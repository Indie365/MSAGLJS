(()=>{var DL=Object.create;var sb=Object.defineProperty;var FL=Object.getOwnPropertyDescriptor;var GL=Object.getOwnPropertyNames;var VL=Object.getPrototypeOf,kL=Object.prototype.hasOwnProperty;var UL=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var Me=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),zL=(s,e)=>{for(var t in e)sb(s,t,{get:e[t],enumerable:!0})},HL=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of GL(e))!kL.call(s,n)&&n!==t&&sb(s,n,{get:()=>e[n],enumerable:!(i=FL(e,n))||i.enumerable});return s};var be=(s,e,t)=>(t=s!=null?DL(VL(s)):{},HL(e||!s||!s.__esModule?sb(t,"default",{value:s,enumerable:!0}):t,s));var oE=Me((Qk,nE)=>{"use strict";function WL(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function Oa(s,e,t,i){this.message=s,this.expected=e,this.found=t,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Oa)}WL(Oa,Error);Oa.buildMessage=function(s,e){var t={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,f;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,f=1;d<h.length;d++)h[d-1]!==h[d]&&(h[f]=h[d],f++);h.length=f}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function jL(s,e){e=e!==void 0?e:{};var t={},i={start:zS},n=zS,o="strict",a=we("strict",!0),l="graph",u=we("graph",!0),c="digraph",h=we("digraph",!0),d="{",f=we("{",!1),P="}",E=we("}",!1),v=function(m,A,N,M){M===null&&(M=[]);var z={type:A.toLowerCase(),children:M};return m&&(z.strict=!0),N&&(z.id=N),z},L=";",O=we(";",!1),D=function(m,A){return A},_=function(m,A){return[m].concat(A)},F="=",X=we("=",!1),$=function(m,A){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:m,eq:A}]}},se="node",ie=we("node",!0),oe="edge",ue=we("edge",!0),Se=function(m,A){return{type:"attr_stmt",target:m,attr_list:A}},ve="[",Ce=we("[",!1),De="]",Cr=we("]",!1),Lo=function(m,A){return(m||[]).concat(A||[])},Yl=function(m,A){return A},Pa=",",$l=we(",",!1),Uc=function(m,A,N){return[{type:"attr",id:m,eq:A}].concat(N||[])},Oo=function(m,A,N){var M=[m];return M=M.concat(A.map(function(z){return z.id})),{type:"edge_stmt",edge_list:M,attr_list:N||[]}},Zl="->",ya=we("->",!1),ki="--",zc=we("--",!1),Xt=function(m,A,N){return[{type:"edgeRHS",edgeop:m,id:A}].concat(N||[])},ln=function(m,A){return{type:"node_stmt",node_id:m,attr_list:A||[]}},Et=function(m,A){return A?{type:"node_id",id:m,port:A}:{type:"node_id",id:m}},nr=Wn("port"),Vn=":",un=we(":",!1),Ro=function(m,A){return A},Mo=function(m,A){return{type:"port",id:m,compass_pt:A||null}},_o=function(m){return{type:"port",compass_pt:m||null}},li="subgraph",fi=we("subgraph",!0),Sa=function(m){return m?{type:"subgraph",id:m}:{type:"subgraph"}},gs=function(m,A){return m=m||{type:"subgraph"},m.children=A||[],m},Bo="n",Ar=we("n",!1),Ql="ne",Ea=we("ne",!1),Kl="e",ms=we("e",!1),Jl="se",eu=we("se",!1),cn="s",tu=we("s",!1),xa="sw",No=we("sw",!1),bs="w",Hc=we("w",!1),ru="nw",iu=we("nw",!1),Wc=Wn("UNICODE_STRING"),nu=function(m,A){return m+A.join("")},Ps=function(m,A){return m+A},jc="$",qc=we("$",!1),va="_",Ca=we("_",!1),kn=Wn("NUMBER"),ou="-",su=we("-",!1),Aa=".",ys=we(".",!1),hn=/^[0-9]/,dn=yi([["0","9"]],!1,!1),au=function(m){return parseFloat(VS())},Do=function(m){return{type:"id",value:m.slice(1,m.length-1),html:!0}},jr="<",Un=we("<",!1),Ss=">",pi=we(">",!1),Es=function(m){return"<"+m.join("")+">"},or=cL(),fn=function(m){return m},Ta=function(m){return m.join("")},zn='"',xs=we('"',!1),Ui=function(m){return m.join("")},k=function(){return VS()},Q="\\",J=we("\\",!1),re=function(m){return m[1]==='"'?'"':m[0]+m[1]},Ie=function(){return""},He=/^[\n\r\u2028\u2029]/,Ye=yi([`
`,"\r","\u2028","\u2029"],!1,!1),Mt=Wn("end of line"),gi=`
`,wt=we(`
`,!1),zi=`\r
`,mi=we(`\r
`,!1),pn="\r",Ia=we("\r",!1),Hi="\u2028",gn=we("\u2028",!1),rf="\u2029",nf=we("\u2029",!1),lu=/^[^"\\\0-\x1F\x7F]/,bi=yi(['"',"\\",["\0",""],"\x7F"],!0,!1),wa='\\"',Xc=we('\\"',!1),Yc=function(){return'"'},$c=function(){return"\\"},Zc=Wn("COMMENT"),uu=Wn("BLOCK_COMMENT"),Wi="/*",Zm=we("/*",!1),Fo="*/",La=we("*/",!1),Qc=function(m){return m},Qm=function(m){return m.join("")},Km=Wn("C_COMMENT"),x="//",T=we("//",!1),R=/^[\n]/,G=yi([`
`],!1,!1),Z=function(m){return m.join("")},ne=Wn("MACRO_COMMENT"),Oe="#",Ut=we("#",!1),Yt=Wn("WHITESPACE"),sr=/^[\n\r]/,Pi=yi([`
`,"\r"],!1,!1),FS=/^[ \t]/,GS=yi([" ","	"],!1,!1),Zw=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,Qw=yi([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),Kw=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,Jw=yi([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),eL=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,tL=yi(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),rL=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,iL=yi(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),nL=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,oL=yi([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),sL=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,aL=yi([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),lL=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,uL=yi([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),S=0,me=0,of=[{line:1,column:1}],Hn=0,Jm=[],U=0,sf;if("startRule"in e){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=i[e.startRule]}function VS(){return s.substring(me,S)}function qk(){return Kc(me,S)}function Xk(m,A){throw A=A!==void 0?A:Kc(me,S),US([Wn(m)],s.substring(me,S),A)}function Yk(m,A){throw A=A!==void 0?A:Kc(me,S),dL(m,A)}function we(m,A){return{type:"literal",text:m,ignoreCase:A}}function yi(m,A,N){return{type:"class",parts:m,inverted:A,ignoreCase:N}}function cL(){return{type:"any"}}function hL(){return{type:"end"}}function Wn(m){return{type:"other",description:m}}function kS(m){var A=of[m],N;if(A)return A;for(N=m-1;!of[N];)N--;for(A=of[N],A={line:A.line,column:A.column};N<m;)s.charCodeAt(N)===10?(A.line++,A.column=1):A.column++,N++;return of[m]=A,A}function Kc(m,A){var N=kS(m),M=kS(A);return{start:{offset:m,line:N.line,column:N.column},end:{offset:A,line:M.line,column:M.column}}}function j(m){S<Hn||(S>Hn&&(Hn=S,Jm=[]),Jm.push(m))}function dL(m,A){return new Oa(m,null,null,A)}function US(m,A,N){return new Oa(Oa.buildMessage(m,A),m,A,N)}function zS(){var m,A;if(m=[],A=HS(),A!==t)for(;A!==t;)m.push(A),A=HS();else m=t;return m}function HS(){var m,A,N,M,z,q,le,xt,vt,qn,Si,ob,iE;return m=S,A=lt(),A!==t?(s.substr(S,6).toLowerCase()===o?(N=s.substr(S,6),S+=6):(N=t,U===0&&j(a)),N===t&&(N=null),N!==t?(M=lt(),M!==t?(s.substr(S,5).toLowerCase()===l?(z=s.substr(S,5),S+=5):(z=t,U===0&&j(u)),z===t&&(s.substr(S,7).toLowerCase()===c?(z=s.substr(S,7),S+=7):(z=t,U===0&&j(h))),z!==t?(q=lt(),q!==t?(le=jn(),le===t&&(le=null),le!==t?(xt=lt(),xt!==t?(s.charCodeAt(S)===123?(vt=d,S++):(vt=t,U===0&&j(f)),vt!==t?(qn=WS(),qn===t&&(qn=null),qn!==t?(Si=lt(),Si!==t?(s.charCodeAt(S)===125?(ob=P,S++):(ob=t,U===0&&j(E)),ob!==t?(iE=lt(),iE!==t?(me=m,A=v(N,z,le,qn),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function WS(){var m,A,N,M,z,q,le,xt,vt,qn,Si;if(m=S,A=lt(),A!==t)if(N=eb(),N!==t)if(M=lt(),M!==t)if(s.charCodeAt(S)===59?(z=L,S++):(z=t,U===0&&j(O)),z===t&&(z=null),z!==t){for(q=[],le=S,xt=lt(),xt!==t?(vt=eb(),vt!==t?(qn=lt(),qn!==t?(s.charCodeAt(S)===59?(Si=L,S++):(Si=t,U===0&&j(O)),Si===t&&(Si=null),Si!==t?(me=le,xt=D(N,vt),le=xt):(S=le,le=t)):(S=le,le=t)):(S=le,le=t)):(S=le,le=t);le!==t;)q.push(le),le=S,xt=lt(),xt!==t?(vt=eb(),vt!==t?(qn=lt(),qn!==t?(s.charCodeAt(S)===59?(Si=L,S++):(Si=t,U===0&&j(O)),Si===t&&(Si=null),Si!==t?(me=le,xt=D(N,vt),le=xt):(S=le,le=t)):(S=le,le=t)):(S=le,le=t)):(S=le,le=t);q!==t?(me=m,A=_(N,q),m=A):(S=m,m=t)}else S=m,m=t;else S=m,m=t;else S=m,m=t;else S=m,m=t;return m}function eb(){var m,A,N,M,z,q;return m=S,A=jn(),A!==t?(N=lt(),N!==t?(s.charCodeAt(S)===61?(M=F,S++):(M=t,U===0&&j(X)),M!==t?(z=lt(),z!==t?(q=jn(),q!==t?(me=m,A=$(A,q),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m===t&&(m=fL(),m===t&&(m=pL(),m===t&&(m=rb(),m===t&&(m=gL(),m===t&&(m=S,A=jn(),A!==t?(s.charCodeAt(S)===61?(N=F,S++):(N=t,U===0&&j(X)),N!==t?(M=jn(),M!==t?(A=[A,N,M],m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)))))),m}function fL(){var m,A,N;return m=S,s.substr(S,5).toLowerCase()===l?(A=s.substr(S,5),S+=5):(A=t,U===0&&j(u)),A===t&&(s.substr(S,4).toLowerCase()===se?(A=s.substr(S,4),S+=4):(A=t,U===0&&j(ie)),A===t&&(s.substr(S,4).toLowerCase()===oe?(A=s.substr(S,4),S+=4):(A=t,U===0&&j(ue)))),A!==t?(N=af(),N!==t?(me=m,A=Se(A,N),m=A):(S=m,m=t)):(S=m,m=t),m}function af(){var m,A,N,M,z,q,le,xt,vt;return m=S,A=lt(),A!==t?(s.charCodeAt(S)===91?(N=ve,S++):(N=t,U===0&&j(Ce)),N!==t?(M=lt(),M!==t?(z=jS(),z===t&&(z=null),z!==t?(q=lt(),q!==t?(s.charCodeAt(S)===93?(le=De,S++):(le=t,U===0&&j(Cr)),le!==t?(xt=lt(),xt!==t?(vt=af(),vt===t&&(vt=null),vt!==t?(me=m,A=Lo(z,vt),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function jS(){var m,A,N,M,z,q,le,xt;return m=S,A=lt(),A!==t?(N=jn(),N!==t?(M=S,z=lt(),z!==t?(s.charCodeAt(S)===61?(q=F,S++):(q=t,U===0&&j(X)),q!==t?(le=lt(),le!==t?(xt=jn(),xt!==t?(me=M,z=Yl(N,xt),M=z):(S=M,M=t)):(S=M,M=t)):(S=M,M=t)):(S=M,M=t),M===t&&(M=null),M!==t?(z=lt(),z!==t?(s.charCodeAt(S)===44?(q=Pa,S++):(q=t,U===0&&j($l)),q===t&&(s.charCodeAt(S)===59?(q=L,S++):(q=t,U===0&&j(O))),q===t&&(q=null),q!==t?(le=jS(),le===t&&(le=null),le!==t?(me=m,A=Uc(N,M,le),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function pL(){var m,A,N,M;return m=S,A=rb(),A===t&&(A=tb()),A!==t?(N=qS(),N!==t?(M=af(),M===t&&(M=null),M!==t?(me=m,A=Oo(A,N,M),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function qS(){var m,A,N,M,z,q,le;return m=S,A=lt(),A!==t?(s.substr(S,2)===Zl?(N=Zl,S+=2):(N=t,U===0&&j(ya)),N===t&&(s.substr(S,2)===ki?(N=ki,S+=2):(N=t,U===0&&j(zc))),N!==t?(M=lt(),M!==t?(z=rb(),z===t&&(z=tb()),z!==t?(q=lt(),q!==t?(le=qS(),le===t&&(le=null),le!==t?(me=m,A=Xt(N,z,le),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function gL(){var m,A,N;return m=S,A=tb(),A!==t?(N=af(),N===t&&(N=null),N!==t?(me=m,A=ln(A,N),m=A):(S=m,m=t)):(S=m,m=t),m}function tb(){var m,A,N;return m=S,A=jn(),A!==t?(N=mL(),N===t&&(N=null),N!==t?(me=m,A=Et(A,N),m=A):(S=m,m=t)):(S=m,m=t),m}function mL(){var m,A,N,M,z,q;return U++,m=S,s.charCodeAt(S)===58?(A=Vn,S++):(A=t,U===0&&j(un)),A!==t?(N=jn(),N!==t?(M=S,s.charCodeAt(S)===58?(z=Vn,S++):(z=t,U===0&&j(un)),z!==t?(q=XS(),q!==t?(me=M,z=Ro(N,q),M=z):(S=M,M=t)):(S=M,M=t),M===t&&(M=null),M!==t?(me=m,A=Mo(N,M),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m===t&&(m=S,s.charCodeAt(S)===58?(A=Vn,S++):(A=t,U===0&&j(un)),A!==t?(N=XS(),N!==t?(me=m,A=_o(N),m=A):(S=m,m=t)):(S=m,m=t)),U--,m===t&&(A=t,U===0&&j(nr)),m}function rb(){var m,A,N,M,z,q;return m=S,A=S,s.substr(S,8).toLowerCase()===li?(N=s.substr(S,8),S+=8):(N=t,U===0&&j(fi)),N!==t?(M=lt(),M!==t?(z=jn(),z===t&&(z=null),z!==t?(q=lt(),q!==t?(me=A,N=Sa(z),A=N):(S=A,A=t)):(S=A,A=t)):(S=A,A=t)):(S=A,A=t),A===t&&(A=null),A!==t?(s.charCodeAt(S)===123?(N=d,S++):(N=t,U===0&&j(f)),N!==t?(M=WS(),M===t&&(M=null),M!==t?(z=lt(),z!==t?(s.charCodeAt(S)===125?(q=P,S++):(q=t,U===0&&j(E)),q!==t?(me=m,A=gs(A,M),m=A):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t)):(S=m,m=t),m}function XS(){var m;return s.charCodeAt(S)===110?(m=Bo,S++):(m=t,U===0&&j(Ar)),m===t&&(s.substr(S,2)===Ql?(m=Ql,S+=2):(m=t,U===0&&j(Ea)),m===t&&(s.charCodeAt(S)===101?(m=Kl,S++):(m=t,U===0&&j(ms)),m===t&&(s.substr(S,2)===Jl?(m=Jl,S+=2):(m=t,U===0&&j(eu)),m===t&&(s.charCodeAt(S)===115?(m=cn,S++):(m=t,U===0&&j(tu)),m===t&&(s.substr(S,2)===xa?(m=xa,S+=2):(m=t,U===0&&j(No)),m===t&&(s.charCodeAt(S)===119?(m=bs,S++):(m=t,U===0&&j(Hc)),m===t&&(s.substr(S,2)===ru?(m=ru,S+=2):(m=t,U===0&&j(iu))))))))),m}function jn(){var m;return m=YS(),m===t&&(m=bL(),m===t&&(m=QS(),m===t&&(m=yL(),m===t&&(m=PL())))),m}function YS(){var m,A,N,M;if(U++,m=S,A=$S(),A!==t){for(N=[],M=ZS();M!==t;)N.push(M),M=ZS();N!==t?(me=m,A=nu(A,N),m=A):(S=m,m=t)}else S=m,m=t;return U--,m===t&&(A=t,U===0&&j(Wc)),m}function bL(){var m,A,N;return m=S,A=QS(),A!==t?(N=YS(),N!==t?(me=m,A=Ps(A,N),m=A):(S=m,m=t)):(S=m,m=t),m}function $S(){var m;return m=wL(),m===t&&(s.charCodeAt(S)===36?(m=jc,S++):(m=t,U===0&&j(qc)),m===t&&(s.charCodeAt(S)===95?(m=va,S++):(m=t,U===0&&j(Ca)))),m}function ZS(){var m;return m=$S(),m===t&&(m=NL()),m}function QS(){var m,A,N,M,z,q,le,xt,vt;if(U++,m=S,A=S,s.charCodeAt(S)===45?(N=ou,S++):(N=t,U===0&&j(su)),N===t&&(N=null),N!==t){if(M=S,s.charCodeAt(S)===46?(z=Aa,S++):(z=t,U===0&&j(ys)),z!==t){if(q=[],hn.test(s.charAt(S))?(le=s.charAt(S),S++):(le=t,U===0&&j(dn)),le!==t)for(;le!==t;)q.push(le),hn.test(s.charAt(S))?(le=s.charAt(S),S++):(le=t,U===0&&j(dn));else q=t;q!==t?(z=[z,q],M=z):(S=M,M=t)}else S=M,M=t;if(M===t){if(M=S,z=[],hn.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(dn)),q!==t)for(;q!==t;)z.push(q),hn.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(dn));else z=t;if(z!==t){if(q=S,s.charCodeAt(S)===46?(le=Aa,S++):(le=t,U===0&&j(ys)),le!==t){for(xt=[],hn.test(s.charAt(S))?(vt=s.charAt(S),S++):(vt=t,U===0&&j(dn));vt!==t;)xt.push(vt),hn.test(s.charAt(S))?(vt=s.charAt(S),S++):(vt=t,U===0&&j(dn));xt!==t?(le=[le,xt],q=le):(S=q,q=t)}else S=q,q=t;q===t&&(q=null),q!==t?(z=[z,q],M=z):(S=M,M=t)}else S=M,M=t}M!==t?(N=[N,M],A=N):(S=A,A=t)}else S=A,A=t;return A!==t&&(me=m,A=au(A)),m=A,U--,m===t&&(A=t,U===0&&j(kn)),m}function PL(){var m,A;return m=S,A=ib(),A!==t&&(me=m,A=Do(A)),m=A,m}function ib(){var m,A,N,M;if(m=S,s.charCodeAt(S)===60?(A=jr,S++):(A=t,U===0&&j(Un)),A!==t){for(N=[],M=KS(),M===t&&(M=ib());M!==t;)N.push(M),M=KS(),M===t&&(M=ib());N!==t?(s.charCodeAt(S)===62?(M=Ss,S++):(M=t,U===0&&j(pi)),M!==t?(me=m,A=Es(N),m=A):(S=m,m=t)):(S=m,m=t)}else S=m,m=t;return m}function KS(){var m,A,N,M,z;if(m=S,A=[],N=S,M=S,U++,s.charCodeAt(S)===62?(z=Ss,S++):(z=t,U===0&&j(pi)),z===t&&(s.charCodeAt(S)===60?(z=jr,S++):(z=t,U===0&&j(Un))),U--,z===t?M=void 0:(S=M,M=t),M!==t?(s.length>S?(z=s.charAt(S),S++):(z=t,U===0&&j(or)),z!==t?(me=N,M=fn(z),N=M):(S=N,N=t)):(S=N,N=t),N!==t)for(;N!==t;)A.push(N),N=S,M=S,U++,s.charCodeAt(S)===62?(z=Ss,S++):(z=t,U===0&&j(pi)),z===t&&(s.charCodeAt(S)===60?(z=jr,S++):(z=t,U===0&&j(Un))),U--,z===t?M=void 0:(S=M,M=t),M!==t?(s.length>S?(z=s.charAt(S),S++):(z=t,U===0&&j(or)),z!==t?(me=N,M=fn(z),N=M):(S=N,N=t)):(S=N,N=t);else A=t;return A!==t&&(me=m,A=Ta(A)),m=A,m}function yL(){var m,A,N,M;if(m=S,s.charCodeAt(S)===34?(A=zn,S++):(A=t,U===0&&j(xs)),A!==t){for(N=[],M=JS();M!==t;)N.push(M),M=JS();N!==t?(s.charCodeAt(S)===34?(M=zn,S++):(M=t,U===0&&j(xs)),M!==t?(me=m,A=Ui(N),m=A):(S=m,m=t)):(S=m,m=t)}else S=m,m=t;return m}function JS(){var m,A,N;return m=SL(),m===t&&(m=S,A=S,U++,s.charCodeAt(S)===34?(N=zn,S++):(N=t,U===0&&j(xs)),N===t&&(N=xL()),U--,N===t?A=void 0:(S=A,A=t),A!==t?(N=CL(),N!==t?(me=m,A=k(),m=A):(S=m,m=t)):(S=m,m=t),m===t&&(m=EL())),m}function SL(){var m,A,N,M;return m=S,A=S,s.charCodeAt(S)===92?(N=Q,S++):(N=t,U===0&&j(J)),N!==t?(s.length>S?(M=s.charAt(S),S++):(M=t,U===0&&j(or)),M!==t?(N=[N,M],A=N):(S=A,A=t)):(S=A,A=t),A!==t&&(me=m,A=re(A)),m=A,m}function EL(){var m,A,N;return m=S,s.charCodeAt(S)===92?(A=Q,S++):(A=t,U===0&&j(J)),A!==t?(N=vL(),N!==t?(me=m,A=Ie(),m=A):(S=m,m=t)):(S=m,m=t),m}function xL(){var m;return He.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(Ye)),m}function vL(){var m,A;return U++,s.charCodeAt(S)===10?(m=gi,S++):(m=t,U===0&&j(wt)),m===t&&(s.substr(S,2)===zi?(m=zi,S+=2):(m=t,U===0&&j(mi)),m===t&&(s.charCodeAt(S)===13?(m=pn,S++):(m=t,U===0&&j(Ia)),m===t&&(s.charCodeAt(S)===8232?(m=Hi,S++):(m=t,U===0&&j(gn)),m===t&&(s.charCodeAt(S)===8233?(m=rf,S++):(m=t,U===0&&j(nf)))))),U--,m===t&&(A=t,U===0&&j(Mt)),m}function CL(){var m;return s.length>S?(m=s.charAt(S),S++):(m=t,U===0&&j(or)),m}function $k(){var m,A,N;if(m=S,A=[],N=eE(),N!==t)for(;N!==t;)A.push(N),N=eE();else A=t;return A!==t&&(me=m,A=Ui(A)),m=A,m}function eE(){var m,A,N;return lu.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(bi)),m===t&&(m=S,s.substr(S,2)===wa?(A=wa,S+=2):(A=t,U===0&&j(Xc)),A!==t&&(me=m,A=Yc()),m=A,m===t&&(m=S,s.charCodeAt(S)===92?(A=Q,S++):(A=t,U===0&&j(J)),A!==t?(N=nb(),N!==t?(me=m,A=Ie(),m=A):(S=m,m=t)):(S=m,m=t),m===t&&(m=S,s.charCodeAt(S)===92?(A=Q,S++):(A=t,U===0&&j(J)),A!==t&&(me=m,A=$c()),m=A))),m}function tE(){var m,A;return U++,m=AL(),m===t&&(m=TL(),m===t&&(m=IL())),U--,m===t&&(A=t,U===0&&j(Zc)),m}function AL(){var m,A,N,M,z,q;if(U++,m=S,s.substr(S,2)===Wi?(A=Wi,S+=2):(A=t,U===0&&j(Zm)),A!==t){for(N=[],M=S,z=S,U++,s.substr(S,2)===Fo?(q=Fo,S+=2):(q=t,U===0&&j(La)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=Qc(q),M=z):(S=M,M=t)):(S=M,M=t);M!==t;)N.push(M),M=S,z=S,U++,s.substr(S,2)===Fo?(q=Fo,S+=2):(q=t,U===0&&j(La)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=Qc(q),M=z):(S=M,M=t)):(S=M,M=t);N!==t?(s.substr(S,2)===Fo?(M=Fo,S+=2):(M=t,U===0&&j(La)),M!==t?(me=m,A=Qm(N),m=A):(S=m,m=t)):(S=m,m=t)}else S=m,m=t;return U--,m===t&&(A=t,U===0&&j(uu)),m}function TL(){var m,A,N,M,z,q;if(U++,m=S,s.substr(S,2)===x?(A=x,S+=2):(A=t,U===0&&j(T)),A!==t){for(N=[],M=S,z=S,U++,R.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(G)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=fn(q),M=z):(S=M,M=t)):(S=M,M=t);M!==t;)N.push(M),M=S,z=S,U++,R.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(G)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=fn(q),M=z):(S=M,M=t)):(S=M,M=t);N!==t?(R.test(s.charAt(S))?(M=s.charAt(S),S++):(M=t,U===0&&j(G)),M===t&&(M=null),M!==t?(me=m,A=Z(N),m=A):(S=m,m=t)):(S=m,m=t)}else S=m,m=t;return U--,m===t&&(A=t,U===0&&j(Km)),m}function IL(){var m,A,N,M,z,q;if(U++,m=S,s.charCodeAt(S)===35?(A=Oe,S++):(A=t,U===0&&j(Ut)),A!==t){for(N=[],M=S,z=S,U++,R.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(G)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=fn(q),M=z):(S=M,M=t)):(S=M,M=t);M!==t;)N.push(M),M=S,z=S,U++,R.test(s.charAt(S))?(q=s.charAt(S),S++):(q=t,U===0&&j(G)),U--,q===t?z=void 0:(S=z,z=t),z!==t?(s.length>S?(q=s.charAt(S),S++):(q=t,U===0&&j(or)),q!==t?(me=M,z=fn(q),M=z):(S=M,M=t)):(S=M,M=t);N!==t?(R.test(s.charAt(S))?(M=s.charAt(S),S++):(M=t,U===0&&j(G)),M===t&&(M=null),M!==t?(me=m,A=Z(N),m=A):(S=m,m=t)):(S=m,m=t)}else S=m,m=t;return U--,m===t&&(A=t,U===0&&j(ne)),m}function lt(){var m,A;for(U++,m=[],A=rE(),A===t&&(A=tE());A!==t;)m.push(A),A=rE(),A===t&&(A=tE());return U--,m===t&&(A=t,U===0&&j(Yt)),m}function nb(){var m,A;if(m=[],sr.test(s.charAt(S))?(A=s.charAt(S),S++):(A=t,U===0&&j(Pi)),A!==t)for(;A!==t;)m.push(A),sr.test(s.charAt(S))?(A=s.charAt(S),S++):(A=t,U===0&&j(Pi));else m=t;return m}function rE(){var m,A;if(m=[],FS.test(s.charAt(S))?(A=s.charAt(S),S++):(A=t,U===0&&j(GS)),A===t&&(A=nb()),A!==t)for(;A!==t;)m.push(A),FS.test(s.charAt(S))?(A=s.charAt(S),S++):(A=t,U===0&&j(GS)),A===t&&(A=nb());else m=t;return m}function wL(){var m;return m=_L(),m===t&&(m=LL(),m===t&&(m=ML(),m===t&&(m=OL(),m===t&&(m=RL(),m===t&&(m=BL()))))),m}function LL(){var m;return Zw.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(Qw)),m}function OL(){var m;return Kw.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(Jw)),m}function RL(){var m;return eL.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(tL)),m}function ML(){var m;return rL.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(iL)),m}function _L(){var m;return nL.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(oL)),m}function BL(){var m;return sL.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(aL)),m}function NL(){var m;return lL.test(s.charAt(S))?(m=s.charAt(S),S++):(m=t,U===0&&j(uL)),m}if(sf=n(),sf!==t&&S===s.length)return sf;throw sf!==t&&S<s.length&&j(hL()),US(Jm,Hn<s.length?s.charAt(Hn):null,Hn<s.length?Kc(Hn,Hn+1):Kc(Hn,Hn))}nE.exports={SyntaxError:Oa,parse:jL}});var aE=Me((Kk,sE)=>{var qL=oE();sE.exports=qL.parse});var ab=Me(lf=>{"use strict";Object.defineProperty(lf,"__esModule",{value:!0});var lE=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,i=!1){if(i&&this.isDuplicate(e))return!1;let n=new Jc(e),o=this._head;if(o)for(;;){if(o.value===t)return n.next=o.next,n.prev=o,o.next=n,n.next?n.next.prev=n:this._tail=n,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Jc(e);return this._tail?(this._tail.next=i,i.prev=this._tail,this._tail=i):this._head=this._tail=i,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Jc(e);return this._head?(i.next=this._head,this._head.prev=i,this._head=i):this._head=this._tail=i,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),i=[],n=Math.min(e,this.length);for(let o=0;o<n;o++){let a=t.next();i.push(a.value)}return i}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};lf.LinkedList=lE;var Jc=class{constructor(e){this.value=e,this.next=null,this.prev=null}};lf.LinkedListItem=Jc});var vs=Me(lb=>{"use strict";Object.defineProperty(lb,"__esModule",{value:!0});var XL=ab(),uE=class extends XL.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};lb.Queue=uE});var qi=Me(gb=>{"use strict";Object.defineProperty(gb,"__esModule",{value:!0});var rO=ab(),pE=class extends rO.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};gb.Stack=pE});var zt=Me(Is=>{"use strict";var bf=Is&&Is.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,n++)i[n]=o[a];return i};Object.defineProperty(Is,"__esModule",{value:!0});Is.StringBuilder=Is.String=void 0;var gu=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{var n=t[0];if(Array.isArray(n)||n instanceof Array){for(var o=s.Empty,a=0,l=0;l<n.length;l++){var u=n[l];l<n.length-1?o+=u+e:o+=u}return o}else if(typeof n=="object"){var c=s.Empty,h=n,d=Object.keys(n);return d.forEach(function(P){c+=h[P]+e}),c=c.slice(0,c.length-e.length),c}var f=t;return s.join.apply(s,bf([e],f))}catch(P){return console.log(P),s.Empty}},s.Format=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(n){return console.log(n),s.Empty}},s.format=function(e,t,i,n){return n===void 0&&(n=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return n?u=i[0][a]:u=i[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var i=t.replace(/,/g,".");if(isNaN(parseFloat(i))||i.length<=3)break;var n=i.split(/[^0-9]+/g),o=n;n.length>1&&(o=[s.join.apply(s,bf([""],n.splice(0,n.length-1))),n[n.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var i=parseFloat(e),n=i.toString(16);return t?n.toLocaleUpperCase():n},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var i=t[t.length-1],n=t[t.length-2],o=t[t.length-3];return i=i.split("T")[0],i=i.split(" ")[0],i+"."+n+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var i=t[t.length-1].split(" "),n=s.Empty;i.length>1&&(n=i[i.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(n)&&n.length>1?u+="T"+n:u+="T00:00:00",u},s.formatNumber=function(e,t){var i=t.length,n=e.toString();if(i<=n.length)return n;var o=i-n.length;return o+=1,new Array(o).join("0")+n},s.join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var n=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];n+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){n+=e,o=l-1;break}}return n},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();Is.String=gu;var lO=function(){function s(e){this.Values=[],gu.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(gu.Format.apply(gu,bf([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(`\r
`+gu.Format.apply(gu,bf([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();Is.StringBuilder=lO});var ws=Me(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});Ke.isPrimitive=Ke.isPropertyKey=Ke.isString=Ke.isBoolean=Ke.isNumber=Ke.isIterator=Ke.isAsyncIterable=Ke.isIterable=Ke.isDefined=Ke.isMissing=Ke.isInstance=Ke.isObject=Ke.isFunctionOrUndefined=Ke.isFunction=void 0;function TE(s){return typeof s=="function"}Ke.isFunction=TE;function Pf(s){return typeof s=="function"||s===void 0}Ke.isFunctionOrUndefined=Pf;function IE(s){return typeof s=="object"&&s!==null||typeof s=="function"}Ke.isObject=IE;function hO(s,e){return!wE(s)&&s instanceof e}Ke.isInstance=hO;function wE(s){return s==null}Ke.isMissing=wE;function dO(s){return s!=null}Ke.isDefined=dO;function fO(s){return s!=null&&Symbol.iterator in Object(s)}Ke.isIterable=fO;function pO(s){return s!=null&&Symbol.asyncIterator in Object(s)}Ke.isAsyncIterable=pO;function gO(s){return IE(s)&&TE(s.next)&&Pf(s.throw)&&Pf(s.return)&&Pf(s[Symbol.iterator])}Ke.isIterator=gO;function mO(s){return typeof s=="number"}Ke.isNumber=mO;function bO(s){return typeof s=="boolean"}Ke.isBoolean=bO;function PO(s){return typeof s=="string"}Ke.isString=PO;function yO(s){return typeof s=="string"||typeof s=="symbol"||typeof s=="number"}Ke.isPropertyKey=yO;function SO(s){return typeof s!="function"&&(typeof s!="object"||s===null)}Ke.isPrimitive=SO});var xb=Me(yf=>{"use strict";Object.defineProperty(yf,"__esModule",{value:!0});yf.binarySearch=void 0;function EO(s,e,t){if(s.length===0)return-1;let i=0,n=s.length-1;for(;i<=n;){let o=i+(n-i>>1),a=s[o];switch(Math.sign(t.compare(a,e))){case-1:i=o+1;break;case 0:return o;case 1:n=o-1;break}}return~i}yf.binarySearch=EO});var LE=Me(Su=>{"use strict";Object.defineProperty(Su,"__esModule",{value:!0});Su.deprecateProperty=Su.deprecate=void 0;function xO(){try{return UL("util").deprecate}catch{}}function vO(){let s=typeof process=="object"&&typeof process.emitWarning=="function"?function e(t,i="Warning",n=e){process.emitWarning(t,i,n)}:typeof Error.captureStackTrace=="function"?function e(t,i="Warning",n=e){typeof t=="string"&&(t=new Error(t),t.name=i),Error.captureStackTrace(t,n),console.warn(t)}:function(t,i="Warning"){typeof t=="string"?console.warn(`${i}:`,t):console.warn(t)};return(e,t)=>{let i=!1;function n(...o){return i||(i=!0,s(t,"DeprecationWarning",e)),new.target?Reflect.construct(e,o,new.target):e.apply(this,o)}return Object.setPrototypeOf(n,e),e.prototype&&(n.prototype=e.prototype),n}}var CO=xO()||vO();function Sf(s,e){return CO(s,e)}Su.deprecate=Sf;function AO(s,e,t){let i=Object.getOwnPropertyDescriptor(s,e);if(i&&i.configurable){let n=!1;i.get&&(i.get=Sf(i.get,t),n=!0),i.set&&(i.set=Sf(i.set,t),n=!0),typeof i.value=="function"&&(i.value=Sf(i.value,t),n=!0),n&&Object.defineProperty(s,e,i)}return s}Su.deprecateProperty=AO});var Da=Me(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.KeyedMultiCollection=rt.ReadonlyKeyedMultiCollection=rt.KeyedCollection=rt.ReadonlyKeyedCollection=rt.IndexedCollection=rt.FixedSizeIndexedCollection=rt.ReadonlyIndexedCollection=rt.Collection=rt.ReadonlyCollection=void 0;var Ef=ws(),Zt=LE(),Mr;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has");function e(i){return Ef.isIterable(i)&&s.size in i&&s.has in i}s.isReadonlyCollection=e,s.name="ReadonlyCollection";function t(i){return Ef.isIterable(i)&&s.size in i&&s.has in i}s.hasInstance=t})(Mr=rt.ReadonlyCollection||(rt.ReadonlyCollection={}));var Ba;(function(s){s.size=Mr.size,s.has=Mr.has,s.isReadonlyCollection=Mr.isReadonlyCollection,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.clear=Symbol.for("@esfx/collection-core!Collection.clear");function e(i){return s.hasInstance(i)}s.isCollection=e,s.name="Collection";function t(i){return Mr.hasInstance(i)&&s.add in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(Ba=rt.Collection||(rt.Collection={}));var Kn;(function(s){s.size=Mr.size,s.has=Mr.has,s.isReadonlyCollection=Mr.isReadonlyCollection,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt");function e(i){return s.hasInstance(i)}s.isReadonlyIndexedCollection=e,s.name="ReadonlyIndexedCollection";function t(i){return Mr.hasInstance(i)&&s.indexOf in i&&s.getAt in i}s.hasInstance=t})(Kn=rt.ReadonlyIndexedCollection||(rt.ReadonlyIndexedCollection={}));var Na;(function(s){s.size=Mr.size,s.has=Mr.has,s.isReadonlyCollection=Mr.isReadonlyCollection,s.indexOf=Kn.indexOf,s.getAt=Kn.getAt,s.isReadonlyIndexedCollection=Kn.isReadonlyIndexedCollection,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt");function e(i){return s.hasInstance(i)}s.isFixedSizeIndexedCollection=e,s.name="FixedSizeIndexedCollection";function t(i){return Kn.hasInstance(i)&&s.setAt in i}s.hasInstance=t})(Na=rt.FixedSizeIndexedCollection||(rt.FixedSizeIndexedCollection={}));var Eu;(function(s){s.size=Mr.size,s.has=Mr.has,s.isReadonlyCollection=Mr.isReadonlyCollection,s.indexOf=Kn.indexOf,s.getAt=Kn.getAt,s.isReadonlyIndexedCollection=Kn.isReadonlyIndexedCollection,s.setAt=Na.setAt,s.isFixedSizeIndexedCollection=Na.isFixedSizeIndexedCollection,s.add=Ba.add,s.delete=Ba.delete,s.clear=Ba.clear,s.isCollection=Ba.isCollection,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt");function e(i){return s.hasInstance(i)}s.isIndexedCollection=e,s.name="IndexedCollection";function t(i){return Na.hasInstance(i)&&s.insertAt in i&&s.removeAt in i}s.hasInstance=t})(Eu=rt.IndexedCollection||(rt.IndexedCollection={}));var zo;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedCollection=e,s.name="ReadonlyKeyedCollection";function t(i){return Ef.isIterable(i)&&s.size in i&&s.has in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(zo=rt.ReadonlyKeyedCollection||(rt.ReadonlyKeyedCollection={}));var vb;(function(s){s.size=zo.size,s.has=zo.has,s.get=zo.get,s.keys=zo.keys,s.values=zo.values,s.isReadonlyKeyedCollection=zo.isReadonlyKeyedCollection,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedCollection=e,s.name="KeyedCollection";function t(i){return zo.hasInstance(i)&&s.set in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(vb=rt.KeyedCollection||(rt.KeyedCollection={}));var Qn;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedMultiCollection=e,s.name="ReadonlyKeyedMultiCollection";function t(i){return Ef.isIterable(i)&&s.size in i&&s.has in i&&s.hasValue in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(Qn=rt.ReadonlyKeyedMultiCollection||(rt.ReadonlyKeyedMultiCollection={}));var Cb;(function(s){s.size=Qn.size,s.has=Qn.has,s.hasValue=Qn.hasValue,s.get=Qn.get,s.keys=Qn.keys,s.values=Qn.values,s.isReadonlyKeyedMultiCollection=Qn.isReadonlyKeyedMultiCollection,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedMultiCollection=e,s.name="KeyedMultiCollection";function t(i){return Qn.hasInstance(i)&&s.add in i&&s.delete in i&&s.deleteValue in i&&s.clear in i}s.hasInstance=t})(Cb=rt.KeyedMultiCollection||(rt.KeyedMultiCollection={}));Zt.deprecateProperty(Mr,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Zt.deprecateProperty(Ba,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Zt.deprecateProperty(Ba,"isCollection","Use 'Collection.hasInstance' instead.");Zt.deprecateProperty(Kn,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Zt.deprecateProperty(Kn,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Zt.deprecateProperty(Na,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Zt.deprecateProperty(Na,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Zt.deprecateProperty(Na,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");Zt.deprecateProperty(Eu,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Zt.deprecateProperty(Eu,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Zt.deprecateProperty(Eu,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");Zt.deprecateProperty(Eu,"isCollection","Use 'Collection.hasInstance' instead.");Zt.deprecateProperty(Eu,"isIndexedCollection","Use 'IndexedCollection.hasInstance' instead.");Zt.deprecateProperty(zo,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");Zt.deprecateProperty(vb,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");Zt.deprecateProperty(vb,"isKeyedCollection","Use 'KeyedCollection.hasInstance' instead.");Zt.deprecateProperty(Qn,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");Zt.deprecateProperty(Cb,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");Zt.deprecateProperty(Cb,"isKeyedMultiCollection","Use 'KeyedMultiCollection.hasInstance' instead.")});var _E=Me(Ls=>{"use strict";Object.defineProperty(Ls,"__esModule",{value:!0});Ls.hash=Ls.defaultSeed=Ls.createSeed=void 0;function ME(){return Math.random()*4294967295>>>0}Ls.createSeed=ME;Ls.defaultSeed=ME();var OE=3432918353,RE=461845907,TO=3864292196;function IO(s,e){let t=new DataView(s),i=e>>>0,n=0,o;for(;n<t.byteLength-4;)o=t.getUint32(n,!0),o*=OE,o=o<<15|o>>>17,o*=RE,i^=o,i=i<<13|i>>>19,i=i*5+TO,n+=4;if(n<t.byteLength){switch(o=0,t.byteLength-n){case 3:o|=t.getUint8(n+2)<<16;case 2:o|=t.getUint8(n+1)<<8;case 1:o|=t.getUint8(n+0)<<0}o*=OE,o=o<<15|o>>>17,o*=RE,i^=o}return i^=t.byteLength,i^=i>>>16,i*=2246822507,i^=i>>>13,i*=3266489909,i^=i>>>16,i}Ls.hash=IO});var zE=Me(xu=>{"use strict";Object.defineProperty(xu,"__esModule",{value:!0});xu.hashUnknown=void 0;var vu=_E(),Fa,xf,ch,Ga,Va,ka,NE=2**31-1,wO=~NE,LO=2**32-1,OO=0,Ab=new DataView(new ArrayBuffer(8)),DE=vu.createSeed(),FE=vu.createSeed(),GE=vu.createSeed(),VE=vu.createSeed(),kE=vu.createSeed(),Tb=DE,Ib=FE,wb=kE,Lb=GE,Ob=VE;function RO(s){return s?1:0}function MO(s){return Number.isInteger(s)&&s>=wO&&s<=NE}function _O(s){return Number.isInteger(s)&&s>=OO&&s<=LO}function BO(s){return s>>0}function NO(s){return Ab.setFloat64(0,s),Ab.getInt32(0,!0)^Ab.getInt32(4,!0)}function DO(s){return MO(s)?s:_O(s)?BO(s):NO(s)}function FO(s,e){let t=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);return vu.hash(t,e)}function vf(s,e,t){if(!Buffer.isEncoding(e))throw new RangeError(`Invalid encoding: ${e}`);return FO(Buffer.from(s,e),t)}function Rb(s,e){return(s<<7|s>>>25)^e}function GO(){let s=BigInt(0),e=BigInt(4294967295),t=BigInt(32);function i(n){if(n===s)return 0;let o=n<s?-1:n>s?1:0;for(n<s&&(n=-n);n!==s;)o=Rb(o,Number(n&e)),n=n>>t;return o}return i}function VO(){function s(e){return vf(e.toString(),"ascii",wb)}return s}var kO=typeof BigInt=="function"?GO():VO();function UO(s){return vf(s,"utf8",Ib)}function zO(s,e){let t=Va&&Va.get(s);return t===void 0&&(t=vf(e,"utf8",Ob),Va||(Va=new Map),Va.set(s,t)),t}var HO="description"in Symbol.prototype?s=>s.description:s=>{let e=s.toString();return e.startsWith("Symbol(")&&e.endsWith(")")?e.slice(7,-1):e};function WO(s){let e=ka&&ka.get(s);if(e===void 0){ch||(ch={next:1}),e=Rb(Lb,ch.next++);let t=HO(s);t&&(e=vf(t,"utf8",e)),ka||(ka=new Map),ka.set(s,e)}return e}function jO(s){let e=Symbol.keyFor(s);return e!==void 0?zO(s,e):WO(s)}function qO(s){let e;return s===null?e=xf||(xf={next:1}):(e=Fa&&Fa.get(s),e||(Fa||(Fa=new WeakMap),Fa.set(s,e={next:1}))),e}function BE(s){let e=Ga&&Ga.get(s);return e===void 0&&(Ga||(Ga=new WeakMap),e=qO(Object.getPrototypeOf(s)).next++,e=Rb(Tb,e),Ga.set(s,e)),e}function UE(s){switch(typeof s){case"boolean":return RO(s);case"number":return DO(s);case"bigint":return kO(s);case"string":return UO(s);case"symbol":return jO(s);case"function":return BE(s);case"object":if(s!==null)return BE(s);case"undefined":default:return 0}}xu.hashUnknown=UE;(function(s){function e(){return{weakPrototypeCounters:Fa,nullPrototypeCounter:xf,localSymbolCounter:ch,weakObjectHashes:Ga,globalSymbolHashes:Va,localSymbolHashes:ka,objectSeed:Tb,stringSeed:Ib,bigIntSeed:wb,localSymbolSeed:Lb,globalSymbolSeed:Ob}}s.getState=e;function t(i){({weakPrototypeCounters:Fa,nullPrototypeCounter:xf,localSymbolCounter:ch,weakObjectHashes:Ga,globalSymbolHashes:Va,localSymbolHashes:ka,objectSeed:Tb=DE,stringSeed:Ib=FE,bigIntSeed:wb=kE,localSymbolSeed:Lb=GE,globalSymbolSeed:Ob=VE}=i)}s.setState=t})(UE=xu.hashUnknown||(xu.hashUnknown={}))});var Ua=Me(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.rawHash=Pe.tupleStructuralComparer=Pe.tupleComparer=Pe.structuralComparer=Pe.defaultComparer=Pe.Comparer=Pe.combineHashes=Pe.tupleStructuralEqualer=Pe.tupleEqualer=Pe.structuralEqualer=Pe.defaultEqualer=Pe.Equaler=Pe.StructuralComparable=Pe.StructuralEquatable=Pe.Comparable=Pe.Equatable=void 0;var HE=zE(),Os;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let i;return t!=null&&s.equals in(i=Object(t))&&s.hash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Os=Pe.Equatable||(Pe.Equatable={}));(function(s){let e=Cf("Use 'Equatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isEquatable=t})(Os=Pe.Equatable||(Pe.Equatable={}));var Cu;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Cu=Pe.Comparable||(Pe.Comparable={}));(function(s){let e=Cf("Use 'Comparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isComparable=t})(Cu=Pe.Comparable||(Pe.Comparable={}));var Rs;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let i;return t!=null&&s.structuralEquals in(i=Object(t))&&s.structuralHash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Rs=Pe.StructuralEquatable||(Pe.StructuralEquatable={}));(function(s){let e=Cf("Use 'StructuralEquatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralEquatable=t})(Rs=Pe.StructuralEquatable||(Pe.StructuralEquatable={}));var Au;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Au=Pe.StructuralComparable||(Pe.StructuralComparable={}));(function(s){let e=Cf("Use 'StructuralComparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralComparable=t})(Au=Pe.StructuralComparable||(Pe.StructuralComparable={}));var Tu;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>Os.hasInstance(o)?o[Os.equals](a):Os.hasInstance(a)?a[Os.equals](o):Object.is(o,a),o=>Os.hasInstance(o)?o[Os.hash]():HE.hashUnknown(o)),s.structuralEqualer=t((o,a)=>Rs.hasInstance(o)?o[Rs.structuralEquals](a,s.structuralEqualer):Rs.hasInstance(a)?a[Rs.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>Rs.hasInstance(o)?o[Rs.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function i(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=i;function n(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(Tu=Pe.Equaler||(Pe.Equaler={}));Pe.defaultEqualer=Tu.defaultEqualer;Pe.structuralEqualer=Tu.structuralEqualer;Pe.tupleEqualer=Tu.tupleEqualer;Pe.tupleStructuralEqualer=Tu.tupleEqualer;Pe.combineHashes=Tu.combineHashes;var hh;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((n,o)=>Cu.hasInstance(n)?n[Cu.compareTo](o):Cu.hasInstance(o)?-o[Cu.compareTo](n):n<o?-1:n>o?1:0),s.structuralComparer=t((n,o)=>Au.hasInstance(n)?n[Au.structuralCompareTo](o,s.structuralComparer):Au.hasInstance(o)?-o[Au.structuralCompareTo](n,s.structuralComparer):s.defaultComparer.compare(n,o)),s.tupleComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.defaultComparer.compare(n[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.structuralComparer.compare(n[l],o[l]))return a;return 0});function t(n){return Object.setPrototypeOf({compare:n},e)}s.create=t;function i(n){return typeof n=="object"&&n!==null&&typeof n.compare=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(hh=Pe.Comparer||(Pe.Comparer={}));Pe.defaultComparer=hh.defaultComparer;Pe.structuralComparer=hh.structuralComparer;Pe.tupleComparer=hh.tupleComparer;Pe.tupleStructuralComparer=hh.tupleStructuralComparer;function XO(s){return HE.hashUnknown(s)}Pe.rawHash=XO;function Cf(s){let e=!1;return()=>{e||(e=!0,typeof process=="object"&&process.emitWarning?process.emitWarning(s,"Deprecation"):typeof console=="object"&&console.warn(`Deprecation: ${s}`))}}});var dh=Me(Tf=>{"use strict";Object.defineProperty(Tf,"__esModule",{value:!0});Tf.SortedMap=void 0;var YO=ws(),Af=xb(),Ms=Da(),WE=Ua(),Mb=class{constructor(...e){this._keys=[],this._values=[];let t,i;if(e.length>0){let n=e[0];YO.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=WE.Comparer.defaultComparer),this._comparer=typeof i=="function"?WE.Comparer.create(i):i,t)for(let[n,o]of t)this.set(n,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return Af.binarySearch(this._keys,e,this._comparer)>=0}get(e){let t=Af.binarySearch(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let i=Af.binarySearch(this._keys,e,this._comparer);return i>=0?this._values[i]=t:(this._keys.splice(~i,0,e),this._values.splice(~i,0,t)),this}delete(e){let t=Af.binarySearch(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this)e.call(t,n,i,this)}get[Ms.KeyedCollection.size](){return this.size}[Ms.KeyedCollection.has](e){return this.has(e)}[Ms.KeyedCollection.get](e){return this.get(e)}[Ms.KeyedCollection.set](e,t){this.set(e,t)}[Ms.KeyedCollection.delete](e){return this.delete(e)}[Ms.KeyedCollection.clear](){this.clear()}[Ms.KeyedCollection.keys](){return this.keys()}[Ms.KeyedCollection.values](){return this.values()}};Tf.SortedMap=Mb;Object.defineProperty(Mb,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedMap"})});var Zx=Me((aee,cp)=>{var Ox,Rx,Mx,_x,Bx,Nx,Dx,Fx,Gx,lp,IP,Vx,kx,Ux,zu,zx,Hx,Wx,jx,qx,Xx,Yx,$x,up;(function(s){var e=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(i){s(t(e,t(i)))}):typeof cp=="object"&&typeof cp.exports=="object"?s(t(e,t(cp.exports))):s(t(e));function t(i,n){return i!==e&&(typeof Object.create=="function"?Object.defineProperty(i,"__esModule",{value:!0}):i.__esModule=!0),function(o,a){return i[o]=n?n(o,a):a}}})(function(s){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])};Ox=function(i,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(i,n);function o(){this.constructor=i}i.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},Rx=Object.assign||function(i){for(var n,o=1,a=arguments.length;o<a;o++){n=arguments[o];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(i[l]=n[l])}return i},Mx=function(i,n){var o={};for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&n.indexOf(a)<0&&(o[a]=i[a]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(i);l<a.length;l++)n.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(i,a[l])&&(o[a[l]]=i[a[l]]);return o},_x=function(i,n,o,a){var l=arguments.length,u=l<3?n:a===null?a=Object.getOwnPropertyDescriptor(n,o):a,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(i,n,o,a);else for(var h=i.length-1;h>=0;h--)(c=i[h])&&(u=(l<3?c(u):l>3?c(n,o,u):c(n,o))||u);return l>3&&u&&Object.defineProperty(n,o,u),u},Bx=function(i,n){return function(o,a){n(o,a,i)}},Nx=function(i,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,n)},Dx=function(i,n,o,a){function l(u){return u instanceof o?u:new o(function(c){c(u)})}return new(o||(o=Promise))(function(u,c){function h(P){try{f(a.next(P))}catch(E){c(E)}}function d(P){try{f(a.throw(P))}catch(E){c(E)}}function f(P){P.done?u(P.value):l(P.value).then(h,d)}f((a=a.apply(i,n||[])).next())})},Fx=function(i,n){var o={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},a,l,u,c;return c={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function h(f){return function(P){return d([f,P])}}function d(f){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,l&&(u=f[0]&2?l.return:f[0]?l.throw||((u=l.return)&&u.call(l),0):l.next)&&!(u=u.call(l,f[1])).done)return u;switch(l=0,u&&(f=[f[0]&2,u.value]),f[0]){case 0:case 1:u=f;break;case 4:return o.label++,{value:f[1],done:!1};case 5:o.label++,l=f[1],f=[0];continue;case 7:f=o.ops.pop(),o.trys.pop();continue;default:if(u=o.trys,!(u=u.length>0&&u[u.length-1])&&(f[0]===6||f[0]===2)){o=0;continue}if(f[0]===3&&(!u||f[1]>u[0]&&f[1]<u[3])){o.label=f[1];break}if(f[0]===6&&o.label<u[1]){o.label=u[1],u=f;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(f);break}u[2]&&o.ops.pop(),o.trys.pop();continue}f=n.call(i,o)}catch(P){f=[6,P],l=0}finally{a=u=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},Gx=function(i,n){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(n,o)&&up(n,i,o)},up=Object.create?function(i,n,o,a){a===void 0&&(a=o),Object.defineProperty(i,a,{enumerable:!0,get:function(){return n[o]}})}:function(i,n,o,a){a===void 0&&(a=o),i[a]=n[o]},lp=function(i){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&i[n],a=0;if(o)return o.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&a>=i.length&&(i=void 0),{value:i&&i[a++],done:!i}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},IP=function(i,n){var o=typeof Symbol=="function"&&i[Symbol.iterator];if(!o)return i;var a=o.call(i),l,u=[],c;try{for(;(n===void 0||n-- >0)&&!(l=a.next()).done;)u.push(l.value)}catch(h){c={error:h}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(c)throw c.error}}return u},Vx=function(){for(var i=[],n=0;n<arguments.length;n++)i=i.concat(IP(arguments[n]));return i},kx=function(){for(var i=0,n=0,o=arguments.length;n<o;n++)i+=arguments[n].length;for(var a=Array(i),l=0,n=0;n<o;n++)for(var u=arguments[n],c=0,h=u.length;c<h;c++,l++)a[l]=u[c];return a},Ux=function(i,n,o){if(o||arguments.length===2)for(var a=0,l=n.length,u;a<l;a++)(u||!(a in n))&&(u||(u=Array.prototype.slice.call(n,0,a)),u[a]=n[a]);return i.concat(u||Array.prototype.slice.call(n))},zu=function(i){return this instanceof zu?(this.v=i,this):new zu(i)},zx=function(i,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=o.apply(i,n||[]),l,u=[];return l={},c("next"),c("throw"),c("return"),l[Symbol.asyncIterator]=function(){return this},l;function c(v){a[v]&&(l[v]=function(L){return new Promise(function(O,D){u.push([v,L,O,D])>1||h(v,L)})})}function h(v,L){try{d(a[v](L))}catch(O){E(u[0][3],O)}}function d(v){v.value instanceof zu?Promise.resolve(v.value.v).then(f,P):E(u[0][2],v)}function f(v){h("next",v)}function P(v){h("throw",v)}function E(v,L){v(L),u.shift(),u.length&&h(u[0][0],u[0][1])}},Hx=function(i){var n,o;return n={},a("next"),a("throw",function(l){throw l}),a("return"),n[Symbol.iterator]=function(){return this},n;function a(l,u){n[l]=i[l]?function(c){return(o=!o)?{value:zu(i[l](c)),done:l==="return"}:u?u(c):c}:u}},Wx=function(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=i[Symbol.asyncIterator],o;return n?n.call(i):(i=typeof lp=="function"?lp(i):i[Symbol.iterator](),o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o);function a(u){o[u]=i[u]&&function(c){return new Promise(function(h,d){c=i[u](c),l(h,d,c.done,c.value)})}}function l(u,c,h,d){Promise.resolve(d).then(function(f){u({value:f,done:h})},c)}},jx=function(i,n){return Object.defineProperty?Object.defineProperty(i,"raw",{value:n}):i.raw=n,i};var t=Object.create?function(i,n){Object.defineProperty(i,"default",{enumerable:!0,value:n})}:function(i,n){i.default=n};qx=function(i){if(i&&i.__esModule)return i;var n={};if(i!=null)for(var o in i)o!=="default"&&Object.prototype.hasOwnProperty.call(i,o)&&up(n,i,o);return t(n,i),n},Xx=function(i){return i&&i.__esModule?i:{default:i}},Yx=function(i,n,o,a){if(o==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?i!==n||!a:!n.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?a:o==="a"?a.call(i):a?a.value:n.get(i)},$x=function(i,n,o,a,l){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!l)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?i!==n||!l:!n.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?l.call(i,o):l?l.value=o:n.set(i,o),o},s("__extends",Ox),s("__assign",Rx),s("__rest",Mx),s("__decorate",_x),s("__param",Bx),s("__metadata",Nx),s("__awaiter",Dx),s("__generator",Fx),s("__exportStar",Gx),s("__createBinding",up),s("__values",lp),s("__read",IP),s("__spread",Vx),s("__spreadArrays",kx),s("__spreadArray",Ux),s("__await",zu),s("__asyncGenerator",zx),s("__asyncDelegator",Hx),s("__asyncValues",Wx),s("__makeTemplateObject",jx),s("__importStar",qx),s("__importDefault",Xx),s("__classPrivateFieldGet",Yx),s("__classPrivateFieldSet",$x)})});var Kx=Me(hp=>{"use strict";Object.defineProperty(hp,"__esModule",{value:!0});hp.SortedSet=void 0;var wP=xb(),h2=ws(),Mh=Da(),Qx=Ua(),LP=class{constructor(...e){this._values=[];let t,i;if(e.length>0){let n=e[0];h2.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=Qx.Comparer.defaultComparer),this._comparer=typeof i=="function"?Qx.Comparer.create(i):i,t)for(let n of t)this.add(n)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return wP.binarySearch(this._values,e,this._comparer)>=0}add(e){let t=wP.binarySearch(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=wP.binarySearch(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){for(let i of this)e.call(t,i,i,this)}get[Mh.Collection.size](){return this.size}[Mh.Collection.has](e){return this.has(e)}[Mh.Collection.add](e){this.add(e)}[Mh.Collection.delete](e){return this.delete(e)}[Mh.Collection.clear](){this.clear()}};hp.SortedSet=LP;Object.defineProperty(LP,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedSet"})});var rv=Me(js=>{"use strict";Object.defineProperty(js,"__esModule",{value:!0});js.expandPrime=js.getPrime=js.isPrime=void 0;var d2=2**31-1,OP=2146435069,f2=101,Jx=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function ev(s){if(s&1){let e=Math.sqrt(s)|0;for(let t=3;t<=e;t+=2)if(!(s%t))return!1;return!0}return s===2}js.isPrime=ev;function tv(s){if(s<0)throw new RangeError;for(let e=0;e<Jx.length;e++){let t=Jx[e];if(t>=s)return t}for(let e=s|1;e<d2;e+=2)if(ev(e)&&(e-1)%f2)return e;return s}js.getPrime=tv;function p2(s){let e=2*s;return e>OP&&OP>s?OP:tv(e)}js.expandPrime=p2});var BP=Me(ze=>{"use strict";Object.defineProperty(ze,"__esModule",{value:!0});ze.forEachEntry=ze.iterateEntries=ze.selectEntryEntry=ze.selectEntryValue=ze.selectEntryKey=ze.trimExcessEntries=ze.ensureCapacity=ze.clearEntries=ze.deleteEntry=ze.insertEntry=ze.findEntryValue=ze.findEntryIndex=ze.resizeHashData=ze.initializeHashData=ze.createHashData=ze.createHashEntry=void 0;var _h=rv(),RP=2**31-1;function MP(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}ze.createHashEntry=MP;function g2(s,e){let t=MP(),i={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:s,head:t,tail:t};return Bh(i,e),i}ze.createHashData=g2;function Bh(s,e){let t=_h.getPrime(e);return s.freeList=-1,s.buckets=new Int32Array(t),s.entries=new Array(t),t}ze.initializeHashData=Bh;function _P(s,e){let t=s.size,i=new Int32Array(e),n=s.entries?s.entries.slice():[];n.length=e;for(let o=0;o<t;o++){let a=n[o];if(a&&a.hashCode>=0){let l=a.hashCode%e;a.next=i[l]-1,i[l]=o+1}}s.buckets=i,s.entries=n}ze.resizeHashData=_P;function iv(s,e){let t=-1,{buckets:i,entries:n,equaler:o}=s;if(i&&n){let a=o.hash(e)&RP;for(t=i[a%i.length]-1;t>>>0<n.length&&!(n[t].hashCode===a&&o.equals(n[t].key,e));)t=n[t].next}return t}ze.findEntryIndex=iv;function m2(s,e){let t=iv(s,e);return t>=0?s.entries[t].value:void 0}ze.findEntryValue=m2;function b2(s,e,t){if(s.buckets||Bh(s,0),!s.buckets||!s.entries)throw new Error;let i=s.equaler.hash(e)&RP,n=i%s.buckets.length,o=s.buckets[n]-1;for(;o>>>0<s.entries.length;){let h=s.entries[o];if(h.hashCode===i&&s.equaler.equals(h.key,e)){h.value=t;return}o=h.next}let a=!1,l;if(s.freeSize>0)l=s.freeList,a=!0,s.freeSize--;else{let h=s.size;if(h===s.entries.length){if(_P(s,_h.expandPrime(s.size)),!s.buckets||!s.entries)throw new Error;n=i%s.buckets.length}l=h,s.size=h+1}let u=s.entries[l]||(s.entries[l]=MP());a&&(s.freeList=u.next),u.hashCode=i,u.next=s.buckets[n]-1,u.key=e,u.value=t,u.skipNextEntry=!1;let c=s.tail;c.nextEntry=u,u.prevEntry=c,s.tail=u,s.buckets[n]=l+1}ze.insertEntry=b2;function P2(s,e){if(s.buckets&&s.entries){let t=s.equaler.hash(e)&RP,i=t%s.buckets.length,n=-1,o;for(let a=s.buckets[i]-1;a>=0;a=o.next){if(o=s.entries[a],o.hashCode===t&&s.equaler.equals(o.key,e)){n<0?s.buckets[i]=o.next+1:s.entries[n].next=o.next;let l=o.prevEntry;return l.nextEntry=o.nextEntry,l.nextEntry&&(l.nextEntry.prevEntry=l),s.tail===o&&(s.tail=l),o.hashCode=-1,o.next=s.freeList,o.key=void 0,o.value=void 0,o.prevEntry=void 0,o.nextEntry=l,o.skipNextEntry=!0,s.freeList=a,s.freeSize++,!0}n=a}}return!1}ze.deleteEntry=P2;function y2(s){if(s.size>0){s.buckets&&s.buckets.fill(0),s.entries&&s.entries.fill(void 0);let t=s.head.nextEntry;for(;t;){let i=t.nextEntry;t.prevEntry=void 0,t.nextEntry=s.head,t.skipNextEntry=!0,t=i}s.head.nextEntry=void 0,s.tail=s.head,s.size=0,s.freeList=-1,s.freeSize=0}}ze.clearEntries=y2;function S2(s,e){if(e<0)throw new RangeError;let t=s.entries?s.entries.length:0;if(t>=e)return t;if(!s.buckets)return Bh(s,e);let i=_h.getPrime(e);return _P(s,_h.getPrime(e)),i}ze.ensureCapacity=S2;function E2(s,e=s.size-s.freeSize){if(e<s.size)throw new RangeError;if(!s.buckets||!s.entries)return;let t=_h.getPrime(e),i=s.entries;if(t>=(i?i.length:0))return;let n=s.size;if(Bh(s,t),!s.buckets||!s.entries)throw new Error;let o=0;for(let a=0;a<n;a++){let l=i[a].hashCode;if(l>=0){let u=l%t;s.entries[o]=i[a],s.entries[o].next=s.buckets[u]-1,s.buckets[u]=o+1,o++}}s.size=o,s.freeSize=0}ze.trimExcessEntries=E2;function x2(s){return s.key}ze.selectEntryKey=x2;function v2(s){return s.value}ze.selectEntryValue=v2;function C2(s){return[s.key,s.value]}ze.selectEntryEntry=C2;function*A2(s,e){let t=s;for(;t;){let i=t.skipNextEntry;t=t.nextEntry,!i&&t&&(yield e(t))}}ze.iterateEntries=A2;function T2(s,e,t,i){let n=e;for(;n;){let o=n.skipNextEntry;n=n.nextEntry,!o&&n&&t.call(i,n.value,n.key,s)}}ze.forEachEntry=T2});var DP=Me(dp=>{"use strict";Object.defineProperty(dp,"__esModule",{value:!0});dp.HashMap=void 0;var qs=Da(),I2=Ua(),w2=ws(),ei=BP(),NP=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):w2.isIterable(o)||o===void 0?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=I2.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=ei.createHashData(n,t),i)for(let[o,a]of i)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return ei.findEntryIndex(this._hashData,e)>=0}get(e){return ei.findEntryValue(this._hashData,e)}set(e,t){return ei.insertEntry(this._hashData,e,t),this}delete(e){return ei.deleteEntry(this._hashData,e)}clear(){ei.clearEntries(this._hashData)}ensureCapacity(e){return ei.ensureCapacity(this._hashData,e)}trimExcess(e){ei.trimExcessEntries(this._hashData,e)}keys(){return ei.iterateEntries(this._hashData.head,ei.selectEntryKey)}values(){return ei.iterateEntries(this._hashData.head,ei.selectEntryValue)}entries(){return ei.iterateEntries(this._hashData.head,ei.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){ei.forEachEntry(this,this._hashData.head,e,t)}get[qs.ReadonlyKeyedCollection.size](){return this.size}[qs.ReadonlyKeyedCollection.has](e){return this.has(e)}[qs.ReadonlyKeyedCollection.get](e){return this.get(e)}[qs.ReadonlyKeyedCollection.keys](){return this.keys()}[qs.ReadonlyKeyedCollection.values](){return this.values()}[qs.KeyedCollection.set](e,t){this.set(e,t)}[qs.KeyedCollection.delete](e){return this.delete(e)}[qs.KeyedCollection.clear](){this.clear()}};dp.HashMap=NP;Object.defineProperty(NP,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashMap"})});var GP=Me(fp=>{"use strict";Object.defineProperty(fp,"__esModule",{value:!0});fp.HashSet=void 0;var Nh=Da(),L2=Ua(),O2=ws(),ti=BP(),FP=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):O2.isIterable(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=L2.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=ti.createHashData(n,t),i)for(let o of i)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return ti.findEntryIndex(this._hashData,e)>=0}add(e){return ti.insertEntry(this._hashData,e,e),this}tryAdd(e){let t=this.size;return ti.insertEntry(this._hashData,e,e),this.size>t}delete(e){return ti.deleteEntry(this._hashData,e)}clear(){ti.clearEntries(this._hashData)}ensureCapacity(e){return ti.ensureCapacity(this._hashData,e)}trimExcess(e){ti.trimExcessEntries(this._hashData,e)}keys(){return ti.iterateEntries(this._hashData.head,ti.selectEntryKey)}values(){return ti.iterateEntries(this._hashData.head,ti.selectEntryValue)}entries(){return ti.iterateEntries(this._hashData.head,ti.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){ti.forEachEntry(this,this._hashData.head,e,t)}get[Nh.Collection.size](){return this.size}[Nh.Collection.has](e){return this.has(e)}[Nh.Collection.add](e){this.add(e)}[Nh.Collection.delete](e){return this.delete(e)}[Nh.Collection.clear](){this.clear()}};fp.HashSet=FP;Object.defineProperty(FP,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashSet"})});var ov=Me(pp=>{"use strict";Object.defineProperty(pp,"__esModule",{value:!0});pp.MultiMap=void 0;var dl=ws(),nv=Ua(),uo=Da(),R2=DP(),M2=GP(),VP=class{constructor(...e){this._size=0;let t,i,n;B2(e)?[t,n={}]=e:(t=0,_2(e)?[i,n={}]=e:n={});let{keyEqualer:o=nv.Equaler.defaultEqualer,valueEqualer:a=nv.Equaler.defaultEqualer}=n;if(this._map=new R2.HashMap(t,o),this._keyEqualer=o,this._valueEqualer=a,i)for(let[l,u]of i)this.add(l,u)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let i=this._map.get(e);return i?i.has(t):!1}get(e){return this._map.get(e)}add(e,t){let i=this._map.get(e);i||(i=new M2.HashSet(this._valueEqualer),this._map.set(e,i));let n=i.size;return i.add(t),this._size+=i.size-n,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let i=this._map.get(e);if(i){let n=i.size;if(i.delete(t))return this._size+=i.size-n,i.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let i of t)yield[e,i]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this._map)for(let o of n)e.call(t,o,i,this)}get[uo.ReadonlyKeyedMultiCollection.size](){return this.size}[uo.ReadonlyKeyedMultiCollection.has](e){return this.has(e)}[uo.ReadonlyKeyedMultiCollection.hasValue](e,t){return this.hasValue(e,t)}[uo.ReadonlyKeyedMultiCollection.get](e){return this.get(e)}[uo.ReadonlyKeyedMultiCollection.keys](){return this.keys()}[uo.ReadonlyKeyedMultiCollection.values](){return this.values()}[uo.KeyedMultiCollection.add](e,t){this.add(e,t)}[uo.KeyedMultiCollection.delete](e){return this.delete(e)}[uo.KeyedMultiCollection.deleteValue](e,t){return this.deleteValue(e,t)}[uo.KeyedMultiCollection.clear](){this.clear()}};pp.MultiMap=VP;Object.defineProperty(VP,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"MultiMap"});function _2(s){return(s.length<1||!dl.isDefined(s[0])||dl.isIterable(s[0]))&&(s.length<2||!dl.isDefined(s[1])||dl.isObject(s[1]))}function B2(s){return(s.length<1||dl.isNumber(s[0]))&&(s.length<2||!dl.isDefined(s[1])||dl.isObject(s[1]))}});var cv=Me(Wu=>{"use strict";var av,lv,uv;Object.defineProperty(Wu,"__esModule",{value:!0});Wu.LinkedList=Wu.LinkedListNode=void 0;var ye=ws(),Dh=Da(),sv=Ua(),gp=Symbol("LinkedListNode.list"),Gr=Symbol("LinkedListNode.previous"),Er=Symbol("LinkedListNode.next"),hr=class{constructor(e){this[av]=void 0,this[lv]=void 0,this[uv]=void 0,this.value=e}get list(){return this[gp]}get previous(){if(this[Gr]&&this.list&&this!==this.list.first)return this[Gr]}get next(){if(this[Er]&&this.list&&this[Er]!==this.list.first)return this[Er]}detachSelf(){return this.list?this.list.deleteNode(this):!1}};Wu.LinkedListNode=hr;av=gp,lv=Gr,uv=Er;Object.defineProperty(hr.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedListNode"});var Hu=class{constructor(...e){this._size=0,this._head=void 0;let t,i;if(e.length>0&&(ye.isIterable(e[0])||ye.isMissing(e[0])?(t=e[0],e.length>1&&(i=e[1])):i=e[0]),ye.isMissing(i)&&(i=sv.Equaler.defaultEqualer),this._equaler=typeof i=="function"?sv.Equaler.create(i):i,t)for(let n of t)this.push(n)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return this._head[Gr]}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(!ye.isMissing(t)&&!ye.isInstance(t,hr))throw new TypeError("LinkedListNode expected: fromNode");if(!ye.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.first;i;i=i.next)if(this._equaler.equals(i.value,e))return i}lastNodeOf(e,t){if(!ye.isMissing(t)&&!ye.isInstance(t,hr))throw new TypeError("LinkedListNode expected: fromNode");if(!ye.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.last;i;i=i.previous)if(this._equaler.equals(i.value,e))return i}find(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;){i=n,n=i.next;let o=i.value;if(e.call(t,o,i,this))return o}}findLast(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;){i=n,n=i.previous;let o=i.value;if(e.call(t,o,i,this))return o}}findNode(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,e.call(t,i.value,i,this))return i}findLastNode(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;)if(i=n,n=i.previous,e.call(t,i.value,i,this))return i}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(!ye.isMissing(e)&&!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: node");if(!ye.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new hr(t),0)}insertNodeBefore(e,t){if(!ye.isMissing(e)&&!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: node");if(!ye.isInstance(t,hr))throw new TypeError("LinkedListNode expected: newNode");if(!ye.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ye.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(!ye.isMissing(e)&&!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: node");if(!ye.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new hr(t),1)}insertNodeAfter(e,t){if(!ye.isMissing(e)&&!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: node");if(!ye.isInstance(t,hr))throw new TypeError("LinkedListNode expected: newNode");if(!ye.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ye.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new hr(e),1)}pushNode(e){if(!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: newNode");if(!ye.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new hr(e),0)}unshiftNode(e){if(!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: newNode");if(!ye.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(!ye.isMissing(e)&&!ye.isInstance(e,hr))throw new TypeError("LinkedListNode expected: node");if(!ye.isMissing(e)&&!ye.isMissing(e.list)&&e.list!==this)throw new TypeError("Wrong list.");return ye.isMissing(e)||ye.isMissing(e.list)?!1:this._deleteNode(e)}deleteAll(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: predicate");let i=0,n=this.first;for(;n;){let o=n.next;e.call(t,n.value,n,this)&&n.list===this&&(this._deleteNode(n),++i),n=o}return i}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)i=n,n=i.next,e.call(t,i.value,i,this)}map(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");[].map;let i=new Hu,n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=e.call(t,n.value,n,this);i.push(a)}return i}filter(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i=new Hu(this.equaler),n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=n.value;e.call(t,a,n,this)&&i.push(a)}return i}reduce(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0)}return n}reduceRight(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0),a=o.previous}return n}some(e,t){if(!ye.isMissing(e)&&!ye.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,!e||e.call(t,i.value,i,this))return!0;return!1}every(e,t){if(!ye.isFunction(e))throw new TypeError("Function expected: callback");let i=!1,n,o=this.first;for(;o!==void 0;){if(n=o,o=n.next,!e.call(t,n.value,n,this))return!1;i=!0}return i}_deleteNode(e){return e[Er]===e?this._head=void 0:(e[Er][Gr]=e[Gr],e[Gr][Er]=e[Er],this._head===e&&(this._head=e[Er])),e[gp]=void 0,e[Er]=void 0,e[Gr]=void 0,this._size--,!0}_insertNode(e,t,i){if(t[gp]=this,this._head===void 0)t[Er]=t,t[Gr]=t,this._head=t;else switch(i){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),t[Er]=e,t[Gr]=e[Gr],e[Gr][Er]=t,e[Gr]=t;break;case 1:e===void 0&&(e=this._head[Gr]),t[Gr]=e,t[Er]=e[Er],e[Er][Gr]=t,e[Er]=t;break}return this._size++,t}get[Dh.ReadonlyCollection.size](){return this.size}[Dh.ReadonlyCollection.has](e){return this.has(e)}[Dh.Collection.add](e){this.push(e)}[Dh.Collection.delete](e){return!!this.delete(e)}[Dh.Collection.clear](){this.clear()}};Wu.LinkedList=Hu;Object.defineProperty(Hu.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedList"})});var mp=Me(Xs=>{"use strict";Object.defineProperty(Xs,"__esModule",{value:!0});var ju=Zx();ju.__exportStar(dh(),Xs);ju.__exportStar(Kx(),Xs);ju.__exportStar(DP(),Xs);ju.__exportStar(GP(),Xs);ju.__exportStar(ov(),Xs);ju.__exportStar(cv(),Xs)});var Dv=Me((rle,Nv)=>{Nv.exports={rgb2hsl:Hh,rgb2hsv:Ap,rgb2hwb:Wh,rgb2cmyk:jh,rgb2keyword:qh,rgb2xyz:r0,rgb2lab:i0,rgb2lch:cR,hsl2rgb:Tp,hsl2hsv:hR,hsl2hwb:dR,hsl2cmyk:fR,hsl2keyword:pR,hsv2rgb:Ip,hsv2hsl:gR,hsv2hwb:mR,hsv2cmyk:bR,hsv2keyword:PR,hwb2rgb:Xh,hwb2hsl:yR,hwb2hsv:SR,hwb2cmyk:ER,hwb2keyword:xR,cmyk2rgb:Yh,cmyk2hsl:vR,cmyk2hsv:CR,cmyk2hwb:AR,cmyk2keyword:TR,keyword2rgb:Pl,keyword2hsl:OR,keyword2hsv:RR,keyword2hwb:MR,keyword2cmyk:_R,keyword2lab:BR,keyword2xyz:NR,xyz2rgb:Rv,xyz2lab:Mv,xyz2lch:IR,lab2xyz:n0,lab2rgb:_v,lab2lch:o0,lch2lab:s0,lch2xyz:wR,lch2rgb:LR};function Hh(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(n+o)/2,o==n?u=0:c<=.5?u=a/(o+n):u=a/(2-o-n),[l,u*100,c*100]}function Ap(s){var e=s[0],t=s[1],i=s[2],n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function Wh(s){var e=s[0],t=s[1],o=s[2],i=Hh(s)[0],n=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[i,n*100,o*100]}function jh(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n,o,a,l;return l=Math.min(1-e,1-t,1-i),n=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-i-l)/(1-l)||0,[n*100,o*100,a*100,l*100]}function qh(s){return Bv[JSON.stringify(s)]}function r0(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;var n=e*.4124+t*.3576+i*.1805,o=e*.2126+t*.7152+i*.0722,a=e*.0193+t*.1192+i*.9505;return[n*100,o*100,a*100]}function i0(s){var e=r0(s),t=e[0],i=e[1],n=e[2],o,a,l;return t/=95.047,i/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=116*i-16,a=500*(t-i),l=200*(i-n),[o,a,l]}function cR(s){return o0(i0(s))}function Tp(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n,o,a,l,u;if(t==0)return u=i*255,[u,u,u];i<.5?o=i*(1+t):o=i+t-i*t,n=2*i-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=n+(o-n)*6*a:2*a<1?u=o:3*a<2?u=n+(o-n)*(2/3-a)*6:u=n,l[c]=u*255;return l}function hR(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return i===0?[0,0,0]:(i*=2,t*=i<=1?i:2-i,o=(i+t)/2,n=2*t/(i+t),[e,n*100,o*100])}function dR(s){return Wh(Tp(s))}function fR(s){return jh(Tp(s))}function pR(s){return qh(Tp(s))}function Ip(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,i=Math.floor(e)%6,n=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*n),l=255*u*(1-t*(1-n)),u=255*u;switch(i){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function gR(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return o=(2-t)*i,n=t*i,n/=o<=1?o:2-o,n=n||0,o/=2,[e,n*100,o*100]}function mR(s){return Wh(Ip(s))}function bR(s){return jh(Ip(s))}function PR(s){return qh(Ip(s))}function Xh(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n=t+i,o,a,l,u;switch(n>1&&(t/=n,i/=n),o=Math.floor(6*e),a=1-i,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function yR(s){return Hh(Xh(s))}function SR(s){return Ap(Xh(s))}function ER(s){return jh(Xh(s))}function xR(s){return qh(Xh(s))}function Yh(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-n)+n),a=1-Math.min(1,t*(1-n)+n),l=1-Math.min(1,i*(1-n)+n),[o*255,a*255,l*255]}function vR(s){return Hh(Yh(s))}function CR(s){return Ap(Yh(s))}function AR(s){return Wh(Yh(s))}function TR(s){return qh(Yh(s))}function Rv(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n,o,a;return n=e*3.2406+t*-1.5372+i*-.4986,o=e*-.9689+t*1.8758+i*.0415,a=e*.0557+t*-.204+i*1.057,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n=n*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,n=Math.min(Math.max(0,n),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[n*255,o*255,a*255]}function Mv(s){var e=s[0],t=s[1],i=s[2],n,o,a;return e/=95.047,t/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=116*t-16,o=500*(e-t),a=200*(t-i),[n,o,a]}function IR(s){return o0(Mv(s))}function n0(s){var e=s[0],t=s[1],i=s[2],n,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),n=n/95.047<=.008856?n=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-i/200-16/116)/7.787:108.883*Math.pow(l-i/200,3),[n,o,a]}function o0(s){var e=s[0],t=s[1],i=s[2],n,o,a;return n=Math.atan2(i,t),o=n*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+i*i),[e,a,o]}function _v(s){return Rv(n0(s))}function s0(s){var e=s[0],t=s[1],i=s[2],n,o,a;return a=i/360*2*Math.PI,n=t*Math.cos(a),o=t*Math.sin(a),[e,n,o]}function wR(s){return n0(s0(s))}function LR(s){return _v(s0(s))}function Pl(s){return t0[s]}function OR(s){return Hh(Pl(s))}function RR(s){return Ap(Pl(s))}function MR(s){return Wh(Pl(s))}function _R(s){return jh(Pl(s))}function BR(s){return i0(Pl(s))}function NR(s){return r0(Pl(s))}var t0={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},Bv={};for(e0 in t0)Bv[JSON.stringify(t0[e0])]=e0;var e0});var Vv=Me((ile,Gv)=>{var a0=Dv(),yl=function(){return new $h};for(Ku in a0)yl[Ku+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),a0[s](e)}}(Ku),l0=/(\w+)2(\w+)/.exec(Ku),wp=l0[1],Fv=l0[2],yl[wp]=yl[wp]||{},yl[wp][Fv]=yl[Ku]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=a0[s](e);if(typeof t=="string"||t===void 0)return t;for(var i=0;i<t.length;i++)t[i]=Math.round(t[i]);return t}}(Ku);var l0,wp,Fv,Ku,$h=function(){this.convs={}};$h.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};$h.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};$h.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,i=this.convs[t];e=yl[t][s](i),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){$h.prototype[s]=function(e){return this.routeSpace(s,arguments)}});Gv.exports=yl});var Uv=Me((nle,kv)=>{var u0=Vv();kv.exports=function(s){var e,t,i,n;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=u0[a],i=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&i.push(1),n=i[l]===void 0?1:i[l],i=i.slice(0,l),t[a]=function(){return i}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=u0.rgb,i=a.split(l===3?/(.)/:/(..)/),i=i.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),n=1,t.rgb=function(){return i},i[0]||(i[0]=0),i[1]||(i[1]=0),i[2]||(i[2]=0)}else t=u0.keyword,t.keyword=function(){return s},i=s,n=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(i)}catch{}try{u.hsl=t.hsl(i)}catch{}try{u.hsv=t.hsv(i)}catch{}try{u.cmyk=t.cmyk(i)}catch{}try{u.keyword=t.keyword(i)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(n)),u.hsl&&(u.hsla=u.hsl.concat(n)),u.hsv&&(u.hsva=u.hsv.concat(n)),u.cmyk&&(u.cmyka=u.cmyk.concat(n)),u}});var LT=Me((Qve,nm)=>{(function(s,e,t,i){"use strict";var n=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",l=Math.round,u=Math.abs,c=Date.now;function h(x,T,R){return setTimeout(D(x,R),T)}function d(x,T,R){return Array.isArray(x)?(f(x,R[T],R),!0):!1}function f(x,T,R){var G;if(!!x)if(x.forEach)x.forEach(T,R);else if(x.length!==i)for(G=0;G<x.length;)T.call(R,x[G],G,x),G++;else for(G in x)x.hasOwnProperty(G)&&T.call(R,x[G],G,x)}function P(x,T,R){var G="DEPRECATED METHOD: "+T+`
`+R+` AT 
`;return function(){var Z=new Error("get-stack-trace"),ne=Z&&Z.stack?Z.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",Oe=s.console&&(s.console.warn||s.console.log);return Oe&&Oe.call(s.console,G,ne),x.apply(this,arguments)}}var E;typeof Object.assign!="function"?E=function(T){if(T===i||T===null)throw new TypeError("Cannot convert undefined or null to object");for(var R=Object(T),G=1;G<arguments.length;G++){var Z=arguments[G];if(Z!==i&&Z!==null)for(var ne in Z)Z.hasOwnProperty(ne)&&(R[ne]=Z[ne])}return R}:E=Object.assign;var v=P(function(T,R,G){for(var Z=Object.keys(R),ne=0;ne<Z.length;)(!G||G&&T[Z[ne]]===i)&&(T[Z[ne]]=R[Z[ne]]),ne++;return T},"extend","Use `assign`."),L=P(function(T,R){return v(T,R,!0)},"merge","Use `assign`.");function O(x,T,R){var G=T.prototype,Z;Z=x.prototype=Object.create(G),Z.constructor=x,Z._super=G,R&&E(Z,R)}function D(x,T){return function(){return x.apply(T,arguments)}}function _(x,T){return typeof x==a?x.apply(T&&T[0]||i,T):x}function F(x,T){return x===i?T:x}function X(x,T,R){f(oe(T),function(G){x.addEventListener(G,R,!1)})}function $(x,T,R){f(oe(T),function(G){x.removeEventListener(G,R,!1)})}function se(x,T){for(;x;){if(x==T)return!0;x=x.parentNode}return!1}function ie(x,T){return x.indexOf(T)>-1}function oe(x){return x.trim().split(/\s+/g)}function ue(x,T,R){if(x.indexOf&&!R)return x.indexOf(T);for(var G=0;G<x.length;){if(R&&x[G][R]==T||!R&&x[G]===T)return G;G++}return-1}function Se(x){return Array.prototype.slice.call(x,0)}function ve(x,T,R){for(var G=[],Z=[],ne=0;ne<x.length;){var Oe=T?x[ne][T]:x[ne];ue(Z,Oe)<0&&G.push(x[ne]),Z[ne]=Oe,ne++}return R&&(T?G=G.sort(function(Yt,sr){return Yt[T]>sr[T]}):G=G.sort()),G}function Ce(x,T){for(var R,G,Z=T[0].toUpperCase()+T.slice(1),ne=0;ne<n.length;){if(R=n[ne],G=R?R+Z:T,G in x)return G;ne++}return i}var De=1;function Cr(){return De++}function Lo(x){var T=x.ownerDocument||x;return T.defaultView||T.parentWindow||s}var Yl=/mobile|tablet|ip(ad|hone|od)|android/i,Pa="ontouchstart"in s,$l=Ce(s,"PointerEvent")!==i,Uc=Pa&&Yl.test(navigator.userAgent),Oo="touch",Zl="pen",ya="mouse",ki="kinect",zc=25,Xt=1,ln=2,Et=4,nr=8,Vn=1,un=2,Ro=4,Mo=8,_o=16,li=un|Ro,fi=Mo|_o,Sa=li|fi,gs=["x","y"],Bo=["clientX","clientY"];function Ar(x,T){var R=this;this.manager=x,this.callback=T,this.element=x.element,this.target=x.options.inputTarget,this.domHandler=function(G){_(x.options.enable,[x])&&R.handler(G)},this.init()}Ar.prototype={handler:function(){},init:function(){this.evEl&&X(this.element,this.evEl,this.domHandler),this.evTarget&&X(this.target,this.evTarget,this.domHandler),this.evWin&&X(Lo(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&$(this.element,this.evEl,this.domHandler),this.evTarget&&$(this.target,this.evTarget,this.domHandler),this.evWin&&$(Lo(this.element),this.evWin,this.domHandler)}};function Ql(x){var T,R=x.options.inputClass;return R?T=R:$l?T=kn:Uc?T=Do:Pa?T=pi:T=Ps,new T(x,Ea)}function Ea(x,T,R){var G=R.pointers.length,Z=R.changedPointers.length,ne=T&Xt&&G-Z===0,Oe=T&(Et|nr)&&G-Z===0;R.isFirst=!!ne,R.isFinal=!!Oe,ne&&(x.session={}),R.eventType=T,Kl(x,R),x.emit("hammer.input",R),x.recognize(R),x.session.prevInput=R}function Kl(x,T){var R=x.session,G=T.pointers,Z=G.length;R.firstInput||(R.firstInput=eu(T)),Z>1&&!R.firstMultiple?R.firstMultiple=eu(T):Z===1&&(R.firstMultiple=!1);var ne=R.firstInput,Oe=R.firstMultiple,Ut=Oe?Oe.center:ne.center,Yt=T.center=cn(G);T.timeStamp=c(),T.deltaTime=T.timeStamp-ne.timeStamp,T.angle=bs(Ut,Yt),T.distance=No(Ut,Yt),ms(R,T),T.offsetDirection=xa(T.deltaX,T.deltaY);var sr=tu(T.deltaTime,T.deltaX,T.deltaY);T.overallVelocityX=sr.x,T.overallVelocityY=sr.y,T.overallVelocity=u(sr.x)>u(sr.y)?sr.x:sr.y,T.scale=Oe?ru(Oe.pointers,G):1,T.rotation=Oe?Hc(Oe.pointers,G):0,T.maxPointers=R.prevInput?T.pointers.length>R.prevInput.maxPointers?T.pointers.length:R.prevInput.maxPointers:T.pointers.length,Jl(R,T);var Pi=x.element;se(T.srcEvent.target,Pi)&&(Pi=T.srcEvent.target),T.target=Pi}function ms(x,T){var R=T.center,G=x.offsetDelta||{},Z=x.prevDelta||{},ne=x.prevInput||{};(T.eventType===Xt||ne.eventType===Et)&&(Z=x.prevDelta={x:ne.deltaX||0,y:ne.deltaY||0},G=x.offsetDelta={x:R.x,y:R.y}),T.deltaX=Z.x+(R.x-G.x),T.deltaY=Z.y+(R.y-G.y)}function Jl(x,T){var R=x.lastInterval||T,G=T.timeStamp-R.timeStamp,Z,ne,Oe,Ut;if(T.eventType!=nr&&(G>zc||R.velocity===i)){var Yt=T.deltaX-R.deltaX,sr=T.deltaY-R.deltaY,Pi=tu(G,Yt,sr);ne=Pi.x,Oe=Pi.y,Z=u(Pi.x)>u(Pi.y)?Pi.x:Pi.y,Ut=xa(Yt,sr),x.lastInterval=T}else Z=R.velocity,ne=R.velocityX,Oe=R.velocityY,Ut=R.direction;T.velocity=Z,T.velocityX=ne,T.velocityY=Oe,T.direction=Ut}function eu(x){for(var T=[],R=0;R<x.pointers.length;)T[R]={clientX:l(x.pointers[R].clientX),clientY:l(x.pointers[R].clientY)},R++;return{timeStamp:c(),pointers:T,center:cn(T),deltaX:x.deltaX,deltaY:x.deltaY}}function cn(x){var T=x.length;if(T===1)return{x:l(x[0].clientX),y:l(x[0].clientY)};for(var R=0,G=0,Z=0;Z<T;)R+=x[Z].clientX,G+=x[Z].clientY,Z++;return{x:l(R/T),y:l(G/T)}}function tu(x,T,R){return{x:T/x||0,y:R/x||0}}function xa(x,T){return x===T?Vn:u(x)>=u(T)?x<0?un:Ro:T<0?Mo:_o}function No(x,T,R){R||(R=gs);var G=T[R[0]]-x[R[0]],Z=T[R[1]]-x[R[1]];return Math.sqrt(G*G+Z*Z)}function bs(x,T,R){R||(R=gs);var G=T[R[0]]-x[R[0]],Z=T[R[1]]-x[R[1]];return Math.atan2(Z,G)*180/Math.PI}function Hc(x,T){return bs(T[1],T[0],Bo)+bs(x[1],x[0],Bo)}function ru(x,T){return No(T[0],T[1],Bo)/No(x[0],x[1],Bo)}var iu={mousedown:Xt,mousemove:ln,mouseup:Et},Wc="mousedown",nu="mousemove mouseup";function Ps(){this.evEl=Wc,this.evWin=nu,this.pressed=!1,Ar.apply(this,arguments)}O(Ps,Ar,{handler:function(T){var R=iu[T.type];R&Xt&&T.button===0&&(this.pressed=!0),R&ln&&T.which!==1&&(R=Et),this.pressed&&(R&Et&&(this.pressed=!1),this.callback(this.manager,R,{pointers:[T],changedPointers:[T],pointerType:ya,srcEvent:T}))}});var jc={pointerdown:Xt,pointermove:ln,pointerup:Et,pointercancel:nr,pointerout:nr},qc={2:Oo,3:Zl,4:ya,5:ki},va="pointerdown",Ca="pointermove pointerup pointercancel";s.MSPointerEvent&&!s.PointerEvent&&(va="MSPointerDown",Ca="MSPointerMove MSPointerUp MSPointerCancel");function kn(){this.evEl=va,this.evWin=Ca,Ar.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}O(kn,Ar,{handler:function(T){var R=this.store,G=!1,Z=T.type.toLowerCase().replace("ms",""),ne=jc[Z],Oe=qc[T.pointerType]||T.pointerType,Ut=Oe==Oo,Yt=ue(R,T.pointerId,"pointerId");ne&Xt&&(T.button===0||Ut)?Yt<0&&(R.push(T),Yt=R.length-1):ne&(Et|nr)&&(G=!0),!(Yt<0)&&(R[Yt]=T,this.callback(this.manager,ne,{pointers:R,changedPointers:[T],pointerType:Oe,srcEvent:T}),G&&R.splice(Yt,1))}});var ou={touchstart:Xt,touchmove:ln,touchend:Et,touchcancel:nr},su="touchstart",Aa="touchstart touchmove touchend touchcancel";function ys(){this.evTarget=su,this.evWin=Aa,this.started=!1,Ar.apply(this,arguments)}O(ys,Ar,{handler:function(T){var R=ou[T.type];if(R===Xt&&(this.started=!0),!!this.started){var G=hn.call(this,T,R);R&(Et|nr)&&G[0].length-G[1].length===0&&(this.started=!1),this.callback(this.manager,R,{pointers:G[0],changedPointers:G[1],pointerType:Oo,srcEvent:T})}}});function hn(x,T){var R=Se(x.touches),G=Se(x.changedTouches);return T&(Et|nr)&&(R=ve(R.concat(G),"identifier",!0)),[R,G]}var dn={touchstart:Xt,touchmove:ln,touchend:Et,touchcancel:nr},au="touchstart touchmove touchend touchcancel";function Do(){this.evTarget=au,this.targetIds={},Ar.apply(this,arguments)}O(Do,Ar,{handler:function(T){var R=dn[T.type],G=jr.call(this,T,R);!G||this.callback(this.manager,R,{pointers:G[0],changedPointers:G[1],pointerType:Oo,srcEvent:T})}});function jr(x,T){var R=Se(x.touches),G=this.targetIds;if(T&(Xt|ln)&&R.length===1)return G[R[0].identifier]=!0,[R,R];var Z,ne,Oe=Se(x.changedTouches),Ut=[],Yt=this.target;if(ne=R.filter(function(sr){return se(sr.target,Yt)}),T===Xt)for(Z=0;Z<ne.length;)G[ne[Z].identifier]=!0,Z++;for(Z=0;Z<Oe.length;)G[Oe[Z].identifier]&&Ut.push(Oe[Z]),T&(Et|nr)&&delete G[Oe[Z].identifier],Z++;if(!!Ut.length)return[ve(ne.concat(Ut),"identifier",!0),Ut]}var Un=2500,Ss=25;function pi(){Ar.apply(this,arguments);var x=D(this.handler,this);this.touch=new Do(this.manager,x),this.mouse=new Ps(this.manager,x),this.primaryTouch=null,this.lastTouches=[]}O(pi,Ar,{handler:function(T,R,G){var Z=G.pointerType==Oo,ne=G.pointerType==ya;if(!(ne&&G.sourceCapabilities&&G.sourceCapabilities.firesTouchEvents)){if(Z)Es.call(this,R,G);else if(ne&&fn.call(this,G))return;this.callback(T,R,G)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function Es(x,T){x&Xt?(this.primaryTouch=T.changedPointers[0].identifier,or.call(this,T)):x&(Et|nr)&&or.call(this,T)}function or(x){var T=x.changedPointers[0];if(T.identifier===this.primaryTouch){var R={x:T.clientX,y:T.clientY};this.lastTouches.push(R);var G=this.lastTouches,Z=function(){var ne=G.indexOf(R);ne>-1&&G.splice(ne,1)};setTimeout(Z,Un)}}function fn(x){for(var T=x.srcEvent.clientX,R=x.srcEvent.clientY,G=0;G<this.lastTouches.length;G++){var Z=this.lastTouches[G],ne=Math.abs(T-Z.x),Oe=Math.abs(R-Z.y);if(ne<=Ss&&Oe<=Ss)return!0}return!1}var Ta=Ce(o.style,"touchAction"),zn=Ta!==i,xs="compute",Ui="auto",k="manipulation",Q="none",J="pan-x",re="pan-y",Ie=Mt();function He(x,T){this.manager=x,this.set(T)}He.prototype={set:function(x){x==xs&&(x=this.compute()),zn&&this.manager.element.style&&Ie[x]&&(this.manager.element.style[Ta]=x),this.actions=x.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var x=[];return f(this.manager.recognizers,function(T){_(T.options.enable,[T])&&(x=x.concat(T.getTouchAction()))}),Ye(x.join(" "))},preventDefaults:function(x){var T=x.srcEvent,R=x.offsetDirection;if(this.manager.session.prevented){T.preventDefault();return}var G=this.actions,Z=ie(G,Q)&&!Ie[Q],ne=ie(G,re)&&!Ie[re],Oe=ie(G,J)&&!Ie[J];if(Z){var Ut=x.pointers.length===1,Yt=x.distance<2,sr=x.deltaTime<250;if(Ut&&Yt&&sr)return}if(!(Oe&&ne)&&(Z||ne&&R&li||Oe&&R&fi))return this.preventSrc(T)},preventSrc:function(x){this.manager.session.prevented=!0,x.preventDefault()}};function Ye(x){if(ie(x,Q))return Q;var T=ie(x,J),R=ie(x,re);return T&&R?Q:T||R?T?J:re:ie(x,k)?k:Ui}function Mt(){if(!zn)return!1;var x={},T=s.CSS&&s.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(R){x[R]=T?s.CSS.supports("touch-action",R):!0}),x}var gi=1,wt=2,zi=4,mi=8,pn=mi,Ia=16,Hi=32;function gn(x){this.options=E({},this.defaults,x||{}),this.id=Cr(),this.manager=null,this.options.enable=F(this.options.enable,!0),this.state=gi,this.simultaneous={},this.requireFail=[]}gn.prototype={defaults:{},set:function(x){return E(this.options,x),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(x){if(d(x,"recognizeWith",this))return this;var T=this.simultaneous;return x=lu(x,this),T[x.id]||(T[x.id]=x,x.recognizeWith(this)),this},dropRecognizeWith:function(x){return d(x,"dropRecognizeWith",this)?this:(x=lu(x,this),delete this.simultaneous[x.id],this)},requireFailure:function(x){if(d(x,"requireFailure",this))return this;var T=this.requireFail;return x=lu(x,this),ue(T,x)===-1&&(T.push(x),x.requireFailure(this)),this},dropRequireFailure:function(x){if(d(x,"dropRequireFailure",this))return this;x=lu(x,this);var T=ue(this.requireFail,x);return T>-1&&this.requireFail.splice(T,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(x){return!!this.simultaneous[x.id]},emit:function(x){var T=this,R=this.state;function G(Z){T.manager.emit(Z,x)}R<mi&&G(T.options.event+rf(R)),G(T.options.event),x.additionalEvent&&G(x.additionalEvent),R>=mi&&G(T.options.event+rf(R))},tryEmit:function(x){if(this.canEmit())return this.emit(x);this.state=Hi},canEmit:function(){for(var x=0;x<this.requireFail.length;){if(!(this.requireFail[x].state&(Hi|gi)))return!1;x++}return!0},recognize:function(x){var T=E({},x);if(!_(this.options.enable,[this,T])){this.reset(),this.state=Hi;return}this.state&(pn|Ia|Hi)&&(this.state=gi),this.state=this.process(T),this.state&(wt|zi|mi|Ia)&&this.tryEmit(T)},process:function(x){},getTouchAction:function(){},reset:function(){}};function rf(x){return x&Ia?"cancel":x&mi?"end":x&zi?"move":x&wt?"start":""}function nf(x){return x==_o?"down":x==Mo?"up":x==un?"left":x==Ro?"right":""}function lu(x,T){var R=T.manager;return R?R.get(x):x}function bi(){gn.apply(this,arguments)}O(bi,gn,{defaults:{pointers:1},attrTest:function(x){var T=this.options.pointers;return T===0||x.pointers.length===T},process:function(x){var T=this.state,R=x.eventType,G=T&(wt|zi),Z=this.attrTest(x);return G&&(R&nr||!Z)?T|Ia:G||Z?R&Et?T|mi:T&wt?T|zi:wt:Hi}});function wa(){bi.apply(this,arguments),this.pX=null,this.pY=null}O(wa,bi,{defaults:{event:"pan",threshold:10,pointers:1,direction:Sa},getTouchAction:function(){var x=this.options.direction,T=[];return x&li&&T.push(re),x&fi&&T.push(J),T},directionTest:function(x){var T=this.options,R=!0,G=x.distance,Z=x.direction,ne=x.deltaX,Oe=x.deltaY;return Z&T.direction||(T.direction&li?(Z=ne===0?Vn:ne<0?un:Ro,R=ne!=this.pX,G=Math.abs(x.deltaX)):(Z=Oe===0?Vn:Oe<0?Mo:_o,R=Oe!=this.pY,G=Math.abs(x.deltaY))),x.direction=Z,R&&G>T.threshold&&Z&T.direction},attrTest:function(x){return bi.prototype.attrTest.call(this,x)&&(this.state&wt||!(this.state&wt)&&this.directionTest(x))},emit:function(x){this.pX=x.deltaX,this.pY=x.deltaY;var T=nf(x.direction);T&&(x.additionalEvent=this.options.event+T),this._super.emit.call(this,x)}});function Xc(){bi.apply(this,arguments)}O(Xc,bi,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Q]},attrTest:function(x){return this._super.attrTest.call(this,x)&&(Math.abs(x.scale-1)>this.options.threshold||this.state&wt)},emit:function(x){if(x.scale!==1){var T=x.scale<1?"in":"out";x.additionalEvent=this.options.event+T}this._super.emit.call(this,x)}});function Yc(){gn.apply(this,arguments),this._timer=null,this._input=null}O(Yc,gn,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[Ui]},process:function(x){var T=this.options,R=x.pointers.length===T.pointers,G=x.distance<T.threshold,Z=x.deltaTime>T.time;if(this._input=x,!G||!R||x.eventType&(Et|nr)&&!Z)this.reset();else if(x.eventType&Xt)this.reset(),this._timer=h(function(){this.state=pn,this.tryEmit()},T.time,this);else if(x.eventType&Et)return pn;return Hi},reset:function(){clearTimeout(this._timer)},emit:function(x){this.state===pn&&(x&&x.eventType&Et?this.manager.emit(this.options.event+"up",x):(this._input.timeStamp=c(),this.manager.emit(this.options.event,this._input)))}});function $c(){bi.apply(this,arguments)}O($c,bi,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Q]},attrTest:function(x){return this._super.attrTest.call(this,x)&&(Math.abs(x.rotation)>this.options.threshold||this.state&wt)}});function Zc(){bi.apply(this,arguments)}O(Zc,bi,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:li|fi,pointers:1},getTouchAction:function(){return wa.prototype.getTouchAction.call(this)},attrTest:function(x){var T=this.options.direction,R;return T&(li|fi)?R=x.overallVelocity:T&li?R=x.overallVelocityX:T&fi&&(R=x.overallVelocityY),this._super.attrTest.call(this,x)&&T&x.offsetDirection&&x.distance>this.options.threshold&&x.maxPointers==this.options.pointers&&u(R)>this.options.velocity&&x.eventType&Et},emit:function(x){var T=nf(x.offsetDirection);T&&this.manager.emit(this.options.event+T,x),this.manager.emit(this.options.event,x)}});function uu(){gn.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}O(uu,gn,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[k]},process:function(x){var T=this.options,R=x.pointers.length===T.pointers,G=x.distance<T.threshold,Z=x.deltaTime<T.time;if(this.reset(),x.eventType&Xt&&this.count===0)return this.failTimeout();if(G&&Z&&R){if(x.eventType!=Et)return this.failTimeout();var ne=this.pTime?x.timeStamp-this.pTime<T.interval:!0,Oe=!this.pCenter||No(this.pCenter,x.center)<T.posThreshold;this.pTime=x.timeStamp,this.pCenter=x.center,!Oe||!ne?this.count=1:this.count+=1,this._input=x;var Ut=this.count%T.taps;if(Ut===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=pn,this.tryEmit()},T.interval,this),wt):pn}return Hi},failTimeout:function(){return this._timer=h(function(){this.state=Hi},this.options.interval,this),Hi},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==pn&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function Wi(x,T){return T=T||{},T.recognizers=F(T.recognizers,Wi.defaults.preset),new La(x,T)}Wi.VERSION="2.0.7",Wi.defaults={domEvents:!1,touchAction:xs,enable:!0,inputTarget:null,inputClass:null,preset:[[$c,{enable:!1}],[Xc,{enable:!1},["rotate"]],[Zc,{direction:li}],[wa,{direction:li},["swipe"]],[uu],[uu,{event:"doubletap",taps:2},["tap"]],[Yc]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Zm=1,Fo=2;function La(x,T){this.options=E({},Wi.defaults,T||{}),this.options.inputTarget=this.options.inputTarget||x,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=x,this.input=Ql(this),this.touchAction=new He(this,this.options.touchAction),Qc(this,!0),f(this.options.recognizers,function(R){var G=this.add(new R[0](R[1]));R[2]&&G.recognizeWith(R[2]),R[3]&&G.requireFailure(R[3])},this)}La.prototype={set:function(x){return E(this.options,x),x.touchAction&&this.touchAction.update(),x.inputTarget&&(this.input.destroy(),this.input.target=x.inputTarget,this.input.init()),this},stop:function(x){this.session.stopped=x?Fo:Zm},recognize:function(x){var T=this.session;if(!T.stopped){this.touchAction.preventDefaults(x);var R,G=this.recognizers,Z=T.curRecognizer;(!Z||Z&&Z.state&pn)&&(Z=T.curRecognizer=null);for(var ne=0;ne<G.length;)R=G[ne],T.stopped!==Fo&&(!Z||R==Z||R.canRecognizeWith(Z))?R.recognize(x):R.reset(),!Z&&R.state&(wt|zi|mi)&&(Z=T.curRecognizer=R),ne++}},get:function(x){if(x instanceof gn)return x;for(var T=this.recognizers,R=0;R<T.length;R++)if(T[R].options.event==x)return T[R];return null},add:function(x){if(d(x,"add",this))return this;var T=this.get(x.options.event);return T&&this.remove(T),this.recognizers.push(x),x.manager=this,this.touchAction.update(),x},remove:function(x){if(d(x,"remove",this))return this;if(x=this.get(x),x){var T=this.recognizers,R=ue(T,x);R!==-1&&(T.splice(R,1),this.touchAction.update())}return this},on:function(x,T){if(x!==i&&T!==i){var R=this.handlers;return f(oe(x),function(G){R[G]=R[G]||[],R[G].push(T)}),this}},off:function(x,T){if(x!==i){var R=this.handlers;return f(oe(x),function(G){T?R[G]&&R[G].splice(ue(R[G],T),1):delete R[G]}),this}},emit:function(x,T){this.options.domEvents&&Qm(x,T);var R=this.handlers[x]&&this.handlers[x].slice();if(!(!R||!R.length)){T.type=x,T.preventDefault=function(){T.srcEvent.preventDefault()};for(var G=0;G<R.length;)R[G](T),G++}},destroy:function(){this.element&&Qc(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function Qc(x,T){var R=x.element;if(!!R.style){var G;f(x.options.cssProps,function(Z,ne){G=Ce(R.style,ne),T?(x.oldCssProps[G]=R.style[G],R.style[G]=Z):R.style[G]=x.oldCssProps[G]||""}),T||(x.oldCssProps={})}}function Qm(x,T){var R=e.createEvent("Event");R.initEvent(x,!0,!0),R.gesture=T,T.target.dispatchEvent(R)}E(Wi,{INPUT_START:Xt,INPUT_MOVE:ln,INPUT_END:Et,INPUT_CANCEL:nr,STATE_POSSIBLE:gi,STATE_BEGAN:wt,STATE_CHANGED:zi,STATE_ENDED:mi,STATE_RECOGNIZED:pn,STATE_CANCELLED:Ia,STATE_FAILED:Hi,DIRECTION_NONE:Vn,DIRECTION_LEFT:un,DIRECTION_RIGHT:Ro,DIRECTION_UP:Mo,DIRECTION_DOWN:_o,DIRECTION_HORIZONTAL:li,DIRECTION_VERTICAL:fi,DIRECTION_ALL:Sa,Manager:La,Input:Ar,TouchAction:He,TouchInput:Do,MouseInput:Ps,PointerEventInput:kn,TouchMouseInput:pi,SingleTouchInput:ys,Recognizer:gn,AttrRecognizer:bi,Tap:uu,Pan:wa,Swipe:Zc,Pinch:Xc,Rotate:$c,Press:Yc,on:X,off:$,each:f,merge:L,extend:v,assign:E,inherit:O,bindFn:D,prefixed:Ce});var Km=typeof s<"u"?s:typeof self<"u"?self:{};Km.Hammer=Wi,typeof define=="function"&&define.amd?define(function(){return Wi}):typeof nm<"u"&&nm.exports?nm.exports=Wi:s[t]=Wi})(window,document,"Hammer")});var FI=Me((vIe,SS)=>{"use strict";SS.exports=Wd;SS.exports.default=Wd;var Dc=1e20;function Wd(s,e,t,i,n,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=i||.25,this.fontFamily=n||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function RV(s,e,t,i,n,o,a){o.fill(Dc,0,e*t),a.fill(0,0,e*t);for(var l=(e-i)/2,u=0;u<n;u++)for(var c=0;c<i;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*i+c)+3]/255;if(d===1)o[h]=0,a[h]=Dc;else if(d===0)o[h]=Dc,a[h]=0;else{var f=Math.max(0,.5-d),P=Math.max(0,d-.5);o[h]=f*f,a[h]=P*P}}}function MV(s,e,t,i,n,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(i[l])-Math.sqrt(n[l]);s[l]=Math.round(255-255*(u/o+a))}}Wd.prototype._draw=function(s,e){var t=this.ctx.measureText(s),i=t.width,n=2*this.buffer,o,a,l,u,c,h,d,f;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),f=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+n,l=u+n,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,f=this.middle,this.ctx.textBaseline="middle");var P;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,f),P=this.ctx.getImageData(d,h,a,u));var E=new Uint8ClampedArray(o*l);return RV(P,o,l,a,u,this.gridOuter,this.gridInner),NI(this.gridOuter,o,l,this.f,this.v,this.z),NI(this.gridInner,o,l,this.f,this.v,this.z),MV(E,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:E,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:i}}};Wd.prototype.draw=function(s){return this._draw(s,!1).data};Wd.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function NI(s,e,t,i,n,o){for(var a=0;a<e;a++)DI(s,a,e,t,i,n,o);for(var l=0;l<t;l++)DI(s,l*e,1,e,i,n,o)}function DI(s,e,t,i,n,o,a){var l,u,c,h;for(o[0]=0,a[0]=-Dc,a[1]=Dc,l=0;l<i;l++)n[l]=s[e+l*t];for(l=1,u=0,c=0;l<i;l++){do h=o[u],c=(n[l]-n[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=Dc}for(l=0,u=0;l<i;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=n[h]+(l-h)*(l-h)}}});var uw=Me((yLe,km)=>{km.exports=lw;km.exports.addWheelListener=lw;km.exports.removeWheelListener=sk;function lw(s,e,t){s.addEventListener("wheel",e,t)}function sk(s,e,t){s.removeEventListener("wheel",e,t)}});var gw=Me((SLe,pw)=>{var ak=4,lk=.001,uk=1e-7,ck=10,Qd=11,Um=1/(Qd-1),hk=typeof Float32Array=="function";function cw(s,e){return 1-3*e+3*s}function hw(s,e){return 3*e-6*s}function dw(s){return 3*s}function zm(s,e,t){return((cw(e,t)*s+hw(e,t))*s+dw(e))*s}function fw(s,e,t){return 3*cw(e,t)*s*s+2*hw(e,t)*s+dw(e)}function dk(s,e,t,i,n){var o,a,l=0;do a=e+(t-e)/2,o=zm(a,i,n)-s,o>0?t=a:e=a;while(Math.abs(o)>uk&&++l<ck);return a}function fk(s,e,t,i){for(var n=0;n<ak;++n){var o=fw(e,t,i);if(o===0)return e;var a=zm(e,t,i)-s;e-=a/o}return e}function pk(s){return s}pw.exports=function(e,t,i,n){if(!(0<=e&&e<=1&&0<=i&&i<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===t&&i===n)return pk;for(var o=hk?new Float32Array(Qd):new Array(Qd),a=0;a<Qd;++a)o[a]=zm(a*Um,e,i);function l(u){for(var c=0,h=1,d=Qd-1;h!==d&&o[h]<=u;++h)c+=Um;--h;var f=(u-o[h])/(o[h+1]-o[h]),P=c+f*Um,E=fw(P,e,i);return E>=lk?fk(u,P,e,i):E===0?P:dk(u,c,c+Um,e,i)}return function(c){return c===0?0:c===1?1:zm(l(c),t,n)}}});var yw=Me((ELe,Hm)=>{var Kd=gw(),mw={ease:Kd(.25,.1,.25,1),easeIn:Kd(.42,0,1,1),easeOut:Kd(0,0,.58,1),easeInOut:Kd(.42,0,.58,1),linear:Kd(0,0,1,1)};Hm.exports=gk;Hm.exports.makeAggregateRaf=Pw;Hm.exports.sharedScheduler=Pw();function gk(s,e,t){var i=Object.create(null),n=Object.create(null);t=t||{};var o=typeof t.easing=="function"?t.easing:mw[t.easing];o||(t.easing&&console.warn("Unknown easing function in amator: "+t.easing),o=mw.ease);var a=typeof t.step=="function"?t.step:bw,l=typeof t.done=="function"?t.done:bw,u=mk(t.scheduler),c=Object.keys(e);c.forEach(function(O){i[O]=s[O],n[O]=e[O]-s[O]});var h=typeof t.duration=="number"?t.duration:400,d=Math.max(1,h*.06),f,P=0;return f=u.next(v),{cancel:E};function E(){u.cancel(f),f=0}function v(){var O=o(P/d);P+=1,L(O),P<=d?(f=u.next(v),a(s)):(f=0,setTimeout(function(){l(s)},0))}function L(O){c.forEach(function(D){s[D]=n[D]*O+i[D]})}}function bw(){}function mk(s){if(!s){var e=typeof window<"u"&&window.requestAnimationFrame;return e?bk():Pk()}if(typeof s.next!="function")throw new Error("Scheduler is supposed to have next(cb) function");if(typeof s.cancel!="function")throw new Error("Scheduler is supposed to have cancel(handle) function");return s}function bk(){return{next:window.requestAnimationFrame.bind(window),cancel:window.cancelAnimationFrame.bind(window)}}function Pk(){return{next:function(s){return setTimeout(s,1e3/60)},cancel:function(s){return clearTimeout(s)}}}function Pw(){var s=new Set,e=new Set,t=0;return{next:n,cancel:n,clearAll:i};function i(){s.clear(),e.clear(),cancelAnimationFrame(t),t=0}function n(u){e.add(u),o()}function o(){t||(t=requestAnimationFrame(a))}function a(){t=0;var u=e;e=s,s=u,s.forEach(function(c){c()}),s.clear()}function l(u){e.delete(u)}}});var Ew=Me((xLe,Sw)=>{Sw.exports=function(e){Sk(e);var t=yk(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e};function yk(s){var e=Object.create(null);return{on:function(t,i,n){if(typeof i!="function")throw new Error("callback is expected to be a function");var o=e[t];return o||(o=e[t]=[]),o.push({callback:i,ctx:n}),s},off:function(t,i){var n=typeof t>"u";if(n)return e=Object.create(null),s;if(e[t]){var o=typeof i!="function";if(o)delete e[t];else for(var a=e[t],l=0;l<a.length;++l)a[l].callback===i&&a.splice(l,1)}return s},fire:function(t){var i=e[t];if(!i)return s;var n;arguments.length>1&&(n=Array.prototype.splice.call(arguments,1));for(var o=0;o<i.length;++o){var a=i[o];a.callback.apply(a.ctx,n)}return s}}}function Sk(s){if(!s)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],t=0;t<e.length;++t)if(s.hasOwnProperty(e[t]))throw new Error("Subject cannot be eventified, since it already has property '"+e[t]+"'")}});var vw=Me((vLe,xw)=>{xw.exports=Ek;function Ek(s,e,t){typeof t!="object"&&(t={});var i=typeof t.minVelocity=="number"?t.minVelocity:5,n=typeof t.amplitude=="number"?t.amplitude:.25,o=typeof t.cancelAnimationFrame=="function"?t.cancelAnimationFrame:xk(),a=typeof t.requestAnimationFrame=="function"?t.requestAnimationFrame:vk(),l,u,c=342,h,d,f,P,E,v,L,O;return{start:_,stop:X,cancel:D};function D(){o(h),o(O)}function _(){l=s(),P=L=d=E=0,u=new Date,o(h),o(O),h=a(F)}function F(){var se=Date.now(),ie=se-u;u=se;var oe=s(),ue=oe.x-l.x,Se=oe.y-l.y;l=oe;var ve=1e3/(1+ie);d=.8*ue*ve+.2*d,E=.8*Se*ve+.2*E,h=a(F)}function X(){o(h),o(O);var se=s();f=se.x,v=se.y,u=Date.now(),(d<-i||d>i)&&(P=n*d,f+=P),(E<-i||E>i)&&(L=n*E,v+=L),O=a($)}function $(){var se=Date.now()-u,ie=!1,oe=0,ue=0;P&&(oe=-P*Math.exp(-se/c),oe>.5||oe<-.5?ie=!0:oe=P=0),L&&(ue=-L*Math.exp(-se/c),ue>.5||ue<-.5?ie=!0:ue=L=0),ie&&(e(f+oe,v+ue),O=a($))}}function xk(){return typeof cancelAnimationFrame=="function"?cancelAnimationFrame:clearTimeout}function vk(){return typeof requestAnimationFrame=="function"?requestAnimationFrame:function(s){return setTimeout(s,16)}}});var Iw=Me((CLe,Tw)=>{Tw.exports=Ck;function Ck(s){if(s)return{capture:Aw,release:Aw};var e,t,i,n=!1;return{capture:o,release:a};function o(l){n=!0,t=window.document.onselectstart,i=window.document.ondragstart,window.document.onselectstart=Cw,e=l,e.ondragstart=Cw}function a(){!n||(n=!1,window.document.onselectstart=t,e&&(e.ondragstart=i))}}function Cw(s){return s.stopPropagation(),!1}function Aw(){}});var Lw=Me((ALe,ww)=>{ww.exports=Ak;function Ak(){this.x=0,this.y=0,this.scale=1}});var Rw=Me((TLe,AS)=>{AS.exports=Tk;AS.exports.canAttach=Ow;function Tk(s,e){if(!Ow(s))throw new Error("svg element is required for svg.panzoom to work");var t=s.ownerSVGElement;if(!t)throw new Error("Do not apply panzoom to the root <svg> element. Use its child instead (e.g. <g></g>). As of March 2016 only FireFox supported transform on the root element");e.disableKeyboardInteraction||t.setAttribute("tabindex",0);var i={getBBox:o,getScreenCTM:a,getOwner:n,applyTransform:u,initTransform:l};return i;function n(){return t}function o(){var c=s.getBBox();return{left:c.x,top:c.y,width:c.width,height:c.height}}function a(){var c=t.getCTM();return c||t.getScreenCTM()}function l(c){var h=s.getCTM();h===null&&(h=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix()),c.x=h.e,c.y=h.f,c.scale=h.a,t.removeAttributeNS(null,"viewBox")}function u(c){s.setAttribute("transform","matrix("+c.scale+" 0 0 "+c.scale+" "+c.x+" "+c.y+")")}}function Ow(s){return s&&s.ownerSVGElement&&s.getCTM}});var _w=Me((ILe,TS)=>{TS.exports=Ik;TS.exports.canAttach=Mw;function Ik(s,e){var t=Mw(s);if(!t)throw new Error("panzoom requires DOM element to be attached to the DOM tree");var i=s.parentElement;s.scrollTop=0,e.disableKeyboardInteraction||i.setAttribute("tabindex",0);var n={getBBox:a,getOwner:o,applyTransform:l};return n;function o(){return i}function a(){return{left:0,top:0,width:s.clientWidth,height:s.clientHeight}}function l(u){s.style.transformOrigin="0 0 0",s.style.transform="matrix("+u.scale+", 0, 0, "+u.scale+", "+u.x+", "+u.y+")"}}function Mw(s){return s&&s.parentElement&&s.style}});var zw=Me((wLe,Uw)=>{"use strict";var Bw=uw(),IS=yw(),wk=Ew(),Lk=vw(),Vw=Iw(),Ok=Vw(),Rk=Vw(!0),Mk=Lw(),Nw=Rw(),Dw=_w(),_k=1,Bk=1.75,Nk=300;Uw.exports=kw;function kw(s,e){e=e||{};var t=e.controller;if(t||(Nw.canAttach(s)?t=Nw(s,e):Dw.canAttach(s)&&(t=Dw(s,e))),!t)throw new Error("Cannot create panzoom for the current type of dom element");var i=t.getOwner(),n={x:0,y:0},o=!1,a=new Mk;t.initTransform&&t.initTransform(a);var l=typeof e.filterKey=="function"?e.filterKey:kc,u=typeof e.pinchSpeed=="number"?e.pinchSpeed:1,c=e.bounds,h=typeof e.maxZoom=="number"?e.maxZoom:Number.POSITIVE_INFINITY,d=typeof e.minZoom=="number"?e.minZoom:0,f=typeof e.boundsPadding=="number"?e.boundsPadding:.05,P=typeof e.zoomDoubleClickSpeed=="number"?e.zoomDoubleClickSpeed:Bk,E=e.beforeWheel||kc,v=e.beforeMouseDown||kc,L=typeof e.zoomSpeed=="number"?e.zoomSpeed:_k,O=Fw(e.transformOrigin),D=e.enableTextSelection?Rk:Ok;Dk(c),e.autocenter&&zc();var _,F=0,X,$=!1,se=!1,ie,oe,ue,Se;"smoothScroll"in e&&!e.smoothScroll?Se=Fk():Se=Lk(li,tu,e.smoothScroll);var ve,Ce,De,Cr=!1;No();var Lo={dispose:xa,moveBy:cn,moveTo:fi,smoothMoveTo:eu,centerOn:Jl,zoomTo:Es,zoomAbs:ms,smoothZoom:Un,smoothZoomAbs:Ss,showRectangle:ya,pause:Uc,resume:Oo,isPaused:Zl,getTransform:Xt,getMinZoom:ln,setMinZoom:Et,getMaxZoom:nr,setMaxZoom:Vn,getTransformOrigin:un,setTransformOrigin:Ro,getZoomSpeed:Mo,setZoomSpeed:_o};wk(Lo);var Yl=typeof e.initialX=="number"?e.initialX:a.x,Pa=typeof e.initialY=="number"?e.initialY:a.y,$l=typeof e.initialZoom=="number"?e.initialZoom:a.scale;return(Yl!=a.x||Pa!=a.y||$l!=a.scale)&&ms(Yl,Pa,$l),Lo;function Uc(){bs(),Cr=!0}function Oo(){Cr&&(No(),Cr=!1)}function Zl(){return Cr}function ya(k){var Q=i.getBoundingClientRect(),J=ki(Q.width,Q.height),re=k.right-k.left,Ie=k.bottom-k.top;if(!Number.isFinite(re)||!Number.isFinite(Ie))throw new Error("Invalid rectangle");var He=J.x/re,Ye=J.y/Ie,Mt=Math.min(He,Ye);a.x=-(k.left+re/2)*Mt+J.x/2,a.y=-(k.top+Ie/2)*Mt+J.y/2,a.scale=Mt}function ki(k,Q){if(t.getScreenCTM){var J=t.getScreenCTM(),re=J.a,Ie=J.d,He=J.e,Ye=J.f;n.x=k*re-He,n.y=Q*Ie-Ye}else n.x=k,n.y=Q;return n}function zc(){var k,Q,J=0,re=0,Ie=Bo();if(Ie)J=Ie.left,re=Ie.top,k=Ie.right-Ie.left,Q=Ie.bottom-Ie.top;else{var He=i.getBoundingClientRect();k=He.width,Q=He.height}var Ye=t.getBBox();if(!(Ye.width===0||Ye.height===0)){var Mt=Q/Ye.height,gi=k/Ye.width,wt=Math.min(gi,Mt);a.x=-(Ye.left+Ye.width/2)*wt+k/2+J,a.y=-(Ye.top+Ye.height/2)*wt+Q/2+re,a.scale=wt}}function Xt(){return a}function ln(){return d}function Et(k){d=k}function nr(){return h}function Vn(k){h=k}function un(){return O}function Ro(k){O=Fw(k)}function Mo(){return L}function _o(k){if(!Number.isFinite(k))throw new Error("Zoom speed should be a number");L=k}function li(){return{x:a.x,y:a.y}}function fi(k,Q){a.x=k,a.y=Q,gs(),Ui("pan"),Ea()}function Sa(k,Q){fi(a.x+k,a.y+Q)}function gs(){var k=Bo();if(!!k){var Q=!1,J=Ar(),re=k.left-J.right;return re>0&&(a.x+=re,Q=!0),re=k.right-J.left,re<0&&(a.x+=re,Q=!0),re=k.top-J.bottom,re>0&&(a.y+=re,Q=!0),re=k.bottom-J.top,re<0&&(a.y+=re,Q=!0),Q}}function Bo(){if(!!c){if(typeof c=="boolean"){var k=i.getBoundingClientRect(),Q=k.width,J=k.height;return{left:Q*f,top:J*f,right:Q*(1-f),bottom:J*(1-f)}}return c}}function Ar(){var k=t.getBBox(),Q=Ql(k.left,k.top);return{left:Q.x,top:Q.y,right:k.width*a.scale+Q.x,bottom:k.height*a.scale+Q.y}}function Ql(k,Q){return{x:k*a.scale+a.x,y:Q*a.scale+a.y}}function Ea(){o=!0,_=window.requestAnimationFrame(Hc)}function Kl(k,Q,J){if(wS(k)||wS(Q)||wS(J))throw new Error("zoom requires valid numbers");var re=a.scale*J;if(re<d){if(a.scale===d)return;J=d/a.scale}if(re>h){if(a.scale===h)return;J=h/a.scale}var Ie=ki(k,Q);if(a.x=Ie.x-J*(Ie.x-a.x),a.y=Ie.y-J*(Ie.y-a.y),c&&f===1&&d===1)a.scale*=J,gs();else{var He=gs();He||(a.scale*=J)}Ui("zoom"),Ea()}function ms(k,Q,J){var re=J/a.scale;Kl(k,Q,re)}function Jl(k){var Q=k.ownerSVGElement;if(!Q)throw new Error("ui element is required to be within the scene");var J=k.getBoundingClientRect(),re=J.left+J.width/2,Ie=J.top+J.height/2,He=Q.getBoundingClientRect(),Ye=He.width/2-re,Mt=He.height/2-Ie;cn(Ye,Mt,!0)}function eu(k,Q){cn(k-a.x,Q-a.y,!0)}function cn(k,Q,J){if(!J)return Sa(k,Q);ve&&ve.cancel();var re={x:0,y:0},Ie={x:k,y:Q},He=0,Ye=0;ve=IS(re,Ie,{step:function(Mt){Sa(Mt.x-He,Mt.y-Ye),He=Mt.x,Ye=Mt.y}})}function tu(k,Q){or(),fi(k,Q)}function xa(){bs()}function No(){i.addEventListener("mousedown",Aa,{passive:!1}),i.addEventListener("dblclick",su,{passive:!1}),i.addEventListener("touchstart",nu,{passive:!1}),i.addEventListener("keydown",iu,{passive:!1}),Bw.addWheelListener(i,Do,{passive:!1}),Ea()}function bs(){Bw.removeWheelListener(i,Do),i.removeEventListener("mousedown",Aa),i.removeEventListener("keydown",iu),i.removeEventListener("dblclick",su),i.removeEventListener("touchstart",nu),_&&(window.cancelAnimationFrame(_),_=0),Se.cancel(),dn(),au(),D.release(),zn()}function Hc(){o&&ru()}function ru(){o=!1,t.applyTransform(a),Ui("transform"),_=0}function iu(k){var Q=0,J=0,re=0;if(k.keyCode===38?J=1:k.keyCode===40?J=-1:k.keyCode===37?Q=1:k.keyCode===39?Q=-1:k.keyCode===189||k.keyCode===109?re=1:(k.keyCode===187||k.keyCode===107)&&(re=-1),!l(k,Q,J,re)){if(Q||J){k.preventDefault(),k.stopPropagation();var Ie=i.getBoundingClientRect(),He=Math.min(Ie.width,Ie.height),Ye=.05,Mt=He*Ye*Q,gi=He*Ye*J;cn(Mt,gi)}if(re){var wt=fn(re*100),He=O?pi():Wc();Es(He.x,He.y,wt)}}}function Wc(){var k=i.getBoundingClientRect();return{x:k.width/2,y:k.height/2}}function nu(k){if(Ps(k),k.touches.length===1)return qc(k,k.touches[0]);k.touches.length===2&&(ue=ou(k.touches[0],k.touches[1]),De=!0,va())}function Ps(k){e.onTouch&&!e.onTouch(k)||(k.stopPropagation(),k.preventDefault())}function jc(k){e.onDoubleClick&&!e.onDoubleClick(k)||(k.preventDefault(),k.stopPropagation())}function qc(k){var Q=k.touches[0],J=jr(Q);X=J;var re=ki(J.x,J.y);ie=re.x,oe=re.y,Se.cancel(),va()}function va(){$||($=!0,document.addEventListener("touchmove",Ca),document.addEventListener("touchend",kn),document.addEventListener("touchcancel",kn))}function Ca(k){if(k.touches.length===1){k.stopPropagation();var Q=k.touches[0],J=jr(Q),re=ki(J.x,J.y),Ie=re.x-ie,He=re.y-oe;Ie!==0&&He!==0&&Ta(),ie=re.x,oe=re.y,cn(Ie,He)}else if(k.touches.length===2){De=!0;var Ye=k.touches[0],Mt=k.touches[1],gi=ou(Ye,Mt),wt=1+(gi/ue-1)*u,zi=jr(Ye),mi=jr(Mt);if(ie=(zi.x+mi.x)/2,oe=(zi.y+mi.y)/2,O){var J=pi();ie=J.x,oe=J.y}Es(ie,oe,wt),ue=gi,k.stopPropagation(),k.preventDefault()}}function kn(k){if(k.touches.length>0){var Q=jr(k.touches[0]),J=ki(Q.x,Q.y);ie=J.x,oe=J.y}else{var re=new Date;if(re-F<Nk)if(O){var Q=pi();Un(Q.x,Q.y,P)}else Un(X.x,X.y,P);F=re,zn(),au()}}function ou(k,Q){var J=k.clientX-Q.clientX,re=k.clientY-Q.clientY;return Math.sqrt(J*J+re*re)}function su(k){jc(k);var Q=jr(k);O&&(Q=pi()),Un(Q.x,Q.y,P)}function Aa(k){if(!v(k)){if($)return k.stopPropagation(),!1;var Q=k.button===1&&window.event!==null||k.button===0;if(!!Q){Se.cancel();var J=jr(k),re=ki(J.x,J.y);return ie=re.x,oe=re.y,document.addEventListener("mousemove",ys),document.addEventListener("mouseup",hn),D.capture(k.target||k.srcElement),!1}}}function ys(k){if(!$){Ta();var Q=jr(k),J=ki(Q.x,Q.y),re=J.x-ie,Ie=J.y-oe;ie=J.x,oe=J.y,cn(re,Ie)}}function hn(){D.release(),zn(),dn()}function dn(){document.removeEventListener("mousemove",ys),document.removeEventListener("mouseup",hn),se=!1}function au(){document.removeEventListener("touchmove",Ca),document.removeEventListener("touchend",kn),document.removeEventListener("touchcancel",kn),se=!1,De=!1,$=!1}function Do(k){if(!E(k)){Se.cancel();var Q=k.deltaY;k.deltaMode>0&&(Q*=100);var J=fn(Q);if(J!==1){var re=O?pi():jr(k);Es(re.x,re.y,J),k.preventDefault()}}}function jr(k){var Q,J,re=i.getBoundingClientRect();return Q=k.clientX-re.left,J=k.clientY-re.top,{x:Q,y:J}}function Un(k,Q,J){var re=a.scale,Ie={scale:re},He={scale:J*re};Se.cancel(),or(),Ce=IS(Ie,He,{step:function(Ye){ms(k,Q,Ye.scale)},done:xs})}function Ss(k,Q,J){var re=a.scale,Ie={scale:re},He={scale:J};Se.cancel(),or(),Ce=IS(Ie,He,{step:function(Ye){ms(k,Q,Ye.scale)}})}function pi(){var k=i.getBoundingClientRect();return{x:k.width*O.x,y:k.height*O.y}}function Es(k,Q,J){return Se.cancel(),or(),Kl(k,Q,J)}function or(){Ce&&(Ce.cancel(),Ce=null)}function fn(k){var Q=Math.sign(k),J=Math.min(.25,Math.abs(L*k/128));return 1-Q*J}function Ta(){se||(Ui("panstart"),se=!0,Se.start())}function zn(){se&&(De||Se.stop(),Ui("panend"))}function xs(){Ui("zoomend")}function Ui(k){Lo.fire(k,Lo)}}function Fw(s){if(!!s){if(typeof s=="object")return(!Vc(s.x)||!Vc(s.y))&&Gw(s),s;Gw()}}function Gw(s){throw console.error(s),new Error(["Cannot parse transform origin.","Some good examples:",'  "center center" can be achieved with {x: 0.5, y: 0.5}','  "top center" can be achieved with {x: 0.5, y: 0}','  "bottom right" can be achieved with {x: 1, y: 1}'].join(`
`))}function kc(){}function Dk(s){var e=typeof s;if(!(e==="undefined"||e==="boolean")){var t=Vc(s.left)&&Vc(s.top)&&Vc(s.bottom)&&Vc(s.right);if(!t)throw new Error("Bounds object is not valid. It can be: undefined, boolean (true|false) or an object {left, top, right, bottom}")}}function Vc(s){return Number.isFinite(s)}function wS(s){return Number.isNaN?Number.isNaN(s):s!==s}function Fk(){return{start:kc,stop:kc,cancel:kc}}function Gk(){if(typeof document>"u")return;var s=document.getElementsByTagName("script");if(!s)return;for(var e,t=0;t<s.length;++t){var i=s[t];if(i.src&&i.src.match(/\bpanzoom(\.min)?\.js/)){e=i;break}}if(!e)return;var n=e.getAttribute("query");if(!n)return;var o=e.getAttribute("name")||"pz",a=Date.now();l();function l(){var h=document.querySelector(n);if(!h){var d=Date.now(),f=d-a;if(f<2e3){setTimeout(l,100);return}console.error("Cannot find the panzoom element",o);return}var P=u(e);console.log(P),window[o]=kw(h,P)}function u(h){for(var d=h.attributes,f={},P=0;P<d.length;++P){var E=d[P],v=c(E);v&&(f[v.name]=v.value)}return f}function c(h){if(!!h.name){var d=h.name[0]==="p"&&h.name[1]==="z"&&h.name[2]==="-";if(!!d){var f=h.name.substr(3),P=JSON.parse(h.value);return{name:f,value:P}}}}}Gk()});var Wv=be(aE());var cE=be(vs());var Cs=class{constructor(){this.attrs=[];this._parent=null}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t==e)return!0;return!1}};var Go=class extends Cs{constructor(e,t){super();this.source=e,this.target=t,e!=t?(e.outEdges.add(this),t.inEdges.add(this)):e.selfEdges.add(this)}add(){this.source!=this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!=this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!=this.target.parent}EdgeToAncestor(){return this.source instanceof Ze&&this.target.isDescendantOf(this.source)?1:this.target instanceof Ze&&this.source.isDescendantOf(this.target)?2:0}};var Vo=class extends Cs{constructor(e){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=e}get id(){return this._id}set id(e){this._id=e}toString(){return this.id}*_edges(){for(let e of this.inEdges)yield e;for(let e of this.outEdges)yield e;for(let e of this.selfEdges)yield e}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}};var ub=class{constructor(){this.nodeMap=new Map}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof Ze&&(yield e)}find(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}*nodesDeep(){for(let e of this.nodes_())if(yield e,e instanceof Ze)for(let t of e.nodeCollection.nodesDeep())yield t}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}hasNode(e){if(this.nodeMap.has(e))return!0;for(let t of this.nodeMap)if(t[1]instanceof Ze&&t[1].nodeCollection.hasNode(e))return!0;return!1}getNode(e){let t=this.nodeMap.get(e);if(t!=null)return t;for(let i of this.nodeMap)if(i[1]instanceof Ze&&(t=i[1].nodeCollection.getNode(e),t!=null))return t}get nodeShallowCount(){return this.nodeMap.size}get nodeDeepCount(){let e=this.nodeMap.size;for(let t of this.nodeMap.values())t instanceof Ze&&(e+=t.nodeCollection.nodeDeepCount);return e}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.getNode(e.id)==null&&this.nodeMap.set(e.id,e)}addEdge(e){this.addNode(e.source),this.addNode(e.target),e.source!=e.target?(e.source.outEdges.add(e),e.target.inEdges.add(e)):e.source.selfEdges.add(e)}removeNode(e){for(let t of e.outEdges)t.target.inEdges.delete(t);for(let t of e.inEdges)t.source.outEdges.delete(t);this.nodeMap.delete(e.id);for(let t of this.nodeMap.values())t instanceof Ze&&t.nodeCollection.nodeMap.delete(e.id)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!=e||t.source==t.target)return!1;for(let t of e.inEdges)if(t.target!=e||t.source==t.target)return!1;for(let t of e.selfEdges)if(t.target!=t.source||t.source!=e)return!1;return!0}isConsistent(){for(let e of this.nodeMap.values())if(!this.nodeIsConsistent(e))return!1;return!0}};var Ze=class extends Vo{constructor(e="__graph__"){super(e);this.nodeCollection=new ub}hasSomeAttrOnIndex(e){for(let t of this.deepNodes)if(t.getAttr(e))return!0;for(let t of this.deepEdges())if(t.getAttr(e))return!0;return!1}*graphs(){for(let e of this.nodeCollection.graphs)yield e}noEmptySubgraphs(){for(let e of this.subgraphs())if(e.shallowNodeCount==0)return!1;return!0}hasSubgraphs(){for(let e of this.shallowNodes)if(e instanceof Ze)return!0;return!1}*subgraphs(){for(let e of this.deepNodes)e instanceof Ze&&(yield e)}isEmpty(){return this.shallowNodeCount==0}setEdge(e,t){let i=this.nodeCollection.find(e);if(i==null)return;let n=this.nodeCollection.find(t);if(n==null)return;let o=new Go(i,n);return this.addEdge(o),o}get shallowNodes(){return this.nodeCollection.nodesShallow}get deepNodes(){return this.nodeCollection.nodesDeep()}findNode(e){return this.nodeCollection.find(e)}get edges(){return this.nodeCollection.edges}*deepEdges(){for(let e of this.deepNodes){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}isConsistent(){return this.parent?this.parent.isConsistent():this.eachNodeIdIsUnique()&&this.nodeCollection.isConsistent()}nodeIsConsistent(e){return this.nodeCollection.nodeIsConsistent(e)}removeNode(e){this.nodeCollection.removeNode(e)}addNode(e){return e.parent=this,this.nodeCollection.addNode(e),e}addEdge(e){this.nodeCollection.addEdge(e)}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){return this.nodeCollection.nodeDeepCount}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(e){for(;e!=null&&e.parent!=this;)e=e.parent;return e}deepEdgesCount(){let e=0;for(let t of this.deepNodes)e+=t.outDegree+t.selfDegree;return e}eachNodeIdIsUnique(){let e=new Set;for(let t of this.deepNodes){if(e.has(t.id))return!1;e.add(t.id)}return!0}};function*hE(s){let e=new Set,t=new cE.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(n(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of i(l))n(u,t,e)}yield a}function*i(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function n(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function cb(s,e){e.parent&&e.parent.nodeCollection.nodeMap.delete(e.id),s.nodeCollection.nodeMap.set(e.id,e),e.parent=s}var hb=class{static solve(e,t,i,n,o,a){let l=e*o-n*t;if(!(Math.abs(l)<hb.eps))return{x:(i*o-a*t)/l,y:(e*a-n*i)/l}}},mn=hb;mn.eps=1e-8;var As=class{static RoundPoint(e){return new p(As.RoundDouble(e.x),As.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*As.mult)/As.mult}},C=As;C.distanceEpsilonPrecision=6,C.mult=Math.pow(10,6),C.defaultLeafBoxesOffset=.5,C.lineSegmentThreshold=.05,C.intersectionEpsilon=1e-4,C.distanceEpsilon=Math.pow(10,-As.distanceEpsilonPrecision),C.squareOfDistanceEpsilon=Math.pow(10,-As.distanceEpsilonPrecision*2),C.tolerance=1e-8;function dE(s,e){return(s?1:0)-(e?1:0)}function Ae(s,e){let t=s-e;return t<0?-1:t==0?0:1}function cu(s,e){let t=Ae(s.y,e.y);return t||Ae(s.x,e.x)}function fE(s,e){let t=Ae(s.x,e.x);return t||Ae(s.y,e.y)}function ae(s,e){let t=s-e;return-C.distanceEpsilon<=t&&t<=C.distanceEpsilon}function uf(s,e){return eh(s,e)>0}function eh(s,e){let t=s-e;return t<=-C.distanceEpsilon?-1:t>=C.distanceEpsilon?1:0}function ke(s,e){return s.sub(e).length}var p=class{toJSON(){return{x:this.x,y:this.y}}static fromJSON(e){return new p(e.x,e.y)}static ProjectionToLine(e,t,i){let n=t.sub(e),o=n.length;if(o<C.distanceEpsilon)return e;n=n.div(o);let a=i.sub(e).dot(n);return e.add(n.mul(a))}static RayIntersectsRayInteriors(e,t,i,n){let o=p.lineLineIntersection(e,e.add(t),i,i.add(n));if(!!o&&o.sub(e).dot(t.div(t.l1))>C.distanceEpsilon&&o.sub(i).dot(n.div(n.l1))>C.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,i,n){let o=p.lineLineIntersection(e,t,i,i.add(n));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(i).dot(n)<0)&&a.dot(a)>C.squareOfDistanceEpsilon&&l.dot(l)>=C.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,i){return p.signedDoubledTriangleArea(e,t,i)>=0}static PointToTheLeftOfLine(e,t,i){return p.signedDoubledTriangleArea(e,t,i)>0}static PointIsInsideCone(e,t,i,n){return p.PointToTheRightOfLineOrOnLine(e,t,i)&&p.PointToTheLeftOfLineOrOnLine(e,t,n)}static PointToTheRightOfLineOrOnLine(e,t,i){return p.signedDoubledTriangleArea(t,i,e)<=0}static PointToTheRightOfLine(e,t,i){return p.signedDoubledTriangleArea(t,i,e)<0}static closeIntersections(e,t){return p.close(e,t,C.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=Ae(this.x,e.x);return t!=0?t:Ae(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,i){return e.sub(t).length<=i}static closeSquare(e,t,i){let n=t.sub(e);return n.dot(n)<=i}static closeDistEps(e,t,i=C.distanceEpsilon){return e.sub(t).length<=i}normalize(){let e=this.length;return new p(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new p(this.x*e,this.y*t)}add(e){return new p(this.x+e.x,this.y+e.y)}sub(e){return new p(this.x-e.x,this.y-e.y)}mul(e){return new p(this.x*e,this.y*e)}div(e){return new p(this.x/e,this.y/e)}equal(e){return e.x==this.x&&e.y==this.y}neg(){return new p(-this.x,-this.y)}static lineLineIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=mn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!=null)return e.add(o.mul(u.x))}static segSegIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=C.tolerance,c=mn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!=null&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,i){let n=e.length,o=t.length;return n<i||o<i?!0:(e=e.div(n),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<i)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new p(-this.y,this.x)}rotate90Cw(){return new p(this.y,-this.x)}clone(){return new p(this.x,this.y)}rotate(e){let t=Math.cos(e),i=Math.sin(e);return new p(t*this.x-i*this.y,i*this.x+t*this.y)}static mkPoint(e,t,i,n){return t.mul(e).add(n.mul(i))}static convSum(e,t,i){return t.add(i.sub(t).mul(e))}static anglePCP(e,t,i){return p.angle(e.sub(t),i.sub(t))}static angle(e,t){let i=e.x,n=e.y,o=t.x,a=t.y,l=i*a-n*o,u=i*o+n*a;if(Math.abs(u)<C.tolerance)return Math.abs(l)<C.tolerance?0:l<-C.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<C.tolerance)return u<-C.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-C.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,i){let n=p.signedDoubledTriangleArea(e,t,i);return n>C.distanceEpsilon?1:n<-C.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,i){let n=p.signedDoubledTriangleArea(e,t,i);return n>C.intersectionEpsilon?1:n<-C.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o),l=n.dot(n);return a<=0+C.tolerance?t:l<=a+C.tolerance?i:t.add(n.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,i){return p.signedDoubledTriangleArea(e,t,i)>=0}static pointToTheLeftOfLine(e,t,i){return p.signedDoubledTriangleArea(e,t,i)>0}static pointToTheRightOfLineOrOnLine(e,t,i){return p.signedDoubledTriangleArea(t,i,e)<=0}static pointToTheRightOfLine(e,t,i){return p.signedDoubledTriangleArea(t,i,e)<0}static canProject(e,t,i){let n=i.sub(t);return!(e.sub(t).dot(n)<0||e.sub(i).dot(n)>0)}static distToLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a,l;if((a=n.dot(o))<=C.tolerance)return{par:0,dist:o.length};if((l=n.dot(n))<=a+C.tolerance)return{par:1,dist:e.sub(i).length};let u=a/l;return{par:u,dist:t.add(n.mul(u)).length}}};var _t=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new _t;return t.point=e,t}};var Le=class{contains(e){let t=e.sub(this.corner),i=C.distanceEpsilon,n=t.dot(this.bRot);if(n>this.abRot+i||n<-i)return!1;let o=t.dot(this.aRot);return o<=this.baRot+i&&o>=-i}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let i=new Le,n=e.corner,o={minx:n.x,maxx:n.x,miny:n.y,maxy:n.y};return Le.pumpMinMax(o,e.aPlusCorner),Le.pumpMinMax(o,e.otherCorner),Le.pumpMinMax(o,e.bPlusCorner),Le.pumpMinMax(o,t.corner),Le.pumpMinMax(o,t.aPlusCorner),Le.pumpMinMax(o,t.otherCorner),Le.pumpMinMax(o,t.bPlusCorner),i.corner=new p(o.minx,o.miny),i.a=new p(0,o.maxy-o.miny),i.b=new p(o.maxx-o.minx,0),i.aPlusCorner=i.a.add(i.corner),i.otherCorner=i.b.add(i.aPlusCorner),i.bPlusCorner=i.b.add(i.corner),i.aRot=new p(-i.a.y,i.a.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new p(-i.b.y,i.b.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.a.dot(i.bRot),i.baRot=i.b.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=i.a.sub(i.b).length<C.distanceEpsilon,i}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(Le.separByA(e,t)||Le.separByA(t,e)||Le.separByB(e,t)||Le.separByB(t,e))==!1?!1:!(e.isSeg&&t.isSeg)||!p.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:Le.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let i=e.corner,n=e.otherCorner,o=t.corner,a=t.otherCorner,l=n.sub(i),u=0,c=l.dot(l),h=o.sub(i).dot(l),d=a.sub(i).dot(l);if(h>d){let f=h;h=d,d=f}return!(d<u-C.distanceEpsilon||h>c+C.distanceEpsilon)}static separByB(e,t){let i=C.distanceEpsilon,n=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(n>e.abRot+i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+i)return!1;return!0}else if(n<-i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-i)return!1;return!0}return!1}static separByA(e,t){let i=C.distanceEpsilon,n=t.corner.sub(e.corner),o=p.dot(n,e.aRot);return o>e.baRot+i?(n=t.aPlusCorner.sub(e.corner),!(p.dot(n,e.aRot)<=e.baRot+i||(n=t.bPlusCorner.sub(e.corner),p.dot(n,e.aRot)<=e.baRot+i)||(n=t.otherCorner.sub(e.corner),p.dot(n,e.aRot)<=e.baRot+i))):o<-i?(n=t.aPlusCorner.sub(e.corner),!(p.dot(n,e.aRot)>=-i||(n=t.bPlusCorner.sub(e.corner),p.dot(n,e.aRot)>=-i)||(n=t.otherCorner.sub(e.corner),p.dot(n,e.aRot)>=-i))):!1}static parallelogramByCornerSideSide(e,t,i){let n=new Le;return n.corner=e,n.a=t,n.b=i,n.aRot=new p(-t.y,t.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new p(-i.y,i.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.bRot.dot(t),n.baRot=i.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=t.sub(i).length<C.distanceEpsilon,n.aPlusCorner=t.add(e),n.otherCorner=i.add(n.aPlusCorner),n.bPlusCorner=i.add(e),n}static getParallelogramOfAGroup(e){let t=0,i=0,n=0,o=0,a=!0;for(let l of e){let u=YL(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=i=h,n=o=d):(h<t?t=h:h>i&&(i=h),d<n?n=d:d>o&&(o=d))}}return Le.parallelogramByCornerSideSide(new p(t,n),new p(0,o-n),new p(i-t,0))}};function*YL(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var B=class{constructor(e,t,i,n){this.parStart=0;this.parEnd=1;this.start=new p(e,t),this.end=new p(i,n)}static fromJSON(e){return B.mkPP(p.fromJSON(e.start),p.fromJSON(e.end))}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let i=this.value(e),n=this.value(t);return p.close(i,n,C.distanceEpsilon)?null:B.mkPP(i,n)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:Le.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new p(-e.y,e.x)}static mkPP(e,t){return new B(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,i){return new B(e.x,e.y,t,i)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new p(0,0)}thirdDerivative(e){return new p(0,0)}reverse(){return B.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return B.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<C.tolerance)return 0;let i=e/t;return i>1?1:i<0?0:i}transform(e){return B.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,i){let n=this.closestParameter(e);return n<t&&(n=t),n>i&&(n=i),n}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return W.mkPP(this.start,this.end)}clone(){return B.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o);if(a<=0+C.tolerance)return 0;let l=n.dot(n);return l<=a+C.tolerance?1:a/l}closestParameter(e){return B.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,i,n){let o=p.lineLineIntersection(e,t,i,n);if(o!=null&&B.xIsBetweenPoints(e,t,o)&&B.xIsBetweenPoints(i,n,o))return o}static xIsBetweenPoints(e,t,i){return e.sub(i).dot(t.sub(i))<=C.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,i,n){let o=t.sub(e),a=n.sub(i),l=e.sub(i),u=p.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),f=o.dot(l),P=a.dot(l),E,v,L=Math.abs(u),O=L,D=L;L<C.tolerance?(E=0,O=1,v=P,D=d):(E=p.crossProduct(a,l),v=p.crossProduct(o,l),u<0&&(E=-E,v=-v),E<0?(E=0,v=P,D=d):E>O&&(E=O=1,v=P+h,D=d)),v<0?(v=0,-f<0?E=0:-f>c?E=O:(E=-f,O=c)):v>D&&(v=D=1,-f+h<0?E=0:-f+h>c?E=O:(E=-f+h,O=c));let _=Math.abs(E)<C.tolerance?0:E/O,F=Math.abs(v)<C.tolerance?0:v/D;return{parab:_,parcd:F,dist:l.add(o.mul(_).sub(a.mul(F))).length}}};function $L(s,e,t,i,n){return{parallelogram:t,seg:i,leafBoxesOffset:n,node:{low:s,high:e,chord:null}}}var gt=class{static distToSegm(e,t,i){let n=i.sub(t);if(n.length<C.intersectionEpsilon)return e.sub(t.add(i).div(2)).length;let o=new p(-n.y,n.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,i){let n=i.derivative(e),o=i.derivative(t),a=new p(-o.y,o.x),l=i.value(e),u=i.value(t),h=u.sub(l).dot(a),d=n.dot(a),f=Math.abs(h)<C.distanceEpsilon;if(!f&&Math.abs(d)<C.distanceEpsilon)return;let P=f?0:h/d;return n=n.mul(P),Le.parallelogramByCornerSideSide(l,n,u.sub(l).sub(n))}static createParallelogramNodeForCurveSeg(e,t,i,n){if(e==i.parStart&&t==i.parEnd&&p.close(i.start,i.end,C.distanceEpsilon))return gt.createNodeWithSegmentSplit(e,t,i,n);let a=i.value(e),l=i.value(t),u=l.sub(a),c=i.value((e+t)/2);if(gt.distToSegm(c,a,l)<=C.intersectionEpsilon&&u.dot(u)<C.lineSegmentThreshold*C.lineSegmentThreshold&&t-e<C.lineSegmentThreshold){let h=B.mkPP(a,l),d=h.pNodeOverICurve();d.seg=i;let f=d.node;return f.low=e,f.high=t,f.chord=h,d}if(gt.WithinEpsilon(i,e,t,n)){let h=gt.createParallelogramOnSubSeg(e,t,i);if(h!=null)return $L(e,t,h,i,n)}return gt.createNodeWithSegmentSplit(e,t,i,n)}static WithinEpsilon(e,t,i,n){let a=(i-t)/3,l=e.value(t),u=e.value(i);return gt.distToSegm(e.value(t+a),l,u)>n?!1:gt.distToSegm(e.value(t+a*(3-1)),l,u)<=n}static createParallelogramNodeForCurveSegDefaultOffset(e){return gt.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,C.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,i,n){let o={parallelogram:null,seg:i,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(gt.createParallelogramNodeForCurveSeg(e,.5*(e+t),i,n)),a.children.push(gt.createParallelogramNodeForCurveSeg(.5*(e+t),t,i,n)),o.parallelogram=Le.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var Xn=class{constructor(e,t,i,n,o){this.par0=e,this.par1=t,this.x=i,this.seg0=n,this.seg1=o}};var Ra=class{static closestPoint(e,t,i,n,o){let u=i,c=0,h=0,d,f=!1;do{let P=e.value(u),E=e.derivative(u),v=e.secondDerivative(u),L=E.dot(E)+P.sub(t).dot(v);if(Math.abs(L)<C.tolerance)return u;d=P.sub(t).dot(E.div(L)),u-=d,u>o+C.tolerance?(u=o,h++):u<n-C.tolerance&&(u=n,h++),c++}while(Math.abs(d)>C.tolerance&&!(f=c>=5||h>=5));return f&&e.value(i).sub(t).length<C.distanceEpsilon&&(u=i),u}};var de=class{isFullEllipse(){return this.parEnd==Math.PI*2&&this.parStart==0}static fromJSON(e){return new de(e.parStart,e.parEnd,p.fromJSON(e.axis0),p.fromJSON(e.axis1),p.fromJSON(e.center))}toJSON(){return{parStart:this.parStart,parEnd:this.parEnd,axis0:this.aAxis.toJSON(),axis1:this.bAxis.toJSON(),center:this.center.toJSON()}}offsetCurve(e,t){let i=t.sub(this.center),n=p.angle(this.aAxis,i);if(this.aAxis.mul(Math.cos(n)).add(this.bAxis.mul(Math.sin(n))).length<i.length){let a=this.aAxis.length,l=this.bAxis.length;return de.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return de.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,i){return new de(0,Math.PI*2,e,t,i)}constructor(e,t,i,n,o){this.parStart=e,this.parEnd=t,this.aAxis=i,this.bAxis=n,this.center=o,this.pNode=null,this.setBoundingBox()}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new de(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(p.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return p.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return p.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return p.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=gt.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(ae(this.parStart,0)&&ae(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=W.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,i,n,o,a){return new de(e,t,i,n,new p(o,a))}static mkFullEllipsePPP(e,t,i){return new de(0,Math.PI*2,e,t,i)}static mkFullEllipseNNP(e,t,i){return new de(0,Math.PI*2,new p(e,0),new p(0,t),i)}static mkCircle(e,t){return de.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new de(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let i=this.parStart,n=this.parEnd,o=e+.001,a=e-.001;for(;n-i>C.distanceEpsilon;){let l=.5*(n+i),u=this.lengthPartial(this.parStart,l);if(u>o)n=l;else if(u<a)i=l;else return l}return(n+i)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),i=e.multiplyPoint(this.bAxis).sub(e.offset());return new de(this.parStart,this.parEnd,t,i,e.multiplyPoint(this.center))}return this}closestParameterWithinBounds(e,t,i){let o=(i-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),f=d.dot(d);f<l&&(l=f,a=h)}a==0&&i==Math.PI*2&&(t=-Math.PI);let u=Ra.closestPoint(this,e,a,t,i);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return w.lengthWithInterpolationAndThreshold(this.trim(e,t),C.lineSegmentThreshold/100)}get length(){return w.lengthWithInterpolation(this)}clone(){return new de(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,i=8,n=(this.parEnd-this.parStart)/(i+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=i;c++){let h=this.parStart+c*n,d=e.sub(this.value(h)),f=d.dot(d);f<a&&(a=f,o=h)}let l=!1;o==0&&this.parEnd==Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=Ra.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return p.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return W.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<C.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<C.tolerance&&p.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var db=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,i,n,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=i,this.bMin=o,this.aMax=n,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,i,n){return e*n-i*t}solve(){let e=0,t=10,i=0,n=100,o=!1;if(this.initValues(),this.curveA instanceof B&&this.curveB instanceof B){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<C.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<C.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<C.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+C.distanceEpsilon||u<this.aMin-C.distanceEpsilon||c>this.bMax+C.distanceEpsilon||c<this.bMin-C.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),i++,o=e>=t||i>=n||a.s==0&&a.t==0&&h}while((Math.abs(a.s)>=C.tolerance||Math.abs(a.t)>=C.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<C.distanceEpsilon*C.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!=0&&e.t!=0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let i=1;this.ti+e.t>this.bMax?i=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(i=(this.bMin-this.ti)/e.t);let n=Math.min(t,i);e.s*=n,e.t*=n}else e.s==0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,i=e.start,n=e.end,o=t.start,a=t.end,l=n.sub(i),u=l.length,c=0,h,d,f;if(u>C.distanceEpsilon){l=l.div(u),h=l.dot(n.sub(i)),d=l.dot(o.sub(i)),f=l.dot(a.sub(i));let P=!1;if(d>f){P=!0;let E=d;d=f,f=E}if(f<c)this.aSolution=0,this.bSolution=P?0:1;else if(d>h)this.aSolution=1,this.bSolution=P?1:0;else{let E=Math.min(h,f);this.aSolution=E/(h-c),this.bSolution=(E-d)/(f-d),P&&(this.bSolution=1-this.bSolution)}}else{let P=a.sub(o),E=P.length;if(E>C.distanceEpsilon)if(P=P.div(E),c=0,h=P.dot(a.sub(o)),d=P.dot(i.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let v=Math.min(h,d);this.bSolution=v/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Fe=class{constructor(e,t,i,n){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=i,this.b[3]=n,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}toJSON(){return{b:this.b.map(e=>e.toJSON())}}static fromJSON(e){return Fe.mkBezier(e.b.map(p.fromJSON))}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=gt.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,i=t*e;return this.l.mul(i).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Fe.adjustParamTo01(e),t=Fe.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-C.tolerance)return new Fe(this.b[3],this.b[3],this.b[3],this.b[3]);let i=new Array(3),n=new Array(2),o=this.casteljau(e,i,n),a=new Fe(o,n[1],i[2],this.b[3]),l=a.casteljau((t-e)/(1-e),i,n);return new Fe(a.b[0],i[0],n[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,i){let n=1-e;for(let o=0;o<3;o++)t[o]=p.mkPoint(n,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)i[o]=p.mkPoint(n,t[o],e,t[o+1]);return p.mkPoint(n,i[0],e,i[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return p.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Fe(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.pBoxNode=null}scaleFromOrigin(e,t){return new Fe(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Fe.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,i,n){let o=n.sub(e).length,a=t.sub(e).length+i.sub(t).length+n.sub(i).length;if(a-o>C.lineSegmentThreshold){let l=p.middle(e,t),u=p.middle(t,i),c=p.middle(i,n),h=p.middle(l,u),d=p.middle(c,u),f=p.middle(h,d);return Fe.lengthOnControlPolygon(e,l,h,f)+Fe.lengthOnControlPolygon(f,d,c,n)}return(a+o)/2}get boundingBox(){let e=W.mkPP(this.b[0],this.b[1]);return e.add(this.b[2]),e.add(this.b[3]),e}transform(e){return new Fe(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,i){let n=(i-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*n+t)),c=u.dot(u);c<a&&(a=c,o=l*n+t)}return Ra.closestPoint(this,e,o,t,i)}clone(){return new Fe(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Fe(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),i=this.Yp(e),n=t*t+i*i;return Math.sqrt(n*n*n)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let i=0,n=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<n&&(n=l,i=o*.125)}return Ra.closestPoint(this,e,i,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+i*i),c=t*n+i*o;return 3*(c*c/u+u*(n*n+t*a+o*o+i*l))}Gp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+i*i)*(t*n+i*o)}getParameterAtLength(e){let t=0,i=1;for(;i-t>C.tolerance;){let n=(i+t)/2,o=this.evaluateError(e,n);if(o>0)i=n;else if(o<0)t=n;else return n}return(t+i)/2}evaluateError(e,t){let i=1-t,n=p.mkPoint(i,this.b[0],t,this.b[1]),o=p.mkPoint(i,this.b[1],t,this.b[2]),a=p.mkPoint(i,this.b[2],t,this.b[3]),l=p.mkPoint(i,n,t,o),u=p.mkPoint(i,o,t,a),c=p.mkPoint(i,l,t,u),h=Fe.lengthOnControlPolygon(this.b[0],n,l,c);return h>e+C.distanceEpsilon?1:h<e-C.distanceEpsilon?-1:0}};function ZL(s){return s.seg.value(s.par)}function QL(s){return s.seg.derivative(s.par)}function KL(s){return s.seg.secondDerivative(s.par)}function JL(s){return s.seg.thirdDerivative(s.par)}function eO(s){if(s instanceof de)return{tag:"ellipse",segData:s.toJSON()};if(s instanceof B)return{tag:"lineSegment",segData:s.toJSON()};if(s instanceof Fe)return{tag:"bezier",segData:s.toJSON()};throw new Error("not implemented")}var w=class{static fromJSON(e){let t=new w;for(let i of e.segs)switch(i.tag){case"bezier":t.addSegment(Fe.fromJSON(i.segData));break;case"ellipse":t.addSegment(de.fromJSON(i.segData));break;case"lineSegment":t.addSegment(B.fromJSON(i.segData));break;default:throw new Error("not implemented")}return t}toJSON(){return{segs:this.segs.map(e=>eO(e))}}static CurvesIntersect(e,t){return e==t||w.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(n.segIndex<o.segIndex){let a=this.segs[n.segIndex],l=a.lengthPartial(n.par,a.parEnd);for(let u=n.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new w;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=w.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let i=new w;for(let n of this.segs)i.addSegment(n.scaleFromOrigin(e,t));return i}trim(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(i.start),o=this.getSegIndexParam(i.end);if(n.segIndex==o.segIndex)return this.segs[n.segIndex].trim(n.par,o.par);let a=new w;n.par<this.segs[n.segIndex].parEnd&&(a=a.addSegment(this.segs[n.segIndex].trim(n.par,this.segs[n.segIndex].parEnd)));for(let l=n.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.boundingBox_=W.translate(this.boundingBox_,e),this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let i=new w;return i.addSegment(this.trim(e,this.parEnd)),i.addSegment(this.trim(this.parStart,t)),i}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(this.boundingBox_=null,!(e instanceof w))this.segs.push(e),this.parEnd_+=w.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=w.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let i of this.segs){let n=i.pNodeOverICurve();e.push(n.parallelogram),t.push(n)}return this.pBNode={parallelogram:Le.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:C.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,i){let n=w.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return i&&n!=null&&(n=w.liftIntersectionToCurves(e,t,n)),n}static getAllIntersections(e,t,i){return e instanceof B?w.getAllIntersectionsOfLineAndICurve(e,t,i):w.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsInternal(e,t,i){let n=[];if(w.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),n),i)for(let o=0;o<n.length;o++)n[o]=w.liftIntersectionToCurves(e,t,n[o]);return n}static getAllIntersectionsOfLineAndICurve(e,t,i){return t instanceof te?w.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof w?w.getAllIntersectionsOfLineAndCurve(e,t,i):t instanceof de&&t.isArc()?w.getAllIntersectionsOfLineAndArc(e,t):w.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsOfLineAndCurve(e,t,i){let n=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(Le.intersect(o.parallelogram,a.parallelogram)==!1)return n;let l=0;for(let u of t.segs){let c=w.getAllIntersections(e,u,!1);if(i){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)w.alreadyInside(n,h)||n.push(h)}return n}static closeIntersections(e,t){return p.close(e.x,t.x,C.intersectionEpsilon)}static closeIntersectionPoints(e,t){return p.close(e,t,C.intersectionEpsilon)}static alreadyInside(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(w.closeIntersections(n,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let i=e.end.sub(e.start),n=[],o=i.length;if(o<C.distanceEpsilon){let d=e.start.sub(t.center);if(ae(d.length,t.aAxis.length)){let f=p.angle(t.aAxis,d);t.parStart-C.tolerance<=f&&(f=Math.max(f,t.parStart),f<=t.parEnd+C.tolerance&&(f=Math.min(t.parEnd,f),n.push(new Xn(0,f,e.start,e,t))))}return n}let a=i.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-C.distanceEpsilon)return n;if(i=a.rotate90Cw(),ae(c,h))w.tryToAddPointToLineCircleCrossing(e,t,n,u,o,i);else{let d=Math.sqrt(c*c-l*l),f=i.mul(d);w.tryToAddPointToLineCircleCrossing(e,t,n,u.add(f),o,i),w.tryToAddPointToLineCircleCrossing(e,t,n,u.sub(f),o,i)}return n}static tryToAddPointToLineCircleCrossing(e,t,i,n,o,a){let u=n.sub(e.start).dot(a);if(u<-C.distanceEpsilon||(u=Math.max(u,0),u>o+C.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=p.angle(t.aAxis,n.sub(t.center));t.parStart-C.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+C.tolerance&&(c=Math.min(t.parEnd,c),i.push(new Xn(u,c,n,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let i=[],n=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=w.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a!=null&&(w.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),w.oldIntersection(i,a.x)||i.push(new Xn(a.aSol,n+a.bSol,a.x,e,t))),n++}if(t.closed){let a=w.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a!=null&&(w.adjustSolution(e.start,e.end,o.point,t.start,a),w.oldIntersection(i,a.x)||i.push(new Xn(a.aSol,n+a.bSol,a.x,e,t)))}return i}static adjustSolution(e,t,i,n,o){w.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):w.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),w.closeIntersectionPoints(o.x,i)?(o.x=i,o.bSol=Math.floor(o.bSol)):w.closeIntersectionPoints(o.x,n)&&(o.x=n,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!Le.intersect(e.parallelogram,t.parallelogram))return null;let i=e.node,n=t.node,o=i.hasOwnProperty("children"),a=n.hasOwnProperty("children");if(o&&a)for(let l of i.children)for(let u of n.children){let c=w.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of n.children){let u=w.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of i.children){let u=w.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return w.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,i){if(!Le.intersect(e.parallelogram,t.parallelogram))return;let n=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(n&&o)for(let a of e.node.children)for(let l of t.node.children)w.curveCurveXWithParallelogramNodes(a,l,i);else if(o)for(let a of t.node.children)w.curveCurveXWithParallelogramNodes(e,a,i);else if(n)for(let a of e.node.children)w.curveCurveXWithParallelogramNodes(a,t,i);else i=w.crossOverLeaves(e,t,i)}static crossOverIntervalsOne(e,t){let i=e.node,n=t.node,o=(i.high-i.low)/2,a=(n.high-n.low)/2;for(let l=1;l<2;l++){let u=l*o+i.low;for(let c=1;c<2;c++){let h=c*a+n.low,d;if(i.chord==null&&n.chord==null?d=w.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,n.low,n.high,u,h):i.chord!=null&&n.chord==null?d=w.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,n.low,n.high,.5*l,h):i.chord==null?(d=w.crossWithinIntervalsWithGuess(e.seg,n.chord,i.low,i.high,0,1,u,.5*c),d!=null&&(d.bSol=n.low+d.bSol*(n.high-n.low))):(d=w.crossWithinIntervalsWithGuess(i.chord,n.chord,0,1,0,1,.5*l,.5*c),d!=null&&(d.aSol=i.low+d.aSol*(i.high-i.low),d.bSol=n.low+d.bSol*(n.high-n.low))),d!=null)return w.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return w.goDeeperOne(e,t)}static crossOverLeaves(e,t,i){let n=e.node,o=t.node,a=!1,l=(n.high-n.low)/2+n.low,u=(o.high-o.low)/2+o.low,c;return n.chord==null&&o.chord==null?c=w.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,o.low,o.high,l,u):n.chord!=null&&o.chord==null?(c=w.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,o.low,o.high,.5,u),c!=null&&(c.aSol=n.low+c.aSol*(n.high-n.low))):n.chord==null?(c=w.crossWithinIntervalsWithGuess(e.seg,o.chord,n.low,n.high,0,1,l,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=w.crossWithinIntervalsWithGuess(n.chord,o.chord,0,1,0,1,.5,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=n.low+c.aSol*(n.high-n.low))),c!=null&&(w.addIntersection(e,t,i,c),a=!0),a||w.goDeeper(i,e,t),i}static addIntersection(e,t,i,n){let o=e.node;w.closeIntersectionPoints(n.x,e.seg.value(o.low))?(n.x=e.seg.value(o.low),n.aSol=o.low):w.closeIntersectionPoints(n.x,e.seg.value(o.high))&&(n.x=e.seg.value(o.high),n.aSol=o.high);let a=t.node;if(w.closeIntersectionPoints(n.x,t.seg.value(a.low))?(n.x=t.seg.value(a.low),n.bSol=a.low):w.closeIntersectionPoints(n.x,t.seg.value(a.high))&&(n.x=t.seg.value(a.high),n.bSol=a.high),!w.oldIntersection(i,n.x)){let u=new Xn(n.aSol,n.bSol,n.x,e.seg,t.seg);i.push(u)}}static oldIntersection(e,t){for(let i of e)if(t.sub(i.x).length<C.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,i,n,o){let a=e.node,l=t.node;return w.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),i=a.low):w.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),i=a.high),w.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),n=l.low):w.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),n=l.high),new Xn(i,n,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,i,n,o,a,l){let u=this.liftParameterToCurve(e,i-a.parStart,a),c=this.liftParameterToCurve(t,n-l.parStart,l);return new Xn(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,i;if(e.seg0 instanceof w){let a=e.seg0.getSegParam(e.par0);t=a.seg,i=a.par}else i=e.par0,t=e.seg0;let n,o;if(e.seg1 instanceof w){let a=e.seg1.getSegParam(e.par1);o=a.par,n=a.seg}else o=e.par1,n=e.seg1;return new Xn(i,o,e.x,t,n)}static liftIntersectionToCurves(e,t,i){return w.liftIntersectionToCurves_(e,t,i.par0,i.par1,i.x,i.seg0,i.seg1)}static liftParameterToCurve(e,t,i){if(e==i)return t;if(!e.hasOwnProperty("segs"))return;let n=e,o=0;for(let a of n.segs){if(a==i)return t+o;o+=w.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let i=e.node,n=t.node;if(e.leafBoxesOffset>C.distanceEpsilon&&t.leafBoxesOffset>C.distanceEpsilon){let l=gt.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2),u=gt.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return w.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>C.distanceEpsilon){let l=gt.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2);return w.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>C.distanceEpsilon){let l=gt.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return w.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(i.low),a=e.seg.value(i.high);if(!p.closeDistEps(o,a)){let l=t.seg.value(n.low),u=t.seg.value(n.high);if(!p.closeDistEps(l,u)){let c=e.seg instanceof B?e.seg:B.mkPP(o,a),h=t.seg instanceof B?t.seg:B.mkPP(l,u),d=w.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d!=null)return w.adjustParameters(e,c,t,h,d),w.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,i){let n=t.node,o=i.node;if(t.leafBoxesOffset>C.distanceEpsilon&&i.leafBoxesOffset>C.distanceEpsilon){let a=gt.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2),l=gt.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);w.curveCurveXWithParallelogramNodes(a,l,e)}else if(t.leafBoxesOffset>C.distanceEpsilon){let a=gt.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);w.curveCurveXWithParallelogramNodes(a,i,e)}else if(i.leafBoxesOffset>C.distanceEpsilon){let a=gt.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);w.curveCurveXWithParallelogramNodes(t,a,e)}else{let a=t.seg.value(n.low),l=t.seg.value(n.high);if(!p.closeDistEps(a,l)){let u=i.seg.value(o.low),c=i.seg.value(o.high);if(!p.closeDistEps(u,c)){let h=t.seg instanceof B?t.seg:B.mkPP(a,l),d=i.seg instanceof B?i.seg:B.mkPP(u,c),f=w.crossWithinIntervalsWithGuess(h,d,0,1,0,1,.5,.5);f!=null&&(w.adjustParameters(t,h,i,d,f),w.addIntersection(t,i,e,f))}}}}static adjustParameters(e,t,i,n,o){if(t!=e.seg&&!(e.seg instanceof te))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(n!=i.seg&&!(i.seg instanceof te))o.bSol=i.seg.closestParameter(o.x);else{let a=i.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let n of this.segs){let o=t+n.parEnd-n.parStart;if(e>=t&&e<=o)return{par:e-t+n.parStart,seg:n};t=o}let i=this.segs[this.segs.length-1];return{seg:i,par:i.parEnd}}getSegIndexParam(e){let t=0,i=this.segs.length;for(let o=0;o<i;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let n=this.segs[i-1];return{segIndex:i-1,par:n.parEnd}}value(e){return ZL(this.getSegParam(e))}derivative(e){return QL(this.getSegParam(e))}secondDerivative(e){return KL(this.getSegParam(e))}thirdDerivative(e){return JL(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,i,n,o,a,l,u){if(e instanceof B&&t instanceof B){let d=w.crossTwoLineSegs(e.start,e.end,t.start,t.end,i,n,o,a);if(d!=null)return d}let c=w.minDistWithinIntervals(e,t,i,n,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=C.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:p.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,i,n,o,a,l,u){let c=t.sub(e),h=i.sub(n),d=i.sub(e),f=mn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(f==null)return;let P=f.x,E=f.y,v=e.add(c.mul(P));if(!(P<o-C.tolerance)&&(P=Math.max(P,o),!(P>a+C.tolerance)&&(P=Math.min(P,a),!(E<l-C.tolerance)&&(E=Math.max(E,l),!(E>u+C.tolerance)))))return E=Math.min(E,u),{aSol:P,bSol:E,x:v}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let i=2*t.boundingBox.diagonal,n=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new p(Math.cos(a*n),Math.sin(a*n)),u=B.mkPP(e,e.add(l.mul(i))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(w.AllIntersectionsAreGood(c,t)){for(let d of c)if(p.closeDistEps(d.x,e))return 1;if(c.length%2==1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let i=t.hasOwnProperty("segs"),n=null;if(i||t instanceof te&&(n=t.toCurve()),n){for(let o of e)if(!w.RealCut(w.DropIntersectionToSegs(o),n,!1))return!1}return!0}static RealCut(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(p.closeDistEps(u,o.end)){let f=null;for(let v=0;v<t.segs.length-1;v++)if(t.segs[v]==o){f=t.segs[v+1];break}if(f==null)return!1;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parEnd))*P.dot(f.derivative(f.parStart))<C.tolerance)}if(p.closeDistEps(u,o.start)){let f=null;for(let v=t.segs.length-1;v>0;v--)if(t.segs[v]==o){f=t.segs[v-1];break}if(f==null)return!1;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parStart))*P.dot(f.derivative(f.parEnd))<C.tolerance)}let d=c.dot(h);return i?d>C.distanceEpsilon:Math.abs(d)>C.distanceEpsilon}static realCutWithClosedCurve(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(p.closeDistEps(u,o.end)){let f=null;for(let v=0;v<t.segs.length;v++)if(t.segs[v]==o){f=t.segs[(v+1)%t.segs.length];break}if(f==null)throw new Error;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parEnd))*P.dot(f.derivative(f.parStart))<C.tolerance)}if(p.closeDistEps(u,o.start)){let f=null;for(let v=0;v<t.segs.length;v++)if(t.segs[v]==o){f=t.segs[v>0?v-1:t.segs.length-1];break}let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parStart))*P.dot(f.derivative(f.parEnd))<C.tolerance)}let d=c.dot(h);return i?d>C.distanceEpsilon:Math.abs(d)>C.distanceEpsilon}static minDistWithinIntervals(e,t,i,n,o,a,l,u){let c=new db(e,t,i,n,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.boundingBox_)return this.boundingBox_;if(this.segs.length==0)this.boundingBox_=W.mkEmpty();else{let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return this.boundingBox_=e}}clone(){let e=new w;for(let t of this.segs)e.addSegment(t.clone());return e.boundingBox_=this.boundingBox_.clone(),e}getParameterAtLength(e){let t=0;for(let i of this.segs){let n=i.length;if(n>=e)return t+i.getParameterAtLength(e);e-=n,t+=i.parEnd-i.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new w;for(let i of this.segs)t.addSegment(i.transform(e));return t}closestParameterWithinBounds(e,t,i){let n=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>i)break;let u=w.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(i-a)),f=l.closestParameterWithinBounds(e,h,d),P=e.sub(l.value(f)),E=P.dot(P);E<o&&(n=a+f-l.parStart,o=E)}a+=u}return n}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);u<i&&(t=n+a-o.parStart,i=u),n+=w.paramSpan(o)}return t}static addLineSegment(e,t,i){return e.addSegment(B.mkPP(t,i))}static addLineSegmentCNNP(e,t,i,n){return w.addLineSegment(e,new p(t,i),n)}static addLineSegmentCNNNN(e,t,i,n,o){w.addLineSegment(e,new p(t,i),new p(n,o))}static continueWithLineSegmentNN(e,t,i){w.addLineSegment(e,e.end,new p(t,i))}static continueWithLineSegmentP(e,t){w.addLineSegment(e,e.end,t)}static closeCurve(e){return w.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<C.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=w.paramSpan(t),Math.abs(e)<C.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<C.tolerance)return this.start==this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<C.tolerance)return t;e-=w.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let i=w.getAllIntersections(e,t,!0);if(i.length==0)return w.NonIntersectingCurveIsInsideOther(e,t);if(i.length==1)return e.start.equal(i[0].x)?w.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:w.PointRelativeToCurveLocation(e.start,t)==2;for(let n of w.PointsBetweenIntersections(e,i))if(w.PointRelativeToCurveLocation(n,t)==0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let i=t[t.length-1].par0,n=t[0].par0,o=e.parEnd-i+(n-e.parStart),a=i+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let i=e.parStart;i<e.parEnd;i+=.5){let n=w.PointRelativeToCurveLocation(e.value(i),t);if(n!=1)return n==2}return w.PointRelativeToCurveLocation(e.end,t)!=0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let i=w.getAllIntersections(e,t,!0);if(i.length==0)return w.NonIntersectingCurveIsInsideOther(e,t)||w.NonIntersectingCurveIsInsideOther(t,e);if(i.length==1)return e.start.equal(i[0].x)?w.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2||!t.start.equal(i[0].x)?w.PointRelativeToCurveLocation(t.start,e)==2:w.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)==2:w.PointRelativeToCurveLocation(e.start,t)==2;for(let n of w.PointsBetweenIntersections(e,i))if(w.PointRelativeToCurveLocation(n,t)==2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,i,n,o){let a=p.mkPoint(e,i.point,1-e,n.point),l=p.mkPoint(t,o.point,1-t,n.point),u=n.point.mul(2/3);return new Fe(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,i,n){let o=i.mul(n);return new Fe(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let i=t.next;if(i!=null)return{b:t,c:i}}static trimEdgeSplineWithNodeBoundaries(e,t,i,n){let o=i.parStart,a=i.parEnd;e!=null&&(o=w.findNewStart(i,o,e,n)),t!=null&&(a=w.findNewEnd(i,t,n,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?i.trim(l,u):i}static findNewEnd(e,t,i,n){let o=w.getAllIntersections(e,t,!0);if(o.length==0)return n=e.parEnd,n;if(i){n=e.parEnd;for(let a of o)a.par0<n&&(n=a.par0)}else{n=e.parStart;for(let a of o)a.par0>n&&(n=a.par0)}return n}static findNewStart(e,t,i,n){let o=w.getAllIntersections(e,i,!0);if(o.length==0){t=e.parStart;return}if(n){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof de)return w.refineEllipse(e);if(e instanceof te)return e;if(e instanceof w&&w.allSegsAreLines(e)){let t=new te;for(let i of e.segs)t.addPoint(i.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof B))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),i=Math.PI/4,n=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(n*n+o*o),l=[];for(let c=0;c<4;c++){let h=i+c*Math.PI/2,d=e.value(h),f=e.derivative(h).normalize().mul(a),P=B.mkPP(d.sub(f),d.add(f));for(let E of w.getAllIntersections(t,P,!0))l.push(E)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new te;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new te;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};function tO(s,e,t,i,n,o){if(n instanceof B)return!0;for(let a of[1/3,.5,2/3]){let l=s*a+t*(1-a);if(p.closeSquare(n.value(l),p.mkPoint(a,e,1-a,i),o)==!1)return!1}return!0}function fb(s,e,t,i,n,o){let a=[];if(tO(s,e,t,i,n,o))a.push(e),a.push(i);else{let l=.5*(s+t),u=n.value(l);a=fb(s,e,l,u,n,o);let c=fb(l,u,t,i,n,o).slice(1);a=a.concat(c)}return a}function cf(s,e){return fb(s.parStart,s.start,s.parEnd,s.end,s,e)}var te=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}toJSON(){return{points:Array.from(this).map(e=>e.toJSON())}}static fromJSON(e){return te.mkFromPoints(e.points.map(t=>p.fromJSON(t)))}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new p(e,t))}isClockwise(){return p.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new _t;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=_t.mkFromPoint(e);t.polyline=this,this.startPoint!=null?p.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let i=t.sub(e).div(2);return Le.parallelogramByCornerSideSide(e,i,i)}static mkFromPoints(e){let t=new te;for(let i of e)t.addPoint(i);return t}static mkClosedFromPoints(e){let t=te.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],i=this.startPoint,n=0;for(;i.next!=null;){let o=te.parallelogramOfLineSeg(i.point,i.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:B.mkPP(i.point,i.next.point)}}),i=i.next,n++}if(this.isClosed_){let o=te.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:B.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:Le.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=W.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return p.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new p(0,0)}thirdDerivative(e){return new p(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new te;t.addPoint(e.start);for(let i of e.segs)t.addPoint(i.end);return t.closed=e.start==e.end,t}trim(e,t){let i=this.toCurve();return i=i.trim(e,t),te.polylineFromCurve(i)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t==this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new te;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t==this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new te;for(let i of this.polylinePoints())t.addPoint(e.multiplyPoint(i.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,i){throw new Error("Method not implemented.")}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0,o=this.startPoint;for(;o.next!=null;){let a=B.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<i&&(i=c,t=l+n),o=o.next,n++}if(this.closed){let a=B.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<i&&(t=l+n)}return t}clone(){let e=new te;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t==this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new w;w.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)w.continueWithLineSegmentP(e,t.point);return this.closed&&w.continueWithLineSegmentP(e,this.startPoint.point),e}};var $t=class{pad(e){this.width+=e*2}constructor(e,t){this.width=e,this.height=t}},W=class{static mkSizeCenter(e,t){let i=e.width/2,n=e.height/2;return new W({left:t.x-i,right:t.x+i,bottom:t.y-n,top:t.y+n})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return W.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=W.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),i=Math.min(this.right,e.right),n=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new W({left:t,bottom:n,right:i,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=e.sub(this.center);this.leftTop=this.leftTop.add(t),this.rightBottom=this.rightBottom.add(t)}intersectsOnY(e){return!(e.bottom_>this.top_+C.distanceEpsilon||e.top_<this.bottom_-C.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+C.distanceEpsilon||e.right<this.left_-C.distanceEpsilon)}static mkEmpty(){return new W({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e}get right(){return this.right_}set right(e){this.right_=e}get top(){return this.top_}set top(e){this.top_=e}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e}get leftBottom(){return new p(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new p(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new p(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new p(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}static mkPP(e,t){let i=new W({left:e.x,right:e.x,top:e.y,bottom:e.y});return i.add(t),i}static rectangleOnPoint(e){return new W({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,i){let n=e+i.width,o=t+i.height;return new W({left:e,right:n,top:o,bottom:t})}static getRectangleOnCoords(e,t,i,n){let o=new W({left:e,bottom:t,right:e,top:t});return o.add(new p(i,n)),o}static mkOnPoints(e){let t=W.mkEmpty();for(let i of e)t.add(i);return t}static rectangleOnRectangles(e){let t=W.mkEmpty();for(let i of e)t.addRecSelf(i);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,i=(this.left_+this.right_)/2;this.left_=i-t,this.right_=i+t}isEmpty(){return this.width<0}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,i=(this.top_+this.bottom_)/2;this.top_=i+t,this.bottom=i-t}static rectangleOfTwo(e,t){let i=new W({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return i.addRecSelf(t),i}containsWithPadding(e,t){return this.left_-t-C.distanceEpsilon<=e.x&&e.x<=this.right_+t+C.distanceEpsilon&&this.bottom_-t-C.distanceEpsilon<=e.y&&e.y<=this.top_+t+C.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addWithCheck(e){let t;(t=e.x<this.left_)?this.left_=e.x:(t=this.right_<e.x)&&(this.right_=e.x);let i;return(i=e.y>this.top_)?this.top_=e.y:(i=this.bottom_>e.y)&&(this.bottom=e.y),t||i}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let i=e.clone();return i.center=e.center.add(t),i}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?W.mkPP(new p(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new p(Math.min(e.right,t.right),Math.min(e.top,t.top))):W.mkEmpty()}perimeter(){let e=new te;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return W.mkPP(this.leftTop,this.rightBottom)}get size(){return new $t(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let i=e.width/2,n=t.x-i,o=t.x+i,a=e.height/2,l=t.y-a,u=t.y+a;return new W({left:n,right:o,top:u,bottom:l})}addPointWithSize(e,t){let i=e.width/2,n=e.height/2;this.add(new p(t.x-i,t.y-n)),this.add(new p(t.x+i,t.y-n)),this.add(new p(t.x-i,t.y+n)),this.add(new p(t.x+i,t.y+n))}};var hf=class{bind(){this.entity&&this.entity.setAttr(hf.attachIndex,this)}constructor(e){this.entity=e,this.bind()}static getGeom(e){return e.getAttr(hf.attachIndex)}},Ue=hf;Ue.attachIndex=0;var Lt=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,i){this.elements[e][t]=i}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return ae(this.elements[0][0],1)&&ae(this.elements[0][1],0)&&ae(this.elements[0][2],0)&&ae(this.elements[1][0],0)&&ae(this.elements[1][1],1)&&ae(this.elements[1][2],0)}offset(){return new p(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new Lt(1,0,0,0,1,0)}constructor(e,t,i,n,o,a){this.elements=[[e,t,i],[n,o,a]]}static rotation(e){let t=Math.cos(e),i=Math.sin(e);return new Lt(t,-i,0,i,t,0)}static scaleAroundCenterTransformation(e,t,i){let n=1-e,o=1-t;return new Lt(e,0,n*i.x,0,t,o*i.y)}multiplyPoint(e){return new p(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new Lt(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,i=-this.getElem(0,1)/e,n=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-i*this.getElem(1,2),l=-n*this.getElem(0,2)-o*this.getElem(1,2);return new Lt(t,i,a,n,o,l)}};function df(s){return s.parEnd-s.parStart}function ff(s){switch(s.type){case"ellipse":return de.fromJSON(s.data);case"curve":return w.fromJSON(s.data);case"lineSegment":return B.fromJSON(s.data);case"bezier":return Fe.fromJSON(s.data);case"polyline":return te.fromJSON(s.data)}}var qr=class{static get DifferenceEpsilon(){return qr.differenceEpsilon}static EqualPP(e,t){return qr.Equal(e.x,t.x)&&qr.Equal(e.y,t.y)}static Equal(e,t){return qr.Compare(e,t)==0}static Compare(e,t){let i=0;return e+qr.DifferenceEpsilon<t?i=-1:t+qr.DifferenceEpsilon<e&&(i=1),i}static ComparePP(e,t){let i=qr.Compare(e.x,t.x);return i==0&&(i=qr.Compare(e.y,t.y)),i}static LessOrEqual(e,t){let i=qr.Compare(e,t);return i<0||i==0}static Less(e,t){return qr.Compare(e,t)<0}static GetDirections(e,t){return H.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return H.IsPureDirection(qr.GetDirections(e,t))}static IsPureDirectionD(e){return H.IsPureDirection(e)}static IsPureLower(e,t){let i=qr.GetDirections(e,t);return 2==i||1==i}static GetPureDirectionVV(e,t){return qr.GetDirections(e.point,t.point)}},V=qr;V.differenceEpsilon=C.distanceEpsilon/2;var H=class{constructor(e){this.Dir=e}get Right(){return new H(H.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>V.DifferenceEpsilon?t=2:e.x<-V.DifferenceEpsilon&&(t=8),e.y>V.DifferenceEpsilon?t=t|1:e.y<-V.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let i=0,n=t.x-e.x,o=t.y-e.y;return n>V.DifferenceEpsilon?i=2:-n>V.DifferenceEpsilon&&(i=8),o>V.DifferenceEpsilon?i|=1:-o>V.DifferenceEpsilon&&(i|=4),i}static DirectionFromPointToPoint(e,t){return H.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return H.IsPureDirection(H.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e==t||e==H.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)==2&&e++,(this.Dir&1)==1&&t++,(this.Dir&8)==8&&e--,(this.Dir&4)==4&&t--,new p(e,t)}static toPoint(e){return new H(e).ToPoint()}static negate(e){return new H(H.OppositeDir(e.Dir))}};var Yn=class{static createHexagon(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y;return te.mkClosedFromPoints([new p(o*-1+a,n*-1+l),new p(o+a,n*-1+l),new p(o+(n+a),0+l),new p(o+a,n+l),new p(o*-1+a,n+l),new p((o-n)*-1+a,0+l)])}static createOctagon(e,t,i){let n=e/2,o=t/2,a=new Array(8);a[0]=new p(n+Yn.octagonPad*n,o-o*Yn.octagonPad),a[3]=new p(a[0].x*-1,a[0].y),a[4]=new p(a[3].x,a[3].y*-1),a[7]=new p(a[0].x,a[0].y*-1),a[1]=new p(n-n*Yn.octagonPad,o+o*Yn.octagonPad),a[2]=new p(a[1].x*-1,a[1].y),a[6]=new p(a[1].x,a[1].y*-1),a[5]=new p(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(i);return te.mkClosedFromPoints(a)}static createInvertedHouse(e,t,i){let n=Yn.createHouse(e,t,i);return Yn.rotateCurveAroundCenterByDegree(n,i,180)}static createHouse(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new w;return w.addLineSegmentCNNNN(u,a-n,l-o,a+n,l-o),w.continueWithLineSegmentNN(u,a+n,l+o),w.continueWithLineSegmentNN(u,a,l+2*o),w.continueWithLineSegmentNN(u,a-n,l+o),w.closeCurve(u)}static CreateDiamond(e,t,i){let n=e,o=t,a=i.x,l=i.y,u=new w,c=[new p(a,l-o),new p(a+n,l),new p(a,l+o),new p(a-n,l)];return u.addSegs([B.mkPP(c[0],c[1]),B.mkPP(c[1],c[2]),B.mkPP(c[2],c[3]),B.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,i){return Yn.rotateCurveAroundCenterByRadian(e,t,i*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,i){let n=Math.cos(i),o=Math.sin(i),a=new Lt(1,0,t.x,0,1,t.y).multiply(new Lt(n,-o,0,o,n,0)).multiply(new Lt(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return de.mkCircle(e,t)}static createRectangle(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new w,c=[new p(a-n,l-o),new p(a+n,l-o),new p(a+n,l+o),new p(a-n,l+o)];return u.addSegs([B.mkPP(c[0],c[1]),B.mkPP(c[1],c[2]),B.mkPP(c[2],c[3]),B.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof w))return;let t=e.segs;if(t.length!=8&&t.length!=4)return;let i=t.length==8,n,o;for(let a=0;a<4;a++){let l=i?2*a+1:a;if(a==0){if(!(t[l]instanceof de))return;let u=t[l];n=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof de))return;let u=t[l];if(n!=u.aAxis.length||o!=u.bAxis.length)return}}return{radX:n,radY:o}}static mkRectangleWithRoundedCorners(e,t,i,n,o=new p(0,0)){if(i==0||n==0)return Yn.createRectangle(e,t,o);let a=new w,l=e/2;i>l/2&&(i=l/2);let u=t/2;n>u/2&&(n=u/2);let c=o.x,h=o.y,d=l-i,f=u-n,P=h+u,E=h-u,v=c-l,L=c+l,O=new p(i,0),D=new p(0,n);return d>0&&a.addSegment(B.mkPP(new p(c-d,E),new p(c+d,E))),a.addSegment(de.mkEllipse(1.5*Math.PI,2*Math.PI,O,D,c+d,h-f)),f>0&&a.addSegment(B.mkPP(new p(L,h-f),new p(L,h+f))),a.addSegment(de.mkEllipse(0,.5*Math.PI,O,D,c+d,h+f)),d>0&&a.addSegment(B.mkPP(new p(c+d,P),new p(c-d,P))),a.addSegment(de.mkEllipse(.5*Math.PI,Math.PI,O,D,c-d,h+f)),f>0&&a.addSegment(B.mkPP(new p(v,h+f),new p(v,h-f))),a.addSegment(de.mkEllipse(Math.PI,1.5*Math.PI,O,D,c-d,h-f)),a}},Be=Yn;Be.octagonPad=1/4;var hu=class extends Ue{constructor(){super(...arguments);this.padding=1}toJSON(){return{boundaryCurve:this.boundaryCurve,padding:this.padding}}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(e){(e!=null&&e.boundingBox.height<hu.minHeight||e.boundingBox.width<hu.minWidth)&&(e=Be.mkCircle(hu.minWidth,e.boundingBox.center)),this._boundaryCurve=e}get id(){return this.node.id}toString(){return this.id}static mkNode(e,t){let i=new hu(t);return i.boundaryCurve=e,i}get center(){return this.boundaryCurve.boundingBox.center}set center(e){let t=e.sub(this.center);this.boundaryCurve.translate(t)}fitBoundaryCurveToTarget(e){if(this.boundaryCurve!=null){let t=Be.isRoundedRect(this.boundaryCurve);if(t==null){let i=e.width/this.boundaryCurve.boundingBox.width,n=e.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(i,n),this.boundaryCurve.translate(e.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=Be.mkRectangleWithRoundedCorners(e.width,e.height,t.radX,t.radY,e.center)}}*inEdges(){for(let e of this.node.inEdges)yield Ue.getGeom(e)}*outEdges(){for(let e of this.node.outEdges)yield Ue.getGeom(e)}*selfEdges(){for(let e of this.node.selfEdges)yield Ue.getGeom(e)}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(e){!this.boundaryCurve||(Math.abs(e.width-this.width)<1e-4&&Math.abs(e.height-this.height)<1e-4?this.center=e.center:this.fitBoundaryCurveToTarget(e))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(e){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e))}underCollapsedGraph(){let e=this.node.parent;if(e==null)return!1;let t=Re.getGeom(e);return t==null?!1:t.isCollapsed?!0:t.underCollapsedGraph()}},wr=hu;wr.minHeight=2,wr.minWidth=3;var tt=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new tt;return t.point=e,t}static mkSiteSP(e,t){let i=new tt;return i.point=t,i.prev=e,e.next=i,i}static mkSiteSPS(e,t,i){let n=new tt;return n.prev=e,n.point=t,n.next=i,e.next=n,i.prev=n,n}get turn(){return this.next==null||this.prev==null?0:p.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new tt;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var mt=class{static mkFromPoints(e){let t=null,i=null;for(let n of e)if(i==null)i=tt.mkSiteP(n),t=new mt(i);else{let o=tt.mkSiteP(n);o.prev=i,i.next=o,i=o}return t}clone(){let e=this.headSite,t=null,i,n=null;for(;e!=null;)i=e.clone(),i.prev=t,t!=null?t.next=i:n=i,e=e.next,t=i;return new mt(n)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield B.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new w,t=this.headSite,i;do{let n=w.findCorner(t);if(n==null)break;let o=mt.createBezierSegOnSite(n.b);e.segs.length==0?p.closeDistEps(t.point,o.start)||w.addLineSegment(e,t.point,o.start):p.closeDistEps(e.end,o.start)||w.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=n.b}while(!0);return e.segs.length==0?p.closeDistEps(t.point,t.next.point)?e.segs.push(new Fe(t.point,t.point.add(new p(5,5)),t.point.add(new p(-5,5)),i.point)):w.addLineSegment(e,t.point,t.next.point):p.closeDistEps(e.end,t.next.point)||w.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,i=e.nextBezierCoefficient,n=e.prev,o=e.next,a=n.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(i).add(e.point.mul(1-i)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Fe.mkBezier([a,u,c,l])}};var ji=class{constructor(){this.length=ji.defaultArrowheadLength;this.width=0}clone(){let e=new ji;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=ji.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let i=ji.findTrimEndForArrowheadAtTarget(e);if(i==null||t>i-C.intersectionEpsilon||w.closeIntersectionPoints(e.curve.value(t),e.curve.value(i)))return!1;let n=e.curve.trim(t,i);return n==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=n,!0)}static getIntersectionsWithArrowheadCircle(e,t,i){let n=de.mkFullEllipseNNP(t,t,i);return w.getAllIntersections(n,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=C.distanceEpsilon*C.distanceEpsilon,i=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=C.distanceEpsilon)return i;let n=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u==0)return;l=ji.getIntersectionsWithArrowheadCircle(n,o,n.end),i=l.length!=0?Math.max(...l.map(c=>c.par1)):n.parEnd,a=e.curve.value(i),o/=2}while(a.sub(n.start).lengthSquared<t||l.length==0);return i}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=C.distanceEpsilon)return e.curve.parStart;let t=C.distanceEpsilon*C.distanceEpsilon,i=e.sourceArrowhead.length,n,o=e.curve,a,l=10,u;for(;--l>0;){if(a=ji.getIntersectionsWithArrowheadCircle(o,i,o.start),a.length==0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),n=a.filter(c=>c.par1==u)[0].x,n.sub(o.end).lengthSquared>=t)return u;i/=2}}static trimSplineAndCalculateArrowheads(e,t,i){return ji.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,i)}static trimSplineAndCalculateArrowheadsII(e,t,i,n,o){if(e.curve=w.trimEdgeSplineWithNodeBoundaries(t,i,n,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<C.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<C.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>C.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>C.intersectionEpsilon)&&!a&&(a=ji.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!=0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=n.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=n.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,i=e.target.center,n=i.sub(t),o=n.length,a;o<.001?(a=new p(1,0),i=t.add(a.rotate(Math.PI/2))):a=n.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=w.createBezierSegN(t,i,a,u);if(ji.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}ji.createEdgeCurveWithNoTrimming(e,t,i)}static createEdgeCurveWithNoTrimming(e,t,i){let n=i.sub(t).normalize(),o=t,a=i,l=e.targetArrowhead;l!=null&&(l.tipPosition=i,a=i.sub(n.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(n.mul(u.length))),e.curve=B.mkPP(o,a)}},gr=ji;gr.defaultArrowheadLength=5;var We=class extends Ue{constructor(e){super(e);this.targetArrowhead=new gr;this.lineWidth=1}requireRouting(){this.curve=null,this.underlyingPolyline=null}get sourcePort(){return this._sourcePort}set sourcePort(e){this._sourcePort=e}get targetPort(){return this._targetPort}set targetPort(e){this._targetPort=e}Translate(e){if(!(e.x==0&&e.y==0)){if(this.curve!=null&&this.curve.translate(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,i=this.smoothedPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=i.point.add(e);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(e)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(e))}}GetMaxArrowheadLength(){let e=0;return this.sourceArrowhead!=null&&(e=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>e?this.targetArrowhead.length:e}transform(e){if(this.curve!=null){if(this.curve=this.curve.transform(e),this.underlyingPolyline!=null)for(let t=this.underlyingPolyline.headSite,i=this.underlyingPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=e.multiplyPoint(t.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=e.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=e.multiplyPoint(this.targetArrowhead.tipPosition)),this.label!=null&&(this.label.center=e.multiplyPoint(this.label.center))}}get labelBBox(){return this.label.boundingBox}get edge(){return this.entity}get source(){return Ue.getGeom(this.edge.source)}get boundingBox(){let e=W.mkEmpty();if(this.underlyingPolyline!=null)for(let i of this.underlyingPolyline)e.add(i);this.curve!=null&&e.addRecSelf(this.curve.boundingBox),this.sourceArrowhead!=null&&e.add(this.sourceArrowhead.tipPosition),this.targetArrowhead!=null&&e.add(this.targetArrowhead.tipPosition),this.edge.label&&e.addRecSelf(this.label.boundingBox);let t=this.lineWidth;return e.left-=t,e.top+=t,e.right+=t,e.bottom-=t,e}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return Ue.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(e,t,i){let n=e.boundingBox.width,o=e.boundingBox.height,a=e.boundingBox.center,l=new p(a.x-n/4,a.y),u=new p(a.x-n/4,a.y-o/2-t),c=new p(a.x+n/4,a.y-o/2-t),h=new p(a.x+n/4,a.y);return i.smoothedPolyline=mt.mkFromPoints([l,u,c,h]),i.smoothedPolyline.createCurve()}underCollapsedGraph(){return this.source.underCollapsedGraph()||this.target.underCollapsedGraph()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var Ee=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var pb=class{},du=pb;du.GoldenRatio=(1+Math.sqrt(5))/2,du.GoldenRatioRemainder=2-pb.GoldenRatio;var Ts=class extends Ee{constructor(e,t){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=e,this.desiredAspectRatio=t}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(e,t,i){let n=Ts.GetGoldenSectionStep(e,t),o=Math.max(i/10,(t-e)/Ts.MaxSteps);t+=o,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length==1?this.PackLimit(e):this.rectangles.length==2?(this.PackLimit(e),this.PackLimit(t)):this.rectangles.length>2&&Ts.GoldenSectionSearch(l=>this.PackLimit(l),e,n,t,o);let a=this.bestPacking.getRects();for(let l=0;l<this.rectangles.length;l++)this.rectangles[l]=a[l]}PackLimit(e){let t=this.cachedCosts.get(e);if(t==null){let i=this.createPacking(this.rectangles,e);i.run(),this.cachedCosts.set(e,t=Math.abs(i.PackedAspectRatio-this.desiredAspectRatio)),t<this.bestPackingCost&&(this.bestPackingCost=t,this.bestPacking=i)}return t}static GoldenSectionSearch(e,t,i,n,o){if(Math.abs(t-n)<o)return e(t)<e(n)?t:n;let a=Ts.GetGoldenSectionStep(i,n),l=e(i),u=e(a),c=()=>Ts.GoldenSectionSearch(e,a,i,t,o),h=()=>Ts.GoldenSectionSearch(e,i,a,n,o);if(u<l)return h();if(u>l)return c();let d=h(),f=c();return e(f)<e(d)?f:d}static GetGoldenSectionStep(e,t){return e<t?e+du.GoldenRatioRemainder*(t-e):e-du.GoldenRatioRemainder*(e-t)}},pf=Ts;pf.MaxSteps=1e3;var gE=be(qi());var mb=class extends Ee{get PackedWidth(){return this.packedWidth}set PackedWidth(e){this.packedWidth=e}get PackedHeight(){return this.packedHeight}set PackedHeight(e){this.packedHeight=e}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let e=[];for(let[t,i]of this.rectsToCenters)t.center=i,e.push(t);return e}};var fu=class extends mb{constructor(e,t,i=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=i?e:fu.SortRectangles(e),this.wrapWidth=t}static SortRectangles(e){return e.sort((t,i)=>i.height-t.height),e}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let e=new gE.Stack,t=!1,i=0,n=0,o=0,a=this.rectanglesByDescendingHeight;for(let l=0;t||l<a.length;){let u=a[l],c=e.length>0?e.top:null;if(c==null||c.right+u.width<=this.wrapWidth&&i+u.height<=c.top){let d=new p(c?c.right:0,i).add(new p(u.width/2,u.height/2));u.center=d,this.rectsToCenters.set(u,d),n=Math.max(n,u.right),o=Math.max(o,u.top),e.push(u),t=!1}else i=c.top,e.pop(),t=!0;t||l++}this.PackedWidth=n,this.PackedHeight=o}};var th=class extends pf{constructor(e,t){super(fu.SortRectangles(e),t);this.createPacking=(i,n)=>new fu(i,n,!0)}run(){let e=Number.MAX_VALUE,t=0,i=0;for(let n of this.rectangles){let o=n.width;i+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,i,e)}};var rh=be(qi());function iO(s,e,t,i,n,o){for(let l=0;l<s.length;l++){if(l==e||l==t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;i.length*2<n.length?(i.push(s[l]),o.box0=u):n.length*2<i.length?(n.push(s[l]),o.box1=h):c<d?(i.push(s[l]),o.box0=u):d<c?(n.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(i.push(s[l]),o.box0=u):(n.push(s[l]),o.box1=h)}}function Qe(s){if(s.length==0)return null;if(s.length==1)return s[0];let e={b0:s[0].irect,seed0:1},t=nO(s,e),i=[],n=[];i.push(s[e.seed0]),n.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};iO(s,e.seed0,t,i,n,o);let a=bE(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=Qe(i),a.Right=Qe(n),a}function mE(s,e){return s.add_rect(e).area}function nO(s,e){let t=mE(e.b0,s[e.seed0].irect);for(let n=2;n<s.length;n++){let o=mE(e.b0,s[n].irect);o>t&&(e.seed0=n,t=o)}let i;for(let n=0;n<s.length;n++)if(n!=e.seed0){i=n;break}t=s[e.seed0].irect.add_rect(s[i].irect).area;for(let n=0;n<s.length;n++){if(n==e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[n].irect).area;o>t&&(i=n,t=o)}return i}function nh(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(i=>ct(i,e(i)));return Qe(t)}function bE(s){let e=new oh;return e.Count=s,e}function ct(s,e){let t=new oh;return t.UserData=s,t.irect=e,t.Count=1,t}function bb(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)==0?s.Left!=null?bb(s.Left,e,t)==0&&bb(s.Right,e,t)==0?0:1:0:1:0}var oh=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent==this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent==this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this==this.Parent.Left}FirstHitNodePF(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)==1?this:null:this:(i=this.Left.FirstHitNodePF(e,t))!=null?i:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)==1?this:null:(i=this.Left.FirstHitNodeWithPredicate(e,t))!=null?i:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t){let i=new rh.Stack;for(i.push(this);i.size>0;){let n=i.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?(t==null||t(n.UserData))&&(yield n.UserData):(i.push(n.left),i.push(n.right)))}}*AllHitItems_(e){let t=new rh.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.contains_point(e)&&(i.IsLeaf?yield i.UserData:(t.push(i.left),t.push(i.right)))}}VisitTree(e,t){bb(this,e,t)}Clone(){let e=bE(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new rh.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?yield i:(t.push(i.left),t.push(i.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new rh.Stack;for(t.push(this);t.size>0;){let i=t.pop();(i.IsLeaf||!e)&&(yield i),i.IsLeaf||(t.push(i.left),t.push(i.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function $n(s){return new Ma(Qe(s.map(([e,t])=>ct(t,e))))}function oO(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function PE(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function sO(s,e){let t=new Array;for(let n of s.GetAllLeafNodes())n!=e&&t.push(n);let i=Qe(t);s.Count=i.Count,s.Left=i.Left,s.Right=i.Right,s.irect=i.Left.irect.add_rect(i.Right.irect)}function aO(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!yE(e))return e;return null}function yE(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function Pb(s,e,t,i){return s.irect.intersects_rect(e)?s.IsLeaf?i(s.UserData)?--t.bound!=0:!0:Pb(s.Left,e,t,i)&&Pb(s.Right,e,t,i):!0}var Ma=class{Clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,i){return Pb(this._rootNode,e,{bound:t},i)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(ct(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=Qe(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=Qe(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=ct(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let i,n;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{i=t.Left.irect.add_rect(e.irect);let o=i.area-t.Left.irect.area;n=t.Right.irect.add_rect(e.irect);let a=n.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n):i.area<n.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count==0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count==0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count==0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count==0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(i.UserData==t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let i;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))n.UserData==t&&(i=n);if(i!=null)return this.RootNode.Count==1?this.RootNode=null:this.RemoveLeaf(i),i.UserData}RemoveLeaf(e){let t=aO(e);if(t!=null)sO(t,e),PE(t);else{let i=e.Parent;i==null?this._rootNode=new oh:(oO(i,e.IsLeftChild?i.Right:i.Left),PE(i))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!yE(t))return t;return null}};function gf(s,e){let t=new Array;for(let o of e)t.push({g:o,lb:o.boundingBox.leftBottom.clone()});let i=e.map(o=>o.boundingBox),n=new th(i,1.5);n.run();for(let{g:o,lb:a}of t){let l=o.boundingBox.leftBottom.sub(a);o.translate(l)}s.boundingBox=new W({left:0,bottom:0,right:n.PackedWidth,top:n.PackedHeight}),s.addLabelToGraphBB(s.boundingBox)}var Re=class extends wr{constructor(e){super(e);this.isCollapsed=!1;this.MinimalWidth=0;this.MinimalHeight=0;this.Margins=10}static getGeom(e){return e.getAttr(Ue.attachIndex)}*intersectedObjects(e,t=!0){this._rtree==null&&(this._rtree=this.buildRTree());let i=this._rtree.GetAllIntersecting(e),n=e.perimeter();for(let o of i)if(o instanceof wr&&(yield o),!t&&o instanceof We){let a=o.curve;(w.intersectionOne(a,n,!1)!=null||w.PointRelativeToCurveLocation(a.start,n)==2)&&(yield o)}}buildRTree(){let e=Array.from(this.deepNodes).concat(Array.from(this.deepEdges())).map(t=>[t.boundingBox,t]);return $n(e)}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(e){this.layoutSettings=e;for(let t of this.deepNodes){let i=t;i.layoutSettings=e}}get layoutSettings(){return this._layoutSettings}set layoutSettings(e){this._layoutSettings=e}translate(e){if(e.x==0&&e.y==0)return;let t=new Lt(1,0,e.x,0,1,e.y);this.transform(t)}get labelSize(){return this._labelSize}set labelSize(e){this._labelSize=e}get boundingBox(){return this._boundingBox_==null&&this.updateBoundingBox(),this._boundingBox_}set boundingBox(e){this._boundingBox_=e}transform(e){if(!e.isIdentity()){this.boundaryCurve!=null?(this.boundaryCurve=this.boundaryCurve.transform(e),this.boundingBox=this.boundaryCurve.boundingBox):this.boundingBox=null;for(let t of this.shallowNodes())t.transform(e);for(let t of this.edges())t.transform(e)}}get deepNodes(){return this.deepNodesIt()}*deepNodesIt(){for(let e of this.graph.deepNodes)yield Ue.getGeom(e)}setEdge(e,t){let i=this.graph.setEdge(e,t);return new We(i)}pumpTheBoxToTheGraphWithMargins(e){let t={b:W.mkEmpty()};return this.pumpTheBoxToTheGraph(t),t.b.pad(Math.max(this.Margins,e)),this.MinimalWidth>0&&(t.b.width=Math.max(t.b.width,this.MinimalWidth)),this.MinimalHeight>0&&(t.b.height=Math.max(t.b.height,this.MinimalHeight)),this._boundingBox_=t.b,t.b}get center(){return this.boundingBox?this.boundingBox.center:new p(0,0)}set center(e){let t=e.sub(this.center),i=new Lt(1,0,t.x,0,1,t.y);this.transform(i)}pumpTheBoxToTheGraph(e){for(let t of this.edges())if(!t.underCollapsedGraph()){if(t.curve!=null){let i=t.curve.boundingBox;i.pad(t.lineWidth),e.b.addRecSelf(i)}t.label!=null&&e.b.addRecSelf(t.label.boundingBox)}for(let t of this.shallowNodes())t.underCollapsedGraph()||!t.boundingBox||e.b.addRecSelf(t.boundingBox)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}*shallowNodes(){for(let e of this.graph.shallowNodes)yield Ue.getGeom(e)}*edges(){for(let e of this.graph.edges)yield Ue.getGeom(e)}*deepEdges(){for(let e of this.graph.deepEdges())yield Ue.getGeom(e)}static mk(e,t=new $t(0,0)){let i=new Re(new Ze(e));return i.labelSize=t,i}*subgraphs(){for(let e of this.graph.subgraphs())yield Ue.getGeom(e)}static mkWithGraphAndLabel(e,t){let i=new Re(e);return i.labelSize=t,i}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(e){let t=this.graph.liftNode(e.node);return t?Ue.getGeom(t):null}findNode(e){let t=this.graph.findNode(e);return t?Ue.getGeom(t):null}addNode(e){return this.graph.addNode(e.node),e}updateBoundingBox(){if(this.graph.isEmpty())return;let e=W.mkEmpty(),t=0;for(let i of this.graph.edges){let n=Ue.getGeom(i);n.curve!=null&&(e.addRecSelf(n.boundingBox),t=Math.max(t,n.lineWidth))}for(let i of this.shallowNodes())i instanceof Re&&i.updateBoundingBox(),i.boundingBox&&(e.addRecSelf(i.boundingBox),t=Math.max(t,i.padding));this.addLabelToGraphBB(e),e.pad(Math.max(t,this.Margins)),this.boundingBox=e}addLabelToGraphBB(e){this.labelSize&&(e.top+=this.labelSize.height+2,e.width<this.labelSize.width&&(e.width=this.labelSize.width))}FlipYAndMoveLeftTopToOrigin(){let e=new Lt(1,0,-this.left,0,-1,this.top);this.transform(e);for(let i of this.deepNodes)if(i instanceof Re&&!i.graph.isEmpty()){let o=i.boundingBox;i.boundingBox=W.mkSizeCenter(new $t(o.width,o.height),e.multiplyPoint(o.center))}let t=this.boundingBox;this.boundingBox=W.mkSizeCenter(new $t(t.width,t.height),e.multiplyPoint(t.center))}};var sh=class extends Ue{constructor(e,t){super(t);this.boundingBox=W.mkPP(new p(0,0),new p(e.width,e.height))}get label(){return this.entity}get width(){return this.boundingBox.width}set width(e){this.boundingBox.width=e}get height(){return this.boundingBox.height}set height(e){this.boundingBox.height=e}get center(){return this.boundingBox.center}set center(e){this.boundingBox.center=e}get isPositioned(){let e=this.center;return e.x!=-77||e.y!=-77}requirePositioning(){this.boundingBox.center=new p(-77,-77)}};var SE=be(vs());function pu(s){let e=new ar;return e.SetEdges(s,ar.vertexCount(s)),e}function mf(s){let e=new ar;return e.SetEdges(s,ar.vertexCount(s)),e}function Lr(s,e){let t=new ar;return t.SetEdges(s,e),t}var ar=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let i=e.indexOf(t,0);i>-1&&e.splice(i,1)}removeEdge(e){ar.deleteFromArray(this.edges,e),e.source!=e.target?(ar.deleteFromArray(this.outEdges[e.source],e),ar.deleteFromArray(this.inEdges[e.target],e)):ar.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let i of e)i.source>=t&&(t=i.source),i.target>=t&&(t=i.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let i=new Array(this.nodeCount).fill(0),n=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!=a.target?(i[a.source]++,n[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(i[a]),i[a]=0,this.inEdges[a]=new Array(n[a]),n[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!=u?(this.outEdges[l][i[l]++]=a,this.inEdges[u][n[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!=e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length==0)return;let e=new Set,t=new SE.Queue,i=this.edges[0].source;for(ar.enqueue(e,t,i),yield i;t.length>0;){i=t.dequeue();for(let n of this.outEdges[i]){let o=n.target;e.has(o)||(ar.enqueue(e,t,o),yield o)}for(let n of this.inEdges[i]){let o=n.source;e.has(o)||(ar.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,i){t.enqueue(i),e.add(i)}};var ge=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x==this.y}};var EE=be(qi());var bn=class{set(e,t,i){this.arrayOfMaps[e].set(t,i)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield new ge(e,i[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield[new ge(e,i[0]),i[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield i[1]}}};var xE=class{constructor(e,t){this.v=e,this.i=t}},Ei=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,i,n){t[i]=1,e.push(new xE(i,n))}static getFeedbackSet(e){let t=new bn(e.nodeCount);if(e==null||e.nodeCount==0)return[];let i=new Array(e.nodeCount).fill(0);for(let n=0;n<e.nodeCount;n++){if(i[n]==2)continue;let o=new EE.Stack,a=0;for(Ei.push(o,i,n,a);o.size>0;){let l=o.pop();n=l.v,i[n]=2,a=l.i;let u=e.outEdges[n];for(;a<u.length;a++){let c=u[a];if(c.source==c.target)continue;let h=i[c.target];h==1?t.set(c.source,c.target,c):h==0&&(Ei.push(o,i,n,a+1),n=c.target,i[c.target]=2,u=e.outEdges[n],a=-1)}}}return Array.from(t.values())}};var vE=be(zt()),xi=class{constructor(e,t,i,n=1){this.Source=e,this.Target=t,this.CrossingWeight=i,this.Weight=n}toString(){return vE.String.Format("{0}->{1}",this.Source,this.Target)}};var _a=class{static FindClosestPoints(e,t){let i=w.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(i)return{curveClosestPoint:i.aX,labelSideClosest:i.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof w){for(let i of e.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static ShiftLabel(e,t,i){let n=e.lineWidth/2,o=t.sub(i),a=o.length;a>n&&(e.label.center=e.label.center.add(o.div(a*(a-n))))}static updateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new p(t.x+t.rightAnchor/2,t.y),i=B.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new p(t.x-t.leftAnchor/2,t.y),i=B.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=_a.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&w.getAllIntersections(e.curve,w.polyFromBox(e.labelBBox),!1).length==0){let o=_a.FindClosestPoints(n,i);if(o)_a.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=n.closestParameter(i.start),c=n.closestParameter(i.end);n.value(u).sub(i.start).length<n.value(c).sub(i.end).length?(a=n.value(u),l=i.start):(a=n.value(c),l=i.end),_a.ShiftLabel(e,a,l)}}}},Or=class{constructor(e,t,i,n=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=i,this.weight=n,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.underlyingPolyline}set underlyingPolyline(e){this.edge.underlyingPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source==this.target}reversedClone(){let e=new Or(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let i=0;i<t;i++){let n=this.LayerEdges[t-1-i];e.LayerEdges[i]=new xi(n.Target,n.Source,n.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e==this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,i=this.LayerEdges[t];_a.updateLabel(this.edge,e[i.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var mr=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let i=this.arrayOfSets[e];return i!=null&&i.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new mr;for(let i of e)t.add(i);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let i of t.values())yield new ge(e,i)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let i=this.arrayOfSets[e];i==null&&(this.arrayOfSets[e]=i=new Set),i.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var AE=be(vs());function*ko(s){let e=new Array(s.nodeCount).fill(!1),t=new AE.Queue;for(let i=0;i<s.nodeCount;i++)if(!e[i]){let n=new Array;for(CE(i,t,e);t.length>0;){let o=t.dequeue();n.push(o);for(let a of uO(s,o))CE(a,t,e)}yield n}}function*uO(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function CE(s,e,t){t[s]==!1&&(e.enqueue(s),t[s]=!0)}var yb=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new mr;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size==0&&this.minLayerOfGeomGraph.size==0&&this.sameLayerConstraints.length==0&&this.upDownConstraints.length==0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=Lr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=Ei.getFeedbackSetWithConstraints(e,null);for(let i of t)this.gluedUpDownIntConstraints.remove(i)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new ge(this.maxRepresentative,t))}if(this.minRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.minRepresentative&&this.gluedUpDownIntConstraints.add(new ge(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new mr}gluedIntPairNN(e){return new ge(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new ge(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new ge(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),i=this.nodeToRepr(e.target),n=new Or(t,i,e.edge);return n.separation=e.separation,n.weight=0,n}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of ko(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return Lr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!=-1&&this.maxLayerInt.filter(t=>t!=this.maxRepresentative).map(t=>new ge(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!=-1&&this.minLayerInt.filter(t=>t!=this.minRepresentative).map(t=>new ge(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new ge(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.minRepresentative);else for(let i of e)t==-1&&(t=i),this.sameLayerDictionaryOfRepresentatives.set(i,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative==t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative==t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!=-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(Ei.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let i of this.unglueEdge(t))yield i}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let i of this.intGraph.outEdges[t])this.nodeToRepr(i.target)==e.target&&(yield i)}createGluedGraph(){let e=new mr;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),Lr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function cO(s,e){return[s,e]}var Sb=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length==0&&this.upDownVerticalConstraints.length==0&&this.leftRightConstraints.length==0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length==0&&!this.nodeToBlockRoot.has(t)){let i=new Array,n=t;for(let o=e.outEdges[n];o.length>0;o=e.outEdges[n])n=o[0].y,i.push(n),this.nodeToBlockRoot.set(n,t);i.length>0&&this.BlockRootToBlock.set(t,i)}}BasicGraphFromLeftRightIntNeibs(){return pu(Array.from(this.LeftRightIntNeibs.values()).map(e=>new ge(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=mr.mk(this.leftRightConstraints.map(t=>cO(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ge(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!=t.x));let e=Ei.getFeedbackSet(pu(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new ge(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=mr.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ge(t[0],t[1]))),this.VerticalInts=mr.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1&&e[t[0]]>e[t[1]]).map(t=>new ge(t[0],t[1])))}};var mu=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(mu||{});var bu=class{constructor(){this.capacityOverflowCoefficient=bu.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=bu.DefaultPathLengthImportance;this.inkImportance=bu.DefaultInkImportance;this.edgeSeparation=bu.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOriginalSpline=!1;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},Zn=bu;Zn.DefaultCapacityOverflowCoefficientMultiplier=1e3,Zn.DefaultPathLengthImportance=500,Zn.DefaultInkImportance=.01,Zn.DefaultEdgeSeparation=.5;var yu=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=3;this.polylinePadding=1.5;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e==1&&this.BundlingSettings==null&&this.BundlingSettings==null&&(this.BundlingSettings=new Zn),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var ah=class{constructor(){this.edgeRoutingSettings=new yu;this.minimalWidth=0;this.minimalHeight=0;this.nodeSeparation=10;this.packingAspectRatio=1.5}get MinimalWidth(){return this.minimalWidth}set MinimalWidth(e){this.minimalWidth=Math.max(e,0)}get MinimalHeight(){return this.minimalHeight}set MinimalHeight(e){this.minimalHeight=Math.max(e,0)}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}},Xr=class extends ah{constructor(){super();this.margins={left:0,top:0,bottom:0,right:0};this.sameRanks=new Array;this.verticalConstraints=new yb;this.horizontalConstraints=new Sb;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=Lt.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.edgeRoutingSettings.EdgeRoutingMode=3}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=Lt.rotation(e);for(let i=0;i<2;i++)for(let n=0;n<3;n++)if(!ae(t.elements[i][n],this.transform.elements[i][n]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=Lt.getIdentity();break;case 1:this.transform=Lt.rotation(Math.PI/2);break;case 3:this.transform=Lt.rotation(-Math.PI/2);break;case 2:this.transform=Lt.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var Rr=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>C.distanceEpsilon?1:e<-C.distanceEpsilon?-1:0}};var Uo=class extends ar{constructor(e,t){super();this.SetEdges(e,t)}};var Eb=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new bn(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let i=new ge(t.source,t.target),n=new ge(t.target,t.source),o=this.Multiedges.get(i.x,i.y);for(let a of o)a.reverse();if(this.Multiedges.has(n.x,n.y)){let a=this.Multiedges.get(n.x,n.y);for(let l of o)a.push(l)}else this.Multiedges.set(n.x,n.y,o);this.Multiedges.delete(i.x,i.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new ge(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function lh(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var vi=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length==0&&t++;if(t==0)return this;let i=new Array(this.y.length);for(let a=0;a<i.length;a++)i[a]=this.y[a]-e[this.y[a]];let n=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(n[a-e[a]]=Array.from(this.layers[a]));let o=new vi(i);return o.layers=n,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)lh(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let i of e)this.verticesToX[i]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let i=0;i<this.y.length;i++)e[i]=t-this.y[i];return new vi(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let i of this.y)i+1>e&&(e=i+1);let t=new Array(e).fill(0);for(let i of this.y)t[i]++;this.layers=new Array(e);for(let i=0;i<e;i++)this.layers[i]=new Array(t[i]),t[i]=0;for(let i=0;i<this.y.length;i++){let n=this.y[i];this.layers[n][t[n]++]=i}}};var uh=class extends Ee{constructor(e,t,i,n){super(n);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=i,this.dag=e,this.layering=t,this.Init()}static Balance(e,t,i,n){new uh(e,t,i,n).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(e){this.jumpers.delete(e);let t=this.possibleJumperFeasibleIntervals.get(e),i=this.CalcJumpInfo(t.x,t.y,e);if(i==null)return;this.layering[e]=i.layerToJumpTo;let n=this.nodeCount[e];this.vertsCounts[i.jumperLayer]-=n,this.vertsCounts[i.layerToJumpTo]+=n,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(i.jumperLayer,e)}IsJumper(e){return this.possibleJumperFeasibleIntervals.has(e)}UpdateRegionsForPossibleJumpersAndInsertJumpers(e,t){let i=new Set;for(let o of this.dag.pred(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));for(let o of this.dag.succ(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));let n=new Array;for(let o of this.possibleJumperFeasibleIntervals)i.has(o[0])||o[1].x>e&&o[1].y<e&&n.push(o[0]);for(let o of n)this.CalculateRegionAndInsertJumper(o)}InitJumpers(){let e=new Array(this.dag.nodeCount).fill(0);for(let t of this.dag.edges)e[t.source]-=t.weight,e[t.target]+=t.weight;this.possibleJumperFeasibleIntervals=new Map;for(let t=0;t<this.dag.nodeCount;t++)e[t]==0&&this.CalculateRegionAndInsertJumper(t)}CalculateRegionAndInsertJumper(e){let t=new ge(this.Up(e),this.Down(e));this.possibleJumperFeasibleIntervals.set(e,t),this.InsertJumper(t.x,t.y,e)}InsertJumper(e,t,i){this.CalcJumpInfo(e,t,i)!=null&&this.jumpers.add(i)}CalcJumpInfo(e,t,i){let n=this.layering[i],o=-1,a=this.vertsCounts[n]-2*this.nodeCount[i];for(let l=e-1;l>n;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);for(let l=n-1;l>t;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);if(o!=-1)return{jumperLayer:n,layerToJumpTo:o}}Up(e){let t=Number.MAX_SAFE_INTEGER;for(let i of this.dag.inEdges[e]){let n=this.layering[i.source]-i.separation+1;n<t&&(t=n)}return t==Number.MAX_SAFE_INTEGER&&(t=this.layering[e]+1),t}Down(e){let t=Number.NEGATIVE_INFINITY;for(let i of this.dag.outEdges[e]){let n=this.layering[i.target]+i.separation-1;n>t&&(t=n)}return t==Number.NEGATIVE_INFINITY&&(t=this.layering[e]-1),t}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let e of this.layering)this.vertsCounts[e]+=this.nodeCount[e]}ChooseJumper(){for(let e of this.jumpers)return e;throw new Error("there are no jumpers to choose")}};var Pn=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i of t.LayerEdges){let n=Math.max(i.Source,i.Target)+1;n>this.totalNumberOfNodes&&(this.totalNumberOfNodes=n)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i=1;i<t.LayerEdges.length;i++){let n=t.LayerEdges[i];this.firstVirtualNode=Math.min(this.firstVirtualNode,n.Source)}this.firstVirtualNode==Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let i of t.LayerEdges)i.Target!=t.target&&(this.virtualNodesToInEdges[i.Target-this.firstVirtualNode]=i),i.Source!=t.source&&(this.virtualNodesToOutEdges[i.Source-this.firstVirtualNode]=i)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield Pn.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield Pn.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new Pn(new Uo(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var jE=be(dh()),_s=class{constructor(e,t,i,n){this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}static InsertLayers(e,t,i,n){let o=new _s(e,t,i,n);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let i=0,n=t[0];if(i=n.LayerSpan*2,i>0){for(let o of n.LayerEdges)o.Target!=n.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(i-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let i=this.la.x[t],n=this.la.y[t],o=this.la.Layers[n];o[i]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges[n];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!=o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let i=this.NLayering[t];i%2==1&&(this.Nla.Layers[i][e[i]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!=e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!=e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,i=!0;for(let n of e)if(i&&(i=!1,t=n.LayerSpan*2),t>0){n.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=Jn.GetSource(a,n,o);this.totalNodes=a.currentVV;let u=Jn.GetTarget(this.totalNodes,n,o,t);n.LayerEdges[o]=new xi(l,u,n.CrossingWeight)}_s.RegisterDontStepOnVertex(this.database,n)}}this.nLayeredGraph=new Pn(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new jE.SortedMap,i=this.Nla.Layers[e];for(let o of i){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let n=0;for(let o of t.values())if(typeof o=="number")i[n++]=o;else for(let a of o)i[n++]=a;for(let o=0;o<i.length;o++)this.Nla.x[i[o]]=o}}InitNewLayering(){this.Nla=new vi(new Array(this.totalNodes));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i]*2;for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!=i.y&&this.la.y[i.x]!=this.la.y[i.y]){let o=this.la.y[i.x]*2;for(let a of n){let l=o-1;for(let u of a.LayerEdges)u.Target!=a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new vi(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let i=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(i.Source)}}};var Jn=class{constructor(e,t,i,n){this.virtNodesToIntEdges=new Map;this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}get NLayering(){return this.Nla.y}static InsertPaths(e,t,i,n){let o=new Jn(e,t,i,n);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(n);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!=o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}EdgeIsFlat(e){return this.la.y[e.source]==this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let i of t.LayerEdges)i.Target!=t.target&&this.virtNodesToIntEdges.set(i.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!=t.y){let n=!0,o=0;for(let a of i){if(n)n=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o==1)a.LayerEdges[0]=new xi(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=Jn.GetSource(u,a,l);e=u.currentVV;let h=Jn.GetTarget(e,a,l,o);a.LayerEdges[l]=new xi(c,h,a.CrossingWeight)}_s.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new Pn(this.intGraph)}static GetTarget(e,t,i,n){return i<n-1?e:t.target}static GetSource(e,t,i){return i==0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new vi(new Array(this.NLayeredGraph.NodeCount));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i];for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!=i.y&&this.la.y[i.x]!=this.la.y[i.y]){let o=0,a=!0;for(let l of n){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new vi(this.NLayering),this.Nla.Layers=e}};var qE=BigInt("6364136223846793005"),_b=(BigInt(1)<<BigInt(32))-BigInt(1),Ho=(BigInt(1)<<BigInt(64))-BigInt(1),fh=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&Ho,this._random_b(),this._state=this._state+BigInt(e)&Ho,this._random_b()}_random_b(){let e=this._state;this._state=e*qE+this._inc&Ho;let t=(e>>BigInt(18)^e)>>BigInt(27),i=e>>BigInt(59),n=i^BigInt(31);return(t>>i|t<<n)&_b}_advance(e){e&=Ho;let t=BigInt(1),i=qE,n=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*i&Ho,n=n*i+o&Ho),o=(i+BigInt(1))*o&Ho,i=i*i&Ho,e>>=BigInt(1);this._state=t*this._state+n&Ho}randint(e){if(e>_b)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),i=(_b^t)%t;for(;;){let n=this._random_b();if(n>=i)return Number(n%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var za;function Bs(s){return za==null&&(za=new fh(0,0)),za.randint(s)}function If(s){za=new fh(s,0)}function ph(){return za==null&&(za=new fh(0,0)),za.random()}var wf=class{constructor(e,t,i){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=i}LayerGroupDisbalance(e,t,i){return t==1?this.LayerGroupDisbalanceWithOrigSeparators(e,i):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentOrigGroupDelta(n,e,t);n=o.i,i+=o.ret}return i}CurrentOrigGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentVirtGroupDelta(n,e,t);i+=o.ret,n=o.i}return i}CurrentVirtGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings==0}};var QE=be(dh()),KE=be(qi());var Bb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Source]-this.x[t.Source];return i!=0?i:this.x[e.Target]-this.x[t.Target]}};var Nb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Target]-this.x[t.Target];return i!=0?i:this.x[e.Source]-this.x[t.Source]}};var Ct=class{constructor(e,t){cu(e,t)<0?(this.first=e,this.second=t):(this.first=t,this.second=e)}get First(){return this.first}get Second(){return this.second}get Length(){return ke(this.first,this.second)}CompareTo(e){let t=cu(this.first,e.first);return t!=0?t:cu(this.second,e.second)}static equal(e,t){return e.first.equal(t.first)&&e.second.equal(t.second)}toString(){return this.first+(" "+this.second)}};var Je=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new Je;for(let i of e)t.add(i);return t}addxy(e,t){let i=this.mapOfSets.get(e);i==null&&this.mapOfSets.set(e,i=new Set),i.has(t)||this.size_++,i.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let i=this.mapOfSets.get(e);return i!=null&&i.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let i of this)e(i,i,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new p(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function Wo(s,e){let t=new Set;for(let i of s)e.has(i)||t.add(i);return t}function XE(s,e){let t=new Je;for(let i of s)e.has(i)||t.add(i);return t}function yn(s,e){let t=new Set(s);for(let i of e)t.add(i);return t}function eo(s,e){for(let t of e)s.push(t)}function Sn(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}function YE(s){if(s.length==0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=Sn(e,s[t]);return e}function Iu(s,e){for(let t of e)s.add(t)}function Ha(s,e){if(s.size!=e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function to(s,e){let t=[];for(let i of s)for(let n of e(i))t.push(n);return t}function Wa(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function ja(s,e,t){let i=s.get(e);i||(i=new Array,s.set(e,i)),i.push(t)}function Db(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function $E(s,e,t){Db(s,new Ct(e[0],e[1]),t)}function $O(s,e,t){let i=s.get(e);i&&i.delete(t)}function Fb(s,e,t){$O(s,new Ct(e[0],e[1]),t)}function Lf(){return Bs(2)==0}function ZO(s,e,t){let i=t.Layers[s+1],n=t.Layers[s];return n.length<=i.length?KO(n,e,t):QO(i,n,e,t)}function QO(s,e,t,i){let n=JE(e,t),o=new Nb(i.x);n.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of n){let h=a+i.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!=0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function KO(s,e,t){let i=JE(s,e),n=new Bb(t.x);i.sort((u,c)=>n.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of i){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!=0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function JE(s,e){return to(s,t=>Array.from(e.InEdges(t)))}function ZE(s,e){let t=0;for(let i=0;i<e.Layers.length-1;i++)t+=ZO(i,s,e);return t}var Ns=class extends Ee{constructor(e,t,i,n,o,a,l){super(l);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=l,this.tryReverse=t,this.startOfVirtNodes=n,this.layerArrays=i,this.layering=i.y,this.nOfLayers=i.Layers.length,this.layers=i.Layers,this.properLayeredGraph=e,this.hasCrossWeights=o,this.SugSettings=a}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return Bs(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(e,t,i,n,o){let a=!1;for(let u of e.Edges)if(u.CrossingWeight!=1){a=!0;break}new Ns(e,!0,t,i,a,n,o).run()}run(){if(this.Calculate(),this.tryReverse){let e=this.layerArrays.ReversedClone(),t=new Ns(this.properLayeredGraph.ReversedClone(),!1,e,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(t.run(),t.measure<this.measure){for(let i=0;i<this.nOfLayers;i++)lh(e.Layers[i],this.layerArrays.Layers[this.nOfLayers-1-i]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=Ns.CloneLayers(this.layers,this.layerArraysCopy);let e=0;this.measure=new wf(this.layerArraysCopy,ZE(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let t=0;t<this.MaxOfIterations&&e<this.NoGainStepsBound&&!this.measure.IsPerfect();t++){let i=t%2==0;this.LayerByLayerSweep(i),this.AdjacentExchange();let n=new wf(this.layerArrays.Layers,ZE(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);this.measure<n?(this.Restore(),e++):(n<this.measure||Lf())&&(e=0,this.layerArraysCopy=Ns.CloneLayers(this.layers,this.layerArraysCopy),this.measure=n)}}static CloneLayers(e,t){if(t==null){t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i].map(n=>n)}else for(let i=0;i<e.length;i++)lh(e[i],t[i]);return t}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(e){if(e)for(let t=1;t<this.nOfLayers;t++)this.SweepLayer(t,!0);else for(let t=this.nOfLayers-2;t>=0;t--)this.SweepLayer(t,!1)}SweepLayer(e,t){let i=this.layers[e],n=new Array(i.length);for(let a=0;a<n.length;a++)n[a]=this.WMedian(i[a],t);this.Sort(e,n);let o=this.layerArrays.Layers[e];for(let a=0;a<o.length;a++)this.layerArrays.x[o[a]]=a}Sort(e,t){let i=new QE.SortedMap,n=this.layers[e],o=0;for(let l of t){let u=n[o++];if(l!=-1)if(!i.has(l))i.set(l,u);else{let c=i.get(l);if(typeof c!="number"){let h=c;if(Lf())h.push(u);else{let d=Bs(h.length),f=h[d];h[d]=u,h.push(f)}}else{let h=c,d=new Array;i.set(l,d),Lf()?(d.push(h),d.push(u)):(d.push(u),d.push(h))}}}let a=i.values();for(o=0;o<n.length;)if(t[o]!=-1){let l=a.next().value;if(typeof l=="number")n[o++]=l;else{let u=l;for(let c of u){for(;t[o]==-1;)o++;n[o++]=c}}}else o++}WMedian(e,t){let i,n;if(t?(i=this.properLayeredGraph.OutEdges(e),n=this.properLayeredGraph.OutEdgesCount(e)):(i=this.properLayeredGraph.InEdges(e),n=this.properLayeredGraph.InEdgesCount(e)),n==0)return-1;let o=new Array(n),a=0;if(t)for(let h of i)o[a++]=this.X[h.Target];else for(let h of i)o[a++]=this.X[h.Source];o.sort((h,d)=>h-d);let l=Math.floor(n/2);if(n%2==1)return o[l];if(n==2)return .5*(o[0]+o[1]);let u=o[l-1]-o[0],c=o[n-1]-o[l];return Math.floor((o[l-1]*u+o[l]*c)/(u+c))}Init(){let e=new Array(this.nOfLayers).fill(0),t=new KE.Stack;for(let n=0;n<this.properLayeredGraph.NodeCount;n++)this.properLayeredGraph.InEdgesCount(n)==0&&t.push(n);let i=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;t.size>0;){let n=t.pop(),o=this.layerArrays.y[n];this.layerArrays.Layers[o][e[o]]=n,this.layerArrays.x[n]=e[o],e[o]++;for(let a of this.properLayeredGraph.Succ(n))i[a]||(i[a]=!0,t.push(a))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let e=0,t=!0;for(;t&&e++<this.MaxNumberOfAdjacentExchanges;){t=!1;for(let i=0;i<this.layers.length;i++)t=this.AdjExchangeLayer(i)||t;for(let i=this.layers.length-2;i>=0;i--)t=this.AdjExchangeLayer(i)||t}}AllocArrays(){let e=this.properLayeredGraph.NodeCount;this.predecessors=new Array(e),this.successors=new Array(e),this.pOrder=new Array(e),this.sOrder=new Array(e),this.hasCrossWeights&&(this.outCrossingCount=new Array(e),this.inCrossingCount=new Array(e));for(let t=0;t<e;t++){let i=this.properLayeredGraph.InEdgesCount(t);if(this.predecessors[t]=new Array(i),this.hasCrossWeights){let n=this.inCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.InEdges(t))n.set(o.Source,o.CrossingWeight)}if(this.pOrder[t]=new Map,i=this.properLayeredGraph.OutEdgesCount(t),this.successors[t]=new Array(i),this.sOrder[t]=new Map,this.hasCrossWeights){let n=this.outCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.OutEdges(t))n.set(o.Target,o.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let e=0;e<this.properLayeredGraph.NodeCount;e++)this.pOrder[e]=new Map,this.sOrder[e]=new Map;for(let e of this.layers)this.InitPsArraysForLayer(e)}CalcPair(e,t){let i=this.successors[e],n=this.successors[t],o=this.predecessors[e],a=this.predecessors[t];if(this.hasCrossWeights){let l=this.outCrossingCount[e],u=this.outCrossingCount[t],c=this.inCrossingCount[e],h=this.inCrossingCount[t];return{cuv:this.CountOnArraysUV(i,n,l,u)+this.CountOnArraysUV(o,a,c,h),cvu:this.CountOnArraysUV(n,i,u,l)+this.CountOnArraysUV(a,o,h,c)}}else return{cuv:this.CountOnArrays(i,n)+this.CountOnArrays(o,a),cvu:this.CountOnArrays(n,i)+this.CountOnArrays(a,o)}}InitPsArraysForLayer(e){for(let t of e){for(let i of this.properLayeredGraph.Pred(t)){let n=this.sOrder[i],o=n.size;this.successors[i][o]=t,n.set(t,o)}for(let i of this.properLayeredGraph.Succ(t)){let n=this.pOrder[i],o=n.size;this.predecessors[i][o]=t,n.set(t,o)}}}CountOnArrays(e,t){let i=0,n=t.length-1,o=-1,a=0;for(let l of e){let u=this.X[l];for(;o<n&&this.X[t[o+1]]<u;o++)a++;i+=a}return i}CountOnArraysUV(e,t,i,n){let o=0,a=t.length-1,l=-1,u=0;for(let c of e){let h=this.X[c],d;for(;l<a&&this.X[d=t[l+1]]<h;l++)u+=n.get(d);o+=u*i.get(c)}return o}AdjExchangeLayer(e){let t=this.layers[e];return this.ExchangeWithGainWithNoDisturbance(t)?!0:(this.DisturbLayer(t),this.ExchangeWithGainWithNoDisturbance(t))}Swap(e,t){let i=this.X[e],n=this.X[t],o=this.layering[e],a=this.layers[o];a[i]=t,a[n]=e,this.X[e]=n,this.X[t]=i,this.UpdateSsContainingUv(e,t),this.UpdatePsContainingUv(e,t)}UpdatePsContainingUv(e,t){if(this.successors[e].length<=this.successors[t].length)for(let i of this.successors[e]){let n=this.pOrder[i];if(n.has(t)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.successors[t]){let n=this.pOrder[i];if(n.has(e)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}UpdateSsContainingUv(e,t){if(this.predecessors[e].length<=this.predecessors[t].length)for(let i of this.predecessors[e]){let n=this.sOrder[i];if(n.has(t)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.predecessors[t]){let n=this.sOrder[i];if(n.has(e)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}DisturbLayer(e){for(let t=0;t<e.length-1;t++)this.AdjacentSwapToTheRight(e,t)}ExchangeWithGainWithNoDisturbance(e){let t=!1,i;do i=this.ExchangeWithGain(e),t=t||i;while(i);return t}ExchangeWithGain(e){for(let t=0;t<e.length-1;t++)if(this.SwapWithGain(e[t],e[t+1]))return this.SwapToTheLeft(e,t),this.SwapToTheRight(e,t+1),!0;return!1}SwapToTheLeft(e,t){for(let i=t-1;i>=0;i--)this.AdjacentSwapToTheRight(e,i)}SwapToTheRight(e,t){for(let i=t;i<e.length-1;i++)this.AdjacentSwapToTheRight(e,i)}AdjacentSwapToTheRight(e,t){let i=e[t],n=e[t+1],o=this.SwapGain(i,n);(o>0||o==0&&Lf())&&this.Swap(i,n)}SwapGain(e,t){let i=this.CalcPair(e,t);return i.cuv-i.cvu}UvAreOfSameKind(e,t){return e<this.startOfVirtNodes&&t<this.startOfVirtNodes||e>=this.startOfVirtNodes&&t>=this.startOfVirtNodes}NeighborsForbidTheSwap(e,t){return this.UpperNeighborsForbidTheSwap(e,t)||this.LowerNeighborsForbidTheSwap(e,t)}LowerNeighborsForbidTheSwap(e,t){let i,n;return(i=this.properLayeredGraph.OutEdgesCount(e))==0||(n=this.properLayeredGraph.OutEdgesCount(t))==0?!1:this.X[this.successors[e][i>>1]]<this.X[this.successors[t][n>>1]]}UpperNeighborsForbidTheSwap(e,t){let i=this.properLayeredGraph.InEdgesCount(e),n=this.properLayeredGraph.InEdgesCount(t);return i==0||n==0?!1:this.X[this.predecessors[e][i>>1]]<this.X[this.predecessors[t][n>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(e,t,i){let n=this.GetKindDelegate(i),o=0;for(let l=t-1;l>=0&&!n(e[l]);l--)o++;let a=0;for(let l=t+1;l<e.length&&!n(e[l]);l++)a++;return o-a}IsOriginal(e){return e<this.startOfVirtNodes}IsVirtual(e){return e>=this.startOfVirtNodes}GetKindDelegate(e){return this.IsVirtual(e)?this.IsVirtual:this.IsOriginal}SwapWithGain(e,t){return this.SwapGain(e,t)>0?(this.Swap(e,t),!0):!1}};var dt=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,i){let n=this.mapOfMaps.get(e);n==null&&this.mapOfMaps.set(e,n=new Map),n.has(t)||this.size_++,n.set(t,i)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let i=this.mapOfMaps.get(e);return i!=null?(i.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let i=this.mapOfMaps.get(e);return i!=null&&i.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let i=this.mapOfMaps.get(e);if(i!=null)return i.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new p(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new p(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var wu=class{constructor(e,t,i){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=i}static UpdateLayerArrays0(e,t,i){new wu(e,t,i).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let i=wu.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,i)}static BuildInitialNodePositions(e,t){let i=new Map;for(let n=0;n<t.Layers.length;n++){let o=0,a=0;for(;o<t.Layers[n].length;){for(;o<t.Layers[n].length&&e.IsVirtualNode(t.Layers[n][o]);)o++;for(let l=a;l<o;l++)i.set(t.Layers[n][l],new p(n,a));o<t.Layers[n].length&&i.set(t.Layers[n][o],new p(n,o)),o++,a=o}}return i}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new dt;for(let t of this.layerArrays.Layers)for(let i of t){let n=this.nodePositions.get(i);e.hasxy(n.x,n.y)||e.setxy(n.x,n.y,[]),e.getxy(n.x,n.y).push(i)}return e}BuildOrdering(e){let t=new dt,i=new Map;for(let n of this.layerArrays.Layers)for(let o of n){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),i),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let i=0;i<e.length;i++)t.set(e[i],i)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,i)=>{let n=this.firstSucc(t),o=this.firstSucc(i),a=this.firstPred(t),l=this.firstPred(i),u=this.nodePositions.get(n),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(n)){if(!h.equal(d))return h.compareTo(d);let f=e.get(n),P=e.get(o);return Ae(f,P)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?Ae(t,i):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let i=0,n=0;for(;i<t.length;){for(;i<t.length&&this.nodePositions.get(t[n]).equal(this.nodePositions.get(t[i]));)i++;let o=e.get(this.nodePositions.get(t[n]));for(let a=n;a<i;a++)t[a]=o[a-n];n=i}}this.layerArrays.UpdateXFromLayers()}};var tx=be(zt());var ex=be(qi());var qa=class{static getOrder(e,t){let i=Lr(t.map(([n,o])=>new ge(n,o)),e);return qa.getOrderOnGraph(i)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),i=new ex.Stack,n=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,i.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(n.push(l),i.length>0){let c=i.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return n.reverse()}};var Gb=class{GetLayers(){let e=qa.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),i=this.graph.nodeCount;for(;i-- >0;){let n=e[i];for(let o of this.graph.inEdges[n]){let a=o.source,l=t[n]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(JO(t,e))return!1;return!0}constructor(e){this.graph=e}};function JO(s,e){let t=e.findIndex(n=>n==s.source),i=e.findIndex(n=>n==s.target);return t==-1||i==-1||t>=i}var Vb=class{constructor(e){this.inTree=!1;this.cut=Vb.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},ui=Vb;ui.infinity=Number.MAX_SAFE_INTEGER;var Ds=be(qi());function e2(s){let e=new Array;for(let t of s.edges)e.push(new ui(t));return Lr(e,s.nodeCount)}var Of=class{constructor(e,t,i,n,o){this.v=e,this.outEnum=t,this.i=i,this.inEnum=n,this.j=o}},gh=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=e2(e),this.networkCancelToken=t;for(let i=0;i<this.graph.nodeCount;i++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let i of this.treeVertices)this.layers[i]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let i=t.source,n=t.target;return this.lim(i)>this.lim(n)?this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?0:1:this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut==ui.infinity&&t!=this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new Ds.Stack;for(let i of this.leaves)e.push(i);let t=new Ds.Stack;for(;e.length>0;){for(;e.length>0;){let n=e.pop(),o=this.parent(n);if(o==null)continue;let a=0;for(let u of this.incidentEdges(n))if(u.inTree==!1){let c=this.edgeSourceTargetVal(u,o);c!=0&&(a+=c*u.weight)}else if(u==o)a+=u.weight;else{let c=o.source==u.target||o.target==u.source?1:-1;a+=this.edgeContribution(u,n)*c}o.cut=a;let l=o.source==n?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let i=e;e=t,t=i}}edgeContribution(e,t){let i=e.cut-e.weight;for(let n of this.incidentEdges(t))if(n.inTree==!1){let o=this.edgeSourceTargetVal(n,e);o==-1?i+=n.weight:o==1&&(i-=n.weight)}return i}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let i=new Ds.Stack,n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(i.push(new Of(t,n,o,a,l)),this.vertices[t].low=e;i.length>0;){let u=i.pop();t=u.v,n=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<n.length;){let h=n[o];!h.inTree||this.vertices[h.target].low>0||(i.push(new Of(t,n,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){i.push(new Of(t,n,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)==this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,i=this.vertices[e].lim;this.leaves=[];for(let n=0;n<this.nodeCount;n++)t<=this.vertices[n].lim&&this.vertices[n].lim<=i?this.setLow(n,0):this.low(n)==this.lim(n)&&this.leaves.push(n);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=ui.infinity;for(let i of this.treeVertices){for(let n of this.graph.outEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o==1))return n}for(let n of this.graph.inEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o==1))return n}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new Ds.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let i of this.graph.outEdges[t])this.vertexInTree(i.target)||this.layers[i.source]-this.layers[i.target]==i.separation&&(e.push(i.target),this.addVertexToTree(i.target),this.treeVertices.push(i.target),i.inTree=!0);for(let i of this.graph.inEdges[t])this.vertexInTree(i.source)||this.layers[i.source]-this.layers[i.target]==i.separation&&(e.push(i.source),this.addVertexToTree(i.source),this.treeVertices.push(i.source),i.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,i=0;for(let a of this.graph.edges)a.inTree&&a.cut<i&&(i=a.cut,e=a);if(e==null)return null;let n=!1,o=ui.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree==!1&&this.edgeSourceTargetVal(a,e)==-1&&(l<o||l==o&&(n=Bs(2)==1))){if(o=l,t=a,o==0&&!n)break;n=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let i=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,i),this.updateLimLowLeavesAndParentsUnderNode(i),this.updateCuts(e),this.updateLayersUnderNode(i)}updateLayersUnderNode(e){let t=new Ds.Stack;t.push(e);for(let i=0;i<this.nodeCount;i++)this.low(e)<=this.lim(i)&&this.lim(i)<=this.lim(e)&&i!=e&&(this.layers[i]=ui.infinity);for(;t.length>0;){let i=t.pop();for(let n of this.graph.outEdges[i])n.inTree&&this.layers[n.target]==ui.infinity&&(this.layers[n.target]=this.layers[i]-n.separation,t.push(n.target));for(let n of this.graph.inEdges[i])n.inTree&&this.layers[n.source]==ui.infinity&&(this.layers[n.source]=this.layers[i]+n.separation,t.push(n.source))}}updateCuts(e){let t=new Ds.Stack,i=new Ds.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!=ui.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree==!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c==a)l+=c.weight;else{let h=a.source==c.target||a.target==c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source==o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&i.push(u)}let n=t;t=i,i=n}}createPathForCutUpdates(e,t,i){let n=t.target;for(;n!=i;){let o=this.parent(n);o.cut=ui.infinity,n=o.source==n?o.target:o.source}t.cut=ui.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,i;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),i=this.lim(e.target)):(t=this.lim(e.target),i=this.lim(e.source));let n=e.source;for(;!(this.low(n)<=t&&i<=this.lim(n));){let o=this.parent(n);o.cut=ui.infinity,n=o.source==n?o.target:o.source}return n}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let i of this.graph.edges)t+=this.edgeSourceTargetVal(i,e)*i.weight;e.cut!=t&&console.log(tx.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new Gb(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length==0&&this.graph.nodeCount==0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var kb=class{GetLayers(){return new gh(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let i of e){let n=i[0],o=i[1];for(let a of this.graph.outEdges[n]){let l=new Or(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new Uo(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var Yr=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new p(this.left,this.top)}get leftBottom(){return new p(this.left,this.bottom)}get rightBottom(){return new p(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new p(this.right,this.top)}static mkAnchor(e,t,i,n,o,a){let l=new Yr(a);return l.la=e,l.ra=t,l.ta=i,l.ba=n,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new p(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=Yr.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t==0?e:Yr.curveIsConvex(e)?Yr.padConvexCurve(e,t):Yr.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,i,n,o){let a=Yr.getPaddedCorner(t,i,n,o);e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b)}static padConvexCurve(e,t){let i=new te;Yr.padCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t),Yr.padCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t);for(let n=e.startPoint;n.next.next!=null;n=n.next)Yr.padCorner(i,n,n.next,n.next.next,t);return i.closed=!0,i}static getPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point,u=p.getTriangleOrientation(o,a,l)==1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<C.intersectionEpsilon)return{a:a.add(h.mul(n)),b:null,numberOfPoints:1};let f=d.normalize().mul(n),P=f.rotate(Math.PI/2),E=(n-f.dot(h))/P.dot(h);return{a:f.add(P.mul(E)).add(a),b:f.sub(P.mul(E)).add(a),numberOfPoints:2}}static*orientations(e){yield p.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield p.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield p.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let i of Yr.orientations(e))if(i!=2){if(t==2)t=i;else if(i!=t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():w.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new te;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return te.mkClosedFromPoints([new p(e,this.top),this.rightTop,this.rightBottom,new p(e,this.bottom),new p(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return te.mkClosedFromPoints([new p(e,this.top),new p(this.right,this.y),new p(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var Lu=class{constructor(e,t,i,n,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=i,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new mr,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=n,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,i,n,o){new Lu(e,t,i,n,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.InEdges(e))i[t++]=o.Source;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2==t?this.upperMedians[e]=new ge(i[n-1],i[n]):this.upperMedians[e]=i[n]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.OutEdges(e))i[t++]=o.Target;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2==t?this.lowMedians[e]=new ge(i[n-1],i[n]):this.lowMedians[e]=i[n]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),i=new Array(4),n=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,i[a]=l.b;let u=i[a]-t[a];u<n&&(e=a,n=u)}for(let a=0;a<4;a++){let l;if(Lu.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=i[e]-i[a],this.x=this.xCoords[a],l!=0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e==0||e==2}AssignmentBounds(e,t){if(this.nOfVertices==0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let i=1;i<this.nOfVertices;i++){let n=this.x[i];n<t.a?t.a=n:n>t.b&&(t.b=n)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let n=t;this.LR?(yield n.x,yield n.y):(yield n.y,yield n.x)}else{let n=t;n>=0&&(yield n)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,i=this.UpperOf(0,this.h-1),n=this.NextLower(i);for(;this.IsBelow(e,i);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,n)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],i=null,n=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(n,o)&&i==null;n=this.NextRight(n))i=this.InnerEdgeByTarget(t[n]);if(i!=null){let a=this.Pos(this.Source(i));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,n);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(i));for(;this.IsNotRightFrom(n,o);){let u=this.AlignmentToTheRightOfInner(t,n,a);if(n=this.NextRight(n),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,i,u,l,c),i=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(i)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(i)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,i,n,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(i)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,n)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,i){if(this.NumberOfInEdges(e[t])==1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(i,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let n=0;n<this.nOfVertices;n++)if(n==this.root[n]){let o=n;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Or(n,this.root[a.neighbor],null)),o=this.align[o]}while(o!=n)}let t=Lr(e,this.nOfVertices),i=qa.getOrderOnGraph(t);for(let n of i)if(n==this.root[n]){let o=0,a=!0,l=n;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!=n);this.x[n]=o}for(let n of i)if(n==this.root[n]&&t.inEdges[n].length==0){let o=n,a=this.RightMost(-Lu.infinity,Lu.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!=n);l!=a&&(this.x[n]=a)}for(let n=0;n<this.nOfVertices;n++)n!=this.root[n]&&(this.x[n]=this.x[this.root[n]])}TryToGetRightNeighbor(e,t){let i=this.NextRight(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}TryToGetLeftNeighbor(e,t){let i=this.NextLeft(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let i=this.la.Layers[t],n=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,i.length-1);for(let a=this.LeftMost(0,i.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=i[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(n,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],n=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let i;if(this.Pos(e)>this.Pos(t)){let n=e;e=t,t=n,i=-1}else i=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*i}},Rf=Lu;Rf.infinity=1e7;var Ub=class extends ar{constructor(e,t,i,n,o){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(n,o),this.virtualVerticesStart=e.nodeCount,this.virtualVerticesEnd=t.NodeCount-1,this.layeredGraph=t,this.layerArrays=i}EdgeWeightMultiplier(e){let t=e.source,i=e.target;if(t<this.layeredGraph.NodeCount&&this.layerArrays.y[t]==this.layerArrays.y[i]&&this.layerArrays.x[t]==this.layerArrays.x[i]+1)return 0;let n=0,o=-1,a=-1;for(let u of this.outEdges[t])a==-1?a=u.target:o=u.target;return a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&n++,o>=this.virtualVerticesStart&&o<=this.virtualVerticesEnd&&n++,n==0?this.weightMultiplierOfOriginalOriginal:n==1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let e of this.edges)e.weight=e.weight*this.EdgeWeightMultiplier(e)}};var Fs=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new Fs(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length==0)return null;if(e.length==1)return e[0];let t=e[0].parallelogram,i=1,n=Le.parallelogramOfTwo(t,e[i].parallelogram).area;for(let h=2;h<e.length;h++){let d=Le.parallelogramOfTwo(t,e[h].parallelogram).area;d>n&&(i=h,n=d)}let o;for(let h=0;h<e.length;h++)if(h!=i){o=h;break}n=Le.parallelogramOfTwo(e[i].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h==i)continue;let d=Le.parallelogramOfTwo(e[i].parallelogram,e[h].parallelogram).area;d>n&&(o=h,n=d)}let a=new Array,l=new Array;a.push(e[i]),l.push(e[o]);let u=e[i].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h==i||h==o)continue;let d=Le.parallelogramOfTwo(u,e[h].parallelogram),f=d.area-u.area,P=Le.parallelogramOfTwo(c,e[h].parallelogram),E=P.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=P):f<E?(a.push(e[h]),u=d):(l.push(e[h]),c=P)}return{parallelogram:Le.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var Xa=class{static mkDebugCurveTWCILD(e,t,i,n,o,a,l=!1){let u=new Xa;return u.transparency=e,u.width=t,u.color=i,u.icurve=n,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,i,n){return Xa.mkDebugCurveTWCILD(e,t,i,n,null,null)}static mkDebugCurveWCI(e,t,i){return Xa.mkDebugCurveTWCI(255,e,t,i)}static mkDebugCurveCI(e,t){return Xa.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return Xa.mkDebugCurveCI("Black",e)}},fe=Xa;fe.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var $r=class{constructor(e,t,i,n,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=i,this.bottomSite=i.next,this.currentTopSite=i,this.currentBottomSite=i.next,this.layerArrays=n,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,i,n,o,a,l,u){new $r(e,t,i,o,a,l,n,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,i){if(e.equal(t))return t;let n=p.ClosestPointAtLineSegment(t,e,i),o=t.sub(n),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return Bs(2)==0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=$r.absCotan(e),i,n=!1;for(let o of this.bottomCorners()){let a=$r.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,i=o,n=!0)}return n?ae(t,$r.absCotan(e))?!1:(this.currentBottomSite=tt.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=$r.absCotan(e),i,n=!1;for(let o of this.topCorners()){let a=$r.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,i=o,n=!0)}return n?ae(t,$r.absCotan(e))?!1:(this.currentTopSite=tt.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&$r.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&$r.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&$r.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&$r.PossibleCorner(t,i,o)&&(yield o)}static PossibleCorner(e,t,i){return i.x>e&&i.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,i,n,o){let a=0,l=0;i==2&&(a=Number.MAX_VALUE),i==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>n&&(d.topAnchor>l+C.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+C.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,i,n,o){let a=0,l=0;i==2&&(a=Number.MAX_VALUE),i==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=n)break;d.left<o&&(d.topAnchor>l+C.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+C.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var lr=class{constructor(e,t,i,n,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=i,this.settings=n,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinEastHierarchy=Fs.Calculate(this.thinRightNodes),Fs.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinWestHierarchy=Fs.Calculate(this.thinWestNodes),Fs.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let i of this.edgePath){let n=null;for(let o of this.EastBoundaryNodesOfANode(i,En.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(n==null||n.origin.x>a.origin.x)&&(n=a),e.push(a.polygonalBoundary)}n!=null&&this.thinRightNodes.push(B.mkLinePXY(n.origin,this.originalGraph.right,n.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let i of this.edgePath.nodes()){let n=-1;for(let o of this.LeftBoundaryNodesOfANode(i,En.GetNodeKind(t,this.edgePath)))(n==-1||this.layerArrays.x[o]>this.layerArrays.x[n])&&(n=o),e.push(this.anchors[o].polygonalBoundary);if(n!=-1){let o=this.anchors[n];this.thinWestNodes.push(B.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,i){let n=0,o=0;i==2?n=Number.MAX_VALUE:i==0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>n&&(n=c.bottomAnchor),yield u):c.bottomAnchor>n&&(this.NodeUCanBeCrossedByNodeV(u,a)||(n=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,i){let n=0,o=0;i==0?o=Number.MAX_VALUE:i==2&&(n=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+C.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,n=Math.max(n,c.bottomAnchor),yield u):c.bottomAnchor>n+C.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),n=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)==this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let i=this.OutcomingEdge(e),n=this.OutcomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Target,t=n.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}IntersectAbove(e,t){do{let i=this.IncomingEdge(e),n=this.IncomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Source,t=n.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}Intersect(e,t){let i=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],n=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return i>0&&n<0||i<0&&n>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new mt(this.headSite)}LineSegIntersectBound(e,t){let i=B.mkPP(e,t);return lr.CurveIntersectsHierarchy(i,this.westHierarchy)||lr.CurveIntersectsHierarchy(i,this.thinWestHierarchy)||lr.CurveIntersectsHierarchy(i,this.eastHierarchy)||lr.CurveIntersectsHierarchy(i,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return lr.SegIntersectsBound(e,t,this.westHierarchy)||lr.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return lr.SegIntersectsBound(e,t,this.eastHierarchy)||lr.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn==1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn==0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,i){return lr.CurveIntersectsHierarchy(B.mkPP(e.point,t.point),i)}static CurveIntersectsHierarchy(e,t){if(t==null||!Le.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let i=t.node;return lr.CurveIntersectsHierarchy(e,i.children[0])||lr.CurveIntersectsHierarchy(e,i.children[1])}return w.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return p.getTriangleOrientation(e.prev.point,e.point,e.next.point)==2}Reverse(){let e=new lr(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,i=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=i,i!=null&&(i.prev=e.headSite),i=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,i;for(let n=0;n<this.edgePath.count;n++)i=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(n),this.EdgePathNode(n+1)),t=i;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,i){$r.Refine(t,i,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=tt.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=tt.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),i=this.anchors[e],n=this.anchors[t];if(ae(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindLegalPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new p(o.ax,i.y);let c=this.headSite.next,h=c.point.y;c.point=new p(this.MiddlePos(o.ax,o.bx,i,n,h),h),c.next.point=new p(o.bx,n.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),i=this.anchors[e],n=this.anchors[t];if(ae(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new p(o.ax,i.y),this.headSite.next.point=new p(o.bx,n.y)}FindLegalPositions(e,t,i){return this.FindPositions(e,t,i)?this.PositionsAreLegal(i.ax,i.bx,i.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,i){let n,o;if(i.ax<i.bx?(i.sign=1,o=Math.max(i.ax,t.left),n=Math.min(e.right,i.bx)):(i.sign=-1,o=Math.max(e.left,i.bx),n=Math.min(t.right,i.ax)),o<=n)i.bx=.5*(o+n),i.ax=.5*(o+n);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;i.sign==1?(i.ax=e.right-.1*e.rightAnchor,i.bx=t.left):(i.ax=e.left+.1*e.leftAnchor,i.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let i=B.mkPP(e.origin,t.origin);return e.x<t.x&&w.CurvesIntersect(i,B.mkPP(e.rightBottom,e.rightTop))||w.CurvesIntersect(i,B.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&w.CurvesIntersect(i,B.mkPP(e.leftBottom,e.leftTop))||w.CurvesIntersect(i,B.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count==2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count==1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,i,n,o,a){if(!ae(e,t)&&(e-t)*i>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,n,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new p(e,n.bottom),new p(t,o.top)):!1}MiddleAnchorLegal(e,t,i){let n=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-i.x;return!(o>0&&this.anchors[n[o-1]].right>a+i.left||o<n.length-1&&this.anchors[n[o+1]].left<a+i.right)}MiddlePos(e,t,i,n,o){let a=i.y-o,l=o-n.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let i=t.turn;if(e==0)i>0?e=1:i<0&&(e=-1);else if(e*i<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e==this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new w,t=this.headSite,i=w.findCorner(t);return i!=null?(this.createFilletCurve(e,{a:t,b:i.b,c:i.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(B.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)lr.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!p.closeDistEps(t,e.start)){let i=new w;i.addSegs([B.mkPP(t,e.start),e]),e=i}return t=this.TailSite.point,p.closeDistEps(t,e.end)||e.addSegment(B.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,i,n){let o=.5,a;do a=w.createBezierSeg(o,o,e,t,i),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=w.createBezierSeg(o,o,e,t,i);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}n.segs.length>0&&!p.closeDistEps(n.end,a.start)&&n.addSegment(B.mkPP(n.end,a.start)),n.addSegment(a)}BezierSegIntersectsBoundary(e){return p.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(Le.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let i=t.node;return this.BezierSegIntersectsTree(e,i.children[0])||this.BezierSegIntersectsTree(e,i.children[1])}else return lr.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let i of w.getAllIntersections(e,t,!1))if(t instanceof w){let n=t;if(w.realCutWithClosedCurve(i,n,!1))return!0}else return!0;return!1}};var zb=be(vs()),ro=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new ro(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new zb.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Children)e.enqueue(i)}}*Ancestors(){let e=new zb.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Parents)e.enqueue(i)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}};var Ya=class{};var Ci=class extends Ya{constructor(e,t){super();this.curve=this.curve,this.location=t.clone()}get Location(){return this.location}set Location(e){this.location=e}Translate(e){this.location=this.location.add(e)}get Curve(){return this.curve}set Curve(e){this.curve=e}};var Ai=class extends Ci{static mk(e,t){return new Ai(e,t,new p(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(e){this.centerDelegate=e}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(e){this.curveDelegate=e}get LocationOffset(){return this.locationOffset}set LocationOffset(e){this.locationOffset=e}constructor(e,t,i){super(null,t().add(i));this.LocationOffset=i,this.CurveDelegate=e,this.CenterDelegate=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var mh=class{constructor(e,t,i,n,o){this.color=e,t!==void 0&&(this.item=t),i!==void 0&&(this.parent=i),n!==void 0&&(this.left=n),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var bt=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new mh(1)}clear(){this.root=this.nil=new mh(1)}toNull(e){return e!=this.nil?e:null}isEmpty(){return this.root==this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let i;for(;t!=this.nil&&(i=this.comparer(e,t.item))!=0;)t=i<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t==this.nil)return null;let i=null;for(;t!=this.nil;)t=e(t.item)?(i=t).left:t.right;return i}findLast(e,t=this.root){if(t==this.nil)return null;let i=null;for(;t!=this.nil;)t=e(t.item)?(i=t).right:t.left;return i}treeMinimum(e=this.root){for(;e.left!=this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!=this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!=this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!=this.nil&&e==t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!=this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!=this.nil&&e==t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!=this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!=this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!=this.root&&e.color==1;)if(e==e.parent.left){let t=e.parent.right;t.color==0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color==1&&t.right.color==1?(t.color=0,e=e.parent):(t.right.color==1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color==0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color==1&&t.left.color==1?(t.color=0,e=e.parent):(t.left.color==1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left==this.nil||e.right==this.nil)t=e;else for(t=e.right;t.left!=this.nil;)t=t.left;let i=t.left!=this.nil?t.left:t.right;return i.parent=t.parent,t.parent==this.nil?this.root=i:t==t.parent.left?t.parent.left=i:t.parent.right=i,t!=e&&(e.item=t.item),t.color==1&&this.deleteFixup(i),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,i=this.root,n=0;for(;i!=this.nil;)t=i,n=this.comparer(e,i.item),i=n<0?i.left:i.right;let o=new mh(1,e,t,this.nil,this.nil);return t==this.nil?this.root=o:n<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!=this.root&&e.parent.color==0;)if(e.parent==e.parent.parent.left){let t=e.parent.parent.right;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let i of this.allNodes())e+=i.toString(),t!=this.count-1&&(e+=`
`),t++;return e+"}"}};var $a=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let i=t>>1,n,o;for(;t>1&&this.Less(n=this.A[t],o=this.A[i]);)this.A[i]=n,this.A[t]=o,t=i,i=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,i=2,n=!1;for(;i<this.heapSize&&!n;){n=!0;let o=this.A[i],a=this.A[i+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e,n=!1,t=i,i=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[i+1]=e,n=!1,t=i+1,i=t<<1)}if(i==this.heapSize){let o=this.A[i];this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Qt=class{};var Ti=class extends Qt{get Site(){return this.Vertex.point}constructor(e){super();this.Vertex=e}get Polyline(){return this.Vertex.polyline}};var Hb=class extends Ti{constructor(e){super(e)}};var Wb=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(p.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),i=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}};var jb=class extends Qt{constructor(e){super();this.site=e}get Site(){return this.site}};var bh=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new $a((i,n)=>this.Compare(i,n)),this.ObstacleSideComparer=new Wb(this),this.LeftObstacleSideTree=new bt((i,n)=>this.ObstacleSideComparer.Compare(i,n)),this.RightObstacleSideTree=new bt((i,n)=>this.ObstacleSideComparer.Compare(i,n))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+C.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>C.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(i=>p.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(i=>!p.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new jb(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new Hb(t))}GetLowestPoint(e){let t=e.startPoint,i=e.startPoint.next;for(;i!=null;i=i.next)this.Less(i.point,t.point)&&(t=i);return t}Compare(e,t){let i=e.Site,n=t.Site;return this.ComparePoints(i,n)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let i=this.SweepDirection.dot(e),n=this.SweepDirection.dot(t);return i<n?-1:i>n?1:(i=this.directionPerp.dot(e),n=this.directionPerp.dot(t),i<n?-1:i>n?1:0)}};var ix=be(zt()),Ou=class{constructor(e,t,i=1){this.LengthMultiplier=1;this.Source=e,this.Target=t,this.Weight=i}static closeuv(e,t){return p.closeDistEps(e.point,Ou.u,.1)&&p.closeDistEps(t.point,Ou.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return ix.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new Ou(this.Target,this.Source)}Clone(){return new Ou(this.Source,this.Target)}},ci=Ou;ci.u=new p(545.833,840.458),ci.v=new p(606.1667261889578,786.2917261889578),ci.DefaultWeight=1;var ur=class extends ci{static constructorVV(e,t){return new ur(e,t,0)}constructor(e,t,i=0){super(e,t,i)}};var jo=class{constructor(e){this._inEdges=new Array;this._outEdges=new bt((t,i)=>this.Compare(t,i)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t==-1)return;let i=this._inEdges.length-1;t!=i&&(this._inEdges[t]=this._inEdges[i]),this._inEdges.pop()}static FindFirst(e,t){return jo.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,i){if(e==t.nil)return null;let n=null;for(;e!=t.nil;)e=e.item.TargetPoint.compareTo(i)>=0?(n=e).left:e.right;return n}get(e){let t=jo.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target==e||(t=jo.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target==this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var $e=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new jo(e);this.pointToVertexMap=new dt}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source==e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!=e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let i=t.startPoint;;i=i.next){let n=p.getTriangleOrientation(i.point,i.next.point,i.next.next.point);if(n!=2){yield n==0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let i=this.VertexFactory(e);return this.pointToVertexMap.set(e,i),i}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let i;if(i=e.get(t))return i;if(e==t)throw new Error("Self-edges are not allowed");let n=new ci(e,t);return e.OutEdges.insert(n),t.InEdges.push(n),n}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,i){let n=this.FindVertex(e),o=null;if(n!=null&&(o=this.FindVertex(t),o!=null)){let l=n.get(o);if(l)return l}n==null?(n=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=i(n,o);return n.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(i,n)=>new ci(i,n))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let i=this.FindVertex(e);if(i==null)return null;let n=this.FindVertex(t);return n==null?null:i.get(n)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var Za=class{constructor(){this.Removed=!1}};var xn=class extends Za{get Start(){return this.start}get End(){return this.EndVertex.point}constructor(e,t,i){super();this.start=e,this.EndVertex=t,this.ConeSide=i}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Ph=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var Mf=class extends Qt{get ConeToClose(){return this.coneToClose}get Site(){return this.site}constructor(e,t){super();this.site=e,this.coneToClose=t}toString(){return"ConeClosureEvent "+this.site}};var Ii=class extends Za{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var io=class extends Za{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var Ru=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let i=e instanceof xn,n=t instanceof xn;return i?n?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):n?this.CompareConeSideAndObstacleSide(e,t):Ru.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(p.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=p.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t==1?-1:t==0?1:e instanceof Ii?-1:1}CompareConeSideAndObstacleSide(e,t){let i=p.getTriangleOrientation(this.x,t.start,t.End);return i==1?-1:i==0||e instanceof Ii?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),i=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}CompareBrokenSides(e,t){return e.EndVertex==t.EndVertex?Ru.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):p.getTriangleOrientation(this.x,t.start,t.EndVertex.point)==1?-1:1}};var Qa=class extends Qt{get EndVertex(){return this.endVertex}constructor(e,t,i){super();this.coneLeftSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var Ka=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var Ja=class extends Ka{Init(e){this.StartVertex=e}constructor(e){super();this.Init(e)}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var qo=class extends Ja{constructor(e){super(e);this.end=e.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var no=class extends Ti{constructor(e){super(e)}};var _f=class extends Qt{get EndVertex(){return this.endVertex}set EndVertex(e){this.endVertex=e}constructor(e,t,i){super();this.coneRightSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var Xo=class extends Ja{constructor(e){super(e);this.end=e.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var oo=class extends Ti{constructor(e){super(e)}};var Nt=class extends bh{constructor(e,t,i,n,o,a,l){super(e,t);this.visibilityGraph=o,this.ConeRightSideDirection=i,this.ConeLeftSideDirection=n,this.coneSideComparer=new Ru(this),this.leftConeSides=new bt((u,c)=>this.coneSideComparer.Compare(u,c)),this.rightConeSides=new bt((u,c)=>this.coneSideComparer.Compare(u,c)),this.Ports=a,this.BorderPolyline=l,this.PortEdgesCreator=(u,c)=>new ur(u,c,0)}static Sweep(e,t,i,n,o,a){new Nt(e,t,t.rotate(-i/2),t.rotate(i/2),n,o,a).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let e of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(e.SourcePoint,e.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count==0)return;let e=this.BorderPolyline.startPoint,t=this.leftConeSides.count;do{let i=this.leftConeSides.treeMinimum().item.Cone;e=this.FindPolylineSideIntersectingConeRightSide(e,i),e=this.GetPolylinePointInsideOfConeAndRemoveCones(e,i),t--}while(this.leftConeSides.count>0&&t>0)}GetPolylinePointInsideOfConeAndRemoveCones(e,t){let i=e.nextOnPolyline,n=Nt.FindInsidePoint(e.point,i.point,t);return p.closeDistEps(n,e.point)?(this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)):p.closeDistEps(n,i.point)?(this.AddEdgeAndRemoveCone(t,i.point),this.AddEdgesAndRemoveRemainingConesByPoint(i.point),e=i):(e=Nt.InsertPointIntoPolylineAfter(this.BorderPolyline,e,n),this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)),e}static FindInsidePoint(e,t,i){return Nt.FindInsidePointBool(e,t,i.Apex,i.Apex.add(i.LeftSideDirection),i.Apex.add(i.RightSideDirection))}static FindInsidePointBool(e,t,i,n,o){if(p.closeDistEps(e,t)||p.PointIsInsideCone(e,i,n,o))return e;if(p.PointIsInsideCone(t,i,n,o))return t;let a=p.middle(e,t);return p.pointToTheLeftOfLine(a,i,n)?Nt.FindInsidePointBool(a,t,i,n,o):Nt.FindInsidePointBool(e,a,i,n,o)}AddEdgesAndRemoveRemainingConesByPoint(e){let t=new Array;for(let i of this.leftConeSides)if(p.PointToTheRightOfLineOrOnLine(e,i.Start,i.Start.add(i.Direction)))t.push(i.Cone);else break;for(let i of t)this.AddEdgeAndRemoveCone(i,e)}FindPolylineSideIntersectingConeRightSide(e,t){let i=e,n=t.Apex,o=t.Apex.add(this.ConeRightSideDirection),a=Nt.GetSign(e,n,o);for(;;){let l=e.nextOnPolyline,u=Nt.GetSign(l,n,o);if(u-a>0)return e;if(e=l,a=u,e==i)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(e,t,i){let n=p.signedDoubledTriangleArea(t,i,e.point);return n<0?1:n>0?-1:0}AddEdgeAndRemoveCone(e,t){this.Ports!=null&&this.Ports.has(e.Apex)?this.CreatePortEdge(e,t):this.visibilityGraph.AddEdgePP(e.Apex,t),this.RemoveCone(e)}CreatePortEdge(e,t){this.portEdgesGraph==null&&(this.portEdgesGraph=new $e);let i=this.portEdgesGraph.FindVertex(e.Apex),n=i!=null?Array.from(i.InEdges).concat(Array.from(i.OutEdges.allNodes())):null;if(n)for(let o of n){let a=(o.Target==i?o.Source:o.Target).point;$e.RemoveEdge(o),this.portEdgesGraph.AddEdgePP(a,t)}this.portEdgesGraph.AddEdgePP(e.Apex,t)}static InsertPointIntoPolylineAfter(e,t,i){let n;return t.next!=null?(n=_t.mkFromPoint(i),n.prev=t,n.next=t.next,t.next.prev=n,t.next=n):(n=_t.mkFromPoint(i),n.prev=t,t.next=n,e.endPoint=n),n.polyline=e,e.setInitIsRequired(),n}ProcessEvent(e){e instanceof Ti?this.ProcessVertexEvent(e):e instanceof _f?this.ProcessRightIntersectionEvent(e):e instanceof Qa?this.ProcessLeftIntersectionEvent(e):(e instanceof Mf?e.ConeToClose.Removed||this.RemoveCone(e.ConeToClose):this.ProcessPortObstacleEvent(e),this.Z=this.GetZS(e))}ProcessPortObstacleEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.CreateConeOnVertex(e)}ProcessLeftIntersectionEvent(e){if(e.coneLeftSide.Removed==!1)if(Math.abs(e.EndVertex.point.sub(e.Site).dot(this.SweepDirection))<C.distanceEpsilon)this.RemoveCone(e.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(e.coneLeftSide),this.Z=this.GetZP(e.Site);let t=new xn(e.Site,e.EndVertex,e.coneLeftSide);this.InsertToTree(this.leftConeSides,t),e.coneLeftSide.Cone.LeftSide=t,this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForLeftSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForLeftSide(e){if(e.Cone.RightSide instanceof io){let t=e.Cone.RightSide;p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.EndVertex.point)==0&&this.CreateConeClosureEvent(e,t)}}CreateConeClosureEvent(e,t){let i=p.RayIntersectsRayInteriors(e.start,e.Direction,t.Start,t.Direction);if(i){let n=new Mf(i,e.Cone);this.EnqueueEvent(n)}}ProcessRightIntersectionEvent(e){if(e.coneRightSide.Removed==!1){this.RemoveSegFromRightTree(e.coneRightSide),this.Z=this.GetZP(e.Site);let t=new xn(e.Site,e.EndVertex,e.coneRightSide);this.InsertToTree(this.rightConeSides,t),e.coneRightSide.Cone.RightSide=t,this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForRightSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForRightSide(e){if(e.Cone.LeftSide instanceof Ii){let i=e.Cone.LeftSide;p.getTriangleOrientation(i.Start,i.Start.add(i.Direction),e.EndVertex.point)==1&&this.CreateConeClosureEvent(e,i)}}RemoveConesClosedBySegment(e,t){this.CloseConesCoveredBySegment(e,t,this.GetZP(e)>this.GetZP(t)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(e,t,i){let n=i.findFirst(l=>p.getTriangleOrientation(l.Start,l.Start.add(l.Direction),e)==1);if(n==null||!p.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction))return;let a=new Array;do a.push(n.item.Cone),n=i.next(n);while(n!=null&&p.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction)!=null);for(let l of a)this.RemoveCone(l)}ProcessVertexEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.AddConeAndEnqueueEvents(e)}static Diamond(e){return Be.CreateDiamond(2,2,e)}AddConeAndEnqueueEvents(e){if(e instanceof no){let i=e.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(e,i)}else if(e instanceof oo){let n=e.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(e,n)}else this.CloseConesAddConeAtLeftVertex(e,e.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(e,e.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;this.directionPerp.dot(e.Site.sub(i))>C.distanceEpsilon&&this.RemoveConesClosedBySegment(i,e.Vertex.point),this.directionPerp.dot(t.point.sub(e.Site))>C.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,t.point);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>C.distanceEpsilon&&this.RemoveRightSide(new Xo(e.Vertex.nextOnPolyline)),this.GetZP(n.sub(t.point))>C.distanceEpsilon&&this.RemoveLeftSide(new qo(t)),this.GetZP(l)+C.distanceEpsilon<this.GetZS(e)&&this.CreateConeOnVertex(e),p.PointToTheRightOfLineOrOnLine(l,n,o)?p.PointToTheLeftOfLineOrOnLine(l,n,a)?this.CaseToTheLeftOfLineOrOnLineConeRp(e,t):(this.GetZP(l.sub(n))>C.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,t),this.InsertRightSide(new Xo(e.Vertex))),this.EnqueueRightVertexEvent(new oo(t))):(this.CreateConeOnVertex(e),p.PointToTheLeftOfLineOrOnLine(l.add(this.DirectionPerp),l,n)&&this.EnqueueRightVertexEvent(new oo(t)))}CaseToTheLeftOfLineOrOnLineConeRp(e,t){this.EnqueueRightVertexEvent(new oo(t));let i=new Ph(e.Vertex.point,this),n=new xn(i.Apex,t,new Ii(i));i.LeftSide=n,i.RightSide=new io(i);let o=this.InsertToTree(this.rightConeSides,i.RightSide);this.LookForIntersectionWithConeRightSide(o);let a=this.InsertToTree(this.leftConeSides,i.LeftSide);this.FixConeLeftSideIntersections(n,a),this.GetZP(t.point.sub(e.Site))>C.distanceEpsilon&&this.InsertRightSide(new Xo(e.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(e,t){let i=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(e);if(i!=null&&i.item instanceof io!=null){let o=p.IntervalIntersectsRay(e,t.point,i.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,t.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(i.item,o,t))}}CreateRightIntersectionEvent(e,t,i){return new _f(e,t,i)}GetLastNodeToTheLeftOfPointInRightSegmentTree(e){return this.rightConeSides.findLast(t=>Nt.PointIsToTheRightOfSegment(e,t))}LookForIntersectionOfObstacleSideAndLeftConeSide(e,t){let i=this.GetFirstNodeToTheRightOfPoint(e);if(i==null||!(i.item instanceof Ii))return;let n=i.item,o=p.IntervalIntersectsRay(e,t.point,n.Start,this.ConeLeftSideDirection);o&&this.EnqueueEvent(new Qa(n,o,t))}GetFirstNodeToTheRightOfPoint(e){return this.leftConeSides.findFirst(t=>Nt.PointIsToTheLeftOfSegment(e,t))}static PointIsToTheLeftOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==1}static PointIsToTheRightOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==0}FixConeLeftSideIntersections(e,t){do t=this.leftConeSides.next(t);while(t!=null&&p.PointToTheRightOfLineOrOnLine(e.Start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null&&t.item instanceof Ii){let i=t.item,n=p.IntervalIntersectsRay(e.start,e.End,i.Start,i.Direction);n&&this.EnqueueEvent(new Qa(i,n,e.EndVertex))}}InsertToTree(e,t){return this.coneSideComparer.SetOperand(t),e.insert(t)}CloseConesAddConeAtLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;e.Site.sub(i).dot(this.directionPerp)<-C.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,i),t.point.sub(e.Site).dot(this.directionPerp)<-C.distanceEpsilon&&this.RemoveConesClosedBySegment(t.point,e.Site);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>C.distanceEpsilon&&this.RemoveLeftSide(new qo(e.Vertex.prevOnPolyline));let u=this.GetZP(l)-this.Z;u<-C.distanceEpsilon&&this.RemoveRightSide(new Xo(t));let c=l.sub(e.Site);if(u<-C.distanceEpsilon||ae(u,0)&&this.GetZP(c)>0&&c.dot(this.directionPerp)>-C.distanceEpsilon)this.CreateConeOnVertex(e);else if(!p.PointToTheLeftOfLineOrOnLine(l,n,a))this.CreateConeOnVertex(e),this.EnqueueEvent(new no(t));else if(p.PointToTheLeftOfLineOrOnLine(l,n,o))this.EnqueueEvent(new no(t)),this.GetZP(c)>C.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,t),this.InsertLeftSide(new qo(e.Vertex)));else{this.EnqueueEvent(new no(t));let h=new Ph(e.Vertex.point,this),d=new xn(e.Vertex.point,t,new io(h));h.RightSide=d,h.LeftSide=new Ii(h),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,h.LeftSide));let f=this.InsertToTree(this.rightConeSides,d);this.FixConeRightSideIntersections(d,f),this.GetZP(c)>C.distanceEpsilon&&this.InsertLeftSide(new qo(e.Vertex))}}RemoveCone(e){e.Removed=!0,this.RemoveSegFromLeftTree(e.LeftSide),this.RemoveSegFromRightTree(e.RightSide)}RemoveSegFromRightTree(e){this.coneSideComparer.SetOperand(e);let t=this.rightConeSides.remove(e);if(e.Removed=!0,t==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),t=this.rightConeSides.remove(e),this.Z=i}}RemoveSegFromLeftTree(e){if(e.Removed=!0,this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e)==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e),this.Z=i}}FixConeRightSideIntersections(e,t){do t=this.rightConeSides.previous(t);while(t!=null&&p.PointToTheLeftOfLineOrOnLine(e.start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null){let i;if(t.item instanceof io){let n=t.item;(i=p.IntervalIntersectsRay(e.start,e.End,n.Start,n.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n,i,e.EndVertex))}}}CreateConeOnVertex(e){let t=new Ph(e.Site,this);t.LeftSide=new Ii(t),t.RightSide=new io(t);let i=this.InsertToTree(this.leftConeSides,t.LeftSide),n=this.InsertToTree(this.rightConeSides,t.RightSide);this.LookForIntersectionWithConeRightSide(n),this.LookForIntersectionWithConeLeftSide(i)}LookForIntersectionWithConeLeftSide(e){if(e.item instanceof Ii){let i=e.item,n=this.FindFirstObstacleSideToTheLeftOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(i,n)}else{let i=e.item;e=this.leftConeSides.next(e),e!=null&&e.item instanceof Ii&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(e.item,i)}}LookForIntersectionWithConeRightSide(e){if(e.item instanceof io){let i=e.item,n=this.FindFirstObstacleSideToToTheRightOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(i,n)}else{let i=e.item;e=this.rightConeSides.previous(e),e!=null&&e.item instanceof io&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(e.item,i)}}TryIntersectionOfConeRightSideAndObstacleConeSide(e,t){let i=p.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(e,t){let i=p.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(e,t){let i=p.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new Qa(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(e,t){let i=p.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new Qa(e,i,t.EndVertex))}Show(e,t){let i=Array.from(this.Obstacles).map(n=>fe.mkDebugCurveTWCI(200,.5,"Blue",n));for(let n of this.rightConeSides)i.push(fe.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(n))),n instanceof xn&&i.push(fe.mkDebugCurveCI("brown",Nt.Diamond(n.start))),i.push(fe.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(n.Cone.LeftSide))),n.Cone.LeftSide instanceof xn&&i.push(fe.mkDebugCurveCI("green",Nt.Diamond(n.Cone.LeftSide.start)));i=i.concat(Array.from(this.visibilityGraph.Edges).map(n=>fe.mkDebugCurveWCI(2,"Black",B.mkPP(n.SourcePoint,n.TargetPoint)))),i=i.concat(e.map(n=>fe.mkDebugCurveCI("Red",n)))}ExtendSegmentToZ(e){let t=e.Direction.dot(this.SweepDirection),i=(this.Z+40-e.Start.dot(this.SweepDirection))/t;return B.mkPP(e.Start,e.Start.add(e.Direction.mul(i)))}GoOverConesSeeingVertexEvent(e){let t=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e);if(t==null)return;let n=t.item.Cone,o=n.LeftSide;if(Nt.VertexIsToTheLeftOfSegment(e,o))return;let a=[n];if(this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),t==null){let l=this.Z;this.Z=Math.max(this.GetZP(o.Start),this.PreviousZ),this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),this.Z=l}if(!(t==null&&(t=this.GetRbNodeEmergency(t,o),t==null))){for(t=this.leftConeSides.next(t);t!=null&&!Nt.VertexIsToTheLeftOfSegment(e,t.item);)a.push(t.item.Cone),t=this.leftConeSides.next(t);for(let l of a)this.AddEdgeAndRemoveCone(l,e.Site)}}GetRbNodeEmergency(e,t){for(let i=this.leftConeSides.treeMinimum();i!=null;i=this.leftConeSides.next(i))if(i.item==t){e=i;break}return e}static VertexIsToTheLeftOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==1}static VertexIsToTheRightOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e){return this.rightConeSides.findFirst(t=>!Nt.VertexIsToTheRightOfSegment(e,t))}EnqueueRightVertexEvent(e){this.GetZP(e.Site.sub(e.Vertex.prevOnPolyline.point))>C.tolerance||this.EnqueueEvent(e)}invariant(){for(let e of this.leftConeSides)if(e.Removed)return!1;for(let e of this.rightConeSides)if(e.Removed)return!1;return!0}};var Gs=class extends Ee{constructor(e,t){super(null);this.coneAngle=Math.PI/6;this.ports=new Je;this._obstacles=Array.from($e.OrientHolesClockwise(e)),this._visibilityGraph=t}static mk(e,t,i,n,o){let a=new Gs(e,t);return a.Ports=n,a.BorderPolyline=o,a.ConeAngle=i,a}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Ports(){return this.ports}set Ports(e){this.ports=e}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(e){this.borderPolyline=e}get Bidirectional(){return this._bidirectional}set Bidirectional(e){this._bidirectional=e}static GetTotalSteps(e){return Math.floor((2*Math.PI-e/2)/e)+1}run(){let e=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let t;for(let i=0;(t=this.coneAngle*i)<=e;i++)super.ProgressStep(),this.AddDirection(new p(Math.cos(t),Math.sin(t)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let e=Math.PI/this.coneAngle;for(let t=0;t<e;t++){let i=t*this.coneAngle,n=new $e;this.AddDirection(new p(Math.cos(i),Math.sin(i)),this.BorderPolyline,n);let o=new $e;this.AddDirection(new p(Math.cos(i)*-1,Math.sin(i)*-1),this.BorderPolyline,o),this.AddIntersectionOfBothDirectionSweepsToTheResult(n,o)}}AddIntersectionOfBothDirectionSweepsToTheResult(e,t){for(let i of e.Edges)t.FindEdgePP(i.SourcePoint,i.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(i.SourcePoint,i.TargetPoint)}AddDirection(e,t,i){Nt.Sweep(this._obstacles,e,this.coneAngle,i,this.Ports,t)}};var Dt=class extends Ya{constructor(e){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=e,this.location=this.curve().start}mk(e,t){let i=new Dt(e);return i.HookSize=t,i}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(e){this.location=e}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(e){this.adjustmentAngle=e}get HookSize(){return this.hookSize}set HookSize(e){this.hookSize=e}};var br=class extends Ai{get LoosePolyline(){return this.loosePolyline}set LoosePolyline(e){this.loosePolyline=e}constructor(e,t,i=new p(0,0)){super(e,t,i)}static mk(e,t){return new br(e,t)}};var Pr=class extends Ya{get Location(){return this.curve.value(this.parameter)}set Location(e){throw new Error("Method should not be called.")}static mk(e,t){let i=new Pr;return i.curve=e,i.parameter=t,i}get Parameter(){return this.parameter}set Parameter(e){this.parameter=e}get Curve(){return this.curve}set Curve(e){this.curve=e}};var Mu=class extends ro{get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(e){if(e)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}constructor(e){super(null);this.curveDelegate=e}};var wi=class{static GetShapes(e,t){let i=new Map;for(let n of e)wi.ProcessAncestorDescendantCouple(n.target,n.source,i),wi.InsertEdgePortsToShapes(i,n);for(let n of t)wi.ProcessAncestorDescendantCouple(n.source,n.target,i),wi.InsertEdgePortsToShapes(i,n);return wi.BindShapes(i),Array.from(i.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,i]of e){if(!(t instanceof Re))continue;let n=t;for(let o of qb(n)){let a=e.get(o);a&&i.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,i){let n=Bf(t);do{for(let o of qb(n))wi.CreateShapeIfNeeeded(o,i);if(n==e)break;n=Bf(n)}while(!0);wi.CreateShapeIfNeeeded(n,i)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new Mu(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,i){let n=new Set;for(let o of e)if(wi.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,n,i))return!1;for(let o of t)if(wi.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,n,i))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,i,n){let o=Bf(t);for(;;){for(let a of qb(o))if(i.add(a),i.size>n)return!0;if(o==e)break;o=Bf(o)}return i.add(o),i.size>n}};function Bf(s){let e=s.node.parent;return Ue.getGeom(e)}function*qb(s){for(let e of s.graph.shallowNodes)yield Ue.getGeom(e)}var Zr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new p(0,Number.MAX_SAFE_INTEGER);let t=-1,i=0;for(let n of e)n.y<this.pivot.y?(this.pivot=n,t=i):n.y==this.pivot.y&&n.x>this.pivot.x&&(this.pivot=n,t=i),i++;if(i>=1){this.hullPoints=new Array(i-1),i=0;for(let n of e)i!=t?this.hullPoints[i++]={point:n,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new Zr(e);for(let i of t.Calculate())yield i}*Calculate(){if(this.pivot.y!=Number.MAX_SAFE_INTEGER){if(this.hullPoints.length==0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return p.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)==1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=p.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t==1?!0:t==0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+C.distanceEpsilon&&e.x<this.pivot.x-C.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(t2(this.pivot))}static createConvexHullAsClosedPolyline(e){return te.mkClosedFromPoints(Array.from(Zr.CalculateConvexHull(e)))}};function t2(s){return(e,t)=>{if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;switch(p.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let i=e.point.x-s.x,n=t.point.x-s.x;if(i>C.distanceEpsilon&&n<C.distanceEpsilon*-1)return-1;if(i<C.distanceEpsilon*-1&&n>C.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function _r(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(_r(s,e.Left,t),_r(s,e.Right,t)):e.Left!=null?(_r(s.Left,e.Left,t),_r(s.Left,e.Right,t),_r(s.Right,e.Left,t),_r(s.Right,e.Right,t)):(_r(s.Left,e,t),_r(s.Right,e,t)))}function Ft(s,e,t){!s.irect.intersects_rect(e.irect)||(s==e?i2(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Ft(s,e.Left,t),Ft(s,e.Right,t)):e.Left!=null?(Ft(s.Left,e.Left,t),Ft(s.Left,e.Right,t),Ft(s.Right,e.Left,t),Ft(s.Right,e.Right,t)):(Ft(s.Left,e,t),Ft(s.Right,e,t)))}function Li(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s==e)return r2(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(Li(s,e.Left,t)||Li(s,e.Right,t))return!0}else if(e.Left!=null){if(Li(s.Left,e.Left,t)||Li(s.Left,e.Right,t)||Li(s.Right,e.Left,t)||Li(s.Right,e.Right,t))return!0}else if(Li(s.Left,e,t)||Li(s.Right,e,t))return!0;return!1}function r2(s,e){return s.Left==null?!1:Li(s.Left,s.Left,e)||Li(s.Left,s.Right,e)||Li(s.Right,s.Right,e)}function i2(s,e){s.Left!=null&&(Ft(s.Left,s.Left,e),Ft(s.Left,s.Right,e),Ft(s.Right,s.Right,e))}var _u=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n>=this.f(0)&&n>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:e=i;break;case 0:t=i;break;case 2:return i}return e==t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e==0){let o=this.f(1);return o==t?2:o>t?0:1}if(e==this.length-1){let o=this.f(this.length-2);return o==t?2:o>t?1:0}let i=t-this.f(e-1),n=this.f(e+1)-t;return i*n<=0?2:i>0?0:1}FindMaximum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n<=this.f(0)&&n<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:t=i;break;case 0:e=i;break;case 2:return i}return e==t||this.f(e)>this.f(t)?e:t}};var Xb=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.min(this.f(n),e+i*n)}GetAdjustedSequenceForMaximum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.max(this.f(n),e+i*n)}FindMinimum(){return this.f(0)==this.f(this.length-1)?new _u(this.f,this.length).FindMinimum():new _u(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)==this.f(this.length-1)?new _u(this.f,this.length).FindMaximum():new _u(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var el=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,i){let n=this.P.pnt(e);return this.upperBranchOnP?p.pointToTheLeftOfLineOrOnLine(i,n,t):p.pointToTheRightOfLineOrOnLine(i,n,t)}LeftFromLineOnQ(e,t,i){let n=this.Q.pnt(e);return this.lowerBranchOnQ?p.pointToTheLeftOfLineOrOnLine(i,n,t):p.pointToTheRightOfLineOrOnLine(i,n,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,i,n){for(;t!=e||n!=i;){let o=t!=e?this.MedianOnP(e,t):e,a=n!=i?this.MedianOnQ(i,n):i,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!=e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(i,n)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?i=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?n=a:h=!1:n!=i?this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:h=!1:h=!1,!c&&!h&&(e=o,t=o,i=a,n=a)}return[e,n]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=p.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.add(t.qClosest).rotate(Math.PI/2)}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2==e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2==e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1==e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1==e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=p.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),p.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:p.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=p.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),p.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:p.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,i,n){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(n-i)+1;return a>2||o==2&&a==2}ShrinkChunks(e){let t=e.p1==e.p2?e.p1:this.P.Median(e.p1,e.p2),i=e.q1==e.q2?e.q1:this.Q.Median(e.q2,e.q1),n=this.P.pp(t).point,o=this.Q.pp(i).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,i,n,o,a),!this.InternalCut(e,t,i,a.a1,a.a2,a.b1,a.b2)&&!el.OneOfChunksContainsOnlyOneVertex(e,t,i,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:i},a)){if(e.p2==this.P.Next(e.p1)&&e.q1==this.Q.Next(e.q2)){let l=B.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab==0?e.p2=e.p1:l.parab==1?e.p1=e.p2:l.parcd==0?e.q2=e.q1:l.parcd==1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=i:a.a2>=Math.PI/2?e.p2=t:e.q2=i:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=i:e.q2=i}}InternalCut(e,t,i,n,o,a,l){let u=!1;if(n>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.P.pp(this.P.Next(t)).point,f=p.getTriangleOrientation(c,h,this.Q.pp(0).point),P=p.getTriangleOrientation(c,h,d);f==P?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.Q.pp(this.Q.Next(i)).point,f=p.getTriangleOrientation(c,h,this.P.pp(0).point),P=p.getTriangleOrientation(c,h,d);f==P?e.q2=this.Q.Next(i):e.q1=this.Q.Prev(i),u=!0}return u}GetAnglesAtTheMedian(e,t,i,n,o){o.a1=p.anglePCP(n,i,this.P.pnt(this.P.Prev(e))),o.a2=p.anglePCP(this.P.pnt(this.P.Next(e)),i,n),o.b1=p.anglePCP(this.Q.pnt(this.Q.Next(t)),n,i),o.b2=p.anglePCP(i,n,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,i){let n=e.p2==this.P.Next(e.p1),o=e.q1==this.Q.Next(e.q2);return n&&!o?(this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),!0):o&&!n?(this.SwapEverything(e,t,i),this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),this.SwapEverything(e,t,i),!0):!1}SwapEverything(e,t,i){this.SwapPq();let n=e.p2;e.p2=e.q1,e.q1=n,n=e.q2,e.q2=e.p1,e.p1=n,n=t.mq,t.mq=t.mp,t.mp=n,n=i.a2,i.a2=i.b1,i.b1=n,n=i.b2,i.b2=i.a1,i.a1=n}ProcessShortSide(e,t,i,n,o,a,l){t==e.p2?this.ProcessSide(e,i,n,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=i:o>=Math.PI/2?e.q1=i:a<l&&(p.canProject(this.Q.pnt(i),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=i:e.p1=e.p2):n+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,i,n,o){let a=this.Q.pnt(t);i<=Math.PI?i+n>=Math.PI?i>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:i<o&&(p.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,n>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,i,n,o){return e.p1==e.p2?(o>=Math.PI/2?e.q1=i:e.q2=i,!0):e.q1==e.q2?(n>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,i,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,i,e.q2)}CalculateRightTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,i,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,i,e.q2)}};var Kt=class{static mkFromPoints(e){return new Kt(te.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,i,n){let o=n.rotate(Math.PI/2);this.polyline.startPoint.point.sub(i).dot(o)<0&&(o=o.mul(-1)),e==t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!=t);return e}static TestPolygonDist(e,t){let i=Number.MAX_SAFE_INTEGER;for(let n=0;n<e.count;n++)for(let o=0;o<t.count;o++){let a=B.minDistBetweenLineSegments(e.pnt(n),e.pnt(n+1),t.pnt(o),t.pnt(o+1));i=Math.min(i,a.dist)}return i}static Distance(e,t){let n=new el(e,t).FindClosestPoints();return{p:n.pClosest,q:n.qClosest,dist:n.pClosest.sub(n.qClosest).length}}static DistanceOnly(e,t){return Kt.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let i=t.startPoint;i.next!=null&&i.next.next!=null;i=i.next)if(p.getTriangleOrientation(i.point,i.next.point,i.next.next.point)==2)return!1;return!0}static DistancePoint(e,t){let i=Number.MAX_VALUE;for(let n=0;n<e.count;n++){let o=p.distToLineSegment(t,e.points[n].point,e.points[(n+1)%e.count].point).dist;i=Math.min(i,o)}return i}GetTangentPoints(e,t){let i=new Xb(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=i.FindMaximum(),e.rightTangentPoint=i.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return i=>{let n=p.anglePCP(t,e,this.pnt(i));return n<Math.PI?n:n-2*Math.PI}}};var Te=class{ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(B.mkPP(e,t))}static PadCorner(e,t,i,n,o){let a=Te.GetPaddedCorner(t,i,n,o);return a.numberOfPoints==-1?!1:(e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return p.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t){return Te.CreatePaddedPolyline(w.polylineAroundClosedCurve(e),t)}static LoosePolylineWithFewCorners(e,t){return t<C.distanceEpsilon?e:Te.CreateLoosePolylineOnBisectors(e,t)}static CreateLoosePolylineOnBisectors(e,t){return te.mkClosedFromPoints(Zr.CalculateConvexHull(Te.BisectorPoints(e,t)))}static CreateRectNodeOfPolyline(e){return ct(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=Te.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(Te.LoosePolylineWithFewCorners(e,t))}this.RootOfLooseHierarchy=Te.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=Te.CreateTightObstacles_(this.Obstacles,this.TightPadding,this.TightObstacles),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size==0}constructor(e,t,i,n){this.Obstacles=e,this.TightPadding=t,this.LoosePadding=i,this.IgnoreTightPadding=n}ObstaclesIntersectICurve(e){let t=e.boundingBox;return Te.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,i){if(!i.irect.intersects(t))return!1;if(i.UserData!=null){let n=i.UserData;return w.intersectionOne(n,e,!1)!=null||Te.PointIsInside(n.start,e)}return Te.CurveIntersectsRectangleNode(e,t,i.Left)||Te.CurveIntersectsRectangleNode(e,t,i.Right)}static PointIsInside(e,t){return w.PointRelativeToCurveLocation(e,t)==2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(n=>w.polylineAroundClosedCurve(n)),t=Te.CalculateHierarchy(e),i=Te.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,i.size==0){for(let n of e){let o=Te.FindMaxPaddingForTightPolyline(t,n,this.TightPadding);this.TightObstacles.add(Te.LoosePolylineWithFewCorners(n,o))}this.RootOfTightHierarchy=Te.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let n of e)this.TightObstacles.add(Te.CreatePaddedPolyline(n,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=Te.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;Te.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=Te.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(i)),this.OverlapsDetected=!0}}static CreateTightObstacles_(e,t,i){if(e.length==0)return null;for(let n of e)Te.CalculateTightPolyline(i,t,n);return Te.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(i)}static CalculateTightPolyline(e,t,i){let n=Te.PaddedPolylineBoundaryOfNode(i,t);e.add(n)}static CalculateHierarchy(e){let t=e.map(i=>Te.CreateRectNodeOfPolyline(i));return Qe(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=Te.CalculateHierarchy(Array.from(e)),i;for(;(i=Te.GetOverlappedPairSet(t)).size>0;)t=Te.ReplaceTightObstaclesWithConvexHulls(e,Array.from(i));return t}static MapToInt(e){let t=new Map;for(let i=0;i<e.length;i++)t.set(e[i],i);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let i=new Set;for(let u of t)i.add(u[0]),i.add(u[1]);let n=Array.from(i),o=Te.MapToInt(n),a=mf(Array.from(t).map(u=>new ge(o.get(u[0]),o.get(u[1])))),l=ko(a);for(let u of l){let c=u.map(f=>n[f]),h=to(c,f=>Array.from(f)),d=Zr.createConvexHullAsClosedPolyline(h);for(let f of c)e.delete(f);e.add(d)}return Te.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return w.PointRelativeToCurveLocation(e.start,t)!=0||w.PointRelativeToCurveLocation(t.start,e)!=0}static PolylinesIntersect(e,t){return w.CurvesIntersect(e,t)||Te.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return Ft(e,e,(i,n)=>{Te.PolylinesIntersect(i,n)&&t.add([i,n])}),t}static BisectorPoints(e,t){let i=new Array;for(let n=e.startPoint;n!=null;n=n.next){let o={skip:!1},a=Te.GetStickingVertexOnBisector(n,t,o);o.skip||i.push(a)}return i}static GetStickingVertexOnBisector(e,t,i){let n=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(n).normalize().add(o.sub(a).normalize()),u=l.length;return u<C.tolerance?i.skip=!0:(i.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,i){let n=i,o=new Kt(t),a=t.boundingBox.clone();a.pad(2*i);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!=t)){let u=Kt.Distance(o,new Kt(l)).dist;n=Math.min(n,u/Te.LooseDistCoefficient)}return n}static GetPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point;if(p.getTriangleOrientation(o,a,l)==1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(Te.CornerIsNotTooSharp(o,a,l)){u=u.mul(n);let E=l.sub(a).normalize().mul(n).rotate(Math.PI/2),v=p.lineLineIntersection(o.add(u),a.add(u),a.add(E),l.add(E));return{a:v,b:v,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<C.intersectionEpsilon){let E=a.add(u.mul(n));return{a:E,b:E,numberOfPoints:1}}let h=c.normalize().mul(n),d=h.rotate(Math.PI/2),f=(n-h.dot(u))/d.dot(u),P=d.mul(f);return{a:h.add(P).add(a),b:h.sub(P).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,i){let n=e.sub(t).rotate(Math.PI/4).add(t);return p.getTriangleOrientation(t,n,i)==1}static CreatePaddedPolyline(e,t){let i=new te;if(!Te.PadCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t))return Te.CreatePaddedPolyline(te.mkClosedFromPoints(Array.from(Zr.CalculateConvexHull(e))),t);if(!Te.PadCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t))return Te.CreatePaddedPolyline(te.mkClosedFromPoints(Array.from(Zr.CalculateConvexHull(e))),t);for(let n=e.startPoint;n.next.next!=null;n=n.next)if(!Te.PadCorner(i,n,n.next,n.next.next,t))return Te.CreatePaddedPolyline(te.mkClosedFromPoints(Array.from(Zr.CalculateConvexHull(e))),t);return i.closed=!0,i}},Jt=Te;Jt.LooseDistCoefficient=2.1;var yh=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,i){let n=new yh;return n.TightPolyline=e,n.LooseShape=t,n.Distance=i,n}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Sh=class{constructor(e,t,i,n){this.MainShape=e,this.TightPadding=t,this.LoosePadding=i,this.ShapesToTightLooseCouples=n}Calculate(){this.MainShape.Children.length!=0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=Qe(this.MainShape.Children.map(t=>ct(t,t.BoundingBox)));_r(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Sh.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return w.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)==2}CreateTigthLooseCouples(){let e=new Array;for(let t of this.tightHierarchy.GetAllLeaves()){let i=Jt.FindMaxPaddingForTightPolyline(this.tightHierarchy,t,this.LoosePadding),n=Jt.LoosePolylineWithFewCorners(t,i);e.push(yh.mk(t,new ro(n),i))}this.coupleHierarchy=Qe(e.map(t=>ct(t,t.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=Jt.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=Jt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),i=to(this.LoosePolylinesUnderShape(e),o=>Array.from(o)).filter(o=>w.PointRelativeToCurveLocation(o,t)==0);if(i.length<=0)return t;let n=Array.from(t).concat(i);return te.mkClosedFromPoints(Zr.CalculateConvexHull(n))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var nx=be(zt());var Yb=class{constructor(e,t,i){this.indexToA=e,this.priority=t,this.v=i}};var yr=class{constructor(e=Ae){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let i=++this.heapSize,n=new Yb(i,t,e);for(this.cache.set(e,n),this.A[i]=n;i>1&&this.compare(this.A[i>>1].priority,t)>0;)this.SwapWithParent(i),i>>=1}IsEmpty(){return this.heapSize==0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this.compare(this.A[n].priority,this.A[t].priority)<0&&(i=n);let o=n+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[i].priority)<0&&(i=o),i!=t)this.SwapWithParent(i);else break;t=i}this.heapSize--}DecreasePriority(e,t){let i=this.cache.get(e);if(!i)return;i.priority=t;let n=i.indexToA;for(;n>1&&this.compare(this.A[n].priority,this.A[n>>1].priority)<0;){this.SwapWithParent(n);n>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count==0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new nx.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var Vs=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,this._visGraph.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new yr(Ae);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source==this.source||this.targets.has(e.Target)||!Vs.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target==this.source||!Vs.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ur}ProcessNeighbor(e,t,i){let n=t.Length,o=this.current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),i!=this.source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!=this.source);return e.push(this.source),e.reverse()}};var Bu=class{constructor(e,t,i){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=i,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new yr(Ae);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let i={priority:0},n=t.DequeueAndGetPriority(i);if(i.priority>=this._target.Distance)break;for(let o of n.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,n,o,a)}for(let o of n.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,n,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source==this._source||e.Target==this._target||!Bu.IsForbidden(e)}PassableInEdge(e){return e.Source==this._target||e.Target==this._source||!Bu.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ur}ProcessNeighborN(e,t,i,n,o){let a=i.Length+o,l=t.Distance+a;n!=this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.Enqueue(n,this.H(n))):n!=this._source&&l<n.Distance&&(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.DecreasePriority(n,this.H(n)))}ProcessNeighbor(e,t,i,n){let o=i.Length,a=t.Distance+o;n!=this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.Enqueue(n,this.H(n))):n!=this._source&&a<n.Distance&&(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.DecreasePriority(n,this.H(n)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,i=this._target;do t.push(i),e&&this._visGraph.ShrinkLengthOfPrevEdge(i,this.LengthMultiplier),i=this._visGraph.PreviosVertex(i);while(i!=this._source);return t.push(this._source),t.reverse()}};var ox=be(zt()),Nf=class{toString(){return ox.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var sx=be(zt()),Df=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return sx.String.Format("{0},{1}",this.Start,this.End)}};var Ff=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(p.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,i){return p.closeDistEps(e,p.ClosestPointAtLineSegment(e,t,i))}static IntersectDiagonalWithRay(e,t,i){let n=t.sub(e),o=i.Start,a=i.End,l=mn.solve(a.x-o.x,n.x*-1,e.x-o.x,a.y-o.y,n.y*-1,e.y-o.y);return e.add(n.mul(l.y))}};var Yo=class{constructor(e){this.pivot=e}IComparer(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=e.Start.point.sub(this.pivot),n=t.Start.point.sub(this.pivot);return Yo.CompareVectorsByAngleToXAxis(i,n)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Yo.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Yo.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let i=e.x*t.y-e.y*t.x;if(i>C.tolerance)return-1;if(i<-C.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let n=Math.abs(e.x)-Math.abs(t.x);return n<0?-1:n>0?1:(n=Math.abs(e.y)-Math.abs(t.y),n<0?-1:n>0?1:0)}};var so=class extends Ee{constructor(e,t,i){super(null);this.activeDiagonalComparer=new Ff;this.polygons=e,this.visibilityGraph=i,this.addedPolygons=t}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let e of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(e);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(e){this.currentPolygon=e,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new bt(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let e=1;e<this.tangents.length;e++){let t=this.tangents[e];t.Diagonal!=null?(t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsHigh&&this.RemoveDiagonalFromActiveNodes(t.Diagonal)):t.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=t.End.point,this.InsertActiveDiagonal(new Nf(t,t.Comp)),t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t))}}AddVisibleEdge(e){$e.AddEdgeVV(ax(this.visibilityGraph,e.start),ax(this.visibilityGraph,e.End))}InitActiveDiagonals(){if(this.tangents.length==0)return;let e=this.tangents[0],t=e.start.point,i=e.End.point;for(let n of this.diagonals)if(so.RayIntersectDiagonal(t,i,n)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=Ff.IntersectDiagonalWithRay(t,i,n),this.InsertActiveDiagonal(n)),e.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(e),e.IsLow==!1){let o=e.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(e){let t=this.activeDiagonalTree.deleteSubTree(e.RbNode);t!=null&&t.item!=null&&(t.item.RbNode=t),e.LeftTangent.Diagonal=null,e.RightTangent.Diagonal=null}InsertActiveDiagonal(e){e.RbNode=this.activeDiagonalTree.insert(e),so.MarkDiagonalAsActiveInTangents(e)}static MarkDiagonalAsActiveInTangents(e){e.LeftTangent.Diagonal=e,e.RightTangent.Diagonal=e}static RayIntersectDiagonal(e,t,i){let n=i.Start,o=i.End;return p.getTriangleOrientation(e,n,o)==1&&p.getTriangleOrientation(e,t,n)!=1&&p.getTriangleOrientation(e,t,o)!=0}static TangentComparison(e,t){return Yo.CompareVectorsByAngleToXAxis(e.End.point.sub(e.start.point),t.End.point.sub(t.start.point))}*AllObstacles(){for(let e of this.addedPolygons)yield e;for(let e of this.polygons)yield e}OrganizeTangents(){for(let e of this.AllObstacles())e!=this.currentPolygon&&this.ProcessPolygonQ(e);this.tangents.sort(so.TangentComparison)}ProcessPolygonQ(e){let t=new el(this.currentPolygon,e);this.useLeftPTangents?t.CalculateLeftTangents():t.CalculateRightTangents();let i=this.useLeftPTangents?t.leftPLeftQ:t.rightPLeftQ,n=new Df(this.currentPolygon.pp(i[0]),e.pp(i[1]));n.IsLow=!0,n.SeparatingPolygons=!this.useLeftPTangents,i=this.useLeftPTangents?t.leftPRightQ:t.rightPRightQ;let o=new Df(this.currentPolygon.pp(i[0]),e.pp(i[1]));o.IsLow=!1,o.SeparatingPolygons=this.useLeftPTangents,n.Comp=o,o.Comp=n,this.tangents.push(n),this.tangents.push(o),this.diagonals.push(new Nf(n,o))}};function ax(s,e){return s.FindVertex(e.point)}var Eh=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(p.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),i=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*i.y-i.x*t.y)<C.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,i){let n=mn.solve(t.x-e.x,-i.x,this.Pivot.x-e.x,t.y-e.y,-i.y,this.Pivot.y-e.y);if(!(-C.tolerance<=n.x&&n.x<=1+C.tolerance))throw new Error;if(!n)throw new Error;return this.Pivot.add(i.mul(n.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let i=new Eh;return i.pivot=e,i.pointOnTheRay=t,i}};var lx=be(zt()),tl=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!=this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!=this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return lx.String.Format("Stem({0},{1})",this.Start,this.End)}};var vn=class{constructor(e,t,i,n){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=i,this.qPolylinePoint=_t.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=n;let o=new Yo(this.q);this.heapForSorting=new $a(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,i,n){let o=t.FindVertex(i);if(o!=null)return o;let a=new vn(e,t,i,n);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!=0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let i=!1;for(let n of t.Sides()){let o=n;if(o.point.y<this.q.y){if(n.nextOnPolyline.point.y>=this.q.y){let a=p.getTriangleOrientation(this.q,o.point,n.nextOnPolyline.point);if(a==1||a==2){i=!0,yield new tl(t.Start,n),yield new tl(n.nextOnPolyline,t.End),this.RegisterActiveSide(n);break}}}else{if(o.point.y>this.q.y)break;if(n.point.x>=this.q.x){i=!0,yield new tl(n,t.End),n!=t.Start&&(yield new tl(t.Start,e.prev(o))),this.RegisterActiveSide(n);break}}}i||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new p(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=vn.GetIncomingSide(e),i=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let n;if(n=this.sideNodes.get(t)){if(n==this.activeSidesTree.treeMinimum()&&this.AddEdge(e),i!=null)n.item=i,this.sideNodes.set(i,n);else{let o=this.activeSidesTree.deleteSubTree(n);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(i!=null){let o;(o=this.sideNodes.get(i))||(o=this.activeSidesTree.insert(i),this.sideNodes.set(i,o),o==this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind==0||this.visibilityKind==1&&vn.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,i)=>new ur(t,i))}static LineTouchesPolygon(e,t){let i=t.polyline.prev(t).point,n=t.polyline.next(t).point,o=t.point;return p.signedDoubledTriangleArea(e,o,i)*p.signedDoubledTriangleArea(e,o,n)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e==t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Eh,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new bt(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,i=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))i=!1;let n=e.next(t);if(i)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,n);n=e.next(n));this.visibleBoundaries.set(e,new tl(t,n))}HoleSideIsVisibleFromQ(e,t){return p.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-C.squareOfDistanceEpsilon}};var Gf=class{constructor(e,t){this.next=null;this.prev=null;this.PolylinePoint=e,this.OriginalPosition=t}get PolylinePoint(){return this.polylinePoint}set PolylinePoint(e){this.polylinePoint=e}get OriginalPosition(){return this.originalPosition}set OriginalPosition(e){this.originalPosition=e}get Next(){return this.next}set Next(e){this.next=e}get Prev(){return this.prev}set Prev(e){this.prev=e}};var Ge=class extends Ee{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=W.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}get Obstacles(){return this.obstacles_}set Obstacles(e){this.obstacles_=e}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(e){this.enteringAngleBound_=e}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(e){this._sourceTightPolyline=e}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(e){this.targetTightPolyline=e}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(e){this.targetLoosePolyline=e}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(e){this.visibilityGraph=e}get SourcePort(){return this.sourcePort}set SourcePort(e){if(this.sourcePort=e,this.sourcePort!=null)if(this.SourceTightPolyline=Ge.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Ci)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let t=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(t.Curve,t.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(e){this.targetPort=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=e)}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(e){this.startPointOfRouting_=e}ExtendVisibilityGraphToLocation(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new $e);let t=null;if(!this.activeRectangle.contains(e)){this.activeRectangle.isEmpty?this.activeRectangle=W.mkPP(this.SourcePort.Location,e):this.activeRectangle.add(e),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null||t.length==0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new so(t,this.activePolygons,this.VisibilityGraph).run(),eo(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(e){this.targetVV=vn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,e,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=vn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(e,t,i){let n=e.value(t),o=e.leftDerivative(t).normalize().add(e.rightDerivative(t).normalize()).normalize();p.getTriangleOrientation(Ge.PointInsideOfConvexCurve(e),n,n.add(o))==1&&(o=o.mul(-1)),o=o.rotate(Math.PI/2);let a=i.boundingBox.diagonal,l=B.mkPP(n,n.add(o.mul(a))),u=w.intersectionOne(l,i,!1).x,c=o.mul(u.sub(n).length/2);for(;;){l=B.mkPP(n,u.add(c));let h=!1;for(let d of Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(l,this.ObstacleCalculator.RootOfLooseHierarchy))if(d.seg1!=i){c=c.div(1.5),h=!0;break}if(!h)break}return l.end}static PointInsideOfConvexCurve(e){return e.value(0).add(e.value(1.5)).div(2)}*GetActivePolylines(){for(let e of this.activePolygons)yield e.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let e=this.activeRectangle,t=new Array,i;do{i=!1;for(let n of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(n)||(e.addRec(n.boundingBox),t.push(new Kt(n)),this.alreadyAddedOrExcludedPolylines.add(n),i=!0);i&&(this.activeRectangle=e)}while(i);return t}RelaxPolyline(){let e=Ge.CreateRelaxedPolylinePoints(this._polyline);for(e=e.Next;e.Next!=null;e=e.Next)this.RelaxPolylinePoint(e)}static CreateRelaxedPolylinePoints(e){let t=e.startPoint,i=new Gf(t,t.point),n=i;for(;t.next!=null;){t=t.next;let o=new Gf(t,t.point);o.Prev=n,n.Next=o,n=o}return i}RelaxPolylinePoint(e){if(!(e.PolylinePoint.prev.prev==null&&this.SourcePort instanceof Pr&&e.PolylinePoint.polyline!=this.SourceLoosePolyline)&&!(e.PolylinePoint.next.next==null&&this.TargetPort instanceof Pr&&e.PolylinePoint.polyline!=this.TargetLoosePolyline))for(let t=this.OffsetForPolylineRelaxing;t>C.distanceEpsilon&&!this.RelaxWithGivenOffset(t,e);)t/=2}RelaxWithGivenOffset(e,t){return Ge.SetRelaxedPointLocation(e,t),this.StickingSegmentDoesNotIntersectTightObstacles(t)?!0:(Ge.PullCloserRelaxedPoint(t.Prev),!1)}static PullCloserRelaxedPoint(e){e.PolylinePoint.point=e.OriginalPosition.mul(.2).add(e.PolylinePoint.point.mul(.8))}StickingSegmentDoesNotIntersectTightObstacles(e){return!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Prev.PolylinePoint.point)&&(e.Next==null||!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Next.PolylinePoint.point))}PolylineSegmentIntersectsTightHierarchy(e,t){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,i){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(B.mkPP(e,t),i)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t){if(!e.boundingBox.intersects(t.irect))return!1;if(t.UserData!=null){for(let i of w.getAllIntersections(e,t.UserData,!1))if(i.seg1!=this.SourceTightPolyline&&i.seg1!=this.TargetTightPolyline||(i.seg1==this.SourceTightPolyline&&this.SourcePort)instanceof Pr||(i.seg1==this.TargetTightPolyline&&this.TargetPort)instanceof Pr)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,t){let i=new Array;return Ge.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i),i}static IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i){if(t!=null&&!!e.boundingBox.intersects(t.irect)){if(t.UserData!=null){eo(i,w.getAllIntersections(e,t.UserData,!0));return}Ge.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Left,i),Ge.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Right,i)}}LineCanBeAcceptedForRouting(e){let t=this.SourcePort instanceof Ci,i=this.TargetPort instanceof Ci;if(!t&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.end,this.SourcePort)||!i&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.start,this.TargetPort))return!1;let n=Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy);for(let o of n)if(o.seg1!=this.SourceTightPolyline&&o.seg1!=this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(e,t){let i=t.Curve,n=Jt.CurveIsClockwise(i,Ge.PointInsideOfConvexCurve(i)),o=t.Location,a=this.GetPointOnTheRightBoundaryPortConeSide(o,i,n,t.Parameter),l=this.GetPointOnTheLeftBoundaryPortConeSide(o,i,n,t.Parameter);return p.getTriangleOrientation(o,a,e)!=0&&p.getTriangleOrientation(o,e,l)!=0}GetPointOnTheRightBoundaryPortConeSide(e,t,i,n){let o=i?t.rightDerivative(n):t.leftDerivative(n).neg();return e.add(o.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(e,t,i,n){let o=i?t.leftDerivative(n).neg():t.rightDerivative(n);return e.add(o.rotate(-this.EnteringAngleBound))}static SetRelaxedPointLocation(e,t){let i=p.getTriangleOrientation(t.Next.OriginalPosition,t.OriginalPosition,t.Prev.OriginalPosition)==1,n=t.Next.OriginalPosition.sub(t.Prev.OriginalPosition).normalize().mul(e).rotate(Math.PI/2);i||(n=n.neg()),t.PolylinePoint.point=t.OriginalPosition.add(n)}SmoothCorners(e){let t=e.headSite,i={b:null,c:null};for(;i=w.findCorner(t);)t=this.SmoothOneCorner(t,i.c,i.b)}SmoothOneCorner(e,t,i){let a=.5,l,u,c;e.prev==null?(c=2,u=1):t.next==null?(c=1,u=2):u=1,c=1;do l=w.createBezierSeg(a*c,a*u,e,i,t),i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u,a/=1.5;while(this.ObstacleCalculator.ObstaclesIntersectICurve(l)&&a>.01);return a*=1.5,a<.5&&a>.01&&(a=.5*(a+a*1.5),l=w.createBezierSeg(a*c,a*u,e,i,t),this.ObstacleCalculator.ObstaclesIntersectICurve(l)||(i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u)),i}TryToRemoveInflectionsAndCollinearSegments(e){let t=!0,i={s:null};for(;t;)for(t=!1,i.s=e.headSite;i.s!=null&&i.s.next!=null;i.s=i.s.next)i.s.turn*i.s.next.turn<0&&(t=this.TryToRemoveInflectionEdge(i)||t)}TryToRemoveInflectionEdge(e){if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.point)){let t=e.s.prev,i=e.s.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.next.point)){let t=e.s.prev,i=e.s.next.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.point,e.s.next.next.point)){let t=e.s.next.next;return e.s.next=t,t.prev=e.s,!0}return!1}GetShortestPolyline(e,t){this.CleanTheGraphForShortestPath();let n=new Bu(this.visibilityGraph,e,t).GetPath(this.UseEdgeLengthMultiplier);if(n==null)return null;let o=new te;for(let a of n)o.addPoint(a.point);return Ge.RemoveCollinearVertices(o)}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}static RemoveCollinearVertices(e){for(let t=e.startPoint.next;t.next!=null;t=t.next)p.getTriangleOrientation(t.prev.point,t.point,t.next.point)==2&&(t.prev.next=t.next,t.next.prev=t.prev);return e}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(e){this.ObstacleCalculator.RootOfTightHierarchy=e}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(e){this.ObstacleCalculator.RootOfLooseHierarchy=e}CalculateObstacles(){this.ObstacleCalculator=new Jt(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}RouteEdgeToLocation(e){this.TargetPort=new Ci(null,e),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let t=new We(null),i=B.mkPP(this.SourcePort.Location,e);return this.LineCanBeAcceptedForRouting(i)?(this._polyline=new te,this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=mt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):this.SourcePort instanceof Pr&&(i=B.mkPP(this.StartPointOfEdgeRouting,e),Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(i,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new te,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=mt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):(this.ExtendVisibilityGraphToLocation(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this.SourcePort instanceof Pr&&this._polyline.PrependPoint(this.SourcePort.Location),t.smoothedPolyline=mt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t)}RouteEdgeToPort(e,t,i,n){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),B.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=e,this.TargetTightPolyline=Ge.GetFirstHitPolyline(e.Location,this.ObstacleCalculator.RootOfTightHierarchy),e instanceof Pr?this.RouteEdgeToBoundaryPort(t,i,n):this.RouteEdgeToFloatingPortOfNode(t,i,n))}SmoothedPolylineFromTwoPoints(e,t){return this._polyline=new te,this._polyline.addPoint(e),this._polyline.addPoint(t),mt.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(e,t,i){return this.sourcePort instanceof Ci?this.RouteFromFloatingPortToFloatingPort(e,t,i):this.RouteFromBoundaryPortToFloatingPort(e,t,i)}RouteFromBoundaryPortToFloatingPort(e,t,i){let n=this.SourcePort.Location,o=this.targetPort.Location,a=B.mkPP(n,o);if(this.LineCanBeAcceptedForRouting(a))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a;if(!this.targetIsInsideOfSourceTightPolyline){let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(a=B.mkPP(u,o),this.LineAvoidsTightHierarchyLP(a,e))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let l=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=l,this.RelaxPolyline(),this._polyline.PrependPoint(n),this.SmoothCornersAndReturnCurve(t,i)}SmoothCornersAndReturnCurve(e,t){return t.smoothedPolyline=mt.mkFromPoints(this._polyline),e&&this.SmoothCorners(t.smoothedPolyline),t.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(e,t,i){let n=this.TargetPort.Location,o=B.mkPP(this.StartPointOfEdgeRouting,n);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(o,this.SourceTightPolyline,this.targetTightPolyline)?(i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),i.smoothedPolyline=mt.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(t,i)))}TryShortcutPolyline(){if(this.UseInnerPolylingShortcutting)for(;this.ShortcutPolylineOneTime(););this.UsePolylineEndShortcutting&&this.TryShortCutThePolylineEnds()}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let e=this._polyline.endPoint,t=e.prev;if(t==null)return;let i=t.prev;if(i==null)return;let n=p.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=_t.mkFromPoint(n);o.next=e,o.prev=i,e.prev=o,i.next=o}}TryShortcutPolylineStart(){let e=this._polyline.startPoint,t=e.next;if(t==null)return;let i=t.next;if(i==null)return;let n=p.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=_t.mkFromPoint(n);o.prev=e,o.next=i,e.next=o,i.prev=o}}ShortcutPolylineOneTime(){let e=!1;for(let t=this._polyline.startPoint;t.next!=null&&t.next.next!=null;t=t.next)e=e||this.TryShortcutPolyPoint(t);return e}TryShortcutPolyPoint(e){return this.LineAvoidsTightHierarchyLPP(B.mkPP(e.point,e.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(e.next=e.next.next,e.next.prev=e,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new $e);let t=null,i=this.targetPort.Location;if(!this.activeRectangle.contains(i)){this.activeRectangle.isEmpty?this.activeRectangle=W.mkPP(this.SourcePort.Location,i):this.activeRectangle.add(i),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new so(t,this.activePolygons,this.VisibilityGraph).run(),eo(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(e,t){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(e,t):this.targetVV=vn.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(t),this.VisibilityGraph,e,1)}AddTransientVisibilityEdgesForPort(e,t){let i=this.GetVertex(e);if(i!=null)return i;if(i=this.visibilityGraph.AddVertexP(e),t!=null)for(let n of t)this.visibilityGraph.AddEdgeF(e,n,(o,a)=>new ur(o,a));else i=vn.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,e,1);return i}GetVertex(e){let t=this.visibilityGraph.FindVertex(e);return t==null&&this.LookForRoundedVertices&&(t=this.visibilityGraph.FindVertex(C.RoundPoint(e))),t}*GetActivePolylinesWithException(e){for(let t of this.activePolygons)t.Polyline!=e&&(yield t.Polyline)}RouteEdgeToBoundaryPort(e,t,i){return this.TargetLoosePolyline=e,this.sourcePort instanceof Ci?this.RouteFromFloatingPortToBoundaryPort(t,i):this.RouteFromBoundaryPortToBoundaryPort(t,i)}RouteFromBoundaryPortToBoundaryPort(e,t){let i=this.SourcePort.Location,n,o=this.targetPort.Location,a=B.mkPP(i,o);if(this.LineCanBeAcceptedForRouting(a))this._polyline=new te,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),n=mt.mkFromPoints(this._polyline).createCurve();else{let l=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(a=B.mkPP(i,l),this.InsideOfTheAllowedConeOfBoundaryPort(l,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(a,this._sourceTightPolyline))this._polyline=new te,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(a=B.mkPP(this.StartPointOfEdgeRouting,o),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(a))this._polyline=new te,this._polyline.addPoint(i),this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),n=this.SmoothCornersAndReturnCurve(e,t);else{let u;if(u=B.IntersectPPPP(i,this.StartPointOfEdgeRouting,o,l))this._polyline=new te,this._polyline.addPoint(i),this._polyline.addPoint(u),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(p.closeDistEps(this.StartPointOfEdgeRouting,l))this._polyline=new te,this._polyline.addPoint(i),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(this.LineAvoidsTightHierarchy(B.mkPP(this.StartPointOfEdgeRouting,l)))this._polyline=new te,this._polyline.addPoint(i),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else{this.ExtendVisibilityGraphToTargetBoundaryPort(l),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let c={tmpTargetTight:null},h=this.HideSourceTargetTightsIfNeeded(c);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(h,c.tmpTargetTight),this.RelaxPolyline(),this._polyline.PrependPoint(i),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t)}}}return n}RecoverSourceTargetTights(e,t){this.SourceTightPolyline=e,this.TargetTightPolyline=t}HideSourceTargetTightsIfNeeded(e){let t=this.SourceTightPolyline;return e.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,t}LineAvoidsTightHierarchy(e){return Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy).length==0}RouteFromFloatingPortToBoundaryPort(e,t){let i=this.targetPort.Location,n;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(n=B.mkPP(this.SourcePort.Location,i),this.LineCanBeAcceptedForRouting(n)))return t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(n.start,n.end),n;let o=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(n=B.mkPP(this.SourcePort.Location,o),this.LineAvoidsTightHierarchyLP(n,this._sourceTightPolyline))return this._polyline=te.mkFromPoints([n.start,n.end,i]),t.smoothedPolyline=mt.mkFromPoints(this._polyline),t.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(o),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this._polyline.addPoint(i);let a={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(e,a)}LineAvoidsTightHierarchyLP(e,t){let i=!0;for(let n of Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(n.seg1!=t){i=!1;break}return i}LineAvoidsTightHierarchyLPP(e,t,i){let n=!0;for(let o of Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(!(o.seg1==t||o.seg1==i)){n=!1;break}return n}LineAvoidsTightHierarchyPPPP(e,t,i,n){return this.LineAvoidsTightHierarchyLPP(B.mkPP(e,t),i,n)}ExtendVisibilityGraphToTargetBoundaryPort(e){let t=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new $e),!this.activeRectangle.contains(e)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(e)):(this.activeRectangle.add(e),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new so(t,this.activePolygons,this.VisibilityGraph).run(),eo(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(e){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:Ge.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(e,t){let i=Ge.GetFirstHitRectangleNode(e,t);return i?i.UserData:null}static GetFirstHitRectangleNode(e,t){return t==null?null:t.FirstHitNodePF(e,(i,n)=>w.PointRelativeToCurveLocation(i,n)!=0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(e,t){this.SourceLoosePolyline=t,this.sourcePort=e,this.sourcePort!=null&&(this.SourceTightPolyline=Ge.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Ci?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new $e,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let t of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(t);let e;this.UseSpanner?e=new Gs(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):e=new so(new Array,this.activePolygons,this.visibilityGraph),e.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e,t,i,n){let o=e instanceof Ci&&t instanceof Pr||e instanceof Dt;if(o){let l=e;e=t,t=l}this.sourcePort=e,this.targetPort=t,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let a=this.GetEdgeGeomByRouting(i,n);return a==null?null:(this.targetVV=null,this.sourceVV=null,o&&(a=a.reverse()),a)}GetEdgeGeomByRouting(e,t){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||w.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)==2;let i;if(this.sourcePort instanceof Pr){let n=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?n.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(n.Curve,n.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let o={smoothedPolyline:null};this.targetPort instanceof Pr?i=this.RouteFromBoundaryPortToBoundaryPort(e,o):i=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,e,o)}else this.targetPort instanceof Ci?(this.ExtendVisibilityGraphFromFloatingSourcePort(),i=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,e,t)):i=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,e,t,this.targetPort);return i}RouteFromFloatingPortToAnywherePort(e,t,i,n){return n.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(e))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),this.FixLastPolylinePointForAnywherePort(n),n.HookSize>0&&this.BuildHook(n),this.SmoothCornersAndReturnCurve(t,i))):(i.smoothedPolyline=null,null)}BuildHook(e){let t=e.Curve,i=de.mkFullEllipseNNP(e.HookSize,e.HookSize,this._polyline.end),n=w.getAllIntersections(t,i,!0);p.getTriangleOrientation(n[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&n.reverse();let o=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),a=t.derivative(n[0].par0).normalize(),l=a.dot(o);if(Math.abs(l)<.2)this.ExtendPolyline(a,n[0],o,e);else{let u=t.derivative(n[1].par0).normalize();u.dot(o)<l?this.ExtendPolyline(u,n[1],o,e):this.ExtendPolyline(a,n[0],o,e)}}ExtendPolyline(e,t,i,n){let o=e.rotate(Math.PI/2);o.dot(i)<0&&(o=o.neg());let a=t.x.add(o.mul(n.HookSize)),l;!(l=p.lineLineIntersection(a,a.add(e),this._polyline.end,this._polyline.end.add(i)))||(this._polyline.addPoint(l),this._polyline.addPoint(a),this._polyline.addPoint(t.x))}FixLastPolylinePointForAnywherePort(e){for(;;){let t=this.GetLastPointInsideOfCurveOnPolyline(e.Curve);t.next.next=null,this._polyline.endPoint=t.next;let i=t.next.point.sub(t.point);i=i.normalize().mul(e.Curve.boundingBox.diagonal);let n=i.rotate(e.AdjustmentAngle*-1),o=i.rotate(e.AdjustmentAngle),a=w.intersectionOne(e.Curve,B.mkPP(t.point,t.point.add(n)),!0),l=w.intersectionOne(e.Curve,B.mkPP(t.point,t.point.add(o)),!0);if(a==null||l==null)return;let u=Ge.GetTrimmedCurveForHookingUpAnywhere(e.Curve,t,a,l),c=u.value(u.closestParameter(t.point));if(!this.LineAvoidsTightHierarchyLPP(B.mkPP(t.point,c),this.SourceTightPolyline,null)){let h=w.intersectionOne(e.Curve,B.mkPP(t.point,t.next.point),!1);if(h==null)return;this._polyline.endPoint.point=h.x;break}if(this._polyline.endPoint.point=c,t.prev==null||!this.TryShortcutPolyPoint(t.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(e,t,i,n){let o=p.getTriangleOrientation(n.x,i.x,t.point)==0,a=i.par0,l=n.par0,u,c,h;return o?a<l?e.trim(a,l):(c=e.trim(a,e.parEnd),u=e.trim(e.parStart,l),h=new w,h.addSegs([c,u])):l<a?e.trim(l,a):(c=e.trim(l,e.parEnd),u=e.trim(e.parStart,a),h=new w,h.addSegs([c,u]))}GetLastPointInsideOfCurveOnPolyline(e){for(let t=this._polyline.endPoint.prev;t!=null;t=t.prev)if(t.prev==null||w.PointRelativeToCurveLocation(t.point,e)==2)return t;throw new Error}GetShortestPolylineToMulitpleTargets(e,t){this.CleanTheGraphForShortestPath();let n=new Vs(e,t,this.VisibilityGraph).GetPath();if(n==null)return null;let o=new te;for(let a of n)o.addPoint(a.point);return Ge.RemoveCollinearVertices(o)}Targets(e){return Array.from(e).map(t=>this.visibilityGraph.FindVertex(t))}ExtendVisibilityGraphFromFloatingSourcePort(){let e=this.sourcePort;this.StartPointOfEdgeRouting=e.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=vn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(t=>t!=this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let e=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=Ge.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=Ge.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),e=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=Ge.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=Ge.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=W.mkPP(new p(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new p(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let e of this.ObstacleCalculator.LooseObstacles)yield new Kt(e)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(e){eo(this.activePolygons,e)}ClearActivePolygons(){this.activePolygons=[]}};var Tv=be(vs());var ao=class{constructor(){this.size_=0;this.mapOfMaps=new dt}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let i=e.first,n=e.second,o=this.mapOfMaps.get(i);o==null&&this.mapOfMaps.set(i,o=new dt),o.has(n)||this.size_++,o.set(n,t)}delete(e){let t=e.first,i=e.second,n=this.mapOfMaps.get(t);n!=null&&n.deleteP(i)&&this.size_--}has(e){let t=this.mapOfMaps.get(e.first);return t!=null&&t.has(e.second)}get_(e,t){return this.get(new Ct(e,t))}get(e){let t=this.mapOfMaps.get(e.first);if(t!=null)return t.get(e.second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new Ct(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[i,n]of t)yield[new Ct(e,i),n]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var Br=class{static GetShapes(e,t=Array.from(e.edges())){let i=new Map;ux(e,i);for(let n of t){let o=i.get(n.source);o&&n.sourcePort!=null&&o.Ports.add(n.sourcePort),o=i.get(n.target),o&&n.targetPort!=null&&o.Ports.add(n.targetPort)}return Array.from(i.values())}static CreateShapeWithCenterPort(e){let t=new Mu(()=>e.boundaryCurve),i=Ai.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);for(let n of e.inEdges())Br.FixPortAtTarget(i,n);for(let n of e.outEdges())Br.FixPortAtSource(i,n);for(let n of e.selfEdges())Br.FixPortAtSource(i,n),Br.FixPortAtTarget(i,n);return t}static CreateShapeWithClusterBoundaryPort(e){let t=new Mu(()=>e.boundaryCurve),i=br.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);let n;for(let o of e.inEdges())o.EdgeToAncestor()==2?(n==null&&(n=new Dt(()=>e.boundaryCurve)),o.targetPort=n):Br.FixPortAtTarget(i,o);for(let o of e.outEdges())o.EdgeToAncestor()==1?(n==null&&(n=new Dt(()=>e.boundaryCurve)),o.sourcePort=n):Br.FixPortAtSource(i,o);for(let o of e.selfEdges())Br.FixPortAtSource(i,o),Br.FixPortAtTarget(i,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function ux(s,e){for(let t of s.shallowNodes())if(t instanceof Re){let i=Br.CreateShapeWithClusterBoundaryPort(t);e.set(t,i);let n=t;if(!n.isCollapsed){ux(n,e);for(let o of n.shallowNodes())i.AddChild(e.get(o))}}else e.set(t,Br.CreateShapeWithCenterPort(t))}var $b=be(qi()),dx=be(zt());var cx=be(zt());var ks=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,i,n){let o=new ks(e);return o.Left=e,o.Right=t,o.Gap=i,o.IsEquality=n,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return cx.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t==0&&(t=this.Right.CompareTo(e.Right)),t==0&&(t=Ae(this.Gap,e.Gap)),t}};var hx=be(zt()),rl=class{static constructorDCVV(e,t,i,n){let o=new rl(t);return o.Set(e,t,i,n),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,i,n){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=i,this.VariableDoneEval=n,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval==this.ConstraintToEval.Right}toString(){return hx.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var fx=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Nu=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return dx.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new $b.Stack;let t=new ks(e);this.dfDvDummyParentNode=new rl(t);let i=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(i);;){let n=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!n.ChildrenHaveBeenPushed){n.ChildrenHaveBeenPushed=!0;for(let a of n.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!=n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Right,n.VariableToEval);a.Right.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of n.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!=n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Left,n.VariableToEval);a.Left.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(n),n==i)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,i,n){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,i,n):rl.constructorDCVV(e,t,i,n);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable==e.VariableToEval){for(;e.Parent!=this.dfDvDummyParentNode;)this.constraintPath.push(new fx(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let i=new Array;this.GetConnectedVariables(i,e.Right,e.Left);let n=e.Violation,o=i.length;for(let a=0;a<o;a++)i[a].OffsetInBlock=i[a].OffsetInBlock+n;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let i=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,n=this.Variables.length;for(let o=0;o<n;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<i&&(t=a,i=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Nu(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length==1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,i=e.OffsetInBlock/e.Scale,n=t*e.Weight;this.sumAd=this.sumAd+n*e.DesiredPos,this.sumAb=this.sumAb+n*i,this.sumA2=this.sumA2+n*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let i=0;i<t;i++){let n=this.Variables[i];n.ActualPos=(e+n.OffsetInBlock)/n.Scale}}GetConnectedVariables(e,t,i){this.RecurseGetConnectedVariables(e,t,i)}RecurseGetConnectedVariables(e,t,i){this.allConstraints.DfDvStack=new $b.Stack;let n=new ks(t);for(this.dfDvDummyParentNode=new rl(n),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,n,t,i)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!=o.VariableDoneEval&&(l.Right.ActiveConstraintCount==1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!=o.VariableDoneEval&&(l.Left.ActiveConstraintCount==1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,i){this.GetConnectedVariables(e.Variables,t,i);let n=e.Variables.length;for(let a=0;a<n;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block==e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length==0){for(let a=0;a<n;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var Zb=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var Qb=be(qi()),Kb=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new Qb.Stack;this.DfDvRecycleStack=new Qb.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var xh=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new Vf}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new xh;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},Vf=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new Vf;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var px=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},gx=class{constructor(e,t){this.Value=e,this.Column=t}},Qr=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!=0&&(this.newMatrixRow.push(new gx(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new px(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let i of this.matrixQ[t.Ordinal])i.Column==t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(i.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let i=0;i<t.length;i++)t[i].Column==e?t[i].Value=1:t[i].Value=t[i].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[i].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;Qr.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=Qr.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!=0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=Qr.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t==0)return!1;let i=e/t;Qr.VectorCopy(this.vectorPrevY,this.vectorCurY),Qr.VectorScaledVectorSubtract(this.vectorPrevY,i,this.gradientVector,this.vectorCurY);for(let n=0;n<this.vectorCurY.length;n++)this.vectorQpscVars[n].Variable.DesiredPos=this.vectorCurY[n];return!0}PostProject(){for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;Qr.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=Qr.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!=0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let i=Qr.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=i==0?1:e/i,t>1?t=1:t<0&&(t=0)}return Qr.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let i=this.previousFunctionValue-e,n=0;if(i!=0){let o=this.previousFunctionValue!=0?this.previousFunctionValue:e;n=Math.abs(i/o)}(Math.abs(i)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(n)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return Qr.VectorVectorMultiply(this.gradientVector,e)/2+Qr.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let i=0;for(let n=0;n<e.length;n++)i=i+e[n]*t[n];return i}MatrixVectorMultiply(e,t){let i=0;for(let n of this.matrixQ){let o=0;for(let a of n)o=o+a.Value*e[a.Column];t[i++]=o}}static VectorVectorAdd(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]+t[n]}static VectorVectorSubtract(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]-t[n]}static VectorScaledVectorSubtract(e,t,i,n){for(let o=0;o<e.length;o++)n[o]=e[o]-t*i[o]}static VectorCopy(e,t){for(let i=0;i<t.length;i++)e[i]=t[i]}};var Du=class{get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Du;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var mx=be(zt());var bx=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},Jb=class{constructor(e,t,i,n,o){this.ActiveConstraintCount=0;if(n<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=i*n;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=i*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=i,this.Weight=n,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new bx(e,t))}toString(){return mx.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return Ae(this.Ordinal,e.Ordinal)}};var Uf=class{get IsFull(){return this.numConstraints==Uf.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(Uf.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let i=this.numConstraints-1;i>=0;i--){let n=this.constraints[i];if(n.Left.Block==e||n.Right.Block==e||n.IsActive||n.IsUnsatisfiable)i<this.numConstraints-1&&(this.constraints[i]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints==0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let i=0;i<this.numConstraints;i++){let n=this.constraints[i],o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o>e&&(e=o,t=n)}return t}Insert(e,t){let i=0,n=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<n?(o=n,i=a,n=u):u<o&&(o=u)}this.IsFull?(this.constraints[i]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=n))}},kf=Uf;kf.MaxConstraints=20;var eP=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},tP=class{constructor(){this.allBlocks=new Zb;this.allConstraints=new Kb;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new kf;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new xh;this.solverSolution=new Du}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,i){return this.AddVariableANNN(e,t,i,1)}AddVariableANNN(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new Jb(this.nextVariableOrdinal++,e,t,i,n),a=new Nu(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new eP(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return to(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let i=t.Constraints.length;for(let n=0;n<i;n++){let o=t.Constraints[n];if(e==o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!0)}AddConstraintVVNB(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e==t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=ks.constructorVVNB(e,t,i,n);return this.loadedVariablesAndConstraintLists.set(e,new eP(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,n&&this.equalityConstraints.push(l),l}AddConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!1)}SetConstraintUpdate(e,t){t!=e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,i){if(i<=0||Number.isNaN(i)||!Number.isFinite(i))throw new Error("relationshipWeight");if(e==t)throw new Error;e.AddNeighbor(t,i),t.AddNeighbor(e,i),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.log2(this.numberOfVariables)+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.log2(this.numberOfConstraints)+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Du,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints==0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length==0)return;let e=this.IsQpsc;for(let[t,i]of this.updatedConstraints){let n=t;if(n.UpdateGap(i),!e&&!n.IsEquality){this.SplitOnConstraintIfActive(n);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),i=t.Constraints,n=0,o=0,a=0;i!=null&&(n=i.length,o=t.NumberOfLeftConstraints,a=n-o);let l=this.emptyConstraintList;o!=0&&(l=new Array(o));let u=this.emptyConstraintList;a!=0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<n;d++){let f=i[d];e==f.Left?l[c++]=f:u[h++]=f}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){let e;if(!this.RunProject(e))return;if(!this.SplitBlocks())break}}RunProject(e){return this.solverSolution.OuterProjectIterations++,e=this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let i=this.allBlocks.item(t),n=i.Variables.length;for(let o=0;o<n;o++){let a=i.Variables[o];this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue+a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue-2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new Qr(this.solverParams,this.numberOfVariables);for(let n of this.allBlocks.Vector)for(let o of n.Variables)e.AddVariable(o);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1,i=!1;for(;!(!e.PreProject()&&!t&&!i||(t=this.SplitBlocks(),!this.RunProject(i))||!e.PostProject()&&!t&&!i););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){let e;return this.RunProject(e)}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let i of t.Variables){i.Reinitialize();let n=new Nu(i,this.allConstraints);this.allBlocks.Add(n)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block==e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints==0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,i={maxViolation:0},n=this.GetMaxViolatedConstraint(i,e);if(!n)return!1;for(;n;){if(n.Left.Block==n.Right.Block?(n.Left.Block.Expand(n),n.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=n.Left.Block):this.lastModifiedBlock=this.MergeBlocks(n),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};n=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,i=e.Right.Block,n=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);i.Variables.length>t.Variables.length&&(t=e.Right.Block,i=e.Left.Block,n=n*-1);let o=i.Variables.length;for(let a=0;a<o;a++){let l=i.Variables[a];l.OffsetInBlock=l.OffsetInBlock+n,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(i),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let n=0;n<t;n++){let a=this.allBlocks.item(n).Split(this.IsQpsc);a!=null&&e.push(a)}let i=e.length;for(let n=0;n<i;n++){let o=e[n];this.allBlocks.Add(o)}return e.length!=0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let i=this.SearchViolationCache(e.maxViolation);return i!=null?i:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let i=this.lastModifiedBlock.Variables.length;for(let o=0;o<i;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);uf(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!=this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);uf(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let n=this.violationCache.FindIfGreater(e);return n!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=n),t}SearchAllConstraints(e,t){let i=null;this.violationCache.Clear();for(let n of this.allConstraints.Vector){if(n.IsActive)break;if(n.IsUnsatisfiable)continue;let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale),a=null,l=0;uf(o,e)&&(e>this.violationCache.LowViolation&&(a=i,l=e),e=o,i=n),t&&(a==null&&n!=i&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=n,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return i}};var Hf=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,i){this.variables.set(e,this.solver.AddVariableANN(e,t,i))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,i,n){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,i,n)}AddLeftRightSeparationConstraintNNN(e,t,i){this.AddLeftRightSeparationConstraintNNNB(e,t,i,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,i){let n=this.GetVariable(e);if(n==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(n,o,i)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let i;do{this.solution=null;let n=null;if(e!=null&&(n=e,n==null))throw new Error("parameters");this.solution=this.solver.SolvePar(n),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,i=this.AdjustConstraintsForMovedFixedVars()}while(i&&this.solution.ExecutionLimitExceeded==!1);return this.solution.ExecutionLimitExceeded==!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,i]of this.fixedVars.entries())Hf.Close(i,this.GetVariableResolvedPosition(t))||e.add(t);return e.size==0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let i of e){t=i;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let i={successInAdjusting:!1},n=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,i);if(!i.successInAdjusting||n.length==0)return!1;for(let o of n)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let i=this.variables.get(e).Block.Variables,n=new Rr,o=new Rr,a=1;for(let l of i)!this.fixedVars.has(l.UserData)||(n.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,n.length/o.length)));return a==1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(i,a),i.map(l=>l.UserData)}FixActiveConstraints(e,t){let i=!1;for(let n of e)for(let o of n.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(i=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return i}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new tP,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,Hf.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},zf=Hf;zf.FixedVarWeight=1e9;var rP=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var iP=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new zf;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let i=this.Var(t);i.LowBound=Math.max(e,i.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let i=this.Var(e);i.UpperBound=Math.min(t,i.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!=Number.NEGATIVE_INFINITY&&this.constraints.add(new ge(this.GetBoundId(t.LowBound),e)),t.UpperBound!=Number.POSITIVE_INFINITY&&this.constraints.add(new ge(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!=Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!=Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=Lr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=Ei.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new ge(e,t))}AddVariableNNNN(e,t,i,n){this.idealPositions.set(e,i),this.AddVariableNNBN(e,t,!1,n)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,i,n){let o=new rP;o.Position=t,o.IsFixed=i,o.Width=n,this.varList.push(o)}};var Px=be(vs());var nP=class extends ci{constructor(e,t){super(e,t);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=H.DirectionFromPointToPoint(e.point,t.point)}AddRightNeighbor(e){this.RightNeighbors.add(e)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(e){this.setOfLongestSegs.add(e)}BoundFromRight(e){e=Math.max(e,this.LeftBound),this.RightBound=Math.min(e,this.RightBound)}BoundFromLeft(e){e=Math.min(e,this.RightBound),this.LeftBound=Math.max(e,this.LeftBound)}};var hi=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,i){for(t--;e<t;t--)this.SetNewNext(i[t])}InsertVertsInReverse(e,t,i){for(e++;e<t;e++)this.SetNewNext(i[e])}SetNewNext(e){let t=new hi(e),i=this.Next;this.Next=t,t.Next=i}};var Fu=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return ae(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return Fu.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?H.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var Nr=class{constructor(e){this.pathVisibilityGraph=new $e;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(n(),e.Width),i=t.next();for(i.done||e.SetFirstEdge(i.value);(i=t.next()).done==!1;)e.AddEdge(i.value);function*n(){if(e.PathPoints instanceof hi)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let i=e.next(),n=i.value;for(;!(i=e.next()).done;)yield this.CreatePathEdge(n,i.value,t),n=i.value}CreatePathEdge(e,t,i){switch(H.DirectionFromPointToPoint(e,t)){case 2:case 1:return new Fu(this.GetAxisEdge(e,t),i);case 4:case 8:{let o=new Fu(this.GetAxisEdge(t,e),i);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(i,n)=>new nP(i,n))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of Nr.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(Nr.CompareTwoPathEdges);let i=0;for(let n of t)n.Index=i++}static CompareTwoPathEdges(e,t){if(e==t)return 0;let i=Nr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return i!=0?i:-Nr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,H.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,i,n){for(;;){if(e=Nr.GetNextPathEdgeInDirection(e,i,n),e==null||(t=Nr.GetNextPathEdgeInDirection(t,i,n),t==null))return 0;if(e.AxisEdge==t.AxisEdge){n=Nr.FindContinuedDirection(i,n,e.AxisEdge),i=e.AxisEdge;let c=Nr.GetExistingOrder(e,t);if(c==Nr.NotOrdered)continue;return n==i.Direction?c:-c}let o=n==i.Direction?i.Target:i.Source,a=Nr.OtherVertex(e.AxisEdge,o),l=Nr.OtherVertex(t.AxisEdge,o),u=Nr.ProjectionForCompare(i,n!=i.Direction);return Ae(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,i){return e.Direction==t?i.Source==e.Target?i.Direction:H.OppositeDir(i.Direction):i.Source==e.Source?i.Direction:H.OppositeDir(i.Direction)}static OtherVertex(e,t){return e.Source==t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction==1?t?i=>-i.x:i=>i.x:t?i=>i.y:i=>-i.y}static GetNextPathEdgeInDirection(e,t,i){return t.Direction==i?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let i=e.Index;if(i==-1)return Nr.NotOrdered;let n=t.Index;return Ae(i,n)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,i){for(let n of i.Vertices()){let o=n.InEdgesLength();t.set(n,o),o==0&&e.enqueue(n)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new Px.Queue,i=new Map;for(Nr.InitQueueOfSources(t,i,e);t.length>0;){let n=t.dequeue();for(let o of n.OutEdges){let a=i.get(o.Target);i.set(o.Target,a-1),a==1&&t.enqueue(o.Target),yield o}}}},Wf=Nr;Wf.NotOrdered=Number.MAX_VALUE;var oP=class extends Qt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var jf=class extends Qt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var sP=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size==0}};var Us=class extends bh{constructor(e,t,i,n,o){super(t,new H(e).ToPoint());this.DirectionPerp=new H(e).Right.ToPoint(),this.PathOrders=n,this.xProjection=e==1?a=>a.x:a=>-a.y,this.edgeContainersTree=new bt((a,l)=>this.CompareAA(a,l)),this.SweepPole=H.VectorDirection(this.SweepDirection),this.AxisEdges=o,this.AxisEdgesToObstaclesTheyOriginatedFrom=i}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(e){e instanceof Ti?this.ProcessVertexEvent(e):(this.Z=this.GetZP(e.Site),e instanceof jf?this.ProcessLowEdgeEvent(e):this.ProcessHighEdgeEvent(e))}ProcessHighEdgeEvent(e){let t=e.AxisEdge;this.RemoveEdge(t),this.ConstraintEdgeWithObstaclesAtZ(t,t.Target.point)}ProcessLowEdgeEvent(e){let t=e.AxisEdge,i=this.GetOrCreateAxisEdgesContainer(t);i.item.AddEdge(t);let n=this.edgeContainersTree.previous(i);if(n!=null)for(let a of n.item.edges)for(let l of i.item.edges)this.TryToAddRightNeighbor(a,l);let o=this.edgeContainersTree.next(i);if(o!=null)for(let a of i.item.Edges)for(let l of o.item.edges)this.TryToAddRightNeighbor(a,l);this.ConstraintEdgeWithObstaclesAtZ(t,t.Source.point)}TryToAddRightNeighbor(e,t){this.ProjectionsOfEdgesOverlap(e,t)&&e.AddRightNeighbor(t)}ProjectionsOfEdgesOverlap(e,t){return this.SweepPole==1?!(e.TargetPoint.y<t.SourcePoint.y-C.distanceEpsilon||t.TargetPoint.y<e.SourcePoint.y-C.distanceEpsilon):!(e.TargetPoint.x<t.SourcePoint.x-C.distanceEpsilon||t.TargetPoint.x<e.SourcePoint.x-C.distanceEpsilon)}GetObstacleBoundaries(e){return this.Obstacles.map(t=>fe.mkDebugCurveWCI(1,e,t))}ConstraintEdgeWithObstaclesAtZ(e,t){this.ConstraintEdgeWithObstaclesAtZFromLeft(e,t),this.ConstraintEdgeWithObstaclesAtZFromRight(e,t)}ConstraintEdgeWithObstaclesAtZFromRight(e,t){let i=this.GetActiveSideFromRight(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromRight(n.dot(this.DirectionPerp))}GetActiveSideFromRight(e){return this.LeftObstacleSideTree.findFirst(t=>Us.PointToTheLeftOfLineOrOnLineLocal(e,t.Start,t.End))}ConstraintEdgeWithObstaclesAtZFromLeft(e,t){let i=this.GetActiveSideFromLeft(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromLeft(n.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(e,t,i){return p.signedDoubledTriangleArea(e,t,i)>-Us.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(e,t,i){return p.signedDoubledTriangleArea(t,i,e)<Us.AreaComparisonEpsilon}GetActiveSideFromLeft(e){return this.RightObstacleSideTree.findLast(t=>Us.PointToTheRightOfLineOrOnLineLocal(e,t.Start,t.End))}static EdgeMidPoint(e){return p.middle(e.SourcePoint,e.TargetPoint)}GetOrCreateAxisEdgesContainer(e){let t=e.Source.point,i=this.GetAxisEdgesContainerNode(t);return i!=null?i:this.edgeContainersTree.insert(new sP(t))}GetAxisEdgesContainerNode(e){let t=this.xProjection(e),i=this.edgeContainersTree.findFirst(n=>this.xProjection(n.Source)>=t-C.distanceEpsilon/2);return i!=null&&this.xProjection(i.item.Source)<=t+C.distanceEpsilon/2?i:null}ProcessVertexEvent(e){this.Z=this.GetZS(e),e instanceof no?this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline):e instanceof oo?this.ProcessRightVertex(e,e.Vertex.prevOnPolyline):(this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline),this.ProcessRightVertex(e,e.Vertex.prevOnPolyline))}ProcessRightVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForRightVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=C.distanceEpsilon?o>0&&a>=0?this.EnqueueEvent(new oo(t)):this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex):(this.InsertRightSide(new Xo(e.Vertex)),this.EnqueueEvent(new oo(t)),this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex))}RestrictEdgeContainerToTheRightOfEvent(e){let t=e.point,i=this.xProjection(t),n=this.edgeContainersTree.findFirst(o=>i<=this.xProjection(o.Source));if(n!=null)for(let o of n.item.Edges)this.NotRestricting(o,e.polyline)||o.BoundFromLeft(this.DirectionPerp.dot(t))}NotRestricting(e,t){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(e)==t}ProcessPrevSegmentForRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;t.sub(i).dot(this.SweepDirection)>C.distanceEpsilon&&this.RemoveRightSide(new Xo(e.Vertex.nextOnPolyline))}RemoveEdge(e){let t=this.GetAxisEdgesContainerNode(e.Source.point);t.item.RemoveAxis(e),t.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(t)}ProcessLeftVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForLeftVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=C.distanceEpsilon?o<0&&a>=0&&this.EnqueueEvent(new no(t)):(this.InsertLeftSide(new qo(e.Vertex)),this.EnqueueEvent(new no(t))),this.RestrictEdgeFromTheLeftOfEvent(e.Vertex)}RestrictEdgeFromTheLeftOfEvent(e){let t=e.point,i=this.GetContainerNodeToTheLeftOfEvent(t);if(i!=null)for(let n of i.item.Edges)this.NotRestricting(n,e.polyline)||n.BoundFromRight(t.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(e){let t=this.xProjection(e);return this.edgeContainersTree.findLast(i=>this.xProjection(i.Source)<=t)}ProcessPrevSegmentForLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;t.sub(i).dot(this.SweepDirection)>C.distanceEpsilon&&this.RemoveLeftSide(new qo(e.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let e of this.AxisEdges)this.EnqueueEventsForEdge(e)}EnqueueEventsForEdge(e){this.EdgeIsParallelToSweepDir(e)&&(this.EnqueueEvent(Us.EdgeLowPointEvent(e,e.Source.point)),this.EnqueueEvent(Us.EdgeHighPointEvent(e,e.Target.point)))}EdgeIsParallelToSweepDir(e){return e.Direction==this.SweepPole||e.Direction==H.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(e,t){return new oP(e,t)}static EdgeLowPointEvent(e,t){return new jf(e,t)}CompareAA(e,t){return Ae(e.Source.dot(this.DirectionPerp),t.Source.dot(this.DirectionPerp))}},qf=Us;qf.AreaComparisonEpsilon=C.intersectionEpsilon;var aP=class extends Ka{constructor(e){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=e}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(e){if(this.Edges.length==0){let t=H.VectorDirectionPP(e.Source,e.Target);switch(t){case 4:t=1;break;case 8:t=2;break}this.CompassDirection=t,this.start=e.Source,this.end=e.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(e.Source),this.TryPointForStartAndEndNorth(e.Target);break;case 2:this.TryPointForStartAndEndEast(e.Source),this.TryPointForStartAndEndEast(e.Target);break}this.Edges.push(e)}TryPointForStartAndEndNorth(e){e.y<this.start.y?this.start=e:e.y>this.end.y&&(this.end=e)}TryPointForStartAndEndEast(e){e.x<this.start.x?this.start=e:e.x>this.end.x&&(this.end=e)}get IsFixed(){return this._isFixed}set IsFixed(e){this._isFixed=e}get Width(){let e=0;for(let t of this.edges)e=Math.max(e,t.Width);return e}GetLeftBound(){if(!this.IsFixed){let e=Number.NEGATIVE_INFINITY;for(let t of this.edges)e=Math.max(e,t.AxisEdge.LeftBound);return e}return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let e=Number.POSITIVE_INFINITY;for(let t of this.edges)e=Math.min(e,t.AxisEdge.RightBound);return e}return this.Position()}Position(){return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var Xi=class{constructor(e,t){this.tree=new bt((e,t)=>Ae(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length==0||this.HorizontalPoints.length==0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){ae(e.Next.Point.x,e.Point.x)?t==Xi.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,i,n,o=e.Y;if(e.Point.x<e.Next.Point.x?(i=e.Point.x,t=e.Next.Point.x,n=!0):(t=e.Point.x,i=e.Next.Point.x,n=!1),n)for(let a=this.tree.findFirst(l=>i<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new p(a.item.Point.x,o);e=Xi.TrySplitHorizontalPoint(e,l,!0),Xi.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=i;a=this.tree.previous(a)){let l=new p(a.item.Point.x,o);e=Xi.TrySplitHorizontalPoint(e,l,!1),Xi.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){Xi.Low(e)+C.distanceEpsilon<t.y&&t.y+C.distanceEpsilon<Xi.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,i){return i&&e.X+C.distanceEpsilon<t.x&&t.x+C.distanceEpsilon<e.Next.X||!i&&e.Next.X+C.distanceEpsilon<t.x&&t.x+C.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new yr(Ae);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,Xi.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var zs=class{constructor(e){this.verticesToPathOffsets=new dt;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,i=null;for(let n=e.PathPoints;n!=null;n=n.Next){let o=this.verticesToPathOffsets.get(n.Point);if(i!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,n),t.delete(a))}for(let[a,l]of i)o.has(a)||t.set(a,l)}i=o}}CollapseLoopingPath(e,t,i,n,o){let a=zs.FindLinkedPointInPath(n,t.Point),l=Array.from(zs.GetPointsInBetween(a,o));zs.Before(t,i)?(this.CleanDisappearedPiece(t,i,e),this.ReplacePiece(t,i,l,e)):(this.CleanDisappearedPiece(i,t,e),this.ReplacePiece(i,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let i=e.Next;i!=t;i=i.Next)yield i.Point}ReplacePiece(e,t,i,n){let o=e;for(let a of i){let l=new hi(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(n,o)}o.Next=t}CleanDisappearedPiece(e,t,i){for(let n of zs.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(n).delete(i)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e==t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let i=e.PathPoints;;i=i.Next)if(i.Point.equal(t))return i}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let i=this.verticesToPathOffsets.get(t.Point);i||this.verticesToPathOffsets.set(t.Point,i=new Map);let n=i.get(e);n?(this.CleanDisappearedPiece(n,t,e),n.Next=t.Next):i.set(e,t)}}};var lP=class{constructor(e){this.projection=e}compare(e,t){return Ae(this.projection(e),this.projection(t))}};var yx=be(dh()),cr=class{static RefinePaths(e,t){cr.AdjustPaths(e);let i=cr.CreatePathsToFirstLinkedVerticesMap(e);cr.Refine(Array.from(i.values())),cr.CrossVerticalAndHorizontalSegs(i.values()),cr.ReconstructPathsFromLinkedVertices(i),t&&new zs(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=cr.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length==0)return;let t=[],i=C.RoundPoint(e[0]);t.push(i);for(let n=1;n<e.length;n++){let o=C.RoundPoint(e[n]);i.equal(o)||(i=o,t.push(i))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,i=new Array;for(let n of e)for(let o=n;o.Next!=null;o=o.Next)ae(o.Point.x,o.Next.Point.x)?i.push(o):t.push(o);new Xi(t,i).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,i]of e)t.PathPoints=i}static Refine(e){cr.RefineInDirection(1,e),cr.RefineInDirection(2,e)}static*groupByProj(e,t){let i=new Map;for(let n of t){let o=e(n.Point),a=i.get(o);a||(a=new Array,i.set(o,a)),a.push(n)}for(let n of i.values())yield n}static RefineInDirection(e,t){let i={projectionToPerp:void 0,projectionToDirection:void 0};cr.GetProjectionsDelegates(e,i);let n=Array.from(cr.GetAllLinkedVertsInDirection(i.projectionToPerp,t)),o=cr.groupByProj(i.projectionToPerp,n);for(let a of o)cr.RefineCollinearBucket(a,i.projectionToDirection)}static GetProjectionsDelegates(e,t){e==2?(t.projectionToDirection=i=>i.x,t.projectionToPerp=i=>i.y):(t.projectionToPerp=i=>i.x,t.projectionToDirection=i=>i.y)}static*GetAllLinkedVertsInDirection(e,t){for(let i of t)for(let n=i;n.Next!=null;n=n.Next)ae(e(n.Point),e(n.Next.Point))&&(yield n)}static RefineCollinearBucket(e,t){let i=new yx.SortedMap(new lP(t));for(let a of e)i.has(a.Point)||i.set(a.Point,0),i.has(a.Next.Point)||i.set(a.Next.Point,0);let n=new Array(i.size),o=0;for(let a of i.keys())n[o++]=a;for(o=0;o<n.length;o++)i.set(n[o],o);for(let a of e){o=i.get(a.Point);let l=i.get(a.Next.Point);Math.abs(l-o)>1&&cr.InsertPoints(a,n,o,l)}}static InsertPoints(e,t,i,n){i<n?e.InsertVerts(i,n,t):e.InsertVertsInReverse(n,i,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let i of e)t.set(i,cr.CreateLinkedVertexOfEdgePath(i));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,i=new hi(t[0]),n=i;for(let o=1;o<t.length;o++)i.Next=new hi(t[o]),i=i.Next;return n}};var $o=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I==t.I&&e.Points==t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var Zo=class{constructor(e,t){this.segTree=new Ma(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new Ma(t),this.Paths=e}static RemoveStaircases(e,t){new Zo(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(i=>!this.crossedOutPaths.has(i)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new $o(e.pts,0),new $o(e.pts,1),new $o(e.pts,2),new $o(e.pts,3)],i=0;for(let n=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,n,t,o))return e.canHaveStaircase=!0,n;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,n++,e.pts.length<n+5)return-1;t[i]=new $o(e.pts,n+3),i++,i%=4}}static GetFlippedPoint(e,t){return ae(e[t].y,e[t+1].y)?new p(e[t+4].x,e[t].y):new p(e[t].x,e[t+4].y)}Crossing(e,t,i){return Zo.IsCrossing(B.mkPP(e,t),this.segTree,i)}static IsCrossing(e,t,i){for(let n of t.GetAllIntersecting(e.boundingBox))if(i.findIndex(o=>o==n)==-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,i){return this.IntersectObstacleHierarchyL(B.mkPP(e,t))||this.IntersectObstacleHierarchyL(B.mkPP(t,i))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>w.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,i,n){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return n.canHaveStaircaseAtI=!1,H.DirectionFromPointToPoint(o,a)!=H.DirectionFromPointToPoint(l,u)||H.DirectionFromPointToPoint(a,l)!=H.DirectionFromPointToPoint(u,c)||(l=Zo.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(n.canHaveStaircaseAtI=!0,!this.Crossing(a,l,i))}RemoveStaircasePN(e,t){let i=e[t],n=e[t+1],o=Math.abs(i.y-n.y)<C.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,i){this.RemoveSegs(e);let n=new Array(e.length-2);s2(e,n,t+1);let o=e[t+1],a=e[t+3];return n[t+1]=i?new p(a.x,o.y):new p(o.x,a.y),o2(e,t+4,n,t+2,n.length-t-2),this.InsertNewSegs(n,t),n}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new $o(e,t))}RemoveSeg(e){this.segTree.Remove(Zo.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let i=new $o(e,t);this.segTree.Add(Zo.Rect(i),i)}static Rect(e){return W.mkPP(e.Start,e.End)}};function o2(s,e,t,i,n){for(;n-- >0;)t[i++]=s[e++]}function s2(s,e,t){let i=0;for(;t-- >0;)e[i++]=s[i++]}var ut=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,i,n){this.AncestorsSets=n,this.HierarchyOfGroups=Qe(Array.from(n.keys()).filter(o=>o.IsGroup).map(o=>ct(o,o.BoundingBox))),this.Obstacles=i,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=Qe(i.map(o=>ct(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length==0)return;let t=e.PathPoints,i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],ut.ObstacleTest),n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],ut.ObstacleTest);i!=null&&n!=null&&this.PathToObstacles.set(e,[i.UserData,n.UserData])}static ObstacleTest(e,t){return w.PointRelativeToCurveLocation(e,t)!=0?1:0}Calculate(e,t){this.NudgingDirection=e,cr.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let i=this.FindLastUnmappedEdge(e);for(let n=t;n!=null&&n!=i;n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(n.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.LastEdge;i!=null&&H.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.FirstEdge;i!=null&&H.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new Wf(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let i=new Array;for(let n of e){let o=new te;for(let a of n.PathPoints)o.addPoint(a);i.push(o)}return i.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)ut.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let i=e.LastEdge;i.Width=Math.max(t.targetArrowhead.width,i.Width)}if(t.sourceArrowhead!=null){let i=e.FirstEdge;i.Width=Math.max(t.sourceArrowhead.width,i.Width)}}PositionShiftedEdges(){this.Solver=new iP(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];ut.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),i=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>i&&(e.IdealPosition=i)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return ut.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x==t.x||e.y==t.y)return t;let i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i<n?new p(e.x,t.y):new p(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],i=e.FirstEdge;t.push(this.ShiftedPoint(i.Source,i.LongestNudgedSegment));for(let n of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(n));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let i=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection==1?new p(i,e.y):new p(e.x,-i)}static LineSegOfLongestSeg(e,t){let i=t==2?o=>o.x:o=>o.y,n={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)ut.UpdateMinMaxWithPoint(n,i,o.Source),ut.UpdateMinMaxWithPoint(n,i,o.Target);return t==2?new B(n.min,-e.IdealPosition,n.max,-e.IdealPosition):new B(e.IdealPosition,n.min,e.IdealPosition,n.max)}static UpdateMinMaxWithPoint(e,t,i){let n=t(i);e.min>n&&(e.min=n),e.max<n&&(e.max=n)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let i of e.Edges){let n=i.AxisEdge;if(n!=null)for(let o of n.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let i of t)this.ConstraintTwoLongestSegs(e,i)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)ut.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return ae(e.SourcePoint.x,e.TargetPoint.x);default:return ae(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let i of e.filter(n=>n.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,i.LongestNudgedSegment),t=i}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,ut.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),i=e.GetRightBound();t>=i?(this.Solver.AddFixedVariable(e.Id,ut.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,ut.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!=Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),i!=Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,i))}}static SegmentPosition(e,t){return t==1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new qf(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let i=t.BoundingBox;for(let n of e.PathEdges()){let o=n.AxisEdge;o.Direction==this.NudgingDirection&&this.BoundAxisEdgeByRect(i,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=ut.MapPortsToShapes(this.AncestorsSets.keys()));let t=a2(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(i=>!i.Children.some(n=>t.has(n)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(W.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection==2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),ut.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let i=null,n=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(i=a.LongestNudgedSegment,n!=null){let l;ut.SetIdealPositionForSeg(n,l=t(n.start),o,t(i.Start)),o=l,n=null}}else i!=null&&(n=i,i=null);n!=null?ut.SetIdealPositionForSeg(n,t(n.Start),o,t(e.End)):i!=null&&(i.IdealPosition=t(i.Start))}static SetIdealPositionForSeg(e,t,i,n){let o=Math.max(i,n),a=Math.min(i,n);a+C.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,i=H.OppositeDir(this.NudgingDirection);for(let n of e.PathEdges()){let o=n.Direction;o==this.NudgingDirection||o==i?(t==null?(n.LongestNudgedSegment=t=new aP(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):n.LongestNudgedSegment=t,n.IsFixed&&(t.IsFixed=!0)):(n.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(i=>i.clone())};return ut.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){ut.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),ut.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let i=e.points.length-1,n=H.VectorDirectionPP(e.points[i-1],e.points[i]);if(ut.ProjectionsAreClose(e.points[i-1],n,t)){e.points=e.points.slice(0,i);return}let o=e.points[i];n==2||n==8?e.points[i]=new p(t.x,o.y):e.points[i]=new p(o.x,t.y)}static ProjectionsAreClose(e,t,i){return t==2||t==8?ae(e.x,i.x):ae(e.y,i.y)}static ExtendPolylineToSourcePort(e,t){let i=H.VectorDirectionPP(e.points[0],e.points[1]);if(ut.ProjectionsAreClose(e.points[1],i,t)){e.points=e.points.slice(1);return}let n=e.points[0];i==2||i==8?e.points[0]=new p(t.x,n.y):e.points[0]=new p(n.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],i=e[0];t.push(i);let n=e[1],o=H.VectorDirectionPP(i,n),a=1;for(;++a<e.length;){let l=H.VectorDirectionPP(n,e[a]);l==o||H.OppositeDir(l)==o||l==0||(p.closeDistEps(i,n)||t.push(i=ut.Rectilinearise(i,n)),o=l),n=e[a]}return p.closeDistEps(i,n)||t.push(ut.Rectilinearise(i,n)),t}static NudgePaths(e,t,i,n,o){if(e.length==0)return;let a=new ut(e,t,i,n);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=te.mkFromPoints(ut.BuildPolylineForPath(l))}RemoveStaircases(){Zo.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let i of e)for(let n of i.Ports)t.set(n,i);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,i,n){let o=n.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield fe.mkDebugCurveTWCI(200,e+l*u,i,B.mkPP(o[u],o[u+1]))}};function a2(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}var Sx=be(zt());var uP=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var Qo=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new uP(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:V.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,i=0,n=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;i<t||o<n;){if(i>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=n){a.push(this.ListOfPointsAndCrossings[i++]);continue}let l=this.ListOfPointsAndCrossings[i],u=e.ListOfPointsAndCrossings[o],c=V.ComparePP(l.Location,u.Location);c==0?(a.push(l),++i,++o):c==-1?(a.push(l),++i):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length==0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(i=>V.ComparePP(i.Location,e)>=0&&V.ComparePP(i.Location,t)<=0))}static ToCrossingArray(e,t){let i=0,n=e.length;for(let l=0;l<n;l++)e[l].DirectionToInside==t&&i++;if(i==0)return null;let o=new Array(i),a=0;for(let l=0;l<n;l++)e[l].DirectionToInside==t&&(o[a++]=e[l]);return o}ToString(){return Sx.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var K=class{static EdgeDirectionVE(e){return K.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return V.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let i=K.EdgeDirectionVE(e);return t==i?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let i of e.InEdges)if(V.GetDirections(e.point,i.SourcePoint)==t)return i.Source;for(let i of e.OutEdges)if(V.GetDirections(e.point,i.TargetPoint)==t)return i.Target;return null}static FindAdjacentEdge(e,t){for(let i of e.InEdges)if(V.GetDirections(i.SourcePoint,e.point)==t)return i;for(let i of e.OutEdges)if(V.GetDirections(e.point,i.TargetPoint)==t)return i;return null}static FindBendPointBetween(e,t,i){return K.IsVerticalD(i)?new p(t.x,e.y):new p(e.x,t.y)}static SegmentIntersectionPPP(e,t,i){let n=V.GetDirections(e,t);return K.IsVerticalD(n)?new p(e.x,i.y):new p(i.x,e.y)}static SegmentIntersectionSP(e,t){return K.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return K.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return K.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return K.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,i,n){return K.IntervalsAreCollinear(e,t,i,n)&&V.ComparePP(e,n)!=V.ComparePP(t,i)}static IntervalsAreCollinear(e,t,i,n){let o=K.IsVerticalPP(e,t);return K.IsVerticalPP(i,n)==o?o?V.Equal(e.x,i.x):V.Equal(e.y,i.y):!1}static IntervalsAreSame(e,t,i,n){return V.EqualPP(e,i)&&V.EqualPP(t,n)}static IntervalsIntersect(e,t,i,n){let o=K.SegmentIntersectionPPP(e,t,i);return K.PointIsOnSegmentPPP(e,t,o)&&K.PointIsOnSegmentPPP(i,n,o)?o:void 0}static SegmentIntersectionEP(e,t){return K.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,i){return V.EqualPP(e,i)||V.EqualPP(t,i)||V.GetDirections(e,i)==V.GetDirections(i,t)}static PointIsOnSegmentSP(e,t){return K.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!=0}static IsVerticalE(e){return K.IsVerticalD(V.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return K.IsVerticalD(V.GetDirections(e,t))}static IsVertical(e){return K.IsVerticalD(V.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!=0}static Slope(e,t,i){let n=t.sub(e);return n.dot(i.PerpDirectionAsPoint)/n.dot(i.DirectionAsPoint)}static SortAscending(e,t){let i=V.GetDirections(e,t);return 0==i||K.IsAscending(i)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,i){switch(i){case 1:case 4:return new p(t.x,K.GetRectangleBound(e,i));case 2:case 8:return new p(K.GetRectangleBound(e,i),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return V.Compare(e.bottom,t.top)<0&&V.Compare(t.bottom,e.top)<0&&V.Compare(e.left,t.right)<0&&V.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return V.Compare(e.y,t.top)<0&&V.Compare(t.bottom,e.y)<0&&V.Compare(e.x,t.right)<0&&V.Compare(t.left,e.x)<0}};var Hs=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=H.toPoint(this.Dir),this.PerpDirection=1==e?2:1,this.PerpDirectionAsPoint=H.toPoint(this.PerpDirection),this.OppositeDirection=H.OppositeDir(e)}get IsHorizontal(){return 2==this.Dir}get IsVertical(){return 1==this.Dir}Compare(e,t){let i=this.ComparePerpCoord(e,t);return i!=0?i:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return V.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return V.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return V.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return V.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?Hs.VerticalInstance:Hs.HorizontalInstance}static GetInstance(e){return K.IsVerticalD(e)?Hs.VerticalInstance:Hs.HorizontalInstance}ToString(){return this.Dir.toString()}},At=Hs;At.HorizontalInstance=new Hs(2),At.VerticalInstance=new Hs(1);var Ko=class extends Ka{static mk(e,t){return new Ko(e,t,Ko.NormalWeight,null)}constructor(e,t,i,n){super();this.Update(e,t),this.Weight=i,this.GroupBoundaryPointAndCrossingsList=n}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Ko.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?At.VerticalInstance:At.HorizontalInstance}get IsOverlapped(){return Ko.OverlappedWeight==this.Weight}get IsReflection(){return Ko.ReflectionWeight==this.Weight}static IsVerticalSegment(e,t){return e.x==t.x}MergeGroupBoundaryCrossingList(e){e!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new Qo),this.GroupBoundaryPointAndCrossingsList.MergeFrom(e))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(e,t){this.startPoint=e,this.endPoint=t}SetInitialVisibilityVertex(e){this.LowestVisibilityVertex=e,this.HighestVisibilityVertex=e}AppendVisibilityVertex(e,t){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.SetInitialVisibilityVertex(t);else{if(V.IsPureLower(t.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.AppendHighestVisibilityVertex(t)}}AddVisibilityEdge(e,t){let i=new ci(e,t,this.Weight);return $e.AddEdge(i),i}AppendHighestVisibilityVertex(e){V.EqualPP(this.HighestVisibilityVertex.point,e.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,e),this.HighestVisibilityVertex=e)}LoadStartOverlapVertexIfNeeded(e){if(this.NeedStartOverlapVertex){let t=e.FindVertex(this.Start);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(e){if(this.NeedEndOverlapVertex){let t=e.FindVertex(this.End);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.End))}}OnSegmentIntersectorBegin(e){this.AppendGroupCrossingsThroughPoint(e,this.Start)||this.LoadStartOverlapVertexIfNeeded(e)}OnSegmentIntersectorEnd(e){this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||V.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(e)}static Subsume(e,t,i,n,o,a,l,u){return u.extendStart=!0,u.extendEnd=!0,e.seg==null||!K.IntervalsOverlapPPPP(e.seg.Start,e.seg.End,t,i)?!1:e.seg.Weight!=n?e.seg.Start==t&&e.seg.End==i?(e.seg.Weight=Math.min(e.seg.Weight,n),!0):!1:(u.extendStart=a.CompareScanCoord(t,e.seg.Start)==-1,u.extendEnd=a.CompareScanCoord(i,e.seg.End)==1,(u.extendStart||u.extendEnd)&&(l.Remove(e.seg),e.seg.startPoint=a.Min(e.seg.Start,t),e.seg.endPoint=a.Max(e.seg.End,i),e.seg=l.InsertUnique(e.seg).item,e.seg.MergeGroupBoundaryCrossingList(o)),!0)}IntersectsSegment(e){return K.SegmentsIntersection(this,e)!=null}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(e){return V.EqualPP(this.Start,e)||V.EqualPP(this.End,e)||V.GetDirections(this.Start,e)==V.GetDirections(e,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(e){return this.IsVertical?new p(this.Start.x,e):new p(e,this.Start.y)}AddSparseVertexCoord(e){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(e)}AddSparseEndpoint(e){return this.sparsePerpendicularCoords.has(e)?!1:(this.sparsePerpendicularCoords.add(e),!0)}CreateSparseVerticesAndEdges(e){var t;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(e,this.Start);for(let i of Array.from(this.sparsePerpendicularCoords.values()).sort(Ae)){let n=this.CreatePointFromPerpCoord(i);this.AppendVisibilityVertex(e,(t=e.FindVertex(n))!=null?t:e.AddVertexP(n))}this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(e,t){return this.AppendGroupCrossingsThroughPoint(e,t.point)?(V.IsPureLower(this.HighestVisibilityVertex.point,t.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t),!0):!1}AppendGroupCrossingsThroughPoint(e,t){var n;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let i=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(t);){let o=this.GroupBoundaryPointAndCrossingsList.Pop(),a=null,l=null;V.ComparePP(o.Location,this.Start)>0&&(a=Qo.ToCrossingArray(o.Crossings,this.ScanDirection.OppositeDirection)),V.ComparePP(o.Location,this.End)<0&&(l=Qo.ToCrossingArray(o.Crossings,this.ScanDirection.Dir)),i=!0;let u=(n=e.FindVertex(o.Location))!=null?n:e.AddVertexP(o.Location);e.AddVertexP(o.Location),a!=null||l!=null?(this.AddLowCrossings(e,u,a),this.AddHighCrossings(e,u,l)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(u):this.AppendHighestVisibilityVertex(u)}return i}static GetCrossingInteriorVertex(e,t,i){var o;let n=i.GetInteriorVertexPoint(t.point);return(o=e.FindVertex(n))!=null?o:e.AddVertexP(n)}AddCrossingEdge(e,t,i,n){let o=null;this.HighestVisibilityVertex!=null&&(V.EqualPP(this.HighestVisibilityVertex.point,i.point)?o=e.FindEdgePP(t.point,i.point):this.AppendHighestVisibilityVertex(t)),o==null&&(o=this.AddVisibilityEdge(t,i));let a=n.map(u=>u.Group.InputShape),l=o.IsPassable;l==null?o.IsPassable=()=>{for(let u of a)if(u.IsTransparent)return!0;return!1}:o.IsPassable=()=>{for(let u of a)if(u.IsTransparent||l())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(t),this.HighestVisibilityVertex=i}AddLowCrossings(e,t,i){if(i!=null){let n=Ko.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,n,t,i)}}AddHighCrossings(e,t,i){if(i!=null){let n=Ko.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,t,n,i)}}},xe=Ko;xe.NormalWeight=ci.DefaultWeight,xe.ReflectionWeight=5,xe.OverlappedWeight=500;var Xf=class{constructor(e,t,i,n,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?H.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,i,n,o)}ResetEntry(e,t,i,n){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=i,this.Cost=n}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var Yf=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},Tt=class{constructor(){this.nextNeighbors=[new Yf,new Yf,new Yf];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,i){if(t==i||!this.InitEntryDirectionsAtTarget(i))return!1;this.Target=i,this.Source=t;let n=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return n>=this.upperBoundOnCost?!1:(this.queue=new yr(Ae),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(n):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|H.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|H.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!=0}static IsInDirs(e,t){return e==(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let i=this.Target.point.sub(e);if(ae(i.x,0)&&ae(i.y,0))return this.targetCostAdjustment;let n=H.VectorDirection(i),o;return t==0?(t=15,o=this.GetNumberOfBends(t,n)):o=this.GetNumberOfBends(t,n),this.CombinedCost(Tt.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return H.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):Tt.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)==t?Tt.IsInDirs(t,this.EntryDirectionsToTarget)?0:Tt.IsInDirs(Tt.Left(t),this.EntryDirectionsToTarget)||Tt.IsInDirs(Tt.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(Tt.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,i){let n=e&t;if(n==0)return Tt.GetBendsForNotPureDirection(e,Tt.AddOneTurn[t],i)+1;let o=e&i;return o==0?Tt.GetBendsForNotPureDirection(e,t,Tt.AddOneTurn[i])+1:(n|o)==e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return Tt.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let i=new Array,n=!1,o=0;for(;;){o==e.entry.Direction?n=!0:(n=!1,i.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex==t)break;e.entry=a}return n&&i.push(e.entry.Vertex.point),i.reverse(),i}QueueReversedEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=t.PreviousVertex,a=Tt.GetLengthAndNumberOfBendsToNeighborVertex(e,o,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree==1){let l=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,n.length,n.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=Tt.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,n.length,n.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,i){let n={numberOfBends:0,length:0},o=Tt.GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n),a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,n.length,n.numberOfBends,a))}EnqueueEntry(e,t,i,n,o){let a=new Xf(t,e,i,n,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n){n.length=e.Length+Tt.ManhattanDistance(e.Vertex.point,t.point)*i;let o=H.DirectionFromPointToPoint(e.Vertex.point,t.point);return n.numberOfBends=e.NumberOfBends,e.Direction!=0&&o!=e.Direction&&n.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,i,n,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=i,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c==this.Target){if(n==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget==0){let d=0;for(let f of this.Target.VertexEntries)n[d++]=f;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=Tt.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(n!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)n[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,i){for(let n of t)this.ExtendPathAlongEdge(e,n,!0,i)}ExtendPathAlongOutEdges(e,t,i){let n=t.isEmpty()?null:t.treeMinimum();for(;n!=null;n=t.next(n))this.ExtendPathAlongEdge(e,n.item,!1,i)}ExtendPathAlongEdge(e,t,i,n){if(!Tt.IsPassable(t))return;let o=i?t.Source:t.Target;if(o==e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!=this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=H.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!=e.Direction&&(l=this.nextNeighbors[a==n?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new Xf(this.Source,null,0,0,e);for(let i of this.Source.OutEdges)!Tt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Target,i.Weight);for(let i of this.Source.InEdges)!Tt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Source,i.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,i){let n=H.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[H.ToIndex(n)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,i):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,i)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i){if(e.Vertex.VertexEntries!=null){let n=H.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[H.ToIndex(n)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,i),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},Yi=Tt;Yi.DefaultBendPenaltyAsAPercentageOfDistance=4,Yi.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var il=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=Yi.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let i={entry:this.GetPathStage(null,e,null,t)};return Yi.RestorePathV(i)}GetPathStage(e,t,i,n){let o=new Yi,a={bestEntry:null,bestCost:Number.MAX_VALUE/xe.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=il.Barycenter(t),c=il.Barycenter(n),h=Yi.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,f=i!=null?this.currentPassTargetEntries:null,P=[];for(let L of t)for(let O of n)P.push([L,O]);P.sort(([L,O],[D,_])=>E(L,O)-E(D,_));for(let[L,O]of P){if(p.closeDistEps(L.point,O.point))continue;let D=v(L,u)*d,_=v(O,c)*d,F=a.bestCost;if(i!=null){for(let se=0;se<f.length;se++)f[se]=null;F=o.MultistageAdjustedCostBound(a.bestCost)}let X=o.GetPathWithCost(e,L,D,f,O,_,F);if(f!=null){il.UpdateTargetEntriesForEachDirection(i,f,a);continue}if(X==null)continue;let $=X.Cost/E(L,O);(X.Cost<a.bestCost||ae(X.Cost,a.bestCost)&&$<l)&&(a.bestCost=X.Cost,a.bestEntry=X,l=X.Cost/E(L,O))}return a.bestEntry;function E(L,O){return Yi.ManhattanDistance(L.point,O.point)}function v(L,O){return Yi.ManhattanDistance(L.point,O)}}static UpdateTargetEntriesForEachDirection(e,t,i){for(let n=0;n<t.length;n++){let o=t[n];o!=null&&(e[n]==null||o.Cost<e[n].Cost)&&(e[n]=o,o.Cost<i.bestCost&&(i.bestCost=o.Cost,i.bestEntry=o))}}static Barycenter(e){let t=new p(0,0);for(let i of e)t=t.add(i.point);return t.div(e.length)}};var xx=be(zt());var cP=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof hi?Array.from(Ex(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new xx.StringBuilder;this.PathPoints instanceof hi&&e.Append("L");for(let t of Ex(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*Ex(s){if(s instanceof hi)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var hP=class extends Ja{constructor(e,t,i,n){super(t);this.Slope=0;this.SlopeInverse=0;this.Obstacle=e,this.endVertex=n?t.nextOnPolyline:t.prevOnPolyline,i.IsPerpendicularPP(t.point,this.endVertex.point)||(this.Slope=K.Slope(t.point,this.endVertex.point,i),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(e){this.obstacle=e}get EndVertex(){return this.endVertex}},Dr=class extends hP{constructor(e,t,i){super(e,t,i,i.IsHorizontal)}},Ws=class extends hP{constructor(e,t,i){super(e,t,i,i.IsVertical)}};var nl=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=Wo(this.InputShape.Ports,this.Ports),e.removedPorts=Wo(this.Ports,this.InputShape.Ports),e.addedPorts.size==0&&e.removedPorts.size==0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,i,n){let o=nl.mk(e,t,n);return o.CreateInitialSides(o.PaddedPolyline.startPoint,i),o}CreateInitialSides(e,t){this.ActiveLowSide=new Dr(this,e,t),this.ActiveHighSide=new Ws(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new Ws(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t,i){if(e!=null){if(t){let n=e.BoundingBox.clone();n.pad(i),this.PaddedPolyline=w.polyFromBox(n)}else this.PaddedPolyline=Jt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,i);nl.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports)}}static mk(e,t,i){let n=new nl(null,!1,0);return n.PaddedPolyline=te.mkClosedFromPoints([C.RoundPoint(e),C.RoundPoint(t)]),n.Ordinal=i,n}IsPolylineRectangle(){if(this.PaddedPolyline.count!=4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,i=H.VectorDirectionPP(e.point,t.point);if(!H.IsPureDirection(i))return!1;do{e=t,t=e.nextOnPolyline;let n=H.DirectionFromPointToPoint(e.point,t.point);if(n!=H.RotateRight(i))return!1;i=n}while(e!=this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=C.RoundPoint(t.point),t=t.nextOnPolyline;while(t!=e.startPoint);nl.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this==this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=C.intersectionEpsilon*10;for(let i=e.startPoint.next;i!=null;i=i.next)p.close(i.prev.point,i.point,t)&&(i.next==null?e.RemoveEndPoint():(i.prev.next=i.next,i.next.prev=i.prev));return p.close(e.start,e.end,t)&&e.RemoveStartPoint(),Ge.RemoveCollinearVertices(e),e.endPoint.prev!=null&&e.endPoint.prev!=e.startPoint&&p.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)==2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!=e.startPoint&&p.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)==2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!=null&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump==e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=Jt.CreatePaddedPolyline(e,C.intersectionEpsilon*10);return nl.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},Sr=nl;Sr.FirstSentinelOrdinal=1,Sr.FirstNonSentinelOrdinal=10;var vx=be(zt());var dP=class{constructor(e,t,i,n){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=xe.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=i;let o=B.mkPP(this.UnpaddedBorderIntersect,K.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,i)),a=w.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=C.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=n.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=n.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,At.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(n))&&(this.unpaddedToPaddedBorderWeight=xe.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight==xe.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(n)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight}get IsCollinearWithPort(){return H.IsPureDirection(V.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return K.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return V.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!=0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=xe.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=W.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,i=>i.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(i=>!i.UserData.IsGroup&&i.UserData!=this.Obstacle).map(i=>i.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=W.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!=this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,i){let n=null;for(let o of i){let a=t(o);if(!K.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(n=n!=null?n:B.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),w.intersectionOne(n,a,!1)!=null||0!=w.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=K.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return V.GetDirections(this.MaxVisibilitySegment.start,t.Location)==V.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,i,n){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,i,n);return}this.OutwardDirection==V.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,i,n)}ExtendEdgeChain(e,t,i,n,o){e.ExtendEdgeChainVRLPB(i,n,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return vx.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var fP=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=W.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=C.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,i){let n=new dP(this,e,t,i);this.PortEntrances.push(n),this.VisibilityRectangle.add(n.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||n.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!p.closeDistEps(this.Location,C.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var pP=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight}get IsOutOfBounds(){return 0!=this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,i,n){let o=K.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,i,n):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,i,n),a}AddToAdjacentVertex(e,t,i,n){V.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,i,n)}ExtendEdgeChain(e,t,i,n){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,i));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,i,e);e.ExtendEdgeChainVRLPB(t,n,a[0],a[1],o)}GetSegmentAndCrossings(e,t,i){let n=H.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[n];if(o==null){let a={pacList:null};o=[i.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[n]=o}else V.GetDirections(e.point,o[0].start)==t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let i=V.GetDirections(t,this.Vertex.point),n=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(n,this.Vertex,i&5,xe.NormalWeight),e.ConnectVertexToTargetVertex(n,this.Vertex,i&10,xe.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var Tx=be(zt());var Cx=be(zt());var Gu=class{constructor(e,t){this.BoundaryWidth=C.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return C.RoundPoint(e.add(H.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return Cx.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};Gu.BoundaryWidth=C.distanceEpsilon;var vh=class extends Qt{constructor(e){super();this.site=e}get Site(){return this.site}};var ol=class extends Ti{constructor(e,t){super(t);this.Obstacle=e}};var sl=class extends ol{constructor(e,t){super(e,t)}};var gP=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!V.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||V.GetDirections(this.CurrentSegment.End,e)==V.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&p.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(V.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new p(e,this.Coord):new p(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y == "+this.Coord:"(V) X == "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var $f=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let i=Array.from(e).sort((n,o)=>n>o?1:n<o?-1:0);for(let n of i)this.vector.push(new gP(n))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,i,n){this.CurrentSlot.AppendScanSegment(new xe(e,t,i,n))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let i=0,n=this.vector.length-1;if(e<=this.vector[i].Coord)return i;if(e>=this.vector[n].Coord)return n;for(;n-i>2;){let o=i+(n-i>>1),a=this.vector[o];if(e<a.Coord){n=o;continue}if(e>a.Coord){i=o;continue}return o}for(i++;i<=n;i++){let o=this.vector[i];if(e<o.Coord)return t>0?i:i-1;if(e==o.Coord)break}return i}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let i=t.FirstSegment;i!=null;i=i.NextSegment)i.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let i=t.NextSegment;i!=null;i=i.NextSegment){if(i.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&i.Start==t.End){let n=this.GetPerpendicularCoord(i.Start);t.AddSparseEndpoint(n),i.AddSparseEndpoint(n)}t=i}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count == ")+this.vector.length}};var $i=class extends Qt{constructor(e,t,i){super();this.InitialObstacle=e,this.ReflectingObstacle=t,this.site=i}static mk(e,t,i){let n=new $i(e.ReflectingObstacle,t,i);return n.PreviousSite=e,n}IsStaircaseStep(e){return this.InitialObstacle==e}get Site(){return this.site}};var Zf=class{constructor(){this.eventTree=new $a((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(i)return i;let n=e instanceof $i?0:1,o=t instanceof $i?0:1;return i=n-o,i||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var Ax=be(zt());var Ch=class{constructor(){this.pointCrossingMap=new dt;this.pointList=new Array}AddIntersection(e,t,i){let n=this.pointCrossingMap.get(e);n||(n=new Array,this.pointCrossingMap.set(e,n));let o=n.length;for(let l=0;l<o;l++){let u=n[l];if(u.Group==t)return u}let a=new Gu(t,i);return n.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size==0)return null;if(V.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())V.ComparePP(o,e)>=0&&V.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let i=new Qo,n=this.pointList.length;for(let o=0;o<n;o++){let a=this.pointList[o];i.Add(a,this.pointCrossingMap.get(a))}return i}toString(){return Ax.String.Format("{0}",this.pointCrossingMap.size)}};var Qf=class extends $i{constructor(e,t,i){super(e.ReflectingObstacle,t.Obstacle,i);this.Side=t}};var mP=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new bt((t,i)=>this.CompareBB(t,i)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let i=this.FindFirstInRange(e,t);i!=null;i=this.FindNextInRange(i,t))this.MarkStaleSite(i.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site==e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let i=this.eventTree.findFirst(this.findFirstPred);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let i=this.eventTree.next(e);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Kf=class extends ol{constructor(e,t){super(e,t)}},Jf=class extends ol{constructor(e,t){super(e,t)}},ep=class extends ol{constructor(e,t){super(e,t)}};var tp=class extends $i{constructor(e,t,i){super(e.ReflectingObstacle,t.obstacle,i);this.Side=t}};var rp=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,i,n){if(K.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=i,this.GroupSideInterveningBeforeHighNeighbor=n;return}this.LowNeighbor=t,this.LowOverlapEnd=i,this.GroupSideInterveningBeforeLowNeighbor=n}};var ip=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],Sr.RoundVerticesAndSimplify(this.Polyline)}};var Jo=class{static MungeClosestIntersectionInfo(e,t,i){let n=t.seg1.boundingBox,o=C.RoundPoint(t.x).clone();return i?new p(Jo.MungeIntersect(e.x,o.x,n.left,n.right),o.y):new p(o.x,Jo.MungeIntersect(e.y,o.y,n.bottom,n.top))}static MungeIntersect(e,t,i,n){if(e<t){let o=Math.min(i,n);t<o&&(t=o)}else if(e>t){let o=Math.max(i,n);t>o&&(t=o)}return C.RoundDouble(t)}};var Pt=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new Ch;this.overlapPairs=new mr;this.hasOverlaps=!1;this.lookupIntPair=new ge(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,i){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=i}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=Sr.FirstNonSentinelOrdinal;for(let i of this.allObstacles)i.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-Sr.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=Pt.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=Pt.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(Ft(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let i={bIsInsideA:!1,aIsInsideB:!1};if(Pt.ObstaclesIntersect(e,t,i)){this.hasOverlaps=!0;return}!i.aIsInsideB&&!i.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&i.bIsInsideA||t.IsGroup&&i.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(i=>ct(i,i.VisibilityBoundingBox));return Qe(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=Pt.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&_r(e,e,(t,i)=>this.EvaluateOverlappedPairForClump(t,i))}EvaluateOverlappedPairForClump(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!Pt.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||this.overlapPairs.add(new ge(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=Pt.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&_r(e,e,(t,i)=>this.EvaluateOverlappedPairForConvexHull(t,i))}EvaluateOverlappedPairForConvexHull(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!Pt.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new ge(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=Pt.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsGroup)),t=Pt.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsPrimaryObstacle));e==null||t==null||_r(e,t,(i,n)=>this.EvaluateOverlappedPairForGroup(i,n))}EvaluateOverlappedPairForGroup(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1},n=Pt.ObstaclesIntersect(e,t,i);if(!(!n&&!i.aIsInsideB&&!i.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(i.aIsInsideB||Pt.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!n&&(t.IsGroup||i.bIsInsideA)||this.overlapPairs.add(new ge(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return w.PointRelativeToCurveLocation(e.start,t)!=0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(i=>i.Ordinal!=e.Ordinal))this.overlapPairs.add(new ge(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(i=>i.Ordinal!=e.Ordinal))this.overlapPairs.add(new ge(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=pu(Array.from(this.overlapPairs.values())),t=ko(e);for(let i of t){if(i.length==1)continue;let n=i.map(o=>this.OrdinalToObstacle(o));for(let o of n)o.clump=n}}CreateConvexHulls(){let e=!1,t=pu(Array.from(this.overlapPairs.values())),i=ko(t);for(let n of i){if(n.length==1)continue;e=!0;let o=n.map(this.OrdinalToObstacle),a=to(o,u=>Array.from(u.VisibilityPolyline)),l=new ip(Zr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let i=this.OrdinalToObstacle(t.x),n=this.OrdinalToObstacle(t.y);Pt.ResolveGroupAndGroupOverlap(i,n)||Pt.ResolveGroupAndObstacleOverlap(i,n)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?Pt.ResolveGroupAndObstacleOverlap(e,t):Pt.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let i=t.looseVisibilityPolyline;Pt.GrowGroupAroundLoosePolyline(e,i);let n={bIsInsideA:!1,aIsInsideB:!1};for(;Pt.ObstaclesIntersect(t,e,n)||!n.aIsInsideB;)i=Sr.CreateLoosePolyline(i),Pt.GrowGroupAroundLoosePolyline(e,i)}static GrowGroupAroundLoosePolyline(e,t){let i=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new ip(Zr.createConvexHullAsClosedPolyline(i),[e]))}static ObstaclesIntersect(e,t,i){return w.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):(i.aIsInsideB=Pt.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),i.bIsInsideA=!i.aIsInsideB&&Pt.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:Pt.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i.aIsInsideB,i.bIsInsideA)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i,n){if(!i&&!n)return w.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=i?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=i?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(w.PointRelativeToCurveLocation(l,a)==0){let u=w.ClosestPoint(a,l);if(!p.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let i=t.VisibilityBoundingBox;for(let n of this.Root.GetNodeItemsIntersectingRectangle(i))if(n!=t&&w.ClosedCurveInteriorsIntersect(n.VisibilityPolyline,t.VisibilityPolyline)){if(n.IsInConvexHull)for(let o of n.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(n.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let i=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(n=>!i.intersects(this.shapeIdToObstacleMap.get(n).VisibilityBoundingBox)));for(let n of e)this.AncestorSets.get(t.InputShape).delete(n);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,i){let n=K.RectangleBorderIntersect(this.GraphBox,e,t);if(V.GetDirections(e,n)==0)return i.pacList=null,B.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,n);return i.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,i,n){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=n,this.Root.FirstHitNodeWithPredicate(i,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,At.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t==this.insideHitTestIgnoreObstacle1||t==this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!K.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let i=K.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),n=K.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=B.mkPP(n,i),a=w.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length==2){let l=C.RoundPoint(a[0].x),u=C.RoundPoint(a[1].x);if(!V.EqualPP(e,l)&&!V.EqualPP(e,u)&&e.compareTo(l)!=e.compareTo(u)&&!ae(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!V.EqualPP(i.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!V.EqualPP(i.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=B.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let i=V.GetDirections(e,t),n=8==i?this.GraphBox.right:2==i?this.GraphBox.left:e.x,o=8==i?this.GraphBox.left:2==i?this.GraphBox.right:t.x,a=4==i?this.GraphBox.top*2:1==i?this.GraphBox.bottom:e.y,l=4==i?this.GraphBox.bottom:1==i?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=B.mkPP(new p(n,a),new p(o,l))}RecurseRestrictRayWithObstacles(e){if(!K.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let i=w.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(i);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,i);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,i=null,n=this.restrictedRayLengthSquared,o=V.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=C.RoundPoint(a.x),u=V.GetDirections(this.currentRestrictedRay.start,l);if(u==H.OppositeDir(o))continue;if(t++,0==u){n=0,i=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<n){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<C.squareOfDistanceEpsilon)continue;n=c,i=a}}if(i!=null){if(t==1){let a=C.RoundPoint(i.x);if(p.closeIntersections(a,this.currentRestrictedRay.start)||p.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=n,this.currentRestrictedRay.end=Jo.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,i,!K.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let i of t){let n=C.RoundPoint(i.x);if(n.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=V.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=i.seg1,u=H.VectorDirection(l.derivative(i.par1)),c=a;(u&H.RotateRight(a))!=0&&(c=H.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,e,c)}}};var bP=class{constructor(e,t){this.scanDirection=e,this.SideTree=new bt((i,n)=>this.Compare(i,n)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)==-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return K.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle==t.Obstacle)return e==t?0:e instanceof Dr?-1:1;let i=al.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),n=al.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=i.compareTo(n);if(o==0){let a=e instanceof Dr,l=t instanceof Dr;o=dE(a,l),o==0&&(o=Ae(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var Vu=class{constructor(e){this.lookupSegment=xe.mk(new p(0,0),new p(0,1));this.ScanDirection=e,this.segmentTree=new bt((t,i)=>this.Compare(t,i)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let i=this.segmentTree.find(this.lookupSegment);return i!=null&&V.EqualPP(i.item.End,t)?i.item:null}FindLowestIntersector(e,t){let i=this.FindLowestIntersectorNode(e,t);return i!=null?i.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let i=this.segmentTree.findLast(this.findIntersectorPred);if(V.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.Start,t)>0)return null;i=this.segmentTree.next(i)}return i}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let i=this.segmentTree.findLast(this.findIntersectorPred);if(V.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.End,e)<0)return null;i=this.segmentTree.previous(i)}return i!=null?i.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,i){this.lookupSegment.Update(e,t);let n=this.segmentTree.findFirst(this.findPointPred);if(n!=null){let o=n.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)==-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped==e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!=t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start==t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End==t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let n=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),n.Update(o.End,n.End),this.segmentTree.insert(n),n.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.ScanDirection.Compare(e.Start,t.Start);return i==0&&(i=this.ScanDirection.Compare(e.End,t.End)*-1),i}};var PP=class extends jo{constructor(e){super(e)}SetVertexEntry(e){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[H.ToIndex(e.Direction)]=e}RemoveVertexEntries(){this.VertexEntries=null}};var Ht=class{constructor(e){this.ObstacleTree=new Pt;this.CurrentGroupBoundaryCrossingMap=new Ch;this.LowNeighborSides=new rp;this.HighNeighborSides=new rp;this.ScanDirection=At.HorizontalInstance,this.eventQueue=new Zf,this.HorizontalScanSegments=new Vu(At.HorizontalInstance),this.VerticalScanSegments=new Vu(At.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new $e;return e.VertexFactory=t=>new PP(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(At.HorizontalInstance);let e=Sr.FirstSentinelOrdinal,t=new p(this.ObstacleTree.GraphBox.left-Ht.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Ht.SentinelOffset),i=new p(this.ObstacleTree.GraphBox.left-Ht.SentinelOffset,this.ObstacleTree.GraphBox.top+Ht.SentinelOffset),n=Sr.CreateSentinel(t,i,this.ScanDirection,e++);this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new p(this.ObstacleTree.GraphBox.right+Ht.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Ht.SentinelOffset),i=new p(this.ObstacleTree.GraphBox.right+Ht.SentinelOffset,this.ObstacleTree.GraphBox.top+Ht.SentinelOffset),n=Sr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(At.VerticalInstance),t=new p(this.ObstacleTree.GraphBox.left-Ht.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Ht.SentinelOffset),i=new p(this.ObstacleTree.GraphBox.right+Ht.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Ht.SentinelOffset),n=Sr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new p(this.ObstacleTree.GraphBox.left-Ht.SentinelOffset,this.ObstacleTree.GraphBox.top+Ht.SentinelOffset),i=new p(this.ObstacleTree.GraphBox.right+Ht.SentinelOffset,this.ObstacleTree.GraphBox.top+Ht.SentinelOffset),n=Sr.CreateSentinel(t,i,this.ScanDirection,e),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,i){let n=t.Direction,o=t.Start.x,a=t.Start.y;return i.IsHorizontal?(o+=n.x/n.y*(e.y-t.Start.y),o=Jo.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=n.y/n.x*(e.x-t.Start.x),a=Jo.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new p(o,a)}GetOpenVertex(e){let t=e.startPoint,i=this.TraversePolylineForEvents(t),n=this.PointCompare(i.point,t.point);for(;;i=this.TraversePolylineForEvents(i)){let o=this.PointCompare(i.point,t.point);if(o<=0)t=i;else if(o>0&&n<=0)break;n=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new bP(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new mP(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new sl(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return Ht.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof Dr?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof Dr?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,i,n){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!n&&!K.PointIsInRectangleInterior(i,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(i)==null&&this.lookaheadScan.Add(new $i(e,t.Obstacle,i))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let i=W.mkPP(e.Start,e.End),n=W.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!i.intersectsOnX(n):!i.intersectsOnY(n))return;let o=W.intersect(i,n),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=Ht.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!=e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,i){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!K.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(i!=null&&e.IsStaircaseStep(i.Obstacle))return this.ScanLineCrossesObstacle(e.Site,i.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,i,n){{let o=this.ScanLineIntersectSide(n.Site,t!=null?t:i),a=t!=null?o:n.Site,l=t!=null?n.Site:o;return t==null?t=this.scanLine.NextLowB(i).item:i=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,i,n)}}AddReflectionEvent(e,t,i){let n=t;n!=null?this.eventQueue.Enqueue(new tp(e,n,i)):this.eventQueue.Enqueue(new Qf(e,t,i))}AddSideToScanLine(e,t){let i=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),i}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Zf,this.HorizontalScanSegments=new Vu(At.HorizontalInstance),this.VerticalScanSegments=new Vu(At.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof sl?this.ProcessEventO(e):e instanceof Kf?this.ProcessEventLB(e):e instanceof Jf?this.ProcessEventHB(e):e instanceof ep?this.ProcessEventCV(e):e instanceof tp?this.ProcessEventLR(e):e instanceof Qf?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,i){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,i,this.HighNeighborSides)}FindNeighbors(e,t,i){let n=e instanceof sl?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,n,o.lowNborSideNode,i),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,n,o.highNborSideNode,i)}SkipToNeighbor(e,t,i,n,o){let a=null,l=null;for(;;n=this.scanLine.Next(e,n))if(n.item.Obstacle!=t.Obstacle){if(n.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(n,i,e)&&l==null&&(l=n.item);continue}if(n.item instanceof Ws==K.IsAscending(e)){this.ScanLineCrossesObstacle(i,n.item.Obstacle)&&(a=n,l=null);continue}break}o.SetSides(e,n,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,i){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let n=e.item instanceof Dr==K.IsAscending(i)?i:H.OppositeDir(i),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,n),!0}FindNeighborsAndProcessVertexEvent(e,t,i){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(i,e,t),this.ProcessVertexEvent(e,t,i),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let i=this.AddSideToScanLine(t.ActiveHighSide,e.Site),n=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(n,i,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!=t.ActiveLowSide.Start){let c=new Ws(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,i=new Dr(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(i.End,i.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(i,e.Site),t.ActiveLowSide=i,this.EnqueueLowBendVertexEvent(i))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Kf(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,i=new Ws(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let n=this.AddSideToScanLine(i,e.Site);if(t.ActiveHighSide=i,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&i.Start.x==t.VisibilityBoundingBox.right&&this.SideReflectsUpward(i)){let o=this.scanLine.NextHighR(n);o.item instanceof Dr&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(i.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,i,i.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,i=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(i.point,e.End)>0?this.eventQueue.Enqueue(new Jf(t,e.EndVertex)):this.eventQueue.Enqueue(new ep(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,i=this.scanLine.Find(t.ActiveLowSide),n=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)==1){let o=i;i=n,n=o}if(this.FindNeighborsAndProcessVertexEvent(i,n,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(i);o.item!=n.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,i=this.HighNeighborSides.HighNeighbor.item,n=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(i),n.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,i=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,i,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,i=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,null,i,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),i=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new p(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(i,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return V.EqualPP(e,this.MakeInBoundsLocation(e))}},al=Ht;al.SentinelOffset=1;var Fr=class extends al{constructor(){super(!1);this.horizontalVertexPoints=new Je;this.verticalVertexPoints=new Je;this.boundingBoxSteinerPoints=new Je;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let e of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(e.VisibilityBoundingBox.left),this.xCoordAccumulator.add(e.VisibilityBoundingBox.right),this.yCoordAccumulator.add(e.VisibilityBoundingBox.top),this.yCoordAccumulator.add(e.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new $f(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new $f(this.xCoordAccumulator,!1);for(let e=0;e<this.horizontalScanSegmentVector.Length;e++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(e).Coord,e);for(let e=0;e<this.verticalScanSegmentVector.Length;e++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(e).Coord,e)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(e){super.InitializeEventQueue(e),this.SetVectorsAndCoordMaps(e),this.AddAxisCoordinateEvents(e)}AddAxisCoordinateEvents(e){if(e.IsHorizontal){for(let t of this.yCoordAccumulator)this.eventQueue.Enqueue(new vh(new p(this.ObstacleTree.GraphBox.left-Fr.SentinelOffset,t)));return}for(let t of this.xCoordAccumulator)this.eventQueue.Enqueue(new vh(new p(t,this.ObstacleTree.GraphBox.bottom-Fr.SentinelOffset)))}ProcessCustomEvent(e){this.ProcessAxisCoordinate(e)||this.ProcessCustomEvent(e)}ProcessAxisCoordinate(e){return e instanceof vh?(this.CreateScanSegmentsOnAxisCoordinate(e.Site),!0):!1}InsertPerpendicularReflectionSegment(e,t){return!1}InsertParallelReflectionSegment(e,t,i,n,o,a){return!1}ProcessVertexEvent(e,t,i){let n=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;n.add(i.Site);let o=this.LowNeighborSides.LowNeighbor.item,a=this.HighNeighborSides.HighNeighbor.item,l=this.ScanDirection.Dir,u=this.ScanDirection.OppositeDirection,c=this.ScanLineIntersectSide(i.Site,o),h=this.ScanLineIntersectSide(i.Site,a);if(this.ObstacleTree.GraphBox.contains(c)){let f=K.RectangleBorderIntersect(o.Obstacle.VisibilityBoundingBox,c,l);V.IsPureLower(f,i.Site)&&this.boundingBoxSteinerPoints.add(f)}if(this.ObstacleTree.GraphBox.contains(h)){let f=K.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);V.IsPureLower(i.Site,f)&&this.boundingBoxSteinerPoints.add(f)}let d={lowCorner:void 0,highCorner:void 0};Fr.GetBoundingCorners(e.item.Obstacle.VisibilityBoundingBox,i instanceof sl,this.ScanDirection.IsHorizontal,d),(V.IsPureLower(c,d.lowCorner)||o.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.lowCorner),(V.IsPureLower(d.highCorner,h)||a.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.highCorner)}static GetBoundingCorners(e,t,i,n){if(t){n.lowCorner=e.leftBottom,n.highCorner=i?e.rightBottom:e.leftTop;return}n.lowCorner=i?e.leftTop:e.rightBottom,n.highCorner=e.rightTop}CreateScanSegmentsOnAxisCoordinate(e){this.CurrentGroupBoundaryCrossingMap.Clear();let t=this.scanLine.Lowest(),i=this.scanLine.NextHighR(t),n=0,o=e,a=!1;for(;i!=null;i=this.scanLine.NextHighR(i)){if(this.SkipSide(o,i.item))continue;if(i.item.Obstacle.IsGroup){(n==0||a)&&this.HandleGroupCrossing(e,i.item);continue}if(i.item instanceof Dr){if(n>0){n++;continue}o=this.CreateScanSegment(o,i.item,xe.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),n=1,a=i.item.Obstacle.isOverlapped;continue}n++,!(n>0)&&(o=i.item.Obstacle.isOverlapped||i.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(o,i.item,xe.OverlappedWeight):this.ScanLineIntersectSide(o,i.item),this.CurrentGroupBoundaryCrossingMap.Clear(),a=!1)}let l=this.ScanDirection.IsHorizontal?new p(this.ObstacleTree.GraphBox.right+Fr.SentinelOffset,o.y):new p(o.x,this.ObstacleTree.GraphBox.top+Fr.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(o,l,xe.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o,l)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(e,t){if(!this.ScanLineCrossesObstacle(e,t.Obstacle))return;let i=t instanceof Dr?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,n=this.ScanLineIntersectSide(e,t),o=this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,t.Obstacle,i);this.AddPerpendicularCoordForGroupCrossing(n);let a=o.GetInteriorVertexPoint(n);this.AddPerpendicularCoordForGroupCrossing(a)}AddPerpendicularCoordForGroupCrossing(e){let t=this.FindPerpendicularSlot(e,0);t!=-1&&this.perpendicularSegmentVector.Item(t).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(e,t){if(t.Obstacle.IsSentinel)return!0;let i=t.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?e.y==i.bottom||e.y==i.top:e.x==i.left||e.x==i.right}CreateScanSegment(e,t,i){let n=this.ScanLineIntersectSide(e,t);return e!=n&&this.parallelSegmentVector.CreateScanSegment(e,n,i,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(e,n)),n}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=Fr.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=cu;let e=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=At.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(i,n)=>i.compareTo(n);let e=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=At.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}SetVectorsAndCoordMaps(e){e.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(e,t){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let i=1,n={j:0};for(let o of this.parallelSegmentVector.Items())for(;!(!o.CurrentSegment.ContainsPoint(e[i])&&(!this.AddSteinerPointsToInterveningSegments(e[i],t,n,o)||!o.TraverseToSegmentContainingPoint(e[i])));){if(this.AddPointsToCurrentSegmentIntersections(t,n,o),this.GenerateIntersectionsFromVertexPointForCurrentSegment(e[i],o),o.PointIsCurrentEndAndNextStart(e[i])){o.MoveNext();continue}if(++i>=e.length)return}}AddSteinerPointsToInterveningSegments(e,t,i,n){for(;i.j<t.length&&this.currentAxisPointComparer(t[i.j],e)==-1;){if(!n.TraverseToSegmentContainingPoint(t[i.j]))return!1;this.AddPointsToCurrentSegmentIntersections(t,i,n)}return!0}AddPointsToCurrentSegmentIntersections(e,t,i){for(;t.j<e.length&&i.CurrentSegment.ContainsPoint(e[t.j]);t.j++){let n=this.FindPerpendicularSlot(e[t.j],0);this.AddSlotToSegmentIntersections(i,n)}}GenerateIntersectionsFromVertexPointForCurrentSegment(e,t){let i=this.FindPerpendicularSlot(t.CurrentSegment.Start,1),n=this.FindPerpendicularSlot(t.CurrentSegment.End,-1),o=this.FindPerpendicularSlot(e,0);i>=n||(this.AddSlotToSegmentIntersections(t,i),this.AddSlotToSegmentIntersections(t,n),o>i&&o<n&&(this.AddSlotToSegmentIntersections(t,o),this.AddBinaryDivisionSlotsToSegmentIntersections(t,i,o,n)))}FindPerpendicularSlot(e,t){return Fr.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,e,t)}static FindIntersectingSlot(e,t,i,n){let o=e.GetParallelCoord(i),a=t.get(o);return a!=null?a:n==0?-1:e.FindNearest(o,n)}AddSlotToSegmentIntersections(e,t){let i=this.perpendicularSegmentVector.Item(t);e.CurrentSegment.AddSparseVertexCoord(i.Coord),i.AddPerpendicularCoord(e.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(e,t,i,n){let o=0,a=this.perpendicularSegmentVector.Length-1;for(;a-o>1;){let l=o+Math.floor((a-o)/2);if(i<=l){a=l,i<a&&a<=n&&this.AddSlotToSegmentIntersections(e,a);continue}o=l,i>o&&o>=t&&this.AddSlotToSegmentIntersections(e,o)}}CreateScanSegmentTrees(){Fr.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),Fr.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(e,t){for(let i of e.Items())for(let n=i.FirstSegment;n!=null;n=n.NextSegment)n.HasVisibility()&&t.InsertUnique(n)}};var Kr=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof Fr}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,xe.NormalWeight)}FindOrAddEdge(e,t,i){let n=V.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};Kr.GetBrackets(e,t,n,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,i),a}static GetBrackets(e,t,i,n){if(n.splitVertex=t,!Kr.FindBracketingVertices(e,t.point,i,n)){let o={bracketSource:null,bracketTarget:null};Kr.FindBracketingVertices(t,e.point,H.OppositeDir(i),o)&&(n.bracketSource=o.bracketTarget,n.splitVertex=e),n.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,i,n){for(n.bracketSource=e;n.bracketTarget=K.FindAdjacentVertex(n.bracketSource,i),n.bracketTarget!=null;){if(p.closeDistEps(n.bracketTarget.point,t))return!0;if(i!=V.GetDirections(n.bracketTarget.point,t))break;n.bracketSource=n.bracketTarget}return n.bracketTarget!=null}CreateEdge(e,t,i){let n=e,o=t;V.IsPureLower(n.point,o.point)||(n=t,o=e);let a=new ur(n,o,i);return $e.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&$e.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)$e.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return K.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,i){for(;;){let n=K.FindAdjacentVertex(e,t);if(n==null)break;let o=V.GetDirections(n.point,i);if((H.OppositeDir(t)&o)!=0)return this.VisGraph.FindEdgePP(e.point,n.point);e=n}return null}FindNearestPerpendicularOrContainingEdge(e,t,i){let n;t&V.GetDirections(e.point,i);let o=e,a=n;for(;0!=a;){let u=K.FindAdjacentVertex(o,n);if(u==null||(H.OppositeDir(n)&V.GetDirections(u.point,i))!=0)break;o=u,t&V.GetDirections(o.point,i)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,i),!(l!=null||o==e);)o=K.FindAdjacentVertex(o,H.OppositeDir(n));return l}ConnectVertexToTargetVertex(e,t,i,n){if(p.closeDistEps(e.point,t.point))return;let o=V.GetDirections(e.point,t.point);if(V.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=K.FindBendPointBetween(e.point,t.point,i),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,n),this.FindOrAddEdge(l,t,n)}AddEdgeToTargetEdge(e,t,i){let n=this.VisGraph.FindVertex(i);return n==null&&(n=this.AddVertex(i),this.SplitEdge(t,n)),this.FindOrAddEdgeVV(e,n),n}SplitEdge(e,t){return e==null?null:p.closeDistEps(e.Source.point,t.point)||p.closeDistEps(e.Target.point,t.point)?e:(e instanceof ur||this.edgesToRestore.push(e),$e.RemoveEdge(e),(this.IsSparseVg||e.Weight==xe.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,i,n,o){let a=V.GetDirections(i.start,i.end);if(a==0)return;let l=K.GetRectangleBound(t,a),u=K.IsVerticalD(a)?C.RoundPoint(new p(e.point.x,l)):C.RoundPoint(new p(l,e.point.y));if(p.closeDistEps(u,e.point)||V.GetDirections(e.point,u)!=a)return;let c=i;V.GetDirections(u,c.end)==a&&(c=B.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,i,n,o)}ExtendEdgeChain(e,t,i,n,o,a){if(V.GetDirections(e.point,i.end)!=t)return;let u=H.RotateLeft(t),c=K.FindAdjacentVertex(e,u);if(c==null&&(u=H.OppositeDir(u),c=K.FindAdjacentVertex(e,u),c==null))return;let h=H.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,i,n,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,i,n,a,d),this.SpliceGroupBoundaryCrossings(o,e,i)}SpliceGroupBoundaryCrossings(e,t,i){if(e==null||e.Count()==0)return;e.Reset();let n=i.start,o=i.end,a=V.GetDirections(n,o);K.IsAscending(a)||(n=i.end,o=i.start,a=H.OppositeDir(a)),t=Kr.TraverseToFirstVertexAtOrAbove(t,n,H.OppositeDir(a));for(let l=t;l!=null;l=K.FindAdjacentVertex(l,a)){let u=V.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();V.ComparePP(c.Location,t.point)>0&&V.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,H.OppositeDir(a)),V.ComparePP(c.Location,t.point)>=0&&V.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,i){let n=e,o=H.OppositeDir(i);for(;;){let a=K.FindAdjacentVertex(n,i);if(a==null||V.GetDirections(a.point,t)==o)break;n=a}return n}SpliceGroupBoundaryCrossing(e,t,i){var o,a;let n=Qo.ToCrossingArray(t.Crossings,i);if(n!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=n[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=n.map(f=>f.Group.InputShape);h.IsPassable=()=>d.some(f=>f.IsTransparent)}}ExtendSpliceWorker(e,t,i,n,o,a,l){let u=K.FindAdjacentVertex(e,i);l.spliceTarget=K.FindAdjacentVertex(u,i);let c={spliceSource:e};for(;Kr.GetNextSpliceSource(c,i,t);){let h=K.FindBendPointBetween(u.point,c.spliceSource.point,H.OppositeDir(i));if(Kr.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=Kr.GetSpliceTarget(c,i,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?xe.OverlappedWeight:xe.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?xe.OverlappedWeight:xe.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?xe.OverlappedWeight:xe.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&V.GetDirections(h,n.end))==0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,i){let n=K.FindAdjacentVertex(e.spliceSource,i);if(n==null)for(n=e.spliceSource;;){if(n=K.FindAdjacentVertex(n,H.OppositeDir(t)),n==null)return!1;let o=K.FindAdjacentVertex(n,i);if(o!=null){n=o;break}}return e.spliceSource=n,!0}static GetSpliceTarget(e,t,i){let n=V.GetDirections(e.spliceSource.point,i),o=n,a=e.spliceSource;for(;o==n&&(e.spliceSource=a,a=K.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(p.closeDistEps(a.point,i)){a=K.FindAdjacentVertex(a,t);break}o=V.GetDirections(a.point,i)}return a}SeeIfSpliceIsStillOverlapped(e,t){let i=this.FindNextEdge(t,H.RotateLeft(e)),n=i==null?!1:xe.NormalWeight==i.Weight;return n||(i=this.FindNextEdge(t,H.RotateRight(e)),n=i==null?!1:xe.NormalWeight==i.Weight),!n||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(Kr.IsSkippableSpliceSourceEdgeWithNullTarget(K.FindAdjacentEdge(e,t)))return!0;let i=K.FindAdjacentEdge(e,H.OppositeDir(t));return Kr.IsSkippableSpliceSourceEdgeWithNullTarget(i)||Kr.IsReflectionEdge(i)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&ae(e.Length,Gu.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight==xe.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return V.GetDirections(e.start,e.end)==V.GetDirections(e.end,t)}toString(){return Tx.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var ll=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new dt;this.freePointLocationsUsedByRouteEdges=new Je;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new Kr(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let i=C.RoundPoint(t.Location);if(0==w.PointRelativeToCurveLocation(i,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!=t.Curve&&0==w.PointRelativeToCurveLocation(i,t.Curve))return null;let n=new fP(t,e);return this.obstaclePortMap.set(t,n),n}FindVertices(e){let t=new Array,i=this.obstaclePortMap.get(e);if(i)if(this.RouteToCenterOfObstacles)t.push(i.CenterVertex);else for(let n of i.PortEntrances){let o=this.VisGraph.FindVertex(n.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(C.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);if(this.AncestorSets.size>0&&i.oport!=null&&n.oport!=null){let l=Wo(a,o),u=Wo(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,i.oport),this.AddPortToGraph(e.targetPort,n.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let i=this.FindVertices(t),n=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i),n=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i)}ConnectToGraphAtPointsCollinearWithVertices(e,t,i){if(0==t)return;let n=H.OppositeDir(t);for(let o of i){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,n,xe.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size==0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size==0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(W.mkPP(e.Location,e.Location),i=>i.IsGroup)).map(i=>i.InputShape))}ActivateAncestors(e,t,i){for(let n of yn(e,t)){let o=i.get(n);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=W.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let i={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(i)){for(let n of i.addedPorts)this.CreateObstaclePort(t.Obstacle,n);for(let n of i.removedPorts)this.RemoveObstaclePort(n);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),i=this.FindObstaclePort(e.targetPort);if(t==null||i==null||t.Obstacle.IsInConvexHull||i.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(i),!t.VisibilityRectangle.intersects(i.VisibilityRectangle)))return null;for(let n of t.PortEntrances)if(!!n.WantVisibilityIntersection)for(let o of i.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=n.IsVertical==o.IsVertical?ll.GetPathPointsFromOverlappingCollinearVisibility(n,o):ll.GetPathPointsFromIntersectingVisibility(n,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!K.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||p.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let i=K.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!i||e.HasGroupCrossingBeforePoint(i)||t.HasGroupCrossingBeforePoint(i)?null:[e.UnpaddedBorderIntersect,i,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,i=W.mkPP(C.RoundPoint(e.PortCurve.boundingBox.leftBottom),C.RoundPoint(e.PortCurve.boundingBox.rightTop)),n=C.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!V.Equal(n.y,i.top)&&!V.Equal(n.y,i.bottom)){o=!0;let l=new B(t.left,n.y,t.right,n.y);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new p(Math.min(a.xx0.x,a.xx1.x),n.y);u.x<i.left&&(u=new p(i.left,u.y));let c=new p(Math.max(a.xx0.x,a.xx1.x),n.y);c.x>i.right&&(c=new p(i.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}if(!V.Equal(n.x,i.left)&&!V.Equal(n.x,i.right)){o=!0;let l=new B(n.x,t.bottom,n.x,t.top);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new p(n.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new p(u.x,t.bottom));let c=new p(n.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new p(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}o||this.CreateEntrancesForCornerPort(i,e,n)}GetBorderIntersections(e,t,i,n){let o=w.getAllIntersections(t,i,!0);n.xx0=C.RoundPoint(o[0].x),n.xx1=C.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,i,n,o){let a=V.GetDirections(n,o);V.EqualPP(n,i)||this.CreatePortEntrance(e,t,o,a),V.EqualPP(o,i)||this.CreatePortEntrance(e,t,n,H.OppositeDir(a))}static GetDerivative(e,t){let i=e.PortCurve.closestParameter(t),n=e.PortCurve.derivative(i),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return Jt.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(n=n.mul(-1)),n}CreatePortEntrance(e,t,i,n){t.CreatePortEntrance(i,n,this.ObstacleTree);let o=At.GetInstance(n),a=K.GetRectangleBound(e,n)-o.Coord(i);if(a<0&&(a=-a),a>C.intersectionEpsilon){let l=H.VectorDirection(ll.GetDerivative(t,i)),u;n|H.OppositeDir(n),0!=(n&l)&&(u=H.OppositeDir(u)),t.CreatePortEntrance(i,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,i){let n=1;V.EqualPP(i,e.leftBottom)?n=4:V.EqualPP(i,e.leftTop)?n=8:V.EqualPP(i,e.rightTop)?n=1:V.EqualPP(i,e.rightBottom)&&(n=2),t.CreatePortEntrance(i,n,this.ObstacleTree),t.CreatePortEntrance(i,H.RotateRight(n),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let i={targetVertex:null},n=e.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,n,i)!=null&&e.AddToAdjacentVertex(this.TransUtil,i.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return K.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,i,n){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o)}FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o){let a=K.SortAscending(e,t),l=a[0],u=a[1],c=K.IsVerticalD(i)?this.HScanSegments:this.VScanSegments,h=K.IsAscending(i)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=K.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(K.IsAscending(i)?l:u,h,d,n,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,i,n,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(i),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,i,t,n,a);if(d!=null)return d}else if(V.EqualPP(e,i))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,H.OppositeDir(t.ScanDirection.Dir));let l=V.GetDirections(i,e),u=V.GetDirections(a.segsegVertex.point,e);if(l==u){let d={bracketTarget:null,bracketSource:null};return Kr.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,H.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,H.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(i),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=K.GetEdgeEnd(c,H.OppositeDir(u)),i=K.SegmentIntersectionPPP(e,i,a.segsegVertex.point),V.EqualPP(a.segsegVertex.point,i)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(i),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,n)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,i,n,o){let l=(i.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(i.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,i.LowestVisibilityVertex,i.Weight);let u=K.SegmentsIntersection(i,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(i,o.segsegVertex,i.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),V.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return V.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,n)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,i){return V.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,i):V.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,i):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():W.mkOnPoints([C.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new pP(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=C.RoundPoint(e);let t=this.VisGraph.FindVertex(e),i=this.FindOrCreateFreePoint(e);if(t!=null)return i;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(i),i;let n=null;i.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(i.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};n=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,i.InitialWeight,l)}let a=4;if(n!=null)a=K.EdgeDirectionVE(n),this.ConnectFreePointToLateralEdge(i,H.RotateLeft(a)),this.ConnectFreePointToLateralEdge(i,H.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(i,a),a=H.RotateLeft(a);return i}CreateOutOfBoundsFreePoint(e){let t=e.Point,i=this.graphGenerator.MakeInBoundsLocation(t),n=V.GetDirections(i,t);if(e.OutOfBoundsDirectionFromGraph=n,!V.IsPureDirectionD(n)){e.AddOobEdgesFromGraphCorner(this.TransUtil,i);return}let o=this.VisGraph.FindVertex(i),a=H.OppositeDir(n);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,i,n,xe.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=K.FindAdjacentVertex(o,H.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,xe.NormalWeight);let u=K.FindAdjacentVertex(o,H.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,xe.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let i=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),n=this.FindorCreateNearestPerpEdgePPDN(i,e.Point,t,e.InitialWeight);n!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,n,t,this.portSpliceLimitRectangle)}};var er=class extends Ee{constructor(e,t,i,n,o){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.UseObstacleRectangles=!1;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=t,this.CornerFitRadius=i,this.BendPenaltyAsAPercentageOfDistance=Yi.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new Fr,this.UseObstacleRectangles=o,this.PortManager=new ll(this.GraphGenerator),this.AddShapes(e)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(e){this.PortManager.RouteToCenterOfObstacles=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=e}AddEdgeGeometryToRoute(e){p.closeDistEps(C.RoundPoint(e.sourcePort.Location),C.RoundPoint(e.targetPort.Location))?this.selfEdges.push(e):this.EdgesToRoute.push(e)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof Fr}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.PaddedPolyline)}AddObstacles(e){this.AddShapes(e),this.RebuildTreeAndGraph()}AddShapes(e){for(let t of e)this.AddObstacleWithoutRebuild(t)}AddObstacle(e){this.AddObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}UpdateObstacles(e){for(let t of e)this.UpdateObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}UpdateObstacle(e){this.UpdateObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}RemoveObstacles(e){for(let t of e)this.RemoveObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}RemoveObstacle(e){this.RemoveObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(e)}UpdateObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(e)),this.CreatePaddedObstacle(e)}CreatePaddedObstacle(e){let t=new Sr(e,this.UseObstacleRectangles,this.Padding);this.ShapeToObstacleMap.set(e,t),this.PortManager.CreateObstaclePorts(t)}RemoveObstacleWithoutRebuild(e){let t=this.ShapeToObstacleMap.get(e);this.ShapeToObstacleMap.delete(e),this.PortManager.RemoveObstaclePorts(t)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let e=this.ObsTree.Root!=null,t=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),e&&this.GenerateObstacleTree(),t&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return er.constructorC(null)}static constructorC(e){return new er([],er.DefaultPadding,er.DefaultCornerFitRadius,!1,!1)}static constructorI(e){return new er(e,er.DefaultPadding,er.DefaultCornerFitRadius,!1,!1)}static constructorINNB(e,t,i,n){return new er(e,t,i,n,!1)}static constructorGNANB(e,t,i,n,o){return this.constructorGNANBB(e,t,i,n,o,!1)}static constructorGNANBB(e,t,i,n,o,a){let l=new er(Br.GetShapes(e),i,n,o,a);if(t==null)for(let u of e.edges())l.AddEdgeGeometryToRoute(u);else for(let u of t)l.AddEdgeGeometryToRoute(u);return l}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let e=this.EdgesToRoute.map(t=>new cP(t));this.FillEdgePathsWithShortestPaths(e),this.NudgePaths(e),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let e of this.selfEdges){let t={smoothedPolyline:null};e.curve=We.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.Padding,2*e.GetMaxArrowheadLength()),t)}}FillEdgePathsWithShortestPaths(e){this.PortManager.BeginRouteEdges();let t=new il(this.BendPenaltyAsAPercentageOfDistance);for(let i of e)this.AddControlPointsAndGeneratePath(t,i);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(e,t){let i=this.PortManager.GetPortVisibilityIntersection(t.GeomEdge);if(i!=null){this.GeneratePathThroughVisibilityIntersection(t,i);return}this.SpliceVisibilityAndGeneratePath(e,t)}GeneratePathThroughVisibilityIntersection(e,t){e.PathPoints=t}SpliceVisibilityAndGeneratePath(e,t){this.PortManager.AddControlPointsToGraph(t.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(e,t,!1)||this.RetryPathsWithAdditionalGroupsEnabled(e,t),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(e,t,i){let n=this.PortManager.FindVertices(t.GeomEdge.sourcePort),o=this.PortManager.FindVertices(t.GeomEdge.targetPort);return er.GetSingleStagePath(t,e,n,o,i)}static GetSingleStagePath(e,t,i,n,o){return e.PathPoints=t.GetPath(i,n),o&&er.EnsureNonNullPath(e),e.PathPoints!=null&&e.PathPoints.length>0}static EnsureNonNullPath(e){e.PathPoints==null&&(V.IsPureDirection(e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location)?e.PathPoints=[e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location]:e.PathPoints=[e.GeomEdge.sourcePort.Location,new p(e.GeomEdge.sourcePort.Location.x,e.GeomEdge.targetPort.Location.y),e.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(e,t){(!this.PortManager.SetAllAncestorsActive(t.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(e,t,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(e,t,!0))}NudgePaths(e){let t=this.ObsTree.SpatialAncestorsAdjusted?it.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;ut.NudgePaths(e,this.CornerFitRadius,this.PaddedObstacles,t,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(e){this.removeStaircases=e}FinaliseEdgeGeometries(){for(let e of this.EdgesToRoute.concat(this.selfEdges)){if(e.curve==null)continue;e.curve instanceof te&&(e.curve=er.FitArcsIntoCorners(this.CornerFitRadius,Array.from(e.curve))),er.CalculateArrowheads(e)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(e){gr.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=it.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(e){this.GraphGenerator.Clear(),this.ClearShortestPaths(),e?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let e of this.EdgesToRoute)e.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(e,t){let i=er.GetFittedArcSegs(e,t),n=new w,o=null;for(let a of i){let l=er.EllipseIsAlmostLineSegment(a);o!=null?l?w.continueWithLineSegmentP(n,er.CornerPoint(a)):(w.continueWithLineSegmentP(n,a.start),n.addSegment(a)):l?w.addLineSegment(n,t[0],er.CornerPoint(a)):(w.addLineSegment(n,t[0],a.start),n.addSegment(a)),o=a}return n.segs.length>0?w.continueWithLineSegmentP(n,t[t.length-1]):w.addLineSegment(n,t[0],t[t.length-1]),n}static CornerPoint(e){return e.center.add(e.aAxis.add(e.bAxis))}static EllipseIsAlmostLineSegment(e){return e.aAxis.lengthSquared<1e-4||e.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(e,t){let i=t[1].sub(t[0]),n=i.normalize(),o=Math.min(e,i.length/2);for(let a=1;a<t.length-1;a++){i=t[a+1].sub(t[a]);let l=i.length;if(l<C.intersectionEpsilon){yield new de(0,0,new p(0,0),new p(0,0),t[a]);continue}let u=i.div(l);Math.abs(u.dot(n))>.9&&(yield new de(0,0,new p(0,0),new p(0,0),t[a]));let c=Math.min(e,i.length/2),h=u.mul(-c),d=n.mul(o);yield new de(0,Math.PI/2,h,d,t[a].sub(d.add(h))),n=u,o=c}}},ku=er;ku.DefaultPadding=1,ku.DefaultCornerFitRadius=3;var Ah=class extends Ee{constructor(e,t,i){super(null);this.graph=e,this.source=t,this.length=i}get Result(){return this.result}run(){let e=new yr((n,o)=>n-o),t=new Map;for(let n of this.graph.shallowNodes()){let o=n==this.source?0:Number.POSITIVE_INFINITY;e.Enqueue(n,o),t.set(n,o)}for(;e.count>0;){let n={priority:0},o=e.DequeueAndGetPriority(n);t.set(o,n.priority);let a=t.get(o);for(let l of o.inEdges()){let u=l.source,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}for(let l of o.outEdges()){let u=l.target,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}}this.result=new Array(this.graph.shallowNodeCount);let i=0;for(let n of this.graph.shallowNodes()){let o=t.get(n);o!=null?this.result[i++]=o:this.result[i++]=Number.POSITIVE_INFINITY}}};var Th=class extends Ee{get Result(){return this.result}set Result(e){this.result=e}constructor(e,t){super(null);this.graph=e,this.length=t}run(){this.result=new Array(this.graph.shallowNodeCount);let e=0;for(let t of this.graph.shallowNodes()){let i=new Ah(this.graph,t,this.length);i.run(),this.Result[e++]=i.Result}}static Stress(e,t){let i=0;if(e.edgeCount==0)return i;let n=new Th(e,t);n.run();let o=n.Result,a=0;for(let u of e.edges())a+=t(u);a/=e.edgeCount;let l=0;for(let u of e.shallowNodes()){let c=0;for(let h of e.shallowNodes()){if(l!=c){let d=u.center.sub(h.center).length,f=a*o[l][c],P=f-d;i+=P*P/(f*f)}c++}l++}return i}};var yP=class extends Ee{get Result(){return this.result}constructor(e,t,i){super(null);this.graph=e,this.pivotArray=t,this.length=i}run(){this.result=new Array(this.pivotArray.length);let e=Array.from(this.graph.shallowNodes()),t=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),i=e[0];this.pivotArray[0]=0;for(let n=0;;n++){let o=new Ah(this.graph,i,this.length);if(o.run(),this.Result[n]=o.Result,n+1<this.pivotArray.length){let a=0;for(let l=0;l<this.Result[n].length;l++)t[l]=Math.min(t[l],this.Result[n][l]),t[l]>t[a]&&(a=l);i=e[a],this.pivotArray[n+1]=a}else break}}};var SP=class{static Rotate(e,t,i){let n=Math.sin(i*(Math.PI/180)),o=Math.cos(i*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+n*t[a];t[a]=o*t[a]-n*e[a],e[a]=l}}};var nt=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),i=new Array(e[0].length).fill(0),n=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],i[a]+=e[o][a],n+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)i[o]/=e[0].length;n/=e.length,n/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+i[a]-n}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[0].length;i++)e[t][i]=Math.pow(e[t][i],2)}static Multiply(e,t){for(let i=0;i<e.length;i++)for(let n=0;n<e[0].length;n++)e[i][n]*=t}static MultiplyX(e,t){if(e[0].length!=t.length)return null;let i=new Array(t.length).fill(0);for(let n=0;n<e.length;n++)for(let o=0;o<e[0].length;o++)i[n]+=e[n][o]*t[o];return i}static Norm(e){let t=0;for(let i=0;i<e.length;i++)t+=Math.pow(e[i],2);return Math.sqrt(t)}static Normalize(e){let t=nt.Norm(e);if(t<=0)return 0;for(let i=0;i<e.length;i++)e[i]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let i=0;i<e;i++)t[i]=ph();return nt.Normalize(t),t}static SpectralDecomposition(e,t){nt.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,i,n){let o=e[0].length;t.u1=nt.RandomUnitLengthVector(o),t.lambda1=0,t.u2=nt.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-n;for(let u=0;u<i&&a<l;u++){let c=nt.MultiplyX(e,t.u1),h=nt.MultiplyX(e,t.u2);t.lambda1=nt.Normalize(c),t.lambda2=nt.Normalize(h),nt.MakeOrthogonal(h,c),nt.Normalize(h),a=Math.min(nt.DotProduct(t.u1,c),nt.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!=t.length)return 0;let i=0;for(let n=0;n<e.length;n++)i+=e[n]*t[n];return i}static MakeOrthogonal(e,t){if(e.length!=t.length)return;let i=nt.DotProduct(e,t)/nt.DotProduct(t,t);for(let n=0;n<e.length;n++)e[n]-=i*t[n]}static ClassicalScaling(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=e[n].slice();nt.SquareEntries(i),nt.DoubleCenter(i),nt.Multiply(i,-.5),nt.SpectralDecomposition(i,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let n=0;n<t.u1.length;n++)t.u1[n]*=t.lambda1,t.u2[n]*=t.lambda2}static DistanceScalingSubset(e,t,i,n,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]==0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!=d&&(c[h]+=n[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let f=0,P=0;for(let E=0;E<a;E++)if(d!=E){let v=Math.sqrt(Math.pow(t[u[d]]-t[E],2)+Math.pow(i[u[d]]-i[E],2));v>0&&(v=1/v),f+=n[d][E]*(t[E]+e[d][E]*(t[u[d]]-t[E])*v),P+=n[d][E]*(i[E]+e[d][E]*(i[u[d]]-i[E])*v)}t[u[d]]=f/c[d],i[u[d]]=P/c[d]}}static DistanceScaling(e,t,i,n,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!=c&&(l[u]+=n[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let f=0;f<a;f++)if(c!=f){let P=Math.sqrt(Math.pow(t[c]-t[f],2)+Math.pow(i[c]-i[f],2));P>0&&(P=1/P),h+=n[c][f]*(t[f]+e[c][f]*(t[c]-t[f])*P),d+=n[c][f]*(i[f]+e[c][f]*(i[c]-i[f])*P)}t[c]=h/l[c],i[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e[n].length).fill(0);for(let o=0;o<e[n].length;o++)e[n][o]>0&&(i[n][o]=Math.pow(e[n][o],t))}return i}static EuclideanDistanceMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e.length);for(let o=0;o<e.length;o++)i[n][o]=Math.sqrt(Math.pow(e[n]-e[o],2)+Math.pow(t[n]-t[o],2))}return i}static LandmarkClassicalScaling(e,t,i){let n=new Array(e.length);for(let l=0;l<e.length;l++){n[l]=new Array(e.length);for(let u=0;u<e.length;u++)n[l][u]=e[l][i[u]]}nt.SquareEntries(n);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=n[l][u];o[l]/=e.length}nt.DoubleCenter(n),nt.Multiply(n,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};nt.SpectralDecomposition(n,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<n.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var Ix=be(zt());var EP=class{constructor(e,t){this.Constrained=!1;this.Capacity=1e6;ot.AbovePP(e.point,t.point)==1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e==this.upperSite||e==this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle==e?this.cwTriangle:this.ccwTriangle}toString(){return Ix.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite==e?this.lowerSite:this.upperSite}};var ul=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let i=new ul(e);return i.Owner=t,i}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite==e)return t}return null}AddInEdge(e){this.InEdges==null&&(this.InEdges=new Array),this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let i=t.upperSite==this?t.CcwTriangle:t.CwTriangle;if(i==null){t=null;break}yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+2)}while(t!=e);if(t!=e){t=e;do{let i=t.upperSite==this?t.CwTriangle:t.CcwTriangle;if(i==null)break;yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var vP=be(qi());var es=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite==e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var np=class{has(e){return e==this.item0||e==this.item1||e==this.item2}index(e){return e==this.item0?0:e==this.item1?1:e==this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var Jr=class{constructor(){this.TriEdges=new np;this.Sites=new np}static mkSSSD(e,t,i,n){let o=p.getTriangleOrientation(e.point,t.point,i.point),a=new Jr;switch(o){case 1:a.FillCcwTriangle(e,t,i,n);break;case 0:a.FillCcwTriangle(e,i,t,n);break;default:throw new Error}return a}static mkSED(e,t,i){let n=new Jr;switch(p.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=n,n.Sites.setItem(0,t.upperSite),n.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=n,n.Sites.setItem(0,t.lowerSite),n.Sites.setItem(1,t.upperSite);break;default:throw new Error}return n.TriEdges.setItem(0,t),n.Sites.setItem(2,e),n.CreateEdge(1,i),n.CreateEdge(2,i),n}static mkSSSEE(e,t,i,n,o,a){let l=Jr.mkSSSD(e,t,i,a);return l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e==t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,i,n){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,i);for(let o=0;o<3;o++)this.CreateEdge(o,n)}CreateEdge(e,t){let i=this.Sites.getItem(e),n=this.Sites.getItem(e+1),o=t(i,n);this.TriEdges.setItem(e,o),this.BindEdgeToTriangle(i,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.TriEdges.getItem(t+1)}OppositeSite(e){let t=this.TriEdges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=W.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,i,n,o,a){let l=new Jr;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,i),l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var xP=class{constructor(e,t,i,n,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.leftPolygon=n,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(p.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite==this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,i=(o=t.CcwTriangle)!=null?o:t.CwTriangle,n=i.TriEdges.index(t);for(let a=1;a<=2;a++){let l=i.TriEdges.getItem(a+n),u=Rr.sign(p.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(Rr.sign(p.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=i,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.TriEdges)if(t.CcwTriangle==null&&t.CwTriangle==null){let i=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,n=Wt.FindNodeInFrontBySite(this.front,i);n.item.Edge==t&&this.elementsToBeRemovedFromFront.push(n.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle==this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var i,n;let e=(i=this.piercedEdge.CwTriangle)!=null?i:this.piercedEdge.CcwTriangle,t=e.TriEdges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.TriEdges.getItem(o+t),l=Rr.sign(p.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(Rr.sign(p.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=Wt.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((n=a.CwTriangle)!=null?n:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.TriEdges)t.CwTriangle==e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(p.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite==this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!=this.b&&(t.length==0||t[t.length-1]!=e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=Wt.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(p.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(p.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let i of this.a.Edges){let n=i.CcwTriangle;if(n==null||p.pointToTheLeftOfLine(this.b.point,i.lowerSite.point,i.upperSite.point))continue;let o=n.TriEdges.index(i),a=n.Sites.getItem(o+2);if(p.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,i.upperSite.point)){this.piercedEdge=n.TriEdges.getItem(o+1),this.piercedTriangle=n;break}}}};var Ih=class{constructor(e,t,i,n){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.createEdgeDelegate=n}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let i of t.TriEdges)(i.CwTriangle==null||i.CcwTriangle==null)&&e.add(i);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new es(t,e))}TriangulatePolygon0(e,t,i,n){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,i,n)}TriangulatePolygon1(e,t,i,n,o,a){let l=i[e],u=e;for(let h=e+1;h<=t;h++){let d=i[h];Ih.LocalInCircle(d,n,o,l,a)&&(u=h,l=d)}let c=Jr.mkSSSD(n,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,i,n,l,a),u<t&&this.TriangulatePolygon1(u+1,t,i,l,o,a)}static LocalInCircle(e,t,i,n,o){return o?op(e,t,n,i):op(e,t,i,n)}TraceEdgeThroughTriangles(){new xP(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var sp=class{constructor(e){this.Edge=e}};var Wt=class extends Ee{constructor(e,t,i,n){super(null);this.front=new bt((e,t)=>e.x-t.x);this.triangles=new Set;if(this.listOfSites=e,this.listOfSites.length==0)return;this.p_1=t,this.p_2=i,this.createEdgeDelegate=n;let o=Jr.mkSSSD(t,i,this.listOfSites[0],n);this.triangles.add(o),this.front.insert(new es(t,o.TriEdges.getItem(2))),this.front.insert(new es(this.listOfSites[0],o.TriEdges.getItem(1)))}run(){if(this.listOfSites.length!=0){for(let e=1;e<this.listOfSites.length;e++)this.ProcessSite(this.listOfSites[e]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let e=this.CreateDoubleLinkedListOfPerimeter();do{let t=this.FindConcaveEdge(e);if(t==null)return;e=this.ShortcutTwoListElements(t)}while(!0)}FindConcaveEdge(e){let t=e,i;do{if(i=t.Next,p.getTriangleOrientation(t.Start.point,t.End.point,i.End.point)==1)return t;t=i}while(i!=e);return null}static FindPivot(e){let t=e,i=e;do i=i.Next,(i.Start.point.x<t.Start.point.x||i.Start.point.x==t.Start.point.x&&i.Start.point.y<t.Start.point.y)&&(t=i);while(i!=e);return t}FindFirsePerimeterEdge(){for(let e of this.triangles)for(let t of e.TriEdges)if(t.GetOtherTriangle_T(e)==null)return t;return null}CreateDoubleLinkedListOfPerimeter(){let e=this.FindFirsePerimeterEdge(),t=e,i=null,n,o=null,a=new Array;do n=Wt.CreatePerimeterElementFromEdge(t),a.push(B.mkPP(n.Start.point,n.End.point)),t=Wt.FindNextEdgeOnPerimeter(t),o!=null?(n.Prev=o,o.Next=n):i=n,o=n;while(t!=e);return i.Prev=n,n.Next=i,i}static FindNextEdgeOnPerimeter(e){var i;let t=(i=e.CwTriangle)!=null?i:e.CcwTriangle;for(e=t.TriEdges.getItem(t.TriEdges.index(e)+2);e.CwTriangle!=null&&e.CcwTriangle!=null;)t=e.GetOtherTriangle_T(t),e=t.TriEdges.getItem(t.TriEdges.index(e)+2);return e}static CreatePerimeterElementFromEdge(e){let t=new sp(e);return e.CwTriangle!=null?(t.Start=e.upperSite,t.End=e.lowerSite):(t.End=e.upperSite,t.Start=e.lowerSite),t}RemoveP1AndP2Triangles(){let e=new Set;for(let t of this.triangles)(t.Sites.has(this.p_1)||t.Sites.has(this.p_2))&&e.add(t);for(let t of e)Wt.RemoveTriangleWithEdges(this.triangles,t)}static RemoveTriangleWithEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle==t?i.CwTriangle=null:i.CcwTriangle=null,i.CwTriangle==null&&i.CcwTriangle==null&&CP(i.upperSite.Edges,i)}static RemoveTriangleButLeaveEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle==t?i.CwTriangle=null:i.CcwTriangle=null}ProcessSite(e){this.PointEvent(e);for(let t=0;t<e.Edges.length;t++){let i=e.Edges[t];i.Constrained&&this.EdgeEvent(i)}}EdgeEvent(e){if(Wt.EdgeIsProcessed(e))return;new Ih(e,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(e){return e.CwTriangle!=null||e.CcwTriangle!=null}ShowFrontWithSite(e,t=null){let i=new Array;if(e.Edges!=null)for(let n of e.Edges)i.push(fe.mkDebugCurveTWCI(200,.8,n.Constrained?"Pink":"Brown",B.mkPP(n.upperSite.point,n.lowerSite.point)));i.push(fe.mkDebugCurveTWCI(200,1,"Brown",de.mkFullEllipseNNP(.5,.5,e.point)));for(let n of this.triangles)for(let o=0;o<3;o++){let a=n.TriEdges.getItem(o);i.push(fe.mkDebugCurveTWCI(a.Constrained?155:100,a.Constrained?.8:.4,a.Constrained?"Pink":"Navy",B.mkPP(a.upperSite.point,a.lowerSite.point)))}if(t!=null)for(let n of t)i.push(fe.mkDebugCurveTWCI(100,.5,"Red",n));for(let n of this.front)i.push(fe.mkDebugCurveTWCI(100,5.5,"Green",B.mkPP(n.Edge.upperSite.point,n.Edge.lowerSite.point)))}Show(e){Wt.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],e)}static ShowCdt(e,t,i,n,o,a){let l=new Array;if(i!=null)for(let u of i)l.push(fe.mkDebugCurveTWCI(200,.1,"Red",u));if(n!=null)for(let u of n)l.push(fe.mkDebugCurveTWCI(200,.1,"Blue",u));if(t!=null)for(let u of t)l.push(fe.mkDebugCurveTWCI(200,.1,"Green",B.mkPP(u.Edge.upperSite.point,u.Edge.lowerSite.point)));for(let u of e)for(let c=0;c<3;c++){let h=u.TriEdges.getItem(c);l.push(Wt.GetDebugCurveOfCdtEdge(h))}l=l.concat(o)}static GetDebugCurveOfCdtEdge(e){return e.CcwTriangle==null||e.CwTriangle==null?fe.mkDebugCurveTWCI(255,.5,e.Constrained?"Brown":"Black",B.mkPP(e.upperSite.point,e.lowerSite.point)):fe.mkDebugCurveTWCI(200,e.Constrained?.8:.2,e.Constrained?"Pink":"Navy",B.mkPP(e.upperSite.point,e.lowerSite.point))}PointEvent(e){let t=this.ProjectToFront(e),i={rightSite:null},n=t.item.x+C.distanceEpsilon<e.point.x?this.MiddleCase(e,t,i):this.LeftCase(e,t,i),o=this.InsertSiteIntoFront(n,e,i.rightSite);this.TriangulateEmptySpaceToTheRight(o),o=Wt.FindNodeInFrontBySite(this.front,n),this.TriangulateEmptySpaceToTheLeft(o)}LeftCase(e,t,i){let n=t.item;this.InsertAndLegalizeTriangle(e,n);let o=this.front.previous(t),a=o.item.LeftSite;i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,o.item),this.front.deleteNodeInternal(o);let l=this.front.remove(n);return a}MiddleCase(e,t,i){let n=t.item.LeftSite;return i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,t.item),this.front.deleteNodeInternal(t),n}TriangulateEmptySpaceToTheLeft(e){let t=e.item.RightSite,i=this.front.previous(e);for(;i!=null;){let n=i.item,o=n.LeftSite,a=n.RightSite;if(a.point.sub(t.point).dot(o.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(i,e),i=this.front.previous(e);else{this.TryTriangulateBasinToTheLeft(e);break}}}ShortcutTwoListElements(e){var a;let t=e.Next,i=Jr.mkSSSEE(e.Start,e.End,t.End,e.Edge,t.Edge,this.createEdgeDelegate);this.triangles.add(i);let n=i.TriEdges.getItem(2);this.LegalizeEdge(e.Start,i.OppositeEdge(e.Start)),i=(a=n.CcwTriangle)!=null?a:n.CwTriangle,this.LegalizeEdge(t.End,i.OppositeEdge(t.End));let o=new sp(n);return o.Start=e.Start,o.End=t.End,e.Prev.Next=o,o.Prev=e.Prev,o.Next=t.Next,t.Next.Prev=o,o}ShortcutTwoFrontElements(e,t){var l;let i=e.item,n=t.item,o=Jr.mkSSSEED(i.LeftSite,i.RightSite,n.RightSite,i.Edge,n.Edge,this.createEdgeDelegate);this.triangles.add(o),this.front.deleteNodeInternal(e),this.front.remove(n);let a=o.TriEdges.getItem(2);return this.LegalizeEdge(i.LeftSite,o.OppositeEdge(i.LeftSite)),o=(l=a.CcwTriangle)!=null?l:a.CwTriangle,this.LegalizeEdge(n.RightSite,o.OppositeEdge(n.RightSite)),this.front.insert(new es(i.LeftSite,a))}TryTriangulateBasinToTheLeft(e){if(!Wt.DropsSharpEnoughToTheLeft(e.item))return;let t=new vP.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=Wt.FindNodeInFrontBySite(this.front,i);let n=this.front.previous(e);if(n==null)return;if(p.getTriangleOrientation(n.item.LeftSite.point,e.item.LeftSite.point,e.item.RightSite.point)==1)t.push(n.item.LeftSite),this.ShortcutTwoFrontElements(n,e);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(n.item.LeftSite);else{if(n.item.LeftSite.point.y<=n.item.RightSite.point.y)return;t.push(n.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(e){let t=e.Edge;if(e.RightSite!=t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x>=.5*i.y}InsertSiteIntoFront(e,t,i){let n=null,o=null;for(let a of t.Edges)if(o==null&&a.lowerSite==e&&(o=a),n==null&&a.lowerSite==i&&(n=a),o!=null&&n!=null)break;return this.front.insert(new es(e,o)),this.front.insert(new es(t,n))}TriangulateEmptySpaceToTheRight(e){let i=e.item.LeftSite.point,n=this.front.next(e);for(;n!=null;){let o=n.item,a=o.LeftSite,l=o.RightSite;if(a.point.sub(i).dot(l.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(e,n),n=this.front.next(e);else{this.TryTriangulateBasinToTheRight(e);break}}}TryTriangulateBasinToTheRight(e){if(!Wt.DropsSharpEnoughToTheRight(e.item))return;let t=new vP.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=Wt.FindNodeInFrontBySite(this.front,i);let n=this.front.next(e);if(n==null)return;if(p.getTriangleOrientation(e.item.LeftSite.point,e.item.RightSite.point,n.item.RightSite.point)==1)this.ShortcutTwoFrontElements(e,n),t.push(i);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(e.item.RightSite);else{if(n.item.LeftSite.point.y>=n.item.RightSite.point.y)return;t.push(e.item.RightSite)}}}static DropsSharpEnoughToTheRight(e){let t=e.Edge;if(e.LeftSite!=t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x<=-.5*i.y}static FindNodeInFrontBySite(e,t){return e.findLast(i=>i.LeftSite.point.x<=t.point.x)}InsertAndLegalizeTriangle(e,t){var i;if(p.getTriangleOrientation(e.point,t.LeftSite.point,t.RightSite.point)!=2){let n=Jr.mkSED(e,t.Edge,this.createEdgeDelegate);this.triangles.add(n),this.LegalizeEdge(e,n.TriEdges.getItem(0))}else{let n=t.Edge;CP(n.upperSite.Edges,n);let o=(i=n.CcwTriangle)!=null?i:n.CwTriangle,a=o.OppositeSite(n);Wt.RemoveTriangleButLeaveEdges(this.triangles,o),o=Jr.mkSSSD(t.LeftSite,a,e,this.createEdgeDelegate);let l=Jr.mkSSSD(t.RightSite,a,e,this.createEdgeDelegate);this.triangles.add(o),this.triangles.add(l),this.LegalizeEdge(e,o.OppositeEdge(e)),this.LegalizeEdge(e,l.OppositeEdge(e))}}LegalizeEdge(e,t){t.Constrained||t.CcwTriangle==null||t.CwTriangle==null||(t.CcwTriangle.Contains(e)?this.LegalizeEdgeForOtherCwTriangle(e,t):this.LegalizeEdgeForOtherCcwTriangle(e,t))}LegalizeEdgeForOtherCwTriangle(e,t){let i=t.CwTriangle.TriEdges.index(t);if(wx(e,t.upperSite,t.CwTriangle.Sites.getItem(i+2),t.lowerSite)){let n=Lx(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}LegalizeEdgeForOtherCcwTriangle(e,t){let i=t.CcwTriangle.TriEdges.index(t);if(wx(e,t.lowerSite,t.CcwTriangle.Sites.getItem(i+2),t.upperSite)){let n=Lx(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}ProjectToFront(e){return this.front.findLast(t=>t.x<=e.point.x)}};function CP(s,e){if(s.length==0)return;let t=s.findIndex(i=>e==i);t>=0&&(t!=s.length-1&&(s[t]=s[s.length-1]),s.pop())}function wx(s,e,t,i){return l2(s,e,t,i)&&op(s,e,t,i)}function l2(s,e,t,i){return p.getTriangleOrientation(e.point,s.point,t.point)==0&&p.getTriangleOrientation(t.point,s.point,i.point)==0}function op(s,e,t,i){let n=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=i.point.x-s.point.x,c=i.point.y-s.point.y,h=n*n+o*o,d=a*a+l*l,f=u*u+c*c;return n*(l*f-c*d)-a*(o*f-c*h)+u*(o*d-l*h)>C.tolerance}function Lx(s,e){let t,i;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,i=e.CwTriangle):(t=e.CwTriangle,i=e.CcwTriangle);let n=t.TriEdges.index(e),o=i.TriEdges.index(e),a=i.Sites.getItem(o+2),l=t.TriEdges.getItem(n+1),u=i.TriEdges.getItem(o+1),c=ot.GetOrCreateEdge(s,a);return t.Sites.setItem(n+1,a),t.TriEdges.setItem(n,u),t.TriEdges.setItem(n+1,c),i.Sites.setItem(o+1,s),i.TriEdges.setItem(o,l),i.TriEdges.setItem(o+1,c),u.lowerSite==a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite==s?l.CcwTriangle=i:l.CwTriangle=i,c.upperSite==s?(c.CcwTriangle=i,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=i),CP(e.upperSite.Edges,e),c}var ot=class extends Ee{constructor(e,t,i){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new dt;this.cdtTree=null;this.isolatedSites=e,this.obstacles=t,this.isolatedSegments=i}static constructor_(e){let t=new ot(null,null,null);return t.isolatedSitesWithObject=e,t}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let e of this.isolatedSitesWithObject)this.AddSite(e[0],e[1]);if(this.isolatedSites!=null)for(let e of this.isolatedSites)this.AddSite(e,null);if(this.obstacles!=null)for(let e of this.obstacles)this.AddPolylineToAllInputSites(e);if(this.isolatedSegments!=null)for(let e of this.isolatedSegments)this.AddConstrainedEdge(e.A,e.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(e,t){let i;return(i=this.PointsToSites.get(e))?i.Owner=t:(i=ul.mkSO(e,t),this.PointsToSites.set(e,i)),i}AddP1AndP2(){let e=W.mkEmpty();for(let n of this.PointsToSites.keys())e.add(n);let t=Math.max(e.width/3,1),i=Math.max(e.height/3,1);this.P1=new ul(e.leftBottom.add(new p(-t,-i))),this.P2=new ul(e.rightBottom.add(new p(t,-i)))}AddPolylineToAllInputSites(e){for(let t=e.startPoint;t.next!=null;t=t.next)this.AddConstrainedEdge(t.point,t.next.point,e);e.closed&&this.AddConstrainedEdge(e.endPoint.point,e.startPoint.point,e)}AddConstrainedEdge(e,t,i){let n=ot.AbovePP(e,t),o,a;n>0?(o=this.AddSite(e,i),a=this.AddSite(t,i)):(o=this.AddSite(t,i),a=this.AddSite(e,i));let l=ot.CreateEdgeOnOrderedCouple(o,a);l.Constrained=!0}static GetOrCreateEdge(e,t){if(ot.AboveCC(e,t)==1){let i=e.EdgeBetweenUpperSiteAndLowerSite(t);return i!=null?i:ot.CreateEdgeOnOrderedCouple(e,t)}else{let i=t.EdgeBetweenUpperSiteAndLowerSite(e);return i!=null?i:ot.CreateEdgeOnOrderedCouple(t,e)}}static CreateEdgeOnOrderedCouple(e,t){return new EP(e,t)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new Wt(this.allInputSites,this.P1,this.P2,ot.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(ot.OnComparison)}static OnComparison(e,t){return ot.AboveCC(e,t)}static AbovePP(e,t){let i=e.y-t.y;return i>0?1:i<0?-1:(i=e.x-t.x,i>0?-1:i<0?1:0)}static AboveCC(e,t){return ot.AbovePP(e.point,t.point)}RestoreEdgeCapacities(){for(let e of this.allInputSites)for(let t of e.Edges)t.Constrained||(t.ResidualCapacity=t.Capacity)}SetInEdges(){for(let e of this.PointsToSites.values())for(let t of e.Edges)t.lowerSite.AddInEdge(t)}FindSite(e){return this.PointsToSites.get(e)}static PointIsInsideOfTriangle(e,t){for(let i=0;i<3;i++){let n=t.Sites.getItem(i).point,o=t.Sites.getItem(i+1).point;if(p.signedDoubledTriangleArea(e,n,o)<C.distanceEpsilon*-1)return!1}return!0}GetCdtTree(){return this.cdtTree==null&&(this.cdtTree=Qe(Array.from(this.GetTriangles().values()).map(e=>ct(e,e.BoundingBox())))),this.cdtTree}EdgeIsCorrect(e){let t=e.upperSite,i=!1;for(let o of t.Edges)if(o==e){i=!0;break}return i?this.PointsToSites.get(t.point)==t:!1}};var cl=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,i=this.clone();return i.add_d(t.start),i.add_d(t.end),i}clone(){return new cl(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new cl(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let i=new cl(e.start,e.end);return i.add_d(t.start),i.add_d(t.end),i}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+C.distanceEpsilon?!1:!(e.end<this.start-C.distanceEpsilon)}};var wh=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let i=this.heapSize;for(this._priors[e]=t,this.PutAtI(i,e);i>1&&this._priors[this._heap[i>>1]]>t;)this.SwapWithParent(i),i>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize==0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this._priors[this._heap[n]]<this._priors[this._heap[t]]&&(i=n);let o=n+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[i]]&&(i=o),i!=t)this.SwapWithParent(i);else break;t=i}}return this.heapSize--,e}IsEmpty(){return this.heapSize==0}DecreasePriority(e,t){this._priors[e]=t;let i=this._reverse_heap[e];for(;i>1&&this._priors[this._heap[i]]<this._priors[this._heap[i>>1]];){this.SwapWithParent(i);i>>=1}}};var AP=class{constructor(e,t,i,n){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=i,this._forLayers=n,this._q=new wh(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=$n([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let i of this._intervalTree.GetAllIntersecting(t)){let n=Oi.GetIdealEdge(e,i,this._nodePositions[e],this._nodePositions[i],this._nodeSizes);if(n.overlapFactor<=1)return;this._proximityEdges.push(n),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,i=this._nodePositions[e].x;return new cl(i-t,i+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,i=this._nodePositions[e].y;this._q.Enqueue(e,i-t),this._q.Enqueue(this._nodeSizes.length+e,i+t)}}};var ap=class{constructor(e,t,i){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=i,this.q=new wh(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),i=this.hedgehog.get(t);this.treeNodes.add(t),e.push(i),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let i=t.target;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let i=t.source;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var Lh=class{static GetMst(e,t){if(e.length==0)return null;let i=e.map(u=>new ge(u.source,u.target)),n=i.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new bn(n+1);for(let u=0;u<e.length;u++)o.setPair(i[u],e[u]);let a=Lr(i,t);return new ap(a,u=>o.get(u.source,u.target).weight,i[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let i=Array.from(e.PointsToSites.values()),n=new Map;for(let u=0;u<i.length;u++)n.set(i[u],u);let o=Lh.GetEdges(i,n),a=mf(Array.from(o.keys()));return new ap(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let i=new bn(e.length);for(let n=0;n<e.length;n++){let o=e[n],a=t.get(o);for(let l of o.Edges)i.set(a,t.get(l.lowerSite),l)}return i}};var Oh=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new Oh;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var Oi=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let i=new Oh;i.RandomizeAllPointsOnStart=!0,i.NodeSeparation=t,new Oi(i,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(u2(this._settings,this._nodes,e),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!=1&&this._nodes.length==2){let e=this._nodes[0],t=this._nodes[1];p.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new p(.001,0)));let i=this.GetIdealDistanceBetweenTwoNodes(e,t),n=p.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(i/a)),e.center=n.add(o),t.center=n.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let i=e.center.sub(t.center),n=Math.abs(i.x),o=Math.abs(i.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return n>C.tolerance&&(u=a/n),o>C.tolerance&&(c=l/o),Math.min(u,c)*i.length}static AvgEdgeLength(e){let t=0,i=0;for(let n of e)for(let o of n.outEdges())i+=n.center.sub(o.target.center).length,t++;return t>0?i/t:1}OneIteration(e,t,i){let n=new Array;for(let h=0;h<e.length;h++)n.push([e[h],h]);let o=ot.constructor_(n);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let f=d.upperSite.point,P=d.lowerSite.point,E=a.get(d.upperSite),v=a.get(d.lowerSite),L=Oi.GetIdealEdge(E,v,f,P,t);u.push(L),L.overlapFactor>1&&l++}if(l==0||i){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l==0&&h==0||l==0&&!i)return!1}let c=Lh.GetMst(u,e.length);return Oi.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,i){return new AP(e,t,i,this._overlapForLayers).Run()}static GetIdealEdge(e,t,i,n,o){let a={overlapFactor:0},l=Oi.GetIdealEdgeLength(e,t,i,n,o,a),u=i.sub(n).length,c=W.mkSizeCenter(o[e],i),h=W.mkSizeCenter(o[t],n),d=a.overlapFactor>1?u-l:Oi.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,i,n,o,a){let l=i.sub(n),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,f=(o[e].height+o[t].height)/2;if(c>=d||h>=f)return a.overlapFactor=1,l.length;let P,E=1e-10;if(c>E)h>E?P=Math.min(d/c,f/h):P=d/c;else if(h>E)P=f/h;else return a.overlapFactor=2,Math.sqrt(d*d+f*f)/4;return P=Math.max(P,1.001),a.overlapFactor=P,P*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let i=0,n=0;return(e.right<t.left||t.right<e.left)&&(n=e.left-t.right),e.top<t.bottom?i=t.bottom-e.top:t.top<e.bottom&&(i=e.bottom-t.top),Math.sqrt(n*n+i*i)}static MoveNodePositions(e,t,i){let n=t.map(a=>a.clone()),o=new Set;o.add(i);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?Oi.MoveNode(l.source,l.target,n,t,o,l.idealDistance):Oi.MoveNode(l.target,l.source,n,t,o,l.idealDistance)}}static MoveNode(e,t,i,n,o,a){let l=i[t].sub(i[e]);l=l.mul(a/l.length+.01),n[t]=n[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function u2(s,e,t){t.nodePositions=e.map(i=>i.center),t.nodeSizes=e.map(i=>{let n=i.boundingBox.size;return n.width+=s.NodeSeparation,n.height+=s.NodeSeparation,n})}var Uu=class extends Ee{constructor(e,t,i,n){super(i);this.settings=e,this.graph=t,this.length=n}run(){this.LayoutConnectedGraphWithMds(),this.SetGraphBoundingBox()}SetGraphBoundingBox(){this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}static ScaleToAverageEdgeLength(e,t,i,n){let o=new Map,a=0;for(let c of e.shallowNodes())o.set(c,a),a++;let l=0,u=0;for(let c of e.edges()){let h=o.get(c.source),d=o.get(c.target);u+=Math.sqrt(Math.pow(t[h]-t[d],2)+Math.pow(i[h]-i[d],2)),l+=n(c)}if(l>0&&(u/=l),u>0)for(let c=0;c<t.length;c++)t[c]/=u,i[c]/=u}static LayoutGraphWithMds(e,t,i,n){if(i.x=new Array(e.shallowNodeCount),i.y=new Array(e.shallowNodeCount),i.x.length==0)return;if(i.x.length==1){i.x[0]=i.y[0]=0;return}let o=Math.min(t.PivotNumber,e.shallowNodeCount),a=t.GetNumberOfIterationsWithMajorization(e.shallowNodeCount),l=t.Exponent,u=new Array(o),c=new yP(e,u,n);c.run();let h=c.Result;if(nt.LandmarkClassicalScaling(h,i,u),Uu.ScaleToAverageEdgeLength(e,i.x,i.y,n),a>0){let d=new Th(e,n);d.run();let f=d.Result,P=nt.ExponentialWeightMatrix(f,l);nt.DistanceScalingSubset(f,i.x,i.y,P,a)}}LayoutConnectedGraphWithMds(){let e={x:[],y:[]};Uu.LayoutGraphWithMds(this.graph,this.settings,e,this.length),this.settings.RotationAngle!=0&&SP.Rotate(e.x,e.y,this.settings.RotationAngle);let t=0;for(let i of this.graph.shallowNodes())i.boundingBox&&(i.center=new p(e.x[t]*this.settings.ScaleX,e.y[t]*this.settings.ScaleY)),t++;this.settings.RemoveOverlaps&&Oi.RemoveOverlaps(Array.from(this.graph.shallowNodes()),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}ScaleNodes(e,t){for(let i of e)i.center=i.center.mul(t)}static PackGraphs(e,t){if(e.length==0)return W.mkEmpty();if(e.length==1)return e[0].boundingBox;let i=e.map(a=>a.boundingBox),n=new Array;for(let a of e)n.push({g:a,lb:a.boundingBox.leftBottom.clone()});let o=new th(i,t.PackingAspectRatio);o.run();for(let{g:a,lb:l}of n){let u=a.boundingBox.leftBottom.sub(l);a.translate(u)}return new W({left:0,bottom:0,right:o.PackedWidth,top:o.PackedHeight})}};var lo=class extends ah{constructor(){super(...arguments);this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this.removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=3e3;this.adjustScale=!1}get RemoveOverlaps(){return this.removeOverlaps}set RemoveOverlaps(e){this.removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get IdealEdgeLength(){return this.edgeConstraints}set IdealEdgeLength(e){this.edgeConstraints=e}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var TP=class extends Ee{get scaleX(){return this.settings.ScaleX}set scaleX(e){this.settings.ScaleX=e}get scaleY(){return this.settings.ScaleY}set scaleY(e){this.settings.ScaleY=e}constructor(e,t,i,n){super(t);this.graph=e,this.length=i,this.settings=n,this.settings.ScaleX=this.settings.ScaleY=200}run(){new Uu(this.settings,this.graph,this.cancelToken,this.length).run()}};var hv=be(mp());var dv=(n=>(n[n.OverlapsOtherLabels=0]="OverlapsOtherLabels",n[n.OverlapsNodes=1]="OverlapsNodes",n[n.OverlapsEdges=2]="OverlapsEdges",n[n.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",n))(dv||{});var fv=class{},pv=class{constructor(){this.points=new hv.LinkedList;this.coveredLength=0}AddFirst(e){if(this.points.size!=0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!=0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var kP=class{constructor(e){this.location=e,this.boundingBox=W.rectangleOnPoint(e)}},qu=class{constructor(e,t){this.data=t,this.boundingBox=e}},gv=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},je=class extends Ee{constructor(e,t){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=je.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(t.length):je.MinGranularity,this.InitializeObstacles(e,t),this.edges=t}get CollisionGranularity(){return this.granularity}set CollisionGranularity(e){this.granularity=e}static constructorG(e){return new je(Array.from(e.deepNodesIt()),Array.from(e.deepEdges()).filter(t=>t.label))}static constructorGA(e,t){return new je(Array.from(e.deepNodesIt()),t.filter(i=>i.label))}interpolateGranularity(e){if(e<=je.LowerEdgeBound)return je.MaxGranularity;if(e>=je.UpperEdgeBound)return je.MinGranularity;let t=(je.UpperEdgeBound-je.LowerEdgeBound)/(e-je.LowerEdgeBound);return Math.ceil(je.MinGranularity+t)}InitializeObstacles(e,t){let i=this.GetEdgeObstacles(t);this.obstacleMaps[1]=$n(e.map(n=>[n.boundingBox,new qu(n.boundingBox,n)])),this.obstacleMaps[2]=$n(i.map(n=>[n.boundingBox,new qu(n.boundingBox,n)]))}static CurvePoints(e,t){let i=[],n=e.end.sub(e.start).lengthSquared/(t*t);return je.SubdivideCurveSegment(i,e,n,e.parStart,e.parEnd),i.sort(fE),i}static SubdivideCurveSegment(e,t,i,n,o){if(e.length>64)return;let a=t.value(n),l=t.value(o);if(a.sub(l).lengthSquared>i){let u=(n+o)/2;je.SubdivideCurveSegment(e,t,i,n,u),je.SubdivideCurveSegment(e,t,i,u,o)}else e.push([n,a])}static PlaceLabelsAtDefaultPositions(e,t){for(let i of t)i.label&&new je([i.source,i.target],[i]).run()}GetEdgeObstacles(e){let t=[];for(let i of e){if(i.curve==null)continue;let n=je.CurvePoints(i.curve,this.CollisionGranularity);this.edgeInfos.set(i,new gv(n));for(let o of n)t.push(new kP(o[1]))}return t}AddLabelObstacle(e){this.labelObstacleMap==null?(this.labelObstacleMap=$n([[e.boundingBox,e]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(e.boundingBox,e)}run(){this.edges.sort((e,t)=>this.edgeInfos.get(e).edgePoints.length-this.edgeInfos.get(t).edgePoints.length);for(let e of this.edges)this.PlaceLabel(e)}PlaceLabel(e){let t=!1;for(let i of this.placementStrategy){switch(i){case 0:t=this.PlaceEdgeLabelOnCurve(e.label);break;case 1:t=this.PlaceEdgeLabelHorizontally(e.label);break;default:throw new Error("unexpected case")}if(t)break}t?this.CalculateCenterLabelInfoCenter(e.label):this.PlaceLabelAtFirstPosition(e.label)}getLabelInfo(e){let t=We.getGeom(e.label.parent);return this.edgeInfos.get(t)}PlaceLabelAtFirstPosition(e){let t=We.getGeom(e.label.parent),i=t.curve,n=this.edgeInfos.get(t).edgePoints,o=this.StartIndex(e,n.map(f=>f[1])),a=n[o][1],l=i.derivative(n[o][0]);l.length<C.distanceEpsilon&&(l=new p(1,1)),l=l.normalize();let u=new $t(e.width,e.height),c=this.getLabelInfo(e),h=je.GetPossibleSides(c.placementSide,l)[0],d=je.GetLabelBounds(a,l,u,h);this.SetLabelBounds(this.getLabelInfo(e),d)}StartIndex(e,t){let i=this.getLabelInfo(e);return Math.min(t.length-1,Math.max(0,Math.floor(t.length*i.placementOffset)))}CalculateCenterLabelInfoCenter(e){let t=this.getLabelInfo(e),i=new p(0,0);for(let n of t.innerPoints)i=i.add(n);for(let n of t.outerPoints)i=i.add(n);e.center=i.div(t.innerPoints.length+t.outerPoints.length)}static geomEdge(e){return We.getGeom(e.label.parent)}PlaceEdgeLabelHorizontally(e){let i=this.getLabelInfo(e).edgePoints,n=new $t(e.width,e.height),o=-1,a=W.mkEmpty(),l=je.geomEdge(e).curve;for(let u of je.ExpandingSearch(this.StartIndex(e,i.map(c=>c[1])),0,i.length)){let c=i[u],h=l.derivative(c[0]).normalize();if(!ae(h.lengthSquared,0)){for(let d of je.GetPossibleSides(this.getLabelInfo(e).placementSide,h)){let f=je.GetLabelBounds(c[1],h,n,d),P=this.ConflictIndexRL(f,e);if(P>o&&(o=P,a=f,o==Number.MAX_VALUE))break}if(o==Number.MAX_VALUE)break}}if(o>=0){this.SetLabelBounds(this.getLabelInfo(e),a);let u=new qu(a,null);this.AddLabelObstacle(u);let c=this.getLabelInfo(e);return o==0?c.placementResult=0:o==1?c.placementResult=1:o==2?c.placementResult=2:c.placementResult=dv.OverlapsNothing,!0}return!1}static GetLabelBounds(e,t,i,n){let o=t.rotate(Math.PI/2).mul(n),a=e.add(o),l=1,u=o.x>0?a.x:a.x-i.width,c=o.y>0?a.y:a.y-i.height;if(Math.abs(o.x)<.75){let h=Math.acos(Math.abs(o.y)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?-1:1)*Math.min(d,i.width/2),c+=(o.y>0?1:-1)*f}else if(Math.abs(o.y)<.75){let h=Math.acos(Math.abs(o.x)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?1:-1)*f,c+=(o.y>0?-1:1)*Math.min(d,i.height/2)}return W.mkLeftBottomSize(u,c,i)}SetLabelBounds(e,t){e.innerPoints=[t.leftTop,t.rightTop],e.outerPoints=[t.leftBottom,t.rightBottom]}static GetPossibleSides(e,t){switch(t.length==0&&(e=0),e){case 1:return[-1];case 2:return[1];case 3:return ae(t.x,0)?je.GetPossibleSides(5,t):[1];case 4:return ae(t.x,0)?je.GetPossibleSides(6,t):[t.x<0?-1:1];case 5:return ae(t.y,0)?je.GetPossibleSides(3,t):[t.y<0?-1:1];case 6:return ae(t.y,0)?je.GetPossibleSides(4,t):[t.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(e,t,i){let n=e+1,o=n;for(;o>t;)yield--o;for(;n<i;)yield n++}static PointSetLength(e){let t=0,i=null;for(let n of e)i!=null&&(t+=i.sub(n.Center).length),i=n.Center;return t}PlaceEdgeLabelOnCurve(e){let t=We.getGeom(e.label.parent),i=this.getLabelInfo(e);i.innerPoints=null;let n=i.edgePoints,o=3,a=e.height/2,l=new $t(a,a),u=e.width;for(let c of je.ExpandingSearch(this.StartIndex(e,n),0,n.length)){let h=this.GetSidesAndEdgeCurve(e,t,n,c);for(let d of h){let f=new pv,P={coveredLength:0};if(this.ProcessExpandingSearchOnSide(c,n,t.curve,d,a,o,l,P,f,u),P.coveredLength>=u)return this.CaseOfCoveredLengthGreaterThanLabelLength(e,f,P.coveredLength,u,l),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(e,t,i,n,o){let a=new Array,l=new Array,u=Array.from(t.points),c=i-n;if(c>0){let d=u[u.length-1],f=u[u.length-2],P=d.Center.sub(f.Center),E=P.length;c>E&&(d=u[0],f=u[1],P=d.Center.sub(f.Center),E=P.length);let v=P.mul((E-c)/E);d.Center=f.Center.add(v),d.Inner=f.Inner.add(v),d.Outer=f.Outer.add(v)}this.GoOverOrderedPointsAndAddLabelObstacels(u,a,l,o);let h=this.getLabelInfo(e);h.innerPoints=a,h.outerPoints=l}GoOverOrderedPointsAndAddLabelObstacels(e,t,i,n){for(let o of e){let a=o.Center;t.push(o.Inner),i.push(o.Outer);let l=new qu(W.mkSizeCenter(new $t(n.width*2,n.height*2),a),null);this.AddLabelObstacle(l)}}ProcessExpandingSearchOnSide(e,t,i,n,o,a,l,u,c,h){for(let d of je.ExpandingSearch(e,0,t.length)){let[f,P]=t[d],E=i.derivative(f);if(ae(E.lengthSquared,0))continue;let v=E.rotate(Math.PI/2).normalize().mul(n),L=P.add(v.mul(o+a));if(this.Conflict(L,o,l))break;{let O=new fv;if(O.Center=L,O.Inner=P.add(v.mul(a)),O.Outer=P.add(v.mul(2*o+a)),u.coveredLength=d<=e?c.AddFirst(O):c.AddLast(O),u.coveredLength>=h)break}}}GetSidesAndEdgeCurve(e,t,i,n){let o=t.curve.derivative(i[n][0]);return je.GetPossibleSides(this.getLabelInfo(e).placementSide,o)}Conflict(e,t,i){return this.ConflictIndex(e,t,i)!=Number.MAX_VALUE}ConflictIndexRL(e,t){let i=We.getGeom(t.label.parent),n=i.source,o=i.target;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l of this.obstacleMaps[a].GetAllIntersecting(e))if(!(a==1&&l instanceof qu&&l.data instanceof Re!=null&&(n.node.isDescendantOf(l.data.graph)||o.node.isDescendantOf(l.data))))return a}return Number.MAX_VALUE}ConflictIndex(e,t,i){let n=W.creatRectangleWithSize(new $t(i.width*2,i.height*2),e),o=t*t;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null)for(let u of this.obstacleMaps[l].GetAllIntersecting(n))if(u instanceof kP){if(e.sub(u.location).lengthSquared<o)return l}else return l;return Number.MAX_VALUE}}},fl=je;fl.MinGranularity=5,fl.MaxGranularity=50,fl.LowerEdgeBound=500,fl.UpperEdgeBound=3e3;function mv(s){s.layoutSettings||(s.layoutSettings=N2(s))}function N2(s){if(s.graph.shallowNodeCount>2e3||s.graph.nodeCollection.edgeCount>4e3)return new lo;let t=!1;for(let i of s.edges())if(i.sourceArrowhead!=null||i.targetArrowhead!=null){t=!0;break}return t?new Xr:new lo}function D2(s,e){if(mv(s),s.layoutSettings instanceof Xr)new Fh(s,s.layoutSettings,e).run();else if(s.layoutSettings instanceof lo)new TP(s,e,()=>1,s.layoutSettings).run();else throw Error("not implemented")}function UP(s,e=null){mv(s),Rh(s,e,D2,hl,gf)}function zP(s){do{if(s.layoutSettings&&s.layoutSettings.edgeRoutingSettings)return s.layoutSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=Ue.getGeom(t);else break}while(!0);let e=new yu;return e.EdgeRoutingMode=0,e}function hl(s,e,t){let i=zP(s);i.EdgeRoutingMode==4?bv(s,e,t):i.EdgeRoutingMode==0||i.EdgeRoutingMode==1?yv(s,e,t):i.EdgeRoutingMode==2?Sv(s,e,t):i.EdgeRoutingMode!=6&&new it(s,e).run(),Pv(s)}function Rh(s,e,t,i,n,o=!0,a=1){if(s.graph.isEmpty())return;If(a),V2(s);let l=f();d(s);let u=F2(s.graph),c=G2(s);if(P(),u.forEach(E=>{E[0].edge.remove(),E[1].add()}),c.forEach(E=>{for(let v of E.graph.shallowNodes)v.parent=s.graph}),l.forEach(E=>E.add()),s.graph.parent==null){let E=h(s);i(s,E,e),Pv(s),o&&s.FlipYAndMoveLeftTopToOrigin()}function h(E){let v=[];for(let L of E.deepNodesIt()){for(let O of L.outEdges())O.curve==null&&v.push(O);for(let O of L.selfEdges())O.curve==null&&v.push(O)}return v}function d(E){for(let v of E.shallowNodes())if(v instanceof Re){let L=v;if(Rh(L,e,t,i,n),!L.graph.isEmpty()){let O=L.boundingBox;O&&!O.isEmpty()&&(v.boundaryCurve=Be.mkRectangleWithRoundedCorners(O.width,O.height,Math.min(10,O.width/10),Math.min(10,O.height/10),O.center))}}}function f(){let E=new Set,v=s.graph;if(v.parent==null)return E;for(let L of v.shallowNodes){for(let O of L.outEdges){let D=v.liftNode(O.target);(D==null||D==L)&&E.add(O)}for(let O of L.inEdges){let D=v.liftNode(O.source);(D==null||D==L)&&E.add(O)}}for(let L of E)L.remove();return E}function P(){if(c.length!=0){for(let E of c)t(E,e);n(s,c)}}}function F2(s){let e=new Array;for(let t of s.deepNodes){let i=s.liftNode(t);if(i!=null)for(let n of t.outEdges.values()){let o=n.target,a=s.liftNode(o);if(a==null||i==t&&a==o||i==a)continue;n.remove();let l=new Go(i,a),u=new We(l);e.push([u,n])}}return e}function G2(s){let e=s.graph,t=hE(e),i=[],n=0;for(let o of t){let a=new Ze(e.id+n++);a.parent=e;let l=new Re(a);l.layoutSettings=s.layoutSettings;for(let u of o)u.parent=a,a.addNode(u);i.push(l)}return i}function bv(s,e,t,i=1,n=3){ku.constructorGNANB(s,e,i,n,!0).run()}function Pv(s){let e=Array.from(s.deepEdges()).filter(i=>i.label&&i.label.isPositioned==!1);if(e.length==0)return;fl.constructorGA(s,e).run()}function V2(s){for(let e of s.deepEdges())e.label&&e.label.requirePositioning()}var Gh=class{static constructorStatic(e,t){let i=new Gh;i.edges=e,i.nodeBoundaries=t,i.boundingBox=W.mkEmpty();for(let n of i.nodeBoundaries)i.boundingBox=i.boundingBox.addRec(n.boundingBox);return i}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=yn(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var xv=be(qi());var Ev=be(mp());var pl=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,i){this.currentTriangle=e,this.start=t,this.end=i}*Triangles(){for(;this.MoveNext();)yield this.CurrentTriangle}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!=t&&p.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.TriEdges.item0;let i=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!=i&&p.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=i,this.currentTriangle.TriEdges.item1):(this.positiveSign=i,this.negativeSign=e,this.currentTriangle.TriEdges.item2)}static PointLocationForTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=p.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<C.distanceEpsilon*-1)return 0;o<C.distanceEpsilon&&(i=!0)}return i?1:2}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.TriEdges.index(this.currentPiercedEdge),t,i=this.currentTriangle.Sites.getItem(e+2),n=this.GetHyperplaneSign(i);this.negativeSign==0?n==-1||n==0?(this.negativeSign=n,t=e+1):t=e+2:this.positiveSign==0?n==1||n==0?(this.positiveSign=n,t=e+2):t=e+1:n!=this.positiveSign?(this.negativeSign=n,t=e+1):(this.positiveSign=n,t=e+2),this.currentPiercedEdge=p.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-C.distanceEpsilon?this.currentTriangle.TriEdges.getItem(t):null}GetHyperplaneSign(e){let t=p.signedDoubledTriangleArea(this.start,e.point,this.end);return t>C.distanceEpsilon?1:t<C.distanceEpsilon*-1?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var Vh=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,i,n){if(ot.PointIsInsideOfTriangle(t,i))return!0;let o=new pl(i,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.Constrained){let l=a.lowerSite.Owner;if(!n.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,i,n,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.CdtTriangle,n,i,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,i,n,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,i,n,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new Ev.HashSet;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(n.has(d))continue;let f=Vh.FindPolylinePoint(d,h.point),P=B.minDistBetweenLineSegments(f.point,f.nextOnPolyline.point,t,i),E=P.dist,v=P.parab,L=P.parcd,O=B.minDistBetweenLineSegments(f.point,f.prevOnPolyline.point,t,i),D=O.dist,_=O.parab,F=O.parcd,X,$,se;if(E<D){if(se=E,se>o)continue;X=f.point.add(f.nextOnPolyline.point.sub(f.point).mul(v)),$=t.add(i.sub(t).mul(L))}else{if(se=D,se>o)continue;X=f.point.add(f.prevOnPolyline.point.sub(f.point).mul(_)),$=t.add(i.sub(t).mul(F))}a.get(d)||a.set(d,[X,$])}return a}ThreadLineSegmentThroughTriangles(e,t,i,n,o){if(ot.PointIsInsideOfTriangle(i,e))return o.push(e),!0;let a=new pl(e,t,i);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.Constrained){let u=l.lowerSite.Owner;if(!n.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=p.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<C.distanceEpsilon*-1)return 0;o<C.distanceEpsilon&&(i=!0)}return i?1:2}static FindPolylinePoint(e,t){for(let i of e.polylinePoints())if(i.point.equal(t))return i;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,i,n){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.CdtTriangle,i,n,a,o)}static closedeb(e,t){return e.Position.sub(new p(360.561,428.416)).length<.1&&t.Position.sub(new p(414.281,440.732)).length<.1}EdgeIsLegalSSPPS(e,t,i){let n=e.Position,o=e.CdtTriangle,a=t.Position;if(ot.PointIsInsideOfTriangle(a,o))return!0;let l=new pl(o,n,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.Constrained){let c=u.lowerSite.Owner;if(!i.has(c))return!1}}return!0}};var ri=class{constructor(e,t,i,n){this.metroGraphData=e,this.obstaclesToIgnoreLambda=n,this.bundlingSettings=t,this.obstacleTree=i}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?yn(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,i,n){let o={minimalDistance:i};return ri.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,i){let n={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,i,n,o)}GetMinimalDistanceToObstacles(e,t,i){let n=new Array,o={minimalDistance:i};return ri.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,i,n,o){return n.touchedObstacles=new Array,o.minimalDistance=t,ri.IntersectCircleWithTree(this.obstacleTree,e,t,i,n.touchedObstacles,o)}static IntersectCircleWithTree(e,t,i,n,o,a){if(!e.irect.contains_point_radius(t,i))return!0;if(e.UserData==null){let l=ri.IntersectCircleWithTree(e.Left,t,i,n,o,a);if(!l||(l=ri.IntersectCircleWithTree(e.Right,t,i,n,o,a),!l))return!1}else{let l=e.UserData;if(n.has(l))return!0;if(w.PointRelativeToCurveLocation(t,l)!=0)return ri.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=i&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,i,n){let o=t.sub(e).normalize();return o=new p(o.y,o.x*-1),te.mkFromPoints([e.add(o.mul(i/2)),e.sub(o.mul(i/2)),t.sub(o.mul(n/2)),t.add(o.mul(n/2))])}};var HP=class{constructor(e,t,i,n){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=i,this.Index=n}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var WP=class{constructor(e,t,i){this.metroline=e,this.station=t,this.polyPoint=i}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var jP=class{constructor(e,t,i){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=i}debStop(){return this.SerialNumber==28&&this.Position.sub(new p(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}static less(e,t){return e.SerialNumber<t.SerialNumber}static greater(e,t){return e.SerialNumber>t.SerialNumber}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var qP=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Gt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Gt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new yr(Ae);for(let n of this.metroGraphData.VirtualStations())t.Enqueue(n,-this.CalculatePotential(n,e));let i=!1;for(;!t.IsEmpty();){let n={priority:0},o=t.DequeueAndGetPriority(n);if(n.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),i=!0)}return i}TryGrowHub(e,t){let i=this.CalculateAllowedHubRadius(e);if(e.Radius>=i)return!1;let n=t?Gt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=n)return!1;let a=.05*(n-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,i);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let i=t?Gt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return i<=e.Radius?0:(i-e.Radius)/i}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let n of e.Neighbors){let o=n.Position.sub(e.Position).length;t=Math.min(t,o/1.05-n.Radius)}let i=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return i<t&&(t=i-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,i){let n=1;for(let o of i.Neighbors){let l=e.GetWidthSSN(o,i,t.EdgeSeparation)/2+t.EdgeSeparation;n=Math.max(n,l)}return n=Math.min(n,2*t.MaxHubRadius),n}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,i){return Gt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,i.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,n){let o=Gt.CalculateIdealHubRadius(e,t,i);if(i.Neighbors.length>1){let a=i.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Gt.GetMinRadiusForTwoAdjacentBundles(o,i,n,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let i=e.MaxHubRadius;for(let n of t.Neighbors)i=Math.min(i,t.Position.sub(n.Position).length/2);return i}static GetMinRadiusForTwoAdjacentBundles(e,t,i,n,o,a,l){let u=a.GetWidthSSN(t,n,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Gt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,i,n.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,i,n,o,a,l){if(o<C.distanceEpsilon||a<C.distanceEpsilon)return e;let u=p.anglePCP(i,t,n);if(u=Math.min(u,Math.PI*2-u),u<C.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),f=a/(4*c),P=2*Math.sqrt(d*d+(f*f+2*(d*(f*h))));return P=Math.min(P,2*l.MaxHubRadius),P=Math.max(P,e),P}};var gl=class{constructor(e,t,i,n){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=i,this.cdt=n}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Gt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],i=e[1],n=this.metroGraphData.GetIjInfo(t,i);n.cachedBundleCost=this.costCalculator.BundleCost(t,i,t.Position),t.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.GetCdtTree();e.CdtTriangle=t.FirstHitNodeWithPredicate(e.Position,gl.testPointInside).UserData,e.cachedIdealRadius=Gt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let i of e.Neighbors){i.IsReal||(i.cachedIdealRadius=Gt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,i),i.cachedRadiusCost=this.costCalculator.RadiusCost(i,i.Position));let n=this.metroGraphData.GetIjInfo(e,i);i.cachedBundleCost-=n.cachedBundleCost,n.cachedBundleCost=this.costCalculator.BundleCost(e,i,e.Position),e.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}static testPointInside(e,t){return ot.PointIsInsideOfTriangle(e,t)?1:0}};var kh=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size==0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let i=this.mainMap.get(e);if(i)return i.get(t)}has(e,t){let i=this.mainMap.get(e);return i?i.has(t):!1}set(e,t,i){let n=this.mainMap.get(e);n||(n=new Map,this.mainMap.set(e,n)),n.set(t,i)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[i,n]of t)yield[e,i,n]}*keys(){for(let[e,t]of this.mainMap)for(let[i]of t)yield[e,i]}};var XP=class{constructor(e,t,i,n,o,a,l,u){this.cachedEnterableLooseForEnd=new dt;this.bundlingSettings=n,this.regularEdges=e,o!=null?this.Cdt=o:this.Cdt=Cn.CreateConstrainedDelaunayTriangulation(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new ri(this,n,t,c=>c.getELP()),this.tightIntersections=new ri(this,n,i,c=>c.EnterableTightPolylines),this.cdtIntersections=new Vh(this,n),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],n=this.edgeInfoDictionary.get(i[0],i[1]);return n?n.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(i[0],i[1])}MoveNode(e,t){let i=e.Position;this.PointToStations.deleteP(i),this.PointToStations.set(t,e),e.Position=t;for(let n of this.MetroNodeInfosOfNode(e))n.PolyPoint.point=t;for(let n of this.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(i).length-a.sub(i).length}for(let n of e.Neighbors)this.ink+=t.sub(n.Position).length-i.sub(n.Position).length;this.SortNeighbors(e);for(let n of e.Neighbors)this.SortNeighbors(n)}GetWidthSSN(e,t,i){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(n[0],n[1]);return o?o.Width+(o.Count-1)*i:0}GetWidthAN(e,t){let i=0;for(let o of e)i+=o.Width;let n=e.length;return i+=n>0?(n-1)*t:0,i}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,i=new xv.Stack,n=new Je;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(n.has(o.point)){let l=o.next;do{let u=i.top;if(!u.equal(a))n.delete(u),i.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else i.push(a),n.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new dt;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!=e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let i=new jP(this.Stations.length,t,e.point);this.PointToStations.set(e.point,i),this.Stations.push(i)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let i=new HP(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(i),this.PointToStations.get(i.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(i.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let i=this.PointToStations.get(t.Polyline.start),n;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,i=n)n=this.PointToStations.get(o.next.point),Wa(e,i,n),Wa(e,n,i)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new p(360.561,428.416)).length<.1&&t.Position.sub(new p(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let i=this.edgeInfoDictionary.get(e,t);return i||(i=new qP,this.edgeInfoDictionary.set(e,t,i),i)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new kh,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let i=this.metrolines[t];this.InitMetroNodeInfos(i),this.InitNodeEnterableLoosePolylines(i,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(i,this.regularEdges[t]),i.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let i=this.PointToStations.get(t.point);i.MetroNodeInfos.push(new WP(e,i,t))}}InitNodeEnterableLoosePolylines(e,t){let i=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point);o.getELP()!=null?o.setELP(Sn(o.getELP(),i)):o.setELP(new Set(i))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let i of this.LooseTree.AllHitItems_(e))w.PointRelativeToCurveLocation(e,i)==2&&t.AddEnterableLoosePolyline(i);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let i of this.TightTree.AllHitItems_(e))w.PointRelativeToCurveLocation(e,i)==2&&t.AddEnterableTightPolyline(i)}InitNodeEnterableTightPolylines(e,t){let i=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=Sn(a,i):o.EnterableTightPolylines=new Set(i)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,i=e.Position;e.Neighbors.sort((n,o)=>co(t.sub(i),n.Position.sub(i),o.Position.sub(i)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,i=this.PointToStations.get(t.start),n;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,i=n){n=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(i,n);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.Cdt.GetCdtTree();for(let t of this.Stations)t.CdtTriangle=e.FirstHitNodeWithPredicate(t.Position,gl.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let i=e.sourceAndTargetLoosePolylines();return w.PointRelativeToCurveLocation(t,i[0])==0&&w.PointRelativeToCurveLocation(t,i[1])==0}};function co(s,e,t){let i=p.crossProduct(s,t),n=s.dot(t),o=p.crossProduct(s,e),a=s.dot(e);return ae(o,0)&&Uh(a,0)?ae(i,0)&&Uh(n,0)?0:1:ae(i,0)&&Uh(n,0)?-1:ae(o,0)||ae(i,0)||o*i>0?eh(p.crossProduct(t,e),0):-eh(Math.sign(o),0)}function Uh(s,e){return eh(s,e)>=0}var Av=be(qi());var ho=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,i){return(e-t)*i.InkImportance}static PathLengthsError(e,t,i,n){return(e-t)*(n.PathLengthImportance/i)}static RError(e,t,i){return e<=t?0:i.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,i){return e<=t?0:i.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let i=t.InkImportance*e.Ink;for(let n of e.Metrolines)i+=t.PathLengthImportance*n.Length/n.IdealLength;return i+=this.CostOfForces(e),i}static CostOfForces(e){let t=0;for(let i of e.VirtualStations())t=t+i.cachedRadiusCost;for(let i of e.VirtualEdges()){let n=i[0],o=i[1];t+=e.GetIjInfo(n,o).cachedBundleCost}return t}InkGain(e,t){let i=this.metroGraphData.Ink,n=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;n-=a.sub(e.Position).length,n+=a.sub(t).length}return ho.InkError(i,n,this.bundlingSettings)}PathLengthsGain(e,t){let i=0;for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline.Length,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point,u=n.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;i+=ho.PathLengthsError(o,u,n.Metroline.IdealLength,this.bundlingSettings)}return i}RadiusGain(e,t){let i=0;return i=i+e.cachedRadiusCost,i=i-this.RadiusCost(e,t),i}RadiusCost(e,t){let i;p.closeDistEps(e.Position,t)?i=e.cachedIdealRadius:i=Gt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,i,n))return ho.Inf;let o=0;for(let a of n.touchedObstacles){let l=a[1].sub(t).length;o+=ho.RError(i,l,this.bundlingSettings)}return o}BundleGain(e,t){let i=e.cachedBundleCost;for(let n of e.Neighbors){let o=this.BundleCost(e,n,t);if(Uh(o,ho.Inf))return-ho.Inf;i-=o}return i}BundleCost(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,i,t.Position,n,o))return ho.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=ho.BundleError(n/2,u,this.bundlingSettings)}return a}},xr=ho;xr.Inf=1e9;var vv=be(vs());var YP=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new dt;this.interestingPoints=new Je;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){k2(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){U2(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new vv.Queue;for(let i of this.Polylines)t.enqueue(i);for(;t.length>0;){let i=t.dequeue();e.delete(i);let n=this.ProcessPolyline(i);n!=null&&(e.has(i)||(e.add(i),t.enqueue(i)),e.has(n)||(e.add(n),t.enqueue(n)))}}ProcessPolyline(e){let t=new Map;for(let i=e.startPoint.next;i!=null;i=i.next){this.FillDepartedPolylinePoints(i,t);for(let n of this.pathsThroughPoints.get(i.point)){let o=t.get(n.polyline);if(o){if(this.ProcessFlip(i,o))return n.polyline;t.delete(n.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let i=e.prev.point;for(let n of this.pathsThroughPoints.get(i))this.IsNeighborOnTheSamePolyline(n,e)||t.has(n.polyline)||t.set(n.polyline,n)}ProcessFlip(e,t){let i=e.polyline,n=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(i),u=this.polylineToEdgeGeom.get(n);if(l.lineWidth!=u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!Ha(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(i,o,a),h=c[0],d=c[1],f=c[2];c=this.FindPointsOnPolyline(n,o,a);let P=c[0],E=c[1],v=c[2],L=this.FindRelationOnFirstPoint(h,P,f,v),O=this.FindRelationOnLastPoint(d,E,f,v);return L!=2&&O!=2||L==1||O==1?!1:(this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.Swap(h,P,d,E,f,v),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,i){let n,o;for(let a=e.startPoint;a!=null;a=a.next)if(n==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];n=a}else o==null&&a.point.equal(i)&&(o=a);else if(a.point.equal(i))return[n,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let i=e;i!=null;i=i.next)if(i==t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Prev(e,i),u=this.Prev(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,i,n)}FindRelationOnLastPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Next(e,i),u=this.Next(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,i).point.equal(this.Prev(t,n).point);)e=this.Next(e,i),t=this.Prev(t,n);return this.PolylinesIntersect(e,t,o,a,i,n)}PolylinesIntersect(e,t,i,n,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(i,o),h=this.Prev(i,o),d=this.Next(t,a),f=this.Prev(n,a);if(e.point.equal(i.point)){let P=e.point,E=co(h.point.sub(P),f.point.sub(P),u.point.sub(P)),v=co(h.point.sub(P),d.point.sub(P),u.point.sub(P));return E==v?1:2}else{let P=co(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),E=co(c.point.sub(i.point),f.point.sub(i.point),h.point.sub(i.point));return P==E?1:2}}Swap(e,t,i,n,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),i,o),u=this.GetRangeOnPolyline(this.Next(t,a),n,a);this.ChangePolylineSegment(e,i,o,u),this.ChangePolylineSegment(t,n,a,l),Ys.RemoveSelfCyclesFromPolyline(e.polyline),Ys.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,i,n){let o=e;for(let a of n){let l=_t.mkFromPoint(a.point);l.polyline=o.polyline,i?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}i?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,i){let n=new Array;for(let o=e;o!=t;o=this.Next(o,i))n.push(o);return n}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new Je;for(let i=e.startPoint;i!=null;i=i.next){if(i==e.startPoint){if(i.prev!=null)return!1}else if(i.prev.next!=i)return!1;if(i==e.endPoint){if(i.next!=null)return!1}else if(i.next.prev!=i)return!1;if(t.has(i.point))return!1;t.add(i.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function k2(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function U2(s,e,t){let i=s.get(e);!i||(i.delete(t),i.size==0&&s.deleteP(e))}var Ys=class{constructor(e,t){this.foundCrossings=new Je;this.crossingsThatShouldBecomeHubs=new Je;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new ao;for(let t of this.Vertices())t.next&&e.set(new Ct(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length==0)return!1;let e=new ao,t=new Ma(null);for(let l of this.Vertices()){let u=W.mkOnPoints([l.point]);u.pad(C.intersectionEpsilon),t.Add(u,l.point)}let i=nh(this.Edges(),l=>W.mkPP(l.First,l.Second));Ft(i,i,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let n=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||n||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((i,n)=>Ae(ke(i,e.First),ke(n,e.First)))}InsertPointsIntoPolylines(e){let t=!1;for(let i of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(i,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let i=!1;for(let n=e.Polyline.startPoint;n.next!=null;n=n.next)this.InsertPointsOnPolypoint(n,t,e)&&(i=!0);return i}InsertPointsOnPolypoint(e,t,i){let n=new Ct(e.point,e.next.point),o=e.point!=n.First,a=t.get(n);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=_t.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=_t.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)Ys.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,i=new dt;for(let n=e.startPoint;n!=null;n=n.next){let o=n.point,a=i.get(o);if(a){for(let l=a.next;l!=n.next;l=l.next)i.deleteP(l.point);a.next=n.next,n.next.prev=a,t=!0}else i.set(n.point,n)}return t}ReduceEdgeCrossings(){let e=new YP(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=XE(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let i=e.startPoint.next;i!=null&&i.next!=null;i=i.next)if(this.pointsToDelete.has(i.point)&&p.getTriangleOrientation(i.prev.point,i.point,i.next.point)==2){let n=i.prev,o=i.next;n.next=o,o.prev=n,i=n,t=!0}return t}IntersectTwoEdges(e,t,i,n){let o=B.IntersectPPPP(e.First,e.Second,t.First,t.Second);if(o){let a=this.FindExistingVertexOrCreateNew(n,o);(this.AddVertexToSplittingList(e,i,a)||this.AddVertexToSplittingList(t,i,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let i=e.RootNode.FirstHitNode(t);if(i!=null)return i.UserData;let n=W.mkOnPoints([t]);return n.pad(C.intersectionEpsilon),e.Add(n,t),t}AddVertexToSplittingList(e,t,i){if(!w.closeIntersectionPoints(i,e.First)&&!w.closeIntersectionPoints(i,e.Second)){let n=t.get(e);if(n||(n=new Array,t.set(e,n)),!n.find(o=>o.equal(i)))return n.push(i),!0}return!1}};var Cv=be(mp());var bp=class{isCorrectlyOrienected(){return p.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!=1}get Count(){return this.points.length}constructor(e,t,i,n){this.BelongsToRealNode=n,this.Curve=t,this.Position=i,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return p.middle(this.StartPoint,this.EndPoint)}get ParameterSpan(){return df(this.Curve)}get Span(){return this.SpanBetweenTwoPoints(this.parStart,this.parEnd)}SpanBetweenTwoPoints(e,t){return e<=t?t-e:t-e+this.ParameterSpan}RotateLeftPoint(e,t){return e==0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e==0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,i){let n=this.ParameterSpan*i;return t+=e*n,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,i){let n=this.ParameterSpan*i;e!=0&&(this.ParStart=this.AdjustParam(this.ParStart+e*n)),t!=0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*n))}RelativeOrderOfBasesIsPreserved(e,t,i){let n=this.ParameterSpan*i,o=this.parStart+e*n,a=this.parStart<this.parEnd?this.parEnd+t*n:this.parEnd+this.ParameterSpan+t*n;if(o>a||this.SpanBetweenTwoPoints(o,a)>this.ParameterSpan/2)return!1;if(this.Prev==null||this.SpanBetweenTwoPoints(this.Prev.ParMid,this.ParMid)>n&&this.SpanBetweenTwoPoints(this.ParMid,this.Next.ParMid)>n)return!0;let l=this.RotateLeftPoint(t,i),u=this.RotateRigthPoint(e,i),c=p.middle(l,u),h=this.MidPoint;return!(p.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=p.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||p.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=p.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var ml=class{constructor(e,t,i,n){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=i,this.HalfWidthArray=n,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let i=this.SourceBase.Curve.boundingBox.diagonal/2,n=this.TargetBase.Curve.boundingBox.diagonal/2,o=ri.Create4gon(this.SourceBase.Position,this.TargetBase.Position,i*2,n*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&w.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,i=e.sub(t).normalize(),n=i.rotate90Ccw(),o=p.middle(e,t),a=i.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(n.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>ml.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(n.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=ml.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(n.mul(ml.FeasibleWidthEpsilon),new p(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new p(0,0),n.mul(-ml.FeasibleWidthEpsilon),l,u))&&(d=2*ml.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"/tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,i){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,i)}SetRLParamsIfWidthIsFeasible_(e,t,i,n){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(B.mkPP(i.add(e),n.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>w.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(B.mkPP(i.add(t),n.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>w.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(B.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"/tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,i){let n=w.getAllIntersections(e,this.SourceBase.Curve,!0);if(n.length==0)return i.par=0,t.par=0,null;let o;if(n.length==1?o=n[0]:this.SourceBase.IsParent?o=n[0].par0<n[1].par0?n[1]:n[0]:o=n[0].par0<n[1].par0?n[0]:n[1],n=w.getAllIntersections(e,this.TargetBase.Curve,!0),n.length==0)return i.par=0,t.par=0,null;let a;return n.length==1?a=n[0]:this.TargetBase.IsParent?a=n[0].par0>n[1].par0?n[1]:n[0]:a=n[0].par0>n[1].par0?n[0]:n[1],t.par=o.par1,i.par=a.par1,B.mkPP(o.x,a.x)}RotateBy(e,t,i,n,o){let a=e!=0||t!=0,l=i!=0||n!=0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(i,n,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let i=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),n=i.length;n>=C.tolerance&&(i=i.div(n),this.TargetBase.Tangents[t]=i,this.SourceBase.Tangents[e-1-t]=i.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,i=e.Points,n=B.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];i[0]=n.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],i[l]=n.value(a*o)}RotationIsLegal(e,t,i,n,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!=0||i!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||n!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!=0||n!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||i!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!=0||t!=0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(i!=0||n!=0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(i,n,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(i=>w.intersectionOne(B.mkPP(e,t),i,!1)!=null)==null}},Pp=ml;Pp.FeasibleWidthEpsilon=.1;var yp=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,i,n){this.Segment=e,this.Reversed=t,this.Index=i,this.BundleBase=n}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var qe=class{constructor(e,t,i){this.fixedBundles=new Cv.HashSet;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=i}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=de.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let i=new bp(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,i);let n=new bp(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,n),w.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!=0?(i.IsParent=!0,ja(this.internalBases,e,i),ja(this.externalBases,t,n)):w.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!=0?(n.IsParent=!0,ja(this.externalBases,e,i),ja(this.internalBases,t,n)):(ja(this.externalBases,e,i),ja(this.externalBases,t,n));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new Pp(i,n,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));i.OutgoingBundleInfo=n.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,i=e[0].CurveCenter;e.sort((n,o)=>co(t.sub(i),n.OppositeBase.Position.sub(i),o.OppositeBase.Position.sub(i)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++)e[i].Prev=e[(i-1+t)%t],e[i].Next=e[(i+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=a.OrientedHubSegments[u]=new yp(null,!1,u,a),d=l.OrientedHubSegments[c]=new yp(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,i=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,i.Position),i.ParEnd=i.ParStart=this.GetBaseMiddleParamInDirection(i,i.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,i){let n=e.Curve;if(n instanceof de){let l=n;if(l.isArc())return p.angle(l.aAxis,i.sub(t))}let a=w.getAllIntersections(n,B.mkPP(t,i),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(i))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++){let n=e[i],o=n.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(n,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let i=z2(e,t);if(i==null||ae(i.start,i.end))return;let n=i.rbaseMiddle,o=i.lbaseMiddle;if(n<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(i.end*a+i.start*l)/(l+a);e.ParStart=e.AdjustParam(u+C.distanceEpsilon),t.ParEnd=t.AdjustParam(u-C.distanceEpsilon)}RegularCut(e,t,i,n,o,a){let l=(o*n+a*e)/(o+a),u=Math.min(t,n),c=Math.max(e,i);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=qe.MaxParameterChange,t={cost:this.Cost()},i=0;for(;i++<qe.MaxIterations;){let n=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,n,t.cost),e<qe.MinParameterChange)break}}UpdateParameterChange(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let i=!1;for(let n of this.Bundles)this.fixedBundles.has(n)||(this.OptimizeBundle(n,e,t)?i=!0:this.fixedBundles.add(n));return i}OptimizeBundle(e,t,i){let n=this.CostBi(e);if(n<qe.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<qe.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(qe.Deltas[u][0],qe.Deltas[u][1],0,0,e,n,t);c>qe.CostDeltaThreshold&&c>o&&(l=u,a=qe.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,qe.Deltas[u][0],qe.Deltas[u][1],e,n,t),c>qe.CostDeltaThreshold&&c>o&&(l=qe.Deltas.length-1,a=u,o=c)}return o<qe.CostDeltaThreshold?!1:(i.cost-=o,e.RotateBy(qe.Deltas[l][0],qe.Deltas[l][1],qe.Deltas[a][0],qe.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,i,n,o,a,l){if(!o.RotationIsLegal(e,t,i,n,l))return 0;o.RotateBy(e,t,i,n,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,i*-1,n*-1,l),a-u}CostBi(e){return qe.SeparationCoeff*this.SeparationCost(e)+(qe.SqueezeCoeff*this.SqueezeCost(e)+(qe.AssymetryCoeff*this.AssymetryCost(e)+qe.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let i=0;return i=i+qe.CenterCoeff*this.CenterCostBi(e),i>t||(i=i+qe.SeparationCoeff*this.SeparationCost(e),i>t)||(i=i+qe.SqueezeCoeff*this.SqueezeCost(e),i>t)||(i=i+qe.AssymetryCoeff*this.AssymetryCost(e)),i}SqueezeCost(e){let i=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),n=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(i)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(i)),a=Math.abs(e.TotalRequiredWidth-n)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(n-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,i=Math.min(e.InitialMidParameter,t),n=Math.max(e.InitialMidParameter,t),o=Math.min(n-i,i+(e.ParameterSpan-n));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,i=0;for(let n of e.OrientedHubSegments){let o=n.Index,a=n.Other.Index,l=e.Points[o],u=e.Tangents[o],c=n.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],f=e.Count+c.Count;i+=this.GetAssymetryCostOnData(l,u,h,d,t)/f}return i}GetAssymetryCostOnData(e,t,i,n,o){let a=e.sub(i),l=a.length;if(l<C.distanceEpsilon)return 0;let u=t.add(n).dot(a),c=p.crossProduct(a,t),h=p.crossProduct(a,n),d=c-h,f=u*u+d*d,P=c*c+h*h;return 10*f+o*P}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let i=e.Curve,n=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,i),o=Math.min(e.Span,t.Span);return Math.exp(n/(o*10))-1}IntervalsOverlapLength(e,t,i,n,o){let a=o.parStart,l=o.parEnd;return e<t?i<n?this.IntersectRegularIntervals(e,t,i,n):this.IntersectRegularIntervals(e,t,i,l)+this.IntersectRegularIntervals(e,t,a,n):i<n?this.IntersectRegularIntervals(e,l,i,n)+this.IntersectRegularIntervals(a,t,i,n):this.IntersectRegularIntervals(e,l,i,l)+this.IntersectRegularIntervals(a,t,a,n)}IntersectRegularIntervals(e,t,i,n){let o=Math.max(e,i),a=Math.min(t,n);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let i=qe.SeparationCoeff*this.SeparationCost(t),n=qe.AssymetryCoeff*this.AssymetryCost(t),o=qe.SqueezeCoeff*this.SqueezeCost(t),a=qe.CenterCoeff*this.CenterCostBi(t);e+=(i+n)/2+o+a}return e}},Ri=qe;Ri.Deltas=[[1,-1],[1,-1]],Ri.SeparationCoeff=1,Ri.SqueezeCoeff=1,Ri.CenterCoeff=10,Ri.AssymetryCoeff=1,Ri.MaxIterations=200,Ri.MaxParameterChange=8/360,Ri.MinParameterChange=.1/360,Ri.CostThreshold=1e-5,Ri.CostDeltaThreshold=.01;function z2(s,e){let t=s.ParEnd,i=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-s.ParameterSpan,n=e.ParEnd,o=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-e.ParameterSpan,a=[t,i],l=[n,o];for(let h=0;h<2;h++)for(let d=0;d<2;d++){let f=a[h],P=l[d];Math.abs(f-P)>Math.PI*2&&(f>P?(n+=Math.PI*2,o+=Math.PI*2):(t+=Math.PI*2,i+=Math.PI*2))}let u=Math.min(t,n),c=Math.max(i,o);return c<=u?{start:c,end:u,rbaseMiddle:(i+t)/2,lbaseMiddle:(o+n)/2}:null}var $P=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var Xu=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let i=new Ct(e.Position,t.Position),n=this.bundles.get(i).Metrolines;if(e.Position==i.First)for(let o=0;o<n.length;o++)yield n[o];else for(let o=n.length-1;o>=0;o--)yield n[o]}GetLineIndexInOrder(e,t,i){let n=new Ct(e.Position,t.Position),o=e.Position!=n.First,a=this.bundles.get(n).LineIndexInOrder;return o?a.size-1-a.get(i):a.get(i)}BuildOrder(){this.bundles=new ao;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let i=new Ct(t.point,t.next.point),n=this.bundles.get(i);n||this.bundles.set(i,n=new $P),n.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((i,n)=>this.CompareLines(i,n,e.First,e.Second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let i=0;i<t.Metrolines.length;i++)t.LineIndexInOrder.set(t.Metrolines[i],i)}}CompareLines(e,t,i,n){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(i,n,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(i,n,t,o);let c=o.polyPoint,h=o.next,d=o.prev,f=a,P=c,E,v;for(;(v=u(f))!=null&&(E=d(P))!=null&&v.point.equal(E.point);){let L=new Ct(v.point,f.point);if(this.bundles.get(L).orderFixed)return this.CompareOnFixedOrder(L,e,t,!v.point.equal(L.First));f=v,P=E}if(v!=null&&E!=null){let L=f.point;return-Xu.IsLeft(l(f).point.sub(L),v.point.sub(L),E.point.sub(L))}for(f=a,P=c;(v=l(f))!=null&&(E=h(P))!=null&&v.point.equal(E.point);){let L=new Ct(v.point,f.point);if(this.bundles.get(L).orderFixed)return this.CompareOnFixedOrder(L,e,t,!f.point.equal(L.First));f=v,P=E}if(v!=null&&E!=null){let L=f.point;return Xu.IsLeft(u(f).point.sub(L),v.point.sub(L),E.point.sub(L))}return Ae(e.Index,t.Index)}CompareOnFixedOrder(e,t,i,n){let o=this.bundles.get(e).LineIndexInOrder;return(n?-1:1)*Ae(o.get(t),o.get(i))}FindStationOnLine(e,t,i,n){for(let o=i.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){n.next=a=>a.next,n.prev=a=>a.prev,n.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){n.next=a=>a.prev,n.prev=a=>a.next,n.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,i){return co(e,t,i)}};var et=class extends Ee{constructor(e,t){super(null);this.metroGraphData=e,this.bundlingSettings=t}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Gt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new Xu(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new Ri(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let e=0;e<this.metroGraphData.Metrolines.length;e++)this.CreateCurveLine(this.metroGraphData.Metrolines[e],this.metroGraphData.Edges[e])}CreateCurveLine(e,t){let i=new w,o=et.FindCurveStart(this.metroGraphData,this.metroOrdering,e),a=et.HubSegsOfLine(this.metroGraphData,this.metroOrdering,e);for(let l of a)l!=null&&(i.addSegment(B.mkPP(o,l.start)),i.addSegment(l),o=l.end);i.addSegment(B.mkPP(o,et.FindCurveEnd(this.metroGraphData,this.metroOrdering,e))),t.curve=i}static FindCurveStart(e,t,i){let n=e.PointToStations.get(i.Polyline.startPoint.point),o=e.PointToStations.get(i.Polyline.startPoint.next.point),a=n.BundleBases.get(o),l=a.IsParent?t.GetLineIndexInOrder(n,o,i):t.GetLineIndexInOrder(o,n,i);return a.Points[l]}static FindCurveEnd(e,t,i){let n=e.PointToStations.get(i.Polyline.endPoint.prev.point),o=e.PointToStations.get(i.Polyline.endPoint.point),a=o.BundleBases.get(n),l=a.IsParent?t.GetLineIndexInOrder(o,n,i):t.GetLineIndexInOrder(n,o,i);return a.Points[l]}static*HubSegsOfLine(e,t,i){for(let n=i.Polyline.startPoint.next;n.next!=null;n=n.next)yield et.SegOnLineVertex(e,t,i,n)}static SegOnLineVertex(e,t,i,n){let o=e.PointToStations.get(n.prev.point),a=e.PointToStations.get(n.point),l=a.BundleBases.get(o),u=t.GetLineIndexInOrder(o,a,i);if(l.OrientedHubSegments[u]==null||l.OrientedHubSegments[u].Segment==null){let c=e.PointToStations.get(n.next.point),h=a.BundleBases.get(c),d=t.GetLineIndexInOrder(c,a,i);return B.mkPP(l.Points[u],h.Points[d])}return l.OrientedHubSegments[u].Segment}CreateSegmentsInsideHubs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateICurveForOrientedSeg(e,t)}CreateICurveForOrientedSeg(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?et.StandardBezier(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]):et.BiArc(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]);a.OrientedHubSegments[u].Segment=h,l.OrientedHubSegments[c].Segment=h}static ShowHubs(e,t,i,n,o=[]){let a=et.GetAllDebugCurves(t,e);i!=null&&a.push(fe.mkDebugCurveTWCI(255,1,"red",Be.CreateDiamond(5,25,i.Position))),a=a.concat(o)}static GetAllDebugCurves(e,t){return et.GraphNodes(t).concat(et.VertexDebugCurves(e,t)).concat(et.DebugEdges(t))}static DebugEdges(e){return e.Edges.map(t=>fe.mkDebugCurveTWCI(40,.1,"gray",t.curve))}static VertexDebugCurves(e,t){return et.DebugCircles(t).concat(et.DebugHubBases(t)).concat(et.DebugSegs(t)).concat(et.BetweenHubs(e,t))}static BetweenHubs(e,t){let i=[];for(let n of t.Metrolines){let o=et.GetInterestingSegs(t,e,n),a=et.GetMonotoneColor(n.Polyline.start,n.Polyline.end,o);for(let l of o)i.push(fe.mkDebugCurveTWCI(100,n.Width,a,B.mkPP(l[0],l[1])))}return i}static GetInterestingSegs(e,t,i){let n=new Array;if(e.Stations.length==0||e.Stations[0].BundleBases==null||e.Stations[0].BundleBases.size==0)return[];let o=et.FindCurveStart(e,t,i),a=et.HubSegsOfLine(e,t,i);for(let l of a)l!=null&&(n.push([o,l.start]),o=l.end);return n.push([o,et.FindCurveEnd(e,t,i)]),n}static GetMonotoneColor(e,t,i){return"green"}static DebugHubBases(e){let t=new Array;for(let i of e.Stations)for(let n of i.BundleBases.values())t.push(fe.mkDebugCurveTWCI(100,1,"red",B.mkPP(n.EndPoint,n.StartPoint)));return t}static DebugCircles(e){return e.Stations.map(t=>fe.mkDebugCurveTWCI(100,.1,"blue",Be.mkCircle(t.Radius,t.Position)))}static DebugSegs(e){let t=new Array;for(let i of e.VirtualStations())for(let n of i.BundleBases.values())for(let o of n.OrientedHubSegments)if(o!=null)if(o.Segment==null){let a=o.Other.BundleBase,l=o.Index,u=o.Other.Index;t.push(B.mkPP(n.Points[l],a.Points[u]))}else t.push(o.Segment);return t.map(i=>fe.mkDebugCurveTWCI(100,.01,"green",i))}static GraphNodes(e){return e.Edges.map(i=>i.sourcePort.Curve).concat(e.Edges.map(i=>i.targetPort.Curve)).map(i=>fe.mkDebugCurveTWCI(40,1,"black",i))}static BiArc(e,t,i,n){let o=e.sub(i);if(o.length<C.distanceEpsilon)return null;let a=o.dot(t.sub(n)),l=-t.dot(n);if(t.dot(i.sub(e))<=0&&t.dot(n)<=0)return et.StandardBezier(e,t,i,n);let u=2*(l-1),c=2*a,h=o.dot(o),d;if(Math.abs(u)<C.distanceEpsilon)if(Math.abs(c)>C.distanceEpsilon)d=-h/c;else return null;else{let D=c*c-4*u*h;D<0&&(D=0),D=Math.sqrt(D),d=(-c+D)/(2*u),d<0&&(d=(-c-D)/(2*u))}let f=e.add(t.mul(d)),P=i.add(n.mul(d)),E=p.middle(f,P),v=p.getTriangleOrientation(e,f,E),L=p.getTriangleOrientation(E,P,i);if(v!=L)return et.StandardBezier(e,t,i,n);let O=new w;return O.addSegs([et.ArcOn(e,f,E),et.ArcOn(E,P,i)]),O}static ArcOn(e,t,i){let n={center:null};if(Math.abs(p.signedDoubledTriangleArea(e,t,i))<1e-4||!et.FindArcCenter(e,t,i,n))return B.mkPP(e,i);let o=n.center,a=ke(e,o);if(ke(e,t)/a<1e-4)return B.mkPP(e,i);let u=e.sub(o),c=Math.atan2(u.y,u.x),h=i.sub(o),d=Math.atan2(h.y,h.x),f=d-c;if(f<0&&(f+=2*Math.PI,d+=2*Math.PI),f<=Math.PI)return new de(c,d,new p(a,0),new p(0,a),o);for(d>2*Math.PI&&(d-=2*Math.PI),c=Math.PI-c,d=Math.PI-d,c<0&&(c+=2*Math.PI);d<c;)d+=2*Math.PI;return f=d-c,new de(c,d,new p(-a,0),new p(0,a),o)}static FindArcCenter(e,t,i,n){let o=t.sub(e).rotate90Cw(),a=t.sub(i).rotate90Cw();return n.center=p.lineLineIntersection(e,e.add(o),i,i.add(a)),n.center!=null}static StandardBezier(e,t,i,n){let o=ke(e,i)/4;return Fe.mkBezier([e,e.add(t.mul(o)),i.add(n.mul(o)),i])}FanBezierSegs(){let e=!0,t=5,i=0;for(;e&&i++<t;){e=!1;for(let n of this.metroGraphData.Stations)for(let o of n.BundleBases.values())e||(e=this.FanEdgesOfHubSegment(o))}}FanEdgesOfHubSegment(e){let t=!1;for(let i=0;i<e.Count-1;i++)t||(t=this.FanCouple(e,i,e.CurveCenter,e.Curve.boundingBox.diagonal/2));return t}FanCouple(e,t,i,n){let o=e.OrientedHubSegments[t],a=e.OrientedHubSegments[t+1];if(o==null||B.IntersectPPPP(o.Segment.start,o.Segment.end,a.Segment.start,a.Segment.end)||p.getTriangleOrientation(o.value(0),o.value(.5),o.value(1))!=p.getTriangleOrientation(a.value(0),a.value(.5),a.value(1)))return!1;let u=this.BaseLength(o),c=this.BaseLength(a);return Math.abs(u-c)<C.intersectionEpsilon?!1:u>c?this.AdjustLongerSeg(o,a,i,n):this.AdjustLongerSeg(a,o,i,n)}AdjustLongerSeg(e,t,i,n){let o=e.value(0).sub(t.value(0)),a=e.value(1).sub(t.value(1)),l=Math.min(o.length,a.length),u=t.value(.5),c=Math.max(o.length,a.length);return this.NicelyAligned(e.Segment,o,a,u,l,c)==0?!1:this.FitLonger(e,o,a,u,l,c,i,n)}FitLonger(e,t,i,n,o,a,l,u){let c=e.Segment,h=c.start,d=c.end,f=0,P=10,E=c.start.mul(1-et.SqueezeBound).add(c.B(1).mul(et.SqueezeBound)),v=c.end.mul(1-et.SqueezeBound).add(c.B(2).mul(et.SqueezeBound)),L=c.B(1).mul(2).sub(c.start),O=c.B(2).mul(2).sub(c.end),D={highP:L};this.PullControlPointToTheCircle(c.start,D,l,u),L=D.highP;let _=this.NicelyAligned(c,t,i,n,o,a);do{if(_==-1){let F=p.middle(c.B(1),E),X=p.middle(c.B(2),v);L=c.B(1),O=c.B(2),c=new Fe(h,F,X,d)}else{let F=p.middle(c.B(1),L),X=(c.B(2),O);E=c.B(1),v=c.B(2),c=new Fe(h,F,X,d)}if((_=this.NicelyAligned(c,t,i,n,o,a))==0)return e.Segment=c,e.Other.Segment=c,!0;if(f++>P)return!1}while(!0)}PullControlPointToTheCircle(e,t,i,n){let o=p.ProjectionToLine(e,t.highP,i),a=Math.sqrt(n*n-o.sub(i).lengthSquared),l=t.highP.sub(o),u=l.length;u>a&&(t.highP=o.add(l.mul(a/u)))}NicelyAligned(e,t,i,n,o,a){let u=e.value(.5).sub(n),c=u.length;return t.dot(u)<0||i.dot(u)<0||c<o-.001?1:c>a+.001?-1:0}BaseLength(e){return e.value(0).sub(e.value(1)).lengthSquared}},$s=et;$s.SqueezeBound=.2;var Zi=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new xr(this.metroGraphData,this.bundlingSettings),this.cache=new gl(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.Cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,i){return new Zi(e,t).FixRoutingP(i)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=Zi.MaxStep,i=Number.POSITIVE_INFINITY,n=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<Zi.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=i;i=xr.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,i);let u=n;if(n=this.metroGraphData.VirtualStations().map(c=>c.Position),t<Zi.MinStep||this.Converged(t,u,n))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let i=e[0],n=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(i,n),a=B.mkPP(i.Position,n.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>w.CurvesIntersect(a,u));return l.length>0?($s.ShowHubs(t,null,null,"/tmp/badcross.svg",[fe.mkDebugCurveTWCI(200,1,"Brown",a),fe.mkDebugCurveTWCI(200,1,"Red",Be.mkCircle(2,i.Position)),fe.mkDebugCurveTWCI(200,1,"Blue",Be.mkCircle(5,n.Position)),fe.mkDebugCurveTWCI(100,1,"Blue",Be.mkCircle(5,n.Position))].concat(l.map(u=>fe.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let i of e){let n=this.metroGraphData.PointToStations.get(i);n&&!n.IsReal&&t.add(n)}return t}}Converged(e,t,i){let n=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(i[l]).lengthSquared,n+=t[l].lengthSquared;return Math.sqrt(o/n)<Zi.MinRelativeChange}UpdateMaxStep(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(Zi.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let i of this.stationsForOptimizations)if(this.TryMoveStation(i)){e=!0,t.add(i);for(let n of i.Neighbors)n.IsReal||t.add(n)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length==0)return!1;let i=this.BuildStepLength(e,t);if(i<Zi.MinStep&&(t=H2(),i=this.BuildStepLength(e,t),i<Zi.MinStep))return!1;let n=t.mul(i),o=e.Position.add(n);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let i of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(W.mkOnPoints([t]),n=>w.PointRelativeToCurveLocation(t,n)!=0))if(e.getELP().has(i)==!1)return!1;for(let i of e.Neighbors){let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(i,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(i.Position,t,i.CdtTriangle,n))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),i=this.BuildForceForPathLengths(e),n=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(i.add(n.add(o)));return a.length<.1?new p(0,0):a.normalize()}BuildStepLength(e,t){let i=Zi.MinStep,n=this.CostGain(e,e.Position.add(t.mul(i)));if(n<.01)return 0;for(;2*i<=Zi.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(i*2)));if(o<=n)break;i*=2,n=o}return i}CostGain(e,t){let n=this.costCalculator.RadiusGain(e,t);if(n<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return n+a+l+o}BuildForceForInk(e){let t=new p(0,0);for(let n of e.Neighbors){let o=n.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new p(0,0);for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.next.point,l=n.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new p(0,0),i=e.cachedIdealRadius,n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,i,n))throw $s.ShowHubs(this.metroGraphData,null,e,"/tmp/hubs.svg",[fe.mkDebugCurveTWCI(255,1,"Brown",ri.containingPoly),fe.mkDebugCurveTWCI(100,1,"Blue",Be.mkCircle(i,e.Position))]),new Error;for(let l of n.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/i),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new p(0,0);for(let n of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,n,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,n,e.Position,n.Position,o/2,a)||$s.ShowHubs(this.metroGraphData,null,e,"/tmp/inside_forbid.svg",[fe.mkDebugCurveTWCI(100,.2,"Blue",B.mkPP(e.Position,n.Position)),fe.mkDebugCurveTWCI(100,.2,"Red",Be.mkCircle(2,e.Position)),fe.mkDebugCurveTWCI(100,.2,"Red",Be.mkCircle(3,n.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},An=Zi;An.MaxIterations=100,An.MaxStep=50,An.MinStep=1,An.MinRelativeChange=5e-4;function H2(){return new p(1+2*ph(),1+2*ph())}var ts=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let i=new ts(e,t);i.GlueConflictingStations(),i.UnglueEdgesFromBundleToSaveInk(!0);let n=0,o=10;for(;++n<o;){let a=i.GlueConflictingStations();if(a||(a=i.RelaxConstrainedEdges()),a||(a=n<=3&&i.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=i.GlueCollinearNeighbors(n)),a||(a=n==3&&i.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,i.RemoveDoublePathCrossings(),i.UnglueEdgesFromBundleToSaveInk(!0);i.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,i=new Set;if(Ft(e,e,(o,a)=>this.TryToGlueStations(o,a,t,i)),t.size==0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let n=new Je;for(let o of i){n.add(o.Position);for(let a of o.Neighbors)a.IsReal||n.add(a.Position)}return this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,n),!0}GetCirclesHierarchy(){for(let i of this.metroGraphData.VirtualStations())i.Radius=this.GetCurrentHubRadius(i);let e=this.metroGraphData.VirtualStations().map(t);return Qe(e);function t(i){let n=i.Position,o=Math.max(i.Radius,5),a=new p(o,o),l=W.mkPP(n.add(a),n.sub(a));return ct(i,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,i=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let n of e.Neighbors)i=Math.min(i,e.Position.sub(n.Position).length);return i}}TryToGlueStations(e,t,i,n){if(!Ha(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,n,i)||this.TryGlueOrdered(t,e,n,i)}TryGlueOrdered(e,t,i,n){return!n.has(e)&&!i.has(e)&&this.StationGluingIsAllowed(e,t,n)?(this.Map(e,t,i,n),!0):!1}Map(e,t,i,n){n.set(e,t),i.add(t)}StationGluingIsAllowed(e,t,i){for(let o of e.Neighbors){let a=ts.Glued(o,i),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,i)<0)}ComputeCostDeltaAfterStationGluing(e,t,i){let n=e.Position.sub(t.Position).length;if(e.Radius>=n||t.Radius>=n)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=ts.Glued(u,i);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)==0?c.Position.sub(t.Position).length:0}o+=xr.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,f=d.prev,P=d.next;h-=f.point.sub(e.Position).length+P.point.sub(e.Position).length,h+=f.point.sub(t.Position).length+P.point.sub(t.Position).length,o+=xr.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let i=this.metroGraphData.Metrolines[t].Polyline;for(let a of i)if(!this.metroGraphData.PointToStations.has(a))return;let n=!1;for(let a of i)if(e.has(this.metroGraphData.PointToStations.get(a))){n=!0;break}if(!n)return;let o=Array.from(i).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=te.mkFromPoints(ts.GluedPolyline(o,e))}static GluedPolyline(e,t){let i,n=new Av.Stack;n.push(e[0]);let o=new Set;for(i=1;i<e.length-1;i++){let a=ts.Glued(e[i],t);if(o.has(a)){for(;n.top!=a;)o.delete(n.pop());continue}p.closeDistEps(a.Position,n.top.Position)||(o.add(a),n.push(a))}return n.push(e[i]),Array.from(n).reverse().map(a=>a.Position)}static Glued(e,t){var i;return(i=t.get(e))!=null?i:e}UnglueEdgesFromBundleToSaveInk(e){let t=new ao;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new Ct(a.point,a.next.point);Db(t,l,o)}}let i=new Je,n=!1;for(let o of this.metroGraphData.Metrolines){let a=Sn(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,i,a)&&(n=!0)}return n&&this.metroGraphData.Initialize(!1),(e||n)&&An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:i),n}TrySeparateOnPolyline(e,t,i,n){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,i,n)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,i,n){return this.SeparationShortcutAllowed(e,t,n)?(i.add(e.point),i.add(e.next.point),i.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,i){let n=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(n),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=yn(l.getELP(),c.getELP()),d=YE([i,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,n,o,a)<0)}GetInkgain(e,t,i,n,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,f=i.sub(n).length,P=n.sub(o).length,E=i.sub(o).length;a.size==u.size&&(d-=f),l.size==u.size&&(d-=P);let v=t.get(new Ct(i,o));(!v||v.size==0)&&(d+=E),c+=xr.InkError(h,d,this.bundlingSettings);for(let X of u){let $=this.polylineLength.get(X),se=$-(f+P-E);c+=xr.PathLengthsError($,se,X.IdealLength,this.bundlingSettings)}let L=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(i)),O=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),D=this.metroGraphData.GetWidthAN(Array.from(Wo(a,u)),this.bundlingSettings.EdgeSeparation),_=Gt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(L,i,o,n,O,D,this.bundlingSettings);_>L&&(c-=xr.RError(_,L,this.bundlingSettings)),L=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let F=this.metroGraphData.GetWidthAN(Array.from(Wo(l,u)),this.bundlingSettings.EdgeSeparation);return _=Gt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(L,o,n,i,F,O,this.bundlingSettings),_>L&&(c-=xr.RError(_,L,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=ke(i,n),h=ke(n,o),d=ke(i,o);a.size==u.size&&(this.ink-=c),l.size==u.size&&(this.ink-=h);let f=t.get(new Ct(i,o));(!f||f.size==0)&&(this.ink+=d);for(let P of u){let E=this.polylineLength.get(P);this.polylineLength.set(P,E-(c+h-d))}for(let P of u){let E=Array.from(P.Polyline.polylinePoints()).find(v=>v.point.equal(n));this.RemovePolypoint(E),Fb(t,[i,n],P),Fb(t,[n,o],P),$E(t,[i,o],P)}}FindPolylines(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,a=t.get_(i,n),l=t.get_(n,o),u=Sn(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,i=e.next;t.next=i,i.prev=t}GlueCollinearNeighbors(e){let t=new Je,i=!1;for(let n of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(n,t,e)&&(i=!0);return i&&(this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),i}GlueCollinearNeighborsSPN(e,t,i){if(e.Neighbors.length<=1)return!1;let n=new kh,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],n,i);if(n.isEmpty)return!1;for(let a of n)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,i,n,o){if(p.anglePCP(t.Position,e.Position,i.Position)<this.bundlingSettings.AngleThreshold){let l=ke(t.Position,e.Position),u=ke(i.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,i)){this.AddEdgeToGlue(e,i,t,t.Position,n);return}}else if(this.EdgeGluingIsAllowedSSS(e,i,t)){this.AddEdgeToGlue(e,t,i,i.Position,n);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,i);this.EdgeGluingIsAllowedSSSP(e,t,i,h)&&this.AddEdgeToGlue(e,i,t,h,n)}}}ConstructGluingPoint(e,t,i){let n=Math.min(ke(t.Position,e.Position),ke(i.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(i.Position.sub(e.Position).normalize());return e.Position.add(o.mul(n/2))}EdgeGluingIsAllowedSSS(e,t,i){if(t.IsReal||i.IsReal||!Ha(t.getELP(),i.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,i,t.Position,i.Position))return!1;let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,i);return!(Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(B.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||Ge.IntersectionsOfLineAndRectangleNodeOverPolylineLR(B.mkPP(t.Position,i.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,i,n){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(n,0,Sn(t.getELP(),i.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(i,null,i.Position,n)||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,n)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,i,n){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-ke(e.Position,i.Position)-ke(e.Position,t.Position)+ke(e.Position,n)+ke(n,t.Position)+ke(n,i.Position);o+=xr.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,i).Metrolines){let f=d.Length,P=d.Length-ke(e.Position,i.Position)+ke(e.Position,n)+ke(n,i.Position);o+=xr.PathLengthsError(f,P,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let f=d.Length,P=d.Length-ke(e.Position,t.Position)+ke(e.Position,n)+ke(n,t.Position);o+=xr.PathLengthsError(f,P,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Gt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,i,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=xr.RError(h,c,this.bundlingSettings)),u>ke(e.Position,n)&&!e.IsReal&&(o-=xr.RError(u,ke(e.Position,n),this.bundlingSettings)),o}AddEdgeToGlue(e,t,i,n,o){o.has(i,e)||o.has(t,e)||o.has(e,i)||o.has(e,t)||(o.set(e,i,n),o.set(e,t,n))}GlueEdge(e){let t=e[0],i=e[1],n=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(i.Position)?this.SplitPolylinePoint(o,n):o.prev!=null&&o.prev.point.equal(i.Position)&&this.SplitPolylinePoint(o.prev,n)}SplitPolylinePoint(e,t){if(e.point==t||e.next.point==t)return;let i=_t.mkFromPoint(t);i.polyline=e.polyline,i.next=e.next,i.prev=e,i.next.prev=i,i.prev.next=i}RelaxConstrainedEdges(){let e=new Je,t=!1;for(let i of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(i[0],i[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*n/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(ke(e.Position,c[1]),ke(t.Position,c[1])),d=ke(e.Position,t.Position);if(h/d<.1)continue;let P=ke(c[0],c[1]);(l==-1||P<l)&&(l=P,u=c[1])}if(l==-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,Sn(e.getELP(),t.getELP())))return!1;i.add(u),i.add(e.Position),i.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new Ys(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),An.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var Yu=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,i.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new yr;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!Yu.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!Yu.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof ur}ProcessNeighbor(e,t,i){let n=t.Length,o=this._current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var ZP=class extends Ee{constructor(e,t,i,n,o,a,l,u,c,h){super(null);this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=e,this.regularEdges=e.filter(d=>d.source!=d.target),this.VisibilityGraph=i,this.shortestPathRouter=t,this.LoosePadding=o,this.LooseHierarchy=l,this.TightHierarchy=a,this.EdgeLooseEnterable=u,this.EdgeTightEnterable=c,this.loosePolylineOfPort=h,If(0)}ThereAreOverlaps(e){return Li(e,e,w.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let e=new XP(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.CdtProperty,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);ts.FixRouting(e,this.bundlingSettings),new $s(e,this.bundlingSettings).run()}FixChildParentEdges(){for(let e of this.regularEdges){let t=e.sourcePort,i=e.targetPort;if(t.Curve.boundingBox.containsRect(i.Curve.boundingBox)){let n=w.intersectionOne(t.Curve,B.mkPP(e.curve.start,e.curve.end),!1),o=e.curve;o.startPoint.point=n.x}if(i.Curve.boundingBox.containsRect(t.Curve.boundingBox)){let n=w.intersectionOne(i.Curve,B.mkPP(e.curve.start,e.curve.end),!0),o=e.curve;o.endPoint.point=n.x}}}static CreateConstrainedDelaunayTriangulation(e){let t=Array.from(e.GetAllLeaves()),i=e.irect,n=i.diagonal/4,o=i.clone();return o.pad(n),ZP.GetConstrainedDelaunayTriangulation(t.concat([o.perimeter()]))}static GetConstrainedDelaunayTriangulation(e){let t=new ot(null,e,null);return t.run(),t}FixLocationsForHookAnywherePorts(e){for(let t of e){let i=t.sourcePort instanceof Dt;if(i){let n=t.sourcePort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.targetPort,t))}else if(i=t.targetPort instanceof Dt,i){let n=t.targetPort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.sourcePort,t))}}}FigureOutHookLocation(e,t,i){return t instanceof br?this.FigureOutHookLocationForClusterOtherPort(e,t,i):this.FigureOutHookLocationForSimpleOtherPort(e,t,i)}FigureOutHookLocationForClusterOtherPort(e,t,i){let n=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),a=new Yu(Array.from(t.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(e).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let l of n)l.IsTransparent=!1;return a[a.length-1].point}FigureOutHookLocationForSimpleOtherPort(e,t,i){let n=t.Location,o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),l=new Vs(this.VisibilityGraph.FindVertex(n),Array.from(e).map(u=>this.VisibilityGraph.FindVertex(u)),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.CdtProperty!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let e=new Map;this.shortestPathRouter.FillCrossedCdtEdges(e);let t=this.GetPathsOnCdtEdge(e);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(t)}GetPathsOnCdtEdge(e){let t=new Map;for(let i of e.keys())for(let n of e.get(i))Wa(t,n,i);return t}CalculateEdgeWidthShrinkCoeff(e){let t=0,i=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(e,i))return i;let n=!1;for(;!n||Math.abs(i-t)>.01;){let o=(t+i)/2;this.EdgeSeparationIsOkMN(e,o)?(t=o,n=!0):i=o}return t}EdgeSeparationIsOkMN(e,t){for(let i of e.keys())if(!this.EdgeSeparationIsOk(i,e.get(i),t))return!1;return!0}EdgeSeparationIsOk(e,t,i){return Array.from(t).map(o=>this.bundlingSettings.ActualEdgeWidth(o,i)).reduce((o,a)=>o+a,0)<=e.Capacity}RouteSelfEdges(){for(let e of this.edgesToRoute)if(e.source==e.target){let t={smoothedPolyline:null};e.curve=We.RouteSelfEdge(e.source.boundaryCurve,this.LoosePadding*2,t)}}FixArrowheads(){for(let e of this.edgesToRoute)gr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}},Cn=ZP;Cn.SuperLoosePaddingCoefficient=1.1;var QP=class{constructor(e,t,i){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=i}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var KP=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source==this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var Tn=class{constructor(e,t,i){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.CdtProperty=t,this.Gates=i}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let i of t.InEdges){let n=new QP(i,this.VisibilityVerticesToSdVerts.get(i.Source),this.VisibilityVerticesToSdVerts.get(i.Target)),o=this.VisibilityVerticesToSdVerts.get(i.Source);e.InBoneEdges.push(n),o.OutBoneEdges.push(n)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new KP(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new te,i=this.EdgesToRouteSources.get(e);t.addPoint(i.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(i.Point)?(t.addPoint(a.TargetPoint),i=a.Target):(t.addPoint(a.SourcePoint),i=a.Source);e.curve=t,e.sourcePort instanceof br&&Tn.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof br&&Tn.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let i=t.closestParameter(e.end);e.addPoint(t.value(i))}static ExtendPolylineStartToClusterBoundary(e,t){let i=t.closestParameter(e.start);e.PrependPoint(t.value(i))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.CdtProperty!=null&&this.CdtProperty.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let i of t)i.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let n=0;n<this.vertexArray.length;n++){let o=this.vertexArray[n];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),i=this.RouteEdgeWithGroups();for(let n of t)n.IsTransparent=!1;return i}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new yr,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e==0);if(t!=null)return t;for(let i=0;i<this.vertexArray.length;i++)this.vertexArray[i].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let i={priority:0},n=this.Queue.DequeueAndGetPriority(i);if(!(i.priority>=this.LowestCostToTarget)){for(let o=0;o<n.OutBoneEdges.length;o++){let a=n.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(n,a,e,t)}for(let o=0;o<n.InBoneEdges.length;o++){let a=n.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(n,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,i,n){n&&i.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,i,n){n&&i.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,i){let n=this.GetEdgeAdditionalCost(i,e.Cost);if(!(t.Cost<=n))if(t.Cost=n,t.PrevEdge=i,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,n);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof br&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),n+o<this.LowestCostToTarget&&(this.LowestCostToTarget=n+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.CdtProperty!=null&&this.BundlingSettings.CapacityOverflowCoefficient!=0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity==t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let i=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*i+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*i)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.CdtProperty==null||this.BundlingSettings.CapacityOverflowCoefficient==0)return 0;let t=0;for(let i of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,i);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,i=e.Source.Triangle,n=new Set,o=e.TargetPoint;if(ot.PointIsInsideOfTriangle(o,i))return n;let a=new pl(i,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&n.add(l)}return n}static CostOfCrossingCdtEdge(e,t,i,n){let o=i.lineWidth*t.edgeWidthShrinkCoeff;n.Capacity!=n.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=n.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,i,n){return this.AdjacentToSourceOrTarget(n)?0:Tn.CostOfCrossingCdtEdge(e,t,i,n)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner==this.sourceLoosePoly||e.lowerSite.Owner==this.sourceLoosePoly||e.upperSite.Owner==this.targetLoosePoly||e.lowerSite.Owner==this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let i;if(e instanceof br){i=e.LoosePolyline;for(let o of i){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof Dt){i=e.LoosePolyline;for(let o of i)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let n=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=n[0].boundingBox.diagonal;i=n[0];for(let a=1;a<n.length;a++){let l=n[a],u=l.boundingBox.diagonal;u<o&&(o=u,i=l)}}return i}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,i){let n=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(n);t?(o.IsSourceOfRouting=!0,o.Cost=i,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.CdtProperty!=null&&(this.capacityOverlowPenaltyMultiplier=Tn.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)Tn.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.Constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,i=e.lowerSite.Owner;if(t!=i){let n=Kt.DistancePoint(new Kt(t),e.lowerSite.point),o=Kt.DistancePoint(new Kt(i),e.upperSite.point);e.Capacity=(n+o)/2}}SetVertexTriangles(){let e=Qe(Array.from(this.CdtProperty.GetTriangles()).map(i=>ct(i,i.BoundingBox()))),t=Qe(this.vertexArray.map(i=>ct(i,W.mkOnPoints([i.Point]))));_r(e,t,(i,n)=>this.TryToAssigenTriangleToVertex(i,n));for(let i of this.vertexArray);}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&ot.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let i of this.EdgesToRoutes.get(t))for(let n of this.CrossedCdtEdgesOfBoneEdge(i))this.AdjacentToSourceOrTarget(n)||Wa(e,t,n)}}};var $u=class{constructor(e,t,i,n,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=nh(i,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new Cn(e.edges,new Tn(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(i,n)=>w.PointRelativeToCurveLocation(i,n)!=0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,i={preGraphs:e};if(this.UniteConnectedPreGraphs(i),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=$u.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let i=ko(t),n=new Array;for(let o of i){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],n.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=n;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let i of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(i)}static GetIntersectionGraphOfPreGraphs(e){let t=$u.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?Lr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),i=nh(t,o=>e[o].boundingBox),n=new Array;return Ft(i,i,(o,a)=>n.push(new ge(o,a))),n}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,i=e[0],n=this.GetPortCurve(i.sourcePort),o=n.boundingBox;t.add(n),t.add(i.targetPort.Curve),o.addRec(i.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return Gh.constructorStatic(e,t)}};var it=class extends Ee{constructor(e,t,i=2,n=1.5,o=30*(Math.PI/180),a=null,l=null){super(l);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.portLocationsToLoosePolylines=new dt;this.multiEdgesSeparation=5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this._edges=t,this.BundlingSettings=a,this.geomGraph=e,this.LoosePadding=n,this.tightPadding=i,this.coneAngle=o}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(e){this.continueOnOverlaps=e}*edges(){if(this._edges!=null)for(let e of this._edges)yield e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(e){this.multiEdgesSeparation=e}static mk2(e,t){return it.mk5(e,t.Padding,t.PolylinePadding,t.ConeAngle,t.BundlingSettings)}static mk4(e,t,i,n){return new it(e,Array.from(e.edges()),t,i,n,null)}static mk5(e,t,i,n,o){return new it(e,Array.from(e.edges()),t,i,n,o)}static mk6(e,t,i,n,o,a){let l=it.mk4(e,t,i,n),u=wi.GetShapes(o,a);return l.Initialize(u,n),l}Initialize(e,t){this.rootShapes=e.filter(i=>i.Parents==null||i.Parents.length==0),this.coneAngle=t,this.coneAngle==0&&(this.coneAngle=Math.PI/6)}run(){if(this.geomGraph.isEmpty())return;let e=Br.GetShapes(this.geomGraph,this._edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings),this.Initialize(e,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[e,t]of this.portsToShapes){let i=new Set;it.EdgesAttachedToPortAvoidTheNode(e)||i.add(t),this.portsToEnterableShapes.set(e,i)}for(let e of this.rootShapes)for(let t of e.Descendants())for(let i of t.Ports){let n=this.portsToEnterableShapes.get(i);Iu(n,Array.from(t.Ancestors()).filter(o=>o.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(e){return e instanceof Pr||e instanceof br}SetLoosePolylinesForAnywherePorts(){for(let[e,t]of this.shapesToTightLooseCouples)for(let i of e.Ports){if(i instanceof Dt){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}if(i instanceof br){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new ro;for(let e of this.root.Children){let t=this.shapesToTightLooseCouples.get(e).LooseShape;this.BindLooseShapesUnderShape(e),this.looseRoot.AddChild(t)}}BindLooseShapesUnderShape(e){let t=this.shapesToTightLooseCouples.get(e).LooseShape;for(let i of e.Children){let n=this.shapesToTightLooseCouples.get(i).LooseShape;t.AddChild(n),this.BindLooseShapesUnderShape(i)}}CalculateShapeToBoundaries(e){if(this.ProgressStep(),e.Children.length==0)return;for(let i of e.Children)this.CalculateShapeToBoundaries(i);let t=new Sh(e,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples);t.Calculate(),this.OverlapsDetected||(this.OverlapsDetected=t.OverlapsDetected)}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(e){this._overlapsDetected=e}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*Cn.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let e=new Array;for(let t of this._edges){let i=this.EdgePassport(t),n=e.find(o=>Ha(o.passport,i));n||(n={passport:i,edges:[]},e.push(n)),n.edges.push(t)}return e}RouteOnVisGraph(){if(this.ancestorSets=it.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let e of this.GroupEdgesByPassport()){let t=e.passport,i=this.GetObstaclesFromPassport(t),n=this.CreateInteractiveEdgeRouter(Array.from(i));this.RouteEdgesWithTheSamePassport(e,n,i)}else this.RouteBundles()}RouteEdgesWithTheSamePassport(e,t,i){let n={regularEdges:[],multiEdges:[]};if(this.RouteMultiEdgesAsBundles){this.SplitOnRegularAndMultiedges(e.edges,n);for(let o of n.regularEdges)this.RouteEdge(t,o);n.multiEdges!=null&&(this.ScaleDownLooseHierarchy(t,i),this.RouteMultiEdges(n.multiEdges,t,e.passport))}else for(let o of e.edges)this.RouteEdge(t,o)}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}RouteEdge(e,t){let i=this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(t);this.ProgressStep(),this.RouteEdgeInternal(t,e),it.SetTransparency(i,!1)}ScaleDownLooseHierarchy(e,t){let i=new Array;for(let n of t){let o=this.shapesToTightLooseCouples.get(n);i.push(Jt.LoosePolylineWithFewCorners(o.TightPolyline,o.Distance/1.1))}e.LooseHierarchy=it.CreateLooseObstacleHierarachy(i),e.ClearActivePolygons(),e.AddActivePolygons(i.map(n=>new Kt(n)))}RouteMultiEdges(e,t,i){let n=[];for(let l of i)for(let u of l.Children)n.push(u.BoundaryCurve);let o=new Zn;o.InkImportance=1e-5,o.EdgeSeparation=this.MultiEdgesSeparation,new $u(e,t,n,o,l=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(l)).run()}SplitOnRegularAndMultiedges(e,t){let i=new ao;for(let n of e)it.IsEdgeToParent(n)?t.regularEdges.push(n):it.RegisterInPortLocationsToEdges(n,i);t.multiEdges=null;for(let n of i.values())n.length==1||this.OverlapsDetected?eo(t.regularEdges,n):(t.multiEdges==null&&(t.multiEdges=new Array),t.multiEdges.push(n))}static RegisterInPortLocationsToEdges(e,t){let i,n=new Ct(e.sourcePort.Location,e.targetPort.Location);i=t.get(n),i||(i=new Array,t.set(n,i)),i.push(e)}static IsEdgeToParent(e){return e.sourcePort instanceof Dt||e.targetPort instanceof Dt}CreateInteractiveEdgeRouter(e){let t=new Set(e.map(n=>this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve)),i=new Ge(this.cancelToken);return i.ObstacleCalculator=new Jt(e.map(n=>n.BoundaryCurve),this.tightPadding,this.loosePadding,!1),i.VisibilityGraph=this.visGraph,i.TightHierarchy=this.CreateTightObstacleHierarachy(e),i.LooseHierarchy=it.CreateLooseObstacleHierarachy(Array.from(t)),i.UseSpanner=!0,i.LookForRoundedVertices=!0,i.TightPadding=this.tightPadding,i.LoosePadding=this.LoosePadding,i.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,i.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,i.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,i.AllowedShootingStraightLines=this.AllowedShootingStraightLines,i.AddActivePolygons(Array.from(t).map(n=>new Kt(n))),i}GetObstaclesFromPassport(e){if(e.size==0)return new Set(this.root.Children);let t=this.GetCommonAncestorsAbovePassport(e),i=this.GetAllAncestors(e),n=new Set;for(let l of e)for(let u of l.Children)i.has(u)||n.add(u);let o=yn(new Set(e),n),a=new Tv.Queue;for(let l of e)t.has(l)||a.enqueue(l);for(;a.length>0;){let l=a.dequeue();for(let u of l.Parents){for(let c of u.Children)i.has(c)||n.add(c);!t.has(u)&&!o.has(u)&&(a.enqueue(u),o.add(u))}}return n}GetAllAncestors(e){if(e.size==0)return new Set;let t=new Set(e);for(let i of e)t=yn(t,this.ancestorSets.get(i));return t}GetCommonAncestorsAbovePassport(e){if(e.size==0)return new Set;let t=Array.from(e),i=this.ancestorSets.get(t[0]);for(let n=1;n<t.length;n++){let o=t[n];i=Sn(i,this.ancestorSets.get(o))}return i}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let e=this.GetLooseHierarchy(),t=Cn.CreateConstrainedDelaunayTriangulation(e),i=new Tn(o=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(o),t,this.FindCdtGates(t));new Cn(this._edges,i,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),e,this.enterableLoose,this.enterableTight,o=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(o))).run()}CreateTheMapToParentLooseShapes(e,t){for(let i of e.Children){let o=this.shapesToTightLooseCouples.get(i).LooseShape.BoundaryCurve;t.set(o,e),this.CreateTheMapToParentLooseShapes(i,t)}}FindCdtGates(e){let t=new Map;this.CreateTheMapToParentLooseShapes(this.root,t);let i=new Set;for(let n of e.PointsToSites.values())for(let o of n.Edges){if(o.CwTriangle==null&&o.CcwTriangle==null)continue;let a=n.Owner,l=o.lowerSite.Owner;if(a==l)continue;let u=t.get(a);if(u){let c=t.get(l);u==c&&i.add(o)}}return i}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let e of this.edges()){let t=new Set,i=new Set;this.GetEdgeEnterablePolylines(e,t,i),this.enterableLoose.set(e,t),this.enterableTight.set(e,i)}}GetEdgeEnterablePolylines(e,t,i){let n=this.portsToShapes.get(e.sourcePort),o=this.portsToShapes.get(e.targetPort);n!=this.root&&this.GetEnterablesForShape(n,t,i),o!=this.root&&this.GetEnterablesForShape(o,t,i)}GetEnterablesForShape(e,t,i){for(let n of this.ancestorSets.get(e)){let o=this.LoosePolyOfOriginalShape(n);o&&t.add(o);let a=this.TightPolyOfOriginalShape(n);a&&i.add(a)}}GetTightHierarchy(){return Qe(Array.from(this.shapesToTightLooseCouples.values()).map(e=>ct(e.TightPolyline,e.TightPolyline.boundingBox)))}GetLooseHierarchy(){let e=new Set;for(let t of this.shapesToTightLooseCouples.values())e.add(t.LooseShape.BoundaryCurve);return Qe(Array.from(e).map(t=>ct(t,t.boundingBox)))}ScaleLooseShapesDown(){for(let[,e]of this.shapesToTightLooseCouples)e.LooseShape.BoundaryCurve=Jt.LoosePolylineWithFewCorners(e.TightPolyline,e.Distance/Cn.SuperLoosePaddingCoefficient)}EdgePassport(e){let t=new Set,i=this.portsToShapes.get(e.sourcePort),n=this.portsToShapes.get(e.targetPort);return this.IsAncestor(i,n)?(Iu(t,n.Parents),t.add(i),t):this.IsAncestor(n,i)?(Iu(t,i.Parents),t.add(n),t):(i!=this.looseRoot&&Iu(t,i.Parents),n!=this.looseRoot&&Iu(t,n.Parents),t)}*AllPorts(){for(let e of this.edges())yield e.sourcePort,yield e.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let e of this.root.Descendants())for(let t of e.Ports)this.portsToShapes.set(t,e);for(let e of this.AllPorts())this.portsToShapes.has(e)||(this.root.Ports.add(e),this.portsToShapes.set(e,this.root))}RouteEdgeInternal(e,t){let i=new Array;e.sourcePort instanceof Dt||eo(i,this.AddVisibilityEdgesFromPort(e.sourcePort)),e.targetPort instanceof Dt||eo(i,this.AddVisibilityEdgesFromPort(e.targetPort));let n={smoothedPolyline:null};if(p.closeDistEps(e.sourcePort.Location,e.targetPort.Location)?e.curve=We.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.LoosePadding*2,e.GetMaxArrowheadLength()),n):e.curve=t.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e.sourcePort,e.targetPort,!0,n),e.smoothedPolyline=n.smoothedPolyline,e.curve==null)throw new Error;for(let o of i)$e.RemoveEdge(o);gr.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!1)}*AddVisibilityEdgesFromPort(e){let t,i;if(e instanceof Pr||!(t=this.portsToShapes.get(e))||!(i=this.shapesToTightLooseCouples.get(t)))return;let n=i.LooseShape;for(let o of n.BoundaryCurve)this.visGraph.FindEdgePP(e.Location,o)==null&&(yield this.visGraph.AddEdgePP(e.Location,o))}MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(e){let t=this.portsToShapes.get(e.sourcePort),i=this.portsToShapes.get(e.targetPort),n=new Array;for(let o of this.GetTransparentShapes(e.sourcePort,e.targetPort,t,i))o!=null&&n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.sourcePort))n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.targetPort))n.push(this.LooseShapeOfOriginalShape(o));return it.SetTransparency(n,!0),n}LooseShapeOfOriginalShape(e){return e==this.root?this.looseRoot:this.shapesToTightLooseCouples.get(e).LooseShape}LoosePolyOfOriginalShape(e){return this.LooseShapeOfOriginalShape(e).BoundaryCurve}TightPolyOfOriginalShape(e){return e==this.root?null:this.shapesToTightLooseCouples.get(e).TightPolyline}*GetTransparentShapes(e,t,i,n){for(let o of this.ancestorSets.get(i))yield o;for(let o of this.ancestorSets.get(n))yield o;it.EdgesAttachedToPortAvoidTheNode(e)||(yield i),it.EdgesAttachedToPortAvoidTheNode(t)||(yield n)}static SetTransparency(e,t){for(let i of e)i.IsTransparent=t}IsAncestor(e,t){let i;return t!=null&&(i=this.ancestorSets.get(t))!=null&&i.has(e)}static CreateLooseObstacleHierarachy(e){return Qe(e.map(t=>ct(t,t.boundingBox)))}CreateTightObstacleHierarachy(e){let t=e.map(i=>this.shapesToTightLooseCouples.get(i).TightPolyline);return Qe(t.map(i=>ct(i,i.boundingBox)))}CalculateVisibilityGraph(){let e=this.LineSweeperPorts!=null?Je.mk(this.LineSweeperPorts):new Je;this.ProcessHookAnyWherePorts(e),this.portRTree=$n(Array.from(e.values()).map(t=>[W.rectangleOnPoint(t),t])),this.visGraph=new $e,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(e,t,i,n=null,o=null){let a=Array.from(t.Edges).map(l=>fe.mkDebugCurveTWCI(100,1,l.IsPassable!=null&&l.IsPassable()?"green":"black",B.mkPP(l.SourcePoint,l.TargetPoint)));if(i!=null)for(let l of i){a.push(fe.mkDebugCurveTWCI(100,.3,"brown",l));for(let u of l)a.push(fe.mkDebugCurveTWCI(100,1,"green",Be.mkCircle(1,u)))}if(n!=null)for(let l of n)a.push(fe.mkDebugCurveTWCI(100,10,"navy",l));if(o!=null)for(let l of o)a.push(fe.mkDebugCurveTWCI(100,10,"red",l))}ProcessHookAnyWherePorts(e){for(let t of this.edges())t.sourcePort instanceof Dt||t.sourcePort instanceof br||e.add(t.sourcePort.Location),t.targetPort instanceof Dt||t.targetPort instanceof br||e.add(t.targetPort.Location)}FillVisibilityGraphUnderShape(e){let t=e.Children;for(let h of t)this.FillVisibilityGraphUnderShape(h);let i=this.shapesToTightLooseCouples.get(e),n=i?i.LooseShape.BoundaryCurve:null,o=i?i.LooseShape:this.looseRoot,a=new Set(o.Children.map(h=>h.BoundaryCurve)),l=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(n),u=new $e,c=Gs.mk([],u,this.coneAngle,l,n);c.run(),u=new $e,c=Gs.mk(Array.from(a),u,this.coneAngle,l,n),c.run(),this.ProgressStep();for(let h of u.Edges)this.TryToCreateNewEdgeAndSetIsPassable(h,o);this.AddBoundaryEdgesToVisGraph(n)}get Bidirectional(){return this.bidirectional}set Bidirectional(e){this.bidirectional=e}TryToCreateNewEdgeAndSetIsPassable(e,t){let i=this.visGraph.FindEdgePP(e.SourcePoint,e.TargetPoint);i==null&&(i=this.visGraph.AddEdgePP(e.SourcePoint,e.TargetPoint),t!=null&&(i.IsPassable=()=>t.IsTransparent))}AddBoundaryEdgesToVisGraph(e){if(e==null)return;let t;for(let i=e.startPoint;t=i.nextOnPolyline,this.visGraph.AddEdgePP(i.point,t.point),t!=e.startPoint;i=t);}RemoveInsidePortsAndSplitBoundaryIfNeeded(e){let t=new Je;if(e==null){for(let o of this.portRTree.GetAllLeaves())t.add(o);return this.portRTree.Clear(),t}let i=e.boundingBox,n=this.portRTree.GetAllIntersecting(i);for(let o of n)switch(w.PointRelativeToCurveLocation(o,e)){case 2:t.add(o),this.portLocationsToLoosePolylines.set(o,e),this.portRTree.Remove(W.rectangleOnPoint(o),o);break;case 1:this.portRTree.Remove(W.rectangleOnPoint(o),o),this.portLocationsToLoosePolylines.set(o,e);let a=it.FindPointOnPolylineToInsertAfter(e,o);if(a!=null)Nt.InsertPointIntoPolylineAfter(e,a,o);else throw new Error;break}return t}static FindPointOnPolylineToInsertAfter(e,t){for(let i=e.startPoint;;){let n=i.nextOnPolyline;if(p.closeDistEps(t,i.point)||p.closeDistEps(t,n.point))return null;let o=p.distToLineSegment(t,i.point,n.point).dist;if(ae(o,0))return i;if(i=n,i==e.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length==1){let e=this.rootShapes[0];if(e.BoundaryCurve==null){this.root=e;return}}this.rootWasCreated=!0,this.root=new ro(null);for(let e of this.rootShapes)this.root.AddChild(e)}RemoveRoot(){if(this.rootWasCreated)for(let e of this.rootShapes)e.RemoveParent(this.root)}static GetAncestorSetsMap(e){let t=new Map;for(let i of e.filter(n=>!t.has(n)))t.set(i,it.GetAncestorSet(i,t));return t}static GetAncestorSet(e,t){let i=new Set(e.Parents);for(let n of e.Parents){let o=t.get(n);o||t.set(n,o=it.GetAncestorSet(n,t));for(let a of o)i.add(a)}return i}static CreatePortsIfNeeded(e){for(let t of e){if(t.sourcePort==null){let i=t;new Ai(()=>i.source.boundaryCurve,()=>i.source.center,new p(0,0))}if(t.targetPort==null){let i=t;new Ai(()=>i.target.boundaryCurve,()=>i.target.center,new p(0,0))}}}static ComputeLooseSplinePadding(e,t){let i=2*t;return(e-i)/8}};function yv(s,e,t){let i=s.layoutSettings?s.layoutSettings.edgeRoutingSettings:zP(s);new it(s,e,i.Padding,i.PolylinePadding,i.coneAngle,i.BundlingSettings,t).run()}function Sv(s,e,t){if(e)for(let i of e){if(t&&t.canceled)return;Vr.RouteEdge(i,s.padding)}else for(let i of s.deepNodesIt()){if(t&&t.canceled)return;for(let n of i.outEdges())n.curve==null&&Vr.RouteEdge(n,s.padding);for(let n of i.selfEdges())n.curve==null&&Vr.RouteEdge(n,s.padding)}}var Vr=class extends Ee{constructor(e,t){super(null);this.edges=e,this.padding=t}run(){it.CreatePortsIfNeeded(this.edges);for(let e of this.edges)Vr.RouteEdge(e,this.padding)}static RouteEdge(e,t){let i=e;i.sourcePort==null&&(i.sourcePort=Ai.mk(()=>e.source.boundaryCurve,()=>e.source.center)),i.targetPort==null&&(i.targetPort=Ai.mk(()=>e.target.boundaryCurve,()=>e.target.center)),Vr.ContainmentLoop(i,t)||(i.curve=Vr.GetEdgeLine(e)),gr.trimSplineAndCalculateArrowheadsII(i,i.sourcePort.Curve,i.targetPort.Curve,e.curve,!1)}static ContainmentLoop(e,t){let i=e.sourcePort.Curve,n=e.targetPort.Curve;if(i==null||n==null)return!1;let o=i.boundingBox,a=n.boundingBox,l=o.containsRect(a),u=!l&&a.containsRect(o);return l||u?(e.curve=Vr.CreateLoop(o,a,u,t),!0):!1}static CreateLoop(e,t,i,n){return i?Vr.CreateLoop_(e,t,n,!1):Vr.CreateLoop_(t,e,n,!0)}static CreateLoop_(e,t,i,n){let o=e.center,a=Vr.FindClosestPointOnBoxBoundary(e.center,t),l=a.sub(o),c=(Math.abs(l.x)<C.distanceEpsilon?Math.min(o.y-t.bottom,t.top-o.y):Math.min(o.x-t.left,t.right-o.x))/2,h=Math.min(i,c);l.length<=C.distanceEpsilon&&(l=new p(1,0));let d=l.normalize(),f=d.rotate(Math.PI/2),P=a.add(d.mul(i)),E=P.add(f.mul(h)),v=a.add(f.mul(h)),L=o.add(f.mul(h));return(n?mt.mkFromPoints([L,v,E,P,a,o]):mt.mkFromPoints([o,a,P,E,v,L])).createCurve()}static FindClosestPointOnBoxBoundary(e,t){let i=e.x-t.left<t.right-e.x?t.left:t.right,n=e.y-t.bottom<t.top-e.y?t.bottom:t.top;return Math.abs(i-e.x)<Math.abs(n-e.y)?new p(i,e.y):new p(e.x,n)}static GetEdgeLine(e){let t,i;e.sourcePort==null?(t=e.source.center,i=e.source.boundaryCurve):(t=e.sourcePort.Location,i=e.sourcePort.Curve);let n,o;e.targetPort==null?(n=e.target.center,o=e.target.boundaryCurve):(n=e.targetPort.Location,o=e.targetPort.Curve);let a=B.mkPP(t,n),l=w.getAllIntersections(i,a,!1);if(l.length>0){let u=a.trim(l[0].par1,1);u instanceof B&&(a=u,l=w.getAllIntersections(o,a,!1),l.length>0&&(u=a.trim(0,l[0].par1),u instanceof B&&(a=u)))}return a}static CreateSimpleEdgeCurveWithUnderlyingPolyline(e){let t=e.source.center,i=e.target.center;if(e.source==e.target){let n=2/(3*e.source.boundaryCurve.boundingBox.width),o=e.source.boundingBox.height/4;e.underlyingPolyline=Vr.CreateUnderlyingPolylineForSelfEdge(t,n,o),e.curve=e.underlyingPolyline.createCurve()}else e.underlyingPolyline=mt.mkFromPoints([t,i]),e.curve=e.underlyingPolyline.createCurve();gr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(e,t,i){let n=e.add(new p(0,i)),o=e.add(new p(t,i)),a=e.add(new p(t,i*-1)),l=e.add(new p(0,i*-1)),u=tt.mkSiteP(e),c=new mt(u);return u=tt.mkSiteSP(u,n),u=tt.mkSiteSP(u,o),u=tt.mkSiteSP(u,a),u=tt.mkSiteSP(u,l),tt.mkSiteSP(u,e),c}static SetStraightLineEdgesWithUnderlyingPolylines(e){it.CreatePortsIfNeeded(Array.from(e.edges()));for(let t of e.edges())Vr.CreateSimpleEdgeCurveWithUnderlyingPolyline(t)}};var En=class extends Ee{constructor(e,t,i,n,o,a){super(null);this.settings=e,this.OriginalGraph=t,this.Database=i,this.ProperLayeredGraph=o,this.LayerArrays=n,this.IntGraph=a}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){for(let e of this.OriginalGraph.deepNodesIt())for(let t of e.outEdges())t.curve||Vr.RouteEdge(t,Math.max(t.source.padding,t.target.padding))}RouteFlatEdges(){}createRegularSplines(){for(let e of this.Database.RegularMultiedges()){let t=e.length,i=t==1&&!this.FanAtSourceOrTarget(e[0]);for(let n=Math.floor(t/2);n<t;n++)this.createSplineForNonSelfEdge(e[n],i);for(let n=Math.floor(t/2)-1;n>=0;n--)this.createSplineForNonSelfEdge(e[n],i)}}FanAtSourceOrTarget(e){return this.ProperLayeredGraph.OutDegreeIsMoreThanOne(e.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(e.target)}createSelfSplines(){for(let[e,t]of this.Database.Multiedges.keyValues()){let i=e;if(i.x==i.y){let n=this.Database.Anchors[i.x],o=n.leftAnchor;for(let a of t){let l=this.settings.NodeSeparation+(this.settings.MinNodeWidth+o),u=n.bottomAnchor/2,c=n.origin,h=c.add(new p(0,u)),d=c.add(new p(l,u)),f=c.add(new p(l,u*-1)),P=c.add(new p(0,u*-1)),E=tt.mkSiteP(c),v=new mt(E);E=tt.mkSiteSP(E,h),E=tt.mkSiteSP(E,d),E=tt.mkSiteSP(E,f),E=tt.mkSiteSP(E,P),tt.mkSiteSP(E,c);let L=v.createCurve();if(a.curve=L,a.edge.underlyingPolyline=v,o=l,a.edge.label!=null){o+=a.edge.label.width;let O=L.value((L.parStart+L.parEnd)/2),D=new p(O.x+a.labelWidth/2,n.y),_=new p(a.edge.label.width/2,a.edge.label.height/2),F=W.mkPP(D.add(_),D.sub(_));a.edge.label.boundingBox=F}gr.trimSplineAndCalculateArrowheadsII(a.edge,a.edge.source.boundaryCurve,a.edge.target.boundaryCurve,L,!1)}}}}createSplineForNonSelfEdge(e,t){e.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(e,t),e.IsVirtualEdge||(e.updateEdgeLabelPosition(this.Database.Anchors),gr.trimSplineAndCalculateArrowheadsII(e.edge,e.edge.source.boundaryCurve,e.edge.target.boundaryCurve,e.curve,!0)))}drawSplineBySmothingThePolyline(e,t){let i=new lr(e,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),n=i.getSpline(t);e.reversed?(e.curve=n.reverse(),e.underlyingPolyline=i.Reverse().GetPolyline):(e.curve=n,e.underlyingPolyline=i.GetPolyline)}static UpdateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new p(t.x+t.rightAnchor/2,t.y),i=B.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new p(t.x-t.leftAnchor/2,t.y),i=B.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=En.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&w.getAllIntersections(e.curve,w.polyFromBox(e.labelBBox),!1).length==0){let o={curveClosestPoint:void 0,labelSideClosest:void 0};if(En.FindClosestPoints(o,n,i))En.ShiftLabel(e,o);else{let a=n.closestParameter(i.start),l=n.closestParameter(i.end);n.value(a).sub(i.start).length<n.value(l).sub(i.end).length?(o.curveClosestPoint=n.value(a),o.labelSideClosest=i.start):(o.curveClosestPoint=n.value(l),o.labelSideClosest=i.end),En.ShiftLabel(e,o)}}}static ShiftLabel(e,t){let i=e.lineWidth/2,n=t.curveClosestPoint.sub(t.labelSideClosest),o=n.length;o>i&&(e.label.center=e.label.center.add(n.div(o*(o-i))))}static FindClosestPoints(e,t,i){let n=w.minDistWithinIntervals(t,i,t.parStart,t.parEnd,i.parStart,i.parEnd,(t.parStart+t.parEnd)/2,(i.parStart+i.parEnd)/2);return n?(e.curveClosestPoint=n.aX,e.labelSideClosest=n.bX,!0):!1}static GetSegmentInFrontOfLabel(e,t){if(e instanceof w){let i=e;for(let n of i.segs)if((n.start.y-t)*(n.end.y-t)<=0)return n}return null}static GetNodeKind(e,t){return e==0?0:e<t.count?1:2}};var Fh=class extends Ee{constructor(e,t,i){super(i);this.LayersAreDoubled=!1;if(e==null)return;this.originalGraph=e,this.sugiyamaSettings=t;let n=Array.from(e.shallowNodes());this.nodeIdToIndex=new Map;let o=0;for(let l of n)this.nodeIdToIndex.set(l.id,o++);let a=[];for(let l of this.originalGraph.edges()){let u=this.nodeIdToIndex.get(l.source.id);if(u==null)continue;let c=this.nodeIdToIndex.get(l.target.id);if(c==null)continue;let h=new Or(u,c,l);a.push(h)}this.IntGraph=new Uo(a,e.shallowNodeCount),this.IntGraph.nodes=n,this.database=new Eb(n.length);for(let l of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(l);this.cycleRemoval()}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount==0){this.originalGraph.boundingBox=W.mkEmpty();return}nR(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode==3&&this.runPostLayering(),oR(this.originalGraph,this.sugiyamaSettings.transform),this.originalGraph.updateBoundingBox(),this.SetMargins()}SetMargins(){this.originalGraph.boundingBox.right+=this.sugiyamaSettings.margins.right,this.originalGraph.boundingBox.top+=this.sugiyamaSettings.margins.bottom,this.originalGraph.boundingBox.left-=this.sugiyamaSettings.margins.left,this.originalGraph.boundingBox.bottom-=this.sugiyamaSettings.margins.bottom}runPostLayering(){let e=this.sugiyamaSettings.edgeRoutingSettings;(this.constrainedOrdering!=null?0:e.EdgeRoutingMode)==3?this.calculateEdgeSplines():hl(this.originalGraph,Array.from(this.originalGraph.deepEdges()),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let e=this.sugiyamaSettings.verticalConstraints,t=e.isEmpty?Ei.getFeedbackSet(this.IntGraph):e.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(t)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let e=this.CalculateLayerArrays();return this.UpdateNodePositionData(),e}UpdateNodePositionData(){this.TryToSatisfyMinWidhtAndMinHeight();for(let e=0;e<this.IntGraph.nodeCount&&e<this.database.Anchors.length;e++)this.IntGraph.nodes[e].center=this.database.Anchors[e].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let e=0;e<this.originalGraph.shallowNodeCount;e++)this.SnapLeftSidesOfTheNodeToGrid(e,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(e,t){let i=this.IntGraph.nodes[e],n=this.database.Anchors[e];n.leftAnchor-=t/2,n.rightAnchor-=t/2;let o=i.boundingBox.left,a=Math.floor(o/t),l=o-a*t;Math.abs(l)<.001||(Math.abs(l)<=t/2?i.center=i.center.add(new p(-l,0)):i.center=i.center.add(new p(t-l,0)),n.x=i.center.x)}TryToSatisfyMinWidhtAndMinHeight(){this.TryToSatisfyMinWidth(),this.TryToSatisfyMinHeight()}TryToSatisfyMinWidth(){if(this.sugiyamaSettings.MinimalWidth==0)return;this.GetCurrentWidth()<this.sugiyamaSettings.MinimalWidth&&this.StretchWidth()}StretchWidth(){let e=new Rr;for(let i of this.originalGraph.shallowNodes())e.AddValue(i.boundingBox.width/2),e.AddValue(this.sugiyamaSettings.MinimalWidth-i.boundingBox.width/2);let t=new Rr;for(let i of this.NodeAnchors())t.AddValue(i.x);if(t.length>C.distanceEpsilon){let i=e.length/t.length;if(i>1)for(let n of this.anchors)n.x*=i}}TryToSatisfyMinHeight(){if(this.sugiyamaSettings.MinimalHeight==0)return;this.GetCurrentHeight()<this.sugiyamaSettings.MinimalHeight&&this.StretchHeight()}GetCurrentHeight(){let e=new Rr;for(let t of this.NodeAnchors())e.AddValue(t.top),e.AddValue(t.bottom);return e.length}StretchHeight(){let e=new Rr;for(let i of this.originalGraph.shallowNodes())e.AddValue(i.boundingBox.height/2),e.AddValue(this.sugiyamaSettings.MinimalHeight-i.boundingBox.height/2);let t=new Rr;for(let i of this.NodeAnchors())t.AddValue(i.y);if(t.length>C.distanceEpsilon){let i=e.length/t.length;if(i>1)for(let n of this.anchors)n.y*=i}}*NodeAnchors(){let e=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let t=0;t<e;t++)yield this.anchors[t]}GetCurrentWidth(){let e=new Rr;for(let t of this.NodeAnchors())e.AddValue(t.left),e.AddValue(t.right);return e.length}ExtendLayeringToUngluedSameLayerVertices(e){let t=this.verticalConstraints;for(let i=0;i<e.length;i++)e[i]=e[t.nodeToRepr(i)];return e}calculateEdgeSplines(){new En(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(e){let t=e.GetLayers();uh.Balance(this.gluedDagSkeletonForLayering,t,this.GetNodeCountsOfGluedDag(),null),t=this.ExtendLayeringToUngluedSameLayerVertices(t);let i=new vi(t);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return i=this.YLayeringAndOrderingWithoutHorizontalConstraints(i),i;throw new Error("not implemented")}CreateProperLayeredGraph(e){let t=e.length,i=0;for(let o of this.database.SkeletonEdges()){let a=Y2(e,o);a>0&&(o.LayerEdges=new Array(a));let l=0;if(a>1){let u=t+i++,c=new xi(o.source,u,o.CrossingWeight,o.weight);o.LayerEdges[l++]=c;for(let h=0;h<a-2;h++)u++,i++,c=new xi(u-1,u,o.CrossingWeight,o.weight),o.LayerEdges[l++]=c;c=new xi(u,o.target,o.CrossingWeight,o.weight),o.LayerEdges[l]=c}else if(a==1){let u=new xi(o.source,o.target,o.CrossingWeight,o.weight);o.LayerEdges[l]=u}}let n=new Array(this.originalGraph.shallowNodeCount+i).fill(0);for(let o of this.database.SkeletonEdges())if(o.LayerEdges!=null){let a=e[o.source];n[o.source]=a--;for(let l of o.LayerEdges)n[l.Target]=a--}else n[o.source]=e[o.source],n[o.target]=e[o.target];return this.properLayeredGraph=new Pn(new Uo(Array.from(this.database.SkeletonEdges()),e.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new vi(n)}YLayeringAndOrderingWithoutHorizontalConstraints(e){let t=this.CreateProperLayeredGraph(e.y);return Ns.OrderLayers(this.properLayeredGraph,t,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),wu.UpdateLayerArrays1(this.properLayeredGraph,t),t}CalculateYLayers(){let e=this.YLayeringAndOrdering(new kb(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?e:this.InsertLayersIfNeeded(e)}InsertLayersIfNeeded(e){this.InsertVirtualEdgesIfNeeded(e);let t=this.AnalyzeNeedToInsertLayersAndHasMultiedges(e);if(t.needToInsertLayers){let i=_s.InsertLayers(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la,this.LayersAreDoubled=!0}else if(t.multipleEdges){let i=Jn.InsertPaths(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la}return this.RecreateIntGraphFromDataBase(),e}RecreateIntGraphFromDataBase(){let e=new Array;for(let t of this.database.Multiedges.values())e=e.concat(t);this.IntGraph.SetEdges(e,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(e){if(this.constrainedOrdering==null){for(let[t,i]of this.database.Multiedges.keyValues())if(i.length%2==0&&e.y[t.x]-1==e.y[t.y]){let n=new We(null),o=new Or(t.x,t.y,n);o.IsVirtualEdge=!0,i.splice(i.length/2,0,o),this.IntGraph.addEdge(o)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(e){let t=!1,i=!1;for(let n of this.IntGraph.edges)if(n.hasLabel&&e.y[n.source]!=e.y[n.target]){t=!0;break}if(t==!1&&this.constrainedOrdering==null){for(let[n,o]of this.database.Multiedges.keyValues())if(o.length>1&&(i=!0,e.y[n.x]-e.y[n.y]==1)){t=!0;break}}return{needToInsertLayers:t,multipleEdges:i}}UseBrandesXCalculations(e){return e.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(e){this.anchors=j2(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),q2(e,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let e=0;e<this.anchors.length;e++){let t=this.anchors[e];if(t.labelIsToTheRightOfTheSpline){let i=this.GetSuccessorAndPredecessor(e);if(!K2(t,i.predecessor,i.successor)){let n=i.predecessor.origin.sub(t.origin).length+i.successor.origin.sub(t.origin).length,o=t.right-t.leftAnchor,a=new p(o,t.y);i.predecessor.origin.sub(a).length+i.successor.origin.sub(a).length<n&&Ov(t)}}}}GetSuccessorAndPredecessor(e){let t;for(let n of this.properLayeredGraph.InEdges(e))t=n.Source;let i;for(let n of this.properLayeredGraph.OutEdges(e))i=n.Target;return{predecessor:this.anchors[t],successor:this.anchors[i]}}CalculateLayerArrays(){let e=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(e),this.UseBrandesXCalculations(e)?this.CalculateXPositionsByBrandes(e):this.CalculateXLayersByGansnerNorth(e)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=e,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),e}StretchToDesiredAspectRatio(e,t){e>t?this.StretchInYDirection(e/t):e<t&&this.StretchInXDirection(t/e)}StretchInYDirection(e){let t=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let n of this.database.Anchors)n.bottomAnchor=n.bottomAnchor*e,n.topAnchor=n.topAnchor*e,n.y=t+e*(n.y-t);let i=this.originalGraph.height*e;this.originalGraph.boundingBox=new W({left:this.originalGraph.boundingBox.left,top:t+i/2,right:this.originalGraph.boundingBox.right,bottom:t-i/2})}StretchInXDirection(e){let t=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let n of this.database.Anchors)n.leftAnchor=n.leftAnchor*e,n.rightAnchor=n.rightAnchor*e,n.x=t+e*(n.x-t);let i=this.originalGraph.width*e;this.originalGraph.boundingBox=new W({left:t-i/2,top:this.originalGraph.boundingBox.top,right:t+i/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length==0)return;let e=new W({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let n=1;n<this.anchors.length;n++){let o=this.anchors[n];e.add(o.leftTop),e.add(o.rightBottom)}let t=e.leftTop.sub(e.rightBottom).length/2,i=new p(t*-1,t);e.add(e.leftTop.add(i)),e.add(e.rightBottom.sub(i)),this.originalGraph.boundingBox=e}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let e=!1;for(let t of this.database.AllIntEdges())t.LayerSpan==2&&(e=this.ShiftVertexWithNeighbors(t.LayerEdges[0].Source,t.LayerEdges[0].Target,t.LayerEdges[1].Target)||e);return e}ShiftVertexWithNeighbors(e,t,i){let n=this.database.Anchors[e],o=this.database.Anchors[i],a=this.database.Anchors[t],l=(a.y-n.y)*((o.x-n.x)/(o.y-n.y))+n.x,u=1e-4;return l>a.x+u?this.TryShiftToTheRight(l,t):l<a.x-u?this.TryShiftToTheLeft(l,t):!1}TryShiftToTheLeft(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n>0){let o=this.database.Anchors[i[n-1]],a=Math.max(o.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[t].leftAnchor),e);return a<this.database.Anchors[t].x-1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}TryShiftToTheRight(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n<i.length-1){let o=this.database.Anchors[i[n+1]],a=Math.min(o.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[t].rightAnchor),e);return a>this.database.Anchors[t].x+1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}CalculateXLayersByGansnerNorth(e){this.xLayoutGraph=this.CreateXLayoutGraph(e),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let e=new gh(this.xLayoutGraph,null).GetLayers();for(let t=0;t<this.database.Anchors.length;t++)this.anchors[t].x=e[t]}CreateXLayoutGraph(e){let t=this.properLayeredGraph.NodeCount,i=new Array;for(let o of this.properLayeredGraph.Edges){let a=new Or(t,o.Source,null),l=new Or(t,o.Target,null);l.weight=o.Weight,a.weight=o.Weight,a.separation=0,l.separation=0,t++,i.push(a),i.push(l)}for(let o of e.Layers)for(let a=o.length-1;a>0;a--){let l=o[a],u=o[a-1],c=new Or(l,u,null),h=this.database.Anchors[l],d=this.database.Anchors[u],f=h.leftAnchor+(d.rightAnchor+this.sugiyamaSettings.NodeSeparation);c.separation=Math.ceil(f+.5),i.push(c)}let n=new Ub(this.IntGraph,this.properLayeredGraph,e,i,t);return n.SetEdgeWeights(),n}CalculateXPositionsByBrandes(e){Rf.CalculateXCoordinates(e,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let e=new bn(this.IntGraph.nodeCount);for(let[i,n]of this.database.Multiedges.keyValues()){if(i.isDiagonal())continue;let o=this.verticalConstraints.gluedIntEdge(n[0]);o.source!=o.target&&e.set(o.source,o.target,o)}let t=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(i=>X2(i,null));for(let i of t)e.set(i.source,i.target,i);return Array.from(e.values())}static CalcAnchorsForOriginalNode(e,t,i,n,o){let a={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(t.nodes!=null){let c=t.nodes[e];tR(a,c,o)}rR(e,a,n,o);let l=o.MinNodeWidth/2;a.leftAnchor<l&&(a.leftAnchor=l),a.rightAnchor<l&&(a.rightAnchor=l);let u=o.MinNodeHeight/2;a.topAnchor<u&&(a.topAnchor=u),a.bottomAnchor<u&&(a.bottomAnchor=u),i[e]=Yr.mkAnchor(a.leftAnchor,a.rightAnchor,a.topAnchor,a.bottomAnchor,t.nodes[e],o.LabelCornersPreserveCoefficient),i[e].padding=t.nodes[e].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new Uo(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let e=new bn(this.IntGraph.nodeCount);for(let t of this.gluedDagSkeletonForLayering.edges)e.set(t.source,t.target,t);for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!=t.y){let n=this.verticalConstraints.gluedIntPair(t);if(n.x==n.y)continue;let o=e.get(n.x,n.y);for(let a of i)o.weight+=a.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function Iv(s,e){if(e==0)return 0;let t=Math.floor(s/e),i=s-t*e;return Math.abs(i)<1e-4?0:e-i}function W2(s,e){for(let t of s)if(t<e)return!0;return!1}function j2(s,e,t,i,n){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new Yr(n.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)Fh.CalcAnchorsForOriginalNode(a,i,o,s,n);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!=a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=JP()*4,c.topAnchor=c.bottomAnchor=wv(n)/2):(c.leftAnchor=c.rightAnchor=JP()/2,c.topAnchor=c.bottomAnchor=wv(n)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=JP()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function JP(){return 1}function wv(s){return s.MinNodeHeight*1.5/8}function Lv(s,e,t,i,n,o){let a=0;if(t>0){let l=J2(e.Layers[t-1],e.y,i);if(l.length){let u=n.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>eR(h,c,u,s)))}}return a}function q2(s,e,t,i,n,o,a){let l=i.Anchors,u=t.Margins+e,c=0;for(let h of s.Layers){let d=0,f=0;for(let O of h){let D=l[O];D.bottomAnchor>d&&(d=D.bottomAnchor),D.topAnchor>f&&(f=D.topAnchor)}$2(h,d,f,t.shallowNodeCount,i.Anchors);let P=Lv(i,s,c,n,o,u),E=u+d+P,v=E+f;if(Z2(o)){v+=Iv(v,o.GridSizeByY);for(let O of h)l[O].top=v}else if(Q2(o)){let O=E-d;O+=Iv(O,O);for(let D of h)l[D].bottom=O,v=Math.max(l[D].top,v)}else for(let O of h)l[O].y=E;let L=o.ActualLayerSeparation(a);u=v+L,c++}Lv(i,s,c,n,o,u)}function X2(s,e){let t=new Or(s.x,s.y,e);return t.weight=0,t.separation=1,t}function Y2(s,e){return s[e.source]-s[e.target]}function $2(s,e,t,i,n){if(W2(s,i)){for(let o of s)if(o>=i){let a=n[o];a.bottomAnchor=e,a.topAnchor=t}}}function Z2(s){return s.SnapToGridByY==1}function Q2(s){return s.SnapToGridByY==2}function K2(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(p.getTriangleOrientation(e.origin,s.origin,t.origin)==0)return!0;let i=s.leftAnchor,n=s.rightAnchor,o=s.x;return Ov(s),p.getTriangleOrientation(e.origin,s.origin,t.origin)==1?!0:(s.x=o,s.leftAnchor=i,s.rightAnchor=n,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function Ov(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function J2(s,e,t){let i=new mr;for(let n of s)if(!(n>=t.nodeCount))for(let o of t.outEdges[n])e[o.source]==e[o.target]&&i.addNN(o.source,o.target);return Array.from(i.values())}function eR(s,e,t,i){let n=0,o=i.GetMultiedgeI(s);for(let a of o){n+=t;let l=a.edge.label;l!=null&&(l.center=new p(l.center.x,e+n+l.height/2),n+=l.height)}return n}function tR(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function rR(s,e,t,i){let n=iR(t,s,e,i);e.rightAnchor+=n}function iR(s,e,t,i){let n=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));n+=(i.NodeSeparation+i.MinNodeWidth)*o.length}return n}function nR(s,e){if(e.isIdentity())return;let t=e.inverse();for(let i of s.shallowNodes())i.transform(t);for(let i of s.edges())if(i.label!=null){let n=W.mkPP(t.multiplyPoint(new p(0,0)),t.multiplyPoint(new p(i.label.width,i.label.height)));i.label.width=n.width,i.label.height=n.height}}function oR(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes())t.transform(e);for(let t of s.edges())if(t.label!=null){let i=W.mkPP(e.multiplyPoint(new p(0,0)),e.multiplyPoint(new p(t.label.width,t.label.height)));t.label.width=i.width,t.label.height=i.height}sR(s,e)}}function sR(s,e){for(let t of s.edges())t.label!=null&&(t.label.center=e.multiplyPoint(t.label.center)),aR(e,t)}function aR(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),lR(e,s)}}function lR(s,e){if(s.underlyingPolyline!=null)for(let t=s.underlyingPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var Sp=class extends Cs{constructor(e,t){super();this.text=e,this.parent=t}toString(){return this.text}};var bl=(_=>(_[_.normal=0]="normal",_[_.inv=1]="inv",_[_.dot=2]="dot",_[_.invdot=3]="invdot",_[_.odot=4]="odot",_[_.invodot=5]="invodot",_[_.none=6]="none",_[_.tee=7]="tee",_[_.empty=8]="empty",_[_.invempty=9]="invempty",_[_.diamond=10]="diamond",_[_.odiamond=11]="odiamond",_[_.ediamond=12]="ediamond",_[_.crow=13]="crow",_[_.box=14]="box",_[_.obox=15]="obox",_[_.open=16]="open",_[_.halfopen=17]="halfopen",_[_.vee=18]="vee",_))(bl||{});var rs=(F=>(F[F.diamond=0]="diamond",F[F.ellipse=1]="ellipse",F[F.box=2]="box",F[F.circle=3]="circle",F[F.record=4]="record",F[F.plaintext=5]="plaintext",F[F.point=6]="point",F[F.mdiamond=7]="mdiamond",F[F.msquare=8]="msquare",F[F.polygon=9]="polygon",F[F.doublecircle=10]="doublecircle",F[F.house=11]="house",F[F.invhouse=12]="invhouse",F[F.parallelogram=13]="parallelogram",F[F.octagon=14]="octagon",F[F.tripleoctagon=15]="tripleoctagon",F[F.triangle=16]="triangle",F[F.trapezium=17]="trapezium",F[F.drawfromgeometry=18]="drawfromgeometry",F[F.hexagon=19]="hexagon",F))(rs||{});var Ep=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(Ep||{});var zh=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(zh||{});var xp=(n=>(n[n.forward=0]="forward",n[n.back=1]="back",n[n.both=2]="both",n[n.none=3]="none",n))(xp||{});var vp=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(vp||{});var I=class{static parse(e){switch(e.toLowerCase()){case"aliceblue":return I.AliceBlue;case"antiquewhite":return I.AntiqueWhite;case"aqua":I.Aqua;case"aquamarine":I.Aquamarine;case"azure":return I.Azure;case"beige":return I.Beige;case"bisque":return I.Bisque;case"black":return I.Black;case"blanchedalmond":return I.BlanchedAlmond;case"blue":return I.Blue;case"blueviolet":return I.BlueViolet;case"brown":return I.Brown;case"burlywood":return I.BurlyWood;case"cadetblue":return I.CadetBlue;case"chartreuse":return I.Chartreuse;case"chocolate":return I.Chocolate;case"coral":return I.Coral;case"cornflowerblue":return I.CornflowerBlue;case"cornsilk":return I.Cornsilk;case"crimson":return I.Crimson;case"cyan":return I.Cyan;case"darkblue":return I.DarkBlue;case"darkcyan":return I.DarkCyan;case"darkgoldenrod":return I.DarkGoldenrod;case"darkgray":return I.DarkGray;case"darkgreen":return I.DarkGreen;case"darkkhaki":return I.DarkKhaki;case"darkmagenta":return I.DarkMagenta;case"darkolivegreen":return I.DarkOliveGreen;case"darkorange":return I.DarkOrange;case"darkorchid":return I.DarkOrchid;case"darkred":return I.DarkRed;case"darksalmon":return I.DarkSalmon;case"darkseagreen":return I.DarkSeaGreen;case"darkslateblue":return I.DarkSlateBlue;case"darkslategray":return I.DarkSlateGray;case"darkturquoise":return I.DarkTurquoise;case"darkviolet":return I.DarkViolet;case"deeppink":return I.DeepPink;case"deepskyblue":return I.DeepSkyBlue;case"dimgray":return I.DimGray;case"dodgerblue":return I.DodgerBlue;case"firebrick":return I.Firebrick;case"floralwhite":return I.FloralWhite;case"forestgreen":return I.ForestGreen;case"fuchsia":return I.Fuchsia;case"gainsboro":return I.Gainsboro;case"ghostwhite":return I.GhostWhite;case"gold":return I.Gold;case"goldenrod":return I.Goldenrod;case"gray":return I.Gray;case"green":return I.Green;case"greenyellow":return I.GreenYellow;case"honeydew":return I.Honeydew;case"hotpink":return I.HotPink;case"indianred":return I.IndianRed;case"indigo":return I.Indigo;case"ivory":return I.Ivory;case"khaki":return I.Khaki;case"lavender":return I.Lavender;case"lavenderblush":return I.LavenderBlush;case"lawngreen":return I.LawnGreen;case"lemonchiffon":return I.LemonChiffon;case"lightblue":return I.LightBlue;case"lightcoral":return I.LightCoral;case"lightcyan":return I.LightCyan;case"lightgoldenrodyellow":return I.LightGoldenrodYellow;case"lightgray":case"lightgrey":return I.LightGray;case"lightgreen":return I.LightGreen;case"lightpink":return I.LightPink;case"lightsalmon":return I.LightSalmon;case"lightseagreen":return I.LightSeaGreen;case"lightskyblue":return I.LightSkyBlue;case"lightslategray":return I.LightSlateGray;case"lightsteelblue":return I.LightSteelBlue;case"lightyellow":return I.LightYellow;case"lime":return I.Lime;case"limegreen":return I.LimeGreen;case"linen":return I.Linen;case"magenta":return I.Magenta;case"maroon":return I.Maroon;case"mediumaquamarine":return I.MediumAquamarine;case"mediumblue":return I.MediumBlue;case"mediumorchid":return I.MediumOrchid;case"mediumpurple":return I.MediumPurple;case"mediumseagreen":return I.MediumSeaGreen;case"mediumslateblue":return I.MediumSlateBlue;case"mediumspringgreen":return I.MediumSpringGreen;case"mediumturquoise":return I.MediumTurquoise;case"mediumvioletred":return I.MediumVioletRed;case"midnightblue":return I.MidnightBlue;case"mintcream":return I.MintCream;case"mistyrose":return I.MistyRose;case"moccasin":return I.Moccasin;case"navajowhite":return I.NavajoWhite;case"navy":return I.Navy;case"oldlace":return I.OldLace;case"olive":return I.Olive;case"olivedrab":return I.OliveDrab;case"orange":return I.Orange;case"orangered":return I.OrangeRed;case"orchid":return I.Orchid;case"palegoldenrod":return I.PaleGoldenrod;case"palegreen":return I.PaleGreen;case"paleturquoise":return I.PaleTurquoise;case"palevioletred":return I.PaleVioletRed;case"papayawhip":return I.PapayaWhip;case"peachpuff":return I.PeachPuff;case"peru":return I.Peru;case"pink":return I.Pink;case"plum":return I.Plum;case"powderblue":return I.PowderBlue;case"purple":return I.Purple;case"red":return I.Red;case"rosybrown":return I.RosyBrown;case"royalblue":return I.RoyalBlue;case"saddlebrown":return I.SaddleBrown;case"salmon":return I.Salmon;case"sandybrown":return I.SandyBrown;case"seagreen":return I.SeaGreen;case"seashell":return I.SeaShell;case"sienna":return I.Sienna;case"silver":return I.Silver;case"skyblue":return I.SkyBlue;case"slateblue":return I.SlateBlue;case"slategray":return I.SlateGray;case"snow":return I.Snow;case"springgreen":return I.SpringGreen;case"steelblue":return I.SteelBlue;case"tan":return I.Tan;case"teal":return I.Teal;case"thistle":return I.Thistle;case"tomato":return I.Tomato;case"transparent":return I.Transparent;case"turquoise":return I.Turquoise;case"violet":return I.Violet;case"wheat":return I.Wheat;case"white":return I.White;case"whitesmoke":return I.WhiteSmoke;case"yellow":return I.Yellow;case"yellowgreen":return I.YellowGreen;default:return}}constructor(e,t,i,n){this.a=e,this.r=t,this.g=i,this.b=n}static mkRGB(e,t,i){return new I(255,e,t,i)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length==1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a==t.a&&e.r==t.r&&e.b==t.b&&e.g==t.g}toString(){return'"#'+I.Xex(this.R)+I.Xex(this.G)+I.Xex(this.B)+(this.A==255?"":I.Xex(this.A))+'"'}static get AliceBlue(){return new I(255,240,248,255)}static get AntiqueWhite(){return new I(255,250,235,215)}static get Aqua(){return new I(255,0,255,255)}static get Aquamarine(){return new I(255,127,255,212)}static get Azure(){return new I(255,240,255,255)}static get Beige(){return new I(255,245,245,220)}static get Bisque(){return new I(255,255,228,196)}static get Black(){return new I(255,0,0,0)}static get BlanchedAlmond(){return new I(255,255,235,205)}static get Blue(){return new I(255,0,0,255)}static get BlueViolet(){return new I(255,138,43,226)}static get Brown(){return new I(255,165,42,42)}static get BurlyWood(){return new I(255,222,184,135)}static get CadetBlue(){return new I(255,95,158,160)}static get Chartreuse(){return new I(255,127,255,0)}static get Chocolate(){return new I(255,210,105,30)}static get Coral(){return new I(255,255,127,80)}static get CornflowerBlue(){return new I(255,100,149,237)}static get Cornsilk(){return new I(255,255,248,220)}static get Crimson(){return new I(255,220,20,60)}static get Cyan(){return new I(255,0,255,255)}static get DarkBlue(){return new I(255,0,0,139)}static get DarkCyan(){return new I(255,0,139,139)}static get DarkGoldenrod(){return new I(255,184,134,11)}static get DarkGray(){return new I(255,169,169,169)}static get DarkGreen(){return new I(255,0,100,0)}static get DarkKhaki(){return new I(255,189,183,107)}static get DarkMagenta(){return new I(255,139,0,139)}static get DarkOliveGreen(){return new I(255,85,107,47)}static get DarkOrange(){return new I(255,255,140,0)}static get DarkOrchid(){return new I(255,153,50,204)}static get DarkRed(){return new I(255,139,0,0)}static get DarkSalmon(){return new I(255,233,150,122)}static get DarkSeaGreen(){return new I(255,143,188,139)}static get DarkSlateBlue(){return new I(255,72,61,139)}static get DarkSlateGray(){return new I(255,47,79,79)}static get DarkTurquoise(){return new I(255,0,206,209)}static get DarkViolet(){return new I(255,148,0,211)}static get DeepPink(){return new I(255,255,20,147)}static get DeepSkyBlue(){return new I(255,0,191,255)}static get DimGray(){return new I(255,105,105,105)}static get DodgerBlue(){return new I(255,30,144,255)}static get Firebrick(){return new I(255,178,34,34)}static get FloralWhite(){return new I(255,255,250,240)}static get ForestGreen(){return new I(255,34,139,34)}static get Fuchsia(){return new I(255,255,0,255)}static get Gainsboro(){return new I(255,220,220,220)}static get GhostWhite(){return new I(255,248,248,255)}static get Gold(){return new I(255,255,215,0)}static get Goldenrod(){return new I(255,218,165,32)}static get Gray(){return new I(255,128,128,128)}static get Green(){return new I(255,0,128,0)}static get GreenYellow(){return new I(255,173,255,47)}static get Honeydew(){return new I(255,240,255,240)}static get HotPink(){return new I(255,255,105,180)}static get IndianRed(){return new I(255,205,92,92)}static get Indigo(){return new I(255,75,0,130)}static get Ivory(){return new I(255,255,255,240)}static get Khaki(){return new I(255,240,230,140)}static get Lavender(){return new I(255,230,230,250)}static get LavenderBlush(){return new I(255,255,240,245)}static get LawnGreen(){return new I(255,124,252,0)}static get LemonChiffon(){return new I(255,255,250,205)}static get LightBlue(){return new I(255,173,216,230)}static get LightCoral(){return new I(255,240,128,128)}static get LightCyan(){return new I(255,224,255,255)}static get LightGoldenrodYellow(){return new I(255,250,250,210)}static get LightGray(){return new I(255,211,211,211)}static get LightGreen(){return new I(255,144,238,144)}static get LightPink(){return new I(255,255,182,193)}static get LightSalmon(){return new I(255,255,160,122)}static get LightSeaGreen(){return new I(255,32,178,170)}static get LightSkyBlue(){return new I(255,135,206,250)}static get LightSlateGray(){return new I(255,119,136,153)}static get LightSteelBlue(){return new I(255,176,196,222)}static get LightYellow(){return new I(255,255,255,224)}static get Lime(){return new I(255,0,255,0)}static get LimeGreen(){return new I(255,50,205,50)}static get Linen(){return new I(255,250,240,230)}static get Magenta(){return new I(255,255,0,255)}static get Maroon(){return new I(255,128,0,0)}static get MediumAquamarine(){return new I(255,102,205,170)}static get MediumBlue(){return new I(255,0,0,205)}static get MediumOrchid(){return new I(255,186,85,211)}static get MediumPurple(){return new I(255,147,112,219)}static get MediumSeaGreen(){return new I(255,60,179,113)}static get MediumSlateBlue(){return new I(255,123,104,238)}static get MediumSpringGreen(){return new I(255,0,250,154)}static get MediumTurquoise(){return new I(255,72,209,204)}static get MediumVioletRed(){return new I(255,199,21,133)}static get MidnightBlue(){return new I(255,25,25,112)}static get MintCream(){return new I(255,245,255,250)}static get MistyRose(){return new I(255,255,228,225)}static get Moccasin(){return new I(255,255,228,181)}static get NavajoWhite(){return new I(255,255,222,173)}static get Navy(){return new I(255,0,0,128)}static get OldLace(){return new I(255,253,245,230)}static get Olive(){return new I(255,128,128,0)}static get OliveDrab(){return new I(255,107,142,35)}static get Orange(){return new I(255,255,165,0)}static get OrangeRed(){return new I(255,255,69,0)}static get Orchid(){return new I(255,218,112,214)}static get PaleGoldenrod(){return new I(255,238,232,170)}static get PaleGreen(){return new I(255,152,251,152)}static get PaleTurquoise(){return new I(255,175,238,238)}static get PaleVioletRed(){return new I(255,219,112,147)}static get PapayaWhip(){return new I(255,255,239,213)}static get PeachPuff(){return new I(255,255,218,185)}static get Peru(){return new I(255,205,133,63)}static get Pink(){return new I(255,255,192,203)}static get Plum(){return new I(255,221,160,221)}static get PowderBlue(){return new I(255,176,224,230)}static get Purple(){return new I(255,128,0,128)}static get Red(){return new I(255,255,0,0)}static get RosyBrown(){return new I(255,188,143,143)}static get RoyalBlue(){return new I(255,65,105,225)}static get SaddleBrown(){return new I(255,139,69,19)}static get Salmon(){return new I(255,250,128,114)}static get SandyBrown(){return new I(255,244,164,96)}static get SeaGreen(){return new I(255,46,139,87)}static get SeaShell(){return new I(255,255,245,238)}static get Sienna(){return new I(255,160,82,45)}static get Silver(){return new I(255,192,192,192)}static get SkyBlue(){return new I(255,135,206,235)}static get SlateBlue(){return new I(255,106,90,205)}static get SlateGray(){return new I(255,112,128,144)}static get Snow(){return new I(255,255,250,250)}static get SpringGreen(){return new I(255,0,255,127)}static get SteelBlue(){return new I(255,70,130,180)}static get Tan(){return new I(255,210,180,140)}static get Teal(){return new I(255,0,128,128)}static get Thistle(){return new I(255,216,191,216)}static get Tomato(){return new I(255,255,99,71)}static get Transparent(){return new I(0,255,255,255)}static get Turquoise(){return new I(255,64,224,208)}static get Violet(){return new I(255,238,130,238)}static get Wheat(){return new I(255,245,222,179)}static get White(){return new I(255,255,255,255)}static get WhiteSmoke(){return new I(255,245,245,245)}static get Yellow(){return new I(255,255,255,0)}static get YellowGreen(){return new I(255,154,205,50)}};var Zu=class{constructor(e){this.labelfontcolor=I.parse("Black");this.styles=[];this.penwidth=1;this.attrCont=e,this.bind(),this.fontname=Zu.defaultLabelFontName,this.fontsize=Zu.defaultLabelFontSize}get labelText(){return this._labelText}set labelText(e){this._labelText=e}bind(){this.attrCont!=null&&this.attrCont.setAttr(Zu.attachIndex,this)}static getDrawingObj(e){return e==null?null:e.getAttr(Zu.attachIndex)}},st=Zu;st.attachIndex=1,st.defaultLabelFontName="Times-Roman",st.defaultLabelFontSize=12;var Qu=class{constructor(e){this.text=e}};var Cp=class extends st{constructor(e){super(e);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;e!=null&&(this.label=new Qu(e.id))}get labelText(){return this.label?this.label.text:null}set labelText(e){this.label!=null&&(this.label.text=e)}get Padding(){return this.padding}set Padding(e){this.padding=Math.max(0,e)}get XRadius(){return this.xRad}set XRadius(e){this.xRad=e}get YRadius(){return this.yRad}set YRadius(e){this.yRad=e}static get DefaultFillColor(){return Cp.defaultFillColor}static set DefaultFillColor(e){Cp.defaultFillColor=e}get ShapeEnum(){return this.shape}set ShapeEnum(e){this.shape=e}get LabelMargin(){return this.labelMargin}set LabelMargin(e){this.labelMargin=e}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(e){this.labelWidthToHeightRatio=e}get node(){return this.attrCont}},tr=Cp;tr.defaultFillColor=I.LightGray;var Mi=class extends tr{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}static getDrawingGraph(e){return st.getDrawingObj(e)}get graph(){return this.attrCont}findNode(e){let i=this.graph.findNode(e);return i==null?null:st.getDrawingObj(i)}hasDirectedEdge(){for(let e of this.graph.edges)if(st.getDrawingObj(e).directed)return!0;return!1}createGeometry(e=t=>t?new $t(t.length*8+8,20):null){let t=new Re(this.graph);this.textMeasure=e;let i={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};t.labelSize=e(this.labelText,i);for(let n of this.graph.deepNodes)this.createNodeGeometry(n);for(let n of this.graph.deepEdges())this.createEdgeGeometry(n);return t}createEdgeGeometry(e){let t=Qi.getDrawingObj(e),i=new We(e);if(t.directed==!1&&(i.targetArrowhead=null),e.label){let n=this.textMeasure(e.label.text,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"});i.label=new sh(W.mkPP(new p(0,0),new p(n.width,n.height)),e.label),t.label.measuredTextSize=n}t.penwidth&&(i.lineWidth=t.penwidth)}curveByShape(e,t,i,n,o){let a;switch(n){case 0:a=Be.CreateDiamond(e,t,i);break;case 1:break;case 4:case 2:a=Be.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,i);break;case 3:a=Be.mkCircle(Math.sqrt(e*e+t*t),i);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=Be.mkCircle(Math.sqrt(e*e+t*t)+2*o.penwidth,i);break;case 11:a=Be.createHouse(e,t,i);break;case 12:a=Be.createInvertedHouse(e,t,i);break;case 13:break;case 14:a=Be.createOctagon(e,t,i);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=Be.createHexagon(e,t,i);break}return a!=null?a:Be.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,i)}createNodeGeometry(e){if(e instanceof Ze){let t=st.getDrawingObj(e),i=new Re(e);t.labelText&&(i.labelSize=t.measuredTextSize=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}))}else{let t=tr.getDrawingObj(e),i=new $t(1,1);t.labelText&&(i=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}));let n=i.width+t.LabelMargin*2,o=i.height+t.LabelMargin*2;t.measuredTextSize=i;let a=new p(0,0),l=new wr(e);l.boundaryCurve=this.curveByShape(n,o,a,t.shape,t)}}};var Qi=class extends st{constructor(){super(...arguments);this.directed=!0}};var zv=be(Uv());function fo(s){let e=(0,zv.default)(s);if(e.keyword!=null)return I.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new I(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return I.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return I.Black}function Sl(s,e){let t=st.getDrawingObj(e);if(s.attr_list!=null)for(let i of s.attr_list)if(i.type=="attr"){let n=i.eq;switch(i.id){case"edgeCurve":{let o=Lp(e),a=JSON.parse(n);o.curve=ff(a)}break;case"boundaryCurve":{let o=Lp(e),a=JSON.parse(n);o.boundaryCurve=ff(a)}break;case"sourceArrowhead":{let o=Lp(e);o.sourceArrowhead.tipPosition=p.fromJSON(JSON.parse(n));break}case"targetArrowhead":{let o=Lp(e);o.targetArrowhead.tipPosition=p.fromJSON(JSON.parse(n));break}case"color":t.color=fo(n);break;case"pencolor":t.pencolor=fo(n);break;case"labelfontcolor":t.labelfontcolor=fo(n);break;case"fontcolor":t.fontColor=fo(n);break;case"fillcolor":t.fillColor=fo(n);break;case"style":t.styles.push(FR(n));break;case"shape":{let o=t;o.shape=GR(n);break}case"peripheries":t.peripheries=parseInt(n);break;case"headlabel":t.headlabel=n;break;case"label":if(typeof n=="string"){let o="\\n",a=0;t.labelText="";do{let l=n.indexOf(o,a);if(l>=0)t.labelText+=n.substring(a,l)+`
`,a=l+2;else{t.labelText+=n.substring(a);break}}while(!0)}else typeof n=="number"&&(t.labelText=n.toString());break;case"size":t.size=c0(n);break;case"pos":t.pos=c0(n);break;case"rankdir":t.rankdir=VR(n);break;case"fontname":t.fontname=n;break;case"fontsize":t.fontsize=parseFloat(n);break;case"width":t.width=parseFloat(n);break;case"penwidth":t.penwidth=parseFloat(n);break;case"height":t.height=parseFloat(n);break;case"margin":t.margin=parseFloat(n);break;case"len":t.len=parseFloat(n);break;case"minlen":t.minlen=parseFloat(n);break;case"rank":t.rank=kR(n);break;case"charset":t.charset=n;break;case"orientation":t.orientation=n;break;case"ratio":t.ratio=n;break;case"weight":t.weight=parseFloat(n);break;case"nodesep":t.nodesep=parseFloat(n);break;case"layersep":t.layersep=parseFloat(n);break;case"arrowsize":t.arrowsize=parseFloat(n);break;case"rotate":t.rotate=parseFloat(n);break;case"ranksep":t.ranksep=parseFloat(n);break;case"splines":t.splines=n=="true";break;case"overlap":t.overlap=n=="true";break;case"arrowtail":t.arrowtail=Hv(n);break;case"taillabel":t.taillabel=n;break;case"arrowhead":t.arrowhead=Hv(n);break;case"ordering":t.ordering=UR(n);break;case"URL":t.URL=n;break;case"dir":t.dir=zR(n);break;case"concentrate":t.concentrate=n=="true";break;case"compound":t.compound=n=="true";break;case"lhead":t.lhead=n;break;case"ltail":t.ltail=n;break;case"bgcolor":t.bgcolor=fo(n);break;case"center":t.center=n==!0||parseInt(n)==1;break;case"colorscheme":t.colorscheme=n;break;case"sides":t.sides=parseInt(n);break;case"distortion":t.distortion=parseFloat(n);break;case"skew":t.skew=parseFloat(n);break;case"bb":t.bb=HR(n);break;case"labelloc":t.labelloc=n;break;case"decorate":t.decorate=n=="true";break;case"tailclip":t.tailclip=n=="true";break;case"headclip":t.headclip=n=="true";break;case"constraint":t.constraint=n=="true";break;case"gradientangle":t.gradientangle=parseFloat(n);break;case"samehead":t.samehead=n;break;case"href":t.href=n;break;case"imagepath":t.imagepath=n;break;case"image":t.image=n;break;case"labeljust":t.labejust=n;break;case"layers":t.layers=n.split(",");break;case"layer":t.layer=n;break;case"f":t.f=parseFloat(n);break;case"nojustify":t.nojustify=n=="true";break;case"root":t.root=n=="true";break;case"page":t.page=c0(n);break;case"pname":t.pname=n;break;case"kind":t.kind=n;break;case"fname":t.fname=n;break;case"subkind":t.subkind=n;break;case"area":t.area=parseFloat(n);break;case"tailport":t.tailport=n;break;case"headport":t.headport=n;break;case"wt":t.wt=n;break;case"id":t.id=n;break;case"edgetooltip":t.edgetooltip=n;break;case"headtooltip":t.headtooltip=n;break;case"tailtooltip":t.tailtooltip=n;break;case"headURL":t.headURL=n;break;case"tailURL":t.tailURL=n;break;case"labelURL":t.labelURL=n;break;case"edgeurl":t.edgeurl=n;break;case"shapefile":t.shapefile=n;break;case"xlabel":t.xlabel=n;break;case"sametail":t.sametail=n;break;case"clusterrank":t.clusterRank=n;break;default:break}}else throw new Error("unexpected type "+i.type)}var h0=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,i,n,o){let a=i.nodeCollection,l,u;if(e.type=="node_id"){let d=e.id.toString();a.hasNode(d)?l=a.getNode(d):l=this.newNode(d,i,!1)}else{let d=[];for(let f of e.children)if(f.type==="node_stmt")for(let P of this.parseEdge(f.node_id,t,i,n,o))d.push(P);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of e.children)if(f.type==="attr_stmt")for(let P of d)Sl(f,P);return d}if(t.type=="node_id"){let d=t.id.toString();a.hasNode(d)?u=a.getNode(d):u=this.newNode(d,i,!1)}else if(t.type=="subgraph"){let d=new Array;for(let f of t.children)if(f.type==="node_stmt")for(let P of this.parseEdge(e,f.node_id,i,n,o))d.push(P);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of t.children)if(f.type==="attr_stmt")for(let P of d)Sl(f,P);return d}let c=new Go(l,u);a.addEdge(c);let h=new Qi(c);return Sl(o,c),h.labelText&&(c.label=new Sp(h.labelText,c),h.label=new Qu(h.labelText)),h.directed=n,[c]}newNode(e,t,i){let n=this.nodeMap.get(e);if(n==null){n=new Vo(e),this.nodeMap.set(e,n),t.addNode(n);let o=new tr(n);o.labelText=e,this.defaultNodeAttr&&Sl(this.defaultNodeAttr,n)}else i&&cb(t,n);return n}parseNode(e,t,i){let n=e.node_id.id.toString(),o=this.newNode(n,t,i);return st.getDrawingObj(o)==null&&new tr(o),Sl(e,o),o}parse(){return this.ast==null?null:(this.graph=new Ze(this.ast[0].id?this.ast[0].id.toString():"__graph__"),this.drawingGraph=new Mi(this.graph),this.parseUnderGraph(this.ast[0].children,this.graph,this.ast[0].type=="digraph",!1),jR(this.graph),qR(this.graph),this.graph)}parseGraphAttr(e,t){e.target=="node"?this.defaultNodeAttr=e:e.target=="graph"&&Sl(e,t)}getEntitiesSubg(e,t,i){let n=[];for(let o of e.children)if(o.type=="edge_stmt")for(let a=0;a<o.edge_list.length-1;a++)for(let l of this.parseEdge(o.edge_list[a],o.edge_list[a+1],t,i,o))n.push(l);else if(o.type!="attr_stmt")if(o.type=="node_stmt")n.push(this.parseNode(o,t,!0));else if(o.type==="subgraph")if(o.id!=null){let a=new Ze(o.id.toString());t.addNode(a);let l=new Mi(a);this.parseUnderGraph(o.children,a,i,!0),n.push(l)}else n=n.concat(this.getEntitiesSubg(o,t,i));else throw new Error("Function not implemented.");return n}parseUnderGraph(e,t,i,n){for(let o of e)switch(o.type){case"node_stmt":this.parseNode(o,t,n);break;case"edge_stmt":{let a=o.edge_list;for(let l=0;l<a.length-1;l++)this.parseEdge(a[l],a[l+1],t,i,o)}break;case"subgraph":if(!DR(o,Mi.getDrawingGraph(t)))if(o.id==null){let a=this.getEntitiesSubg(o,t,i);WR(o,Mi.getDrawingGraph(t),a)}else{let a=new Ze(o.id.toString());new Mi(a),this.parseUnderGraph(o.children,a,i,!0),a.isEmpty()||t.addNode(a)}break;case"attr_stmt":this.parseGraphAttr(o,t);break;default:throw new Error("not implemented")}}};function Op(s){return new h0((0,Wv.default)(s)).parse()}function Rp(s){try{let e=JSON.parse(s);return new h0([e]).parse()}catch(e){return console.log(e.message),null}}function DR(s,e){let t=s.children[0];if(t==null||t.type!="attr_stmt")return!1;let i=t.attr_list;if(i==null||i.length==0)return!1;let n=i[0];if(n.type!="attr"||n.id!="rank")return!1;switch(n.eq){case"min":for(let o=1;o<s.children.length;o++){let a=s.children[o];if(a.type=="node_stmt")e.graphVisData.minRanks.push(a.node_id.id.toString());else throw new Error}return!0;case"max":for(let o=1;o<s.children.length;o++){let a=s.children[o];if(a.type=="node_stmt")e.graphVisData.minRanks.push(a.node_id.id.toString());else throw new Error}return!0;case"same":{let o=[];for(let a=1;a<s.children.length;a++){let l=s.children[a];if(l.type=="node_stmt")o.push(l.node_id.id.toString());else throw new Error}return e.graphVisData.sameRanks.push(o),!0}case"source":{for(let o=1;o<s.children.length;o++){let a=s.children[o];if(a.type=="node_stmt")e.graphVisData.sourceRanks.push(a.node_id.id.toString());else throw new Error}return!0}case"sink":for(let o=1;o<s.children.length;o++){let a=s.children[o];if(a.type=="node_stmt")e.graphVisData.sinkRanks.push(a.node_id.id.toString());else throw new Error}return!0;default:throw new Error("incorrect rank")}}function FR(s){return zh[s]}function GR(s){let e=s.toLowerCase();return rs[e]}function c0(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function VR(s){return mu[s]}function kR(s){return Ep[s]}function Hv(s){return bl[s]}function UR(s){return vp[s]}function zR(s){return xp[s]}function HR(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function WR(s,e,t){for(let i of s.children)if(i.type=="attr_stmt")for(let n of t)Sl(i,n)}function jR(s){let e=[];for(let t of s.subgraphs())t.isEmpty()&&e.push(t);for(let t of e){let i=t.parent;i&&i.removeNode(t)}}function qR(s){for(let e of s.subgraphs())Re.getGeom(e)==null&&e.hasSomeAttrOnIndex(Ue.attachIndex)&&new Re(e);Re.getGeom(s)==null&&s.hasSomeAttrOnIndex(Re.attachIndex)&&new Re(s)}function Lp(s){var e;return(e=Ue.getGeom(s))!=null?e:XR(s)}function XR(s){if(s instanceof Ze)return new Re(s);if(s instanceof Vo)return new wr(s);if(s instanceof Go)return new We(s);throw new Error("unsupported type "+s)}function d0(s){let e=new Ze;for(let t of s.nodes){let i=String(t.id),n=e.addNode(new Vo(i)),o=new tr(n),{label:a=i,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=rs[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=fo(t.color))}for(let t of s.edges){let i=e.setEdge(String(t.source),String(t.target)),n=new Qi(i),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;n.arrowhead=bl[o],n.arrowtail=bl[a],n.directed=l,"weight"in t&&(n.weight=t.weight),"color"in t&&(n.color=fo(t.color))}return e}async function f0(s){var n;let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),i;if(e.endsWith(".json")){let o=await t.json();i=(n=Rp(o))!=null?n:d0(o)}else{let o=await t.text();i=Op(o)}return i.id=e,i}async function jv(s){let e=await s.text(),t;return s.name.endsWith(".json")?t=Rp(JSON.parse(e)):t=Op(e),t.id=s.name,t}function qv(s,e){let t=document.getElementById(s);t.ondragover=i=>{i.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=i=>{i.preventDefault(),t.classList.remove("active");let n=i.dataTransfer.items[0];n.kind==="file"&&e(n.getAsFile())},t.onclick=()=>{let i=document.createElement("input");i.type="file",i.onchange=()=>i.files.length&&e(i.files[0]),i.click()}}function Zs(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var po={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},$R=po.self||po.window||po.global||{},ZR=po.window||po.self||po.global||{},QR=po.global||po.self||po.window||{},KR=po.document||{};var El=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var Xv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),JR=Xv&&parseFloat(Xv[1])||0;var Yv="3.2.3";function kr(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var go={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},_le=go.self||go.window||go.global||{},Ble=go.window||go.self||go.global||{},Nle=go.global||go.self||go.window||{},Dle=go.document||{};var Ju=typeof process!="object"||String(process)!=="[object process]"||process.browser;var Zv=typeof window<"u"&&typeof window.orientation<"u",$v=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),Fle=$v&&parseFloat($v[1])||0;function y(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var Mp=class{constructor(e,t){y(this,"name",void 0),y(this,"workerThread",void 0),y(this,"isRunning",!0),y(this,"result",void 0),y(this,"_resolve",()=>{}),y(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,n)=>{this._resolve=i,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){kr(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){kr(this.isRunning),this.isRunning=!1,this._reject(e)}};var Zh=class{};var p0=new Map;function Qv(s){kr(s.source&&!s.url||!s.source&&s.url);let e=p0.get(s.source||s.url);return e||(s.url&&(e=eM(s.url),p0.set(s.url,e)),s.source&&(e=Kv(s.source),p0.set(s.source,e))),kr(e),e}function eM(s){if(!s.startsWith("http"))return s;let e=tM(s);return Kv(e)}function Kv(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function tM(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function g0(s,e=!0,t){let i=t||new Set;if(s){if(Jv(s))i.add(s);else if(Jv(s.buffer))i.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let n in s)g0(s[n],e,i)}}return t===void 0?Array.from(i):[]}function Jv(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var m0=()=>{},xl=class{static isSupported(){return typeof Worker<"u"&&Ju||typeof Zh!==void 0}constructor(e){y(this,"name",void 0),y(this,"source",void 0),y(this,"url",void 0),y(this,"terminated",!1),y(this,"worker",void 0),y(this,"onMessage",void 0),y(this,"onError",void 0),y(this,"_loadableURL","");let{name:t,source:i,url:n}=e;kr(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=m0,this.onError=o=>console.log(o),this.worker=Ju?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=m0,this.onError=m0,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||g0(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=Qv({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){let i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new Zh(i,{eval:!1})}else if(this.source)e=new Zh(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}};var _p=class{static isSupported(){return xl.isSupported()}constructor(e){y(this,"name","unnamed"),y(this,"source",void 0),y(this,"url",void 0),y(this,"maxConcurrency",1),y(this,"maxMobileConcurrency",1),y(this,"onDebug",()=>{}),y(this,"reuseWorkers",!0),y(this,"props",{}),y(this,"jobQueue",[]),y(this,"idleQueue",[]),y(this,"count",0),y(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,o,a)=>n.done(a),i=(n,o)=>n.error(o)){let n=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new Mp(t.name,e);e.onMessage=n=>t.onMessage(i,n.type,n.payload),e.onError=n=>t.onError(i,n),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new xl({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Zv?this.maxMobileConcurrency:this.maxConcurrency}};var rM={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},_i=class{static isSupported(){return xl.isSupported()}static getWorkerFarm(e={}){return _i._workerFarm=_i._workerFarm||new _i({}),_i._workerFarm.setProps(e),_i._workerFarm}constructor(e){y(this,"props",void 0),y(this,"workerPools",new Map),this.props={...rM},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:n}=e,o=this.workerPools.get(t);return o||(o=new _p({name:t,source:i,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};y(_i,"_workerFarm",void 0);var iM="latest";function b0(s,e={}){let t=e[s.id]||{},i="".concat(s.id,"-worker.js"),n=t.workerUrl;if(!n&&s.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(n="modules/".concat(s.module,"/dist/").concat(i)),!n){let o=s.version;o==="latest"&&(o=iM);let a=o?"@".concat(o):"";n="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(i)}return kr(n),n}function P0(s,e=Yv){kr(s,"no worker provided");let t=s.version;return!(!e||!t)}function y0(s,e){return!_i.isSupported()||!Ju&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&e?.worker}async function S0(s,e,t,i,n){let o=s.id,a=b0(s,t),u=_i.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));let c=await u.startJob("process-on-worker",nM.bind(null,n));return c.postMessage("process",{input:e,options:t,context:i}),await(await c.result).result}async function nM(s,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":let{id:n,input:o,options:a}=i;try{let l=await s(o,a);e.postMessage("done",{id:n,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:n,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function E0(s){return s&&typeof s=="object"&&s.isBuffer}function eC(s){return E0(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function Bp(s){if(E0(s))return eC(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function x0(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let i=new Uint8Array(s),n=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==n[o])return!1;return!0}function v0(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),i=new Uint8Array(t),n=0;for(let o of e)i.set(o,n),n+=o.byteLength;return i.buffer}async function C0(s){let e=[];for await(let t of s)e.push(t);return v0(...e)}function Qh(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var vl=class{constructor(e,t){y(this,"name",void 0),y(this,"type",void 0),y(this,"sampleSize",1),y(this,"time",void 0),y(this,"count",void 0),y(this,"samples",void 0),y(this,"lastTiming",void 0),y(this,"lastSampleTime",void 0),y(this,"lastSampleCount",void 0),y(this,"_count",0),y(this,"_time",0),y(this,"_samples",0),y(this,"_startTime",0),y(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Qh(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Qh()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var mo=class{constructor(e){y(this,"id",void 0),y(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:i}=e;return this.stats[t]||(e instanceof vl?this.stats[t]=e:this.stats[t]=new vl(t,i)),this.stats[t]}};var oM="",tC={};function A0(s){for(let e in tC)if(s.startsWith(e)){let t=tC[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(oM).concat(s)),s}var Np={};zL(Np,{dirname:()=>aM,filename:()=>sM,join:()=>lM});function sM(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function aM(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function lM(...s){let e="/";return s=s.map((t,i)=>(i&&(t=t.replace(new RegExp("^".concat(e)),"")),i!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var uM=s=>typeof s=="boolean",Kh=s=>typeof s=="function",ec=s=>s!==null&&typeof s=="object",T0=s=>ec(s)&&s.constructor==={}.constructor;var rC=s=>s&&typeof s[Symbol.iterator]=="function",iC=s=>s&&typeof s[Symbol.asyncIterator]=="function";var In=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var wn=s=>typeof Blob<"u"&&s instanceof Blob,nC=s=>s&&typeof s=="object"&&s.isBuffer;var cM=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||ec(s)&&Kh(s.tee)&&Kh(s.cancel)&&Kh(s.getReader);var hM=s=>ec(s)&&Kh(s.read)&&Kh(s.pipe)&&uM(s.readable),Dp=s=>cM(s)||hM(s);var dM=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,fM=/^([-\w.]+\/[-\w.+]+)/;function oC(s){let e=fM.exec(s);return e?e[1]:s}function I0(s){let e=dM.exec(s);return e?e[1]:""}var pM=/\?.*/;function Cl(s){if(In(s)){let e=w0(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:oC(t)||I0(e)}}return wn(s)?{url:w0(s.name||""),type:s.type||""}:typeof s=="string"?{url:w0(s),type:I0(s)}:{url:"",type:""}}function sC(s){return In(s)?s.headers["content-length"]||-1:wn(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function w0(s){return s.replace(pM,"")}async function Fp(s){if(In(s))return s;let e={},t=sC(s);t>=0&&(e["content-length"]=String(t));let{url:i,type:n}=Cl(s);n&&(e["content-type"]=n);let o=await mM(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:i}),a}async function aC(s){if(!s.ok){let e=await gM(s);throw new Error(e)}}async function gM(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),i=s.statusText;t.includes("application/json")&&(i+=" ".concat(await s.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function mM(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(i=>{let n=new FileReader;n.onload=o=>{var a;return i(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},n.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),i=bM(t);return"data:base64,".concat(i)}return null}function bM(s){let e="",t=new Uint8Array(s);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function L0(s,e){if(typeof s=="string"){s=A0(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await Fp(s)}function Jh(s){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;let e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}function rr(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Jh()}var Qs={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process};var PM=Qs.self||Qs.window||Qs.global,tc=Qs.window||Qs.self||Qs.global,yM=Qs.document||{},Al=Qs.process||{};var Gp=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",mce=rr();var O0=globalThis;function Tl(s){if(!s&&!rr())return"Node";if(Jh(s))return"Electron";let t=s||(typeof navigator<"u"?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";let i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n?"IE":O0.chrome?"Chrome":O0.safari?"Safari":O0.mozInnerScreenX?"Firefox":"Unknown"}function EM(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var Vp=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";y(this,"storage",void 0),y(this,"id",void 0),y(this,"config",{}),this.storage=EM(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function lC(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function uC(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function kp(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,n=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>i&&(t=Math.min(t,i/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(n,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var Up;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Up||(Up={}));function cC(s){return typeof s=="string"?Up[s.toUpperCase()]||Up.WHITE:s}function hC(s,e,t){return!rr&&typeof s=="string"&&(e&&(e=cC(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=cC(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function dC(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),i=Object.getOwnPropertyNames(t);for(let n of i)typeof s[n]=="function"&&(e.find(o=>n===o)||(s[n]=s[n].bind(s)))}function rc(s,e){if(!s)throw new Error(e||"Assertion failed")}function Il(){let s;if(rr&&"performance"in tc){var e,t;s=tc===null||tc===void 0||(e=tc.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in Al){var i;let n=Al===null||Al===void 0||(i=Al.hrtime)===null||i===void 0?void 0:i.call(Al);s=n[0]*1e3+n[1]/1e6}else s=Date.now();return s}var ic={debug:rr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},xM={enabled:!0,level:0};function Ki(){}var fC={},pC={once:!0},ii=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};y(this,"id",void 0),y(this,"VERSION",Gp),y(this,"_startTs",Il()),y(this,"_deltaTs",Il()),y(this,"_storage",void 0),y(this,"userData",{}),y(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new Vp("__probe-".concat(this.id,"__"),xM),this.userData={},this.timeStamp("".concat(this.id," started")),dC(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Il()-this._startTs).toPrecision(10))}getDelta(){return Number((Il()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){rc(e,t)}warn(e){return this._getLogFunction(0,e,ic.warn,arguments,pC)}error(e){return this._getLogFunction(0,e,ic.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,ic.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,ic.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),o=2;o<i;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,ic.debug||ic.info,arguments,pC)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Ki,i&&[i],{tag:TM(t)}):Ki}image(e){let{logLevel:t,priority:i,image:n,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?rr?AM({image:n,message:o,scale:a}):CM({image:n,message:o,scale:a}):Ki}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Ki)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},n=gC({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Ki)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=mC(e)}_getLogFunction(e,t,i,n,o){if(this._shouldLog(e)){o=gC({logLevel:e,message:t,args:n,opts:o}),i=i||o.method,rc(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Il();let a=o.tag||o.message;if(o.once)if(!fC[a])fC[a]=Il();else return Ki;return t=vM(this.id,o.message,o),i.bind(console,t,...o.args)}return Ki}};y(ii,"VERSION",Gp);function mC(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return rc(Number.isFinite(e)&&e>=0),e}function gC(s){let{logLevel:e,message:t}=s;s.logLevel=mC(e);let i=s.args?Array.from(s.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let n=typeof s.message;return rc(n==="string"||n==="object"),Object.assign(s,{args:i},s.opts)}function vM(s,e,t){if(typeof e=="string"){let i=t.time?uC(lC(t.total)):"";e=t.time?"".concat(s,": ").concat(i,"  ").concat(e):"".concat(s,": ").concat(e),e=hC(e,t.color,t.background)}return e}function CM(s){let{image:e,message:t="",scale:i=1}=s,n=null;try{n=module.require("asciify-image")}catch{}return n?()=>n(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):Ki}function AM(s){let{image:e,message:t="",scale:i=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=kp(o,t,i);console.log(...a)},o.src=e,Ki}let n=e.nodeName||"";if(n.toLowerCase()==="img")return console.log(...kp(e,t,i)),Ki;if(n.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...kp(o,t,i)),o.src=e.toDataURL(),Ki}return Ki}function TM(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var Yce=new ii({id:"@probe.gl/log"});var R0=new ii({id:"loaders.gl"}),M0=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},_0=class{constructor(){y(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var B0={fetch:null,mimeType:void 0,nothrow:!1,log:new _0,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:El,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},bC={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function N0(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var SC=()=>{let s=N0();return s.globalOptions=s.globalOptions||{...B0},s.globalOptions};function EC(s,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],IM(s,t),LM(e,s,i)}function zp(s,e){let t=SC(),i=s||t;return typeof i.fetch=="function"?i.fetch:ec(i.fetch)?n=>L0(n,i):e!=null&&e.fetch?e?.fetch:L0}function IM(s,e){PC(s,null,B0,bC,e);for(let t of e){let i=s&&s[t.id]||{},n=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};PC(i,t.id,n,o,e)}}function PC(s,e,t,i,n){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&ec(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in i)R0.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(i[l],"'"))();else if(!u){let d=wM(l,n);R0.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function wM(s,e){let t=s.toLowerCase(),i="";for(let n of e)for(let o in n.options){if(s===o)return"Did you mean '".concat(n.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(i=i||"Did you mean '".concat(n.id,".").concat(o,"'?"))}return i}function LM(s,e,t){let n={...s.options||{}};return OM(n,t),n.log===null&&(n.log=new M0),yC(n,SC()),yC(n,e),n}function yC(s,e){for(let t in e)if(t in e){let i=e[t];T0(i)&&T0(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function OM(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function ed(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function td(s){var e,t;Zs(s,"null loader"),Zs(ed(s),"invalid loader");let i;return Array.isArray(s)&&(i=s[1],s=s[0],s={...s,options:{...s.options,...i}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var xC=()=>{let s=N0();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function D0(s){let e=xC();s=Array.isArray(s)?s:[s];for(let t of s){let i=td(t);e.find(n=>i===n)||e.unshift(i)}}function vC(){return xC()}var CC=new ii({id:"loaders.gl"});var RM=/\.([^.]+)$/;async function IC(s,e=[],t,i){if(!wC(s))return null;let n=AC(s,e,{...t,nothrow:!0},i);if(n)return n;if(wn(s)&&(s=await s.slice(0,10).arrayBuffer(),n=AC(s,e,t,i)),!n&&!(t!=null&&t.nothrow))throw new Error(LC(s));return n}function AC(s,e=[],t,i){if(!wC(s))return null;if(e&&!Array.isArray(e))return td(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...vC()),_M(n);let o=MM(s,n,t,i);if(!o&&!(t!=null&&t.nothrow))throw new Error(LC(s));return o}function MM(s,e,t,i){let{url:n,type:o}=Cl(s),a=n||i?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=F0(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||BM(e,a),u=u||(l?"matched url ".concat(a):""),l=l||F0(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||DM(e,s),u=u||(l?"matched initial data ".concat(OC(s)):""),l=l||F0(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;CC.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function wC(s){return!(s instanceof Response&&s.status===204)}function LC(s){let{url:e,type:t}=Cl(s),i="No valid loader found (";i+=e?"".concat(Np.filename(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let n=s?OC(s):"";return i+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",i+=")",i}function _M(s){for(let e of s)td(e)}function BM(s,e){let t=e&&RM.exec(e),i=t&&t[1];return i?NM(s,i):null}function NM(s,e){e=e.toLowerCase();for(let t of s)for(let i of t.extensions)if(i.toLowerCase()===e)return t;return null}function F0(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function DM(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(FM(e,t))return t}else if(ArrayBuffer.isView(e)){if(TC(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&TC(e,0,t))return t;return null}function FM(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>s.startsWith(i))}function TC(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>GM(s,e,t,n))}function GM(s,e,t,i){if(i instanceof ArrayBuffer)return x0(i,s,i.byteLength);switch(typeof i){case"function":return i(s,t);case"string":let n=G0(s,e,i.length);return i===n;default:return!1}}function OC(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?G0(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?G0(s,0,e):""}function G0(s,e,t){if(s.byteLength<e+t)return"";let i=new DataView(s),n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i.getUint8(e+o));return n}function*RC(s,e){let t=e?.chunkSize||262144,i=0,n=new TextEncoder;for(;i<s.length;){let o=Math.min(s.length-i,t),a=s.slice(i,i+o);i+=o,yield n.encode(a)}}function*MC(s,e={}){let{chunkSize:t=262144}=e,i=0;for(;i<s.byteLength;){let n=Math.min(s.byteLength-i,t),o=new ArrayBuffer(n),a=new Uint8Array(s,i,n);new Uint8Array(o).set(a),i+=n,yield o}}async function*_C(s,e){let t=e?.chunkSize||1048576,i=0;for(;i<s.size;){let n=i+t,o=await s.slice(i,n).arrayBuffer();i=n,yield o}}function V0(s,e){return El?VM(s,e):kM(s,e)}async function*VM(s,e){let t=s.getReader(),i;try{for(;;){let n=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());let{done:o,value:a}=await n;if(o)return;yield Bp(a)}}catch{t.releaseLock()}}async function*kM(s,e){for await(let t of s)yield Bp(t)}function BC(s,e){if(typeof s=="string")return RC(s,e);if(s instanceof ArrayBuffer)return MC(s,e);if(wn(s))return _C(s,e);if(Dp(s))return V0(s,e);if(In(s))return V0(s.body,e);throw new Error("makeIterator")}var NC="Cannot convert supplied data type";function UM(s,e,t){if(e.text&&typeof s=="string")return s;if(nC(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let i=s.buffer,n=s.byteLength||s.length;return(s.byteOffset!==0||n!==i.byteLength)&&(i=i.slice(s.byteOffset,s.byteOffset+n)),i}throw new Error(NC)}async function DC(s,e,t){let i=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||i)return UM(s,e,t);if(wn(s)&&(s=await Fp(s)),In(s)){let n=s;return await aC(n),e.binary?await n.arrayBuffer():await n.text()}if(Dp(s)&&(s=BC(s,t)),rC(s)||iC(s))return C0(s);throw new Error(NC)}function FC(s,e,t=null){if(t)return t;let i={fetch:zp(e,s),...s};return Array.isArray(i.loaders)||(i.loaders=null),i}function GC(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function Hp(s,e,t,i){kr(!i||typeof i=="object"),e&&!Array.isArray(e)&&!ed(e)&&(i=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:n}=Cl(s),a=GC(e,i),l=await IC(s,a,t);return l?(t=EC(t,l,a,n),i=FC({url:n,parse:Hp,loaders:a},t,i),await zM(l,s,t,i)):null}async function zM(s,e,t,i){if(P0(s),In(e)){let n=e,{ok:o,redirected:a,status:l,statusText:u,type:c,url:h}=n,d=Object.fromEntries(n.headers.entries());i.response={headers:d,ok:o,redirected:a,status:l,statusText:u,type:c,url:h}}if(e=await DC(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,i,s);if(y0(s,t))return await S0(s,e,t,i,Hp);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,i,s);if(s.parse)return await s.parse(e,t,i,s);throw kr(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function bo(s,e,t,i){!Array.isArray(e)&&!ed(e)&&(i=void 0,t=e,e=void 0);let n=zp(t),o=s;return typeof s=="string"&&(o=await n(s)),wn(s)&&(o=await n(s)),await Hp(o,e,t)}var VC="3.2.3";var{_parseImageNode:HM}=globalThis,k0=typeof Image<"u",U0=typeof ImageBitmap<"u",WM=Boolean(HM),z0=El?!0:WM;function kC(s){switch(s){case"auto":return U0||k0||z0;case"imagebitmap":return U0;case"image":return k0;case"data":return z0;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function UC(){if(U0)return"imagebitmap";if(k0)return"image";if(z0)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function jM(s){let e=qM(s);if(!e)throw new Error("Not an image");return e}function zC(s){switch(jM(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function qM(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var XM=/^data:image\/svg\+xml/,YM=/\.svg((\?|#).*)?$/;function Wp(s){return s&&(XM.test(s)||YM.test(s))}function HC(s,e){if(Wp(e)){let i=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return H0(s,e)}function H0(s,e){if(Wp(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function rd(s,e,t){let i=HC(s,t),n=self.URL||self.webkitURL,o=typeof i!="string"&&n.createObjectURL(i);try{return await $M(o||i,e)}finally{o&&n.revokeObjectURL(o)}}async function $M(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,n)=>{try{t.onload=()=>i(t),t.onerror=o=>n(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){n(o)}})}var ZM={},WC=!0;async function W0(s,e,t){let i;Wp(t)?i=await rd(s,e,t):i=H0(s,t);let n=e&&e.imagebitmap;return await QM(i,n)}async function QM(s,e=null){if((KM(e)||!WC)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),WC=!1}return await createImageBitmap(s)}function KM(s){for(let e in s||ZM)return!1;return!0}function jp(s){let e=id(s);return JM(e)||r_(e)||e_(e)||t_(e)}function JM(s){let e=id(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function e_(s){let e=id(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function t_(s){let e=id(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function r_(s){let e=id(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:i,sofMarkers:n}=i_(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(n.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!i.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function i_(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function id(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function j0(s,e){let{mimeType:t}=jp(s)||{},i=globalThis._parseImageNode;return Zs(i),await i(s,t)}async function q0(s,e,t){e=e||{};let n=(e.image||{}).type||"auto",{url:o}=t||{},a=n_(n),l;switch(a){case"imagebitmap":l=await W0(s,e,o);break;case"image":l=await rd(s,e,o);break;case"data":l=await j0(s,e);break;default:Zs(!1)}return n==="data"&&(l=zC(l)),l}function n_(s){switch(s){case"auto":case"data":return UC();default:return kC(s),s}}var o_=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],s_=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],a_={image:{type:"auto",decode:!0}},wl={id:"image",module:"images",name:"Images",version:VC,mimeTypes:s_,extensions:o_,parse:q0,tests:[s=>Boolean(jp(new DataView(s)))],options:a_};var he=new ii({id:"deck"});var X0={};function jC(s){X0=s}function Ot(s,e,t,i){he.level>0&&X0[s]&&X0[s].call(null,e,t,i)}function l_(s){let e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}var qC={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:l_,parseTextSync:JSON.parse};var nd="8.8.0-beta.2",qp=globalThis.deck&&globalThis.deck.VERSION;if(qp&&qp!==nd)throw new Error("deck.gl - multiple versions detected: ".concat(qp," vs ").concat(nd));qp||(he.log(1,"deck.gl ".concat(nd))(),globalThis.deck={...globalThis.deck,VERSION:nd,version:nd,log:he,_registerLoggers:jC},D0([qC,[wl,{imagebitmap:{premultiplyAlpha:"none"}}]]));var XC=globalThis.deck;var ee=new ii({id:"luma.gl"});function Vt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var u_="Invalid WebGLRenderingContext";var c_="Requires WebGL2";function is(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function ce(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function Y0(s){return ce(s)?s:null}function ns(s){return Vt(is(s),u_),s}function ft(s){return Vt(ce(s),c_),s}var od={};function h_(s){globalThis.console&&globalThis.console.error&&globalThis.console.error(s)}function d_(s){globalThis.console&&globalThis.console.log&&globalThis.console.log(s)}function f_(s,e){od[s]=!0,e!==void 0&&h_(e)}function p_(s){let e=s.getError;s.getError=function(){let i;do i=e.apply(s),i!==0&&(od[i]=!0);while(i!==0);for(i in od)if(od[i])return delete od[i],parseInt(i,10);return 0}}var sd=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){let n=new s.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};sd.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};sd.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var Ll=function(e){let t=this;this.gl=e,p_(e);let i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let f=d.attribs[o];return f.buffer=t.currentArrayBuffer,f.size=a,f.type=l,f.normalized=u,f.stride=c,f.offset=h,f.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{d_("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};Ll.prototype.VERTEX_ARRAY_BINDING_OES=34229;Ll.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new sd(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};Ll.prototype.createVertexArrayOES=function(){let e=new sd(this);return this.vertexArrayObjects.push(e),e};Ll.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};Ll.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof sd&&e.hasBeenBound&&e.ext===this)};Ll.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){f_(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(n===o)return;(!n||o.elementArrayBuffer!==n.elementArrayBuffer)&&i.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(n?n.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=n?n.attribs[u]:null;if((!n||c.enabled!==h.enabled)&&(c.enabled?i.enableVertexAttribArray.call(t,u):i.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!n||c.buffer!==h.buffer)&&(a!==c.buffer&&(i.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&i.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};function YC(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let n=e.call(this)||[];return n.indexOf("OES_vertex_array_object")<0&&n.push("OES_vertex_array_object"),n};let t=s.getExtension;s.getExtension=function(n){let o=t.call(this,n);return o||(n!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new Ll(this)),this.__OESVertexArrayObject))}}var $C="OES_element_index",ZC="WEBGL_draw_buffers",g_="EXT_disjoint_timer_query",m_="EXT_disjoint_timer_query_webgl2",b_="EXT_texture_filter_anisotropic",QC="WEBGL_debug_renderer_info",P_=35723,y_=4352,S_=36795,E_=34047,x_=37445,v_=37446,pt=s=>ce(s)?void 0:0,C_={[3074]:s=>ce(s)?void 0:36064,[P_]:s=>ce(s)?void 0:y_,[35977]:pt,[32937]:pt,[S_]:(s,e)=>{let t=ce(s)?s.getExtension(m_):s.getExtension(g_);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[x_]:(s,e)=>{let t=s.getExtension(QC);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[v_]:(s,e)=>{let t=s.getExtension(QC);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[E_]:(s,e)=>{let t=s.luma.extensions[b_];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:pt,[35071]:pt,[37447]:pt,[36063]:(s,e)=>{if(!ce(s)){let t=s.getExtension(ZC);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:pt,[35374]:pt,[35377]:pt,[34852]:s=>{if(!ce(s)){let e=s.getExtension(ZC);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension($C)?2147483647:65535,[33001]:s=>s.getExtension($C)?16777216:65535,[33e3]:s=>16777216,[37157]:pt,[35373]:pt,[35657]:pt,[36183]:pt,[37137]:pt,[34045]:pt,[35978]:pt,[35979]:pt,[35968]:pt,[35376]:pt,[35375]:pt,[35659]:pt,[37154]:pt,[35371]:pt,[35658]:pt,[35076]:pt,[35077]:pt,[35380]:pt};function KC(s,e,t){let i=C_[t],n=typeof i=="function"?i(s,e,t):i;return n!==void 0?n:e(t)}var A_="OES_vertex_array_object",JC="ANGLE_instanced_arrays",T_="WEBGL_draw_buffers",I_="EXT_disjoint_timer_query",w_="EXT_texture_filter_anisotropic",L_="VertexArray requires WebGL2 or OES_vertex_array_object extension";function O_(s,e){return{webgl2:ce(s),ext:s.getExtension(e)}}var $0={[A_]:{meta:{suffix:"OES"},createVertexArray:()=>{Vt(!1,L_)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[JC]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){Vt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[T_]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Vt(!1)}},[I_]:{meta:{suffix:"EXT"},createQuery:()=>{Vt(!1)},deleteQuery:()=>{Vt(!1)},beginQuery:()=>{Vt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},Xp={readBuffer:(s,e,t)=>{ce(s)&&e(t)},getVertexAttrib:(s,e,t,i)=>{let{webgl2:n,ext:o}=O_(s,JC),a;switch(i){case 35069:a=n?void 0:!1;break;case 35070:a=!n&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,i)},getProgramParameter:(s,e,t,i)=>{if(!ce(s))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,i)},getInternalformatParameter:(s,e,t,i,n)=>{if(!ce(s))switch(n){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,i,n)},getTexParameter(s,e,t,i){switch(i){case 34046:let{extensions:n}=s.luma,o=n[w_];i=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,i)},getParameter:KC,hint(s,e,t,i){return e(t,i)}};function e1(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(YC(s),R_(s),__(s,$0),M_(s,{target:e,target2:s}),e.polyfilled=!0),s}globalThis.polyfillContext=e1;function R_(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function M_(s,{target:e,target2:t}){Object.keys(Xp).forEach(i=>{if(typeof Xp[i]=="function"){let n=s[i]?s[i].bind(s):()=>{},o=Xp[i].bind(null,s,n);e[i]=o,t[i]=o}})}function __(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&B_(s,{extension:t,target:s.luma,target2:s})}function B_(s,{extension:e,target:t,target2:i}){let n=$0[e];Vt(n);let{meta:o={}}=n,{suffix:a=""}=o,l=s.getExtension(e);for(let u of Object.keys(n)){let c=`${u}${a}`,h=null;u==="meta"||typeof s[u]=="function"||(l&&typeof l[c]=="function"?h=(...d)=>l[c](...d):typeof n[u]=="function"&&(h=n[u].bind(t))),h&&(t[u]=h,i[u]=h)}}var ld={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Ks=(s,e,t)=>e?s.enable(t):s.disable(t),t1=(s,e,t)=>s.hint(t,e),Bi=(s,e,t)=>s.pixelStorei(t,e),N_=(s,e)=>{let t=ce(s)?36009:36160;return s.bindFramebuffer(t,e)},D_=(s,e)=>s.bindFramebuffer(36008,e);function ad(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var r1={[3042]:Ks,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Ks,[2885]:(s,e)=>s.cullFace(e),[2929]:Ks,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Ks,[35723]:t1,[36006]:N_,[2886]:(s,e)=>s.frontFace(e),[33170]:t1,[2849]:(s,e)=>s.lineWidth(e),[32823]:Ks,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Ks,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Ks,[3088]:(s,e)=>s.scissor(...e),[2960]:Ks,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:Bi,[3317]:Bi,[37440]:Bi,[37441]:Bi,[37443]:Bi,[3330]:Bi,[3332]:Bi,[3331]:Bi,[36010]:D_,[3314]:Bi,[32878]:Bi,[3316]:Bi,[3315]:Bi,[32877]:Bi,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=ad(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=ad(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=ad(e)?e:[e,e];let[t,i]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,i)},stencilFunc:(s,e)=>{e=ad(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilFuncSeparate(1028,t,i,n),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=ad(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilOpSeparate(1028,t,i,n),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function Rt(s,e,t){return e[s]!==void 0?e[s]:t[s]}var i1={blendEquation:(s,e,t)=>s.blendEquationSeparate(Rt(32777,e,t),Rt(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(Rt(32969,e,t),Rt(32968,e,t),Rt(32971,e,t),Rt(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(Rt(32824,e,t),Rt(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(Rt(32938,e,t),Rt(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,Rt(2962,e,t),Rt(2967,e,t),Rt(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,Rt(34816,e,t),Rt(36003,e,t),Rt(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,Rt(2964,e,t),Rt(2965,e,t),Rt(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,Rt(34817,e,t),Rt(34818,e,t),Rt(34819,e,t))},Z0={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,i,n)=>s({[32773]:new Float32Array([e,t,i,n])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,i,n)=>s({[32969]:e,[32968]:t,[32971]:i,[32970]:n}),clearColor:(s,e,t,i,n)=>s({[3106]:new Float32Array([e,t,i,n])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,i,n)=>s({[3107]:[e,t,i,n]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,i,n)=>s({[3088]:new Int32Array([e,t,i,n])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,i)=>s({[2962]:e,[2967]:t,[2963]:i,[34816]:e,[36003]:t,[36004]:i}),stencilFuncSeparate:(s,e,t,i,n)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:n}),stencilOp:(s,e,t,i)=>s({[2964]:e,[2965]:t,[2966]:i,[34817]:e,[34818]:t,[34819]:i}),stencilOpSeparate:(s,e,t,i,n)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:n}),viewport:(s,e,t,i,n)=>s({[2978]:[e,t,i,n]})},Po=(s,e)=>s.isEnabled(e),Q0={[3042]:Po,[2884]:Po,[2929]:Po,[3024]:Po,[32823]:Po,[32926]:Po,[32928]:Po,[3089]:Po,[2960]:Po,[35977]:Po};function K0(s){for(let e in s)return!1;return!0}function n1(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&s.length===e.length){for(let n=0;n<s.length;++n)if(s[n]!==e[n])return!1;return!0}return!1}function o1(s,e){let t=s[e].bind(s);s[e]=function(...n){let o=n[0];return o in s.state.cache?s.state.enable?s.state.cache[o]:t(...n):t(...n)},Object.defineProperty(s[e],"name",{value:`${e}-from-cache`,configurable:!1})}function F_(s,e,t){let i=s[e].bind(s);s[e]=function(...o){let{valueChanged:a,oldValue:l}=t(s.state._updateCache,...o);return a&&i(...o),l},Object.defineProperty(s[e],"name",{value:`${e}-to-cache`,configurable:!1})}function G_(s){let e=s.useProgram.bind(s);s.useProgram=function(i){s.state.program!==i&&(e(i),s.state.program=i)}}var s1=class{constructor(e,{copyState:t=!1,log:i=()=>{}}={}){this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?Zp(e):Object.assign({},ld),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){Vt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];ni(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,i,n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){Vt(o!==void 0);let a=e[o],l=this.cache[o];n1(a,l)||(t=!0,i=l,n&&!(o in n)&&(n[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:i}}};function Yp(s,e={}){let{enable:t=!0,copyState:i}=e;if(Vt(i!==void 0),!s.state){let{polyfillContext:n}=globalThis;n&&n(s),s.state=new s1(s,{copyState:i}),G_(s);for(let o in Z0){let a=Z0[o];F_(s,o,a)}o1(s,"getParameter"),o1(s,"isEnabled")}return s.state.enable=t,s}function J0(s){s.state||Yp(s,{copyState:!1}),s.state.push()}function $p(s){Vt(s.state),s.state.pop()}function ni(s,e){if(Vt(is(s),"setParameters requires a WebGL context"),K0(e))return;let t={};for(let n in e){let o=Number(n),a=r1[n];a&&(typeof a=="string"?t[a]=!0:a(s,e[n],o))}let i=s.state&&s.state.cache;if(i)for(let n in t)i1[n](s,e,i)}function Zp(s,e){if(e=e||ld,typeof e=="number"){let n=e,o=Q0[n];return o?o(s,n):s.getParameter(n)}let t=Array.isArray(e)?e:Object.keys(e),i={};for(let n of t){let o=Q0[n];i[n]=o?o(s,Number(n)):s.getParameter(Number(n))}return i}function Qp(s){ni(s,ld)}function ht(s,e,t){if(K0(e))return t(s);let{nocatch:i=!0}=e;J0(s),ni(s,e);let n;if(i)n=t(s),$p(s);else try{n=t(s)}finally{$p(s)}return n}function Ln(s){let{luma:e}=s;if(s.canvas&&e){let{clientWidth:t}=e.canvasSizeInfo;return t?s.drawingBufferWidth/t:1}return 1}function nc(s,e,t=!0){let i=Ln(s),n=s.drawingBufferWidth,o=s.drawingBufferHeight;return V_(e,i,n,o,t)}function u1(s){let e=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(s)?s<=0?1:s:s?e:1}function V_(s,e,t,i,n){let o=a1(s[0],e,t),a=l1(s[1],e,i,n),l=a1(s[0]+1,e,t),u=l===t-1?l:l-1;l=l1(s[1]+1,e,i,n);let c;return n?(l=l===0?l:l+1,c=a,a=l):c=l===i-1?l:l-1,{x:o,y:a,width:Math.max(u-o+1,1),height:Math.max(c-a+1,1)}}function a1(s,e,t){return Math.min(Math.round(s*e),t-1)}function l1(s,e,t,i){return i?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}var ey=rr(),k_=ey&&typeof document<"u",c1={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function oc(s={}){Vt(ey,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),s=Object.assign({},c1,s);let{width:e,height:t}=s;function i(l){if(s.throwOnError)throw new Error(l);return console.error(l),null}s.onError=i;let n,{canvas:o}=s,a=z_({canvas:o,width:e,height:t,onError:i});return n=U_(a,s),n?(n=Ol(n,s),H_(n),n):null}function Ol(s,e={}){if(!s||s._instrumented)return s;s._version=s._version||W_(s),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{},e=Object.assign({},c1,e);let{manageState:t,debug:i}=e;return t&&Yp(s,{copyState:!1,log:(...n)=>ee.log(1,...n)()}),ey&&i&&(globalThis.makeDebugContext?(s=globalThis.makeDebugContext(s,e),ee.level=Math.max(ee.level,1)):ee.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),s._instrumented=!0,s}function h1(s){let e=s.getParameter(7936),t=s.getParameter(7937),i=s.getExtension("WEBGL_debug_renderer_info"),n=i&&s.getParameter(i.UNMASKED_VENDOR_WEBGL||7936),o=i&&s.getParameter(i.UNMASKED_RENDERER_WEBGL||7937);return{vendor:n||e,renderer:o||t,vendorMasked:e,rendererMasked:t,version:s.getParameter(7938),shadingLanguageVersion:s.getParameter(35724)}}function ty(s,e={}){if(s.canvas){let i=u1(e.useDevicePixels);j_(s,i,e);return}let t=s.getExtension("STACKGL_resize_drawingbuffer");t&&"width"in e&&"height"in e&&t.resize(e.width,e.height)}function U_(s,e){let{onError:t}=e,i=null,n=u=>i=u.statusMessage||i;s.addEventListener("webglcontextcreationerror",n,!1);let{webgl1:o=!0,webgl2:a=!0}=e,l=null;return a&&(l=l||s.getContext("webgl2",e),l=l||s.getContext("experimental-webgl2",e)),o&&(l=l||s.getContext("webgl",e),l=l||s.getContext("experimental-webgl",e)),s.removeEventListener("webglcontextcreationerror",n,!1),l?(e.onContextLost&&s.addEventListener("webglcontextlost",e.onContextLost,!1),e.onContextRestored&&s.addEventListener("webglcontextrestored",e.onContextRestored,!1),l):t(`Failed to create ${a&&!o?"WebGL2":"WebGL"} context: ${i||"Unknown error"}`)}function z_({canvas:s,width:e=800,height:t=600,onError:i}){let n;return typeof s=="string"?(k_&&document.readyState==="complete"||i(`createGLContext called on canvas '${s}' before page was loaded`),n=document.getElementById(s)):s?n=s:(n=document.createElement("canvas"),n.id="lumagl-canvas",n.style.width=Number.isFinite(e)?`${e}px`:"100%",n.style.height=Number.isFinite(t)?`${t}px`:"100%",document.body.insertBefore(n,document.body.firstChild)),n}function H_(s){let e=ce(s)?"WebGL2":"WebGL1",t=h1(s),i=t?`(${t.vendor},${t.renderer})`:"",n=s.debug?" debug":"";ee.info(1,`${e}${n} context ${i}`)()}function W_(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?2:1}function j_(s,e,t){let i="width"in t?t.width:s.canvas.clientWidth,n="height"in t?t.height:s.canvas.clientHeight;(!i||!n)&&(ee.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=s.canvas.width||1,n=s.canvas.height||1),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{};let o=s.luma.canvasSizeInfo;if(o.clientWidth!==i||o.clientHeight!==n||o.devicePixelRatio!==e){let a=e,l=Math.floor(i*a),u=Math.floor(n*a);s.canvas.width=l,s.canvas.height=u,(s.drawingBufferWidth!==l||s.drawingBufferHeight!==u)&&(ee.warn("Device pixel ratio clamped")(),a=Math.min(s.drawingBufferWidth/i,s.drawingBufferHeight/n),s.canvas.width=Math.floor(i*a),s.canvas.height=Math.floor(n*a)),Object.assign(s.luma.canvasSizeInfo,{clientWidth:i,clientHeight:n,devicePixelRatio:e})}}var ud="8.5.14",q_="set luma.log.level=1 (or higher) to trace rendering",d1=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new mo({id:e})),this.stats.get(e)}},Ji=new d1;if(globalThis.luma&&globalThis.luma.VERSION!==ud)throw new Error(`luma.gl - multiple VERSIONs detected: ${globalThis.luma.VERSION} vs ${ud}`);globalThis.luma||(rr()&&ee.log(1,`luma.gl ${ud} - ${q_}`)(),globalThis.luma=globalThis.luma||{VERSION:ud,version:ud,log:ee,stats:Ji,globals:{modules:{},nodeIO:{}}});var zfe=globalThis.luma;function ry(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function iy(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}function Y(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function Kp(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let i=s[e];return Y(i!==void 0,`Accessing undefined constant GL.${e}`),i}function en(s,e){e=Number(e);for(let t in s)if(s[t]===e)return`GL.${t}`;return String(e)}var ny={};function oi(s="id"){ny[s]=ny[s]||1;let e=ny[s]++;return`${s}-${e}`}function oy(s){return Y(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function yo(s){let e=!0;for(let t in s){e=!1;break}return e}function Jp(s,e,t,i){let n=`See luma.gl ${t} Upgrade Guide at https://luma.gl/docs/upgrade-guide`,o=Object.getPrototypeOf(s);i.forEach(a=>{o.methodName||(o[a]=()=>{throw ee.removed(`Calling removed method ${e}.${a}: `,n)(),new Error(a)})})}var sc="Resource subclass must define virtual methods",jt=class{get[Symbol.toStringTag](){return"Resource"}constructor(e,t={}){ns(e);let{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||oi(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}(${this.id})`}get handle(){return this._handle}delete({deleteChildren:e=!1}={}){let t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(i=>i.delete()),this}bind(e=this.handle){if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e,t={}){e=Kp(this.gl,e),Y(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=ce(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){let l=n.webgl1,u="webgl2"in n?n.webgl2:n.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(e={}){let{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},o=ce(this.gl),a={},l=t||Object.keys(n);for(let u of l){let c=n[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=i?en(this.gl,u):u;a[d]=this.getParameter(u,e),i&&c.type==="GLenum"&&(a[d]=en(this.gl,a[d]))}}return a}setParameter(e,t){e=Kp(this.gl,e),Y(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=ce(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");n.type==="GLenum"&&(t=Kp(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return Jp(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(sc)}_deleteHandle(){throw new Error(sc)}_bindHandle(e){throw new Error(sc)}_getOptsFromHandle(){throw new Error(sc)}_getParameter(e,t){throw new Error(sc)}_setParameter(e,t){throw new Error(sc)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){let e=this[Symbol.toStringTag],t=Ji.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get(`${e}s Created`).incrementCount(),t.get(`${e}s Active`).incrementCount()}_removeStats(){let e=this[Symbol.toStringTag];Ji.get("Resource Counts").get(`${e}s Active`).decrementCount()}_trackAllocatedMemory(e,t=this[Symbol.toStringTag]){let i=Ji.get("Memory Usage");i.get("GPU Memory").addCount(e),i.get(`${t} Memory`).addCount(e),this.byteLength=e}_trackDeallocatedMemory(e=this[Symbol.toStringTag]){let t=Ji.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get(`${e} Memory`).subtractCount(this.byteLength),this.byteLength=0}};var X_="Failed to deduce GL constant from typed array";function cd(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(X_)}}function Js(s,{clamped:e=!0}={}){switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function f1({data:s,width:e,height:t,bytesPerPixel:i=4,temp:n}){let o=e*i;n=n||new Uint8Array(o);for(let a=0;a<t/2;++a){let l=a*o,u=(t-a-1)*o;n.set(s.subarray(l,l+o)),s.copyWithin(l,u,u+o),s.set(n,u)}}function p1({data:s,width:e,height:t}){let i=Math.round(e/2),n=Math.round(t/2),o=new Uint8Array(i*n*4);for(let a=0;a<n;a++)for(let l=0;l<i;l++)for(let u=0;u<4;u++)o[(a*i+l)*4+u]=s[(a*2*e+l*2)*4+u];return{data:o,width:i,height:n}}function hd(s,e,t){let{removedProps:i={},deprecatedProps:n={},replacedProps:o={}}=t;for(let l in i)if(l in e){let c=i[l]?`${s}.${i[l]}`:"N/A";ee.removed(`${s}.${l}`,c)()}for(let l in n)if(l in e){let u=n[l];ee.deprecated(`${s}.${l}`,`${s}.${u}`)()}let a=null;for(let l in o)if(l in e){let u=o[l];ee.deprecated(`${s}.${l}`,`${s}.${u}`)(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var Y_={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},$_={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},dr=class{static getBytesPerElement(e){return Js(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return Y(e.size),Js(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(...e){return new dr(...[Y_,...e])}constructor(...e){e.forEach(t=>this._assign(t)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return dr.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return dr.getBytesPerVertex(this)}_assign(e={}){return e=hd("Accessor",e,$_),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var g1=10,m1={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},Z_={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:m1},Q_={removedProps:m1},pe=class extends jt{get[Symbol.toStringTag](){return"Buffer"}constructor(e,t={}){super(e,t);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(e=this.accessor){return Math.round(this.byteLength/dr.getBytesPerElement(e))}getVertexCount(e=this.accessor){return Math.round(this.byteLength/dr.getBytesPerVertex(e))}initialize(e={}){return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=hd("Buffer",e,Z_),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=hd("Buffer",e,Q_),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new dr(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:i=0,srcOffset:n=0}=e,o=e.byteLength||e.length;Y(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),n!==0||o!==void 0?(ft(this.gl),this.gl.bufferSubData(this.target,i,t,n,o)):this.gl.bufferSubData(a,i,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData({sourceBuffer:e,readOffset:t=0,writeOffset:i=0,size:n}){let{gl:o}=this;return ft(o),o.bindBuffer(36662,e.handle),o.bindBuffer(36663,this.handle),o.copyBufferSubData(36662,36663,t,i,n),o.bindBuffer(36662,null),o.bindBuffer(36663,null),this.debugData=null,this}getData({dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}={}){ft(this.gl);let o=Js(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=i,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,n||a),c=l+u);let h=Math.min(a,u);return n=n||h,Y(n<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind({target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}={}){return e===35345||e===35982?n!==void 0?this.gl.bindBufferRange(e,t,this.handle,i,n):(Y(i===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind({target:e=this.target,index:t=this.accessor&&this.accessor.index}={}){return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(g1,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e,t=0,i=e.byteLength+t){Y(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,g1),this.bytesUsed=i,this._trackAllocatedMemory(i);let o=cd(e);return Y(o),this.setAccessor(new dr(this.accessor,{type:o})),this}_setByteLength(e,t=this.usage){Y(e>=0),this._trackDeallocatedMemory();let i=e;e===0&&(i=new Float32Array(0));let n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=Js(this.accessor.type||5126,{clamped:!1}),i=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(e){this.accessor.type||this.setAccessor(new dr(this.accessor,{type:cd(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return ee.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return ee.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return ee.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return ee.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new dr(this.accessor,e),this}};var eg={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},tg={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},rg={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function b1(s,e){let t=eg[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let i=ce(s)&&t.gl2||t.gl1;return typeof i=="string"?s.getExtension(i):i}function P1(s,e){let t=eg[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var K_=[9729,9728],y1=globalThis.WebGLBuffer||function(){},si=class extends jt{get[Symbol.toStringTag](){return"Texture"}static isSupported(e,t={}){let{format:i,linearFiltering:n}=t,o=!0;return i&&(o=o&&b1(e,i),o=o&&(!n||P1(e,i))),o}constructor(e,t){let{id:i=oi("texture"),handle:n,target:o}=t;super(e,{id:i,handle:n});this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return`Texture(${this.id},${this.width}x${this.height})`}initialize(e={}){let t=e.data;if(t instanceof Promise)return t.then(D=>this.initialize(Object.assign({},e,{pixels:D,data:D}))),this;let i=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:n=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=n);let{width:d,height:f,dataFormat:P,type:E,compressed:v=!1,mipmaps:L=!0}=e,{depth:O=0}=e;return{width:d,height:f,compressed:v,dataFormat:P,type:E}=this._deduceParameters({format:o,type:E,dataFormat:P,compressed:v,data:t,width:d,height:f}),this.width=d,this.height=f,this.depth=O,this.format=o,this.type=E,this.dataFormat=P,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),L&&this._isNPOT()&&(ee.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),L=!1,this._updateForNPOT(u)),this.mipmaps=L,this.setImageData({data:t,width:d,height:f,depth:O,format:o,type:E,dataFormat:P,border:a,mipmaps:L,parameters:c,compressed:v}),L&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),i&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize({height:e,width:t,mipmaps:i=!1}){return t!==this.width||e!==this.height?this.initialize({width:t,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(e={}){return this._isNPOT()?(ee.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),ht(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:i=null,level:n=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:f=this.height,dataFormat:P=this.dataFormat,compressed:E=!1}=e;c||(c=i),{type:h,dataFormat:P,compressed:E,width:d,height:f}=this._deduceParameters({format:o,type:h,dataFormat:P,compressed:E,data:c,width:d,height:f});let{gl:v}=this;v.bindTexture(this.target,this.handle);let L=null;({data:c,dataType:L}=this._getDataType({data:c,compressed:E}));let O,D=0;if(ht(this.gl,u,()=>{switch(L){case"null":v.texImage2D(t,n,o,d,f,a,P,h,c);break;case"typed-array":v.texImage2D(t,n,o,d,f,a,P,h,c,l);break;case"buffer":O=ft(v),O.bindBuffer(35052,c.handle||c),O.texImage2D(t,n,o,d,f,a,P,h,l),O.bindBuffer(35052,null);break;case"browser-object":ce(v)?v.texImage2D(t,n,o,d,f,a,P,h,c):v.texImage2D(t,n,o,P,h,c);break;case"compressed":for(let[_,F]of c.entries())v.compressedTexImage2D(t,_,F.format,F.width,F.height,a,F.data),D+=F.levelSize;break;default:Y(!1,"Unknown image data type")}}),L==="compressed")this._trackAllocatedMemory(D,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let _=tg[this.dataFormat]||4,F=rg[this.type]||1;this._trackAllocatedMemory(this.width*this.height*_*F,"Texture")}return this.loaded=!0,this}setSubImageData({target:e=this.target,pixels:t=null,data:i=null,x:n=0,y:o=0,width:a=this.width,height:l=this.height,level:u=0,format:c=this.format,type:h=this.type,dataFormat:d=this.dataFormat,compressed:f=!1,offset:P=0,border:E=this.border,parameters:v={}}){if({type:h,dataFormat:d,compressed:f,width:a,height:l}=this._deduceParameters({format:c,type:h,dataFormat:d,compressed:f,data:i,width:a,height:l}),Y(this.depth===0,"texSubImage not supported for 3D textures"),i||(i=t),i&&i.data){let L=i;i=L.data,a=L.shape[0],l=L.shape[1]}i instanceof pe&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),ht(this.gl,v,()=>{if(f)this.gl.compressedTexSubImage2D(e,u,n,o,a,l,c,i);else if(i===null)this.gl.texSubImage2D(e,u,n,o,a,l,d,h,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(e,u,n,o,a,l,d,h,i,P);else if(i instanceof y1){let L=ft(this.gl);L.bindBuffer(35052,i),L.texSubImage2D(e,u,n,o,a,l,d,h,P),L.bindBuffer(35052,null)}else ce(this.gl)?ft(this.gl).texSubImage2D(e,u,n,o,a,l,d,h,i):this.gl.texSubImage2D(e,u,n,o,d,h,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(e={}){return ee.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType({data:e,compressed:t=!1}){return t?{data:e,dataType:"compressed"}:e===null?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof pe?{data:e.handle,dataType:"buffer"}:e instanceof y1?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:i}=e,{width:n,height:o,dataFormat:a,type:l,compressed:u}=e,c=eg[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:n,height:o}=this._deduceImageSize(i,n,o),{dataFormat:a,type:l,compressed:u,width:n,height:o,format:t,data:i}}_deduceImageSize(e,t,i){let n;return typeof ImageData<"u"&&e instanceof ImageData?n={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?n={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?n={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?n={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?n={width:e.videoWidth,height:e.videoHeight}:e?n={width:t,height:i}:n={width:t>=0?t:1,height:i>=0?i:1},Y(n,"Could not deduced texture size"),Y(t===void 0||n.width===t,"Deduced texture width does not match supplied width"),Y(i===void 0||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:Y(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return ce(this.gl)||!this.width||!this.height?!1:!oy(this.width)||!oy(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:K_.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var J_="";function S1(s,e){return Y(typeof s=="string"),s=J_+s,new Promise((t,i)=>{try{let n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error(`Could not load image ${s}.`)),n.crossOrigin=e&&e.crossOrigin||"anonymous",n.src=s}catch(n){i(n)}})}var Xe=class extends si{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return si.isSupported(e,t)}constructor(e,t={}){ns(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:S1(t.data)}));super(e,Object.assign({},t,{target:3553}));this.initialize(t),Object.seal(this)}};var sy=[34069,34070,34071,34072,34073,34074],ac=class extends si{get[Symbol.toStringTag](){return"TextureCube"}constructor(e,t={}){ns(e);super(e,Object.assign({},t,{target:34067}));this.initialize(t),Object.seal(this)}initialize(e={}){let{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)}),this}subImage({face:e,data:t,x:i=0,y:n=0,mipmapLevel:o=0}){return this._subImage({target:e,data:t,x:i,y:n,mipmapLevel:o})}async setCubeMapImageData({width:e,height:t,pixels:i,data:n,border:o=0,format:a=6408,type:l=5121}){let{gl:u}=this,c=i||n,h=await Promise.all(sy.map(d=>{let f=c[d];return Promise.all(Array.isArray(f)?f:[f])}));this.bind(),sy.forEach((d,f)=>{h[f].length>1&&this.opts.mipmaps!==!1&&ee.warn(`${this.id} has mipmap and multiple LODs.`)(),h[f].forEach((P,E)=>{e&&t?u.texImage2D(d,E,a,e,t,o,a,l,P):u.texImage2D(d,E,a,a,l,P)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:i,height:n,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(f=>this.setImageDataForFace(Object.assign({},e,{face:t,data:f,pixels:f}))):this.width||this.height?h.texImage2D(t,0,u,i,n,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};ac.FACES=sy;var dd=class extends si{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return ce(e)}constructor(e,t={}){ft(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1});super(e,t);this.initialize(t),Object.seal(this)}setImageData({level:e=0,dataFormat:t=6408,width:i,height:n,depth:o=1,border:a=0,format:l,type:u=5121,offset:c=0,data:h,parameters:d={}}){if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),ht(this.gl,d,()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,e,t,i,n,o,a,l,u,h),h instanceof pe&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,e,t,i,n,o,a,l,u,c))}),h&&h.byteLength)this._trackAllocatedMemory(h.byteLength,"Texture");else{let f=tg[this.dataFormat]||4,P=rg[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*f*P,"Texture")}return this.loaded=!0,this}};var Rl="EXT_color_buffer_float",ay={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Rl,bpp:2},[33327]:{gl2:Rl,bpp:4},[34842]:{gl2:Rl,bpp:8},[33326]:{gl2:Rl,bpp:4},[33328]:{gl2:Rl,bpp:8},[34836]:{gl2:Rl,bpp:16},[35898]:{gl2:Rl,bpp:4}};function eB(s,e,t){let i=t[e];if(!i)return!1;let n=ce(s)&&i.gl2||i.gl1;return typeof n=="string"?s.getExtension(n):n}var Ni=class extends jt{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e,{format:t}={format:null}){return!t||eB(e,t,ay)}static getSamplesForFormat(e,{format:t}){return e.getInternalformatParameter(36161,t,32937)}constructor(e,t={}){super(e,t);this.initialize(t),Object.seal(this)}initialize({format:e,width:t=1,height:i=1,samples:n=0}){return Y(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),n!==0&&ce(this.gl)?this.gl.renderbufferStorageMultisample(36161,n,e,t,i):this.gl.renderbufferStorage(36161,e,t,i),this.format=e,this.width=t,this.height=i,this.samples=n,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*ay[this.format].bpp),this}resize({width:e,height:t}){return e!==this.width||t!==this.height?this.initialize({width:e,height:t,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var tB=256,rB=1024,iB=16384,E1=6144,x1=6145,v1=6146,C1=34041,A1="clear: bad arguments";function ea(s,{framebuffer:e=null,color:t=null,depth:i=null,stencil:n=null}={}){let o={};e&&(o.framebuffer=e);let a=0;t&&(a|=iB,t!==!0&&(o.clearColor=t)),i&&(a|=tB,i!==!0&&(o.clearDepth=i)),n&&(a|=rB,i!==!0&&(o.clearStencil=i)),Y(a!==0,A1),ht(s,o,()=>{s.clear(a)})}function ly(s,{framebuffer:e=null,buffer:t=E1,drawBuffer:i=0,value:n=[0,0,0,0]}={}){ft(s),ht(s,{framebuffer:e},()=>{switch(t){case E1:switch(n.constructor){case Int32Array:s.clearBufferiv(t,i,n);break;case Uint32Array:s.clearBufferuiv(t,i,n);break;case Float32Array:default:s.clearBufferfv(t,i,n)}break;case x1:s.clearBufferfv(x1,0,[n]);break;case v1:s.clearBufferiv(v1,0,[n]);break;case C1:let[o,a]=n;s.clearBufferfi(C1,0,o,a);break;default:Y(!1,A1)}})}function uy(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return Y(!1),0}}function T1(s){switch(s){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return Y(!1),0}}function os(s,e={}){let{sourceX:t=0,sourceY:i=0,sourceFormat:n=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=cy(s);Y(h);let{gl:f,handle:P,attachments:E}=h;l=l||h.width,u=u||h.height,o===36064&&P===null&&(o=1028),Y(E[o]),c=c||E[o].type,a=nB(a,c,n,l,u),c=c||cd(a);let v=f.bindFramebuffer(36160,P);return f.readPixels(t,i,l,u,n,c,a),f.bindFramebuffer(36160,v||null),d&&h.delete(),a}function ig(s,{sourceX:e=0,sourceY:t=0,sourceFormat:i=6408,target:n=null,targetByteOffset:o=0,sourceWidth:a,sourceHeight:l,sourceType:u}){let{framebuffer:c,deleteFramebuffer:h}=cy(s);Y(c),a=a||c.width,l=l||c.height;let d=ft(c.gl);if(u=u||(n?n.type:5121),!n){let f=uy(i),P=T1(u),E=o+a*l*f*P;n=new pe(d,{byteLength:E,accessor:{type:u,size:f}})}return n.bind({target:35051}),ht(d,{framebuffer:c},()=>{d.readPixels(e,t,a,l,i,u,o)}),n.unbind({target:35051}),h&&c.delete(),n}function ng(s,{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}={}){let i=os(s,{sourceAttachment:e}),{width:n,height:o}=s;for(;o>t;)({data:i,width:n,height:o}=p1({data:i,width:n,height:o}));f1({data:i,width:n,height:o});let a=document.createElement("canvas");a.width=n,a.height=o;let l=a.getContext("2d"),u=l.createImageData(n,o);return u.data.set(i),l.putImageData(u,0,0),a.toDataURL()}function og(s,e,t={}){let{sourceX:i=0,sourceY:n=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:f,deleteFramebuffer:P}=cy(s);Y(f);let{gl:E,handle:v}=f,L=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let O=E.bindFramebuffer(36160,v);Y(e);let D=null;if(e instanceof si&&(D=e,h=Number.isFinite(h)?h:D.width,d=Number.isFinite(d)?d:D.height,D.bind(0),e=D.target),!L)E.copyTexImage2D(e,o,a,i,n,h,d,0);else switch(e){case 3553:case 34067:E.copyTexSubImage2D(e,o,l,u,i,n,h,d);break;case 35866:case 32879:ft(E).copyTexSubImage3D(e,o,l,u,c,i,n,h,d);break;default:}return D&&D.unbind(),E.bindFramebuffer(36160,O||null),P&&f.delete(),D}function cy(s){return s instanceof _e?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:I1(s),deleteFramebuffer:!0}}function nB(s,e,t,i,n){if(s)return s;e=e||5121;let o=Js(e,{clamped:!1}),a=uy(t);return new o(i*n*a)}var at={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function oB(s){let e=new Xe(s,{format:6408,type:5126,dataFormat:6408}),t=new _e(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),i=t.getStatus();return e.delete(),t.delete(),i===36053}var hy={[at.WEBGL2]:[!1,!0],[at.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[at.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[at.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[at.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[at.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[at.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[at.FLOAT_BLEND]:["EXT_float_blend"],[at.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[at.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[at.TEXTURE_FLOAT]:["OES_texture_float",!0],[at.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[at.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[at.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[at.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[at.COLOR_ATTACHMENT_RGBA32F]:[oB,"EXT_color_buffer_float"],[at.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[at.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[at.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[at.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[at.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[at.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var sB=2;function fd(s,e){return lc(s,e)}function lc(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>w1(s,t))}function sg(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in hy)s.luma.caps[e]===void 0&&(s.luma.caps[e]=w1(s,e));return s.luma.caps}function w1(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=aB(s,e)),s.luma.caps[e]||ee.log(sB,`Feature: ${e} not supported`)(),s.luma.caps[e]}function aB(s,e){let t=hy[e];Y(t,e);let i,n=ce(s)&&t[1]||t[0];if(typeof n=="function")i=n(s);else if(Array.isArray(n)){i=!0;for(let o of n)i=i&&Boolean(s.getExtension(o))}else typeof n=="string"?i=Boolean(s.getExtension(n)):typeof n=="boolean"?i=n:Y(!1);return i}var L1="Multiple render targets not supported",_e=class extends jt{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e,t={}){let{colorBufferFloat:i,colorBufferHalfFloat:n}=t,o=!0;return i&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new _e(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=ft(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=ft(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e,t={}){super(e,t);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize({width:e=1,height:t=1,attachments:i=null,color:n=!0,depth:o=!0,stencil:a=!1,check:l=!0,readBuffer:u=void 0,drawBuffers:c=void 0}){if(Y(e>=0&&t>=0,"Width and height need to be integers"),this.width=e,this.height=t,i)for(let h in i){let d=i[h];(Array.isArray(d)?d[0]:d).resize({width:e,height:t})}else i=this._createDefaultAttachments(n,o,a,e,t);this.update({clearAttachments:!0,attachments:i,readBuffer:u,drawBuffers:c}),i&&l&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update({attachments:e={},readBuffer:t,drawBuffers:i,clearAttachments:n=!1,resizeAttachments:o=!0}){this.attach(e,{clearAttachments:n,resizeAttachments:o});let{gl:a}=this,l=a.bindFramebuffer(36160,this.handle);return t&&this._setReadBuffer(t),i&&this._setDrawBuffers(i),a.bindFramebuffer(36160,l||null),this}resize(e={}){let{width:t,height:i}=e;if(this.handle===null)return Y(t===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&ee.log(2,`Resizing framebuffer ${this.id} to ${t}x${i}`)();for(let n in this.attachments)this.attachments[n].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e,{clearAttachments:t=!1,resizeAttachments:i=!0}={}){let n={};t&&Object.keys(this.attachments).forEach(a=>{n[a]=null}),Object.assign(n,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in n){Y(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=n[l],c=u;if(!c)this._unattach(l);else if(c instanceof Ni)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,f=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:f})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});i&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(uB(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(e={}){let{color:t,depth:i,stencil:n,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&ea(this.gl,{color:t,depth:i,stencil:n}),o.forEach((l,u)=>{ly(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(e={}){return ee.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(e={}){return ee.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(e={}){return ee.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(e={}){return ee.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(e={}){return ee.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(e={}){return ee.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate({attachments:e=[],x:t=0,y:i=0,width:n,height:o}){let a=ft(this.gl),l=a.bindFramebuffer(36008,this.handle);return t===0&&i===0&&n===void 0&&o===void 0?a.invalidateFramebuffer(36008,e):a.invalidateFramebuffer(36008,e,t,i,n,o),a.bindFramebuffer(36008,l),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return n===null&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=en(this.gl,n)),n}getAttachmentParameters(e=36064,t,i=this.constructor.ATTACHMENT_PARAMETERS||[]){let n={};for(let o of i){let a=t?en(this.gl,o):o;n[a]=this.getAttachmentParameter(e,o,t)}return n}getParameters(e=!0){let t=Object.keys(this.attachments),i={};for(let n of t){let o=Number(n),a=e?en(this.gl,o):o;i[a]=this.getAttachmentParameters(o,e)}return i}show(){return typeof window<"u"&&window.open(ng(this),"luma-debug-texture"),this}log(e=0,t=""){if(e>ee.level||typeof window>"u")return this;t=t||`Framebuffer ${this.id}`;let i=ng(this,{targetMaxHeight:100});return ee.image({logLevel:e,message:t,image:i},t)(),this}bind({target:e=36160}={}){return this.gl.bindFramebuffer(e,this.handle),this}unbind({target:e=36160}={}){return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,o){let a=null;return e&&(a=a||{},a[36064]=new Xe(this.gl,{id:`${this.id}-color0`,pixels:null,format:6408,type:5121,width:n,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&i?(a=a||{},a[33306]=new Ni(this.gl,{id:`${this.id}-depth-stencil`,format:35056,width:n,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new Ni(this.gl,{id:`${this.id}-depth`,format:33189,width:n,height:o}),this.ownResources.push(a[36096])):i&&Y(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof Ni?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer({attachment:e=36064,renderbuffer:t}){let{gl:i}=this;i.framebufferRenderbuffer(36160,e,36161,t.handle),this.attachments[e]=t}_attachTexture({attachment:e=36064,texture:t,layer:i,level:n}){let{gl:o}=this;switch(o.bindTexture(t.target,t.handle),t.target){case 35866:case 32879:ft(o).framebufferTextureLayer(36160,e,t.target,n,i);break;case 34067:let l=lB(i);o.framebufferTexture2D(36160,e,l,t.handle,n);break;case 3553:o.framebufferTexture2D(36160,e,3553,t.handle,n);break;default:Y(!1,"Illegal texture type")}o.bindTexture(t.target,null),this.attachments[e]=t}_setReadBuffer(e){let t=Y0(this.gl);t?t.readBuffer(e):Y(e===36064||e===1029,L1),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,i=ft(t);if(i)i.drawBuffers(e);else{let n=t.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(e):Y(e.length===1&&(e[0]===36064||e[0]===1029),L1)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=sg(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function lB(s){return s<34069?s+34069:s}function uB(s){return(_e.STATUS||{})[s]||`Framebuffer error ${s}`}var cB=[36049,36048,33296,33298,33299,33300,33301,33302,33303];_e.ATTACHMENT_PARAMETERS=cB;function uc(s,e){Y(s instanceof Xe||s instanceof ac||s instanceof dd);let t=s.constructor,{gl:i,width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(i,d)}function I1(s,e){let{gl:t,width:i,height:n,id:o}=s;return new _e(t,Object.assign({},e,{id:`framebuffer-for-${o}`,width:i,height:n,attachments:{[36064]:s}}))}function ta(s,e="unnamed"){let t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=s.match(t);return i?i[1]:e}function dy(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function fy(s,e,t,i){let n=s.split(/\r?\n/),o={},a={},l=i||ta(e)||"(unnamed)",u=`${dy(t)} shader ${l}`;for(let h=0;h<n.length;h++){let d=n[h];if(d.length<=1)continue;let f=d.split(":"),P=f[0],E=parseInt(f[2],10);if(isNaN(E))throw new Error(`GLSL compilation error in ${u}: ${s}`);P!=="WARNING"?o[E]=d:a[E]=d}let c=hB(e);return{shaderName:u,errors:O1(o,c),warnings:O1(a,c)}}function O1(s,e){let t="";for(let i=0;i<e.length;i++){let n=e[i];if(!(!s[i+3]&&!s[i+2]&&!s[i+1])&&(t+=`${n}
`,s[i+1])){let o=s[i+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=R1(`^^^ ${l}: ${c}

`,u)}}return t}function hB(s,e=1,t=": "){let i=s.split(/\r?\n/),n=String(i.length+e-1).length;return i.map((o,a)=>{let l=String(a+e),u=l.length;return R1(l,n-u)+t+o})}function R1(s,e){let t="";for(let i=0;i<e;++i)t+=" ";return`${t}${s}`}function cc(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}return e}var dB="Shader: GLSL source code must be a JavaScript string",hc=class extends jt{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return Y(!1),"unknown"}}constructor(e,t){ns(e),Y(typeof t.source=="string",dB);let i=ta(t.source,null)||t.id||oi(`unnamed ${hc.getTypeName(t.shaderType)}`);super(e,{id:i});this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize({source:e}){let t=ta(e,null);t&&(this.id=oi(t)),this._compile(e)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return`${hc.getTypeName(this.shaderType)}:${this.id}`}getName(){return ta(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(e=this.source){if(e.startsWith("#version ")||(e=`#version 100
${e}`),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let i=this.gl.getShaderInfoLog(this.handle),{shaderName:n,errors:o,warnings:a}=fy(i,this.source,this.shaderType,this.id);throw ee.error(`GLSL compilation errors in ${n}
${o}`)(),ee.warn(`GLSL compilation warnings in ${n}
${a}`)(),new Error(`GLSL compilation errors in ${n}`)}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},pd=class extends hc{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},gd=class extends hc{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var fB={[5126]:yt.bind(null,"uniform1fv",Di,1,Ur),[35664]:yt.bind(null,"uniform2fv",Di,2,Ur),[35665]:yt.bind(null,"uniform3fv",Di,3,Ur),[35666]:yt.bind(null,"uniform4fv",Di,4,Ur),[5124]:yt.bind(null,"uniform1iv",ra,1,Ur),[35667]:yt.bind(null,"uniform2iv",ra,2,Ur),[35668]:yt.bind(null,"uniform3iv",ra,3,Ur),[35669]:yt.bind(null,"uniform4iv",ra,4,Ur),[35670]:yt.bind(null,"uniform1iv",ra,1,Ur),[35671]:yt.bind(null,"uniform2iv",ra,2,Ur),[35672]:yt.bind(null,"uniform3iv",ra,3,Ur),[35673]:yt.bind(null,"uniform4iv",ra,4,Ur),[35674]:yt.bind(null,"uniformMatrix2fv",Di,4,ss),[35675]:yt.bind(null,"uniformMatrix3fv",Di,9,ss),[35676]:yt.bind(null,"uniformMatrix4fv",Di,16,ss),[35678]:vr,[35680]:vr,[5125]:yt.bind(null,"uniform1uiv",ag,1,Ur),[36294]:yt.bind(null,"uniform2uiv",ag,2,Ur),[36295]:yt.bind(null,"uniform3uiv",ag,3,Ur),[36296]:yt.bind(null,"uniform4uiv",ag,4,Ur),[35685]:yt.bind(null,"uniformMatrix2x3fv",Di,6,ss),[35686]:yt.bind(null,"uniformMatrix2x4fv",Di,8,ss),[35687]:yt.bind(null,"uniformMatrix3x2fv",Di,6,ss),[35688]:yt.bind(null,"uniformMatrix3x4fv",Di,12,ss),[35689]:yt.bind(null,"uniformMatrix4x2fv",Di,8,ss),[35690]:yt.bind(null,"uniformMatrix4x3fv",Di,12,ss),[35678]:vr,[35680]:vr,[35679]:vr,[35682]:vr,[36289]:vr,[36292]:vr,[36293]:vr,[36298]:vr,[36299]:vr,[36300]:vr,[36303]:vr,[36306]:vr,[36307]:vr,[36308]:vr,[36311]:vr},pB={},gB={},mB={},M1=[0];function py(s,e,t,i){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(M1[0]=s,s=M1);let n=s.length;if(n%e&&ee.warn(`Uniform size should be multiples of ${e}`,s)(),s instanceof t)return s;let o=i[n];o||(o=new t(n),i[n]=o);for(let a=0;a<n;a++)o[a]=s[a];return o}function Di(s,e){return py(s,e,Float32Array,pB)}function ra(s,e){return py(s,e,Int32Array,gB)}function ag(s,e){return py(s,e,Uint32Array,mB)}function gy(s,e,t){let i=fB[t.type];if(!i)throw new Error(`Unknown GLSL uniform type ${t.type}`);return i().bind(null,s,e)}function _1(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${s}`);return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function B1(s,e,t){for(let i in s){let n=s[i];if((!t||Boolean(t[i]))&&!bB(n))throw e=e?`${e} `:"",console.error(`${e} Bad uniform ${i}`,n),new Error(`${e} Bad uniform ${i}`)}return!0}function bB(s){return Array.isArray(s)||ArrayBuffer.isView(s)?PB(s):isFinite(s)||s===!0||s===!1||s instanceof si||s instanceof Ni?!0:s instanceof _e?Boolean(s.texture):!1}function N1(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let i=s[e];for(let n=0,o=t.length;n<o;++n)i[n]=t[n]}else s[e]=t.slice();else s[e]=t}function PB(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function vr(){let s=null;return(e,t,i)=>{let n=s!==i;return n&&(e.uniform1i(t,i),s=i),n}}function yt(s,e,t,i){let n=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(n===null)n=new Float32Array(h),o=h,d=!0;else{Y(o===h,"Uniform length cannot change.");for(let f=0;f<h;++f)if(c[f]!==n[f]){d=!0;break}}return d&&(i(a,s,l,c),n.set(c)),d}}function Ur(s,e,t,i){s[e](t,i)}function ss(s,e,t,i){s[e](t,!1,i)}var yB=5120,SB=5121,EB=5122,xB=5123,D1=0,lg=1,vB=2,CB=3,ug=4,AB=5,TB=6,ir=5126,IB=35664,wB=35665,LB=35666,md=5124,OB=35667,RB=35668,MB=35669,bd=5125,_B=36294,BB=36295,NB=36296,DB=35670,FB=35671,GB=35672,VB=35673,kB=35674,UB=35675,zB=35676,HB=35685,WB=35686,jB=35687,qB=35688,XB=35689,YB=35690,my={[ir]:[ir,1,"float"],[IB]:[ir,2,"vec2"],[wB]:[ir,3,"vec3"],[LB]:[ir,4,"vec4"],[md]:[md,1,"int"],[OB]:[md,2,"ivec2"],[RB]:[md,3,"ivec3"],[MB]:[md,4,"ivec4"],[bd]:[bd,1,"uint"],[_B]:[bd,2,"uvec2"],[BB]:[bd,3,"uvec3"],[NB]:[bd,4,"uvec4"],[DB]:[ir,1,"bool"],[FB]:[ir,2,"bvec2"],[GB]:[ir,3,"bvec3"],[VB]:[ir,4,"bvec4"],[kB]:[ir,8,"mat2"],[HB]:[ir,8,"mat2x3"],[WB]:[ir,8,"mat2x4"],[UB]:[ir,12,"mat3"],[jB]:[ir,12,"mat3x2"],[qB]:[ir,12,"mat3x4"],[zB]:[ir,16,"mat4"],[XB]:[ir,16,"mat4x2"],[YB]:[ir,16,"mat4x3"]};function F1(s){switch(s){case D1:return D1;case lg:return lg;case CB:return lg;case vB:return lg;case ug:return ug;case AB:return ug;case TB:return ug;default:return Y(!1),0}}function by(s){let e=my[s];if(!e)return null;let[t,i]=e;return{type:t,components:i}}function cg(s,e){switch(s){case yB:case SB:case EB:case xB:s=ir;break;default:}for(let t in my){let[i,n,o]=my[t];if(i===s&&n===e)return{glType:t,name:o}}return null}var hg=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,n),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((n,o)=>n.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!ce(t))return;let i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,o,a,l)}this.varyingInfos.sort((n,o)=>n.location-o.location)}_addAttribute(e,t,i,n){let{type:o,components:a}=by(i),l={type:o,size:n*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new dr(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){let{type:o,components:a}=by(i),l=new dr({type:o,size:n*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var G1=4,$B=35981,ZB=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],ia=class extends jt{get[Symbol.toStringTag](){return"Program"}constructor(e,t={}){super(e,t);this.stubRemovedMethods("Program","v6.0",ZB),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(e={}){let{hash:t,vs:i,fs:n,varyings:o,bufferMode:a=$B}=e;return this.hash=t||"",this.vs=typeof i=="string"?new pd(this.gl,{id:`${e.id}-vs`,source:i}):i,this.fs=typeof n=="string"?new gd(this.gl,{id:`${e.id}-fs`,source:n}):n,Y(this.vs instanceof pd),Y(this.fs instanceof gd),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(ft(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new hg(this),this.setProps(e)}delete(e={}){return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw({logPriority:e,drawMode:t=4,vertexCount:i,offset:n=0,start:o,end:a,isIndexed:l=!1,indexType:u=5123,instanceCount:c=0,isInstanced:h=c>0,vertexArray:d=null,transformFeedback:f,framebuffer:P,parameters:E={},uniforms:v,samplers:L}){if((v||L)&&(ee.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(v||{})),ee.priority>=e){let O=P?P.id:"default",D=`mode=${en(this.gl,t)} verts=${i} instances=${c} indexType=${en(this.gl,u)} isInstanced=${h} isIndexed=${l} Framebuffer=${O}`;ee.log(e,D)()}return Y(d),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||i===0||h&&c===0?!1:(d.bindForDraw(i,c,()=>{if(P!==void 0&&(E=Object.assign({},E,{framebuffer:P})),f){let O=F1(t);f.begin(O)}this._bindTextures(),ht(this.gl,E,()=>{l&&h?this.gl2.drawElementsInstanced(t,i,u,n,c):l&&ce(this.gl)&&!isNaN(o)&&!isNaN(a)?this.gl2.drawRangeElements(t,o,a,i,u,n):l?this.gl.drawElements(t,i,u,n):h?this.gl2.drawArraysInstanced(t,n,i,c):this.gl.drawArrays(t,n,i)}),f&&f.end()}),!0)}setUniforms(e={}){ee.priority>=2&&B1(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let i=e[t],n=this._uniformSetters[t];if(n){let o=i,a=!1;if(o instanceof _e&&(o=o.texture),o instanceof si)if(a=this.uniforms[t]!==i,a){n.textureIndex===void 0&&(n.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=n;l.bind(u),o=u,this._textureUniforms[t]=l}else o=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(o)||a)&&N1(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),i={};for(let n of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new pd({handle:n});break;case 35632:i.fs=new gd({handle:n});break;default:}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=oi(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?`${e}-program`:"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),ee.time(G1,`linkProgram for ${this._getName()}`)(),e.linkProgram(this.handle),ee.timeEnd(G1,`linkProgram for ${this._getName()}`)(),e.debug||ee.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error(`Error linking: ${e.getProgramInfoLog(this.handle)}`);if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error(`Error validating: ${e.getProgramInfoLog(this.handle)}`)}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let i=this.gl.getActiveUniform(this.handle,t),{name:n}=_1(i.name),o=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=gy(e,o,i),i.size>1)for(let a=0;a<i.size;a++)o=e.getUniformLocation(this.handle,`${n}[${a}]`),this._uniformSetters[`${n}[${a}]`]=gy(e,o,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var QB=34918,KB=34919,JB=35007,eN=36795,tN=35976,rN=35887,iN=36202,na=class extends jt{get[Symbol.toStringTag](){return"Query"}static isSupported(e,t=[]){let i=ce(e),n=lc(e,at.TIMER_QUERY),o=i||n;for(let a of t)switch(a){case"queries":o=o&&i;break;case"timers":o=o&&n;break;default:Y(!1)}return o}constructor(e,t={}){super(e,t);this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(JB)}beginOcclusionQuery({conservative:e=!1}={}){return this.begin(e?iN:rN)}beginTransformFeedbackQuery(){return this.begin(tN)}begin(e){return this._queryPending?this:(this.target=e,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;let e=this.gl2.getQueryParameter(this.handle,KB);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(eN)}getResult(){return this.gl2.getQueryParameter(this.handle,QB)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((i,n)=>{let o=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}_createHandle(){return na.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}};var oa=class extends jt{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return ce(e)}constructor(e,t={}){ft(e);super(e,t);this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(e={}){return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,yo(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(e={}){return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let i=this._getVaryingIndex(e),{buffer:n,byteSize:o,byteOffset:a}=this._getBufferParams(t);return i<0?(this.unused[e]=n,ee.warn(()=>`${this.id} unused varying buffer ${e}`)(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,a,o),this)}begin(e=0){return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof pe?n=e:(n=e.buffer,i=e.byteSize,t=e.byteOffset),(t!==void 0||i!==void 0)&&(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t,i=0,n){let o=t&&t.handle;return!o||n===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,i,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var dg=null;function nN(s){return(!dg||dg.byteLength<s)&&(dg=new ArrayBuffer(s)),dg}function V1(s,e){let t=nN(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function k1({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var oN="elements must be GL.ELEMENT_ARRAY_BUFFER",zr=class extends jt{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e,t={}){return t.constantAttributeZero?ce(e)||Tl()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new zr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return zr.MAX_ATTRIBUTES=zr.MAX_ATTRIBUTES||e.getParameter(34921),zr.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:zr._setConstantFloatArray(e,t,i);break;case Int32Array:zr._setConstantIntArray(e,t,i);break;case Uint32Array:zr._setConstantUintArray(e,t,i);break;default:Y(!1)}}constructor(e,t={}){let i=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:i}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return zr.getMaxAttributes(this.gl)}initialize(e={}){return this.setProps(e)}setProps(e){return this}setElementBuffer(e=null,t={}){return Y(!e||e.target===34963,oN),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,i){if(t.target===34963)return this.setElementBuffer(t,i);let{size:n,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=i,{gl:d,gl2:f}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(Y(ce(d)),f.vertexAttribIPointer(e,n,o,a,l)):d.vertexAttribPointer(e,n,o,u,a,l),d.enableVertexAttribArray(e),f.vertexAttribDivisor(e,h||0)}),this}enable(e,t=!0){return!t&&e===0&&!zr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,o=i.length*e,a=!this.buffer;if(this.buffer=this.buffer||new pe(this.gl,n),a=a||this.buffer.reallocate(n),a=a||!this._compareConstantArrayValues(i,this.bufferValue),a){let l=V1(t.constructor,o);k1({target:l,source:i,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:Y(!1)}}static _setConstantIntArray(e,t,i){switch(Y(ce(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:Y(!1)}}static _setConstantUintArray(e,t,i){switch(Y(ce(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:Y(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,{location:t}){return Y(Number.isFinite(t)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(t,e);default:return this.gl.getVertexAttrib(t,e)}})}};var sN="VertexArray: attributes must be Buffers or constants (i.e. typed array)",aN=/^(.+)__LOCATION_([0-9]+)$/,lN=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],Pd=class{constructor(e,t={}){let i=t.id||t.program&&t.program.id;this.id=i,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new zr(e),Jp(this,"VertexArray","v6.0",lN),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(e={}){return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let i=e[t];this._setAttribute(t,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(e=null,t={}){return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t,i={}){if(t.target===34963)return this.setElementBuffer(t,i);let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,o)),this}setConstant(e,t,i={}){let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new pe(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof pe&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof pe&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),n=i()}),n}_resolveLocationAndAccessor(e,t,i,n){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,ee.once(3,()=>`unused value ${e} in ${this.id}`)(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=dr.resolve(u.accessor,c,i,n),{size:d,type:f}=h;return Y(Number.isFinite(d)&&Number.isFinite(f)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let i=aN.exec(e),n=i?i[1]:e,o=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+o,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof pe)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof pe){let i=t[0],n=t[1];this.setBuffer(e,i,n)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let i=t;this.setConstant(e,i)}else if(t.buffer instanceof pe){let i=t;this.setBuffer(e,i.buffer,i)}else throw new Error(sN)}_setConstantAttributes(e,t){let i=Math.max(e|0,t|0),n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)n=this.values[o],ArrayBuffer.isView(n)&&this._setConstantAttribute(o,n)}_setConstantAttributeZero(e,t){if(zr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){zr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let i=this.values[t],n=this.accessors[t];if(!i)return;let{divisor:o}=n,a=o>0;if(e.isInstanced=e.isInstanced||a,i instanceof pe){let l=i;if(a){let u=l.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(e=null,t={}){return ee.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function uN(s,e){let{maxElts:t=16,size:i=1}=e,n="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(n+=`,${a%i===0?" ":""}`),n+=Ml(s[a],e);let o=s.length>t?"...":"]";return`${n}${o}`}function Ml(s,e={}){let{isInteger:i=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return uN(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<1e-16)return i?"0":"0.";if(i||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let n=s.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function fg({header:s="Uniforms",program:e,uniforms:t,undefinedOnly:i=!1}){Y(e);let n=".*_.*",o=".*Matrix",a=e._uniformSetters,l={},u=Object.keys(a).sort(),c=0;for(let f of u)!f.match(n)&&!f.match(o)&&Py({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:i})&&c++;for(let f of u)f.match(o)&&Py({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:i})&&c++;for(let f of u)l[f]||Py({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:i})&&c++;let h=0,d={};if(!i)for(let f in t){let P=t[f];l[f]||(h++,d[f]={Type:`NOT USED: ${P}`,[s]:Ml(P)})}return{table:l,count:c,unusedTable:d,unusedCount:h}}function Py({table:s,header:e,uniforms:t,uniformName:i,undefinedOnly:n}){let o=t[i],a=cN(o);return!n||!a?(s[i]={[e]:a?Ml(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0):!1}function cN(s){return s!=null}function yy({vertexArray:s,header:e="Attributes"}){if(!s.configuration)return{};let t={};s.elements&&(t.ELEMENT_ARRAY_BUFFER=U1(s,s.elements,null,e));let i=s.values;for(let n in i){let o=s._getAttributeInfo(n);if(o){let a=`${n}: ${o.name}`,l=s.accessors[o.location];l&&(a=`${n}: ${hN(o.name,l)}`),t[a]=U1(s,i[n],l,e)}}return t}function U1(s,e,t,i){let{gl:n}=s;if(!e)return{[i]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof pe){let f=e,{data:P,changed:E}=f.getDebugData();h=E?"*":"",d=P,u=f.byteLength,l=u/P.BYTES_PER_ELEMENT/a;let v;return t?v=`${t.divisor>0?"I ":"P "} ${l} (x${a}=${u} bytes ${en(n,o)})`:(c=!0,v=`${u} bytes`),{[i]:`${h}${Ml(d,{size:a,isInteger:c})}`,"Format ":v}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[i]:`${Ml(d,{size:a,isInteger:c})} (constant)`,"Format ":`${a}x${o} (constant)`}}function hN(s,e){let{type:t,size:i}=e,n=cg(t,i);return n?`${s} (${n.name})`:s}function Sy(s){let e={},t=`Accessors for ${s.id}`;for(let i of s.attributeInfos)if(i){let n=z1(i);e[`in ${n}`]={[t]:JSON.stringify(i.accessor)}}for(let i of s.varyingInfos)if(i){let n=z1(i);e[`out ${n}`]={[t]:JSON.stringify(i.accessor)}}return e}function z1(s){let{type:e,size:t}=s.accessor,i=cg(e,t);return i?`${i.name} ${s.name}`:s.name}var H1=rr()&&typeof document<"u",dN=0,dc=class{constructor(e={}){let{onCreateContext:t=L=>oc(L),onAddHTML:i=null,onInitialize:n=()=>{},onRender:o=()=>{},onFinalize:a=()=>{},onError:l,gl:u=null,glOptions:c={},debug:h=!1,createFramebuffer:d=!1,autoResizeViewport:f=!0,autoResizeDrawingBuffer:P=!0,stats:E=Ji.get(`animation-loop-${dN++}`)}=e,{useDevicePixels:v=!0}=e;"useDevicePixelRatio"in e&&(ee.deprecated("useDevicePixelRatio","useDevicePixels")(),v=e.useDevicePixelRatio),this.props={onCreateContext:t,onAddHTML:i,onInitialize:n,onRender:o,onFinalize:a,onError:l,gl:u,glOptions:c,debug:h,createFramebuffer:d},this.gl=u,this.needsRedraw=null,this.timeline=null,this.stats=E,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:f,autoResizeDrawingBuffer:P,useDevicePixels:v}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return Y(typeof e=="string"),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(e={}){if(this._running)return this;this._running=!0;let t=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=na.isSupported(this.gl,["timers"])?new na(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(i=>{this._running&&(this._addCallbackData(i||{}),i!==!1&&this._startLoop())});return this.props.onError&&t.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(...e){return this.props.onCreateContext(...e)}onInitialize(...e){return this.props.onInitialize(...e)}onRender(...e){return this.props.onRender(...e)}onFinalize(...e){return this.props.onFinalize(...e)}getHTMLControlValue(e,t=1){let i=document.getElementById(e);return i?Number(i.value):t}setViewParameters(){return ee.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){let e=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=H1?new Promise((e,t)=>{if(H1&&document.readyState==="complete"){e(document);return}window.addEventListener("load",()=>{e(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):iy(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):ry(e)}_renderFrame(...e){if(this.display){this.display._renderFrame(...e);return}this.onRender(...e)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){typeof e=="object"&&e!==null&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&typeof OffscreenCanvas<"u"&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?Ol(this.props.gl,e):this.onCreateContext(e),!is(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");Qp(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){let e=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight,i=1,{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&ty(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new _e(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){let{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}};var _l="vs",yd="fs";function kt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var Ey={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function j1(s){let e={};for(let t in s){let i=s[t],n=fN(i);e[t]=n}return e}function fN(s){let e=W1(s);return e==="object"?s?"type"in s?Object.assign({},s,Ey[s.type]):"value"in s?(e=W1(s.value),Object.assign({type:e},s,Ey[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},Ey[e])}function W1(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var pN="vs",gN="fs",Sd=class{constructor({name:e,vs:t,fs:i,dependencies:n=[],uniforms:o,getUniforms:a,deprecations:l=[],defines:u={},inject:c={},vertexShader:h,fragmentShader:d}){kt(typeof e=="string"),this.name=e,this.vs=t||h,this.fs=i||d,this.getModuleUniforms=a,this.dependencies=n,this.deprecations=this._parseDeprecationDefinitions(l),this.defines=u,this.injections=mN(c),o&&(this.uniforms=j1(o))}getModuleSource(e){let t;switch(e){case pN:t=this.vs||"";break;case gN:t=this.fs||"";break;default:kt(!1)}return`#define MODULE_${this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_")}
${t}// END MODULE_${this.name}

`}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),e}_defaultGetUniforms(e={}){let t={},i=this.uniforms;for(let n in i){let o=i[n];n in e&&!o.private?(o.validate&&kt(o.validate(e[n],o),`${this.name}: invalid ${n}`),t[n]=e[n]):t[n]=o.value}return t}};function mN(s){let e={vs:{},fs:{}};for(let t in s){let i=s[t],n=t.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),e[n][t]=i}return e}function q1(s){return bN(Y1(s))}function bN(s){let e={},t={};return X1({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((i,n)=>t[n]-t[i]).map(i=>e[i])}function X1({modules:s,level:e,moduleMap:t,moduleDepth:i}){if(e>=5)throw new Error("Possible loop in shader dependency graph");for(let n of s)t[n.name]=n,(i[n.name]===void 0||i[n.name]<e)&&(i[n.name]=e);for(let n of s)n.dependencies&&X1({modules:n.dependencies,level:e+1,moduleMap:t,moduleDepth:i})}function Y1(s,e){return s.map(t=>(t instanceof Sd||(kt(typeof t!="string",`Shader module use by name is deprecated. Import shader module '${t}' and use it directly.`),kt(t.name,"shader module has no name"),t=new Sd(t),t.dependencies=Y1(t.dependencies)),t))}function xy(s={}){let e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n}var PN=7936,yN=7937,SN=7938,EN=35724,Cy={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},sa={};Object.keys(Cy).forEach(s=>{sa[s]=s});function xN(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function $1(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||PN),i=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||yN);return{gpuVendor:vN(t,i),vendor:t,renderer:i,version:s.getParameter(SN),shadingLanguageVersion:s.getParameter(EN)}}function vN(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var vy={};function Ay(s,e,t={}){let i=Cy[e];if(kt(i,e),!xy(t))return!0;if(e in vy)return vy[e];let n=i[0],o=t.behavior||"enable",a=`#extension GL_${n} : ${o}
void main(void) {}`,l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),vy[e]=u,u}function CN(s,e){let t=Cy[e];kt(t,e);let i=xN(s)&&t[1]||t[0],n=typeof i=="string"?Boolean(s.getExtension(i)):i;return kt(n===!1||n===!0),n}function Ed(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>CN(s,t))}function Z1(s){switch($1(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function Q1(s,e,t){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Ed(s,sa.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Ed(s,sa.GLSL_DERIVATIVES)&&Ay(s,sa.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Ed(s,sa.GLSL_FRAG_DATA)&&Ay(s,sa.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Ed(s,sa.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}var K1=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,J1=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var AN={[_l]:K1,[yd]:J1},xd="__LUMA_INJECT_DECLARATIONS__",eA=/void\s+main\s*\([^)]*\)\s*\{\n?/,tA=/}\n?[^{}]*$/,Ty=[];function pg(s,e,t,i=!1){let n=e===_l;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),Ty.length=a.length;for(let u=0,c=a.length;u<c;++u)Ty[u]=a[u].injection;let l=`${Ty.join(`
`)}
`;switch(o){case"vs:#decl":n&&(s=s.replace(xd,l));break;case"vs:#main-start":n&&(s=s.replace(eA,u=>u+l));break;case"vs:#main-end":n&&(s=s.replace(tA,u=>l+u));break;case"fs:#decl":n||(s=s.replace(xd,l));break;case"fs:#main-start":n||(s=s.replace(eA,u=>u+l));break;case"fs:#main-end":n||(s=s.replace(tA,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(xd,""),i&&(s=s.replace(/\}\s*$/,o=>o+AN[e])),s}function fc(s){let e={};return kt(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let i in t)e[i]=e[i]?`${e[i]}
${t[i]}`:t[i]}),e}function pc(s){return new RegExp(`\\b${s}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}var rA=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],TN=[...rA,[pc("attribute"),"in $1"],[pc("varying"),"out $1"]],IN=[...rA,[pc("varying"),"in $1"]],iA=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],wN=[...iA,[pc("in"),"attribute $1"],[pc("out"),"varying $1"]],LN=[...iA,[pc("in"),"varying $1"]],Iy="gl_FragColor",wy=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,ON=/void\s+main\s*\([^)]*\)\s*\{\n?/;function Ly(s,e,t){switch(e){case 300:return t?gg(s,TN):RN(s);case 100:return t?gg(s,wN):MN(s);default:throw new Error(`unknown GLSL version ${e}`)}}function gg(s,e){for(let[t,i]of e)s=s.replace(t,i);return s}function RN(s){s=gg(s,IN);let e=s.match(wy);if(e){let t=e[1];s=s.replace(new RegExp(`\\b${Iy}\\b`,"g"),t)}else{let t="fragmentColor";s=s.replace(ON,i=>`out vec4 ${t};
${i}`).replace(new RegExp(`\\b${Iy}\\b`,"g"),t)}return s}function MN(s){s=gg(s,LN);let e=s.match(wy);if(e){let t=e[1];s=s.replace(wy,"").replace(new RegExp(`\\b${t}\\b`,"g"),Iy)}return s}var _N=`

${xd}

`,oA={[_l]:"vertex",[yd]:"fragment"},BN=`precision highp float;

`;function Oy(s,e){let{vs:t,fs:i}=e,n=q1(e.modules||[]);return{gl:s,vs:nA(s,Object.assign({},e,{source:t,type:_l,modules:n})),fs:nA(s,Object.assign({},e,{source:i,type:yd,modules:n})),getUniforms:NN(n)}}function nA(s,{id:e,source:t,type:i,modules:n,defines:o={},hookFunctions:a=[],inject:l={},transpileToGLSL100:u=!1,prologue:c=!0,log:h}){kt(typeof t=="string","shader source must be a string");let d=i===_l,f=t.split(`
`),P=100,E="",v=t;f[0].indexOf("#version ")===0?(P=300,E=f[0],v=f.slice(1).join(`
`)):E=`#version ${P}`;let L={};n.forEach($=>{Object.assign(L,$.getDefines())}),Object.assign(L,o);let O=c?`${E}
${FN({id:e,source:t,type:i})}
${DN({type:i})}
${Z1(s)}
${Q1(s,P,!d)}
${GN(L)}
${d?"":BN}
`:`${E}
`,D=kN(a),_={},F={},X={};for(let $ in l){let se=typeof l[$]=="string"?{injection:l[$],order:0}:l[$],ie=$.match(/^(v|f)s:(#)?([\w-]+)$/);if(ie){let oe=ie[2],ue=ie[3];oe?ue==="decl"?F[$]=[se]:X[$]=[se]:_[$]=[se]}else X[$]=[se]}for(let $ of n){h&&$.checkDeprecations(v,h),O+=$.getModuleSource(i,P);let ie=$.injections[i];for(let oe in ie){let ue=oe.match(/^(v|f)s:#([\w-]+)$/);if(ue){let ve=ue[2]==="decl"?F:X;ve[oe]=ve[oe]||[],ve[oe].push(ie[oe])}else _[oe]=_[oe]||[],_[oe].push(ie[oe])}}return O+=_N,O=pg(O,i,F),O+=VN(D[i],_),O+=v,O=pg(O,i,X),O=Ly(O,u?100:P,d),O}function NN(s){return function(t){let i={};for(let n of s){let o=n.getUniforms(t,i);Object.assign(i,o)}return i}}function DN({type:s}){return`
#define SHADER_TYPE_${oA[s].toUpperCase()}
`}function FN({id:s,source:e,type:t}){return s&&typeof s=="string"&&e.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${s}_${oA[t]}

`:""}function GN(s={}){let e=0,t="";for(let i in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let n=s[i];(n||Number.isFinite(n))&&(t+=`#define ${i.toUpperCase()} ${s[i]}
`)}return e===0&&(t+=`
`),t}function VN(s,e){let t="";for(let i in s){let n=s[i];if(t+=`void ${n.signature} {
`,n.header&&(t+=`  ${n.header}`),e[i]){let o=e[i];o.sort((a,l)=>a.order-l.order);for(let a of o)t+=`  ${a.injection}
`}n.footer&&(t+=`  ${n.footer}`),t+=`}
`}return t}function kN(s){let e={vs:{},fs:{}};return s.forEach(t=>{let i;typeof t!="string"?(i=t,t=i.hook):i={},t=t.trim();let[n,o]=t.split(":"),a=t.replace(/\(.+/,"");e[n][a]=Object.assign(i,{signature:o})}),e}var UN="void main() {gl_FragColor = vec4(0);}",sA=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,zN=`#version 300 es
${sA}`;function mg(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[i,n,o]=t;if(!e.includes(i)||!n||!o)return null;let a=o.split(";")[0];return{qualifier:i,type:n,name:a}}function vd(s={}){let{version:e=100,input:t,inputType:i,output:n}=s;if(!t)return e===300?zN:e>300?`#version ${e}
${sA}`:UN;let o=aA(t,i);return e>=300?`#version ${e} ${e===300?"es":""}
in ${i} ${t};
out vec4 ${n};
void main() {
  ${n} = ${o};
}`:`varying ${i} ${t};
void main() {
  gl_FragColor = ${o};
}`}function Ry(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return kt(!1),null}}function My(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return kt(!1),null}}function aA(s,e){switch(e){case"float":return`vec4(${s}, 0.0, 0.0, 1.0)`;case"vec2":return`vec4(${s}, 0.0, 1.0)`;case"vec3":return`vec4(${s}, 1.0)`;case"vec4":return s;default:return kt(!1),null}}var HN=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,bg={name:"fp32",vs:HN,fs:null};var WN=new Uint8Array([0,255,255,255]),jN={pickingSelectedColor:null,pickingHighlightColor:WN,pickingActive:!1,pickingAttribute:!1};function qN(s=jN){let e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,i=>i/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var XN=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,YN=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,gc={name:"picking",vs:XN,fs:YN,getUniforms:qN};var $N=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,_y={name:"transform",vs:$N,fs:null};var tn=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new tn(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(e={}){let{vs:t="",fs:i="",defines:n={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(i),f=c.map(_=>this._getHash(_.name)).sort(),P=a.map(_=>this._getHash(_)),E=Object.keys(n).sort(),v=Object.keys(o).sort(),L=[],O=[];for(let _ of E)L.push(this._getHash(_)),L.push(this._getHash(n[_]));for(let _ of v)O.push(this._getHash(_)),O.push(this._getHash(o[_]));let D=`${h}/${d}D${L.join("/")}M${f.join("/")}I${O.join("/")}V${P.join("/")}H${this.stateHash}B${l}${u?"T":""}`;if(!this._programCache[D]){let _=Oy(this.gl,{vs:t,fs:i,modules:c,inject:o,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[D]=new ia(this.gl,{hash:D,vs:_.vs,fs:_.fs,varyings:a,bufferMode:l}),this._getUniforms[D]=_.getUniforms||(F=>{}),this._useCounts[D]=0}return this._useCounts[D]++,this._programCache[D]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(e=[]){let t=new Array(this._defaultModules.length+e.length),i={},n=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[n++]=l,i[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;i[u]||(t[n++]=l,i[u]=!0)}return t.length=n,t}};var ZN={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function lA(s,e,t){let i={},n=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=QN(o,t);if(o==="indices")n=a;else if(a.constant)i[l]=a.value;else{let u=a.value,c={...a};delete c.value,i[l]=[new pe(s,u),c],KN(o,c)}}if(n){let o=n.value||n;Y(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:n.isIndexed===void 0?!0:n.isIndexed};i.indices=[new pe(s,{data:o,target:34963}),a]}return i}function QN(s,e){let{attributeMap:t=ZN}=e||{};return t&&t[s]||s}function KN(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}Y(Number.isFinite(e.size),`attribute ${s} needs size`)}var mc=2,JN=1e4,eD="Model needs drawMode and vertexCount",uA=()=>{},tD={},Hr=class{constructor(e,t={}){let{id:i=oi("model")}=t;Y(is(e)),this.id=i,this.gl=e,this.id=t.id||oi("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||tn.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},Y(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),eD)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return Y(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return Y(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=lA(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(e={}){if(yo(e))return this;let t={};for(let i in e){let n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(e={}){return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return ea(this.program.gl,e),this}draw(e={}){this._checkProgram();let{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(n);let c;ee.priority>=mc&&(c=this._logDrawCallStart(mc));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:f=h.indexType,indexOffset:P=h.indexOffset,vertexArrayInstanced:E=h.isInstanced}=this.props;E&&!this.isInstanced&&ee.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:v,instanceCount:L}=this,{onBeforeRender:O=uA,onAfterRender:D=uA}=this.props;O(),this.program.setUniforms(this.uniforms);let _=this.program.draw(Object.assign(tD,e,{logPriority:c,uniforms:null,framebuffer:i,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:f,isInstanced:v,instanceCount:L,offset:d?P:0}));return D(),ee.priority>=mc&&this._logDrawCallEnd(c,u,i),_}transform(e={}){let{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e,{parameters:o}=e;i&&this._setFeedbackBuffers(i),t&&(o=Object.assign({},o,{[35977]:t})),n.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{n.forEach(a=>a.vertexArray.bindBuffers())}return this}render(e={}){return ee.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}Y(t instanceof ia,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Pd(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof pe&&t.delete()}}_setAnimationProps(e){this.animated&&Y(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(e={}){if(yo(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new oa(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:JN;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),ee.group(mc,`>>> DRAWING MODEL ${this.id}`,{collapsed:ee.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(e===void 0)return;let o=yy({vertexArray:t,header:`${this.id} attributes`,attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=fg({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:c,count:h}=fg({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});h>0&&ee.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&ee.log("UNUSED UNIFORMS",Object.keys(l))();let d=Sy(this.vertexArray.configuration);ee.table(e,o)(),ee.table(e,a)(),ee.table(e+1,d)(),n&&n.log({logLevel:mc,message:`Rendered to ${n.id}`}),ee.groupEnd(mc,`>>> DRAWING MODEL ${this.id}`)()}};var Pg=class{constructor(e,t={}){this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(e={}){let{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(e={}){let t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof pe?i:i.buffer:null}getData(e={}){let{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(e={}){this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&Y(ce(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let n in this.feedbackMap){let o=this.feedbackMap[n];n in t&&(i[o]=n)}Object.assign(i,e.feedbackBuffers);for(let n in i){let o=i[n];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;i[n]=this._createNewBuffer(n,{byteLength:l,usage:u,accessor:c})}}return i}_setupBuffers(e={}){let{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,{model:t}){let{program:i}=t;e.transformFeedback=new oa(this.gl,{program:i,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:i})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(let n in this.feedbackMap){let o=this.feedbackMap[n];t[n]=e.feedbackBuffers[o],i[o]=e.sourceBuffers[n],Y(i[o]instanceof pe)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){let i=new pe(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}};var rD="transform_uSampler_",yg="transform_uSize_",cA="transform_position";function hA({vs:s,sourceTextureMap:e,targetTextureVarying:t,targetTexture:i}){let o=Object.keys(e).length,a=null,l={},u=s,c={};if(o>0||t){let h=u.split(`
`),d=h.slice();if(h.forEach((f,P,E)=>{if(o>0){let v=sD(f,e);if(v){let{updatedLine:L,inject:O}=v;d[P]=L,c=fc([c,O]),Object.assign(l,v.samplerTextureMap),o--}}t&&!a&&(a=oD(f,t))}),t){Y(i);let f=`${yg}${t}`,P=`uniform vec2 ${f};
`,E=`     vec2 ${cA} = transform_getPos(${f});
     gl_Position = vec4(${cA}, 0, 1.);
`;c=fc([c,{"vs:#decl":P,"vs:#main-start":E}])}u=d.join(`
`)}return{vs:u,targetTextureType:a,inject:c,samplerTextureMap:l}}function dA({sourceTextureMap:s,targetTextureVarying:e,targetTexture:t}){let i={},n,o;e&&({width:n,height:o}=t,i[`${yg}${e}`]=[n,o]);for(let a in s)({width:n,height:o}=s[a]),i[`${yg}${a}`]=[n,o];return i}function iD(s){return mg(s,["attribute","in"])}function nD(s){let e=`${rD}${s}`,t=`${yg}${s}`,i=`  uniform sampler2D ${e};
  uniform vec2 ${t};`;return{samplerName:e,sizeName:t,uniformDeclerations:i}}function oD(s,e){let t=mg(s,["varying","out"]);return t&&t.name===e?t.type:null}function sD(s,e){let t={},i=iD(s);if(!i)return null;let{type:n,name:o}=i;if(o&&e[o]){let a=`// ${s} => Replaced by Transform with a sampler`,{samplerName:l,sizeName:u,uniformDeclerations:c}=nD(o),h=Ry(n),d=`  ${n} ${o} = transform_getInput(${l}, ${u}).${h};
`;return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var aD={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},lD="transform_output",Sg=class{constructor(e,t={}){this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(e={}){let t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(e={}){let{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let f=this.samplerTextureMap[d];l[d]=i[f]}this._setSourceTextureParameters();let h=dA({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,n.width,n.height]),{attributes:a,framebuffer:n,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData({packed:e=!1}={}){let{framebuffer:t}=this.bindings[this.currentIndex],i=os(t);if(!e)return i;let n=i.constructor,o=My(this.targetTextureType),a=new n(i.length*o/4),l=0;for(let u=0;u<i.length;u+=4)for(let c=0;c<o;c++)a[l++]=i[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(e={}){let{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Xe)return i;let n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(e={}){let{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,o=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((i,n,o)=>{o[n]=n}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new pe(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:i})}}_updateBinding(e,t){let{sourceBuffers:i,sourceTextures:n,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new _e(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let i in t)t[i].setParameters(aD)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let i=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:i}}_createNewTexture(e){let t=uc(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(e={}){let{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=hA({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),c=fc([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||vd({version:cc(n),input:this.targetTextureVarying,inputType:a,output:lD}),d=this.hasSourceTextures||this.targetTextureVarying?[_y].concat(e.modules||[]):e.modules;return{vs:n,fs:h,modules:d,uniforms:o,inject:c}}};var rn=class{static isSupported(e){return ce(e)}constructor(e,t={}){this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(e={}){let{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)e=e||i.swap();Y(e,"Nothing to swap")}getBuffer(e=null){return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(e={}){let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t){let n=i.getData(e);if(n)return n}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(e={}){"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)i.update(e)}_initialize(e={}){let{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new Hr(t,Object.assign({},e,{fs:e.fs||vd({version:cc(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=n.updateModelProps(t);return t}_buildResourceTransforms(e,t){uD(t)&&(this.bufferTransform=new Pg(e,t)),cD(t)&&(this.textureTransform=new Sg(e,t)),Y(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=Object.assign(t,n.getDrawOptions(t));return t}};function uD(s){return!!(!yo(s.feedbackBuffers)||!yo(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function cD(s){return!!(!yo(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var fA={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},nn=class{static get DRAW_MODE(){return fA}constructor(e={}){let{id:t=oi("geometry"),drawMode:i=fA.TRIANGLES,attributes:n={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(n,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let i in e){let n=e[i];n=ArrayBuffer.isView(n)?{value:n}:n,Y(ArrayBuffer.isView(n.value),`${this._print(i)}: must be typed array or object with value as typed array`),(i==="POSITION"||i==="positions")&&!n.size&&(n.size=3),i==="indices"?(Y(!this.indices),this.indices=n):this.attributes[i]=n}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let n in e){let o=e[n],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(i=Math.min(i,a.length/l))}return Y(Number.isFinite(i)),i}};var hD=1,dD=1,Bl=class{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){let{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:o=1}=e,a=hD++,l={time:0,delay:t,duration:i,rate:n,repeat:o};return this._setChannelTime(l,this.time),this.channels.set(a,l),a}removeChannel(e){this.channels.delete(e);for(let[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;let t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);let t=this.channels.values();for(let n of t)this._setChannelTime(n,this.time);let i=this.animations.values();for(let n of i){let{animation:o,channel:a}=n;o.setTime(this.getTime(a))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=dD++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay,n=e.duration*e.repeat;i>=n?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}};var pA="#define SMOOTH_EDGE_RADIUS 0.5",gD=`
`.concat(pA,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),mD=`
`.concat(pA,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),gA={name:"geometry",vs:gD,fs:mD};var Ve={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Ve,"IDENTITY",{get:()=>(he.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var di={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},on={common:0,meters:1,pixels:2},By={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},On={DRAW:"draw",MASK:"mask"};var bD=Object.keys(Ve).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Ve[s],";")).join(""),PD=Object.keys(di).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(di[s],";")).join(""),yD=Object.keys(on).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(on[s],";")).join(""),mA="".concat(bD,`
`).concat(PD,`
`).concat(yD,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      float y = clamp(geometry.worldPosition.y, -89.9, 89.9);
      return 1.0 / cos(radians(y));
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}
//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size(position_world.z),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);var aa=1e-6,So=typeof Float32Array<"u"?Float32Array:Array;var R0e=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function SD(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function bA(s,e){if(s===e){var t=e[1],i=e[2],n=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=i,s[9]=o,s[11]=e[14],s[12]=n,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function Cd(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],P=e[11],E=e[12],v=e[13],L=e[14],O=e[15],D=t*l-i*a,_=t*u-n*a,F=t*c-o*a,X=i*u-n*l,$=i*c-o*l,se=n*c-o*u,ie=h*v-d*E,oe=h*L-f*E,ue=h*O-P*E,Se=d*L-f*v,ve=d*O-P*v,Ce=f*O-P*L,De=D*Ce-_*ve+F*Se+X*ue-$*oe+se*ie;return De?(De=1/De,s[0]=(l*Ce-u*ve+c*Se)*De,s[1]=(n*ve-i*Ce-o*Se)*De,s[2]=(v*se-L*$+O*X)*De,s[3]=(f*$-d*se-P*X)*De,s[4]=(u*ue-a*Ce-c*oe)*De,s[5]=(t*Ce-n*ue+o*oe)*De,s[6]=(L*F-E*se-O*_)*De,s[7]=(h*se-f*F+P*_)*De,s[8]=(a*ve-l*ue+c*ie)*De,s[9]=(i*ue-t*ve-o*ie)*De,s[10]=(E*$-v*F+O*D)*De,s[11]=(d*F-h*$-P*D)*De,s[12]=(l*oe-a*Se-u*ie)*De,s[13]=(t*Se-i*oe+n*ie)*De,s[14]=(v*_-E*X-L*D)*De,s[15]=(h*X-d*_+f*D)*De,s):null}function PA(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],f=s[11],P=s[12],E=s[13],v=s[14],L=s[15],O=e*a-t*o,D=e*l-i*o,_=e*u-n*o,F=t*l-i*a,X=t*u-n*a,$=i*u-n*l,se=c*E-h*P,ie=c*v-d*P,oe=c*L-f*P,ue=h*v-d*E,Se=h*L-f*E,ve=d*L-f*v;return O*ve-D*Se+_*ue+F*oe-X*ie+$*se}function Eo(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],P=e[10],E=e[11],v=e[12],L=e[13],O=e[14],D=e[15],_=t[0],F=t[1],X=t[2],$=t[3];return s[0]=_*i+F*l+X*d+$*v,s[1]=_*n+F*u+X*f+$*L,s[2]=_*o+F*c+X*P+$*O,s[3]=_*a+F*h+X*E+$*D,_=t[4],F=t[5],X=t[6],$=t[7],s[4]=_*i+F*l+X*d+$*v,s[5]=_*n+F*u+X*f+$*L,s[6]=_*o+F*c+X*P+$*O,s[7]=_*a+F*h+X*E+$*D,_=t[8],F=t[9],X=t[10],$=t[11],s[8]=_*i+F*l+X*d+$*v,s[9]=_*n+F*u+X*f+$*L,s[10]=_*o+F*c+X*P+$*O,s[11]=_*a+F*h+X*E+$*D,_=t[12],F=t[13],X=t[14],$=t[15],s[12]=_*i+F*l+X*d+$*v,s[13]=_*n+F*u+X*f+$*L,s[14]=_*o+F*c+X*P+$*O,s[15]=_*a+F*h+X*E+$*D,s}function xg(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,f,P,E,v,L,O;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],P=e[7],E=e[8],v=e[9],L=e[10],O=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=P,s[8]=E,s[9]=v,s[10]=L,s[11]=O,s[12]=a*i+h*n+E*o+e[12],s[13]=l*i+d*n+v*o+e[13],s[14]=u*i+f*n+L*o+e[14],s[15]=c*i+P*n+O*o+e[15]),s}function vg(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function yA(s,e,t,i){var n=i[0],o=i[1],a=i[2],l=Math.hypot(n,o,a),u,c,h,d,f,P,E,v,L,O,D,_,F,X,$,se,ie,oe,ue,Se,ve,Ce,De,Cr;return l<aa?null:(l=1/l,n*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],f=e[1],P=e[2],E=e[3],v=e[4],L=e[5],O=e[6],D=e[7],_=e[8],F=e[9],X=e[10],$=e[11],se=n*n*h+c,ie=o*n*h+a*u,oe=a*n*h-o*u,ue=n*o*h-a*u,Se=o*o*h+c,ve=a*o*h+n*u,Ce=n*a*h+o*u,De=o*a*h-n*u,Cr=a*a*h+c,s[0]=d*se+v*ie+_*oe,s[1]=f*se+L*ie+F*oe,s[2]=P*se+O*ie+X*oe,s[3]=E*se+D*ie+$*oe,s[4]=d*ue+v*Se+_*ve,s[5]=f*ue+L*Se+F*ve,s[6]=P*ue+O*Se+X*ve,s[7]=E*ue+D*Se+$*ve,s[8]=d*Ce+v*De+_*Cr,s[9]=f*Ce+L*De+F*Cr,s[10]=P*Ce+O*De+X*Cr,s[11]=E*Ce+D*De+$*Cr,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function SA(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+f*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=f*n-u*i,s}function EA(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n-c*i,s[1]=a*n-h*i,s[2]=l*n-d*i,s[3]=u*n-f*i,s[8]=o*i+c*n,s[9]=a*i+h*n,s[10]=l*i+d*n,s[11]=u*i+f*n,s}function xA(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+f*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=f*n-u*i,s}function vA(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,P=n*l,E=n*u,v=o*a,L=o*l,O=o*u;return s[0]=1-d-E,s[1]=h+O,s[2]=f-L,s[3]=0,s[4]=h-O,s[5]=1-c-E,s[6]=P+v,s[7]=0,s[8]=f+L,s[9]=P-v,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function CA(s,e,t,i,n,o,a){var l=1/(t-e),u=1/(n-i),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(n+i)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function ED(s,e,t,i,n){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,n!=null&&n!==1/0?(a=1/(i-n),s[10]=(n+i)*a,s[14]=2*n*i*a):(s[10]=-1,s[14]=-2*i),s}var AA=ED;function xD(s,e,t,i,n,o,a){var l=1/(e-t),u=1/(i-n),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+i)*u,s[14]=(a+o)*c,s[15]=1,s}var TA=xD;function IA(s,e,t,i){var n,o,a,l,u,c,h,d,f,P,E=e[0],v=e[1],L=e[2],O=i[0],D=i[1],_=i[2],F=t[0],X=t[1],$=t[2];return Math.abs(E-F)<aa&&Math.abs(v-X)<aa&&Math.abs(L-$)<aa?SD(s):(h=E-F,d=v-X,f=L-$,P=1/Math.hypot(h,d,f),h*=P,d*=P,f*=P,n=D*f-_*d,o=_*h-O*f,a=O*d-D*h,P=Math.hypot(n,o,a),P?(P=1/P,n*=P,o*=P,a*=P):(n=0,o=0,a=0),l=d*a-f*o,u=f*n-h*a,c=h*o-d*n,P=Math.hypot(l,u,c),P?(P=1/P,l*=P,u*=P,c*=P):(l=0,u=0,c=0),s[0]=n,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=f,s[11]=0,s[12]=-(n*E+o*v+a*L),s[13]=-(l*E+u*v+c*L),s[14]=-(h*E+d*v+f*L),s[15]=1,s)}function vD(){var s=new So(4);return So!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Nl(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}var M0e=function(){var s=vD();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();function CD(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}return!1}function la(s){let e={},t;return i=>{for(let n in i)if(!CD(i[n],e[n])){t=s(i),e=i;break}return t}}var LA=[0,0,0,0],AD=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],OA=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],TD=[0,0,0],RA=[0,0,0],ID=la(LD);function Fy(s,e,t=RA){t.length<3&&(t=[t[0],t[1],0]);let i=t,n,o=!0;switch(e===Ve.LNGLAT_OFFSETS||e===Ve.METER_OFFSETS?n=t:n=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case di.WEB_MERCATOR:(e===Ve.LNGLAT||e===Ve.CARTESIAN)&&(n=[0,0,0],o=!1);break;case di.WEB_MERCATOR_AUTO_OFFSET:e===Ve.LNGLAT?i=n:e===Ve.CARTESIAN&&(i=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],n=s.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case di.IDENTITY:i=s.position.map(Math.fround),i[2]=i[2]||0;break;case di.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:i,offsetMode:o}}function wD(s,e,t){let{viewMatrixUncentered:i,projectionMatrix:n}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=LA,u=LA,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:f}=Fy(s,e,t);return f&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=Nl([],u,a),o=i||o,a=Eo([],n,o),a=Eo([],a,AD)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function MA({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Ve.DEFAULT,coordinateOrigin:n=RA,autoWrapLongitude:o=!1}){i===Ve.DEFAULT&&(i=s.isGeospatial?Ve.LNGLAT:Ve.CARTESIAN);let a=ID({viewport:s,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||OA,a}function LD({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){let{projectionCenter:n,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=wD(s,t,i),h=s.getDistanceScales(),d=[s.width*e,s.height*e],f=Nl([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,P={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:n,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:TD,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:OA,project_uCameraPosition:l};if(c){let E=s.getDistanceScales(c);switch(t){case Ve.METER_OFFSETS:P.project_uCommonUnitsPerWorldUnit=E.unitsPerMeter,P.project_uCommonUnitsPerWorldUnit2=E.unitsPerMeter2;break;case Ve.LNGLAT:case Ve.LNGLAT_OFFSETS:s._pseudoMeters||(P.project_uCommonUnitsPerMeter=E.unitsPerMeter),P.project_uCommonUnitsPerWorldUnit=E.unitsPerDegree,P.project_uCommonUnitsPerWorldUnit2=E.unitsPerDegree2;break;case Ve.CARTESIAN:P.project_uCommonUnitsPerWorldUnit=[1,1,E.unitsPerMeter[2]],P.project_uCommonUnitsPerWorldUnit2=[0,0,E.unitsPerMeter2[2]];break;default:break}}return P}var OD={};function RD(s=OD){return"viewport"in s?MA(s):{}}var Dl={name:"project",dependencies:[bg,gA],vs:mA,getUniforms:RD};var MD=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,xo={name:"project32",dependencies:[Dl],vs:MD};function Cg(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var j0e=1/Math.PI*180,q0e=1/180*Math.PI,fr={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function Gy(s,{precision:e=fr.precision}={}){return s=_D(s),"".concat(parseFloat(s.toPrecision(e)))}function as(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function It(s,e,t){return ND(s,i=>Math.max(e,Math.min(t,i)))}function Fl(s,e,t){return as(s)?s.map((i,n)=>Fl(i,e[n],t)):t*e+(1-t)*s}function Rn(s,e,t){let i=fr.EPSILON;t&&(fr.EPSILON=t);try{if(s===e)return!0;if(as(s)&&as(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!Rn(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=fr.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{fr.EPSILON=i}}function _D(s){return Math.round(s/fr.EPSILON)*fr.EPSILON}function BD(s){return s.clone?s.clone():new Array(s.length)}function ND(s,e,t){if(as(s)){let i=s;t=t||BD(i);for(let n=0;n<t.length&&n<i.length;++n)t[n]=e(s[n],n,t);return t}return e(s)}function DD(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var bc=class extends DD(Array){clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:as(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(fr)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+Gy(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Rn(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(i===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){let o=e[n];this[n]=o+i*(t[n]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(fr.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}};function FD(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Wr(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function Ag(s,e,t=""){if(fr.debug&&!FD(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var Tg=class extends bc{get x(){return this[0]}set x(e){this[0]=Wr(e)}get y(){return this[1]}set y(e){this[1]=Wr(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let n=this[i]-e[i];t+=n*n}return Wr(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return Wr(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Cg(e>=0&&e<this.ELEMENTS,"index is out of range"),Wr(this[e])}setComponent(e,t){return Cg(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};function GD(){var s=new So(2);return So!=Float32Array&&(s[0]=0,s[1]=0),s}function Pc(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function Ig(s,e){return s[0]=-e[0],s[1]=-e[1],s}function _A(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[4]*n+t[12],s[1]=t[1]*i+t[5]*n+t[13],s}var rye=function(){var s=GD();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function BA(s,e,t){let i=e[0],n=e[1],o=t[3]*i+t[7]*n||1;return s[0]=(t[0]*i+t[4]*n)/o,s[1]=(t[1]*i+t[5]*n)/o,s}function wg(s,e,t){let i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o||1;return s[0]=(t[0]*i+t[4]*n+t[8]*o)/a,s[1]=(t[1]*i+t[5]*n+t[9]*o)/a,s[2]=(t[2]*i+t[6]*n+t[10]*o)/a,s}function NA(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s}function VD(){var s=new So(3);return So!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function kD(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function UD(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function DA(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=n*u-o*l,s[1]=o*a-i*u,s[2]=i*l-n*a,s}function Lg(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,s[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,s[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,s}function FA(s,e,t){var i=e[0],n=e[1],o=e[2];return s[0]=i*t[0]+n*t[3]+o*t[6],s[1]=i*t[1]+n*t[4]+o*t[7],s[2]=i*t[2]+n*t[5]+o*t[8],s}function GA(s,e,t){var i=t[0],n=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=n*c-o*u,d=o*l-i*c,f=i*u-n*l,P=n*f-o*d,E=o*h-i*f,v=i*d-n*h,L=a*2;return h*=L,d*=L,f*=L,P*=2,E*=2,v*=2,s[0]=l+h+P,s[1]=u+d+E,s[2]=c+f+v,s}function VA(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function kA(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function UA(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function zA(s,e){var t=s[0],i=s[1],n=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+i*i+n*n),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&UD(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var HA=kD;var nye=function(){var s=VD();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var Uy=[0,0,0],Og,pr=class extends Tg{static get ZERO(){return Og||(Og=new pr(0,0,0),Object.freeze(Og)),Og}constructor(e=0,t=0,i=0){super(-0,-0,-0);arguments.length===1&&as(e)?this.copy(e):(fr.debug&&(Wr(e),Wr(t),Wr(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return fr.debug&&(Wr(e.x),Wr(e.y),Wr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Wr(e)}angle(e){return zA(this,e)}cross(e){return DA(this,this,e),this.check()}rotateX({radians:e,origin:t=Uy}){return VA(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Uy}){return kA(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Uy}){return UA(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Lg(this,this,e),this.check()}transformAsVector(e){return wg(this,this,e),this.check()}transformByMatrix3(e){return FA(this,this,e),this.check()}transformByMatrix2(e){return NA(this,this,e),this.check()}transformByQuaternion(e){return GA(this,this,e),this.check()}};var Rg=class extends bc{toString(){let e="[";if(fr.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=Wr(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[i+n];return t}setColumn(e,t){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)this[i+n]=t[n];return this}};var Wy;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(Wy||(Wy={}));var zD=45*Math.PI/180,HD=1,zy=.1,Hy=500,WD=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),qt=class extends Rg{static get IDENTITY(){return qD()}static get ZERO(){return jD()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Wy}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,o,a,l,u,c,h,d,f,P,E,v,L){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=f,this[12]=P,this[13]=E,this[14]=v,this[15]=L,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c,h,d,f,P,E,v,L){return this[0]=e,this[1]=o,this[2]=c,this[3]=P,this[4]=t,this[5]=a,this[6]=h,this[7]=E,this[8]=i,this[9]=l,this[10]=d,this[11]=v,this[12]=n,this[13]=u,this[14]=f,this[15]=L,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(WD)}fromObject(e){return this.check()}fromQuaternion(e){return vA(this,e),this.check()}frustum(e){let{left:t,right:i,bottom:n,top:o,near:a=zy,far:l=Hy}=e;return l===1/0?XD(this,t,i,n,o,a):CA(this,t,i,n,o,a,l),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:n=[0,1,0]}=e;return IA(this,t,i,n),this.check()}ortho(e){let{left:t,right:i,bottom:n,top:o,near:a=zy,far:l=Hy}=e;return TA(this,t,i,n,o,a,l),this.check()}orthographic(e){let{fovy:t=zD,aspect:i=HD,focalDistance:n=1,near:o=zy,far:a=Hy}=e;WA(t);let l=t/2,u=n*Math.tan(l),c=u*i;return this.ortho({left:-c,right:c,bottom:-u,top:u,near:o,far:a})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:o=500}=e;return WA(t),AA(this,t,i,n,o),this.check()}determinant(){return PA(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*n,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*n,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return bA(this,this),this.check()}invert(){return Cd(this,this),this.check()}multiplyLeft(e){return Eo(this,e,this),this.check()}multiplyRight(e){return Eo(this,this,e),this.check()}rotateX(e){return SA(this,this,e),this.check()}rotateY(e){return EA(this,this,e),this.check()}rotateZ(e){return xA(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return yA(this,this,e,t),this.check()}scale(e){return vg(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return xg(this,this,e),this.check()}transform(e,t){return e.length===4?(t=Nl(t||[-0,-0,-0,-0],e,this),Ag(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:i}=e,n;switch(i){case 2:n=_A(t||[-0,-0],e,this);break;case 3:n=Lg(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ag(n,e.length),n}transformAsVector(e,t){let i;switch(e.length){case 2:i=BA(t||[-0,-0],e,this);break;case 3:i=wg(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ag(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}},Mg,_g;function jD(){return Mg||(Mg=new qt([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Mg)),Mg}function qD(){return _g||(_g=new qt,Object.freeze(_g)),_g}function WA(s){if(s>Math.PI*2)throw Error("expected radians")}function XD(s,e,t,i,n,o){let a=2*o/(t-e),l=2*o/(n-i),u=(t+e)/(t-e),c=(n+i)/(n-i),h=-1,d=-1,f=-2*o;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=l,s[6]=0,s[7]=0,s[8]=u,s[9]=c,s[10]=h,s[11]=d,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}var ls=typeof Float32Array<"u"?Float32Array:Array;var Dye=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function YD(){var s=new ls(4);return ls!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function XA(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function YA(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}var Fye=function(){var s=YD();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();function qy(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ua(s,e){let t=YA([],e,s);return XA(t,t,1/t[3]),t}function Xy(s,e){let t=s%e;return t<0?e+t:t}function Yy(s,e,t){return s<e?e:s>t?t:s}function $D(s){return Math.log(s)*Math.LOG2E}var yc=Math.log2||$D;function $y(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,f,P,E,v,L,O;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],P=e[7],E=e[8],v=e[9],L=e[10],O=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=P,s[8]=E,s[9]=v,s[10]=L,s[11]=O,s[12]=a*i+h*n+E*o+e[12],s[13]=l*i+d*n+v*o+e[13],s[14]=u*i+f*n+L*o+e[14],s[15]=c*i+P*n+O*o+e[15]),s}function $A(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function ZA(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+f*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=f*n-u*i,s}function QA(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+f*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=f*n-u*i,s}function QD(){var s=new ls(2);return ls!=Float32Array&&(s[0]=0,s[1]=0),s}function Bg(s,e,t,i){var n=e[0],o=e[1];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s}var Uye=function(){var s=QD();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function KD(){var s=new ls(3);return ls!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function JA(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}var zye=function(){var s=KD();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();function sn(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var Mn=Math.PI,eT=Mn/4,_n=Mn/180,Zy=180/Mn,Ad=512,Qy=4003e4,Sc=85.051129,tT=1.5;function Ky(s){return yc(s)}function us(s){let[e,t]=s;sn(Number.isFinite(e)),sn(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");let i=e*_n,n=t*_n,o=Ad*(i+Mn)/(2*Mn),a=Ad*(Mn+Math.log(Math.tan(eT+n*.5)))/(2*Mn);return[o,a]}function Fi(s){let[e,t]=s,i=e/Ad*(2*Mn)-Mn,n=2*(Math.atan(Math.exp(t/Ad*(2*Mn)-Mn))-eT);return[i*Zy,n*Zy]}function Jy(s){let{latitude:e}=s;sn(Number.isFinite(e));let t=Math.cos(e*_n);return Ky(Qy*t)-9}function Ec(s){let{latitude:e,longitude:t,highPrecision:i=!1}=s;sn(Number.isFinite(e)&&Number.isFinite(t));let n=Ad,o=Math.cos(e*_n),a=n/360,l=a/o,u=n/Qy/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[a,l,u],degreesPerUnit:[1/a,1/l,1/u]};if(i){let h=_n*Math.tan(e*_n)/o,d=a*h/2,f=n/Qy*h,P=f/l*u;c.unitsPerDegree2=[0,d,f],c.unitsPerMeter2=[P,0,P]}return c}function Td(s,e){let[t,i,n]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Ec({longitude:t,latitude:i,highPrecision:!0}),h=us(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=Fi(h),f=(n||0)+(l||0);return Number.isFinite(n)||Number.isFinite(l)?[d[0],d[1],f]:d}function Ng(s){let{height:e,pitch:t,bearing:i,altitude:n,scale:o,center:a}=s,l=qy();$y(l,l,[0,0,-n]),ZA(l,l,-t*_n),QA(l,l,i*_n);let u=o/e;return $A(l,l,[u,u,u]),a&&$y(l,l,JA([],a)),l}function eS(s){let{width:e,height:t,altitude:i,pitch:n=0,nearZMultiplier:o=1,farZMultiplier:a=1}=s,{fovy:l=Gl(tT)}=s;i!==void 0&&(l=Gl(i));let u=.5*l*_n,c=Id(l),h=n*_n,d=Math.sin(u)*c/Math.sin(Math.min(Math.max(Math.PI/2-h-u,.01),Math.PI-.01)),f=Math.sin(h)*d+c;return{fov:2*u,aspect:e/t,focalDistance:c,near:o,far:f*a}}function Gl(s){return 2*Math.atan(.5/s)*Zy}function Id(s){return .5/Math.tan(.5*s*_n)}function xc(s,e){let[t,i,n=0]=s;return sn(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(n)),ua(e,[t,i,n,1])}function vo(s,e,t=0){let[i,n,o]=s;if(sn(Number.isFinite(i)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(o))return ua(e,[i,n,o,1]);let a=ua(e,[i,n,0,1]),l=ua(e,[i,n,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return Bg([],a,l,h)}function Vl(s){let{width:e,height:t,bounds:i,minExtent:n=0,maxZoom:o=24,offset:a=[0,0]}=s,[[l,u],[c,h]]=i,d=eF(s.padding),f=us([l,Yy(h,-Sc,Sc)]),P=us([c,Yy(u,-Sc,Sc)]),E=[Math.max(Math.abs(P[0]-f[0]),n),Math.max(Math.abs(P[1]-f[1]),n)],v=[e-d.left-d.right-Math.abs(a[0])*2,t-d.top-d.bottom-Math.abs(a[1])*2];sn(v[0]>0&&v[1]>0);let L=v[0]/E[0],O=v[1]/E[1],D=(d.right-d.left)/2/L,_=(d.bottom-d.top)/2/O,F=[(P[0]+f[0])/2+D,(P[1]+f[1])/2+_],X=Fi(F),$=Math.min(o,yc(Math.abs(Math.min(L,O))));return sn(Number.isFinite($)),{longitude:X[0],latitude:X[1],zoom:$}}function eF(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(sn(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}var rT=Math.PI/180;function wd(s,e=0){let{width:t,height:i,unproject:n}=s,o={targetZ:e},a=n([0,i],o),l=n([t,i],o),u,c,h=s.fovy?.5*s.fovy*rT:Math.atan(.5/s.altitude),d=(90-s.pitch)*rT;return h>d-.01?(u=iT(s,0,e),c=iT(s,t,e)):(u=n([0,0],o),c=n([t,0],o)),[a,l,c,u]}function iT(s,e,t){let{pixelUnprojectionMatrix:i}=s,n=ua(i,[e,0,1,1]),o=ua(i,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-n[2])/(o[2]-n[2]),u=Bg([],n,o,l),c=Fi(u);return c.push(t),c}var oT=512;function Dg(s){let{width:e,height:t,pitch:i=0}=s,{longitude:n,latitude:o,zoom:a,bearing:l=0}=s;(n<-180||n>180)&&(n=Xy(n+180,360)-180),(l<-180||l>180)&&(l=Xy(l+180,360)-180);let u=yc(t/oT);if(a<=u)a=u,o=0;else{let c=t/2/Math.pow(2,a),h=Fi([0,c])[1];if(o<h)o=h;else{let d=Fi([0,oT-c])[1];o>d&&(o=d)}}return{width:e,height:t,longitude:n,latitude:o,zoom:a,pitch:i,bearing:l}}var iF=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,nF=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,oF=la(cF),sF=la(hF),aF=[0,0,0,1],lF=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function uF(s,e){let[t,i,n]=s,o=vo([t,i,n],e);return Number.isFinite(n)?o:[o[0],o[1],0]}function cF({viewport:s,center:e}){return new qt(s.viewProjectionMatrix).invert().transform(e)}function hF({viewport:s,shadowMatrices:e}){let t=[],i=s.pixelUnprojectionMatrix,n=s.isGeospatial?void 0:1,o=[[0,0,n],[s.width,0,n],[0,s.height,n],[s.width,s.height,n],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(a=>uF(a,i));for(let a of e){let l=a.clone().translate(new pr(s.center).negate()),u=o.map(h=>l.transform(h)),c=new qt().ortho({left:Math.min(...u.map(h=>h[0])),right:Math.max(...u.map(h=>h[0])),bottom:Math.min(...u.map(h=>h[1])),top:Math.max(...u.map(h=>h[1])),near:Math.min(...u.map(h=>-h[2])),far:Math.max(...u.map(h=>-h[2]))});t.push(c.multiplyRight(a))}return t}function dF(s,e){let{shadowEnabled:t=!0}=s;if(!t||!s.shadowMatrices||!s.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};let i={shadow_uDrawShadowMap:Boolean(s.drawToShadowMap),shadow_uUseShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,shadow_uColor:s.shadowColor||aF,shadow_uLightId:s.shadowLightId||0,shadow_uLightCount:s.shadowMatrices.length},n=oF({viewport:s.viewport,center:e.project_uCenter}),o=[],a=sF({shadowMatrices:s.shadowMatrices,viewport:s.viewport}).slice();for(let l=0;l<s.shadowMatrices.length;l++){let u=a[l],c=u.clone().translate(new pr(s.viewport.center).negate());e.project_uCoordinateSystem===Ve.LNGLAT&&e.project_uProjectionMode===di.WEB_MERCATOR?(a[l]=c,o[l]=n):(a[l]=u.clone().multiplyRight(lF),o[l]=c.transform(n))}for(let l=0;l<a.length;l++)i["shadow_uViewProjectionMatrices[".concat(l,"]")]=a[l],i["shadow_uProjectCenters[".concat(l,"]")]=o[l],s.shadowMaps&&s.shadowMaps.length>0?i["shadow_uShadowMap".concat(l)]=s.shadowMaps[l]:i["shadow_uShadowMap".concat(l)]=s.dummyShadowMap;return i}var Ld={name:"shadow",dependencies:[Dl],vs:iF,fs:nF,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(s={},e={})=>"viewport"in s&&(s.drawToShadowMap||s.shadowMaps&&s.shadowMaps.length>0)?dF(s,e):{}};var ca={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...gc};var fF=[Dl],pF=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function sT(s){let e=tn.getDefaultProgramManager(s);for(let t of fF)e.addDefaultModule(t);for(let t of pF)e.addShaderHook(t);return e}var gF=[255,255,255],mF=1,bF=0,tS=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","ambient");let{color:t=gF}=e,{intensity:i=mF}=e;this.id=e.id||"ambient-".concat(bF++),this.color=t,this.intensity=i}};var PF=[255,255,255],yF=1,SF=[0,0,-1],EF=0,Fg=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","directional"),y(this,"direction",void 0),y(this,"shadow",void 0);let{color:t=PF}=e,{intensity:i=yF}=e,{direction:n=SF}=e,{_shadow:o=!1}=e;this.id=e.id||"directional-".concat(EF++),this.color=t,this.intensity=i,this.type="directional",this.direction=new pr(n).normalize().toArray(),this.shadow=o}getProjectedLight(e){return this}};var Gg=class{constructor(e,t={id:"pass"}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"props",void 0);let{id:i}=t;this.id=i,this.gl=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}};var Co=class extends Gg{render(e){let t=this.gl;return ni(t,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){let{target:t,moduleParameters:i,viewports:n,views:o,onViewportActive:a,clearCanvas:l=!0}=e;e.pass=e.pass||"unknown";let u=this.gl;l&&vF(u);let c=[];for(let h of n){let d=o&&o[h.id];a(h);let f=this._getDrawLayerParams(h,e),P=h.subViewports||[h];for(let E of P){let v=this._drawLayersInViewport(u,{target:t,moduleParameters:i,viewport:E,view:d,pass:e.pass,layers:e.layers},f);c.push(v)}}return c}_getDrawLayerParams(e,{layers:t,pass:i,layerFilter:n,effects:o,moduleParameters:a}){let l=[],u=aT(),c={layer:t[0],viewport:e,isPicking:i.startsWith("picking"),renderPass:i},h={};for(let d=0;d<t.length;d++){let f=t[d],P=this._shouldDrawLayer(f,c,n,h),E={shouldDrawLayer:P};P&&(E.layerRenderIndex=u(f,P),E.moduleParameters=this._getModuleParameters(f,o,i,a),E.layerParameters=this.getLayerParameters(f,d,e)),l[d]=E}return l}_drawLayersInViewport(e,{layers:t,moduleParameters:i,pass:n,target:o,viewport:a,view:l},u){let c=xF(e,{moduleParameters:i,target:o,viewport:a});if(l&&l.props.clear){let d=l.props.clear===!0?{color:!0,depth:!0}:l.props.clear;ht(e,{scissorTest:!0,scissor:c},()=>ea(e,d))}let h={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};ni(e,{viewport:c});for(let d=0;d<t.length;d++){let f=t[d],{shouldDrawLayer:P,layerRenderIndex:E,moduleParameters:v,layerParameters:L}=u[d];if(P&&f.props.pickable&&h.pickableCount++,f.isComposite)h.compositeCount++;else if(P){h.visibleCount++,v.viewport=a;try{f._drawLayer({moduleParameters:v,uniforms:{layerIndex:E},parameters:L})}catch(O){f.raiseError(O,"drawing ".concat(f," to ").concat(n))}}}return h}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,n){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let a=e.parent;for(;a;){if(!a.props.visible||!a.filterSubLayer(t))return!1;t.layer=a,a=a.parent}if(i){let l=t.layer.id;if(l in n||(n[l]=i(t)),!n[l])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,i,n){var o;let a=Object.assign(Object.create(((o=e.internalState)===null||o===void 0?void 0:o.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:Ln(this.gl)});if(t)for(let u of t){var l;Object.assign(a,(l=u.getModuleParameters)===null||l===void 0?void 0:l.call(u,e))}return Object.assign(a,this.getModuleParameters(e,t),n)}};function aT(s=0,e={}){let t={},i=(n,o)=>{let a=n.props._offset,l=n.id,u=n.parent&&n.parent.id,c;if(u&&!(u in e)&&i(n.parent,!1),u in t){let h=t[u]=t[u]||aT(e[u],e);c=h(n,o),t[l]=h}else Number.isFinite(a)?(c=a+(e[u]||0),t[l]=null):c=s;return o&&c>=s&&(s=c+1),e[l]=c,c};return i}function xF(s,{moduleParameters:e,target:t,viewport:i}){let n=t&&t.id!=="default-framebuffer",o=e&&e.devicePixelRatio||Ln(s),a=n?t.height:s.drawingBufferHeight,l=i;return[l.x*o,a-(l.y+l.height)*o,l.width*o,l.height*o]}function vF(s){let e=s.drawingBufferWidth,t=s.drawingBufferHeight;ni(s,{viewport:[0,0,e,t]}),s.clear(16640)}var Vg=class extends Co{constructor(e,t){super(e,t);y(this,"shadowMap",void 0),y(this,"depthBuffer",void 0),y(this,"fbo",void 0),this.shadowMap=new Xe(e,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new Ni(e,{format:33189,width:1,height:1}),this.fbo=new _e(e,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(e){let t=this.fbo;ht(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{let i=e.viewports[0],n=Ln(this.gl),o=i.width*n,a=i.height*n;(o!==t.width||a!==t.height)&&t.resize({width:o,height:a}),super.render({...e,target:t,pass:"shadow"})})}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}};var CF={color:[255,255,255],intensity:1},lT=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],AF=[0,0,0,200/255],Od=class{constructor(e={}){y(this,"id","lighting-effect"),y(this,"props",null),y(this,"shadowColor",AF),y(this,"shadow",void 0),y(this,"ambientLight",null),y(this,"directionalLights",[]),y(this,"pointLights",[]),y(this,"shadowPasses",[]),y(this,"shadowMaps",[]),y(this,"dummyShadowMap",null),y(this,"programManager",void 0),y(this,"shadowMatrices",void 0);for(let t in e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break;default:}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(e),this.programManager||(this.programManager=tn.getDefaultProgramManager(e),Ld&&this.programManager.addDefaultModule(Ld)),this.dummyShadowMap||(this.dummyShadowMap=new Xe(e,{width:1,height:1}));for(let l=0;l<this.shadowPasses.length;l++)this.shadowPasses[l].render({layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a,moduleParameters:{shadowLightId:l,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){let t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:e})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:e}))},t}cleanup(){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(Ld),this.programManager=null)}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new qt().lookAt({eye:new pr(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new Vg(e);this.shadowPasses[t]=i,this.shadowMaps[t]=i.shadowMap}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new tS(CF),this.directionalLights.push(new Fg(lT[0]),new Fg(lT[1])))}};var uT=class{constructor(e={}){y(this,"_pool",[]),y(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:n,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=n||e&&e.constructor||Float32Array,h=t*i+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d=1/0;u&&(d=u*i+o);let f=this._allocate(c,h,l,d);return e&&a?f.set(e):l||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,i,n){let o=Math.max(Math.ceil(t*this.opts.overAlloc),1);o>n&&(o=n);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return i&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:n}=i,o=t.findIndex(a=>a.byteLength>=n);o<0?t.push(i):(o>0||t.length<this.opts.poolSize)&&t.splice(o,0,i),t.length>this.opts.poolSize&&t.shift()}},Bn=new uT;function Cc(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function hT(s,e){let t=s%e;return t<0?e+t:t}function dT(s){return[s[12],s[13],s[14]]}function fT(s){return{left:vc(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:vc(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:vc(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:vc(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:vc(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:vc(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var cT=new pr;function vc(s,e,t,i){cT.set(s,e,t);let n=cT.len();return{distance:i/n,normal:new pr(-s/n,-e/n,-t/n)}}function TF(s){return s-Math.fround(s)}var Rd;function kg(s,e){let{size:t=1,startIndex:i=0}=e,n=e.endIndex!==void 0?e.endIndex:s.length,o=(n-i)/t;Rd=Bn.allocate(Rd,o,{type:Float32Array,size:t*2});let a=i,l=0;for(;a<n;){for(let u=0;u<t;u++){let c=s[a++];Rd[l+u]=c,Rd[l+u+t]=TF(c)}l+=t*2}return Rd.subarray(0,o*t*2)}var IF=Math.PI/180,wF=Cc(),pT=[0,0,0],LF={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function OF({width:s,height:e,orthographic:t,fovyRadians:i,focalDistance:n,padding:o,near:a,far:l}){let u=s/e,c=t?new qt().orthographic({fovy:i,aspect:u,focalDistance:n,near:a,far:l}):new qt().perspective({fovy:i,aspect:u,near:a,far:l});if(o){let{left:h=0,right:d=0,top:f=0,bottom:P=0}=o,E=It((h+s-d)/2,0,s)-s/2,v=It((f+e-P)/2,0,e)-e/2;c[8]-=E*2/s,c[9]+=v*2/e}return c}var Gi=class{constructor(e={}){y(this,"id",void 0),y(this,"x",void 0),y(this,"y",void 0),y(this,"width",void 0),y(this,"height",void 0),y(this,"isGeospatial",void 0),y(this,"zoom",void 0),y(this,"focalDistance",void 0),y(this,"position",void 0),y(this,"modelMatrix",void 0),y(this,"distanceScales",void 0),y(this,"scale",void 0),y(this,"center",void 0),y(this,"cameraPosition",void 0),y(this,"projectionMatrix",void 0),y(this,"viewMatrix",void 0),y(this,"viewMatrixUncentered",void 0),y(this,"viewMatrixInverse",void 0),y(this,"viewProjectionMatrix",void 0),y(this,"pixelProjectionMatrix",void 0),y(this,"pixelUnprojectionMatrix",void 0),y(this,"resolution",void 0),y(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.distanceScales=e.distanceScales||LF,this.focalDistance=e.focalDistance||1,this.position=e.position||pT,this.modelMatrix=e.modelMatrix||null;let{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?di.WEB_MERCATOR:di.WEB_MERCATOR_AUTO_OFFSET:di.IDENTITY}equals(e){return e instanceof Gi?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Rn(e.projectionMatrix,this.projectionMatrix)&&Rn(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let i=this.projectPosition(e),n=xc(i,this.pixelProjectionMatrix),[o,a]=n,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,n[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,u=i&&i*this.distanceScales.unitsPerMeter[2],c=vo([n,l,a],this.pixelUnprojectionMatrix,u),[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i]=this.projectFlat(e),n=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,n]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e),n=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,n]}projectFlat(e){if(this.isGeospatial){let t=us(e);return t[1]=It(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?Fi(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],o[0],a[0]),Math.min(i[1],n[1],o[1],a[1]),Math.max(i[0],n[0],o[0],a[0]),Math.max(i[1],n[1],o[1],a[1])]}getDistanceScales(e){return e?Ec({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,fT(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=Jy({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Ec({latitude:i,longitude:t}));let n=Math.pow(2,this.zoom);this.scale=n;let{position:o,modelMatrix:a}=e,l=pT;if(o&&(l=a?new qt(a).transformAsVector(o,[]):o),this.isGeospatial){let u=this.projectPosition([t,i,0]);this.center=new pr(l).scale(this.distanceScales.unitsPerMeter).add(u)}else this.center=this.projectPosition(l)}_initMatrices(e){let{viewMatrix:t=wF,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:o,fovy:a=75,near:l=.1,far:u=1e3,padding:c=null,focalDistance:h=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new qt().multiplyRight(t).translate(new pr(this.center).negate()),this.projectionMatrix=i||OF({width:this.width,height:this.height,orthographic:n,fovyRadians:o||a*IF,focalDistance:h,padding:c,near:l,far:u});let d=Cc();Eo(d,d,this.projectionMatrix),Eo(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=Cd([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=dT(this.viewMatrixInverse);let f=Cc(),P=Cc();vg(f,f,[this.width/2,-this.height/2,1]),xg(f,f,[1,-1,0]),Eo(P,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=P,this.pixelUnprojectionMatrix=Cd(Cc(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||he.warn("Pixel project matrix not invertible")()}};y(Gi,"displayName","Viewport");var RF=512,MF=4003e4,_F=Math.PI/180;function gT(s){let e=Math.cos(s*_F);return RF/MF/e}var Vi=class extends Gi{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,legacyMeterSizes:P=!1}=e,{width:E,height:v,altitude:L=1.5}=e,O=Math.pow(2,n);E=E||1,v=v||1;let D,_=null;h?(L=h[5]/2,D=Gl(L)):(e.fovy?(D=e.fovy,L=Id(D)):D=Gl(L),_=eS({width:E,height:v,pitch:o,fovy:D,nearZMultiplier:l,farZMultiplier:u}));let F=Ng({height:v,pitch:o,bearing:a,scale:O,altitude:L});f&&(F=new qt().translate([512*f,0,0]).multiplyLeft(F));super({...e,width:E,height:v,viewMatrix:F,longitude:i,latitude:t,zoom:n,..._,fovy:D,focalDistance:L});y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"pitch",void 0),y(this,"bearing",void 0),y(this,"altitude",void 0),y(this,"fovy",void 0),y(this,"orthographic",void 0),y(this,"_subViewports",void 0),y(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=o,this.bearing=a,this.altitude=L,this.fovy=D,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=P,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let n=t;n<=i;n++){let o=n?new Vi({...this,worldOffset:n}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e),n=(e[2]||0)*gT(e[1]);return[t,i,n]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),n=(e[2]||0)/gT(i);return[t,i,n]}addMetersToLngLat(e,t){return Td(e,t)}panByPosition(e,t){let i=vo(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=Pc([],n,Ig([],i)),a=Pc([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=wd(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:n}=this,{longitude:o,latitude:a,zoom:l}=Vl({width:i,height:n,bounds:e,...t});return new Vi({width:i,height:n,longitude:o,latitude:a,zoom:l})}};y(Vi,"displayName","WebMercatorViewport");function rS(s,e,t=!1){let i=e.projectPosition(s);if(t&&e instanceof Vi){let[n,o,a=0]=s,l=e.getDistanceScales([n,o]);i[2]=a*l.unitsPerMeter[2]}return i}function BF(s){let{viewport:e,modelMatrix:t,coordinateOrigin:i}=s,{coordinateSystem:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return n===Ve.DEFAULT&&(n=e.isGeospatial?Ve.LNGLAT:Ve.CARTESIAN),o===void 0&&(o=n),a===void 0&&(a=i),{viewport:e,coordinateSystem:n,coordinateOrigin:i,modelMatrix:t,fromCoordinateSystem:o,fromCoordinateOrigin:a}}function iS(s,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:n,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=Nl([],[a,l,u,1],t)),i){case Ve.LNGLAT:return rS([a,l,u],e,o);case Ve.LNGLAT_OFFSETS:return rS([a+n[0],l+n[1],u+(n[2]||0)],e,o);case Ve.METER_OFFSETS:return rS(Td(n,[a,l,u]),e,o);case Ve.CARTESIAN:default:return e.isGeospatial?[a+n[0],l+n[1],u+n[2]]:e.projectPosition([a,l,u])}}function mT(s,e){let{viewport:t,coordinateSystem:i,coordinateOrigin:n,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=BF(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=Fy(t,i,n),d=iS(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let f=t.projectPosition(u||c);HA(d,d,f)}return d}var ha={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Ac=Symbol.for("component"),cs=Symbol.for("asyncPropDefaults"),Ao=Symbol.for("asyncPropOriginal"),Nn=Symbol.for("asyncPropResolved");function Tc(s,e=()=>!0){return Array.isArray(s)?bT(s,e,[]):e(s)?[s]:[]}function bT(s,e,t){let i=-1;for(;++i<s.length;){let n=s[i];Array.isArray(n)?bT(n,e,t):e(n)&&t.push(n)}return t}function PT({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var Ug=class{constructor(e,t,i){y(this,"id",void 0),y(this,"context",void 0),y(this,"isLoaded",void 0),y(this,"persistent",void 0),y(this,"_loadCount",0),y(this,"_subscribers",new Set),y(this,"_data",void 0),y(this,"_loader",void 0),y(this,"_error",void 0),y(this,"_content",void 0),this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,n=e;typeof e=="string"&&(n=bo(e)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=o)}).catch(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=o||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(let o of this._subscribers)o.onChange(this.getData())}};var zg=class{constructor({gl:e,protocol:t}){y(this,"protocol",void 0),y(this,"_context",void 0),y(this,"_resources",void 0),y(this,"_consumers",void 0),y(this,"_pruneRequest",void 0),this.protocol=t||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:n=!0}){let o=this._resources[e];o?o.setData(t,i):(o=new Ug(e,t,this._context),this._resources[e]=o),o.persistent=n}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let i in t){let n=t[i],o=this._resources[n.resourceId];o&&o.unsubscribe(n)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:n="default"}){let{_resources:o,protocol:a}=this;e.startsWith(a)&&(e=e.replace(a,""),o[e]||this.add({resourceId:e,data:null,persistent:!1}));let l=o[e];if(this._track(i,n,l,t),l)return l.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,n){let o=this._consumers,a=o[e]=o[e]||{},l=a[t]||{},u=l.resourceId&&this._resources[l.resourceId];u&&(u.unsubscribe(l),this.prune()),i&&(a[t]=l,l.onChange=n,l.resourceId=i.id,i.subscribe(l))}_prune(){this._pruneRequest=null;for(let e of Object.keys(this._resources)){let t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}};var NF="layerManager.setLayers",DF="layerManager.activateViewport",Hg=class{constructor(e,{deck:t,stats:i,viewport:n,timeline:o}={}){y(this,"layers",void 0),y(this,"context",void 0),y(this,"resourceManager",void 0),y(this,"_lastRenderedLayers",[]),y(this,"_needsRedraw",!1),y(this,"_needsUpdate",!1),y(this,"_nextLayers",null),y(this,"_debug",!1),y(this,"activateViewport",a=>{Ot(DF,this,a),a&&(this.context.viewport=a)}),this.layers=[],this.resourceManager=new zg({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:t,programManager:e&&sT(e),stats:i||new mo({id:"deck.gl"}),viewport:n||new Gi({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Bl,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(let e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(let i of this.layers){let n=i.getNeedsRedraw(e);t=t||n}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){Ot(NF,this,t,e),this._lastRenderedLayers=e;let i=Tc(e,Boolean);for(let n of i)n.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,t,i){i.raiseError(t,"".concat(e," of ").concat(i))}_updateLayers(e,t){let i={};for(let a of e)i[a.id]?he.warn("Multiple old layers with same id ".concat(a.id))():i[a.id]=a;let n=[];this._updateSublayersRecursively(t,i,n),this._finalizeOldLayers(i);let o=!1;for(let a of n)if(a.hasUniformTransition()){o="Uniform transition in ".concat(a);break}this._needsUpdate=o,this.layers=n}_updateSublayersRecursively(e,t,i){for(let n of e){n.context=this.context;let o=t[n.id];o===null&&he.warn("Multiple new layers with same id ".concat(n.id))(),t[n.id]=null;let a=null;try{this._debug&&o!==n&&n.validateProps(),o?(this._transferLayerState(o,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),a=n.isComposite?n.getSubLayers():null}catch(l){this._handleError("matching",l,n)}a&&this._updateSublayersRecursively(a,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=ha.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=ha.MATCHED,t!==e&&(e.lifecycle=ha.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=ha.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=ha.FINALIZED}catch(t){this._handleError("finalization",t,e)}}};function Dn(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let i=s[t],n=e[t];if(!(i===n||Array.isArray(i)&&Array.isArray(n)&&Dn(i,n)))return!1}return!0}var Wg=class{constructor(e){y(this,"width",void 0),y(this,"height",void 0),y(this,"views",void 0),y(this,"viewState",void 0),y(this,"controllers",void 0),y(this,"timeline",void 0),y(this,"_viewports",void 0),y(this,"_viewportMap",void 0),y(this,"_isUpdating",void 0),y(this,"_needsRedraw",void 0),y(this,"_needsUpdate",void 0),y(this,"_eventManager",void 0),y(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),n={x:e[0],y:e[1]};for(let o=i.length-1;o>=0;--o){let a=i[o];if(a.containsPixel(n)){let l=e.slice();return l[0]-=a.x,l[1]-=a.y,a.unproject(l,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Tc(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Dn(e,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):he.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,t){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...t,viewId:e})}_createController(e,t){let i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,t.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:o=>e.makeViewport({viewState:o,width:this.width,height:this.height})})}_updateController(e,t,i,n){let o=e.controller;if(o){let a={...t,...o,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return n||(n=this._createController(e,a)),n&&n.setProps(a),n}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=e.length;n--;){let o=e[n],a=this.getViewState(o),l=o.makeViewport({viewState:a,width:this.width,height:this.height}),u=t[o.id],c=Boolean(o.controller);c&&!u&&(i=!0),(i||!c)&&u&&(u.finalize(),u=null),this.controllers[o.id]=this._updateController(o,a,l,u),this._viewports.unshift(l)}for(let n in t){let o=t[n];o&&!this.controllers[n]&&o.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,n)=>!e[n].equals(t[n]))}};var FF=/([0-9]+\.?[0-9]*)(%|px)/;function hs(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":let e=FF.exec(s);if(e&&e.length>=3){let t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error("Could not parse position string ".concat(s))}}function ds(s,e){return s.relative?Math.round(s.position*e):s.position}function St(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}var Ic=class{constructor(e){y(this,"id",void 0),y(this,"viewportInstance",void 0),y(this,"_x",void 0),y(this,"_y",void 0),y(this,"_width",void 0),y(this,"_height",void 0),y(this,"_padding",void 0),y(this,"props",void 0);let{id:t,x:i=0,y:n=0,width:o="100%",height:a="100%",padding:l=null,viewportInstance:u}=e||{};St(!u||u instanceof Gi),this.viewportInstance=u,this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=hs(i),this._y=hs(n),this._width=hs(o),this._height=hs(a),this._padding=l&&{left:hs(l.left||0),right:hs(l.right||0),top:hs(l.top||0),bottom:hs(l.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.viewportInstance?e.viewportInstance?this.viewportInstance.equals(e.viewportInstance):!1:this.ViewportType===e.ViewportType&&Dn(this.props,e.props)}makeViewport({width:e,height:t,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);let n=this.getDimensions({width:e,height:t});return new this.ViewportType({...i,...this.props,...n})}getViewStateId(){let{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){let i={x:ds(this._x,e),y:ds(this._y,t),width:ds(this._width,e),height:ds(this._height,t)};return this._padding&&(i.padding={left:ds(this._padding.left,e),top:ds(this._padding.top,t),right:ds(this._padding.right,e),bottom:ds(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}};var an=class{constructor(e){y(this,"_inProgress",void 0),y(this,"_handle",void 0),y(this,"_timeline",void 0),y(this,"time",void 0),y(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,(t=(i=this.settings).onStart)===null||t===void 0||t.call(i,this)}end(){if(this._inProgress){var e,t;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(t=this.settings).onEnd)===null||e===void 0||e.call(t,this)}}cancel(){if(this._inProgress){var e,t;(e=(t=this.settings).onInterrupt)===null||e===void 0||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:i,settings:n}=this;this._handle=i.addChannel({delay:i.getTime(),duration:n.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(t=this.settings).onUpdate)===null||e===void 0||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var yT=()=>{},Md;(function(s){s[s.BREAK=1]="BREAK",s[s.SNAP_TO_END=2]="SNAP_TO_END",s[s.IGNORE=3]="IGNORE"})(Md||(Md={}));var GF=s=>s,VF=Md.BREAK,jg=class{constructor(e){y(this,"getControllerState",void 0),y(this,"props",void 0),y(this,"propsInTransition",void 0),y(this,"transition",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"_onTransitionUpdate",t=>{let{time:i,settings:{interpolator:n,startProps:o,endProps:a,duration:l,easing:u}}=t,c=u(i/l),h=n.interpolateProps(o,a,c);this.propsInTransition=this.getControllerState({...this.props,...h}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new an(e.timeline),this.onViewStateChange=e.onViewStateChange||yT,this.onStateChange=e.onStateChange||yT}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let n=i;if(this.transition.inProgress){let{interruption:o,endProps:a}=this.transition.settings;n={...i,...o===Md.SNAP_TO_END?a:this.propsInTransition||i}}this._triggerTransition(n,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&Boolean(i)}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===Md.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){let i=this.getControllerState(e),n=this.getControllerState(t).shortestPathFrom(i),o=t.transitionInterpolator,a=o.getDuration?o.getDuration(e,t):t.transitionDuration;if(a===0)return;let l=o.initializeProps(e,n);this.propsInTransition={};let u={duration:a,easing:t.transitionEasing||GF,interpolator:o,interruption:t.transitionInterruption||VF,startProps:l.start,endProps:l.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(u),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}};var qg=class{constructor(e){y(this,"_propsToCompare",void 0),y(this,"_propsToExtract",void 0),y(this,"_requiredProps",void 0);let{compare:t,extract:i,required:n}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=n}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!Rn(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},n={};for(let o of this._propsToExtract)(o in e||o in t)&&(i[o]=e[o],n[o]=t[o]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){!this._requiredProps||this._requiredProps.forEach(t=>{let i=e[t];St(Number.isFinite(i)||Array.isArray(i),"".concat(t," is required for transition"))})}};var kF=["longitude","latitude","zoom","bearing","pitch"],UF=["longitude","latitude","zoom"],Fn=class extends qg{constructor(e={}){let t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:kF,required:UF};super(i.transitionProps);y(this,"opts",void 0),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:n,around:o}=this.opts;if(n&&o){let a=n(e),l=n(t),u=a.unproject(o);i.start.around=o,Object.assign(i.end,{around:l.project(u),aroundPosition:u,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let n={};for(let o of this._propsToExtract)n[o]=Fl(e[o]||0,t[o]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let o=this.opts.makeViewport({...t,...n});Object.assign(n,o.panByPosition(t.aroundPosition,Fl(e.around,t.around,i)))}return n}};var da={transitionDuration:0},zF=300,Xg=s=>1-(1-s)*(1-s),wc={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},kl={},Lc=class{constructor(e){y(this,"props",void 0),y(this,"state",{}),y(this,"transitionManager",void 0),y(this,"eventManager",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"makeViewport",void 0),y(this,"_controllerState",void 0),y(this,"_events",{}),y(this,"_interactionState",{isDragging:!1}),y(this,"_customEvents",[]),y(this,"_eventStartBlocked",null),y(this,"_panMove",!1),y(this,"invertPan",!1),y(this,"dragMode","rotate"),y(this,"inertia",0),y(this,"scrollZoom",!0),y(this,"dragPan",!0),y(this,"dragRotate",!0),y(this,"doubleClickZoom",!0),y(this,"touchZoom",!0),y(this,"touchRotate",!1),y(this,"keyboard",!0),this.transitionManager=new jg({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let t in this._events)if(this._events[t]){var e;(e=this.eventManager)===null||e===void 0||e.off(t,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return t?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:n}=e;return[n.x-t,n.y-i]}isPointInBounds(e,t){let{width:i,height:n}=this.props;if(t&&t.handled)return!1;let o=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=n;return o&&t&&t.stopPropagation(),o}isFunctionKeyPressed(e){let{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?zF:0;let{scrollZoom:i=!0,dragPan:n=!0,dragRotate:o=!0,doubleClickZoom:a=!0,touchZoom:l=!0,touchRotate:u=!1,keyboard:c=!0}=e,h=Boolean(this.onViewStateChange);this.toggleEvents(wc.WHEEL,h&&i),this.toggleEvents(wc.PAN,h&&(n||o)),this.toggleEvents(wc.PINCH,h&&(l||u)),this.toggleEvents(wc.TRIPLE_PAN,h&&u),this.toggleEvents(wc.DOUBLE_TAP,h&&a),this.toggleEvents(wc.KEYBOARD,h&&c),this.scrollZoom=i,this.dragPan=n,this.dragRotate=o,this.doubleClickZoom=a,this.touchZoom=l,this.touchRotate=u,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){let n={...e.getViewportProps(),...t},o=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),o){let a=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:a})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);let n=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(n,da,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,da,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.pan({pos:n}).panEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Xg},{isDragging:!1,isPanning:!0})}else{let i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,da,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.rotate({pos:n}).rotateEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Xg},{isDragging:!1,isRotating:!0})}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;e.srcEvent.preventDefault();let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let{speed:i=.01,smooth:n=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:o}=e,a=2/(1+Math.exp(-Math.abs(o*i)));o<0&&a!==0&&(a=1/a);let l=this.controllerState.zoom({pos:t,scale:a});return this.updateViewport(l,{...this._getTransitionProps({around:t}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,da,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,da,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),n=[i[0],i[1]+=e.velocityY*t/2],o=this.controllerState.rotate({pos:n});this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Xg},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return kl._startPinchRotation=e.rotation,kl._lastPinchEvent=e,this.updateViewport(i,da,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,n=this.getCenter(e);t=t.zoom({pos:n,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:kl._startPinchRotation-i})}return this.updateViewport(t,da,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),kl._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=kl;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let n=this.getCenter(e),o=this.controllerState.rotateEnd(),a=Math.log2(e.scale),l=(a-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),u=Math.pow(2,a+l*t/2);o=o.zoom({pos:n,scale:u}).zoomEnd(),this.updateViewport(o,{...this._getTransitionProps({around:n}),transitionDuration:t,transitionEasing:Xg},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let n=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return kl._startPinchRotation=null,kl._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),n=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;let t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:o,rotateSpeedY:a}=this.keyboard===!0?{}:this.keyboard,{controllerState:l}=this,u,c={};switch(e.srcEvent.code){case"Minus":u=t?l.zoomOut(i).zoomOut(i):l.zoomOut(i),c.isZooming=!0;break;case"Equal":u=t?l.zoomIn(i).zoomIn(i):l.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":t?(u=l.rotateLeft(o),c.isRotating=!0):(u=l.moveLeft(n),c.isPanning=!0);break;case"ArrowRight":t?(u=l.rotateRight(o),c.isRotating=!0):(u=l.moveRight(n),c.isPanning=!0);break;case"ArrowUp":t?(u=l.rotateUp(a),c.isRotating=!0):(u=l.moveUp(n),c.isPanning=!0);break;case"ArrowDown":t?(u=l.rotateDown(a),c.isRotating=!0):(u=l.moveDown(n),c.isPanning=!0);break;default:return!1}return this.updateViewport(u,this._getTransitionProps(),c),!0}_getTransitionProps(e){let{transition:t}=this;return!t||!t.transitionInterpolator?da:e?{...t,transitionInterpolator:new Fn({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}};var Oc=class{constructor(e,t){y(this,"_viewportProps",void 0),y(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}};var ST=5,HF=1.2,ET=class extends Oc{constructor(e){let{width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l=0,pitch:u=0,altitude:c=1.5,position:h=[0,0,0],maxZoom:d=20,minZoom:f=0,maxPitch:P=60,minPitch:E=0,startPanLngLat:v,startZoomLngLat:L,startRotatePos:O,startBearing:D,startPitch:_,startZoom:F,normalize:X=!0}=e;St(Number.isFinite(o)),St(Number.isFinite(n)),St(Number.isFinite(a));super({width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l,pitch:u,altitude:c,maxZoom:d,minZoom:f,maxPitch:P,minPitch:E,normalize:X,position:h},{startPanLngLat:v,startZoomLngLat:L,startRotatePos:O,startBearing:D,startPitch:_,startZoom:F});y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startBearing:o,startPitch:a}=this.getState();if(!n||o===void 0||a===void 0)return this;let l;return e?l=this._getNewRotation(e,n,a,o):l={bearing:o+t,pitch:a+i},this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomLngLat:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let{maxZoom:a,minZoom:l}=this.getViewportProps(),u=n+Math.log2(i);u=It(u,l,a);let c=this.makeViewport({...this.getViewportProps(),zoom:u});return this._getUpdatedState({zoom:u,...c.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:o}=i;return Math.abs(n-t.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(o-t.longitude)>180&&(i.longitude=o<0?o+360:o-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n}=e;e.zoom=It(n,i,t);let{maxPitch:o,minPitch:a,pitch:l}=e;e.pitch=It(l,a,o);let{normalize:u=!0}=e;return u&&Object.assign(e,Dg(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,n){let o=e[0]-t[0],a=e[1]-t[1],l=e[1],u=t[1],{width:c,height:h}=this.getViewportProps(),d=o/c,f=0;a>0?Math.abs(h-u)>ST&&(f=a/(u-h)*HF):a<0&&u>ST&&(f=1-l/u),f=It(f,-1,1);let{minPitch:P,maxPitch:E}=this.getViewportProps(),v=n+180*d,L=i;return f>0?L=i+f*(E-i):f<0&&(L=i-f*(P-i)),{pitch:L,bearing:v}}},Yg=class extends Lc{constructor(...e){super(...e);y(this,"ControllerState",ET),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Fn({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),y(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}};var _d=class extends Ic{get ViewportType(){return Vi}get ControllerType(){return Yg}};y(_d,"displayName","MapView");var $g=class extends Co{constructor(e,t){super(e,t);y(this,"maskMap",void 0),y(this,"fbo",void 0);let{mapSize:i=2048}=t;this.maskMap=new Xe(e,{width:i,height:i,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new _e(e,{id:"maskmap",width:i,height:i,attachments:{[36064]:this.maskMap}})}render(e){let t=this.gl,i=[!1,!1,!1,!1];return i[e.channel]=!0,ht(t,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:i,depthTest:!1},()=>super.render({...e,target:this.fbo,pass:"mask"}))}shouldDrawLayer(e){return e.props.operation===On.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}};var WF=new qt().lookAt({eye:[0,0,1]});function jF({width:s,height:e,near:t,far:i,padding:n}){let o=-s/2,a=s/2,l=-e/2,u=e/2;if(n){let{left:c=0,right:h=0,top:d=0,bottom:f=0}=n,P=It((c+s-h)/2,0,s)-s/2,E=It((d+e-f)/2,0,e)-e/2;o-=P,a-=P,l+=E,u+=E}return new qt().ortho({left:o,right:a,bottom:l,top:u,near:t,far:i})}var Zg=class extends Gi{constructor(e){let{width:t,height:i,near:n=.1,far:o=1e3,zoom:a=0,target:l=[0,0,0],padding:u=null,flipY:c=!0}=e,h=Array.isArray(a)?a[0]:a,d=Array.isArray(a)?a[1]:a,f=Math.min(h,d),P=Math.pow(2,f),E;if(h!==d){let v=Math.pow(2,h),L=Math.pow(2,d);E={unitsPerMeter:[v/P,L/P,1],metersPerUnit:[P/v,P/L,1]}}super({...e,longitude:void 0,position:l,viewMatrix:WF.clone().scale([P,P*(c?-1:1),P]),projectionMatrix:jF({width:t||1,height:i||1,padding:u,near:n,far:o}),zoom:f,distanceScales:E})}projectFlat([e,t]){let{unitsPerMeter:i}=this.distanceScales;return[e*i[0],t*i[1]]}unprojectFlat([e,t]){let{metersPerUnit:i}=this.distanceScales;return[e*i[0],t*i[1]]}panByPosition(e,t){let i=vo(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=Pc([],n,Ig([],i)),a=Pc([],this.center,o);return{target:this.unprojectFlat(a)}}};var nS=class extends Oc{constructor(e){let{width:t,height:i,rotationX:n=0,rotationOrbit:o=0,target:a=[0,0,0],zoom:l=0,minRotationX:u=-90,maxRotationX:c=90,minZoom:h=-1/0,maxZoom:d=1/0,startPanPosition:f,startRotatePos:P,startRotationX:E,startRotationOrbit:v,startZoomPosition:L,startZoom:O}=e;super({width:t,height:i,rotationX:n,rotationOrbit:o,target:a,zoom:l,minRotationX:u,maxRotationX:c,minZoom:h,maxZoom:d},{startPanPosition:f,startRotatePos:P,startRotationX:E,startRotationOrbit:v,startZoomPosition:L,startZoom:O});y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:t}){let i=this.getState().startPanPosition||t;if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startRotationX:o,startRotationOrbit:a}=this.getState(),{width:l,height:u}=this.getViewportProps();if(!n||o===void 0||a===void 0)return this;let c;if(e){let h=(e[0]-n[0])/l,d=(e[1]-n[1])/u;(o<-90||o>90)&&(h*=-1),c={rotationX:o+d*180,rotationOrbit:a+h*180}}else c={rotationX:o+i,rotationOrbit:a+t};return this._getUpdatedState(c)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:n}=i;return Math.abs(n-t.rotationOrbit)>180&&(i.rotationOrbit=n<0?n+360:n-360),i}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomPosition:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let a=this._calculateNewZoom({scale:i,startZoom:n}),l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=t+Math.log2(e);return It(o,n,i)}_panFromCenter(e){let{width:t,height:i,target:n}=this.getViewportProps();return this.pan({startPosition:n,pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n,maxRotationX:o,minRotationX:a,rotationOrbit:l}=e;return e.zoom=Array.isArray(n)?[It(n[0],i,t),It(n[1],i,t)]:It(n,i,t),e.rotationX=It(e.rotationX,a,o),(l<-180||l>180)&&(e.rotationOrbit=hT(l+180,360)-180),e}};var xT=class extends nS{constructor(e){super(e);y(this,"zoomAxis",void 0),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=Math.log2(e);if(Array.isArray(t)){let[a,l]=t;switch(this.zoomAxis){case"X":a=It(a+o,n,i);break;case"Y":l=It(l+o,n,i);break;default:let u=Math.min(a+o,l+o);u<n&&(o+=n-u),u=Math.max(a+o,l+o),u>i&&(o+=i-u),a+=o,l+=o}return[a,l]}return It(t+o,n,i)}},Qg=class extends Lc{constructor(...e){super(...e);y(this,"ControllerState",xT),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Fn(["target","zoom"])}),y(this,"dragMode","pan")}_onPanRotate(){return!1}};var fa=class extends Ic{get ViewportType(){return Zg}get ControllerType(){return Qg}};y(fa,"displayName","OrthographicView");function vT({layers:s,viewport:e}){let t=null;for(let o of s){let a=o.getBounds();a&&(t?(t[0]=Math.min(t[0],a[0][0]),t[1]=Math.min(t[1],a[0][1]),t[2]=Math.max(t[2],a[1][0]),t[3]=Math.max(t[3],a[1][1])):t=[a[0][0],a[0][1],a[1][0],a[1][1]])}let i=e.getBounds();if(!t)return i;let n=qF(i);return t[2]-t[0]<n[2]-n[0]||t[3]-t[1]<n[3]-n[1]||(t[0]=Math.max(t[0],n[0]),t[1]=Math.max(t[1],n[1]),t[2]=Math.min(t[2],n[2]),t[3]=Math.min(t[3],n[3])),t}function CT({bounds:s,viewport:e,width:t,height:i}){if(s[2]<=s[0]||s[3]<=s[1])return null;let n=1;if(t-=n*2,i-=n*2,e instanceof Vi){let{longitude:l,latitude:u,zoom:c}=Vl({width:t,height:i,bounds:[[s[0],s[1]],[s[2],s[3]]],maxZoom:20});return new Vi({longitude:l,latitude:u,zoom:c,x:n,y:n,width:t,height:i})}let o=[(s[0]+s[2])/2,(s[1]+s[3])/2,0],a=Math.min(20,t/(s[2]-s[0]),i/(s[3]-s[1]));return new fa({x:n,y:n}).makeViewport({width:t,height:i,viewState:{target:o,zoom:Math.log2(a)}})}function qF(s){let e={x:s[2]-s[0],y:s[3]-s[1]},t={x:s[0]+.5*e.x,y:s[1]+.5*e.y};return[t.x-e.x,t.y-e.y,t.x+e.x,t.y+e.y]}var Kg=class{constructor(){y(this,"id","mask-effect"),y(this,"props",null),y(this,"useInPicking",!0),y(this,"dummyMaskMap",void 0),y(this,"channels",[]),y(this,"masks",null),y(this,"maskPass",void 0),y(this,"maskMap",void 0),y(this,"lastViewport",void 0)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){this.dummyMaskMap||(this.dummyMaskMap=new Xe(e,{width:1,height:1}));let l=t.filter(d=>d.props.visible&&d.props.operation===On.MASK);if(l.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new $g(e,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);let u=this._sortMaskChannels(l),c=n[0],h=!this.lastViewport||!this.lastViewport.equals(c);for(let d in u)this._renderChannel(u[d],{layerFilter:i,onViewportActive:o,views:a,viewport:c,viewportChanged:h})}_renderChannel(e,{layerFilter:t,onViewportActive:i,views:n,viewport:o,viewportChanged:a}){let l=this.channels[e.index];if(!l)return;let u=e===l||l.layers.length!==e.layers.length||e.layerBounds.some((c,h)=>c!==l.layerBounds[h]);if(e.bounds=l.bounds,e.maskBounds=l.maskBounds,this.channels[e.index]=e,(u||a)&&(this.lastViewport=o,e.bounds=vT({layers:e.layers,viewport:o}),u||!Rn(e.bounds,l.bounds))){let{maskPass:c,maskMap:h}=this,d=CT({bounds:e.bounds,viewport:o,width:h.width,height:h.height});e.maskBounds=d?d.getBounds():[0,0,1,1],c.render({pass:"mask",channel:e.index,layers:e.layers,layerFilter:t,viewports:d?[d]:[],onViewportActive:i,views:n,moduleParameters:{devicePixelRatio:1}})}this.masks[e.id]={index:e.index,bounds:e.maskBounds,coordinateOrigin:e.coordinateOrigin,coordinateSystem:e.coordinateSystem}}_sortMaskChannels(e){let t={},i=0;for(let n of e){let{id:o}=n.root,a=t[o];if(!a){if(++i>4){he.warn("Too many mask layers. The max supported is 4")();continue}a={id:o,index:this.channels.findIndex(l=>l?.id===o),layers:[],layerBounds:[],coordinateOrigin:n.root.props.coordinateOrigin,coordinateSystem:n.root.props.coordinateSystem},t[o]=a}a.layers.push(n),a.layerBounds.push(n.getBounds())}for(let n=0;n<4;n++){let o=this.channels[n];(!o||!(o.id in t))&&(this.channels[n]=null)}for(let n in t){let o=t[n];o.index<0&&(o.index=this.channels.findIndex(a=>!a),this.channels[o.index]=o)}return t}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}};var XF=new Od,Jg=class{constructor(){y(this,"effects",void 0),y(this,"_internalEffects",void 0),y(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(e){"effects"in e&&(e.effects.length!==this.effects.length||!Dn(e.effects,this.effects))&&(this.setEffects(e.effects),this._needsRedraw="effects changed")}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(e=[]){this.cleanup(),this.effects=e,this._internalEffects=e.slice(),this._internalEffects.push(new Kg),e.some(t=>t instanceof Od)||this._internalEffects.push(XF)}cleanup(){for(let e of this.effects)e.cleanup();for(let e of this._internalEffects)e.cleanup();this.effects.length=0,this._internalEffects.length=0}};var em=class extends Co{shouldDrawLayer(e){return e.props.operation===On.DRAW}};var AT={blendFunc:[1,0,32771,0],blendEquation:32774},Rc=class extends Co{constructor(...e){super(...e);y(this,"pickZ",void 0),y(this,"_colors",null)}render(e){return e.pickingFBO?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,pickingFBO:a,deviceRect:{x:l,y:u,width:c,height:h},effects:d,pass:f="picking",pickZ:P}){let E=this.gl;this.pickZ=P;let v=P?null:{byLayer:new Map,byAlpha:[]};this._colors=v;let L=ht(E,{scissorTest:!0,scissor:[l,u,c,h],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...AT,blend:!P},()=>super.render({target:a,layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,effects:d?.filter(D=>D.useInPicking),pass:f}));return this._colors=null,{decodePickingColor:v&&$F.bind(null,v),stats:L}}shouldDrawLayer(e){return e.props.pickable&&e.props.operation===On.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,t,i){let n={...e.props.parameters};return this._colors?(Object.assign(n,AT),n.blend=!0,n.blendColor=YF(this._colors,e,i)):n.blend=!1,n}};function YF(s,e,t){let{byLayer:i,byAlpha:n}=s,o,a=i.get(e);return a?(a.viewports.push(t),o=a.a):(o=i.size+1,o<=255?(a={a:o,layer:e,viewports:[t]},i.set(e,a),n[o]=a):(he.warn("Too many pickable layers, only picking the first 255")(),o=0)),[0,0,0,o/255]}function $F(s,e){let t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}var ZF="deckRenderer.renderLayers",tm=class{constructor(e){this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new em(e),this.pickLayersPass=new Rc(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){"layerFilter"in e&&this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in e&&this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;e.layerFilter=e.layerFilter||this.layerFilter,e.effects=e.effects||[],e.target=e.target||_e.getDefaultFramebuffer(this.gl),this._preRender(e.effects,e);let i=this.lastPostProcessEffect?this.renderBuffers[0]:e.target,n=t.render({...e,target:i});this._postRender(e.effects,e),this.renderCount++,Ot(ZF,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){let i=null;for(let n of e)n.preRender(this.gl,t),n.postRender&&(i=n);i&&this._resizeRenderBuffers(),this.lastPostProcessEffect=i}_resizeRenderBuffers(){let{renderBuffers:e}=this;e.length===0&&e.push(new _e(this.gl),new _e(this.gl));for(let t of e)t.resize()}_postRender(e,t){let{renderBuffers:i}=this,n={inputBuffer:i[0],swapBuffer:i[1],target:null};for(let o of e)if(o.postRender){if(o===this.lastPostProcessEffect){n.target=t.target,o.postRender(this.gl,n);break}let a=o.postRender(this.gl,n);n.inputBuffer=a,n.swapBuffer=a===i[0]?i[1]:i[0]}}};var QF={pickedColor:null,pickedObjectIndex:-1};function TT({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:n,deviceRect:o}){let{x:a,y:l,width:u,height:c}=o,h=n*n,d=-1,f=0;for(let P=0;P<c;P++){let E=P+l-i,v=E*E;if(v>h)f+=4*u;else for(let L=0;L<u;L++){if(s[f+3]-1>=0){let D=L+a-t,_=D*D+v;_<=h&&(h=_,d=f)}f+=4}}if(d>=0){let P=s.slice(d,d+4),E=e(P);if(E){let v=Math.floor(d/4/u),L=d/4-v*u;return{...E,pickedColor:P,pickedX:a+L,pickedY:l+v}}he.error("Picked non-existent layer. Is picking buffer corrupt?")()}return QF}function IT({pickedColors:s,decodePickingColor:e}){let t=new Map;if(s){for(let i=0;i<s.length;i+=4)if(s[i+3]-1>=0){let o=s.slice(i,i+4),a=o.join(",");if(!t.has(a)){let l=e(o);l?t.set(a,{...l,color:o}):he.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function oS({pickInfo:s,viewports:e,pixelRatio:t,x:i,y:n,z:o}){let a=e[0];e.length>1&&(a=KF(s?.pickedViewports||e,{x:i,y:n}));let l;if(a){let u=[i-a.x,n-a.y];o!==void 0&&(u[2]=o),l=a.unproject(u)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:i,y:n,pixel:[i,n],coordinate:l,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function wT(s){let{pickInfo:e,lastPickedInfo:t,mode:i,layers:n}=s,{pickedColor:o,pickedLayer:a,pickedObjectIndex:l}=e,u=a?[a]:[];if(i==="hover"){let d=t.index,f=t.layerId,P=a?a.props.id:null;if(P!==f||l!==d){if(P!==f){let E=n.find(v=>v.props.id===f);E&&u.unshift(E)}t.layerId=P,t.index=l,t.info=null}}let c=oS(s),h=new Map;return h.set(null,c),u.forEach(d=>{let f={...c};d===a&&(f.color=o,f.index=l,f.picked=!0),f=sS({layer:d,info:f,mode:i});let P=f.layer;d===a&&i==="hover"&&(t.info=f),h.set(P.id,f),i==="hover"&&P.updateAutoHighlight(f)}),h}function sS({layer:s,info:e,mode:t}){for(;s&&e;){let i=e.layer||null;e.sourceLayer=i,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:i}),s=s.parent}return e}function KF(s,e){for(let t=s.length-1;t>=0;t--){let i=s[t];if(i.containsPixel(e))return i}return s[0]}var rm=class{constructor(e){y(this,"gl",void 0),y(this,"pickingFBO",void 0),y(this,"depthFBO",void 0),y(this,"pickLayersPass",void 0),y(this,"layerFilter",void 0),y(this,"lastPickedInfo",void 0),y(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new Rc(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:n},o=this.lastPickedInfo.info){let a=o&&o.layer&&o.layer.id,l=o&&o.viewport&&o.viewport.id,u=a?i.find(f=>f.id===a):null,c=l&&n.find(f=>f.id===l)||n[0],h=c&&c.unproject([e-c.x,t-c.y]);return{...o,...{x:e,y:t,viewport:c,coordinate:h,layer:u}}}_resizeBuffer(){var e,t;let{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new _e(i),_e.isSupported(i,{colorBufferFloat:!0}))){let n=new _e(i);n.attach({[36064]:new Xe(i,{format:ce(i)?34836:6408,type:5126})}),this.depthFBO=n}(e=this.pickingFBO)===null||e===void 0||e.resize({width:i.canvas.width,height:i.canvas.height}),(t=this.depthFBO)===null||t===void 0||t.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;let t=e.filter(i=>i.isPickable()&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:n,y:o,radius:a=0,depth:l=1,mode:u="query",unproject3D:c,onViewportActive:h,effects:d}){let f=this._getPickable(e),P=Ln(this.gl);if(!f)return{result:[],emptyInfo:oS({viewports:i,x:n,y:o,pixelRatio:P})};this._resizeBuffer();let E=nc(this.gl,[n,o],!0),v=[E.x+Math.floor(E.width/2),E.y+Math.floor(E.height/2)],L=Math.round(a*P),{width:O,height:D}=this.pickingFBO,_=this._getPickingRect({deviceX:v[0],deviceY:v[1],deviceRadius:L,deviceWidth:O,deviceHeight:D}),F,X=[],$=new Set;for(let se=0;se<l;se++){let ie;if(_){let ue=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:_,effects:d,pass:"picking:".concat(u)});ie=TT({...ue,deviceX:v[0],deviceY:v[1],deviceRadius:L,deviceRect:_})}else ie={pickedColor:null,pickedObjectIndex:-1};let oe;ie.pickedLayer&&c&&this.depthFBO&&(oe=this._drawAndSample({layers:[ie.pickedLayer],views:t,viewports:i,onViewportActive:h,deviceRect:{x:ie.pickedX,y:ie.pickedY,width:1,height:1},effects:d,pass:"picking:".concat(u,":z")},!0).pickedColors[0]),ie.pickedLayer&&se+1<l&&($.add(ie.pickedLayer),ie.pickedLayer.disablePickingIndex(ie.pickedObjectIndex)),F=wT({pickInfo:ie,lastPickedInfo:this.lastPickedInfo,mode:u,layers:f,viewports:i,x:n,y:o,z:oe,pixelRatio:P});for(let ue of F.values())ue.layer&&X.push(ue);if(!ie.pickedColor)break}for(let se of $)se.restorePickingColors();return{result:X,emptyInfo:F.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:n,y:o,width:a=1,height:l=1,mode:u="query",maxObjects:c=null,onViewportActive:h,effects:d}){let f=this._getPickable(e);if(!f)return[];this._resizeBuffer();let P=Ln(this.gl),E=nc(this.gl,[n,o],!0),v=E.x,L=E.y+E.height,O=nc(this.gl,[n+a,o+l],!0),D=O.x+O.width,_=O.y,F={x:v,y:_,width:D-v,height:L-_},X=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:F,effects:d,pass:"picking:".concat(u)}),$=IT(X),se=new Map,ie=Number.isFinite(c);for(let oe=0;oe<$.length&&!(ie&&c&&se.size>=c);oe++){let ue=$[oe],Se={color:ue.pickedColor,layer:null,index:ue.pickedObjectIndex,picked:!0,x:n,y:o,pixelRatio:P};Se=sS({layer:ue.pickedLayer,info:Se,mode:u}),se.has(Se.object)||se.set(Se.object,Se)}return Array.from(se.values())}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:n,deviceRect:o,effects:a,pass:l},u=!1){let c=u?this.depthFBO:this.pickingFBO,{decodePickingColor:h}=this.pickLayersPass.render({layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:n,pickingFBO:c,deviceRect:o,effects:a,pass:l,pickZ:u}),{x:d,y:f,width:P,height:E}=o,v=new(u?Float32Array:Uint8Array)(P*E*4);return os(c,{sourceX:d,sourceY:f,sourceWidth:P,sourceHeight:E,target:v}),{pickedColors:v,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:n,deviceHeight:o}){let a=Math.max(0,e-i),l=Math.max(0,t-i),u=Math.min(n,e+i+1)-a,c=Math.min(o,t+i+1)-l;return u<=0||c<=0?null:{x:a,y:l,width:u,height:c}}};var JF={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},im=class{constructor(e){y(this,"el",null),y(this,"isVisible",!1);let t=e.parentElement;t&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,JF),t.appendChild(this.el))}setTooltip(e,t,i){let n=this.el;if(!!n){if(typeof e=="string")n.innerText=e;else if(e)e.text&&(n.innerText=e.text),e.html&&(n.innerHTML=e.html),e.className&&(n.className=e.className),Object.assign(n.style,e.style);else{this.isVisible=!1,n.style.display="none";return}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(t,"px, ").concat(i,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}};var Bd=be(LT());var eG={mousedown:1,mousemove:2,mouseup:4};function tG(s,e){for(let t=0;t<s.length;t++)if(e(s[t]))return!0;return!1}function OT(s){let e=s.prototype.handler;s.prototype.handler=function(i){let n=this.store;i.button>0&&i.type==="pointerdown"&&(tG(n,o=>o.pointerId===i.pointerId)||n.push(i)),e.call(this,i)}}function RT(s){s.prototype.handler=function(t){let i=eG[t.type];i&1&&t.button>=0&&(this.pressed=!0),i&2&&t.which===0&&(i=4),this.pressed&&(i&4&&(this.pressed=!1),this.callback(this.manager,i,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}OT(Bd.default.PointerEventInput);RT(Bd.default.MouseInput);var MT=Bd.default.Manager,Gn=Bd.default;var To=class{constructor(e,t,i){this.element=e,this.callback=t,this.options={enable:!0,...i}}};var _T=Gn?[[Gn.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[Gn.Rotate,{enable:!1}],[Gn.Pinch,{enable:!1}],[Gn.Swipe,{enable:!1}],[Gn.Pan,{threshold:0,enable:!1}],[Gn.Press,{enable:!1}],[Gn.Tap,{event:"doubletap",taps:2,enable:!1}],[Gn.Tap,{event:"anytap",enable:!1}],[Gn.Tap,{enable:!1}]]:null,aS={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},BT={doubletap:["tap"]},NT={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Mc={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},DT={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},lS={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"};var FT=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Ul=typeof window<"u"?window:global;var om=!1;try{let s={get passive(){return om=!0,!0}};Ul.addEventListener("test",null,s),Ul.removeEventListener("test",null)}catch{om=!1}var rG=FT.indexOf("firefox")!==-1,{WHEEL_EVENTS:iG}=Mc,GT="wheel",VT=4.000244140625,nG=40,oG=.25,sm=class extends To{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{if(!this.options.enable)return;let o=n.deltaY;Ul.WheelEvent&&(rG&&n.deltaMode===Ul.WheelEvent.DOM_DELTA_PIXEL&&(o/=Ul.devicePixelRatio),n.deltaMode===Ul.WheelEvent.DOM_DELTA_LINE&&(o*=nG)),o!==0&&o%VT===0&&(o=Math.floor(o/VT)),n.shiftKey&&o&&(o=o*oG),this.callback({type:GT,center:{x:n.clientX,y:n.clientY},delta:-o,srcEvent:n,pointerType:"mouse",target:n.target})},this.events=(this.options.events||[]).concat(iG),this.events.forEach(n=>e.addEventListener(n,this.handleEvent,om?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===GT&&(this.options.enable=t)}};var{MOUSE_EVENTS:sG}=Mc,kT="pointermove",UT="pointerover",zT="pointerout",HT="pointerenter",WT="pointerleave",am=class extends To{constructor(e,t,i){super(e,t,i);this.handleEvent=o=>{this.handleOverEvent(o),this.handleOutEvent(o),this.handleEnterEvent(o),this.handleLeaveEvent(o),this.handleMoveEvent(o)},this.pressed=!1;let{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(sG),this.events.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===kT&&(this.enableMoveEvent=t),e===UT&&(this.enableOverEvent=t),e===zT&&(this.enableOutEvent=t),e===HT&&(this.enableEnterEvent=t),e===WT&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(UT,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(zT,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(HT,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(WT,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(kT,e);break;case"mouseup":this.pressed=!1;break;default:}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}};var{KEY_EVENTS:aG}=Mc,jT="keydown",qT="keyup",lm=class extends To{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{let o=n.target||n.srcElement;o.tagName==="INPUT"&&o.type==="text"||o.tagName==="TEXTAREA"||(this.enableDownEvent&&n.type==="keydown"&&this.callback({type:jT,srcEvent:n,key:n.key,target:n.target}),this.enableUpEvent&&n.type==="keyup"&&this.callback({type:qT,srcEvent:n,key:n.key,target:n.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(aG),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===jT&&(this.enableDownEvent=t),e===qT&&(this.enableUpEvent=t)}};var XT="contextmenu",um=class extends To{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{!this.options.enable||this.callback({type:XT,center:{x:n.clientX,y:n.clientY},srcEvent:n,pointerType:"mouse",target:n.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===XT&&(this.options.enable=t)}};var lG={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},uG=1,cG=2,hG=3,dG=0,fG=1,pG=2,gG=1,mG=2,bG=4;function YT(s){let e=lG[s.srcEvent.type];if(!e)return null;let{buttons:t,button:i,which:n}=s.srcEvent,o=!1,a=!1,l=!1;return e===4||e===2&&!Number.isFinite(t)?(o=n===uG,a=n===cG,l=n===hG):e===2?(o=Boolean(t&gG),a=Boolean(t&bG),l=Boolean(t&mG)):e===1&&(o=i===dG,a=i===fG,l=i===pG),{leftButton:o,middleButton:a,rightButton:l}}function $T(s,e){let t=s.center;if(!t)return null;let i=e.getBoundingClientRect(),n=i.width/e.offsetWidth||1,o=i.height/e.offsetHeight||1,a={x:(t.x-i.left-e.clientLeft)/n,y:(t.y-i.top-e.clientTop)/o};return{center:t,offsetCenter:a}}var uS={srcElement:"root",priority:0},cm=class{constructor(e){this.handleEvent=t=>{if(this.isEmpty())return;let i=this._normalizeEvent(t),n=t.srcEvent.target;for(;n&&n!==i.rootElement;){if(this._emit(i,n),i.handled)return;n=n.parentNode}this._emit(i,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,n=!1,o=!1){let{handlers:a,handlersByElement:l}=this,u=uS;typeof i=="string"||i&&i.addEventListener?u={...uS,srcElement:i}:i&&(u={...uS,...i});let c=l.get(u.srcElement);c||(c=[],l.set(u.srcElement,c));let h={type:e,handler:t,srcElement:u.srcElement,priority:u.priority};n&&(h.once=!0),o&&(h.passive=!0),a.push(h),this._active=this._active||!h.passive;let d=c.length-1;for(;d>=0&&!(c[d].priority>=h.priority);)d--;c.splice(d+1,0,h)}remove(e,t){let{handlers:i,handlersByElement:n}=this;for(let o=i.length-1;o>=0;o--){let a=i[o];if(a.type===e&&a.handler===t){i.splice(o,1);let l=n.get(a.srcElement);l.splice(l.indexOf(a),1),l.length===0&&n.delete(a.srcElement)}}this._active=i.some(o=>!o.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let n=!1,o=()=>{e.handled=!0},a=()=>{e.handled=!0,n=!0},l=[];for(let u=0;u<i.length;u++){let{type:c,handler:h,once:d}=i[u];if(h({...e,type:c,stopPropagation:o,stopImmediatePropagation:a}),d&&l.push(i[u]),n)break}for(let u=0;u<l.length;u++){let{type:c,handler:h}=l[u];this.remove(c,h)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,...YT(e),...$T(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}};var PG={events:null,recognizers:null,recognizerOptions:{},Manager:MT,touchAction:"none",tabIndex:0},Nd=class{constructor(e=null,t){this._onBasicInput=n=>{let{srcEvent:o}=n,a=NT[o.type];a&&this.manager.emit(a,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options={...PG,...t},this.events=new Map,this.setElement(e);let{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;let{options:t}=this,i=t.Manager;this.manager=new i(e,{touchAction:t.touchAction,recognizers:t.recognizers||_T}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(aS).forEach(n=>{let o=this.manager.get(n);o&&aS[n].forEach(a=>{o.recognizeWith(a)})});for(let n in t.recognizerOptions){let o=this.manager.get(n);if(o){let a=t.recognizerOptions[n];delete a.enable,o.set(a)}}this.wheelInput=new sm(e,this._onOtherEvent,{enable:!1}),this.moveInput=new am(e,this._onOtherEvent,{enable:!1}),this.keyInput=new lm(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new um(e,this._onOtherEvent,{enable:!1});for(let[n,o]of this.events)o.isEmpty()||(this._toggleRecognizer(o.recognizerName,!0),this.manager.on(n,o.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let n=i.get(e);if(n&&n.options.enable!==t){n.set({enable:t});let o=BT[e];o&&!this.options.recognizers&&o.forEach(a=>{let l=i.get(a);t?(l.requireFailure(e),n.dropRequireFailure(a)):l.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,i,n,o){if(typeof e!="string"){i=t;for(let h in e)this._addEventHandler(h,e[h],i,n,o);return}let{manager:a,events:l}=this,u=lS[e]||e,c=l.get(u);c||(c=new cm(this),l.set(u,c),c.recognizerName=DT[u]||u,a&&a.on(u,c.handleEvent)),c.add(e,t,i,n,o),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(let a in e)this._removeEventHandler(a,e[a]);return}let{events:i}=this,n=lS[e]||e,o=i.get(n);if(!!o&&(o.remove(e,t),o.isEmpty())){let{recognizerName:a}=o,l=!1;for(let u of i.values())if(u.recognizerName===a&&!u.isEmpty()){l=!0;break}l||this._toggleRecognizer(a,!1)}}};function zl(){}var yG=({isDragging:s})=>s?"grabbing":"grab",ZT={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:zl,onResize:zl,onViewStateChange:zl,onInteractionStateChange:zl,onBeforeRender:zl,onAfterRender:zl,onLoad:zl,onError:s=>he.error(s.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:yG,getTooltip:null,debug:!1,drawPickingColors:!1},Hl=class{constructor(e){y(this,"props",void 0),y(this,"width",0),y(this,"height",0),y(this,"userData",{}),y(this,"canvas",null),y(this,"viewManager",null),y(this,"layerManager",null),y(this,"effectManager",null),y(this,"deckRenderer",null),y(this,"deckPicker",null),y(this,"eventManager",null),y(this,"tooltip",null),y(this,"metrics",void 0),y(this,"animationLoop",void 0),y(this,"stats",void 0),y(this,"viewState",void 0),y(this,"cursorState",void 0),y(this,"_needsRedraw",void 0),y(this,"_pickRequest",void 0),y(this,"_lastPointerDownInfo",null),y(this,"_metricsCounter",void 0),y(this,"_onPointerMove",t=>{let{_pickRequest:i}=this;if(t.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(t.leftButton||t.rightButton)return;{let n=t.offsetCenter;if(!n)return;i.x=n.x,i.y=n.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=t}),y(this,"_onEvent",t=>{let i=By[t.type],n=t.offsetCenter;if(!i||!n||!this.layerManager)return;let o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:l}=a,u=l&&(l[i.handler]||l.props[i.handler]),c=this.props[i.handler],h=!1;u&&(h=u.call(l,a,t)),!h&&c&&c(a,t)}),y(this,"_onPointerDown",t=>{let i=t.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo}),this.props={...ZT,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&he.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),Tl()==="IE"&&he.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||typeof document<"u"&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new mo({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&Bn.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,n,o,a,l;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(e=this.layerManager)===null||e===void 0||e.finalize(),this.layerManager=null,(t=this.viewManager)===null||t===void 0||t.finalize(),this.viewManager=null,(i=this.effectManager)===null||i===void 0||i.finalize(),this.effectManager=null,(n=this.deckRenderer)===null||n===void 0||n.finalize(),this.deckRenderer=null,(o=this.deckPicker)===null||o===void 0||o.finalize(),this.deckPicker=null,(a=this.eventManager)===null||a===void 0||a.destroy(),this.eventManager=null,(l=this.tooltip)===null||l===void 0||l.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var u;(u=this.canvas.parentElement)===null||u===void 0||u.removeChild(this.canvas),this.canvas=null}}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&he.removed("onLayerHover","onHover")(),"onLayerClick"in e&&he.removed("onLayerClick","onClick")(),e.initialViewState&&!Dn(this.props.initialViewState,e.initialViewState)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),n=this.layerManager.needsRedraw(e),o=this.effectManager.needsRedraw(e),a=this.deckRenderer.needsRedraw(e);return t=t||i||n||o||a,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0})||e;!t||(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}getViews(){return St(this.viewManager),this.viewManager.views}getViewports(e){return St(this.viewManager),this.viewManager.getViewports(e)}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_pick(e,t,i){let{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(t).timeStart();let o=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(t).timeEnd(),o}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),St(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||t===0){let o=Number.isFinite(t)?"".concat(t,"px"):t;this.canvas.style.width=o}if(i||i===0){var n;let o=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=((n=e.style)===null||n===void 0?void 0:n.position)||"absolute",this.canvas.style.height=o}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth||e.width,i=e.clientHeight||e.height;if(t!==this.width||i!==this.height){var n;this.width=t,this.height=i,(n=this.viewManager)===null||n===void 0||n.setProps({width:t,height:i}),this.props.onResize({width:t,height:i})}}_createAnimationLoop(e){let{width:t,height:i,gl:n,glOptions:o,debug:a,onError:l,onBeforeRender:u,onAfterRender:c,useDevicePixels:h}=e;return new dc({width:t,height:i,useDevicePixels:h,autoResizeViewport:!1,gl:n,onCreateContext:d=>oc({...o,...d,canvas:this.canvas,debug:a,onContextLost:()=>this._onContextLost()}),onInitialize:d=>this._setGLContext(d.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:u,onAfterRender:c,onError:l})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new _d({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){let{_pickRequest:e}=this;if(e.event){let{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let o=n,a=!1;for(let l of i){var t;o=l,a=((t=l.layer)===null||t===void 0?void 0:t.onHover(l,e.event))||a}if(!a&&this.props.onHover&&this.props.onHover(o,e.event),this.props.getTooltip&&this.tooltip){let l=this.props.getTooltip(o);this.tooltip.setTooltip(l,o.x,o.y)}e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,Ol(e,{enable:!0,copyState:!0})),this.tooltip=new im(this.canvas),ni(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);let t=new Bl;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new Nd(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(let n in By)this.eventManager.on(n,this._onEvent);this.viewManager=new Wg({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new Hg(e,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new Jg,this.deckRenderer=new tm(e),this.deckPicker=new rm(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{gl:i}=this.layerManager.context;ni(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:e,effects:this.effectManager.getEffects(),...t}),this.props.onAfterRender({gl:i})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),he.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=Ji.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}};y(Hl,"defaultProps",ZT);y(Hl,"VERSION",XC.VERSION);var _c=class{constructor(e,t){y(this,"opts",void 0),y(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:i}=this.source,{size:n}=t,o=i;if(i&&i.length!==n){o=new Float32Array(n);let a=t.elementOffset||0;for(let l=0;l<n;++l)o[l]=i[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function QT(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function hm(s){return s.stride||s.size*s.bytesPerElement}function KT(s,e){e.offset&&he.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=hm(s),i=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,n=e.elementOffset||0,o=i*t+n*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function SG(s,e){let t=KT(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var dm=class{constructor(e,t,i){y(this,"gl",void 0),y(this,"id",void 0),y(this,"size",void 0),y(this,"settings",void 0),y(this,"value",void 0),y(this,"doublePrecision",void 0),y(this,"_buffer",void 0),y(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;let n=t.logicalType||t.type,o=n===5130,{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0);let l;o?l=5126:!n&&t.isIndexed?l=e&&fd(e,at.ELEMENT_INDEX_UINT32)?5125:5123:l=n||5126;let u=QT(n||l||5126);this.doublePrecision=o,o&&t.fp64===!1&&(u=Float32Array),this.value=null,this.settings={...t,defaultType:u,defaultValue:a,logicalType:n,type:l,size:this.size,bytesPerElement:u.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new pe(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*hm(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Bn.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let i={},n=this.value instanceof Float64Array,o=SG(this.getAccessor(),t||{});return i[e]=new _c(this,o.high),i["".concat(e,"64Low")]=n?new _c(this,o.low):new Float32Array(this.size),i}if(t){let i=KT(this.getAccessor(),t);return{[e]:new _c(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:n}=this,o=i*n;if(t&&o&&t.length>=o){let a=new Array(n).fill(1/0),l=new Array(n).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<n;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this,i;ArrayBuffer.isView(e)?i={value:e}:e instanceof pe?i={buffer:e}:i=e;let n={...this.settings,...i};if(t.bufferAccessor=n,t.bounds=null,i.constant){let o=i.value;if(o=this._normalizeValue(o,[],0),this.settings.normalized&&(o=this.normalizeConstant(o)),!(!t.constant||!this._areValuesEqual(o,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=o}else if(i.buffer){let o=i.buffer;t.externalBuffer=o,t.constant=!1,this.value=i.value||null;let a=i.value instanceof Float64Array;n.type=i.type||o.accessor.type,n.bytesPerElement=o.accessor.BYTES_PER_ELEMENT*(a?2:1),n.stride=hm(n)}else if(i.value){this._checkExternalBuffer(i);let o=i.value;t.externalBuffer=null,t.constant=!1,this.value=o,n.bytesPerElement=o.BYTES_PER_ELEMENT,n.stride=hm(n);let{buffer:a,byteOffset:l}=this;this.doublePrecision&&o instanceof Float64Array&&(o=kg(o,n));let u=o.byteLength+l+n.stride*2;a.byteLength<u&&a.reallocate(u),a.setAccessor(null),a.subData({data:o,offset:l}),n.type=i.type||a.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?kg(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){let{state:i}=this,n=i.allocatedValue,o=Bn.allocate(n,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&n&&a.subData({data:n instanceof Float64Array?kg(n,this):n,offset:l})),i.allocatedValue=o,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));let i=this.settings.defaultType,n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&he.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:n,size:o}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e)return t[i]=n[0],t;switch(o){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let a=o;for(;--a>=0;)t[i+a]=Number.isFinite(e[a])?e[a]:n[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}};var JT=[],eI=[];function fs(s,e=0,t=1/0){let i=JT,n={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?i=s:s.length>0&&(eI.length=s.length,i=eI):i=JT,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),n.index=e-1),{iterable:i,objectInfo:n}}function fm(s){return s&&s[Symbol.asyncIterator]}function pm(s,e){let{size:t,stride:i,offset:n,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=i?i/l:t,c=n?n/l:0,h=Math.floor((s.length-c)/u);return(d,{index:f,target:P})=>{if(!o){let O=f*u+c;for(let D=0;D<t;D++)P[D]=s[O+D];return P}let E=o[f],v=o[f+1]||h,L;if(a){L=new Array(v-E);for(let O=E;O<v;O++){let D=O*u+c;P=new Array(t);for(let _=0;_<t;_++)P[_]=s[D+_];L[O-E]=P}}else if(u===t)L=s.subarray(E*t+c,v*t+c);else{L=new s.constructor((v-E)*t);let O=0;for(let D=E;D<v;D++){let _=D*u+c;for(let F=0;F<t;F++)L[O++]=s[_+F]}}return L}}var tI=[],Dd=[[0,1/0]];function rI(s,e){if(s===Dd||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],i=s.length,n=0;for(let o=0;o<i;o++){let a=s[o];a[1]<e[0]?(t.push(a),n=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(n,0,e),t}function cS(s){let{source:e,target:t,start:i=0,size:n,getData:o}=s,a=s.end||t.length,l=e.length,u=a-i;if(l>u){t.set(e.subarray(0,u),i);return}if(t.set(e,i),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<n;d++)t[i+c]=h[d]||0,c++}}function iI({source:s,target:e,size:t,getData:i,sourceStartIndices:n,targetStartIndices:o}){if(!Array.isArray(o))return cS({source:s,target:e,size:t,getData:i}),e;let a=0,l=0,u=i&&((h,d)=>i(h+l,d)),c=Math.min(n.length,o.length);for(let h=1;h<c;h++){let d=n[h]*t,f=o[h]*t;cS({source:s.subarray(a,d),target:e,start:l,end:f,size:t,getData:u}),a=d,l=f}return l<e.length&&cS({source:[],target:e,start:l,size:t,getData:u}),e}var xG={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function gm(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});let t=s.type||"interpolation";return{...xG[t],...e,...s,type:t}}function mm(s,e){let t=e.getBuffer();return t?[t,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function bm(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function Pm(s){s.push(s.shift())}function Fd(s,e){let{doublePrecision:t,settings:i,value:n,size:o}=s,a=t&&n instanceof Float64Array?2:1;return(i.noAlloc?n.length:e*o)*a}function ym({buffer:s,numInstances:e,attribute:t,fromLength:i,fromStartIndices:n,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=n&&c,d=Fd(t,e),f=t.isConstant;if(!h&&i>=d)return;let P=f?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!f){let O=o;o=(D,_)=>t.normalizeConstant(O(D,_))}let E=f?(O,D)=>o(P,D):(O,D)=>o(P.subarray(O,O+l),D),v=s.getData({length:i}),L=new Float32Array(d);iI({source:v,target:L,sourceStartIndices:n,targetStartIndices:c,size:l,getData:E}),s.byteLength<L.byteLength+u&&s.reallocate(L.byteLength+u),s.subData({data:L,offset:u})}var pa=class extends dm{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:Dd});y(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return gm(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:i=0,endRow:n=1/0}=t;this.state.updateRanges=rI(this.state.updateRanges,[i,n])}else this.state.updateRanges=Dd}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=tI}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,t.updateRanges!==Dd),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(n,this,{data:t,startRow:c,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:f})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),n.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let a=e;St(ArrayBuffer.isView(a.value),"invalid ".concat(n.accessor));let l=Boolean(a.size)&&a.size!==this.size;return i.binaryAccessor=pm(a.value,{size:a.size||this.size,stride:a.stride,offset:a.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:f,transform:P}=l,E=u.binaryAccessor||(typeof f=="function"?f:o[f]);St(typeof E=="function",'accessor "'.concat(f,'" is not a function'));let v=e.getVertexOffset(i),{iterable:L,objectInfo:O}=fs(t,i,n);for(let D of L){O.index++;let _=E(D,O);if(P&&(_=P.call(this,_)),d){let F=(O.index<d.length-1?d[O.index+1]:a)-d[O.index];if(_&&Array.isArray(_[0])){let X=v;for(let $ of _)e._normalizeValue($,c,X),X+=h}else _&&_.length>h?c.set(_,v):(e._normalizeValue(_,O.target,0),PT({target:c,source:O.target,start:v,count:F}));v+=F*h}else e._normalizeValue(_,c,v),v+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var Sm=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","interpolation"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.transition=new an(i),this.attribute=t,this.attributeInTransition=new pa(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=CG(e,t);let n={byteLength:0,usage:35050};this.buffers=[new pe(e,n),new pe(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}this.settings=e;let{gl:i,buffers:n,attribute:o}=this;Pm(n);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)ym({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=Fd(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:n[0],aTo:mm(i,o)},feedbackBuffers:{vCurrent:n[1]}})}update(){let e=this.transition.update();if(e){let{duration:t,easing:i}=this.settings,{time:n}=this.transition,o=n/t;i&&(o=i(o)),this.transform.run({uniforms:{time:o}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0}},vG=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function CG(s,e){let t=bm(e.size);return new rn(s,{vs:vG,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var Em=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","spring"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"texture",void 0),y(this,"framebuffer",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new an(i),this.attribute=t,this.attributeInTransition=new pa(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=TG(e),this.framebuffer=IG(e,this.texture),this.transform=AG(e,t,this.framebuffer);let n={byteLength:0,usage:35050};this.buffers=[new pe(e,n),new pe(e,n),new pe(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:i,buffers:n,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)ym({buffer:l,...a});this.settings=e,this.currentStartIndices=o.startIndices,this.currentLength=Fd(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:mm(i,o)}})}update(){let{buffers:e,transform:t,framebuffer:i,transition:n}=this;if(!n.update())return!1;let a=this.settings;return t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:a.stiffness,damping:a.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),Pm(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),os(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}};function AG(s,e,t){let i=bm(e.size);return new rn(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function TG(s){return new Xe(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function IG(s,e){return new _e(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var wG={interpolation:Sm,spring:Em},xm=class{constructor(e,{id:t,timeline:i}){y(this,"id",void 0),y(this,"isSupported",void 0),y(this,"gl",void 0),y(this,"timeline",void 0),y(this,"transitions",void 0),y(this,"needsRedraw",void 0),y(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=rn.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(let n in e){let o=e[n],a=o.getTransitionSetting(t);!a||this._updateAttribute(n,o,a)}for(let n in this.transitions){let o=e[n];(!o||!o.getTransitionSetting(t))&&this._removeTransition(n)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){let n=this.transitions[e],o=!n||n.type!==i.type;if(o){if(!this.isSupported){he.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}n&&this._removeTransition(e);let a=wG[i.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(he.error("unsupported transition type '".concat(i.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}};var nI="attributeManager.invalidate",LG="attributeManager.updateStart",OG="attributeManager.updateEnd",RG="attribute.updateStart",MG="attribute.allocate",_G="attribute.updateEnd",vm=class{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"attributes",void 0),y(this,"updateTriggers",void 0),y(this,"needsRedraw",void 0),y(this,"userData",void 0),y(this,"stats",void 0),y(this,"attributeTransitionManager",void 0),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new xm(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(let t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);Ot(nI,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);Ot(nI,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:o={},buffers:a={},context:l={}}){let u=!1;Ot(LG,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=i,h.numInstances=t,o[c]&&he.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(typeof d=="string"?a[d]:void 0,e.startIndices)||typeof d=="string"&&!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}u&&Ot(OG,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!i.hasAttribute(o)&&(n[o]=a)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let i={};for(let n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}_add(e,t={}){for(let i in e){let n=e[i];this.attributes[i]=this._createAttribute(i,n,t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){let n={...t,id:e,size:t.isIndexed&&1||t.size||1,divisor:i.instanced?1:t.divisor||0};return new pa(this.gl,n)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(n=>{e[n]||(e[n]=[]),e[n].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:n}=this,o=n[e];return o&&o.forEach(a=>{let l=i[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:i}=e;if(Ot(RG,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&Ot(MG,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,Ot(_G,t,i))}};var Cm=class extends an{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:o}}=this,a=o(e/n);this._value=Fl(t,i,a)}};var oI=1e-5;function sI(s,e,t,i,n){let o=e-s,l=(t-e)*n,u=-o*i;return l+u+o+e}function BG(s,e,t,i,n){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=sI(s[a],e[a],t[a],i,n);return o}return sI(s,e,t,i,n)}function aI(s,e){if(Array.isArray(s)){let t=0;for(let i=0;i<s.length;i++){let n=s[i]-e[i];t+=n*n}return Math.sqrt(t)}return Math.abs(s-e)}var Am=class extends an{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=BG(o,a,t,i,n),u=aI(l,t),c=aI(l,a);u<oI&&c<oI&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var NG={interpolation:Cm,spring:Am},Tm=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(n=gm(n),!n)return;let a=NG[n.type];if(!a){he.error("unsupported transition type '".concat(n.type,"'"))();return}let l=new a(this.timeline);l.start({...n,fromValue:t,toValue:i}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function uI(s){let e=dS(s);for(let t in e){let i=e[t],{validate:n}=i;if(n&&!n(s[t],i))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function cI(s,e){let t=hI({newProps:s,oldProps:e,propTypes:dS(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=FG(s,e),n=!1;return i||(n=GG(s,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:n,extensionsChanged:VG(s,e),transitionsChanged:DG(s,e)}}function DG(s,e){if(!s.transitions)return!1;let t={},i=dS(s),n=!1;for(let o in s.transitions){let a=i[o],l=a&&a.type;(l==="number"||l==="color"||l==="array")&&hS(s[o],e[o],a)&&(t[o]=!0,n=!0)}return n?t:!1}function hI({newProps:s,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:n="props"}){if(e===s)return!1;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(n," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(n,".").concat(o," added");let a=hS(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(n,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=hS(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}}return!1}function hS(s,e,t){let i=t&&t.equal;return i&&!i(s,e,t)||!i&&(i=s&&e&&s.equals,i&&!i.call(s,e))?"changed deeply":!i&&e!==s?"changed shallowly":null}function FG(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1,{dataComparator:i,_dataDiff:n}=s;return i?i(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&n&&(t=n(s.data,e.data)||t),t}function GG(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&lI(s,e,"all"))return{all:!0};let t={},i=!1;for(let n in s.updateTriggers)n!=="all"&&lI(s,e,n)&&(t[n]=!0,i=!0);return i?t:!1}function VG(s,e){if(e===null)return!0;let t=e.extensions,{extensions:i}=s;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let n=0;n<i.length;n++)if(!i[n].equals(t[n]))return!0;return!1}function lI(s,e,t){let i=s.updateTriggers[t];i=i??{};let n=e.updateTriggers[t];return n=n??{},hI({oldProps:n,newProps:i,triggerName:t})}function dS(s){let e=s[Ac],t=e&&e.constructor;return t?t._propTypes:{}}var kG="count(): argument not an object",UG="count(): argument not a container";function dI(s){if(!HG(s))throw new Error(kG);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(zG(s))return Object.keys(s).length;throw new Error(UG)}function zG(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function HG(s){return s!==null&&typeof s=="object"}function fI(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){let i=t.modules.findIndex(n=>n.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let i={...s.inject};for(let n in e.inject)i[n]=(i[n]||"")+e.inject[n];t.inject=i}return t}var WG={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},fS={};function pI(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Xe)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={[10241]:e.data.length>1?9985:9729});let n=new Xe(t,{...e,parameters:{...WG,...i,...s.props.textureParameters}});return fS[n.id]=!0,n}function gI(s){!s||!(s instanceof Xe)||fS[s.id]&&(s.delete(),delete fS[s.id])}var jG={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||Vd(s)&&(s.length===3||s.length===4)},equal(s,e,t){return pS(s,e)}},accessor:{validate(s,e){let t=Im(s);return t==="function"||t===Im(e.value)},equal(s,e,t){return typeof e=="function"?!0:pS(s,e)}},array:{validate(s,e){return e.optional&&!s||Vd(s)},equal(s,e,t){return t.compare?pS(s,e):s===e}},object:{equal(s,e,t){return t.compare?Dn(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:i}=t.props;return i&&s?i(s):s}},image:{transform:(s,e,t)=>pI(t,s),release:s=>{gI(s)}}};function pS(s,e){if(s===e)return!0;if(!Vd(s)||!Vd(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}function mI(s){let e={},t={},i={};for(let[n,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)i[n]=Array.isArray(a)?a:[a];else{let l=qG(n,o);e[n]=l,t[n]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function qG(s,e){switch(Im(e)){case"object":return Gd(s,e);case"array":return Gd(s,{type:"array",value:e,compare:!1});case"boolean":return Gd(s,{type:"boolean",value:e});case"number":return Gd(s,{type:"number",value:e});case"function":return Gd(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function Gd(s,e){return"type"in e?{name:s,...jG[e.type],...e}:"value"in e?{name:s,type:Im(e.value),...e}:{name:s,type:"object",value:e}}function Vd(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function Im(s){return Vd(s)?"array":s===null?"null":typeof s}function bI(s,e){let t=PI(s.constructor),i=Object.create(t);i[Ac]=s,i[Ao]={},i[Nn]={};for(let n=0;n<e.length;++n){let o=e[n];for(let a in o)i[a]=o[a]}return Object.freeze(i),i}function PI(s){let e=wm(s,"_mergedDefaultProps");return e||(XG(s),s._mergedDefaultProps)}function XG(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),i=PI(t),n=wm(s,"defaultProps")||{},o=mI(n),a=YG(o.defaultProps,i,s),l={...t._propTypes,...o.propTypes};ZG(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};$G(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function YG(s,e,t){let i=Object.create(null);Object.assign(i,e,s);let n=KG(t);return delete s.id,Object.defineProperties(i,{id:{writable:!0,value:n}}),i}function $G(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(i){let n="".concat(this.id,": ").concat(t);for(let o of e[t])yI(this,o)||(this[o]=i);he.deprecated(n,e[t].join("/"))()}})}function ZG(s,e){let t={},i={};for(let n in e){let o=e[n],{name:a,value:l}=o;o.async&&(t[a]=l,i[a]=QG(a))}s[cs]=t,s[Ao]={},Object.defineProperties(s,i)}function QG(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||fm(e)?this[Ao][s]=e:this[Nn][s]=e},get(){if(this[Nn]){if(s in this[Nn])return this[Nn][s]||this[cs][s];if(s in this[Ao]){let e=this[Ac]&&this[Ac].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[cs][s]}}return this[cs][s]}}}function yI(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function wm(s,e){return yI(s,e)&&s[e]}function KG(s){let e=wm(s,"layerName")||wm(s,"componentName");return e||he.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var JG=0,Bc=class{constructor(...e){y(this,"id",void 0),y(this,"props",void 0),y(this,"count",void 0),this.props=bI(this,e),this.id=this.props.id,this.count=JG++}clone(e){let{props:t}=this,i={};for(let n in t[cs])n in t[Nn]?i[n]=t[Nn][n]:n in t[Ao]&&(i[n]=t[Ao][n]);return new this.constructor({...t,...i,...e})}};y(Bc,"componentName","Component");y(Bc,"defaultProps",{});var eV=Object.freeze({}),Lm=class{constructor(e){y(this,"component",void 0),y(this,"onAsyncPropUpdated",void 0),y(this,"asyncProps",void 0),y(this,"oldProps",void 0),y(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||eV}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[Nn]||{},i=e[Ao]||e,n=e[cs]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in i){let a=i[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return t}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(fm(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let n=i.pendingLoadCount;t.then(o=>{o=this._postProcessValue(i,o),this._setAsyncPropValue(e,o,n),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let n=i.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,n)}this._onResolve(e,o)}_postProcessValue(e,t){let i=e.type;return i&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let n=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var Om=class extends Lm{constructor({attributeManager:e,layer:t}){super(t);y(this,"attributeManager",void 0),y(this,"needsRedraw",void 0),y(this,"needsUpdate",void 0),y(this,"subLayers",void 0),y(this,"usesPickingColorCache",void 0),y(this,"changeFlags",void 0),y(this,"viewport",void 0),y(this,"uniformTransitions",void 0),y(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let i=this.component.props.fetch;return i?i(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let i=this.component.props.onDataLoad;e==="data"&&i&&i(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var tV="layer.changeFlag",rV="layer.initialize",iV="layer.update",nV="layer.finalize",oV="layer.matched",SI=2**24-1,sV=Object.freeze([]),aV=la(({oldViewport:s,viewport:e})=>s.equals(e)),Io=new Uint8ClampedArray(0),lV={data:{type:"data",value:sV,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:i,loadOptions:n,signal:o})=>{let{resourceManager:a}=t.context;if(n=n||t.getLoadOptions(),i=i||t.props.loaders,o){var l;n={...n,fetch:{...(l=n)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!n&&(a.add({resourceId:s,data:bo(s,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>{var h;return(h=t.internalState)===null||h===void 0?void 0:h.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):bo(s,i,n)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:On.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Ve.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},ai=class extends Bc{constructor(...e){super(...e);y(this,"internalState",null),y(this,"lifecycle",ha.NO_STATE),y(this,"context",void 0),y(this,"state",void 0),y(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){St(this.internalState);let t=this.internalState.viewport||this.context.viewport,i=iS(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,o,a]=xc(i,t.pixelProjectionMatrix);return e.length===2?[n,o]:[n,o,a]}unproject(e){return St(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){St(this.internalState);let i=this.internalState.viewport||this.context.viewport;return mT(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Ve.DEFAULT||e===Ve.LNGLAT||e===Ve.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){St(e instanceof Uint8Array);let[t,i,n]=e;return t+i*256+n*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:dI(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:i,instancePositions:n}=t.attributes;return(e=i||n)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(let t of this.props.extensions)e=fI(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let u of i)t.invalidateAll(u);else t.invalidateAll();let{props:n,oldProps:o}=e,a=Number.isInteger(o.highlightedObjectIndex)||o.pickable,l=Number.isInteger(n.highlightedObjectIndex)||n.pickable;if(a!==l&&t){let{pickingColors:u,instancePickingColors:c}=t.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,t.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(e){for(let i of this.getModels())i.delete();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:n}=e;return n>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[n]),e}raiseError(e,t){var i,n;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((i=(n=this.props).onError)!==null&&i!==void 0&&i.call(n,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!aV({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();!t||(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),n=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:n,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let n in t)Object.defineProperty(i,n,{value:t[n]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(Io.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>SI&&he.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Io=Bn.allocate(Io,t,{size:3,copy:!0,maxCount:Math.max(t,SI)});let n=Math.floor(Io.length/3),o=[];for(let a=i;a<n;a++)this.encodePickingColor(a,o),Io[a*3+0]=o[0],Io[a*3+1]=o[1],Io[a*3+2]=o[2]}e.value=Io.subarray(0,t*3)}_setModelAttributes(e,t){let i=this.getAttributeManager(),n=e.userData.excludeAttributes||{},o=i.getShaderAttributes(t,n);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i;if(!n)return;let o=n.getVertexOffset(e),a=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;!i||(this.internalState.usesPickingColorCache&&i.value.buffer!==Io.buffer&&(i.value=Io.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){St(!this.internalState),St(Number.isFinite(this.props.coordinateSystem)),Ot(rV,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Om({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(he.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Tm(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Ot(oV,this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(Ot(iV,this,e),!e)return;let t=this.props,i=this.context,n=this.internalState,o=i.viewport,a=this._updateUniformTransition();n.propsInTransition=a,i.viewport=n.viewport||o,this.props=a;try{let l=this._getUpdateParams(),u=this.getModels();if(i.gl)this.updateState(l);else try{this.updateState(l)}catch{}for(let h of this.props.extensions)h.updateState.call(this,l,h);let c=this.getModels()[0]!==u[0];this._postUpdate(l,c)}finally{i.viewport=o,this.props=t,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){Ot(nV,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();let n=this.props,o=this.context;this.props=this.internalState.propsInTransition||n;let a=this.props.opacity;t.opacity=Math.pow(a,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:l}=this.props,u=l&&l(t)||[0,0];ni(o.gl,{polygonOffset:u}),ht(o.gl,i,()=>{let c={moduleParameters:e,uniforms:t,parameters:i,context:o};for(let h of this.props.extensions)h.draw.call(this,c,h);this.draw(c)})}finally{this.props=n}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let n in e)if(e[n]){let o=!1;switch(n){case"dataChanged":let a=e[n],l=t[n];a&&Array.isArray(l)&&(t.dataChanged=Array.isArray(a)?l.concat(a):a,o=!0);default:t[n]||(t[n]=e[n],o=!0)}o&&Ot(tV,this,n,e)}let i=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i=cI(e,t);if(i.updateTriggersChanged)for(let o in i.updateTriggersChanged)i.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(i.transitionsChanged)for(let o in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(o,t[o],e[o],(n=e.transitions)===null||n===void 0?void 0:n[o])}return this.setChangeFlags(i)}validateProps(){uI(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new vm(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:n}=e;this.setNeedsRedraw(),this._updateAttributes();let{model:o}=this.state;o?.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:l,highlightColor:u}=i;if(t||n.autoHighlight!==a||n.highlightedObjectIndex!==l||n.highlightColor!==u){let c={};a||(c.pickingSelectedColor=null),Array.isArray(u)&&(c.pickingHighlightColor=u),Number.isInteger(l)&&(c.pickingSelectedColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setModuleParameters(c)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let i=this.getAttributeManager(),n=i?i.getNeedsRedraw(e):!1;return t=t||n,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};y(ai,"defaultProps",lV);y(ai,"layerName","Layer");var uV="compositeLayer.renderLayers",wo=class extends ai{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){var t;let{opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:P,positionFormat:E,modelMatrix:v,extensions:L,fetch:O,operation:D,_subLayerProps:_}=this.props,F={id:"",updateTriggers:{},opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:P,positionFormat:E,modelMatrix:v,extensions:L,fetch:O,operation:D},X=_&&e.id&&_[e.id],$=X&&X.updateTriggers,se=e.id||"sublayer";if(X){let ie=this.constructor._propTypes,oe=e.type?e.type._propTypes:{};for(let ue in X){let Se=oe[ue]||ie[ue];Se&&Se.type==="accessor"&&(X[ue]=this.getSubLayerAccessor(X[ue]))}}Object.assign(F,e,X),F.id="".concat(this.props.id,"-").concat(se),F.updateTriggers={all:(t=this.props.updateTriggers)===null||t===void 0?void 0:t.all,...e.updateTriggers,...$};for(let ie of L){let oe=ie.getSubLayerProps.call(this,ie);oe&&Object.assign(F,oe,{updateTriggers:Object.assign(F.updateTriggers,oe.updateTriggers)})}return F}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,n=!i||this.needsUpdate();if(n){let o=this.renderLayers();i=Tc(o,Boolean),this.internalState.subLayers=i}Ot(uV,this,n,i);for(let o of i)o.parent=this}};y(wo,"layerName","CompositeLayer");var kd=class{constructor(e){y(this,"opts",void 0),y(this,"typedArrayManager",void 0),y(this,"indexStarts",[0]),y(this,"vertexStarts",[0]),y(this,"vertexCount",0),y(this,"instanceCount",0),y(this,"attributes",void 0),y(this,"_attributeDefs",void 0),y(this,"data",void 0),y(this,"getGeometry",void 0),y(this,"geometryBuffer",void 0),y(this,"buffers",void 0),y(this,"positionSize",void 0),y(this,"normalize",void 0);let{attributes:t={}}=e;this.typedArrayManager=Bn,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:n,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=i,this.normalize=u,o&&(St(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(i.positions=o)),this.geometryBuffer=i.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){let t=e.value||e;return ArrayBuffer.isView(t)?pm(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){let{attributes:i,buffers:n,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in n)a.release(i[l]),i[l]=null;else{let u=o[l];u.copy=t,i[l]=a.allocate(i[l],e,u)}}_forEachGeometry(e,t,i){let{data:n,getGeometry:o}=this,{iterable:a,objectInfo:l}=fs(n,t,i);for(let u of a){l.index++;let c=o?o(u,l):null;e(c,l.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!a)this._forEachGeometry((d,f)=>{let P=d&&this.normalizeGeometry(d);c[f]=P,i[f+1]=i[f]+(P?this.getGeometrySize(P):0)},l,u),n=i[i.length-1];else if(i=o.startIndices,n=i[o.length]||0,ArrayBuffer.isView(a))n=n||a.length/this.positionSize;else if(a instanceof pe){let d=a.accessor.stride||this.positionSize*4;n=n||a.byteLength/d}else if(a.buffer){let d=a.stride||this.positionSize*4;n=n||a.buffer.byteLength/d}else if(a.value){let d=a.value,f=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;n=n||d.length/f}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;let h={};this._forEachGeometry((d,f)=>{let P=c[f]||d;h.vertexStart=i[f],h.indexStart=t[f];let E=f<i.length-1?i[f+1]:n;h.geometrySize=E-i[f],h.geometryIndex=f,this.updateGeometryAttributes(P,h)},l,u),this.vertexCount=t[t.length-1]}};var EI=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var xI=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var cV=1024,hV=4,vI=()=>{},dV={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function fV(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function pV(s,e,t,i){return t===e.width&&i===e.height?e:(s.canvas.height=i,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,i),s.canvas)}function Ud(s){return s&&(s.id||s.url)}function gV(s,e,t){let i=s.width,n=s.height,o=uc(s,{width:e,height:t});return og(s,o,{targetY:0,width:i,height:n}),s.delete(),o}function CI(s,e,t){for(let i=0;i<e.length;i++){let{icon:n,xOffset:o}=e[i],a=Ud(n);s[a]={...n,x:o,y:t}}}function mV({icons:s,buffer:e,mapping:t={},xOffset:i=0,yOffset:n=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=Ud(c);if(!t[h]){let{height:d,width:f}=c;i+f+e>a&&(CI(t,l,n),i=0,n=o+n+e,o=0,l=[]),l.push({icon:c,xOffset:i}),i=i+f+e,o=Math.max(o,d)}}return l.length>0&&CI(t,l,n),{mapping:t,rowHeight:o,xOffset:i,yOffset:n,canvasWidth:a,canvasHeight:fV(o+n+e)}}function bV(s,e,t){if(!s||!e)return null;t=t||{};let i={},{iterable:n,objectInfo:o}=fs(s);for(let a of n){o.index++;let l=e(a,o),u=Ud(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!i[u]&&(!t[u]||l.url!==t[u].url)&&(i[u]={...l,source:a,sourceIndex:o.index})}return i}var Rm=class{constructor(e,{onUpdate:t=vI,onError:i=vI}){y(this,"gl",void 0),y(this,"onUpdate",void 0),y(this,"onError",void 0),y(this,"_loadOptions",null),y(this,"_texture",null),y(this,"_externalTexture",null),y(this,"_mapping",{}),y(this,"_pendingCount",0),y(this,"_autoPacking",!1),y(this,"_xOffset",0),y(this,"_yOffset",0),y(this,"_rowHeight",0),y(this,"_buffer",hV),y(this,"_canvasWidth",cV),y(this,"_canvasHeight",0),y(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=i}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?Ud(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n}){if(e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),n&&(this._mapping=n),i){var o;(o=this._texture)===null||o===void 0||o.delete(),this._texture=null,this._externalTexture=i}}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;let i=Object.values(bV(e,t,this._mapping)||{});if(i.length>0){let{mapping:n,xOffset:o,yOffset:a,rowHeight:l,canvasHeight:u}=mV({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=n,this._xOffset=o,this._yOffset=a,this._canvasHeight=u,this._texture||(this._texture=new Xe(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:dV})),this._texture.height!==this._canvasHeight&&(this._texture=gV(this._texture,this._canvasWidth,this._canvasHeight)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let i of e)this._pendingCount++,bo(i.url,wl,this._loadOptions).then(n=>{let o=Ud(i),{x:a,y:l,width:u,height:c}=this._mapping[o],h=pV(t,n,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(n=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:n})}).finally(()=>{this._pendingCount--})}};var AI=[0,0,0,255],PV={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:AI},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},ps=class extends ai{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:EI,fs:xI,modules:[xo,ca]})}initializeState(){this.state={iconManager:new Rm(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:AI},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager(),{iconAtlas:a,iconMapping:l,data:u,getIcon:c}=t,{iconManager:h}=this.state,d=a||this.internalState.isAsyncPropLoading("iconAtlas");if(h.setProps({loadOptions:t.loadOptions,autoPacking:!d,iconAtlas:a,iconMapping:l}),d?i.iconMapping!==t.iconMapping&&o.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&h.packIcons(u,c),n.extensionsChanged){var f;let{gl:P}=this.context;(f=this.state.model)===null||f===void 0||f.delete(),this.state.model=this._getModel(P),o.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:on[o],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new Hr(e,{...this.getShaders(),id:this.props.id,geometry:new nn({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;let i=(t=this.getCurrentLayer())===null||t===void 0?void 0:t.props.onIconError;i?i(e):he.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:n=t/2,anchorY:o=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-n,i/2-o]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let{x:t,y:i,width:n,height:o}=this.state.iconManager.getIconMapping(e);return[t,i,n,o]}};y(ps,"defaultProps",PV);y(ps,"layerName","IconLayer");var gS;(function(s){s[s.CLOCKWISE=1]="CLOCKWISE",s[s.COUNTER_CLOCKWISE=-1]="COUNTER_CLOCKWISE"})(gS||(gS={}));function Wl(s,e){let t=e.length,i=s.length;if(i>0){let n=!0;for(let o=0;o<t;o++)if(s[i-t+o]!==e[o]){n=!1;break}if(n)return!1}for(let n=0;n<t;n++)s[i+n]=e[n];return!0}function Mm(s,e){let t=e.length;for(let i=0;i<t;i++)s[i]=e[i]}function zd(s,e,t,i,n=[]){let o=i+e*t;for(let a=0;a<t;a++)n[a]=s[o+a];return n}function mS(s,e,t,i,n=[]){let o,a;if(t&8)o=(i[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(i[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(i[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(i[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)n[l]=(a&1)===l?i[a]:o*(e[l]-s[l])+s[l];return n}function _m(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function Hd(s,e){let{size:t=2,broken:i=!1,gridResolution:n=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e||{},u=(l-a)/t,c=[],h=[c],d=zd(s,0,t,a),f,P,E=EV(d,n,o,[]),v=[];Wl(c,d);for(let L=1;L<u;L++){for(f=zd(s,L,t,a,f),P=_m(f,E);P;){mS(d,f,P,E,v);let O=_m(v,E);O&&(mS(d,v,O,E,v),P=O),Wl(c,v),Mm(d,v),xV(E,n,P),i&&c.length>t&&(c=[],h.push(c),Wl(c,d)),P=_m(f,E)}Wl(c,f),Mm(d,f)}return i?h:h[0]}function EV(s,e,t,i){let n=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return i[0]=n,i[1]=o,i[2]=n+e,i[3]=o+e,i}function xV(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function bS(s,e){let{size:t=2,startIndex:i=0,endIndex:n=s.length,normalize:o=!0}=e||{},a=s.slice(i,n);CV(a,t,0,n-i);let l=Hd(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)AV(u,t);return l}function CV(s,e,t,i){let n=s[0],o;for(let a=t;a<i;a+=e){o=s[a];let l=o-n;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=n=o}}function AV(s,e){let t,i=s.length/e;for(let o=0;o<i&&(t=s[o*e],(t+180)%360===0);o++);let n=-Math.round(t/360)*360;if(n!==0)for(let o=0;o<i;o++)s[o*e]+=n}function II(s,e,t,i){let n;if(Array.isArray(s[0])){let o=s.length*e;n=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)n[a*e+l]=s[a][l]||0}else n=s;return t?Hd(n,{size:e,gridResolution:t}):i?bS(n,{size:e}):n}var IV=1,wV=2,PS=4,Bm=class extends kd{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?II(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(wI(e)){let i=0;for(let n of e)i+=this.getGeometrySize(n);return i}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&wI(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let i=this.attributes.segmentTypes,n=e?this.isClosed(e):!1,{vertexStart:o,geometrySize:a}=t;i.fill(0,o,o+a),n?(i[o]=PS,i[o+a-2]=PS):(i[o]+=IV,i[o+a-2]+=wV),i[o+a-1]=PS}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i||!e)return;let{vertexStart:n,geometrySize:o}=t,a=new Array(3);for(let l=n,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),i[l*3]=a[0],i[l*3+1]=a[1],i[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);let o=t*n;return i[0]=e[o],i[1]=e[o+1],i[2]=n===3&&e[o+2]||0,i}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}};function wI(s){return Array.isArray(s[0])}var LI=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var OI=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var RI=[0,0,0,255],LV={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:RI},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},yS={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},ga=class extends ai{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:LI,fs:OI,modules:[xo,ca]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:yS,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:yS,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:yS,defaultValue:RI},instancePickingColors:{size:3,type:5121,accessor:(i,{index:n,target:o})=>this.encodePickingColor(i&&i.__source?i.__source.index:n,o)}}),this.setState({pathTesselator:new Bm({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);let{props:t,changeFlags:i}=e,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),n.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:n,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:on[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Hr(e,{...this.getShaders(),id:this.props.id,geometry:new nn({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};y(ga,"defaultProps",LV);y(ga,"layerName","PathLayer");var MI=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var _I=192/256,BI=[],OV={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},Nc=class extends ps{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:MI}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:i,target:n})=>this.encodePickingColor(i,n)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map(o=>o/255),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&he.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:_I,outlineBuffer:n?Math.max(i,_I*(1-n)):-1,gamma:i,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):BI}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):BI}};y(Nc,"defaultProps",OV);y(Nc,"layerName","MultiIconLayer");var jI=be(FI());var _V=32,BV=[];function NV(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function GI({characterSet:s,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:n,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a;for(let d of s)if(!o[d]){let f=e(d);c+f+i*2>n&&(c=0,u++),o[d]={x:c+i,y:l+u*(t+i*2)+i,width:f,height:t},c+=f+i*2}let h=t+i*2;return{mapping:o,xOffset:c,yOffset:l+u*h,canvasHeight:NV(l+(u+1)*h)}}function VI(s,e,t,i){let n=0;for(let a=e;a<t;a++){var o;let l=s[a];n+=((o=i[l])===null||o===void 0?void 0:o.width)||0}return n}function kI(s,e,t,i,n,o){let a=e,l=0;for(let u=e;u<t;u++){let c=VI(s,u,u+1,n);l+c>i&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function DV(s,e,t,i,n,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=VI(s,l,u,n);c+d>i&&(a<l&&(o.push(l),a=l,c=0),d>i&&(d=kI(s,l,u,i,n,o),a=o[o.length-1])),l=u,c+=d}return c}function FV(s,e,t,i,n=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?kI(s,n,o,t,i,a):DV(s,n,o,t,i,a),a}function GV(s,e,t,i,n,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=i[c];h?(l||(l=h.height),n[u]=a+h.width/2,a+=h.width):(he.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),n[u]=a,a+=_V)}o[0]=a,o[1]=l}function ES(s,e,t,i,n){let o=Array.from(s),a=o.length,l=new Array(a),u=new Array(a),c=new Array(a),h=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,d=[0,0],f=[0,0],P=0,E=0,v=0;for(let L=0;L<=a;L++){let O=o[L];if((O===`
`||L===a)&&(v=L),v>E){let D=h?FV(o,t,i,n,E,v):BV;for(let _=0;_<=D.length;_++){let F=_===0?E:D[_-1],X=_<D.length?D[_]:v;GV(o,F,X,n,l,f);for(let $=F;$<X;$++)u[$]=P+f[1]/2,c[$]=f[0];P=P+f[1]*e,d[0]=Math.max(d[0],f[0])}E=v}O===`
`&&(l[E]=0,u[E]=0,c[E]=0,E++)}return d[1]=P,{x:l,y:u,rowWidth:c,size:d}}function UI({value:s,length:e,stride:t,offset:i,startIndices:n,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=i?i/a:0,c=n[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),f=s;if(l>1||u>0){let P=s.constructor;f=new P(c);for(let E=0;E<c;E++)f[E]=s[E*l+u]}for(let P=0;P<e;P++){let E=n[P],v=n[P+1]||c,L=f.subarray(E,v);d[P]=String.fromCodePoint.apply(null,L),h&&L.forEach(h.add,h)}if(h)for(let P of h)o.add(String.fromCodePoint(P));return{texts:d,characterCount:c}}var jd=class{constructor(e=5){y(this,"limit",void 0),y(this,"_cache",{}),y(this,"_order",[]),this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function VV(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var Fc={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:VV(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},zI=1024,kV=.9,HI=1.2,qI=3,Nm=new jd(qI);function UV(s,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);let i=Nm.get(s);if(!i)return t;for(let n in i.mapping)t.has(n)&&t.delete(n);return t}function zV(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function WI(s,e,t,i){s.font="".concat(i," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="alphabetic",s.textAlign="left"}function XI(s){he.assert(Number.isFinite(s)&&s>=qI,"Invalid cache limit"),Nm=new jd(s)}var Dm=class{constructor(){y(this,"props",{...Fc}),y(this,"_key",void 0),y(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return HI}setProps(e={}){Object.assign(this.props,e);let t=this._key;this._key=this._getKey();let i=UV(this._key,this.props.characterSet),n=Nm.get(this._key);if(n&&i.size===0){this._key!==t&&(this._atlas=n);return}let o=this._generateFontAtlas(this._key,i,n);this._atlas=o,Nm.set(this._key,o)}_generateFontAtlas(e,t,i){let{fontFamily:n,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=i&&i.data;d||(d=document.createElement("canvas"),d.width=zI);let f=d.getContext("2d");WI(f,n,a,o);let{mapping:P,canvasHeight:E,xOffset:v,yOffset:L}=GI({getFontWidth:O=>f.measureText(O).width,fontHeight:a*HI,buffer:l,characterSet:t,maxCanvasWidth:zI,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(d.height!==E){let O=f.getImageData(0,0,d.width,d.height);d.height=E,f.putImageData(O,0,0)}if(WI(f,n,a,o),u){let O=new jI.default(a,l,c,h,n,o),D=f.getImageData(0,0,O.size,O.size);for(let _ of t)zV(O.draw(_),D),f.putImageData(D,P[_].x-l,P[_].y+l)}else for(let O of t)f.fillText(O,P[O].x,P[O].y+a*kV);return{xOffset:v,yOffset:L,mapping:P,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}};var YI=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var $I=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var HV={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},Gc=class extends ai{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:YI,fs:$I,modules:[xo,ca]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;if(t.extensionsChanged){var i;let{gl:n}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(n),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:on[n],sizeScale:i,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new Hr(e,{...this.getShaders(),id:this.props.id,geometry:new nn({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Gc,"defaultProps",HV);y(Gc,"layerName","TextBackgroundLayer");var ZI={start:1,middle:0,end:-1},QI={top:1,center:0,bottom:-1},xS=[0,0,0,255],WV=1,jV={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:xS},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:Fc.characterSet},fontFamily:Fc.fontFamily,fontWeight:Fc.fontWeight,lineHeight:WV,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:xS},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:xS},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},ma=class extends wo{constructor(...e){super(...e);y(this,"state",void 0),y(this,"getBoundingRect",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{size:[f,P]}=ES(d,u,a,l,n),E=ZI[typeof c=="function"?c(t,i):c],v=QI[typeof h=="function"?h(t,i):h];return[(E-1)*f/2,(v-1)*P/2,f,P]}),y(this,"getIconOffsets",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{x:f,y:P,rowWidth:E,size:[v,L]}=ES(d,u,a,l,n),O=ZI[typeof c=="function"?c(t,i):c],D=QI[typeof h=="function"?h(t,i):h],_=f.length,F=new Array(_*2),X=0;for(let $=0;$<_;$++){let se=(1-O)*(v-E[$])/2;F[X++]=(O-1)*v/2+se+f[$],F[X++]=(D-1)*L/2+P[$]}return F})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new Dm}}updateState(e){let{props:t,oldProps:i,changeFlags:n}=e;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:o}=this.state,a={...e,characterSet:o,fontFamily:t,fontWeight:i};if(!n.mapping)return n.setProps(a),!0;for(let l in a)if(a[l]!==n.props[l])return n.setProps(a),!0;return!1}_updateText(){var e;let{data:t,characterSet:i}=this.props,n=(e=t.attributes)===null||e===void 0?void 0:e.getText,{getText:o}=this.props,a=t.startIndices,l,u=i==="auto"&&new Set;if(n&&a){let{texts:c,characterCount:h}=UI({...ArrayBuffer.isView(n)?{value:n}:n,length:t.length,startIndices:a,characterSet:u});l=h,o=(d,{index:f})=>c[f]}else{let{iterable:c,objectInfo:h}=fs(t);a=[0],l=0;for(let d of c){h.index++;let f=Array.from(o(d,h)||"");u&&f.forEach(u.add,u),l+=f.length,a.push(l)}}this.setState({getText:o,startIndices:a,numInstances:l,characterSet:u||i})}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:f,getAngle:P,getPixelOffset:E,getBackgroundColor:v,getBorderColor:L,getBorderWidth:O,backgroundPadding:D,background:_,billboard:F,fontSettings:X,outlineWidth:$,outlineColor:se,sizeScale:ie,sizeUnits:oe,sizeMinPixels:ue,sizeMaxPixels:Se,transitions:ve,updateTriggers:Ce}=this.props,De=this.getSubLayerClass("characters",Nc),Cr=this.getSubLayerClass("background",Gc);return[_&&new Cr({getFillColor:v,getLineColor:L,getLineWidth:O,padding:D,getPosition:h,getSize:f,getAngle:P,getPixelOffset:E,billboard:F,sizeScale:ie/this.state.fontAtlasManager.props.fontSize,sizeUnits:oe,sizeMinPixels:ue,sizeMaxPixels:Se,transitions:ve&&{getPosition:ve.getPosition,getAngle:ve.getAngle,getSize:ve.getSize,getFillColor:ve.getBackgroundColor,getLineColor:ve.getBorderColor,getLineWidth:ve.getBorderWidth,getPixelOffset:ve.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:Ce.getPosition,getAngle:Ce.getAngle,getSize:Ce.getSize,getFillColor:Ce.getBackgroundColor,getLineColor:Ce.getBorderColor,getLineWidth:Ce.getBorderWidth,getPixelOffset:Ce.getPixelOffset,getBoundingRect:{getText:Ce.getText,getTextAnchor:Ce.getTextAnchor,getAlignmentBaseline:Ce.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new De({sdf:X.sdf,smoothing:Number.isFinite(X.smoothing)?X.smoothing:Fc.smoothing,outlineWidth:$,outlineColor:se,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:f,getAngle:P,getPixelOffset:E,billboard:F,sizeScale:ie*n,sizeUnits:oe,sizeMinPixels:ue*n,sizeMaxPixels:Se*n,transitions:ve&&{getPosition:ve.getPosition,getAngle:ve.getAngle,getColor:ve.getColor,getSize:ve.getSize,getPixelOffset:ve.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:Ce.getText,getPosition:Ce.getPosition,getAngle:Ce.getAngle,getColor:Ce.getColor,getSize:Ce.getSize,getPixelOffset:Ce.getPixelOffset,getIconOffsets:{getText:Ce.getText,getTextAnchor:Ce.getTextAnchor,getAlignmentBaseline:Ce.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){XI(e)}};y(ma,"defaultProps",jV);y(ma,"layerName","TextLayer");var Ne={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var qV={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColors:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},XV=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceDepths;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  applyHighlight(int(instanceDepths.r));
}
`,YV=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,jl=class extends ai{getShaders(){return super.getShaders({vs:XV,fs:YV,modules:[xo,gc]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:Ne.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:Ne.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:Ne.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:Ne.UNSIGNED_BYTE,accessor:"getShape"}})}updateState(e){var a;super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=!1;if(n.extensionsChanged){let{gl:l}=this.context;(a=this.state.model)==null||a.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),o=!0}if((o||t.getDepth!==i.getDepth)&&t.getDepth&&this.state.model.setAttributes({instanceDepths:t.getDepth}),o||t.highlightColors!==i.highlightColors){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=t.highlightColors[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:i,cornerRadius:n,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:i,cornerRadius:n,lineWidthUnits:on[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new Hr(e,{...this.getShaders(),id:this.props.id,geometry:new nn({drawMode:Ne.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};jl.defaultProps=qV,jl.layerName="GeometryLayer";function qd(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!qd(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!e.hasOwnProperty(n)||!qd(s[n],e[n]))return!1;return!0}return!1}function KI(s){if(s instanceof Re){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}var Xd=class extends wo{renderLayers(){return[new jl(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:0,cornerRadius:$V(this.props.data[0]),getLineColor:JI,getFillColor:ZV}),new ma(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof Re)||t.labelSize),getPosition:e=>KI(e),getText:e=>tr.getDrawingObj(e.node).labelText,getColor:JI,getSize:this.props.getTextSize,sizeMaxPixels:48,sizeUnits:"common",characterSet:"auto"})]}};Xd.defaultProps={...ma.defaultProps,...jl.defaultProps,getTextSize:{type:"accessor",value:16}};function $V(s){return s?tr.getDrawingObj(s.node).xRad:0}function JI(s){let e=st.getDrawingObj(s.node);if(e){let t=e.color;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function ZV(s){let e=st.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}var QV="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",vS=4,ew=bo(QV,wl,{imagebitmap:{resizeWidth:256*vS,resizeHeight:128*vS}}),tw=KV({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},vS);function KV(s,e){for(let t in s){let i=s[t];i.x*=e,i.y*=e,i.width*=e,i.height*=e,i.anchorX&&(i.anchorX*=e),i.anchorY&&(i.anchorY*=e)}return s}var Yd=class extends wo{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let t=[];for(let i of e.props.data){let n=i;n.sourceArrowhead&&t.push({edge:i,type:"triangle-n",tip:n.sourceArrowhead.tipPosition,end:n.curve.start}),n.targetArrowhead&&t.push({edge:i,type:"triangle-n",tip:n.targetArrowhead.tipPosition,end:n.curve.end})}this.setState({arrows:t})}}renderLayers(){let e=this.props;return[new ga(e,this.getSubLayerProps({id:"path"}),{getPath:t=>Array.from(cf(t.curve,.01)).map(i=>[i.x,i.y]),getColor:rw,widthUnits:"pixels"}),new ps(this.getSubLayerProps({id:"arrow"}),{data:this.state.arrows,iconAtlas:ew,iconMapping:tw,getPosition:t=>[t.tip.x,t.tip.y],getColor:t=>rw(t.edge),getIcon:t=>t.type,getSize:t=>JV(t.tip,t.end),getAngle:t=>ek(t.tip,t.end),sizeUnits:"common"})]}};Yd.defaultProps={...ga.defaultProps};function rw(s){let e=st.getDrawingObj(s.edge);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function JV(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}function ek(s,e){let t=s.x-e.x,i=s.y-e.y;return-Math.atan2(i,t)/Math.PI*180}function Fm(s,e,t=!1){let i=!1,n=t,o=Re.getGeom(s.graph);function a(l){if(!l)return;for(let h of l.subgraphs())a(h);let u=tk(s,l,e),c=rk(l.layoutSettings,u);n=n||c.layoutChanged,i=i||c.routingChanged,l.layoutSettings=u}if(a(o),n||i)for(let l of o.deepEdges())l.requireRouting();return n?UP(o,null):i&&hl(o,Array.from(o.deepEdges()),null),o}function tk(s,e,t){let i=!1;for(let o of e.edges())if(o.sourceArrowhead!=null||o.targetArrowhead!=null){i=!0;break}let n;switch(t.layoutType){case"Sugiyama LR":{let o=n=new Xr;o.layerDirection=1;break}case"Sugiyama RL":{let o=n=new Xr;o.layerDirection=3;break}case"Sugiyama TB":{let o=n=new Xr;o.layerDirection=0;break}case"Sugiyama BT":{let o=n=new Xr;o.layerDirection=2;break}case"MDS":n=new lo;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.nodeCollection.edgeCount>4e3;if(i&&!o){let a=n=new Xr;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else n=new lo}}return t.edgeRoutingMode==null?n instanceof Xr?n.edgeRoutingSettings.EdgeRoutingMode=3:n.edgeRoutingSettings.EdgeRoutingMode=0:n.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,n}function rk(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.edgeRoutingSettings.EdgeRoutingMode!==e.edgeRoutingSettings.EdgeRoutingMode,i=t&&e.edgeRoutingSettings.EdgeRoutingMode===3,n=s instanceof Xr&&e instanceof Xr&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||i||n,routingChanged:t}}function iw(s,e,t){t[s]=t[s]||[],t[s].indexOf(e)<0&&t[s].push(e)}function CS(s,e,t){if(t[s]){let i=t[s].indexOf(e);i>=0&&t[s].splice(i,1)}}var Gm=class{constructor(){this._listeners={};this._onceListeners={}}on(e,t){iw(e,t,this._listeners)}once(e,t){iw(e,t,this._onceListeners)}off(e,t){CS(e,t,this._listeners),CS(e,t,this._onceListeners)}emit(e){var a,l;let t;typeof e=="string"?t={type:e}:t=e;let i=t.type;if(!this._listens(i))return;t.target=this;let n=((a=this._listeners[i])==null?void 0:a.slice())||[];for(let u of n)u.call(this,t);let o=((l=this._onceListeners[i])==null?void 0:l.slice())||[];for(let u of o)CS(i,u,this._onceListeners),u.call(this,t)}_listens(e){return this._listeners[e]&&this._listeners[e].length>0||this._onceListeners[e]&&this._onceListeners[e].length>0}};var ql=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:i,fontStyle:n,fontWeight:o}=this.opts;this.ctx.font=`${n} ${o} ${i}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:i,lineHeight:n}=this.opts,o=i*1.2,a=i*(n-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new $t(l,u.length*o+(u.length-1)*a)}};var sw=`
uniform sampler2D nodeDepth;
uniform vec2 textureDim;

vec2 getCoordinate(vec3 nodeIdx) {
  // index = r + g * 256 + b * 65536
  // textureDim.x is always power of 2 and <= 65536
  // avoid making big integers (float32 precision)
  float x = nodeIdx.r + nodeIdx.g * 256.0;
  float y = floor(x / textureDim.x);
  x -= y * textureDim.x;
  y += 65536.0 / textureDim.x * nodeIdx.b;
  return vec2(x + 0.5, y + 0.5) / textureDim;
}

bool getDepth(vec3 nodeIdx, out float depth) {
  vec2 coord = getCoordinate(nodeIdx);
  vec4 c = texture2D(nodeDepth, coord);
  depth = c.r * 255.0;
  return c.a == 0.0;
}
`,ik=new Uint8Array(4),Vm=class{constructor(e){this._gl=e,this._nodeDepthTextures=[nw(e),nw(e)],this._nodeDepthFB=new _e(e,{id:"graph-highlighter-framebuffer",width:this._nodeDepthTextures[0].width,height:1,attachments:{[Ne.COLOR_ATTACHMENT0]:this._nodeDepthTextures[0]}}),this._model=nk(e),this._transform=ok(e)}delete(){var e,t,i,n;(e=this._edgeSourceBuffer)==null||e.delete(),(t=this._edgeTargetBuffer)==null||t.delete(),(i=this._edgeDirectionBuffer)==null||i.delete(),(n=this._edgeDepthBuffer)==null||n.delete(),this._nodeDepthTextures.forEach(o=>o.delete()),this._nodeDepthFB.delete(),this._nodeDepthBuffer.delete(),this._model.delete(),this._transform.delete()}get nodeDepthBuffer(){return this._nodeDepthBuffer}get edgeDepthBuffer(){return this._edgeDepthBuffer}setGraph(e){if(this._graph===e.graph)return;this._graph=e.graph;let t=this._graph.deepEdgesCount();this._nodeMap=new Map,this._nodeList=[],this._hasBidirectionalEdge=!1;let i=this._gl;this._edgeSourceBuffer=$d(i,this._edgeSourceBuffer,{size:3,type:Ne.UNSIGNED_BYTE},t),this._edgeTargetBuffer=$d(i,this._edgeTargetBuffer,{size:3,type:Ne.UNSIGNED_BYTE},t),this._edgeDirectionBuffer=$d(i,this._edgeDirectionBuffer,{size:1,type:Ne.UNSIGNED_BYTE},t),this._edgeDepthBuffer=$d(i,this._edgeDepthBuffer,{size:1,type:Ne.FLOAT},t);let n=0,o=0;for(let f of e.deepNodesIt())this._nodeList[n]=f.id,this._nodeMap.set(f.id,n),n++;let a=new Uint8Array(t*3),l=new Uint8Array(t*3),u=new Uint8Array(t),c=[0,0,0];for(let f of e.deepEdges()){let P=this._nodeMap.get(f.source.id);ow(P,c),a.set(c,o*3);let E=this._nodeMap.get(f.target.id);ow(E,c),l.set(c,o*3);let v=st.getDrawingObj(f.edge);this._hasBidirectionalEdge=this._hasBidirectionalEdge||!v.directed,u[o]=v.directed?1:0,o++}this._edgeSourceBuffer.subData(a),this._edgeTargetBuffer.subData(l),this._edgeDirectionBuffer.subData(u),this._nodeCount=this._nodeMap.size;let h=this._nodeDepthTextures[0].width,d=Math.ceil(this._nodeCount/h);this._nodeDepthBuffer=$d(i,this._nodeDepthBuffer,{size:4,type:Ne.UNSIGNED_BYTE},h*d),this._nodeDepthFB.resize({width:h,height:d}),this._transform.update({elementCount:t,sourceBuffers:{source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer},feedbackBuffers:{nextDepth:this._edgeDepthBuffer}}),this._model.setAttributes({source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer}),this._model.setVertexCount(t),this.update({sourceId:null})}update(e){let{sourceId:t,edgeDepth:i=!1,maxDepth:n=1}=e,o=[this._nodeDepthFB.width,this._nodeDepthFB.height],a=this._nodeDepthTextures[1],l=this._nodeDepthTextures[0];if(t){let u=this._nodeMap.get(t);this._resetNodeDepth(a,u),this._resetNodeDepth(l,u);for(let c=0;c<n;c++){[a,l]=[l,a],this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:l});let h={nodeDepth:a,textureDim:o,testForward:!0};this._updateNodeDepth(h),this._hasBidirectionalEdge&&(h.testForward=!1,this._updateNodeDepth(h))}}else this._resetNodeDepth(l),this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:l});ig(this._nodeDepthFB,{target:this._nodeDepthBuffer}),i&&(this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:a}),this._transform.run({framebuffer:this._nodeDepthFB,clearRenderTarget:!1,discard:!0,uniforms:{nodeDepth:l,textureDim:o}}))}_resetNodeDepth(e,t){this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:e}),ht(this._gl,{framebuffer:this._nodeDepthFB,viewport:[0,0,e.width,e.height],clearColor:[1,1,1,1]},()=>{this._gl.clear(Ne.COLOR_BUFFER_BIT)}),t!==void 0&&e.setSubImageData({data:ik,x:t%e.width,y:Math.floor(t/e.width),width:1,height:1})}_updateNodeDepth(e){this._model.draw({framebuffer:this._nodeDepthFB,uniforms:e,parameters:{depthTest:!1,blend:!0,viewport:[0,0,this._nodeDepthFB.width,this._nodeDepthFB.height],blendFunc:[Ne.ONE,Ne.ONE,Ne.ONE,Ne.ONE],blendEquation:[Ne.MIN,Ne.MIN]}})}};function $d(s,e,t,i){e||(e=new pe(s,{target:s.ARRAY_BUFFER,accessor:t}));let n=i*t.size*(t.type===Ne.UNSIGNED_BYTE?1:4);return e.byteLength<n&&e.reallocate(n),e}function nw(s){let e=s.getParameter(s.MAX_TEXTURE_SIZE);return e=Math.min(1024,2**Math.floor(Math.log2(e))),new Xe(s,{format:Ne.RGBA,type:Ne.UNSIGNED_BYTE,border:0,mipmaps:!1,dataFormat:Ne.RGBA,width:e,height:1,parameters:{[Ne.TEXTURE_MIN_FILTER]:Ne.NEAREST,[Ne.TEXTURE_MAG_FILTER]:Ne.NEAREST,[Ne.TEXTURE_WRAP_S]:Ne.CLAMP_TO_EDGE,[Ne.TEXTURE_WRAP_T]:Ne.CLAMP_TO_EDGE}})}function nk(s){return new Hr(s,{id:"graph-highlighter-nodes",vs:`
#define SHADER_NAME graph-highlighter-nodes-vertex-shader

uniform bool testForward;

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float targetDepth;

${sw}

void main(void) {
  vec3 sourceIdx = source;
  vec3 targetIdx = target;
  if (!testForward && direction == 0.0) {
    sourceIdx = target;
    targetIdx = source;
  }
  float sourceDepth;
  bool sourceDepthValid = getDepth(sourceIdx, sourceDepth);
  vec2 targetCoord = getCoordinate(targetIdx);

  gl_Position = vec4(targetCoord * 2.0 - 1.0, sourceDepthValid ? 0.0 : 2.0, 1.0);
  gl_PointSize = 1.0;

  targetDepth = sourceDepth + 1.0;
}
`,fs:`
#define SHADER_NAME graph-highlighter-nodes-fragment-shader
varying float targetDepth;

void main(void) {
  gl_FragColor = vec4(targetDepth / 255.0, 0.0, 0.0, 0.0);
}`,isInstanced:!1,drawMode:Ne.POINTS})}function ok(s){return new rn(s,{vs:`
#define SHADER_NAME graph-highlighter-edges-vertex-shader

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float nextDepth;

${sw}

float getDepth(vec3 sourceIdx) {
  float sourceDepth;
  if (getDepth(sourceIdx, sourceDepth)) {
    return sourceDepth + 1.0;
  }
  return 255.0;
}

void main(void) {
  nextDepth = getDepth(source);
  if (direction == 0.0) {
    nextDepth = min(nextDepth, getDepth(target));
  }

  gl_Position = vec4(0.0);
}
`,varyings:["nextDepth"]})}function ow(s,e){return e[0]=s&255,e[1]=s>>8&255,e[2]=s>>8>>8&255,e}var aw=2,Zd=class extends Gm{constructor(e=document.body){super();this._layoutOptions={};this._controls=[];this._textMeasurer=new ql,window.getComputedStyle(e).position==="static"&&(e.style.position="relative");let t=Array.from({length:2},()=>{let i=document.createElement("div");return Object.assign(i.style,{position:"absolute",top:0,bottom:0,left:0,right:0}),e.appendChild(i)});this._deck=new Hl({parent:t[0],views:[new fa({})],initialViewState:{target:[0,0,0],zoom:0,maxZoom:aw},controller:!0,onLoad:()=>{this.emit("load"),this._update()},onClick:({object:i})=>{!i&&this._highlightedNodeId&&this.highlight(null)}}),t[1].style.pointerEvents="none",this._controlsContainer=t[1]}addControl(e){if(this._controls.indexOf(e)<0){this._controls.push(e),e.onAdd(this);let t=e.getElement();t&&this._controlsContainer.appendChild(t)}}removeControl(e){let t=this._controls.indexOf(e);if(t>=0){let i=e.getElement();i&&i.remove(),e.onRemove(this),this._controls.splice(t,1)}}get graph(){return this._graph}setGraph(e,t=this._layoutOptions){if(this._graph===e)this.setOptions(t);else{this._graph=e,this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{}),this._highlightedNodeId=null;let i=Mi.getDrawingObj(e)||new Mi(e);i.createGeometry(this._textMeasurer.measure),Fm(i,this._layoutOptions,!0),this._deck.layerManager&&this._update()}}setOptions(e){let t=this._layoutOptions.label,i=e.label,n=!qd(t,i);if(this._layoutOptions=e,!this._graph)return;let o=Mi.getDrawingObj(this._graph);n&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=n;Fm(o,this._layoutOptions,a),this._deck.layerManager&&this._update()}zoomTo(e){let t=Math.min(this._deck.width/e.width,this._deck.height/e.height),i=Math.min(Math.log2(t),aw);this._deck.setProps({initialViewState:{target:[e.center.x,e.center.y,0],zoom:i,transitionInterpolator:new Fn(["target","zoom"]),transitionDuration:1e3}})}highlight(e){this._highlightedNodeId=e,this._highlight(e)}_highlight(e,t=2){this._graph&&this._deck.layerManager&&(this._graphHighlighter.update({sourceId:e,maxDepth:t,edgeDepth:!1}),this._deck.layerManager.setNeedsRedraw("hightlight changed"))}_update(){if(!this._graph)return;let e=this._textMeasurer.opts,t=Re.getGeom(this._graph);this._graphHighlighter=this._graphHighlighter||new Vm(this._deck.deckRenderer.gl),this._graphHighlighter.setGraph(t);let i=new Yd({id:"edges",data:Array.from(t.deepEdges()),getWidth:1,getDepth:this._graphHighlighter.edgeDepthBuffer}),n=new Xd({id:"nodeBoundaries",data:Array.from(t.deepNodesIt()),getDepth:this._graphHighlighter.nodeDepthBuffer,fontFamily:e.fontFamily,fontWeight:e.fontWeight,lineHeight:e.lineHeight,getLineWidth:1,getTextSize:e.fontSize,pickable:!0,onHover:({object:o})=>{this._highlightedNodeId||this._highlight(o==null?void 0:o.id)}});this._deck.setProps({layers:[n,i]}),this.emit({type:"graphload",data:this._graph}),this.zoomTo(t.boundingBox)}};var Ym=be(zt()),Ww=be(zw()),Xm=class{bind(){this.entity&&this.entity.setAttr(Xm.attachIndex,this)}constructor(e,t){this.entity=e,this.svgData=t,this.bind()}static getGeom(e){return e.getAttr(Xm.attachIndex)}},LS=Xm;LS.attachIndex=2;var qm=class{constructor(e,t=!1){this._textMeasurer=new ql;this.transformRequired=t,this.container=e}getSvgString(){return this.svg==null?null:new XMLSerializer().serializeToString(this.svg)}clearContainer(){for(;this.container.childNodes.length>0;)this.container.removeChild(this.container.firstChild)}setGraph(e){if(this.clearContainer(),this.graph=e,this.svg=Jd(this.graph,"svg"),this.svg.setAttribute("style","border: 1px solid black"),this.geomGraph=Re.getGeom(this.graph),!this.geomGraph)return null;this.geomGraph.updateBoundingBox(),this.open();for(let t of this.graph.deepNodes)this.drawNode(t);for(let t of this.graph.deepEdges())this.drawEdge(t);this.close(),this.container.appendChild(this.svg),(0,Ww.default)(this.svg)}drawEdge(e){if(We.getGeom(e).curve==null)return;let t=Jd(e,"g"),i=document.createElementNS(jm,"path");t.appendChild(i),i.setAttribute("fill","none");let n=Qi.getDrawingObj(e);this.setStroke(i,n);let o=We.getGeom(e);i.setAttribute("d",Hw(o.curve));for(let a of this.AddArrows(e))t.appendChild(a);this.DrawEdgeLabel(e),this.svg.appendChild(t)}DrawEdgeLabel(e){let t=Qi.getDrawingObj(e),n=We.getGeom(e).label;!n||this.drawLabelAtXY(t,n.boundingBox)}*AddArrows(e){let t=We.getGeom(e),i=t.curve,n=this.AddArrowhead(e,t.sourceArrowhead,i.start);n&&(yield n),n=this.AddArrowhead(e,t.targetArrowhead,i.end),n&&(yield n)}AddArrowhead(e,t,i){if(!t)return;let n=Jd(e,"polygon"),o=Qi.getDrawingObj(e);this.setStroke(n,o);let a=Hk(i,t.tipPosition);return n.setAttribute("points",qw(a)),n}setStroke(e,t){let i=Wm(t.color);e.setAttribute("stroke",i),e.setAttribute("stroke-opacity",(t.color?t.color.A/255:1).toString()),e.setAttribute("stroke-width",t.penwidth.toString())}drawNode(e){let i=Ue.getGeom(e).boundaryCurve;!i||this.drawNodeOnCurve(i,e)}drawNodeOnCurve(e,t){let i=st.getDrawingObj(t);if(i.shape!=5&&(this.makePathOnCurve(t,i,e),i.shape==10)){let n=e,o=n.aAxis.length-2*i.penwidth;n=Be.mkCircle(o,n.center),this.makePathOnCurve(t,i,n)}this.drawLabel(t,i)}makePathOnCurve(e,t,i){var o,a;let n=Jd(e,"path");if(t.styles.find(l=>l==5)){let l=(a=(o=t.fillColor)!=null?o:t.color)!=null?a:tr.defaultFillColor;n.setAttribute("fill",Wm(l))}else n.setAttribute("fill","none");n.setAttribute("d",Hw(i)),n.setAttribute("stroke",Wm(t.color)),n.setAttribute("stroke-width",t.penwidth.toString()),this.svg.appendChild(n)}drawLabel(e,t){if(!!t&&!(!t.labelText||t.labelText.length==0))if(t instanceof tr)this.writeLabelText(e,t.measuredTextSize);else throw new Error("not implemented")}writeLabelText(e,t){let i=wr.getGeom(e),n=st.getDrawingObj(e),a=e instanceof Ze?W.creatRectangleWithSize(t,new p(i.boundaryCurve.boundingBox.center.x,i.boundaryCurve.boundingBox.bottom+t.height/2+n.LabelMargin)):W.creatRectangleWithSize(t,i.center);this.drawLabelAtXY(n,a)}drawLabelAtXY(e,t){let i=e.fontsize,n=Jd(e.attrCont,"text");n.setAttribute("text-anchor","middle"),n.setAttribute("x",t.center.x.toString()),n.setAttribute("fill",Wm(e.fontColor)),n.setAttribute("font-family",e.fontname),n.setAttribute("font-size",i.toString()+"px"),this.createTspans(e.labelText,n,i,t),this.svg.appendChild(n)}createTspans(e,t,i,n){let o=`
`,a=e.split(o);if(a.length==1){let l=document.createElementNS(jm,"tspan");t.appendChild(l),l.textContent=e,l.setAttribute("text-anchor","middle"),l.setAttribute("x",n.center.x.toString()),l.setAttribute("alignment-baseline","middle"),l.setAttribute("y",n.center.y.toString())}else{let l=n.bottom+1;for(let u=0;u<a.length;u++){let c=document.createElementNS(jm,"tspan");t.appendChild(c),c.textContent=a[u],c.setAttribute("text-anchor","middle"),c.setAttribute("x",n.center.x.toString()),c.setAttribute("alignment-baseline","hanging"),c.setAttribute("y",l.toString()),l+=1.21*i}}}close(){if(this.transformRequired)throw new Error("not implemented")}open(){if(this.svg.setAttribute("width",this.geomGraph.width),this.svg.setAttribute("height",this.geomGraph.height),this.transformRequired)throw new Error("not implemented")}};qm.arrowAngle=25;var jm="http://www.w3.org/2000/svg";function Hw(s){return Ym.String.Join(" ",Array.from(Vk(s)))}function*Vk(s){if(yield"M",yield Xl(s.start),s instanceof w)for(let t of s.segs)yield Uk(t);else if(s instanceof B)yield"L",yield Xl(s.end);else if(s instanceof Fe)yield jw(s);else if(s instanceof te){let o=s;for(let a of o.skip(1))yield"L",yield Xl(a.point);o.closed&&(yield"L",yield Xl(o.start))}else if(s instanceof de){let a=s;a.isFullEllipse()?(yield OS(new de(0,Math.PI,a.aAxis,a.bAxis,a.center)),yield OS(new de(Math.PI,Math.PI*2,a.aAxis,a.bAxis,a.center))):this.ellipseToString(a)}}function Xl(s){return ef(s.x)+" "+ef(s.y)}function ef(s){return Math.abs(s)<1e-11?"0":s.toString()}function jw(s){return"C"+qw([s.B(1),s.B(2),s.B(3)])}function OS(s){let e=Math.abs(s.parEnd-s.parStart)>=Math.PI?"1":"0",t=s.orientedCounterclockwise()?"1":"0";return Ym.String.Join(" ","A",kk(s),ef(p.angle(new p(1,0),s.aAxis)/(Math.PI/180)),e,t,Xl(s.end))}function kk(s){return ef(s.aAxis.length)+","+ef(s.bAxis.length)}function qw(s){return Ym.String.Join(" ",s.map(e=>Xl(e)))}function Uk(s){if(s instanceof B)return zk(s);if(s instanceof Fe)return jw(s);if(s instanceof de)return OS(s);throw new Error("NotImplementedException")}function zk(s){return"L "+Xl(s.end)}function Wm(s){return s?"rgba("+s.R+","+s.G+","+s.B+","+s.A/255+")":"Black"}function Hk(s,e){let t=e.sub(s),i=t;t=t.normalize();let n=new p(-t.y,t.x),o=i.length*Math.tan(qm.arrowAngle*.5*(Math.PI/180));return n=n.mul(o),[s.add(n),e,s.sub(n)]}function Jd(s,e){let t=document.createElementNS(jm,e);return new LS(s,t),t}var Wk=`
  .search-control { pointer-events: all; font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; position: absolute; top: 0; right: 0; margin: 20px; width: 200px; }
  .search-control-input { font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; padding: 8px; width: 100%; }
  .search-control-options { background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); padding: 12px 0; margin-top: 4px; overflow-x: hidden; overflow-y: auto; }
  .search-control-option { padding: 0 12px; line-height: 32px; white-space: nowrap; color: #000; cursor: pointer; }
  .search-control-option:hover { background: #f8f8f8; }
  .search-control-option.focus { color: #08f; background: #f8f8f8; }
`,tf=class{constructor(){this._nodes=[];this._onGraphLoad=e=>{this._updateNodeList(e.data)}}onAdd(e){e.on("graphload",this._onGraphLoad),this._dropdown=new Xw({getLabel:t=>tr.getDrawingObj(t).labelText,onSelect:t=>{e.highlight(t.id);let i=wr.getGeom(t);e.zoomTo(i.boundingBox)}}),this._updateNodeList(e.graph)}onRemove(e){e.off("graphload",this._onGraphLoad),this._dropdown.delete(),this._dropdown=null}getElement(){return this._dropdown.element}_updateNodeList(e){this._nodes=e?Array.from(e.deepNodes):[],this._dropdown.update(this._nodes)}},Xw=class{constructor(e){this.focus=-1;this.items=[];this.options={getLabel:e=>e.toString(),renderItem:(e,t)=>{if(!t)return e;let i=e.toLowerCase().indexOf(t);return`${e.slice(0,i)}<b>${e.slice(i,i+t.length)}</b>${e.slice(i+t.length)}`},filterItem:(e,t)=>{if(!t)return 1;let i=e.toLowerCase().indexOf(t);return i===0?2:i>0?1:0},onSelect:()=>{},buffer:2,itemHeight:32,maxHeight:240};this._active=!1;this._topOffset=0;this._keyword="";this._filteredItems=[];this._items=[];this._onScroll=()=>{let{itemHeight:e,buffer:t,getLabel:i,renderItem:n}=this.options,o=this._flyout.scrollTop;this._topOffset=Math.max(0,Math.floor(o/e)-t),this._scroller.style.paddingTop=this._topOffset*e+"px";for(let a=0;a<this._items.length;a++){let l=this._items[a],u=a+this._topOffset;u===this.focus?l.classList.add("focus"):l.classList.remove("focus");let c=this._filteredItems[u];if(c){let h=i(c);l.innerHTML=n(h,this._keyword,c)}}};let t=document.createElement("style");t.innerText=Wk,document.head.appendChild(t),this._stylesheet=t;let i=document.createElement("div");i.className="search-control";let n=document.createElement("input");n.placeholder="Search...",n.className="search-control-input",i.appendChild(n),n.addEventListener("focus",()=>{n.value="",this._keyword="",this._active=!0,this._updateFilter()}),n.addEventListener("blur",()=>{setTimeout(()=>{this._active=!1,this._updateUI()},200)}),n.addEventListener("input",l=>{this._keyword=n.value.toLowerCase(),this._updateFilter()}),n.addEventListener("keydown",l=>{switch(l.key){case"ArrowDown":l.preventDefault(),this.focus=Math.min(this._filteredItems.length-1,this.focus+1),this._updateUI();break;case"ArrowUp":l.preventDefault(),this.focus=Math.max(0,this.focus-1),this._updateUI();break;case"Enter":this._select(this.focus);break}}),this._textbox=n;let o=document.createElement("div");o.className="search-control-options",o.addEventListener("scroll",this._onScroll),i.appendChild(o);let a=document.createElement("div");a.style.boxSizing="border-box",a.style.overflow="hidden",o.appendChild(a),this._flyout=o,this._scroller=a,this.element=i,this.setOptions(e)}delete(){this.items=null,this._stylesheet.remove(),this._stylesheet=null,this.element.remove(),this.element=null,this._scroller=null,this._flyout=null}setOptions(e){Object.assign(this.options,e);let t=Math.ceil(this.options.maxHeight/this.options.itemHeight)+this.options.buffer*2,i=this._items;if(i.length!==t){for(let n=i.length;n<t;n++){let o=this._makeItem(n);i.push(o)}for(let n=i.length;n>t;n--)i[n-1].remove()}this._updateFilter()}update(e){this.items=e,this._textbox.value="",this._keyword="",this._updateFilter()}_updateFilter(){let{getLabel:e,filterItem:t}=this.options,i=this.items.map(o=>{let a=e(o);return t(a,this._keyword,o)}),n=Array.from(i,(o,a)=>a).filter(o=>i[o]);n.sort((o,a)=>i[a]-i[o]),this._filteredItems=n.map(o=>this.items[o]),this.focus=0,this._updateUI()}_select(e){let t=this._filteredItems[e];t&&(this.options.onSelect(t),this._textbox.value=this.options.getLabel(t),this._textbox.blur())}_updateUI(){if(!this._active){this._flyout.style.display="none";return}this._flyout.style.display="block",this._flyout.style.maxHeight=this.options.maxHeight+"px";let{itemHeight:e,maxHeight:t}=this.options,i=this._filteredItems.length,n=Math.floor(t/e),o=Math.max(0,(this.focus+2-n)*e),a=Math.min(Math.max(0,i*e-t),Math.max(0,this.focus-1)*e),l=this._flyout.scrollTop;l<o&&(l=o),l>a&&(l=a),this._scroller.style.height=i*e+"px";for(let u=0;u<this._items.length;u++){let c=this._items[u];c.style.display=u<i?"block":"none"}this._flyout.scrollTo({left:0,top:l,behavior:"smooth"}),this._onScroll()}_makeItem(e){let t=document.createElement("div");return t.className="search-control-option",t.style.height=this.options.itemHeight+"px",this._scroller.appendChild(t),t.addEventListener("click",()=>{this._select(e+this._topOffset)}),t}};var Yw="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),RS={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},MS={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",mds:"Pivot MDS"},$w=["Times New Roman","Arial","Georgia","Courier New","Verdana"];var jk="https://raw.githubusercontent.com/microsoft/msagljs/main/examples/data/gameofthrones.json",ba=new Zd(document.getElementById("viewer"));ba.addControl(new tf);var _S=document.getElementById("gv");for(let s of Yw){let e=document.createElement("option");e.value=`${s}.gv`,e.innerText=s,_S.appendChild(e)}_S.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+_S.value;f0(s).then(e=>{ba.setGraph(e),document.getElementById("graph-name").innerText=e.id})};var BS=document.getElementById("routings");for(let s in RS){let e=document.createElement("option");e.value=s,e.innerText=RS[s],BS.appendChild(e)}BS.onchange=()=>{ba.setOptions($m())};var NS=document.getElementById("layouts");for(let s in MS){let e=document.createElement("option");e.value=s,e.innerText=MS[s],NS.appendChild(e)}NS.onchange=()=>{ba.setOptions($m())};var DS=document.getElementById("fonts");for(let s of $w){let e=document.createElement("option");e.value=s,e.innerText=s,e.style.fontFamily=s,DS.appendChild(e)}DS.onchange=()=>{ba.setOptions($m())};qv("drop-target",async s=>{let e=await jv(s);ba.setGraph(e),document.getElementById("graph-name").innerText=e.id});(async()=>{ba.setOptions($m());let s=await f0(jk);ba.setGraph(s),document.getElementById("graph-name").innerText=s.id})();function $m(){let s={label:{fontFamily:DS.value}};switch(st.defaultLabelFontName=s.label.fontFamily,NS.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;default:break}switch(BS.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)
   
   Copyright (c) .NET Foundation and Contributors
   
   All rights reserved.
   
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:
   
   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.
   
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   NOTE: The `murmur3` algorithm is public domain.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */
