(()=>{var q2=Object.create;var ny=Object.defineProperty;var X2=Object.getOwnPropertyDescriptor;var Y2=Object.getOwnPropertyNames;var K2=Object.getPrototypeOf,Z2=Object.prototype.hasOwnProperty;var Q2=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var Fe=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),J2=(s,e)=>{for(var t in e)ny(s,t,{get:e[t],enumerable:!0})},$2=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Y2(e))!Z2.call(s,n)&&n!==t&&ny(s,n,{get:()=>e[n],enumerable:!(i=X2(e,n))||i.enumerable});return s};var me=(s,e,t)=>(t=s!=null?q2(K2(s)):{},$2(e||!s||!s.__esModule?ny(t,"default",{value:s,enumerable:!0}):t,s));var FC=Fe((q6,DC)=>{"use strict";function eM(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function fl(s,e,t,i){this.message=s,this.expected=e,this.found=t,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,fl)}eM(fl,Error);fl.buildMessage=function(s,e){var t={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,f;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,f=1;d<h.length;d++)h[d-1]!==h[d]&&(h[f]=h[d],f++);h.length=f}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function tM(s,e){e=e!==void 0?e:{};var t={},i={start:SC},n=SC,o="strict",a=Re("strict",!0),l="graph",u=Re("graph",!0),c="digraph",h=Re("digraph",!0),d="{",f=Re("{",!1),p="}",S=Re("}",!1),x=function(P,v,F,B){B===null&&(B=[]);var U={type:v.toLowerCase(),children:B};return P&&(U.strict=!0),F&&(U.id=F),U},T=";",O=Re(";",!1),M=function(P,v){return v},R=function(P,v){return[P].concat(v)},N="=",H=Re("=",!1),Q=function(P,v){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:P,eq:v}]}},ne="node",he=Re("node",!0),se="edge",oe=Re("edge",!0),ge=function(P,v){return{type:"attr_stmt",target:P,attr_list:v}},Pe="[",pe=Re("[",!1),Ue="]",ui=Re("]",!1),js=function(P,v){return(P||[]).concat(v||[])},ci=function(P,v){return v},qs=",",os=Re(",",!1),Xs=function(P,v,F){return[{type:"attr",id:P,eq:v}].concat(F||[])},on=function(P,v,F){var B=[P];return B=B.concat(v.map(function(U){return U.id})),{type:"edge_stmt",edge_list:B,attr_list:F||[]}},ss="->",Ys=Re("->",!1),il="--",ku=Re("--",!1),ar=function(P,v,F){return[{type:"edgeRHS",edgeop:P,id:v}].concat(F||[])},On=function(P,v){return{type:"node_stmt",node_id:P,attr_list:v||[]}},It=function(P,v){return v?{type:"node_id",id:P,port:v}:{type:"node_id",id:P}},mr=Ao("port"),zr=":",Rn=Re(":",!1),as=function(P,v){return v},ls=function(P,v){return{type:"port",id:P,compass_pt:v||null}},us=function(P){return{type:"port",compass_pt:P||null}},Oi="subgraph",_n=Re("subgraph",!0),zu=function(P){return P?{type:"subgraph",id:P}:{type:"subgraph"}},Uu=function(P,v){return P=P||{type:"subgraph"},P.children=v||[],P},Ks="n",Ur=Re("n",!1),Wu="ne",nl=Re("ne",!1),Hu="e",ol=Re("e",!1),sl="se",ju=Re("se",!1),qu="s",Zs=Re("s",!1),Qs="sw",Mn=Re("sw",!1),al="w",$h=Re("w",!1),Nn="nw",ed=Re("nw",!1),td=Ao("UNICODE_STRING"),Xu=function(P,v){return P+v.join("")},cs=function(P,v){return P+v},rd="$",id=Re("$",!1),ll="_",Yu=Re("_",!1),Js=Ao("NUMBER"),nd="-",od=Re("-",!1),Ku=".",$s=Re(".",!1),Bn=/^[0-9]/,Ri=ki([["0","9"]],!1,!1),Zu=function(P){return parseFloat(bC())},Dn=function(P){return{type:"id",value:P.slice(1,P.length-1),html:!0}},ea="<",ta=Re("<",!1),hs=">",So=Re(">",!1),Qu=function(P){return"<"+P.join("")+">"},Wr=S2(),Fn=function(P){return P},ul=function(P){return P.join("")},Hr='"',Gn=Re('"',!1),cl=function(P){return P.join("")},Vn=function(){return bC()},Ir="\\",hi=Re("\\",!1),Eo=function(P){return P[1]==='"'?'"':P[0]+P[1]},xo=function(){return""},ds=/^[\n\r\u2028\u2029]/,sd=ki([`
`,"\r","\u2028","\u2029"],!1,!1),Co=Ao("end of line"),G=`
`,Y=Re(`
`,!1),$=`\r
`,te=Re(`\r
`,!1),Ae="\r",We=Re("\r",!1),Be="\u2028",st=Re("\u2028",!1),kn="\u2029",sn=Re("\u2029",!1),fs=/^[^"\\\0-\x1F\x7F]/,jr=ki(['"',"\\",["\0",""],"\x7F"],!0,!1),hl='\\"',ad=Re('\\"',!1),ld=function(){return'"'},ud=function(){return"\\"},cd=Ao("COMMENT"),Ju=Ao("BLOCK_COMMENT"),an="/*",YP=Re("/*",!1),ps="*/",dl=Re("*/",!1),hd=function(P){return P},KP=function(P){return P.join("")},ZP=Ao("C_COMMENT"),C="//",I=Re("//",!1),_=/^[\n]/,V=ki([`
`],!1,!1),Z=function(P){return P.join("")},ae=Ao("MACRO_COMMENT"),De="#",er=Re("#",!1),lr=Ao("WHITESPACE"),br=/^[\n\r]/,Vi=ki([`
`,"\r"],!1,!1),gC=/^[ \t]/,mC=ki([" ","	"],!1,!1),s2=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,a2=ki([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),l2=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,u2=ki([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),c2=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,h2=ki(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),d2=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,f2=ki(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),p2=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,g2=ki([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),m2=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,b2=ki([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),P2=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,y2=ki([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),E=0,Ee=0,wp=[{line:1,column:1}],vo=0,QP=[],z=0,Lp;if("startRule"in e){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=i[e.startRule]}function bC(){return s.substring(Ee,E)}function z6(){return dd(Ee,E)}function U6(P,v){throw v=v!==void 0?v:dd(Ee,E),yC([Ao(P)],s.substring(Ee,E),v)}function W6(P,v){throw v=v!==void 0?v:dd(Ee,E),x2(P,v)}function Re(P,v){return{type:"literal",text:P,ignoreCase:v}}function ki(P,v,F){return{type:"class",parts:P,inverted:v,ignoreCase:F}}function S2(){return{type:"any"}}function E2(){return{type:"end"}}function Ao(P){return{type:"other",description:P}}function PC(P){var v=wp[P],F;if(v)return v;for(F=P-1;!wp[F];)F--;for(v=wp[F],v={line:v.line,column:v.column};F<P;)s.charCodeAt(F)===10?(v.line++,v.column=1):v.column++,F++;return wp[P]=v,v}function dd(P,v){var F=PC(P),B=PC(v);return{start:{offset:P,line:F.line,column:F.column},end:{offset:v,line:B.line,column:B.column}}}function q(P){E<vo||(E>vo&&(vo=E,QP=[]),QP.push(P))}function x2(P,v){return new fl(P,null,null,v)}function yC(P,v,F){return new fl(fl.buildMessage(P,v),P,v,F)}function SC(){var P,v;if(P=[],v=EC(),v!==t)for(;v!==t;)P.push(v),v=EC();else P=t;return P}function EC(){var P,v,F,B,U,X,ue,Ot,Rt,Io,zi,iy,BC;return P=E,v=dt(),v!==t?(s.substr(E,6).toLowerCase()===o?(F=s.substr(E,6),E+=6):(F=t,z===0&&q(a)),F===t&&(F=null),F!==t?(B=dt(),B!==t?(s.substr(E,5).toLowerCase()===l?(U=s.substr(E,5),E+=5):(U=t,z===0&&q(u)),U===t&&(s.substr(E,7).toLowerCase()===c?(U=s.substr(E,7),E+=7):(U=t,z===0&&q(h))),U!==t?(X=dt(),X!==t?(ue=To(),ue===t&&(ue=null),ue!==t?(Ot=dt(),Ot!==t?(s.charCodeAt(E)===123?(Rt=d,E++):(Rt=t,z===0&&q(f)),Rt!==t?(Io=xC(),Io===t&&(Io=null),Io!==t?(zi=dt(),zi!==t?(s.charCodeAt(E)===125?(iy=p,E++):(iy=t,z===0&&q(S)),iy!==t?(BC=dt(),BC!==t?(Ee=P,v=x(F,U,ue,Io),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function xC(){var P,v,F,B,U,X,ue,Ot,Rt,Io,zi;if(P=E,v=dt(),v!==t)if(F=JP(),F!==t)if(B=dt(),B!==t)if(s.charCodeAt(E)===59?(U=T,E++):(U=t,z===0&&q(O)),U===t&&(U=null),U!==t){for(X=[],ue=E,Ot=dt(),Ot!==t?(Rt=JP(),Rt!==t?(Io=dt(),Io!==t?(s.charCodeAt(E)===59?(zi=T,E++):(zi=t,z===0&&q(O)),zi===t&&(zi=null),zi!==t?(Ee=ue,Ot=M(F,Rt),ue=Ot):(E=ue,ue=t)):(E=ue,ue=t)):(E=ue,ue=t)):(E=ue,ue=t);ue!==t;)X.push(ue),ue=E,Ot=dt(),Ot!==t?(Rt=JP(),Rt!==t?(Io=dt(),Io!==t?(s.charCodeAt(E)===59?(zi=T,E++):(zi=t,z===0&&q(O)),zi===t&&(zi=null),zi!==t?(Ee=ue,Ot=M(F,Rt),ue=Ot):(E=ue,ue=t)):(E=ue,ue=t)):(E=ue,ue=t)):(E=ue,ue=t);X!==t?(Ee=P,v=R(F,X),P=v):(E=P,P=t)}else E=P,P=t;else E=P,P=t;else E=P,P=t;else E=P,P=t;return P}function JP(){var P,v,F,B,U,X;return P=E,v=To(),v!==t?(F=dt(),F!==t?(s.charCodeAt(E)===61?(B=N,E++):(B=t,z===0&&q(H)),B!==t?(U=dt(),U!==t?(X=To(),X!==t?(Ee=P,v=Q(v,X),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P===t&&(P=C2(),P===t&&(P=v2(),P===t&&(P=ey(),P===t&&(P=A2(),P===t&&(P=E,v=To(),v!==t?(s.charCodeAt(E)===61?(F=N,E++):(F=t,z===0&&q(H)),F!==t?(B=To(),B!==t?(v=[v,F,B],P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)))))),P}function C2(){var P,v,F;return P=E,s.substr(E,5).toLowerCase()===l?(v=s.substr(E,5),E+=5):(v=t,z===0&&q(u)),v===t&&(s.substr(E,4).toLowerCase()===ne?(v=s.substr(E,4),E+=4):(v=t,z===0&&q(he)),v===t&&(s.substr(E,4).toLowerCase()===se?(v=s.substr(E,4),E+=4):(v=t,z===0&&q(oe)))),v!==t?(F=Op(),F!==t?(Ee=P,v=ge(v,F),P=v):(E=P,P=t)):(E=P,P=t),P}function Op(){var P,v,F,B,U,X,ue,Ot,Rt;return P=E,v=dt(),v!==t?(s.charCodeAt(E)===91?(F=Pe,E++):(F=t,z===0&&q(pe)),F!==t?(B=dt(),B!==t?(U=CC(),U===t&&(U=null),U!==t?(X=dt(),X!==t?(s.charCodeAt(E)===93?(ue=Ue,E++):(ue=t,z===0&&q(ui)),ue!==t?(Ot=dt(),Ot!==t?(Rt=Op(),Rt===t&&(Rt=null),Rt!==t?(Ee=P,v=js(U,Rt),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function CC(){var P,v,F,B,U,X,ue,Ot;return P=E,v=dt(),v!==t?(F=To(),F!==t?(B=E,U=dt(),U!==t?(s.charCodeAt(E)===61?(X=N,E++):(X=t,z===0&&q(H)),X!==t?(ue=dt(),ue!==t?(Ot=To(),Ot!==t?(Ee=B,U=ci(F,Ot),B=U):(E=B,B=t)):(E=B,B=t)):(E=B,B=t)):(E=B,B=t),B===t&&(B=null),B!==t?(U=dt(),U!==t?(s.charCodeAt(E)===44?(X=qs,E++):(X=t,z===0&&q(os)),X===t&&(s.charCodeAt(E)===59?(X=T,E++):(X=t,z===0&&q(O))),X===t&&(X=null),X!==t?(ue=CC(),ue===t&&(ue=null),ue!==t?(Ee=P,v=Xs(F,B,ue),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function v2(){var P,v,F,B;return P=E,v=ey(),v===t&&(v=$P()),v!==t?(F=vC(),F!==t?(B=Op(),B===t&&(B=null),B!==t?(Ee=P,v=on(v,F,B),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function vC(){var P,v,F,B,U,X,ue;return P=E,v=dt(),v!==t?(s.substr(E,2)===ss?(F=ss,E+=2):(F=t,z===0&&q(Ys)),F===t&&(s.substr(E,2)===il?(F=il,E+=2):(F=t,z===0&&q(ku))),F!==t?(B=dt(),B!==t?(U=ey(),U===t&&(U=$P()),U!==t?(X=dt(),X!==t?(ue=vC(),ue===t&&(ue=null),ue!==t?(Ee=P,v=ar(F,U,ue),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function A2(){var P,v,F;return P=E,v=$P(),v!==t?(F=Op(),F===t&&(F=null),F!==t?(Ee=P,v=On(v,F),P=v):(E=P,P=t)):(E=P,P=t),P}function $P(){var P,v,F;return P=E,v=To(),v!==t?(F=T2(),F===t&&(F=null),F!==t?(Ee=P,v=It(v,F),P=v):(E=P,P=t)):(E=P,P=t),P}function T2(){var P,v,F,B,U,X;return z++,P=E,s.charCodeAt(E)===58?(v=zr,E++):(v=t,z===0&&q(Rn)),v!==t?(F=To(),F!==t?(B=E,s.charCodeAt(E)===58?(U=zr,E++):(U=t,z===0&&q(Rn)),U!==t?(X=AC(),X!==t?(Ee=B,U=as(F,X),B=U):(E=B,B=t)):(E=B,B=t),B===t&&(B=null),B!==t?(Ee=P,v=ls(F,B),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P===t&&(P=E,s.charCodeAt(E)===58?(v=zr,E++):(v=t,z===0&&q(Rn)),v!==t?(F=AC(),F!==t?(Ee=P,v=us(F),P=v):(E=P,P=t)):(E=P,P=t)),z--,P===t&&(v=t,z===0&&q(mr)),P}function ey(){var P,v,F,B,U,X;return P=E,v=E,s.substr(E,8).toLowerCase()===Oi?(F=s.substr(E,8),E+=8):(F=t,z===0&&q(_n)),F!==t?(B=dt(),B!==t?(U=To(),U===t&&(U=null),U!==t?(X=dt(),X!==t?(Ee=v,F=zu(U),v=F):(E=v,v=t)):(E=v,v=t)):(E=v,v=t)):(E=v,v=t),v===t&&(v=null),v!==t?(s.charCodeAt(E)===123?(F=d,E++):(F=t,z===0&&q(f)),F!==t?(B=xC(),B===t&&(B=null),B!==t?(U=dt(),U!==t?(s.charCodeAt(E)===125?(X=p,E++):(X=t,z===0&&q(S)),X!==t?(Ee=P,v=Uu(v,B),P=v):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function AC(){var P;return s.charCodeAt(E)===110?(P=Ks,E++):(P=t,z===0&&q(Ur)),P===t&&(s.substr(E,2)===Wu?(P=Wu,E+=2):(P=t,z===0&&q(nl)),P===t&&(s.charCodeAt(E)===101?(P=Hu,E++):(P=t,z===0&&q(ol)),P===t&&(s.substr(E,2)===sl?(P=sl,E+=2):(P=t,z===0&&q(ju)),P===t&&(s.charCodeAt(E)===115?(P=qu,E++):(P=t,z===0&&q(Zs)),P===t&&(s.substr(E,2)===Qs?(P=Qs,E+=2):(P=t,z===0&&q(Mn)),P===t&&(s.charCodeAt(E)===119?(P=al,E++):(P=t,z===0&&q($h)),P===t&&(s.substr(E,2)===Nn?(P=Nn,E+=2):(P=t,z===0&&q(ed))))))))),P}function To(){var P;return P=TC(),P===t&&(P=I2(),P===t&&(P=LC(),P===t&&(P=L2(),P===t&&(P=w2())))),P}function TC(){var P,v,F,B;if(z++,P=E,v=IC(),v!==t){for(F=[],B=wC();B!==t;)F.push(B),B=wC();F!==t?(Ee=P,v=Xu(v,F),P=v):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(v=t,z===0&&q(td)),P}function I2(){var P,v,F;return P=E,v=LC(),v!==t?(F=TC(),F!==t?(Ee=P,v=cs(v,F),P=v):(E=P,P=t)):(E=P,P=t),P}function IC(){var P;return P=G2(),P===t&&(s.charCodeAt(E)===36?(P=rd,E++):(P=t,z===0&&q(id)),P===t&&(s.charCodeAt(E)===95?(P=ll,E++):(P=t,z===0&&q(Yu)))),P}function wC(){var P;return P=IC(),P===t&&(P=j2()),P}function LC(){var P,v,F,B,U,X,ue,Ot,Rt;if(z++,P=E,v=E,s.charCodeAt(E)===45?(F=nd,E++):(F=t,z===0&&q(od)),F===t&&(F=null),F!==t){if(B=E,s.charCodeAt(E)===46?(U=Ku,E++):(U=t,z===0&&q($s)),U!==t){if(X=[],Bn.test(s.charAt(E))?(ue=s.charAt(E),E++):(ue=t,z===0&&q(Ri)),ue!==t)for(;ue!==t;)X.push(ue),Bn.test(s.charAt(E))?(ue=s.charAt(E),E++):(ue=t,z===0&&q(Ri));else X=t;X!==t?(U=[U,X],B=U):(E=B,B=t)}else E=B,B=t;if(B===t){if(B=E,U=[],Bn.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(Ri)),X!==t)for(;X!==t;)U.push(X),Bn.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(Ri));else U=t;if(U!==t){if(X=E,s.charCodeAt(E)===46?(ue=Ku,E++):(ue=t,z===0&&q($s)),ue!==t){for(Ot=[],Bn.test(s.charAt(E))?(Rt=s.charAt(E),E++):(Rt=t,z===0&&q(Ri));Rt!==t;)Ot.push(Rt),Bn.test(s.charAt(E))?(Rt=s.charAt(E),E++):(Rt=t,z===0&&q(Ri));Ot!==t?(ue=[ue,Ot],X=ue):(E=X,X=t)}else E=X,X=t;X===t&&(X=null),X!==t?(U=[U,X],B=U):(E=B,B=t)}else E=B,B=t}B!==t?(F=[F,B],v=F):(E=v,v=t)}else E=v,v=t;return v!==t&&(Ee=P,v=Zu(v)),P=v,z--,P===t&&(v=t,z===0&&q(Js)),P}function w2(){var P,v;return P=E,v=ty(),v!==t&&(Ee=P,v=Dn(v)),P=v,P}function ty(){var P,v,F,B;if(P=E,s.charCodeAt(E)===60?(v=ea,E++):(v=t,z===0&&q(ta)),v!==t){for(F=[],B=OC(),B===t&&(B=ty());B!==t;)F.push(B),B=OC(),B===t&&(B=ty());F!==t?(s.charCodeAt(E)===62?(B=hs,E++):(B=t,z===0&&q(So)),B!==t?(Ee=P,v=Qu(F),P=v):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return P}function OC(){var P,v,F,B,U;if(P=E,v=[],F=E,B=E,z++,s.charCodeAt(E)===62?(U=hs,E++):(U=t,z===0&&q(So)),U===t&&(s.charCodeAt(E)===60?(U=ea,E++):(U=t,z===0&&q(ta))),z--,U===t?B=void 0:(E=B,B=t),B!==t?(s.length>E?(U=s.charAt(E),E++):(U=t,z===0&&q(Wr)),U!==t?(Ee=F,B=Fn(U),F=B):(E=F,F=t)):(E=F,F=t),F!==t)for(;F!==t;)v.push(F),F=E,B=E,z++,s.charCodeAt(E)===62?(U=hs,E++):(U=t,z===0&&q(So)),U===t&&(s.charCodeAt(E)===60?(U=ea,E++):(U=t,z===0&&q(ta))),z--,U===t?B=void 0:(E=B,B=t),B!==t?(s.length>E?(U=s.charAt(E),E++):(U=t,z===0&&q(Wr)),U!==t?(Ee=F,B=Fn(U),F=B):(E=F,F=t)):(E=F,F=t);else v=t;return v!==t&&(Ee=P,v=ul(v)),P=v,P}function L2(){var P,v,F,B;if(P=E,s.charCodeAt(E)===34?(v=Hr,E++):(v=t,z===0&&q(Gn)),v!==t){for(F=[],B=RC();B!==t;)F.push(B),B=RC();F!==t?(s.charCodeAt(E)===34?(B=Hr,E++):(B=t,z===0&&q(Gn)),B!==t?(Ee=P,v=cl(F),P=v):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return P}function RC(){var P,v,F;return P=O2(),P===t&&(P=E,v=E,z++,s.charCodeAt(E)===34?(F=Hr,E++):(F=t,z===0&&q(Gn)),F===t&&(F=_2()),z--,F===t?v=void 0:(E=v,v=t),v!==t?(F=N2(),F!==t?(Ee=P,v=Vn(),P=v):(E=P,P=t)):(E=P,P=t),P===t&&(P=R2())),P}function O2(){var P,v,F,B;return P=E,v=E,s.charCodeAt(E)===92?(F=Ir,E++):(F=t,z===0&&q(hi)),F!==t?(s.length>E?(B=s.charAt(E),E++):(B=t,z===0&&q(Wr)),B!==t?(F=[F,B],v=F):(E=v,v=t)):(E=v,v=t),v!==t&&(Ee=P,v=Eo(v)),P=v,P}function R2(){var P,v,F;return P=E,s.charCodeAt(E)===92?(v=Ir,E++):(v=t,z===0&&q(hi)),v!==t?(F=M2(),F!==t?(Ee=P,v=xo(),P=v):(E=P,P=t)):(E=P,P=t),P}function _2(){var P;return ds.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(sd)),P}function M2(){var P,v;return z++,s.charCodeAt(E)===10?(P=G,E++):(P=t,z===0&&q(Y)),P===t&&(s.substr(E,2)===$?(P=$,E+=2):(P=t,z===0&&q(te)),P===t&&(s.charCodeAt(E)===13?(P=Ae,E++):(P=t,z===0&&q(We)),P===t&&(s.charCodeAt(E)===8232?(P=Be,E++):(P=t,z===0&&q(st)),P===t&&(s.charCodeAt(E)===8233?(P=kn,E++):(P=t,z===0&&q(sn)))))),z--,P===t&&(v=t,z===0&&q(Co)),P}function N2(){var P;return s.length>E?(P=s.charAt(E),E++):(P=t,z===0&&q(Wr)),P}function H6(){var P,v,F;if(P=E,v=[],F=_C(),F!==t)for(;F!==t;)v.push(F),F=_C();else v=t;return v!==t&&(Ee=P,v=cl(v)),P=v,P}function _C(){var P,v,F;return fs.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(jr)),P===t&&(P=E,s.substr(E,2)===hl?(v=hl,E+=2):(v=t,z===0&&q(ad)),v!==t&&(Ee=P,v=ld()),P=v,P===t&&(P=E,s.charCodeAt(E)===92?(v=Ir,E++):(v=t,z===0&&q(hi)),v!==t?(F=ry(),F!==t?(Ee=P,v=xo(),P=v):(E=P,P=t)):(E=P,P=t),P===t&&(P=E,s.charCodeAt(E)===92?(v=Ir,E++):(v=t,z===0&&q(hi)),v!==t&&(Ee=P,v=ud()),P=v))),P}function MC(){var P,v;return z++,P=B2(),P===t&&(P=D2(),P===t&&(P=F2())),z--,P===t&&(v=t,z===0&&q(cd)),P}function B2(){var P,v,F,B,U,X;if(z++,P=E,s.substr(E,2)===an?(v=an,E+=2):(v=t,z===0&&q(YP)),v!==t){for(F=[],B=E,U=E,z++,s.substr(E,2)===ps?(X=ps,E+=2):(X=t,z===0&&q(dl)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=hd(X),B=U):(E=B,B=t)):(E=B,B=t);B!==t;)F.push(B),B=E,U=E,z++,s.substr(E,2)===ps?(X=ps,E+=2):(X=t,z===0&&q(dl)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=hd(X),B=U):(E=B,B=t)):(E=B,B=t);F!==t?(s.substr(E,2)===ps?(B=ps,E+=2):(B=t,z===0&&q(dl)),B!==t?(Ee=P,v=KP(F),P=v):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(v=t,z===0&&q(Ju)),P}function D2(){var P,v,F,B,U,X;if(z++,P=E,s.substr(E,2)===C?(v=C,E+=2):(v=t,z===0&&q(I)),v!==t){for(F=[],B=E,U=E,z++,_.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(V)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=Fn(X),B=U):(E=B,B=t)):(E=B,B=t);B!==t;)F.push(B),B=E,U=E,z++,_.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(V)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=Fn(X),B=U):(E=B,B=t)):(E=B,B=t);F!==t?(_.test(s.charAt(E))?(B=s.charAt(E),E++):(B=t,z===0&&q(V)),B===t&&(B=null),B!==t?(Ee=P,v=Z(F),P=v):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(v=t,z===0&&q(ZP)),P}function F2(){var P,v,F,B,U,X;if(z++,P=E,s.charCodeAt(E)===35?(v=De,E++):(v=t,z===0&&q(er)),v!==t){for(F=[],B=E,U=E,z++,_.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(V)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=Fn(X),B=U):(E=B,B=t)):(E=B,B=t);B!==t;)F.push(B),B=E,U=E,z++,_.test(s.charAt(E))?(X=s.charAt(E),E++):(X=t,z===0&&q(V)),z--,X===t?U=void 0:(E=U,U=t),U!==t?(s.length>E?(X=s.charAt(E),E++):(X=t,z===0&&q(Wr)),X!==t?(Ee=B,U=Fn(X),B=U):(E=B,B=t)):(E=B,B=t);F!==t?(_.test(s.charAt(E))?(B=s.charAt(E),E++):(B=t,z===0&&q(V)),B===t&&(B=null),B!==t?(Ee=P,v=Z(F),P=v):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(v=t,z===0&&q(ae)),P}function dt(){var P,v;for(z++,P=[],v=NC(),v===t&&(v=MC());v!==t;)P.push(v),v=NC(),v===t&&(v=MC());return z--,P===t&&(v=t,z===0&&q(lr)),P}function ry(){var P,v;if(P=[],br.test(s.charAt(E))?(v=s.charAt(E),E++):(v=t,z===0&&q(Vi)),v!==t)for(;v!==t;)P.push(v),br.test(s.charAt(E))?(v=s.charAt(E),E++):(v=t,z===0&&q(Vi));else P=t;return P}function NC(){var P,v;if(P=[],gC.test(s.charAt(E))?(v=s.charAt(E),E++):(v=t,z===0&&q(mC)),v===t&&(v=ry()),v!==t)for(;v!==t;)P.push(v),gC.test(s.charAt(E))?(v=s.charAt(E),E++):(v=t,z===0&&q(mC)),v===t&&(v=ry());else P=t;return P}function G2(){var P;return P=W2(),P===t&&(P=V2(),P===t&&(P=U2(),P===t&&(P=k2(),P===t&&(P=z2(),P===t&&(P=H2()))))),P}function V2(){var P;return s2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(a2)),P}function k2(){var P;return l2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(u2)),P}function z2(){var P;return c2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(h2)),P}function U2(){var P;return d2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(f2)),P}function W2(){var P;return p2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(g2)),P}function H2(){var P;return m2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(b2)),P}function j2(){var P;return P2.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&q(y2)),P}if(Lp=n(),Lp!==t&&E===s.length)return Lp;throw Lp!==t&&E<s.length&&q(E2()),yC(QP,vo<s.length?s.charAt(vo):null,vo<s.length?dd(vo,vo+1):dd(vo,vo))}DC.exports={SyntaxError:fl,parse:tM}});var VC=Fe((X6,GC)=>{var rM=FC();GC.exports=rM.parse});var oy=Fe(Rp=>{"use strict";Object.defineProperty(Rp,"__esModule",{value:!0});var kC=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,i=!1){if(i&&this.isDuplicate(e))return!1;let n=new fd(e),o=this._head;if(o)for(;;){if(o.value===t)return n.next=o.next,n.prev=o,o.next=n,n.next?n.next.prev=n:this._tail=n,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new fd(e);return this._tail?(this._tail.next=i,i.prev=this._tail,this._tail=i):this._head=this._tail=i,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new fd(e);return this._head?(i.next=this._head,this._head.prev=i,this._head=i):this._head=this._tail=i,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),i=[],n=Math.min(e,this.length);for(let o=0;o<n;o++){let a=t.next();i.push(a.value)}return i}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Rp.LinkedList=kC;var fd=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Rp.LinkedListItem=fd});var gs=Fe(sy=>{"use strict";Object.defineProperty(sy,"__esModule",{value:!0});var iM=oy(),zC=class extends iM.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};sy.Queue=zC});var un=Fe(gy=>{"use strict";Object.defineProperty(gy,"__esModule",{value:!0});var pM=oy(),HC=class extends pM.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};gy.Stack=HC});var tr=Fe(na=>{"use strict";var Gp=na&&na.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,n++)i[n]=o[a];return i};Object.defineProperty(na,"__esModule",{value:!0});na.StringBuilder=na.String=void 0;var oc=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{var n=t[0];if(Array.isArray(n)||n instanceof Array){for(var o=s.Empty,a=0,l=0;l<n.length;l++){var u=n[l];l<n.length-1?o+=u+e:o+=u}return o}else if(typeof n=="object"){var c=s.Empty,h=n,d=Object.keys(n);return d.forEach(function(p){c+=h[p]+e}),c=c.slice(0,c.length-e.length),c}var f=t;return s.join.apply(s,Gp([e],f))}catch(p){return console.log(p),s.Empty}},s.Format=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(n){return console.log(n),s.Empty}},s.format=function(e,t,i,n){return n===void 0&&(n=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return n?u=i[0][a]:u=i[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var i=t.replace(/,/g,".");if(isNaN(parseFloat(i))||i.length<=3)break;var n=i.split(/[^0-9]+/g),o=n;n.length>1&&(o=[s.join.apply(s,Gp([""],n.splice(0,n.length-1))),n[n.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var i=parseFloat(e),n=i.toString(16);return t?n.toLocaleUpperCase():n},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var i=t[t.length-1],n=t[t.length-2],o=t[t.length-3];return i=i.split("T")[0],i=i.split(" ")[0],i+"."+n+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var i=t[t.length-1].split(" "),n=s.Empty;i.length>1&&(n=i[i.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(n)&&n.length>1?u+="T"+n:u+="T00:00:00",u},s.formatNumber=function(e,t){var i=t.length,n=e.toString();if(i<=n.length)return n;var o=i-n.length;return o+=1,new Array(o).join("0")+n},s.join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var n=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];n+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){n+=e,o=l-1;break}}return n},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();na.String=oc;var SM=function(){function s(e){this.Values=[],oc.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(oc.Format.apply(oc,Gp([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(`\r
`+oc.Format.apply(oc,Gp([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();na.StringBuilder=SM});var oa=Fe(it=>{"use strict";Object.defineProperty(it,"__esModule",{value:!0});it.isPrimitive=it.isPropertyKey=it.isString=it.isBoolean=it.isNumber=it.isIterator=it.isAsyncIterable=it.isIterable=it.isDefined=it.isMissing=it.isInstance=it.isObject=it.isFunctionOrUndefined=it.isFunction=void 0;function rv(s){return typeof s=="function"}it.isFunction=rv;function Vp(s){return typeof s=="function"||s===void 0}it.isFunctionOrUndefined=Vp;function iv(s){return typeof s=="object"&&s!==null||typeof s=="function"}it.isObject=iv;function CM(s,e){return!nv(s)&&s instanceof e}it.isInstance=CM;function nv(s){return s==null}it.isMissing=nv;function vM(s){return s!=null}it.isDefined=vM;function AM(s){return s!=null&&Symbol.iterator in Object(s)}it.isIterable=AM;function TM(s){return s!=null&&Symbol.asyncIterator in Object(s)}it.isAsyncIterable=TM;function IM(s){return iv(s)&&rv(s.next)&&Vp(s.throw)&&Vp(s.return)&&Vp(s[Symbol.iterator])}it.isIterator=IM;function wM(s){return typeof s=="number"}it.isNumber=wM;function LM(s){return typeof s=="boolean"}it.isBoolean=LM;function OM(s){return typeof s=="string"}it.isString=OM;function RM(s){return typeof s=="string"||typeof s=="symbol"||typeof s=="number"}it.isPropertyKey=RM;function _M(s){return typeof s!="function"&&(typeof s!="object"||s===null)}it.isPrimitive=_M});var vy=Fe(kp=>{"use strict";Object.defineProperty(kp,"__esModule",{value:!0});kp.binarySearch=void 0;function MM(s,e,t){if(s.length===0)return-1;let i=0,n=s.length-1;for(;i<=n;){let o=i+(n-i>>1),a=s[o];switch(Math.sign(t.compare(a,e))){case-1:i=o+1;break;case 0:return o;case 1:n=o-1;break}}return~i}kp.binarySearch=MM});var ov=Fe(lc=>{"use strict";Object.defineProperty(lc,"__esModule",{value:!0});lc.deprecateProperty=lc.deprecate=void 0;function NM(){try{return Q2("util").deprecate}catch{}}function BM(){let s=typeof process=="object"&&typeof process.emitWarning=="function"?function e(t,i="Warning",n=e){process.emitWarning(t,i,n)}:typeof Error.captureStackTrace=="function"?function e(t,i="Warning",n=e){typeof t=="string"&&(t=new Error(t),t.name=i),Error.captureStackTrace(t,n),console.warn(t)}:function(t,i="Warning"){typeof t=="string"?console.warn(`${i}:`,t):console.warn(t)};return(e,t)=>{let i=!1;function n(...o){return i||(i=!0,s(t,"DeprecationWarning",e)),new.target?Reflect.construct(e,o,new.target):e.apply(this,o)}return Object.setPrototypeOf(n,e),e.prototype&&(n.prototype=e.prototype),n}}var DM=NM()||BM();function zp(s,e){return DM(s,e)}lc.deprecate=zp;function FM(s,e,t){let i=Object.getOwnPropertyDescriptor(s,e);if(i&&i.configurable){let n=!1;i.get&&(i.get=zp(i.get,t),n=!0),i.set&&(i.set=zp(i.set,t),n=!0),typeof i.value=="function"&&(i.value=zp(i.value,t),n=!0),n&&Object.defineProperty(s,e,i)}return s}lc.deprecateProperty=FM});var El=Fe(lt=>{"use strict";Object.defineProperty(lt,"__esModule",{value:!0});lt.KeyedMultiCollection=lt.ReadonlyKeyedMultiCollection=lt.KeyedCollection=lt.ReadonlyKeyedCollection=lt.IndexedCollection=lt.FixedSizeIndexedCollection=lt.ReadonlyIndexedCollection=lt.Collection=lt.ReadonlyCollection=void 0;var Up=oa(),ur=ov(),Kr;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has");function e(i){return Up.isIterable(i)&&s.size in i&&s.has in i}s.isReadonlyCollection=e,s.name="ReadonlyCollection";function t(i){return Up.isIterable(i)&&s.size in i&&s.has in i}s.hasInstance=t})(Kr=lt.ReadonlyCollection||(lt.ReadonlyCollection={}));var yl;(function(s){s.size=Kr.size,s.has=Kr.has,s.isReadonlyCollection=Kr.isReadonlyCollection,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.clear=Symbol.for("@esfx/collection-core!Collection.clear");function e(i){return s.hasInstance(i)}s.isCollection=e,s.name="Collection";function t(i){return Kr.hasInstance(i)&&s.add in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(yl=lt.Collection||(lt.Collection={}));var _o;(function(s){s.size=Kr.size,s.has=Kr.has,s.isReadonlyCollection=Kr.isReadonlyCollection,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt");function e(i){return s.hasInstance(i)}s.isReadonlyIndexedCollection=e,s.name="ReadonlyIndexedCollection";function t(i){return Kr.hasInstance(i)&&s.indexOf in i&&s.getAt in i}s.hasInstance=t})(_o=lt.ReadonlyIndexedCollection||(lt.ReadonlyIndexedCollection={}));var Sl;(function(s){s.size=Kr.size,s.has=Kr.has,s.isReadonlyCollection=Kr.isReadonlyCollection,s.indexOf=_o.indexOf,s.getAt=_o.getAt,s.isReadonlyIndexedCollection=_o.isReadonlyIndexedCollection,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt");function e(i){return s.hasInstance(i)}s.isFixedSizeIndexedCollection=e,s.name="FixedSizeIndexedCollection";function t(i){return _o.hasInstance(i)&&s.setAt in i}s.hasInstance=t})(Sl=lt.FixedSizeIndexedCollection||(lt.FixedSizeIndexedCollection={}));var uc;(function(s){s.size=Kr.size,s.has=Kr.has,s.isReadonlyCollection=Kr.isReadonlyCollection,s.indexOf=_o.indexOf,s.getAt=_o.getAt,s.isReadonlyIndexedCollection=_o.isReadonlyIndexedCollection,s.setAt=Sl.setAt,s.isFixedSizeIndexedCollection=Sl.isFixedSizeIndexedCollection,s.add=yl.add,s.delete=yl.delete,s.clear=yl.clear,s.isCollection=yl.isCollection,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt");function e(i){return s.hasInstance(i)}s.isIndexedCollection=e,s.name="IndexedCollection";function t(i){return Sl.hasInstance(i)&&s.insertAt in i&&s.removeAt in i}s.hasInstance=t})(uc=lt.IndexedCollection||(lt.IndexedCollection={}));var Ss;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedCollection=e,s.name="ReadonlyKeyedCollection";function t(i){return Up.isIterable(i)&&s.size in i&&s.has in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(Ss=lt.ReadonlyKeyedCollection||(lt.ReadonlyKeyedCollection={}));var Ay;(function(s){s.size=Ss.size,s.has=Ss.has,s.get=Ss.get,s.keys=Ss.keys,s.values=Ss.values,s.isReadonlyKeyedCollection=Ss.isReadonlyKeyedCollection,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedCollection=e,s.name="KeyedCollection";function t(i){return Ss.hasInstance(i)&&s.set in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(Ay=lt.KeyedCollection||(lt.KeyedCollection={}));var Ro;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedMultiCollection=e,s.name="ReadonlyKeyedMultiCollection";function t(i){return Up.isIterable(i)&&s.size in i&&s.has in i&&s.hasValue in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(Ro=lt.ReadonlyKeyedMultiCollection||(lt.ReadonlyKeyedMultiCollection={}));var Ty;(function(s){s.size=Ro.size,s.has=Ro.has,s.hasValue=Ro.hasValue,s.get=Ro.get,s.keys=Ro.keys,s.values=Ro.values,s.isReadonlyKeyedMultiCollection=Ro.isReadonlyKeyedMultiCollection,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedMultiCollection=e,s.name="KeyedMultiCollection";function t(i){return Ro.hasInstance(i)&&s.add in i&&s.delete in i&&s.deleteValue in i&&s.clear in i}s.hasInstance=t})(Ty=lt.KeyedMultiCollection||(lt.KeyedMultiCollection={}));ur.deprecateProperty(Kr,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");ur.deprecateProperty(yl,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");ur.deprecateProperty(yl,"isCollection","Use 'Collection.hasInstance' instead.");ur.deprecateProperty(_o,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");ur.deprecateProperty(_o,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");ur.deprecateProperty(Sl,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");ur.deprecateProperty(Sl,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");ur.deprecateProperty(Sl,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");ur.deprecateProperty(uc,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");ur.deprecateProperty(uc,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");ur.deprecateProperty(uc,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");ur.deprecateProperty(uc,"isCollection","Use 'Collection.hasInstance' instead.");ur.deprecateProperty(uc,"isIndexedCollection","Use 'IndexedCollection.hasInstance' instead.");ur.deprecateProperty(Ss,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");ur.deprecateProperty(Ay,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");ur.deprecateProperty(Ay,"isKeyedCollection","Use 'KeyedCollection.hasInstance' instead.");ur.deprecateProperty(Ro,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");ur.deprecateProperty(Ty,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");ur.deprecateProperty(Ty,"isKeyedMultiCollection","Use 'KeyedMultiCollection.hasInstance' instead.")});var uv=Fe(sa=>{"use strict";Object.defineProperty(sa,"__esModule",{value:!0});sa.hash=sa.defaultSeed=sa.createSeed=void 0;function lv(){return Math.random()*4294967295>>>0}sa.createSeed=lv;sa.defaultSeed=lv();var sv=3432918353,av=461845907,GM=3864292196;function VM(s,e){let t=new DataView(s),i=e>>>0,n=0,o;for(;n<t.byteLength-4;)o=t.getUint32(n,!0),o*=sv,o=o<<15|o>>>17,o*=av,i^=o,i=i<<13|i>>>19,i=i*5+GM,n+=4;if(n<t.byteLength){switch(o=0,t.byteLength-n){case 3:o|=t.getUint8(n+2)<<16;case 2:o|=t.getUint8(n+1)<<8;case 1:o|=t.getUint8(n+0)<<0}o*=sv,o=o<<15|o>>>17,o*=av,i^=o}return i^=t.byteLength,i^=i>>>16,i*=2246822507,i^=i>>>13,i*=3266489909,i^=i>>>16,i}sa.hash=VM});var Pv=Fe(cc=>{"use strict";Object.defineProperty(cc,"__esModule",{value:!0});cc.hashUnknown=void 0;var hc=uv(),xl,Wp,xd,Cl,vl,Al,hv=2**31-1,kM=~hv,zM=2**32-1,UM=0,Iy=new DataView(new ArrayBuffer(8)),dv=hc.createSeed(),fv=hc.createSeed(),pv=hc.createSeed(),gv=hc.createSeed(),mv=hc.createSeed(),wy=dv,Ly=fv,Oy=mv,Ry=pv,_y=gv;function WM(s){return s?1:0}function HM(s){return Number.isInteger(s)&&s>=kM&&s<=hv}function jM(s){return Number.isInteger(s)&&s>=UM&&s<=zM}function qM(s){return s>>0}function XM(s){return Iy.setFloat64(0,s),Iy.getInt32(0,!0)^Iy.getInt32(4,!0)}function YM(s){return HM(s)?s:jM(s)?qM(s):XM(s)}function KM(s,e){let t=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);return hc.hash(t,e)}function Hp(s,e,t){if(!Buffer.isEncoding(e))throw new RangeError(`Invalid encoding: ${e}`);return KM(Buffer.from(s,e),t)}function My(s,e){return(s<<7|s>>>25)^e}function ZM(){let s=BigInt(0),e=BigInt(4294967295),t=BigInt(32);function i(n){if(n===s)return 0;let o=n<s?-1:n>s?1:0;for(n<s&&(n=-n);n!==s;)o=My(o,Number(n&e)),n=n>>t;return o}return i}function QM(){function s(e){return Hp(e.toString(),"ascii",Oy)}return s}var JM=typeof BigInt=="function"?ZM():QM();function $M(s){return Hp(s,"utf8",Ly)}function eN(s,e){let t=vl&&vl.get(s);return t===void 0&&(t=Hp(e,"utf8",_y),vl||(vl=new Map),vl.set(s,t)),t}var tN="description"in Symbol.prototype?s=>s.description:s=>{let e=s.toString();return e.startsWith("Symbol(")&&e.endsWith(")")?e.slice(7,-1):e};function rN(s){let e=Al&&Al.get(s);if(e===void 0){xd||(xd={next:1}),e=My(Ry,xd.next++);let t=tN(s);t&&(e=Hp(t,"utf8",e)),Al||(Al=new Map),Al.set(s,e)}return e}function iN(s){let e=Symbol.keyFor(s);return e!==void 0?eN(s,e):rN(s)}function nN(s){let e;return s===null?e=Wp||(Wp={next:1}):(e=xl&&xl.get(s),e||(xl||(xl=new WeakMap),xl.set(s,e={next:1}))),e}function cv(s){let e=Cl&&Cl.get(s);return e===void 0&&(Cl||(Cl=new WeakMap),e=nN(Object.getPrototypeOf(s)).next++,e=My(wy,e),Cl.set(s,e)),e}function bv(s){switch(typeof s){case"boolean":return WM(s);case"number":return YM(s);case"bigint":return JM(s);case"string":return $M(s);case"symbol":return iN(s);case"function":return cv(s);case"object":if(s!==null)return cv(s);case"undefined":default:return 0}}cc.hashUnknown=bv;(function(s){function e(){return{weakPrototypeCounters:xl,nullPrototypeCounter:Wp,localSymbolCounter:xd,weakObjectHashes:Cl,globalSymbolHashes:vl,localSymbolHashes:Al,objectSeed:wy,stringSeed:Ly,bigIntSeed:Oy,localSymbolSeed:Ry,globalSymbolSeed:_y}}s.getState=e;function t(i){({weakPrototypeCounters:xl,nullPrototypeCounter:Wp,localSymbolCounter:xd,weakObjectHashes:Cl,globalSymbolHashes:vl,localSymbolHashes:Al,objectSeed:wy=dv,stringSeed:Ly=fv,bigIntSeed:Oy=mv,localSymbolSeed:Ry=pv,globalSymbolSeed:_y=gv}=i)}s.setState=t})(bv=cc.hashUnknown||(cc.hashUnknown={}))});var Tl=Fe(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.rawHash=xe.tupleStructuralComparer=xe.tupleComparer=xe.structuralComparer=xe.defaultComparer=xe.Comparer=xe.combineHashes=xe.tupleStructuralEqualer=xe.tupleEqualer=xe.structuralEqualer=xe.defaultEqualer=xe.Equaler=xe.StructuralComparable=xe.StructuralEquatable=xe.Comparable=xe.Equatable=void 0;var yv=Pv(),aa;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let i;return t!=null&&s.equals in(i=Object(t))&&s.hash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(aa=xe.Equatable||(xe.Equatable={}));(function(s){let e=jp("Use 'Equatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isEquatable=t})(aa=xe.Equatable||(xe.Equatable={}));var dc;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(dc=xe.Comparable||(xe.Comparable={}));(function(s){let e=jp("Use 'Comparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isComparable=t})(dc=xe.Comparable||(xe.Comparable={}));var la;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let i;return t!=null&&s.structuralEquals in(i=Object(t))&&s.structuralHash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(la=xe.StructuralEquatable||(xe.StructuralEquatable={}));(function(s){let e=jp("Use 'StructuralEquatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralEquatable=t})(la=xe.StructuralEquatable||(xe.StructuralEquatable={}));var fc;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(fc=xe.StructuralComparable||(xe.StructuralComparable={}));(function(s){let e=jp("Use 'StructuralComparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralComparable=t})(fc=xe.StructuralComparable||(xe.StructuralComparable={}));var pc;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>aa.hasInstance(o)?o[aa.equals](a):aa.hasInstance(a)?a[aa.equals](o):Object.is(o,a),o=>aa.hasInstance(o)?o[aa.hash]():yv.hashUnknown(o)),s.structuralEqualer=t((o,a)=>la.hasInstance(o)?o[la.structuralEquals](a,s.structuralEqualer):la.hasInstance(a)?a[la.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>la.hasInstance(o)?o[la.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function i(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=i;function n(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(pc=xe.Equaler||(xe.Equaler={}));xe.defaultEqualer=pc.defaultEqualer;xe.structuralEqualer=pc.structuralEqualer;xe.tupleEqualer=pc.tupleEqualer;xe.tupleStructuralEqualer=pc.tupleEqualer;xe.combineHashes=pc.combineHashes;var Cd;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((n,o)=>dc.hasInstance(n)?n[dc.compareTo](o):dc.hasInstance(o)?-o[dc.compareTo](n):n<o?-1:n>o?1:0),s.structuralComparer=t((n,o)=>fc.hasInstance(n)?n[fc.structuralCompareTo](o,s.structuralComparer):fc.hasInstance(o)?-o[fc.structuralCompareTo](n,s.structuralComparer):s.defaultComparer.compare(n,o)),s.tupleComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.defaultComparer.compare(n[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.structuralComparer.compare(n[l],o[l]))return a;return 0});function t(n){return Object.setPrototypeOf({compare:n},e)}s.create=t;function i(n){return typeof n=="object"&&n!==null&&typeof n.compare=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(Cd=xe.Comparer||(xe.Comparer={}));xe.defaultComparer=Cd.defaultComparer;xe.structuralComparer=Cd.structuralComparer;xe.tupleComparer=Cd.tupleComparer;xe.tupleStructuralComparer=Cd.tupleStructuralComparer;function oN(s){return yv.hashUnknown(s)}xe.rawHash=oN;function jp(s){let e=!1;return()=>{e||(e=!0,typeof process=="object"&&process.emitWarning?process.emitWarning(s,"Deprecation"):typeof console=="object"&&console.warn(`Deprecation: ${s}`))}}});var vd=Fe(Xp=>{"use strict";Object.defineProperty(Xp,"__esModule",{value:!0});Xp.SortedMap=void 0;var sN=oa(),qp=vy(),ua=El(),Sv=Tl(),Ny=class{constructor(...e){this._keys=[],this._values=[];let t,i;if(e.length>0){let n=e[0];sN.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=Sv.Comparer.defaultComparer),this._comparer=typeof i=="function"?Sv.Comparer.create(i):i,t)for(let[n,o]of t)this.set(n,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return qp.binarySearch(this._keys,e,this._comparer)>=0}get(e){let t=qp.binarySearch(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let i=qp.binarySearch(this._keys,e,this._comparer);return i>=0?this._values[i]=t:(this._keys.splice(~i,0,e),this._values.splice(~i,0,t)),this}delete(e){let t=qp.binarySearch(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this)e.call(t,n,i,this)}get[ua.KeyedCollection.size](){return this.size}[ua.KeyedCollection.has](e){return this.has(e)}[ua.KeyedCollection.get](e){return this.get(e)}[ua.KeyedCollection.set](e,t){this.set(e,t)}[ua.KeyedCollection.delete](e){return this.delete(e)}[ua.KeyedCollection.clear](){this.clear()}[ua.KeyedCollection.keys](){return this.keys()}[ua.KeyedCollection.values](){return this.values()}};Xp.SortedMap=Ny;Object.defineProperty(Ny,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedMap"})});var TA=Fe((Pse,_g)=>{var sA,aA,lA,uA,cA,hA,dA,fA,pA,Og,w0,gA,mA,bA,Lc,PA,yA,SA,EA,xA,CA,vA,AA,Rg;(function(s){var e=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(i){s(t(e,t(i)))}):typeof _g=="object"&&typeof _g.exports=="object"?s(t(e,t(_g.exports))):s(t(e));function t(i,n){return i!==e&&(typeof Object.create=="function"?Object.defineProperty(i,"__esModule",{value:!0}):i.__esModule=!0),function(o,a){return i[o]=n?n(o,a):a}}})(function(s){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])};sA=function(i,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(i,n);function o(){this.constructor=i}i.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},aA=Object.assign||function(i){for(var n,o=1,a=arguments.length;o<a;o++){n=arguments[o];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(i[l]=n[l])}return i},lA=function(i,n){var o={};for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&n.indexOf(a)<0&&(o[a]=i[a]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(i);l<a.length;l++)n.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(i,a[l])&&(o[a[l]]=i[a[l]]);return o},uA=function(i,n,o,a){var l=arguments.length,u=l<3?n:a===null?a=Object.getOwnPropertyDescriptor(n,o):a,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(i,n,o,a);else for(var h=i.length-1;h>=0;h--)(c=i[h])&&(u=(l<3?c(u):l>3?c(n,o,u):c(n,o))||u);return l>3&&u&&Object.defineProperty(n,o,u),u},cA=function(i,n){return function(o,a){n(o,a,i)}},hA=function(i,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,n)},dA=function(i,n,o,a){function l(u){return u instanceof o?u:new o(function(c){c(u)})}return new(o||(o=Promise))(function(u,c){function h(p){try{f(a.next(p))}catch(S){c(S)}}function d(p){try{f(a.throw(p))}catch(S){c(S)}}function f(p){p.done?u(p.value):l(p.value).then(h,d)}f((a=a.apply(i,n||[])).next())})},fA=function(i,n){var o={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},a,l,u,c;return c={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function h(f){return function(p){return d([f,p])}}function d(f){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,l&&(u=f[0]&2?l.return:f[0]?l.throw||((u=l.return)&&u.call(l),0):l.next)&&!(u=u.call(l,f[1])).done)return u;switch(l=0,u&&(f=[f[0]&2,u.value]),f[0]){case 0:case 1:u=f;break;case 4:return o.label++,{value:f[1],done:!1};case 5:o.label++,l=f[1],f=[0];continue;case 7:f=o.ops.pop(),o.trys.pop();continue;default:if(u=o.trys,!(u=u.length>0&&u[u.length-1])&&(f[0]===6||f[0]===2)){o=0;continue}if(f[0]===3&&(!u||f[1]>u[0]&&f[1]<u[3])){o.label=f[1];break}if(f[0]===6&&o.label<u[1]){o.label=u[1],u=f;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(f);break}u[2]&&o.ops.pop(),o.trys.pop();continue}f=n.call(i,o)}catch(p){f=[6,p],l=0}finally{a=u=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},pA=function(i,n){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(n,o)&&Rg(n,i,o)},Rg=Object.create?function(i,n,o,a){a===void 0&&(a=o),Object.defineProperty(i,a,{enumerable:!0,get:function(){return n[o]}})}:function(i,n,o,a){a===void 0&&(a=o),i[a]=n[o]},Og=function(i){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&i[n],a=0;if(o)return o.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&a>=i.length&&(i=void 0),{value:i&&i[a++],done:!i}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},w0=function(i,n){var o=typeof Symbol=="function"&&i[Symbol.iterator];if(!o)return i;var a=o.call(i),l,u=[],c;try{for(;(n===void 0||n-- >0)&&!(l=a.next()).done;)u.push(l.value)}catch(h){c={error:h}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(c)throw c.error}}return u},gA=function(){for(var i=[],n=0;n<arguments.length;n++)i=i.concat(w0(arguments[n]));return i},mA=function(){for(var i=0,n=0,o=arguments.length;n<o;n++)i+=arguments[n].length;for(var a=Array(i),l=0,n=0;n<o;n++)for(var u=arguments[n],c=0,h=u.length;c<h;c++,l++)a[l]=u[c];return a},bA=function(i,n,o){if(o||arguments.length===2)for(var a=0,l=n.length,u;a<l;a++)(u||!(a in n))&&(u||(u=Array.prototype.slice.call(n,0,a)),u[a]=n[a]);return i.concat(u||Array.prototype.slice.call(n))},Lc=function(i){return this instanceof Lc?(this.v=i,this):new Lc(i)},PA=function(i,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=o.apply(i,n||[]),l,u=[];return l={},c("next"),c("throw"),c("return"),l[Symbol.asyncIterator]=function(){return this},l;function c(x){a[x]&&(l[x]=function(T){return new Promise(function(O,M){u.push([x,T,O,M])>1||h(x,T)})})}function h(x,T){try{d(a[x](T))}catch(O){S(u[0][3],O)}}function d(x){x.value instanceof Lc?Promise.resolve(x.value.v).then(f,p):S(u[0][2],x)}function f(x){h("next",x)}function p(x){h("throw",x)}function S(x,T){x(T),u.shift(),u.length&&h(u[0][0],u[0][1])}},yA=function(i){var n,o;return n={},a("next"),a("throw",function(l){throw l}),a("return"),n[Symbol.iterator]=function(){return this},n;function a(l,u){n[l]=i[l]?function(c){return(o=!o)?{value:Lc(i[l](c)),done:l==="return"}:u?u(c):c}:u}},SA=function(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=i[Symbol.asyncIterator],o;return n?n.call(i):(i=typeof Og=="function"?Og(i):i[Symbol.iterator](),o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o);function a(u){o[u]=i[u]&&function(c){return new Promise(function(h,d){c=i[u](c),l(h,d,c.done,c.value)})}}function l(u,c,h,d){Promise.resolve(d).then(function(f){u({value:f,done:h})},c)}},EA=function(i,n){return Object.defineProperty?Object.defineProperty(i,"raw",{value:n}):i.raw=n,i};var t=Object.create?function(i,n){Object.defineProperty(i,"default",{enumerable:!0,value:n})}:function(i,n){i.default=n};xA=function(i){if(i&&i.__esModule)return i;var n={};if(i!=null)for(var o in i)o!=="default"&&Object.prototype.hasOwnProperty.call(i,o)&&Rg(n,i,o);return t(n,i),n},CA=function(i){return i&&i.__esModule?i:{default:i}},vA=function(i,n,o,a){if(o==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?i!==n||!a:!n.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?a:o==="a"?a.call(i):a?a.value:n.get(i)},AA=function(i,n,o,a,l){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!l)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?i!==n||!l:!n.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?l.call(i,o):l?l.value=o:n.set(i,o),o},s("__extends",sA),s("__assign",aA),s("__rest",lA),s("__decorate",uA),s("__param",cA),s("__metadata",hA),s("__awaiter",dA),s("__generator",fA),s("__exportStar",pA),s("__createBinding",Rg),s("__values",Og),s("__read",w0),s("__spread",gA),s("__spreadArrays",mA),s("__spreadArray",bA),s("__await",Lc),s("__asyncGenerator",PA),s("__asyncDelegator",yA),s("__asyncValues",SA),s("__makeTemplateObject",EA),s("__importStar",xA),s("__importDefault",CA),s("__classPrivateFieldGet",vA),s("__classPrivateFieldSet",AA)})});var wA=Fe(Mg=>{"use strict";Object.defineProperty(Mg,"__esModule",{value:!0});Mg.SortedSet=void 0;var L0=vy(),CN=oa(),jd=El(),IA=Tl(),O0=class{constructor(...e){this._values=[];let t,i;if(e.length>0){let n=e[0];CN.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=IA.Comparer.defaultComparer),this._comparer=typeof i=="function"?IA.Comparer.create(i):i,t)for(let n of t)this.add(n)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return L0.binarySearch(this._values,e,this._comparer)>=0}add(e){let t=L0.binarySearch(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=L0.binarySearch(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){for(let i of this)e.call(t,i,i,this)}get[jd.Collection.size](){return this.size}[jd.Collection.has](e){return this.has(e)}[jd.Collection.add](e){this.add(e)}[jd.Collection.delete](e){return this.delete(e)}[jd.Collection.clear](){this.clear()}};Mg.SortedSet=O0;Object.defineProperty(O0,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedSet"})});var _A=Fe(Ca=>{"use strict";Object.defineProperty(Ca,"__esModule",{value:!0});Ca.expandPrime=Ca.getPrime=Ca.isPrime=void 0;var vN=2**31-1,R0=2146435069,AN=101,LA=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function OA(s){if(s&1){let e=Math.sqrt(s)|0;for(let t=3;t<=e;t+=2)if(!(s%t))return!1;return!0}return s===2}Ca.isPrime=OA;function RA(s){if(s<0)throw new RangeError;for(let e=0;e<LA.length;e++){let t=LA[e];if(t>=s)return t}for(let e=s|1;e<vN;e+=2)if(OA(e)&&(e-1)%AN)return e;return s}Ca.getPrime=RA;function TN(s){let e=2*s;return e>R0&&R0>s?R0:RA(e)}Ca.expandPrime=TN});var B0=Fe(qe=>{"use strict";Object.defineProperty(qe,"__esModule",{value:!0});qe.forEachEntry=qe.iterateEntries=qe.selectEntryEntry=qe.selectEntryValue=qe.selectEntryKey=qe.trimExcessEntries=qe.ensureCapacity=qe.clearEntries=qe.deleteEntry=qe.insertEntry=qe.findEntryValue=qe.findEntryIndex=qe.resizeHashData=qe.initializeHashData=qe.createHashData=qe.createHashEntry=void 0;var qd=_A(),_0=2**31-1;function M0(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}qe.createHashEntry=M0;function IN(s,e){let t=M0(),i={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:s,head:t,tail:t};return Xd(i,e),i}qe.createHashData=IN;function Xd(s,e){let t=qd.getPrime(e);return s.freeList=-1,s.buckets=new Int32Array(t),s.entries=new Array(t),t}qe.initializeHashData=Xd;function N0(s,e){let t=s.size,i=new Int32Array(e),n=s.entries?s.entries.slice():[];n.length=e;for(let o=0;o<t;o++){let a=n[o];if(a&&a.hashCode>=0){let l=a.hashCode%e;a.next=i[l]-1,i[l]=o+1}}s.buckets=i,s.entries=n}qe.resizeHashData=N0;function MA(s,e){let t=-1,{buckets:i,entries:n,equaler:o}=s;if(i&&n){let a=o.hash(e)&_0;for(t=i[a%i.length]-1;t>>>0<n.length&&!(n[t].hashCode===a&&o.equals(n[t].key,e));)t=n[t].next}return t}qe.findEntryIndex=MA;function wN(s,e){let t=MA(s,e);return t>=0?s.entries[t].value:void 0}qe.findEntryValue=wN;function LN(s,e,t){if(s.buckets||Xd(s,0),!s.buckets||!s.entries)throw new Error;let i=s.equaler.hash(e)&_0,n=i%s.buckets.length,o=s.buckets[n]-1;for(;o>>>0<s.entries.length;){let h=s.entries[o];if(h.hashCode===i&&s.equaler.equals(h.key,e)){h.value=t;return}o=h.next}let a=!1,l;if(s.freeSize>0)l=s.freeList,a=!0,s.freeSize--;else{let h=s.size;if(h===s.entries.length){if(N0(s,qd.expandPrime(s.size)),!s.buckets||!s.entries)throw new Error;n=i%s.buckets.length}l=h,s.size=h+1}let u=s.entries[l]||(s.entries[l]=M0());a&&(s.freeList=u.next),u.hashCode=i,u.next=s.buckets[n]-1,u.key=e,u.value=t,u.skipNextEntry=!1;let c=s.tail;c.nextEntry=u,u.prevEntry=c,s.tail=u,s.buckets[n]=l+1}qe.insertEntry=LN;function ON(s,e){if(s.buckets&&s.entries){let t=s.equaler.hash(e)&_0,i=t%s.buckets.length,n=-1,o;for(let a=s.buckets[i]-1;a>=0;a=o.next){if(o=s.entries[a],o.hashCode===t&&s.equaler.equals(o.key,e)){n<0?s.buckets[i]=o.next+1:s.entries[n].next=o.next;let l=o.prevEntry;return l.nextEntry=o.nextEntry,l.nextEntry&&(l.nextEntry.prevEntry=l),s.tail===o&&(s.tail=l),o.hashCode=-1,o.next=s.freeList,o.key=void 0,o.value=void 0,o.prevEntry=void 0,o.nextEntry=l,o.skipNextEntry=!0,s.freeList=a,s.freeSize++,!0}n=a}}return!1}qe.deleteEntry=ON;function RN(s){if(s.size>0){s.buckets&&s.buckets.fill(0),s.entries&&s.entries.fill(void 0);let t=s.head.nextEntry;for(;t;){let i=t.nextEntry;t.prevEntry=void 0,t.nextEntry=s.head,t.skipNextEntry=!0,t=i}s.head.nextEntry=void 0,s.tail=s.head,s.size=0,s.freeList=-1,s.freeSize=0}}qe.clearEntries=RN;function _N(s,e){if(e<0)throw new RangeError;let t=s.entries?s.entries.length:0;if(t>=e)return t;if(!s.buckets)return Xd(s,e);let i=qd.getPrime(e);return N0(s,qd.getPrime(e)),i}qe.ensureCapacity=_N;function MN(s,e=s.size-s.freeSize){if(e<s.size)throw new RangeError;if(!s.buckets||!s.entries)return;let t=qd.getPrime(e),i=s.entries;if(t>=(i?i.length:0))return;let n=s.size;if(Xd(s,t),!s.buckets||!s.entries)throw new Error;let o=0;for(let a=0;a<n;a++){let l=i[a].hashCode;if(l>=0){let u=l%t;s.entries[o]=i[a],s.entries[o].next=s.buckets[u]-1,s.buckets[u]=o+1,o++}}s.size=o,s.freeSize=0}qe.trimExcessEntries=MN;function NN(s){return s.key}qe.selectEntryKey=NN;function BN(s){return s.value}qe.selectEntryValue=BN;function DN(s){return[s.key,s.value]}qe.selectEntryEntry=DN;function*FN(s,e){let t=s;for(;t;){let i=t.skipNextEntry;t=t.nextEntry,!i&&t&&(yield e(t))}}qe.iterateEntries=FN;function GN(s,e,t,i){let n=e;for(;n;){let o=n.skipNextEntry;n=n.nextEntry,!o&&n&&t.call(i,n.value,n.key,s)}}qe.forEachEntry=GN});var F0=Fe(Ng=>{"use strict";Object.defineProperty(Ng,"__esModule",{value:!0});Ng.HashMap=void 0;var va=El(),VN=Tl(),kN=oa(),Ei=B0(),D0=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):kN.isIterable(o)||o===void 0?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=VN.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=Ei.createHashData(n,t),i)for(let[o,a]of i)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return Ei.findEntryIndex(this._hashData,e)>=0}get(e){return Ei.findEntryValue(this._hashData,e)}set(e,t){return Ei.insertEntry(this._hashData,e,t),this}delete(e){return Ei.deleteEntry(this._hashData,e)}clear(){Ei.clearEntries(this._hashData)}ensureCapacity(e){return Ei.ensureCapacity(this._hashData,e)}trimExcess(e){Ei.trimExcessEntries(this._hashData,e)}keys(){return Ei.iterateEntries(this._hashData.head,Ei.selectEntryKey)}values(){return Ei.iterateEntries(this._hashData.head,Ei.selectEntryValue)}entries(){return Ei.iterateEntries(this._hashData.head,Ei.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){Ei.forEachEntry(this,this._hashData.head,e,t)}get[va.ReadonlyKeyedCollection.size](){return this.size}[va.ReadonlyKeyedCollection.has](e){return this.has(e)}[va.ReadonlyKeyedCollection.get](e){return this.get(e)}[va.ReadonlyKeyedCollection.keys](){return this.keys()}[va.ReadonlyKeyedCollection.values](){return this.values()}[va.KeyedCollection.set](e,t){this.set(e,t)}[va.KeyedCollection.delete](e){return this.delete(e)}[va.KeyedCollection.clear](){this.clear()}};Ng.HashMap=D0;Object.defineProperty(D0,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashMap"})});var V0=Fe(Bg=>{"use strict";Object.defineProperty(Bg,"__esModule",{value:!0});Bg.HashSet=void 0;var Yd=El(),zN=Tl(),UN=oa(),xi=B0(),G0=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):UN.isIterable(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=zN.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=xi.createHashData(n,t),i)for(let o of i)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return xi.findEntryIndex(this._hashData,e)>=0}add(e){return xi.insertEntry(this._hashData,e,e),this}tryAdd(e){let t=this.size;return xi.insertEntry(this._hashData,e,e),this.size>t}delete(e){return xi.deleteEntry(this._hashData,e)}clear(){xi.clearEntries(this._hashData)}ensureCapacity(e){return xi.ensureCapacity(this._hashData,e)}trimExcess(e){xi.trimExcessEntries(this._hashData,e)}keys(){return xi.iterateEntries(this._hashData.head,xi.selectEntryKey)}values(){return xi.iterateEntries(this._hashData.head,xi.selectEntryValue)}entries(){return xi.iterateEntries(this._hashData.head,xi.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){xi.forEachEntry(this,this._hashData.head,e,t)}get[Yd.Collection.size](){return this.size}[Yd.Collection.has](e){return this.has(e)}[Yd.Collection.add](e){this.add(e)}[Yd.Collection.delete](e){return this.delete(e)}[Yd.Collection.clear](){this.clear()}};Bg.HashSet=G0;Object.defineProperty(G0,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashSet"})});var BA=Fe(Dg=>{"use strict";Object.defineProperty(Dg,"__esModule",{value:!0});Dg.MultiMap=void 0;var Ql=oa(),NA=Tl(),zo=El(),WN=F0(),HN=V0(),k0=class{constructor(...e){this._size=0;let t,i,n;qN(e)?[t,n={}]=e:(t=0,jN(e)?[i,n={}]=e:n={});let{keyEqualer:o=NA.Equaler.defaultEqualer,valueEqualer:a=NA.Equaler.defaultEqualer}=n;if(this._map=new WN.HashMap(t,o),this._keyEqualer=o,this._valueEqualer=a,i)for(let[l,u]of i)this.add(l,u)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let i=this._map.get(e);return i?i.has(t):!1}get(e){return this._map.get(e)}add(e,t){let i=this._map.get(e);i||(i=new HN.HashSet(this._valueEqualer),this._map.set(e,i));let n=i.size;return i.add(t),this._size+=i.size-n,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let i=this._map.get(e);if(i){let n=i.size;if(i.delete(t))return this._size+=i.size-n,i.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let i of t)yield[e,i]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this._map)for(let o of n)e.call(t,o,i,this)}get[zo.ReadonlyKeyedMultiCollection.size](){return this.size}[zo.ReadonlyKeyedMultiCollection.has](e){return this.has(e)}[zo.ReadonlyKeyedMultiCollection.hasValue](e,t){return this.hasValue(e,t)}[zo.ReadonlyKeyedMultiCollection.get](e){return this.get(e)}[zo.ReadonlyKeyedMultiCollection.keys](){return this.keys()}[zo.ReadonlyKeyedMultiCollection.values](){return this.values()}[zo.KeyedMultiCollection.add](e,t){this.add(e,t)}[zo.KeyedMultiCollection.delete](e){return this.delete(e)}[zo.KeyedMultiCollection.deleteValue](e,t){return this.deleteValue(e,t)}[zo.KeyedMultiCollection.clear](){this.clear()}};Dg.MultiMap=k0;Object.defineProperty(k0,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"MultiMap"});function jN(s){return(s.length<1||!Ql.isDefined(s[0])||Ql.isIterable(s[0]))&&(s.length<2||!Ql.isDefined(s[1])||Ql.isObject(s[1]))}function qN(s){return(s.length<1||Ql.isNumber(s[0]))&&(s.length<2||!Ql.isDefined(s[1])||Ql.isObject(s[1]))}});var kA=Fe(Rc=>{"use strict";var FA,GA,VA;Object.defineProperty(Rc,"__esModule",{value:!0});Rc.LinkedList=Rc.LinkedListNode=void 0;var Ce=oa(),Kd=El(),DA=Tl(),Fg=Symbol("LinkedListNode.list"),ri=Symbol("LinkedListNode.previous"),Nr=Symbol("LinkedListNode.next"),vr=class{constructor(e){this[FA]=void 0,this[GA]=void 0,this[VA]=void 0,this.value=e}get list(){return this[Fg]}get previous(){if(this[ri]&&this.list&&this!==this.list.first)return this[ri]}get next(){if(this[Nr]&&this.list&&this[Nr]!==this.list.first)return this[Nr]}detachSelf(){return this.list?this.list.deleteNode(this):!1}};Rc.LinkedListNode=vr;FA=Fg,GA=ri,VA=Nr;Object.defineProperty(vr.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedListNode"});var Oc=class{constructor(...e){this._size=0,this._head=void 0;let t,i;if(e.length>0&&(Ce.isIterable(e[0])||Ce.isMissing(e[0])?(t=e[0],e.length>1&&(i=e[1])):i=e[0]),Ce.isMissing(i)&&(i=DA.Equaler.defaultEqualer),this._equaler=typeof i=="function"?DA.Equaler.create(i):i,t)for(let n of t)this.push(n)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return this._head[ri]}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(!Ce.isMissing(t)&&!Ce.isInstance(t,vr))throw new TypeError("LinkedListNode expected: fromNode");if(!Ce.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.first;i;i=i.next)if(this._equaler.equals(i.value,e))return i}lastNodeOf(e,t){if(!Ce.isMissing(t)&&!Ce.isInstance(t,vr))throw new TypeError("LinkedListNode expected: fromNode");if(!Ce.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.last;i;i=i.previous)if(this._equaler.equals(i.value,e))return i}find(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;){i=n,n=i.next;let o=i.value;if(e.call(t,o,i,this))return o}}findLast(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;){i=n,n=i.previous;let o=i.value;if(e.call(t,o,i,this))return o}}findNode(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,e.call(t,i.value,i,this))return i}findLastNode(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;)if(i=n,n=i.previous,e.call(t,i.value,i,this))return i}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(!Ce.isMissing(e)&&!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: node");if(!Ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new vr(t),0)}insertNodeBefore(e,t){if(!Ce.isMissing(e)&&!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: node");if(!Ce.isInstance(t,vr))throw new TypeError("LinkedListNode expected: newNode");if(!Ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!Ce.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(!Ce.isMissing(e)&&!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: node");if(!Ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new vr(t),1)}insertNodeAfter(e,t){if(!Ce.isMissing(e)&&!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: node");if(!Ce.isInstance(t,vr))throw new TypeError("LinkedListNode expected: newNode");if(!Ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!Ce.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new vr(e),1)}pushNode(e){if(!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: newNode");if(!Ce.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new vr(e),0)}unshiftNode(e){if(!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: newNode");if(!Ce.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(!Ce.isMissing(e)&&!Ce.isInstance(e,vr))throw new TypeError("LinkedListNode expected: node");if(!Ce.isMissing(e)&&!Ce.isMissing(e.list)&&e.list!==this)throw new TypeError("Wrong list.");return Ce.isMissing(e)||Ce.isMissing(e.list)?!1:this._deleteNode(e)}deleteAll(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: predicate");let i=0,n=this.first;for(;n;){let o=n.next;e.call(t,n.value,n,this)&&n.list===this&&(this._deleteNode(n),++i),n=o}return i}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)i=n,n=i.next,e.call(t,i.value,i,this)}map(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");[].map;let i=new Oc,n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=e.call(t,n.value,n,this);i.push(a)}return i}filter(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i=new Oc(this.equaler),n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=n.value;e.call(t,a,n,this)&&i.push(a)}return i}reduce(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0)}return n}reduceRight(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0),a=o.previous}return n}some(e,t){if(!Ce.isMissing(e)&&!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,!e||e.call(t,i.value,i,this))return!0;return!1}every(e,t){if(!Ce.isFunction(e))throw new TypeError("Function expected: callback");let i=!1,n,o=this.first;for(;o!==void 0;){if(n=o,o=n.next,!e.call(t,n.value,n,this))return!1;i=!0}return i}_deleteNode(e){return e[Nr]===e?this._head=void 0:(e[Nr][ri]=e[ri],e[ri][Nr]=e[Nr],this._head===e&&(this._head=e[Nr])),e[Fg]=void 0,e[Nr]=void 0,e[ri]=void 0,this._size--,!0}_insertNode(e,t,i){if(t[Fg]=this,this._head===void 0)t[Nr]=t,t[ri]=t,this._head=t;else switch(i){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),t[Nr]=e,t[ri]=e[ri],e[ri][Nr]=t,e[ri]=t;break;case 1:e===void 0&&(e=this._head[ri]),t[ri]=e,t[Nr]=e[Nr],e[Nr][ri]=t,e[Nr]=t;break}return this._size++,t}get[Kd.ReadonlyCollection.size](){return this.size}[Kd.ReadonlyCollection.has](e){return this.has(e)}[Kd.Collection.add](e){this.push(e)}[Kd.Collection.delete](e){return!!this.delete(e)}[Kd.Collection.clear](){this.clear()}};Rc.LinkedList=Oc;Object.defineProperty(Oc.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedList"})});var Zd=Fe(Aa=>{"use strict";Object.defineProperty(Aa,"__esModule",{value:!0});var _c=TA();_c.__exportStar(vd(),Aa);_c.__exportStar(wA(),Aa);_c.__exportStar(F0(),Aa);_c.__exportStar(V0(),Aa);_c.__exportStar(BA(),Aa);_c.__exportStar(kA(),Aa)});var yT=Fe((Age,PT)=>{PT.exports={rgb2hsl:sf,rgb2hsv:Xg,rgb2hwb:af,rgb2cmyk:lf,rgb2keyword:uf,rgb2xyz:pS,rgb2lab:gS,rgb2lch:vB,hsl2rgb:Yg,hsl2hsv:AB,hsl2hwb:TB,hsl2cmyk:IB,hsl2keyword:wB,hsv2rgb:Kg,hsv2hsl:LB,hsv2hwb:OB,hsv2cmyk:RB,hsv2keyword:_B,hwb2rgb:cf,hwb2hsl:MB,hwb2hsv:NB,hwb2cmyk:BB,hwb2keyword:DB,cmyk2rgb:hf,cmyk2hsl:FB,cmyk2hsv:GB,cmyk2hwb:VB,cmyk2keyword:kB,keyword2rgb:nu,keyword2hsl:HB,keyword2hsv:jB,keyword2hwb:qB,keyword2cmyk:XB,keyword2lab:YB,keyword2xyz:KB,xyz2rgb:pT,xyz2lab:gT,xyz2lch:zB,lab2xyz:mS,lab2rgb:mT,lab2lch:bS,lch2lab:PS,lch2xyz:UB,lch2rgb:WB};function sf(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(n+o)/2,o==n?u=0:c<=.5?u=a/(o+n):u=a/(2-o-n),[l,u*100,c*100]}function Xg(s){var e=s[0],t=s[1],i=s[2],n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function af(s){var e=s[0],t=s[1],o=s[2],i=sf(s)[0],n=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[i,n*100,o*100]}function lf(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n,o,a,l;return l=Math.min(1-e,1-t,1-i),n=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-i-l)/(1-l)||0,[n*100,o*100,a*100,l*100]}function uf(s){return bT[JSON.stringify(s)]}function pS(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;var n=e*.4124+t*.3576+i*.1805,o=e*.2126+t*.7152+i*.0722,a=e*.0193+t*.1192+i*.9505;return[n*100,o*100,a*100]}function gS(s){var e=pS(s),t=e[0],i=e[1],n=e[2],o,a,l;return t/=95.047,i/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=116*i-16,a=500*(t-i),l=200*(i-n),[o,a,l]}function vB(s){return bS(gS(s))}function Yg(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n,o,a,l,u;if(t==0)return u=i*255,[u,u,u];i<.5?o=i*(1+t):o=i+t-i*t,n=2*i-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=n+(o-n)*6*a:2*a<1?u=o:3*a<2?u=n+(o-n)*(2/3-a)*6:u=n,l[c]=u*255;return l}function AB(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return i===0?[0,0,0]:(i*=2,t*=i<=1?i:2-i,o=(i+t)/2,n=2*t/(i+t),[e,n*100,o*100])}function TB(s){return af(Yg(s))}function IB(s){return lf(Yg(s))}function wB(s){return uf(Yg(s))}function Kg(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,i=Math.floor(e)%6,n=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*n),l=255*u*(1-t*(1-n)),u=255*u;switch(i){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function LB(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return o=(2-t)*i,n=t*i,n/=o<=1?o:2-o,n=n||0,o/=2,[e,n*100,o*100]}function OB(s){return af(Kg(s))}function RB(s){return lf(Kg(s))}function _B(s){return uf(Kg(s))}function cf(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n=t+i,o,a,l,u;switch(n>1&&(t/=n,i/=n),o=Math.floor(6*e),a=1-i,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function MB(s){return sf(cf(s))}function NB(s){return Xg(cf(s))}function BB(s){return lf(cf(s))}function DB(s){return uf(cf(s))}function hf(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-n)+n),a=1-Math.min(1,t*(1-n)+n),l=1-Math.min(1,i*(1-n)+n),[o*255,a*255,l*255]}function FB(s){return sf(hf(s))}function GB(s){return Xg(hf(s))}function VB(s){return af(hf(s))}function kB(s){return uf(hf(s))}function pT(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n,o,a;return n=e*3.2406+t*-1.5372+i*-.4986,o=e*-.9689+t*1.8758+i*.0415,a=e*.0557+t*-.204+i*1.057,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n=n*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,n=Math.min(Math.max(0,n),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[n*255,o*255,a*255]}function gT(s){var e=s[0],t=s[1],i=s[2],n,o,a;return e/=95.047,t/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=116*t-16,o=500*(e-t),a=200*(t-i),[n,o,a]}function zB(s){return bS(gT(s))}function mS(s){var e=s[0],t=s[1],i=s[2],n,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),n=n/95.047<=.008856?n=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-i/200-16/116)/7.787:108.883*Math.pow(l-i/200,3),[n,o,a]}function bS(s){var e=s[0],t=s[1],i=s[2],n,o,a;return n=Math.atan2(i,t),o=n*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+i*i),[e,a,o]}function mT(s){return pT(mS(s))}function PS(s){var e=s[0],t=s[1],i=s[2],n,o,a;return a=i/360*2*Math.PI,n=t*Math.cos(a),o=t*Math.sin(a),[e,n,o]}function UB(s){return mS(PS(s))}function WB(s){return mT(PS(s))}function nu(s){return fS[s]}function HB(s){return sf(nu(s))}function jB(s){return Xg(nu(s))}function qB(s){return af(nu(s))}function XB(s){return lf(nu(s))}function YB(s){return gS(nu(s))}function KB(s){return pS(nu(s))}var fS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},bT={};for(dS in fS)bT[JSON.stringify(fS[dS])]=dS;var dS});var xT=Fe((Tge,ET)=>{var yS=yT(),ou=function(){return new df};for(Fc in yS)ou[Fc+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),yS[s](e)}}(Fc),SS=/(\w+)2(\w+)/.exec(Fc),Zg=SS[1],ST=SS[2],ou[Zg]=ou[Zg]||{},ou[Zg][ST]=ou[Fc]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=yS[s](e);if(typeof t=="string"||t===void 0)return t;for(var i=0;i<t.length;i++)t[i]=Math.round(t[i]);return t}}(Fc);var SS,Zg,ST,Fc,df=function(){this.convs={}};df.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};df.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};df.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,i=this.convs[t];e=ou[t][s](i),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){df.prototype[s]=function(e){return this.routeSpace(s,arguments)}});ET.exports=ou});var vT=Fe((Ige,CT)=>{var ES=xT();CT.exports=function(s){var e,t,i,n;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=ES[a],i=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&i.push(1),n=i[l]===void 0?1:i[l],i=i.slice(0,l),t[a]=function(){return i}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=ES.rgb,i=a.split(l===3?/(.)/:/(..)/),i=i.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),n=1,t.rgb=function(){return i},i[0]||(i[0]=0),i[1]||(i[1]=0),i[2]||(i[2]=0)}else t=ES.keyword,t.keyword=function(){return s},i=s,n=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(i)}catch{}try{u.hsl=t.hsl(i)}catch{}try{u.hsv=t.hsv(i)}catch{}try{u.cmyk=t.cmyk(i)}catch{}try{u.keyword=t.keyword(i)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(n)),u.hsl&&(u.hsla=u.hsl.concat(n)),u.hsv&&(u.hsva=u.hsv.concat(n)),u.cmyk&&(u.cmyka=u.cmyk.concat(n)),u}});var FL=Fe((nRe,wb)=>{(function(s,e,t,i){"use strict";var n=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",l=Math.round,u=Math.abs,c=Date.now;function h(C,I,_){return setTimeout(M(C,_),I)}function d(C,I,_){return Array.isArray(C)?(f(C,_[I],_),!0):!1}function f(C,I,_){var V;if(!!C)if(C.forEach)C.forEach(I,_);else if(C.length!==i)for(V=0;V<C.length;)I.call(_,C[V],V,C),V++;else for(V in C)C.hasOwnProperty(V)&&I.call(_,C[V],V,C)}function p(C,I,_){var V="DEPRECATED METHOD: "+I+`
`+_+` AT 
`;return function(){var Z=new Error("get-stack-trace"),ae=Z&&Z.stack?Z.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",De=s.console&&(s.console.warn||s.console.log);return De&&De.call(s.console,V,ae),C.apply(this,arguments)}}var S;typeof Object.assign!="function"?S=function(I){if(I===i||I===null)throw new TypeError("Cannot convert undefined or null to object");for(var _=Object(I),V=1;V<arguments.length;V++){var Z=arguments[V];if(Z!==i&&Z!==null)for(var ae in Z)Z.hasOwnProperty(ae)&&(_[ae]=Z[ae])}return _}:S=Object.assign;var x=p(function(I,_,V){for(var Z=Object.keys(_),ae=0;ae<Z.length;)(!V||V&&I[Z[ae]]===i)&&(I[Z[ae]]=_[Z[ae]]),ae++;return I},"extend","Use `assign`."),T=p(function(I,_){return x(I,_,!0)},"merge","Use `assign`.");function O(C,I,_){var V=I.prototype,Z;Z=C.prototype=Object.create(V),Z.constructor=C,Z._super=V,_&&S(Z,_)}function M(C,I){return function(){return C.apply(I,arguments)}}function R(C,I){return typeof C==a?C.apply(I&&I[0]||i,I):C}function N(C,I){return C===i?I:C}function H(C,I,_){f(se(I),function(V){C.addEventListener(V,_,!1)})}function Q(C,I,_){f(se(I),function(V){C.removeEventListener(V,_,!1)})}function ne(C,I){for(;C;){if(C==I)return!0;C=C.parentNode}return!1}function he(C,I){return C.indexOf(I)>-1}function se(C){return C.trim().split(/\s+/g)}function oe(C,I,_){if(C.indexOf&&!_)return C.indexOf(I);for(var V=0;V<C.length;){if(_&&C[V][_]==I||!_&&C[V]===I)return V;V++}return-1}function ge(C){return Array.prototype.slice.call(C,0)}function Pe(C,I,_){for(var V=[],Z=[],ae=0;ae<C.length;){var De=I?C[ae][I]:C[ae];oe(Z,De)<0&&V.push(C[ae]),Z[ae]=De,ae++}return _&&(I?V=V.sort(function(lr,br){return lr[I]>br[I]}):V=V.sort()),V}function pe(C,I){for(var _,V,Z=I[0].toUpperCase()+I.slice(1),ae=0;ae<n.length;){if(_=n[ae],V=_?_+Z:I,V in C)return V;ae++}return i}var Ue=1;function ui(){return Ue++}function js(C){var I=C.ownerDocument||C;return I.defaultView||I.parentWindow||s}var ci=/mobile|tablet|ip(ad|hone|od)|android/i,qs="ontouchstart"in s,os=pe(s,"PointerEvent")!==i,Xs=qs&&ci.test(navigator.userAgent),on="touch",ss="pen",Ys="mouse",il="kinect",ku=25,ar=1,On=2,It=4,mr=8,zr=1,Rn=2,as=4,ls=8,us=16,Oi=Rn|as,_n=ls|us,zu=Oi|_n,Uu=["x","y"],Ks=["clientX","clientY"];function Ur(C,I){var _=this;this.manager=C,this.callback=I,this.element=C.element,this.target=C.options.inputTarget,this.domHandler=function(V){R(C.options.enable,[C])&&_.handler(V)},this.init()}Ur.prototype={handler:function(){},init:function(){this.evEl&&H(this.element,this.evEl,this.domHandler),this.evTarget&&H(this.target,this.evTarget,this.domHandler),this.evWin&&H(js(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&Q(this.element,this.evEl,this.domHandler),this.evTarget&&Q(this.target,this.evTarget,this.domHandler),this.evWin&&Q(js(this.element),this.evWin,this.domHandler)}};function Wu(C){var I,_=C.options.inputClass;return _?I=_:os?I=Js:Xs?I=Dn:qs?I=So:I=cs,new I(C,nl)}function nl(C,I,_){var V=_.pointers.length,Z=_.changedPointers.length,ae=I&ar&&V-Z===0,De=I&(It|mr)&&V-Z===0;_.isFirst=!!ae,_.isFinal=!!De,ae&&(C.session={}),_.eventType=I,Hu(C,_),C.emit("hammer.input",_),C.recognize(_),C.session.prevInput=_}function Hu(C,I){var _=C.session,V=I.pointers,Z=V.length;_.firstInput||(_.firstInput=ju(I)),Z>1&&!_.firstMultiple?_.firstMultiple=ju(I):Z===1&&(_.firstMultiple=!1);var ae=_.firstInput,De=_.firstMultiple,er=De?De.center:ae.center,lr=I.center=qu(V);I.timeStamp=c(),I.deltaTime=I.timeStamp-ae.timeStamp,I.angle=al(er,lr),I.distance=Mn(er,lr),ol(_,I),I.offsetDirection=Qs(I.deltaX,I.deltaY);var br=Zs(I.deltaTime,I.deltaX,I.deltaY);I.overallVelocityX=br.x,I.overallVelocityY=br.y,I.overallVelocity=u(br.x)>u(br.y)?br.x:br.y,I.scale=De?Nn(De.pointers,V):1,I.rotation=De?$h(De.pointers,V):0,I.maxPointers=_.prevInput?I.pointers.length>_.prevInput.maxPointers?I.pointers.length:_.prevInput.maxPointers:I.pointers.length,sl(_,I);var Vi=C.element;ne(I.srcEvent.target,Vi)&&(Vi=I.srcEvent.target),I.target=Vi}function ol(C,I){var _=I.center,V=C.offsetDelta||{},Z=C.prevDelta||{},ae=C.prevInput||{};(I.eventType===ar||ae.eventType===It)&&(Z=C.prevDelta={x:ae.deltaX||0,y:ae.deltaY||0},V=C.offsetDelta={x:_.x,y:_.y}),I.deltaX=Z.x+(_.x-V.x),I.deltaY=Z.y+(_.y-V.y)}function sl(C,I){var _=C.lastInterval||I,V=I.timeStamp-_.timeStamp,Z,ae,De,er;if(I.eventType!=mr&&(V>ku||_.velocity===i)){var lr=I.deltaX-_.deltaX,br=I.deltaY-_.deltaY,Vi=Zs(V,lr,br);ae=Vi.x,De=Vi.y,Z=u(Vi.x)>u(Vi.y)?Vi.x:Vi.y,er=Qs(lr,br),C.lastInterval=I}else Z=_.velocity,ae=_.velocityX,De=_.velocityY,er=_.direction;I.velocity=Z,I.velocityX=ae,I.velocityY=De,I.direction=er}function ju(C){for(var I=[],_=0;_<C.pointers.length;)I[_]={clientX:l(C.pointers[_].clientX),clientY:l(C.pointers[_].clientY)},_++;return{timeStamp:c(),pointers:I,center:qu(I),deltaX:C.deltaX,deltaY:C.deltaY}}function qu(C){var I=C.length;if(I===1)return{x:l(C[0].clientX),y:l(C[0].clientY)};for(var _=0,V=0,Z=0;Z<I;)_+=C[Z].clientX,V+=C[Z].clientY,Z++;return{x:l(_/I),y:l(V/I)}}function Zs(C,I,_){return{x:I/C||0,y:_/C||0}}function Qs(C,I){return C===I?zr:u(C)>=u(I)?C<0?Rn:as:I<0?ls:us}function Mn(C,I,_){_||(_=Uu);var V=I[_[0]]-C[_[0]],Z=I[_[1]]-C[_[1]];return Math.sqrt(V*V+Z*Z)}function al(C,I,_){_||(_=Uu);var V=I[_[0]]-C[_[0]],Z=I[_[1]]-C[_[1]];return Math.atan2(Z,V)*180/Math.PI}function $h(C,I){return al(I[1],I[0],Ks)+al(C[1],C[0],Ks)}function Nn(C,I){return Mn(I[0],I[1],Ks)/Mn(C[0],C[1],Ks)}var ed={mousedown:ar,mousemove:On,mouseup:It},td="mousedown",Xu="mousemove mouseup";function cs(){this.evEl=td,this.evWin=Xu,this.pressed=!1,Ur.apply(this,arguments)}O(cs,Ur,{handler:function(I){var _=ed[I.type];_&ar&&I.button===0&&(this.pressed=!0),_&On&&I.which!==1&&(_=It),this.pressed&&(_&It&&(this.pressed=!1),this.callback(this.manager,_,{pointers:[I],changedPointers:[I],pointerType:Ys,srcEvent:I}))}});var rd={pointerdown:ar,pointermove:On,pointerup:It,pointercancel:mr,pointerout:mr},id={2:on,3:ss,4:Ys,5:il},ll="pointerdown",Yu="pointermove pointerup pointercancel";s.MSPointerEvent&&!s.PointerEvent&&(ll="MSPointerDown",Yu="MSPointerMove MSPointerUp MSPointerCancel");function Js(){this.evEl=ll,this.evWin=Yu,Ur.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}O(Js,Ur,{handler:function(I){var _=this.store,V=!1,Z=I.type.toLowerCase().replace("ms",""),ae=rd[Z],De=id[I.pointerType]||I.pointerType,er=De==on,lr=oe(_,I.pointerId,"pointerId");ae&ar&&(I.button===0||er)?lr<0&&(_.push(I),lr=_.length-1):ae&(It|mr)&&(V=!0),!(lr<0)&&(_[lr]=I,this.callback(this.manager,ae,{pointers:_,changedPointers:[I],pointerType:De,srcEvent:I}),V&&_.splice(lr,1))}});var nd={touchstart:ar,touchmove:On,touchend:It,touchcancel:mr},od="touchstart",Ku="touchstart touchmove touchend touchcancel";function $s(){this.evTarget=od,this.evWin=Ku,this.started=!1,Ur.apply(this,arguments)}O($s,Ur,{handler:function(I){var _=nd[I.type];if(_===ar&&(this.started=!0),!!this.started){var V=Bn.call(this,I,_);_&(It|mr)&&V[0].length-V[1].length===0&&(this.started=!1),this.callback(this.manager,_,{pointers:V[0],changedPointers:V[1],pointerType:on,srcEvent:I})}}});function Bn(C,I){var _=ge(C.touches),V=ge(C.changedTouches);return I&(It|mr)&&(_=Pe(_.concat(V),"identifier",!0)),[_,V]}var Ri={touchstart:ar,touchmove:On,touchend:It,touchcancel:mr},Zu="touchstart touchmove touchend touchcancel";function Dn(){this.evTarget=Zu,this.targetIds={},Ur.apply(this,arguments)}O(Dn,Ur,{handler:function(I){var _=Ri[I.type],V=ea.call(this,I,_);!V||this.callback(this.manager,_,{pointers:V[0],changedPointers:V[1],pointerType:on,srcEvent:I})}});function ea(C,I){var _=ge(C.touches),V=this.targetIds;if(I&(ar|On)&&_.length===1)return V[_[0].identifier]=!0,[_,_];var Z,ae,De=ge(C.changedTouches),er=[],lr=this.target;if(ae=_.filter(function(br){return ne(br.target,lr)}),I===ar)for(Z=0;Z<ae.length;)V[ae[Z].identifier]=!0,Z++;for(Z=0;Z<De.length;)V[De[Z].identifier]&&er.push(De[Z]),I&(It|mr)&&delete V[De[Z].identifier],Z++;if(!!er.length)return[Pe(ae.concat(er),"identifier",!0),er]}var ta=2500,hs=25;function So(){Ur.apply(this,arguments);var C=M(this.handler,this);this.touch=new Dn(this.manager,C),this.mouse=new cs(this.manager,C),this.primaryTouch=null,this.lastTouches=[]}O(So,Ur,{handler:function(I,_,V){var Z=V.pointerType==on,ae=V.pointerType==Ys;if(!(ae&&V.sourceCapabilities&&V.sourceCapabilities.firesTouchEvents)){if(Z)Qu.call(this,_,V);else if(ae&&Fn.call(this,V))return;this.callback(I,_,V)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function Qu(C,I){C&ar?(this.primaryTouch=I.changedPointers[0].identifier,Wr.call(this,I)):C&(It|mr)&&Wr.call(this,I)}function Wr(C){var I=C.changedPointers[0];if(I.identifier===this.primaryTouch){var _={x:I.clientX,y:I.clientY};this.lastTouches.push(_);var V=this.lastTouches,Z=function(){var ae=V.indexOf(_);ae>-1&&V.splice(ae,1)};setTimeout(Z,ta)}}function Fn(C){for(var I=C.srcEvent.clientX,_=C.srcEvent.clientY,V=0;V<this.lastTouches.length;V++){var Z=this.lastTouches[V],ae=Math.abs(I-Z.x),De=Math.abs(_-Z.y);if(ae<=hs&&De<=hs)return!0}return!1}var ul=pe(o.style,"touchAction"),Hr=ul!==i,Gn="compute",cl="auto",Vn="manipulation",Ir="none",hi="pan-x",Eo="pan-y",xo=Co();function ds(C,I){this.manager=C,this.set(I)}ds.prototype={set:function(C){C==Gn&&(C=this.compute()),Hr&&this.manager.element.style&&xo[C]&&(this.manager.element.style[ul]=C),this.actions=C.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var C=[];return f(this.manager.recognizers,function(I){R(I.options.enable,[I])&&(C=C.concat(I.getTouchAction()))}),sd(C.join(" "))},preventDefaults:function(C){var I=C.srcEvent,_=C.offsetDirection;if(this.manager.session.prevented){I.preventDefault();return}var V=this.actions,Z=he(V,Ir)&&!xo[Ir],ae=he(V,Eo)&&!xo[Eo],De=he(V,hi)&&!xo[hi];if(Z){var er=C.pointers.length===1,lr=C.distance<2,br=C.deltaTime<250;if(er&&lr&&br)return}if(!(De&&ae)&&(Z||ae&&_&Oi||De&&_&_n))return this.preventSrc(I)},preventSrc:function(C){this.manager.session.prevented=!0,C.preventDefault()}};function sd(C){if(he(C,Ir))return Ir;var I=he(C,hi),_=he(C,Eo);return I&&_?Ir:I||_?I?hi:Eo:he(C,Vn)?Vn:cl}function Co(){if(!Hr)return!1;var C={},I=s.CSS&&s.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(_){C[_]=I?s.CSS.supports("touch-action",_):!0}),C}var G=1,Y=2,$=4,te=8,Ae=te,We=16,Be=32;function st(C){this.options=S({},this.defaults,C||{}),this.id=ui(),this.manager=null,this.options.enable=N(this.options.enable,!0),this.state=G,this.simultaneous={},this.requireFail=[]}st.prototype={defaults:{},set:function(C){return S(this.options,C),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(C){if(d(C,"recognizeWith",this))return this;var I=this.simultaneous;return C=fs(C,this),I[C.id]||(I[C.id]=C,C.recognizeWith(this)),this},dropRecognizeWith:function(C){return d(C,"dropRecognizeWith",this)?this:(C=fs(C,this),delete this.simultaneous[C.id],this)},requireFailure:function(C){if(d(C,"requireFailure",this))return this;var I=this.requireFail;return C=fs(C,this),oe(I,C)===-1&&(I.push(C),C.requireFailure(this)),this},dropRequireFailure:function(C){if(d(C,"dropRequireFailure",this))return this;C=fs(C,this);var I=oe(this.requireFail,C);return I>-1&&this.requireFail.splice(I,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(C){return!!this.simultaneous[C.id]},emit:function(C){var I=this,_=this.state;function V(Z){I.manager.emit(Z,C)}_<te&&V(I.options.event+kn(_)),V(I.options.event),C.additionalEvent&&V(C.additionalEvent),_>=te&&V(I.options.event+kn(_))},tryEmit:function(C){if(this.canEmit())return this.emit(C);this.state=Be},canEmit:function(){for(var C=0;C<this.requireFail.length;){if(!(this.requireFail[C].state&(Be|G)))return!1;C++}return!0},recognize:function(C){var I=S({},C);if(!R(this.options.enable,[this,I])){this.reset(),this.state=Be;return}this.state&(Ae|We|Be)&&(this.state=G),this.state=this.process(I),this.state&(Y|$|te|We)&&this.tryEmit(I)},process:function(C){},getTouchAction:function(){},reset:function(){}};function kn(C){return C&We?"cancel":C&te?"end":C&$?"move":C&Y?"start":""}function sn(C){return C==us?"down":C==ls?"up":C==Rn?"left":C==as?"right":""}function fs(C,I){var _=I.manager;return _?_.get(C):C}function jr(){st.apply(this,arguments)}O(jr,st,{defaults:{pointers:1},attrTest:function(C){var I=this.options.pointers;return I===0||C.pointers.length===I},process:function(C){var I=this.state,_=C.eventType,V=I&(Y|$),Z=this.attrTest(C);return V&&(_&mr||!Z)?I|We:V||Z?_&It?I|te:I&Y?I|$:Y:Be}});function hl(){jr.apply(this,arguments),this.pX=null,this.pY=null}O(hl,jr,{defaults:{event:"pan",threshold:10,pointers:1,direction:zu},getTouchAction:function(){var C=this.options.direction,I=[];return C&Oi&&I.push(Eo),C&_n&&I.push(hi),I},directionTest:function(C){var I=this.options,_=!0,V=C.distance,Z=C.direction,ae=C.deltaX,De=C.deltaY;return Z&I.direction||(I.direction&Oi?(Z=ae===0?zr:ae<0?Rn:as,_=ae!=this.pX,V=Math.abs(C.deltaX)):(Z=De===0?zr:De<0?ls:us,_=De!=this.pY,V=Math.abs(C.deltaY))),C.direction=Z,_&&V>I.threshold&&Z&I.direction},attrTest:function(C){return jr.prototype.attrTest.call(this,C)&&(this.state&Y||!(this.state&Y)&&this.directionTest(C))},emit:function(C){this.pX=C.deltaX,this.pY=C.deltaY;var I=sn(C.direction);I&&(C.additionalEvent=this.options.event+I),this._super.emit.call(this,C)}});function ad(){jr.apply(this,arguments)}O(ad,jr,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Ir]},attrTest:function(C){return this._super.attrTest.call(this,C)&&(Math.abs(C.scale-1)>this.options.threshold||this.state&Y)},emit:function(C){if(C.scale!==1){var I=C.scale<1?"in":"out";C.additionalEvent=this.options.event+I}this._super.emit.call(this,C)}});function ld(){st.apply(this,arguments),this._timer=null,this._input=null}O(ld,st,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[cl]},process:function(C){var I=this.options,_=C.pointers.length===I.pointers,V=C.distance<I.threshold,Z=C.deltaTime>I.time;if(this._input=C,!V||!_||C.eventType&(It|mr)&&!Z)this.reset();else if(C.eventType&ar)this.reset(),this._timer=h(function(){this.state=Ae,this.tryEmit()},I.time,this);else if(C.eventType&It)return Ae;return Be},reset:function(){clearTimeout(this._timer)},emit:function(C){this.state===Ae&&(C&&C.eventType&It?this.manager.emit(this.options.event+"up",C):(this._input.timeStamp=c(),this.manager.emit(this.options.event,this._input)))}});function ud(){jr.apply(this,arguments)}O(ud,jr,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Ir]},attrTest:function(C){return this._super.attrTest.call(this,C)&&(Math.abs(C.rotation)>this.options.threshold||this.state&Y)}});function cd(){jr.apply(this,arguments)}O(cd,jr,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Oi|_n,pointers:1},getTouchAction:function(){return hl.prototype.getTouchAction.call(this)},attrTest:function(C){var I=this.options.direction,_;return I&(Oi|_n)?_=C.overallVelocity:I&Oi?_=C.overallVelocityX:I&_n&&(_=C.overallVelocityY),this._super.attrTest.call(this,C)&&I&C.offsetDirection&&C.distance>this.options.threshold&&C.maxPointers==this.options.pointers&&u(_)>this.options.velocity&&C.eventType&It},emit:function(C){var I=sn(C.offsetDirection);I&&this.manager.emit(this.options.event+I,C),this.manager.emit(this.options.event,C)}});function Ju(){st.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}O(Ju,st,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[Vn]},process:function(C){var I=this.options,_=C.pointers.length===I.pointers,V=C.distance<I.threshold,Z=C.deltaTime<I.time;if(this.reset(),C.eventType&ar&&this.count===0)return this.failTimeout();if(V&&Z&&_){if(C.eventType!=It)return this.failTimeout();var ae=this.pTime?C.timeStamp-this.pTime<I.interval:!0,De=!this.pCenter||Mn(this.pCenter,C.center)<I.posThreshold;this.pTime=C.timeStamp,this.pCenter=C.center,!De||!ae?this.count=1:this.count+=1,this._input=C;var er=this.count%I.taps;if(er===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=Ae,this.tryEmit()},I.interval,this),Y):Ae}return Be},failTimeout:function(){return this._timer=h(function(){this.state=Be},this.options.interval,this),Be},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==Ae&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function an(C,I){return I=I||{},I.recognizers=N(I.recognizers,an.defaults.preset),new dl(C,I)}an.VERSION="2.0.7",an.defaults={domEvents:!1,touchAction:Gn,enable:!0,inputTarget:null,inputClass:null,preset:[[ud,{enable:!1}],[ad,{enable:!1},["rotate"]],[cd,{direction:Oi}],[hl,{direction:Oi},["swipe"]],[Ju],[Ju,{event:"doubletap",taps:2},["tap"]],[ld]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var YP=1,ps=2;function dl(C,I){this.options=S({},an.defaults,I||{}),this.options.inputTarget=this.options.inputTarget||C,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=C,this.input=Wu(this),this.touchAction=new ds(this,this.options.touchAction),hd(this,!0),f(this.options.recognizers,function(_){var V=this.add(new _[0](_[1]));_[2]&&V.recognizeWith(_[2]),_[3]&&V.requireFailure(_[3])},this)}dl.prototype={set:function(C){return S(this.options,C),C.touchAction&&this.touchAction.update(),C.inputTarget&&(this.input.destroy(),this.input.target=C.inputTarget,this.input.init()),this},stop:function(C){this.session.stopped=C?ps:YP},recognize:function(C){var I=this.session;if(!I.stopped){this.touchAction.preventDefaults(C);var _,V=this.recognizers,Z=I.curRecognizer;(!Z||Z&&Z.state&Ae)&&(Z=I.curRecognizer=null);for(var ae=0;ae<V.length;)_=V[ae],I.stopped!==ps&&(!Z||_==Z||_.canRecognizeWith(Z))?_.recognize(C):_.reset(),!Z&&_.state&(Y|$|te)&&(Z=I.curRecognizer=_),ae++}},get:function(C){if(C instanceof st)return C;for(var I=this.recognizers,_=0;_<I.length;_++)if(I[_].options.event==C)return I[_];return null},add:function(C){if(d(C,"add",this))return this;var I=this.get(C.options.event);return I&&this.remove(I),this.recognizers.push(C),C.manager=this,this.touchAction.update(),C},remove:function(C){if(d(C,"remove",this))return this;if(C=this.get(C),C){var I=this.recognizers,_=oe(I,C);_!==-1&&(I.splice(_,1),this.touchAction.update())}return this},on:function(C,I){if(C!==i&&I!==i){var _=this.handlers;return f(se(C),function(V){_[V]=_[V]||[],_[V].push(I)}),this}},off:function(C,I){if(C!==i){var _=this.handlers;return f(se(C),function(V){I?_[V]&&_[V].splice(oe(_[V],I),1):delete _[V]}),this}},emit:function(C,I){this.options.domEvents&&KP(C,I);var _=this.handlers[C]&&this.handlers[C].slice();if(!(!_||!_.length)){I.type=C,I.preventDefault=function(){I.srcEvent.preventDefault()};for(var V=0;V<_.length;)_[V](I),V++}},destroy:function(){this.element&&hd(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function hd(C,I){var _=C.element;if(!!_.style){var V;f(C.options.cssProps,function(Z,ae){V=pe(_.style,ae),I?(C.oldCssProps[V]=_.style[V],_.style[V]=Z):_.style[V]=C.oldCssProps[V]||""}),I||(C.oldCssProps={})}}function KP(C,I){var _=e.createEvent("Event");_.initEvent(C,!0,!0),_.gesture=I,I.target.dispatchEvent(_)}S(an,{INPUT_START:ar,INPUT_MOVE:On,INPUT_END:It,INPUT_CANCEL:mr,STATE_POSSIBLE:G,STATE_BEGAN:Y,STATE_CHANGED:$,STATE_ENDED:te,STATE_RECOGNIZED:Ae,STATE_CANCELLED:We,STATE_FAILED:Be,DIRECTION_NONE:zr,DIRECTION_LEFT:Rn,DIRECTION_RIGHT:as,DIRECTION_UP:ls,DIRECTION_DOWN:us,DIRECTION_HORIZONTAL:Oi,DIRECTION_VERTICAL:_n,DIRECTION_ALL:zu,Manager:dl,Input:Ur,TouchAction:ds,TouchInput:Dn,MouseInput:cs,PointerEventInput:Js,TouchMouseInput:So,SingleTouchInput:$s,Recognizer:st,AttrRecognizer:jr,Tap:Ju,Pan:hl,Swipe:cd,Pinch:ad,Rotate:ud,Press:ld,on:H,off:Q,each:f,merge:T,extend:x,assign:S,inherit:O,bindFn:M,prefixed:pe});var ZP=typeof s<"u"?s:typeof self<"u"?self:{};ZP.Hammer=an,typeof define=="function"&&define.amd?define(function(){return an}):typeof wb<"u"&&wb.exports?wb.exports=an:s[t]=an})(window,document,"Hammer")});var $O=Fe((WNe,Wx)=>{"use strict";Wx.exports=hP;Wx.exports.default=hP;function hP(s,e,t){t=t||2;var i=e&&e.length,n=i?e[0]*t:s.length,o=ZO(s,0,n,t,!0),a=[];if(!o||o.next===o.prev)return a;var l,u,c,h,d,f,p;if(i&&(o=g8(s,e,o,t)),s.length>80*t){l=c=s[0],u=h=s[1];for(var S=t;S<n;S+=t)d=s[S],f=s[S+1],d<l&&(l=d),f<u&&(u=f),d>c&&(c=d),f>h&&(h=f);p=Math.max(c-l,h-u),p=p!==0?32767/p:0}return hp(o,a,t,l,u,p,0),a}function ZO(s,e,t,i,n){var o,a;if(n===Ux(s,e,t,i)>0)for(o=e;o<t;o+=i)a=KO(o,s[o],s[o+1],a);else for(o=t-i;o>=e;o-=i)a=KO(o,s[o],s[o+1],a);return a&&dP(a,a.next)&&(fp(a),a=a.next),a}function Ru(s,e){if(!s)return s;e||(e=s);var t=s,i;do if(i=!1,!t.steiner&&(dP(t,t.next)||Vt(t.prev,t,t.next)===0)){if(fp(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function hp(s,e,t,i,n,o,a){if(!!s){!a&&o&&S8(s,i,n,o);for(var l=s,u,c;s.prev!==s.next;){if(u=s.prev,c=s.next,o?d8(s,i,n,o):h8(s)){e.push(u.i/t|0),e.push(s.i/t|0),e.push(c.i/t|0),fp(s),s=c.next,l=c.next;continue}if(s=c,s===l){a?a===1?(s=f8(Ru(s),e,t),hp(s,e,t,i,n,o,2)):a===2&&p8(s,e,t,i,n,o):hp(Ru(s),e,t,i,n,o,1);break}}}}function h8(s){var e=s.prev,t=s,i=s.next;if(Vt(e,t,i)>=0)return!1;for(var n=e.x,o=t.x,a=i.x,l=e.y,u=t.y,c=i.y,h=n<o?n<a?n:a:o<a?o:a,d=l<u?l<c?l:c:u<c?u:c,f=n>o?n>a?n:a:o>a?o:a,p=l>u?l>c?l:c:u>c?u:c,S=i.next;S!==e;){if(S.x>=h&&S.x<=f&&S.y>=d&&S.y<=p&&Fh(n,l,o,u,a,c,S.x,S.y)&&Vt(S.prev,S,S.next)>=0)return!1;S=S.next}return!0}function d8(s,e,t,i){var n=s.prev,o=s,a=s.next;if(Vt(n,o,a)>=0)return!1;for(var l=n.x,u=o.x,c=a.x,h=n.y,d=o.y,f=a.y,p=l<u?l<c?l:c:u<c?u:c,S=h<d?h<f?h:f:d<f?d:f,x=l>u?l>c?l:c:u>c?u:c,T=h>d?h>f?h:f:d>f?d:f,O=kx(p,S,e,t,i),M=kx(x,T,e,t,i),R=s.prevZ,N=s.nextZ;R&&R.z>=O&&N&&N.z<=M;){if(R.x>=p&&R.x<=x&&R.y>=S&&R.y<=T&&R!==n&&R!==a&&Fh(l,h,u,d,c,f,R.x,R.y)&&Vt(R.prev,R,R.next)>=0||(R=R.prevZ,N.x>=p&&N.x<=x&&N.y>=S&&N.y<=T&&N!==n&&N!==a&&Fh(l,h,u,d,c,f,N.x,N.y)&&Vt(N.prev,N,N.next)>=0))return!1;N=N.nextZ}for(;R&&R.z>=O;){if(R.x>=p&&R.x<=x&&R.y>=S&&R.y<=T&&R!==n&&R!==a&&Fh(l,h,u,d,c,f,R.x,R.y)&&Vt(R.prev,R,R.next)>=0)return!1;R=R.prevZ}for(;N&&N.z<=M;){if(N.x>=p&&N.x<=x&&N.y>=S&&N.y<=T&&N!==n&&N!==a&&Fh(l,h,u,d,c,f,N.x,N.y)&&Vt(N.prev,N,N.next)>=0)return!1;N=N.nextZ}return!0}function f8(s,e,t){var i=s;do{var n=i.prev,o=i.next.next;!dP(n,o)&&QO(n,i,i.next,o)&&dp(n,o)&&dp(o,n)&&(e.push(n.i/t|0),e.push(i.i/t|0),e.push(o.i/t|0),fp(i),fp(i.next),i=s=o),i=i.next}while(i!==s);return Ru(i)}function p8(s,e,t,i,n,o){var a=s;do{for(var l=a.next.next;l!==a.prev;){if(a.i!==l.i&&C8(a,l)){var u=JO(a,l);a=Ru(a,a.next),u=Ru(u,u.next),hp(a,e,t,i,n,o,0),hp(u,e,t,i,n,o,0);return}l=l.next}a=a.next}while(a!==s)}function g8(s,e,t,i){var n=[],o,a,l,u,c;for(o=0,a=e.length;o<a;o++)l=e[o]*i,u=o<a-1?e[o+1]*i:s.length,c=ZO(s,l,u,i,!1),c===c.next&&(c.steiner=!0),n.push(x8(c));for(n.sort(m8),o=0;o<n.length;o++)t=b8(n[o],t);return t}function m8(s,e){return s.x-e.x}function b8(s,e){var t=P8(s,e);if(!t)return e;var i=JO(t,s);return Ru(i,i.next),Ru(t,t.next)}function P8(s,e){var t=e,i=s.x,n=s.y,o=-1/0,a;do{if(n<=t.y&&n>=t.next.y&&t.next.y!==t.y){var l=t.x+(n-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(l<=i&&l>o&&(o=l,a=t.x<t.next.x?t:t.next,l===i))return a}t=t.next}while(t!==e);if(!a)return null;var u=a,c=a.x,h=a.y,d=1/0,f;t=a;do i>=t.x&&t.x>=c&&i!==t.x&&Fh(n<h?i:o,n,c,h,n<h?o:i,n,t.x,t.y)&&(f=Math.abs(n-t.y)/(i-t.x),dp(t,s)&&(f<d||f===d&&(t.x>a.x||t.x===a.x&&y8(a,t)))&&(a=t,d=f)),t=t.next;while(t!==u);return a}function y8(s,e){return Vt(s.prev,s,e.prev)<0&&Vt(e.next,s,s.next)<0}function S8(s,e,t,i){var n=s;do n.z===0&&(n.z=kx(n.x,n.y,e,t,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==s);n.prevZ.nextZ=null,n.prevZ=null,E8(n)}function E8(s){var e,t,i,n,o,a,l,u,c=1;do{for(t=s,s=null,o=null,a=0;t;){for(a++,i=t,l=0,e=0;e<c&&(l++,i=i.nextZ,!!i);e++);for(u=c;l>0||u>0&&i;)l!==0&&(u===0||!i||t.z<=i.z)?(n=t,t=t.nextZ,l--):(n=i,i=i.nextZ,u--),o?o.nextZ=n:s=n,n.prevZ=o,o=n;t=i}o.nextZ=null,c*=2}while(a>1);return s}function kx(s,e,t,i,n){return s=(s-t)*n|0,e=(e-i)*n|0,s=(s|s<<8)&16711935,s=(s|s<<4)&252645135,s=(s|s<<2)&858993459,s=(s|s<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,s|e<<1}function x8(s){var e=s,t=s;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==s);return t}function Fh(s,e,t,i,n,o,a,l){return(n-a)*(e-l)>=(s-a)*(o-l)&&(s-a)*(i-l)>=(t-a)*(e-l)&&(t-a)*(o-l)>=(n-a)*(i-l)}function C8(s,e){return s.next.i!==e.i&&s.prev.i!==e.i&&!v8(s,e)&&(dp(s,e)&&dp(e,s)&&A8(s,e)&&(Vt(s.prev,s,e.prev)||Vt(s,e.prev,e))||dP(s,e)&&Vt(s.prev,s,s.next)>0&&Vt(e.prev,e,e.next)>0)}function Vt(s,e,t){return(e.y-s.y)*(t.x-e.x)-(e.x-s.x)*(t.y-e.y)}function dP(s,e){return s.x===e.x&&s.y===e.y}function QO(s,e,t,i){var n=cP(Vt(s,e,t)),o=cP(Vt(s,e,i)),a=cP(Vt(t,i,s)),l=cP(Vt(t,i,e));return!!(n!==o&&a!==l||n===0&&uP(s,t,e)||o===0&&uP(s,i,e)||a===0&&uP(t,s,i)||l===0&&uP(t,e,i))}function uP(s,e,t){return e.x<=Math.max(s.x,t.x)&&e.x>=Math.min(s.x,t.x)&&e.y<=Math.max(s.y,t.y)&&e.y>=Math.min(s.y,t.y)}function cP(s){return s>0?1:s<0?-1:0}function v8(s,e){var t=s;do{if(t.i!==s.i&&t.next.i!==s.i&&t.i!==e.i&&t.next.i!==e.i&&QO(t,t.next,s,e))return!0;t=t.next}while(t!==s);return!1}function dp(s,e){return Vt(s.prev,s,s.next)<0?Vt(s,e,s.next)>=0&&Vt(s,s.prev,e)>=0:Vt(s,e,s.prev)<0||Vt(s,s.next,e)<0}function A8(s,e){var t=s,i=!1,n=(s.x+e.x)/2,o=(s.y+e.y)/2;do t.y>o!=t.next.y>o&&t.next.y!==t.y&&n<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==s);return i}function JO(s,e){var t=new zx(s.i,s.x,s.y),i=new zx(e.i,e.x,e.y),n=s.next,o=e.prev;return s.next=e,e.prev=s,t.next=n,n.prev=t,i.next=t,t.prev=i,o.next=i,i.prev=o,i}function KO(s,e,t,i){var n=new zx(s,e,t);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function fp(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function zx(s,e,t){this.i=s,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}hP.deviation=function(s,e,t,i){var n=e&&e.length,o=n?e[0]*t:s.length,a=Math.abs(Ux(s,0,o,t));if(n)for(var l=0,u=e.length;l<u;l++){var c=e[l]*t,h=l<u-1?e[l+1]*t:s.length;a-=Math.abs(Ux(s,c,h,t))}var d=0;for(l=0;l<i.length;l+=3){var f=i[l]*t,p=i[l+1]*t,S=i[l+2]*t;d+=Math.abs((s[f]-s[S])*(s[p+1]-s[f+1])-(s[f]-s[p])*(s[S+1]-s[f+1]))}return a===0&&d===0?0:Math.abs((d-a)/a)};function Ux(s,e,t,i){for(var n=0,o=e,a=t-i;o<t;o+=i)n+=(s[a]-s[o])*(s[o+1]+s[a+1]),a=o;return n}hP.flatten=function(s){for(var e=s[0][0].length,t={vertices:[],holes:[],dimensions:e},i=0,n=0;n<s.length;n++){for(var o=0;o<s[n].length;o++)for(var a=0;a<e;a++)t.vertices.push(s[n][o][a]);n>0&&(i+=s[n-1].length,t.holes.push(i))}return t}});var PR=Fe((mBe,Hx)=>{"use strict";Hx.exports=gp;Hx.exports.default=gp;var zh=1e20;function gp(s,e,t,i,n,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=i||.25,this.fontFamily=n||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function B8(s,e,t,i,n,o,a){o.fill(zh,0,e*t),a.fill(0,0,e*t);for(var l=(e-i)/2,u=0;u<n;u++)for(var c=0;c<i;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*i+c)+3]/255;if(d===1)o[h]=0,a[h]=zh;else if(d===0)o[h]=zh,a[h]=0;else{var f=Math.max(0,.5-d),p=Math.max(0,d-.5);o[h]=f*f,a[h]=p*p}}}function D8(s,e,t,i,n,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(i[l])-Math.sqrt(n[l]);s[l]=Math.round(255-255*(u/o+a))}}gp.prototype._draw=function(s,e){var t=this.ctx.measureText(s),i=t.width,n=2*this.buffer,o,a,l,u,c,h,d,f;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),f=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+n,l=u+n,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,f=this.middle,this.ctx.textBaseline="middle");var p;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,f),p=this.ctx.getImageData(d,h,a,u));var S=new Uint8ClampedArray(o*l);return B8(p,o,l,a,u,this.gridOuter,this.gridInner),mR(this.gridOuter,o,l,this.f,this.v,this.z),mR(this.gridInner,o,l,this.f,this.v,this.z),D8(S,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:S,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:i}}};gp.prototype.draw=function(s){return this._draw(s,!1).data};gp.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function mR(s,e,t,i,n,o){for(var a=0;a<e;a++)bR(s,a,e,t,i,n,o);for(var l=0;l<t;l++)bR(s,l*e,1,e,i,n,o)}function bR(s,e,t,i,n,o,a){var l,u,c,h;for(o[0]=0,a[0]=-zh,a[1]=zh,l=0;l<i;l++)n[l]=s[e+l*t];for(l=1,u=0,c=0;l<i;l++){do h=o[u],c=(n[l]-n[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=zh}for(l=0,u=0;l<i;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=n[h]+(l-h)*(l-h)}}});var m_=Fe((ike,VP)=>{VP.exports=g_;VP.exports.addWheelListener=g_;VP.exports.removeWheelListener=r6;function g_(s,e,t){s.addEventListener("wheel",e,t)}function r6(s,e,t){s.removeEventListener("wheel",e,t)}});var x_=Fe((nke,E_)=>{var i6=4,n6=.001,o6=1e-7,s6=10,Cp=11,kP=1/(Cp-1),a6=typeof Float32Array=="function";function b_(s,e){return 1-3*e+3*s}function P_(s,e){return 3*e-6*s}function y_(s){return 3*s}function zP(s,e,t){return((b_(e,t)*s+P_(e,t))*s+y_(e))*s}function S_(s,e,t){return 3*b_(e,t)*s*s+2*P_(e,t)*s+y_(e)}function l6(s,e,t,i,n){var o,a,l=0;do a=e+(t-e)/2,o=zP(a,i,n)-s,o>0?t=a:e=a;while(Math.abs(o)>o6&&++l<s6);return a}function u6(s,e,t,i){for(var n=0;n<i6;++n){var o=S_(e,t,i);if(o===0)return e;var a=zP(e,t,i)-s;e-=a/o}return e}function c6(s){return s}E_.exports=function(e,t,i,n){if(!(0<=e&&e<=1&&0<=i&&i<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===t&&i===n)return c6;for(var o=a6?new Float32Array(Cp):new Array(Cp),a=0;a<Cp;++a)o[a]=zP(a*kP,e,i);function l(u){for(var c=0,h=1,d=Cp-1;h!==d&&o[h]<=u;++h)c+=kP;--h;var f=(u-o[h])/(o[h+1]-o[h]),p=c+f*kP,S=S_(p,e,i);return S>=n6?u6(u,p,e,i):S===0?p:l6(u,c,c+kP,e,i)}return function(c){return c===0?0:c===1?1:zP(l(c),t,n)}}});var T_=Fe((oke,UP)=>{var vp=x_(),C_={ease:vp(.25,.1,.25,1),easeIn:vp(.42,0,1,1),easeOut:vp(0,0,.58,1),easeInOut:vp(.42,0,.58,1),linear:vp(0,0,1,1)};UP.exports=h6;UP.exports.makeAggregateRaf=A_;UP.exports.sharedScheduler=A_();function h6(s,e,t){var i=Object.create(null),n=Object.create(null);t=t||{};var o=typeof t.easing=="function"?t.easing:C_[t.easing];o||(t.easing&&console.warn("Unknown easing function in amator: "+t.easing),o=C_.ease);var a=typeof t.step=="function"?t.step:v_,l=typeof t.done=="function"?t.done:v_,u=d6(t.scheduler),c=Object.keys(e);c.forEach(function(O){i[O]=s[O],n[O]=e[O]-s[O]});var h=typeof t.duration=="number"?t.duration:400,d=Math.max(1,h*.06),f,p=0;return f=u.next(x),{cancel:S};function S(){u.cancel(f),f=0}function x(){var O=o(p/d);p+=1,T(O),p<=d?(f=u.next(x),a(s)):(f=0,setTimeout(function(){l(s)},0))}function T(O){c.forEach(function(M){s[M]=n[M]*O+i[M]})}}function v_(){}function d6(s){if(!s){var e=typeof window<"u"&&window.requestAnimationFrame;return e?f6():p6()}if(typeof s.next!="function")throw new Error("Scheduler is supposed to have next(cb) function");if(typeof s.cancel!="function")throw new Error("Scheduler is supposed to have cancel(handle) function");return s}function f6(){return{next:window.requestAnimationFrame.bind(window),cancel:window.cancelAnimationFrame.bind(window)}}function p6(){return{next:function(s){return setTimeout(s,1e3/60)},cancel:function(s){return clearTimeout(s)}}}function A_(){var s=new Set,e=new Set,t=0;return{next:n,cancel:n,clearAll:i};function i(){s.clear(),e.clear(),cancelAnimationFrame(t),t=0}function n(u){e.add(u),o()}function o(){t||(t=requestAnimationFrame(a))}function a(){t=0;var u=e;e=s,s=u,s.forEach(function(c){c()}),s.clear()}function l(u){e.delete(u)}}});var w_=Fe((ske,I_)=>{I_.exports=function(e){m6(e);var t=g6(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e};function g6(s){var e=Object.create(null);return{on:function(t,i,n){if(typeof i!="function")throw new Error("callback is expected to be a function");var o=e[t];return o||(o=e[t]=[]),o.push({callback:i,ctx:n}),s},off:function(t,i){var n=typeof t>"u";if(n)return e=Object.create(null),s;if(e[t]){var o=typeof i!="function";if(o)delete e[t];else for(var a=e[t],l=0;l<a.length;++l)a[l].callback===i&&a.splice(l,1)}return s},fire:function(t){var i=e[t];if(!i)return s;var n;arguments.length>1&&(n=Array.prototype.splice.call(arguments,1));for(var o=0;o<i.length;++o){var a=i[o];a.callback.apply(a.ctx,n)}return s}}}function m6(s){if(!s)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],t=0;t<e.length;++t)if(s.hasOwnProperty(e[t]))throw new Error("Subject cannot be eventified, since it already has property '"+e[t]+"'")}});var O_=Fe((ake,L_)=>{L_.exports=b6;function b6(s,e,t){typeof t!="object"&&(t={});var i=typeof t.minVelocity=="number"?t.minVelocity:5,n=typeof t.amplitude=="number"?t.amplitude:.25,o=typeof t.cancelAnimationFrame=="function"?t.cancelAnimationFrame:P6(),a=typeof t.requestAnimationFrame=="function"?t.requestAnimationFrame:y6(),l,u,c=342,h,d,f,p,S,x,T,O;return{start:R,stop:H,cancel:M};function M(){o(h),o(O)}function R(){l=s(),p=T=d=S=0,u=new Date,o(h),o(O),h=a(N)}function N(){var ne=Date.now(),he=ne-u;u=ne;var se=s(),oe=se.x-l.x,ge=se.y-l.y;l=se;var Pe=1e3/(1+he);d=.8*oe*Pe+.2*d,S=.8*ge*Pe+.2*S,h=a(N)}function H(){o(h),o(O);var ne=s();f=ne.x,x=ne.y,u=Date.now(),(d<-i||d>i)&&(p=n*d,f+=p),(S<-i||S>i)&&(T=n*S,x+=T),O=a(Q)}function Q(){var ne=Date.now()-u,he=!1,se=0,oe=0;p&&(se=-p*Math.exp(-ne/c),se>.5||se<-.5?he=!0:se=p=0),T&&(oe=-T*Math.exp(-ne/c),oe>.5||oe<-.5?he=!0:oe=T=0),he&&(e(f+se,x+oe),O=a(Q))}}function P6(){return typeof cancelAnimationFrame=="function"?cancelAnimationFrame:clearTimeout}function y6(){return typeof requestAnimationFrame=="function"?requestAnimationFrame:function(s){return setTimeout(s,16)}}});var N_=Fe((lke,M_)=>{M_.exports=S6;function S6(s){if(s)return{capture:__,release:__};var e,t,i,n=!1;return{capture:o,release:a};function o(l){n=!0,t=window.document.onselectstart,i=window.document.ondragstart,window.document.onselectstart=R_,e=l,e.ondragstart=R_}function a(){!n||(n=!1,window.document.onselectstart=t,e&&(e.ondragstart=i))}}function R_(s){return s.stopPropagation(),!1}function __(){}});var D_=Fe((uke,B_)=>{B_.exports=E6;function E6(){this.x=0,this.y=0,this.scale=1}});var G_=Fe((cke,iC)=>{iC.exports=x6;iC.exports.canAttach=F_;function x6(s,e){if(!F_(s))throw new Error("svg element is required for svg.panzoom to work");var t=s.ownerSVGElement;if(!t)throw new Error("Do not apply panzoom to the root <svg> element. Use its child instead (e.g. <g></g>). As of March 2016 only FireFox supported transform on the root element");e.disableKeyboardInteraction||t.setAttribute("tabindex",0);var i={getBBox:o,getScreenCTM:a,getOwner:n,applyTransform:u,initTransform:l};return i;function n(){return t}function o(){var c=s.getBBox();return{left:c.x,top:c.y,width:c.width,height:c.height}}function a(){var c=t.getCTM();return c||t.getScreenCTM()}function l(c){var h=s.getCTM();h===null&&(h=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix()),c.x=h.e,c.y=h.f,c.scale=h.a,t.removeAttributeNS(null,"viewBox")}function u(c){s.setAttribute("transform","matrix("+c.scale+" 0 0 "+c.scale+" "+c.x+" "+c.y+")")}}function F_(s){return s&&s.ownerSVGElement&&s.getCTM}});var k_=Fe((hke,nC)=>{nC.exports=C6;nC.exports.canAttach=V_;function C6(s,e){var t=V_(s);if(!t)throw new Error("panzoom requires DOM element to be attached to the DOM tree");var i=s.parentElement;s.scrollTop=0,e.disableKeyboardInteraction||i.setAttribute("tabindex",0);var n={getBBox:a,getOwner:o,applyTransform:l};return n;function o(){return i}function a(){return{left:0,top:0,width:s.clientWidth,height:s.clientHeight}}function l(u){s.style.transformOrigin="0 0 0",s.style.transform="matrix("+u.scale+", 0, 0, "+u.scale+", "+u.x+", "+u.y+")"}}function V_(s){return s&&s.parentElement&&s.style}});var Q_=Fe((dke,Z_)=>{"use strict";var z_=m_(),oC=T_(),v6=w_(),A6=O_(),Y_=N_(),T6=Y_(),I6=Y_(!0),w6=D_(),U_=G_(),W_=k_(),L6=1,O6=1.75,H_=300,j_=200;Z_.exports=K_;function K_(s,e){e=e||{};var t=e.controller;if(t||(U_.canAttach(s)?t=U_(s,e):W_.canAttach(s)&&(t=W_(s,e))),!t)throw new Error("Cannot create panzoom for the current type of dom element");var i=t.getOwner(),n={x:0,y:0},o=!1,a=new w6;t.initTransform&&t.initTransform(a);var l=typeof e.filterKey=="function"?e.filterKey:Qh,u=typeof e.pinchSpeed=="number"?e.pinchSpeed:1,c=e.bounds,h=typeof e.maxZoom=="number"?e.maxZoom:Number.POSITIVE_INFINITY,d=typeof e.minZoom=="number"?e.minZoom:0,f=typeof e.boundsPadding=="number"?e.boundsPadding:.05,p=typeof e.zoomDoubleClickSpeed=="number"?e.zoomDoubleClickSpeed:O6,S=e.beforeWheel||Qh,x=e.beforeMouseDown||Qh,T=typeof e.zoomSpeed=="number"?e.zoomSpeed:L6,O=q_(e.transformOrigin),M=e.enableTextSelection?I6:T6;R6(c),e.autocenter&&Rn();var R,N=0,H=0,Q=0,ne=null,he=new Date,se,oe=!1,ge=!1,Pe,pe,Ue,ui,js,ci;"smoothScroll"in e&&!e.smoothScroll?ci=_6():ci=A6(Wu,ed,e.smoothScroll);var qs,os,Xs,on=!1;Xu();var ss={dispose:td,moveBy:Nn,moveTo:nl,smoothMoveTo:$h,centerOn:al,zoomTo:Ir,zoomAbs:Mn,smoothZoom:Gn,smoothZoomAbs:cl,showRectangle:mr,pause:ar,resume:On,isPaused:It,getTransform:as,getMinZoom:ls,setMinZoom:us,getMaxZoom:Oi,setMaxZoom:_n,getTransformOrigin:zu,setTransformOrigin:Uu,getZoomSpeed:Ks,setZoomSpeed:Ur};v6(ss);var Ys=typeof e.initialX=="number"?e.initialX:a.x,il=typeof e.initialY=="number"?e.initialY:a.y,ku=typeof e.initialZoom=="number"?e.initialZoom:a.scale;return(Ys!=a.x||il!=a.y||ku!=a.scale)&&Mn(Ys,il,ku),ss;function ar(){cs(),on=!0}function On(){on&&(Xu(),on=!1)}function It(){return on}function mr(G){var Y=i.getBoundingClientRect(),$=zr(Y.width,Y.height),te=G.right-G.left,Ae=G.bottom-G.top;if(!Number.isFinite(te)||!Number.isFinite(Ae))throw new Error("Invalid rectangle");var We=$.x/te,Be=$.y/Ae,st=Math.min(We,Be);a.x=-(G.left+te/2)*st+$.x/2,a.y=-(G.top+Ae/2)*st+$.y/2,a.scale=st}function zr(G,Y){if(t.getScreenCTM){var $=t.getScreenCTM(),te=$.a,Ae=$.d,We=$.e,Be=$.f;n.x=G*te-We,n.y=Y*Ae-Be}else n.x=G,n.y=Y;return n}function Rn(){var G,Y,$=0,te=0,Ae=sl();if(Ae)$=Ae.left,te=Ae.top,G=Ae.right-Ae.left,Y=Ae.bottom-Ae.top;else{var We=i.getBoundingClientRect();G=We.width,Y=We.height}var Be=t.getBBox();if(!(Be.width===0||Be.height===0)){var st=Y/Be.height,kn=G/Be.width,sn=Math.min(kn,st);a.x=-(Be.left+Be.width/2)*sn+G/2+$,a.y=-(Be.top+Be.height/2)*sn+Y/2+te,a.scale=sn}}function as(){return a}function ls(){return d}function us(G){d=G}function Oi(){return h}function _n(G){h=G}function zu(){return O}function Uu(G){O=q_(G)}function Ks(){return T}function Ur(G){if(!Number.isFinite(G))throw new Error("Zoom speed should be a number");T=G}function Wu(){return{x:a.x,y:a.y}}function nl(G,Y){a.x=G,a.y=Y,ol(),Co("pan"),Zs()}function Hu(G,Y){nl(a.x+G,a.y+Y)}function ol(){var G=sl();if(!!G){var Y=!1,$=ju(),te=G.left-$.right;return te>0&&(a.x+=te,Y=!0),te=G.right-$.left,te<0&&(a.x+=te,Y=!0),te=G.top-$.bottom,te>0&&(a.y+=te,Y=!0),te=G.bottom-$.top,te<0&&(a.y+=te,Y=!0),Y}}function sl(){if(!!c){if(typeof c=="boolean"){var G=i.getBoundingClientRect(),Y=G.width,$=G.height;return{left:Y*f,top:$*f,right:Y*(1-f),bottom:$*(1-f)}}return c}}function ju(){var G=t.getBBox(),Y=qu(G.left,G.top);return{left:Y.x,top:Y.y,right:G.width*a.scale+Y.x,bottom:G.height*a.scale+Y.y}}function qu(G,Y){return{x:G*a.scale+a.x,y:Y*a.scale+a.y}}function Zs(){o=!0,R=window.requestAnimationFrame(rd)}function Qs(G,Y,$){if(sC(G)||sC(Y)||sC($))throw new Error("zoom requires valid numbers");var te=a.scale*$;if(te<d){if(a.scale===d)return;$=d/a.scale}if(te>h){if(a.scale===h)return;$=h/a.scale}var Ae=zr(G,Y);if(a.x=Ae.x-$*(Ae.x-a.x),a.y=Ae.y-$*(Ae.y-a.y),c&&f===1&&d===1)a.scale*=$,ol();else{var We=ol();We||(a.scale*=$)}Co("zoom"),Zs()}function Mn(G,Y,$){var te=$/a.scale;Qs(G,Y,te)}function al(G){var Y=G.ownerSVGElement;if(!Y)throw new Error("ui element is required to be within the scene");var $=G.getBoundingClientRect(),te=$.left+$.width/2,Ae=$.top+$.height/2,We=Y.getBoundingClientRect(),Be=We.width/2-te,st=We.height/2-Ae;Nn(Be,st,!0)}function $h(G,Y){Nn(G-a.x,Y-a.y,!0)}function Nn(G,Y,$){if(!$)return Hu(G,Y);qs&&qs.cancel();var te={x:0,y:0},Ae={x:G,y:Y},We=0,Be=0;qs=oC(te,Ae,{step:function(st){Hu(st.x-We,st.y-Be),We=st.x,Be=st.y}})}function ed(G,Y){hi(),nl(G,Y)}function td(){cs()}function Xu(){i.addEventListener("mousedown",hs,{passive:!1}),i.addEventListener("dblclick",ta,{passive:!1}),i.addEventListener("touchstart",Js,{passive:!1}),i.addEventListener("keydown",ll,{passive:!1}),z_.addWheelListener(i,ul,{passive:!1}),Zs()}function cs(){z_.removeWheelListener(i,ul),i.removeEventListener("mousedown",hs),i.removeEventListener("keydown",ll),i.removeEventListener("dblclick",ta),i.removeEventListener("touchstart",Js),R&&(window.cancelAnimationFrame(R),R=0),ci.cancel(),Wr(),Fn(),M.release(),ds()}function rd(){o&&id()}function id(){o=!1,t.applyTransform(a),Co("transform"),R=0}function ll(G){var Y=0,$=0,te=0;if(G.keyCode===38?$=1:G.keyCode===40?$=-1:G.keyCode===37?Y=1:G.keyCode===39?Y=-1:G.keyCode===189||G.keyCode===109?te=1:(G.keyCode===187||G.keyCode===107)&&(te=-1),!l(G,Y,$,te)){if(Y||$){G.preventDefault(),G.stopPropagation();var Ae=i.getBoundingClientRect(),We=Math.min(Ae.width,Ae.height),Be=.05,st=We*Be*Y,kn=We*Be*$;Nn(st,kn)}if(te){var sn=Eo(te*100),We=O?Vn():Yu();Ir(We.x,We.y,sn)}}}function Yu(){var G=i.getBoundingClientRect();return{x:G.width/2,y:G.height/2}}function Js(G){if(nd(G),Ri(),G.touches.length===1)return Ku(G,G.touches[0]);G.touches.length===2&&(js=ea(G.touches[0],G.touches[1]),Xs=!0,$s())}function nd(G){e.onTouch&&!e.onTouch(G)||(G.stopPropagation(),G.preventDefault())}function od(G){Ri(),!(e.onDoubleClick&&!e.onDoubleClick(G))&&(G.preventDefault(),G.stopPropagation())}function Ku(G){H=new Date;var Y=G.touches[0],$=Hr(Y);se=$;var te=zr($.x,$.y);Pe=te.x,pe=te.y,Ue=Pe,ui=pe,ci.cancel(),$s()}function $s(){oe||(oe=!0,document.addEventListener("touchmove",Bn),document.addEventListener("touchend",Dn),document.addEventListener("touchcancel",Dn))}function Bn(G){if(G.touches.length===1){G.stopPropagation();var Y=G.touches[0],$=Hr(Y),te=zr($.x,$.y),Ae=te.x-Pe,We=te.y-pe;Ae!==0&&We!==0&&xo(),Pe=te.x,pe=te.y,Nn(Ae,We)}else if(G.touches.length===2){Xs=!0;var Be=G.touches[0],st=G.touches[1],kn=ea(Be,st),sn=1+(kn/js-1)*u,fs=Hr(Be),jr=Hr(st);if(Pe=(fs.x+jr.x)/2,pe=(fs.y+jr.y)/2,O){var $=Vn();Pe=$.x,pe=$.y}Ir(Pe,pe,sn),js=kn,G.stopPropagation(),G.preventDefault()}}function Ri(){Q&&(clearTimeout(Q),Q=0)}function Zu(G){if(!!e.onClick){Ri();var Y=Pe-Ue,$=pe-ui,te=Math.sqrt(Y*Y+$*$);te>5||(Q=setTimeout(function(){Q=0,e.onClick(G)},H_))}}function Dn(G){if(Ri(),G.touches.length>0){var Y=Hr(G.touches[0]),$=zr(Y.x,Y.y);Pe=$.x,pe=$.y}else{var te=new Date;if(te-N<H_)if(O){var Y=Vn();Gn(Y.x,Y.y,p)}else Gn(se.x,se.y,p);else te-H<j_&&Zu(G);N=te,ds(),Fn()}}function ea(G,Y){var $=G.clientX-Y.clientX,te=G.clientY-Y.clientY;return Math.sqrt($*$+te*te)}function ta(G){od(G);var Y=Hr(G);O&&(Y=Vn()),Gn(Y.x,Y.y,p)}function hs(G){if(Ri(),!x(G)){if(ne=G,he=new Date,oe)return G.stopPropagation(),!1;var Y=G.button===1&&window.event!==null||G.button===0;if(!!Y){ci.cancel();var $=Hr(G),te=zr($.x,$.y);return Ue=Pe=te.x,ui=pe=te.y,document.addEventListener("mousemove",So),document.addEventListener("mouseup",Qu),M.capture(G.target||G.srcElement),!1}}}function So(G){if(!oe){xo();var Y=Hr(G),$=zr(Y.x,Y.y),te=$.x-Pe,Ae=$.y-pe;Pe=$.x,pe=$.y,Nn(te,Ae)}}function Qu(){var G=new Date;G-he<j_&&Zu(ne),M.release(),ds(),Wr()}function Wr(){document.removeEventListener("mousemove",So),document.removeEventListener("mouseup",Qu),ge=!1}function Fn(){document.removeEventListener("touchmove",Bn),document.removeEventListener("touchend",Dn),document.removeEventListener("touchcancel",Dn),ge=!1,Xs=!1,oe=!1}function ul(G){if(!S(G)){ci.cancel();var Y=G.deltaY;G.deltaMode>0&&(Y*=100);var $=Eo(Y);if($!==1){var te=O?Vn():Hr(G);Ir(te.x,te.y,$),G.preventDefault()}}}function Hr(G){var Y,$,te=i.getBoundingClientRect();return Y=G.clientX-te.left,$=G.clientY-te.top,{x:Y,y:$}}function Gn(G,Y,$){var te=a.scale,Ae={scale:te},We={scale:$*te};ci.cancel(),hi(),os=oC(Ae,We,{step:function(Be){Mn(G,Y,Be.scale)},done:sd})}function cl(G,Y,$){var te=a.scale,Ae={scale:te},We={scale:$};ci.cancel(),hi(),os=oC(Ae,We,{step:function(Be){Mn(G,Y,Be.scale)}})}function Vn(){var G=i.getBoundingClientRect();return{x:G.width*O.x,y:G.height*O.y}}function Ir(G,Y,$){return ci.cancel(),hi(),Qs(G,Y,$)}function hi(){os&&(os.cancel(),os=null)}function Eo(G){var Y=Math.sign(G),$=Math.min(.25,Math.abs(T*G/128));return 1-Y*$}function xo(){ge||(Co("panstart"),ge=!0,ci.start())}function ds(){ge&&(Xs||ci.stop(),Co("panend"))}function sd(){Co("zoomend")}function Co(G){ss.fire(G,ss)}}function q_(s){if(!!s){if(typeof s=="object")return(!Zh(s.x)||!Zh(s.y))&&X_(s),s;X_()}}function X_(s){throw console.error(s),new Error(["Cannot parse transform origin.","Some good examples:",'  "center center" can be achieved with {x: 0.5, y: 0.5}','  "top center" can be achieved with {x: 0.5, y: 0}','  "bottom right" can be achieved with {x: 1, y: 1}'].join(`
`))}function Qh(){}function R6(s){var e=typeof s;if(!(e==="undefined"||e==="boolean")){var t=Zh(s.left)&&Zh(s.top)&&Zh(s.bottom)&&Zh(s.right);if(!t)throw new Error("Bounds object is not valid. It can be: undefined, boolean (true|false) or an object {left, top, right, bottom}")}}function Zh(s){return Number.isFinite(s)}function sC(s){return Number.isNaN?Number.isNaN(s):s!==s}function _6(){return{start:Qh,stop:Qh,cancel:Qh}}function M6(){if(typeof document>"u")return;var s=document.getElementsByTagName("script");if(!s)return;for(var e,t=0;t<s.length;++t){var i=s[t];if(i.src&&i.src.match(/\bpanzoom(\.min)?\.js/)){e=i;break}}if(!e)return;var n=e.getAttribute("query");if(!n)return;var o=e.getAttribute("name")||"pz",a=Date.now();l();function l(){var h=document.querySelector(n);if(!h){var d=Date.now(),f=d-a;if(f<2e3){setTimeout(l,100);return}console.error("Cannot find the panzoom element",o);return}var p=u(e);console.log(p),window[o]=K_(h,p)}function u(h){for(var d=h.attributes,f={},p=0;p<d.length;++p){var S=d[p],x=c(S);x&&(f[x.name]=x.value)}return f}function c(h){if(!!h.name){var d=h.name[0]==="p"&&h.name[1]==="z"&&h.name[2]==="-";if(!!d){var f=h.name.substr(3),p=JSON.parse(h.value);return{name:f,value:p}}}}}M6()});var IT=me(VC());var ly=me(gs());var $u=class{constructor(){this.attrs=[];this._parent=null}addEvent(e){this.events.push(e)}removeEvent(e){let t=this.events.indexOf(e);t>=0&&(this.events=this.events.splice(t,1))}raiseEvents(e){this.events.forEach(t=>t(e))}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t===e)return!0;return!1}};var ms=class extends $u{constructor(e,t){super();this.source=e,this.target=t,e!==t?(e.outEdges.add(this),t.inEdges.add(this)):e.selfEdges.add(this)}add(){this.source!==this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!==this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!==this.target.parent}EdgeToAncestor(){return this.source instanceof Te&&this.target.isDescendantOf(this.source)?1:this.target instanceof Te&&this.source.isDescendantOf(this.target)?2:0}};var bs=class extends $u{constructor(e){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=e}get id(){return this._id}set id(e){this._id=e}toString(){return this.id}*_edges(){for(let e of this.inEdges)yield e;for(let e of this.outEdges)yield e;for(let e of this.selfEdges)yield e}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}};var ay=class{constructor(){this.nodeMap=new Map}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof Te&&(yield e)}find(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}*nodesDeep(){for(let e of this.nodes_())if(yield e,e instanceof Te)for(let t of e.nodeCollection.nodesDeep())yield t}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}hasNode(e){if(this.nodeMap.has(e))return!0;for(let t of this.nodeMap)if(t[1]instanceof Te&&t[1].nodeCollection.hasNode(e))return!0;return!1}getNode(e){let t=this.nodeMap.get(e);if(t!==void 0)return t;for(let i of this.nodeMap)if(i[1]instanceof Te&&(t=i[1].nodeCollection.getNode(e),t!==void 0))return t}get nodeShallowCount(){return this.nodeMap.size}get nodeDeepCount(){let e=this.nodeMap.size;for(let t of this.nodeMap.values())t instanceof Te&&(e+=t.nodeCollection.nodeDeepCount);return e}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.getNode(e.id)==null&&this.nodeMap.set(e.id,e)}addEdge(e){this.addNode(e.source),this.addNode(e.target),e.source!==e.target?(e.source.outEdges.add(e),e.target.inEdges.add(e)):e.source.selfEdges.add(e)}removeNode(e){for(let t of e.outEdges)t.target.inEdges.delete(t);for(let t of e.inEdges)t.source.outEdges.delete(t);this.nodeMap.delete(e.id);for(let t of this.nodeMap.values())t instanceof Te&&t.nodeCollection.nodeMap.delete(e.id)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!==e||t.source===t.target)return!1;for(let t of e.inEdges)if(t.target!==e||t.source===t.target)return!1;for(let t of e.selfEdges)if(t.target!==t.source||t.source!==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap.values())if(!this.nodeIsConsistent(e))return!1;return!0}};var Te=class extends bs{constructor(e="__graph__"){super(e);this.nodeCollection=new ay}*getClusteredConnectedComponents(){let e=new Set,t=new ly.Queue;for(let i of this.deepNodes){if(e.has(i))continue;e.add(i),t.enqueue(i);let n=new Set;do{let o=t.dequeue();o.parent===this&&n.add(o);for(let a of this.reachableFrom(o))e.has(a)||(e.add(a),t.enqueue(a))}while(t.length>0);yield Array.from(n)}}*reachableFrom(e){for(let t of e.outEdges)yield t.target;for(let t of e.inEdges)yield t.source;e instanceof Te&&(yield*e.shallowNodes),e.parent!=this&&(yield e.parent)}hasSomeAttrOnIndex(e){for(let t of this.deepNodes)if(t.getAttr(e))return!0;for(let t of this.deepEdges)if(t.getAttr(e))return!0;return!1}*graphs(){for(let e of this.nodeCollection.graphs)yield e}noEmptySubgraphs(){for(let e of this.subgraphs())if(e.shallowNodeCount===0)return!1;return!0}hasSubgraphs(){for(let e of this.shallowNodes)if(e instanceof Te)return!0;return!1}*subgraphs(){for(let e of this.deepNodes)e instanceof Te&&(yield e)}isEmpty(){return this.shallowNodeCount===0}setEdge(e,t){let i=this.nodeCollection.find(e);if(i==null)return;let n=this.nodeCollection.find(t);if(n==null)return;let o=new ms(i,n);return this.addEdge(o),o}get shallowNodes(){return this.nodeCollection.nodesShallow}get deepNodes(){return this.nodeCollection.nodesDeep()}findNodeRecursive(e){let t=this.nodeCollection.find(e);if(t)return t;for(let i of this.shallowNodes)if(i instanceof Te){let n=i.findNodeRecursive(e);if(n)return n}return null}findNode(e){return this.nodeCollection.find(e)}get edges(){return this.nodeCollection.edges}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let e of this.deepNodes){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}isConsistent(){return this.parent?this.parent.isConsistent():this.eachNodeIdIsUnique()&&this.nodeCollection.isConsistent()}nodeIsConsistent(e){return this.nodeCollection.nodeIsConsistent(e)}removeNode(e){this.nodeCollection.removeNode(e)}addNode(e){return e.parent=this,this.nodeCollection.addNode(e),e}addEdge(e){this.nodeCollection.addEdge(e)}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){return this.nodeCollection.nodeDeepCount}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(e){for(;e!=null&&e.parent!==this;)e=e.parent;return e}deepEdgesCount(){let e=0;for(let t of this.deepNodes)e+=t.outDegree+t.selfDegree;return e}eachNodeIdIsUnique(){let e=new Set;for(let t of this.deepNodes){if(e.has(t.id))return!1;e.add(t.id)}return!0}*allSuccessorsWidthFirst(){for(let e of this.shallowNodes)yield e;for(let e of this.shallowNodes)e instanceof Te&&(yield*e.allSuccessorsWidthFirst())}*allSuccessorsDepthFirst(){for(let e of this.shallowNodes)e instanceof Te&&(yield*e.allSuccessorsDepthFirst()),yield e}};function*UC(s){let e=new Set,t=new ly.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(n(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of i(l))n(u,t,e)}yield a}function*i(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function n(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function uy(s,e){e.parent&&e.parent.nodeCollection.nodeMap.delete(e.id),s.nodeCollection.nodeMap.set(e.id,e),e.parent=s}var cy=class{static solve(e,t,i,n,o,a){let l=e*o-n*t;if(!(Math.abs(l)<cy.eps))return{x:(i*o-a*t)/l,y:(e*a-n*i)/l}}},zn=cy;zn.eps=1e-8;var ra=class{static RoundPoint(e){return new m(ra.RoundDouble(e.x),ra.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*ra.mult)/ra.mult}},A=ra;A.distanceEpsilonPrecision=6,A.mult=Math.pow(10,6),A.defaultLeafBoxesOffset=.5,A.lineSegmentThreshold=.05,A.intersectionEpsilon=1e-4,A.distanceEpsilon=Math.pow(10,-ra.distanceEpsilonPrecision),A.squareOfDistanceEpsilon=Math.pow(10,-ra.distanceEpsilonPrecision*2),A.tolerance=1e-8;function WC(s,e){return(s?1:0)-(e?1:0)}function Me(s,e){let t=s-e;return t<0?-1:t===0?0:1}function ec(s,e){let t=Me(s.y,e.y);return t||Me(s.x,e.x)}function le(s,e){let t=s-e;return-A.distanceEpsilon<=t&&t<=A.distanceEpsilon}function _p(s,e){return pd(s,e)>0}function pd(s,e){let t=s-e;return t<=-A.distanceEpsilon?-1:t>=A.distanceEpsilon?1:0}function je(s,e){return s.sub(e).length}var m=class{toJSON(){return{x:this.x,y:this.y}}static fromJSON(e){return new m(e.x,e.y)}static ProjectionToLine(e,t,i){let n=t.sub(e),o=n.length;if(o<A.distanceEpsilon)return e;n=n.div(o);let a=i.sub(e).dot(n);return e.add(n.mul(a))}static RayIntersectsRayInteriors(e,t,i,n){let o=m.lineLineIntersection(e,e.add(t),i,i.add(n));if(!!o&&o.sub(e).dot(t.div(t.l1))>A.distanceEpsilon&&o.sub(i).dot(n.div(n.l1))>A.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,i,n){let o=m.lineLineIntersection(e,t,i,i.add(n));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(i).dot(n)<0)&&a.dot(a)>A.squareOfDistanceEpsilon&&l.dot(l)>=A.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static PointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static PointIsInsideCone(e,t,i,n){return m.PointToTheRightOfLineOrOnLine(e,t,i)&&m.PointToTheLeftOfLineOrOnLine(e,t,n)}static PointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static PointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static closeIntersections(e,t){return m.close(e,t,A.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=Me(this.x,e.x);return t!==0?t:Me(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,i){return e.sub(t).length<=i}static closeSquare(e,t,i){let n=t.sub(e);return n.dot(n)<=i}static closeDistEps(e,t,i=A.distanceEpsilon){return e.sub(t).length<=i}normalize(){let e=this.length;return new m(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new m(this.x*e,this.y*t)}add(e){return new m(this.x+e.x,this.y+e.y)}sub(e){return new m(this.x-e.x,this.y-e.y)}mul(e){return new m(this.x*e,this.y*e)}div(e){return new m(this.x/e,this.y/e)}equal(e){return e.x===this.x&&e.y===this.y}neg(){return new m(-this.x,-this.y)}static lineLineIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=zn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!==void 0)return e.add(o.mul(u.x))}static segSegIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=A.tolerance,c=zn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!==void 0&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,i){let n=e.length,o=t.length;return n<i||o<i?!0:(e=e.div(n),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<i)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new m(-this.y,this.x)}rotate90Cw(){return new m(this.y,-this.x)}clone(){return new m(this.x,this.y)}rotate(e){let t=Math.cos(e),i=Math.sin(e);return new m(t*this.x-i*this.y,i*this.x+t*this.y)}static mkPoint(e,t,i,n){return t.mul(e).add(n.mul(i))}static convSum(e,t,i){return t.add(i.sub(t).mul(e))}static anglePCP(e,t,i){return m.angle(e.sub(t),i.sub(t))}static angle(e,t){let i=e.x,n=e.y,o=t.x,a=t.y,l=i*a-n*o,u=i*o+n*a;if(Math.abs(u)<A.tolerance)return Math.abs(l)<A.tolerance?0:l<-A.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<A.tolerance)return u<-A.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-A.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>A.distanceEpsilon?1:n<-A.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>A.intersectionEpsilon?1:n<-A.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o),l=n.dot(n);return a<=0+A.tolerance?t:l<=a+A.tolerance?i:t.add(n.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static pointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static pointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static pointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static canProject(e,t,i){let n=i.sub(t);return!(e.sub(t).dot(n)<0||e.sub(i).dot(n)>0)}static distToLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a,l;if((a=n.dot(o))<=A.tolerance)return{par:0,dist:o.length};if((l=n.dot(n))<=a+A.tolerance)return{par:1,dist:e.sub(i).length};let u=a/l;return{par:u,dist:t.add(n.mul(u)).length}}};var Ut=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new Ut;return t.point=e,t}};var Ne=class{contains(e){let t=e.sub(this.corner),i=A.distanceEpsilon,n=t.dot(this.bRot);if(n>this.abRot+i||n<-i)return!1;let o=t.dot(this.aRot);return o<=this.baRot+i&&o>=-i}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let i=new Ne,n=e.corner,o={minx:n.x,maxx:n.x,miny:n.y,maxy:n.y};return Ne.pumpMinMax(o,e.aPlusCorner),Ne.pumpMinMax(o,e.otherCorner),Ne.pumpMinMax(o,e.bPlusCorner),Ne.pumpMinMax(o,t.corner),Ne.pumpMinMax(o,t.aPlusCorner),Ne.pumpMinMax(o,t.otherCorner),Ne.pumpMinMax(o,t.bPlusCorner),i.corner=new m(o.minx,o.miny),i.a=new m(0,o.maxy-o.miny),i.b=new m(o.maxx-o.minx,0),i.aPlusCorner=i.a.add(i.corner),i.otherCorner=i.b.add(i.aPlusCorner),i.bPlusCorner=i.b.add(i.corner),i.aRot=new m(-i.a.y,i.a.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new m(-i.b.y,i.b.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.a.dot(i.bRot),i.baRot=i.b.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=i.a.sub(i.b).length<A.distanceEpsilon,i}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(Ne.separByA(e,t)||Ne.separByA(t,e)||Ne.separByB(e,t)||Ne.separByB(t,e))===!1?!1:!(e.isSeg&&t.isSeg)||!m.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:Ne.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let i=e.corner,n=e.otherCorner,o=t.corner,a=t.otherCorner,l=n.sub(i),u=0,c=l.dot(l),h=o.sub(i).dot(l),d=a.sub(i).dot(l);if(h>d){let f=h;h=d,d=f}return!(d<u-A.distanceEpsilon||h>c+A.distanceEpsilon)}static separByB(e,t){let i=A.distanceEpsilon,n=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(n>e.abRot+i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+i)return!1;return!0}else if(n<-i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-i)return!1;return!0}return!1}static separByA(e,t){let i=A.distanceEpsilon,n=t.corner.sub(e.corner),o=m.dot(n,e.aRot);return o>e.baRot+i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)<=e.baRot+i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i))):o<-i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)>=-i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)>=-i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)>=-i))):!1}static parallelogramByCornerSideSide(e,t,i){let n=new Ne;return n.corner=e,n.a=t,n.b=i,n.aRot=new m(-t.y,t.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new m(-i.y,i.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.bRot.dot(t),n.baRot=i.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=t.sub(i).length<A.distanceEpsilon,n.aPlusCorner=t.add(e),n.otherCorner=i.add(n.aPlusCorner),n.bPlusCorner=i.add(e),n}static getParallelogramOfAGroup(e){let t=0,i=0,n=0,o=0,a=!0;for(let l of e){let u=nM(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=i=h,n=o=d):(h<t?t=h:h>i&&(i=h),d<n?n=d:d>o&&(o=d))}}return Ne.parallelogramByCornerSideSide(new m(t,n),new m(0,o-n),new m(i-t,0))}};function*nM(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var D=class{constructor(e,t,i,n){this.parStart=0;this.parEnd=1;this.start=new m(e,t),this.end=new m(i,n)}static fromJSON(e){return D.mkPP(m.fromJSON(e.start),m.fromJSON(e.end))}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let i=this.value(e),n=this.value(t);return m.close(i,n,A.distanceEpsilon)?null:D.mkPP(i,n)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:Ne.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new m(-e.y,e.x)}static mkPP(e,t){return new D(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,i){return new D(e.x,e.y,t,i)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}reverse(){return D.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return D.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<A.tolerance)return 0;let i=e/t;return i>1?1:i<0?0:i}transform(e){return D.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,i){let n=this.closestParameter(e);return n<t&&(n=t),n>i&&(n=i),n}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return W.mkPP(this.start,this.end)}clone(){return D.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o);if(a<=0+A.tolerance)return 0;let l=n.dot(n);return l<=a+A.tolerance?1:a/l}closestParameter(e){return D.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,i,n){let o=m.lineLineIntersection(e,t,i,n);if(o!=null&&D.xIsBetweenPoints(e,t,o)&&D.xIsBetweenPoints(i,n,o))return o}static xIsBetweenPoints(e,t,i){return e.sub(i).dot(t.sub(i))<=A.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,i,n){let o=t.sub(e),a=n.sub(i),l=e.sub(i),u=m.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),f=o.dot(l),p=a.dot(l),S,x,T=Math.abs(u),O=T,M=T;T<A.tolerance?(S=0,O=1,x=p,M=d):(S=m.crossProduct(a,l),x=m.crossProduct(o,l),u<0&&(S=-S,x=-x),S<0?(S=0,x=p,M=d):S>O&&(S=O=1,x=p+h,M=d)),x<0?(x=0,-f<0?S=0:-f>c?S=O:(S=-f,O=c)):x>M&&(x=M=1,-f+h<0?S=0:-f+h>c?S=O:(S=-f+h,O=c));let R=Math.abs(S)<A.tolerance?0:S/O,N=Math.abs(x)<A.tolerance?0:x/M;return{parab:R,parcd:N,dist:l.add(o.mul(R).sub(a.mul(N))).length}}};function oM(s,e,t,i,n){return{parallelogram:t,seg:i,leafBoxesOffset:n,node:{low:s,high:e,chord:null}}}var Et=class{static distToSegm(e,t,i){let n=i.sub(t);if(n.length<A.intersectionEpsilon)return e.sub(t.add(i).div(2)).length;let o=new m(-n.y,n.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,i){let n=i.derivative(e),o=i.derivative(t),a=new m(-o.y,o.x),l=i.value(e),u=i.value(t),h=u.sub(l).dot(a),d=n.dot(a),f=Math.abs(h)<A.distanceEpsilon;if(!f&&Math.abs(d)<A.distanceEpsilon)return;let p=f?0:h/d;return n=n.mul(p),Ne.parallelogramByCornerSideSide(l,n,u.sub(l).sub(n))}static createParallelogramNodeForCurveSeg(e,t,i,n){if(e===i.parStart&&t===i.parEnd&&m.close(i.start,i.end,A.distanceEpsilon))return Et.createNodeWithSegmentSplit(e,t,i,n);let a=i.value(e),l=i.value(t),u=l.sub(a),c=i.value((e+t)/2);if(Et.distToSegm(c,a,l)<=A.intersectionEpsilon&&u.dot(u)<A.lineSegmentThreshold*A.lineSegmentThreshold&&t-e<A.lineSegmentThreshold){let h=D.mkPP(a,l),d=h.pNodeOverICurve();d.seg=i;let f=d.node;return f.low=e,f.high=t,f.chord=h,d}if(Et.WithinEpsilon(i,e,t,n)){let h=Et.createParallelogramOnSubSeg(e,t,i);if(h!==void 0)return oM(e,t,h,i,n)}return Et.createNodeWithSegmentSplit(e,t,i,n)}static WithinEpsilon(e,t,i,n){let a=(i-t)/3,l=e.value(t),u=e.value(i);return Et.distToSegm(e.value(t+a),l,u)>n?!1:Et.distToSegm(e.value(t+a*(3-1)),l,u)<=n}static createParallelogramNodeForCurveSegDefaultOffset(e){return Et.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,A.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,i,n){let o={parallelogram:null,seg:i,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(Et.createParallelogramNodeForCurveSeg(e,.5*(e+t),i,n)),a.children.push(Et.createParallelogramNodeForCurveSeg(.5*(e+t),t,i,n)),o.parallelogram=Ne.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var wo=class{constructor(e,t,i,n,o){this.par0=e,this.par1=t,this.x=i,this.seg0=n,this.seg1=o}};var pl=class{static closestPoint(e,t,i,n,o){let u=i,c=0,h=0,d,f=!1;do{let p=e.value(u),S=e.derivative(u),x=e.secondDerivative(u),T=S.dot(S)+p.sub(t).dot(x);if(Math.abs(T)<A.tolerance)return u;d=p.sub(t).dot(S.div(T)),u-=d,u>o+A.tolerance?(u=o,h++):u<n-A.tolerance&&(u=n,h++),c++}while(Math.abs(d)>A.tolerance&&!(f=c>=5||h>=5));return f&&e.value(i).sub(t).length<A.distanceEpsilon&&(u=i),u}};var de=class{isFullEllipse(){return this.parEnd===Math.PI*2&&this.parStart===0}static fromJSON(e){return new de(e.parStart,e.parEnd,m.fromJSON(e.axis0),m.fromJSON(e.axis1),m.fromJSON(e.center))}toJSON(){return{parStart:this.parStart,parEnd:this.parEnd,axis0:this.aAxis.toJSON(),axis1:this.bAxis.toJSON(),center:this.center.toJSON()}}offsetCurve(e,t){let i=t.sub(this.center),n=m.angle(this.aAxis,i);if(this.aAxis.mul(Math.cos(n)).add(this.bAxis.mul(Math.sin(n))).length<i.length){let a=this.aAxis.length,l=this.bAxis.length;return de.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return de.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,i){return new de(0,Math.PI*2,e,t,i)}constructor(e,t,i,n,o){this.parStart=e,this.parEnd=t,this.aAxis=i,this.bAxis=n,this.center=o,this.pNode=null,this.setBoundingBox()}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new de(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(m.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return m.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return m.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return m.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=Et.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(le(this.parStart,0)&&le(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=W.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,i,n,o,a){return new de(e,t,i,n,new m(o,a))}static mkFullEllipsePPP(e,t,i){return new de(0,Math.PI*2,e,t,i)}static mkFullEllipseNNP(e,t,i){return new de(0,Math.PI*2,new m(e,0),new m(0,t),i)}static mkCircle(e,t){return de.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new de(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let i=this.parStart,n=this.parEnd,o=e+.001,a=e-.001;for(;n-i>A.distanceEpsilon;){let l=.5*(n+i),u=this.lengthPartial(this.parStart,l);if(u>o)n=l;else if(u<a)i=l;else return l}return(n+i)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),i=e.multiplyPoint(this.bAxis).sub(e.offset());return new de(this.parStart,this.parEnd,t,i,e.multiplyPoint(this.center))}return this}closestParameterWithinBounds(e,t,i){let o=(i-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),f=d.dot(d);f<l&&(l=f,a=h)}a===0&&i===Math.PI*2&&(t=-Math.PI);let u=pl.closestPoint(this,e,a,t,i);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return L.lengthWithInterpolationAndThreshold(this.trim(e,t),A.lineSegmentThreshold/100)}get length(){return(this.aAxis.length+this.bAxis.length)*Math.abs(this.parEnd-this.parStart)/2}clone(){return new de(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,i=8,n=(this.parEnd-this.parStart)/(i+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=i;c++){let h=this.parStart+c*n,d=e.sub(this.value(h)),f=d.dot(d);f<a&&(a=f,o=h)}let l=!1;o===0&&this.parEnd===Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=pl.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return m.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return W.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<A.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<A.tolerance&&m.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var hy=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,i,n,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=i,this.bMin=o,this.aMax=n,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,i,n){return e*n-i*t}solve(){let e=0,t=10,i=0,n=100,o=!1;if(this.initValues(),this.curveA instanceof D&&this.curveB instanceof D){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<A.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<A.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<A.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+A.distanceEpsilon||u<this.aMin-A.distanceEpsilon||c>this.bMax+A.distanceEpsilon||c<this.bMin-A.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),i++,o=e>=t||i>=n||a.s===0&&a.t===0&&h}while((Math.abs(a.s)>=A.tolerance||Math.abs(a.t)>=A.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<A.distanceEpsilon*A.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!==0&&e.t!==0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let i=1;this.ti+e.t>this.bMax?i=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(i=(this.bMin-this.ti)/e.t);let n=Math.min(t,i);e.s*=n,e.t*=n}else e.s===0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,i=e.start,n=e.end,o=t.start,a=t.end,l=n.sub(i),u=l.length,c=0,h,d,f;if(u>A.distanceEpsilon){l=l.div(u),h=l.dot(n.sub(i)),d=l.dot(o.sub(i)),f=l.dot(a.sub(i));let p=!1;if(d>f){p=!0;let S=d;d=f,f=S}if(f<c)this.aSolution=0,this.bSolution=p?0:1;else if(d>h)this.aSolution=1,this.bSolution=p?1:0;else{let S=Math.min(h,f);this.aSolution=S/(h-c),this.bSolution=(S-d)/(f-d),p&&(this.bSolution=1-this.bSolution)}}else{let p=a.sub(o),S=p.length;if(S>A.distanceEpsilon)if(p=p.div(S),c=0,h=p.dot(a.sub(o)),d=p.dot(i.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let x=Math.min(h,d);this.bSolution=x/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Ge=class{constructor(e,t,i,n){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=i,this.b[3]=n,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}toJSON(){return{b:this.b.map(e=>e.toJSON())}}static fromJSON(e){return Ge.mkBezier(e.b.map(m.fromJSON))}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=Et.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,i=t*e;return this.l.mul(i).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Ge.adjustParamTo01(e),t=Ge.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-A.tolerance)return new Ge(this.b[3],this.b[3],this.b[3],this.b[3]);let i=new Array(3),n=new Array(2),o=this.casteljau(e,i,n),a=new Ge(o,n[1],i[2],this.b[3]),l=a.casteljau((t-e)/(1-e),i,n);return new Ge(a.b[0],i[0],n[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,i){let n=1-e;for(let o=0;o<3;o++)t[o]=m.mkPoint(n,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)i[o]=m.mkPoint(n,t[o],e,t[o+1]);return m.mkPoint(n,i[0],e,i[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return m.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Ge(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.bbox&&(this.bbox=W.translate(this.bbox,e)),this.pBoxNode=null}scaleFromOrigin(e,t){return new Ge(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Ge.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,i,n){let o=n.sub(e).length,a=t.sub(e).length+i.sub(t).length+n.sub(i).length;if(a-o>A.lineSegmentThreshold){let l=m.middle(e,t),u=m.middle(t,i),c=m.middle(i,n),h=m.middle(l,u),d=m.middle(c,u),f=m.middle(h,d);return Ge.lengthOnControlPolygon(e,l,h,f)+Ge.lengthOnControlPolygon(f,d,c,n)}return(a+o)/2}get boundingBox(){return this.bbox?this.bbox:this.bbox=W.mkOnPoints(this.b)}transform(e){return new Ge(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,i){let n=(i-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*n+t)),c=u.dot(u);c<a&&(a=c,o=l*n+t)}return pl.closestPoint(this,e,o,t,i)}clone(){return new Ge(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Ge(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),i=this.Yp(e),n=t*t+i*i;return Math.sqrt(n*n*n)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let i=0,n=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<n&&(n=l,i=o*.125)}return pl.closestPoint(this,e,i,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+i*i),c=t*n+i*o;return 3*(c*c/u+u*(n*n+t*a+o*o+i*l))}Gp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+i*i)*(t*n+i*o)}getParameterAtLength(e){let t=0,i=1;for(;i-t>A.tolerance;){let n=(i+t)/2,o=this.evaluateError(e,n);if(o>0)i=n;else if(o<0)t=n;else return n}return(t+i)/2}evaluateError(e,t){let i=1-t,n=m.mkPoint(i,this.b[0],t,this.b[1]),o=m.mkPoint(i,this.b[1],t,this.b[2]),a=m.mkPoint(i,this.b[2],t,this.b[3]),l=m.mkPoint(i,n,t,o),u=m.mkPoint(i,o,t,a),c=m.mkPoint(i,l,t,u),h=Ge.lengthOnControlPolygon(this.b[0],n,l,c);return h>e+A.distanceEpsilon?1:h<e-A.distanceEpsilon?-1:0}};function sM(s){return s.seg.value(s.par)}function aM(s){return s.seg.derivative(s.par)}function lM(s){return s.seg.secondDerivative(s.par)}function uM(s){return s.seg.thirdDerivative(s.par)}function cM(s){if(s instanceof de)return{tag:"ellipse",segData:s.toJSON()};if(s instanceof D)return{tag:"lineSegment",segData:s.toJSON()};if(s instanceof Ge)return{tag:"bezier",segData:s.toJSON()};throw new Error("not implemented")}var L=class{static fromJSON(e){let t=new L;for(let i of e.segs)switch(i.tag){case"bezier":t.addSegment(Ge.fromJSON(i.segData));break;case"ellipse":t.addSegment(de.fromJSON(i.segData));break;case"lineSegment":t.addSegment(D.fromJSON(i.segData));break;default:throw new Error("not implemented")}return t}toJSON(){return{segs:this.segs.map(e=>cM(e))}}static CurvesIntersect(e,t){return e===t||L.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(n.segIndex<o.segIndex){let a=this.segs[n.segIndex],l=a.lengthPartial(n.par,a.parEnd);for(let u=n.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new L;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=L.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let i=new L;for(let n of this.segs)i.addSegment(n.scaleFromOrigin(e,t));return i}trim(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(i.start),o=this.getSegIndexParam(i.end);if(n.segIndex===o.segIndex)return this.segs[n.segIndex].trim(n.par,o.par);let a=new L;n.par<this.segs[n.segIndex].parEnd&&(a=a.addSegment(this.segs[n.segIndex].trim(n.par,this.segs[n.segIndex].parEnd)));for(let l=n.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.boundingBox_=W.translate(this.boundingBox_,e),this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let i=new L;return i.addSegment(this.trim(e,this.parEnd)),i.addSegment(this.trim(this.parStart,t)),i}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(this.boundingBox_=null,!(e instanceof L))this.segs.push(e),this.parEnd_+=L.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=L.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let i of this.segs){let n=i.pNodeOverICurve();e.push(n.parallelogram),t.push(n)}return this.pBNode={parallelogram:Ne.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:A.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,i){let n=L.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return i&&n!=null&&(n=L.liftIntersectionToCurves(e,t,n)),n}static getAllIntersections(e,t,i){return e instanceof D?L.getAllIntersectionsOfLineAndICurve(e,t,i):L.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsInternal(e,t,i){let n=[];if(L.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),n),i)for(let o=0;o<n.length;o++)n[o]=L.liftIntersectionToCurves(e,t,n[o]);return n}static getAllIntersectionsOfLineAndICurve(e,t,i){return t instanceof re?L.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof L?L.getAllIntersectionsOfLineAndCurve(e,t,i):t instanceof de&&t.isArc()?L.getAllIntersectionsOfLineAndArc(e,t):L.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsOfLineAndCurve(e,t,i){let n=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(Ne.intersect(o.parallelogram,a.parallelogram)===!1)return n;let l=0;for(let u of t.segs){let c=L.getAllIntersections(e,u,!1);if(i){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)L.alreadyInside(n,h)||n.push(h)}return n}static closeIntersections(e,t){return m.close(e.x,t.x,A.intersectionEpsilon)}static closeIntersectionPoints(e,t){return m.close(e,t,A.intersectionEpsilon)}static alreadyInside(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(L.closeIntersections(n,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let i=e.end.sub(e.start),n=[],o=i.length;if(o<A.distanceEpsilon){let d=e.start.sub(t.center);if(le(d.length,t.aAxis.length)){let f=m.angle(t.aAxis,d);t.parStart-A.tolerance<=f&&(f=Math.max(f,t.parStart),f<=t.parEnd+A.tolerance&&(f=Math.min(t.parEnd,f),n.push(new wo(0,f,e.start,e,t))))}return n}let a=i.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-A.distanceEpsilon)return n;if(i=a.rotate90Cw(),le(c,h))L.tryToAddPointToLineCircleCrossing(e,t,n,u,o,i);else{let d=Math.sqrt(c*c-l*l),f=i.mul(d);L.tryToAddPointToLineCircleCrossing(e,t,n,u.add(f),o,i),L.tryToAddPointToLineCircleCrossing(e,t,n,u.sub(f),o,i)}return n}static tryToAddPointToLineCircleCrossing(e,t,i,n,o,a){let u=n.sub(e.start).dot(a);if(u<-A.distanceEpsilon||(u=Math.max(u,0),u>o+A.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=m.angle(t.aAxis,n.sub(t.center));t.parStart-A.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+A.tolerance&&(c=Math.min(t.parEnd,c),i.push(new wo(u,c,n,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let i=[],n=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=L.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a&&(L.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),L.oldIntersection(i,a.x)||i.push(new wo(a.aSol,n+a.bSol,a.x,e,t))),n++}if(t.closed){let a=L.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a&&(L.adjustSolution(e.start,e.end,o.point,t.start,a),L.oldIntersection(i,a.x)||i.push(new wo(a.aSol,n+a.bSol,a.x,e,t)))}return i}static adjustSolution(e,t,i,n,o){L.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):L.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),L.closeIntersectionPoints(o.x,i)?(o.x=i,o.bSol=Math.floor(o.bSol)):L.closeIntersectionPoints(o.x,n)&&(o.x=n,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!Ne.intersect(e.parallelogram,t.parallelogram))return null;let i=e.node,n=t.node,o=i.hasOwnProperty("children"),a=n.hasOwnProperty("children");if(o&&a)for(let l of i.children)for(let u of n.children){let c=L.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of n.children){let u=L.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of i.children){let u=L.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return L.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,i){if(!Ne.intersect(e.parallelogram,t.parallelogram))return;let n=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(n&&o)for(let a of e.node.children)for(let l of t.node.children)L.curveCurveXWithParallelogramNodes(a,l,i);else if(o)for(let a of t.node.children)L.curveCurveXWithParallelogramNodes(e,a,i);else if(n)for(let a of e.node.children)L.curveCurveXWithParallelogramNodes(a,t,i);else i=L.crossOverLeaves(e,t,i)}static crossOverIntervalsOne(e,t){let i=e.node,n=t.node,o=(i.high-i.low)/2,a=(n.high-n.low)/2;for(let l=1;l<2;l++){let u=l*o+i.low;for(let c=1;c<2;c++){let h=c*a+n.low,d;if(i.chord==null&&n.chord==null?d=L.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,n.low,n.high,u,h):i.chord!=null&&n.chord==null?d=L.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,n.low,n.high,.5*l,h):i.chord==null?(d=L.crossWithinIntervalsWithGuess(e.seg,n.chord,i.low,i.high,0,1,u,.5*c),d&&(d.bSol=n.low+d.bSol*(n.high-n.low))):(d=L.crossWithinIntervalsWithGuess(i.chord,n.chord,0,1,0,1,.5*l,.5*c),d&&(d.aSol=i.low+d.aSol*(i.high-i.low),d.bSol=n.low+d.bSol*(n.high-n.low))),d)return L.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return L.goDeeperOne(e,t)}static crossOverLeaves(e,t,i){let n=e.node,o=t.node,a=!1,l=(n.high-n.low)/2+n.low,u=(o.high-o.low)/2+o.low,c;return n.chord==null&&o.chord==null?c=L.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,o.low,o.high,l,u):n.chord!=null&&o.chord==null?(c=L.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,o.low,o.high,.5,u),c&&(c.aSol=n.low+c.aSol*(n.high-n.low))):n.chord==null?(c=L.crossWithinIntervalsWithGuess(e.seg,o.chord,n.low,n.high,0,1,l,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=L.crossWithinIntervalsWithGuess(n.chord,o.chord,0,1,0,1,.5,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=n.low+c.aSol*(n.high-n.low))),c&&(L.addIntersection(e,t,i,c),a=!0),a||L.goDeeper(i,e,t),i}static addIntersection(e,t,i,n){let o=e.node;L.closeIntersectionPoints(n.x,e.seg.value(o.low))?(n.x=e.seg.value(o.low),n.aSol=o.low):L.closeIntersectionPoints(n.x,e.seg.value(o.high))&&(n.x=e.seg.value(o.high),n.aSol=o.high);let a=t.node;if(L.closeIntersectionPoints(n.x,t.seg.value(a.low))?(n.x=t.seg.value(a.low),n.bSol=a.low):L.closeIntersectionPoints(n.x,t.seg.value(a.high))&&(n.x=t.seg.value(a.high),n.bSol=a.high),!L.oldIntersection(i,n.x)){let u=new wo(n.aSol,n.bSol,n.x,e.seg,t.seg);i.push(u)}}static oldIntersection(e,t){for(let i of e)if(t.sub(i.x).length<A.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,i,n,o){let a=e.node,l=t.node;return L.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),i=a.low):L.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),i=a.high),L.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),n=l.low):L.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),n=l.high),new wo(i,n,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,i,n,o,a,l){let u=e instanceof L?L.liftParameterToCurve(e,i-a.parStart,a):i,c=t instanceof L?L.liftParameterToCurve(t,n-l.parStart,l):n;return new wo(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,i;if(e.seg0 instanceof L){let a=e.seg0.getSegParam(e.par0);t=a.seg,i=a.par}else i=e.par0,t=e.seg0;let n,o;if(e.seg1 instanceof L){let a=e.seg1.getSegParam(e.par1);o=a.par,n=a.seg}else o=e.par1,n=e.seg1;return new wo(i,o,e.x,t,n)}static liftIntersectionToCurves(e,t,i){return L.liftIntersectionToCurves_(e,t,i.par0,i.par1,i.x,i.seg0,i.seg1)}static liftParameterToCurve(e,t,i){if(e===i)return t;if(!e.hasOwnProperty("segs"))return;let n=e,o=0;for(let a of n.segs){if(a===i)return t+o;o+=L.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let i=e.node,n=t.node;if(e.leafBoxesOffset>A.distanceEpsilon&&t.leafBoxesOffset>A.distanceEpsilon){let l=Et.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2),u=Et.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return L.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>A.distanceEpsilon){let l=Et.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2);return L.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>A.distanceEpsilon){let l=Et.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return L.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(i.low),a=e.seg.value(i.high);if(!m.closeDistEps(o,a)){let l=t.seg.value(n.low),u=t.seg.value(n.high);if(!m.closeDistEps(l,u)){let c=e.seg instanceof D?e.seg:D.mkPP(o,a),h=t.seg instanceof D?t.seg:D.mkPP(l,u),d=L.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d)return L.adjustParameters(e,c,t,h,d),L.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,i){let n=t.node,o=i.node,a=t.leafBoxesOffset>A.distanceEpsilon,l=i.leafBoxesOffset>A.distanceEpsilon;if(a&&l){let u=Et.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2),c=Et.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);L.curveCurveXWithParallelogramNodes(u,c,e)}else if(a){let u=Et.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);L.curveCurveXWithParallelogramNodes(u,i,e)}else if(l){let u=Et.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);L.curveCurveXWithParallelogramNodes(t,u,e)}else{let u=t.seg.value(n.low),c=t.seg.value(n.high);if(!m.closeDistEps(u,c)){let h=i.seg.value(o.low),d=i.seg.value(o.high);if(!m.closeDistEps(h,d)){let f=t.seg instanceof D?t.seg:D.mkPP(u,c),p=i.seg instanceof D?i.seg:D.mkPP(h,d),S=L.crossWithinIntervalsWithGuess(f,p,0,1,0,1,.5,.5);S&&(L.adjustParameters(t,f,i,p,S),L.addIntersection(t,i,e,S))}}}}static adjustParameters(e,t,i,n,o){if(t!==e.seg&&!(e.seg instanceof re))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(n!==i.seg&&!(i.seg instanceof re))o.bSol=i.seg.closestParameter(o.x);else{let a=i.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let n of this.segs){let o=t+n.parEnd-n.parStart;if(e>=t&&e<=o)return{par:e-t+n.parStart,seg:n};t=o}let i=this.segs[this.segs.length-1];return{seg:i,par:i.parEnd}}getSegIndexParam(e){let t=0,i=this.segs.length;for(let o=0;o<i;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let n=this.segs[i-1];return{segIndex:i-1,par:n.parEnd}}value(e){return sM(this.getSegParam(e))}derivative(e){return aM(this.getSegParam(e))}secondDerivative(e){return lM(this.getSegParam(e))}thirdDerivative(e){return uM(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,i,n,o,a,l,u){if(e instanceof D&&t instanceof D){let d=L.crossTwoLineSegs(e.start,e.end,t.start,t.end,i,n,o,a);if(d!==void 0)return d}let c=L.minDistWithinIntervals(e,t,i,n,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=A.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:m.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,i,n,o,a,l,u){let c=t.sub(e),h=i.sub(n),d=i.sub(e),f=zn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(f==null)return;let p=f.x,S=f.y,x=e.add(c.mul(p));if(!(p<o-A.tolerance)&&(p=Math.max(p,o),!(p>a+A.tolerance)&&(p=Math.min(p,a),!(S<l-A.tolerance)&&(S=Math.max(S,l),!(S>u+A.tolerance)))))return S=Math.min(S,u),{aSol:p,bSol:S,x}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let i=2*t.boundingBox.diagonal,n=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new m(Math.cos(a*n),Math.sin(a*n)),u=D.mkPP(e,e.add(l.mul(i))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(L.AllIntersectionsAreGood(c,t)){for(let d of c)if(m.closeDistEps(d.x,e))return 1;if(c.length%2===1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let i=t.hasOwnProperty("segs"),n=null;if(i||t instanceof re&&(n=t.toCurve()),n){for(let o of e)if(!L.RealCut(L.DropIntersectionToSegs(o),n,!1))return!1}return!0}static RealCut(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let x=0;x<t.segs.length-1;x++)if(t.segs[x]===o){f=t.segs[x+1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<A.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let x=t.segs.length-1;x>0;x--)if(t.segs[x]===o){f=t.segs[x-1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<A.tolerance)}let d=c.dot(h);return i?d>A.distanceEpsilon:Math.abs(d)>A.distanceEpsilon}static realCutWithClosedCurve(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let x=0;x<t.segs.length;x++)if(t.segs[x]===o){f=t.segs[(x+1)%t.segs.length];break}if(f==null)throw new Error;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<A.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let x=0;x<t.segs.length;x++)if(t.segs[x]===o){f=t.segs[x>0?x-1:t.segs.length-1];break}let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<A.tolerance)}let d=c.dot(h);return i?d>A.distanceEpsilon:Math.abs(d)>A.distanceEpsilon}static minDistWithinIntervals(e,t,i,n,o,a,l,u){let c=new hy(e,t,i,n,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.boundingBox_)return this.boundingBox_;if(this.segs.length===0)this.boundingBox_=W.mkEmpty();else{let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return this.boundingBox_=e}}clone(){let e=new L;for(let t of this.segs)e.addSegment(t.clone());return e.boundingBox_=this.boundingBox_.clone(),e}getParameterAtLength(e){let t=0;for(let i of this.segs){let n=i.length;if(n>=e)return t+i.getParameterAtLength(e);e-=n,t+=i.parEnd-i.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new L;for(let i of this.segs)t.addSegment(i.transform(e));return this.boundingBox_&&(t.boundingBox_=this.boundingBox_.transform(e)),t}closestParameterWithinBounds(e,t,i){let n=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>i)break;let u=L.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(i-a)),f=l.closestParameterWithinBounds(e,h,d),p=e.sub(l.value(f)),S=p.dot(p);S<o&&(n=a+f-l.parStart,o=S)}a+=u}return n}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);u<i&&(t=n+a-o.parStart,i=u),n+=L.paramSpan(o)}return t}static addLineSegment(e,t,i){return e.addSegment(D.mkPP(t,i))}static addLineSegmentCNNP(e,t,i,n){return L.addLineSegment(e,new m(t,i),n)}static addLineSegmentCNNNN(e,t,i,n,o){L.addLineSegment(e,new m(t,i),new m(n,o))}static continueWithLineSegmentNN(e,t,i){L.addLineSegment(e,e.end,new m(t,i))}static continueWithLineSegmentP(e,t){L.addLineSegment(e,e.end,t)}static closeCurve(e){return L.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<A.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=L.paramSpan(t),Math.abs(e)<A.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<A.tolerance)return this.start===this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<A.tolerance)return t;e-=L.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let i=L.getAllIntersections(e,t,!0);if(i.length===0)return L.NonIntersectingCurveIsInsideOther(e,t);if(i.length===1)return e.start.equal(i[0].x)?L.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:L.PointRelativeToCurveLocation(e.start,t)===2;for(let n of L.PointsBetweenIntersections(e,i))if(L.PointRelativeToCurveLocation(n,t)===0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let i=t[t.length-1].par0,n=t[0].par0,o=e.parEnd-i+(n-e.parStart),a=i+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let i=e.parStart;i<e.parEnd;i+=.5){let n=L.PointRelativeToCurveLocation(e.value(i),t);if(n!==1)return n===2}return L.PointRelativeToCurveLocation(e.end,t)!==0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let i=L.getAllIntersections(e,t,!0);if(i.length===0)return L.NonIntersectingCurveIsInsideOther(e,t)||L.NonIntersectingCurveIsInsideOther(t,e);if(i.length===1)return e.start.equal(i[0].x)?L.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)===2||!t.start.equal(i[0].x)?L.PointRelativeToCurveLocation(t.start,e)===2:L.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)===2:L.PointRelativeToCurveLocation(e.start,t)===2;for(let n of L.PointsBetweenIntersections(e,i))if(L.PointRelativeToCurveLocation(n,t)===2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,i,n,o){let a=m.mkPoint(e,i.point,1-e,n.point),l=m.mkPoint(t,o.point,1-t,n.point),u=n.point.mul(2/3);return new Ge(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,i,n){let o=i.mul(n);return new Ge(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let i=t.next;if(i!=null)return{b:t,c:i}}static trimEdgeSplineWithNodeBoundaries(e,t,i,n){let o=i.parStart,a=i.parEnd;e!=null&&(o=L.findNewStart(i,o,e,n)),t!=null&&(a=L.findNewEnd(i,t,n,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?i.trim(l,u):i}static findNewEnd(e,t,i,n){let o=L.getAllIntersections(e,t,!0);if(o.length===0)return n=e.parEnd,n;if(i){n=e.parEnd;for(let a of o)a.par0<n&&(n=a.par0)}else{n=e.parStart;for(let a of o)a.par0>n&&(n=a.par0)}return n}static findNewStart(e,t,i,n){let o=L.getAllIntersections(e,i,!0);if(o.length===0){t=e.parStart;return}if(n){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof de)return L.refineEllipse(e);if(e instanceof re)return e;if(e instanceof L&&L.allSegsAreLines(e)){let t=new re;for(let i of e.segs)t.addPoint(i.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof D))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),i=Math.PI/4,n=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(n*n+o*o),l=[];for(let c=0;c<4;c++){let h=i+c*Math.PI/2,d=e.value(h),f=e.derivative(h).normalize().mul(a),p=D.mkPP(d.sub(f),d.add(f));for(let S of L.getAllIntersections(t,p,!0))l.push(S)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new re;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new re;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};function hM(s,e,t,i,n,o){if(n instanceof D)return!0;for(let a of[1/3,.5,2/3]){let l=s*a+t*(1-a);if(m.closeSquare(n.value(l),m.mkPoint(a,e,1-a,i),o)===!1)return!1}return!0}function dy(s,e,t,i,n,o){let a=[];if(hM(s,e,t,i,n,o))a.push(e),a.push(i);else{let l=.5*(s+t),u=n.value(l);a=dy(s,e,l,u,n,o);let c=dy(l,u,t,i,n,o).slice(1);a=a.concat(c)}return a}function*fy(s,e){if(e.containsRectWithPadding(s.boundingBox,1)){yield s;return}let t=Math.max(Math.min(e.width,e.height)/20,1),i=e.perimeter(),n=L.getAllIntersections(s,i,!0);if(n.length==0){e.contains(s.start)&&(yield s);return}n.sort((u,c)=>u.par0-c.par0);let o=[s.parStart],a=0;for(;a<n.length;a++){let u=n[a];u.par0>o[o.length-1]+A.distanceEpsilon&&o.push(u.par0)}for(s.parEnd>o[o.length-1]+A.distanceEpsilon&&o.push(s.parEnd),a=0;a<o.length-1;a++)l(o[a],o[a+1])&&(yield s.trim(o[a],o[a+1]));function l(u,c){let h=s.value(u),d=s.value(c),f=Math.min(t,h.sub(d).length/10),p=dy(u,h,c,d,s,f);if(p.length===2)return!0;for(let S=1;S<p.length-1;S++){let x=p[S];if(e.containsWithPadding(x,-A.distanceEpsilon))return!0;if(!e.containsWithPadding(x,e.diagonal/10))return!1}return!0}}var re=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}toJSON(){return{points:Array.from(this).map(e=>e.toJSON())}}static fromJSON(e){return re.mkFromPoints(e.points.map(t=>m.fromJSON(t)))}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new m(e,t))}isClockwise(){return m.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new Ut;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=Ut.mkFromPoint(e);t.polyline=this,this.startPoint!=null?m.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let i=t.sub(e).div(2);return Ne.parallelogramByCornerSideSide(e,i,i)}static mkFromPoints(e){let t=new re;for(let i of e)t.addPoint(i);return t}static mkClosedFromPoints(e){let t=re.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],i=this.startPoint,n=0;for(;i.next!=null;){let o=re.parallelogramOfLineSeg(i.point,i.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:D.mkPP(i.point,i.next.point)}}),i=i.next,n++}if(this.isClosed_){let o=re.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:D.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:Ne.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=W.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return m.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new re;t.addPoint(e.start);for(let i of e.segs)t.addPoint(i.end);return t.closed=e.start===e.end,t}trim(e,t){let i=this.toCurve();return i=i.trim(e,t),re.polylineFromCurve(i)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t===this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new re;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t===this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new re;for(let i of this.polylinePoints())t.addPoint(e.multiplyPoint(i.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,i){throw new Error("Method not implemented.")}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0,o=this.startPoint;for(;o.next!=null;){let a=D.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<i&&(i=c,t=l+n),o=o.next,n++}if(this.closed){let a=D.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<i&&(t=l+n)}return t}clone(){let e=new re;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t===this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new L;L.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)L.continueWithLineSegmentP(e,t.point);return this.closed&&L.continueWithLineSegmentP(e,this.startPoint.point),e}};var Pr=class{pad(e){this.width+=e*2}constructor(e,t){this.width=e,this.height=t}},W=class{transform(e){let t=e.multiplyPoint(this.center);return W.mkSizeCenter(this.size,t)}equalEps(e){return le(this.left_,e.left)&&le(this.right_,e.right)&&le(this.top_,e.top)&&le(this.bottom_,e.bottom)}static mkSizeCenter(e,t){let i=e.width/2,n=e.height/2;return new W({left:t.x-i,right:t.x+i,bottom:t.y-n,top:t.y+n})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return W.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=W.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),i=Math.min(this.right,e.right),n=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new W({left:t,bottom:n,right:i,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=this.leftTop.add(this.rightBottom).mul(.5),i=e.sub(t);this.leftTop=this.leftTop.add(i),this.rightBottom=this.rightBottom.add(i)}intersectsOnY(e){return!(e.bottom_>this.top_+A.distanceEpsilon||e.top_<this.bottom_-A.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+A.distanceEpsilon||e.right<this.left_-A.distanceEpsilon)}static mkEmpty(){return new W({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e}get right(){return this.right_}set right(e){this.right_=e}get top(){return this.top_}set top(e){this.top_=e}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e}get leftBottom(){return new m(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new m(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new m(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new m(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}static mkPP(e,t){let i=new W({left:e.x,right:e.x,top:e.y,bottom:e.y});return i.add(t),i}static rectangleOnPoint(e){return new W({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,i){let n=e+i.width,o=t+i.height;return new W({left:e,right:n,top:o,bottom:t})}static getRectangleOnCoords(e,t,i,n){let o=new W({left:e,bottom:t,right:e,top:t});return o.add(new m(i,n)),o}static mkOnPoints(e){let t=W.mkEmpty();for(let i of e)t.add(i);return t}static mkOnRectangles(e){let t=W.mkEmpty();for(let i of e)t.addRecSelf(i);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,i=(this.left_+this.right_)/2;this.left_=i-t,this.right_=i+t}isEmpty(){return this.right<this.left}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,i=(this.top_+this.bottom_)/2;this.top_=i+t,this.bottom=i-t}static rectangleOfTwo(e,t){let i=new W({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return i.addRecSelf(t),i}containsWithPadding(e,t){return this.left_-t-A.distanceEpsilon<=e.x&&e.x<=this.right_+t+A.distanceEpsilon&&this.bottom_-t-A.distanceEpsilon<=e.y&&e.y<=this.top_+t+A.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addWithCheck(e){let t;(t=e.x<this.left_)?this.left_=e.x:(t=this.right_<e.x)&&(this.right_=e.x);let i;return(i=e.y>this.top_)?this.top_=e.y:(i=this.bottom_>e.y)&&(this.bottom=e.y),t||i}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let i=e.clone();return i.center=e.center.add(t),i}static transform(e,t){return W.mkPP(t.multiplyPoint(e.leftTop),t.multiplyPoint(e.rightBottom))}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}containsRectWithPadding(e,t){return this.containsWithPadding(e.leftTop,t)&&this.containsWithPadding(e.rightBottom,t)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?W.mkPP(new m(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new m(Math.min(e.right,t.right),Math.min(e.top,t.top))):W.mkEmpty()}perimeter(){let e=new re;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return new W({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get size(){return new Pr(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let i=e.width/2,n=t.x-i,o=t.x+i,a=e.height/2,l=t.y-a,u=t.y+a;return new W({left:n,right:o,top:u,bottom:l})}addPointWithSize(e,t){let i=e.width/2,n=e.height/2;this.add(new m(t.x-i,t.y-n)),this.add(new m(t.x+i,t.y-n)),this.add(new m(t.x-i,t.y+n)),this.add(new m(t.x+i,t.y+n))}};var gl=class{bind(e){this.entity&&this.entity.setAttr(e,this)}constructor(e,t){this.entity=e,this.bind(t)}};var Ht=class{};Ht.GeomObjectIndex=0,Ht.DrawingObjectIndex=1,Ht.SvgObjectIndex=2,Ht.AlgorithmDataIndex=3;var ke=class extends gl{constructor(e){super(e,Ht.GeomObjectIndex)}static getGeom(e){return e.getAttr(Ht.GeomObjectIndex)}get parent(){let e=this.entity.parent;return e?ke.getGeom(e):null}};var wt=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,i){this.elements[e][t]=i}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return le(this.elements[0][0],1)&&le(this.elements[0][1],0)&&le(this.elements[0][2],0)&&le(this.elements[1][0],0)&&le(this.elements[1][1],1)&&le(this.elements[1][2],0)}offset(){return new m(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new wt(1,0,0,0,1,0)}constructor(e,t,i,n,o,a){this.elements=[[e,t,i],[n,o,a]]}static rotation(e){let t=Math.cos(e),i=Math.sin(e);return new wt(t,-i,0,i,t,0)}static scaleAroundCenterTransformation(e,t,i){let n=1-e,o=1-t;return new wt(e,0,n*i.x,0,t,o*i.y)}multiplyPoint(e){return new m(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new wt(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,i=-this.getElem(0,1)/e,n=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-i*this.getElem(1,2),l=-n*this.getElem(0,2)-o*this.getElem(1,2);return new wt(t,i,a,n,o,l)}};function ln(s){return s.parEnd-s.parStart}function Mp(s){switch(s.type){case"ellipse":return de.fromJSON(s.data);case"curve":return L.fromJSON(s.data);case"lineSegment":return D.fromJSON(s.data);case"bezier":return Ge.fromJSON(s.data);case"polyline":return re.fromJSON(s.data)}}function dM(s){if(s instanceof de)return"ellipse";if(s instanceof L)return"curve";if(s instanceof D)return"lineSegment";if(s instanceof Ge)return"bezier";if(s instanceof re)return"polyline";throw new Error("not implemented")}function Np(s){return{type:dM(s),data:s.toJSON()}}var di=class{static get DifferenceEpsilon(){return di.differenceEpsilon}static EqualPP(e,t){return di.Equal(e.x,t.x)&&di.Equal(e.y,t.y)}static Equal(e,t){return di.Compare(e,t)===0}static Compare(e,t){let i=0;return e+di.DifferenceEpsilon<t?i=-1:t+di.DifferenceEpsilon<e&&(i=1),i}static ComparePP(e,t){let i=di.Compare(e.x,t.x);return i===0&&(i=di.Compare(e.y,t.y)),i}static LessOrEqual(e,t){let i=di.Compare(e,t);return i<0||i===0}static Less(e,t){return di.Compare(e,t)<0}static GetDirections(e,t){return j.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return j.IsPureDirection(di.GetDirections(e,t))}static IsPureDirectionD(e){return j.IsPureDirection(e)}static IsPureLower(e,t){let i=di.GetDirections(e,t);return 2===i||1===i}static GetPureDirectionVV(e,t){return di.GetDirections(e.point,t.point)}},k=di;k.differenceEpsilon=A.distanceEpsilon/2;var j=class{constructor(e){this.Dir=e}get Right(){return new j(j.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>k.DifferenceEpsilon?t=2:e.x<-k.DifferenceEpsilon&&(t=8),e.y>k.DifferenceEpsilon?t=t|1:e.y<-k.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let i=0,n=t.x-e.x,o=t.y-e.y;return n>k.DifferenceEpsilon?i=2:-n>k.DifferenceEpsilon&&(i=8),o>k.DifferenceEpsilon?i|=1:-o>k.DifferenceEpsilon&&(i|=4),i}static DirectionFromPointToPoint(e,t){return j.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return j.IsPureDirection(j.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e===t||e===j.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)===2&&e++,(this.Dir&1)===1&&t++,(this.Dir&8)===8&&e--,(this.Dir&4)===4&&t--,new m(e,t)}static toPoint(e){return new j(e).ToPoint()}static negate(e){return new j(j.OppositeDir(e.Dir))}};var Lo=class{static mkEllipse(e,t,i){return de.mkFullEllipseNNP(e,t,i)}static createParallelogram(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y,u=80*Math.PI/180,c=n/Math.tan(u);return re.mkClosedFromPoints([new m(-o-c+a,-n+l),new m(o+a,-n+l),new m(o+a+c,n+l),new m(-o+a,n+l)])}static createHexagon(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y;return re.mkClosedFromPoints([new m(-o+a,-n+l),new m(o+a,-n+l),new m(o+(n+a),0+l),new m(o+a,n+l),new m(-o+a,n+l),new m(-(o-n)+a,0+l)])}static createOctagon(e,t,i){let n=e/2,o=t/2,a=new Array(8);a[0]=new m(n+Lo.octagonPad*n,o-o*Lo.octagonPad),a[3]=new m(a[0].x*-1,a[0].y),a[4]=new m(a[3].x,a[3].y*-1),a[7]=new m(a[0].x,a[0].y*-1),a[1]=new m(n-n*Lo.octagonPad,o+o*Lo.octagonPad),a[2]=new m(a[1].x*-1,a[1].y),a[6]=new m(a[1].x,a[1].y*-1),a[5]=new m(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(i);return re.mkClosedFromPoints(a)}static createInvertedHouse(e,t,i){let n=Lo.createHouse(e,t,i);return Lo.rotateCurveAroundCenterByDegree(n,i,180)}static createHouse(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new L;return L.addLineSegmentCNNNN(u,a-n,l-o,a+n,l-o),L.continueWithLineSegmentNN(u,a+n,l+o),L.continueWithLineSegmentNN(u,a,l+2*o),L.continueWithLineSegmentNN(u,a-n,l+o),L.closeCurve(u)}static CreateDiamond(e,t,i){let n=e,o=t,a=i.x,l=i.y,u=new L,c=[new m(a,l-o),new m(a+n,l),new m(a,l+o),new m(a-n,l)];return u.addSegs([D.mkPP(c[0],c[1]),D.mkPP(c[1],c[2]),D.mkPP(c[2],c[3]),D.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,i){return Lo.rotateCurveAroundCenterByRadian(e,t,i*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,i){let n=Math.cos(i),o=Math.sin(i),a=new wt(1,0,t.x,0,1,t.y).multiply(new wt(n,-o,0,o,n,0)).multiply(new wt(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return de.mkCircle(e,t)}static createRectangle(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new L,c=[new m(a-n,l-o),new m(a+n,l-o),new m(a+n,l+o),new m(a-n,l+o)];return u.addSegs([D.mkPP(c[0],c[1]),D.mkPP(c[1],c[2]),D.mkPP(c[2],c[3]),D.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof L))return;let t=e.segs;if(t.length!==8&&t.length!==4)return;let i=t.length===8,n,o;for(let a=0;a<4;a++){let l=i?2*a+1:a;if(a===0){if(!(t[l]instanceof de))return;let u=t[l];n=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof de))return;let u=t[l];if(n!==u.aAxis.length||o!==u.bAxis.length)return}}return{radX:n,radY:o}}static mkRectangleWithRoundedCorners(e,t,i,n,o=new m(0,0)){if(i===0||n===0)return Lo.createRectangle(e,t,o);let a=new L,l=e/2;i>l/2&&(i=l/2);let u=t/2;n>u/2&&(n=u/2);let c=o.x,h=o.y,d=l-i,f=u-n,p=h+u,S=h-u,x=c-l,T=c+l,O=new m(i,0),M=new m(0,n);return d>0&&a.addSegment(D.mkPP(new m(c-d,S),new m(c+d,S))),a.addSegment(de.mkEllipse(1.5*Math.PI,2*Math.PI,O,M,c+d,h-f)),f>0&&a.addSegment(D.mkPP(new m(T,h-f),new m(T,h+f))),a.addSegment(de.mkEllipse(0,.5*Math.PI,O,M,c+d,h+f)),d>0&&a.addSegment(D.mkPP(new m(c+d,p),new m(c-d,p))),a.addSegment(de.mkEllipse(.5*Math.PI,Math.PI,O,M,c-d,h+f)),f>0&&a.addSegment(D.mkPP(new m(x,h+f),new m(x,h-f))),a.addSegment(de.mkEllipse(Math.PI,1.5*Math.PI,O,M,c-d,h-f)),a}},we=Lo;we.octagonPad=1/4;var tc=class extends ke{constructor(){super(...arguments);this.padding=1}translate(e){if(e.x===0&&e.y===0)return;let t=new wt(1,0,e.x,0,1,e.y);this.transform(t)}toJSON(){return{boundaryCurve:this.boundaryCurve,padding:this.padding}}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(e){(e!=null&&e.boundingBox.height<tc.minHeight||e.boundingBox.width<tc.minWidth)&&(e=we.mkCircle(tc.minWidth,e.boundingBox.center)),this._boundaryCurve=e}get id(){return this.node.id}toString(){return this.id}static mkNode(e,t){let i=new tc(t);return i.boundaryCurve=e,i}get center(){return this.boundaryCurve.boundingBox.center}set center(e){let t=e.sub(this.center);this.boundaryCurve.translate(t)}fitBoundaryCurveToTarget(e){if(this.boundaryCurve!=null){let t=we.isRoundedRect(this.boundaryCurve);if(t==null){let i=e.width/this.boundaryCurve.boundingBox.width,n=e.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(i,n),this.boundaryCurve.translate(e.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=we.mkRectangleWithRoundedCorners(e.width,e.height,t.radX,t.radY,e.center)}}*inEdges(){for(let e of this.node.inEdges)yield ke.getGeom(e)}*outEdges(){for(let e of this.node.outEdges)yield ke.getGeom(e)}*selfEdges(){for(let e of this.node.selfEdges)yield ke.getGeom(e)}get boundingBoxWithPadding(){let e=this.boundingBox.clone();return e.pad(this.padding),e}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(e){!this.boundaryCurve||(Math.abs(e.width-this.width)<1e-4&&Math.abs(e.height-this.height)<1e-4?this.center=e.center:this.fitBoundaryCurveToTarget(e))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(e){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e))}underCollapsedGraph(){let e=this.node.parent;if(e==null)return!1;let t=Ie.getGeom(e);return t==null?!1:t.isCollapsed?!0:t.underCollapsedGraph()}*getAncestors(){for(let e of this.node.getAncestors())yield ke.getGeom(e)}},ft=tc;ft.minHeight=2,ft.minWidth=3;var at=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new at;return t.point=e,t}static mkSiteSP(e,t){let i=new at;return i.point=t,i.prev=e,e.next=i,i}static mkSiteSPS(e,t,i){let n=new at;return n.prev=e,n.point=t,n.next=i,e.next=n,i.prev=n,n}get turn(){return this.next==null||this.prev==null?0:m.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new at;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var xt=class{static mkFromPoints(e){let t=null,i=null;for(let n of e)if(i==null)i=at.mkSiteP(n),t=new xt(i);else{let o=at.mkSiteP(n);o.prev=i,i.next=o,i=o}return t}clone(){let e=this.headSite,t=null,i,n=null;for(;e!=null;)i=e.clone(),i.prev=t,t!=null?t.next=i:n=i,e=e.next,t=i;return new xt(n)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield D.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new L,t=this.headSite,i;do{let n=L.findCorner(t);if(n==null)break;let o=xt.createBezierSegOnSite(n.b);e.segs.length===0?m.closeDistEps(t.point,o.start)||L.addLineSegment(e,t.point,o.start):m.closeDistEps(e.end,o.start)||L.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=n.b}while(!0);return e.segs.length===0?m.closeDistEps(t.point,t.next.point)?e.segs.push(new Ge(t.point,t.point.add(new m(5,5)),t.point.add(new m(-5,5)),i.point)):L.addLineSegment(e,t.point,t.next.point):m.closeDistEps(e.end,t.next.point)||L.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,i=e.nextBezierCoefficient,n=e.prev,o=e.next,a=n.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(i).add(e.point.mul(1-i)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Ge.mkBezier([a,u,c,l])}};var Xe=class extends ke{constructor(e){super(e);this.lineWidth=1}RaiseLayoutChangeEvent(e){this.edge.raiseEvents(e)}requireRouting(){this.curve=null,this.underlyingPolyline=null}get sourcePort(){return this._sourcePort}set sourcePort(e){this._sourcePort=e}get targetPort(){return this._targetPort}set targetPort(e){this._targetPort=e}translate(e){if(!(e.x===0&&e.y===0)){if(this.curve!=null&&this.curve.translate(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,i=this.smoothedPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=i.point.add(e);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(e)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(e)),this.label&&this.label.translate(e)}}GetMaxArrowheadLength(){let e=0;return this.sourceArrowhead!=null&&(e=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>e?this.targetArrowhead.length:e}transform(e){if(this.curve!=null){if(this.curve=this.curve.transform(e),this.underlyingPolyline!=null)for(let t=this.underlyingPolyline.headSite,i=this.underlyingPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=e.multiplyPoint(t.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=e.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=e.multiplyPoint(this.targetArrowhead.tipPosition)),this.label&&this.label.transform(e)}}get labelBBox(){return this.label.boundingBox}get edge(){return this.entity}get source(){return ke.getGeom(this.edge.source)}*sourceArrowheadPoints(e){if(this.sourceArrowhead==null)return;yield this.sourceArrowhead.tipPosition;let t=this.sourceArrowhead.tipPosition.sub(this.curve.start);t=t.rotate90Cw().mul(Math.tan(e*.5*(Math.PI/180))),yield t.add(this.curve.start),yield this.curve.start.sub(t)}*targetArrowheadPoints(e){if(this.targetArrowhead==null)return;yield this.targetArrowhead.tipPosition;let t=this.targetArrowhead.tipPosition.sub(this.curve.end);t=t.rotate90Cw().mul(Math.tan(e*.5*(Math.PI/180))),yield t.add(this.curve.end),yield this.curve.end.sub(t)}get boundingBox(){let e=W.mkEmpty();if(this.underlyingPolyline!=null)for(let i of this.underlyingPolyline)e.add(i);this.curve!=null&&e.addRecSelf(this.curve.boundingBox);for(let i of this.sourceArrowheadPoints(25))e.add(i);for(let i of this.targetArrowheadPoints(25))e.add(i);this.label&&e.addRecSelf(this.label.boundingBox);let t=this.lineWidth;return e.left-=t,e.top+=t,e.right+=t,e.bottom-=t,e}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return ke.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(e,t,i){let n=e.boundingBox.width,o=e.boundingBox.height,a=e.boundingBox.center,l=new m(a.x-n/4,a.y),u=new m(a.x-n/4,a.y-o/2-t),c=new m(a.x+n/4,a.y-o/2-t),h=new m(a.x+n/4,a.y);return i.smoothedPolyline=xt.mkFromPoints([l,u,c,h]),i.smoothedPolyline.createCurve()}underCollapsedGraph(){return this.source.underCollapsedGraph()||this.target.underCollapsedGraph()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var ye=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var py=class{},rc=py;rc.GoldenRatio=(1+Math.sqrt(5))/2,rc.GoldenRatioRemainder=2-py.GoldenRatio;var ia=class extends ye{constructor(e,t){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=e,this.desiredAspectRatio=t}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(e,t,i){let n=ia.GetGoldenSectionStep(e,t),o=Math.max(i/10,(t-e)/ia.MaxSteps);t+=o,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length===1?this.PackLimit(e):this.rectangles.length===2?(this.PackLimit(e),this.PackLimit(t)):this.rectangles.length>2&&ia.GoldenSectionSearch(l=>this.PackLimit(l),e,n,t,o);let a=this.bestPacking.getRects();for(let l=0;l<this.rectangles.length;l++)this.rectangles[l]=a[l]}PackLimit(e){let t=this.cachedCosts.get(e);if(t==null){let i=this.createPacking(this.rectangles,e);i.run(),this.cachedCosts.set(e,t=Math.abs(i.PackedAspectRatio-this.desiredAspectRatio)),t<this.bestPackingCost&&(this.bestPackingCost=t,this.bestPacking=i)}return t}static GoldenSectionSearch(e,t,i,n,o){if(Math.abs(t-n)<o)return e(t)<e(n)?t:n;let a=ia.GetGoldenSectionStep(i,n),l=e(i),u=e(a),c=()=>ia.GoldenSectionSearch(e,a,i,t,o),h=()=>ia.GoldenSectionSearch(e,i,a,n,o);if(u<l)return h();if(u>l)return c();let d=h(),f=c();return e(f)<e(d)?f:d}static GetGoldenSectionStep(e,t){return e<t?e+rc.GoldenRatioRemainder*(t-e):e-rc.GoldenRatioRemainder*(e-t)}},Bp=ia;Bp.MaxSteps=1e3;var jC=me(un());var my=class extends ye{get PackedWidth(){return this.packedWidth}set PackedWidth(e){this.packedWidth=e}get PackedHeight(){return this.packedHeight}set PackedHeight(e){this.packedHeight=e}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let e=[];for(let[t,i]of this.rectsToCenters)t.center=i,e.push(t);return e}};var ic=class extends my{constructor(e,t,i=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=i?e:ic.SortRectangles(e),this.wrapWidth=t}static SortRectangles(e){return e.sort((t,i)=>i.height-t.height),e}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let e=new jC.Stack,t=!1,i=0,n=0,o=0,a=this.rectanglesByDescendingHeight;for(let l=0;t||l<a.length;){let u=a[l],c=e.length>0?e.top:null;if(c==null||c.right+u.width<=this.wrapWidth&&i+u.height<=c.top){let d=new m(c?c.right:0,i).add(new m(u.width/2,u.height/2));u.center=d,this.rectsToCenters.set(u,d),n=Math.max(n,u.right),o=Math.max(o,u.top),e.push(u),t=!1}else i=c.top,e.pop(),t=!0;t||l++}this.PackedWidth=n,this.PackedHeight=o}};var gd=class extends Bp{constructor(e,t){super(ic.SortRectangles(e),t);this.createPacking=(i,n)=>new ic(i,n,!0)}run(){let e=Number.MAX_VALUE,t=0,i=0;for(let n of this.rectangles){let o=n.width;i+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,i,e)}};var md=me(un());function gM(s,e,t,i,n,o){for(let l=0;l<s.length;l++){if(l===e||l===t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;i.length*2<n.length?(i.push(s[l]),o.box0=u):n.length*2<i.length?(n.push(s[l]),o.box1=h):c<d?(i.push(s[l]),o.box0=u):d<c?(n.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(i.push(s[l]),o.box0=u):(n.push(s[l]),o.box1=h)}}function rt(s){if(s.length===0)return null;if(s.length===1)return s[0];let e={b0:s[0].irect,seed0:1},t=mM(s,e),i=[],n=[];i.push(s[e.seed0]),n.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};gM(s,e.seed0,t,i,n,o);let a=XC(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=rt(i),a.Right=rt(n),a}function qC(s,e){return s.add_rect(e).area}function mM(s,e){let t=qC(e.b0,s[e.seed0].irect);for(let n=2;n<s.length;n++){let o=qC(e.b0,s[n].irect);o>t&&(e.seed0=n,t=o)}let i;for(let n=0;n<s.length;n++)if(n!==e.seed0){i=n;break}t=s[e.seed0].irect.add_rect(s[i].irect).area;for(let n=0;n<s.length;n++){if(n===e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[n].irect).area;o>t&&(i=n,t=o)}return i}function Pd(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(i=>gt(i,e(i)));return rt(t)}function XC(s){let e=new yd;return e.Count=s,e}function gt(s,e){let t=new yd;return t.UserData=s,t.irect=e,t.Count=1,t}function by(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)===0?s.Left!=null?by(s.Left,e,t)===0&&by(s.Right,e,t)===0?0:1:0:1:0}var yd=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent===this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent===this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this===this.Parent.Left}FirstHitNodePF(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)===1?this:null:this:(i=this.Left.FirstHitNodePF(e,t))!=null?i:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)===1?this:null:(i=this.Left.FirstHitNodeWithPredicate(e,t))!=null?i:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t){let i=new md.Stack;for(i.push(this);i.size>0;){let n=i.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?(t==null||t(n.UserData))&&(yield n.UserData):(i.push(n.left),i.push(n.right)))}}*AllHitItems_(e){let t=new md.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.contains_point(e)&&(i.IsLeaf?yield i.UserData:(t.push(i.left),t.push(i.right)))}}VisitTree(e,t){by(this,e,t)}Clone(){let e=XC(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new md.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?yield i:(t.push(i.left),t.push(i.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new md.Stack;for(t.push(this);t.size>0;){let i=t.pop();(i.IsLeaf||!e)&&(yield i),i.IsLeaf||(t.push(i.left),t.push(i.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function Oo(s){return new ml(rt(s.map(([e,t])=>gt(t,e))))}function bM(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function YC(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function PM(s,e){let t=new Array;for(let n of s.GetAllLeafNodes())n!==e&&t.push(n);let i=rt(t);s.Count=i.Count,s.Left=i.Left,s.Right=i.Right,s.irect=i.Left.irect.add_rect(i.Right.irect)}function yM(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!KC(e))return e;return null}function KC(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function Py(s,e,t,i){return s.irect.intersects_rect(e)?s.IsLeaf?i(s.UserData)?--t.bound!==0:!0:Py(s.Left,e,t,i)&&Py(s.Right,e,t,i):!0}var ml=class{Clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,i){return Py(this._rootNode,e,{bound:t},i)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(gt(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=rt(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=rt(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=gt(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let i,n;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{i=t.Left.irect.add_rect(e.irect);let o=i.area-t.Left.irect.area;n=t.Right.irect.add_rect(e.irect);let a=n.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n):i.area<n.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count===0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count===0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count===0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count===0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(i.UserData===t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let i;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))n.UserData===t&&(i=n);if(i!=null)return this.RootNode.Count===1?this.RootNode=null:this.RemoveLeaf(i),i.UserData}RemoveLeaf(e){let t=yM(e);if(t!=null)PM(t,e),YC(t);else{let i=e.Parent;i==null?this._rootNode=new yd:(bM(i,e.IsLeftChild?i.Right:i.Left),YC(i))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!KC(t))return t;return null}};var yy=class extends W{isOk(){return this.isEmpty()?!0:this.roundedRect_.boundingBox.equalEps(this)}setRect(e){super.left_=e.left,super.right_=e.right,super.top_=e.top,super.bottom_=e.bottom,this.isEmpty()||(this.roundedRect_=we.mkRectangleWithRoundedCorners(e.width,e.height,this.radX,this.radY,super.center))}constructor(e){super(e);this.radX=e.radX,this.radY=e.radY,this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,e.radX,e.radY,super.center)}get center(){return super.center}set center(e){super.center=e,this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,this.radX,this.radY,super.center)}get left(){return super.left}set left(e){super.left=e,this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,this.radX,this.radY,super.center)}get right(){return super.right}set right(e){super.right=e,this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,this.radX,this.radY,super.center)}get top(){return super.top}set top(e){super.top=e,this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,this.radX,this.radY,super.center)}get bottom(){return super.bottom}set bottom(e){super.bottom=e,this.isEmpty||(this.roundedRect_=we.mkRectangleWithRoundedCorners(super.width,super.height,this.radX,this.radY,super.center))}};function Dp(s,e){let t=e.map(o=>[o,o.boundingBox]),i=t.map(o=>o[1]),n=new gd(i,1.5);n.run();for(let[o,a]of t){let l=a.leftBottom.sub(o.boundingBox.leftBottom);o.translate(l)}s.boundingBox=new W({left:0,bottom:0,right:n.PackedWidth,top:n.PackedHeight})}var Ie=class extends ft{constructor(e){super(e);this.ignoreBBoxCheck=!1;this.margins={left:10,top:10,bottom:10,right:10};this._isCollapsed=!1;this.radX=10;this.radY=10;this.rrect=new yy({left:0,right:-1,top:20,bottom:0,radX:this.radX,radY:this.radY})}*allSuccessorsWidthFirst(){for(let e of this.graph.allSuccessorsWidthFirst())yield ft.getGeom(e)}calculateBoundsFromChildren(){let e=W.mkEmpty();for(let t of this.shallowNodes)e.addRecSelf(t.boundingBoxWithPadding);return e.padEverywhere(this.margins),e}get isCollapsed(){return this._isCollapsed}set isCollapsed(e){this._isCollapsed=e}static getGeom(e){return ke.getGeom(e)}edgeCurveOrArrowheadsIntersectRect(e,t){for(let o of e.sourceArrowheadPoints(25))if(t.contains(o))return!0;for(let o of e.targetArrowheadPoints(25))if(t.contains(o))return!0;let i=e.curve,n=t.perimeter();return L.intersectionOne(i,n,!1)!=null||L.PointRelativeToCurveLocation(i.start,n)===2}*intersectedObjects(e,t,i=!0){let n=e.GetAllIntersecting(t);if(i)for(let o of n)o instanceof ft&&(yield o);else for(let o of n)(o instanceof ft||o instanceof Xe)&&(yield o)}buildRTree(){let e=Array.from(this.deepNodes).concat(Array.from(this.deepEdges)).map(t=>[t.boundingBox,t]);return Oo(e)}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(e){this.layoutSettings=e;for(let t of this.deepNodes){let i=t;i.layoutSettings=e}}get layoutSettings(){return this._layoutSettings}set layoutSettings(e){this._layoutSettings=e}get labelSize(){return this._labelSize}set labelSize(e){this._labelSize=e}get boundingBox(){return this.rrect?this.rrect.clone():null}set boundingBox(e){e?this.rrect.setRect(e):this.rrect.roundedRect_=null}transform(e){if(!e.isIdentity()){for(let t of this.shallowNodes)t.transform(e);for(let t of this.edges())t.transform(e);this.boundingBox=this.rrect==null||this.rrect.isEmpty()?this.pumpTheBoxToTheGraphWithMargins():this.boundingBox.transform(e)}}get deepNodes(){return this.deepNodesIt()}*deepNodesIt(){for(let e of this.graph.deepNodes)yield ke.getGeom(e)}setEdge(e,t){let i=this.graph.setEdge(e,t);return new Xe(i)}pumpTheBoxToTheGraphWithMargins(){let e={b:W.mkEmpty()};return Sy(this,e),e.b.padEverywhere(this.margins),this.boundingBox=e.b}get center(){return this.boundingBox||this.boundingBox.isEmpty?this.boundingBox.center:new m(0,0)}set center(e){let t=e.sub(this.center),i=new wt(1,0,t.x,0,1,t.y);this.transform(i)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}get boundaryCurve(){return this.rrect.roundedRect_}set boundaryCurve(e){throw new Error}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.graph.shallowNodes)yield ke.getGeom(e)}*edges(){for(let e of this.graph.edges)yield ke.getGeom(e)}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let e of this.graph.deepEdges)yield ke.getGeom(e)}static mk(e,t=new Pr(0,0)){let i=new Ie(new Te(e));return i.labelSize=t,i}get Clusters(){return this.subgraphs()}*subgraphs(){for(let e of this.graph.subgraphs())yield ke.getGeom(e)}static mkWithGraphAndLabel(e,t){let i=new Ie(e);return i.labelSize=t,i}get deepNodeCount(){let e=0;for(let t of this.graph.deepNodes)e++;return e}get subgraphsDepthFirst(){return this.getSubgraphsDepthFirst()}*getSubgraphsDepthFirst(){for(let e of this.graph.allSuccessorsDepthFirst())e instanceof Te&&(yield Ie.getGeom(e))}get uniformMargins(){return Math.max(this.margins.left,this.margins.right,this.margins.right,this.margins.bottom)}set uniformMargins(e){this.margins.left=this.margins.right=this.margins.right=this.margins.bottom=e}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(e){let t=this.graph.liftNode(e.node);return t?ke.getGeom(t):null}findNode(e){let t=this.graph.findNode(e);return t?ke.getGeom(t):null}addNode(e){return this.graph.addNode(e.node),e}addLabelToGraphBB(e){this.labelSize&&(e.top+=this.labelSize.height+2,e.width<this.labelSize.width&&(e.width=this.labelSize.width))}FlipYAndMoveLeftTopToOrigin(){let e=this.boundingBox,t=new wt(1,0,-e.left,0,-1,e.top);this.transform(t)}};function Sy(s,e){for(let t of s.edges())if(!t.underCollapsedGraph()&&t.curve!=null){let i=t.curve.boundingBox;e.b.addRecSelf(i),t.label!=null&&e.b.addRecSelf(t.label.boundingBox)}for(let t of s.shallowNodes)t.underCollapsedGraph()||!t.boundingBox||e.b.addRecSelf(t.boundingBox);s instanceof Ie&&s.addLabelToGraphBB(e.b)}var bl=class{constructor(e,t){this._isPositioned=!1;e&&(this.boundingBox=W.mkPP(new m(0,0),new m(e.width,e.height))),this.parent=t}get isPositioned(){return this._isPositioned}set isPositioned(e){this._isPositioned=e}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}setBoundingBox(e){this.isPositioned=!0,this._boundingBox=e}get width(){return this.boundingBox.width}set width(e){this.boundingBox.width=e}get height(){return this.boundingBox.height}set height(e){this.boundingBox.height=e}get center(){return this.boundingBox.center}set center(e){this.boundingBox.center=e}translate(e){this.isPositioned&&(this.center=this.center.add(e))}transform(e){this.isPositioned&&(this.center=e.multiplyPoint(this.center))}positionCenter(e){this.boundingBox.center=e,this.isPositioned=!0}};var ZC=me(gs());function nc(s){let e=new yr;return e.SetEdges(s,yr.vertexCount(s)),e}function Fp(s){let e=new yr;return e.SetEdges(s,yr.vertexCount(s)),e}function Sr(s,e){let t=new yr;return t.SetEdges(s,e),t}var yr=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let i=e.indexOf(t,0);i>-1&&e.splice(i,1)}removeEdge(e){yr.deleteFromArray(this.edges,e),e.source!==e.target?(yr.deleteFromArray(this.outEdges[e.source],e),yr.deleteFromArray(this.inEdges[e.target],e)):yr.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let i of e)i.source>=t&&(t=i.source),i.target>=t&&(t=i.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let i=new Array(this.nodeCount).fill(0),n=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!==a.target?(i[a.source]++,n[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(i[a]),i[a]=0,this.inEdges[a]=new Array(n[a]),n[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!==u?(this.outEdges[l][i[l]++]=a,this.inEdges[u][n[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!==e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length===0)return;let e=new Set,t=new ZC.Queue,i=this.edges[0].source;for(yr.enqueue(e,t,i),yield i;t.length>0;){i=t.dequeue();for(let n of this.outEdges[i]){let o=n.target;e.has(o)||(yr.enqueue(e,t,o),yield o)}for(let n of this.inEdges[i]){let o=n.source;e.has(o)||(yr.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,i){t.enqueue(i),e.add(i)}};var Se=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x===this.y}};var QC=me(un());var Un=class{set(e,t,i){this.arrayOfMaps[e].set(t,i)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield new Se(e,i[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield[new Se(e,i[0]),i[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield i[1]}}};var JC=class{constructor(e,t){this.v=e,this.i=t}},Ui=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,i,n){t[i]=1,e.push(new JC(i,n))}static getFeedbackSet(e){let t=new Un(e.nodeCount);if(e==null||e.nodeCount===0)return[];let i=new Array(e.nodeCount).fill(0);for(let n=0;n<e.nodeCount;n++){if(i[n]===2)continue;let o=new QC.Stack,a=0;for(Ui.push(o,i,n,a);o.size>0;){let l=o.pop();n=l.v,i[n]=2,a=l.i;let u=e.outEdges[n];for(;a<u.length;a++){let c=u[a];if(c.source===c.target)continue;let h=i[c.target];h===1?t.set(c.source,c.target,c):h===0&&(Ui.push(o,i,n,a+1),n=c.target,i[c.target]=2,u=e.outEdges[n],a=-1)}}}return Array.from(t.values())}};var $C=me(tr()),Wi=class{constructor(e,t,i,n=1){this.Source=e,this.Target=t,this.CrossingWeight=i,this.Weight=n}toString(){return $C.String.Format("{0}->{1}",this.Source,this.Target)}};var Pl=class{static FindClosestPoints(e,t){let i=L.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(i)return{curveClosestPoint:i.aX,labelSideClosest:i.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof L){for(let i of e.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static ShiftLabel(e,t,i){let n=e.lineWidth/2,o=t.sub(i),a=o.length;a>n&&e.label.positionCenter(e.label.center.add(o.div(a*(a-n))))}static updateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new m(t.x+t.rightAnchor/2,t.y)),i=D.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new m(t.x-t.leftAnchor/2,t.y)),i=D.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=Pl.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&L.getAllIntersections(e.curve,L.polyFromBox(e.labelBBox),!1).length===0){let o=Pl.FindClosestPoints(n,i);if(o)Pl.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=n.closestParameter(i.start),c=n.closestParameter(i.end);n.value(u).sub(i.start).length<n.value(c).sub(i.end).length?(a=n.value(u),l=i.start):(a=n.value(c),l=i.end),Pl.ShiftLabel(e,a,l)}}}},Yr=class{constructor(e,t,i,n=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=i,this.weight=n,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.underlyingPolyline}set underlyingPolyline(e){this.edge.underlyingPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source===this.target}reversedClone(){let e=new Yr(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let i=0;i<t;i++){let n=this.LayerEdges[t-1-i];e.LayerEdges[i]=new Wi(n.Target,n.Source,n.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e===this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,i=this.LayerEdges[t];Pl.updateLabel(this.edge,e[i.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var wr=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let i=this.arrayOfSets[e];return i!==void 0&&i.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new wr;for(let i of e)t.add(i);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let i of t.values())yield new Se(e,i)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let i=this.arrayOfSets[e];i==null&&(this.arrayOfSets[e]=i=new Set),i.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var tv=me(gs());function*Wn(s){let e=new Array(s.nodeCount).fill(!1),t=new tv.Queue;for(let i=0;i<s.nodeCount;i++)if(!e[i]){let n=new Array;for(ev(i,t,e);t.length>0;){let o=t.dequeue();n.push(o);for(let a of EM(s,o))ev(a,t,e)}yield n}}function*EM(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function ev(s,e,t){t[s]===!1&&(e.enqueue(s),t[s]=!0)}var Ey=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new wr;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size===0&&this.minLayerOfGeomGraph.size===0&&this.sameLayerConstraints.length===0&&this.upDownConstraints.length===0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=Sr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=Ui.getFeedbackSetWithConstraints(e,null);for(let i of t)this.gluedUpDownIntConstraints.remove(i)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new Se(this.maxRepresentative,t))}if(this.minRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.minRepresentative&&this.gluedUpDownIntConstraints.add(new Se(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new wr}gluedIntPairNN(e){return new Se(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new Se(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new Se(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),i=this.nodeToRepr(e.target),n=new Yr(t,i,e.edge);return n.separation=e.separation,n.weight=0,n}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Wn(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return Sr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!==-1&&this.maxLayerInt.filter(t=>t!==this.maxRepresentative).map(t=>new Se(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!==-1&&this.minLayerInt.filter(t=>t!==this.minRepresentative).map(t=>new Se(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new Se(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.minRepresentative);else for(let i of e)t===-1&&(t=i),this.sameLayerDictionaryOfRepresentatives.set(i,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative===t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative===t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!==-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(Ui.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let i of this.unglueEdge(t))yield i}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let i of this.intGraph.outEdges[t])this.nodeToRepr(i.target)===e.target&&(yield i)}createGluedGraph(){let e=new wr;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),Sr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function xM(s,e){return[s,e]}var xy=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length===0&&this.upDownVerticalConstraints.length===0&&this.leftRightConstraints.length===0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length===0&&!this.nodeToBlockRoot.has(t)){let i=new Array,n=t;for(let o=e.outEdges[n];o.length>0;o=e.outEdges[n])n=o[0].y,i.push(n),this.nodeToBlockRoot.set(n,t);i.length>0&&this.BlockRootToBlock.set(t,i)}}BasicGraphFromLeftRightIntNeibs(){return nc(Array.from(this.LeftRightIntNeibs.values()).map(e=>new Se(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=wr.mk(this.leftRightConstraints.map(t=>xM(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new Se(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!==t.x));let e=Ui.getFeedbackSet(nc(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new Se(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=wr.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new Se(t[0],t[1]))),this.VerticalInts=wr.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1&&e[t[0]]>e[t[1]]).map(t=>new Se(t[0],t[1])))}};var sc=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(sc||{});var Hn=class{constructor(){this.capacityOverflowCoefficient=Hn.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=Hn.DefaultPathLengthImportance;this.inkImportance=Hn.DefaultInkImportance;this.edgeSeparation=Hn.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.useCubicBezierSegmentsInsideOfHubs=!1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}toJSON(){let e={};return this.capacityOverflowCoefficient!=Hn.DefaultCapacityOverflowCoefficientMultiplier&&(e.capacityOverflowCoefficient=this.capacityOverflowCoefficient),this.RotateBundles&&(e.RotateBundles=this.RotateBundles),this.MaxHubRadius!=50&&(e.MaxHubRadius=this.MaxHubRadius),this.MinHubRadius!=.1&&(e.MinHubRadius=this.MinHubRadius),this.CreateUnderlyingPolyline&&(e.CreateUnderlyingPolyline=this.CreateUnderlyingPolyline),this.pathLengthImportance!=Hn.DefaultPathLengthImportance&&(e.pathLengthImportance=this.pathLengthImportance),this.inkImportance!=Hn.DefaultInkImportance&&(e.inkImportance=this.inkImportance),this.edgeSeparation!=Hn.DefaultEdgeSeparation&&(e.edgeSeparation=this.edgeSeparation),this._edgeWidthShrinkCoeff!=1&&(e._edgeWidthShrinkCoeff=this._edgeWidthShrinkCoeff),this.useCubicBezierSegmentsInsideOfHubs&&(e.useCubicBezierSegmentsInsideOfHubs=this.useCubicBezierSegmentsInsideOfHubs),this.angleThreshold!=Math.PI/180*45&&(e.angleThreshold=this.angleThreshold),this.hubRepulsionImportance!=100&&(e.hubRepulsionImportance=this.hubRepulsionImportance),this.bundleRepulsionImportance!=100&&(e.bundleRepulsionImportance=this.bundleRepulsionImportance),this.minimalRatioOfGoodCdtEdges!=.9&&(e.minimalRatioOfGoodCdtEdges=this.minimalRatioOfGoodCdtEdges),this.highestQuality||(e.highestQuality=this.highestQuality),this.KeepOverlaps&&(e.KeepOverlaps=this.KeepOverlaps),this.StopAfterShortestPaths&&(e.StopAfterShortestPaths=this.StopAfterShortestPaths),e}static createFromJSON(e){let t=new Hn;return e.capacityOverflowCoefficient&&(t.capacityOverflowCoefficient=e.capacityOverflowCoefficient),e.RotateBundles&&(t.RotateBundles=e.RotateBundles),e.MaxHubRadius&&(t.MaxHubRadius=e.MaxHubRadius),e.MinHubRadius&&(t.MinHubRadius=e.MinHubRadius),e.CreateUnderlyingPolyline&&(t.CreateUnderlyingPolyline=e.CreateUnderlyingPolyline),e.pathLengthImportance&&(t.pathLengthImportance=e.pathLengthImportance),e.inkImportance&&(t.inkImportance=e.inkImportance),e.edgeSeparation&&(t.edgeSeparation=e.edgeSeparation),e._edgeWidthShrinkCoeff&&(t._edgeWidthShrinkCoeff=e._edgeWidthShrinkCoeff),e.useCubicBezierSegmentsInsideOfHubs&&(t.useCubicBezierSegmentsInsideOfHubs=e.useCubicBezierSegmentsInsideOfHubs),e.angleThreshold&&(t.angleThreshold=e.angleThreshold),e.hubRepulsionImportance&&(t.hubRepulsionImportance=e.hubRepulsionImportance),e.bundleRepulsionImportance&&(t.bundleRepulsionImportance=e.bundleRepulsionImportance),e.minimalRatioOfGoodCdtEdges&&(t.minimalRatioOfGoodCdtEdges=e.minimalRatioOfGoodCdtEdges),e.highestQuality&&(t.HighestQuality=e.highestQuality),e.KeepOverlaps&&(t.KeepOverlaps=e.KeepOverlaps),e.StopAfterShortestPaths&&(t.StopAfterShortestPaths=e.StopAfterShortestPaths),t}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},jn=Hn;jn.DefaultCapacityOverflowCoefficientMultiplier=1e3,jn.DefaultPathLengthImportance=500,jn.DefaultInkImportance=.01,jn.DefaultEdgeSeparation=.5;var Ps=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=3;this.polylinePadding=1.5;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}toJSON(){let e={};return this.EdgeRoutingMode!=0&&(e.edgeRoutingMode=0),this.ConeAngle!=30*(Math.PI/180)&&(e.coneAngle=this.ConeAngle),this.padding!=3&&(e.padding=this.padding),this.polylinePadding!=1.5&&(e.polylinePadding=this.polylinePadding),this.bundlingSettings&&(e.bundlingSettingsJSON=this.bundlingSettings.toJSON()),e}static fromJSON(e){let t=new Ps;return e.edgeRoutingMode&&(e.edgeRoutingMode=t.edgeRoutingMode),e.coneAngle&&(t.coneAngle=e.coneAngle),e.padding&&(t.padding=e.padding),e.polylinePadding&&(t.polylinePadding=e.polylinePadding),e.bundlingSettingsJSON&&(t.bundlingSettings=jn.createFromJSON(e.bundlingSettingsJSON)),e.routingToParentConeAngle&&(t.routingToParentConeAngle=e.routingToParentConeAngle),e.simpleSelfLoopsForParentEdgesThreshold&&(t.simpleSelfLoopsForParentEdgesThreshold=e.simpleSelfLoopsForParentEdgesThreshold),e.incrementalRoutingThreshold&&(t.incrementalRoutingThreshold=e.incrementalRoutingThreshold),e.routeMultiEdgesAsBundles&&(t.routeMultiEdgesAsBundles=e.routeMultiEdgesAsBundles),e.KeepOriginalSpline&&(t.KeepOriginalSpline=e.KeepOriginalSpline),t}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e===1&&this.bundlingSettings==null&&this.bundlingSettings==null&&(this.bundlingSettings=new jn),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var qn=class{constructor(){this.edgeRoutingSettings=new Ps;this.nodeSeparation=10;this.packingAspectRatio=1.5}static fromJSON(e){let t=new qn;return e.nodeSeparation!=10&&(t.nodeSeparation=e.nodeSeparation),e.packingAspectRatio&&(t.packingAspectRatio=e.packingAspectRatio),e.edgeRoutingSettings&&(t.edgeRoutingSettings=Ps.fromJSON(e.edgeRoutingSettings)),t}toJSON(){let e=!1,t={};return this.nodeSeparation!=10&&(t.nodeSeparation=this.nodeSeparation,e=!0),this.packingAspectRatio!=1.5&&(t.packingAspectRatio=this.packingAspectRatio,e=!0),(t.edgeRoutingSettings=this.edgeRoutingSettings.toJSON())&&(e=!0),e?t:void 0}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}};var Lr=class{constructor(){this.commonLayoutSettings=new qn;this.verticalConstraints=new Ey;this.horizontalConstraints=new xy;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=wt.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.commonLayoutSettings.edgeRoutingSettings.EdgeRoutingMode=3}get NodeSeparation(){return this.commonLayoutSettings.NodeSeparation}get edgeRoutingSettings(){return this.commonLayoutSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonLayoutSettings.edgeRoutingSettings=e}toJSON(){let e={};return this.sameRanks&&(e.sameRanks=this.sameRanks),this.verticalConstraints&&(e.verticalConstraints=this.verticalConstraints),this.horizontalConstraints&&(e.horizontalConstraints=this.horizontalConstraints),this.NoGainAdjacentSwapStepsBound!=5&&(e.horizontalConstraints=this.horizontalConstraints),this.RepetitionCoefficientForOrdering!=1&&(e.RepetitionCoefficientForOrdering=this.RepetitionCoefficientForOrdering),this.AspectRatio&&(e.AspectRatio=this.AspectRatio),this.MaxNumberOfPassesInOrdering!=24&&(e.MaxNumberOfPassesInOrdering=this.MaxNumberOfPassesInOrdering),this.BrandesThreshold!=600&&(e.BrandesThreshold=this.BrandesThreshold),this.LabelCornersPreserveCoefficient!=.1&&(e.LabelCornersPreserveCoefficient=this.LabelCornersPreserveCoefficient),this.MinNodeHeight!=72*.5/4&&(e.MinNodeHeight=this.MinNodeHeight),this.MinNodeWidth!=72*.75/4&&(e.MinNodeWidth=this.MinNodeWidth),this.SnapToGridByY!=0&&(e.SnapToGridByY=this.SnapToGridByY),this.yLayerSep!=10*3&&(e.yLayerSep=this.yLayerSep),this.transform&&(e.transform=this.transform.elements),this.GridSizeByY&&(e.GridSizeByY=this.GridSizeByY),this.GridSizeByX&&(e.GridSizeByX=this.GridSizeByX),e.commonLayoutSettings=this.commonLayoutSettings.toJSON(),e}static fromJSON(e){let t=new Lr;return e.sameRanks&&(t.sameRanks=e.sameRanks),e.verticalConstraints&&(t.verticalConstraints=e.verticalConstraints),e.horizontalConstraints&&(t.horizontalConstraints=e.horizontalConstraints),e.NoGainAdjacentSwapStepsBound&&(t.horizontalConstraints=e.horizontalConstraints),e.RepetitionCoefficientForOrdering&&(t.RepetitionCoefficientForOrdering=e.RepetitionCoefficientForOrdering),e.AspectRatio&&(t.AspectRatio=e.AspectRatio),e.MaxNumberOfPassesInOrdering&&(t.MaxNumberOfPassesInOrdering=e.MaxNumberOfPassesInOrdering),e.BrandesThreshold&&(t.BrandesThreshold=e.BrandesThreshold),e.LabelCornersPreserveCoefficient&&(t.LabelCornersPreserveCoefficient=e.LabelCornersPreserveCoefficient),e.MinNodeHeight&&(t.MinNodeHeight=e.MinNodeHeight),e.MinNodeWidth&&(t.MinNodeWidth=t.MinNodeWidth),e.SnapToGridByY&&(t.SnapToGridByY=e.SnapToGridByY),e.yLayerSep&&(t.yLayerSep=e.yLayerSep),e.transform&&(t.transform=new wt(e.transform[0][0],e.transform[0][1],e.transform[0][2],e.transform[1][0],e.transform[1][1],e.transform[1][2])),e.GridSizeByY&&(t.GridSizeByY=e.GridSizeByY),e.GridSizeByX&&(t.GridSizeByX=e.GridSizeByX),e.commonLayoutSettings&&(t.commonLayoutSettings=qn.fromJSON(e.commonLayoutSettings)),t}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=wt.rotation(e);for(let i=0;i<2;i++)for(let n=0;n<3;n++)if(!le(t.elements[i][n],this.transform.elements[i][n]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=wt.getIdentity();break;case 1:this.transform=wt.rotation(Math.PI/2);break;case 3:this.transform=wt.rotation(-Math.PI/2);break;case 2:this.transform=wt.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var cn=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>A.distanceEpsilon?1:e<-A.distanceEpsilon?-1:0}};var ys=class extends yr{constructor(e,t){super();this.SetEdges(e,t)}};var Cy=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new Un(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let i=new Se(t.source,t.target),n=new Se(t.target,t.source),o=this.Multiedges.get(i.x,i.y);for(let a of o)a.reverse();if(this.Multiedges.has(n.x,n.y)){let a=this.Multiedges.get(n.x,n.y);for(let l of o)a.push(l)}else this.Multiedges.set(n.x,n.y,o);this.Multiedges.delete(i.x,i.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new Se(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function Sd(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var Hi=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length===0&&t++;if(t===0)return this;let i=new Array(this.y.length);for(let a=0;a<i.length;a++)i[a]=this.y[a]-e[this.y[a]];let n=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(n[a-e[a]]=Array.from(this.layers[a]));let o=new Hi(i);return o.layers=n,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)Sd(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let i of e)this.verticesToX[i]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let i=0;i<this.y.length;i++)e[i]=t-this.y[i];return new Hi(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let i of this.y)i+1>e&&(e=i+1);let t=new Array(e).fill(0);for(let i of this.y)t[i]++;this.layers=new Array(e);for(let i=0;i<e;i++)this.layers[i]=new Array(t[i]),t[i]=0;for(let i=0;i<this.y.length;i++){let n=this.y[i];this.layers[n][t[n]++]=i}}};var Ed=class extends ye{constructor(e,t,i,n){super(n);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=i,this.dag=e,this.layering=t,this.Init()}static Balance(e,t,i,n){new Ed(e,t,i,n).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(e){this.jumpers.delete(e);let t=this.possibleJumperFeasibleIntervals.get(e),i=this.CalcJumpInfo(t.x,t.y,e);if(i==null)return;this.layering[e]=i.layerToJumpTo;let n=this.nodeCount[e];this.vertsCounts[i.jumperLayer]-=n,this.vertsCounts[i.layerToJumpTo]+=n,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(i.jumperLayer,e)}IsJumper(e){return this.possibleJumperFeasibleIntervals.has(e)}UpdateRegionsForPossibleJumpersAndInsertJumpers(e,t){let i=new Set;for(let o of this.dag.pred(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));for(let o of this.dag.succ(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));let n=new Array;for(let o of this.possibleJumperFeasibleIntervals)i.has(o[0])||o[1].x>e&&o[1].y<e&&n.push(o[0]);for(let o of n)this.CalculateRegionAndInsertJumper(o)}InitJumpers(){let e=new Array(this.dag.nodeCount).fill(0);for(let t of this.dag.edges)e[t.source]-=t.weight,e[t.target]+=t.weight;this.possibleJumperFeasibleIntervals=new Map;for(let t=0;t<this.dag.nodeCount;t++)e[t]===0&&this.CalculateRegionAndInsertJumper(t)}CalculateRegionAndInsertJumper(e){let t=new Se(this.Up(e),this.Down(e));this.possibleJumperFeasibleIntervals.set(e,t),this.InsertJumper(t.x,t.y,e)}InsertJumper(e,t,i){this.CalcJumpInfo(e,t,i)!=null&&this.jumpers.add(i)}CalcJumpInfo(e,t,i){let n=this.layering[i],o=-1,a=this.vertsCounts[n]-2*this.nodeCount[i];for(let l=e-1;l>n;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);for(let l=n-1;l>t;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);if(o!==-1)return{jumperLayer:n,layerToJumpTo:o}}Up(e){let t=Number.MAX_SAFE_INTEGER;for(let i of this.dag.inEdges[e]){let n=this.layering[i.source]-i.separation+1;n<t&&(t=n)}return t===Number.MAX_SAFE_INTEGER&&(t=this.layering[e]+1),t}Down(e){let t=Number.NEGATIVE_INFINITY;for(let i of this.dag.outEdges[e]){let n=this.layering[i.target]+i.separation-1;n>t&&(t=n)}return t===Number.NEGATIVE_INFINITY&&(t=this.layering[e]-1),t}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let e of this.layering)this.vertsCounts[e]+=this.nodeCount[e]}ChooseJumper(){for(let e of this.jumpers)return e;throw new Error("there are no jumpers to choose")}};var Xn=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i of t.LayerEdges){let n=Math.max(i.Source,i.Target)+1;n>this.totalNumberOfNodes&&(this.totalNumberOfNodes=n)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i=1;i<t.LayerEdges.length;i++){let n=t.LayerEdges[i];this.firstVirtualNode=Math.min(this.firstVirtualNode,n.Source)}this.firstVirtualNode===Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let i of t.LayerEdges)i.Target!==t.target&&(this.virtualNodesToInEdges[i.Target-this.firstVirtualNode]=i),i.Source!==t.source&&(this.virtualNodesToOutEdges[i.Source-this.firstVirtualNode]=i)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield Xn.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield Xn.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new Xn(new ys(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var Ev=me(vd()),ca=class{constructor(e,t,i,n){this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}static InsertLayers(e,t,i,n){let o=new ca(e,t,i,n);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let i=0,n=t[0];if(i=n.LayerSpan*2,i>0){for(let o of n.LayerEdges)o.Target!==n.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(i-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let i=this.la.x[t],n=this.la.y[t],o=this.la.Layers[n];o[i]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges[n];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let i=this.NLayering[t];i%2===1&&(this.Nla.Layers[i][e[i]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!==e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!==e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,i=!0;for(let n of e)if(i&&(i=!1,t=n.LayerSpan*2),t>0){n.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=Mo.GetSource(a,n,o);this.totalNodes=a.currentVV;let u=Mo.GetTarget(this.totalNodes,n,o,t);n.LayerEdges[o]=new Wi(l,u,n.CrossingWeight)}ca.RegisterDontStepOnVertex(this.database,n)}}this.nLayeredGraph=new Xn(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new Ev.SortedMap,i=this.Nla.Layers[e];for(let o of i){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let n=0;for(let o of t.values())if(typeof o=="number")i[n++]=o;else for(let a of o)i[n++]=a;for(let o=0;o<i.length;o++)this.Nla.x[i[o]]=o}}InitNewLayering(){this.Nla=new Hi(new Array(this.totalNodes));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i]*2;for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=this.la.y[i.x]*2;for(let a of n){let l=o-1;for(let u of a.LayerEdges)u.Target!==a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Hi(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let i=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(i.Source)}}};var Mo=class{constructor(e,t,i,n){this.virtNodesToIntEdges=new Map;this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}get NLayering(){return this.Nla.y}static InsertPaths(e,t,i,n){let o=new Mo(e,t,i,n);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(n);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}EdgeIsFlat(e){return this.la.y[e.source]===this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let i of t.LayerEdges)i.Target!==t.target&&this.virtNodesToIntEdges.set(i.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!==t.y){let n=!0,o=0;for(let a of i){if(n)n=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o===1)a.LayerEdges[0]=new Wi(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=Mo.GetSource(u,a,l);e=u.currentVV;let h=Mo.GetTarget(e,a,l,o);a.LayerEdges[l]=new Wi(c,h,a.CrossingWeight)}ca.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new Xn(this.intGraph)}static GetTarget(e,t,i,n){return i<n-1?e:t.target}static GetSource(e,t,i){return i===0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new Hi(new Array(this.NLayeredGraph.NodeCount));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i];for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=0,a=!0;for(let l of n){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Hi(this.NLayering),this.Nla.Layers=e}};var xv=BigInt("6364136223846793005"),By=(BigInt(1)<<BigInt(32))-BigInt(1),Es=(BigInt(1)<<BigInt(64))-BigInt(1),Ad=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&Es,this._random_b(),this._state=this._state+BigInt(e)&Es,this._random_b()}_random_b(){let e=this._state;this._state=e*xv+this._inc&Es;let t=(e>>BigInt(18)^e)>>BigInt(27),i=e>>BigInt(59),n=i^BigInt(31);return(t>>i|t<<n)&By}_advance(e){e&=Es;let t=BigInt(1),i=xv,n=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*i&Es,n=n*i+o&Es),o=(i+BigInt(1))*o&Es,i=i*i&Es,e>>=BigInt(1);this._state=t*this._state+n&Es}randint(e){if(e>By)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),i=(By^t)%t;for(;;){let n=this._random_b();if(n>=i)return Number(n%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var Il;function ha(s){return Il==null&&(Il=new Ad(0,0)),Il.randint(s)}function Yp(s){Il=new Ad(s,0)}function Td(){return Il==null&&(Il=new Ad(0,0)),Il.random()}var Kp=class{constructor(e,t,i){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=i}LayerGroupDisbalance(e,t,i){return t===1?this.LayerGroupDisbalanceWithOrigSeparators(e,i):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentOrigGroupDelta(n,e,t);n=o.i,i+=o.ret}return i}CurrentOrigGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentVirtGroupDelta(n,e,t);i+=o.ret,n=o.i}return i}CurrentVirtGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings===0}};var Iv=me(vd()),wv=me(un());var Dy=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Source]-this.x[t.Source];return i!==0?i:this.x[e.Target]-this.x[t.Target]}};var Fy=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Target]-this.x[t.Target];return i!==0?i:this.x[e.Source]-this.x[t.Source]}};var _t=class{constructor(e,t){ec(e,t)<0?(this.first=e,this.second=t):(this.first=t,this.second=e)}get First(){return this.first}get Second(){return this.second}get Length(){return je(this.first,this.second)}CompareTo(e){let t=ec(this.first,e.first);return t!==0?t:ec(this.second,e.second)}static equal(e,t){return e.first.equal(t.first)&&e.second.equal(t.second)}toString(){return this.first+(" "+this.second)}};var nt=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new nt;for(let i of e)t.add(i);return t}addxy(e,t){let i=this.mapOfSets.get(e);i==null&&this.mapOfSets.set(e,i=new Set),i.has(t)||this.size_++,i.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let i=this.mapOfSets.get(e);return i!=null&&i.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let i of this)e(i,i,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new m(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function xs(s,e){let t=new Set;for(let i of s)e.has(i)||t.add(i);return t}function Cv(s,e){let t=new nt;for(let i of s)e.has(i)||t.add(i);return t}function Yn(s,e){let t=new Set(s);for(let i of e)t.add(i);return t}function No(s,e){for(let t of e)s.push(t)}function Kn(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}function vv(s){if(s.length===0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=Kn(e,s[t]);return e}function gc(s,e){for(let t of e)s.add(t)}function wl(s,e){if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function Bo(s,e){let t=[];for(let i of s)for(let n of e(i))t.push(n);return t}function Ll(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function Ol(s,e,t){let i=s.get(e);i||(i=new Array,s.set(e,i)),i.push(t)}function Gy(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function Av(s,e,t){Gy(s,new _t(e[0],e[1]),t)}function aN(s,e,t){let i=s.get(e);i&&i.delete(t)}function Vy(s,e,t){aN(s,new _t(e[0],e[1]),t)}function Zp(){return ha(2)===0}function lN(s,e,t){let i=t.Layers[s+1],n=t.Layers[s];return n.length<=i.length?cN(n,e,t):uN(i,n,e,t)}function uN(s,e,t,i){let n=Lv(e,t),o=new Fy(i.x);n.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of n){let h=a+i.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!==0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function cN(s,e,t){let i=Lv(s,e),n=new Dy(t.x);i.sort((u,c)=>n.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of i){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!==0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function Lv(s,e){return Bo(s,t=>e.InEdges(t))}function Tv(s,e){let t=0;for(let i=0;i<e.Layers.length-1;i++)t+=lN(i,s,e);return t}var da=class extends ye{constructor(e,t,i,n,o,a,l){super(l);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=l,this.tryReverse=t,this.startOfVirtNodes=n,this.layerArrays=i,this.layering=i.y,this.nOfLayers=i.Layers.length,this.layers=i.Layers,this.properLayeredGraph=e,this.hasCrossWeights=o,this.SugSettings=a}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return ha(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(e,t,i,n,o){let a=!1;for(let u of e.Edges)if(u.CrossingWeight!==1){a=!0;break}new da(e,!0,t,i,a,n,o).run()}run(){if(this.Calculate(),this.tryReverse){let e=this.layerArrays.ReversedClone(),t=new da(this.properLayeredGraph.ReversedClone(),!1,e,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(t.run(),t.measure<this.measure){for(let i=0;i<this.nOfLayers;i++)Sd(e.Layers[i],this.layerArrays.Layers[this.nOfLayers-1-i]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=da.CloneLayers(this.layers,this.layerArraysCopy);let e=0;this.measure=new Kp(this.layerArraysCopy,Tv(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let t=0;t<this.MaxOfIterations&&e<this.NoGainStepsBound&&!this.measure.IsPerfect();t++){let i=t%2===0;this.LayerByLayerSweep(i),this.AdjacentExchange();let n=new Kp(this.layerArrays.Layers,Tv(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);this.measure<n?(this.Restore(),e++):(n<this.measure||Zp())&&(e=0,this.layerArraysCopy=da.CloneLayers(this.layers,this.layerArraysCopy),this.measure=n)}}static CloneLayers(e,t){if(t==null){t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i].map(n=>n)}else for(let i=0;i<e.length;i++)Sd(e[i],t[i]);return t}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(e){if(e)for(let t=1;t<this.nOfLayers;t++)this.SweepLayer(t,!0);else for(let t=this.nOfLayers-2;t>=0;t--)this.SweepLayer(t,!1)}SweepLayer(e,t){let i=this.layers[e],n=new Array(i.length);for(let a=0;a<n.length;a++)n[a]=this.WMedian(i[a],t);this.Sort(e,n);let o=this.layerArrays.Layers[e];for(let a=0;a<o.length;a++)this.layerArrays.x[o[a]]=a}Sort(e,t){let i=new Iv.SortedMap,n=this.layers[e],o=0;for(let l of t){let u=n[o++];if(l!==-1)if(!i.has(l))i.set(l,u);else{let c=i.get(l);if(typeof c!="number"){let h=c;if(Zp())h.push(u);else{let d=ha(h.length),f=h[d];h[d]=u,h.push(f)}}else{let h=c,d=new Array;i.set(l,d),Zp()?(d.push(h),d.push(u)):(d.push(u),d.push(h))}}}let a=i.values();for(o=0;o<n.length;)if(t[o]!==-1){let l=a.next().value;if(typeof l=="number")n[o++]=l;else{let u=l;for(let c of u){for(;t[o]===-1;)o++;n[o++]=c}}}else o++}WMedian(e,t){let i,n;if(t?(i=this.properLayeredGraph.OutEdges(e),n=this.properLayeredGraph.OutEdgesCount(e)):(i=this.properLayeredGraph.InEdges(e),n=this.properLayeredGraph.InEdgesCount(e)),n===0)return-1;let o=new Array(n),a=0;if(t)for(let h of i)o[a++]=this.X[h.Target];else for(let h of i)o[a++]=this.X[h.Source];o.sort((h,d)=>h-d);let l=Math.floor(n/2);if(n%2===1)return o[l];if(n===2)return .5*(o[0]+o[1]);let u=o[l-1]-o[0],c=o[n-1]-o[l];return Math.floor((o[l-1]*u+o[l]*c)/(u+c))}Init(){let e=new Array(this.nOfLayers).fill(0),t=new wv.Stack;for(let n=0;n<this.properLayeredGraph.NodeCount;n++)this.properLayeredGraph.InEdgesCount(n)===0&&t.push(n);let i=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;t.size>0;){let n=t.pop(),o=this.layerArrays.y[n];this.layerArrays.Layers[o][e[o]]=n,this.layerArrays.x[n]=e[o],e[o]++;for(let a of this.properLayeredGraph.Succ(n))i[a]||(i[a]=!0,t.push(a))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let e=0,t=!0;for(;t&&e++<this.MaxNumberOfAdjacentExchanges;){t=!1;for(let i=0;i<this.layers.length;i++)t=this.AdjExchangeLayer(i)||t;for(let i=this.layers.length-2;i>=0;i--)t=this.AdjExchangeLayer(i)||t}}AllocArrays(){let e=this.properLayeredGraph.NodeCount;this.predecessors=new Array(e),this.successors=new Array(e),this.pOrder=new Array(e),this.sOrder=new Array(e),this.hasCrossWeights&&(this.outCrossingCount=new Array(e),this.inCrossingCount=new Array(e));for(let t=0;t<e;t++){let i=this.properLayeredGraph.InEdgesCount(t);if(this.predecessors[t]=new Array(i),this.hasCrossWeights){let n=this.inCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.InEdges(t))n.set(o.Source,o.CrossingWeight)}if(this.pOrder[t]=new Map,i=this.properLayeredGraph.OutEdgesCount(t),this.successors[t]=new Array(i),this.sOrder[t]=new Map,this.hasCrossWeights){let n=this.outCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.OutEdges(t))n.set(o.Target,o.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let e=0;e<this.properLayeredGraph.NodeCount;e++)this.pOrder[e]=new Map,this.sOrder[e]=new Map;for(let e of this.layers)this.InitPsArraysForLayer(e)}CalcPair(e,t){let i=this.successors[e],n=this.successors[t],o=this.predecessors[e],a=this.predecessors[t];if(this.hasCrossWeights){let l=this.outCrossingCount[e],u=this.outCrossingCount[t],c=this.inCrossingCount[e],h=this.inCrossingCount[t];return{cuv:this.CountOnArraysUV(i,n,l,u)+this.CountOnArraysUV(o,a,c,h),cvu:this.CountOnArraysUV(n,i,u,l)+this.CountOnArraysUV(a,o,h,c)}}else return{cuv:this.CountOnArrays(i,n)+this.CountOnArrays(o,a),cvu:this.CountOnArrays(n,i)+this.CountOnArrays(a,o)}}InitPsArraysForLayer(e){for(let t of e){for(let i of this.properLayeredGraph.Pred(t)){let n=this.sOrder[i],o=n.size;this.successors[i][o]=t,n.set(t,o)}for(let i of this.properLayeredGraph.Succ(t)){let n=this.pOrder[i],o=n.size;this.predecessors[i][o]=t,n.set(t,o)}}}CountOnArrays(e,t){let i=0,n=t.length-1,o=-1,a=0;for(let l of e){let u=this.X[l];for(;o<n&&this.X[t[o+1]]<u;o++)a++;i+=a}return i}CountOnArraysUV(e,t,i,n){let o=0,a=t.length-1,l=-1,u=0;for(let c of e){let h=this.X[c],d;for(;l<a&&this.X[d=t[l+1]]<h;l++)u+=n.get(d);o+=u*i.get(c)}return o}AdjExchangeLayer(e){let t=this.layers[e];return this.ExchangeWithGainWithNoDisturbance(t)?!0:(this.DisturbLayer(t),this.ExchangeWithGainWithNoDisturbance(t))}Swap(e,t){let i=this.X[e],n=this.X[t],o=this.layering[e],a=this.layers[o];a[i]=t,a[n]=e,this.X[e]=n,this.X[t]=i,this.UpdateSsContainingUv(e,t),this.UpdatePsContainingUv(e,t)}UpdatePsContainingUv(e,t){if(this.successors[e].length<=this.successors[t].length)for(let i of this.successors[e]){let n=this.pOrder[i];if(n.has(t)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.successors[t]){let n=this.pOrder[i];if(n.has(e)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}UpdateSsContainingUv(e,t){if(this.predecessors[e].length<=this.predecessors[t].length)for(let i of this.predecessors[e]){let n=this.sOrder[i];if(n.has(t)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.predecessors[t]){let n=this.sOrder[i];if(n.has(e)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}DisturbLayer(e){for(let t=0;t<e.length-1;t++)this.AdjacentSwapToTheRight(e,t)}ExchangeWithGainWithNoDisturbance(e){let t=!1,i;do i=this.ExchangeWithGain(e),t=t||i;while(i);return t}ExchangeWithGain(e){for(let t=0;t<e.length-1;t++)if(this.SwapWithGain(e[t],e[t+1]))return this.SwapToTheLeft(e,t),this.SwapToTheRight(e,t+1),!0;return!1}SwapToTheLeft(e,t){for(let i=t-1;i>=0;i--)this.AdjacentSwapToTheRight(e,i)}SwapToTheRight(e,t){for(let i=t;i<e.length-1;i++)this.AdjacentSwapToTheRight(e,i)}AdjacentSwapToTheRight(e,t){let i=e[t],n=e[t+1],o=this.SwapGain(i,n);(o>0||o===0&&Zp())&&this.Swap(i,n)}SwapGain(e,t){let i=this.CalcPair(e,t);return i.cuv-i.cvu}UvAreOfSameKind(e,t){return e<this.startOfVirtNodes&&t<this.startOfVirtNodes||e>=this.startOfVirtNodes&&t>=this.startOfVirtNodes}NeighborsForbidTheSwap(e,t){return this.UpperNeighborsForbidTheSwap(e,t)||this.LowerNeighborsForbidTheSwap(e,t)}LowerNeighborsForbidTheSwap(e,t){let i,n;return(i=this.properLayeredGraph.OutEdgesCount(e))===0||(n=this.properLayeredGraph.OutEdgesCount(t))===0?!1:this.X[this.successors[e][i>>1]]<this.X[this.successors[t][n>>1]]}UpperNeighborsForbidTheSwap(e,t){let i=this.properLayeredGraph.InEdgesCount(e),n=this.properLayeredGraph.InEdgesCount(t);return i===0||n===0?!1:this.X[this.predecessors[e][i>>1]]<this.X[this.predecessors[t][n>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(e,t,i){let n=this.GetKindDelegate(i),o=0;for(let l=t-1;l>=0&&!n(e[l]);l--)o++;let a=0;for(let l=t+1;l<e.length&&!n(e[l]);l++)a++;return o-a}IsOriginal(e){return e<this.startOfVirtNodes}IsVirtual(e){return e>=this.startOfVirtNodes}GetKindDelegate(e){return this.IsVirtual(e)?this.IsVirtual:this.IsOriginal}SwapWithGain(e,t){return this.SwapGain(e,t)>0?(this.Swap(e,t),!0):!1}};var bt=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,i){let n=this.mapOfMaps.get(e);n==null&&this.mapOfMaps.set(e,n=new Map),n.has(t)||this.size_++,n.set(t,i)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let i=this.mapOfMaps.get(e);return i!=null?(i.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let i=this.mapOfMaps.get(e);return i!=null&&i.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let i=this.mapOfMaps.get(e);if(i!=null)return i.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new m(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new m(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var mc=class{constructor(e,t,i){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=i}static UpdateLayerArrays0(e,t,i){new mc(e,t,i).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let i=mc.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,i)}static BuildInitialNodePositions(e,t){let i=new Map;for(let n=0;n<t.Layers.length;n++){let o=0,a=0;for(;o<t.Layers[n].length;){for(;o<t.Layers[n].length&&e.IsVirtualNode(t.Layers[n][o]);)o++;for(let l=a;l<o;l++)i.set(t.Layers[n][l],new m(n,a));o<t.Layers[n].length&&i.set(t.Layers[n][o],new m(n,o)),o++,a=o}}return i}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new bt;for(let t of this.layerArrays.Layers)for(let i of t){let n=this.nodePositions.get(i);e.hasxy(n.x,n.y)||e.setxy(n.x,n.y,[]),e.getxy(n.x,n.y).push(i)}return e}BuildOrdering(e){let t=new bt,i=new Map;for(let n of this.layerArrays.Layers)for(let o of n){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),i),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let i=0;i<e.length;i++)t.set(e[i],i)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,i)=>{let n=this.firstSucc(t),o=this.firstSucc(i),a=this.firstPred(t),l=this.firstPred(i),u=this.nodePositions.get(n),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(n)){if(!h.equal(d))return h.compareTo(d);let f=e.get(n),p=e.get(o);return Me(f,p)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?Me(t,i):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let i=0,n=0;for(;i<t.length;){for(;i<t.length&&this.nodePositions.get(t[n]).equal(this.nodePositions.get(t[i]));)i++;let o=e.get(this.nodePositions.get(t[n]));for(let a=n;a<i;a++)t[a]=o[a-n];n=i}}this.layerArrays.UpdateXFromLayers()}};var Rv=me(tr());var Ov=me(un());var Rl=class{static getOrder(e,t){let i=Sr(t.map(([n,o])=>new Se(n,o)),e);return Rl.getOrderOnGraph(i)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),i=new Ov.Stack,n=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,i.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(n.push(l),i.length>0){let c=i.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return n.reverse()}};var ky=class{GetLayers(){let e=Rl.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),i=this.graph.nodeCount;for(;i-- >0;){let n=e[i];for(let o of this.graph.inEdges[n]){let a=o.source,l=t[n]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(hN(t,e))return!1;return!0}constructor(e){this.graph=e}};function hN(s,e){let t=e.findIndex(n=>n===s.source),i=e.findIndex(n=>n===s.target);return t===-1||i===-1||t>=i}var zy=class{constructor(e){this.inTree=!1;this.cut=zy.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},_i=zy;_i.infinity=Number.MAX_SAFE_INTEGER;var fa=me(un());function dN(s){let e=new Array;for(let t of s.edges)e.push(new _i(t));return Sr(e,s.nodeCount)}var Qp=class{constructor(e,t,i,n,o){this.v=e,this.outEnum=t,this.i=i,this.inEnum=n,this.j=o}},Id=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=dN(e),this.networkCancelToken=t;for(let i=0;i<this.graph.nodeCount;i++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let i of this.treeVertices)this.layers[i]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let i=t.source,n=t.target;return this.lim(i)>this.lim(n)?this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?0:1:this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut===_i.infinity&&t!==this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new fa.Stack;for(let i of this.leaves)e.push(i);let t=new fa.Stack;for(;e.length>0;){for(;e.length>0;){let n=e.pop(),o=this.parent(n);if(o==null)continue;let a=0;for(let u of this.incidentEdges(n))if(u.inTree===!1){let c=this.edgeSourceTargetVal(u,o);c!==0&&(a+=c*u.weight)}else if(u===o)a+=u.weight;else{let c=o.source===u.target||o.target===u.source?1:-1;a+=this.edgeContribution(u,n)*c}o.cut=a;let l=o.source===n?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let i=e;e=t,t=i}}edgeContribution(e,t){let i=e.cut-e.weight;for(let n of this.incidentEdges(t))if(n.inTree===!1){let o=this.edgeSourceTargetVal(n,e);o===-1?i+=n.weight:o===1&&(i-=n.weight)}return i}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let i=new fa.Stack,n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(i.push(new Qp(t,n,o,a,l)),this.vertices[t].low=e;i.length>0;){let u=i.pop();t=u.v,n=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<n.length;){let h=n[o];!h.inTree||this.vertices[h.target].low>0||(i.push(new Qp(t,n,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){i.push(new Qp(t,n,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)===this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,i=this.vertices[e].lim;this.leaves=[];for(let n=0;n<this.nodeCount;n++)t<=this.vertices[n].lim&&this.vertices[n].lim<=i?this.setLow(n,0):this.low(n)===this.lim(n)&&this.leaves.push(n);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=_i.infinity;for(let i of this.treeVertices){for(let n of this.graph.outEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}for(let n of this.graph.inEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new fa.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let i of this.graph.outEdges[t])this.vertexInTree(i.target)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.target),this.addVertexToTree(i.target),this.treeVertices.push(i.target),i.inTree=!0);for(let i of this.graph.inEdges[t])this.vertexInTree(i.source)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.source),this.addVertexToTree(i.source),this.treeVertices.push(i.source),i.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,i=0;for(let a of this.graph.edges)a.inTree&&a.cut<i&&(i=a.cut,e=a);if(e==null)return null;let n=!1,o=_i.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree===!1&&this.edgeSourceTargetVal(a,e)===-1&&(l<o||l===o&&(n=ha(2)===1))){if(o=l,t=a,o===0&&!n)break;n=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let i=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,i),this.updateLimLowLeavesAndParentsUnderNode(i),this.updateCuts(e),this.updateLayersUnderNode(i)}updateLayersUnderNode(e){let t=new fa.Stack;t.push(e);for(let i=0;i<this.nodeCount;i++)this.low(e)<=this.lim(i)&&this.lim(i)<=this.lim(e)&&i!==e&&(this.layers[i]=_i.infinity);for(;t.length>0;){let i=t.pop();for(let n of this.graph.outEdges[i])n.inTree&&this.layers[n.target]===_i.infinity&&(this.layers[n.target]=this.layers[i]-n.separation,t.push(n.target));for(let n of this.graph.inEdges[i])n.inTree&&this.layers[n.source]===_i.infinity&&(this.layers[n.source]=this.layers[i]+n.separation,t.push(n.source))}}updateCuts(e){let t=new fa.Stack,i=new fa.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!==_i.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree===!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c===a)l+=c.weight;else{let h=a.source===c.target||a.target===c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source===o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&i.push(u)}let n=t;t=i,i=n}}createPathForCutUpdates(e,t,i){let n=t.target;for(;n!==i;){let o=this.parent(n);o.cut=_i.infinity,n=o.source===n?o.target:o.source}t.cut=_i.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,i;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),i=this.lim(e.target)):(t=this.lim(e.target),i=this.lim(e.source));let n=e.source;for(;!(this.low(n)<=t&&i<=this.lim(n));){let o=this.parent(n);o.cut=_i.infinity,n=o.source===n?o.target:o.source}return n}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let i of this.graph.edges)t+=this.edgeSourceTargetVal(i,e)*i.weight;e.cut!==t&&console.log(Rv.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new ky(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length===0&&this.graph.nodeCount===0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var Uy=class{GetLayers(){return new Id(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let i of e){let n=i[0],o=i[1];for(let a of this.graph.outEdges[n]){let l=new Yr(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new ys(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var fi=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new m(this.left,this.top)}get leftBottom(){return new m(this.left,this.bottom)}get rightBottom(){return new m(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new m(this.right,this.top)}static mkAnchor(e,t,i,n,o,a){let l=new fi(a);return l.la=e,l.ra=t,l.ta=i,l.ba=n,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new m(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=fi.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t===0?e:fi.curveIsConvex(e)?fi.padConvexCurve(e,t):fi.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,i,n,o){let a=fi.getPaddedCorner(t,i,n,o);e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b)}static padConvexCurve(e,t){let i=new re;fi.padCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t),fi.padCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t);for(let n=e.startPoint;n.next.next!=null;n=n.next)fi.padCorner(i,n,n.next,n.next.next,t);return i.closed=!0,i}static getPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point,u=m.getTriangleOrientation(o,a,l)===1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<A.intersectionEpsilon)return{a:a.add(h.mul(n)),b:null,numberOfPoints:1};let f=d.normalize().mul(n),p=f.rotate(Math.PI/2),S=(n-f.dot(h))/p.dot(h);return{a:f.add(p.mul(S)).add(a),b:f.sub(p.mul(S)).add(a),numberOfPoints:2}}static*orientations(e){yield m.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield m.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield m.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let i of fi.orientations(e))if(i!==2){if(t===2)t=i;else if(i!==t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():L.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new re;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return re.mkClosedFromPoints([new m(e,this.top),this.rightTop,this.rightBottom,new m(e,this.bottom),new m(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return re.mkClosedFromPoints([new m(e,this.top),new m(this.right,this.y),new m(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var bc=class{constructor(e,t,i,n,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=i,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new wr,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=n,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,i,n,o){new bc(e,t,i,n,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.InEdges(e))i[t++]=o.Source;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.upperMedians[e]=new Se(i[n-1],i[n]):this.upperMedians[e]=i[n]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.OutEdges(e))i[t++]=o.Target;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.lowMedians[e]=new Se(i[n-1],i[n]):this.lowMedians[e]=i[n]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),i=new Array(4),n=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,i[a]=l.b;let u=i[a]-t[a];u<n&&(e=a,n=u)}for(let a=0;a<4;a++){let l;if(bc.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=i[e]-i[a],this.x=this.xCoords[a],l!==0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e===0||e===2}AssignmentBounds(e,t){if(this.nOfVertices===0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let i=1;i<this.nOfVertices;i++){let n=this.x[i];n<t.a?t.a=n:n>t.b&&(t.b=n)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let n=t;this.LR?(yield n.x,yield n.y):(yield n.y,yield n.x)}else{let n=t;n>=0&&(yield n)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,i=this.UpperOf(0,this.h-1),n=this.NextLower(i);for(;this.IsBelow(e,i);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,n)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],i=null,n=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(n,o)&&i==null;n=this.NextRight(n))i=this.InnerEdgeByTarget(t[n]);if(i!=null){let a=this.Pos(this.Source(i));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,n);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(i));for(;this.IsNotRightFrom(n,o);){let u=this.AlignmentToTheRightOfInner(t,n,a);if(n=this.NextRight(n),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,i,u,l,c),i=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(i)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(i)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,i,n,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(i)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,n)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,i){if(this.NumberOfInEdges(e[t])===1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(i,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let n=0;n<this.nOfVertices;n++)if(n===this.root[n]){let o=n;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Yr(n,this.root[a.neighbor],null)),o=this.align[o]}while(o!==n)}let t=Sr(e,this.nOfVertices),i=Rl.getOrderOnGraph(t);for(let n of i)if(n===this.root[n]){let o=0,a=!0,l=n;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!==n);this.x[n]=o}for(let n of i)if(n===this.root[n]&&t.inEdges[n].length===0){let o=n,a=this.RightMost(-bc.infinity,bc.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!==n);l!==a&&(this.x[n]=a)}for(let n=0;n<this.nOfVertices;n++)n!==this.root[n]&&(this.x[n]=this.x[this.root[n]])}TryToGetRightNeighbor(e,t){let i=this.NextRight(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}TryToGetLeftNeighbor(e,t){let i=this.NextLeft(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let i=this.la.Layers[t],n=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,i.length-1);for(let a=this.LeftMost(0,i.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=i[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(n,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],n=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let i;if(this.Pos(e)>this.Pos(t)){let n=e;e=t,t=n,i=-1}else i=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*i}},Jp=bc;Jp.infinity=1e7;var Wy=class extends yr{constructor(e,t,i,n,o){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(n,o),this.virtualVerticesStart=e.nodeCount,this.virtualVerticesEnd=t.NodeCount-1,this.layeredGraph=t,this.layerArrays=i}EdgeWeightMultiplier(e){let t=e.source,i=e.target;if(t<this.layeredGraph.NodeCount&&this.layerArrays.y[t]===this.layerArrays.y[i]&&this.layerArrays.x[t]===this.layerArrays.x[i]+1)return 0;let n=0,o=-1,a=-1;for(let u of this.outEdges[t])a===-1?a=u.target:o=u.target;return a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&n++,o>=this.virtualVerticesStart&&o<=this.virtualVerticesEnd&&n++,n===0?this.weightMultiplierOfOriginalOriginal:n===1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let e of this.edges)e.weight=e.weight*this.EdgeWeightMultiplier(e)}};var hn=class{constructor(){this.length=hn.defaultArrowheadLength;this.width=0}clone(){let e=new hn;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=hn.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let i=hn.findTrimEndForArrowheadAtTarget(e);if(i==null||t>i-A.intersectionEpsilon||L.closeIntersectionPoints(e.curve.value(t),e.curve.value(i)))return!1;let n=e.curve.trim(t,i);return n==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=n,!0)}static getIntersectionsWithArrowheadCircle(e,t,i){let n=de.mkFullEllipseNNP(t,t,i);return L.getAllIntersections(n,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=A.distanceEpsilon*A.distanceEpsilon,i=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=A.distanceEpsilon)return i;let n=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u===0)return;l=hn.getIntersectionsWithArrowheadCircle(n,o,n.end),i=l.length!==0?Math.max(...l.map(c=>c.par1)):n.parEnd,a=e.curve.value(i),o/=2}while(a.sub(n.start).lengthSquared<t||l.length===0);return i}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=A.distanceEpsilon)return e.curve.parStart;let t=A.distanceEpsilon*A.distanceEpsilon,i=e.sourceArrowhead.length,n,o=e.curve,a,l=10,u;for(;--l>0;){if(a=hn.getIntersectionsWithArrowheadCircle(o,i,o.start),a.length===0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),n=a.filter(c=>c.par1===u)[0].x,n.sub(o.end).lengthSquared>=t)return u;i/=2}}static trimSplineAndCalculateArrowheads(e,t,i){return hn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,i)}static trimSplineAndCalculateArrowheadsII(e,t,i,n,o){if(e.curve=L.trimEdgeSplineWithNodeBoundaries(t,i,n,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<A.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<A.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>A.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>A.intersectionEpsilon)&&!a&&(a=hn.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!==0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=n.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=n.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,i=e.target.center,n=i.sub(t),o=n.length,a;o<.001?(a=new m(1,0),i=t.add(a.rotate(Math.PI/2))):a=n.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=L.createBezierSegN(t,i,a,u);if(hn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}hn.createEdgeCurveWithNoTrimming(e,t,i)}static createEdgeCurveWithNoTrimming(e,t,i){let n=i.sub(t).normalize(),o=t,a=i,l=e.targetArrowhead;l!=null&&(l.tipPosition=i,a=i.sub(n.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(n.mul(u.length))),e.curve=D.mkPP(o,a)}},rr=hn;rr.defaultArrowheadLength=5;var pa=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new pa(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length===0)return null;if(e.length===1)return e[0];let t=e[0].parallelogram,i=1,n=Ne.parallelogramOfTwo(t,e[i].parallelogram).area;for(let h=2;h<e.length;h++){let d=Ne.parallelogramOfTwo(t,e[h].parallelogram).area;d>n&&(i=h,n=d)}let o;for(let h=0;h<e.length;h++)if(h!==i){o=h;break}n=Ne.parallelogramOfTwo(e[i].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h===i)continue;let d=Ne.parallelogramOfTwo(e[i].parallelogram,e[h].parallelogram).area;d>n&&(o=h,n=d)}let a=new Array,l=new Array;a.push(e[i]),l.push(e[o]);let u=e[i].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h===i||h===o)continue;let d=Ne.parallelogramOfTwo(u,e[h].parallelogram),f=d.area-u.area,p=Ne.parallelogramOfTwo(c,e[h].parallelogram),S=p.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=p):f<S?(a.push(e[h]),u=d):(l.push(e[h]),c=p)}return{parallelogram:Ne.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var _l=class{static mkDebugCurveTWCILD(e,t,i,n,o,a,l=!1){let u=new _l;return u.transparency=e,u.width=t,u.color=i,u.icurve=n,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,i,n){return _l.mkDebugCurveTWCILD(e,t,i,n,null,null)}static mkDebugCurveWCI(e,t,i){return _l.mkDebugCurveTWCI(255,e,t,i)}static mkDebugCurveCI(e,t){return _l.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return _l.mkDebugCurveCI("Black",e)}},be=_l;be.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var pi=class{constructor(e,t,i,n,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=i,this.bottomSite=i.next,this.currentTopSite=i,this.currentBottomSite=i.next,this.layerArrays=n,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,i,n,o,a,l,u){new pi(e,t,i,o,a,l,n,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,i){if(e.equal(t))return t;let n=m.ClosestPointAtLineSegment(t,e,i),o=t.sub(n),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return ha(2)===0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=pi.absCotan(e),i,n=!1;for(let o of this.bottomCorners()){let a=pi.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,i=o,n=!0)}return n?le(t,pi.absCotan(e))?!1:(this.currentBottomSite=at.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=pi.absCotan(e),i,n=!1;for(let o of this.topCorners()){let a=pi.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,i=o,n=!0)}return n?le(t,pi.absCotan(e))?!1:(this.currentTopSite=at.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&pi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&pi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&pi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&pi.PossibleCorner(t,i,o)&&(yield o)}static PossibleCorner(e,t,i){return i.x>e&&i.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>n&&(d.topAnchor>l+A.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+A.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=n)break;d.left<o&&(d.topAnchor>l+A.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+A.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var Er=class{constructor(e,t,i,n,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=i,this.settings=n,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinEastHierarchy=pa.Calculate(this.thinRightNodes),pa.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinWestHierarchy=pa.Calculate(this.thinWestNodes),pa.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let i of this.edgePath){let n=null;for(let o of this.EastBoundaryNodesOfANode(i,Zn.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(n==null||n.origin.x>a.origin.x)&&(n=a),e.push(a.polygonalBoundary)}n!=null&&this.thinRightNodes.push(D.mkLinePXY(n.origin,this.originalGraph.right,n.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let i of this.edgePath.nodes()){let n=-1;for(let o of this.LeftBoundaryNodesOfANode(i,Zn.GetNodeKind(t,this.edgePath)))(n===-1||this.layerArrays.x[o]>this.layerArrays.x[n])&&(n=o),e.push(this.anchors[o].polygonalBoundary);if(n!==-1){let o=this.anchors[n];this.thinWestNodes.push(D.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,i){let n=0,o=0;i===2?n=Number.MAX_VALUE:i===0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>n&&(n=c.bottomAnchor),yield u):c.bottomAnchor>n&&(this.NodeUCanBeCrossedByNodeV(u,a)||(n=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,i){let n=0,o=0;i===0?o=Number.MAX_VALUE:i===2&&(n=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+A.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,n=Math.max(n,c.bottomAnchor),yield u):c.bottomAnchor>n+A.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),n=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)===this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let i=this.OutcomingEdge(e),n=this.OutcomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Target,t=n.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}IntersectAbove(e,t){do{let i=this.IncomingEdge(e),n=this.IncomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Source,t=n.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}Intersect(e,t){let i=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],n=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return i>0&&n<0||i<0&&n>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new xt(this.headSite)}LineSegIntersectBound(e,t){let i=D.mkPP(e,t);return Er.CurveIntersectsHierarchy(i,this.westHierarchy)||Er.CurveIntersectsHierarchy(i,this.thinWestHierarchy)||Er.CurveIntersectsHierarchy(i,this.eastHierarchy)||Er.CurveIntersectsHierarchy(i,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return Er.SegIntersectsBound(e,t,this.westHierarchy)||Er.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return Er.SegIntersectsBound(e,t,this.eastHierarchy)||Er.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn===1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn===0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,i){return Er.CurveIntersectsHierarchy(D.mkPP(e.point,t.point),i)}static CurveIntersectsHierarchy(e,t){if(t==null||!Ne.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let i=t.node;return Er.CurveIntersectsHierarchy(e,i.children[0])||Er.CurveIntersectsHierarchy(e,i.children[1])}return L.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return m.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2}Reverse(){let e=new Er(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,i=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=i,i!=null&&(i.prev=e.headSite),i=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,i;for(let n=0;n<this.edgePath.count;n++)i=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(n),this.EdgePathNode(n+1)),t=i;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,i){pi.Refine(t,i,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=at.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=at.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),i=this.anchors[e],n=this.anchors[t];if(le(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindLegalPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y);let c=this.headSite.next,h=c.point.y;c.point=new m(this.MiddlePos(o.ax,o.bx,i,n,h),h),c.next.point=new m(o.bx,n.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),i=this.anchors[e],n=this.anchors[t];if(le(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y),this.headSite.next.point=new m(o.bx,n.y)}FindLegalPositions(e,t,i){return this.FindPositions(e,t,i)?this.PositionsAreLegal(i.ax,i.bx,i.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,i){let n,o;if(i.ax<i.bx?(i.sign=1,o=Math.max(i.ax,t.left),n=Math.min(e.right,i.bx)):(i.sign=-1,o=Math.max(e.left,i.bx),n=Math.min(t.right,i.ax)),o<=n)i.bx=.5*(o+n),i.ax=.5*(o+n);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;i.sign===1?(i.ax=e.right-.1*e.rightAnchor,i.bx=t.left):(i.ax=e.left+.1*e.leftAnchor,i.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let i=D.mkPP(e.origin,t.origin);return e.x<t.x&&L.CurvesIntersect(i,D.mkPP(e.rightBottom,e.rightTop))||L.CurvesIntersect(i,D.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&L.CurvesIntersect(i,D.mkPP(e.leftBottom,e.leftTop))||L.CurvesIntersect(i,D.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count===2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count===1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,i,n,o,a){if(!le(e,t)&&(e-t)*i>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,n,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new m(e,n.bottom),new m(t,o.top)):!1}MiddleAnchorLegal(e,t,i){let n=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-i.x;return!(o>0&&this.anchors[n[o-1]].right>a+i.left||o<n.length-1&&this.anchors[n[o+1]].left<a+i.right)}MiddlePos(e,t,i,n,o){let a=i.y-o,l=o-n.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let i=t.turn;if(e===0)i>0?e=1:i<0&&(e=-1);else if(e*i<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e===this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new L,t=this.headSite,i=L.findCorner(t);return i!==void 0?(this.createFilletCurve(e,{a:t,b:i.b,c:i.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(D.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)Er.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!m.closeDistEps(t,e.start)){let i=new L;i.addSegs([D.mkPP(t,e.start),e]),e=i}return t=this.TailSite.point,m.closeDistEps(t,e.end)||e.addSegment(D.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,i,n){let o=.5,a;do a=L.createBezierSeg(o,o,e,t,i),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=L.createBezierSeg(o,o,e,t,i);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}n.segs.length>0&&!m.closeDistEps(n.end,a.start)&&n.addSegment(D.mkPP(n.end,a.start)),n.addSegment(a)}BezierSegIntersectsBoundary(e){return m.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(Ne.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let i=t.node;return this.BezierSegIntersectsTree(e,i.children[0])||this.BezierSegIntersectsTree(e,i.children[1])}else return Er.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let i of L.getAllIntersections(e,t,!1))if(t instanceof L){let n=t;if(L.realCutWithClosedCurve(i,n,!1))return!0}else return!0;return!1}};var Hy=me(gs()),$p=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.id=$p.debugCount++,this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new $p(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new Hy.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Children)e.enqueue(i)}}*Ancestors(){let e=new Hy.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Parents)e.enqueue(i)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}},Cs=$p;Cs.debugCount=0;var Ml=class{};var Zr=class extends Ml{constructor(e,t){super();this.curve=this.curve,this.location=t.clone()}get Location(){return this.location}set Location(e){this.location=e}Translate(e){this.location=this.location.add(e)}get Curve(){return this.curve}set Curve(e){this.curve=e}};var ji=class extends Zr{static mk(e,t){return new ji(e,t,new m(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(e){this.centerDelegate=e}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(e){this.curveDelegate=e}get LocationOffset(){return this.locationOffset}set LocationOffset(e){this.locationOffset=e}constructor(e,t,i){super(null,t().add(i));this.LocationOffset=i,this.CurveDelegate=e,this.CenterDelegate=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var wd=class{constructor(e,t,i,n,o){this.color=e,t!==void 0&&(this.item=t),i!==void 0&&(this.parent=i),n!==void 0&&(this.left=n),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var Ct=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new wd(1)}clear(){this.root=this.nil=new wd(1)}toNull(e){return e!==this.nil?e:null}isEmpty(){return this.root===this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let i;for(;t!==this.nil&&(i=this.comparer(e,t.item))!==0;)t=i<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).left:t.right;return i}findLast(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).right:t.left;return i}treeMinimum(e=this.root){for(;e.left!==this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!==this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!==this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!==this.nil&&e===t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!==this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!==this.nil&&e===t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!==this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!==this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!==this.root&&e.color===1;)if(e===e.parent.left){let t=e.parent.right;t.color===0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color===1&&t.right.color===1?(t.color=0,e=e.parent):(t.right.color===1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color===0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color===1&&t.left.color===1?(t.color=0,e=e.parent):(t.left.color===1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left===this.nil||e.right===this.nil)t=e;else for(t=e.right;t.left!==this.nil;)t=t.left;let i=t.left!==this.nil?t.left:t.right;return i.parent=t.parent,t.parent===this.nil?this.root=i:t===t.parent.left?t.parent.left=i:t.parent.right=i,t!==e&&(e.item=t.item),t.color===1&&this.deleteFixup(i),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,i=this.root,n=0;for(;i!==this.nil;)t=i,n=this.comparer(e,i.item),i=n<0?i.left:i.right;let o=new wd(1,e,t,this.nil,this.nil);return t===this.nil?this.root=o:n<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!==this.root&&e.parent.color===0;)if(e.parent===e.parent.parent.left){let t=e.parent.parent.right;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let i of this.allNodes())e+=i.toString(),t!==this.count-1&&(e+=`
`),t++;return e+"}"}};var Nl=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let i=t>>1,n,o;for(;t>1&&this.Less(n=this.A[t],o=this.A[i]);)this.A[i]=n,this.A[t]=o,t=i,i=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,i=2,n=!1;for(;i<this.heapSize&&!n;){n=!0;let o=this.A[i],a=this.A[i+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e,n=!1,t=i,i=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[i+1]=e,n=!1,t=i+1,i=t<<1)}if(i===this.heapSize){let o=this.A[i];this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var cr=class{};var qi=class extends cr{get Site(){return this.Vertex.point}constructor(e){super();this.Vertex=e}get Polyline(){return this.Vertex.polyline}};var jy=class extends qi{constructor(e){super(e)}};var qy=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(m.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),i=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}};var Xy=class extends cr{constructor(e){super();this.site=e}get Site(){return this.site}};var Ld=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new Nl((i,n)=>this.Compare(i,n)),this.ObstacleSideComparer=new qy(this),this.LeftObstacleSideTree=new Ct((i,n)=>this.ObstacleSideComparer.Compare(i,n)),this.RightObstacleSideTree=new Ct((i,n)=>this.ObstacleSideComparer.Compare(i,n))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+A.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>A.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(i=>m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(i=>!m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new Xy(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new jy(t))}GetLowestPoint(e){let t=e.startPoint,i=e.startPoint.next;for(;i!=null;i=i.next)this.Less(i.point,t.point)&&(t=i);return t}Compare(e,t){let i=e.Site,n=t.Site;return this.ComparePoints(i,n)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let i=this.SweepDirection.dot(e),n=this.SweepDirection.dot(t);return i<n?-1:i>n?1:(i=this.directionPerp.dot(e),n=this.directionPerp.dot(t),i<n?-1:i>n?1:0)}};var Mv=me(tr()),Pc=class{constructor(e,t,i=1){this.LengthMultiplier=1;this.Source=e,this.Target=t,this.Weight=i}static closeuv(e,t){return m.closeDistEps(e.point,Pc.u,.1)&&m.closeDistEps(t.point,Pc.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return Mv.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new Pc(this.Target,this.Source)}Clone(){return new Pc(this.Source,this.Target)}},Mi=Pc;Mi.u=new m(545.833,840.458),Mi.v=new m(606.1667261889578,786.2917261889578),Mi.DefaultWeight=1;var xr=class extends Mi{static constructorVV(e,t){return new xr(e,t,0)}constructor(e,t,i=0){super(e,t,i)}};var vs=class{constructor(e){this._inEdges=new Array;this._outEdges=new Ct((t,i)=>this.Compare(t,i)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t===-1)return;let i=this._inEdges.length-1;t!==i&&(this._inEdges[t]=this._inEdges[i]),this._inEdges.pop()}static FindFirst(e,t){return vs.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,i){if(e===t.nil)return null;let n=null;for(;e!==t.nil;)e=e.item.TargetPoint.compareTo(i)>=0?(n=e).left:e.right;return n}get(e){let t=vs.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target===e||(t=vs.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target===this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var et=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new vs(e);this.pointToVertexMap=new bt}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source===e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!==e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let i=t.startPoint;;i=i.next){let n=m.getTriangleOrientation(i.point,i.next.point,i.next.next.point);if(n!==2){yield n===0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let i=this.VertexFactory(e);return this.pointToVertexMap.set(e,i),i}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let i;if(i=e.get(t))return i;if(e===t)throw new Error("Self-edges are not allowed");let n=new Mi(e,t);return e.OutEdges.insert(n),t.InEdges.push(n),n}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,i){let n=this.FindVertex(e),o=null;if(n!=null&&(o=this.FindVertex(t),o!=null)){let l=n.get(o);if(l)return l}n==null?(n=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=i(n,o);return n.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(i,n)=>new Mi(i,n))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let i=this.FindVertex(e);if(i==null)return null;let n=this.FindVertex(t);return n==null?null:i.get(n)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var Bl=class{constructor(){this.Removed=!1}};var Qn=class extends Bl{get Start(){return this.start}get End(){return this.EndVertex.point}constructor(e,t,i){super();this.start=e,this.EndVertex=t,this.ConeSide=i}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Od=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var eg=class extends cr{get ConeToClose(){return this.coneToClose}get Site(){return this.site}constructor(e,t){super();this.site=e,this.coneToClose=t}toString(){return"ConeClosureEvent "+this.site}};var Xi=class extends Bl{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var Do=class extends Bl{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var yc=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let i=e instanceof Qn,n=t instanceof Qn;return i?n?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):n?this.CompareConeSideAndObstacleSide(e,t):yc.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(m.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=m.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t===1?-1:t===0?1:e instanceof Xi?-1:1}CompareConeSideAndObstacleSide(e,t){let i=m.getTriangleOrientation(this.x,t.start,t.End);return i===1?-1:i===0||e instanceof Xi?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),i=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}CompareBrokenSides(e,t){return e.EndVertex===t.EndVertex?yc.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):m.getTriangleOrientation(this.x,t.start,t.EndVertex.point)===1?-1:1}};var Dl=class extends cr{get EndVertex(){return this.endVertex}constructor(e,t,i){super();this.coneLeftSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var Fl=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var Gl=class extends Fl{Init(e){this.StartVertex=e}constructor(e){super();this.Init(e)}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var As=class extends Gl{constructor(e){super(e);this.end=e.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var Fo=class extends qi{constructor(e){super(e)}};var tg=class extends cr{get EndVertex(){return this.endVertex}set EndVertex(e){this.endVertex=e}constructor(e,t,i){super();this.coneRightSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var Ts=class extends Gl{constructor(e){super(e);this.end=e.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var Go=class extends qi{constructor(e){super(e)}};var jt=class extends Ld{constructor(e,t,i,n,o,a,l){super(e,t);this.visibilityGraph=o,this.ConeRightSideDirection=i,this.ConeLeftSideDirection=n,this.coneSideComparer=new yc(this),this.leftConeSides=new Ct((u,c)=>this.coneSideComparer.Compare(u,c)),this.rightConeSides=new Ct((u,c)=>this.coneSideComparer.Compare(u,c)),this.Ports=a,this.BorderPolyline=l,this.PortEdgesCreator=(u,c)=>new xr(u,c,0)}static Sweep(e,t,i,n,o,a){new jt(e,t,t.rotate(-i/2),t.rotate(i/2),n,o,a).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let e of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(e.SourcePoint,e.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count===0)return;let e=this.BorderPolyline.startPoint,t=this.leftConeSides.count;do{let i=this.leftConeSides.treeMinimum().item.Cone;e=this.FindPolylineSideIntersectingConeRightSide(e,i),e=this.GetPolylinePointInsideOfConeAndRemoveCones(e,i),t--}while(this.leftConeSides.count>0&&t>0)}GetPolylinePointInsideOfConeAndRemoveCones(e,t){let i=e.nextOnPolyline,n=jt.FindInsidePoint(e.point,i.point,t);return m.closeDistEps(n,e.point)?(this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)):m.closeDistEps(n,i.point)?(this.AddEdgeAndRemoveCone(t,i.point),this.AddEdgesAndRemoveRemainingConesByPoint(i.point),e=i):(e=jt.InsertPointIntoPolylineAfter(this.BorderPolyline,e,n),this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)),e}static FindInsidePoint(e,t,i){return jt.FindInsidePointBool(e,t,i.Apex,i.Apex.add(i.LeftSideDirection),i.Apex.add(i.RightSideDirection))}static FindInsidePointBool(e,t,i,n,o){if(m.closeDistEps(e,t)||m.PointIsInsideCone(e,i,n,o))return e;if(m.PointIsInsideCone(t,i,n,o))return t;let a=m.middle(e,t);return m.pointToTheLeftOfLine(a,i,n)?jt.FindInsidePointBool(a,t,i,n,o):jt.FindInsidePointBool(e,a,i,n,o)}AddEdgesAndRemoveRemainingConesByPoint(e){let t=new Array;for(let i of this.leftConeSides)if(m.PointToTheRightOfLineOrOnLine(e,i.Start,i.Start.add(i.Direction)))t.push(i.Cone);else break;for(let i of t)this.AddEdgeAndRemoveCone(i,e)}FindPolylineSideIntersectingConeRightSide(e,t){let i=e,n=t.Apex,o=t.Apex.add(this.ConeRightSideDirection),a=jt.GetSign(e,n,o);for(;;){let l=e.nextOnPolyline,u=jt.GetSign(l,n,o);if(u-a>0)return e;if(e=l,a=u,e===i)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(e,t,i){let n=m.signedDoubledTriangleArea(t,i,e.point);return n<0?1:n>0?-1:0}AddEdgeAndRemoveCone(e,t){this.Ports!=null&&this.Ports.has(e.Apex)?this.CreatePortEdge(e,t):this.visibilityGraph.AddEdgePP(e.Apex,t),this.RemoveCone(e)}CreatePortEdge(e,t){this.portEdgesGraph==null&&(this.portEdgesGraph=new et);let i=this.portEdgesGraph.FindVertex(e.Apex),n=i!=null?Array.from(i.InEdges).concat(Array.from(i.OutEdges.allNodes())):null;if(n)for(let o of n){let a=(o.Target===i?o.Source:o.Target).point;et.RemoveEdge(o),this.portEdgesGraph.AddEdgePP(a,t)}this.portEdgesGraph.AddEdgePP(e.Apex,t)}static InsertPointIntoPolylineAfter(e,t,i){let n;return t.next!=null?(n=Ut.mkFromPoint(i),n.prev=t,n.next=t.next,t.next.prev=n,t.next=n):(n=Ut.mkFromPoint(i),n.prev=t,t.next=n,e.endPoint=n),n.polyline=e,e.setInitIsRequired(),n}ProcessEvent(e){e instanceof qi?this.ProcessVertexEvent(e):e instanceof tg?this.ProcessRightIntersectionEvent(e):e instanceof Dl?this.ProcessLeftIntersectionEvent(e):(e instanceof eg?e.ConeToClose.Removed||this.RemoveCone(e.ConeToClose):this.ProcessPortObstacleEvent(e),this.Z=this.GetZS(e))}ProcessPortObstacleEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.CreateConeOnVertex(e)}ProcessLeftIntersectionEvent(e){if(e.coneLeftSide.Removed===!1)if(Math.abs(e.EndVertex.point.sub(e.Site).dot(this.SweepDirection))<A.distanceEpsilon)this.RemoveCone(e.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(e.coneLeftSide),this.Z=this.GetZP(e.Site);let t=new Qn(e.Site,e.EndVertex,e.coneLeftSide);this.InsertToTree(this.leftConeSides,t),e.coneLeftSide.Cone.LeftSide=t,this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForLeftSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForLeftSide(e){if(e.Cone.RightSide instanceof Do){let t=e.Cone.RightSide;m.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.EndVertex.point)==0&&this.CreateConeClosureEvent(e,t)}}CreateConeClosureEvent(e,t){let i=m.RayIntersectsRayInteriors(e.start,e.Direction,t.Start,t.Direction);if(i){let n=new eg(i,e.Cone);this.EnqueueEvent(n)}}ProcessRightIntersectionEvent(e){if(e.coneRightSide.Removed===!1){this.RemoveSegFromRightTree(e.coneRightSide),this.Z=this.GetZP(e.Site);let t=new Qn(e.Site,e.EndVertex,e.coneRightSide);this.InsertToTree(this.rightConeSides,t),e.coneRightSide.Cone.RightSide=t,this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForRightSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForRightSide(e){if(e.Cone.LeftSide instanceof Xi){let i=e.Cone.LeftSide;m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),e.EndVertex.point)==1&&this.CreateConeClosureEvent(e,i)}}RemoveConesClosedBySegment(e,t){this.CloseConesCoveredBySegment(e,t,this.GetZP(e)>this.GetZP(t)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(e,t,i){let n=i.findFirst(l=>m.getTriangleOrientation(l.Start,l.Start.add(l.Direction),e)===1);if(n==null||!m.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction))return;let a=new Array;do a.push(n.item.Cone),n=i.next(n);while(n!=null&&m.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction)!==void 0);for(let l of a)this.RemoveCone(l)}ProcessVertexEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.AddConeAndEnqueueEvents(e)}static Diamond(e){return we.CreateDiamond(2,2,e)}AddConeAndEnqueueEvents(e){if(e instanceof Fo){let i=e.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(e,i)}else if(e instanceof Go){let n=e.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(e,n)}else this.CloseConesAddConeAtLeftVertex(e,e.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(e,e.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;this.directionPerp.dot(e.Site.sub(i))>A.distanceEpsilon&&this.RemoveConesClosedBySegment(i,e.Vertex.point),this.directionPerp.dot(t.point.sub(e.Site))>A.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,t.point);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>A.distanceEpsilon&&this.RemoveRightSide(new Ts(e.Vertex.nextOnPolyline)),this.GetZP(n.sub(t.point))>A.distanceEpsilon&&this.RemoveLeftSide(new As(t)),this.GetZP(l)+A.distanceEpsilon<this.GetZS(e)&&this.CreateConeOnVertex(e),m.PointToTheRightOfLineOrOnLine(l,n,o)?m.PointToTheLeftOfLineOrOnLine(l,n,a)?this.CaseToTheLeftOfLineOrOnLineConeRp(e,t):(this.GetZP(l.sub(n))>A.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,t),this.InsertRightSide(new Ts(e.Vertex))),this.EnqueueRightVertexEvent(new Go(t))):(this.CreateConeOnVertex(e),m.PointToTheLeftOfLineOrOnLine(l.add(this.DirectionPerp),l,n)&&this.EnqueueRightVertexEvent(new Go(t)))}CaseToTheLeftOfLineOrOnLineConeRp(e,t){this.EnqueueRightVertexEvent(new Go(t));let i=new Od(e.Vertex.point,this),n=new Qn(i.Apex,t,new Xi(i));i.LeftSide=n,i.RightSide=new Do(i);let o=this.InsertToTree(this.rightConeSides,i.RightSide);this.LookForIntersectionWithConeRightSide(o);let a=this.InsertToTree(this.leftConeSides,i.LeftSide);this.FixConeLeftSideIntersections(n,a),this.GetZP(t.point.sub(e.Site))>A.distanceEpsilon&&this.InsertRightSide(new Ts(e.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(e,t){let i=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(e);if(i!=null&&i.item instanceof Do!=null){let o=m.IntervalIntersectsRay(e,t.point,i.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,t.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(i.item,o,t))}}CreateRightIntersectionEvent(e,t,i){return new tg(e,t,i)}GetLastNodeToTheLeftOfPointInRightSegmentTree(e){return this.rightConeSides.findLast(t=>jt.PointIsToTheRightOfSegment(e,t))}LookForIntersectionOfObstacleSideAndLeftConeSide(e,t){let i=this.GetFirstNodeToTheRightOfPoint(e);if(i==null||!(i.item instanceof Xi))return;let n=i.item,o=m.IntervalIntersectsRay(e,t.point,n.Start,this.ConeLeftSideDirection);o&&this.EnqueueEvent(new Dl(n,o,t))}GetFirstNodeToTheRightOfPoint(e){return this.leftConeSides.findFirst(t=>jt.PointIsToTheLeftOfSegment(e,t))}static PointIsToTheLeftOfSegment(e,t){return m.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)===1}static PointIsToTheRightOfSegment(e,t){return m.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)===0}FixConeLeftSideIntersections(e,t){do t=this.leftConeSides.next(t);while(t!=null&&m.PointToTheRightOfLineOrOnLine(e.Start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null&&t.item instanceof Xi){let i=t.item,n=m.IntervalIntersectsRay(e.start,e.End,i.Start,i.Direction);n&&this.EnqueueEvent(new Dl(i,n,e.EndVertex))}}InsertToTree(e,t){return this.coneSideComparer.SetOperand(t),e.insert(t)}CloseConesAddConeAtLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;e.Site.sub(i).dot(this.directionPerp)<-A.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,i),t.point.sub(e.Site).dot(this.directionPerp)<-A.distanceEpsilon&&this.RemoveConesClosedBySegment(t.point,e.Site);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>A.distanceEpsilon&&this.RemoveLeftSide(new As(e.Vertex.prevOnPolyline));let u=this.GetZP(l)-this.Z;u<-A.distanceEpsilon&&this.RemoveRightSide(new Ts(t));let c=l.sub(e.Site);if(u<-A.distanceEpsilon||le(u,0)&&this.GetZP(c)>0&&c.dot(this.directionPerp)>-A.distanceEpsilon)this.CreateConeOnVertex(e);else if(!m.PointToTheLeftOfLineOrOnLine(l,n,a))this.CreateConeOnVertex(e),this.EnqueueEvent(new Fo(t));else if(m.PointToTheLeftOfLineOrOnLine(l,n,o))this.EnqueueEvent(new Fo(t)),this.GetZP(c)>A.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,t),this.InsertLeftSide(new As(e.Vertex)));else{this.EnqueueEvent(new Fo(t));let h=new Od(e.Vertex.point,this),d=new Qn(e.Vertex.point,t,new Do(h));h.RightSide=d,h.LeftSide=new Xi(h),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,h.LeftSide));let f=this.InsertToTree(this.rightConeSides,d);this.FixConeRightSideIntersections(d,f),this.GetZP(c)>A.distanceEpsilon&&this.InsertLeftSide(new As(e.Vertex))}}RemoveCone(e){e.Removed=!0,this.RemoveSegFromLeftTree(e.LeftSide),this.RemoveSegFromRightTree(e.RightSide)}RemoveSegFromRightTree(e){this.coneSideComparer.SetOperand(e);let t=this.rightConeSides.remove(e);if(e.Removed=!0,t==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),t=this.rightConeSides.remove(e),this.Z=i}}RemoveSegFromLeftTree(e){if(e.Removed=!0,this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e)==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e),this.Z=i}}FixConeRightSideIntersections(e,t){do t=this.rightConeSides.previous(t);while(t!=null&&m.PointToTheLeftOfLineOrOnLine(e.start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null){let i;if(t.item instanceof Do){let n=t.item;(i=m.IntervalIntersectsRay(e.start,e.End,n.Start,n.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n,i,e.EndVertex))}}}CreateConeOnVertex(e){let t=new Od(e.Site,this);t.LeftSide=new Xi(t),t.RightSide=new Do(t);let i=this.InsertToTree(this.leftConeSides,t.LeftSide),n=this.InsertToTree(this.rightConeSides,t.RightSide);this.LookForIntersectionWithConeRightSide(n),this.LookForIntersectionWithConeLeftSide(i)}LookForIntersectionWithConeLeftSide(e){if(e.item instanceof Xi){let i=e.item,n=this.FindFirstObstacleSideToTheLeftOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(i,n)}else{let i=e.item;e=this.leftConeSides.next(e),e!=null&&e.item instanceof Xi&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(e.item,i)}}LookForIntersectionWithConeRightSide(e){if(e.item instanceof Do){let i=e.item,n=this.FindFirstObstacleSideToToTheRightOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(i,n)}else{let i=e.item;e=this.rightConeSides.previous(e),e!=null&&e.item instanceof Do&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(e.item,i)}}TryIntersectionOfConeRightSideAndObstacleConeSide(e,t){let i=m.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(e,t){let i=m.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(e,t){let i=m.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new Dl(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(e,t){let i=m.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new Dl(e,i,t.EndVertex))}Show(e,t){let i=Array.from(this.Obstacles).map(n=>be.mkDebugCurveTWCI(200,.5,"Blue",n));for(let n of this.rightConeSides)i.push(be.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(n))),n instanceof Qn&&i.push(be.mkDebugCurveCI("brown",jt.Diamond(n.start))),i.push(be.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(n.Cone.LeftSide))),n.Cone.LeftSide instanceof Qn&&i.push(be.mkDebugCurveCI("green",jt.Diamond(n.Cone.LeftSide.start)));i=i.concat(Array.from(this.visibilityGraph.Edges).map(n=>be.mkDebugCurveWCI(2,"Black",D.mkPP(n.SourcePoint,n.TargetPoint)))),i=i.concat(e.map(n=>be.mkDebugCurveCI("Red",n)))}ExtendSegmentToZ(e){let t=e.Direction.dot(this.SweepDirection),i=(this.Z+40-e.Start.dot(this.SweepDirection))/t;return D.mkPP(e.Start,e.Start.add(e.Direction.mul(i)))}GoOverConesSeeingVertexEvent(e){let t=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e);if(t==null)return;let n=t.item.Cone,o=n.LeftSide;if(jt.VertexIsToTheLeftOfSegment(e,o))return;let a=[n];if(this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),t==null){let l=this.Z;this.Z=Math.max(this.GetZP(o.Start),this.PreviousZ),this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),this.Z=l}if(!(t==null&&(t=this.GetRbNodeEmergency(o),t==null))){for(t=this.leftConeSides.next(t);t!=null&&!jt.VertexIsToTheLeftOfSegment(e,t.item);)a.push(t.item.Cone),t=this.leftConeSides.next(t);for(let l of a)this.AddEdgeAndRemoveCone(l,e.Site)}}GetRbNodeEmergency(e){if(this.leftConeSides.count===0)return null;for(let t=this.leftConeSides.treeMinimum();t!=null;t=this.leftConeSides.next(t))if(t.item===e)return t;return null}static VertexIsToTheLeftOfSegment(e,t){return m.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)===1}static VertexIsToTheRightOfSegment(e,t){return m.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)===0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e){return this.rightConeSides.findFirst(t=>!jt.VertexIsToTheRightOfSegment(e,t))}EnqueueRightVertexEvent(e){this.GetZP(e.Site.sub(e.Vertex.prevOnPolyline.point))>A.tolerance||this.EnqueueEvent(e)}invariant(){for(let e of this.leftConeSides)if(e.Removed)return!1;for(let e of this.rightConeSides)if(e.Removed)return!1;return!0}};var ga=class extends ye{constructor(e,t){super(null);this.coneAngle=Math.PI/6;this.ports=new nt;this._obstacles=Array.from(et.OrientHolesClockwise(e)),this._visibilityGraph=t}static mk(e,t,i,n,o){let a=new ga(e,t);return a.Ports=n,a.BorderPolyline=o,a.ConeAngle=i,a}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Ports(){return this.ports}set Ports(e){this.ports=e}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(e){this.borderPolyline=e}get Bidirectional(){return this._bidirectional}set Bidirectional(e){this._bidirectional=e}static GetTotalSteps(e){return Math.floor((2*Math.PI-e/2)/e)+1}run(){let e=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let t;for(let i=0;(t=this.coneAngle*i)<=e;i++)super.ProgressStep(),this.AddDirection(new m(Math.cos(t),Math.sin(t)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let e=Math.PI/this.coneAngle;for(let t=0;t<e;t++){let i=t*this.coneAngle,n=new et;this.AddDirection(new m(Math.cos(i),Math.sin(i)),this.BorderPolyline,n);let o=new et;this.AddDirection(new m(Math.cos(i)*-1,Math.sin(i)*-1),this.BorderPolyline,o),this.AddIntersectionOfBothDirectionSweepsToTheResult(n,o)}}AddIntersectionOfBothDirectionSweepsToTheResult(e,t){for(let i of e.Edges)t.FindEdgePP(i.SourcePoint,i.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(i.SourcePoint,i.TargetPoint)}AddDirection(e,t,i){jt.Sweep(this._obstacles,e,this.coneAngle,i,this.Ports,t)}};var qt=class extends Ml{constructor(e){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=e,this.location=this.curve().start}mk(e,t){let i=new qt(e);return i.HookSize=t,i}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(e){this.location=e}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(e){this.adjustmentAngle=e}get HookSize(){return this.hookSize}set HookSize(e){this.hookSize=e}};var Or=class extends ji{get LoosePolyline(){return this.loosePolyline}set LoosePolyline(e){this.loosePolyline=e}constructor(e,t,i=new m(0,0)){super(e,t,i)}static mk(e,t){return new Or(e,t)}};var Rr=class extends Ml{get Location(){return this.curve.value(this.parameter)}set Location(e){throw new Error("Method should not be called.")}static mk(e,t){let i=new Rr;return i.curve=e,i.parameter=t,i}get Parameter(){return this.parameter}set Parameter(e){this.parameter=e}get Curve(){return this.curve}set Curve(e){this.curve=e}};var Sc=class extends Cs{get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(e){if(e)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}constructor(e){super(null);this.curveDelegate=e}};var Yi=class{static GetShapes(e,t){let i=new Map;for(let n of e)Yi.ProcessAncestorDescendantCouple(n.target,n.source,i),Yi.InsertEdgePortsToShapes(i,n);for(let n of t)Yi.ProcessAncestorDescendantCouple(n.source,n.target,i),Yi.InsertEdgePortsToShapes(i,n);return Yi.BindShapes(i),Array.from(i.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,i]of e){if(!(t instanceof Ie))continue;let n=t;for(let o of Yy(n)){let a=e.get(o);a&&i.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,i){let n=rg(t);do{for(let o of Yy(n))Yi.CreateShapeIfNeeeded(o,i);if(n===e)break;n=rg(n)}while(!0);Yi.CreateShapeIfNeeeded(n,i)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new Sc(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,i){let n=new Set;for(let o of e)if(Yi.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,n,i))return!1;for(let o of t)if(Yi.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,n,i))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,i,n){let o=rg(t);for(;;){for(let a of Yy(o))if(i.add(a),i.size>n)return!0;if(o===e)break;o=rg(o)}return i.add(o),i.size>n}};function rg(s){let e=s.node.parent;return ke.getGeom(e)}function*Yy(s){for(let e of s.graph.shallowNodes)yield ke.getGeom(e)}var gi=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new m(0,Number.MAX_SAFE_INTEGER);let t=-1,i=0;for(let n of e)n.y<this.pivot.y?(this.pivot=n,t=i):n.y===this.pivot.y&&n.x>this.pivot.x&&(this.pivot=n,t=i),i++;if(i>=1){this.hullPoints=new Array(i-1),i=0;for(let n of e)i!==t?this.hullPoints[i++]={point:n,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new gi(e);for(let i of t.Calculate())yield i}*Calculate(){if(this.pivot.y!==Number.MAX_SAFE_INTEGER){if(this.hullPoints.length===0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return m.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)===1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=m.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t===1?!0:t===0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+A.distanceEpsilon&&e.x<this.pivot.x-A.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(fN(this.pivot))}static createConvexHullAsClosedPolyline(e){return re.mkClosedFromPoints(Array.from(gi.CalculateConvexHull(e)))}};function fN(s){return(e,t)=>{if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;switch(m.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let i=e.point.x-s.x,n=t.point.x-s.x;if(i>A.distanceEpsilon&&n<A.distanceEpsilon*-1)return-1;if(i<A.distanceEpsilon*-1&&n>A.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function Qr(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Qr(s,e.Left,t),Qr(s,e.Right,t)):e.Left!=null?(Qr(s.Left,e.Left,t),Qr(s.Left,e.Right,t),Qr(s.Right,e.Left,t),Qr(s.Right,e.Right,t)):(Qr(s.Left,e,t),Qr(s.Right,e,t)))}function Xt(s,e,t){!s.irect.intersects_rect(e.irect)||(s===e?gN(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Xt(s,e.Left,t),Xt(s,e.Right,t)):e.Left!=null?(Xt(s.Left,e.Left,t),Xt(s.Left,e.Right,t),Xt(s.Right,e.Left,t),Xt(s.Right,e.Right,t)):(Xt(s.Left,e,t),Xt(s.Right,e,t)))}function Ki(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s===e)return pN(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(Ki(s,e.Left,t)||Ki(s,e.Right,t))return!0}else if(e.Left!=null){if(Ki(s.Left,e.Left,t)||Ki(s.Left,e.Right,t)||Ki(s.Right,e.Left,t)||Ki(s.Right,e.Right,t))return!0}else if(Ki(s.Left,e,t)||Ki(s.Right,e,t))return!0;return!1}function pN(s,e){return s.Left==null?!1:Ki(s.Left,s.Left,e)||Ki(s.Left,s.Right,e)||Ki(s.Right,s.Right,e)}function gN(s,e){s.Left!=null&&(Xt(s.Left,s.Left,e),Xt(s.Left,s.Right,e),Xt(s.Right,s.Right,e))}var Ec=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n>=this.f(0)&&n>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:e=i;break;case 0:t=i;break;case 2:return i}return e===t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e===0){let o=this.f(1);return o===t?2:o>t?0:1}if(e===this.length-1){let o=this.f(this.length-2);return o===t?2:o>t?1:0}let i=t-this.f(e-1),n=this.f(e+1)-t;return i*n<=0?2:i>0?0:1}FindMaximum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n<=this.f(0)&&n<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:t=i;break;case 0:e=i;break;case 2:return i}return e===t||this.f(e)>this.f(t)?e:t}};var Ky=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.min(this.f(n),e+i*n)}GetAdjustedSequenceForMaximum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.max(this.f(n),e+i*n)}FindMinimum(){return this.f(0)===this.f(this.length-1)?new Ec(this.f,this.length).FindMinimum():new Ec(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)===this.f(this.length-1)?new Ec(this.f,this.length).FindMaximum():new Ec(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var Vl=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,i){let n=this.P.pnt(e);return this.upperBranchOnP?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}LeftFromLineOnQ(e,t,i){let n=this.Q.pnt(e);return this.lowerBranchOnQ?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,i,n){for(;t!==e||n!==i;){let o=t!==e?this.MedianOnP(e,t):e,a=n!==i?this.MedianOnQ(i,n):i,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!==e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(i,n)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?i=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?n=a:h=!1:n!==i?this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:h=!1:h=!1,!c&&!h&&(e=o,t=o,i=a,n=a)}return[e,n]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=m.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.add(t.qClosest).rotate(Math.PI/2)}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2===e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2===e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1===e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1===e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=m.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),m.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:m.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=m.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),m.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:m.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,i,n){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(n-i)+1;return a>2||o===2&&a===2}ShrinkChunks(e){let t=e.p1===e.p2?e.p1:this.P.Median(e.p1,e.p2),i=e.q1===e.q2?e.q1:this.Q.Median(e.q2,e.q1),n=this.P.pp(t).point,o=this.Q.pp(i).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,i,n,o,a),!this.InternalCut(e,t,i,a.a1,a.a2,a.b1,a.b2)&&!Vl.OneOfChunksContainsOnlyOneVertex(e,t,i,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:i},a)){if(e.p2===this.P.Next(e.p1)&&e.q1===this.Q.Next(e.q2)){let l=D.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab===0?e.p2=e.p1:l.parab===1?e.p1=e.p2:l.parcd===0?e.q2=e.q1:l.parcd===1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=i:a.a2>=Math.PI/2?e.p2=t:e.q2=i:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=i:e.q2=i}}InternalCut(e,t,i,n,o,a,l){let u=!1;if(n>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.P.pp(this.P.Next(t)).point,f=m.getTriangleOrientation(c,h,this.Q.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.Q.pp(this.Q.Next(i)).point,f=m.getTriangleOrientation(c,h,this.P.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.q2=this.Q.Next(i):e.q1=this.Q.Prev(i),u=!0}return u}GetAnglesAtTheMedian(e,t,i,n,o){o.a1=m.anglePCP(n,i,this.P.pnt(this.P.Prev(e))),o.a2=m.anglePCP(this.P.pnt(this.P.Next(e)),i,n),o.b1=m.anglePCP(this.Q.pnt(this.Q.Next(t)),n,i),o.b2=m.anglePCP(i,n,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,i){let n=e.p2===this.P.Next(e.p1),o=e.q1===this.Q.Next(e.q2);return n&&!o?(this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),!0):o&&!n?(this.SwapEverything(e,t,i),this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),this.SwapEverything(e,t,i),!0):!1}SwapEverything(e,t,i){this.SwapPq();let n=e.p2;e.p2=e.q1,e.q1=n,n=e.q2,e.q2=e.p1,e.p1=n,n=t.mq,t.mq=t.mp,t.mp=n,n=i.a2,i.a2=i.b1,i.b1=n,n=i.b2,i.b2=i.a1,i.a1=n}ProcessShortSide(e,t,i,n,o,a,l){t===e.p2?this.ProcessSide(e,i,n,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=i:o>=Math.PI/2?e.q1=i:a<l&&(m.canProject(this.Q.pnt(i),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=i:e.p1=e.p2):n+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,i,n,o){let a=this.Q.pnt(t);i<=Math.PI?i+n>=Math.PI?i>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:i<o&&(m.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,n>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,i,n,o){return e.p1===e.p2?(o>=Math.PI/2?e.q1=i:e.q2=i,!0):e.q1===e.q2?(n>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,i,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,i,e.q2)}CalculateRightTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,i,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,i,e.q2)}};var hr=class{static mkFromPoints(e){return new hr(re.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,i,n){let o=n.rotate(Math.PI/2);this.polyline.startPoint.point.sub(i).dot(o)<0&&(o=o.mul(-1)),e===t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!==t);return e}static TestPolygonDist(e,t){let i=Number.MAX_SAFE_INTEGER;for(let n=0;n<e.count;n++)for(let o=0;o<t.count;o++){let a=D.minDistBetweenLineSegments(e.pnt(n),e.pnt(n+1),t.pnt(o),t.pnt(o+1));i=Math.min(i,a.dist)}return i}static Distance(e,t){let n=new Vl(e,t).FindClosestPoints();return{p:n.pClosest,q:n.qClosest,dist:n.pClosest.sub(n.qClosest).length}}static DistanceOnly(e,t){return hr.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let i=t.startPoint;i.next!=null&&i.next.next!=null;i=i.next)if(m.getTriangleOrientation(i.point,i.next.point,i.next.next.point)===2)return!1;return!0}static DistancePoint(e,t){let i=Number.MAX_VALUE;for(let n=0;n<e.count;n++){let o=m.distToLineSegment(t,e.points[n].point,e.points[(n+1)%e.count].point).dist;i=Math.min(i,o)}return i}GetTangentPoints(e,t){let i=new Ky(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=i.FindMaximum(),e.rightTangentPoint=i.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return i=>{let n=m.anglePCP(t,e,this.pnt(i));return n<Math.PI?n:n-2*Math.PI}}};var Oe=class{ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(D.mkPP(e,t))}static PadCorner(e,t,i,n,o){let a=Oe.GetPaddedCorner(t,i,n,o);return a.numberOfPoints===-1?!1:(e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return m.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t){return Oe.CreatePaddedPolyline(L.polylineAroundClosedCurve(e),t)}static LoosePolylineWithFewCorners(e,t){return t<A.distanceEpsilon?e:Oe.CreateLoosePolylineOnBisectors(e,t)}static CreateLoosePolylineOnBisectors(e,t){return re.mkClosedFromPoints(gi.CalculateConvexHull(Oe.BisectorPoints(e,t)))}static CreateRectNodeOfPolyline(e){return gt(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=Oe.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(Oe.LoosePolylineWithFewCorners(e,t))}this.RootOfLooseHierarchy=Oe.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=Oe.CreateTightObstacles_(this.Obstacles,this.TightPadding,this.TightObstacles),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size===0}constructor(e,t,i,n){this.Obstacles=e,this.TightPadding=t,this.LoosePadding=i,this.IgnoreTightPadding=n}ObstaclesIntersectICurve(e){let t=e.boundingBox;return Oe.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,i){if(!i.irect.intersects(t))return!1;if(i.UserData!=null){let n=i.UserData;return L.intersectionOne(n,e,!1)!=null||Oe.PointIsInside(n.start,e)}return Oe.CurveIntersectsRectangleNode(e,t,i.Left)||Oe.CurveIntersectsRectangleNode(e,t,i.Right)}static PointIsInside(e,t){return L.PointRelativeToCurveLocation(e,t)===2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(n=>L.polylineAroundClosedCurve(n)),t=Oe.CalculateHierarchy(e),i=Oe.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,i.size===0){for(let n of e){let o=Oe.FindMaxPaddingForTightPolyline(t,n,this.TightPadding);this.TightObstacles.add(Oe.LoosePolylineWithFewCorners(n,o))}this.RootOfTightHierarchy=Oe.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let n of e)this.TightObstacles.add(Oe.CreatePaddedPolyline(n,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=Oe.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;Oe.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=Oe.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(i)),this.OverlapsDetected=!0}}static CreateTightObstacles_(e,t,i){if(e.length===0)return null;for(let n of e)Oe.CalculateTightPolyline(i,t,n);return Oe.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(i)}static CalculateTightPolyline(e,t,i){let n=Oe.PaddedPolylineBoundaryOfNode(i,t);e.add(n)}static CalculateHierarchy(e){let t=e.map(i=>Oe.CreateRectNodeOfPolyline(i));return rt(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=Oe.CalculateHierarchy(Array.from(e)),i;for(;(i=Oe.GetOverlappedPairSet(t)).size>0;)t=Oe.ReplaceTightObstaclesWithConvexHulls(e,Array.from(i));return t}static MapToInt(e){let t=new Map;for(let i=0;i<e.length;i++)t.set(e[i],i);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let i=new Set;for(let u of t)i.add(u[0]),i.add(u[1]);let n=Array.from(i),o=Oe.MapToInt(n),a=Fp(Array.from(t).map(u=>new Se(o.get(u[0]),o.get(u[1])))),l=Wn(a);for(let u of l){let c=u.map(f=>n[f]),h=Bo(c,f=>f),d=gi.createConvexHullAsClosedPolyline(h);for(let f of c)e.delete(f);e.add(d)}return Oe.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return L.PointRelativeToCurveLocation(e.start,t)!==0||L.PointRelativeToCurveLocation(t.start,e)!==0}static PolylinesIntersect(e,t){return L.CurvesIntersect(e,t)||Oe.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return Xt(e,e,(i,n)=>{Oe.PolylinesIntersect(i,n)&&t.add([i,n])}),t}static BisectorPoints(e,t){let i=new Array;for(let n=e.startPoint;n!=null;n=n.next){let o={skip:!1},a=Oe.GetStickingVertexOnBisector(n,t,o);o.skip||i.push(a)}return i}static GetStickingVertexOnBisector(e,t,i){let n=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(n).normalize().add(o.sub(a).normalize()),u=l.length;return u<A.tolerance?i.skip=!0:(i.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,i){let n=i,o=new hr(t),a=t.boundingBox.clone();a.pad(2*i);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!==t)){let u=hr.Distance(o,new hr(l)).dist;n=Math.min(n,u/Oe.LooseDistCoefficient)}return n}static GetPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point;if(m.getTriangleOrientation(o,a,l)===1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(Oe.CornerIsNotTooSharp(o,a,l)){u=u.mul(n);let S=l.sub(a).normalize().mul(n).rotate(Math.PI/2),x=m.lineLineIntersection(o.add(u),a.add(u),a.add(S),l.add(S));return{a:x,b:x,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<A.intersectionEpsilon){let S=a.add(u.mul(n));return{a:S,b:S,numberOfPoints:1}}let h=c.normalize().mul(n),d=h.rotate(Math.PI/2),f=(n-h.dot(u))/d.dot(u),p=d.mul(f);return{a:h.add(p).add(a),b:h.sub(p).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,i){let n=e.sub(t).rotate(Math.PI/4).add(t);return m.getTriangleOrientation(t,n,i)===1}static CreatePaddedPolyline(e,t){let i=new re;if(!Oe.PadCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t))return Oe.CreatePaddedPolyline(re.mkClosedFromPoints(Array.from(gi.CalculateConvexHull(e))),t);if(!Oe.PadCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t))return Oe.CreatePaddedPolyline(re.mkClosedFromPoints(Array.from(gi.CalculateConvexHull(e))),t);for(let n=e.startPoint;n.next.next!=null;n=n.next)if(!Oe.PadCorner(i,n,n.next,n.next.next,t))return Oe.CreatePaddedPolyline(re.mkClosedFromPoints(Array.from(gi.CalculateConvexHull(e))),t);return i.closed=!0,i}},dr=Oe;dr.LooseDistCoefficient=2.1;var Rd=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,i){let n=new Rd;return n.TightPolyline=e,n.LooseShape=t,n.Distance=i,n}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var _d=class{constructor(e,t,i,n){this.MainShape=e,this.TightPadding=t,this.LoosePadding=i,this.ShapesToTightLooseCouples=n}Calculate(){this.MainShape.Children.length!==0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=rt(this.MainShape.Children.map(t=>gt(t,t.BoundingBox)));Qr(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){_d.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return L.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)===2}CreateTigthLooseCouples(){let e=new Array;for(let t of this.tightHierarchy.GetAllLeaves()){let i=dr.FindMaxPaddingForTightPolyline(this.tightHierarchy,t,this.LoosePadding),n=dr.LoosePolylineWithFewCorners(t,i);e.push(Rd.mk(t,new Cs(n),i))}this.coupleHierarchy=rt(e.map(t=>gt(t,t.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=dr.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=dr.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),i=Bo(this.LoosePolylinesUnderShape(e),o=>o).filter(o=>L.PointRelativeToCurveLocation(o,t)===0);if(i.length<=0)return t;let n=Array.from(t).concat(i);return re.mkClosedFromPoints(gi.CalculateConvexHull(n))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var Nv=me(tr());var Zy=class{constructor(e,t,i){this.indexToA=e,this.priority=t,this.v=i}};var _r=class{constructor(e=Me){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let i=++this.heapSize,n=new Zy(i,t,e);for(this.cache.set(e,n),this.A[i]=n;i>1&&this.compare(this.A[i>>1].priority,t)>0;)this.SwapWithParent(i),i>>=1}IsEmpty(){return this.heapSize===0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this.compare(this.A[n].priority,this.A[t].priority)<0&&(i=n);let o=n+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[i].priority)<0&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}this.heapSize--}DecreasePriority(e,t){let i=this.cache.get(e);if(!i)return;i.priority=t;let n=i.indexToA;for(;n>1&&this.compare(this.A[n].priority,this.A[n>>1].priority)<0;){this.SwapWithParent(n);n>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count===0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new Nv.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var ma=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,this._visGraph.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new _r(Me);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source===this.source||this.targets.has(e.Target)||!ma.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target===this.source||!ma.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof xr}ProcessNeighbor(e,t,i){let n=t.Length,o=this.current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),i!==this.source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!==this.source);return e.push(this.source),e.reverse()}};var xc=class{constructor(e,t,i){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=i,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new _r(Me);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let i={priority:0},n=t.DequeueAndGetPriority(i);if(i.priority>=this._target.Distance)break;for(let o of n.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,n,o,a)}for(let o of n.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,n,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source===this._source||e.Target===this._target||!xc.IsForbidden(e)}PassableInEdge(e){return e.Source===this._target||e.Target===this._source||!xc.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof xr}ProcessNeighborN(e,t,i,n,o){let a=i.Length+o,l=t.Distance+a;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&l<n.Distance&&(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}ProcessNeighbor(e,t,i,n){let o=i.Length,a=t.Distance+o;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&a<n.Distance&&(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,i=this._target;do t.push(i),e&&this._visGraph.ShrinkLengthOfPrevEdge(i,this.LengthMultiplier),i=this._visGraph.PreviosVertex(i);while(i!==this._source);return t.push(this._source),t.reverse()}};var Bv=me(tr()),ig=class{toString(){return Bv.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var Dv=me(tr()),ng=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return Dv.String.Format("{0},{1}",this.Start,this.End)}};var og=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(m.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,i){return m.closeDistEps(e,m.ClosestPointAtLineSegment(e,t,i))}static IntersectDiagonalWithRay(e,t,i){let n=t.sub(e),o=i.Start,a=i.End,l=zn.solve(a.x-o.x,n.x*-1,e.x-o.x,a.y-o.y,n.y*-1,e.y-o.y);return e.add(n.mul(l.y))}};var Is=class{constructor(e){this.pivot=e}IComparer(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=e.Start.point.sub(this.pivot),n=t.Start.point.sub(this.pivot);return Is.CompareVectorsByAngleToXAxis(i,n)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Is.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Is.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let i=e.x*t.y-e.y*t.x;if(i>A.tolerance)return-1;if(i<-A.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let n=Math.abs(e.x)-Math.abs(t.x);return n<0?-1:n>0?1:(n=Math.abs(e.y)-Math.abs(t.y),n<0?-1:n>0?1:0)}};var Vo=class extends ye{constructor(e,t,i){super(null);this.activeDiagonalComparer=new og;this.polygons=e,this.visibilityGraph=i,this.addedPolygons=t}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let e of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(e);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(e){this.currentPolygon=e,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new Ct(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let e=1;e<this.tangents.length;e++){let t=this.tangents[e];t.Diagonal!=null?(t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsHigh&&this.RemoveDiagonalFromActiveNodes(t.Diagonal)):t.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=t.End.point,this.InsertActiveDiagonal(new ig(t,t.Comp)),t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t))}}AddVisibleEdge(e){et.AddEdgeVV(Fv(this.visibilityGraph,e.start),Fv(this.visibilityGraph,e.End))}InitActiveDiagonals(){if(this.tangents.length===0)return;let e=this.tangents[0],t=e.start.point,i=e.End.point;for(let n of this.diagonals)if(Vo.RayIntersectDiagonal(t,i,n)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=og.IntersectDiagonalWithRay(t,i,n),this.InsertActiveDiagonal(n)),e.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(e),e.IsLow===!1){let o=e.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(e){let t=this.activeDiagonalTree.deleteSubTree(e.RbNode);t!=null&&t.item!=null&&(t.item.RbNode=t),e.LeftTangent.Diagonal=null,e.RightTangent.Diagonal=null}InsertActiveDiagonal(e){e.RbNode=this.activeDiagonalTree.insert(e),Vo.MarkDiagonalAsActiveInTangents(e)}static MarkDiagonalAsActiveInTangents(e){e.LeftTangent.Diagonal=e,e.RightTangent.Diagonal=e}static RayIntersectDiagonal(e,t,i){let n=i.Start,o=i.End;return m.getTriangleOrientation(e,n,o)===1&&m.getTriangleOrientation(e,t,n)!==1&&m.getTriangleOrientation(e,t,o)!==0}static TangentComparison(e,t){return Is.CompareVectorsByAngleToXAxis(e.End.point.sub(e.start.point),t.End.point.sub(t.start.point))}*AllObstacles(){for(let e of this.addedPolygons)yield e;for(let e of this.polygons)yield e}OrganizeTangents(){for(let e of this.AllObstacles())e!==this.currentPolygon&&this.ProcessPolygonQ(e);this.tangents.sort(Vo.TangentComparison)}ProcessPolygonQ(e){let t=new Vl(this.currentPolygon,e);this.useLeftPTangents?t.CalculateLeftTangents():t.CalculateRightTangents();let i=this.useLeftPTangents?t.leftPLeftQ:t.rightPLeftQ,n=new ng(this.currentPolygon.pp(i[0]),e.pp(i[1]));n.IsLow=!0,n.SeparatingPolygons=!this.useLeftPTangents,i=this.useLeftPTangents?t.leftPRightQ:t.rightPRightQ;let o=new ng(this.currentPolygon.pp(i[0]),e.pp(i[1]));o.IsLow=!1,o.SeparatingPolygons=this.useLeftPTangents,n.Comp=o,o.Comp=n,this.tangents.push(n),this.tangents.push(o),this.diagonals.push(new ig(n,o))}};function Fv(s,e){return s.FindVertex(e.point)}var Md=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(m.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),i=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*i.y-i.x*t.y)<A.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,i){let n=zn.solve(t.x-e.x,-i.x,this.Pivot.x-e.x,t.y-e.y,-i.y,this.Pivot.y-e.y);if(!(-A.tolerance<=n.x&&n.x<=1+A.tolerance))throw new Error;if(!n)throw new Error;return this.Pivot.add(i.mul(n.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let i=new Md;return i.pivot=e,i.pointOnTheRay=t,i}};var Gv=me(tr()),kl=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!==this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!==this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return Gv.String.Format("Stem({0},{1})",this.Start,this.End)}};var Jn=class{constructor(e,t,i,n){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=i,this.qPolylinePoint=Ut.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=n;let o=new Is(this.q);this.heapForSorting=new Nl(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,i,n){let o=t.FindVertex(i);if(o!=null)return o;let a=new Jn(e,t,i,n);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!==0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let i=!1;for(let n of t.Sides()){let o=n;if(o.point.y<this.q.y){if(n.nextOnPolyline.point.y>=this.q.y){let a=m.getTriangleOrientation(this.q,o.point,n.nextOnPolyline.point);if(a===1||a===2){i=!0,yield new kl(t.Start,n),yield new kl(n.nextOnPolyline,t.End),this.RegisterActiveSide(n);break}}}else{if(o.point.y>this.q.y)break;if(n.point.x>=this.q.x){i=!0,yield new kl(n,t.End),n!==t.Start&&(yield new kl(t.Start,e.prev(o))),this.RegisterActiveSide(n);break}}}i||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new m(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=Jn.GetIncomingSide(e),i=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let n;if(n=this.sideNodes.get(t)){if(n===this.activeSidesTree.treeMinimum()&&this.AddEdge(e),i!=null)n.item=i,this.sideNodes.set(i,n);else{let o=this.activeSidesTree.deleteSubTree(n);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(i!=null){let o;(o=this.sideNodes.get(i))||(o=this.activeSidesTree.insert(i),this.sideNodes.set(i,o),o===this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind===0||this.visibilityKind===1&&Jn.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,i)=>new xr(t,i))}static LineTouchesPolygon(e,t){let i=t.polyline.prev(t).point,n=t.polyline.next(t).point,o=t.point;return m.signedDoubledTriangleArea(e,o,i)*m.signedDoubledTriangleArea(e,o,n)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e===t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Md,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new Ct(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,i=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))i=!1;let n=e.next(t);if(i)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,n);n=e.next(n));this.visibleBoundaries.set(e,new kl(t,n))}HoleSideIsVisibleFromQ(e,t){return m.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-A.squareOfDistanceEpsilon}};var sg=class{constructor(e,t){this.next=null;this.prev=null;this.PolylinePoint=e,this.OriginalPosition=t}get PolylinePoint(){return this.polylinePoint}set PolylinePoint(e){this.polylinePoint=e}get OriginalPosition(){return this.originalPosition}set OriginalPosition(e){this.originalPosition=e}get Next(){return this.next}set Next(e){this.next=e}get Prev(){return this.prev}set Prev(e){this.prev=e}};var He=class extends ye{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=W.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}get Obstacles(){return this.obstacles_}set Obstacles(e){this.obstacles_=e}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(e){this.enteringAngleBound_=e}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(e){this._sourceTightPolyline=e}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(e){this.targetTightPolyline=e}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(e){this.targetLoosePolyline=e}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(e){this.visibilityGraph=e}get SourcePort(){return this.sourcePort}set SourcePort(e){if(this.sourcePort=e,this.sourcePort!=null)if(this.SourceTightPolyline=He.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Zr)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let t=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(t.Curve,t.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(e){this.targetPort=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=e)}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(e){this.startPointOfRouting_=e}ExtendVisibilityGraphToLocation(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new et);let t=null;if(!this.activeRectangle.contains(e)){this.activeRectangle.isEmpty?this.activeRectangle=W.mkPP(this.SourcePort.Location,e):this.activeRectangle.add(e),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null||t.length===0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Vo(t,this.activePolygons,this.VisibilityGraph).run(),No(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(e){this.targetVV=Jn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,e,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=Jn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(e,t,i){let n=e.value(t),o=e.leftDerivative(t).normalize().add(e.rightDerivative(t).normalize()).normalize();m.getTriangleOrientation(He.PointInsideOfConvexCurve(e),n,n.add(o))==1&&(o=o.mul(-1)),o=o.rotate(Math.PI/2);let a=i.boundingBox.diagonal,l=D.mkPP(n,n.add(o.mul(a))),u=L.intersectionOne(l,i,!1).x,c=o.mul(u.sub(n).length/2);for(;;){l=D.mkPP(n,u.add(c));let h=!1;for(let d of He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(l,this.ObstacleCalculator.RootOfLooseHierarchy))if(d.seg1!==i){c=c.div(1.5),h=!0;break}if(!h)break}return l.end}static PointInsideOfConvexCurve(e){return e.value(0).add(e.value(1.5)).div(2)}*GetActivePolylines(){for(let e of this.activePolygons)yield e.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let e=this.activeRectangle,t=new Array,i;do{i=!1;for(let n of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(n)||(e.addRec(n.boundingBox),t.push(new hr(n)),this.alreadyAddedOrExcludedPolylines.add(n),i=!0);i&&(this.activeRectangle=e)}while(i);return t}RelaxPolyline(){let e=He.CreateRelaxedPolylinePoints(this._polyline);for(e=e.Next;e.Next!=null;e=e.Next)this.RelaxPolylinePoint(e)}static CreateRelaxedPolylinePoints(e){let t=e.startPoint,i=new sg(t,t.point),n=i;for(;t.next!=null;){t=t.next;let o=new sg(t,t.point);o.Prev=n,n.Next=o,n=o}return i}RelaxPolylinePoint(e){if(!(e.PolylinePoint.prev.prev==null&&this.SourcePort instanceof Rr&&e.PolylinePoint.polyline!==this.SourceLoosePolyline)&&!(e.PolylinePoint.next.next==null&&this.TargetPort instanceof Rr&&e.PolylinePoint.polyline!==this.TargetLoosePolyline))for(let t=this.OffsetForPolylineRelaxing;t>A.distanceEpsilon&&!this.RelaxWithGivenOffset(t,e);)t/=2}RelaxWithGivenOffset(e,t){return He.SetRelaxedPointLocation(e,t),this.StickingSegmentDoesNotIntersectTightObstacles(t)?!0:(He.PullCloserRelaxedPoint(t.Prev),!1)}static PullCloserRelaxedPoint(e){e.PolylinePoint.point=e.OriginalPosition.mul(.2).add(e.PolylinePoint.point.mul(.8))}StickingSegmentDoesNotIntersectTightObstacles(e){return!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Prev.PolylinePoint.point)&&(e.Next==null||!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Next.PolylinePoint.point))}PolylineSegmentIntersectsTightHierarchy(e,t){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,i){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(D.mkPP(e,t),i)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t){if(!e.boundingBox.intersects(t.irect))return!1;if(t.UserData!=null){for(let i of L.getAllIntersections(e,t.UserData,!1))if(i.seg1!==this.SourceTightPolyline&&i.seg1!==this.TargetTightPolyline||(i.seg1===this.SourceTightPolyline&&this.SourcePort)instanceof Rr||(i.seg1===this.TargetTightPolyline&&this.TargetPort)instanceof Rr)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,t){let i=new Array;return He.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i),i}static IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i){if(t!=null&&!!e.boundingBox.intersects(t.irect)){if(t.UserData!=null){No(i,L.getAllIntersections(e,t.UserData,!0));return}He.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Left,i),He.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Right,i)}}LineCanBeAcceptedForRouting(e){let t=this.SourcePort instanceof Zr,i=this.TargetPort instanceof Zr;if(!t&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.end,this.SourcePort)||!i&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.start,this.TargetPort))return!1;let n=He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy);for(let o of n)if(o.seg1!==this.SourceTightPolyline&&o.seg1!==this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(e,t){let i=t.Curve,n=dr.CurveIsClockwise(i,He.PointInsideOfConvexCurve(i)),o=t.Location,a=this.GetPointOnTheRightBoundaryPortConeSide(o,i,n,t.Parameter),l=this.GetPointOnTheLeftBoundaryPortConeSide(o,i,n,t.Parameter);return m.getTriangleOrientation(o,a,e)!==0&&m.getTriangleOrientation(o,e,l)!==0}GetPointOnTheRightBoundaryPortConeSide(e,t,i,n){let o=i?t.rightDerivative(n):t.leftDerivative(n).neg();return e.add(o.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(e,t,i,n){let o=i?t.leftDerivative(n).neg():t.rightDerivative(n);return e.add(o.rotate(-this.EnteringAngleBound))}static SetRelaxedPointLocation(e,t){let i=m.getTriangleOrientation(t.Next.OriginalPosition,t.OriginalPosition,t.Prev.OriginalPosition)==1,n=t.Next.OriginalPosition.sub(t.Prev.OriginalPosition).normalize().mul(e).rotate(Math.PI/2);i||(n=n.neg()),t.PolylinePoint.point=t.OriginalPosition.add(n)}SmoothCorners(e){let t=e.headSite,i={b:null,c:null};for(;i=L.findCorner(t);)t=this.SmoothOneCorner(t,i.c,i.b)}SmoothOneCorner(e,t,i){let a=.5,l,u,c;e.prev==null?(c=2,u=1):t.next==null?(c=1,u=2):u=1,c=1;do l=L.createBezierSeg(a*c,a*u,e,i,t),i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u,a/=1.5;while(this.ObstacleCalculator.ObstaclesIntersectICurve(l)&&a>.01);return a*=1.5,a<.5&&a>.01&&(a=.5*(a+a*1.5),l=L.createBezierSeg(a*c,a*u,e,i,t),this.ObstacleCalculator.ObstaclesIntersectICurve(l)||(i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u)),i}TryToRemoveInflectionsAndCollinearSegments(e){let t=!0,i={s:null};for(;t;)for(t=!1,i.s=e.headSite;i.s!=null&&i.s.next!=null;i.s=i.s.next)i.s.turn*i.s.next.turn<0&&(t=this.TryToRemoveInflectionEdge(i)||t)}TryToRemoveInflectionEdge(e){if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.point)){let t=e.s.prev,i=e.s.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.next.point)){let t=e.s.prev,i=e.s.next.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.point,e.s.next.next.point)){let t=e.s.next.next;return e.s.next=t,t.prev=e.s,!0}return!1}GetShortestPolyline(e,t){this.CleanTheGraphForShortestPath();let n=new xc(this.visibilityGraph,e,t).GetPath(this.UseEdgeLengthMultiplier);if(n==null)return null;let o=new re;for(let a of n)o.addPoint(a.point);return He.RemoveCollinearVertices(o)}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}static RemoveCollinearVertices(e){for(let t=e.startPoint.next;t.next!=null;t=t.next)m.getTriangleOrientation(t.prev.point,t.point,t.next.point)===2&&(t.prev.next=t.next,t.next.prev=t.prev);return e}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(e){this.ObstacleCalculator.RootOfTightHierarchy=e}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(e){this.ObstacleCalculator.RootOfLooseHierarchy=e}CalculateObstacles(){this.ObstacleCalculator=new dr(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}RouteEdgeToLocation(e){this.TargetPort=new Zr(null,e),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let t=new Xe(null),i=D.mkPP(this.SourcePort.Location,e);return this.LineCanBeAcceptedForRouting(i)?(this._polyline=new re,this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=xt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):this.SourcePort instanceof Rr&&(i=D.mkPP(this.StartPointOfEdgeRouting,e),He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(i,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new re,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=xt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):(this.ExtendVisibilityGraphToLocation(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this.SourcePort instanceof Rr&&this._polyline.PrependPoint(this.SourcePort.Location),t.smoothedPolyline=xt.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t)}RouteEdgeToPort(e,t,i,n){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),D.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=e,this.TargetTightPolyline=He.GetFirstHitPolyline(e.Location,this.ObstacleCalculator.RootOfTightHierarchy),e instanceof Rr?this.RouteEdgeToBoundaryPort(t,i,n):this.RouteEdgeToFloatingPortOfNode(t,i,n))}SmoothedPolylineFromTwoPoints(e,t){return this._polyline=new re,this._polyline.addPoint(e),this._polyline.addPoint(t),xt.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(e,t,i){return this.sourcePort instanceof Zr?this.RouteFromFloatingPortToFloatingPort(e,t,i):this.RouteFromBoundaryPortToFloatingPort(e,t,i)}RouteFromBoundaryPortToFloatingPort(e,t,i){let n=this.SourcePort.Location,o=this.targetPort.Location,a=D.mkPP(n,o);if(this.LineCanBeAcceptedForRouting(a))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a;if(!this.targetIsInsideOfSourceTightPolyline){let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(a=D.mkPP(u,o),this.LineAvoidsTightHierarchyLP(a,e))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let l=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=l,this.RelaxPolyline(),this._polyline.PrependPoint(n),this.SmoothCornersAndReturnCurve(t,i)}SmoothCornersAndReturnCurve(e,t){return t.smoothedPolyline=xt.mkFromPoints(this._polyline),e&&this.SmoothCorners(t.smoothedPolyline),t.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(e,t,i){let n=this.TargetPort.Location,o=D.mkPP(this.StartPointOfEdgeRouting,n);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(o,this.SourceTightPolyline,this.targetTightPolyline)?(i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),i.smoothedPolyline=xt.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(t,i)))}TryShortcutPolyline(){if(this.UseInnerPolylingShortcutting)for(;this.ShortcutPolylineOneTime(););this.UsePolylineEndShortcutting&&this.TryShortCutThePolylineEnds()}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let e=this._polyline.endPoint,t=e.prev;if(t==null)return;let i=t.prev;if(i==null)return;let n=m.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=Ut.mkFromPoint(n);o.next=e,o.prev=i,e.prev=o,i.next=o}}TryShortcutPolylineStart(){let e=this._polyline.startPoint,t=e.next;if(t==null)return;let i=t.next;if(i==null)return;let n=m.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=Ut.mkFromPoint(n);o.prev=e,o.next=i,e.next=o,i.prev=o}}ShortcutPolylineOneTime(){let e=!1;for(let t=this._polyline.startPoint;t.next!=null&&t.next.next!=null;t=t.next)e=e||this.TryShortcutPolyPoint(t);return e}TryShortcutPolyPoint(e){return this.LineAvoidsTightHierarchyLPP(D.mkPP(e.point,e.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(e.next=e.next.next,e.next.prev=e,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new et);let t=null,i=this.targetPort.Location;if(!this.activeRectangle.contains(i)){this.activeRectangle.isEmpty?this.activeRectangle=W.mkPP(this.SourcePort.Location,i):this.activeRectangle.add(i),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new Vo(t,this.activePolygons,this.VisibilityGraph).run(),No(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(e,t){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(e,t):this.targetVV=Jn.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(t),this.VisibilityGraph,e,1)}AddTransientVisibilityEdgesForPort(e,t){let i=this.GetVertex(e);if(i!=null)return i;if(i=this.visibilityGraph.AddVertexP(e),t!=null)for(let n of t)this.visibilityGraph.AddEdgeF(e,n,(o,a)=>new xr(o,a));else i=Jn.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,e,1);return i}GetVertex(e){let t=this.visibilityGraph.FindVertex(e);return t==null&&this.LookForRoundedVertices&&(t=this.visibilityGraph.FindVertex(A.RoundPoint(e))),t}*GetActivePolylinesWithException(e){for(let t of this.activePolygons)t.Polyline!==e&&(yield t.Polyline)}RouteEdgeToBoundaryPort(e,t,i){return this.TargetLoosePolyline=e,this.sourcePort instanceof Zr?this.RouteFromFloatingPortToBoundaryPort(t,i):this.RouteFromBoundaryPortToBoundaryPort(t,i)}RouteFromBoundaryPortToBoundaryPort(e,t){let i=this.SourcePort.Location,n,o=this.targetPort.Location,a=D.mkPP(i,o);if(this.LineCanBeAcceptedForRouting(a))this._polyline=new re,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),n=xt.mkFromPoints(this._polyline).createCurve();else{let l=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(a=D.mkPP(i,l),this.InsideOfTheAllowedConeOfBoundaryPort(l,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(a,this._sourceTightPolyline))this._polyline=new re,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(a=D.mkPP(this.StartPointOfEdgeRouting,o),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(a))this._polyline=new re,this._polyline.addPoint(i),this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),n=this.SmoothCornersAndReturnCurve(e,t);else{let u;if(u=D.IntersectPPPP(i,this.StartPointOfEdgeRouting,o,l))this._polyline=new re,this._polyline.addPoint(i),this._polyline.addPoint(u),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(m.closeDistEps(this.StartPointOfEdgeRouting,l))this._polyline=new re,this._polyline.addPoint(i),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(this.LineAvoidsTightHierarchy(D.mkPP(this.StartPointOfEdgeRouting,l)))this._polyline=new re,this._polyline.addPoint(i),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else{this.ExtendVisibilityGraphToTargetBoundaryPort(l),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let c={tmpTargetTight:null},h=this.HideSourceTargetTightsIfNeeded(c);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(h,c.tmpTargetTight),this.RelaxPolyline(),this._polyline.PrependPoint(i),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t)}}}return n}RecoverSourceTargetTights(e,t){this.SourceTightPolyline=e,this.TargetTightPolyline=t}HideSourceTargetTightsIfNeeded(e){let t=this.SourceTightPolyline;return e.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,t}LineAvoidsTightHierarchy(e){return He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy).length===0}RouteFromFloatingPortToBoundaryPort(e,t){let i=this.targetPort.Location,n;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(n=D.mkPP(this.SourcePort.Location,i),this.LineCanBeAcceptedForRouting(n)))return t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(n.start,n.end),n;let o=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(n=D.mkPP(this.SourcePort.Location,o),this.LineAvoidsTightHierarchyLP(n,this._sourceTightPolyline))return this._polyline=re.mkFromPoints([n.start,n.end,i]),t.smoothedPolyline=xt.mkFromPoints(this._polyline),t.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(o),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this._polyline.addPoint(i);let a={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(e,a)}LineAvoidsTightHierarchyLP(e,t){let i=!0;for(let n of He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(n.seg1!==t){i=!1;break}return i}LineAvoidsTightHierarchyLPP(e,t,i){let n=!0;for(let o of He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(!(o.seg1===t||o.seg1===i)){n=!1;break}return n}LineAvoidsTightHierarchyPPPP(e,t,i,n){return this.LineAvoidsTightHierarchyLPP(D.mkPP(e,t),i,n)}ExtendVisibilityGraphToTargetBoundaryPort(e){let t=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new et),!this.activeRectangle.contains(e)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(e)):(this.activeRectangle.add(e),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Vo(t,this.activePolygons,this.VisibilityGraph).run(),No(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(e){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:He.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(e,t){let i=He.GetFirstHitRectangleNode(e,t);return i?i.UserData:null}static GetFirstHitRectangleNode(e,t){return t==null?null:t.FirstHitNodePF(e,(i,n)=>L.PointRelativeToCurveLocation(i,n)!==0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(e,t){this.SourceLoosePolyline=t,this.sourcePort=e,this.sourcePort!=null&&(this.SourceTightPolyline=He.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Zr?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new et,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let t of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(t);let e;this.UseSpanner?e=new ga(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):e=new Vo(new Array,this.activePolygons,this.visibilityGraph),e.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e,t,i,n){let o=e instanceof Zr&&t instanceof Rr||e instanceof qt;if(o){let l=e;e=t,t=l}this.sourcePort=e,this.targetPort=t,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let a=this.GetEdgeGeomByRouting(i,n);return a==null?null:(this.targetVV=null,this.sourceVV=null,o&&(a=a.reverse()),a)}GetEdgeGeomByRouting(e,t){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||L.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)===2;let i;if(this.sourcePort instanceof Rr){let n=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?n.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(n.Curve,n.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let o={smoothedPolyline:null};this.targetPort instanceof Rr?i=this.RouteFromBoundaryPortToBoundaryPort(e,o):i=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,e,o)}else this.targetPort instanceof Zr?(this.ExtendVisibilityGraphFromFloatingSourcePort(),i=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,e,t)):i=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,e,t,this.targetPort);return i}RouteFromFloatingPortToAnywherePort(e,t,i,n){return n.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(e))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),this.FixLastPolylinePointForAnywherePort(n),n.HookSize>0&&this.BuildHook(n),this.SmoothCornersAndReturnCurve(t,i))):(i.smoothedPolyline=null,null)}BuildHook(e){let t=e.Curve,i=de.mkFullEllipseNNP(e.HookSize,e.HookSize,this._polyline.end),n=L.getAllIntersections(t,i,!0);m.getTriangleOrientation(n[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&n.reverse();let o=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),a=t.derivative(n[0].par0).normalize(),l=a.dot(o);if(Math.abs(l)<.2)this.ExtendPolyline(a,n[0],o,e);else{let u=t.derivative(n[1].par0).normalize();u.dot(o)<l?this.ExtendPolyline(u,n[1],o,e):this.ExtendPolyline(a,n[0],o,e)}}ExtendPolyline(e,t,i,n){let o=e.rotate(Math.PI/2);o.dot(i)<0&&(o=o.neg());let a=t.x.add(o.mul(n.HookSize)),l;!(l=m.lineLineIntersection(a,a.add(e),this._polyline.end,this._polyline.end.add(i)))||(this._polyline.addPoint(l),this._polyline.addPoint(a),this._polyline.addPoint(t.x))}FixLastPolylinePointForAnywherePort(e){for(;;){let t=this.GetLastPointInsideOfCurveOnPolyline(e.Curve);t.next.next=null,this._polyline.endPoint=t.next;let i=t.next.point.sub(t.point);i=i.normalize().mul(e.Curve.boundingBox.diagonal);let n=i.rotate(e.AdjustmentAngle*-1),o=i.rotate(e.AdjustmentAngle),a=L.intersectionOne(e.Curve,D.mkPP(t.point,t.point.add(n)),!0),l=L.intersectionOne(e.Curve,D.mkPP(t.point,t.point.add(o)),!0);if(a==null||l==null)return;let u=He.GetTrimmedCurveForHookingUpAnywhere(e.Curve,t,a,l),c=u.value(u.closestParameter(t.point));if(!this.LineAvoidsTightHierarchyLPP(D.mkPP(t.point,c),this.SourceTightPolyline,null)){let h=L.intersectionOne(e.Curve,D.mkPP(t.point,t.next.point),!1);if(h==null)return;this._polyline.endPoint.point=h.x;break}if(this._polyline.endPoint.point=c,t.prev==null||!this.TryShortcutPolyPoint(t.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(e,t,i,n){let o=m.getTriangleOrientation(n.x,i.x,t.point)===0,a=i.par0,l=n.par0,u,c,h;return o?a<l?e.trim(a,l):(c=e.trim(a,e.parEnd),u=e.trim(e.parStart,l),h=new L,h.addSegs([c,u])):l<a?e.trim(l,a):(c=e.trim(l,e.parEnd),u=e.trim(e.parStart,a),h=new L,h.addSegs([c,u]))}GetLastPointInsideOfCurveOnPolyline(e){for(let t=this._polyline.endPoint.prev;t!=null;t=t.prev)if(t.prev==null||L.PointRelativeToCurveLocation(t.point,e)===2)return t;throw new Error}GetShortestPolylineToMulitpleTargets(e,t){this.CleanTheGraphForShortestPath();let n=new ma(e,t,this.VisibilityGraph).GetPath();if(n==null)return null;let o=new re;for(let a of n)o.addPoint(a.point);return He.RemoveCollinearVertices(o)}Targets(e){return Array.from(e).map(t=>this.visibilityGraph.FindVertex(t))}ExtendVisibilityGraphFromFloatingSourcePort(){let e=this.sourcePort;this.StartPointOfEdgeRouting=e.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=Jn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(t=>t!==this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let e=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=He.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=He.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),e=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=He.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=He.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=W.mkPP(new m(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new m(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let e of this.ObstacleCalculator.LooseObstacles)yield new hr(e)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(e){No(this.activePolygons,e)}ClearActivePolygons(){this.activePolygons=[]}};var uT=me(gs());var ko=class{constructor(){this.size_=0;this.mapOfMaps=new bt}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let i=e.first,n=e.second,o=this.mapOfMaps.get(i);o==null&&this.mapOfMaps.set(i,o=new bt),o.has(n)||this.size_++,o.set(n,t)}delete(e){let t=e.first,i=e.second,n=this.mapOfMaps.get(t);n!=null&&n.deleteP(i)&&this.size_--}has(e){let t=this.mapOfMaps.get(e.first);return t!=null&&t.has(e.second)}get_(e,t){return this.get(new _t(e,t))}get(e){let t=this.mapOfMaps.get(e.first);if(t!=null)return t.get(e.second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new _t(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[i,n]of t)yield[new _t(e,i),n]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var Jr=class{static GetShapes(e,t=Array.from(e.edges())){let i=new Map;Vv(e,i);for(let n of t){let o=i.get(n.source);o&&n.sourcePort!=null&&o.Ports.add(n.sourcePort),o=i.get(n.target),o&&n.targetPort!=null&&o.Ports.add(n.targetPort)}return Array.from(i.values())}static CreateShapeWithCenterPort(e){let t=new Sc(()=>e.boundaryCurve),i=ji.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);for(let n of e.inEdges())Jr.FixPortAtTarget(i,n);for(let n of e.outEdges())Jr.FixPortAtSource(i,n);for(let n of e.selfEdges())Jr.FixPortAtSource(i,n),Jr.FixPortAtTarget(i,n);return t}static CreateShapeWithClusterBoundaryPort(e){let t=new Sc(()=>e.boundaryCurve),i=Or.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);let n;for(let o of e.inEdges())o.EdgeToAncestor()===2?(n==null&&(n=new qt(()=>e.boundaryCurve)),o.targetPort=n):Jr.FixPortAtTarget(i,o);for(let o of e.outEdges())o.EdgeToAncestor()===1?(n==null&&(n=new qt(()=>e.boundaryCurve)),o.sourcePort=n):Jr.FixPortAtSource(i,o);for(let o of e.selfEdges())Jr.FixPortAtSource(i,o),Jr.FixPortAtTarget(i,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function Vv(s,e){for(let t of s.shallowNodes)if(t instanceof Ie){let i=Jr.CreateShapeWithClusterBoundaryPort(t);e.set(t,i);let n=t;if(!n.isCollapsed){Vv(n,e);for(let o of n.shallowNodes)i.AddChild(e.get(o))}}else e.set(t,Jr.CreateShapeWithCenterPort(t))}var Qy=me(un()),Uv=me(tr());var kv=me(tr());var ba=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,i,n){let o=new ba(e);return o.Left=e,o.Right=t,o.Gap=i,o.IsEquality=n,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return kv.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t===0&&(t=this.Right.CompareTo(e.Right)),t===0&&(t=Me(this.Gap,e.Gap)),t}};var zv=me(tr()),zl=class{static constructorDCVV(e,t,i,n){let o=new zl(t);return o.Set(e,t,i,n),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,i,n){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=i,this.VariableDoneEval=n,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval===this.ConstraintToEval.Right}toString(){return zv.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var Wv=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Cc=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return Uv.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new Qy.Stack;let t=new ba(e);this.dfDvDummyParentNode=new zl(t);let i=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(i);;){let n=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!n.ChildrenHaveBeenPushed){n.ChildrenHaveBeenPushed=!0;for(let a of n.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Right,n.VariableToEval);a.Right.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of n.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Left,n.VariableToEval);a.Left.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(n),n===i)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,i,n){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,i,n):zl.constructorDCVV(e,t,i,n);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable===e.VariableToEval){for(;e.Parent!==this.dfDvDummyParentNode;)this.constraintPath.push(new Wv(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let i=new Array;this.GetConnectedVariables(i,e.Right,e.Left);let n=e.Violation,o=i.length;for(let a=0;a<o;a++)i[a].OffsetInBlock=i[a].OffsetInBlock+n;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let i=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,n=this.Variables.length;for(let o=0;o<n;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<i&&(t=a,i=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Cc(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length===1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,i=e.OffsetInBlock/e.Scale,n=t*e.Weight;this.sumAd+=n*e.DesiredPos,this.sumAb+=n*i,this.sumA2+=n*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let i=0;i<t;i++){let n=this.Variables[i];n.ActualPos=(e+n.OffsetInBlock)/n.Scale}}GetConnectedVariables(e,t,i){this.RecurseGetConnectedVariables(e,t,i)}RecurseGetConnectedVariables(e,t,i){this.allConstraints.DfDvStack=new Qy.Stack;let n=new ba(t);for(this.dfDvDummyParentNode=new zl(n),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,n,t,i)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!==o.VariableDoneEval&&(l.Right.ActiveConstraintCount===1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!==o.VariableDoneEval&&(l.Left.ActiveConstraintCount===1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,i){this.GetConnectedVariables(e.Variables,t,i);let n=e.Variables.length;for(let a=0;a<n;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block===e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length===0){for(let a=0;a<n;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var Jy=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var $y=me(un()),e0=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new $y.Stack;this.DfDvRecycleStack=new $y.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var Nd=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new ag}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new Nd;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},ag=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new ag;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var Hv=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},jv=class{constructor(e,t){this.Value=e,this.Column=t}},mi=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!==0&&(this.newMatrixRow.push(new jv(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new Hv(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let i of this.matrixQ[t.Ordinal])i.Column===t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(i.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let i=0;i<t.length;i++)t[i].Column===e?t[i].Value=1:t[i].Value=t[i].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[i].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;mi.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=mi.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!==0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=mi.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t===0)return!1;let i=e/t;mi.VectorCopy(this.vectorPrevY,this.vectorCurY),mi.VectorScaledVectorSubtract(this.vectorPrevY,i,this.gradientVector,this.vectorCurY);for(let n=0;n<this.vectorCurY.length;n++)this.vectorQpscVars[n].Variable.DesiredPos=this.vectorCurY[n];return!0}PostProject(){for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;mi.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=mi.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!==0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let i=mi.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=i===0?1:e/i,t>1?t=1:t<0&&(t=0)}return mi.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let i=this.previousFunctionValue-e,n=0;if(i!==0){let o=this.previousFunctionValue!==0?this.previousFunctionValue:e;n=Math.abs(i/o)}(Math.abs(i)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(n)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return mi.VectorVectorMultiply(this.gradientVector,e)/2+mi.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let i=0;for(let n=0;n<e.length;n++)i=i+e[n]*t[n];return i}MatrixVectorMultiply(e,t){let i=0;for(let n of this.matrixQ){let o=0;for(let a of n)o=o+a.Value*e[a.Column];t[i++]=o}}static VectorVectorAdd(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]+t[n]}static VectorVectorSubtract(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]-t[n]}static VectorScaledVectorSubtract(e,t,i,n){for(let o=0;o<e.length;o++)n[o]=e[o]-t*i[o]}static VectorCopy(e,t){for(let i=0;i<t.length;i++)e[i]=t[i]}};var vc=class{constructor(){this.NumberOfUnsatisfiableConstraints=0;this.OuterProjectIterations=0;this.InnerProjectIterationsTotal=0;this.MinInnerProjectIterations=0;this.MaxInnerProjectIterations=0;this.MaxConstraintTreeDepth=0;this.GoalFunctionValue=0;this.TimeLimitExceeded=!1;this.OuterProjectIterationsLimitExceeded=!1;this.InnerProjectIterationsLimitExceeded=!1}get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new vc;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var qv=me(tr());var Xv=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},t0=class{constructor(e,t,i,n,o){this.ActiveConstraintCount=0;if(n<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=i*n;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=i*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=i,this.Weight=n,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new Xv(e,t))}toString(){return qv.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return Me(this.Ordinal,e.Ordinal)}};var ug=class{get IsFull(){return this.numConstraints===ug.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(ug.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let i=this.numConstraints-1;i>=0;i--){let n=this.constraints[i];if(n.Left.Block===e||n.Right.Block===e||n.IsActive||n.IsUnsatisfiable)i<this.numConstraints-1&&(this.constraints[i]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints===0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let i=0;i<this.numConstraints;i++){let n=this.constraints[i],o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o>e&&(e=o,t=n)}return t}Insert(e,t){let i=0,n=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<n?(o=n,i=a,n=u):u<o&&(o=u)}this.IsFull?(this.constraints[i]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=n))}},lg=ug;lg.MaxConstraints=20;var r0=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},i0=class{constructor(){this.allBlocks=new Jy;this.allConstraints=new e0;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new lg;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new Nd;this.solverSolution=new vc}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,i){return this.AddVariableANNN(e,t,i,1)}AddVariableANNN(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new t0(this.nextVariableOrdinal++,e,t,i,n),a=new Cc(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new r0(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return Bo(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let i=t.Constraints.length;for(let n=0;n<i;n++){let o=t.Constraints[n];if(e===o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!0)}AddConstraintVVNB(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e===t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=ba.constructorVVNB(e,t,i,n);return this.loadedVariablesAndConstraintLists.set(e,new r0(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,n&&this.equalityConstraints.push(l),l}AddConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!1)}SetConstraintUpdate(e,t){t!==e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,i){if(i<=0||Number.isNaN(i)||!Number.isFinite(i))throw new Error("relationshipWeight");if(e===t)throw new Error;e.AddNeighbor(t,i),t.AddNeighbor(e,i),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.floor(Math.log2(this.numberOfVariables))+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.max(0,Math.floor(Math.log2(this.numberOfConstraints)))+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new vc,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints===0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length===0)return;let e=this.IsQpsc;for(let[t,i]of this.updatedConstraints){let n=t;if(n.UpdateGap(i),!e&&!n.IsEquality){this.SplitOnConstraintIfActive(n);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),i=t.Constraints,n=0,o=0,a=0;i!=null&&(n=i.length,o=t.NumberOfLeftConstraints,a=n-o);let l=this.emptyConstraintList;o!==0&&(l=new Array(o));let u=this.emptyConstraintList;a!==0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<n;d++){let f=i[d];e===f.Left?l[c++]=f:u[h++]=f}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){if(!this.RunProject())return;if(!this.SplitBlocks())break}}RunProject(){return this.solverSolution.OuterProjectIterations++,this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let i=this.allBlocks.item(t),n=i.Variables.length;for(let o=0;o<n;o++){let a=i.Variables[o];this.solverSolution.GoalFunctionValue+=a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue-=2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new mi(this.solverParams,this.numberOfVariables);for(let i of this.allBlocks.Vector)for(let n of i.Variables)e.AddVariable(n);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1;for(;!(!e.PreProject()&&!t||(t=this.SplitBlocks(),!this.RunProject())||!e.PostProject()&&!t););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){return this.RunProject()}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let i of t.Variables){i.Reinitialize();let n=new Cc(i,this.allConstraints);this.allBlocks.Add(n)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block===e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints===0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,i={maxViolation:0},n=this.GetMaxViolatedConstraint(i,e);if(!n)return!1;for(;n;){if(n.Left.Block===n.Right.Block?(n.Left.Block.Expand(n),n.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=n.Left.Block):this.lastModifiedBlock=this.MergeBlocks(n),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};n=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,i=e.Right.Block,n=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);i.Variables.length>t.Variables.length&&(t=e.Right.Block,i=e.Left.Block,n=-n);let o=i.Variables.length;for(let a=0;a<o;a++){let l=i.Variables[a];l.OffsetInBlock+=n,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(i),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let n=0;n<t;n++){let a=this.allBlocks.item(n).Split(this.IsQpsc);a!=null&&e.push(a)}let i=e.length;for(let n=0;n<i;n++){let o=e[n];this.allBlocks.Add(o)}return e.length!==0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let i=this.SearchViolationCache(e.maxViolation);return i!=null?i:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let i=this.lastModifiedBlock.Variables.length;for(let o=0;o<i;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);_p(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!==this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);_p(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let n=this.violationCache.FindIfGreater(e);return n!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=n),t}SearchAllConstraints(e,t){let i=null;this.violationCache.Clear();for(let n of this.allConstraints.Vector){if(n.IsActive)break;if(n.IsUnsatisfiable)continue;let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale),a=null,l=0;_p(o,e)&&(e>this.violationCache.LowViolation&&(a=i,l=e),e=o,i=n),t&&(a==null&&n!==i&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=n,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return i}};var hg=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,i){this.variables.set(e,this.solver.AddVariableANN(e,t,i))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,i,n){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,i,n)}AddLeftRightSeparationConstraintNNN(e,t,i){this.AddLeftRightSeparationConstraintNNNB(e,t,i,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,i){let n=this.GetVariable(e);if(n==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(n,o,i)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let i;do{this.solution=null;let n=null;if(e!=null&&(n=e,n==null))throw new Error("parameters");this.solution=this.solver.SolvePar(n),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,i=this.AdjustConstraintsForMovedFixedVars()}while(i&&this.solution.ExecutionLimitExceeded===!1);return this.solution.ExecutionLimitExceeded===!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,i]of this.fixedVars.entries())hg.Close(i,this.GetVariableResolvedPosition(t))||e.add(t);return e.size===0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let i of e){t=i;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let i={successInAdjusting:!1},n=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,i);if(!i.successInAdjusting||n.length===0)return!1;for(let o of n)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let i=this.variables.get(e).Block.Variables,n=new cn,o=new cn,a=1;for(let l of i)!this.fixedVars.has(l.UserData)||(n.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,n.length/o.length)));return a===1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(i,a),i.map(l=>l.UserData)}FixActiveConstraints(e,t){let i=!1;for(let n of e)for(let o of n.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(i=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return i}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new i0,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,hg.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},cg=hg;cg.FixedVarWeight=1e9;var n0=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var o0=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new cg;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let i=this.Var(t);i.LowBound=Math.max(e,i.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let i=this.Var(e);i.UpperBound=Math.min(t,i.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!==Number.NEGATIVE_INFINITY&&this.constraints.add(new Se(this.GetBoundId(t.LowBound),e)),t.UpperBound!==Number.POSITIVE_INFINITY&&this.constraints.add(new Se(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!==Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!==Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=Sr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=Ui.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new Se(e,t))}AddVariableNNNN(e,t,i,n){this.idealPositions.set(e,i),this.AddVariableNNBN(e,t,!1,n)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,i,n){let o=new n0;o.Position=t,o.IsFixed=i,o.Width=n,this.varList.push(o)}};var Yv=me(gs());var s0=class extends Mi{constructor(e,t){super(e,t);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=j.DirectionFromPointToPoint(e.point,t.point)}AddRightNeighbor(e){this.RightNeighbors.add(e)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(e){this.setOfLongestSegs.add(e)}BoundFromRight(e){e=Math.max(e,this.LeftBound),this.RightBound=Math.min(e,this.RightBound)}BoundFromLeft(e){e=Math.min(e,this.RightBound),this.LeftBound=Math.max(e,this.LeftBound)}};var Ni=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,i){for(t--;e<t;t--)this.SetNewNext(i[t])}InsertVertsInReverse(e,t,i){for(e++;e<t;e++)this.SetNewNext(i[e])}SetNewNext(e){let t=new Ni(e),i=this.Next;this.Next=t,t.Next=i}};var Ac=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return le(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return Ac.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?j.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var $r=class{constructor(e){this.pathVisibilityGraph=new et;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(n(),e.Width),i=t.next();for(i.done||e.SetFirstEdge(i.value);(i=t.next()).done===!1;)e.AddEdge(i.value);function*n(){if(e.PathPoints instanceof Ni)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let i=e.next(),n=i.value;for(;!(i=e.next()).done;)yield this.CreatePathEdge(n,i.value,t),n=i.value}CreatePathEdge(e,t,i){switch(j.DirectionFromPointToPoint(e,t)){case 2:case 1:return new Ac(this.GetAxisEdge(e,t),i);case 4:case 8:{let o=new Ac(this.GetAxisEdge(t,e),i);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(i,n)=>new s0(i,n))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of $r.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort($r.CompareTwoPathEdges);let i=0;for(let n of t)n.Index=i++}static CompareTwoPathEdges(e,t){if(e===t)return 0;let i=$r.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return i!==0?i:-$r.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,j.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,i,n){for(;;){if(e=$r.GetNextPathEdgeInDirection(e,i,n),e==null||(t=$r.GetNextPathEdgeInDirection(t,i,n),t==null))return 0;if(e.AxisEdge===t.AxisEdge){n=$r.FindContinuedDirection(i,n,e.AxisEdge),i=e.AxisEdge;let c=$r.GetExistingOrder(e,t);if(c===$r.NotOrdered)continue;return n===i.Direction?c:-c}let o=n===i.Direction?i.Target:i.Source,a=$r.OtherVertex(e.AxisEdge,o),l=$r.OtherVertex(t.AxisEdge,o),u=$r.ProjectionForCompare(i,n!==i.Direction);return Me(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,i){return e.Direction===t?i.Source===e.Target?i.Direction:j.OppositeDir(i.Direction):i.Source===e.Source?i.Direction:j.OppositeDir(i.Direction)}static OtherVertex(e,t){return e.Source===t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction===1?t?i=>-i.x:i=>i.x:t?i=>i.y:i=>-i.y}static GetNextPathEdgeInDirection(e,t,i){return t.Direction===i?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let i=e.Index;if(i===-1)return $r.NotOrdered;let n=t.Index;return Me(i,n)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,i){for(let n of i.Vertices()){let o=n.InEdgesLength();t.set(n,o),o===0&&e.enqueue(n)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new Yv.Queue,i=new Map;for($r.InitQueueOfSources(t,i,e);t.length>0;){let n=t.dequeue();for(let o of n.OutEdges){let a=i.get(o.Target);i.set(o.Target,a-1),a===1&&t.enqueue(o.Target),yield o}}}},dg=$r;dg.NotOrdered=Number.MAX_VALUE;var a0=class extends cr{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var fg=class extends cr{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var l0=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size===0}};var Pa=class extends Ld{constructor(e,t,i,n,o){super(t,new j(e).ToPoint());this.DirectionPerp=new j(e).Right.ToPoint(),this.PathOrders=n,this.xProjection=e===1?a=>a.x:a=>-a.y,this.edgeContainersTree=new Ct((a,l)=>this.CompareAA(a,l)),this.SweepPole=j.VectorDirection(this.SweepDirection),this.AxisEdges=o,this.AxisEdgesToObstaclesTheyOriginatedFrom=i}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(e){e instanceof qi?this.ProcessVertexEvent(e):(this.Z=this.GetZP(e.Site),e instanceof fg?this.ProcessLowEdgeEvent(e):this.ProcessHighEdgeEvent(e))}ProcessHighEdgeEvent(e){let t=e.AxisEdge;this.RemoveEdge(t),this.ConstraintEdgeWithObstaclesAtZ(t,t.Target.point)}ProcessLowEdgeEvent(e){let t=e.AxisEdge,i=this.GetOrCreateAxisEdgesContainer(t);i.item.AddEdge(t);let n=this.edgeContainersTree.previous(i);if(n!=null)for(let a of n.item.edges)for(let l of i.item.edges)this.TryToAddRightNeighbor(a,l);let o=this.edgeContainersTree.next(i);if(o!=null)for(let a of i.item.Edges)for(let l of o.item.edges)this.TryToAddRightNeighbor(a,l);this.ConstraintEdgeWithObstaclesAtZ(t,t.Source.point)}TryToAddRightNeighbor(e,t){this.ProjectionsOfEdgesOverlap(e,t)&&e.AddRightNeighbor(t)}ProjectionsOfEdgesOverlap(e,t){return this.SweepPole===1?!(e.TargetPoint.y<t.SourcePoint.y-A.distanceEpsilon||t.TargetPoint.y<e.SourcePoint.y-A.distanceEpsilon):!(e.TargetPoint.x<t.SourcePoint.x-A.distanceEpsilon||t.TargetPoint.x<e.SourcePoint.x-A.distanceEpsilon)}GetObstacleBoundaries(e){return this.Obstacles.map(t=>be.mkDebugCurveWCI(1,e,t))}ConstraintEdgeWithObstaclesAtZ(e,t){this.ConstraintEdgeWithObstaclesAtZFromLeft(e,t),this.ConstraintEdgeWithObstaclesAtZFromRight(e,t)}ConstraintEdgeWithObstaclesAtZFromRight(e,t){let i=this.GetActiveSideFromRight(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromRight(n.dot(this.DirectionPerp))}GetActiveSideFromRight(e){return this.LeftObstacleSideTree.findFirst(t=>Pa.PointToTheLeftOfLineOrOnLineLocal(e,t.Start,t.End))}ConstraintEdgeWithObstaclesAtZFromLeft(e,t){let i=this.GetActiveSideFromLeft(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromLeft(n.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>-Pa.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<Pa.AreaComparisonEpsilon}GetActiveSideFromLeft(e){return this.RightObstacleSideTree.findLast(t=>Pa.PointToTheRightOfLineOrOnLineLocal(e,t.Start,t.End))}static EdgeMidPoint(e){return m.middle(e.SourcePoint,e.TargetPoint)}GetOrCreateAxisEdgesContainer(e){let t=e.Source.point,i=this.GetAxisEdgesContainerNode(t);return i!=null?i:this.edgeContainersTree.insert(new l0(t))}GetAxisEdgesContainerNode(e){let t=this.xProjection(e),i=this.edgeContainersTree.findFirst(n=>this.xProjection(n.Source)>=t-A.distanceEpsilon/2);return i!=null&&this.xProjection(i.item.Source)<=t+A.distanceEpsilon/2?i:null}ProcessVertexEvent(e){this.Z=this.GetZS(e),e instanceof Fo?this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline):e instanceof Go?this.ProcessRightVertex(e,e.Vertex.prevOnPolyline):(this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline),this.ProcessRightVertex(e,e.Vertex.prevOnPolyline))}ProcessRightVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForRightVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=A.distanceEpsilon?o>0&&a>=0?this.EnqueueEvent(new Go(t)):this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex):(this.InsertRightSide(new Ts(e.Vertex)),this.EnqueueEvent(new Go(t)),this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex))}RestrictEdgeContainerToTheRightOfEvent(e){let t=e.point,i=this.xProjection(t),n=this.edgeContainersTree.findFirst(o=>i<=this.xProjection(o.Source));if(n!=null)for(let o of n.item.Edges)this.NotRestricting(o,e.polyline)||o.BoundFromLeft(this.DirectionPerp.dot(t))}NotRestricting(e,t){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(e)===t}ProcessPrevSegmentForRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;t.sub(i).dot(this.SweepDirection)>A.distanceEpsilon&&this.RemoveRightSide(new Ts(e.Vertex.nextOnPolyline))}RemoveEdge(e){let t=this.GetAxisEdgesContainerNode(e.Source.point);t.item.RemoveAxis(e),t.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(t)}ProcessLeftVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForLeftVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=A.distanceEpsilon?o<0&&a>=0&&this.EnqueueEvent(new Fo(t)):(this.InsertLeftSide(new As(e.Vertex)),this.EnqueueEvent(new Fo(t))),this.RestrictEdgeFromTheLeftOfEvent(e.Vertex)}RestrictEdgeFromTheLeftOfEvent(e){let t=e.point,i=this.GetContainerNodeToTheLeftOfEvent(t);if(i!=null)for(let n of i.item.Edges)this.NotRestricting(n,e.polyline)||n.BoundFromRight(t.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(e){let t=this.xProjection(e);return this.edgeContainersTree.findLast(i=>this.xProjection(i.Source)<=t)}ProcessPrevSegmentForLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;t.sub(i).dot(this.SweepDirection)>A.distanceEpsilon&&this.RemoveLeftSide(new As(e.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let e of this.AxisEdges)this.EnqueueEventsForEdge(e)}EnqueueEventsForEdge(e){this.EdgeIsParallelToSweepDir(e)&&(this.EnqueueEvent(Pa.EdgeLowPointEvent(e,e.Source.point)),this.EnqueueEvent(Pa.EdgeHighPointEvent(e,e.Target.point)))}EdgeIsParallelToSweepDir(e){return e.Direction===this.SweepPole||e.Direction===j.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(e,t){return new a0(e,t)}static EdgeLowPointEvent(e,t){return new fg(e,t)}CompareAA(e,t){return Me(e.Source.dot(this.DirectionPerp),t.Source.dot(this.DirectionPerp))}},pg=Pa;pg.AreaComparisonEpsilon=A.intersectionEpsilon;var u0=class extends Fl{constructor(e){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=e}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(e){if(this.Edges.length===0){let t=j.VectorDirectionPP(e.Source,e.Target);switch(t){case 4:t=1;break;case 8:t=2;break}this.CompassDirection=t,this.start=e.Source,this.end=e.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(e.Source),this.TryPointForStartAndEndNorth(e.Target);break;case 2:this.TryPointForStartAndEndEast(e.Source),this.TryPointForStartAndEndEast(e.Target);break}this.Edges.push(e)}TryPointForStartAndEndNorth(e){e.y<this.start.y?this.start=e:e.y>this.end.y&&(this.end=e)}TryPointForStartAndEndEast(e){e.x<this.start.x?this.start=e:e.x>this.end.x&&(this.end=e)}get IsFixed(){return this._isFixed}set IsFixed(e){this._isFixed=e}get Width(){let e=0;for(let t of this.edges)e=Math.max(e,t.Width);return e}GetLeftBound(){if(!this.IsFixed){let e=Number.NEGATIVE_INFINITY;for(let t of this.edges)e=Math.max(e,t.AxisEdge.LeftBound);return e}return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let e=Number.POSITIVE_INFINITY;for(let t of this.edges)e=Math.min(e,t.AxisEdge.RightBound);return e}return this.Position()}Position(){return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var dn=class{constructor(e,t){this.tree=new Ct((e,t)=>Me(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length===0||this.HorizontalPoints.length===0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){le(e.Next.Point.x,e.Point.x)?t===dn.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,i,n,o=e.Y;if(e.Point.x<e.Next.Point.x?(i=e.Point.x,t=e.Next.Point.x,n=!0):(t=e.Point.x,i=e.Next.Point.x,n=!1),n)for(let a=this.tree.findFirst(l=>i<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new m(a.item.Point.x,o);e=dn.TrySplitHorizontalPoint(e,l,!0),dn.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=i;a=this.tree.previous(a)){let l=new m(a.item.Point.x,o);e=dn.TrySplitHorizontalPoint(e,l,!1),dn.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){dn.Low(e)+A.distanceEpsilon<t.y&&t.y+A.distanceEpsilon<dn.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,i){return i&&e.X+A.distanceEpsilon<t.x&&t.x+A.distanceEpsilon<e.Next.X||!i&&e.Next.X+A.distanceEpsilon<t.x&&t.x+A.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new _r(Me);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,dn.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var ya=class{constructor(e){this.verticesToPathOffsets=new bt;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,i=null;for(let n=e.PathPoints;n!=null;n=n.Next){let o=this.verticesToPathOffsets.get(n.Point);if(i!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,n),t.delete(a))}for(let[a,l]of i)o.has(a)||t.set(a,l)}i=o}}CollapseLoopingPath(e,t,i,n,o){let a=ya.FindLinkedPointInPath(n,t.Point),l=Array.from(ya.GetPointsInBetween(a,o));ya.Before(t,i)?(this.CleanDisappearedPiece(t,i,e),this.ReplacePiece(t,i,l,e)):(this.CleanDisappearedPiece(i,t,e),this.ReplacePiece(i,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let i=e.Next;i!==t;i=i.Next)yield i.Point}ReplacePiece(e,t,i,n){let o=e;for(let a of i){let l=new Ni(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(n,o)}o.Next=t}CleanDisappearedPiece(e,t,i){for(let n of ya.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(n).delete(i)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e===t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let i=e.PathPoints;;i=i.Next)if(i.Point.equal(t))return i}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let i=this.verticesToPathOffsets.get(t.Point);i||this.verticesToPathOffsets.set(t.Point,i=new Map);let n=i.get(e);n?(this.CleanDisappearedPiece(n,t,e),n.Next=t.Next):i.set(e,t)}}};var c0=class{constructor(e){this.projection=e}compare(e,t){return Me(this.projection(e),this.projection(t))}};var Kv=me(vd()),Cr=class{static RefinePaths(e,t){Cr.AdjustPaths(e);let i=Cr.CreatePathsToFirstLinkedVerticesMap(e);Cr.Refine(Array.from(i.values())),Cr.CrossVerticalAndHorizontalSegs(i.values()),Cr.ReconstructPathsFromLinkedVertices(i),t&&new ya(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=Cr.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length===0)return;let t=[],i=A.RoundPoint(e[0]);t.push(i);for(let n=1;n<e.length;n++){let o=A.RoundPoint(e[n]);i.equal(o)||(i=o,t.push(i))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,i=new Array;for(let n of e)for(let o=n;o.Next!=null;o=o.Next)le(o.Point.x,o.Next.Point.x)?i.push(o):t.push(o);new dn(t,i).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,i]of e)t.PathPoints=i}static Refine(e){Cr.RefineInDirection(1,e),Cr.RefineInDirection(2,e)}static*groupByProj(e,t){let i=new Map;for(let n of t){let o=e(n.Point),a=i.get(o);a||(a=new Array,i.set(o,a)),a.push(n)}for(let n of i.values())yield n}static RefineInDirection(e,t){let i={projectionToPerp:void 0,projectionToDirection:void 0};Cr.GetProjectionsDelegates(e,i);let n=Array.from(Cr.GetAllLinkedVertsInDirection(i.projectionToPerp,t)),o=Cr.groupByProj(i.projectionToPerp,n);for(let a of o)Cr.RefineCollinearBucket(a,i.projectionToDirection)}static GetProjectionsDelegates(e,t){e===2?(t.projectionToDirection=i=>i.x,t.projectionToPerp=i=>i.y):(t.projectionToPerp=i=>i.x,t.projectionToDirection=i=>i.y)}static*GetAllLinkedVertsInDirection(e,t){for(let i of t)for(let n=i;n.Next!=null;n=n.Next)le(e(n.Point),e(n.Next.Point))&&(yield n)}static RefineCollinearBucket(e,t){let i=new Kv.SortedMap(new c0(t));for(let a of e)i.has(a.Point)||i.set(a.Point,0),i.has(a.Next.Point)||i.set(a.Next.Point,0);let n=new Array(i.size),o=0;for(let a of i.keys())n[o++]=a;for(o=0;o<n.length;o++)i.set(n[o],o);for(let a of e){o=i.get(a.Point);let l=i.get(a.Next.Point);Math.abs(l-o)>1&&Cr.InsertPoints(a,n,o,l)}}static InsertPoints(e,t,i,n){i<n?e.InsertVerts(i,n,t):e.InsertVertsInReverse(n,i,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let i of e)t.set(i,Cr.CreateLinkedVertexOfEdgePath(i));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,i=new Ni(t[0]),n=i;for(let o=1;o<t.length;o++)i.Next=new Ni(t[o]),i=i.Next;return n}};var ws=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I===t.I&&e.Points===t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var Ls=class{constructor(e,t){this.segTree=new ml(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new ml(t),this.Paths=e}static RemoveStaircases(e,t){new Ls(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(i=>!this.crossedOutPaths.has(i)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new ws(e.pts,0),new ws(e.pts,1),new ws(e.pts,2),new ws(e.pts,3)],i=0;for(let n=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,n,t,o))return e.canHaveStaircase=!0,n;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,n++,e.pts.length<n+5)return-1;t[i]=new ws(e.pts,n+3),i++,i%=4}}static GetFlippedPoint(e,t){return le(e[t].y,e[t+1].y)?new m(e[t+4].x,e[t].y):new m(e[t].x,e[t+4].y)}Crossing(e,t,i){return Ls.IsCrossing(D.mkPP(e,t),this.segTree,i)}static IsCrossing(e,t,i){for(let n of t.GetAllIntersecting(e.boundingBox))if(i.findIndex(o=>o===n)===-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,i){return this.IntersectObstacleHierarchyL(D.mkPP(e,t))||this.IntersectObstacleHierarchyL(D.mkPP(t,i))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>L.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,i,n){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return n.canHaveStaircaseAtI=!1,j.DirectionFromPointToPoint(o,a)!==j.DirectionFromPointToPoint(l,u)||j.DirectionFromPointToPoint(a,l)!==j.DirectionFromPointToPoint(u,c)||(l=Ls.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(n.canHaveStaircaseAtI=!0,!this.Crossing(a,l,i))}RemoveStaircasePN(e,t){let i=e[t],n=e[t+1],o=Math.abs(i.y-n.y)<A.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,i){this.RemoveSegs(e);let n=new Array(e.length-2);PN(e,n,t+1);let o=e[t+1],a=e[t+3];return n[t+1]=i?new m(a.x,o.y):new m(o.x,a.y),bN(e,t+4,n,t+2,n.length-t-2),this.InsertNewSegs(n,t),n}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new ws(e,t))}RemoveSeg(e){this.segTree.Remove(Ls.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let i=new ws(e,t);this.segTree.Add(Ls.Rect(i),i)}static Rect(e){return W.mkPP(e.Start,e.End)}};function bN(s,e,t,i,n){for(;n-- >0;)t[i++]=s[e++]}function PN(s,e,t){let i=0;for(;t-- >0;)e[i++]=s[i++]}var pt=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,i,n){this.AncestorsSets=n,this.HierarchyOfGroups=rt(Array.from(n.keys()).filter(o=>o.IsGroup).map(o=>gt(o,o.BoundingBox))),this.Obstacles=i,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=rt(i.map(o=>gt(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length===0)return;let t=e.PathPoints,i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],pt.ObstacleTest),n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],pt.ObstacleTest);i!=null&&n!=null&&this.PathToObstacles.set(e,[i.UserData,n.UserData])}static ObstacleTest(e,t){return L.PointRelativeToCurveLocation(e,t)!==0?1:0}Calculate(e,t){this.NudgingDirection=e,Cr.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let i=this.FindLastUnmappedEdge(e);for(let n=t;n!=null&&n!==i;n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(n.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.LastEdge;i!=null&&j.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.FirstEdge;i!=null&&j.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new dg(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let i=new Array;for(let n of e){let o=new re;for(let a of n.PathPoints)o.addPoint(a);i.push(o)}return i.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)pt.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let i=e.LastEdge;i.Width=Math.max(t.targetArrowhead.width,i.Width)}if(t.sourceArrowhead!=null){let i=e.FirstEdge;i.Width=Math.max(t.sourceArrowhead.width,i.Width)}}PositionShiftedEdges(){this.Solver=new o0(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];pt.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),i=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>i&&(e.IdealPosition=i)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return pt.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x===t.x||e.y===t.y)return t;let i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i<n?new m(e.x,t.y):new m(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],i=e.FirstEdge;t.push(this.ShiftedPoint(i.Source,i.LongestNudgedSegment));for(let n of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(n));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let i=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection===1?new m(i,e.y):new m(e.x,-i)}static LineSegOfLongestSeg(e,t){let i=t===2?o=>o.x:o=>o.y,n={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)pt.UpdateMinMaxWithPoint(n,i,o.Source),pt.UpdateMinMaxWithPoint(n,i,o.Target);return t===2?new D(n.min,-e.IdealPosition,n.max,-e.IdealPosition):new D(e.IdealPosition,n.min,e.IdealPosition,n.max)}static UpdateMinMaxWithPoint(e,t,i){let n=t(i);e.min>n&&(e.min=n),e.max<n&&(e.max=n)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let i of e.Edges){let n=i.AxisEdge;if(n!=null)for(let o of n.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let i of t)this.ConstraintTwoLongestSegs(e,i)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)pt.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return le(e.SourcePoint.x,e.TargetPoint.x);default:return le(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let i of e.filter(n=>n.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,i.LongestNudgedSegment),t=i}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,pt.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),i=e.GetRightBound();t>=i?(this.Solver.AddFixedVariable(e.Id,pt.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,pt.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!==Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),i!==Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,i))}}static SegmentPosition(e,t){return t===1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new pg(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let i=t.BoundingBox;for(let n of e.PathEdges()){let o=n.AxisEdge;o.Direction===this.NudgingDirection&&this.BoundAxisEdgeByRect(i,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=pt.MapPortsToShapes(this.AncestorsSets.keys()));let t=yN(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(i=>!i.Children.some(n=>t.has(n)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(W.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection===2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),pt.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let i=null,n=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(i=a.LongestNudgedSegment,n!=null){let l;pt.SetIdealPositionForSeg(n,l=t(n.start),o,t(i.Start)),o=l,n=null}}else i!=null&&(n=i,i=null);n!=null?pt.SetIdealPositionForSeg(n,t(n.Start),o,t(e.End)):i!=null&&(i.IdealPosition=t(i.Start))}static SetIdealPositionForSeg(e,t,i,n){let o=Math.max(i,n),a=Math.min(i,n);a+A.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,i=j.OppositeDir(this.NudgingDirection);for(let n of e.PathEdges()){let o=n.Direction;o===this.NudgingDirection||o===i?(t==null?(n.LongestNudgedSegment=t=new u0(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):n.LongestNudgedSegment=t,n.IsFixed&&(t.IsFixed=!0)):(n.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(i=>i.clone())};return pt.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){pt.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),pt.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let i=e.points.length-1,n=j.VectorDirectionPP(e.points[i-1],e.points[i]);if(pt.ProjectionsAreClose(e.points[i-1],n,t)){e.points=e.points.slice(0,i);return}let o=e.points[i];n===2||n===8?e.points[i]=new m(t.x,o.y):e.points[i]=new m(o.x,t.y)}static ProjectionsAreClose(e,t,i){return t===2||t===8?le(e.x,i.x):le(e.y,i.y)}static ExtendPolylineToSourcePort(e,t){let i=j.VectorDirectionPP(e.points[0],e.points[1]);if(pt.ProjectionsAreClose(e.points[1],i,t)){e.points=e.points.slice(1);return}let n=e.points[0];i===2||i===8?e.points[0]=new m(t.x,n.y):e.points[0]=new m(n.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],i=e[0];t.push(i);let n=e[1],o=j.VectorDirectionPP(i,n),a=1;for(;++a<e.length;){let l=j.VectorDirectionPP(n,e[a]);l===o||j.OppositeDir(l)===o||l===0||(m.closeDistEps(i,n)||t.push(i=pt.Rectilinearise(i,n)),o=l),n=e[a]}return m.closeDistEps(i,n)||t.push(pt.Rectilinearise(i,n)),t}static NudgePaths(e,t,i,n,o){if(e.length===0)return;let a=new pt(e,t,i,n);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=re.mkFromPoints(pt.BuildPolylineForPath(l))}RemoveStaircases(){Ls.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let i of e)for(let n of i.Ports)t.set(n,i);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,i,n){let o=n.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield be.mkDebugCurveTWCI(200,e+l*u,i,D.mkPP(o[u],o[u+1]))}};function yN(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}var Zv=me(tr());var h0=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var Os=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new h0(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:k.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,i=0,n=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;i<t||o<n;){if(i>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=n){a.push(this.ListOfPointsAndCrossings[i++]);continue}let l=this.ListOfPointsAndCrossings[i],u=e.ListOfPointsAndCrossings[o],c=k.ComparePP(l.Location,u.Location);c===0?(a.push(l),++i,++o):c===-1?(a.push(l),++i):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length===0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(i=>k.ComparePP(i.Location,e)>=0&&k.ComparePP(i.Location,t)<=0))}static ToCrossingArray(e,t){let i=0,n=e.length;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&i++;if(i===0)return null;let o=new Array(i),a=0;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&(o[a++]=e[l]);return o}ToString(){return Zv.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var J=class{static EdgeDirectionVE(e){return J.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return k.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let i=J.EdgeDirectionVE(e);return t===i?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let i of e.InEdges)if(k.GetDirections(e.point,i.SourcePoint)===t)return i.Source;for(let i of e.OutEdges)if(k.GetDirections(e.point,i.TargetPoint)===t)return i.Target;return null}static FindAdjacentEdge(e,t){for(let i of e.InEdges)if(k.GetDirections(i.SourcePoint,e.point)===t)return i;for(let i of e.OutEdges)if(k.GetDirections(e.point,i.TargetPoint)===t)return i;return null}static FindBendPointBetween(e,t,i){return J.IsVerticalD(i)?new m(t.x,e.y):new m(e.x,t.y)}static SegmentIntersectionPPP(e,t,i){let n=k.GetDirections(e,t);return J.IsVerticalD(n)?new m(e.x,i.y):new m(i.x,e.y)}static SegmentIntersectionSP(e,t){return J.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return J.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return J.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return J.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,i,n){return J.IntervalsAreCollinear(e,t,i,n)&&k.ComparePP(e,n)!==k.ComparePP(t,i)}static IntervalsAreCollinear(e,t,i,n){let o=J.IsVerticalPP(e,t);return J.IsVerticalPP(i,n)===o?o?k.Equal(e.x,i.x):k.Equal(e.y,i.y):!1}static IntervalsAreSame(e,t,i,n){return k.EqualPP(e,i)&&k.EqualPP(t,n)}static IntervalsIntersect(e,t,i,n){let o=J.SegmentIntersectionPPP(e,t,i);return J.PointIsOnSegmentPPP(e,t,o)&&J.PointIsOnSegmentPPP(i,n,o)?o:void 0}static SegmentIntersectionEP(e,t){return J.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,i){return k.EqualPP(e,i)||k.EqualPP(t,i)||k.GetDirections(e,i)===k.GetDirections(i,t)}static PointIsOnSegmentSP(e,t){return J.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!==0}static IsVerticalE(e){return J.IsVerticalD(k.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return J.IsVerticalD(k.GetDirections(e,t))}static IsVertical(e){return J.IsVerticalD(k.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!==0}static Slope(e,t,i){let n=t.sub(e);return n.dot(i.PerpDirectionAsPoint)/n.dot(i.DirectionAsPoint)}static SortAscending(e,t){let i=k.GetDirections(e,t);return 0===i||J.IsAscending(i)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,i){switch(i){case 1:case 4:return new m(t.x,J.GetRectangleBound(e,i));case 2:case 8:return new m(J.GetRectangleBound(e,i),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return k.Compare(e.bottom,t.top)<0&&k.Compare(t.bottom,e.top)<0&&k.Compare(e.left,t.right)<0&&k.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return k.Compare(e.y,t.top)<0&&k.Compare(t.bottom,e.y)<0&&k.Compare(e.x,t.right)<0&&k.Compare(t.left,e.x)<0}};var Sa=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=j.toPoint(this.Dir),this.PerpDirection=1===e?2:1,this.PerpDirectionAsPoint=j.toPoint(this.PerpDirection),this.OppositeDirection=j.OppositeDir(e)}get IsHorizontal(){return 2===this.Dir}get IsVertical(){return 1===this.Dir}Compare(e,t){let i=this.ComparePerpCoord(e,t);return i!==0?i:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return k.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return k.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return k.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return k.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?Sa.VerticalInstance:Sa.HorizontalInstance}static GetInstance(e){return J.IsVerticalD(e)?Sa.VerticalInstance:Sa.HorizontalInstance}ToString(){return this.Dir.toString()}},Mt=Sa;Mt.HorizontalInstance=new Sa(2),Mt.VerticalInstance=new Sa(1);var Rs=class extends Fl{static mk(e,t){return new Rs(e,t,Rs.NormalWeight,null)}constructor(e,t,i,n){super();this.Update(e,t),this.Weight=i,this.GroupBoundaryPointAndCrossingsList=n}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Rs.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?Mt.VerticalInstance:Mt.HorizontalInstance}get IsOverlapped(){return Rs.OverlappedWeight===this.Weight}get IsReflection(){return Rs.ReflectionWeight===this.Weight}static IsVerticalSegment(e,t){return e.x===t.x}MergeGroupBoundaryCrossingList(e){e!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new Os),this.GroupBoundaryPointAndCrossingsList.MergeFrom(e))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(e,t){this.startPoint=e,this.endPoint=t}SetInitialVisibilityVertex(e){this.LowestVisibilityVertex=e,this.HighestVisibilityVertex=e}AppendVisibilityVertex(e,t){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.SetInitialVisibilityVertex(t);else{if(k.IsPureLower(t.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.AppendHighestVisibilityVertex(t)}}AddVisibilityEdge(e,t){let i=new Mi(e,t,this.Weight);return et.AddEdge(i),i}AppendHighestVisibilityVertex(e){k.EqualPP(this.HighestVisibilityVertex.point,e.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,e),this.HighestVisibilityVertex=e)}LoadStartOverlapVertexIfNeeded(e){if(this.NeedStartOverlapVertex){let t=e.FindVertex(this.Start);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(e){if(this.NeedEndOverlapVertex){let t=e.FindVertex(this.End);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.End))}}OnSegmentIntersectorBegin(e){this.AppendGroupCrossingsThroughPoint(e,this.Start)||this.LoadStartOverlapVertexIfNeeded(e)}OnSegmentIntersectorEnd(e){this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||k.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(e)}static Subsume(e,t,i,n,o,a,l,u){return u.extendStart=!0,u.extendEnd=!0,e.seg==null||!J.IntervalsOverlapPPPP(e.seg.Start,e.seg.End,t,i)?!1:e.seg.Weight!==n?e.seg.Start===t&&e.seg.End===i?(e.seg.Weight=Math.min(e.seg.Weight,n),!0):!1:(u.extendStart=a.CompareScanCoord(t,e.seg.Start)===-1,u.extendEnd=a.CompareScanCoord(i,e.seg.End)===1,(u.extendStart||u.extendEnd)&&(l.Remove(e.seg),e.seg.startPoint=a.Min(e.seg.Start,t),e.seg.endPoint=a.Max(e.seg.End,i),e.seg=l.InsertUnique(e.seg).item,e.seg.MergeGroupBoundaryCrossingList(o)),!0)}IntersectsSegment(e){return J.SegmentsIntersection(this,e)!==void 0}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(e){return k.EqualPP(this.Start,e)||k.EqualPP(this.End,e)||k.GetDirections(this.Start,e)===k.GetDirections(e,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(e){return this.IsVertical?new m(this.Start.x,e):new m(e,this.Start.y)}AddSparseVertexCoord(e){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(e)}AddSparseEndpoint(e){return this.sparsePerpendicularCoords.has(e)?!1:(this.sparsePerpendicularCoords.add(e),!0)}CreateSparseVerticesAndEdges(e){var t;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(e,this.Start);for(let i of Array.from(this.sparsePerpendicularCoords.values()).sort(Me)){let n=this.CreatePointFromPerpCoord(i);this.AppendVisibilityVertex(e,(t=e.FindVertex(n))!=null?t:e.AddVertexP(n))}this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(e,t){return this.AppendGroupCrossingsThroughPoint(e,t.point)?(k.IsPureLower(this.HighestVisibilityVertex.point,t.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t),!0):!1}AppendGroupCrossingsThroughPoint(e,t){var n;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let i=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(t);){let o=this.GroupBoundaryPointAndCrossingsList.Pop(),a=null,l=null;k.ComparePP(o.Location,this.Start)>0&&(a=Os.ToCrossingArray(o.Crossings,this.ScanDirection.OppositeDirection)),k.ComparePP(o.Location,this.End)<0&&(l=Os.ToCrossingArray(o.Crossings,this.ScanDirection.Dir)),i=!0;let u=(n=e.FindVertex(o.Location))!=null?n:e.AddVertexP(o.Location);e.AddVertexP(o.Location),a!=null||l!=null?(this.AddLowCrossings(e,u,a),this.AddHighCrossings(e,u,l)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(u):this.AppendHighestVisibilityVertex(u)}return i}static GetCrossingInteriorVertex(e,t,i){var o;let n=i.GetInteriorVertexPoint(t.point);return(o=e.FindVertex(n))!=null?o:e.AddVertexP(n)}AddCrossingEdge(e,t,i,n){let o=null;this.HighestVisibilityVertex!=null&&(k.EqualPP(this.HighestVisibilityVertex.point,i.point)?o=e.FindEdgePP(t.point,i.point):this.AppendHighestVisibilityVertex(t)),o==null&&(o=this.AddVisibilityEdge(t,i));let a=n.map(u=>u.Group.InputShape),l=o.IsPassable;l==null?o.IsPassable=()=>{for(let u of a)if(u.IsTransparent)return!0;return!1}:o.IsPassable=()=>{for(let u of a)if(u.IsTransparent||l())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(t),this.HighestVisibilityVertex=i}AddLowCrossings(e,t,i){if(i!=null){let n=Rs.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,n,t,i)}}AddHighCrossings(e,t,i){if(i!=null){let n=Rs.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,t,n,i)}}},Le=Rs;Le.NormalWeight=Mi.DefaultWeight,Le.ReflectionWeight=5,Le.OverlappedWeight=500;var gg=class{constructor(e,t,i,n,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?j.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,i,n,o)}ResetEntry(e,t,i,n){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=i,this.Cost=n}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var mg=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},Nt=class{constructor(){this.nextNeighbors=[new mg,new mg,new mg];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,i){if(t===i||!this.InitEntryDirectionsAtTarget(i))return!1;this.Target=i,this.Source=t;let n=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return n>=this.upperBoundOnCost?!1:(this.queue=new _r(Me),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(n):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|j.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|j.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!==0}static IsInDirs(e,t){return e===(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let i=this.Target.point.sub(e);if(le(i.x,0)&&le(i.y,0))return this.targetCostAdjustment;let n=j.VectorDirection(i),o;return t===0?(t=15,o=this.GetNumberOfBends(t,n)):o=this.GetNumberOfBends(t,n),this.CombinedCost(Nt.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return j.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):Nt.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)===t?Nt.IsInDirs(t,this.EntryDirectionsToTarget)?0:Nt.IsInDirs(Nt.Left(t),this.EntryDirectionsToTarget)||Nt.IsInDirs(Nt.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(Nt.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,i){let n=e&t;if(n===0)return Nt.GetBendsForNotPureDirection(e,Nt.AddOneTurn[t],i)+1;let o=e&i;return o===0?Nt.GetBendsForNotPureDirection(e,t,Nt.AddOneTurn[i])+1:(n|o)===e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return Nt.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let i=new Array,n=!1,o=0;for(;;){o===e.entry.Direction?n=!0:(n=!1,i.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex===t)break;e.entry=a}return n&&i.push(e.entry.Vertex.point),i.reverse(),i}QueueReversedEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=t.PreviousVertex,a=Nt.GetLengthAndNumberOfBendsToNeighborVertex(e,o,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree===1){let l=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,n.length,n.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=Nt.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,n.length,n.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,i){let n={numberOfBends:0,length:0},o=Nt.GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n),a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,n.length,n.numberOfBends,a))}EnqueueEntry(e,t,i,n,o){let a=new gg(t,e,i,n,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n){n.length=e.Length+Nt.ManhattanDistance(e.Vertex.point,t.point)*i;let o=j.DirectionFromPointToPoint(e.Vertex.point,t.point);return n.numberOfBends=e.NumberOfBends,e.Direction!==0&&o!==e.Direction&&n.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,i,n,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=i,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c===this.Target){if(n==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget===0){let d=0;for(let f of this.Target.VertexEntries)n[d++]=f;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=Nt.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(n!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)n[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,i){for(let n of t)this.ExtendPathAlongEdge(e,n,!0,i)}ExtendPathAlongOutEdges(e,t,i){let n=t.isEmpty()?null:t.treeMinimum();for(;n!=null;n=t.next(n))this.ExtendPathAlongEdge(e,n.item,!1,i)}ExtendPathAlongEdge(e,t,i,n){if(!Nt.IsPassable(t))return;let o=i?t.Source:t.Target;if(o===e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!==this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=j.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!==e.Direction&&(l=this.nextNeighbors[a===n?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new gg(this.Source,null,0,0,e);for(let i of this.Source.OutEdges)!Nt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Target,i.Weight);for(let i of this.Source.InEdges)!Nt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Source,i.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,i){let n=j.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[j.ToIndex(n)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,i):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,i)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i){if(e.Vertex.VertexEntries!=null){let n=j.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[j.ToIndex(n)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,i),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},fn=Nt;fn.DefaultBendPenaltyAsAPercentageOfDistance=4,fn.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var Ul=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=fn.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let i={entry:this.GetPathStage(null,e,null,t)};return fn.RestorePathV(i)}GetPathStage(e,t,i,n){let o=new fn,a={bestEntry:null,bestCost:Number.MAX_VALUE/Le.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=Ul.Barycenter(t),c=Ul.Barycenter(n),h=fn.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,f=i!=null?this.currentPassTargetEntries:null,p=[];for(let T of t)for(let O of n)p.push([T,O]);p.sort(([T,O],[M,R])=>S(T,O)-S(M,R));for(let[T,O]of p){if(m.closeDistEps(T.point,O.point))continue;let M=x(T,u)*d,R=x(O,c)*d,N=a.bestCost;if(i!=null){for(let ne=0;ne<f.length;ne++)f[ne]=null;N=o.MultistageAdjustedCostBound(a.bestCost)}let H=o.GetPathWithCost(e,T,M,f,O,R,N);if(f!=null){Ul.UpdateTargetEntriesForEachDirection(i,f,a);continue}if(H==null)continue;let Q=H.Cost/S(T,O);(H.Cost<a.bestCost||le(H.Cost,a.bestCost)&&Q<l)&&(a.bestCost=H.Cost,a.bestEntry=H,l=H.Cost/S(T,O))}return a.bestEntry;function S(T,O){return fn.ManhattanDistance(T.point,O.point)}function x(T,O){return fn.ManhattanDistance(T.point,O)}}static UpdateTargetEntriesForEachDirection(e,t,i){for(let n=0;n<t.length;n++){let o=t[n];o!=null&&(e[n]==null||o.Cost<e[n].Cost)&&(e[n]=o,o.Cost<i.bestCost&&(i.bestCost=o.Cost,i.bestEntry=o))}}static Barycenter(e){let t=new m(0,0);for(let i of e)t=t.add(i.point);return t.div(e.length)}};var Jv=me(tr());var d0=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof Ni?Array.from(Qv(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new Jv.StringBuilder;this.PathPoints instanceof Ni&&e.Append("L");for(let t of Qv(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*Qv(s){if(s instanceof Ni)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var f0=class extends Gl{constructor(e,t,i,n){super(t);this.Slope=0;this.SlopeInverse=0;this.Obstacle=e,this.endVertex=n?t.nextOnPolyline:t.prevOnPolyline,i.IsPerpendicularPP(t.point,this.endVertex.point)||(this.Slope=J.Slope(t.point,this.endVertex.point,i),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(e){this.obstacle=e}get EndVertex(){return this.endVertex}},ei=class extends f0{constructor(e,t,i){super(e,t,i,i.IsHorizontal)}},Ea=class extends f0{constructor(e,t,i){super(e,t,i,i.IsVertical)}};var Wl=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=xs(this.InputShape.Ports,this.Ports),e.removedPorts=xs(this.Ports,this.InputShape.Ports),e.addedPorts.size===0&&e.removedPorts.size===0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,i,n){let o=Wl.mk(e,t,n);return o.CreateInitialSides(o.PaddedPolyline.startPoint,i),o}CreateInitialSides(e,t){this.ActiveLowSide=new ei(this,e,t),this.ActiveHighSide=new Ea(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new Ea(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t){e!=null&&(this.PaddedPolyline=dr.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,t),Wl.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports))}static mk(e,t,i){let n=new Wl(null,0);return n.PaddedPolyline=re.mkClosedFromPoints([A.RoundPoint(e),A.RoundPoint(t)]),n.Ordinal=i,n}IsPolylineRectangle(){if(this.PaddedPolyline.count!==4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,i=j.VectorDirectionPP(e.point,t.point);if(!j.IsPureDirection(i))return!1;do{e=t,t=e.nextOnPolyline;let n=j.DirectionFromPointToPoint(e.point,t.point);if(n!==j.RotateRight(i))return!1;i=n}while(e!==this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=A.RoundPoint(t.point),t=t.nextOnPolyline;while(t!==e.startPoint);Wl.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this===this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=A.intersectionEpsilon*10;for(let i=e.startPoint.next;i!=null;i=i.next)m.close(i.prev.point,i.point,t)&&(i.next==null?e.RemoveEndPoint():(i.prev.next=i.next,i.next.prev=i.prev));return m.close(e.start,e.end,t)&&e.RemoveStartPoint(),He.RemoveCollinearVertices(e),e.endPoint.prev!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)===2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)===2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!==void 0&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump===e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=dr.CreatePaddedPolyline(e,A.intersectionEpsilon*10);return Wl.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},Mr=Wl;Mr.FirstSentinelOrdinal=1,Mr.FirstNonSentinelOrdinal=10;var $v=me(tr());var p0=class{constructor(e,t,i,n){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=Le.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=i;let o=D.mkPP(this.UnpaddedBorderIntersect,J.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,i)),a=L.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=A.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=n.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=n.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,Mt.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(n))&&(this.unpaddedToPaddedBorderWeight=Le.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight===Le.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(n)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?Le.OverlappedWeight:Le.NormalWeight}get IsCollinearWithPort(){return j.IsPureDirection(k.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return J.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return k.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!==0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=Le.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=W.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,i=>i.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(i=>!i.UserData.IsGroup&&i.UserData!==this.Obstacle).map(i=>i.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=W.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!==this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,i){let n=null;for(let o of i){let a=t(o);if(!J.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(n=n!=null?n:D.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),L.intersectionOne(n,a,!1)!=null||0!==L.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=J.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return k.GetDirections(this.MaxVisibilitySegment.start,t.Location)===k.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,i,n){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,i,n);return}this.OutwardDirection===k.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,i,n)}ExtendEdgeChain(e,t,i,n,o){e.ExtendEdgeChainVRLPB(i,n,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return $v.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var g0=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=W.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=A.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,i){let n=new p0(this,e,t,i);this.PortEntrances.push(n),this.VisibilityRectangle.add(n.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||n.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!m.closeDistEps(this.Location,A.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var m0=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?Le.OverlappedWeight:Le.NormalWeight}get IsOutOfBounds(){return 0!==this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,i,n){let o=J.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,i,n):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,i,n),a}AddToAdjacentVertex(e,t,i,n){k.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,i,n)}ExtendEdgeChain(e,t,i,n){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,i));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,i,e);e.ExtendEdgeChainVRLPB(t,n,a[0],a[1],o)}GetSegmentAndCrossings(e,t,i){let n=j.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[n];if(o==null){let a={pacList:null};o=[i.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[n]=o}else k.GetDirections(e.point,o[0].start)===t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let i=k.GetDirections(t,this.Vertex.point),n=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(n,this.Vertex,i&5,Le.NormalWeight),e.ConnectVertexToTargetVertex(n,this.Vertex,i&10,Le.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var rA=me(tr());var eA=me(tr());var Tc=class{constructor(e,t){this.BoundaryWidth=A.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return A.RoundPoint(e.add(j.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return eA.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};Tc.BoundaryWidth=A.distanceEpsilon;var Bd=class extends cr{constructor(e){super();this.site=e}get Site(){return this.site}};var Hl=class extends qi{constructor(e,t){super(t);this.Obstacle=e}};var jl=class extends Hl{constructor(e,t){super(e,t)}};var b0=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!k.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||k.GetDirections(this.CurrentSegment.End,e)==k.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&m.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(k.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new m(e,this.Coord):new m(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y === "+this.Coord:"(V) X === "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var bg=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let i=Array.from(e).sort((n,o)=>n>o?1:n<o?-1:0);for(let n of i)this.vector.push(new b0(n))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,i,n){this.CurrentSlot.AppendScanSegment(new Le(e,t,i,n))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let i=0,n=this.vector.length-1;if(e<=this.vector[i].Coord)return i;if(e>=this.vector[n].Coord)return n;for(;n-i>2;){let o=i+(n-i>>1),a=this.vector[o];if(e<a.Coord){n=o;continue}if(e>a.Coord){i=o;continue}return o}for(i++;i<=n;i++){let o=this.vector[i];if(e<o.Coord)return t>0?i:i-1;if(e===o.Coord)break}return i}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let i=t.FirstSegment;i!=null;i=i.NextSegment)i.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let i=t.NextSegment;i!=null;i=i.NextSegment){if(i.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&i.Start===t.End){let n=this.GetPerpendicularCoord(i.Start);t.AddSparseEndpoint(n),i.AddSparseEndpoint(n)}t=i}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count === ")+this.vector.length}};var pn=class extends cr{constructor(e,t,i){super();this.InitialObstacle=e,this.ReflectingObstacle=t,this.site=i}static mk(e,t,i){let n=new pn(e.ReflectingObstacle,t,i);return n.PreviousSite=e,n}IsStaircaseStep(e){return this.InitialObstacle===e}get Site(){return this.site}};var Pg=class{constructor(){this.eventTree=new Nl((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(i)return i;let n=e instanceof pn?0:1,o=t instanceof pn?0:1;return i=n-o,i||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var tA=me(tr());var Dd=class{constructor(){this.pointCrossingMap=new bt;this.pointList=new Array}AddIntersection(e,t,i){let n=this.pointCrossingMap.get(e);n||(n=new Array,this.pointCrossingMap.set(e,n));let o=n.length;for(let l=0;l<o;l++){let u=n[l];if(u.Group===t)return u}let a=new Tc(t,i);return n.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size===0)return null;if(k.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())k.ComparePP(o,e)>=0&&k.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let i=new Os,n=this.pointList.length;for(let o=0;o<n;o++){let a=this.pointList[o];i.Add(a,this.pointCrossingMap.get(a))}return i}toString(){return tA.String.Format("{0}",this.pointCrossingMap.size)}};var yg=class extends pn{constructor(e,t,i){super(e.ReflectingObstacle,t.Obstacle,i);this.Side=t}};var P0=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new Ct((t,i)=>this.CompareBB(t,i)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let i=this.FindFirstInRange(e,t);i!=null;i=this.FindNextInRange(i,t))this.MarkStaleSite(i.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site===e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let i=this.eventTree.findFirst(this.findFirstPred);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let i=this.eventTree.next(e);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Sg=class extends Hl{constructor(e,t){super(e,t)}},Eg=class extends Hl{constructor(e,t){super(e,t)}},xg=class extends Hl{constructor(e,t){super(e,t)}};var Cg=class extends pn{constructor(e,t,i){super(e.ReflectingObstacle,t.obstacle,i);this.Side=t}};var vg=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,i,n){if(J.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=i,this.GroupSideInterveningBeforeHighNeighbor=n;return}this.LowNeighbor=t,this.LowOverlapEnd=i,this.GroupSideInterveningBeforeLowNeighbor=n}};var Ag=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],Mr.RoundVerticesAndSimplify(this.Polyline)}};var _s=class{static MungeClosestIntersectionInfo(e,t,i){let n=t.seg1.boundingBox,o=A.RoundPoint(t.x).clone();return i?new m(_s.MungeIntersect(e.x,o.x,n.left,n.right),o.y):new m(o.x,_s.MungeIntersect(e.y,o.y,n.bottom,n.top))}static MungeIntersect(e,t,i,n){if(e<t){let o=Math.min(i,n);t<o&&(t=o)}else if(e>t){let o=Math.max(i,n);t>o&&(t=o)}return A.RoundDouble(t)}};var vt=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new Dd;this.overlapPairs=new wr;this.hasOverlaps=!1;this.lookupIntPair=new Se(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,i){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=i}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=Mr.FirstNonSentinelOrdinal;for(let i of this.allObstacles)i.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-Mr.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=vt.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=vt.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(Xt(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let i={bIsInsideA:!1,aIsInsideB:!1};if(vt.ObstaclesIntersect(e,t,i)){this.hasOverlaps=!0;return}!i.aIsInsideB&&!i.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&i.bIsInsideA||t.IsGroup&&i.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(i=>gt(i,i.VisibilityBoundingBox));return rt(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=vt.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&Qr(e,e,(t,i)=>this.EvaluateOverlappedPairForClump(t,i))}EvaluateOverlappedPairForClump(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!vt.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||this.overlapPairs.add(new Se(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=vt.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&Qr(e,e,(t,i)=>this.EvaluateOverlappedPairForConvexHull(t,i))}EvaluateOverlappedPairForConvexHull(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!vt.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new Se(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=vt.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsGroup)),t=vt.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsPrimaryObstacle));e==null||t==null||Qr(e,t,(i,n)=>this.EvaluateOverlappedPairForGroup(i,n))}EvaluateOverlappedPairForGroup(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1},n=vt.ObstaclesIntersect(e,t,i);if(!(!n&&!i.aIsInsideB&&!i.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(i.aIsInsideB||vt.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!n&&(t.IsGroup||i.bIsInsideA)||this.overlapPairs.add(new Se(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return L.PointRelativeToCurveLocation(e.start,t)!==0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new Se(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new Se(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=nc(Array.from(this.overlapPairs.values())),t=Wn(e);for(let i of t){if(i.length===1)continue;let n=i.map(o=>this.OrdinalToObstacle(o));for(let o of n)o.clump=n}}CreateConvexHulls(){let e=!1,t=nc(Array.from(this.overlapPairs.values())),i=Wn(t);for(let n of i){if(n.length===1)continue;e=!0;let o=n.map(this.OrdinalToObstacle),a=Bo(o,u=>u.VisibilityPolyline),l=new Ag(gi.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let i=this.OrdinalToObstacle(t.x),n=this.OrdinalToObstacle(t.y);vt.ResolveGroupAndGroupOverlap(i,n)||vt.ResolveGroupAndObstacleOverlap(i,n)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?vt.ResolveGroupAndObstacleOverlap(e,t):vt.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let i=t.looseVisibilityPolyline;vt.GrowGroupAroundLoosePolyline(e,i);let n={bIsInsideA:!1,aIsInsideB:!1};for(;vt.ObstaclesIntersect(t,e,n)||!n.aIsInsideB;)i=Mr.CreateLoosePolyline(i),vt.GrowGroupAroundLoosePolyline(e,i)}static GrowGroupAroundLoosePolyline(e,t){let i=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new Ag(gi.createConvexHullAsClosedPolyline(i),[e]))}static ObstaclesIntersect(e,t,i){return L.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):(i.aIsInsideB=vt.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),i.bIsInsideA=!i.aIsInsideB&&vt.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:vt.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i.aIsInsideB,i.bIsInsideA)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i,n){if(!i&&!n)return L.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=i?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=i?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(L.PointRelativeToCurveLocation(l,a)===0){let u=L.ClosestPoint(a,l);if(!m.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let i=t.VisibilityBoundingBox;for(let n of this.Root.GetNodeItemsIntersectingRectangle(i))if(n!==t&&L.ClosedCurveInteriorsIntersect(n.VisibilityPolyline,t.VisibilityPolyline)){if(n.IsInConvexHull)for(let o of n.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(n.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let i=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(n=>!i.intersects(this.shapeIdToObstacleMap.get(n).VisibilityBoundingBox)));for(let n of e)this.AncestorSets.get(t.InputShape).delete(n);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,i){let n=J.RectangleBorderIntersect(this.GraphBox,e,t);if(k.GetDirections(e,n)===0)return i.pacList=null,D.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,n);return i.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,i,n){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=n,this.Root.FirstHitNodeWithPredicate(i,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,Mt.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t===this.insideHitTestIgnoreObstacle1||t===this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!J.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let i=J.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),n=J.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=D.mkPP(n,i),a=L.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length===2){let l=A.RoundPoint(a[0].x),u=A.RoundPoint(a[1].x);if(!k.EqualPP(e,l)&&!k.EqualPP(e,u)&&e.compareTo(l)!==e.compareTo(u)&&!le(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!k.EqualPP(i.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!k.EqualPP(i.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=D.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let i=k.GetDirections(e,t),n=8===i?this.GraphBox.right:2===i?this.GraphBox.left:e.x,o=8===i?this.GraphBox.left:2===i?this.GraphBox.right:t.x,a=4===i?this.GraphBox.top*2:1===i?this.GraphBox.bottom:e.y,l=4===i?this.GraphBox.bottom:1===i?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=D.mkPP(new m(n,a),new m(o,l))}RecurseRestrictRayWithObstacles(e){if(!J.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let i=L.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(i);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,i);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,i=null,n=this.restrictedRayLengthSquared,o=k.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=A.RoundPoint(a.x),u=k.GetDirections(this.currentRestrictedRay.start,l);if(u===j.OppositeDir(o))continue;if(t++,0===u){n=0,i=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<n){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<A.squareOfDistanceEpsilon)continue;n=c,i=a}}if(i!=null){if(t===1){let a=A.RoundPoint(i.x);if(m.closeIntersections(a,this.currentRestrictedRay.start)||m.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=n,this.currentRestrictedRay.end=_s.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,i,!J.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let i of t){let n=A.RoundPoint(i.x);if(n.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=k.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=i.seg1,u=j.VectorDirection(l.derivative(i.par1)),c=a;(u&j.RotateRight(a))!==0&&(c=j.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,e,c)}}};var y0=class{constructor(e,t){this.scanDirection=e,this.SideTree=new Ct((i,n)=>this.Compare(i,n)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)===-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return J.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle===t.Obstacle)return e===t?0:e instanceof ei?-1:1;let i=ql.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),n=ql.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=i.compareTo(n);if(o===0){let a=e instanceof ei,l=t instanceof ei;o=WC(a,l),o===0&&(o=Me(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var Ic=class{constructor(e){this.lookupSegment=Le.mk(new m(0,0),new m(0,1));this.ScanDirection=e,this.segmentTree=new Ct((t,i)=>this.Compare(t,i)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let i=this.segmentTree.find(this.lookupSegment);return i!=null&&k.EqualPP(i.item.End,t)?i.item:null}FindLowestIntersector(e,t){let i=this.FindLowestIntersectorNode(e,t);return i!=null?i.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let i=this.segmentTree.findLast(this.findIntersectorPred);if(k.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.Start,t)>0)return null;i=this.segmentTree.next(i)}return i}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let i=this.segmentTree.findLast(this.findIntersectorPred);if(k.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.End,e)<0)return null;i=this.segmentTree.previous(i)}return i!=null?i.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,i){this.lookupSegment.Update(e,t);let n=this.segmentTree.findFirst(this.findPointPred);if(n!=null){let o=n.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)===-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped===e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!==t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start===t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End===t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let n=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),n.Update(o.End,n.End),this.segmentTree.insert(n),n.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.ScanDirection.Compare(e.Start,t.Start);return i===0&&(i=this.ScanDirection.Compare(e.End,t.End)*-1),i}};var S0=class extends vs{constructor(e){super(e)}SetVertexEntry(e){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[j.ToIndex(e.Direction)]=e}RemoveVertexEntries(){this.VertexEntries=null}};var ir=class{constructor(e){this.ObstacleTree=new vt;this.CurrentGroupBoundaryCrossingMap=new Dd;this.LowNeighborSides=new vg;this.HighNeighborSides=new vg;this.ScanDirection=Mt.HorizontalInstance,this.eventQueue=new Pg,this.HorizontalScanSegments=new Ic(Mt.HorizontalInstance),this.VerticalScanSegments=new Ic(Mt.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new et;return e.VertexFactory=t=>new S0(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(Mt.HorizontalInstance);let e=Mr.FirstSentinelOrdinal,t=new m(this.ObstacleTree.GraphBox.left-ir.SentinelOffset,this.ObstacleTree.GraphBox.bottom-ir.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.left-ir.SentinelOffset,this.ObstacleTree.GraphBox.top+ir.SentinelOffset),n=Mr.CreateSentinel(t,i,this.ScanDirection,e++);this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.right+ir.SentinelOffset,this.ObstacleTree.GraphBox.bottom-ir.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+ir.SentinelOffset,this.ObstacleTree.GraphBox.top+ir.SentinelOffset),n=Mr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(Mt.VerticalInstance),t=new m(this.ObstacleTree.GraphBox.left-ir.SentinelOffset,this.ObstacleTree.GraphBox.bottom-ir.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+ir.SentinelOffset,this.ObstacleTree.GraphBox.bottom-ir.SentinelOffset),n=Mr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.left-ir.SentinelOffset,this.ObstacleTree.GraphBox.top+ir.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+ir.SentinelOffset,this.ObstacleTree.GraphBox.top+ir.SentinelOffset),n=Mr.CreateSentinel(t,i,this.ScanDirection,e),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,i){let n=t.Direction,o=t.Start.x,a=t.Start.y;return i.IsHorizontal?(o+=n.x/n.y*(e.y-t.Start.y),o=_s.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=n.y/n.x*(e.x-t.Start.x),a=_s.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new m(o,a)}GetOpenVertex(e){let t=e.startPoint,i=this.TraversePolylineForEvents(t),n=this.PointCompare(i.point,t.point);for(;;i=this.TraversePolylineForEvents(i)){let o=this.PointCompare(i.point,t.point);if(o<=0)t=i;else if(o>0&&n<=0)break;n=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new y0(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new P0(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new jl(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return ir.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof ei?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof ei?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,i,n){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!n&&!J.PointIsInRectangleInterior(i,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(i)==null&&this.lookaheadScan.Add(new pn(e,t.Obstacle,i))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let i=W.mkPP(e.Start,e.End),n=W.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!i.intersectsOnX(n):!i.intersectsOnY(n))return;let o=W.intersect(i,n),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=ir.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!==e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,i){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!J.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(i!=null&&e.IsStaircaseStep(i.Obstacle))return this.ScanLineCrossesObstacle(e.Site,i.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,i,n){{let o=this.ScanLineIntersectSide(n.Site,t!=null?t:i),a=t!=null?o:n.Site,l=t!=null?n.Site:o;return t==null?t=this.scanLine.NextLowB(i).item:i=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,i,n)}}AddReflectionEvent(e,t,i){let n=t;n!=null?this.eventQueue.Enqueue(new Cg(e,n,i)):this.eventQueue.Enqueue(new yg(e,t,i))}AddSideToScanLine(e,t){let i=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),i}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Pg,this.HorizontalScanSegments=new Ic(Mt.HorizontalInstance),this.VerticalScanSegments=new Ic(Mt.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof jl?this.ProcessEventO(e):e instanceof Sg?this.ProcessEventLB(e):e instanceof Eg?this.ProcessEventHB(e):e instanceof xg?this.ProcessEventCV(e):e instanceof Cg?this.ProcessEventLR(e):e instanceof yg?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,i){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,i,this.HighNeighborSides)}FindNeighbors(e,t,i){let n=e instanceof jl?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,n,o.lowNborSideNode,i),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,n,o.highNborSideNode,i)}SkipToNeighbor(e,t,i,n,o){let a=null,l=null;for(;;n=this.scanLine.Next(e,n))if(n.item.Obstacle!==t.Obstacle){if(n.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(n,i,e)&&l==null&&(l=n.item);continue}if(n.item instanceof Ea===J.IsAscending(e)){this.ScanLineCrossesObstacle(i,n.item.Obstacle)&&(a=n,l=null);continue}break}o.SetSides(e,n,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,i){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let n=e.item instanceof ei===J.IsAscending(i)?i:j.OppositeDir(i),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,n),!0}FindNeighborsAndProcessVertexEvent(e,t,i){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(i,e,t),this.ProcessVertexEvent(e,t,i),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let i=this.AddSideToScanLine(t.ActiveHighSide,e.Site),n=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(n,i,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!==t.ActiveLowSide.Start){let c=new Ea(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,i=new ei(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(i.End,i.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(i,e.Site),t.ActiveLowSide=i,this.EnqueueLowBendVertexEvent(i))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Sg(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,i=new Ea(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let n=this.AddSideToScanLine(i,e.Site);if(t.ActiveHighSide=i,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&i.Start.x===t.VisibilityBoundingBox.right&&this.SideReflectsUpward(i)){let o=this.scanLine.NextHighR(n);o.item instanceof ei&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(i.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,i,i.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,i=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(i.point,e.End)>0?this.eventQueue.Enqueue(new Eg(t,e.EndVertex)):this.eventQueue.Enqueue(new xg(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,i=this.scanLine.Find(t.ActiveLowSide),n=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)===1){let o=i;i=n,n=o}if(this.FindNeighborsAndProcessVertexEvent(i,n,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(i);o.item!==n.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,i=this.HighNeighborSides.HighNeighbor.item,n=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(i),n.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,i=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,i,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,i=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,null,i,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),i=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new m(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(i,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return k.EqualPP(e,this.MakeInBoundsLocation(e))}},ql=ir;ql.SentinelOffset=1;var ti=class extends ql{constructor(){super(!1);this.horizontalVertexPoints=new nt;this.verticalVertexPoints=new nt;this.boundingBoxSteinerPoints=new nt;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let e of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(e.VisibilityBoundingBox.left),this.xCoordAccumulator.add(e.VisibilityBoundingBox.right),this.yCoordAccumulator.add(e.VisibilityBoundingBox.top),this.yCoordAccumulator.add(e.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new bg(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new bg(this.xCoordAccumulator,!1);for(let e=0;e<this.horizontalScanSegmentVector.Length;e++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(e).Coord,e);for(let e=0;e<this.verticalScanSegmentVector.Length;e++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(e).Coord,e)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(e){super.InitializeEventQueue(e),this.SetVectorsAndCoordMaps(e),this.AddAxisCoordinateEvents(e)}AddAxisCoordinateEvents(e){if(e.IsHorizontal){for(let t of this.yCoordAccumulator)this.eventQueue.Enqueue(new Bd(new m(this.ObstacleTree.GraphBox.left-ti.SentinelOffset,t)));return}for(let t of this.xCoordAccumulator)this.eventQueue.Enqueue(new Bd(new m(t,this.ObstacleTree.GraphBox.bottom-ti.SentinelOffset)))}ProcessCustomEvent(e){this.ProcessAxisCoordinate(e)||this.ProcessCustomEvent(e)}ProcessAxisCoordinate(e){return e instanceof Bd?(this.CreateScanSegmentsOnAxisCoordinate(e.Site),!0):!1}InsertPerpendicularReflectionSegment(e,t){return!1}InsertParallelReflectionSegment(e,t,i,n,o,a){return!1}ProcessVertexEvent(e,t,i){let n=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;n.add(i.Site);let o=this.LowNeighborSides.LowNeighbor.item,a=this.HighNeighborSides.HighNeighbor.item,l=this.ScanDirection.Dir,u=this.ScanDirection.OppositeDirection,c=this.ScanLineIntersectSide(i.Site,o),h=this.ScanLineIntersectSide(i.Site,a);if(this.ObstacleTree.GraphBox.contains(c)){let f=J.RectangleBorderIntersect(o.Obstacle.VisibilityBoundingBox,c,l);k.IsPureLower(f,i.Site)&&this.boundingBoxSteinerPoints.add(f)}if(this.ObstacleTree.GraphBox.contains(h)){let f=J.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);k.IsPureLower(i.Site,f)&&this.boundingBoxSteinerPoints.add(f)}let d={lowCorner:void 0,highCorner:void 0};ti.GetBoundingCorners(e.item.Obstacle.VisibilityBoundingBox,i instanceof jl,this.ScanDirection.IsHorizontal,d),(k.IsPureLower(c,d.lowCorner)||o.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.lowCorner),(k.IsPureLower(d.highCorner,h)||a.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.highCorner)}static GetBoundingCorners(e,t,i,n){if(t){n.lowCorner=e.leftBottom,n.highCorner=i?e.rightBottom:e.leftTop;return}n.lowCorner=i?e.leftTop:e.rightBottom,n.highCorner=e.rightTop}CreateScanSegmentsOnAxisCoordinate(e){this.CurrentGroupBoundaryCrossingMap.Clear();let t=this.scanLine.Lowest(),i=this.scanLine.NextHighR(t),n=0,o=e,a=!1;for(;i!=null;i=this.scanLine.NextHighR(i)){if(this.SkipSide(o,i.item))continue;if(i.item.Obstacle.IsGroup){(n===0||a)&&this.HandleGroupCrossing(e,i.item);continue}if(i.item instanceof ei){if(n>0){n++;continue}o=this.CreateScanSegment(o,i.item,Le.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),n=1,a=i.item.Obstacle.isOverlapped;continue}n++,!(n>0)&&(o=i.item.Obstacle.isOverlapped||i.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(o,i.item,Le.OverlappedWeight):this.ScanLineIntersectSide(o,i.item),this.CurrentGroupBoundaryCrossingMap.Clear(),a=!1)}let l=this.ScanDirection.IsHorizontal?new m(this.ObstacleTree.GraphBox.right+ti.SentinelOffset,o.y):new m(o.x,this.ObstacleTree.GraphBox.top+ti.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(o,l,Le.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o,l)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(e,t){if(!this.ScanLineCrossesObstacle(e,t.Obstacle))return;let i=t instanceof ei?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,n=this.ScanLineIntersectSide(e,t),o=this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,t.Obstacle,i);this.AddPerpendicularCoordForGroupCrossing(n);let a=o.GetInteriorVertexPoint(n);this.AddPerpendicularCoordForGroupCrossing(a)}AddPerpendicularCoordForGroupCrossing(e){let t=this.FindPerpendicularSlot(e,0);t!==-1&&this.perpendicularSegmentVector.Item(t).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(e,t){if(t.Obstacle.IsSentinel)return!0;let i=t.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?e.y===i.bottom||e.y===i.top:e.x===i.left||e.x===i.right}CreateScanSegment(e,t,i){let n=this.ScanLineIntersectSide(e,t);return e!==n&&this.parallelSegmentVector.CreateScanSegment(e,n,i,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(e,n)),n}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=ti.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=ec;let e=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=Mt.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(i,n)=>i.compareTo(n);let e=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=Mt.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}SetVectorsAndCoordMaps(e){e.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(e,t){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let i=1,n={j:0};for(let o of this.parallelSegmentVector.Items())for(;!(!o.CurrentSegment.ContainsPoint(e[i])&&(!this.AddSteinerPointsToInterveningSegments(e[i],t,n,o)||!o.TraverseToSegmentContainingPoint(e[i])));){if(this.AddPointsToCurrentSegmentIntersections(t,n,o),this.GenerateIntersectionsFromVertexPointForCurrentSegment(e[i],o),o.PointIsCurrentEndAndNextStart(e[i])){o.MoveNext();continue}if(++i>=e.length)return}}AddSteinerPointsToInterveningSegments(e,t,i,n){for(;i.j<t.length&&this.currentAxisPointComparer(t[i.j],e)===-1;){if(!n.TraverseToSegmentContainingPoint(t[i.j]))return!1;this.AddPointsToCurrentSegmentIntersections(t,i,n)}return!0}AddPointsToCurrentSegmentIntersections(e,t,i){for(;t.j<e.length&&i.CurrentSegment.ContainsPoint(e[t.j]);t.j++){let n=this.FindPerpendicularSlot(e[t.j],0);this.AddSlotToSegmentIntersections(i,n)}}GenerateIntersectionsFromVertexPointForCurrentSegment(e,t){let i=this.FindPerpendicularSlot(t.CurrentSegment.Start,1),n=this.FindPerpendicularSlot(t.CurrentSegment.End,-1),o=this.FindPerpendicularSlot(e,0);i>=n||(this.AddSlotToSegmentIntersections(t,i),this.AddSlotToSegmentIntersections(t,n),o>i&&o<n&&(this.AddSlotToSegmentIntersections(t,o),this.AddBinaryDivisionSlotsToSegmentIntersections(t,i,o,n)))}FindPerpendicularSlot(e,t){return ti.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,e,t)}static FindIntersectingSlot(e,t,i,n){let o=e.GetParallelCoord(i),a=t.get(o);return a!==void 0?a:n===0?-1:e.FindNearest(o,n)}AddSlotToSegmentIntersections(e,t){let i=this.perpendicularSegmentVector.Item(t);e.CurrentSegment.AddSparseVertexCoord(i.Coord),i.AddPerpendicularCoord(e.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(e,t,i,n){let o=0,a=this.perpendicularSegmentVector.Length-1;for(;a-o>1;){let l=o+Math.floor((a-o)/2);if(i<=l){a=l,i<a&&a<=n&&this.AddSlotToSegmentIntersections(e,a);continue}o=l,i>o&&o>=t&&this.AddSlotToSegmentIntersections(e,o)}}CreateScanSegmentTrees(){ti.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),ti.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(e,t){for(let i of e.Items())for(let n=i.FirstSegment;n!=null;n=n.NextSegment)n.HasVisibility()&&t.InsertUnique(n)}};var bi=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof ti}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,Le.NormalWeight)}FindOrAddEdge(e,t,i){let n=k.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};bi.GetBrackets(e,t,n,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,i),a}static GetBrackets(e,t,i,n){if(n.splitVertex=t,!bi.FindBracketingVertices(e,t.point,i,n)){let o={bracketSource:null,bracketTarget:null};bi.FindBracketingVertices(t,e.point,j.OppositeDir(i),o)&&(n.bracketSource=o.bracketTarget,n.splitVertex=e),n.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,i,n){for(n.bracketSource=e;n.bracketTarget=J.FindAdjacentVertex(n.bracketSource,i),n.bracketTarget!=null;){if(m.closeDistEps(n.bracketTarget.point,t))return!0;if(i!==k.GetDirections(n.bracketTarget.point,t))break;n.bracketSource=n.bracketTarget}return n.bracketTarget!=null}CreateEdge(e,t,i){let n=e,o=t;k.IsPureLower(n.point,o.point)||(n=t,o=e);let a=new xr(n,o,i);return et.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&et.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)et.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return J.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,i){for(;;){let n=J.FindAdjacentVertex(e,t);if(n==null)break;let o=k.GetDirections(n.point,i);if((j.OppositeDir(t)&o)!==0)return this.VisGraph.FindEdgePP(e.point,n.point);e=n}return null}FindNearestPerpendicularOrContainingEdge(e,t,i){let n;t&k.GetDirections(e.point,i);let o=e,a=n;for(;0!==a;){let u=J.FindAdjacentVertex(o,n);if(u==null||(j.OppositeDir(n)&k.GetDirections(u.point,i))!==0)break;o=u,t&k.GetDirections(o.point,i)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,i),!(l!=null||o===e);)o=J.FindAdjacentVertex(o,j.OppositeDir(n));return l}ConnectVertexToTargetVertex(e,t,i,n){if(m.closeDistEps(e.point,t.point))return;let o=k.GetDirections(e.point,t.point);if(k.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=J.FindBendPointBetween(e.point,t.point,i),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,n),this.FindOrAddEdge(l,t,n)}AddEdgeToTargetEdge(e,t,i){let n=this.VisGraph.FindVertex(i);return n==null&&(n=this.AddVertex(i),this.SplitEdge(t,n)),this.FindOrAddEdgeVV(e,n),n}SplitEdge(e,t){return e==null?null:m.closeDistEps(e.Source.point,t.point)||m.closeDistEps(e.Target.point,t.point)?e:(e instanceof xr||this.edgesToRestore.push(e),et.RemoveEdge(e),(this.IsSparseVg||e.Weight===Le.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,i,n,o){let a=k.GetDirections(i.start,i.end);if(a===0)return;let l=J.GetRectangleBound(t,a),u=J.IsVerticalD(a)?A.RoundPoint(new m(e.point.x,l)):A.RoundPoint(new m(l,e.point.y));if(m.closeDistEps(u,e.point)||k.GetDirections(e.point,u)!==a)return;let c=i;k.GetDirections(u,c.end)===a&&(c=D.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,i,n,o)}ExtendEdgeChain(e,t,i,n,o,a){if(k.GetDirections(e.point,i.end)!==t)return;let u=j.RotateLeft(t),c=J.FindAdjacentVertex(e,u);if(c==null&&(u=j.OppositeDir(u),c=J.FindAdjacentVertex(e,u),c==null))return;let h=j.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,i,n,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,i,n,a,d),this.SpliceGroupBoundaryCrossings(o,e,i)}SpliceGroupBoundaryCrossings(e,t,i){if(e==null||e.Count()===0)return;e.Reset();let n=i.start,o=i.end,a=k.GetDirections(n,o);J.IsAscending(a)||(n=i.end,o=i.start,a=j.OppositeDir(a)),t=bi.TraverseToFirstVertexAtOrAbove(t,n,j.OppositeDir(a));for(let l=t;l!=null;l=J.FindAdjacentVertex(l,a)){let u=k.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();k.ComparePP(c.Location,t.point)>0&&k.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,j.OppositeDir(a)),k.ComparePP(c.Location,t.point)>=0&&k.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,i){let n=e,o=j.OppositeDir(i);for(;;){let a=J.FindAdjacentVertex(n,i);if(a==null||k.GetDirections(a.point,t)===o)break;n=a}return n}SpliceGroupBoundaryCrossing(e,t,i){var o,a;let n=Os.ToCrossingArray(t.Crossings,i);if(n!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=n[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=n.map(f=>f.Group.InputShape);h.IsPassable=()=>d.some(f=>f.IsTransparent)}}ExtendSpliceWorker(e,t,i,n,o,a,l){let u=J.FindAdjacentVertex(e,i);l.spliceTarget=J.FindAdjacentVertex(u,i);let c={spliceSource:e};for(;bi.GetNextSpliceSource(c,i,t);){let h=J.FindBendPointBetween(u.point,c.spliceSource.point,j.OppositeDir(i));if(bi.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=bi.GetSpliceTarget(c,i,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?Le.OverlappedWeight:Le.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?Le.OverlappedWeight:Le.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?Le.OverlappedWeight:Le.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&k.GetDirections(h,n.end))===0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,i){let n=J.FindAdjacentVertex(e.spliceSource,i);if(n==null)for(n=e.spliceSource;;){if(n=J.FindAdjacentVertex(n,j.OppositeDir(t)),n==null)return!1;let o=J.FindAdjacentVertex(n,i);if(o!=null){n=o;break}}return e.spliceSource=n,!0}static GetSpliceTarget(e,t,i){let n=k.GetDirections(e.spliceSource.point,i),o=n,a=e.spliceSource;for(;o===n&&(e.spliceSource=a,a=J.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(m.closeDistEps(a.point,i)){a=J.FindAdjacentVertex(a,t);break}o=k.GetDirections(a.point,i)}return a}SeeIfSpliceIsStillOverlapped(e,t){let i=this.FindNextEdge(t,j.RotateLeft(e)),n=i==null?!1:Le.NormalWeight===i.Weight;return n||(i=this.FindNextEdge(t,j.RotateRight(e)),n=i==null?!1:Le.NormalWeight===i.Weight),!n||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(bi.IsSkippableSpliceSourceEdgeWithNullTarget(J.FindAdjacentEdge(e,t)))return!0;let i=J.FindAdjacentEdge(e,j.OppositeDir(t));return bi.IsSkippableSpliceSourceEdgeWithNullTarget(i)||bi.IsReflectionEdge(i)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&le(e.Length,Tc.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight===Le.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return k.GetDirections(e.start,e.end)===k.GetDirections(e.end,t)}toString(){return rA.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var Xl=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new bt;this.freePointLocationsUsedByRouteEdges=new nt;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new bi(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let i=A.RoundPoint(t.Location);if(0===L.PointRelativeToCurveLocation(i,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!==t.Curve&&0===L.PointRelativeToCurveLocation(i,t.Curve))return null;let n=new g0(t,e);return this.obstaclePortMap.set(t,n),n}FindVertices(e){let t=new Array,i=this.obstaclePortMap.get(e);if(i)if(this.RouteToCenterOfObstacles)t.push(i.CenterVertex);else for(let n of i.PortEntrances){let o=this.VisGraph.FindVertex(n.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(A.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);if(this.AncestorSets.size>0&&i.oport!=null&&n.oport!=null){let l=xs(a,o),u=xs(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,i.oport),this.AddPortToGraph(e.targetPort,n.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let i=this.FindVertices(t),n=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i),n=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i)}ConnectToGraphAtPointsCollinearWithVertices(e,t,i){if(0===t)return;let n=j.OppositeDir(t);for(let o of i){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,n,Le.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size===0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size===0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(W.mkPP(e.Location,e.Location),i=>i.IsGroup)).map(i=>i.InputShape))}ActivateAncestors(e,t,i){for(let n of Yn(e,t)){let o=i.get(n);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=W.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let i={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(i)){for(let n of i.addedPorts)this.CreateObstaclePort(t.Obstacle,n);for(let n of i.removedPorts)this.RemoveObstaclePort(n);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),i=this.FindObstaclePort(e.targetPort);if(t==null||i==null||t.Obstacle.IsInConvexHull||i.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(i),!t.VisibilityRectangle.intersects(i.VisibilityRectangle)))return null;for(let n of t.PortEntrances)if(!!n.WantVisibilityIntersection)for(let o of i.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=n.IsVertical===o.IsVertical?Xl.GetPathPointsFromOverlappingCollinearVisibility(n,o):Xl.GetPathPointsFromIntersectingVisibility(n,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!J.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||m.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let i=J.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!i||e.HasGroupCrossingBeforePoint(i)||t.HasGroupCrossingBeforePoint(i)?null:[e.UnpaddedBorderIntersect,i,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,i=W.mkPP(A.RoundPoint(e.PortCurve.boundingBox.leftBottom),A.RoundPoint(e.PortCurve.boundingBox.rightTop)),n=A.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!k.Equal(n.y,i.top)&&!k.Equal(n.y,i.bottom)){o=!0;let l=new D(t.left,n.y,t.right,n.y);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(Math.min(a.xx0.x,a.xx1.x),n.y);u.x<i.left&&(u=new m(i.left,u.y));let c=new m(Math.max(a.xx0.x,a.xx1.x),n.y);c.x>i.right&&(c=new m(i.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}if(!k.Equal(n.x,i.left)&&!k.Equal(n.x,i.right)){o=!0;let l=new D(n.x,t.bottom,n.x,t.top);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(n.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new m(u.x,t.bottom));let c=new m(n.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new m(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}o||this.CreateEntrancesForCornerPort(i,e,n)}GetBorderIntersections(e,t,i,n){let o=L.getAllIntersections(t,i,!0);n.xx0=A.RoundPoint(o[0].x),n.xx1=A.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,i,n,o){let a=k.GetDirections(n,o);k.EqualPP(n,i)||this.CreatePortEntrance(e,t,o,a),k.EqualPP(o,i)||this.CreatePortEntrance(e,t,n,j.OppositeDir(a))}static GetDerivative(e,t){let i=e.PortCurve.closestParameter(t),n=e.PortCurve.derivative(i),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return dr.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(n=n.mul(-1)),n}CreatePortEntrance(e,t,i,n){t.CreatePortEntrance(i,n,this.ObstacleTree);let o=Mt.GetInstance(n),a=J.GetRectangleBound(e,n)-o.Coord(i);if(a<0&&(a=-a),a>A.intersectionEpsilon){let l=j.VectorDirection(Xl.GetDerivative(t,i)),u;n|j.OppositeDir(n),0!==(n&l)&&(u=j.OppositeDir(u)),t.CreatePortEntrance(i,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,i){let n=1;k.EqualPP(i,e.leftBottom)?n=4:k.EqualPP(i,e.leftTop)?n=8:k.EqualPP(i,e.rightTop)?n=1:k.EqualPP(i,e.rightBottom)&&(n=2),t.CreatePortEntrance(i,n,this.ObstacleTree),t.CreatePortEntrance(i,j.RotateRight(n),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let i={targetVertex:null},n=e.IsOverlapped?Le.OverlappedWeight:Le.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,n,i)!=null&&e.AddToAdjacentVertex(this.TransUtil,i.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return J.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,i,n){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o)}FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o){let a=J.SortAscending(e,t),l=a[0],u=a[1],c=J.IsVerticalD(i)?this.HScanSegments:this.VScanSegments,h=J.IsAscending(i)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=J.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(J.IsAscending(i)?l:u,h,d,n,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,i,n,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(i),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,i,t,n,a);if(d!=null)return d}else if(k.EqualPP(e,i))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,j.OppositeDir(t.ScanDirection.Dir));let l=k.GetDirections(i,e),u=k.GetDirections(a.segsegVertex.point,e);if(l===u){let d={bracketTarget:null,bracketSource:null};return bi.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,j.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,j.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(i),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=J.GetEdgeEnd(c,j.OppositeDir(u)),i=J.SegmentIntersectionPPP(e,i,a.segsegVertex.point),k.EqualPP(a.segsegVertex.point,i)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(i),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,n)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,i,n,o){let l=(i.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(i.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,i.LowestVisibilityVertex,i.Weight);let u=J.SegmentsIntersection(i,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(i,o.segsegVertex,i.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),k.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return k.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,n)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,i){return k.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,i):k.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,i):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():W.mkOnPoints([A.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new m0(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=A.RoundPoint(e);let t=this.VisGraph.FindVertex(e),i=this.FindOrCreateFreePoint(e);if(t!=null)return i;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(i),i;let n=null;i.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(i.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};n=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,i.InitialWeight,l)}let a=4;if(n!=null)a=J.EdgeDirectionVE(n),this.ConnectFreePointToLateralEdge(i,j.RotateLeft(a)),this.ConnectFreePointToLateralEdge(i,j.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(i,a),a=j.RotateLeft(a);return i}CreateOutOfBoundsFreePoint(e){let t=e.Point,i=this.graphGenerator.MakeInBoundsLocation(t),n=k.GetDirections(i,t);if(e.OutOfBoundsDirectionFromGraph=n,!k.IsPureDirectionD(n)){e.AddOobEdgesFromGraphCorner(this.TransUtil,i);return}let o=this.VisGraph.FindVertex(i),a=j.OppositeDir(n);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,i,n,Le.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=J.FindAdjacentVertex(o,j.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,Le.NormalWeight);let u=J.FindAdjacentVertex(o,j.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,Le.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let i=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),n=this.FindorCreateNearestPerpEdgePPDN(i,e.Point,t,e.InitialWeight);n!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,n,t,this.portSpliceLimitRectangle)}};var fr=class extends ye{constructor(e,t,i){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=t,this.CornerFitRadius=i,this.BendPenaltyAsAPercentageOfDistance=fn.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new ti,this.PortManager=new Xl(this.GraphGenerator),this.AddShapes(e)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(e){this.PortManager.RouteToCenterOfObstacles=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=e}AddEdgeGeometryToRoute(e){m.closeDistEps(A.RoundPoint(e.sourcePort.Location),A.RoundPoint(e.targetPort.Location))?this.selfEdges.push(e):this.EdgesToRoute.push(e)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof ti}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.PaddedPolyline)}AddObstacles(e){this.AddShapes(e),this.RebuildTreeAndGraph()}AddShapes(e){for(let t of e)this.AddObstacleWithoutRebuild(t)}AddObstacle(e){this.AddObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}UpdateObstacles(e){for(let t of e)this.UpdateObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}UpdateObstacle(e){this.UpdateObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}RemoveObstacles(e){for(let t of e)this.RemoveObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}RemoveObstacle(e){this.RemoveObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(e)}UpdateObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(e)),this.CreatePaddedObstacle(e)}CreatePaddedObstacle(e){let t=new Mr(e,this.Padding);this.ShapeToObstacleMap.set(e,t),this.PortManager.CreateObstaclePorts(t)}RemoveObstacleWithoutRebuild(e){let t=this.ShapeToObstacleMap.get(e);this.ShapeToObstacleMap.delete(e),this.PortManager.RemoveObstaclePorts(t)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let e=this.ObsTree.Root!=null,t=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),e&&this.GenerateObstacleTree(),t&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return fr.constructorC(null)}static constructorC(e){return new fr([],fr.DefaultPadding,fr.DefaultCornerFitRadius)}static constructorI(e){return new fr(e,fr.DefaultPadding,fr.DefaultCornerFitRadius)}static constructorINN(e,t,i){return new fr(e,t,i)}static constructorGNAN(e,t,i,n){let o=new fr(Jr.GetShapes(e),i,n);if(t==null)for(let a of e.edges())o.AddEdgeGeometryToRoute(a);else for(let a of t)o.AddEdgeGeometryToRoute(a);return o}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let e=this.EdgesToRoute.map(t=>new d0(t));this.FillEdgePathsWithShortestPaths(e),this.NudgePaths(e),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let e of this.selfEdges){let t={smoothedPolyline:null};e.curve=Xe.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.Padding,2*e.GetMaxArrowheadLength()),t)}}FillEdgePathsWithShortestPaths(e){this.PortManager.BeginRouteEdges();let t=new Ul(this.BendPenaltyAsAPercentageOfDistance);for(let i of e)this.AddControlPointsAndGeneratePath(t,i);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(e,t){let i=this.PortManager.GetPortVisibilityIntersection(t.GeomEdge);if(i!=null){this.GeneratePathThroughVisibilityIntersection(t,i);return}this.SpliceVisibilityAndGeneratePath(e,t)}GeneratePathThroughVisibilityIntersection(e,t){e.PathPoints=t}SpliceVisibilityAndGeneratePath(e,t){this.PortManager.AddControlPointsToGraph(t.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(e,t,!1)||this.RetryPathsWithAdditionalGroupsEnabled(e,t),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(e,t,i){let n=this.PortManager.FindVertices(t.GeomEdge.sourcePort),o=this.PortManager.FindVertices(t.GeomEdge.targetPort);return fr.GetSingleStagePath(t,e,n,o,i)}static GetSingleStagePath(e,t,i,n,o){return e.PathPoints=t.GetPath(i,n),o&&fr.EnsureNonNullPath(e),e.PathPoints!=null&&e.PathPoints.length>0}static EnsureNonNullPath(e){e.PathPoints==null&&(k.IsPureDirection(e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location)?e.PathPoints=[e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location]:e.PathPoints=[e.GeomEdge.sourcePort.Location,new m(e.GeomEdge.sourcePort.Location.x,e.GeomEdge.targetPort.Location.y),e.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(e,t){(!this.PortManager.SetAllAncestorsActive(t.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(e,t,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(e,t,!0))}NudgePaths(e){let t=this.ObsTree.SpatialAncestorsAdjusted?ut.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;pt.NudgePaths(e,this.CornerFitRadius,this.PaddedObstacles,t,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(e){this.removeStaircases=e}FinaliseEdgeGeometries(){for(let e of this.EdgesToRoute.concat(this.selfEdges)){if(e.curve==null)continue;e.curve instanceof re&&(e.curve=fr.FitArcsIntoCorners(this.CornerFitRadius,Array.from(e.curve))),fr.CalculateArrowheads(e)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(e){rr.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=ut.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(e){this.GraphGenerator.Clear(),this.ClearShortestPaths(),e?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let e of this.EdgesToRoute)e.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(e,t){let i=fr.GetFittedArcSegs(e,t),n=new L,o=null;for(let a of i){let l=fr.EllipseIsAlmostLineSegment(a);o!=null?l?L.continueWithLineSegmentP(n,fr.CornerPoint(a)):(L.continueWithLineSegmentP(n,a.start),n.addSegment(a)):l?L.addLineSegment(n,t[0],fr.CornerPoint(a)):(L.addLineSegment(n,t[0],a.start),n.addSegment(a)),o=a}return n.segs.length>0?L.continueWithLineSegmentP(n,t[t.length-1]):L.addLineSegment(n,t[0],t[t.length-1]),n}static CornerPoint(e){return e.center.add(e.aAxis.add(e.bAxis))}static EllipseIsAlmostLineSegment(e){return e.aAxis.lengthSquared<1e-4||e.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(e,t){let i=t[1].sub(t[0]),n=i.normalize(),o=Math.min(e,i.length/2);for(let a=1;a<t.length-1;a++){i=t[a+1].sub(t[a]);let l=i.length;if(l<A.intersectionEpsilon){yield new de(0,0,new m(0,0),new m(0,0),t[a]);continue}let u=i.div(l);Math.abs(u.dot(n))>.9&&(yield new de(0,0,new m(0,0),new m(0,0),t[a]));let c=Math.min(e,i.length/2),h=u.mul(-c),d=n.mul(o);yield new de(0,Math.PI/2,h,d,t[a].sub(d.add(h))),n=u,o=c}}},wc=fr;wc.DefaultPadding=1,wc.DefaultCornerFitRadius=3;var Fd=class extends ye{constructor(e,t,i){super(null);this.graph=e,this.source=t,this.length=i}get Result(){return this.result}run(){let e=new _r((n,o)=>n-o),t=new Map;for(let n of this.graph.shallowNodes){let o=n===this.source?0:Number.POSITIVE_INFINITY;e.Enqueue(n,o),t.set(n,o)}for(;e.count>0;){let n={priority:0},o=e.DequeueAndGetPriority(n);t.set(o,n.priority);let a=t.get(o);for(let l of o.inEdges()){let u=l.source,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}for(let l of o.outEdges()){let u=l.target,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}}this.result=new Array(this.graph.shallowNodeCount);let i=0;for(let n of this.graph.shallowNodes){let o=t.get(n);o!==void 0?this.result[i++]=o:this.result[i++]=Number.POSITIVE_INFINITY}}};var Gd=class extends ye{get Result(){return this.result}set Result(e){this.result=e}constructor(e,t){super(null);this.graph=e,this.length=t}run(){this.result=new Array(this.graph.shallowNodeCount);let e=0;for(let t of this.graph.shallowNodes){let i=new Fd(this.graph,t,this.length);i.run(),this.Result[e++]=i.Result}}static Stress(e,t){let i=0;if(e.edgeCount===0)return i;let n=new Gd(e,t);n.run();let o=n.Result,a=0;for(let u of e.edges())a+=t(u);a/=e.edgeCount;let l=0;for(let u of e.shallowNodes){let c=0;for(let h of e.shallowNodes){if(l!==c){let d=u.center.sub(h.center).length,f=a*o[l][c],p=f-d;i+=p*p/(f*f)}c++}l++}return i}};var E0=class extends ye{get Result(){return this.result}constructor(e,t,i){super(null);this.graph=e,this.pivotArray=t,this.length=i}run(){this.result=new Array(this.pivotArray.length);let e=Array.from(this.graph.shallowNodes),t=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),i=e[0];this.pivotArray[0]=0;for(let n=0;;n++){let o=new Fd(this.graph,i,this.length);if(o.run(),this.Result[n]=o.Result,n+1<this.pivotArray.length){let a=0;for(let l=0;l<this.Result[n].length;l++)t[l]=Math.min(t[l],this.Result[n][l]),t[l]>t[a]&&(a=l);i=e[a],this.pivotArray[n+1]=a}else break}}};var x0=class{static Rotate(e,t,i){let n=Math.sin(i*(Math.PI/180)),o=Math.cos(i*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+n*t[a];t[a]=o*t[a]-n*e[a],e[a]=l}}};var ct=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),i=new Array(e[0].length).fill(0),n=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],i[a]+=e[o][a],n+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)i[o]/=e[0].length;n/=e.length,n/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+i[a]-n}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[0].length;i++)e[t][i]=Math.pow(e[t][i],2)}static Multiply(e,t){for(let i=0;i<e.length;i++)for(let n=0;n<e[0].length;n++)e[i][n]*=t}static MultiplyX(e,t){if(e[0].length!==t.length)return null;let i=new Array(t.length).fill(0);for(let n=0;n<e.length;n++)for(let o=0;o<e[0].length;o++)i[n]+=e[n][o]*t[o];return i}static Norm(e){let t=0;for(let i=0;i<e.length;i++)t+=Math.pow(e[i],2);return Math.sqrt(t)}static Normalize(e){let t=ct.Norm(e);if(t<=0)return 0;for(let i=0;i<e.length;i++)e[i]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let i=0;i<e;i++)t[i]=Td();return ct.Normalize(t),t}static SpectralDecomposition(e,t){ct.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,i,n){let o=e[0].length;t.u1=ct.RandomUnitLengthVector(o),t.lambda1=0,t.u2=ct.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-n;for(let u=0;u<i&&a<l;u++){let c=ct.MultiplyX(e,t.u1),h=ct.MultiplyX(e,t.u2);t.lambda1=ct.Normalize(c),t.lambda2=ct.Normalize(h),ct.MakeOrthogonal(h,c),ct.Normalize(h),a=Math.min(ct.DotProduct(t.u1,c),ct.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!==t.length)return 0;let i=0;for(let n=0;n<e.length;n++)i+=e[n]*t[n];return i}static MakeOrthogonal(e,t){if(e.length!==t.length)return;let i=ct.DotProduct(e,t)/ct.DotProduct(t,t);for(let n=0;n<e.length;n++)e[n]-=i*t[n]}static ClassicalScaling(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=e[n].slice();ct.SquareEntries(i),ct.DoubleCenter(i),ct.Multiply(i,-.5),ct.SpectralDecomposition(i,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let n=0;n<t.u1.length;n++)t.u1[n]*=t.lambda1,t.u2[n]*=t.lambda2}static DistanceScalingSubset(e,t,i,n,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]===0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!==d&&(c[h]+=n[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let f=0,p=0;for(let S=0;S<a;S++)if(d!==S){let x=Math.sqrt(Math.pow(t[u[d]]-t[S],2)+Math.pow(i[u[d]]-i[S],2));x>0&&(x=1/x),f+=n[d][S]*(t[S]+e[d][S]*(t[u[d]]-t[S])*x),p+=n[d][S]*(i[S]+e[d][S]*(i[u[d]]-i[S])*x)}t[u[d]]=f/c[d],i[u[d]]=p/c[d]}}static DistanceScaling(e,t,i,n,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!==c&&(l[u]+=n[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let f=0;f<a;f++)if(c!==f){let p=Math.sqrt(Math.pow(t[c]-t[f],2)+Math.pow(i[c]-i[f],2));p>0&&(p=1/p),h+=n[c][f]*(t[f]+e[c][f]*(t[c]-t[f])*p),d+=n[c][f]*(i[f]+e[c][f]*(i[c]-i[f])*p)}t[c]=h/l[c],i[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e[n].length).fill(0);for(let o=0;o<e[n].length;o++)e[n][o]>0&&(i[n][o]=Math.pow(e[n][o],t))}return i}static EuclideanDistanceMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e.length);for(let o=0;o<e.length;o++)i[n][o]=Math.sqrt(Math.pow(e[n]-e[o],2)+Math.pow(t[n]-t[o],2))}return i}static LandmarkClassicalScaling(e,t,i){let n=new Array(e.length);for(let l=0;l<e.length;l++){n[l]=new Array(e.length);for(let u=0;u<e.length;u++)n[l][u]=e[l][i[u]]}ct.SquareEntries(n);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=n[l][u];o[l]/=e.length}ct.DoubleCenter(n),ct.Multiply(n,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};ct.SpectralDecomposition(n,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<n.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var iA=me(tr());var C0=class{constructor(e,t){this.Constrained=!1;this.Capacity=1e6;ht.AbovePP(e.point,t.point)===1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e===this.upperSite||e===this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle===e?this.cwTriangle:this.ccwTriangle}toString(){return iA.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite===e?this.lowerSite:this.upperSite}};var Yl=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let i=new Yl(e);return i.Owner=t,i}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite===e)return t}return null}AddInEdge(e){this.InEdges==null&&(this.InEdges=new Array),this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let i=t.upperSite===this?t.CcwTriangle:t.CwTriangle;if(i==null){t=null;break}yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+2)}while(t!==e);if(t!==e){t=e;do{let i=t.upperSite===this?t.CwTriangle:t.CcwTriangle;if(i==null)break;yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var A0=me(un());var Ms=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite===e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var Tg=class{has(e){return e===this.item0||e===this.item1||e===this.item2}index(e){return e===this.item0?0:e===this.item1?1:e===this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var Pi=class{constructor(){this.TriEdges=new Tg;this.Sites=new Tg}static mkSSSD(e,t,i,n){let o=m.getTriangleOrientation(e.point,t.point,i.point),a=new Pi;switch(o){case 1:a.FillCcwTriangle(e,t,i,n);break;case 0:a.FillCcwTriangle(e,i,t,n);break;default:throw new Error}return a}static mkSED(e,t,i){let n=new Pi;switch(m.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=n,n.Sites.setItem(0,t.upperSite),n.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=n,n.Sites.setItem(0,t.lowerSite),n.Sites.setItem(1,t.upperSite);break;default:throw new Error}return n.TriEdges.setItem(0,t),n.Sites.setItem(2,e),n.CreateEdge(1,i),n.CreateEdge(2,i),n}static mkSSSEE(e,t,i,n,o,a){let l=Pi.mkSSSD(e,t,i,a);return l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e===t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,i,n){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,i);for(let o=0;o<3;o++)this.CreateEdge(o,n)}CreateEdge(e,t){let i=this.Sites.getItem(e),n=this.Sites.getItem(e+1),o=t(i,n);this.TriEdges.setItem(e,o),this.BindEdgeToTriangle(i,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.TriEdges.getItem(t+1)}OppositeSite(e){let t=this.TriEdges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=W.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,i,n,o,a){let l=new Pi;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,i),l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var v0=class{constructor(e,t,i,n,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.leftPolygon=n,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(m.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite===this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,i=(o=t.CcwTriangle)!=null?o:t.CwTriangle,n=i.TriEdges.index(t);for(let a=1;a<=2;a++){let l=i.TriEdges.getItem(a+n),u=cn.sign(m.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(cn.sign(m.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=i,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.TriEdges)if(t.CcwTriangle==null&&t.CwTriangle==null){let i=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,n=nr.FindNodeInFrontBySite(this.front,i);n.item.Edge===t&&this.elementsToBeRemovedFromFront.push(n.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle===this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var i,n;let e=(i=this.piercedEdge.CwTriangle)!=null?i:this.piercedEdge.CcwTriangle,t=e.TriEdges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.TriEdges.getItem(o+t),l=cn.sign(m.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(cn.sign(m.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=nr.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((n=a.CwTriangle)!=null?n:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.TriEdges)t.CwTriangle===e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(m.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite===this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!==this.b&&(t.length===0||t[t.length-1]!==e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=nr.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(m.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(m.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let i of this.a.Edges){let n=i.CcwTriangle;if(n==null||m.pointToTheLeftOfLine(this.b.point,i.lowerSite.point,i.upperSite.point))continue;let o=n.TriEdges.index(i),a=n.Sites.getItem(o+2);if(m.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,i.upperSite.point)){this.piercedEdge=n.TriEdges.getItem(o+1),this.piercedTriangle=n;break}}}};var Vd=class{constructor(e,t,i,n){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.createEdgeDelegate=n}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let i of t.TriEdges)(i.CwTriangle==null||i.CcwTriangle==null)&&e.add(i);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new Ms(t,e))}TriangulatePolygon0(e,t,i,n){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,i,n)}TriangulatePolygon1(e,t,i,n,o,a){let l=i[e],u=e;for(let h=e+1;h<=t;h++){let d=i[h];Vd.LocalInCircle(d,n,o,l,a)&&(u=h,l=d)}let c=Pi.mkSSSD(n,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,i,n,l,a),u<t&&this.TriangulatePolygon1(u+1,t,i,l,o,a)}static LocalInCircle(e,t,i,n,o){return o?Ig(e,t,n,i):Ig(e,t,i,n)}TraceEdgeThroughTriangles(){new v0(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var wg=class{constructor(e){this.Edge=e}};var nr=class extends ye{constructor(e,t,i,n){super(null);this.front=new Ct((e,t)=>e.x-t.x);this.triangles=new Set;if(this.listOfSites=e,this.listOfSites.length===0)return;this.p_1=t,this.p_2=i,this.createEdgeDelegate=n;let o=Pi.mkSSSD(t,i,this.listOfSites[0],n);this.triangles.add(o),this.front.insert(new Ms(t,o.TriEdges.getItem(2))),this.front.insert(new Ms(this.listOfSites[0],o.TriEdges.getItem(1)))}run(){if(this.listOfSites.length!==0){for(let e=1;e<this.listOfSites.length;e++)this.ProcessSite(this.listOfSites[e]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let e=this.CreateDoubleLinkedListOfPerimeter();do{let t=this.FindConcaveEdge(e);if(t==null)return;e=this.ShortcutTwoListElements(t)}while(!0)}FindConcaveEdge(e){let t=e,i;do{if(i=t.Next,m.getTriangleOrientation(t.Start.point,t.End.point,i.End.point)===1)return t;t=i}while(i!==e);return null}static FindPivot(e){let t=e,i=e;do i=i.Next,(i.Start.point.x<t.Start.point.x||i.Start.point.x===t.Start.point.x&&i.Start.point.y<t.Start.point.y)&&(t=i);while(i!==e);return t}FindFirsePerimeterEdge(){for(let e of this.triangles)for(let t of e.TriEdges)if(t.GetOtherTriangle_T(e)==null)return t;return null}CreateDoubleLinkedListOfPerimeter(){let e=this.FindFirsePerimeterEdge(),t=e,i=null,n,o=null,a=new Array;do n=nr.CreatePerimeterElementFromEdge(t),a.push(D.mkPP(n.Start.point,n.End.point)),t=nr.FindNextEdgeOnPerimeter(t),o!=null?(n.Prev=o,o.Next=n):i=n,o=n;while(t!==e);return i.Prev=n,n.Next=i,i}static FindNextEdgeOnPerimeter(e){var i;let t=(i=e.CwTriangle)!=null?i:e.CcwTriangle;for(e=t.TriEdges.getItem(t.TriEdges.index(e)+2);e.CwTriangle!=null&&e.CcwTriangle!=null;)t=e.GetOtherTriangle_T(t),e=t.TriEdges.getItem(t.TriEdges.index(e)+2);return e}static CreatePerimeterElementFromEdge(e){let t=new wg(e);return e.CwTriangle!=null?(t.Start=e.upperSite,t.End=e.lowerSite):(t.End=e.upperSite,t.Start=e.lowerSite),t}RemoveP1AndP2Triangles(){let e=new Set;for(let t of this.triangles)(t.Sites.has(this.p_1)||t.Sites.has(this.p_2))&&e.add(t);for(let t of e)nr.RemoveTriangleWithEdges(this.triangles,t)}static RemoveTriangleWithEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle===t?i.CwTriangle=null:i.CcwTriangle=null,i.CwTriangle==null&&i.CcwTriangle==null&&T0(i.upperSite.Edges,i)}static RemoveTriangleButLeaveEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle===t?i.CwTriangle=null:i.CcwTriangle=null}ProcessSite(e){this.PointEvent(e);for(let t=0;t<e.Edges.length;t++){let i=e.Edges[t];i.Constrained&&this.EdgeEvent(i)}}EdgeEvent(e){if(nr.EdgeIsProcessed(e))return;new Vd(e,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(e){return e.CwTriangle!=null||e.CcwTriangle!=null}ShowFrontWithSite(e,t=null){let i=new Array;if(e.Edges!=null)for(let n of e.Edges)i.push(be.mkDebugCurveTWCI(200,.8,n.Constrained?"Pink":"Brown",D.mkPP(n.upperSite.point,n.lowerSite.point)));i.push(be.mkDebugCurveTWCI(200,1,"Brown",de.mkFullEllipseNNP(.5,.5,e.point)));for(let n of this.triangles)for(let o=0;o<3;o++){let a=n.TriEdges.getItem(o);i.push(be.mkDebugCurveTWCI(a.Constrained?155:100,a.Constrained?.8:.4,a.Constrained?"Pink":"Navy",D.mkPP(a.upperSite.point,a.lowerSite.point)))}if(t!=null)for(let n of t)i.push(be.mkDebugCurveTWCI(100,.5,"Red",n));for(let n of this.front)i.push(be.mkDebugCurveTWCI(100,5.5,"Green",D.mkPP(n.Edge.upperSite.point,n.Edge.lowerSite.point)))}Show(e){nr.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],e)}static ShowCdt(e,t,i,n,o,a){let l=new Array;if(i!=null)for(let u of i)l.push(be.mkDebugCurveTWCI(200,.1,"Red",u));if(n!=null)for(let u of n)l.push(be.mkDebugCurveTWCI(200,.1,"Blue",u));if(t!=null)for(let u of t)l.push(be.mkDebugCurveTWCI(200,.1,"Green",D.mkPP(u.Edge.upperSite.point,u.Edge.lowerSite.point)));for(let u of e)for(let c=0;c<3;c++){let h=u.TriEdges.getItem(c);l.push(nr.GetDebugCurveOfCdtEdge(h))}l=l.concat(o)}static GetDebugCurveOfCdtEdge(e){return e.CcwTriangle==null||e.CwTriangle==null?be.mkDebugCurveTWCI(255,.5,e.Constrained?"Brown":"Black",D.mkPP(e.upperSite.point,e.lowerSite.point)):be.mkDebugCurveTWCI(200,e.Constrained?.8:.2,e.Constrained?"Pink":"Navy",D.mkPP(e.upperSite.point,e.lowerSite.point))}PointEvent(e){let t=this.ProjectToFront(e),i={rightSite:null},n=t.item.x+A.distanceEpsilon<e.point.x?this.MiddleCase(e,t,i):this.LeftCase(e,t,i),o=this.InsertSiteIntoFront(n,e,i.rightSite);this.TriangulateEmptySpaceToTheRight(o),o=nr.FindNodeInFrontBySite(this.front,n),this.TriangulateEmptySpaceToTheLeft(o)}LeftCase(e,t,i){let n=t.item;this.InsertAndLegalizeTriangle(e,n);let o=this.front.previous(t),a=o.item.LeftSite;i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,o.item),this.front.deleteNodeInternal(o);let l=this.front.remove(n);return a}MiddleCase(e,t,i){let n=t.item.LeftSite;return i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,t.item),this.front.deleteNodeInternal(t),n}TriangulateEmptySpaceToTheLeft(e){let t=e.item.RightSite,i=this.front.previous(e);for(;i!=null;){let n=i.item,o=n.LeftSite,a=n.RightSite;if(a.point.sub(t.point).dot(o.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(i,e),i=this.front.previous(e);else{this.TryTriangulateBasinToTheLeft(e);break}}}ShortcutTwoListElements(e){var a;let t=e.Next,i=Pi.mkSSSEE(e.Start,e.End,t.End,e.Edge,t.Edge,this.createEdgeDelegate);this.triangles.add(i);let n=i.TriEdges.getItem(2);this.LegalizeEdge(e.Start,i.OppositeEdge(e.Start)),i=(a=n.CcwTriangle)!=null?a:n.CwTriangle,this.LegalizeEdge(t.End,i.OppositeEdge(t.End));let o=new wg(n);return o.Start=e.Start,o.End=t.End,e.Prev.Next=o,o.Prev=e.Prev,o.Next=t.Next,t.Next.Prev=o,o}ShortcutTwoFrontElements(e,t){var l;let i=e.item,n=t.item,o=Pi.mkSSSEED(i.LeftSite,i.RightSite,n.RightSite,i.Edge,n.Edge,this.createEdgeDelegate);this.triangles.add(o),this.front.deleteNodeInternal(e),this.front.remove(n);let a=o.TriEdges.getItem(2);return this.LegalizeEdge(i.LeftSite,o.OppositeEdge(i.LeftSite)),o=(l=a.CcwTriangle)!=null?l:a.CwTriangle,this.LegalizeEdge(n.RightSite,o.OppositeEdge(n.RightSite)),this.front.insert(new Ms(i.LeftSite,a))}TryTriangulateBasinToTheLeft(e){if(!nr.DropsSharpEnoughToTheLeft(e.item))return;let t=new A0.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=nr.FindNodeInFrontBySite(this.front,i);let n=this.front.previous(e);if(n==null)return;if(m.getTriangleOrientation(n.item.LeftSite.point,e.item.LeftSite.point,e.item.RightSite.point)==1)t.push(n.item.LeftSite),this.ShortcutTwoFrontElements(n,e);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(n.item.LeftSite);else{if(n.item.LeftSite.point.y<=n.item.RightSite.point.y)return;t.push(n.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(e){let t=e.Edge;if(e.RightSite!==t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x>=.5*i.y}InsertSiteIntoFront(e,t,i){let n=null,o=null;for(let a of t.Edges)if(o==null&&a.lowerSite===e&&(o=a),n==null&&a.lowerSite===i&&(n=a),o!=null&&n!=null)break;return this.front.insert(new Ms(e,o)),this.front.insert(new Ms(t,n))}TriangulateEmptySpaceToTheRight(e){let i=e.item.LeftSite.point,n=this.front.next(e);for(;n!=null;){let o=n.item,a=o.LeftSite,l=o.RightSite;if(a.point.sub(i).dot(l.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(e,n),n=this.front.next(e);else{this.TryTriangulateBasinToTheRight(e);break}}}TryTriangulateBasinToTheRight(e){if(!nr.DropsSharpEnoughToTheRight(e.item))return;let t=new A0.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=nr.FindNodeInFrontBySite(this.front,i);let n=this.front.next(e);if(n==null)return;if(m.getTriangleOrientation(e.item.LeftSite.point,e.item.RightSite.point,n.item.RightSite.point)==1)this.ShortcutTwoFrontElements(e,n),t.push(i);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(e.item.RightSite);else{if(n.item.LeftSite.point.y>=n.item.RightSite.point.y)return;t.push(e.item.RightSite)}}}static DropsSharpEnoughToTheRight(e){let t=e.Edge;if(e.LeftSite!==t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x<=-.5*i.y}static FindNodeInFrontBySite(e,t){return e.findLast(i=>i.LeftSite.point.x<=t.point.x)}InsertAndLegalizeTriangle(e,t){var i;if(m.getTriangleOrientation(e.point,t.LeftSite.point,t.RightSite.point)!==2){let n=Pi.mkSED(e,t.Edge,this.createEdgeDelegate);this.triangles.add(n),this.LegalizeEdge(e,n.TriEdges.getItem(0))}else{let n=t.Edge;T0(n.upperSite.Edges,n);let o=(i=n.CcwTriangle)!=null?i:n.CwTriangle,a=o.OppositeSite(n);nr.RemoveTriangleButLeaveEdges(this.triangles,o),o=Pi.mkSSSD(t.LeftSite,a,e,this.createEdgeDelegate);let l=Pi.mkSSSD(t.RightSite,a,e,this.createEdgeDelegate);this.triangles.add(o),this.triangles.add(l),this.LegalizeEdge(e,o.OppositeEdge(e)),this.LegalizeEdge(e,l.OppositeEdge(e))}}LegalizeEdge(e,t){t.Constrained||t.CcwTriangle==null||t.CwTriangle==null||(t.CcwTriangle.Contains(e)?this.LegalizeEdgeForOtherCwTriangle(e,t):this.LegalizeEdgeForOtherCcwTriangle(e,t))}LegalizeEdgeForOtherCwTriangle(e,t){let i=t.CwTriangle.TriEdges.index(t);if(nA(e,t.upperSite,t.CwTriangle.Sites.getItem(i+2),t.lowerSite)){let n=oA(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}LegalizeEdgeForOtherCcwTriangle(e,t){let i=t.CcwTriangle.TriEdges.index(t);if(nA(e,t.lowerSite,t.CcwTriangle.Sites.getItem(i+2),t.upperSite)){let n=oA(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}ProjectToFront(e){return this.front.findLast(t=>t.x<=e.point.x)}};function T0(s,e){if(s.length===0)return;let t=s.findIndex(i=>e===i);t>=0&&(t!==s.length-1&&(s[t]=s[s.length-1]),s.pop())}function nA(s,e,t,i){return SN(s,e,t,i)&&Ig(s,e,t,i)}function SN(s,e,t,i){return m.getTriangleOrientation(e.point,s.point,t.point)===0&&m.getTriangleOrientation(t.point,s.point,i.point)===0}function Ig(s,e,t,i){let n=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=i.point.x-s.point.x,c=i.point.y-s.point.y,h=n*n+o*o,d=a*a+l*l,f=u*u+c*c;return n*(l*f-c*d)-a*(o*f-c*h)+u*(o*d-l*h)>A.tolerance}function oA(s,e){let t,i;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,i=e.CwTriangle):(t=e.CwTriangle,i=e.CcwTriangle);let n=t.TriEdges.index(e),o=i.TriEdges.index(e),a=i.Sites.getItem(o+2),l=t.TriEdges.getItem(n+1),u=i.TriEdges.getItem(o+1),c=ht.GetOrCreateEdge(s,a);return t.Sites.setItem(n+1,a),t.TriEdges.setItem(n,u),t.TriEdges.setItem(n+1,c),i.Sites.setItem(o+1,s),i.TriEdges.setItem(o,l),i.TriEdges.setItem(o+1,c),u.lowerSite===a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite===s?l.CcwTriangle=i:l.CwTriangle=i,c.upperSite===s?(c.CcwTriangle=i,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=i),T0(e.upperSite.Edges,e),c}var ht=class extends ye{constructor(e,t,i){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new bt;this.cdtTree=null;this.isolatedSites=e,this.obstacles=t,this.isolatedSegments=i}static constructor_(e){let t=new ht(null,null,null);return t.isolatedSitesWithObject=e,t}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let e of this.isolatedSitesWithObject)this.AddSite(e[0],e[1]);if(this.isolatedSites!=null)for(let e of this.isolatedSites)this.AddSite(e,null);if(this.obstacles!=null)for(let e of this.obstacles)this.AddPolylineToAllInputSites(e);if(this.isolatedSegments!=null)for(let e of this.isolatedSegments)this.AddConstrainedEdge(e.A,e.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(e,t){let i;return(i=this.PointsToSites.get(e))?i.Owner=t:(i=Yl.mkSO(e,t),this.PointsToSites.set(e,i)),i}AddP1AndP2(){let e=W.mkEmpty();for(let n of this.PointsToSites.keys())e.add(n);let t=Math.max(e.width/3,1),i=Math.max(e.height/3,1);this.P1=new Yl(e.leftBottom.add(new m(-t,-i))),this.P2=new Yl(e.rightBottom.add(new m(t,-i)))}AddPolylineToAllInputSites(e){for(let t=e.startPoint;t.next!=null;t=t.next)this.AddConstrainedEdge(t.point,t.next.point,e);e.closed&&this.AddConstrainedEdge(e.endPoint.point,e.startPoint.point,e)}AddConstrainedEdge(e,t,i){let n=ht.AbovePP(e,t),o,a;n>0?(o=this.AddSite(e,i),a=this.AddSite(t,i)):(o=this.AddSite(t,i),a=this.AddSite(e,i));let l=ht.CreateEdgeOnOrderedCouple(o,a);l.Constrained=!0}static GetOrCreateEdge(e,t){if(ht.AboveCC(e,t)===1){let i=e.EdgeBetweenUpperSiteAndLowerSite(t);return i!=null?i:ht.CreateEdgeOnOrderedCouple(e,t)}else{let i=t.EdgeBetweenUpperSiteAndLowerSite(e);return i!=null?i:ht.CreateEdgeOnOrderedCouple(t,e)}}static CreateEdgeOnOrderedCouple(e,t){return new C0(e,t)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new nr(this.allInputSites,this.P1,this.P2,ht.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(ht.OnComparison)}static OnComparison(e,t){return ht.AboveCC(e,t)}static AbovePP(e,t){let i=e.y-t.y;return i>0?1:i<0?-1:(i=e.x-t.x,i>0?-1:i<0?1:0)}static AboveCC(e,t){return ht.AbovePP(e.point,t.point)}RestoreEdgeCapacities(){for(let e of this.allInputSites)for(let t of e.Edges)t.Constrained||(t.ResidualCapacity=t.Capacity)}SetInEdges(){for(let e of this.PointsToSites.values())for(let t of e.Edges)t.lowerSite.AddInEdge(t)}FindSite(e){return this.PointsToSites.get(e)}static PointIsInsideOfTriangle(e,t){for(let i=0;i<3;i++){let n=t.Sites.getItem(i).point,o=t.Sites.getItem(i+1).point;if(m.signedDoubledTriangleArea(e,n,o)<A.distanceEpsilon*-1)return!1}return!0}GetCdtTree(){return this.cdtTree==null&&(this.cdtTree=rt(Array.from(this.GetTriangles().values()).map(e=>gt(e,e.BoundingBox())))),this.cdtTree}EdgeIsCorrect(e){let t=e.upperSite,i=!1;for(let o of t.Edges)if(o===e){i=!0;break}return i?this.PointsToSites.get(t.point)===t:!1}};var Kl=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,i=this.clone();return i.add_d(t.start),i.add_d(t.end),i}clone(){return new Kl(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new Kl(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let i=new Kl(e.start,e.end);return i.add_d(t.start),i.add_d(t.end),i}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+A.distanceEpsilon?!1:!(e.end<this.start-A.distanceEpsilon)}};var kd=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let i=this.heapSize;for(this._priors[e]=t,this.PutAtI(i,e);i>1&&this._priors[this._heap[i>>1]]>t;)this.SwapWithParent(i),i>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize===0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this._priors[this._heap[n]]<this._priors[this._heap[t]]&&(i=n);let o=n+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[i]]&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}}return this.heapSize--,e}IsEmpty(){return this.heapSize===0}DecreasePriority(e,t){this._priors[e]=t;let i=this._reverse_heap[e];for(;i>1&&this._priors[this._heap[i]]<this._priors[this._heap[i>>1]];){this.SwapWithParent(i);i>>=1}}};var I0=class{constructor(e,t,i,n){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=i,this._forLayers=n,this._q=new kd(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=Oo([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let i of this._intervalTree.GetAllIntersecting(t)){let n=yi.GetIdealEdge(e,i,this._nodePositions[e],this._nodePositions[i],this._nodeSizes);if(n.overlapFactor<=1)return;this._proximityEdges.push(n),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,i=this._nodePositions[e].x;return new Kl(i-t,i+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,i=this._nodePositions[e].y;this._q.Enqueue(e,i-t),this._q.Enqueue(this._nodeSizes.length+e,i+t)}}};var Lg=class{constructor(e,t,i){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=i,this.q=new kd(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),i=this.hedgehog.get(t);this.treeNodes.add(t),e.push(i),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let i=t.target;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let i=t.source;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var zd=class{static GetMst(e,t){if(e.length===0)return null;let i=e.map(u=>new Se(u.source,u.target)),n=i.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new Un(n+1);for(let u=0;u<e.length;u++)o.setPair(i[u],e[u]);let a=Sr(i,t);return new Lg(a,u=>o.get(u.source,u.target).weight,i[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let i=Array.from(e.PointsToSites.values()),n=new Map;for(let u=0;u<i.length;u++)n.set(i[u],u);let o=zd.GetEdges(i,n),a=Fp(Array.from(o.keys()));return new Lg(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let i=new Un(e.length);for(let n=0;n<e.length;n++){let o=e[n],a=t.get(o);for(let l of o.Edges)i.set(a,t.get(l.lowerSite),l)}return i}};var Ud=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new Ud;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var yi=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let i=new Ud;i.RandomizeAllPointsOnStart=!0,i.NodeSeparation=t,new yi(i,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(EN(this._settings,this._nodes,e),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!==1&&this._nodes.length===2){let e=this._nodes[0],t=this._nodes[1];m.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new m(.001,0)));let i=this.GetIdealDistanceBetweenTwoNodes(e,t),n=m.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(i/a)),e.center=n.add(o),t.center=n.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let i=e.center.sub(t.center),n=Math.abs(i.x),o=Math.abs(i.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return n>A.tolerance&&(u=a/n),o>A.tolerance&&(c=l/o),Math.min(u,c)*i.length}static AvgEdgeLength(e){let t=0,i=0;for(let n of e)for(let o of n.outEdges())i+=n.center.sub(o.target.center).length,t++;return t>0?i/t:1}OneIteration(e,t,i){let n=new Array;for(let h=0;h<e.length;h++)n.push([e[h],h]);let o=ht.constructor_(n);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let f=d.upperSite.point,p=d.lowerSite.point,S=a.get(d.upperSite),x=a.get(d.lowerSite),T=yi.GetIdealEdge(S,x,f,p,t);u.push(T),T.overlapFactor>1&&l++}if(l===0||i){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l===0&&h===0||l===0&&!i)return!1}let c=zd.GetMst(u,e.length);return yi.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,i){return new I0(e,t,i,this._overlapForLayers).Run()}static GetIdealEdge(e,t,i,n,o){let a={overlapFactor:0},l=yi.GetIdealEdgeLength(e,t,i,n,o,a),u=i.sub(n).length,c=W.mkSizeCenter(o[e],i),h=W.mkSizeCenter(o[t],n),d=a.overlapFactor>1?u-l:yi.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,i,n,o,a){let l=i.sub(n),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,f=(o[e].height+o[t].height)/2;if(c>=d||h>=f)return a.overlapFactor=1,l.length;let p,S=1e-10;if(c>S)h>S?p=Math.min(d/c,f/h):p=d/c;else if(h>S)p=f/h;else return a.overlapFactor=2,Math.sqrt(d*d+f*f)/4;return p=Math.max(p,1.001),a.overlapFactor=p,p*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let i=0,n=0;return(e.right<t.left||t.right<e.left)&&(n=e.left-t.right),e.top<t.bottom?i=t.bottom-e.top:t.top<e.bottom&&(i=e.bottom-t.top),Math.sqrt(n*n+i*i)}static MoveNodePositions(e,t,i){let n=t.map(a=>a.clone()),o=new Set;o.add(i);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?yi.MoveNode(l.source,l.target,n,t,o,l.idealDistance):yi.MoveNode(l.target,l.source,n,t,o,l.idealDistance)}}static MoveNode(e,t,i,n,o,a){let l=i[t].sub(i[e]);l=l.mul(a/l.length+.01),n[t]=n[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function EN(s,e,t){t.nodePositions=e.map(i=>i.center),t.nodeSizes=e.map(i=>{let n=i.boundingBox.size;return n.width+=s.NodeSeparation,n.height+=s.NodeSeparation,n})}var xa=class extends ye{constructor(e,t,i,n){super(i);this.settings=e,this.graph=t,this.length=n}run(){this.LayoutConnectedGraphWithMds(),this.graph.pumpTheBoxToTheGraphWithMargins()}static ScaleToAverageEdgeLength(e,t,i,n){let o=new Map,a=0;for(let c of e.shallowNodes)o.set(c,a),a++;let l=0,u=0;for(let c of e.edges()){let h=o.get(c.source),d=o.get(c.target);u+=Math.sqrt(Math.pow(t[h]-t[d],2)+Math.pow(i[h]-i[d],2)),l+=n(c)}if(l>0&&(u/=l),u>0)for(let c=0;c<t.length;c++)t[c]/=u,i[c]/=u}static LayoutGraphWithMds(e,t,i,n){if(i.x=new Array(e.shallowNodeCount),i.y=new Array(e.shallowNodeCount),i.x.length===0)return;if(i.x.length===1){i.x[0]=i.y[0]=0;return}let o=Math.min(t.PivotNumber,e.shallowNodeCount),a=t.GetNumberOfIterationsWithMajorization(e.shallowNodeCount),l=t.Exponent,u=new Array(o),c=new E0(e,u,n);c.run();let h=c.Result;if(ct.LandmarkClassicalScaling(h,i,u),xa.ScaleToAverageEdgeLength(e,i.x,i.y,n),a>0){let d=new Gd(e,n);d.run();let f=d.Result,p=ct.ExponentialWeightMatrix(f,l);ct.DistanceScalingSubset(f,i.x,i.y,p,a)}}LayoutConnectedGraphWithMds(){let e={x:[],y:[]};xa.LayoutGraphWithMds(this.graph,this.settings,e,this.length),this.settings.RotationAngle!==0&&x0.Rotate(e.x,e.y,this.settings.RotationAngle);let t=0;for(let i of this.graph.shallowNodes)i.boundingBox&&(i.center=new m(e.x[t]*this.settings.ScaleX,e.y[t]*this.settings.ScaleY)),t++;this.settings.removeOverlaps&&yi.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins()}ScaleNodes(e,t){for(let i of e)i.center=i.center.mul(t)}static PackGraphs(e,t){if(e.length===0)return W.mkEmpty();if(e.length===1)return e[0].boundingBox;let i=e.map(a=>a.boundingBox),n=new Array;for(let a of e)n.push({g:a,lb:a.boundingBox.leftBottom.clone()});let o=new gd(i,t.PackingAspectRatio);o.run();for(let{g:a,lb:l}of n){let u=a.boundingBox.leftBottom.sub(l);a.translate(u)}return new W({left:0,bottom:0,right:o.PackedWidth,top:o.PackedHeight})}};var Si=class{constructor(){this.layoutSettings=new qn;this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this._removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=3e3;this.adjustScale=!1}static fromJSON(e){let t=new Si;return e.pivotNumber&&(t.pivotNumber=e.pivotNumber),e.iterationsWithMajorization&&(t.iterationsWithMajorization=e.iterationsWithMajorization),e.scaleX&&(t.scaleX=e.scaleX),e.scaleY&&(t.scaleY=e.scaleY),e.exponent&&(t.exponent=e.exponent),e.rotationAngle&&(t.rotationAngle=e.rotationAngle),e.removeOverlaps!=null&&(t._removeOverlaps=e.removeOverlaps),e._callIterationsWithMajorizationThreshold&&(t._callIterationsWithMajorizationThreshold=e._callIterationsWithMajorizationThreshold),t}toJSON(){let e={};return this.pivotNumber!=50&&(e.pivotNumber=this.pivotNumber),this.iterationsWithMajorization!=30&&(e.iterationsWithMajorization=this.iterationsWithMajorization),this.scaleX!=200&&(e.scaleX=this.scaleX),this.scaleY!=200&&(e.scaleY=this.scaleY),this.exponent!=-2&&(e.exponent=this.exponent),this.rotationAngle!=0&&(e.rotationAngle=this.rotationAngle),this._removeOverlaps||(e.removeOverlaps=this._removeOverlaps),this._callIterationsWithMajorizationThreshold!=3e3&&(e._callIterationsWithMajorizationThreshold=this._callIterationsWithMajorizationThreshold),e}get NodeSeparation(){return this.layoutSettings.NodeSeparation}set NodeSeparation(e){this.layoutSettings.NodeSeparation=e}get edgeRoutingSettings(){return this.layoutSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.layoutSettings.edgeRoutingSettings=e}get removeOverlaps(){return this._removeOverlaps}set removeOverlaps(e){this._removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var Wd=class extends ye{get scaleX(){return this.settings.ScaleX}set scaleX(e){this.settings.ScaleX=e}get scaleY(){return this.settings.ScaleY}set scaleY(e){this.settings.ScaleY=e}constructor(e,t,i,n){super(t);this.graph=e,this.length=i,this.settings=n,this.settings.ScaleX=this.settings.ScaleY=200}run(){new xa(this.settings,this.graph,this.cancelToken,this.length).run()}};var zA=me(Zd());var UA=(n=>(n[n.OverlapsOtherLabels=0]="OverlapsOtherLabels",n[n.OverlapsNodes=1]="OverlapsNodes",n[n.OverlapsEdges=2]="OverlapsEdges",n[n.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",n))(UA||{});var WA=class{},HA=class{constructor(){this.points=new zA.LinkedList;this.coveredLength=0}AddFirst(e){if(this.points.size!==0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!==0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var z0=class{constructor(e){this.location=e,this.boundingBox=W.rectangleOnPoint(e)}},Mc=class{constructor(e,t){this.data=t,this.boundingBox=e}},jA=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},Ye=class extends ye{constructor(e,t){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=Ye.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(t.length):Ye.MinGranularity,this.InitializeObstacles(e,t),this.edges=t}get CollisionGranularity(){return this.granularity}set CollisionGranularity(e){this.granularity=e}static constructorG(e){return new Ye(Array.from(e.deepNodesIt()),Array.from(e.deepEdges).filter(t=>t.label))}static constructorGA(e,t){return new Ye(Array.from(e.deepNodesIt()),t.filter(i=>i.label))}interpolateGranularity(e){if(e<=Ye.LowerEdgeBound)return Ye.MaxGranularity;if(e>=Ye.UpperEdgeBound)return Ye.MinGranularity;let t=(Ye.UpperEdgeBound-Ye.LowerEdgeBound)/(e-Ye.LowerEdgeBound);return Math.ceil(Ye.MinGranularity+t)}InitializeObstacles(e,t){let i=this.GetEdgeObstacles(t);this.obstacleMaps[1]=Oo(e.map(n=>[n.boundingBox,new Mc(n.boundingBox,n)])),this.obstacleMaps[2]=Oo(i.map(n=>[n.boundingBox,new Mc(n.boundingBox,n)]))}static CurvePoints(e,t){let i=[],n=e.end.sub(e.start).lengthSquared/(t*t);return Ye.SubdivideCurveSegment(i,e,n,e.parStart,e.parEnd),i.sort(Ye.compareByArgument),i}static compareByArgument(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}static SubdivideCurveSegment(e,t,i,n,o){if(e.length>64)return;let a=t.value(n),l=t.value(o);if(a.sub(l).lengthSquared>i){let u=(n+o)/2;Ye.SubdivideCurveSegment(e,t,i,n,u),Ye.SubdivideCurveSegment(e,t,i,u,o)}else e.push([n,a])}static PlaceLabelsAtDefaultPositions(e,t){for(let i of t)i.label&&new Ye([i.source,i.target],[i]).run()}GetEdgeObstacles(e){let t=[];for(let i of e){if(i.curve==null)continue;let n=Ye.CurvePoints(i.curve,this.CollisionGranularity);this.edgeInfos.set(i,new jA(n));for(let o of n)t.push(new z0(o[1]))}return t}AddLabelObstacle(e){this.labelObstacleMap==null?(this.labelObstacleMap=Oo([[e.boundingBox,e]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(e.boundingBox,e)}run(){this.edges.sort((e,t)=>this.edgeInfos.get(e).edgePoints.length-this.edgeInfos.get(t).edgePoints.length);for(let e of this.edges)this.PlaceLabel(e)}PlaceLabel(e){let t=!1;for(let i of this.placementStrategy){switch(i){case 0:t=this.PlaceEdgeLabelOnCurve(e.label);break;case 1:t=this.PlaceEdgeLabelHorizontally(e);break;default:throw new Error("unexpected case")}if(t)break}t?this.CalculateCenterLabelInfoCenter(e.label):this.PlaceLabelAtFirstPosition(e.label)}getLabelInfo(e){let t=e.parent;return this.edgeInfos.get(t)}PlaceLabelAtFirstPosition(e){let t=e.parent,i=t.curve,n=this.edgeInfos.get(t).edgePoints,o=this.StartIndex(e,n.map(f=>f[1])),a=n[o][1],l=i.derivative(n[o][0]);l.length<A.distanceEpsilon&&(l=new m(1,1)),l=l.normalize();let u=new Pr(e.width,e.height),c=this.getLabelInfo(e),h=Ye.GetPossibleSides(c.placementSide,l)[0],d=Ye.GetLabelBounds(a,l,u,h);this.SetLabelBounds(this.getLabelInfo(e),d)}StartIndex(e,t){let i=this.getLabelInfo(e);return Math.min(t.length-1,Math.max(0,Math.floor(t.length*i.placementOffset)))}CalculateCenterLabelInfoCenter(e){let t=this.getLabelInfo(e),i=new m(0,0);for(let n of t.innerPoints)i=i.add(n);for(let n of t.outerPoints)i=i.add(n);e.positionCenter(i.div(t.innerPoints.length+t.outerPoints.length))}PlaceEdgeLabelHorizontally(e){let t=e.label,n=this.getLabelInfo(t).edgePoints,o=new Pr(t.width,t.height),a=-1,l=W.mkEmpty(),u=e.curve;for(let c of Ye.ExpandingSearch(this.StartIndex(t,n.map(h=>h[1])),0,n.length)){let h=n[c],d=u.derivative(h[0]);if(!le(d.lengthSquared,0)){d=d.normalize();for(let f of Ye.GetPossibleSides(this.getLabelInfo(t).placementSide,d)){let p=Ye.GetLabelBounds(h[1],d,o,f),S=this.ConflictIndexRL(p,t);if(S>a&&(a=S,l=p,a===Number.MAX_VALUE))break}if(a===Number.MAX_VALUE)break}}if(a>=0){this.SetLabelBounds(this.getLabelInfo(t),l);let c=new Mc(l,null);this.AddLabelObstacle(c);let h=this.getLabelInfo(t);return a===0?h.placementResult=0:a===1?h.placementResult=1:a===2?h.placementResult=2:h.placementResult=UA.OverlapsNothing,!0}return!1}static GetLabelBounds(e,t,i,n){let o=t.rotate(Math.PI/2).mul(n),a=e.add(o),l=1,u=o.x>0?a.x:a.x-i.width,c=o.y>0?a.y:a.y-i.height;if(Math.abs(o.x)<.75){let h=Math.acos(Math.abs(o.y)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?-1:1)*Math.min(d,i.width/2),c+=(o.y>0?1:-1)*f}else if(Math.abs(o.y)<.75){let h=Math.acos(Math.abs(o.x)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?1:-1)*f,c+=(o.y>0?-1:1)*Math.min(d,i.height/2)}return W.mkLeftBottomSize(u,c,i)}SetLabelBounds(e,t){e.innerPoints=[t.leftTop,t.rightTop],e.outerPoints=[t.leftBottom,t.rightBottom]}static GetPossibleSides(e,t){switch(t.length===0&&(e=0),e){case 1:return[-1];case 2:return[1];case 3:return le(t.x,0)?Ye.GetPossibleSides(5,t):[1];case 4:return le(t.x,0)?Ye.GetPossibleSides(6,t):[t.x<0?-1:1];case 5:return le(t.y,0)?Ye.GetPossibleSides(3,t):[t.y<0?-1:1];case 6:return le(t.y,0)?Ye.GetPossibleSides(4,t):[t.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(e,t,i){let n=e+1,o=n;for(;o>t;)yield--o;for(;n<i;)yield n++}static PointSetLength(e){let t=0,i=null;for(let n of e)i!=null&&(t+=i.sub(n.Center).length),i=n.Center;return t}PlaceEdgeLabelOnCurve(e){let t=e.parent,i=this.getLabelInfo(e);i.innerPoints=null;let n=i.edgePoints,o=3,a=e.height/2,l=new Pr(a,a),u=e.width;for(let c of Ye.ExpandingSearch(this.StartIndex(e,n),0,n.length)){let h=this.GetSidesAndEdgeCurve(e,t,n,c);for(let d of h){let f=new HA,p={coveredLength:0};if(this.ProcessExpandingSearchOnSide(c,n,t.curve,d,a,o,l,p,f,u),p.coveredLength>=u)return this.CaseOfCoveredLengthGreaterThanLabelLength(e,f,p.coveredLength,u,l),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(e,t,i,n,o){let a=new Array,l=new Array,u=Array.from(t.points),c=i-n;if(c>0){let d=u[u.length-1],f=u[u.length-2],p=d.Center.sub(f.Center),S=p.length;c>S&&(d=u[0],f=u[1],p=d.Center.sub(f.Center),S=p.length);let x=p.mul((S-c)/S);d.Center=f.Center.add(x),d.Inner=f.Inner.add(x),d.Outer=f.Outer.add(x)}this.GoOverOrderedPointsAndAddLabelObstacels(u,a,l,o);let h=this.getLabelInfo(e);h.innerPoints=a,h.outerPoints=l}GoOverOrderedPointsAndAddLabelObstacels(e,t,i,n){for(let o of e){let a=o.Center;t.push(o.Inner),i.push(o.Outer);let l=new Mc(W.mkSizeCenter(new Pr(n.width*2,n.height*2),a),null);this.AddLabelObstacle(l)}}ProcessExpandingSearchOnSide(e,t,i,n,o,a,l,u,c,h){for(let d of Ye.ExpandingSearch(e,0,t.length)){let[f,p]=t[d],S=i.derivative(f);if(le(S.lengthSquared,0))continue;let x=S.rotate(Math.PI/2).normalize().mul(n),T=p.add(x.mul(o+a));if(this.Conflict(T,o,l))break;{let O=new WA;if(O.Center=T,O.Inner=p.add(x.mul(a)),O.Outer=p.add(x.mul(2*o+a)),u.coveredLength=d<=e?c.AddFirst(O):c.AddLast(O),u.coveredLength>=h)break}}}GetSidesAndEdgeCurve(e,t,i,n){let o=t.curve.derivative(i[n][0]);return Ye.GetPossibleSides(this.getLabelInfo(e).placementSide,o)}Conflict(e,t,i){return this.ConflictIndex(e,t,i)!==Number.MAX_VALUE}ConflictIndexRL(e,t){let i=t.parent,n=i.source,o=i.target;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l of this.obstacleMaps[a].GetAllIntersecting(e))if(!(a===1&&l instanceof Mc&&l.data instanceof Ie!=null&&(n.node.isDescendantOf(l.data.graph)||o.node.isDescendantOf(l.data))))return a}return Number.MAX_VALUE}ConflictIndex(e,t,i){let n=W.creatRectangleWithSize(new Pr(i.width*2,i.height*2),e),o=t*t;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null)for(let u of this.obstacleMaps[l].GetAllIntersecting(n))if(u instanceof z0){if(e.sub(u.location).lengthSquared<o)return l}else return l;return Number.MAX_VALUE}}},Jl=Ye;Jl.MinGranularity=5,Jl.MaxGranularity=50,Jl.LowerEdgeBound=500,Jl.UpperEdgeBound=3e3;var gn=class extends gl{constructor(e,t=null){super(e,Ht.AlgorithmDataIndex);this.data=t}static getAlgData(e){return e.getAttr(Ht.AlgorithmDataIndex)}};function Qd(s){let e=gn.getAlgData(s.node);return e==null?null:e.data}var U0=class{constructor(e,t){this.force=new m(0,0);this.stayWeight=1;this.index=e,this.geomNode=t,this.ResetBounds()}get Center(){return this.center}set Center(e){this.geomNode.center=e,this.center=e}ResetBounds(){this.previousCenter=this.geomNode.center,this.center=this.geomNode.center,this.Width=this.geomNode.width,this.Height=this.geomNode.height}ToString(){return"FINode("+(this.index+("):"+this.geomNode))}};var W0=class{constructor(e){this._length=1;this.mEdge=e,this.sourceFiNode=Qd(this.mEdge.source),this.targetFiNode=Qd(this.mEdge.target)}get source(){return this.sourceFiNode.index}get target(){return this.targetFiNode.index}get length(){return this._length}set length(e){this._length=e}vector(){return this.sourceFiNode.geomNode.center.sub(this.targetFiNode.geomNode.center)}};var Ke=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var KA=me(gs());var qA=me(Zd());var mn=class{get Center(){return this.c}get Radius(){return this.r}Distance2(e){let t=this.c.y-e.y,i=this.c.x-e.x;return i*i+t*t}Contains(e){return this.Distance2(e)-1e-7<=this.r2}ContainsPN(e,t){for(let i=0;i<e.length;i++)if(t.findIndex(n=>n==i)==-1&&!this.Contains(e[i]))return!1;return!0}static constructorP(e){let t=new mn;return t.c=e,t.r=0,t.r2=0,t}static midPoint(e,t){return new m((t.x+e.x)/2,(t.y+e.y)/2)}static constructorPP(e,t){let i=new mn;return i.c=mn.midPoint(e,t),i.r2=i.Distance2(e),i.r=Math.sqrt(i.r2),Ke.assert(i.OnBoundary(e)),Ke.assert(i.OnBoundary(t)),i}OnBoundary(e){let t=this.Distance2(e);return Math.abs(t-this.r2)/(t+this.r2)<1e-5}static centre(e,t,i){Ke.assert(t.x!=e.x),Ke.assert(i.x!=t.x);let n=(t.y-e.y)/(t.x-e.x),o=(i.y-t.y)/(i.x-t.x);Ke.assert(o!=n);let a,l=(n*o*(e.y-i.y)+o*(e.x+t.x)-n*(t.x+i.x))/(2*(o-n));return Math.abs(n)>Math.abs(o)?a=(e.y+t.y)/2-(l-(e.x+t.x)/2)/n:a=(t.y+i.y)/2-(l-(t.x+i.x)/2)/o,new m(l,a)}static Collinear(e,t,i){return e.x*(t.y-i.y)+(t.x*(i.y-e.y)+i.x*(e.y-t.y))==0}static constructorPPP(e,t,i){mn.count++;let n=new mn;if(mn.Collinear(e,t,i)){let o=new m(Math.min(e.x,Math.min(t.x,i.x)),Math.min(e.y,Math.max(t.y,i.y))),a=new m(Math.max(e.x,Math.max(t.x,i.x)),Math.max(e.y,Math.max(t.y,i.y)));n.c=mn.midPoint(o,a),n.r2=n.Distance2(a),n.r=Math.sqrt(n.r2)}else{let o=t.x-e.x,a=i.x-t.x,l=i.x-e.x;o!=0?a!=0?n.c=mn.centre(e,t,i):(Ke.assert(l!=0),n.c=mn.centre(t,e,i)):(Ke.assert(a!=0),n.c=mn.centre(t,i,e)),n.r2=n.Distance2(e),n.r=Math.sqrt(n.r2),Ke.assert(n.OnBoundary(e)),Ke.assert(n.OnBoundary(t)),Ke.assert(n.OnBoundary(i))}return n}},Uo=mn;Uo.count=0;var XA=class{constructor(e,t){switch(this.boundary=t,Ke.assert(t.length<=3),t.length){case 0:this.disc=null;break;case 1:this.disc=Uo.constructorP(e[t[0]]);break;case 2:this.disc=Uo.constructorPP(e[t[0]],e[t[1]]);break;case 3:this.disc=Uo.constructorPPP(e[t[0]],e[t[1]],e[t[2]]);break}}contains(e){return this.disc==null?!1:this.disc.Contains(e)}},YA=class{constructor(e){this.ps=e,this.L=new qA.LinkedList;for(let i=0;i<this.ps.length;i++)this.L.push(i);let t=this.mtf_md(null,new Array);this.disc=t.disc,this.boundary=t.boundary}collinear3(e){return e.length==3?Uo.Collinear(this.ps[e[0]],this.ps[e[1]],this.ps[e[2]]):!1}mtf_md(e,t){Ke.assert(t.length<=3);let i=new XA(this.ps,t);if(t.length==3)return i;let n=this.L.first;for(;n!=null&&n!=e;){let o=n.next,a=n.value;if(!i.contains(this.ps[a])){let l=Array.from(t);l.push(a),Ke.assert(!this.collinear3(l),"Collinear points on boundary of minimal enclosing disc"),i=this.mtf_md(n,l),this.L.deleteNode(n),this.L.insertNodeBefore(null,n)}n=o}return i}},H0=class{static LinearComputation(e){return new YA(e).disc}static SlowComputation(e){let t=e.length,i=null,n=null;for(let o=0;o<t;o++)for(let a=0;a<t;a++){if(o!=a){let l=Uo.constructorPP(e[o],e[a]);l.ContainsPN(e,[o,a])&&(i==null||i.Radius>l.Radius)&&(i=l,n=[o,a])}for(let l=0;l<t;l++)if(l!=o&&l!=a&&!Uo.Collinear(e[o],e[a],e[l])){let u=Uo.constructorPPP(e[o],e[a],e[l]);u.ContainsPN(e,[o,a,l])&&(i==null||i.Radius>u.Radius)&&(i=u,n=[o,a,l])}}return Ke.assert(n!=null),i}};var Ci=class{static constructorNPA(e,t,i){let n=new Ci;n.p=e,n.z0=new Lt(t.x,t.y),n.a=new Array(e);for(let o=0;o<e;o++)n.a[o]=n.compute(o,i);return n}static constructorPMM(e,t,i){let n=new Ci;Ke.assert(t.p==i.p),n.p=t.p,n.z0=new Lt(e.x,e.y);let o=i.shift(n.z0),a=t.shift(n.z0);n.a=new Array(n.p);for(let l=0;l<n.p;l++)n.a[l]=j0(a[l],o[l]);return n}static factorial(e){let t=1;for(let i=2;i<=e;i++)t*=i;return t}static binomial(e,t){return Ci.factorial(e)/(Ci.factorial(t)*Ci.factorial(e-t))}sum(e,t){let i=Lt.constructorN(0);for(let n=1;n<=e;n++){let o=Lt.constructorN(Ci.binomial(e-1,n-1));i=j0(i,Ta(this.a[n],Ta(Lt.Pow(t,e-n),o)))}return i}shift(e){let t=new Array(this.p),i=t[0]=this.a[0],n=Jd(this.z0,e);for(let o=1;o<this.p;o++){let a=Lt.constructorN(o);t[o]=j0(Ta(YN(i),q0(Lt.Pow(n,o),a)),this.sum(o,n))}return t}compute(e,t){let i=t.length,n=Lt.constructorN(0);if(e==0)n.re=i;else{for(let o=0;o<i;o++){let a=t[o],l=new Lt(a.x,a.y);n=Jd(n,Lt.Pow(Jd(l,this.z0),e))}n.divideBy(e)}return n}ApproximateForce(e){let t=new Lt(e.x,e.y),i=Jd(t,this.z0),n=q0(this.a[0],i),o=i,a=0;for(;n=Jd(n,q0(XN(this.a[a],a),o)),a++,a!=this.p;)o=Ta(o,i);return new m(n.re,-n.im)}static Force(e,t){let i=t.sub(e),n=i.lengthSquared;return n<.1?n!=0?i.div(.1):new m(1,0):i.div(n)}},Lt=class{constructor(e,t){this.re=e,this.im=t}static constructorN(e){return new Lt(e,0)}divideBy(e){this.re/=e,this.im/=e}static Pow(e,t){switch(Ke.assert(t>=0),t){case 0:return Lt.constructorN(1);case 1:return e;case 2:return Ta(e,e);case 3:return Ta(e,Ta(e,e));default:return Ta(Lt.Pow(e,t/2),Lt.Pow(e,t/2+t%2))}}};function j0(s,e){return new Lt(s.re+e.re,s.im+e.im)}function Ta(s,e){return new Lt(s.re*e.re-s.im*e.im,s.re*e.im+e.re*s.im)}function XN(s,e){return new Lt(s.re*e,s.im*e)}function Jd(s,e){return new Lt(s.re-e.re,s.im-e.im)}function YN(s){return new Lt(-s.re,-s.im)}function q0(s,e){let t=e.re*e.re+e.im*e.im;if(t==0)return Lt.constructorN(0);let i=s.re*e.re+s.im*e.im,n=s.im*e.re-s.re*e.im;return new Lt(i/t,n/t)}var X0=class{intersects(e){return e.med.Center.sub(this.med.Center).length<e.med.Radius+this.med.Radius}},ZA=class extends X0{constructor(e,t,i){super();this.med=e,this.parent=t.parent,this.parent!=null&&(this.parent.leftChild==t?this.parent.leftChild=this:(Ke.assert(this.parent.rightChild==t),this.parent.rightChild=this)),this.leftChild=t,this.rightChild=i,t.parent=this,i.parent=this}computeMultipoleCoefficients(e){this.leftChild.computeMultipoleCoefficients(e),this.rightChild.computeMultipoleCoefficients(e),this.multipoleCoefficients=Ci.constructorPMM(this.med.Center,this.leftChild.multipoleCoefficients,this.rightChild.multipoleCoefficients)}},$d=class extends X0{constructor(e){super();Ke.assert(e[0].length==e[1].length),this.particles=e,this.ComputeMinimumEnclosingDisc()}computeMultipoleCoefficients(e){this.multipoleCoefficients=Ci.constructorNPA(e,this.med.Center,this.ps)}ComputeMinimumEnclosingDisc(){let e=this.Size();this.ps=new Array(e);for(let t=0;t<e;t++)this.ps[t]=this.particles[0][t].point;return this.med=H0.LinearComputation(this.ps)}Min(e){return this.particles[e][0].pos(e)}Size(){return this.particles[0].length}Max(e){return this.particles[e][this.Size()-1].pos(e)}Dimension(e){return this.Max(e)-this.Min(e)}Split(e){let t=this.Dimension(0)>this.Dimension(1)?0:1,i=t==0?1:0,n=this.Size(),o=n>>1,a=n-o,l=[new Array(o),new Array(o)],u=[new Array(a),new Array(a)],c=0,h=0;for(let f=0;f<n;f++){let p=this.particles[t][f];f<o?(l[t][f]=p,p.splitLeft=!0):(u[t][f-o]=p,p.splitLeft=!1)}for(let f=0;f<n;f++){let p=this.particles[i][f];p.splitLeft?l[i][h++]=p:u[i][c++]=p}Ke.assert(h==o),Ke.assert(c==a);let d=this.med;return this.particles=l,this.ComputeMinimumEnclosingDisc(),e.rightSibling=new $d(u),new ZA(d,this,e.rightSibling)}ComputeForces(){for(let e of this.particles[0])for(let t of this.particles[0])e!=t&&(e.force=e.force.add(Ci.Force(e.point,t.point)))}},Y0=class{pos(e){return e==0?this.point.x:this.point.y}constructor(e){this.point=e,this.force=new m(0,0)}},K0=class{particlesBy(e){return this.particles.map(t=>t).sort((t,i)=>t.pos(e)-i.pos(e))}constructor(e,t){this.particles=e;let i=new Array;i.push(this.particlesBy(0)),i.push(this.particlesBy(1)),this.leaves=new Array;let n=new $d(i);this.leaves.push(n);let o={rightSibling:null};this.root=n.Split(o),this.leaves.push(o.rightSibling);let a=new QA(t);for(a.EnqueueLL(n,o.rightSibling);a.length>0;)n=a.dequeue(),n.Split(o),this.leaves.push(o.rightSibling),a.EnqueueLL(n,o.rightSibling)}ComputeForces(e){this.root.computeMultipoleCoefficients(e);for(let t of this.leaves){t.ComputeForces();let i=new Array;for(i.push(this.root);i.length>0;){let n=i.pop();if(t.intersects(n))if(n instanceof $d)for(let o of t.particles[0])for(let a of n.particles[0])o!=a&&(o.force=o.force.add(Ci.Force(o.point,a.point)));else{let o=n;i.push(o.leftChild),i.push(o.rightChild)}else for(let o of t.particles[0])o.force=o.force.sub(n.multipoleCoefficients.ApproximateForce(o.point))}}}},QA=class extends KA.Queue{constructor(e){super();this.B=e}EnqueueLL(e,t){e.Size()>this.B&&this.enqueue(e),t.Size()>this.B&&this.enqueue(t)}};var Ia=class extends ye{constructor(e,t,i){super(null);this.clustersInfo=new Map;this.clusterEdges=new Array;if(this.graph=e,this.settings=t,this.initFiNodesEdges(),this.edges=Array.from(this.graph.edges()).map(n=>gn.getAlgData(n.edge).data),this.nodes=Array.from(this.graph.shallowNodes).map(n=>gn.getAlgData(n.node).data),this.components=new Array,this.settings.InterComponentForces)this.components.push(this.nodes);else{this.basicGraph=Sr(this.edges,this.nodes.length);for(let n of Wn(this.basicGraph)){let o=new Array(n.length),a=0;for(let l of n)o[a++]=this.nodes[l];this.components.push(o)}}this.computeWeight(e),this.setCurrentConstraintLevel(i)}initFiNodesEdges(){let e=0;for(let t of this.graph.shallowNodes){let i=new U0(e++,t);new gn(t.node,i)}for(let t of this.graph.edges()){let i=new W0(t);new gn(t.edge,i)}}getCurrentConstraintLevel(){return this.currentConstraintLevel}setCurrentConstraintLevel(e){this.currentConstraintLevel=e,this.settings.Unconverge()}ResetNodePositions(){for(let e of this.nodes)e.ResetBounds()}AddRepulsiveForce(e,t){e.force=t.mul(10*this.settings.RepulsiveForceConstant)}AddLogSpringForces(e,t,i){let n=t.length,o=7e-4*this.settings.AttractiveForceConstant*n*Math.log((n+.1)/(i+.1));e.sourceFiNode.force=e.sourceFiNode.force.add(t.mul(o)),e.targetFiNode.force=e.targetFiNode.force.sub(t.mul(o))}AddSquaredSpringForces(e,t,i){let n=t.length,o=i*i+.1,a=this.settings.AttractiveForceConstant*(n-i)/o;e.sourceFiNode.force=e.sourceFiNode.force.add(t.mul(a)),e.targetFiNode.force=e.targetFiNode.force.sub(t.mul(a))}AddSpringForces(e){let t;if(this.settings.RespectEdgePorts){let i=e.sourceFiNode.Center,n=e.targetFiNode.Center,o=e.mEdge.sourcePort;o instanceof Zr&&(i=o.Location);let a=e.mEdge.targetPort;a instanceof Zr&&(n=a.Location),t=i.sub(n)}else t=e.vector();this.settings.LogScaleEdgeForces?this.AddLogSpringForces(e,t,e.length):this.AddSquaredSpringForces(e,t,e.length)}static AddGravityForce(e,t,i){i!=null&&(i.force=i.force.sub(e.sub(i.Center).mul(t*1e-4)))}ComputeRepulsiveForces(e){let t=e.length;if(t>16&&this.settings.ApproximateRepulsion){let i=new Array(e.length),n=2*(Math.PI/t),o=0;for(let l=0;l<t;l++)i[l]=new Y0(e[l].Center.add(new m(Math.cos(o),Math.sin(o)).mul(1e-5))),o+=n;new K0(i,8).ComputeForces(5);for(let l=0;l<e.length;l++)this.AddRepulsiveForce(e[l],i[l].force)}else for(let i of e){let n=new m(0,0);for(let o of e)i!=o&&(n=n.add(Ci.Force(i.Center,o.Center)));this.AddRepulsiveForce(i,n)}}SetBarycenter(e){let t=this.clustersInfo.get(e);if(t!=null)return t.barycenter;let i=new m(0,0);if(e.shallowNodeCount||KN(e)){let n=this.clustersInfo.get(e);if((n==null||n.weight==null)&&this.computeWeight(e),n.weight!=null){for(let o of e.shallowNodes)o instanceof ft?i=i.add(o.center):i=i.add(this.SetBarycenter(o).mul(this.clustersInfo.get(o).weight));this.clustersInfo.get(e).barycenter=i=i.div(n.weight)}}else this.clustersInfo.get(e).barycenter=i;return i}computeWeight(e){let t=0;for(let n of e.shallowNodes)n.entity instanceof Te?t+=this.computeWeight(n):t++;let i=this.clustersInfo.get(e);return i==null&&this.clustersInfo.set(e,i={barycenter:new m(0,0)}),i.weight=t,t}AddClusterForces(e){if(e!=null){this.SetBarycenter(e);for(let t of this.clusterEdges){let i=ke.getGeom(t.source),n=ke.getGeom(t.target),o=gn.getAlgData(t.source).data,a=gn.getAlgData(t.target).data,l=i.hasOwnProperty("shallowNodes"),u=l?this.clustersInfo.get(i).barycenter:i.center,c=n.hasOwnProperty("shallowNodes"),h=c?this.clustersInfo.get(n).barycenter:n.center,d=u.sub(h),f=d.length,p=1e-8*(this.settings.AttractiveInterClusterForceConstant*(f*Math.log(f+.1)));if(d=d.mul(p),l){let S=i;for(let x of S.shallowNodes){let T=gn.getAlgData(x.node).data;T.force=T.force.add(d)}}else o.force=o.force.add(d);if(c){let S=n;for(let x of S.shallowNodes){let T=gn.getAlgData(x.node).data;T.force=T.force.sub(d)}}else a.force=a.force.sub(d)}for(let t of e.subgraphsDepthFirst){let i=this.clustersInfo.get(t).barycenter;for(let n of t.shallowNodes)Ia.AddGravityForce(i,this.settings.ClusterGravity,Qd(n))}}}ComputeForces(){if(this.components!=null)for(let e of this.components)this.ComputeRepulsiveForces(e);else this.ComputeRepulsiveForces(this.nodes);this.edges.forEach(e=>this.AddSpringForces(e));for(let e of this.components){let t=new m(0,0);for(let n=0;n<e.length;n++)t=t.add(e[n].Center);t=t.div(e.length);let i=Number.NEGATIVE_INFINITY;for(let n=0;n<e.length;n++){let o=e[n];Ia.AddGravityForce(t,this.settings.GravityConstant,o),o.force.length>i&&(i=o.force.length)}if(i>100)for(let n=0;n<e.length;n++)e[n].force=e[n].force.mul(100/i)}this.AddClusterForces(this.graph)}VerletIntegration(){let e=this.energy;this.energy=this.ComputeDescentDirection(1),this.UpdateStepSize(e);let t=0;for(let i=0;i<this.nodes.length;i++){let n=this.nodes[i];t+=n.Center.sub(n.previousCenter).lengthSquared}return t}ComputeDescentDirection(e){this.ResetForceVectors(),this.settings.ApplyForces&&this.ComputeForces();let t=0;for(let i of this.nodes){t=t+i.force.lengthSquared;let n=i.Center.sub(i.previousCenter).mul(this.settings.Friction),o=i.force.mul(-this.stepSize*e);i.previousCenter=i.Center,Ke.assert(!Number.isNaN(o.x),"!double.IsNaN(a.X)"),Ke.assert(!Number.isNaN(o.y),"!double.IsNaN(a.Y)"),Ke.assert(Number.isFinite(o.x),"!double.IsInfinity(a.X)"),Ke.assert(Number.isFinite(o.y),"!double.IsInfinity(a.Y)"),n=n.add(o),n=n.div(i.stayWeight),i.Center=i.Center.add(n)}return t}ResetForceVectors(){for(let e of this.nodes)e.force=new m(0,0)}UpdateStepSize(e){this.energy<e?++this.progress>=3&&(this.progress=0,this.stepSize/=this.settings.Decay):(this.progress=0,this.stepSize*=this.settings.Decay)}RungeKuttaIntegration(){let e=new Array(this.nodes.length),t=new Array(this.nodes.length),i=new Array(this.nodes.length),n=new Array(this.nodes.length),o=new Array(this.nodes.length),a=this.energy;for(let u=0;u<this.nodes.length;u++)this.nodes[u].previousCenter=this.nodes[u].Center,e[u]=this.nodes[u].Center;let l=3;this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)t[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].Center=e[u].add(t[u].mul(.5));this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)i[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u],this.nodes[u].Center=e[u].add(i[u].mul(.5));this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)n[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u],this.nodes[u].Center=e[u].add(n[u]);this.energy=this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++){o[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u];let c=t[u].add(i[u].mul(2).add(n[u].mul(2)).add(o[u])).div(6);this.nodes[u].Center=e[u].add(c)}return this.UpdateStepSize(a),this.nodes.reduce((u,c)=>c.Center.sub(c.previousCenter).lengthSquared+u,0)}run(){this.settings.Converged=!1,this.settings.EdgeRoutesUpToDate=!1,this.settings.Iterations++==0&&(this.stepSize=this.settings.InitialStepSize,this.energy=Number.MAX_VALUE,this.progress=0);for(let e=0;e<this.settings.MinorIterations;e++){if((this.settings.RungeKuttaIntegration?this.RungeKuttaIntegration():this.VerletIntegration())<this.settings.DisplacementThreshold||this.settings.Iterations>this.settings.MaxIterations){this.settings.Converged=!0;break}this.ProgressStep()}}};function KN(s){for(let e of s.Clusters)return!0;return!1}var bn=class{constructor(){this.commonSettings=new qn;this.maxIterations=100;this.clusterMargin=10;this.minorIterations=3;this.projectionIterations=5;this.approximateRepulsion=!0;this.RungeKuttaIntegration=!1;this.initialStepSize=1.4;this.decay=.9;this.friction=.8;this.repulsiveForceConstant=1;this.attractiveForceConstant=1;this.gravity=1;this.interComponentForces=!0;this.applyForces=!0;this.AvoidOverlaps=!0;this.approximateRouting=!0;this.logScaleEdgeForces=!0;this.displacementThreshold=.1;this.maxConstraintLevel=2;this.minConstraintLevel=0;this.attractiveInterClusterForceConstant=1;this.clusterGravity=1;this.commonSettings.NodeSeparation*=2}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get PackingAspectRatio(){return this.commonSettings.PackingAspectRatio}set PackingAspectRatio(e){this.commonSettings.PackingAspectRatio=e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get MaxIterations(){return this.maxIterations}set MaxIterations(e){this.maxIterations=e}get MinorIterations(){return this.minorIterations}set MinorIterations(e){this.minorIterations=e}get Iterations(){return this.iterations}set Iterations(e){this.iterations=e}get ProjectionIterations(){return this.projectionIterations}set ProjectionIterations(e){this.projectionIterations=e}get ApproximateRepulsion(){return this.approximateRepulsion}set ApproximateRepulsion(e){this.approximateRepulsion=e}get InitialStepSize(){return this.initialStepSize}set InitialStepSize(e){if(e<=0||e>2)throw new Error("ForceScalar should be greater than 0 and less than 2 (if we let you set it to 0 nothing would happen, greater than 2 would most likely be very unstable!)");this.initialStepSize=e}get Decay(){return this.decay}set Decay(e){if(e<.1||e>1)throw new Error("Setting decay too small gives no progress.  1==no decay, 0.1==minimum allowed value");this.decay=e}get Friction(){return this.friction}set Friction(e){if(e<0||e>1)throw new Error("Setting friction less than 0 or greater than 1 would just be strange.  1==no friction, 0==no conservation of velocity");this.friction=e}get RepulsiveForceConstant(){return this.repulsiveForceConstant}set RepulsiveForceConstant(e){this.repulsiveForceConstant=e}get AttractiveForceConstant(){return this.attractiveForceConstant}set AttractiveForceConstant(e){this.attractiveForceConstant=e}get GravityConstant(){return this.gravity}set GravityConstant(e){this.gravity=e}get InterComponentForces(){return this.interComponentForces}set InterComponentForces(e){this.interComponentForces=e}get ApplyForces(){return this.applyForces}set ApplyForces(e){this.applyForces=e}ResetLayout(){this.Unconverge(),this.algorithm!=null&&this.algorithm.ResetNodePositions()}Unconverge(){this.iterations=0,this.converged=!1}InitializeLayoutGN(e,t){this.InitializeLayout(e,t)}InitializeLayout(e,t){this.algorithm=new Ia(e,this,t),this.ResetLayout()}Uninitialize(){this.algorithm=null}get IsInitialized(){return this.algorithm!=null}IncrementalRunG(e){this.IncrementalRunGF(e)}SetupIncrementalRun(e){this.IsInitialized?this.IsDone&&this.ResetLayout():this.InitializeLayout(e,this.MaxConstraintLevel)}IncrementalRunGF(e){this.SetupIncrementalRun(e),this.algorithm.run()}IncrementalRun(e,t){e!=null&&e.throwIfCanceled(),this.SetupIncrementalRun(t),this.algorithm.cancelToken=e,this.algorithm.run()}Clone(){return bn.ctorClone(this)}get ApproximateRouting(){return this.approximateRouting}set ApproximateRouting(e){this.approximateRouting=e}get LogScaleEdgeForces(){return this.logScaleEdgeForces}set LogScaleEdgeForces(e){this.logScaleEdgeForces=e}get DisplacementThreshold(){return this.displacementThreshold}set DisplacementThreshold(e){this.displacementThreshold=e}get Converged(){return this.converged}set Converged(e){this.converged=e}get PercentDone(){return this.Converged?100:100*this.iterations/this.MaxIterations}get IsDone(){return this.Converged||this.iterations>=this.MaxIterations}get Energy(){return this.algorithm!=null?this.algorithm.energy:0}get MaxConstraintLevel(){return this.maxConstraintLevel}set MaxConstraintLevel(e){this.maxConstraintLevel!=e&&(this.maxConstraintLevel=e,this.IsInitialized&&this.Uninitialize())}get MinConstraintLevel(){return this.minConstraintLevel}set MinConstraintLevel(e){this.minConstraintLevel=e}getCurrentConstraintLevel(){return this.algorithm==null?0:this.algorithm.getCurrentConstraintLevel()}setCurrentConstraintLevel(e){this.algorithm.setCurrentConstraintLevel(e)}get AttractiveInterClusterForceConstant(){return this.attractiveInterClusterForceConstant}set AttractiveInterClusterForceConstant(e){this.attractiveInterClusterForceConstant=e}static ctorClone(e){let t=new bn;return t.maxIterations=e.maxIterations,t.minorIterations=e.minorIterations,t.projectionIterations=e.projectionIterations,t.approximateRepulsion=e.approximateRepulsion,t.initialStepSize=e.initialStepSize,t.RungeKuttaIntegration=e.RungeKuttaIntegration,t.decay=e.decay,t.friction=e.friction,t.repulsiveForceConstant=e.repulsiveForceConstant,t.attractiveForceConstant=e.attractiveForceConstant,t.gravity=e.gravity,t.interComponentForces=e.interComponentForces,t.applyForces=e.applyForces,t.AvoidOverlaps=e.AvoidOverlaps,t.RespectEdgePorts=e.RespectEdgePorts,t.RouteEdges=e.RouteEdges,t.approximateRouting=e.approximateRouting,t.logScaleEdgeForces=e.logScaleEdgeForces,t.displacementThreshold=e.displacementThreshold,t.minConstraintLevel=e.minConstraintLevel,t.maxConstraintLevel=e.maxConstraintLevel,t.attractiveInterClusterForceConstant=e.attractiveInterClusterForceConstant,t.clusterGravity=e.clusterGravity,t.PackingAspectRatio=e.PackingAspectRatio,t.NodeSeparation=e.NodeSeparation,t.clusterMargin=e.clusterMargin,t}get ClusterGravity(){return this.clusterGravity}set ClusterGravity(e){this.clusterGravity=e}static CreateFastIncrementalLayoutSettings(){let e=new bn;return e.ApplyForces=!1,e.ApproximateRepulsion=!0,e.ApproximateRouting=!0,e.AttractiveForceConstant=1,e.AttractiveInterClusterForceConstant=1,e.AvoidOverlaps=!0,e.ClusterGravity=1,e.Decay=.9,e.DisplacementThreshold=5e-8,e.Friction=.8,e.GravityConstant=1,e.InitialStepSize=2,e.InterComponentForces=!1,e.Iterations=0,e.LogScaleEdgeForces=!1,e.MaxConstraintLevel=2,e.MaxIterations=20,e.MinConstraintLevel=0,e.MinorIterations=1,e.ProjectionIterations=5,e.RepulsiveForceConstant=2,e.RespectEdgePorts=!1,e.RouteEdges=!1,e.RungeKuttaIntegration=!0,e.NodeSeparation=20,e}};var Z0=class{constructor(e){this.topNodes=e}get deepNodes(){return this.deepNodes_()}*deepNodes_(){for(let e of this.topNodes)if(yield ft.getGeom(e),e instanceof Te)for(let t of e.deepNodes)yield ft.getGeom(t)}get Clusters(){return this.clusters()}*clusters(){for(let e of this.topNodes)e instanceof Te&&(yield Ie.getGeom(e))}get subgraphsDepthFirst(){return this.subgraphsDepthFirst_()}*subgraphsDepthFirst_(){for(let e of this.topNodes)if(e instanceof Te){let t=Ie.getGeom(e);yield*t.subgraphsDepthFirst,yield t}}*edges(){for(let e of this.topNodes){for(let t of e.outEdges)yield Xe.getGeom(t);for(let t of e.selfEdges)yield Xe.getGeom(t)}}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.topNodes)yield ft.getGeom(e)}pumpTheBoxToTheGraphWithMargins(){let e={b:W.mkEmpty()};return Sy(this,e),this.boundingBox=e.b}get shallowNodeCount(){return this.topNodes.length}translate(e){this.boundingBox&&(this.boundingBox.center=this.boundingBox.center.add(e));for(let t of this.topNodes)ft.getGeom(t).translate(e)}};var Gg=class{static LinearInterpolation(e,t,i,n,o){if(e<t)return n;if(e>i)return o;let a=(e-t)/(i-t);return n+a*(o-n)}static NegativeLinearInterpolation(e,t,i,n,o){if(e<t)return o;if(e>i)return n;let a=(e-t)/(i-t);return n+(1-a)*(o-n)}};var Q0=class extends ye{constructor(e,t){super(null);this.SingleComponent=!1;this.graph=e,this.settings=bn.ctorClone(t),this.settings.ApplyForces=!0,this.settings.InterComponentForces=!0,this.settings.RungeKuttaIntegration=!1,this.settings.RespectEdgePorts=!1}run(){if(this.SingleComponent)this.componentCount=1,this.LayoutComponent(this.graph);else{let e=Array.from(this.graph.graph.getClusteredConnectedComponents()).map(t=>new Z0(t));this.componentCount=e.length;for(let t of e)this.LayoutComponent(t);this.graph.boundingBox=xa.PackGraphs(e,this.settings.commonSettings)}}LayoutComponent(e){if(e.shallowNodeCount>1){if(this.settings.MaxIterations=Gg.NegativeLinearInterpolation(e.shallowNodeCount,50,500,5,10),this.settings.MinorIterations=Gg.NegativeLinearInterpolation(e.shallowNodeCount,50,500,3,20),this.settings.MinConstraintLevel==0){let i=new Si;i.removeOverlaps=!1,i.IterationsWithMajorization=0,new Wd(e,null,()=>1,new Si).run()}let t=new Ia(e,this.settings,this.settings.MinConstraintLevel);Ke.assert(this.settings.Iterations==0);for(let i of this.GetConstraintLevels(e)){if(i>this.settings.MaxConstraintLevel)break;i>this.settings.MinConstraintLevel&&t.setCurrentConstraintLevel(i);do t.run();while(!this.settings.IsDone)}this.settings.AvoidOverlaps&&yi.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation)}e.pumpTheBoxToTheGraphWithMargins(),e.uniformMargins=this.settings.NodeSeparation,e.translate(e.boundingBox.leftBottom.mul(-1))}GetConstraintLevels(e){let t=new Set;return t.add(0),this.settings.AvoidOverlaps&&e.shallowNodeCount<2e3&&t.add(2),t}};function JA(s){s.layoutSettings||(s.layoutSettings=$A(s))}function ZN(s){let e=s.parent;for(;e;){if(e.layoutSettings)return e.layoutSettings;e=e.parent}return null}function $A(s){let e=ZN(s);if(e)return e;if(s.graph.shallowNodeCount>2e3||s.graph.nodeCollection.edgeCount>4e3)return new Si;let i=!1;for(let n of s.edges())if(n.sourceArrowhead!=null||n.targetArrowhead!=null){i=!0;break}return i?new Lr:new Si}function QN(s,e){if(JA(s),s.layoutSettings instanceof Lr)new ef(s,s.layoutSettings,e).run();else if(s.layoutSettings instanceof Si)new Wd(s,e,()=>1,s.layoutSettings).run();else if(s.layoutSettings instanceof bn){let t=new Q0(s,s.layoutSettings);t.SingleComponent=!0,t.run()}}function J0(s,e=null){JA(s),Hd(s,e,QN,Zl,Dp)}function $0(s){do{if(s.layoutSettings&&s.layoutSettings.edgeRoutingSettings)return s.layoutSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=ke.getGeom(t);else break}while(!0);let e=new Ps;return e.EdgeRoutingMode=0,e}function Zl(s,e,t){let i=$0(s);i.EdgeRoutingMode===4?eT(s,e,t):i.EdgeRoutingMode===0||i.EdgeRoutingMode===1?rT(s,e,t):i.EdgeRoutingMode===2?iT(s,e,t):i.EdgeRoutingMode!==6&&new ut(s,e).run(),tT(s,e)}function Hd(s,e,t,i,n,o=!0,a=1){if(s.graph.isEmpty())return;s.parent==null&&(Yp(a),eB(s));let l=f();d(s);let u=JN(s.graph),c=$N(s);if(p(),u.forEach(S=>{S[0].edge.remove(),S[1].add()}),c.forEach(S=>{for(let x of S.graph.shallowNodes)x.parent=s.graph}),l.forEach(S=>S.add()),s.graph.parent==null){let S=h(s);i(s,S,e),tT(s,S),s.pumpTheBoxToTheGraphWithMargins(),o&&s.FlipYAndMoveLeftTopToOrigin()}function h(S){let x=[];for(let T of S.deepNodesIt()){for(let O of T.outEdges())O.curve==null&&x.push(O);for(let O of T.selfEdges())O.curve==null&&x.push(O)}return x}function d(S){for(let x of S.shallowNodes)x instanceof Ie&&Hd(x,e,t,i,n)}function f(){let S=new Set,x=s.graph;if(x.parent==null)return S;for(let T of x.shallowNodes){for(let O of T.outEdges){let M=x.liftNode(O.target);(M==null||M===T)&&S.add(O)}for(let O of T.inEdges){let M=x.liftNode(O.source);(M==null||M===T)&&S.add(O)}}for(let T of S)T.remove();return S}function p(){if(c.length===1)t(s,e);else{for(let S of c)t(S,e),S.boundingBox=S.pumpTheBoxToTheGraphWithMargins();n(s,c)}}}function JN(s){let e=new Array;for(let t of s.deepNodes){let i=s.liftNode(t);if(i!=null)for(let n of t.outEdges.values()){let o=n.target,a=s.liftNode(o);if(a==null||i===t&&a===o||i===a)continue;n.remove();let l=new ms(i,a),u=new Xe(l);e.push([u,n])}}return e}function $N(s){var o;let e=s.graph,t=UC(e),i=[],n=0;for(let a of t){let l=new Te(e.id+n++);l.parent=e;let u=new Ie(l);u.layoutSettings=(o=s.layoutSettings)!=null?o:$A(s);for(let c of a)c.parent=l,l.addNode(c);i.push(u)}return i}function eT(s,e,t,i=1,n=3){wc.constructorGNAN(s,e,i,n).run()}function tT(s,e){if(e.length===0)return;Jl.constructorGA(s,e).run()}function eB(s){for(let e of s.deepEdges)e.label&&(e.label.isPositioned=!1)}function Vg(s){if(Ie.getGeom(s)==null)return!1;for(let e of s.shallowNodes){let t=ke.getGeom(e);if(t==null||t.boundaryCurve==null||e instanceof Te&&Vg(e)===!1)return!1}for(let e of s.edges)if(Xe.getGeom(e)==null)return!1;return!0}var tf=class{static constructorStatic(e,t){let i=new tf;i.edges=e,i.nodeBoundaries=t,i.boundingBox=W.mkEmpty();for(let n of i.nodeBoundaries)i.boundingBox=i.boundingBox.addRec(n.boundingBox);return i}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=Yn(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var oT=me(un());var nT=me(Zd());var $l=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,i){this.currentTriangle=e,this.start=t,this.end=i}*Triangles(){for(;this.MoveNext();)yield this.CurrentTriangle}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!==t&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.TriEdges.item0;let i=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!==i&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=i,this.currentTriangle.TriEdges.item1):(this.positiveSign=i,this.negativeSign=e,this.currentTriangle.TriEdges.item2)}static PointLocationForTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<A.distanceEpsilon*-1)return 0;o<A.distanceEpsilon&&(i=!0)}return i?1:2}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.TriEdges.index(this.currentPiercedEdge),t,i=this.currentTriangle.Sites.getItem(e+2),n=this.GetHyperplaneSign(i);this.negativeSign===0?n===-1||n===0?(this.negativeSign=n,t=e+1):t=e+2:this.positiveSign===0?n===1||n===0?(this.positiveSign=n,t=e+2):t=e+1:n!==this.positiveSign?(this.negativeSign=n,t=e+1):(this.positiveSign=n,t=e+2),this.currentPiercedEdge=m.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-A.distanceEpsilon?this.currentTriangle.TriEdges.getItem(t):null}GetHyperplaneSign(e){let t=m.signedDoubledTriangleArea(this.start,e.point,this.end);return t>A.distanceEpsilon?1:t<A.distanceEpsilon*-1?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var rf=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,i,n){if(ht.PointIsInsideOfTriangle(t,i))return!0;let o=new $l(i,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.Constrained){let l=a.lowerSite.Owner;if(!n.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,i,n,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.CdtTriangle,n,i,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,i,n,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,i,n,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new nT.HashSet;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(n.has(d))continue;let f=rf.FindPolylinePoint(d,h.point),p=D.minDistBetweenLineSegments(f.point,f.nextOnPolyline.point,t,i),S=p.dist,x=p.parab,T=p.parcd,O=D.minDistBetweenLineSegments(f.point,f.prevOnPolyline.point,t,i),M=O.dist,R=O.parab,N=O.parcd,H,Q,ne;if(S<M){if(ne=S,ne>o)continue;H=f.point.add(f.nextOnPolyline.point.sub(f.point).mul(x)),Q=t.add(i.sub(t).mul(T))}else{if(ne=M,ne>o)continue;H=f.point.add(f.prevOnPolyline.point.sub(f.point).mul(R)),Q=t.add(i.sub(t).mul(N))}a.get(d)||a.set(d,[H,Q])}return a}ThreadLineSegmentThroughTriangles(e,t,i,n,o){if(ht.PointIsInsideOfTriangle(i,e))return o.push(e),!0;let a=new $l(e,t,i);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.Constrained){let u=l.lowerSite.Owner;if(!n.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<A.distanceEpsilon*-1)return 0;o<A.distanceEpsilon&&(i=!0)}return i?1:2}static FindPolylinePoint(e,t){for(let i of e.polylinePoints())if(i.point.equal(t))return i;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,i,n){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.CdtTriangle,i,n,a,o)}static closedeb(e,t){return e.Position.sub(new m(360.561,428.416)).length<.1&&t.Position.sub(new m(414.281,440.732)).length<.1}EdgeIsLegalSSPPS(e,t,i){let n=e.Position,o=e.CdtTriangle,a=t.Position;if(ht.PointIsInsideOfTriangle(a,o))return!0;let l=new $l(o,n,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.Constrained){let c=u.lowerSite.Owner;if(!i.has(c))return!1}}return!0}};var vi=class{constructor(e,t,i,n){this.metroGraphData=e,this.obstaclesToIgnoreLambda=n,this.bundlingSettings=t,this.obstacleTree=i}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?Yn(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,i,n){let o={minimalDistance:i};return vi.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,i){let n={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,i,n,o)}GetMinimalDistanceToObstacles(e,t,i){let n=new Array,o={minimalDistance:i};return vi.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,i,n,o){return n.touchedObstacles=new Array,o.minimalDistance=t,vi.IntersectCircleWithTree(this.obstacleTree,e,t,i,n.touchedObstacles,o)}static IntersectCircleWithTree(e,t,i,n,o,a){if(!e.irect.contains_point_radius(t,i))return!0;if(e.UserData==null){let l=vi.IntersectCircleWithTree(e.Left,t,i,n,o,a);if(!l||(l=vi.IntersectCircleWithTree(e.Right,t,i,n,o,a),!l))return!1}else{let l=e.UserData;if(n.has(l))return!0;if(L.PointRelativeToCurveLocation(t,l)!==0)return vi.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=i&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,i,n){let o=t.sub(e).normalize();return o=new m(o.y,o.x*-1),re.mkFromPoints([e.add(o.mul(i/2)),e.sub(o.mul(i/2)),t.sub(o.mul(n/2)),t.add(o.mul(n/2))])}};var eS=class{constructor(e,t,i,n){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=i,this.Index=n}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var tS=class{constructor(e,t,i){this.metroline=e,this.station=t,this.polyPoint=i}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var rS=class{constructor(e,t,i){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=i}debStop(){return this.SerialNumber===28&&this.Position.sub(new m(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}static less(e,t){return e.SerialNumber<t.SerialNumber}static greater(e,t){return e.SerialNumber>t.SerialNumber}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var iS=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Yt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Yt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new _r(Me);for(let n of this.metroGraphData.VirtualStations())t.Enqueue(n,-this.CalculatePotential(n,e));let i=!1;for(;!t.IsEmpty();){let n={priority:0},o=t.DequeueAndGetPriority(n);if(n.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),i=!0)}return i}TryGrowHub(e,t){let i=this.CalculateAllowedHubRadius(e);if(e.Radius>=i)return!1;let n=t?Yt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=n)return!1;let a=.05*(n-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,i);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let i=t?Yt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return i<=e.Radius?0:(i-e.Radius)/i}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let n of e.Neighbors){let o=n.Position.sub(e.Position).length;t=Math.min(t,o/1.05-n.Radius)}let i=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return i<t&&(t=i-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,i){let n=1;for(let o of i.Neighbors){let l=e.GetWidthSSN(o,i,t.EdgeSeparation)/2+t.EdgeSeparation;n=Math.max(n,l)}return n=Math.min(n,2*t.MaxHubRadius),n}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,i){return Yt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,i.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,n){let o=Yt.CalculateIdealHubRadius(e,t,i);if(i.Neighbors.length>1){let a=i.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Yt.GetMinRadiusForTwoAdjacentBundles(o,i,n,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let i=e.MaxHubRadius;for(let n of t.Neighbors)i=Math.min(i,t.Position.sub(n.Position).length/2);return i}static GetMinRadiusForTwoAdjacentBundles(e,t,i,n,o,a,l){let u=a.GetWidthSSN(t,n,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Yt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,i,n.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,i,n,o,a,l){if(o<A.distanceEpsilon||a<A.distanceEpsilon)return e;let u=m.anglePCP(i,t,n);if(u=Math.min(u,Math.PI*2-u),u<A.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),f=a/(4*c),p=2*Math.sqrt(d*d+(f*f+2*(d*(f*h))));return p=Math.min(p,2*l.MaxHubRadius),p=Math.max(p,e),p}};var eu=class{constructor(e,t,i,n){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=i,this.cdt=n}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Yt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],i=e[1],n=this.metroGraphData.GetIjInfo(t,i);n.cachedBundleCost=this.costCalculator.BundleCost(t,i,t.Position),t.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.GetCdtTree();e.CdtTriangle=t.FirstHitNodeWithPredicate(e.Position,eu.testPointInside).UserData,e.cachedIdealRadius=Yt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let i of e.Neighbors){i.IsReal||(i.cachedIdealRadius=Yt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,i),i.cachedRadiusCost=this.costCalculator.RadiusCost(i,i.Position));let n=this.metroGraphData.GetIjInfo(e,i);i.cachedBundleCost-=n.cachedBundleCost,n.cachedBundleCost=this.costCalculator.BundleCost(e,i,e.Position),e.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}static testPointInside(e,t){return ht.PointIsInsideOfTriangle(e,t)?1:0}};var nf=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size===0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let i=this.mainMap.get(e);if(i)return i.get(t)}has(e,t){let i=this.mainMap.get(e);return i?i.has(t):!1}set(e,t,i){let n=this.mainMap.get(e);n||(n=new Map,this.mainMap.set(e,n)),n.set(t,i)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[i,n]of t)yield[e,i,n]}*keys(){for(let[e,t]of this.mainMap)for(let[i]of t)yield[e,i]}};var nS=class{constructor(e,t,i,n,o,a,l,u){this.cachedEnterableLooseForEnd=new bt;this.bundlingSettings=n,this.regularEdges=e,o!=null?this.Cdt=o:this.Cdt=$n.CreateConstrainedDelaunayTriangulation(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new vi(this,n,t,c=>c.getELP()),this.tightIntersections=new vi(this,n,i,c=>c.EnterableTightPolylines),this.cdtIntersections=new rf(this,n),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],n=this.edgeInfoDictionary.get(i[0],i[1]);return n?n.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(i[0],i[1])}MoveNode(e,t){let i=e.Position;this.PointToStations.deleteP(i),this.PointToStations.set(t,e),e.Position=t;for(let n of this.MetroNodeInfosOfNode(e))n.PolyPoint.point=t;for(let n of this.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(i).length-a.sub(i).length}for(let n of e.Neighbors)this.ink+=t.sub(n.Position).length-i.sub(n.Position).length;this.SortNeighbors(e);for(let n of e.Neighbors)this.SortNeighbors(n)}GetWidthSSN(e,t,i){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(n[0],n[1]);return o?o.Width+(o.Count-1)*i:0}GetWidthAN(e,t){let i=0;for(let o of e)i+=o.Width;let n=e.length;return i+=n>0?(n-1)*t:0,i}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,i=new oT.Stack,n=new nt;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(n.has(o.point)){let l=o.next;do{let u=i.top;if(!u.equal(a))n.delete(u),i.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else i.push(a),n.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new bt;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!==e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let i=new rS(this.Stations.length,t,e.point);this.PointToStations.set(e.point,i),this.Stations.push(i)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let i=new eS(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(i),this.PointToStations.get(i.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(i.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let i=this.PointToStations.get(t.Polyline.start),n;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,i=n)n=this.PointToStations.get(o.next.point),Ll(e,i,n),Ll(e,n,i)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new m(360.561,428.416)).length<.1&&t.Position.sub(new m(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let i=this.edgeInfoDictionary.get(e,t);return i||(i=new iS,this.edgeInfoDictionary.set(e,t,i),i)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new nf,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let i=this.metrolines[t];this.InitMetroNodeInfos(i),this.InitNodeEnterableLoosePolylines(i,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(i,this.regularEdges[t]),i.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let i=this.PointToStations.get(t.point);i.MetroNodeInfos.push(new tS(e,i,t))}}InitNodeEnterableLoosePolylines(e,t){let i=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point);o.getELP()!=null?o.setELP(Kn(o.getELP(),i)):o.setELP(new Set(i))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let i of this.LooseTree.AllHitItems_(e))L.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableLoosePolyline(i);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let i of this.TightTree.AllHitItems_(e))L.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableTightPolyline(i)}InitNodeEnterableTightPolylines(e,t){let i=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=Kn(a,i):o.EnterableTightPolylines=new Set(i)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,i=e.Position;e.Neighbors.sort((n,o)=>Wo(t.sub(i),n.Position.sub(i),o.Position.sub(i)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,i=this.PointToStations.get(t.start),n;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,i=n){n=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(i,n);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.Cdt.GetCdtTree();for(let t of this.Stations)t.CdtTriangle=e.FirstHitNodeWithPredicate(t.Position,eu.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let i=e.sourceAndTargetLoosePolylines();return L.PointRelativeToCurveLocation(t,i[0])===0&&L.PointRelativeToCurveLocation(t,i[1])===0}};function Wo(s,e,t){let i=m.crossProduct(s,t),n=s.dot(t),o=m.crossProduct(s,e),a=s.dot(e);return le(o,0)&&of(a,0)?le(i,0)&&of(n,0)?0:1:le(i,0)&&of(n,0)?-1:le(o,0)||le(i,0)||o*i>0?pd(m.crossProduct(t,e),0):-pd(Math.sign(o),0)}function of(s,e){return pd(s,e)>=0}var lT=me(un());var Ho=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,i){return(e-t)*i.InkImportance}static PathLengthsError(e,t,i,n){return(e-t)*(n.PathLengthImportance/i)}static RError(e,t,i){return e<=t?0:i.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,i){return e<=t?0:i.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let i=t.InkImportance*e.Ink;for(let n of e.Metrolines)i+=t.PathLengthImportance*n.Length/n.IdealLength;return i+=this.CostOfForces(e),i}static CostOfForces(e){let t=0;for(let i of e.VirtualStations())t=t+i.cachedRadiusCost;for(let i of e.VirtualEdges()){let n=i[0],o=i[1];t+=e.GetIjInfo(n,o).cachedBundleCost}return t}InkGain(e,t){let i=this.metroGraphData.Ink,n=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;n-=a.sub(e.Position).length,n+=a.sub(t).length}return Ho.InkError(i,n,this.bundlingSettings)}PathLengthsGain(e,t){let i=0;for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline.Length,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point,u=n.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;i+=Ho.PathLengthsError(o,u,n.Metroline.IdealLength,this.bundlingSettings)}return i}RadiusGain(e,t){let i=0;return i=i+e.cachedRadiusCost,i=i-this.RadiusCost(e,t),i}RadiusCost(e,t){let i;m.closeDistEps(e.Position,t)?i=e.cachedIdealRadius:i=Yt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,i,n))return Ho.Inf;let o=0;for(let a of n.touchedObstacles){let l=a[1].sub(t).length;o+=Ho.RError(i,l,this.bundlingSettings)}return o}BundleGain(e,t){let i=e.cachedBundleCost;for(let n of e.Neighbors){let o=this.BundleCost(e,n,t);if(of(o,Ho.Inf))return-Ho.Inf;i-=o}return i}BundleCost(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,i,t.Position,n,o))return Ho.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=Ho.BundleError(n/2,u,this.bundlingSettings)}return a}},Br=Ho;Br.Inf=1e9;var sT=me(gs());var oS=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new bt;this.interestingPoints=new nt;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){tB(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){rB(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new sT.Queue;for(let i of this.Polylines)t.enqueue(i);for(;t.length>0;){let i=t.dequeue();e.delete(i);let n=this.ProcessPolyline(i);n!=null&&(e.has(i)||(e.add(i),t.enqueue(i)),e.has(n)||(e.add(n),t.enqueue(n)))}}ProcessPolyline(e){let t=new Map;for(let i=e.startPoint.next;i!=null;i=i.next){this.FillDepartedPolylinePoints(i,t);for(let n of this.pathsThroughPoints.get(i.point)){let o=t.get(n.polyline);if(o){if(this.ProcessFlip(i,o))return n.polyline;t.delete(n.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let i=e.prev.point;for(let n of this.pathsThroughPoints.get(i))this.IsNeighborOnTheSamePolyline(n,e)||t.has(n.polyline)||t.set(n.polyline,n)}ProcessFlip(e,t){let i=e.polyline,n=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(i),u=this.polylineToEdgeGeom.get(n);if(l.lineWidth!==u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!wl(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(i,o,a),h=c[0],d=c[1],f=c[2];c=this.FindPointsOnPolyline(n,o,a);let p=c[0],S=c[1],x=c[2],T=this.FindRelationOnFirstPoint(h,p,f,x),O=this.FindRelationOnLastPoint(d,S,f,x);return T!==2&&O!==2||T===1||O===1?!1:(this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.Swap(h,p,d,S,f,x),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,i){let n,o;for(let a=e.startPoint;a!=null;a=a.next)if(n==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];n=a}else o==null&&a.point.equal(i)&&(o=a);else if(a.point.equal(i))return[n,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let i=e;i!=null;i=i.next)if(i===t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Prev(e,i),u=this.Prev(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,i,n)}FindRelationOnLastPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Next(e,i),u=this.Next(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,i).point.equal(this.Prev(t,n).point);)e=this.Next(e,i),t=this.Prev(t,n);return this.PolylinesIntersect(e,t,o,a,i,n)}PolylinesIntersect(e,t,i,n,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(i,o),h=this.Prev(i,o),d=this.Next(t,a),f=this.Prev(n,a);if(e.point.equal(i.point)){let p=e.point,S=Wo(h.point.sub(p),f.point.sub(p),u.point.sub(p)),x=Wo(h.point.sub(p),d.point.sub(p),u.point.sub(p));return S===x?1:2}else{let p=Wo(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),S=Wo(c.point.sub(i.point),f.point.sub(i.point),h.point.sub(i.point));return p===S?1:2}}Swap(e,t,i,n,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),i,o),u=this.GetRangeOnPolyline(this.Next(t,a),n,a);this.ChangePolylineSegment(e,i,o,u),this.ChangePolylineSegment(t,n,a,l),wa.RemoveSelfCyclesFromPolyline(e.polyline),wa.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,i,n){let o=e;for(let a of n){let l=Ut.mkFromPoint(a.point);l.polyline=o.polyline,i?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}i?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,i){let n=new Array;for(let o=e;o!==t;o=this.Next(o,i))n.push(o);return n}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new nt;for(let i=e.startPoint;i!=null;i=i.next){if(i===e.startPoint){if(i.prev!=null)return!1}else if(i.prev.next!==i)return!1;if(i===e.endPoint){if(i.next!=null)return!1}else if(i.next.prev!==i)return!1;if(t.has(i.point))return!1;t.add(i.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function tB(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function rB(s,e,t){let i=s.get(e);!i||(i.delete(t),i.size===0&&s.deleteP(e))}var wa=class{constructor(e,t){this.foundCrossings=new nt;this.crossingsThatShouldBecomeHubs=new nt;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new ko;for(let t of this.Vertices())t.next&&e.set(new _t(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length===0)return!1;let e=new ko,t=new ml(null);for(let l of this.Vertices()){let u=W.mkOnPoints([l.point]);u.pad(A.intersectionEpsilon),t.Add(u,l.point)}let i=Pd(this.Edges(),l=>W.mkPP(l.First,l.Second));Xt(i,i,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let n=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||n||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((i,n)=>Me(je(i,e.First),je(n,e.First)))}InsertPointsIntoPolylines(e){let t=!1;for(let i of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(i,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let i=!1;for(let n=e.Polyline.startPoint;n.next!=null;n=n.next)this.InsertPointsOnPolypoint(n,t,e)&&(i=!0);return i}InsertPointsOnPolypoint(e,t,i){let n=new _t(e.point,e.next.point),o=e.point!==n.First,a=t.get(n);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Ut.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Ut.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)wa.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,i=new bt;for(let n=e.startPoint;n!=null;n=n.next){let o=n.point,a=i.get(o);if(a){for(let l=a.next;l!==n.next;l=l.next)i.deleteP(l.point);a.next=n.next,n.next.prev=a,t=!0}else i.set(n.point,n)}return t}ReduceEdgeCrossings(){let e=new oS(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=Cv(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let i=e.startPoint.next;i!=null&&i.next!=null;i=i.next)if(this.pointsToDelete.has(i.point)&&m.getTriangleOrientation(i.prev.point,i.point,i.next.point)===2){let n=i.prev,o=i.next;n.next=o,o.prev=n,i=n,t=!0}return t}IntersectTwoEdges(e,t,i,n){let o=D.IntersectPPPP(e.First,e.Second,t.First,t.Second);if(o){let a=this.FindExistingVertexOrCreateNew(n,o);(this.AddVertexToSplittingList(e,i,a)||this.AddVertexToSplittingList(t,i,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let i=e.RootNode.FirstHitNode(t);if(i!=null)return i.UserData;let n=W.mkOnPoints([t]);return n.pad(A.intersectionEpsilon),e.Add(n,t),t}AddVertexToSplittingList(e,t,i){if(!L.closeIntersectionPoints(i,e.First)&&!L.closeIntersectionPoints(i,e.Second)){let n=t.get(e);if(n||(n=new Array,t.set(e,n)),!n.find(o=>o.equal(i)))return n.push(i),!0}return!1}};var aT=me(Zd());var kg=class{isCorrectlyOrienected(){return m.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!==1}get Count(){return this.points.length}constructor(e,t,i,n){this.BelongsToRealNode=n,this.Curve=t,this.Position=i,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return m.middle(this.StartPoint,this.EndPoint)}get Span(){return this.SpanBetweenTwoParameters(this.parStart,this.parEnd)}SpanBetweenTwoParameters(e,t){return e<=t?t-e:t-e+ln(this.Curve)}RotateLeftPoint(e,t){return e===0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e===0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,i){let n=ln(this.Curve)*i;return t+=e*n,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,i){let n=ln(this.Curve)*i;e!==0&&(this.ParStart=this.AdjustParam(this.ParStart+e*n)),t!==0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*n))}RelativeOrderOfBasesIsPreserved(e,t,i){let n=ln(this.Curve)*i,o=this.parStart+e*n,a=this.parStart<this.parEnd?this.parEnd+t*n:this.parEnd+ln(this.Curve)+t*n;if(o>a||this.SpanBetweenTwoParameters(o,a)>ln(this.Curve)/2)return!1;if(this.Prev==null||this.SpanBetweenTwoParameters(this.Prev.ParMid,this.ParMid)>n&&this.SpanBetweenTwoParameters(this.ParMid,this.Next.ParMid)>n)return!0;let l=this.RotateLeftPoint(t,i),u=this.RotateRigthPoint(e,i),c=m.middle(l,u),h=this.MidPoint;return!(m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var tu=class{constructor(e,t,i,n){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=i,this.HalfWidthArray=n,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let i=this.SourceBase.Curve.boundingBox.diagonal/2,n=this.TargetBase.Curve.boundingBox.diagonal/2,o=vi.Create4gon(this.SourceBase.Position,this.TargetBase.Position,i*2,n*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&L.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,i=e.sub(t).normalize(),n=i.rotate90Ccw(),o=m.middle(e,t),a=i.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(n.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>tu.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(n.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=tu.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(n.mul(tu.FeasibleWidthEpsilon),new m(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new m(0,0),n.mul(-tu.FeasibleWidthEpsilon),l,u))&&(d=2*tu.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"/tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,i){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,i)}SetRLParamsIfWidthIsFeasible_(e,t,i,n){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(D.mkPP(i.add(e),n.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>L.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(D.mkPP(i.add(t),n.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>L.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(D.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"/tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,i){let n=L.getAllIntersections(e,this.SourceBase.Curve,!0);if(n.length===0)return i.par=0,t.par=0,null;let o;if(n.length===1?o=n[0]:this.SourceBase.IsParent?o=n[0].par0<n[1].par0?n[1]:n[0]:o=n[0].par0<n[1].par0?n[0]:n[1],n=L.getAllIntersections(e,this.TargetBase.Curve,!0),n.length===0)return i.par=0,t.par=0,null;let a;return n.length===1?a=n[0]:this.TargetBase.IsParent?a=n[0].par0>n[1].par0?n[1]:n[0]:a=n[0].par0>n[1].par0?n[0]:n[1],t.par=o.par1,i.par=a.par1,D.mkPP(o.x,a.x)}RotateBy(e,t,i,n,o){let a=e!==0||t!==0,l=i!==0||n!==0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(i,n,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let i=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),n=i.length;n>=A.tolerance&&(i=i.div(n),this.TargetBase.Tangents[t]=i,this.SourceBase.Tangents[e-1-t]=i.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,i=e.Points,n=D.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];i[0]=n.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],i[l]=n.value(a*o)}RotationIsLegal(e,t,i,n,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!==0||i!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||n!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!==0||n!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||i!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!==0||t!==0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(i!==0||n!==0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(i,n,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(i=>L.intersectionOne(D.mkPP(e,t),i,!1)!=null)==null}},zg=tu;zg.FeasibleWidthEpsilon=.1;var Ug=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,i,n){this.Segment=e,this.Reversed=t,this.Index=i,this.BundleBase=n}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var Ze=class{constructor(e,t,i){this.fixedBundles=new aT.HashSet;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=i}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=de.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let i=new kg(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,i);let n=new kg(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,n),L.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!==0?(i.IsParent=!0,Ol(this.internalBases,e,i),Ol(this.externalBases,t,n)):L.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!==0?(n.IsParent=!0,Ol(this.externalBases,e,i),Ol(this.internalBases,t,n)):(Ol(this.externalBases,e,i),Ol(this.externalBases,t,n));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new zg(i,n,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));i.OutgoingBundleInfo=n.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,i=e[0].CurveCenter;e.sort((n,o)=>Wo(t.sub(i),n.OppositeBase.Position.sub(i),o.OppositeBase.Position.sub(i)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++)e[i].Prev=e[(i-1+t)%t],e[i].Next=e[(i+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=a.OrientedHubSegments[u]=new Ug(null,!1,u,a),d=l.OrientedHubSegments[c]=new Ug(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,i=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,i.Position),i.ParEnd=i.ParStart=this.GetBaseMiddleParamInDirection(i,i.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,i){let n=e.Curve;if(n instanceof de){let l=n;if(l.isArc())return m.angle(l.aAxis,i.sub(t))}let a=L.getAllIntersections(n,D.mkPP(t,i),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(i))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++){let n=e[i],o=n.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(n,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let i=iB(e,t);if(i==null||le(i.start,i.end))return;let n=i.rbaseMiddle,o=i.lbaseMiddle;if(n<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(i.end*a+i.start*l)/(l+a);e.ParStart=e.AdjustParam(u+A.distanceEpsilon),t.ParEnd=t.AdjustParam(u-A.distanceEpsilon)}RegularCut(e,t,i,n,o,a){let l=(o*n+a*e)/(o+a),u=Math.min(t,n),c=Math.max(e,i);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=Ze.MaxParameterChange,t={cost:this.Cost()},i=0;for(;i++<Ze.MaxIterations;){let n=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,n,t.cost),e<Ze.MinParameterChange)break}}UpdateParameterChange(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let i=!1;for(let n of this.Bundles)this.fixedBundles.has(n)||(this.OptimizeBundle(n,e,t)?i=!0:this.fixedBundles.add(n));return i}OptimizeBundle(e,t,i){let n=this.CostBi(e);if(n<Ze.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<Ze.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(Ze.Deltas[u][0],Ze.Deltas[u][1],0,0,e,n,t);c>Ze.CostDeltaThreshold&&c>o&&(l=u,a=Ze.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,Ze.Deltas[u][0],Ze.Deltas[u][1],e,n,t),c>Ze.CostDeltaThreshold&&c>o&&(l=Ze.Deltas.length-1,a=u,o=c)}return o<Ze.CostDeltaThreshold?!1:(i.cost-=o,e.RotateBy(Ze.Deltas[l][0],Ze.Deltas[l][1],Ze.Deltas[a][0],Ze.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,i,n,o,a,l){if(!o.RotationIsLegal(e,t,i,n,l))return 0;o.RotateBy(e,t,i,n,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,i*-1,n*-1,l),a-u}CostBi(e){return Ze.SeparationCoeff*this.SeparationCost(e)+(Ze.SqueezeCoeff*this.SqueezeCost(e)+(Ze.AssymetryCoeff*this.AssymetryCost(e)+Ze.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let i=0;return i=i+Ze.CenterCoeff*this.CenterCostBi(e),i>t||(i=i+Ze.SeparationCoeff*this.SeparationCost(e),i>t)||(i=i+Ze.SqueezeCoeff*this.SqueezeCost(e),i>t)||(i=i+Ze.AssymetryCoeff*this.AssymetryCost(e)),i}SqueezeCost(e){let i=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),n=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(i)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(i)),a=Math.abs(e.TotalRequiredWidth-n)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(n-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,i=Math.min(e.InitialMidParameter,t),n=Math.max(e.InitialMidParameter,t),o=Math.min(n-i,i+(ln(e.Curve)-n));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,i=0;for(let n of e.OrientedHubSegments){let o=n.Index,a=n.Other.Index,l=e.Points[o],u=e.Tangents[o],c=n.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],f=e.Count+c.Count;i+=this.GetAssymetryCostOnData(l,u,h,d,t)/f}return i}GetAssymetryCostOnData(e,t,i,n,o){let a=e.sub(i),l=a.length;if(l<A.distanceEpsilon)return 0;let u=t.add(n).dot(a),c=m.crossProduct(a,t),h=m.crossProduct(a,n),d=c-h,f=u*u+d*d,p=c*c+h*h;return 10*f+o*p}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let i=e.Curve,n=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,i),o=Math.min(e.Span,t.Span);return Math.exp(n/(o*10))-1}IntervalsOverlapLength(e,t,i,n,o){let a=o.parStart,l=o.parEnd;return e<t?i<n?this.IntersectRegularIntervals(e,t,i,n):this.IntersectRegularIntervals(e,t,i,l)+this.IntersectRegularIntervals(e,t,a,n):i<n?this.IntersectRegularIntervals(e,l,i,n)+this.IntersectRegularIntervals(a,t,i,n):this.IntersectRegularIntervals(e,l,i,l)+this.IntersectRegularIntervals(a,t,a,n)}IntersectRegularIntervals(e,t,i,n){let o=Math.max(e,i),a=Math.min(t,n);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let i=Ze.SeparationCoeff*this.SeparationCost(t),n=Ze.AssymetryCoeff*this.AssymetryCost(t),o=Ze.SqueezeCoeff*this.SqueezeCost(t),a=Ze.CenterCoeff*this.CenterCostBi(t);e+=(i+n)/2+o+a}return e}},Zi=Ze;Zi.Deltas=[[1,-1],[1,-1]],Zi.SeparationCoeff=1,Zi.SqueezeCoeff=1,Zi.CenterCoeff=10,Zi.AssymetryCoeff=1,Zi.MaxIterations=200,Zi.MaxParameterChange=8/360,Zi.MinParameterChange=.1/360,Zi.CostThreshold=1e-5,Zi.CostDeltaThreshold=.01;function iB(s,e){let t=ln(s.Curve),i=s.ParEnd,n=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-t,o=e.ParEnd,a=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-t;i>o?i-a>t&&(a+=t,o+=t):o-n>t&&(n+=t,i+=t);let l=Math.min(i,o),u=Math.max(n,a);return u<=l?{start:u,end:l,rbaseMiddle:(n+i)/2,lbaseMiddle:(a+o)/2}:null}var sS=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var Nc=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let i=new _t(e.Position,t.Position),n=this.bundles.get(i).Metrolines;if(e.Position===i.First)for(let o=0;o<n.length;o++)yield n[o];else for(let o=n.length-1;o>=0;o--)yield n[o]}GetLineIndexInOrder(e,t,i){let n=new _t(e.Position,t.Position),o=e.Position!==n.First,a=this.bundles.get(n).LineIndexInOrder;return o?a.size-1-a.get(i):a.get(i)}BuildOrder(){this.bundles=new ko;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let i=new _t(t.point,t.next.point),n=this.bundles.get(i);n||this.bundles.set(i,n=new sS),n.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((i,n)=>this.CompareLines(i,n,e.First,e.Second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let i=0;i<t.Metrolines.length;i++)t.LineIndexInOrder.set(t.Metrolines[i],i)}}CompareLines(e,t,i,n){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(i,n,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(i,n,t,o);let c=o.polyPoint,h=o.next,d=o.prev,f=a,p=c,S,x;for(;(x=u(f))!=null&&(S=d(p))!=null&&x.point.equal(S.point);){let T=new _t(x.point,f.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!x.point.equal(T.First));f=x,p=S}if(x!=null&&S!=null){let T=f.point;return-Nc.IsLeft(l(f).point.sub(T),x.point.sub(T),S.point.sub(T))}for(f=a,p=c;(x=l(f))!=null&&(S=h(p))!=null&&x.point.equal(S.point);){let T=new _t(x.point,f.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!f.point.equal(T.First));f=x,p=S}if(x!=null&&S!=null){let T=f.point;return Nc.IsLeft(u(f).point.sub(T),x.point.sub(T),S.point.sub(T))}return Me(e.Index,t.Index)}CompareOnFixedOrder(e,t,i,n){let o=this.bundles.get(e).LineIndexInOrder;return(n?-1:1)*Me(o.get(t),o.get(i))}FindStationOnLine(e,t,i,n){for(let o=i.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){n.next=a=>a.next,n.prev=a=>a.prev,n.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){n.next=a=>a.prev,n.prev=a=>a.next,n.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,i){return Wo(e,t,i)}};var ot=class extends ye{constructor(e,t){super(null);this.metroGraphData=e,this.bundlingSettings=t}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Yt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new Nc(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new Zi(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let e=0;e<this.metroGraphData.Metrolines.length;e++)this.CreateCurveLine(this.metroGraphData.Metrolines[e],this.metroGraphData.Edges[e])}CreateCurveLine(e,t){let i=new L,o=ot.FindCurveStart(this.metroGraphData,this.metroOrdering,e),a=ot.HubSegsOfLine(this.metroGraphData,this.metroOrdering,e);for(let l of a)l!=null&&(i.addSegment(D.mkPP(o,l.start)),i.addSegment(l),o=l.end);i.addSegment(D.mkPP(o,ot.FindCurveEnd(this.metroGraphData,this.metroOrdering,e))),t.curve=i}static FindCurveStart(e,t,i){let n=e.PointToStations.get(i.Polyline.startPoint.point),o=e.PointToStations.get(i.Polyline.startPoint.next.point),a=n.BundleBases.get(o),l=a.IsParent?t.GetLineIndexInOrder(n,o,i):t.GetLineIndexInOrder(o,n,i);return a.Points[l]}static FindCurveEnd(e,t,i){let n=e.PointToStations.get(i.Polyline.endPoint.prev.point),o=e.PointToStations.get(i.Polyline.endPoint.point),a=o.BundleBases.get(n),l=a.IsParent?t.GetLineIndexInOrder(o,n,i):t.GetLineIndexInOrder(n,o,i);return a.Points[l]}static*HubSegsOfLine(e,t,i){for(let n=i.Polyline.startPoint.next;n.next!=null;n=n.next)yield ot.SegOnLineVertex(e,t,i,n)}static SegOnLineVertex(e,t,i,n){let o=e.PointToStations.get(n.prev.point),a=e.PointToStations.get(n.point),l=a.BundleBases.get(o),u=t.GetLineIndexInOrder(o,a,i);if(l.OrientedHubSegments[u]==null||l.OrientedHubSegments[u].Segment==null){let c=e.PointToStations.get(n.next.point),h=a.BundleBases.get(c),d=t.GetLineIndexInOrder(c,a,i);return D.mkPP(l.Points[u],h.Points[d])}return l.OrientedHubSegments[u].Segment}CreateSegmentsInsideHubs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateICurveForOrientedSeg(e,t)}CreateICurveForOrientedSeg(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?ot.StandardBezier(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]):ot.BiArc(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]);a.OrientedHubSegments[u].Segment=h,l.OrientedHubSegments[c].Segment=h}static ShowHubs(e,t,i,n,o=[]){let a=ot.GetAllDebugCurves(t,e);i!=null&&a.push(be.mkDebugCurveTWCI(255,1,"red",we.CreateDiamond(5,25,i.Position))),a=a.concat(o)}static GetAllDebugCurves(e,t){return ot.GraphNodes(t).concat(ot.VertexDebugCurves(e,t)).concat(ot.DebugEdges(t))}static DebugEdges(e){return e.Edges.map(t=>be.mkDebugCurveTWCI(40,.1,"gray",t.curve))}static VertexDebugCurves(e,t){return ot.DebugCircles(t).concat(ot.DebugHubBases(t)).concat(ot.DebugSegs(t)).concat(ot.BetweenHubs(e,t))}static BetweenHubs(e,t){let i=[];for(let n of t.Metrolines){let o=ot.GetInterestingSegs(t,e,n),a=ot.GetMonotoneColor(n.Polyline.start,n.Polyline.end,o);for(let l of o)i.push(be.mkDebugCurveTWCI(100,n.Width,a,D.mkPP(l[0],l[1])))}return i}static GetInterestingSegs(e,t,i){let n=new Array;if(e.Stations.length===0||e.Stations[0].BundleBases==null||e.Stations[0].BundleBases.size===0)return[];let o=ot.FindCurveStart(e,t,i),a=ot.HubSegsOfLine(e,t,i);for(let l of a)l!=null&&(n.push([o,l.start]),o=l.end);return n.push([o,ot.FindCurveEnd(e,t,i)]),n}static GetMonotoneColor(e,t,i){return"green"}static DebugHubBases(e){let t=new Array;for(let i of e.Stations)for(let n of i.BundleBases.values())t.push(be.mkDebugCurveTWCI(100,1,"red",D.mkPP(n.EndPoint,n.StartPoint)));return t}static DebugCircles(e){return e.Stations.map(t=>be.mkDebugCurveTWCI(100,.1,"blue",we.mkCircle(t.Radius,t.Position)))}static DebugSegs(e){let t=new Array;for(let i of e.VirtualStations())for(let n of i.BundleBases.values())for(let o of n.OrientedHubSegments)if(o!=null)if(o.Segment==null){let a=o.Other.BundleBase,l=o.Index,u=o.Other.Index;t.push(D.mkPP(n.Points[l],a.Points[u]))}else t.push(o.Segment);return t.map(i=>be.mkDebugCurveTWCI(100,.01,"green",i))}static GraphNodes(e){return e.Edges.map(i=>i.sourcePort.Curve).concat(e.Edges.map(i=>i.targetPort.Curve)).map(i=>be.mkDebugCurveTWCI(40,1,"black",i))}static BiArc(e,t,i,n){let o=e.sub(i);if(o.length<A.distanceEpsilon)return null;let a=o.dot(t.sub(n)),l=-t.dot(n);if(t.dot(i.sub(e))<=0&&t.dot(n)<=0)return ot.StandardBezier(e,t,i,n);let u=2*(l-1),c=2*a,h=o.dot(o),d;if(Math.abs(u)<A.distanceEpsilon)if(Math.abs(c)>A.distanceEpsilon)d=-h/c;else return null;else{let M=c*c-4*u*h;M<0&&(M=0),M=Math.sqrt(M),d=(-c+M)/(2*u),d<0&&(d=(-c-M)/(2*u))}let f=e.add(t.mul(d)),p=i.add(n.mul(d)),S=m.middle(f,p),x=m.getTriangleOrientation(e,f,S),T=m.getTriangleOrientation(S,p,i);if(x!==T)return ot.StandardBezier(e,t,i,n);let O=new L;return O.addSegs([ot.ArcOn(e,f,S),ot.ArcOn(S,p,i)]),O}static ArcOn(e,t,i){let n={center:null};if(Math.abs(m.signedDoubledTriangleArea(e,t,i))<1e-4||!ot.FindArcCenter(e,t,i,n))return D.mkPP(e,i);let o=n.center,a=je(e,o);if(je(e,t)/a<1e-4)return D.mkPP(e,i);let u=e.sub(o),c=Math.atan2(u.y,u.x),h=i.sub(o),d=Math.atan2(h.y,h.x),f=d-c;if(f<0&&(f+=2*Math.PI,d+=2*Math.PI),f<=Math.PI)return new de(c,d,new m(a,0),new m(0,a),o);for(d>2*Math.PI&&(d-=2*Math.PI),c=Math.PI-c,d=Math.PI-d,c<0&&(c+=2*Math.PI);d<c;)d+=2*Math.PI;return f=d-c,new de(c,d,new m(-a,0),new m(0,a),o)}static FindArcCenter(e,t,i,n){let o=t.sub(e).rotate90Cw(),a=t.sub(i).rotate90Cw();return n.center=m.lineLineIntersection(e,e.add(o),i,i.add(a)),n.center!=null}static StandardBezier(e,t,i,n){let o=je(e,i)/4;return Ge.mkBezier([e,e.add(t.mul(o)),i.add(n.mul(o)),i])}FanBezierSegs(){let e=!0,t=5,i=0;for(;e&&i++<t;){e=!1;for(let n of this.metroGraphData.Stations)for(let o of n.BundleBases.values())e||(e=this.FanEdgesOfHubSegment(o))}}FanEdgesOfHubSegment(e){let t=!1;for(let i=0;i<e.Count-1;i++)t||(t=this.FanCouple(e,i,e.CurveCenter,e.Curve.boundingBox.diagonal/2));return t}FanCouple(e,t,i,n){let o=e.OrientedHubSegments[t],a=e.OrientedHubSegments[t+1];if(o==null||D.IntersectPPPP(o.Segment.start,o.Segment.end,a.Segment.start,a.Segment.end)||m.getTriangleOrientation(o.value(0),o.value(.5),o.value(1))!=m.getTriangleOrientation(a.value(0),a.value(.5),a.value(1)))return!1;let u=this.BaseLength(o),c=this.BaseLength(a);return Math.abs(u-c)<A.intersectionEpsilon?!1:u>c?this.AdjustLongerSeg(o,a,i,n):this.AdjustLongerSeg(a,o,i,n)}AdjustLongerSeg(e,t,i,n){let o=e.value(0).sub(t.value(0)),a=e.value(1).sub(t.value(1)),l=Math.min(o.length,a.length),u=t.value(.5),c=Math.max(o.length,a.length);return this.NicelyAligned(e.Segment,o,a,u,l,c)===0?!1:this.FitLonger(e,o,a,u,l,c,i,n)}FitLonger(e,t,i,n,o,a,l,u){let c=e.Segment,h=c.start,d=c.end,f=0,p=10,S=c.start.mul(1-ot.SqueezeBound).add(c.B(1).mul(ot.SqueezeBound)),x=c.end.mul(1-ot.SqueezeBound).add(c.B(2).mul(ot.SqueezeBound)),T=c.B(1).mul(2).sub(c.start),O=c.B(2).mul(2).sub(c.end),M={highP:T};this.PullControlPointToTheCircle(c.start,M,l,u),T=M.highP;let R=this.NicelyAligned(c,t,i,n,o,a);do{if(R===-1){let N=m.middle(c.B(1),S),H=m.middle(c.B(2),x);T=c.B(1),O=c.B(2),c=new Ge(h,N,H,d)}else{let N=m.middle(c.B(1),T),H=(c.B(2),O);S=c.B(1),x=c.B(2),c=new Ge(h,N,H,d)}if((R=this.NicelyAligned(c,t,i,n,o,a))===0)return e.Segment=c,e.Other.Segment=c,!0;if(f++>p)return!1}while(!0)}PullControlPointToTheCircle(e,t,i,n){let o=m.ProjectionToLine(e,t.highP,i),a=Math.sqrt(n*n-o.sub(i).lengthSquared),l=t.highP.sub(o),u=l.length;u>a&&(t.highP=o.add(l.mul(a/u)))}NicelyAligned(e,t,i,n,o,a){let u=e.value(.5).sub(n),c=u.length;return t.dot(u)<0||i.dot(u)<0||c<o-.001?1:c>a+.001?-1:0}BaseLength(e){return e.value(0).sub(e.value(1)).lengthSquared}},La=ot;La.SqueezeBound=.2;var Pn=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new Br(this.metroGraphData,this.bundlingSettings),this.cache=new eu(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.Cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,i){return new Pn(e,t).FixRoutingP(i)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=Pn.MaxStep,i=Number.POSITIVE_INFINITY,n=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<Pn.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=i;i=Br.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,i);let u=n;if(n=this.metroGraphData.VirtualStations().map(c=>c.Position),t<Pn.MinStep||this.Converged(t,u,n))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let i=e[0],n=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(i,n),a=D.mkPP(i.Position,n.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>L.CurvesIntersect(a,u));return l.length>0?(La.ShowHubs(t,null,null,"/tmp/badcross.svg",[be.mkDebugCurveTWCI(200,1,"Brown",a),be.mkDebugCurveTWCI(200,1,"Red",we.mkCircle(2,i.Position)),be.mkDebugCurveTWCI(200,1,"Blue",we.mkCircle(5,n.Position)),be.mkDebugCurveTWCI(100,1,"Blue",we.mkCircle(5,n.Position))].concat(l.map(u=>be.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let i of e){let n=this.metroGraphData.PointToStations.get(i);n&&!n.IsReal&&t.add(n)}return t}}Converged(e,t,i){let n=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(i[l]).lengthSquared,n+=t[l].lengthSquared;return Math.sqrt(o/n)<Pn.MinRelativeChange}UpdateMaxStep(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(Pn.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let i of this.stationsForOptimizations)if(this.TryMoveStation(i)){e=!0,t.add(i);for(let n of i.Neighbors)n.IsReal||t.add(n)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length===0)return!1;let i=this.BuildStepLength(e,t);if(i<Pn.MinStep&&(t=nB(),i=this.BuildStepLength(e,t),i<Pn.MinStep))return!1;let n=t.mul(i),o=e.Position.add(n);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let i of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(W.mkOnPoints([t]),n=>L.PointRelativeToCurveLocation(t,n)!==0))if(e.getELP().has(i)===!1)return!1;for(let i of e.Neighbors){let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(i,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(i.Position,t,i.CdtTriangle,n))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),i=this.BuildForceForPathLengths(e),n=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(i.add(n.add(o)));return a.length<.1?new m(0,0):a.normalize()}BuildStepLength(e,t){let i=Pn.MinStep,n=this.CostGain(e,e.Position.add(t.mul(i)));if(n<.01)return 0;for(;2*i<=Pn.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(i*2)));if(o<=n)break;i*=2,n=o}return i}CostGain(e,t){let n=this.costCalculator.RadiusGain(e,t);if(n<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return n+a+l+o}BuildForceForInk(e){let t=new m(0,0);for(let n of e.Neighbors){let o=n.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new m(0,0);for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.next.point,l=n.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new m(0,0),i=e.cachedIdealRadius,n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,i,n))throw La.ShowHubs(this.metroGraphData,null,e,"/tmp/hubs.svg",[be.mkDebugCurveTWCI(255,1,"Brown",vi.containingPoly),be.mkDebugCurveTWCI(100,1,"Blue",we.mkCircle(i,e.Position))]),new Error;for(let l of n.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/i),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new m(0,0);for(let n of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,n,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,n,e.Position,n.Position,o/2,a)||La.ShowHubs(this.metroGraphData,null,e,"/tmp/inside_forbid.svg",[be.mkDebugCurveTWCI(100,.2,"Blue",D.mkPP(e.Position,n.Position)),be.mkDebugCurveTWCI(100,.2,"Red",we.mkCircle(2,e.Position)),be.mkDebugCurveTWCI(100,.2,"Red",we.mkCircle(3,n.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},eo=Pn;eo.MaxIterations=100,eo.MaxStep=50,eo.MinStep=1,eo.MinRelativeChange=5e-4;function nB(){return new m(1+2*Td(),1+2*Td())}var Ns=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let i=new Ns(e,t);i.GlueConflictingStations(),i.UnglueEdgesFromBundleToSaveInk(!0);let n=0,o=10;for(;++n<o;){let a=i.GlueConflictingStations();if(a||(a=i.RelaxConstrainedEdges()),a||(a=n<=3&&i.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=i.GlueCollinearNeighbors(n)),a||(a=n===3&&i.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,i.RemoveDoublePathCrossings(),i.UnglueEdgesFromBundleToSaveInk(!0);i.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,i=new Set;if(Xt(e,e,(o,a)=>this.TryToGlueStations(o,a,t,i)),t.size===0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let n=new nt;for(let o of i){n.add(o.Position);for(let a of o.Neighbors)a.IsReal||n.add(a.Position)}return this.metroGraphData.Initialize(!1),eo.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,n),!0}GetCirclesHierarchy(){for(let i of this.metroGraphData.VirtualStations())i.Radius=this.GetCurrentHubRadius(i);let e=this.metroGraphData.VirtualStations().map(t);return rt(e);function t(i){let n=i.Position,o=Math.max(i.Radius,5),a=new m(o,o),l=W.mkPP(n.add(a),n.sub(a));return gt(i,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,i=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let n of e.Neighbors)i=Math.min(i,e.Position.sub(n.Position).length);return i}}TryToGlueStations(e,t,i,n){if(!wl(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,n,i)||this.TryGlueOrdered(t,e,n,i)}TryGlueOrdered(e,t,i,n){return!n.has(e)&&!i.has(e)&&this.StationGluingIsAllowed(e,t,n)?(this.Map(e,t,i,n),!0):!1}Map(e,t,i,n){n.set(e,t),i.add(t)}StationGluingIsAllowed(e,t,i){for(let o of e.Neighbors){let a=Ns.Glued(o,i),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,i)<0)}ComputeCostDeltaAfterStationGluing(e,t,i){let n=e.Position.sub(t.Position).length;if(e.Radius>=n||t.Radius>=n)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=Ns.Glued(u,i);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)===0?c.Position.sub(t.Position).length:0}o+=Br.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,f=d.prev,p=d.next;h-=f.point.sub(e.Position).length+p.point.sub(e.Position).length,h+=f.point.sub(t.Position).length+p.point.sub(t.Position).length,o+=Br.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let i=this.metroGraphData.Metrolines[t].Polyline;for(let a of i)if(!this.metroGraphData.PointToStations.has(a))return;let n=!1;for(let a of i)if(e.has(this.metroGraphData.PointToStations.get(a))){n=!0;break}if(!n)return;let o=Array.from(i).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=re.mkFromPoints(Ns.GluedPolyline(o,e))}static GluedPolyline(e,t){let i,n=new lT.Stack;n.push(e[0]);let o=new Set;for(i=1;i<e.length-1;i++){let a=Ns.Glued(e[i],t);if(o.has(a)){for(;n.top!==a;)o.delete(n.pop());continue}m.closeDistEps(a.Position,n.top.Position)||(o.add(a),n.push(a))}return n.push(e[i]),Array.from(n).reverse().map(a=>a.Position)}static Glued(e,t){var i;return(i=t.get(e))!=null?i:e}UnglueEdgesFromBundleToSaveInk(e){let t=new ko;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new _t(a.point,a.next.point);Gy(t,l,o)}}let i=new nt,n=!1;for(let o of this.metroGraphData.Metrolines){let a=Kn(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,i,a)&&(n=!0)}return n&&this.metroGraphData.Initialize(!1),(e||n)&&eo.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:i),n}TrySeparateOnPolyline(e,t,i,n){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,i,n)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,i,n){return this.SeparationShortcutAllowed(e,t,n)?(i.add(e.point),i.add(e.next.point),i.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,i){let n=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(n),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=Yn(l.getELP(),c.getELP()),d=vv([i,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,n,o,a)<0)}GetInkgain(e,t,i,n,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,f=i.sub(n).length,p=n.sub(o).length,S=i.sub(o).length;a.size===u.size&&(d-=f),l.size===u.size&&(d-=p);let x=t.get(new _t(i,o));(!x||x.size===0)&&(d+=S),c+=Br.InkError(h,d,this.bundlingSettings);for(let H of u){let Q=this.polylineLength.get(H),ne=Q-(f+p-S);c+=Br.PathLengthsError(Q,ne,H.IdealLength,this.bundlingSettings)}let T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(i)),O=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),M=this.metroGraphData.GetWidthAN(Array.from(xs(a,u)),this.bundlingSettings.EdgeSeparation),R=Yt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,i,o,n,O,M,this.bundlingSettings);R>T&&(c-=Br.RError(R,T,this.bundlingSettings)),T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let N=this.metroGraphData.GetWidthAN(Array.from(xs(l,u)),this.bundlingSettings.EdgeSeparation);return R=Yt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,o,n,i,N,O,this.bundlingSettings),R>T&&(c-=Br.RError(R,T,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=je(i,n),h=je(n,o),d=je(i,o);a.size===u.size&&(this.ink-=c),l.size===u.size&&(this.ink-=h);let f=t.get(new _t(i,o));(!f||f.size===0)&&(this.ink+=d);for(let p of u){let S=this.polylineLength.get(p);this.polylineLength.set(p,S-(c+h-d))}for(let p of u){let S=Array.from(p.Polyline.polylinePoints()).find(x=>x.point.equal(n));this.RemovePolypoint(S),Vy(t,[i,n],p),Vy(t,[n,o],p),Av(t,[i,o],p)}}FindPolylines(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,a=t.get_(i,n),l=t.get_(n,o),u=Kn(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,i=e.next;t.next=i,i.prev=t}GlueCollinearNeighbors(e){let t=new nt,i=!1;for(let n of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(n,t,e)&&(i=!0);return i&&(this.metroGraphData.Initialize(!1),eo.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),i}GlueCollinearNeighborsSPN(e,t,i){if(e.Neighbors.length<=1)return!1;let n=new nf,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],n,i);if(n.isEmpty)return!1;for(let a of n)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,i,n,o){if(m.anglePCP(t.Position,e.Position,i.Position)<this.bundlingSettings.AngleThreshold){let l=je(t.Position,e.Position),u=je(i.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,i)){this.AddEdgeToGlue(e,i,t,t.Position,n);return}}else if(this.EdgeGluingIsAllowedSSS(e,i,t)){this.AddEdgeToGlue(e,t,i,i.Position,n);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,i);this.EdgeGluingIsAllowedSSSP(e,t,i,h)&&this.AddEdgeToGlue(e,i,t,h,n)}}}ConstructGluingPoint(e,t,i){let n=Math.min(je(t.Position,e.Position),je(i.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(i.Position.sub(e.Position).normalize());return e.Position.add(o.mul(n/2))}EdgeGluingIsAllowedSSS(e,t,i){if(t.IsReal||i.IsReal||!wl(t.getELP(),i.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,i,t.Position,i.Position))return!1;let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,i);return!(He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(D.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||He.IntersectionsOfLineAndRectangleNodeOverPolylineLR(D.mkPP(t.Position,i.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,i,n){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(n,0,Kn(t.getELP(),i.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(i,null,i.Position,n)||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,n)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,i,n){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-je(e.Position,i.Position)-je(e.Position,t.Position)+je(e.Position,n)+je(n,t.Position)+je(n,i.Position);o+=Br.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,i).Metrolines){let f=d.Length,p=d.Length-je(e.Position,i.Position)+je(e.Position,n)+je(n,i.Position);o+=Br.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let f=d.Length,p=d.Length-je(e.Position,t.Position)+je(e.Position,n)+je(n,t.Position);o+=Br.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Yt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,i,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=Br.RError(h,c,this.bundlingSettings)),u>je(e.Position,n)&&!e.IsReal&&(o-=Br.RError(u,je(e.Position,n),this.bundlingSettings)),o}AddEdgeToGlue(e,t,i,n,o){o.has(i,e)||o.has(t,e)||o.has(e,i)||o.has(e,t)||(o.set(e,i,n),o.set(e,t,n))}GlueEdge(e){let t=e[0],i=e[1],n=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(i.Position)?this.SplitPolylinePoint(o,n):o.prev!=null&&o.prev.point.equal(i.Position)&&this.SplitPolylinePoint(o.prev,n)}SplitPolylinePoint(e,t){if(e.point===t||e.next.point===t)return;let i=Ut.mkFromPoint(t);i.polyline=e.polyline,i.next=e.next,i.prev=e,i.next.prev=i,i.prev.next=i}RelaxConstrainedEdges(){let e=new nt,t=!1;for(let i of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(i[0],i[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),eo.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*n/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(je(e.Position,c[1]),je(t.Position,c[1])),d=je(e.Position,t.Position);if(h/d<.1)continue;let p=je(c[0],c[1]);(l===-1||p<l)&&(l=p,u=c[1])}if(l===-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,Kn(e.getELP(),t.getELP())))return!1;i.add(u),i.add(e.Position),i.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new wa(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),eo.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var Bc=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,i.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new _r;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!Bc.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!Bc.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof xr}ProcessNeighbor(e,t,i){let n=t.Length,o=this._current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var aS=class extends ye{constructor(e,t,i,n,o,a,l,u,c,h){super(null);this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=e,this.regularEdges=e.filter(d=>d.source!==d.target),this.VisibilityGraph=i,this.shortestPathRouter=t,this.LoosePadding=o,this.LooseHierarchy=l,this.TightHierarchy=a,this.EdgeLooseEnterable=u,this.EdgeTightEnterable=c,this.loosePolylineOfPort=h,Yp(0)}ThereAreOverlaps(e){return Ki(e,e,L.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let e=new nS(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.CdtProperty,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);Ns.FixRouting(e,this.bundlingSettings),new La(e,this.bundlingSettings).run()}FixChildParentEdges(){for(let e of this.regularEdges){let t=e.sourcePort,i=e.targetPort;if(t.Curve.boundingBox.containsRect(i.Curve.boundingBox)){let n=L.intersectionOne(t.Curve,D.mkPP(e.curve.start,e.curve.end),!1),o=e.curve;o.startPoint.point=n.x}if(i.Curve.boundingBox.containsRect(t.Curve.boundingBox)){let n=L.intersectionOne(i.Curve,D.mkPP(e.curve.start,e.curve.end),!0),o=e.curve;o.endPoint.point=n.x}}}static CreateConstrainedDelaunayTriangulation(e){let t=Array.from(e.GetAllLeaves()),i=e.irect,n=i.diagonal/4,o=i.clone();return o.pad(n),aS.GetConstrainedDelaunayTriangulation(t.concat([o.perimeter()]))}static GetConstrainedDelaunayTriangulation(e){let t=new ht(null,e,null);return t.run(),t}FixLocationsForHookAnywherePorts(e){for(let t of e){let i=t.sourcePort instanceof qt;if(i){let n=t.sourcePort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.targetPort,t))}else if(i=t.targetPort instanceof qt,i){let n=t.targetPort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.sourcePort,t))}}}FigureOutHookLocation(e,t,i){return t instanceof Or?this.FigureOutHookLocationForClusterOtherPort(e,t,i):this.FigureOutHookLocationForSimpleOtherPort(e,t,i)}FigureOutHookLocationForClusterOtherPort(e,t,i){let n=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),a=new Bc(Array.from(t.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(e).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let l of n)l.IsTransparent=!1;return a[a.length-1].point}FigureOutHookLocationForSimpleOtherPort(e,t,i){let n=t.Location,o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),l=new ma(this.VisibilityGraph.FindVertex(n),Array.from(e).map(u=>this.VisibilityGraph.FindVertex(u)),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.CdtProperty!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let e=new Map;this.shortestPathRouter.FillCrossedCdtEdges(e);let t=this.GetPathsOnCdtEdge(e);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(t)}GetPathsOnCdtEdge(e){let t=new Map;for(let i of e.keys())for(let n of e.get(i))Ll(t,n,i);return t}CalculateEdgeWidthShrinkCoeff(e){let t=0,i=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(e,i))return i;let n=!1;for(;!n||Math.abs(i-t)>.01;){let o=(t+i)/2;this.EdgeSeparationIsOkMN(e,o)?(t=o,n=!0):i=o}return t}EdgeSeparationIsOkMN(e,t){for(let i of e.keys())if(!this.EdgeSeparationIsOk(i,e.get(i),t))return!1;return!0}EdgeSeparationIsOk(e,t,i){return Array.from(t).map(o=>this.bundlingSettings.ActualEdgeWidth(o,i)).reduce((o,a)=>o+a,0)<=e.Capacity}RouteSelfEdges(){for(let e of this.edgesToRoute)if(e.source===e.target){let t={smoothedPolyline:null};e.curve=Xe.RouteSelfEdge(e.source.boundaryCurve,this.LoosePadding*2,t)}}FixArrowheads(){for(let e of this.edgesToRoute)rr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}},$n=aS;$n.SuperLoosePaddingCoefficient=1.1;var lS=class{constructor(e,t,i){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=i}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var uS=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source===this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var to=class{constructor(e,t,i){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.CdtProperty=t,this.Gates=i}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let i of t.InEdges){let n=new lS(i,this.VisibilityVerticesToSdVerts.get(i.Source),this.VisibilityVerticesToSdVerts.get(i.Target)),o=this.VisibilityVerticesToSdVerts.get(i.Source);e.InBoneEdges.push(n),o.OutBoneEdges.push(n)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new uS(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new re,i=this.EdgesToRouteSources.get(e);t.addPoint(i.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(i.Point)?(t.addPoint(a.TargetPoint),i=a.Target):(t.addPoint(a.SourcePoint),i=a.Source);e.curve=t,e.sourcePort instanceof Or&&to.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof Or&&to.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let i=t.closestParameter(e.end);e.addPoint(t.value(i))}static ExtendPolylineStartToClusterBoundary(e,t){let i=t.closestParameter(e.start);e.PrependPoint(t.value(i))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.CdtProperty!=null&&this.CdtProperty.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let i of t)i.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let n=0;n<this.vertexArray.length;n++){let o=this.vertexArray[n];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),i=this.RouteEdgeWithGroups();for(let n of t)n.IsTransparent=!1;return i}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new _r,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e===0);if(t!=null)return t;for(let i=0;i<this.vertexArray.length;i++)this.vertexArray[i].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let i={priority:0},n=this.Queue.DequeueAndGetPriority(i);if(!(i.priority>=this.LowestCostToTarget)){for(let o=0;o<n.OutBoneEdges.length;o++){let a=n.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(n,a,e,t)}for(let o=0;o<n.InBoneEdges.length;o++){let a=n.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(n,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,i,n){n&&i.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,i,n){n&&i.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,i){let n=this.GetEdgeAdditionalCost(i,e.Cost);if(!(t.Cost<=n))if(t.Cost=n,t.PrevEdge=i,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,n);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof Or&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),n+o<this.LowestCostToTarget&&(this.LowestCostToTarget=n+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.CdtProperty!=null&&this.BundlingSettings.CapacityOverflowCoefficient!==0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity===t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let i=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*i+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*i)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.CdtProperty==null||this.BundlingSettings.CapacityOverflowCoefficient===0)return 0;let t=0;for(let i of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,i);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,i=e.Source.Triangle,n=new Set,o=e.TargetPoint;if(ht.PointIsInsideOfTriangle(o,i))return n;let a=new $l(i,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&n.add(l)}return n}static CostOfCrossingCdtEdge(e,t,i,n){let o=i.lineWidth*t.edgeWidthShrinkCoeff;n.Capacity!==n.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=n.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,i,n){return this.AdjacentToSourceOrTarget(n)?0:to.CostOfCrossingCdtEdge(e,t,i,n)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner===this.sourceLoosePoly||e.lowerSite.Owner===this.sourceLoosePoly||e.upperSite.Owner===this.targetLoosePoly||e.lowerSite.Owner===this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let i;if(e instanceof Or){i=e.LoosePolyline;for(let o of i){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof qt){i=e.LoosePolyline;for(let o of i)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let n=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=n[0].boundingBox.diagonal;i=n[0];for(let a=1;a<n.length;a++){let l=n[a],u=l.boundingBox.diagonal;u<o&&(o=u,i=l)}}return i}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,i){let n=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(n);t?(o.IsSourceOfRouting=!0,o.Cost=i,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.CdtProperty!=null&&(this.capacityOverlowPenaltyMultiplier=to.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)to.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.Constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,i=e.lowerSite.Owner;if(t!==i){let n=hr.DistancePoint(new hr(t),e.lowerSite.point),o=hr.DistancePoint(new hr(i),e.upperSite.point);e.Capacity=(n+o)/2}}SetVertexTriangles(){let e=rt(Array.from(this.CdtProperty.GetTriangles()).map(i=>gt(i,i.BoundingBox()))),t=rt(this.vertexArray.map(i=>gt(i,W.mkOnPoints([i.Point]))));Qr(e,t,(i,n)=>this.TryToAssigenTriangleToVertex(i,n));for(let i of this.vertexArray);}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&ht.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let i of this.EdgesToRoutes.get(t))for(let n of this.CrossedCdtEdgesOfBoneEdge(i))this.AdjacentToSourceOrTarget(n)||Ll(e,t,n)}}};var Dc=class{constructor(e,t,i,n,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=Pd(i,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new $n(e.edges,new to(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(i,n)=>L.PointRelativeToCurveLocation(i,n)!==0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,i={preGraphs:e};if(this.UniteConnectedPreGraphs(i),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=Dc.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let i=Wn(t),n=new Array;for(let o of i){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],n.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=n;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let i of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(i)}static GetIntersectionGraphOfPreGraphs(e){let t=Dc.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?Sr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),i=Pd(t,o=>e[o].boundingBox),n=new Array;return Xt(i,i,(o,a)=>n.push(new Se(o,a))),n}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,i=e[0],n=this.GetPortCurve(i.sourcePort),o=n.boundingBox;t.add(n),t.add(i.targetPort.Curve),o.addRec(i.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return tf.constructorStatic(e,t)}};var ut=class extends ye{constructor(e,t,i=2,n=1.5,o=30*(Math.PI/180),a=null,l=null){super(l);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.portLocationsToLoosePolylines=new bt;this.multiEdgesSeparation=5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this._edges=t,this.BundlingSettings=a,this.geomGraph=e,this.LoosePadding=n,this.tightPadding=i,this.coneAngle=o}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(e){this.continueOnOverlaps=e}*edges(){if(this._edges!=null)for(let e of this._edges)yield e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(e){this.multiEdgesSeparation=e}static mk2(e,t){return ut.mk5(e,t.Padding,t.PolylinePadding,t.ConeAngle,t.bundlingSettings)}static mk4(e,t,i,n){return new ut(e,Array.from(e.edges()),t,i,n,null)}static mk5(e,t,i,n,o){return new ut(e,Array.from(e.edges()),t,i,n,o)}static mk6(e,t,i,n,o,a){let l=ut.mk4(e,t,i,n),u=Yi.GetShapes(o,a);return l.Initialize(u,n),l}Initialize(e,t){this.rootShapes=e.filter(i=>i.Parents==null||i.Parents.length===0),this.coneAngle=t,this.coneAngle===0&&(this.coneAngle=Math.PI/6)}run(){if(this.geomGraph.isEmpty())return;let e=Jr.GetShapes(this.geomGraph,this._edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings.bundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.edgeRoutingSettings.bundlingSettings),this.Initialize(e,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[e,t]of this.portsToShapes){let i=new Set;ut.EdgesAttachedToPortAvoidTheNode(e)||i.add(t),this.portsToEnterableShapes.set(e,i)}for(let e of this.rootShapes)for(let t of e.Descendants())for(let i of t.Ports){let n=this.portsToEnterableShapes.get(i);gc(n,Array.from(t.Ancestors()).filter(o=>o.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(e){return e instanceof Rr||e instanceof Or}SetLoosePolylinesForAnywherePorts(){for(let[e,t]of this.shapesToTightLooseCouples)for(let i of e.Ports){if(i instanceof qt){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}if(i instanceof Or){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new Cs;for(let e of this.root.Children){let t=this.shapesToTightLooseCouples.get(e).LooseShape;this.BindLooseShapesUnderShape(e),this.looseRoot.AddChild(t)}}BindLooseShapesUnderShape(e){let t=this.shapesToTightLooseCouples.get(e).LooseShape;for(let i of e.Children){let n=this.shapesToTightLooseCouples.get(i).LooseShape;t.AddChild(n),this.BindLooseShapesUnderShape(i)}}CalculateShapeToBoundaries(e){if(this.ProgressStep(),e.Children.length===0)return;for(let i of e.Children)this.CalculateShapeToBoundaries(i);let t=new _d(e,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples);t.Calculate(),this.OverlapsDetected||(this.OverlapsDetected=t.OverlapsDetected)}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(e){this._overlapsDetected=e}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*$n.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let e=new Array;for(let t of this._edges){let i=this.EdgePassport(t),n=e.find(o=>wl(o.passport,i));n||(n={passport:i,edges:[]},e.push(n)),n.edges.push(t)}return e}RouteOnVisGraph(){if(this.ancestorSets=ut.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let e of this.GroupEdgesByPassport()){let t=e.passport,i=this.GetObstaclesFromPassport(t),n=this.CreateInteractiveEdgeRouter(Array.from(i));this.RouteEdgesWithTheSamePassport(e,n,i)}else this.RouteBundles()}RouteEdgesWithTheSamePassport(e,t,i){let n={regularEdges:[],multiEdges:[]};if(this.RouteMultiEdgesAsBundles){this.SplitOnRegularAndMultiedges(e.edges,n);for(let o of n.regularEdges)this.RouteEdge(t,o);n.multiEdges!=null&&(this.ScaleDownLooseHierarchy(t,i),this.RouteMultiEdges(n.multiEdges,t,e.passport))}else for(let o of e.edges)this.RouteEdge(t,o)}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}RouteEdge(e,t){let i=this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(t);this.ProgressStep(),this.RouteEdgeInternal(t,e),ut.SetTransparency(i,!1)}ScaleDownLooseHierarchy(e,t){let i=new Array;for(let n of t){let o=this.shapesToTightLooseCouples.get(n);i.push(dr.LoosePolylineWithFewCorners(o.TightPolyline,o.Distance/1.1))}e.LooseHierarchy=ut.CreateLooseObstacleHierarachy(i),e.ClearActivePolygons(),e.AddActivePolygons(i.map(n=>new hr(n)))}RouteMultiEdges(e,t,i){let n=[];for(let l of i)for(let u of l.Children)n.push(u.BoundaryCurve);let o=new jn;o.InkImportance=1e-5,o.EdgeSeparation=this.MultiEdgesSeparation,new Dc(e,t,n,o,l=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(l)).run()}SplitOnRegularAndMultiedges(e,t){let i=new ko;for(let n of e)ut.IsEdgeToParent(n)?t.regularEdges.push(n):ut.RegisterInPortLocationsToEdges(n,i);t.multiEdges=null;for(let n of i.values())n.length===1||this.OverlapsDetected?No(t.regularEdges,n):(t.multiEdges==null&&(t.multiEdges=new Array),t.multiEdges.push(n))}static RegisterInPortLocationsToEdges(e,t){let i,n=new _t(e.sourcePort.Location,e.targetPort.Location);i=t.get(n),i||(i=new Array,t.set(n,i)),i.push(e)}static IsEdgeToParent(e){return e.sourcePort instanceof qt||e.targetPort instanceof qt}CreateInteractiveEdgeRouter(e){let t=new Set(e.map(n=>this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve)),i=new He(this.cancelToken);return i.ObstacleCalculator=new dr(e.map(n=>n.BoundaryCurve),this.tightPadding,this.loosePadding,!1),i.VisibilityGraph=this.visGraph,i.TightHierarchy=this.CreateTightObstacleHierarachy(e),i.LooseHierarchy=ut.CreateLooseObstacleHierarachy(Array.from(t)),i.UseSpanner=!0,i.LookForRoundedVertices=!0,i.TightPadding=this.tightPadding,i.LoosePadding=this.LoosePadding,i.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,i.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,i.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,i.AllowedShootingStraightLines=this.AllowedShootingStraightLines,i.AddActivePolygons(Array.from(t).map(n=>new hr(n))),i}GetObstaclesFromPassport(e){if(e.size===0)return new Set(this.root.Children);let t=this.GetCommonAncestorsAbovePassport(e),i=this.GetAllAncestors(e),n=new Set;for(let l of e)for(let u of l.Children)i.has(u)||n.add(u);let o=Yn(new Set(e),n),a=new uT.Queue;for(let l of e)t.has(l)||a.enqueue(l);for(;a.length>0;){let l=a.dequeue();for(let u of l.Parents){for(let c of u.Children)i.has(c)||n.add(c);!t.has(u)&&!o.has(u)&&(a.enqueue(u),o.add(u))}}return n}GetAllAncestors(e){if(e.size===0)return new Set;let t=new Set(e);for(let i of e)t=Yn(t,this.ancestorSets.get(i));return t}GetCommonAncestorsAbovePassport(e){if(e.size===0)return new Set;let t=Array.from(e),i=this.ancestorSets.get(t[0]);for(let n=1;n<t.length;n++){let o=t[n];i=Kn(i,this.ancestorSets.get(o))}return i}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let e=this.GetLooseHierarchy(),t=$n.CreateConstrainedDelaunayTriangulation(e),i=new to(o=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(o),t,this.FindCdtGates(t));new $n(this._edges,i,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),e,this.enterableLoose,this.enterableTight,o=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(o))).run()}CreateTheMapToParentLooseShapes(e,t){for(let i of e.Children){let o=this.shapesToTightLooseCouples.get(i).LooseShape.BoundaryCurve;t.set(o,e),this.CreateTheMapToParentLooseShapes(i,t)}}FindCdtGates(e){let t=new Map;this.CreateTheMapToParentLooseShapes(this.root,t);let i=new Set;for(let n of e.PointsToSites.values())for(let o of n.Edges){if(o.CwTriangle==null&&o.CcwTriangle==null)continue;let a=n.Owner,l=o.lowerSite.Owner;if(a===l)continue;let u=t.get(a);if(u){let c=t.get(l);u===c&&i.add(o)}}return i}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let e of this.edges()){let t=new Set,i=new Set;this.GetEdgeEnterablePolylines(e,t,i),this.enterableLoose.set(e,t),this.enterableTight.set(e,i)}}GetEdgeEnterablePolylines(e,t,i){let n=this.portsToShapes.get(e.sourcePort),o=this.portsToShapes.get(e.targetPort);n!==this.root&&this.GetEnterablesForShape(n,t,i),o!==this.root&&this.GetEnterablesForShape(o,t,i)}GetEnterablesForShape(e,t,i){for(let n of this.ancestorSets.get(e)){let o=this.LoosePolyOfOriginalShape(n);o&&t.add(o);let a=this.TightPolyOfOriginalShape(n);a&&i.add(a)}}GetTightHierarchy(){return rt(Array.from(this.shapesToTightLooseCouples.values()).map(e=>gt(e.TightPolyline,e.TightPolyline.boundingBox)))}GetLooseHierarchy(){let e=new Set;for(let t of this.shapesToTightLooseCouples.values())e.add(t.LooseShape.BoundaryCurve);return rt(Array.from(e).map(t=>gt(t,t.boundingBox)))}ScaleLooseShapesDown(){for(let[,e]of this.shapesToTightLooseCouples)e.LooseShape.BoundaryCurve=dr.LoosePolylineWithFewCorners(e.TightPolyline,e.Distance/$n.SuperLoosePaddingCoefficient)}EdgePassport(e){let t=new Set,i=this.portsToShapes.get(e.sourcePort),n=this.portsToShapes.get(e.targetPort);return this.IsAncestor(i,n)?(gc(t,n.Parents),t.add(i),t):this.IsAncestor(n,i)?(gc(t,i.Parents),t.add(n),t):(i!==this.looseRoot&&gc(t,i.Parents),n!==this.looseRoot&&gc(t,n.Parents),t)}*AllPorts(){for(let e of this.edges())yield e.sourcePort,yield e.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let e of this.root.Descendants())for(let t of e.Ports)this.portsToShapes.set(t,e);for(let e of this.AllPorts())this.portsToShapes.has(e)||(this.root.Ports.add(e),this.portsToShapes.set(e,this.root))}RouteEdgeInternal(e,t){let i=new Array;e.sourcePort instanceof qt||No(i,this.AddVisibilityEdgesFromPort(e.sourcePort)),e.targetPort instanceof qt||No(i,this.AddVisibilityEdgesFromPort(e.targetPort));let n={smoothedPolyline:null};if(m.closeDistEps(e.sourcePort.Location,e.targetPort.Location)?e.curve=Xe.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.LoosePadding*2,e.GetMaxArrowheadLength()),n):e.curve=t.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e.sourcePort,e.targetPort,!0,n),e.smoothedPolyline=n.smoothedPolyline,e.curve==null)throw new Error;for(let o of i)et.RemoveEdge(o);rr.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!1)}*AddVisibilityEdgesFromPort(e){let t,i;if(e instanceof Rr||!(t=this.portsToShapes.get(e))||!(i=this.shapesToTightLooseCouples.get(t)))return;let n=i.LooseShape;for(let o of n.BoundaryCurve)this.visGraph.FindEdgePP(e.Location,o)==null&&(yield this.visGraph.AddEdgePP(e.Location,o))}MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(e){let t=this.portsToShapes.get(e.sourcePort),i=this.portsToShapes.get(e.targetPort),n=new Array;for(let o of this.GetTransparentShapes(e.sourcePort,e.targetPort,t,i))o!=null&&n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.sourcePort))n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.targetPort))n.push(this.LooseShapeOfOriginalShape(o));return ut.SetTransparency(n,!0),n}LooseShapeOfOriginalShape(e){return e===this.root?this.looseRoot:this.shapesToTightLooseCouples.get(e).LooseShape}LoosePolyOfOriginalShape(e){return this.LooseShapeOfOriginalShape(e).BoundaryCurve}TightPolyOfOriginalShape(e){return e===this.root?null:this.shapesToTightLooseCouples.get(e).TightPolyline}*GetTransparentShapes(e,t,i,n){for(let o of this.ancestorSets.get(i))yield o;for(let o of this.ancestorSets.get(n))yield o;ut.EdgesAttachedToPortAvoidTheNode(e)||(yield i),ut.EdgesAttachedToPortAvoidTheNode(t)||(yield n)}static SetTransparency(e,t){for(let i of e)i.IsTransparent=t}IsAncestor(e,t){let i;return t!=null&&(i=this.ancestorSets.get(t))!=null&&i.has(e)}static CreateLooseObstacleHierarachy(e){return rt(e.map(t=>gt(t,t.boundingBox)))}CreateTightObstacleHierarachy(e){let t=e.map(i=>this.shapesToTightLooseCouples.get(i).TightPolyline);return rt(t.map(i=>gt(i,i.boundingBox)))}CalculateVisibilityGraph(){let e=this.LineSweeperPorts!=null?nt.mk(this.LineSweeperPorts):new nt;this.ProcessHookAnyWherePorts(e),this.portRTree=Oo(Array.from(e.values()).map(t=>[W.rectangleOnPoint(t),t])),this.visGraph=new et,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(e,t,i,n=null,o=null){let a=Array.from(t.Edges).map(l=>be.mkDebugCurveTWCI(100,1,l.IsPassable!=null&&l.IsPassable()?"green":"black",D.mkPP(l.SourcePoint,l.TargetPoint)));if(i!=null)for(let l of i){a.push(be.mkDebugCurveTWCI(100,.3,"brown",l));for(let u of l)a.push(be.mkDebugCurveTWCI(100,1,"green",we.mkCircle(1,u)))}if(n!=null)for(let l of n)a.push(be.mkDebugCurveTWCI(100,10,"navy",l));if(o!=null)for(let l of o)a.push(be.mkDebugCurveTWCI(100,10,"red",l))}ProcessHookAnyWherePorts(e){for(let t of this.edges())t.sourcePort instanceof qt||t.sourcePort instanceof Or||e.add(t.sourcePort.Location),t.targetPort instanceof qt||t.targetPort instanceof Or||e.add(t.targetPort.Location)}FillVisibilityGraphUnderShape(e){let t=e.Children;for(let h of t)this.FillVisibilityGraphUnderShape(h);let i=this.shapesToTightLooseCouples.get(e),n=i?i.LooseShape.BoundaryCurve:null,o=i?i.LooseShape:this.looseRoot,a=new Set(o.Children.map(h=>h.BoundaryCurve)),l=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(n),u=new et,c=ga.mk([],u,this.coneAngle,l,n);c.run(),u=new et,c=ga.mk(Array.from(a),u,this.coneAngle,l,n),c.run(),this.ProgressStep();for(let h of u.Edges)this.TryToCreateNewEdgeAndSetIsPassable(h,o);this.AddBoundaryEdgesToVisGraph(n)}get Bidirectional(){return this.bidirectional}set Bidirectional(e){this.bidirectional=e}TryToCreateNewEdgeAndSetIsPassable(e,t){let i=this.visGraph.FindEdgePP(e.SourcePoint,e.TargetPoint);i==null&&(i=this.visGraph.AddEdgePP(e.SourcePoint,e.TargetPoint),t!=null&&(i.IsPassable=()=>t.IsTransparent))}AddBoundaryEdgesToVisGraph(e){if(e==null)return;let t;for(let i=e.startPoint;t=i.nextOnPolyline,this.visGraph.AddEdgePP(i.point,t.point),t!==e.startPoint;i=t);}RemoveInsidePortsAndSplitBoundaryIfNeeded(e){let t=new nt;if(e==null){for(let o of this.portRTree.GetAllLeaves())t.add(o);return this.portRTree.Clear(),t}let i=e.boundingBox,n=this.portRTree.GetAllIntersecting(i);for(let o of n)switch(L.PointRelativeToCurveLocation(o,e)){case 2:t.add(o),this.portLocationsToLoosePolylines.set(o,e),this.portRTree.Remove(W.rectangleOnPoint(o),o);break;case 1:this.portRTree.Remove(W.rectangleOnPoint(o),o),this.portLocationsToLoosePolylines.set(o,e);let a=ut.FindPointOnPolylineToInsertAfter(e,o);if(a!=null)jt.InsertPointIntoPolylineAfter(e,a,o);else throw new Error;break}return t}static FindPointOnPolylineToInsertAfter(e,t){for(let i=e.startPoint;;){let n=i.nextOnPolyline;if(m.closeDistEps(t,i.point)||m.closeDistEps(t,n.point))return null;let o=m.distToLineSegment(t,i.point,n.point).dist;if(le(o,0))return i;if(i=n,i===e.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length===1){let e=this.rootShapes[0];if(e.BoundaryCurve==null){this.root=e;return}}this.rootWasCreated=!0,this.root=new Cs(null);for(let e of this.rootShapes)this.root.AddChild(e)}RemoveRoot(){if(this.rootWasCreated)for(let e of this.rootShapes)e.RemoveParent(this.root)}static GetAncestorSetsMap(e){let t=new Map;for(let i of e.filter(n=>!t.has(n)))t.set(i,ut.GetAncestorSet(i,t));return t}static GetAncestorSet(e,t){let i=new Set(e.Parents);for(let n of e.Parents){let o=t.get(n);o||t.set(n,o=ut.GetAncestorSet(n,t));for(let a of o)i.add(a)}return i}static CreatePortsIfNeeded(e){for(let t of e){if(t.sourcePort==null){let i=t;new ji(()=>i.source.boundaryCurve,()=>i.source.center,new m(0,0))}if(t.targetPort==null){let i=t;new ji(()=>i.target.boundaryCurve,()=>i.target.center,new m(0,0))}}}static ComputeLooseSplinePadding(e,t){let i=2*t;return(e-i)/8}};function rT(s,e,t){let i=$0(s);new ut(s,e,i.Padding,i.PolylinePadding,i.coneAngle,i.bundlingSettings,t).run()}function iT(s,e,t){if(e)for(let i of e){if(t&&t.canceled)return;ii.RouteEdge(i,s.padding)}else for(let i of s.deepNodesIt()){if(t&&t.canceled)return;for(let n of i.outEdges())n.curve==null&&ii.RouteEdge(n,s.padding);for(let n of i.selfEdges())n.curve==null&&ii.RouteEdge(n,s.padding)}}var ii=class extends ye{constructor(e,t){super(null);this.edges=e,this.padding=t}run(){ut.CreatePortsIfNeeded(this.edges);for(let e of this.edges)ii.RouteEdge(e,this.padding)}static RouteEdge(e,t){let i=e;i.sourcePort==null&&(i.sourcePort=ji.mk(()=>e.source.boundaryCurve,()=>e.source.center)),i.targetPort==null&&(i.targetPort=ji.mk(()=>e.target.boundaryCurve,()=>e.target.center)),ii.ContainmentLoop(i,t)||(i.curve=ii.GetEdgeLine(e)),rr.trimSplineAndCalculateArrowheadsII(i,i.sourcePort.Curve,i.targetPort.Curve,e.curve,!1)}static ContainmentLoop(e,t){let i=e.sourcePort.Curve,n=e.targetPort.Curve;if(i==null||n==null)return!1;let o=i.boundingBox,a=n.boundingBox,l=o.containsRect(a),u=!l&&a.containsRect(o);return l||u?(e.curve=ii.CreateLoop(o,a,u,t),!0):!1}static CreateLoop(e,t,i,n){return i?ii.CreateLoop_(e,t,n,!1):ii.CreateLoop_(t,e,n,!0)}static CreateLoop_(e,t,i,n){let o=e.center,a=ii.FindClosestPointOnBoxBoundary(e.center,t),l=a.sub(o),c=(Math.abs(l.x)<A.distanceEpsilon?Math.min(o.y-t.bottom,t.top-o.y):Math.min(o.x-t.left,t.right-o.x))/2,h=Math.min(i,c);l.length<=A.distanceEpsilon&&(l=new m(1,0));let d=l.normalize(),f=d.rotate(Math.PI/2),p=a.add(d.mul(i)),S=p.add(f.mul(h)),x=a.add(f.mul(h)),T=o.add(f.mul(h));return(n?xt.mkFromPoints([T,x,S,p,a,o]):xt.mkFromPoints([o,a,p,S,x,T])).createCurve()}static FindClosestPointOnBoxBoundary(e,t){let i=e.x-t.left<t.right-e.x?t.left:t.right,n=e.y-t.bottom<t.top-e.y?t.bottom:t.top;return Math.abs(i-e.x)<Math.abs(n-e.y)?new m(i,e.y):new m(e.x,n)}static GetEdgeLine(e){let t,i;e.sourcePort==null?(t=e.source.center,i=e.source.boundaryCurve):(t=e.sourcePort.Location,i=e.sourcePort.Curve);let n,o;e.targetPort==null?(n=e.target.center,o=e.target.boundaryCurve):(n=e.targetPort.Location,o=e.targetPort.Curve);let a=D.mkPP(t,n),l=L.getAllIntersections(i,a,!1);if(l.length>0){let u=a.trim(l[0].par1,1);u instanceof D&&(a=u,l=L.getAllIntersections(o,a,!1),l.length>0&&(u=a.trim(0,l[0].par1),u instanceof D&&(a=u)))}return a}static CreateSimpleEdgeCurveWithUnderlyingPolyline(e){let t=e.source.center,i=e.target.center;if(e.source===e.target){let n=2/(3*e.source.boundaryCurve.boundingBox.width),o=e.source.boundingBox.height/4;e.underlyingPolyline=ii.CreateUnderlyingPolylineForSelfEdge(t,n,o),e.curve=e.underlyingPolyline.createCurve()}else e.underlyingPolyline=xt.mkFromPoints([t,i]),e.curve=e.underlyingPolyline.createCurve();rr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(e,t,i){let n=e.add(new m(0,i)),o=e.add(new m(t,i)),a=e.add(new m(t,i*-1)),l=e.add(new m(0,i*-1)),u=at.mkSiteP(e),c=new xt(u);return u=at.mkSiteSP(u,n),u=at.mkSiteSP(u,o),u=at.mkSiteSP(u,a),u=at.mkSiteSP(u,l),at.mkSiteSP(u,e),c}static SetStraightLineEdgesWithUnderlyingPolylines(e){ut.CreatePortsIfNeeded(Array.from(e.edges()));for(let t of e.edges())ii.CreateSimpleEdgeCurveWithUnderlyingPolyline(t)}};var Zn=class extends ye{constructor(e,t,i,n,o,a){super(null);this.settings=e,this.OriginalGraph=t,this.Database=i,this.ProperLayeredGraph=o,this.LayerArrays=n,this.IntGraph=a}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){for(let e of this.OriginalGraph.deepNodesIt())for(let t of e.outEdges())t.curve||ii.RouteEdge(t,Math.max(t.source.padding,t.target.padding))}RouteFlatEdges(){}createRegularSplines(){for(let e of this.Database.RegularMultiedges()){let t=e.length,i=t===1&&!this.FanAtSourceOrTarget(e[0]);for(let n=Math.floor(t/2);n<t;n++)this.createSplineForNonSelfEdge(e[n],i);for(let n=Math.floor(t/2)-1;n>=0;n--)this.createSplineForNonSelfEdge(e[n],i)}}FanAtSourceOrTarget(e){return this.ProperLayeredGraph.OutDegreeIsMoreThanOne(e.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(e.target)}createSelfSplines(){for(let[e,t]of this.Database.Multiedges.keyValues()){let i=e;if(i.x===i.y){let n=this.Database.Anchors[i.x],o=n.leftAnchor;for(let a of t){let l=this.settings.NodeSeparation+(this.settings.MinNodeWidth+o),u=n.bottomAnchor/2,c=n.origin,h=c.add(new m(0,u)),d=c.add(new m(l,u)),f=c.add(new m(l,u*-1)),p=c.add(new m(0,u*-1)),S=at.mkSiteP(c),x=new xt(S);S=at.mkSiteSP(S,h),S=at.mkSiteSP(S,d),S=at.mkSiteSP(S,f),S=at.mkSiteSP(S,p),at.mkSiteSP(S,c);let T=x.createCurve();if(a.curve=T,a.edge.underlyingPolyline=x,o=l,a.edge.label!=null){o+=a.edge.label.width;let O=T.value((T.parStart+T.parEnd)/2),M=new m(O.x+a.labelWidth/2,n.y),R=new m(a.edge.label.width/2,a.edge.label.height/2),N=W.mkPP(M.add(R),M.sub(R));a.edge.label.width=N.width,a.edge.label.height=N.height,a.edge.label.positionCenter(M)}rr.trimSplineAndCalculateArrowheadsII(a.edge,a.edge.source.boundaryCurve,a.edge.target.boundaryCurve,T,!1)}}}}createSplineForNonSelfEdge(e,t){e.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(e,t),e.IsVirtualEdge||(e.updateEdgeLabelPosition(this.Database.Anchors),rr.trimSplineAndCalculateArrowheadsII(e.edge,e.edge.source.boundaryCurve,e.edge.target.boundaryCurve,e.curve,!0)))}drawSplineBySmothingThePolyline(e,t){let i=new Er(e,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),n=i.getSpline(t);e.reversed?(e.curve=n.reverse(),e.underlyingPolyline=i.Reverse().GetPolyline):(e.curve=n,e.underlyingPolyline=i.GetPolyline)}static UpdateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new m(t.x+t.rightAnchor/2,t.y)),i=D.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new m(t.x-t.leftAnchor/2,t.y)),i=D.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=Zn.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&L.getAllIntersections(e.curve,L.polyFromBox(e.labelBBox),!1).length===0){let o={curveClosestPoint:void 0,labelSideClosest:void 0};if(Zn.FindClosestPoints(o,n,i))Zn.ShiftLabel(e,o);else{let a=n.closestParameter(i.start),l=n.closestParameter(i.end);n.value(a).sub(i.start).length<n.value(l).sub(i.end).length?(o.curveClosestPoint=n.value(a),o.labelSideClosest=i.start):(o.curveClosestPoint=n.value(l),o.labelSideClosest=i.end),Zn.ShiftLabel(e,o)}}}static ShiftLabel(e,t){let i=e.lineWidth/2,n=t.curveClosestPoint.sub(t.labelSideClosest),o=n.length;o>i&&e.label.positionCenter(e.label.center.add(n.div(o*(o-i))))}static FindClosestPoints(e,t,i){let n=L.minDistWithinIntervals(t,i,t.parStart,t.parEnd,i.parStart,i.parEnd,(t.parStart+t.parEnd)/2,(i.parStart+i.parEnd)/2);return n?(e.curveClosestPoint=n.aX,e.labelSideClosest=n.bX,!0):!1}static GetSegmentInFrontOfLabel(e,t){if(e instanceof L){let i=e;for(let n of i.segs)if((n.start.y-t)*(n.end.y-t)<=0)return n}return null}static GetNodeKind(e,t){return e===0?0:e<t.count?1:2}};var ef=class extends ye{constructor(e,t,i){super(i);this.LayersAreDoubled=!1;if(e==null)return;this.originalGraph=e,this.sugiyamaSettings=t;let n=Array.from(e.shallowNodes);this.nodeIdToIndex=new Map;let o=0;for(let l of n)this.nodeIdToIndex.set(l.id,o++);let a=[];for(let l of this.originalGraph.edges()){let u=this.nodeIdToIndex.get(l.source.id);if(u==null)continue;let c=this.nodeIdToIndex.get(l.target.id);if(c==null)continue;let h=new Yr(u,c,l);a.push(h)}this.IntGraph=new ys(a,e.shallowNodeCount),this.IntGraph.nodes=n,this.database=new Cy(n.length);for(let l of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(l);this.cycleRemoval()}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount===0){this.originalGraph.boundingBox=W.mkEmpty();return}yB(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode===3&&this.runPostLayering(),SB(this.originalGraph,this.sugiyamaSettings.transform)}runPostLayering(){let e=this.sugiyamaSettings.commonLayoutSettings.edgeRoutingSettings;(this.constrainedOrdering!=null?0:e.EdgeRoutingMode)===3?this.calculateEdgeSplines():Zl(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let e=this.sugiyamaSettings.verticalConstraints,t=e.isEmpty?Ui.getFeedbackSet(this.IntGraph):e.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(t)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let e=this.CalculateLayerArrays();return this.UpdateNodePositionData(),e}UpdateNodePositionData(){for(let e=0;e<this.IntGraph.nodeCount&&e<this.database.Anchors.length;e++)this.IntGraph.nodes[e].center=this.database.Anchors[e].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let e=0;e<this.originalGraph.shallowNodeCount;e++)this.SnapLeftSidesOfTheNodeToGrid(e,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(e,t){let i=this.IntGraph.nodes[e],n=this.database.Anchors[e];n.leftAnchor-=t/2,n.rightAnchor-=t/2;let o=i.boundingBox.left,a=Math.floor(o/t),l=o-a*t;Math.abs(l)<.001||(Math.abs(l)<=t/2?i.center=i.center.add(new m(-l,0)):i.center=i.center.add(new m(t-l,0)),n.x=i.center.x)}GetCurrentHeight(){let e=new cn;for(let t of this.NodeAnchors())e.AddValue(t.top),e.AddValue(t.bottom);return e.length}*NodeAnchors(){let e=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let t=0;t<e;t++)yield this.anchors[t]}GetCurrentWidth(){let e=new cn;for(let t of this.NodeAnchors())e.AddValue(t.left),e.AddValue(t.right);return e.length}ExtendLayeringToUngluedSameLayerVertices(e){let t=this.verticalConstraints;for(let i=0;i<e.length;i++)e[i]=e[t.nodeToRepr(i)];return e}calculateEdgeSplines(){new Zn(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(e){let t=e.GetLayers();Ed.Balance(this.gluedDagSkeletonForLayering,t,this.GetNodeCountsOfGluedDag(),null),t=this.ExtendLayeringToUngluedSameLayerVertices(t);let i=new Hi(t);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return i=this.YLayeringAndOrderingWithoutHorizontalConstraints(i),i;throw new Error("not implemented")}CreateProperLayeredGraph(e){let t=e.length,i=0;for(let o of this.database.SkeletonEdges()){let a=uB(e,o);a>0&&(o.LayerEdges=new Array(a));let l=0;if(a>1){let u=t+i++,c=new Wi(o.source,u,o.CrossingWeight,o.weight);o.LayerEdges[l++]=c;for(let h=0;h<a-2;h++)u++,i++,c=new Wi(u-1,u,o.CrossingWeight,o.weight),o.LayerEdges[l++]=c;c=new Wi(u,o.target,o.CrossingWeight,o.weight),o.LayerEdges[l]=c}else if(a===1){let u=new Wi(o.source,o.target,o.CrossingWeight,o.weight);o.LayerEdges[l]=u}}let n=new Array(this.originalGraph.shallowNodeCount+i).fill(0);for(let o of this.database.SkeletonEdges())if(o.LayerEdges!=null){let a=e[o.source];n[o.source]=a--;for(let l of o.LayerEdges)n[l.Target]=a--}else n[o.source]=e[o.source],n[o.target]=e[o.target];return this.properLayeredGraph=new Xn(new ys(Array.from(this.database.SkeletonEdges()),e.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new Hi(n)}YLayeringAndOrderingWithoutHorizontalConstraints(e){let t=this.CreateProperLayeredGraph(e.y);return da.OrderLayers(this.properLayeredGraph,t,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),mc.UpdateLayerArrays1(this.properLayeredGraph,t),t}CalculateYLayers(){let e=this.YLayeringAndOrdering(new Uy(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?e:this.InsertLayersIfNeeded(e)}InsertLayersIfNeeded(e){this.InsertVirtualEdgesIfNeeded(e);let t=this.AnalyzeNeedToInsertLayersAndHasMultiedges(e);if(t.needToInsertLayers){let i=ca.InsertLayers(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la,this.LayersAreDoubled=!0}else if(t.multipleEdges){let i=Mo.InsertPaths(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la}return this.RecreateIntGraphFromDataBase(),e}RecreateIntGraphFromDataBase(){let e=new Array;for(let t of this.database.Multiedges.values())e=e.concat(t);this.IntGraph.SetEdges(e,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(e){if(this.constrainedOrdering==null){for(let[t,i]of this.database.Multiedges.keyValues())if(i.length%2===0&&e.y[t.x]-1===e.y[t.y]){let n=new Xe(null),o=new Yr(t.x,t.y,n);o.IsVirtualEdge=!0,i.splice(i.length/2,0,o),this.IntGraph.addEdge(o)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(e){let t=!1,i=!1;for(let n of this.IntGraph.edges)if(n.hasLabel&&e.y[n.source]!==e.y[n.target]){t=!0;break}if(t===!1&&this.constrainedOrdering==null){for(let[n,o]of this.database.Multiedges.keyValues())if(o.length>1&&(i=!0,e.y[n.x]-e.y[n.y]===1)){t=!0;break}}return{needToInsertLayers:t,multipleEdges:i}}UseBrandesXCalculations(e){return e.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(e){this.anchors=sB(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),aB(e,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let e=0;e<this.anchors.length;e++){let t=this.anchors[e];if(t.labelIsToTheRightOfTheSpline){let i=this.GetSuccessorAndPredecessor(e);if(!fB(t,i.predecessor,i.successor)){let n=i.predecessor.origin.sub(t.origin).length+i.successor.origin.sub(t.origin).length,o=t.right-t.leftAnchor,a=new m(o,t.y);i.predecessor.origin.sub(a).length+i.successor.origin.sub(a).length<n&&fT(t)}}}}GetSuccessorAndPredecessor(e){let t;for(let n of this.properLayeredGraph.InEdges(e))t=n.Source;let i;for(let n of this.properLayeredGraph.OutEdges(e))i=n.Target;return{predecessor:this.anchors[t],successor:this.anchors[i]}}CalculateLayerArrays(){let e=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(e),this.UseBrandesXCalculations(e)?this.CalculateXPositionsByBrandes(e):this.CalculateXLayersByGansnerNorth(e)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=e,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),e}StretchToDesiredAspectRatio(e,t){e>t?this.StretchInYDirection(e/t):e<t&&this.StretchInXDirection(t/e)}StretchInYDirection(e){let t=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let n of this.database.Anchors)n.bottomAnchor=n.bottomAnchor*e,n.topAnchor=n.topAnchor*e,n.y=t+e*(n.y-t);let i=this.originalGraph.height*e;this.originalGraph.boundingBox=new W({left:this.originalGraph.boundingBox.left,top:t+i/2,right:this.originalGraph.boundingBox.right,bottom:t-i/2})}StretchInXDirection(e){let t=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let n of this.database.Anchors)n.leftAnchor=n.leftAnchor*e,n.rightAnchor=n.rightAnchor*e,n.x=t+e*(n.x-t);let i=this.originalGraph.width*e;this.originalGraph.boundingBox=new W({left:t-i/2,top:this.originalGraph.boundingBox.top,right:t+i/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length===0)return;let e=new W({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let n=1;n<this.anchors.length;n++){let o=this.anchors[n];e.add(o.leftTop),e.add(o.rightBottom)}let t=e.leftTop.sub(e.rightBottom).length/2,i=new m(-t,t);e.add(e.leftTop.add(i)),e.add(e.rightBottom.sub(i)),this.originalGraph.ignoreBBoxCheck=!0,this.originalGraph.boundingBox=e,this.originalGraph.ignoreBBoxCheck=!1}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let e=!1;for(let t of this.database.AllIntEdges())t.LayerSpan===2&&(e=this.ShiftVertexWithNeighbors(t.LayerEdges[0].Source,t.LayerEdges[0].Target,t.LayerEdges[1].Target)||e);return e}ShiftVertexWithNeighbors(e,t,i){let n=this.database.Anchors[e],o=this.database.Anchors[i],a=this.database.Anchors[t],l=(a.y-n.y)*((o.x-n.x)/(o.y-n.y))+n.x,u=1e-4;return l>a.x+u?this.TryShiftToTheRight(l,t):l<a.x-u?this.TryShiftToTheLeft(l,t):!1}TryShiftToTheLeft(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n>0){let o=this.database.Anchors[i[n-1]],a=Math.max(o.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[t].leftAnchor),e);return a<this.database.Anchors[t].x-1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}TryShiftToTheRight(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n<i.length-1){let o=this.database.Anchors[i[n+1]],a=Math.min(o.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[t].rightAnchor),e);return a>this.database.Anchors[t].x+1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}CalculateXLayersByGansnerNorth(e){this.xLayoutGraph=this.CreateXLayoutGraph(e),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let e=new Id(this.xLayoutGraph,null).GetLayers();for(let t=0;t<this.database.Anchors.length;t++)this.anchors[t].x=e[t]}CreateXLayoutGraph(e){let t=this.properLayeredGraph.NodeCount,i=new Array;for(let o of this.properLayeredGraph.Edges){let a=new Yr(t,o.Source,null),l=new Yr(t,o.Target,null);l.weight=o.Weight,a.weight=o.Weight,a.separation=0,l.separation=0,t++,i.push(a),i.push(l)}for(let o of e.Layers)for(let a=o.length-1;a>0;a--){let l=o[a],u=o[a-1],c=new Yr(l,u,null),h=this.database.Anchors[l],d=this.database.Anchors[u],f=h.leftAnchor+(d.rightAnchor+this.sugiyamaSettings.NodeSeparation);c.separation=Math.ceil(f+.5),i.push(c)}let n=new Wy(this.IntGraph,this.properLayeredGraph,e,i,t);return n.SetEdgeWeights(),n}CalculateXPositionsByBrandes(e){Jp.CalculateXCoordinates(e,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let e=new Un(this.IntGraph.nodeCount);for(let[i,n]of this.database.Multiedges.keyValues()){if(i.isDiagonal())continue;let o=this.verticalConstraints.gluedIntEdge(n[0]);o.source!==o.target&&e.set(o.source,o.target,o)}let t=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(i=>lB(i,null));for(let i of t)e.set(i.source,i.target,i);return Array.from(e.values())}static CalcAnchorsForOriginalNode(e,t,i,n,o){let a={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(t.nodes!=null){let c=t.nodes[e];mB(a,c,o)}bB(e,a,n,o);let l=o.MinNodeWidth/2;a.leftAnchor<l&&(a.leftAnchor=l),a.rightAnchor<l&&(a.rightAnchor=l);let u=o.MinNodeHeight/2;a.topAnchor<u&&(a.topAnchor=u),a.bottomAnchor<u&&(a.bottomAnchor=u),i[e]=fi.mkAnchor(a.leftAnchor,a.rightAnchor,a.topAnchor,a.bottomAnchor,t.nodes[e],o.LabelCornersPreserveCoefficient),i[e].padding=t.nodes[e].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new ys(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let e=new Un(this.IntGraph.nodeCount);for(let t of this.gluedDagSkeletonForLayering.edges)e.set(t.source,t.target,t);for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!==t.y){let n=this.verticalConstraints.gluedIntPair(t);if(n.x===n.y)continue;let o=e.get(n.x,n.y);for(let a of i)o.weight+=a.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function cT(s,e){if(e===0)return 0;let t=Math.floor(s/e),i=s-t*e;return Math.abs(i)<1e-4?0:e-i}function oB(s,e){for(let t of s)if(t<e)return!0;return!1}function sB(s,e,t,i,n){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new fi(n.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)ef.CalcAnchorsForOriginalNode(a,i,o,s,n);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!==a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=cS()*4,c.topAnchor=c.bottomAnchor=hT(n)/2):(c.leftAnchor=c.rightAnchor=cS()/2,c.topAnchor=c.bottomAnchor=hT(n)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=cS()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function cS(){return 1}function hT(s){return s.MinNodeHeight*1.5/8}function dT(s,e,t,i,n,o){let a=0;if(t>0){let l=pB(e.Layers[t-1],e.y,i);if(l.length){let u=n.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>gB(h,c,u,s)))}}return a}function aB(s,e,t,i,n,o,a){let l=i.Anchors,u=t.margins.top+e,c=0;for(let h of s.Layers){let d=0,f=0;for(let O of h){let M=l[O];M.bottomAnchor>d&&(d=M.bottomAnchor),M.topAnchor>f&&(f=M.topAnchor)}cB(h,d,f,t.shallowNodeCount,i.Anchors);let p=dT(i,s,c,n,o,u),S=u+d+p,x=S+f;if(hB(o)){x+=cT(x,o.GridSizeByY);for(let O of h)l[O].top=x}else if(dB(o)){let O=S-d;O+=cT(O,O);for(let M of h)l[M].bottom=O,x=Math.max(l[M].top,x)}else for(let O of h)l[O].y=S;let T=o.ActualLayerSeparation(a);u=x+T,c++}dT(i,s,c,n,o,u)}function lB(s,e){let t=new Yr(s.x,s.y,e);return t.weight=0,t.separation=1,t}function uB(s,e){return s[e.source]-s[e.target]}function cB(s,e,t,i,n){if(oB(s,i)){for(let o of s)if(o>=i){let a=n[o];a.bottomAnchor=e,a.topAnchor=t}}}function hB(s){return s.SnapToGridByY===1}function dB(s){return s.SnapToGridByY===2}function fB(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(m.getTriangleOrientation(e.origin,s.origin,t.origin)===0)return!0;let i=s.leftAnchor,n=s.rightAnchor,o=s.x;return fT(s),m.getTriangleOrientation(e.origin,s.origin,t.origin)===1?!0:(s.x=o,s.leftAnchor=i,s.rightAnchor=n,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function fT(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function pB(s,e,t){let i=new wr;for(let n of s)if(!(n>=t.nodeCount))for(let o of t.outEdges[n])e[o.source]===e[o.target]&&i.addNN(o.source,o.target);return Array.from(i.values())}function gB(s,e,t,i){let n=0,o=i.GetMultiedgeI(s);for(let a of o){n+=t;let l=a.edge.label;l!=null&&(l.positionCenter(new m(l.center.x,e+n+l.height/2)),n+=l.height)}return n}function mB(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function bB(s,e,t,i){let n=PB(t,s,e,i);e.rightAnchor+=n}function PB(s,e,t,i){let n=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));n+=(i.NodeSeparation+i.MinNodeWidth)*o.length}return n}function yB(s,e){if(e.isIdentity())return;let t=e.inverse();for(let i of s.shallowNodes)i.transform(t);for(let i of s.edges())if(i.label!=null){let n=W.mkPP(t.multiplyPoint(new m(0,0)),t.multiplyPoint(new m(i.label.width,i.label.height)));i.label.width=n.width,i.label.height=n.height}}function SB(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes)t.transform(e);for(let t of s.edges())if(t.label!=null){let i=W.mkPP(e.multiplyPoint(new m(0,0)),e.multiplyPoint(new m(t.label.width,t.label.height)));t.label.width=i.width,t.label.height=i.height}EB(s,e),s.graph.parent==null&&(s.boundingBox=null)}}function EB(s,e){for(let t of s.edges())t.label&&t.label.transform(e),xB(e,t)}function xB(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),CB(e,s)}}function CB(s,e){if(s.underlyingPolyline!=null)for(let t=s.underlyingPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var ru=(R=>(R[R.normal=0]="normal",R[R.inv=1]="inv",R[R.dot=2]="dot",R[R.invdot=3]="invdot",R[R.odot=4]="odot",R[R.invodot=5]="invodot",R[R.none=6]="none",R[R.tee=7]="tee",R[R.empty=8]="empty",R[R.invempty=9]="invempty",R[R.diamond=10]="diamond",R[R.odiamond=11]="odiamond",R[R.ediamond=12]="ediamond",R[R.crow=13]="crow",R[R.box=14]="box",R[R.obox=15]="obox",R[R.open=16]="open",R[R.halfopen=17]="halfopen",R[R.vee=18]="vee",R))(ru||{});var jo=(N=>(N[N.diamond=0]="diamond",N[N.ellipse=1]="ellipse",N[N.box=2]="box",N[N.circle=3]="circle",N[N.record=4]="record",N[N.plaintext=5]="plaintext",N[N.point=6]="point",N[N.mdiamond=7]="mdiamond",N[N.msquare=8]="msquare",N[N.polygon=9]="polygon",N[N.doublecircle=10]="doublecircle",N[N.house=11]="house",N[N.invhouse=12]="invhouse",N[N.parallelogram=13]="parallelogram",N[N.octagon=14]="octagon",N[N.tripleoctagon=15]="tripleoctagon",N[N.triangle=16]="triangle",N[N.trapezium=17]="trapezium",N[N.drawFromGeometry=18]="drawFromGeometry",N[N.hexagon=19]="hexagon",N))(jo||{});var Wg=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(Wg||{});var iu=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(iu||{});var Hg=(n=>(n[n.forward=0]="forward",n[n.back=1]="back",n[n.both=2]="both",n[n.none=3]="none",n))(Hg||{});var jg=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(jg||{});var w=class{static mkWithKeyword(e,t,i,n,o){let a=new w(e,t,i,n);return a.keyword=o,a}static parse(e){switch(e.toLowerCase()){case"aliceblue":return w.AliceBlue;case"antiquewhite":return w.AntiqueWhite;case"aqua":return w.Aqua;case"aquamarine":return w.Aquamarine;case"azure":return w.Azure;case"beige":return w.Beige;case"bisque":return w.Bisque;case"black":return w.Black;case"blanchedalmond":return w.BlanchedAlmond;case"blue":return w.Blue;case"blueviolet":return w.BlueViolet;case"brown":return w.Brown;case"burlywood":return w.BurlyWood;case"cadetblue":return w.CadetBlue;case"chartreuse":return w.Chartreuse;case"chocolate":return w.Chocolate;case"coral":return w.Coral;case"cornflowerblue":return w.CornflowerBlue;case"cornsilk":return w.Cornsilk;case"crimson":return w.Crimson;case"cyan":return w.Cyan;case"darkblue":return w.DarkBlue;case"darkcyan":return w.DarkCyan;case"darkgoldenrod":return w.DarkGoldenrod;case"darkgray":return w.DarkGray;case"darkgreen":return w.DarkGreen;case"darkkhaki":return w.DarkKhaki;case"darkmagenta":return w.DarkMagenta;case"darkolivegreen":return w.DarkOliveGreen;case"darkorange":return w.DarkOrange;case"darkorchid":return w.DarkOrchid;case"darkred":return w.DarkRed;case"darksalmon":return w.DarkSalmon;case"darkseagreen":return w.DarkSeaGreen;case"darkslateblue":return w.DarkSlateBlue;case"darkslategray":return w.DarkSlateGray;case"darkturquoise":return w.DarkTurquoise;case"darkviolet":return w.DarkViolet;case"deeppink":return w.DeepPink;case"deepskyblue":return w.DeepSkyBlue;case"dimgray":return w.DimGray;case"dodgerblue":return w.DodgerBlue;case"firebrick":return w.Firebrick;case"floralwhite":return w.FloralWhite;case"forestgreen":return w.ForestGreen;case"fuchsia":return w.Fuchsia;case"gainsboro":return w.Gainsboro;case"ghostwhite":return w.GhostWhite;case"gold":return w.Gold;case"goldenrod":return w.Goldenrod;case"gray":return w.Gray;case"green":return w.Green;case"greenyellow":return w.GreenYellow;case"honeydew":return w.Honeydew;case"hotpink":return w.HotPink;case"indianred":return w.IndianRed;case"indigo":return w.Indigo;case"ivory":return w.Ivory;case"khaki":return w.Khaki;case"lavender":return w.Lavender;case"lavenderblush":return w.LavenderBlush;case"lawngreen":return w.LawnGreen;case"lemonchiffon":return w.LemonChiffon;case"lightblue":return w.LightBlue;case"lightcoral":return w.LightCoral;case"lightcyan":return w.LightCyan;case"lightgoldenrodyellow":return w.LightGoldenrodYellow;case"lightgray":case"lightgrey":return w.LightGray;case"lightgreen":return w.LightGreen;case"lightpink":return w.LightPink;case"lightsalmon":return w.LightSalmon;case"lightseagreen":return w.LightSeaGreen;case"lightskyblue":return w.LightSkyBlue;case"lightslategray":return w.LightSlateGray;case"lightsteelblue":return w.LightSteelBlue;case"lightyellow":return w.LightYellow;case"lime":return w.Lime;case"limegreen":return w.LimeGreen;case"linen":return w.Linen;case"magenta":return w.Magenta;case"maroon":return w.Maroon;case"mediumaquamarine":return w.MediumAquamarine;case"mediumblue":return w.MediumBlue;case"mediumorchid":return w.MediumOrchid;case"mediumpurple":return w.MediumPurple;case"mediumseagreen":return w.MediumSeaGreen;case"mediumslateblue":return w.MediumSlateBlue;case"mediumspringgreen":return w.MediumSpringGreen;case"mediumturquoise":return w.MediumTurquoise;case"mediumvioletred":return w.MediumVioletRed;case"midnightblue":return w.MidnightBlue;case"mintcream":return w.MintCream;case"mistyrose":return w.MistyRose;case"moccasin":return w.Moccasin;case"navajowhite":return w.NavajoWhite;case"navy":return w.Navy;case"oldlace":return w.OldLace;case"olive":return w.Olive;case"olivedrab":return w.OliveDrab;case"orange":return w.Orange;case"orangered":return w.OrangeRed;case"orchid":return w.Orchid;case"palegoldenrod":return w.PaleGoldenrod;case"palegreen":return w.PaleGreen;case"paleturquoise":return w.PaleTurquoise;case"palevioletred":return w.PaleVioletRed;case"papayawhip":return w.PapayaWhip;case"peachpuff":return w.PeachPuff;case"peru":return w.Peru;case"pink":return w.Pink;case"plum":return w.Plum;case"powderblue":return w.PowderBlue;case"purple":return w.Purple;case"red":return w.Red;case"rosybrown":return w.RosyBrown;case"royalblue":return w.RoyalBlue;case"saddlebrown":return w.SaddleBrown;case"salmon":return w.Salmon;case"sandybrown":return w.SandyBrown;case"seagreen":return w.SeaGreen;case"seashell":return w.SeaShell;case"sienna":return w.Sienna;case"silver":return w.Silver;case"skyblue":return w.SkyBlue;case"slateblue":return w.SlateBlue;case"slategray":return w.SlateGray;case"snow":return w.Snow;case"springgreen":return w.SpringGreen;case"steelblue":return w.SteelBlue;case"tan":return w.Tan;case"teal":return w.Teal;case"thistle":return w.Thistle;case"tomato":return w.Tomato;case"transparent":return w.Transparent;case"turquoise":return w.Turquoise;case"violet":return w.Violet;case"wheat":return w.Wheat;case"white":return w.White;case"whitesmoke":return w.WhiteSmoke;case"yellow":return w.Yellow;case"yellowgreen":return w.YellowGreen;default:return}}get keyword(){return this.keyword_}set keyword(e){this.keyword_=e}constructor(e,t,i,n){this.a=e,this.r=t,this.g=i,this.b=n}static mkRGB(e,t,i){return new w(255,e,t,i)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length===1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a===t.a&&e.r===t.r&&e.b===t.b&&e.g===t.g}toString(){return this.keyword?this.keyword:'"#'+w.Xex(this.R)+w.Xex(this.G)+w.Xex(this.B)+(this.A===255?"":w.Xex(this.A))+'"'}static get AliceBlue(){return w.mkWithKeyword(255,240,248,255,"aliceblue")}static get AntiqueWhite(){return w.mkWithKeyword(255,250,235,215,"antiquewhite")}static get Aqua(){return w.mkWithKeyword(255,0,255,255,"aqua")}static get Aquamarine(){return w.mkWithKeyword(255,127,255,212,"aquamarine")}static get Azure(){return w.mkWithKeyword(255,240,255,255,"azure")}static get Beige(){return w.mkWithKeyword(255,245,245,220,"beige")}static get Bisque(){return w.mkWithKeyword(255,255,228,196,"bisque")}static get Black(){return w.mkWithKeyword(255,0,0,0,"black")}static get BlanchedAlmond(){return w.mkWithKeyword(255,255,235,205,"blanchedalmond")}static get Blue(){return w.mkWithKeyword(255,0,0,255,"blue")}static get BlueViolet(){return w.mkWithKeyword(255,138,43,226,"blueviolet")}static get Brown(){return w.mkWithKeyword(255,165,42,42,"brown")}static get BurlyWood(){return w.mkWithKeyword(255,222,184,135,"burlywood")}static get CadetBlue(){return w.mkWithKeyword(255,95,158,160,"cadetblue")}static get Chartreuse(){return w.mkWithKeyword(255,127,255,0,"chartreuse")}static get Chocolate(){return w.mkWithKeyword(255,210,105,30,"chocolate")}static get Coral(){return w.mkWithKeyword(255,255,127,80,"coral")}static get CornflowerBlue(){return w.mkWithKeyword(255,100,149,237,"cornflowerblue")}static get Cornsilk(){return w.mkWithKeyword(255,255,248,220,"cornsilk")}static get Crimson(){return w.mkWithKeyword(255,220,20,60,"crimson")}static get Cyan(){return w.mkWithKeyword(255,0,255,255,"cyan")}static get DarkBlue(){return w.mkWithKeyword(255,0,0,139,"darkblue")}static get DarkCyan(){return w.mkWithKeyword(255,0,139,139,"darkcyan")}static get DarkGoldenrod(){return w.mkWithKeyword(255,184,134,11,"darkgoldenrod")}static get DarkGray(){return w.mkWithKeyword(255,169,169,169,"darkgray")}static get DarkGreen(){return w.mkWithKeyword(255,0,100,0,"darkgreen")}static get DarkKhaki(){return w.mkWithKeyword(255,189,183,107,"darkkhaki")}static get DarkMagenta(){return w.mkWithKeyword(255,139,0,139,"darkmagenta")}static get DarkOliveGreen(){return w.mkWithKeyword(255,85,107,47,"darkolivegreen")}static get DarkOrange(){return w.mkWithKeyword(255,255,140,0,"darkorange")}static get DarkOrchid(){return w.mkWithKeyword(255,153,50,204,"darkorchid")}static get DarkRed(){return w.mkWithKeyword(255,139,0,0,"darkred")}static get DarkSalmon(){return w.mkWithKeyword(255,233,150,122,"darksalmon")}static get DarkSeaGreen(){return w.mkWithKeyword(255,143,188,139,"darkseagreen")}static get DarkSlateBlue(){return w.mkWithKeyword(255,72,61,139,"darkslateblue")}static get DarkSlateGray(){return w.mkWithKeyword(255,47,79,79,"darkslategray")}static get DarkTurquoise(){return w.mkWithKeyword(255,0,206,209,"darkturquoise")}static get DarkViolet(){return w.mkWithKeyword(255,148,0,211,"darkviolet")}static get DeepPink(){return w.mkWithKeyword(255,255,20,147,"deeppink")}static get DeepSkyBlue(){return w.mkWithKeyword(255,0,191,255,"deepskyblue")}static get DimGray(){return w.mkWithKeyword(255,105,105,105,"dimgray")}static get DodgerBlue(){return w.mkWithKeyword(255,30,144,255,"dodgerblue")}static get Firebrick(){return w.mkWithKeyword(255,178,34,34,"firebrick")}static get FloralWhite(){return w.mkWithKeyword(255,255,250,240,"floralwhite")}static get ForestGreen(){return w.mkWithKeyword(255,34,139,34,"forestgreen")}static get Fuchsia(){return w.mkWithKeyword(255,255,0,255,"fuchsia")}static get Gainsboro(){return w.mkWithKeyword(255,220,220,220,"gainsboro")}static get GhostWhite(){return w.mkWithKeyword(255,248,248,255,"ghostwhite")}static get Gold(){return w.mkWithKeyword(255,255,215,0,"gold")}static get Goldenrod(){return w.mkWithKeyword(255,218,165,32,"goldenrod")}static get Gray(){return w.mkWithKeyword(255,128,128,128,"gray")}static get Green(){return w.mkWithKeyword(255,0,128,0,"green")}static get GreenYellow(){return w.mkWithKeyword(255,173,255,47,"greenyellow")}static get Honeydew(){return w.mkWithKeyword(255,240,255,240,"honeydew")}static get HotPink(){return w.mkWithKeyword(255,255,105,180,"hotpink")}static get IndianRed(){return w.mkWithKeyword(255,205,92,92,"indianred")}static get Indigo(){return w.mkWithKeyword(255,75,0,130,"indigo")}static get Ivory(){return w.mkWithKeyword(255,255,255,240,"ivory")}static get Khaki(){return w.mkWithKeyword(255,240,230,140,"khaki")}static get Lavender(){return w.mkWithKeyword(255,230,230,250,"lavender")}static get LavenderBlush(){return w.mkWithKeyword(255,255,240,245,"lavenderblush")}static get LawnGreen(){return w.mkWithKeyword(255,124,252,0,"lawngreen")}static get LemonChiffon(){return w.mkWithKeyword(255,255,250,205,"lemonchiffon")}static get LightBlue(){return w.mkWithKeyword(255,173,216,230,"lightblue")}static get LightCoral(){return w.mkWithKeyword(255,240,128,128,"lightcoral")}static get LightCyan(){return w.mkWithKeyword(255,224,255,255,"lightcyan")}static get LightGoldenrodYellow(){return w.mkWithKeyword(255,250,250,210,"lightgoldenrodyellow")}static get LightGray(){return w.mkWithKeyword(255,211,211,211,"lightgray")}static get LightGreen(){return w.mkWithKeyword(255,144,238,144,"lightgreen")}static get LightPink(){return w.mkWithKeyword(255,255,182,193,"lightpink")}static get LightSalmon(){return w.mkWithKeyword(255,255,160,122,"lightsalmon")}static get LightSeaGreen(){return w.mkWithKeyword(255,32,178,170,"lightseagreen")}static get LightSkyBlue(){return w.mkWithKeyword(255,135,206,250,"lightskyblue")}static get LightSlateGray(){return w.mkWithKeyword(255,119,136,153,"lightslategray")}static get LightSteelBlue(){return w.mkWithKeyword(255,176,196,222,"lightsteelblue")}static get LightYellow(){return w.mkWithKeyword(255,255,255,224,"lightyellow")}static get Lime(){return w.mkWithKeyword(255,0,255,0,"lime")}static get LimeGreen(){return w.mkWithKeyword(255,50,205,50,"limegreen")}static get Linen(){return w.mkWithKeyword(255,250,240,230,"linen")}static get Magenta(){return w.mkWithKeyword(255,255,0,255,"magenta")}static get Maroon(){return w.mkWithKeyword(255,128,0,0,"maroon")}static get MediumAquamarine(){return w.mkWithKeyword(255,102,205,170,"mediumaquamarine")}static get MediumBlue(){return w.mkWithKeyword(255,0,0,205,"mediumblue")}static get MediumOrchid(){return w.mkWithKeyword(255,186,85,211,"mediumorchid")}static get MediumPurple(){return w.mkWithKeyword(255,147,112,219,"mediumpurple")}static get MediumSeaGreen(){return w.mkWithKeyword(255,60,179,113,"mediumseagreen")}static get MediumSlateBlue(){return w.mkWithKeyword(255,123,104,238,"mediumslateblue")}static get MediumSpringGreen(){return w.mkWithKeyword(255,0,250,154,"mediumspringgreen")}static get MediumTurquoise(){return w.mkWithKeyword(255,72,209,204,"mediumturquoise")}static get MediumVioletRed(){return w.mkWithKeyword(255,199,21,133,"mediumvioletred")}static get MidnightBlue(){return w.mkWithKeyword(255,25,25,112,"midnightblue")}static get MintCream(){return w.mkWithKeyword(255,245,255,250,"mintcream")}static get MistyRose(){return w.mkWithKeyword(255,255,228,225,"mistyrose")}static get Moccasin(){return w.mkWithKeyword(255,255,228,181,"moccasin")}static get NavajoWhite(){return w.mkWithKeyword(255,255,222,173,"navajowhite")}static get Navy(){return w.mkWithKeyword(255,0,0,128,"navy")}static get OldLace(){return w.mkWithKeyword(255,253,245,230,"oldlace")}static get Olive(){return w.mkWithKeyword(255,128,128,0,"olive")}static get OliveDrab(){return w.mkWithKeyword(255,107,142,35,"olivedrab")}static get Orange(){return w.mkWithKeyword(255,255,165,0,"orange")}static get OrangeRed(){return w.mkWithKeyword(255,255,69,0,"orangered")}static get Orchid(){return w.mkWithKeyword(255,218,112,214,"orchid")}static get PaleGoldenrod(){return w.mkWithKeyword(255,238,232,170,"palegoldenrod")}static get PaleGreen(){return w.mkWithKeyword(255,152,251,152,"palegreen")}static get PaleTurquoise(){return w.mkWithKeyword(255,175,238,238,"paleturquoise")}static get PaleVioletRed(){return w.mkWithKeyword(255,219,112,147,"palevioletred")}static get PapayaWhip(){return w.mkWithKeyword(255,255,239,213,"papayawhip")}static get PeachPuff(){return w.mkWithKeyword(255,255,218,185,"peachpuff")}static get Peru(){return w.mkWithKeyword(255,205,133,63,"peru")}static get Pink(){return w.mkWithKeyword(255,255,192,203,"pink")}static get Plum(){return w.mkWithKeyword(255,221,160,221,"plum")}static get PowderBlue(){return w.mkWithKeyword(255,176,224,230,"powderblue")}static get Purple(){return w.mkWithKeyword(255,128,0,128,"purple")}static get Red(){return w.mkWithKeyword(255,255,0,0,"red")}static get RosyBrown(){return w.mkWithKeyword(255,188,143,143,"rosybrown")}static get RoyalBlue(){return w.mkWithKeyword(255,65,105,225,"royalblue")}static get SaddleBrown(){return w.mkWithKeyword(255,139,69,19,"saddlebrown")}static get Salmon(){return w.mkWithKeyword(255,250,128,114,"salmon")}static get SandyBrown(){return w.mkWithKeyword(255,244,164,96,"sandybrown")}static get SeaGreen(){return w.mkWithKeyword(255,46,139,87,"seagreen")}static get SeaShell(){return w.mkWithKeyword(255,255,245,238,"seashell")}static get Sienna(){return w.mkWithKeyword(255,160,82,45,"sienna")}static get Silver(){return w.mkWithKeyword(255,192,192,192,"silver")}static get SkyBlue(){return w.mkWithKeyword(255,135,206,235,"skyblue")}static get SlateBlue(){return w.mkWithKeyword(255,106,90,205,"slateblue")}static get SlateGray(){return w.mkWithKeyword(255,112,128,144,"slategray")}static get Snow(){return w.mkWithKeyword(255,255,250,250,"snow")}static get SpringGreen(){return w.mkWithKeyword(255,0,255,127,"springgreen")}static get SteelBlue(){return w.mkWithKeyword(255,70,130,180,"steelblue")}static get Tan(){return w.mkWithKeyword(255,210,180,140,"tan")}static get Teal(){return w.mkWithKeyword(255,0,128,128,"teal")}static get Thistle(){return w.mkWithKeyword(255,216,191,216,"thistle")}static get Tomato(){return w.mkWithKeyword(255,255,99,71,"tomato")}static get Transparent(){return w.mkWithKeyword(0,255,255,255,"transparent")}static get Turquoise(){return w.mkWithKeyword(255,64,224,208,"turquoise")}static get Violet(){return w.mkWithKeyword(255,238,130,238,"violet")}static get Wheat(){return w.mkWithKeyword(255,245,222,179,"wheat")}static get White(){return w.mkWithKeyword(255,255,255,255,"white")}static get WhiteSmoke(){return w.mkWithKeyword(255,245,245,245,"whitesmoke")}static get Yellow(){return w.mkWithKeyword(255,255,255,0,"yellow")}static get YellowGreen(){return w.mkWithKeyword(255,154,205,50,"yellowgreen")}};var Oa=class extends gl{constructor(e){super(e,Ht.DrawingObjectIndex);this.labelfontcolor=w.Black;this.styles=[];this.penwidth=1;this.fontname=Oa.defaultLabelFontName,this.fontsize=Oa.defaultLabelFontSize}static copyValidFields(e,t){e==null||t==null||(e.color&&e.color.keyword&&e.color.keyword.toLowerCase()!=="black"&&(t.color=e.color),e.fillColor&&(t.fillColor=e.fillColor),e.labelfontcolor&&e.labelfontcolor.keyword.toLowerCase()!=="black"&&(t.labelfontcolor=e.labelfontcolor),e.labelText!=null&&e.labelText!==""&&e.labelText!==e.id&&(t.labelText=e.labelText),e.fontColor&&e.fontColor.keyword&&e.fontColor.keyword.toLowerCase()!=="black"&&(t.fontColor=e.fontColor),e.styles&&e.styles.length&&(t.styles=e.styles.map(i=>i)),e.pencolor&&e.pencolor.keyword!=="black"&&(t.pencolor=e.pencolor),e.penwidth&&e.penwidth!==1&&(t.penwidth=e.penwidth),e.rankdir&&(t.rankdir=e.rankdir),e.fontname&&e.fontname!==Oa.defaultLabelFontName&&(t.fontname=e.fontname),e.margin&&(t.margin=e.margin),e.fontsize&&e.fontsize!==Oa.defaultLabelFontSize&&(t.fontsize=e.fontsize),e.orientation&&(t.orientation=e.orientation),e.ranksep&&(t.ranksep=e.ranksep),e.arrowtail&&(t.arrowtail=e.arrowtail),e.arrowhead&&(t.arrowhead=e.arrowhead),e.ordering&&(t.ordering=e.ordering),e.bgcolor&&(t.bgcolor=e.bgcolor),e.pos&&(t.pos=e.pos),e.nodesep&&(t.nodesep=e.nodesep),e.arrowsize&&(t.arrowsize=e.arrowsize),e.samehead&&(t.samehead=e.samehead),e.layersep&&(t.layersep=e.layersep),e.clusterRank&&(t.clusterRank=e.clusterRank))}*attrIter(){if(this.color&&this.color.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"color",eq:this.color.toString()}),this.fillColor&&(yield{type:"attr",id:"fillColor",eq:this.fillColor.toString()}),this.labelfontcolor&&this.labelfontcolor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"labelfontcolor",eq:this.labelfontcolor.toString()}),!(this.labelText==null||this.labelText==="")&&this.entity&&this.labelText!==this.id&&(yield{type:"attr",id:"label",eq:this.labelText}),this.fontColor&&this.fontColor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"fontColor",eq:this.fontColor.toString()}),this.styles&&this.styles.length){let e=this.styles.map(t=>iu[t]).reduce((t,i)=>t.concat(","+i));yield{type:"attr",id:"style",eq:e}}this.pencolor&&this.pencolor.keyword!=="black"&&(yield{type:"attr",id:"pencolor",eq:this.pencolor.toString()}),this.penwidth&&this.penwidth!==1&&(yield{type:"attr",id:"penwidth",eq:this.penwidth.toString()}),this.rankdir&&(yield{type:"attr",id:"rankdir",eq:this.rankdir.toString()}),this.fontname&&this.fontname!==Oa.defaultLabelFontName&&(yield{type:"attr",id:"fontname",eq:this.fontname}),this.margin&&(yield{type:"attr",id:"margin",eq:this.margin.toString()}),this.fontsize&&this.fontsize!==Oa.defaultLabelFontSize&&(yield{type:"attr",id:"fontsize",eq:this.fontsize.toString()}),this.orientation&&(yield{type:"attr",id:"orientation",eq:this.orientation.toString()}),this.ranksep&&(yield{type:"attr",id:"ranksep",eq:this.ranksep.toString()}),this.arrowtail&&(yield{type:"attr",id:"arrowtail",eq:this.arrowtail.toString()}),this.arrowhead&&(yield{type:"attr",id:"arrowhead",eq:this.arrowhead.toString()}),this.ordering&&(yield{type:"attr",id:"ordering",eq:this.ordering.toString()}),this.bgcolor&&(yield{type:"attr",id:"bgcolor",eq:this.bgcolor.toString()}),this.pos&&(yield{type:"attr",id:"pos",eq:this.pos.toString()}),this.nodesep&&(yield{type:"attr",id:"nodesep",eq:this.nodesep.toString()}),this.arrowsize&&(yield{type:"attr",id:"arrowsize",eq:this.arrowsize.toString()}),this.samehead&&(yield{type:"attr",id:"samehead",eq:this.samehead.toString()}),this.layersep&&(yield{type:"attr",id:"layersep",eq:this.layersep.toString()}),this.clusterRank&&(yield{type:"attr",id:"clusterrank",eq:this.clusterRank.toString()}),this.measuredTextSize&&(yield{type:"attr",id:"measuredTextSize",eq:JSON.stringify(this.measuredTextSize)})}get labelText(){return this._labelText}set labelText(e){this._labelText=e}get id(){return this._id}set id(e){this._id=e}static getDrawingObj(e){return e==null?null:e.getAttr(Ht.DrawingObjectIndex)}},Qe=Oa;Qe.defaultLabelFontName="Times-Roman",Qe.defaultLabelFontSize=12;var qg=class extends Qe{constructor(e){super(e);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;e!=null&&(this.labelText=e.id)}*attrIter(){yield*super.attrIter(),this.shape&&this.shape!==2&&(yield{type:"attr",id:"shape",eq:this.shape.toString()}),this.xRad&&this.xRad!==3&&(yield{type:"attr",id:"xRad",eq:this.xRad.toString()}),this.yRad&&this.yRad!==3&&(yield{type:"attr",id:"yRad",eq:this.yRad.toString()}),this.padding&&this.padding!==2&&(yield{type:"attr",id:"padding",eq:this.padding.toString()})}get Padding(){return this.padding}set Padding(e){this.padding=Math.max(0,e)}get XRadius(){return this.xRad}set XRadius(e){this.xRad=e}get YRadius(){return this.yRad}set YRadius(e){this.yRad=e}static get DefaultFillColor(){return qg.defaultFillColor}static set DefaultFillColor(e){qg.defaultFillColor=e}get ShapeEnum(){return this.shape}set ShapeEnum(e){this.shape=e}get LabelMargin(){return this.labelMargin}set LabelMargin(e){this.labelMargin=e}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(e){this.labelWidthToHeightRatio=e}get node(){return this.entity}get id(){return this.node?this.node.id:null}},Bt=qg;Bt.defaultFillColor=w.LightGray;var or=class extends Bt{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get defaultNodeObject(){return this._defaultNodeObject}set defaultNodeObject(e){this._defaultNodeObject=e}static getDrawingGraph(e){return Qe.getDrawingObj(e)}get graph(){return this.entity}findNode(e){let i=this.graph.findNode(e);return i==null?null:Qe.getDrawingObj(i)}hasDirectedEdge(){for(let e of this.graph.edges)if(Qe.getDrawingObj(e).directed)return!0;return!1}createGeometry(e=t=>t?new Pr(t.length*8+8,20):null){let t=new Ie(this.graph);this.textMeasure=e;let i={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};t.labelSize=e(this.labelText,i);for(let n of this.graph.deepNodes)this.createNodeGeometry(n);for(let n of this.graph.deepEdges)this.createEdgeGeometry(n);return t}createEdgeGeometry(e){let t=Bi.getDrawingObj(e),i=new Xe(e);if(t.directed?i.targetArrowhead==null&&(i.targetArrowhead=new rr):i.targetArrowhead=null,t.labelText){let n=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"});i.label=new bl(W.mkPP(new m(0,0),new m(n.width,n.height)),i),t.measuredTextSize=n}t.penwidth&&(i.lineWidth=t.penwidth)}curveByShape(e,t,i,n,o){let a;switch(n){case 0:a=we.CreateDiamond(e,t,i);break;case 1:a=we.mkEllipse(e/1.6,t/1.6,i);break;case 4:case 2:a=we.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,i);break;case 3:a=we.mkCircle(Math.sqrt(e*e+t*t),i);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=we.mkCircle(Math.sqrt(e*e+t*t)+2*o.penwidth,i);break;case 11:a=we.createHouse(e,t,i);break;case 12:a=we.createInvertedHouse(e,t,i);break;case 13:a=we.createParallelogram(e,t,i);break;case 14:a=we.createOctagon(e,t,i);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=we.createHexagon(e,t,i);break}return a!=null?a:we.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,i)}createNodeGeometry(e){if(e instanceof Te){let t=Qe.getDrawingObj(e),i=new Ie(e);t.labelText&&(i.labelSize=t.measuredTextSize=hS(t,this.textMeasure))}else{let t=Bt.getDrawingObj(e),i=new Pr(1,1);t.labelText&&(i=hS(t,this.textMeasure)),t.measuredTextSize=i;let n=new m(0,0),o=new ft(e),a=i.width+t.LabelMargin*2,l=i.height+t.LabelMargin*2;o.boundaryCurve=this.curveByShape(a,l,n,t.shape,t)}}measureLabelSizes(e){var t;for(let i of this.graph.deepNodes){let n=Bt.getDrawingObj(i);n.measuredTextSize=(t=hS(n,e))!=null?t:new Pr(1,1)}}};function hS(s,e){return s.labelText?e(s.labelText,{fontSize:s.fontsize,fontFamily:s.fontname,fontStyle:"normal"}):null}var Bi=class extends Qe{constructor(){super(...arguments);this.directed=!0}};var AT=me(vT());function qo(s){let e=(0,AT.default)(s);if(e.keyword!=null)return w.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new w(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return w.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return w.Black}function CS(s,e,t){for(let i of t.attr_list)if(i.type==="attr"){let n=i.eq;switch(i.id){case"edgeCurve":{let o=Gc(s),a=JSON.parse(n);o.curve=Mp(a)}break;case"graphBoundingBox":{let o=Gc(s),a=JSON.parse(n);o.boundingBox=new W(a)}break;case"boundaryCurve":{let o=Gc(s),a=JSON.parse(n),l=Mp(a);o instanceof Ie?o.boundingBox=l.boundingBox:o.boundaryCurve=l}break;case"sourceArrowhead":{let o=Gc(s);o.sourceArrowhead==null&&(o.sourceArrowhead=new rr),o.sourceArrowhead.tipPosition=m.fromJSON(JSON.parse(n));break}case"targetArrowhead":{let o=Gc(s);o.targetArrowhead==null&&(o.targetArrowhead=new rr),o.targetArrowhead.tipPosition=m.fromJSON(JSON.parse(n));break}case"geomEdgeLabel":{let o=Gc(s),a=JSON.parse(n);o.label=new bl(null,o),o.label.setBoundingBox(new W(a));break}case"color":e.color=qo(n);break;case"pencolor":e.pencolor=qo(n);break;case"labelfontcolor":e.labelfontcolor=qo(n);break;case"fontcolor":e.fontColor=qo(n);break;case"fillcolor":e.fillColor=qo(n);break;case"style":for(let o of ZB(n))e.styles.push(o);break;case"shape":{let o=e;o.shape=QB(n);break}case"peripheries":e.peripheries=parseInt(n);break;case"headlabel":e.headlabel=n;break;case"label":if(typeof n=="string"){let o="\\n",a=0;e.labelText="";do{let l=n.indexOf(o,a);if(l>=0)e.labelText+=n.substring(a,l)+`
`,a=l+2;else{e.labelText+=n.substring(a);break}}while(!0)}else typeof n=="number"&&(e.labelText=n.toString());break;case"size":e.size=xS(n);break;case"pos":e.pos=xS(n);break;case"rankdir":e.rankdir=JB(n);break;case"fontname":e.fontname=n;break;case"fontsize":e.fontsize=parseFloat(n);break;case"width":e.width=parseFloat(n);break;case"penwidth":e.penwidth=parseFloat(n);break;case"height":e.height=parseFloat(n);break;case"margin":e.margin=parseFloat(n);break;case"len":e.len=parseFloat(n);break;case"minlen":e.minlen=parseFloat(n);break;case"rank":e.rank=$B(n);break;case"charset":e.charset=n;break;case"orientation":e.orientation=n;break;case"ratio":e.ratio=n;break;case"weight":e.weight=parseFloat(n);break;case"nodesep":e.nodesep=parseFloat(n);break;case"layersep":e.layersep=parseFloat(n);break;case"arrowsize":e.arrowsize=parseFloat(n);break;case"rotate":e.rotate=parseFloat(n);break;case"ranksep":e.ranksep=parseFloat(n);break;case"splines":e.splines=n==="true";break;case"overlap":e.overlap=n==="true";break;case"arrowtail":e.arrowtail=TT(n);break;case"taillabel":e.taillabel=n;break;case"arrowhead":e.arrowhead=TT(n);break;case"ordering":e.ordering=eD(n);break;case"URL":e.URL=n;break;case"dir":e.dir=tD(n);break;case"concentrate":e.concentrate=n==="true";break;case"compound":e.compound=n==="true";break;case"lhead":e.lhead=n;break;case"ltail":e.ltail=n;break;case"bgcolor":e.bgcolor=qo(n);break;case"center":e.center=n===!0||parseInt(n)===1;break;case"colorscheme":e.colorscheme=n;break;case"sides":e.sides=parseInt(n);break;case"distortion":e.distortion=parseFloat(n);break;case"skew":e.skew=parseFloat(n);break;case"bb":e.bb=rD(n);break;case"labelloc":e.labelloc=n;break;case"decorate":e.decorate=n==="true";break;case"tailclip":e.tailclip=n==="true";break;case"headclip":e.headclip=n==="true";break;case"constraint":e.constraint=n==="true";break;case"gradientangle":e.gradientangle=parseFloat(n);break;case"samehead":e.samehead=n;break;case"href":e.href=n;break;case"imagepath":e.imagepath=n;break;case"image":e.image=n;break;case"labeljust":e.labejust=n;break;case"layers":e.layers=n.split(",");break;case"layer":e.layer=n;break;case"f":e.f=parseFloat(n);break;case"nojustify":e.nojustify=n==="true";break;case"root":e.root=n==="true";break;case"page":e.page=xS(n);break;case"pname":e.pname=n;break;case"kind":e.kind=n;break;case"fname":e.fname=n;break;case"subkind":e.subkind=n;break;case"area":e.area=parseFloat(n);break;case"tailport":e.tailport=n;break;case"headport":e.headport=n;break;case"wt":e.wt=n;break;case"id":e instanceof Bt||(e.id=n);break;case"edgetooltip":e.edgetooltip=n;break;case"headtooltip":e.headtooltip=n;break;case"tailtooltip":e.tailtooltip=n;break;case"headURL":e.headURL=n;break;case"tailURL":e.tailURL=n;break;case"labelURL":e.labelURL=n;break;case"edgeurl":e.edgeurl=n;break;case"shapefile":e.shapefile=n;break;case"xlabel":e.xlabel=n;break;case"sametail":e.sametail=n;break;case"clusterrank":e.clusterRank=n;break;case"measuredTextSize":e.measuredTextSize=JSON.parse(n);break;default:break}}else throw new Error("unexpected type "+i.type)}function Vc(s,e){let t=Qe.getDrawingObj(e);s.attr_list!=null&&CS(e,t,s)}var vS=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,i,n,o){let a=i.nodeCollection,l,u;if(e.type==="node_id"){let d=e.id.toString();a.hasNode(d)?l=a.getNode(d):l=this.newNode(d,i,!1)}else{let d=[];for(let f of e.children)if(f.type==="node_stmt")for(let p of this.parseEdge(f.node_id,t,i,n,o))d.push(p);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of e.children)if(f.type==="attr_stmt")for(let p of d)Vc(f,p);return d}if(t.type==="node_id"){let d=t.id.toString();a.hasNode(d)?u=a.getNode(d):u=this.newNode(d,i,!1)}else if(t.type==="subgraph"){let d=new Array;for(let f of t.children)if(f.type==="node_stmt")for(let p of this.parseEdge(e,f.node_id,i,n,o))d.push(p);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of t.children)if(f.type==="attr_stmt")for(let p of d)Vc(f,p);return d}let c=new ms(l,u);a.addEdge(c);let h=new Bi(c);return Vc(o,c),h.directed=n,[c]}newNode(e,t,i){let n=this.nodeMap.get(e);if(n==null){n=new bs(e),this.nodeMap.set(e,n),t.addNode(n);let o=new Bt(n);o.labelText=e;let a=or.getDrawingObj(t);Qe.copyValidFields(a.defaultNodeObject,o)}else i&&uy(t,n);return n}parseNode(e,t,i){let n=e.node_id.id.toString(),o=this.newNode(n,t,i);return Qe.getDrawingObj(o)==null&&new Bt(o),Vc(e,o),o}parse(){return this.ast==null?null:(this.graph=new Te(this.ast[0].id?this.ast[0].id.toString():"__graph__"),this.drawingGraph=new or(this.graph),this.parseUnderGraph(this.ast[0].children,this.graph,this.ast[0].type==="digraph",!1),nD(this.graph),oD(this.graph),this.graph)}parseGraphAttr(e,t){if(e.target==="node"){let i=or.getDrawingObj(t);i.defaultNodeObject==null&&(i.defaultNodeObject=new Bt(null)),CS(null,i.defaultNodeObject,e)}else e.target==="graph"&&Vc(e,t)}getEntitiesSubg(e,t,i){let n=[];for(let o of e.children)if(o.type==="edge_stmt")for(let a=0;a<o.edge_list.length-1;a++)for(let l of this.parseEdge(o.edge_list[a],o.edge_list[a+1],t,i,o))n.push(l);else if(o.type!=="attr_stmt")if(o.type==="node_stmt")n.push(this.parseNode(o,t,!0));else if(o.type==="subgraph")if(o.id!=null){let a=new Te(o.id.toString());t.addNode(a);let l=new or(a);this.parseUnderGraph(o.children,a,i,!0),n.push(l.graph)}else n=n.concat(this.getEntitiesSubg(o,t,i));else throw new Error("Function not implemented.");return n}parseUnderGraph(e,t,i,n){for(let o of e)switch(o.type){case"node_stmt":this.parseNode(o,t,n);break;case"edge_stmt":{let a=o.edge_list;for(let l=0;l<a.length-1;l++)this.parseEdge(a[l],a[l+1],t,i,o)}break;case"subgraph":if(!this.process_same_rank(o,or.getDrawingGraph(t)))if(o.id==null){let a=this.getEntitiesSubg(o,t,i);iD(o,or.getDrawingGraph(t),a)}else{let a=new Te(o.id.toString());new or(a),this.parseUnderGraph(o.children,a,i,!0),a.isEmpty()||t.addNode(a)}break;case"attr_stmt":this.parseGraphAttr(o,t);break;default:throw new Error("not implemented")}}process_same_rank(e,t){let i=e.children[0];if(i==null||i.type!=="attr_stmt")return!1;let n=i.attr_list;if(n==null||n.length===0)return!1;let o=n[0];if(o.type!=="attr"||o.id!=="rank")return!1;switch(o.eq){case"min":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"max":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"same":{let a=[];for(let l=1;l<e.children.length;l++){let u=e.children[l];u.type==="node_stmt"?(this.newNode(u.node_id.id.toString(),t.graph,!1),a.push(u.node_id.id.toString())):u.type==="attr_stmt"&&u.target==="node"&&(t.defaultNodeObject==null&&(t.defaultNodeObject=new Bt(null)),CS(null,t.defaultNodeObject,u))}return t.graphVisData.sameRanks.push(a),!0}case"source":{for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sourceRanks.push(l.node_id.id.toString());else throw new Error}return!0}case"sink":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sinkRanks.push(l.node_id.id.toString());else throw new Error}return!0;default:throw new Error("incorrect rank")}}};function Qg(s){return new vS((0,IT.default)(s)).parse()}function wT(s){try{return new vS([s]).parse()}catch(e){return console.log(e.message),null}}function*ZB(s){let e=s.split(",");for(let t of e){let n=iu[t];n&&(yield n)}}function QB(s){let e=s.toLowerCase();return jo[e]}function xS(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function JB(s){return sc[s]}function $B(s){return Wg[s]}function TT(s){return ru[s]}function eD(s){return jg[s]}function tD(s){return Hg[s]}function rD(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function iD(s,e,t){for(let i of s.children)if(i.type==="attr_stmt")for(let n of t)Vc(i,n)}function nD(s){let e=[];for(let t of s.subgraphs())t.isEmpty()&&e.push(t);for(let t of e){let i=t.parent;i&&i.removeNode(t)}}function oD(s){for(let e of s.subgraphs())Ie.getGeom(e)==null&&e.hasSomeAttrOnIndex(Ht.GeomObjectIndex)&&new Ie(e);Ie.getGeom(s)==null&&s.hasSomeAttrOnIndex(Ht.GeomObjectIndex)&&new Ie(s)}function ff(s){let e=pD(s);return{type:dD(s),id:s.id,children:aD(s,e)}}function sD(s){return{type:"edge_stmt",edge_list:[{type:"node_id",id:s.source.id},{type:"node_id",id:s.target.id}],attr_list:Array.from(lD(s))}}function aD(s,e){let t=new Map,i=[],n=Ie.getGeom(s);if(n){let o=Array.from(OT(n));i.push({type:"attr_stmt",target:"graph",attr_list:o})}mD(i,s);for(let o of s.deepNodes)t.set(o.id,uD(o));for(let o of s.deepNodes){if(o.parent===s)continue;t.get(o.parent.id).children.push(t.get(o.id))}for(let o of s.deepEdges){let a=sD(o),l=fD(o,e);l===s?i.push(a):t.get(l.id).children.push(a)}for(let o of s.shallowNodes)i.push(t.get(o.id));return i}function*lD(s){let e=ke.getGeom(s);if(e&&e.curve&&(yield{type:"attr",id:"edgeCurve",eq:JSON.stringify(Np(e.curve))},e.sourceArrowhead&&(yield{type:"attr",id:"sourceArrowhead",eq:JSON.stringify(e.sourceArrowhead.tipPosition.toJSON())}),e.targetArrowhead&&(yield{type:"attr",id:"targetArrowhead",eq:JSON.stringify(e.targetArrowhead.tipPosition.toJSON())}),e.label)){let t=e.labelBBox,i={left:t.left,right:t.right,top:t.top,bottom:t.bottom};yield{type:"attr",id:"geomEdgeLabel",eq:JSON.stringify(i)}}yield*AS(Qe.getDrawingObj(s))}function uD(s){if(s instanceof Te){let t=Array.from(OT(Ie.getGeom(s))),i=[],n={type:"attr_stmt",target:"graph",attr_list:t};return i.push(n),{type:"subgraph",children:i,id:s.id}}else return{type:"node_stmt",node_id:{type:"node_id",id:s.id},attr_list:Array.from(hD(s))}}function cD(s){let e=ft.getGeom(s).boundaryCurve;return{type:"attr",id:"boundaryCurve",eq:JSON.stringify(Np(e))}}function*hD(s){ke.getGeom(s)&&(yield cD(s)),yield*AS(Qe.getDrawingObj(s))}function*AS(s){if(s)for(let e of s.attrIter())yield e}function dD(s){return or.getDrawingGraph(s).hasDirectedEdge()?"digraph":"graph"}function fD(s,e){let t=s.source,i=s.target,n=e.get(t.id),o=e.get(i.id);for(;n>o;)t=t.parent,n--;for(;n<o;)i=i.parent,o--;for(;t.parent!==i.parent;)t=t.parent,i=i.parent;return t.parent}function pD(s){let e=new Map;return e.set(s.id,0),LT(s,e),e}function LT(s,e){let t=e.get(s.id)+1;for(let i of s.shallowNodes)e.set(i.id,t),i instanceof Te&&LT(i,e)}function Gc(s){var e;return(e=ke.getGeom(s))!=null?e:gD(s)}function gD(s){if(s instanceof Te)return new Ie(s);if(s instanceof bs)return new ft(s);if(s instanceof ms)return new Xe(s);throw new Error("unsupported type "+s)}function mD(s,e){let t=or.getDrawingObj(e);if(t==null)return;let i=t.defaultNodeObject;i&&s.push({type:"attr_stmt",target:"node",attr_list:Array.from(AS(i))})}function*OT(s){if(s==null)return;let e=s.boundingBox;if(e&&e.isEmpty()===!1){let t={left:e.left,right:e.right,top:e.top,bottom:e.bottom};yield{type:"attr",id:"graphBoundingBox",eq:JSON.stringify(t)}}s.radX!==10&&(yield{type:"attr",id:"radX",eq:s.radX.toString()}),s.radY!==10&&(yield{type:"attr",id:"radY",eq:s.radY.toString()})}function su(s){return"nodes"in s?bD(s):wT(s)}function bD(s){let e=new Te;for(let t of s.nodes){let i=String(t.id),n=e.addNode(new bs(i)),o=new Bt(n),{label:a=i,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=jo[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=qo(t.color))}for(let t of s.edges){let i=e.setEdge(String(t.source),String(t.target)),n=new Bi(i),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;n.arrowhead=ru[o],n.arrowtail=ru[a],n.directed=l,"weight"in t&&(n.weight=t.weight),"color"in t&&(n.color=qo(t.color))}return e}async function TS(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),i;if(e.endsWith(".json")){let n=await t.json();i=su(n)}else{let n=await t.text();i=Qg(n)}return i.id=e,i}async function RT(s){let e=await s.text(),t;return s.name.endsWith(".json")?t=su(JSON.parse(e)):t=Qg(e),t.id=s.name,t}function _T(s,e){let t=document.getElementById(s);t.ondragover=i=>{i.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=i=>{i.preventDefault(),t.classList.remove("active");let n=i.dataTransfer.items[0];n.kind==="file"&&e(n.getAsFile())},t.onclick=()=>{let i=document.createElement("input");i.type="file",i.onchange=()=>i.files.length&&e(i.files[0]),i.click()}}function Ra(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var Xo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},PD=Xo.self||Xo.window||Xo.global||{},yD=Xo.window||Xo.self||Xo.global||{},SD=Xo.global||Xo.self||Xo.window||{},ED=Xo.document||{};var au=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var MT=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),xD=MT&&parseFloat(MT[1])||0;var NT="3.2.6";function ni(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var Yo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},ome=Yo.self||Yo.window||Yo.global||{},sme=Yo.window||Yo.self||Yo.global||{},ame=Yo.global||Yo.self||Yo.window||{},lme=Yo.document||{};var kc=typeof process!="object"||String(process)!=="[object process]"||process.browser;var DT=typeof window<"u"&&typeof window.orientation<"u",BT=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),ume=BT&&parseFloat(BT[1])||0;function y(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var Jg=class{constructor(e,t){y(this,"name",void 0),y(this,"workerThread",void 0),y(this,"isRunning",!0),y(this,"result",void 0),y(this,"_resolve",()=>{}),y(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,n)=>{this._resolve=i,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){ni(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ni(this.isRunning),this.isRunning=!1,this._reject(e)}};var pf=class{};var IS=new Map;function FT(s){ni(s.source&&!s.url||!s.source&&s.url);let e=IS.get(s.source||s.url);return e||(s.url&&(e=CD(s.url),IS.set(s.url,e)),s.source&&(e=GT(s.source),IS.set(s.source,e))),ni(e),e}function CD(s){if(!s.startsWith("http"))return s;let e=vD(s);return GT(e)}function GT(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function vD(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function wS(s,e=!0,t){let i=t||new Set;if(s){if(VT(s))i.add(s);else if(VT(s.buffer))i.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let n in s)wS(s[n],e,i)}}return t===void 0?Array.from(i):[]}function VT(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var LS=()=>{},lu=class{static isSupported(){return typeof Worker<"u"&&kc||typeof pf!==void 0}constructor(e){y(this,"name",void 0),y(this,"source",void 0),y(this,"url",void 0),y(this,"terminated",!1),y(this,"worker",void 0),y(this,"onMessage",void 0),y(this,"onError",void 0),y(this,"_loadableURL","");let{name:t,source:i,url:n}=e;ni(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=LS,this.onError=o=>console.log(o),this.worker=kc?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=LS,this.onError=LS,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||wS(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=FT({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){let i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new pf(i,{eval:!1})}else if(this.source)e=new pf(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}};var $g=class{static isSupported(){return lu.isSupported()}constructor(e){y(this,"name","unnamed"),y(this,"source",void 0),y(this,"url",void 0),y(this,"maxConcurrency",1),y(this,"maxMobileConcurrency",1),y(this,"onDebug",()=>{}),y(this,"reuseWorkers",!0),y(this,"props",{}),y(this,"jobQueue",[]),y(this,"idleQueue",[]),y(this,"count",0),y(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,o,a)=>n.done(a),i=(n,o)=>n.error(o)){let n=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new Jg(t.name,e);e.onMessage=n=>t.onMessage(i,n.type,n.payload),e.onError=n=>t.onError(i,n),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new lu({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return DT?this.maxMobileConcurrency:this.maxConcurrency}};var AD={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Qi=class{static isSupported(){return lu.isSupported()}static getWorkerFarm(e={}){return Qi._workerFarm=Qi._workerFarm||new Qi({}),Qi._workerFarm.setProps(e),Qi._workerFarm}constructor(e){y(this,"props",void 0),y(this,"workerPools",new Map),this.props={...AD},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:n}=e,o=this.workerPools.get(t);return o||(o=new $g({name:t,source:i,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};y(Qi,"_workerFarm",void 0);var TD="latest";function OS(s,e={}){let t=e[s.id]||{},i="".concat(s.id,"-worker.js"),n=t.workerUrl;if(!n&&s.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(n="modules/".concat(s.module,"/dist/").concat(i)),!n){let o=s.version;o==="latest"&&(o=TD);let a=o?"@".concat(o):"";n="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(i)}return ni(n),n}function RS(s,e=NT){ni(s,"no worker provided");let t=s.version;return!(!e||!t)}function _S(s,e){return!Qi.isSupported()||!kc&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&e?.worker}async function MS(s,e,t,i,n){let o=s.id,a=OS(s,t),u=Qi.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));let c=await u.startJob("process-on-worker",ID.bind(null,n));return c.postMessage("process",{input:e,options:t,context:i}),await(await c.result).result}async function ID(s,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":let{id:n,input:o,options:a}=i;try{let l=await s(o,a);e.postMessage("done",{id:n,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:n,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function NS(s){return s&&typeof s=="object"&&s.isBuffer}function kT(s){return NS(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function em(s){if(NS(s))return kT(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function BS(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let i=new Uint8Array(s),n=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==n[o])return!1;return!0}function DS(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),i=new Uint8Array(t),n=0;for(let o of e)i.set(o,n),n+=o.byteLength;return i.buffer}async function FS(s){let e=[];for await(let t of s)e.push(t);return DS(...e)}function gf(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var uu=class{constructor(e,t){y(this,"name",void 0),y(this,"type",void 0),y(this,"sampleSize",1),y(this,"time",void 0),y(this,"count",void 0),y(this,"samples",void 0),y(this,"lastTiming",void 0),y(this,"lastSampleTime",void 0),y(this,"lastSampleCount",void 0),y(this,"_count",0),y(this,"_time",0),y(this,"_samples",0),y(this,"_startTime",0),y(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=gf(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(gf()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var yn=class{constructor(e){y(this,"id",void 0),y(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:i}=e;return this.stats[t]||(e instanceof uu?this.stats[t]=e:this.stats[t]=new uu(t,i)),this.stats[t]}};var wD="Queued Requests",LD="Active Requests",OD="Cancelled Requests",RD="Queued Requests Ever",_D="Active Requests Ever",MD={id:"request-scheduler",throttleRequests:!0,maxRequests:6},mf=class{constructor(e={}){y(this,"props",void 0),y(this,"stats",void 0),y(this,"activeRequestCount",0),y(this,"requestQueue",[]),y(this,"requestMap",new Map),y(this,"deferredUpdate",null),this.props={...MD,...e},this.stats=new yn({id:this.props.id}),this.stats.get(wD),this.stats.get(LD),this.stats.get(OD),this.stats.get(RD),this.stats.get(_D)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);let i={handle:e,priority:0,getPriority:t},n=new Promise(o=>(i.resolve=o,i));return this.requestQueue.push(i),this.requestMap.set(e,n),this._issueNewRequests(),n}_issueRequest(e){let{handle:t,resolve:i}=e,n=!1,o=()=>{n||(n=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:o}):Promise.resolve({done:o})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout(()=>this._issueNewRequestsAsync(),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;let e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){let i=this.requestQueue.shift();i&&this._issueRequest(i)}}}_updateAllRequests(){let e=this.requestQueue;for(let t=0;t<e.length;++t){let i=e[t];this._updateRequest(i)||(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort((t,i)=>t.priority-i.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}};var ND="",zT={};function GS(s){for(let e in zT)if(s.startsWith(e)){let t=zT[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(ND).concat(s)),s}var tm={};J2(tm,{dirname:()=>DD,filename:()=>BD,join:()=>FD});function BD(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function DD(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function FD(...s){let e="/";return s=s.map((t,i)=>(i&&(t=t.replace(new RegExp("^".concat(e)),"")),i!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var GD=s=>typeof s=="boolean",bf=s=>typeof s=="function",zc=s=>s!==null&&typeof s=="object",VS=s=>zc(s)&&s.constructor==={}.constructor;var UT=s=>s&&typeof s[Symbol.iterator]=="function",WT=s=>s&&typeof s[Symbol.asyncIterator]=="function";var ro=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var io=s=>typeof Blob<"u"&&s instanceof Blob,HT=s=>s&&typeof s=="object"&&s.isBuffer;var VD=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||zc(s)&&bf(s.tee)&&bf(s.cancel)&&bf(s.getReader);var kD=s=>zc(s)&&bf(s.read)&&bf(s.pipe)&&GD(s.readable),rm=s=>VD(s)||kD(s);var zD=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,UD=/^([-\w.]+\/[-\w.+]+)/;function jT(s){let e=UD.exec(s);return e?e[1]:s}function kS(s){let e=zD.exec(s);return e?e[1]:""}var WD=/\?.*/;function cu(s){if(ro(s)){let e=zS(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:jT(t)||kS(e)}}return io(s)?{url:zS(s.name||""),type:s.type||""}:typeof s=="string"?{url:zS(s),type:kS(s)}:{url:"",type:""}}function qT(s){return ro(s)?s.headers["content-length"]||-1:io(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function zS(s){return s.replace(WD,"")}async function im(s){if(ro(s))return s;let e={},t=qT(s);t>=0&&(e["content-length"]=String(t));let{url:i,type:n}=cu(s);n&&(e["content-type"]=n);let o=await jD(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:i}),a}async function XT(s){if(!s.ok){let e=await HD(s);throw new Error(e)}}async function HD(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),i=s.statusText;t.includes("application/json")&&(i+=" ".concat(await s.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function jD(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(i=>{let n=new FileReader;n.onload=o=>{var a;return i(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},n.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),i=qD(t);return"data:base64,".concat(i)}return null}function qD(s){let e="",t=new Uint8Array(s);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function US(s,e){if(typeof s=="string"){s=GS(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await im(s)}function Pf(s){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;let e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}function pr(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Pf()}var _a={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process};var XD=_a.self||_a.window||_a.global,Uc=_a.window||_a.self||_a.global,YD=_a.document||{},hu=_a.process||{};var nm=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",qbe=pr();var WS=globalThis;function Wc(s){if(!s&&!pr())return"Node";if(Pf(s))return"Electron";let t=s||(typeof navigator<"u"?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";let i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n?"IE":WS.chrome?"Chrome":WS.safari?"Safari":WS.mozInnerScreenX?"Firefox":"Unknown"}function KD(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var om=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";y(this,"storage",void 0),y(this,"id",void 0),y(this,"config",{}),this.storage=KD(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function YT(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function KT(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function sm(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,n=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>i&&(t=Math.min(t,i/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(n,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var am;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(am||(am={}));function ZT(s){return typeof s=="string"?am[s.toUpperCase()]||am.WHITE:s}function QT(s,e,t){return!pr&&typeof s=="string"&&(e&&(e=ZT(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=ZT(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function JT(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),i=Object.getOwnPropertyNames(t);for(let n of i)typeof s[n]=="function"&&(e.find(o=>n===o)||(s[n]=s[n].bind(s)))}function Hc(s,e){if(!s)throw new Error(e||"Assertion failed")}function du(){let s;if(pr&&"performance"in Uc){var e,t;s=Uc===null||Uc===void 0||(e=Uc.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in hu){var i;let n=hu===null||hu===void 0||(i=hu.hrtime)===null||i===void 0?void 0:i.call(hu);s=n[0]*1e3+n[1]/1e6}else s=Date.now();return s}var jc={debug:pr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},ZD={enabled:!0,level:0};function Sn(){}var $T={},e1={once:!0},Ai=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};y(this,"id",void 0),y(this,"VERSION",nm),y(this,"_startTs",du()),y(this,"_deltaTs",du()),y(this,"_storage",void 0),y(this,"userData",{}),y(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new om("__probe-".concat(this.id,"__"),ZD),this.userData={},this.timeStamp("".concat(this.id," started")),JT(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((du()-this._startTs).toPrecision(10))}getDelta(){return Number((du()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){Hc(e,t)}warn(e){return this._getLogFunction(0,e,jc.warn,arguments,e1)}error(e){return this._getLogFunction(0,e,jc.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,jc.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,jc.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),o=2;o<i;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,jc.debug||jc.info,arguments,e1)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Sn,i&&[i],{tag:eF(t)}):Sn}image(e){let{logLevel:t,priority:i,image:n,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?pr?$D({image:n,message:o,scale:a}):JD({image:n,message:o,scale:a}):Sn}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Sn)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},n=t1({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Sn)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=r1(e)}_getLogFunction(e,t,i,n,o){if(this._shouldLog(e)){o=t1({logLevel:e,message:t,args:n,opts:o}),i=i||o.method,Hc(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=du();let a=o.tag||o.message;if(o.once)if(!$T[a])$T[a]=du();else return Sn;return t=QD(this.id,o.message,o),i.bind(console,t,...o.args)}return Sn}};y(Ai,"VERSION",nm);function r1(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return Hc(Number.isFinite(e)&&e>=0),e}function t1(s){let{logLevel:e,message:t}=s;s.logLevel=r1(e);let i=s.args?Array.from(s.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let n=typeof s.message;return Hc(n==="string"||n==="object"),Object.assign(s,{args:i},s.opts)}function QD(s,e,t){if(typeof e=="string"){let i=t.time?KT(YT(t.total)):"";e=t.time?"".concat(s,": ").concat(i,"  ").concat(e):"".concat(s,": ").concat(e),e=QT(e,t.color,t.background)}return e}function JD(s){let{image:e,message:t="",scale:i=1}=s,n=null;try{n=module.require("asciify-image")}catch{}return n?()=>n(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):Sn}function $D(s){let{image:e,message:t="",scale:i=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=sm(o,t,i);console.log(...a)},o.src=e,Sn}let n=e.nodeName||"";if(n.toLowerCase()==="img")return console.log(...sm(e,t,i)),Sn;if(n.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...sm(o,t,i)),o.src=e.toDataURL(),Sn}return Sn}function eF(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var APe=new Ai({id:"@probe.gl/log"});var HS=new Ai({id:"loaders.gl"}),jS=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},qS=class{constructor(){y(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var XS={fetch:null,mimeType:void 0,nothrow:!1,log:new qS,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:au,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},i1={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function YS(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var s1=()=>{let s=YS();return s.globalOptions=s.globalOptions||{...XS},s.globalOptions};function a1(s,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],tF(s,t),iF(e,s,i)}function lm(s,e){let t=s1(),i=s||t;return typeof i.fetch=="function"?i.fetch:zc(i.fetch)?n=>US(n,i):e!=null&&e.fetch?e?.fetch:US}function tF(s,e){n1(s,null,XS,i1,e);for(let t of e){let i=s&&s[t.id]||{},n=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};n1(i,t.id,n,o,e)}}function n1(s,e,t,i,n){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&zc(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in i)HS.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(i[l],"'"))();else if(!u){let d=rF(l,n);HS.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function rF(s,e){let t=s.toLowerCase(),i="";for(let n of e)for(let o in n.options){if(s===o)return"Did you mean '".concat(n.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(i=i||"Did you mean '".concat(n.id,".").concat(o,"'?"))}return i}function iF(s,e,t){let n={...s.options||{}};return nF(n,t),n.log===null&&(n.log=new jS),o1(n,s1()),o1(n,e),n}function o1(s,e){for(let t in e)if(t in e){let i=e[t];VS(i)&&VS(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function nF(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function yf(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function Sf(s){var e,t;Ra(s,"null loader"),Ra(yf(s),"invalid loader");let i;return Array.isArray(s)&&(i=s[1],s=s[0],s={...s,options:{...s.options,...i}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var l1=()=>{let s=YS();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function KS(s){let e=l1();s=Array.isArray(s)?s:[s];for(let t of s){let i=Sf(t);e.find(n=>i===n)||e.unshift(i)}}function u1(){return l1()}var c1=new Ai({id:"loaders.gl"});var oF=/\.([^.]+)$/;async function f1(s,e=[],t,i){if(!p1(s))return null;let n=h1(s,e,{...t,nothrow:!0},i);if(n)return n;if(io(s)&&(s=await s.slice(0,10).arrayBuffer(),n=h1(s,e,t,i)),!n&&!(t!=null&&t.nothrow))throw new Error(g1(s));return n}function h1(s,e=[],t,i){if(!p1(s))return null;if(e&&!Array.isArray(e))return Sf(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...u1()),aF(n);let o=sF(s,n,t,i);if(!o&&!(t!=null&&t.nothrow))throw new Error(g1(s));return o}function sF(s,e,t,i){let{url:n,type:o}=cu(s),a=n||i?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=ZS(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||lF(e,a),u=u||(l?"matched url ".concat(a):""),l=l||ZS(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||cF(e,s),u=u||(l?"matched initial data ".concat(m1(s)):""),l=l||ZS(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;c1.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function p1(s){return!(s instanceof Response&&s.status===204)}function g1(s){let{url:e,type:t}=cu(s),i="No valid loader found (";i+=e?"".concat(tm.filename(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let n=s?m1(s):"";return i+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",i+=")",i}function aF(s){for(let e of s)Sf(e)}function lF(s,e){let t=e&&oF.exec(e),i=t&&t[1];return i?uF(s,i):null}function uF(s,e){e=e.toLowerCase();for(let t of s)for(let i of t.extensions)if(i.toLowerCase()===e)return t;return null}function ZS(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function cF(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(hF(e,t))return t}else if(ArrayBuffer.isView(e)){if(d1(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&d1(e,0,t))return t;return null}function hF(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>s.startsWith(i))}function d1(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>dF(s,e,t,n))}function dF(s,e,t,i){if(i instanceof ArrayBuffer)return BS(i,s,i.byteLength);switch(typeof i){case"function":return i(s,t);case"string":let n=QS(s,e,i.length);return i===n;default:return!1}}function m1(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?QS(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?QS(s,0,e):""}function QS(s,e,t){if(s.byteLength<e+t)return"";let i=new DataView(s),n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i.getUint8(e+o));return n}function*b1(s,e){let t=e?.chunkSize||262144,i=0,n=new TextEncoder;for(;i<s.length;){let o=Math.min(s.length-i,t),a=s.slice(i,i+o);i+=o,yield n.encode(a)}}function*P1(s,e={}){let{chunkSize:t=262144}=e,i=0;for(;i<s.byteLength;){let n=Math.min(s.byteLength-i,t),o=new ArrayBuffer(n),a=new Uint8Array(s,i,n);new Uint8Array(o).set(a),i+=n,yield o}}async function*y1(s,e){let t=e?.chunkSize||1048576,i=0;for(;i<s.size;){let n=i+t,o=await s.slice(i,n).arrayBuffer();i=n,yield o}}function JS(s,e){return au?fF(s,e):pF(s,e)}async function*fF(s,e){let t=s.getReader(),i;try{for(;;){let n=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());let{done:o,value:a}=await n;if(o)return;yield em(a)}}catch{t.releaseLock()}}async function*pF(s,e){for await(let t of s)yield em(t)}function S1(s,e){if(typeof s=="string")return b1(s,e);if(s instanceof ArrayBuffer)return P1(s,e);if(io(s))return y1(s,e);if(rm(s))return JS(s,e);if(ro(s))return JS(s.body,e);throw new Error("makeIterator")}var E1="Cannot convert supplied data type";function gF(s,e,t){if(e.text&&typeof s=="string")return s;if(HT(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let i=s.buffer,n=s.byteLength||s.length;return(s.byteOffset!==0||n!==i.byteLength)&&(i=i.slice(s.byteOffset,s.byteOffset+n)),i}throw new Error(E1)}async function x1(s,e,t){let i=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||i)return gF(s,e,t);if(io(s)&&(s=await im(s)),ro(s)){let n=s;return await XT(n),e.binary?await n.arrayBuffer():await n.text()}if(rm(s)&&(s=S1(s,t)),UT(s)||WT(s))return FS(s);throw new Error(E1)}function C1(s,e,t=null){if(t)return t;let i={fetch:lm(e,s),...s};return Array.isArray(i.loaders)||(i.loaders=null),i}function v1(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function um(s,e,t,i){ni(!i||typeof i=="object"),e&&!Array.isArray(e)&&!yf(e)&&(i=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:n}=cu(s),a=v1(e,i),l=await f1(s,a,t);return l?(t=a1(t,l,a,n),i=C1({url:n,parse:um,loaders:a},t,i),await mF(l,s,t,i)):null}async function mF(s,e,t,i){if(RS(s),ro(e)){let n=e,{ok:o,redirected:a,status:l,statusText:u,type:c,url:h}=n,d=Object.fromEntries(n.headers.entries());i.response={headers:d,ok:o,redirected:a,status:l,statusText:u,type:c,url:h}}if(e=await x1(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,i,s);if(_S(s,t))return await MS(s,e,t,i,um);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,i,s);if(s.parse)return await s.parse(e,t,i,s);throw ni(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function Ko(s,e,t,i){!Array.isArray(e)&&!yf(e)&&(i=void 0,t=e,e=void 0);let n=lm(t),o=s;return typeof s=="string"&&(o=await n(s)),io(s)&&(o=await n(s)),await um(o,e,t)}var A1="3.2.6";var{_parseImageNode:bF}=globalThis,$S=typeof Image<"u",eE=typeof ImageBitmap<"u",PF=Boolean(bF),tE=au?!0:PF;function T1(s){switch(s){case"auto":return eE||$S||tE;case"imagebitmap":return eE;case"image":return $S;case"data":return tE;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function I1(){if(eE)return"imagebitmap";if($S)return"image";if(tE)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function yF(s){let e=SF(s);if(!e)throw new Error("Not an image");return e}function w1(s){switch(yF(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function SF(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var EF=/^data:image\/svg\+xml/,xF=/\.svg((\?|#).*)?$/;function cm(s){return s&&(EF.test(s)||xF.test(s))}function L1(s,e){if(cm(e)){let i=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return rE(s,e)}function rE(s,e){if(cm(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function Ef(s,e,t){let i=L1(s,t),n=self.URL||self.webkitURL,o=typeof i!="string"&&n.createObjectURL(i);try{return await CF(o||i,e)}finally{o&&n.revokeObjectURL(o)}}async function CF(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,n)=>{try{t.onload=()=>i(t),t.onerror=o=>n(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){n(o)}})}var vF={},O1=!0;async function iE(s,e,t){let i;cm(t)?i=await Ef(s,e,t):i=rE(s,t);let n=e&&e.imagebitmap;return await AF(i,n)}async function AF(s,e=null){if((TF(e)||!O1)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),O1=!1}return await createImageBitmap(s)}function TF(s){for(let e in s||vF)return!1;return!0}function hm(s){let e=xf(s);return IF(e)||OF(e)||wF(e)||LF(e)}function IF(s){let e=xf(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function wF(s){let e=xf(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function LF(s){let e=xf(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function OF(s){let e=xf(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:i,sofMarkers:n}=RF(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(n.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!i.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function RF(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function xf(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function nE(s,e){let{mimeType:t}=hm(s)||{},i=globalThis._parseImageNode;return Ra(i),await i(s,t)}async function oE(s,e,t){e=e||{};let n=(e.image||{}).type||"auto",{url:o}=t||{},a=_F(n),l;switch(a){case"imagebitmap":l=await iE(s,e,o);break;case"image":l=await Ef(s,e,o);break;case"data":l=await nE(s,e);break;default:Ra(!1)}return n==="data"&&(l=w1(l)),l}function _F(s){switch(s){case"auto":case"data":return I1();default:return T1(s),s}}var MF=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],NF=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],BF={image:{type:"auto",decode:!0}},fu={id:"image",module:"images",name:"Images",version:A1,mimeTypes:NF,extensions:MF,parse:oE,tests:[s=>Boolean(hm(new DataView(s)))],options:BF};var ce=new Ai({id:"deck"});var sE={};function R1(s){sE=s}function kt(s,e,t,i){ce.level>0&&sE[s]&&sE[s].call(null,e,t,i)}function DF(s){let e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}var _1={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:DF,parseTextSync:JSON.parse};var Cf="8.8.6",dm=globalThis.deck&&globalThis.deck.VERSION;if(dm&&dm!==Cf)throw new Error("deck.gl - multiple versions detected: ".concat(dm," vs ").concat(Cf));dm||(ce.log(1,"deck.gl ".concat(Cf))(),globalThis.deck={...globalThis.deck,VERSION:Cf,version:Cf,log:ce,_registerLoggers:R1},KS([_1,[fu,{imagebitmap:{premultiplyAlpha:"none"}}]]));var M1=globalThis.deck;var ie=new Ai({id:"luma.gl"});function Kt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var FF="Invalid WebGLRenderingContext";var GF="Requires WebGL2";function Bs(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function fe(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function aE(s){return fe(s)?s:null}function Ds(s){return Kt(Bs(s),FF),s}function At(s){return Kt(fe(s),GF),s}var vf={};function VF(s){globalThis.console&&globalThis.console.error&&globalThis.console.error(s)}function kF(s){globalThis.console&&globalThis.console.log&&globalThis.console.log(s)}function zF(s,e){vf[s]=!0,e!==void 0&&VF(e)}function UF(s){let e=s.getError;s.getError=function(){let i;do i=e.apply(s),i!==0&&(vf[i]=!0);while(i!==0);for(i in vf)if(vf[i])return delete vf[i],parseInt(i,10);return 0}}var Af=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){let n=new s.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};Af.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};Af.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var pu=function(e){let t=this;this.gl=e,UF(e);let i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let f=d.attribs[o];return f.buffer=t.currentArrayBuffer,f.size=a,f.type=l,f.normalized=u,f.stride=c,f.offset=h,f.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{kF("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};pu.prototype.VERTEX_ARRAY_BINDING_OES=34229;pu.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new Af(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};pu.prototype.createVertexArrayOES=function(){let e=new Af(this);return this.vertexArrayObjects.push(e),e};pu.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};pu.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof Af&&e.hasBeenBound&&e.ext===this)};pu.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){zF(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(n===o)return;(!n||o.elementArrayBuffer!==n.elementArrayBuffer)&&i.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(n?n.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=n?n.attribs[u]:null;if((!n||c.enabled!==h.enabled)&&(c.enabled?i.enableVertexAttribArray.call(t,u):i.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!n||c.buffer!==h.buffer)&&(a!==c.buffer&&(i.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&i.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};function N1(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let n=e.call(this)||[];return n.indexOf("OES_vertex_array_object")<0&&n.push("OES_vertex_array_object"),n};let t=s.getExtension;s.getExtension=function(n){let o=t.call(this,n);return o||(n!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new pu(this)),this.__OESVertexArrayObject))}}var B1="OES_element_index",D1="WEBGL_draw_buffers",WF="EXT_disjoint_timer_query",HF="EXT_disjoint_timer_query_webgl2",jF="EXT_texture_filter_anisotropic",F1="WEBGL_debug_renderer_info",qF=35723,XF=4352,YF=36795,KF=34047,ZF=37445,QF=37446,Pt=s=>fe(s)?void 0:0,JF={[3074]:s=>fe(s)?void 0:36064,[qF]:s=>fe(s)?void 0:XF,[35977]:Pt,[32937]:Pt,[YF]:(s,e)=>{let t=fe(s)?s.getExtension(HF):s.getExtension(WF);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[ZF]:(s,e)=>{let t=s.getExtension(F1);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[QF]:(s,e)=>{let t=s.getExtension(F1);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[KF]:(s,e)=>{let t=s.luma.extensions[jF];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:Pt,[35071]:Pt,[37447]:Pt,[36063]:(s,e)=>{if(!fe(s)){let t=s.getExtension(D1);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:Pt,[35374]:Pt,[35377]:Pt,[34852]:s=>{if(!fe(s)){let e=s.getExtension(D1);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(B1)?2147483647:65535,[33001]:s=>s.getExtension(B1)?16777216:65535,[33e3]:s=>16777216,[37157]:Pt,[35373]:Pt,[35657]:Pt,[36183]:Pt,[37137]:Pt,[34045]:Pt,[35978]:Pt,[35979]:Pt,[35968]:Pt,[35376]:Pt,[35375]:Pt,[35659]:Pt,[37154]:Pt,[35371]:Pt,[35658]:Pt,[35076]:Pt,[35077]:Pt,[35380]:Pt};function G1(s,e,t){let i=JF[t],n=typeof i=="function"?i(s,e,t):i;return n!==void 0?n:e(t)}var $F="OES_vertex_array_object",V1="ANGLE_instanced_arrays",eG="WEBGL_draw_buffers",tG="EXT_disjoint_timer_query",rG="EXT_texture_filter_anisotropic",iG="VertexArray requires WebGL2 or OES_vertex_array_object extension";function nG(s,e){return{webgl2:fe(s),ext:s.getExtension(e)}}var lE={[$F]:{meta:{suffix:"OES"},createVertexArray:()=>{Kt(!1,iG)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[V1]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){Kt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[eG]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Kt(!1)}},[tG]:{meta:{suffix:"EXT"},createQuery:()=>{Kt(!1)},deleteQuery:()=>{Kt(!1)},beginQuery:()=>{Kt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},fm={readBuffer:(s,e,t)=>{fe(s)&&e(t)},getVertexAttrib:(s,e,t,i)=>{let{webgl2:n,ext:o}=nG(s,V1),a;switch(i){case 35069:a=n?void 0:!1;break;case 35070:a=!n&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,i)},getProgramParameter:(s,e,t,i)=>{if(!fe(s))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,i)},getInternalformatParameter:(s,e,t,i,n)=>{if(!fe(s))switch(n){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,i,n)},getTexParameter(s,e,t,i){switch(i){case 34046:let{extensions:n}=s.luma,o=n[rG];i=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,i)},getParameter:G1,hint(s,e,t,i){return e(t,i)}};function k1(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(N1(s),oG(s),aG(s,lE),sG(s,{target:e,target2:s}),e.polyfilled=!0),s}globalThis.polyfillContext=k1;function oG(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function sG(s,e){let{target:t,target2:i}=e;Object.keys(fm).forEach(n=>{if(typeof fm[n]=="function"){let o=s[n]?s[n].bind(s):()=>{},a=fm[n].bind(null,s,o);t[n]=a,i[n]=a}})}function aG(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&lG(s,{extension:t,target:s.luma,target2:s})}function lG(s,e){let{extension:t,target:i,target2:n}=e,o=lE[t];Kt(o);let{meta:a={}}=o,{suffix:l=""}=a,u=s.getExtension(t);for(let c of Object.keys(o)){let h="".concat(c).concat(l),d=null;c==="meta"||typeof s[c]=="function"||(u&&typeof u[h]=="function"?d=function(){return u[h](...arguments)}:typeof o[c]=="function"&&(d=o[c].bind(i))),d&&(i[c]=d,n[c]=d)}}var If={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Ma=(s,e,t)=>e?s.enable(t):s.disable(t),z1=(s,e,t)=>s.hint(t,e),Ji=(s,e,t)=>s.pixelStorei(t,e),uG=(s,e)=>{let t=fe(s)?36009:36160;return s.bindFramebuffer(t,e)},cG=(s,e)=>s.bindFramebuffer(36008,e);function Tf(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var U1={[3042]:Ma,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Ma,[2885]:(s,e)=>s.cullFace(e),[2929]:Ma,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Ma,[35723]:z1,[36006]:uG,[2886]:(s,e)=>s.frontFace(e),[33170]:z1,[2849]:(s,e)=>s.lineWidth(e),[32823]:Ma,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Ma,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Ma,[3088]:(s,e)=>s.scissor(...e),[2960]:Ma,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:Ji,[3317]:Ji,[37440]:Ji,[37441]:Ji,[37443]:Ji,[3330]:Ji,[3332]:Ji,[3331]:Ji,[36010]:cG,[3314]:Ji,[32878]:Ji,[3316]:Ji,[3315]:Ji,[32877]:Ji,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=Tf(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=Tf(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=Tf(e)?e:[e,e];let[t,i]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,i)},stencilFunc:(s,e)=>{e=Tf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilFuncSeparate(1028,t,i,n),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=Tf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilOpSeparate(1028,t,i,n),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function zt(s,e,t){return e[s]!==void 0?e[s]:t[s]}var W1={blendEquation:(s,e,t)=>s.blendEquationSeparate(zt(32777,e,t),zt(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(zt(32969,e,t),zt(32968,e,t),zt(32971,e,t),zt(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(zt(32824,e,t),zt(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(zt(32938,e,t),zt(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,zt(2962,e,t),zt(2967,e,t),zt(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,zt(34816,e,t),zt(36003,e,t),zt(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,zt(2964,e,t),zt(2965,e,t),zt(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,zt(34817,e,t),zt(34818,e,t),zt(34819,e,t))},uE={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,i,n)=>s({[32773]:new Float32Array([e,t,i,n])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,i,n)=>s({[32969]:e,[32968]:t,[32971]:i,[32970]:n}),clearColor:(s,e,t,i,n)=>s({[3106]:new Float32Array([e,t,i,n])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,i,n)=>s({[3107]:[e,t,i,n]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,i,n)=>s({[3088]:new Int32Array([e,t,i,n])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,i)=>s({[2962]:e,[2967]:t,[2963]:i,[34816]:e,[36003]:t,[36004]:i}),stencilFuncSeparate:(s,e,t,i,n)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:n}),stencilOp:(s,e,t,i)=>s({[2964]:e,[2965]:t,[2966]:i,[34817]:e,[34818]:t,[34819]:i}),stencilOpSeparate:(s,e,t,i,n)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:n}),viewport:(s,e,t,i,n)=>s({[2978]:[e,t,i,n]})},Zo=(s,e)=>s.isEnabled(e),cE={[3042]:Zo,[2884]:Zo,[2929]:Zo,[3024]:Zo,[32823]:Zo,[32926]:Zo,[32928]:Zo,[3089]:Zo,[2960]:Zo,[35977]:Zo};function hE(s){for(let e in s)return!1;return!0}function H1(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&s.length===e.length){for(let n=0;n<s.length;++n)if(s[n]!==e[n])return!1;return!0}return!1}function j1(s,e){let t=s[e].bind(s);s[e]=function(){let n=arguments.length<=0?void 0:arguments[0];return n in s.state.cache?s.state.enable?s.state.cache[n]:t(...arguments):t(...arguments)},Object.defineProperty(s[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function hG(s,e,t){let i=s[e].bind(s);s[e]=function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];let{valueChanged:u,oldValue:c}=t(s.state._updateCache,...a);return u&&i(...a),c},Object.defineProperty(s[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}function dG(s){let e=s.useProgram.bind(s);s.useProgram=function(i){s.state.program!==i&&(e(i),s.state.program=i)}}var q1=class{constructor(e){let{copyState:t=!1,log:i=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?mm(e):Object.assign({},If),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.stateStack.push({})}pop(){Kt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];Ti(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,i,n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){Kt(o!==void 0);let a=e[o],l=this.cache[o];H1(a,l)||(t=!0,i=l,n&&!(o in n)&&(n[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:i}}};function pm(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{enable:t=!0,copyState:i}=e;if(Kt(i!==void 0),!s.state){let{polyfillContext:n}=globalThis;n&&n(s),s.state=new q1(s,{copyState:i}),dG(s);for(let o in uE){let a=uE[o];hG(s,o,a)}j1(s,"getParameter"),j1(s,"isEnabled")}return s.state.enable=t,s}function dE(s){s.state||pm(s,{copyState:!1}),s.state.push()}function gm(s){Kt(s.state),s.state.pop()}function Ti(s,e){if(Kt(Bs(s),"setParameters requires a WebGL context"),hE(e))return;let t={};for(let n in e){let o=Number(n),a=U1[n];a&&(typeof a=="string"?t[a]=!0:a(s,e[n],o))}let i=s.state&&s.state.cache;if(i)for(let n in t)W1[n](s,e,i)}function mm(s,e){if(e=e||If,typeof e=="number"){let n=e,o=cE[n];return o?o(s,n):s.getParameter(n)}let t=Array.isArray(e)?e:Object.keys(e),i={};for(let n of t){let o=cE[n];i[n]=o?o(s,Number(n)):s.getParameter(Number(n))}return i}function bm(s){Ti(s,If)}function yt(s,e,t){if(hE(e))return t(s);let{nocatch:i=!0}=e;dE(s),Ti(s,e);let n;if(i)n=t(s),gm(s);else try{n=t(s)}finally{gm(s)}return n}function no(s){let{luma:e}=s;if(s.canvas&&e){let{clientWidth:t}=e.canvasSizeInfo;return t?s.drawingBufferWidth/t:1}return 1}function qc(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=no(s),n=s.drawingBufferWidth,o=s.drawingBufferHeight;return fG(e,i,n,o,t)}function K1(s){let e=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(s)?s<=0?1:s:s?e:1}function fG(s,e,t,i,n){let o=X1(s[0],e,t),a=Y1(s[1],e,i,n),l=X1(s[0]+1,e,t),u=l===t-1?l:l-1;l=Y1(s[1]+1,e,i,n);let c;return n?(l=l===0?l:l+1,c=a,a=l):c=l===i-1?l:l-1,{x:o,y:a,width:Math.max(u-o+1,1),height:Math.max(c-a+1,1)}}function X1(s,e,t){return Math.min(Math.round(s*e),t-1)}function Y1(s,e,t,i){return i?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}var fE=pr(),pG=fE&&typeof document<"u",Z1={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function Xc(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Kt(fE,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),s=Object.assign({},Z1,s);let{width:e,height:t}=s;function i(l){if(s.throwOnError)throw new Error(l);return console.error(l),null}s.onError=i;let n,{canvas:o}=s,a=mG({canvas:o,width:e,height:t,onError:i});return n=gG(a,s),n?(n=gu(n,s),bG(n),n):null}function gu(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!s||s._instrumented)return s;s._version=s._version||PG(s),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{},e=Object.assign({},Z1,e);let{manageState:t,debug:i}=e;return t&&pm(s,{copyState:!1,log:function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return ie.log(1,...o)()}}),fE&&i&&(globalThis.makeDebugContext?(s=globalThis.makeDebugContext(s,e),ie.level=Math.max(ie.level,1)):ie.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),s._instrumented=!0,s}function Q1(s){let e=s.getParameter(7936),t=s.getParameter(7937),i=s.getExtension("WEBGL_debug_renderer_info"),n=i&&s.getParameter(i.UNMASKED_VENDOR_WEBGL||7936),o=i&&s.getParameter(i.UNMASKED_RENDERER_WEBGL||7937);return{vendor:n||e,renderer:o||t,vendorMasked:e,rendererMasked:t,version:s.getParameter(7938),shadingLanguageVersion:s.getParameter(35724)}}function pE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(s.canvas){let i=K1(e.useDevicePixels);yG(s,i,e);return}let t=s.getExtension("STACKGL_resize_drawingbuffer");t&&"width"in e&&"height"in e&&t.resize(e.width,e.height)}function gG(s,e){let{onError:t}=e,i=null,n=u=>i=u.statusMessage||i;s.addEventListener("webglcontextcreationerror",n,!1);let{webgl1:o=!0,webgl2:a=!0}=e,l=null;return a&&(l=l||s.getContext("webgl2",e),l=l||s.getContext("experimental-webgl2",e)),o&&(l=l||s.getContext("webgl",e),l=l||s.getContext("experimental-webgl",e)),s.removeEventListener("webglcontextcreationerror",n,!1),l?(e.onContextLost&&s.addEventListener("webglcontextlost",e.onContextLost,!1),e.onContextRestored&&s.addEventListener("webglcontextrestored",e.onContextRestored,!1),l):t("Failed to create ".concat(a&&!o?"WebGL2":"WebGL"," context: ").concat(i||"Unknown error"))}function mG(s){let{canvas:e,width:t=800,height:i=600,onError:n}=s,o;return typeof e=="string"?(pG&&document.readyState==="complete"||n("createGLContext called on canvas '".concat(e,"' before page was loaded")),o=document.getElementById(e)):e?o=e:(o=document.createElement("canvas"),o.id="lumagl-canvas",o.style.width=Number.isFinite(t)?"".concat(t,"px"):"100%",o.style.height=Number.isFinite(i)?"".concat(i,"px"):"100%",document.body.insertBefore(o,document.body.firstChild)),o}function bG(s){let e=fe(s)?"WebGL2":"WebGL1",t=Q1(s),i=t?"(".concat(t.vendor,",").concat(t.renderer,")"):"",n=s.debug?" debug":"";ie.info(1,"".concat(e).concat(n," context ").concat(i))()}function PG(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?2:1}function yG(s,e,t){let i="width"in t?t.width:s.canvas.clientWidth,n="height"in t?t.height:s.canvas.clientHeight;(!i||!n)&&(ie.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=s.canvas.width||1,n=s.canvas.height||1),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{};let o=s.luma.canvasSizeInfo;if(o.clientWidth!==i||o.clientHeight!==n||o.devicePixelRatio!==e){let a=e,l=Math.floor(i*a),u=Math.floor(n*a);s.canvas.width=l,s.canvas.height=u,(s.drawingBufferWidth!==l||s.drawingBufferHeight!==u)&&(ie.warn("Device pixel ratio clamped")(),a=Math.min(s.drawingBufferWidth/i,s.drawingBufferHeight/n),s.canvas.width=Math.floor(i*a),s.canvas.height=Math.floor(n*a)),Object.assign(s.luma.canvasSizeInfo,{clientWidth:i,clientHeight:n,devicePixelRatio:e})}}var wf="8.5.16",SG="set luma.log.level=1 (or higher) to trace rendering",Pm=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new yn({id:e})),this.stats.get(e)}},En=new Pm;if(globalThis.luma&&globalThis.luma.VERSION!==wf)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(wf));globalThis.luma||(pr()&&ie.log(1,"luma.gl ".concat(wf," - ").concat(SG))(),globalThis.luma=globalThis.luma||{VERSION:wf,version:wf,log:ie,stats:En,globals:{modules:{},nodeIO:{}}});var PSe=globalThis.luma;function gE(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function mE(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}function K(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function ym(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let i=s[e];return K(i!==void 0,"Accessing undefined constant GL.".concat(e)),i}function xn(s,e){e=Number(e);for(let t in s)if(s[t]===e)return"GL.".concat(t);return String(e)}var bE={};function Ii(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";bE[s]=bE[s]||1;let e=bE[s]++;return"".concat(s,"-").concat(e)}function PE(s){return K(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function Qo(s){let e=!0;for(let t in s){e=!1;break}return e}function Sm(s,e,t,i){let n="See luma.gl ".concat(t," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),o=Object.getPrototypeOf(s);i.forEach(a=>{o.methodName||(o[a]=()=>{throw ie.removed("Calling removed method ".concat(e,".").concat(a,": "),n)(),new Error(a)})})}var Yc="Resource subclass must define virtual methods",sr=class{get[Symbol.toStringTag](){return"Resource"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ds(e);let{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||Ii(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._initStats(),this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(i=>i.delete()),this}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e=ym(this.gl,e),K(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=fe(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){let l=n.webgl1,u="webgl2"in n?n.webgl2:n.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},o=fe(this.gl),a={},l=t||Object.keys(n);for(let u of l){let c=n[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=i?xn(this.gl,u):u;a[d]=this.getParameter(u,e),i&&c.type==="GLenum"&&(a[d]=xn(this.gl,a[d]))}}return a}setParameter(e,t){e=ym(this.gl,e),K(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=fe(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");n.type==="GLenum"&&(t=ym(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return Sm(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(Yc)}_deleteHandle(){throw new Error(Yc)}_bindHandle(e){throw new Error(Yc)}_getOptsFromHandle(){throw new Error(Yc)}_getParameter(e,t){throw new Error(Yc)}_setParameter(e,t){throw new Error(Yc)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_initStats(){this.gl.stats=this.gl.stats||new Pm}_addStats(){let e=this[Symbol.toStringTag],t=En.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get("".concat(e,"s Created")).incrementCount(),t.get("".concat(e,"s Active")).incrementCount()}_removeStats(){let e=this[Symbol.toStringTag];En.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._doTrackAllocatedMemory(e,t),this._doTrackAllocatedMemory(e,t,this.gl.stats.get("Memory Usage"))}_doTrackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:En.get("Memory Usage");i.get("GPU Memory").addCount(e),i.get("".concat(t," Memory")).addCount(e),this.byteLength=e}_trackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._doTrackDeallocatedMemory(e),this._doTrackDeallocatedMemory(e,this.gl.stats.get("Memory Usage"))}_doTrackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:En.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get("".concat(e," Memory")).subtractCount(this.byteLength),this.byteLength=0}};var EG="Failed to deduce GL constant from typed array";function Lf(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(EG)}}function Na(s){let{clamped:e=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function J1(s){let{data:e,width:t,height:i,bytesPerPixel:n=4,temp:o}=s,a=t*n;o=o||new Uint8Array(a);for(let l=0;l<i/2;++l){let u=l*a,c=(i-l-1)*a;o.set(e.subarray(u,u+a)),e.copyWithin(u,c,c+a),e.set(o,c)}}function $1(s){let{data:e,width:t,height:i}=s,n=Math.round(t/2),o=Math.round(i/2),a=new Uint8Array(n*o*4);for(let l=0;l<o;l++)for(let u=0;u<n;u++)for(let c=0;c<4;c++)a[(l*n+u)*4+c]=e[(l*2*t+u*2)*4+c];return{data:a,width:n,height:o}}function Of(s,e,t){let{removedProps:i={},deprecatedProps:n={},replacedProps:o={}}=t;for(let l in i)if(l in e){let c=i[l]?"".concat(s,".").concat(i[l]):"N/A";ie.removed("".concat(s,".").concat(l),c)()}for(let l in n)if(l in e){let u=n[l];ie.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))()}let a=null;for(let l in o)if(l in e){let u=o[l];ie.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var xG={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},CG={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},Ar=class{static getBytesPerElement(e){return Na(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return K(e.size),Na(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new Ar(...[xG,...t])}constructor(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach(n=>this._assign(n)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return Ar.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return Ar.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e=Of("Accessor",e,CG),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var eI=10,tI={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},vG={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:tI},AG={removedProps:tI},ve=class extends sr{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/Ar.getBytesPerElement(e))}getVertexCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/Ar.getBytesPerVertex(e))}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Of("Buffer",e,vG),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Of("Buffer",e,AG),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new Ar(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:i=0,srcOffset:n=0}=e,o=e.byteLength||e.length;K(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),n!==0||o!==void 0?(At(this.gl),this.gl.bufferSubData(this.target,i,t,n,o)):this.gl.bufferSubData(a,i,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData(e){let{sourceBuffer:t,readOffset:i=0,writeOffset:n=0,size:o}=e,{gl:a}=this;return At(a),a.bindBuffer(36662,t.handle),a.bindBuffer(36663,this.handle),a.copyBufferSubData(36662,36663,i,n,o),a.bindBuffer(36662,null),a.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};At(this.gl);let o=Na(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=i,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,n||a),c=l+u);let h=Math.min(a,u);return n=n||h,K(n<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?n!==void 0?this.gl.bindBufferRange(e,t,this.handle,i,n):(K(i===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(eI,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e.byteLength+t;K(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,eI),this.bytesUsed=i,this._trackAllocatedMemory(i);let o=Lf(e);return K(o),this.setAccessor(new Ar(this.accessor,{type:o})),this}_setByteLength(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;K(e>=0),this._trackDeallocatedMemory();let i=e;e===0&&(i=new Float32Array(0));let n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=Na(this.accessor.type||5126,{clamped:!1}),i=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(e){this.accessor.type||this.setAccessor(new Ar(this.accessor,{type:Lf(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return ie.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return ie.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return ie.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return ie.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new Ar(this.accessor,e),this}};var Em={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},xm={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},Cm={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function rI(s,e){let t=Em[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let i=fe(s)&&t.gl2||t.gl1;return typeof i=="string"?s.getExtension(i):i}function iI(s,e){let t=Em[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var TG=[9729,9728],nI=globalThis.WebGLBuffer||function(){},wi=class extends sr{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{format:i,linearFiltering:n}=t,o=!0;return i&&(o=o&&rI(e,i),o=o&&(!n||iI(e,i))),o}constructor(e,t){let{id:i=Ii("texture"),handle:n,target:o}=t;super(e,{id:i,handle:n});this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data;if(t instanceof Promise)return t.then(M=>this.initialize(Object.assign({},e,{pixels:M,data:M}))),this;let i=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:n=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=n);let{width:d,height:f,dataFormat:p,type:S,compressed:x=!1,mipmaps:T=!0}=e,{depth:O=0}=e;return{width:d,height:f,compressed:x,dataFormat:p,type:S}=this._deduceParameters({format:o,type:S,dataFormat:p,compressed:x,data:t,width:d,height:f}),this.width=d,this.height=f,this.depth=O,this.format=o,this.type=S,this.dataFormat=p,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),T&&this._isNPOT()&&(ie.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),T=!1,this._updateForNPOT(u)),this.mipmaps=T,this.setImageData({data:t,width:d,height:f,depth:O,format:o,type:S,dataFormat:p,border:a,mipmaps:T,parameters:c,compressed:x}),T&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),i&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:t,width:i,mipmaps:n=!1}=e;return i!==this.width||t!==this.height?this.initialize({width:i,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(ie.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),yt(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:i=null,level:n=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:f=this.height,dataFormat:p=this.dataFormat,compressed:S=!1}=e;c||(c=i),{type:h,dataFormat:p,compressed:S,width:d,height:f}=this._deduceParameters({format:o,type:h,dataFormat:p,compressed:S,data:c,width:d,height:f});let{gl:x}=this;x.bindTexture(this.target,this.handle);let T=null;({data:c,dataType:T}=this._getDataType({data:c,compressed:S}));let O,M=0;if(yt(this.gl,u,()=>{switch(T){case"null":x.texImage2D(t,n,o,d,f,a,p,h,c);break;case"typed-array":x.texImage2D(t,n,o,d,f,a,p,h,c,l);break;case"buffer":O=At(x),O.bindBuffer(35052,c.handle||c),O.texImage2D(t,n,o,d,f,a,p,h,l),O.bindBuffer(35052,null);break;case"browser-object":fe(x)?x.texImage2D(t,n,o,d,f,a,p,h,c):x.texImage2D(t,n,o,p,h,c);break;case"compressed":for(let[R,N]of c.entries())x.compressedTexImage2D(t,R,N.format,N.width,N.height,a,N.data),M+=N.levelSize;break;default:K(!1,"Unknown image data type")}}),T==="compressed")this._trackAllocatedMemory(M,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let R=xm[this.dataFormat]||4,N=Cm[this.type]||1;this._trackAllocatedMemory(this.width*this.height*R*N,"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:t=this.target,pixels:i=null,data:n=null,x:o=0,y:a=0,width:l=this.width,height:u=this.height,level:c=0,format:h=this.format,type:d=this.type,dataFormat:f=this.dataFormat,compressed:p=!1,offset:S=0,border:x=this.border,parameters:T={}}=e;if({type:d,dataFormat:f,compressed:p,width:l,height:u}=this._deduceParameters({format:h,type:d,dataFormat:f,compressed:p,data:n,width:l,height:u}),K(this.depth===0,"texSubImage not supported for 3D textures"),n||(n=i),n&&n.data){let O=n;n=O.data,l=O.shape[0],u=O.shape[1]}n instanceof ve&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),yt(this.gl,T,()=>{if(p)this.gl.compressedTexSubImage2D(t,c,o,a,l,u,h,n);else if(n===null)this.gl.texSubImage2D(t,c,o,a,l,u,f,d,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(t,c,o,a,l,u,f,d,n,S);else if(n instanceof nI){let O=At(this.gl);O.bindBuffer(35052,n),O.texSubImage2D(t,c,o,a,l,u,f,d,S),O.bindBuffer(35052,null)}else fe(this.gl)?At(this.gl).texSubImage2D(t,c,o,a,l,u,f,d,n):this.gl.texSubImage2D(t,c,o,a,f,d,n)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType(e){let{data:t,compressed:i=!1}=e;return i?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof ve?{data:t.handle,dataType:"buffer"}:t instanceof nI?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:i}=e,{width:n,height:o,dataFormat:a,type:l,compressed:u}=e,c=Em[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:n,height:o}=this._deduceImageSize(i,n,o),{dataFormat:a,type:l,compressed:u,width:n,height:o,format:t,data:i}}_deduceImageSize(e,t,i){let n;return typeof ImageData<"u"&&e instanceof ImageData?n={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?n={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?n={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?n={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?n={width:e.videoWidth,height:e.videoHeight}:e?n={width:t,height:i}:n={width:t>=0?t:1,height:i>=0?i:1},K(n,"Could not deduced texture size"),K(t===void 0||n.width===t,"Deduced texture width does not match supplied width"),K(i===void 0||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:K(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return fe(this.gl)||!this.width||!this.height?!1:!PE(this.width)||!PE(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:TG.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var IG="";function oI(s,e){return K(typeof s=="string"),s=IG+s,new Promise((t,i)=>{try{let n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error("Could not load image ".concat(s,"."))),n.crossOrigin=e&&e.crossOrigin||"anonymous",n.src=s}catch(n){i(n)}})}var Je=class extends wi{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return wi.isSupported(e,t)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ds(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:oI(t.data)}));super(e,Object.assign({},t,{target:3553}));this.initialize(t),Object.seal(this)}};var yE=[34069,34070,34071,34072,34073,34074],Kc=class extends wi{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ds(e);super(e,Object.assign({},t,{target:34067}));this.initialize(t),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)}),this}subImage(e){let{face:t,data:i,x:n=0,y:o=0,mipmapLevel:a=0}=e;return this._subImage({target:t,data:i,x:n,y:o,mipmapLevel:a})}async setCubeMapImageData(e){let{width:t,height:i,pixels:n,data:o,border:a=0,format:l=6408,type:u=5121}=e,{gl:c}=this,h=n||o,d=await Promise.all(yE.map(f=>{let p=h[f];return Promise.all(Array.isArray(p)?p:[p])}));this.bind(),yE.forEach((f,p)=>{d[p].length>1&&this.opts.mipmaps!==!1&&ie.warn("".concat(this.id," has mipmap and multiple LODs."))(),d[p].forEach((S,x)=>{t&&i?c.texImage2D(f,x,l,t,i,a,l,u,S):c.texImage2D(f,x,l,l,u,S)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:i,height:n,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(f=>this.setImageDataForFace(Object.assign({},e,{face:t,data:f,pixels:f}))):this.width||this.height?h.texImage2D(t,0,u,i,n,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};Kc.FACES=yE;var Rf=class extends wi{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};At(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1});super(e,t);this.initialize(t),Object.seal(this)}setImageData(e){let{level:t=0,dataFormat:i=6408,width:n,height:o,depth:a=1,border:l=0,format:u,type:c=5121,offset:h=0,data:d,parameters:f={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),yt(this.gl,f,()=>{ArrayBuffer.isView(d)&&this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,d),d instanceof ve&&(this.gl.bindBuffer(35052,d.handle),this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,h))}),d&&d.byteLength)this._trackAllocatedMemory(d.byteLength,"Texture");else{let p=xm[this.dataFormat]||4,S=Cm[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*p*S,"Texture")}return this.loaded=!0,this}};var mu="EXT_color_buffer_float",SE={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:mu,bpp:2},[33327]:{gl2:mu,bpp:4},[34842]:{gl2:mu,bpp:8},[33326]:{gl2:mu,bpp:4},[33328]:{gl2:mu,bpp:8},[34836]:{gl2:mu,bpp:16},[35898]:{gl2:mu,bpp:4}};function wG(s,e,t){let i=t[e];if(!i)return!1;let n=fe(s)&&i.gl2||i.gl1;return typeof n=="string"?s.getExtension(n):n}var $i=class extends sr{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!t||wG(e,t,SE)}static getSamplesForFormat(e,t){let{format:i}=t;return e.getInternalformatParameter(36161,i,32937)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.initialize(t),Object.seal(this)}initialize(e){let{format:t,width:i=1,height:n=1,samples:o=0}=e;return K(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),o!==0&&fe(this.gl)?this.gl.renderbufferStorageMultisample(36161,o,t,i,n):this.gl.renderbufferStorage(36161,t,i,n),this.format=t,this.width=i,this.height=n,this.samples=o,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*SE[this.format].bpp),this}resize(e){let{width:t,height:i}=e;return t!==this.width||i!==this.height?this.initialize({width:t,height:i,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var LG=256,OG=1024,RG=16384,sI=6144,aI=6145,lI=6146,uI=34041,cI="clear: bad arguments";function Ba(s){let{framebuffer:e=null,color:t=null,depth:i=null,stencil:n=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o={};e&&(o.framebuffer=e);let a=0;t&&(a|=RG,t!==!0&&(o.clearColor=t)),i&&(a|=LG,i!==!0&&(o.clearDepth=i)),n&&(a|=OG,i!==!0&&(o.clearStencil=i)),K(a!==0,cI),yt(s,o,()=>{s.clear(a)})}function EE(s){let{framebuffer:e=null,buffer:t=sI,drawBuffer:i=0,value:n=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};At(s),yt(s,{framebuffer:e},()=>{switch(t){case sI:switch(n.constructor){case Int32Array:s.clearBufferiv(t,i,n);break;case Uint32Array:s.clearBufferuiv(t,i,n);break;case Float32Array:default:s.clearBufferfv(t,i,n)}break;case aI:s.clearBufferfv(aI,0,[n]);break;case lI:s.clearBufferiv(lI,0,[n]);break;case uI:let[o,a]=n;s.clearBufferfi(uI,0,o,a);break;default:K(!1,cI)}})}function hI(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return K(!1),0}}function Fs(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{sourceX:t=0,sourceY:i=0,sourceFormat:n=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=dI(s);K(h);let{gl:f,handle:p,attachments:S}=h;l=l||h.width,u=u||h.height,o===36064&&p===null&&(o=1028),K(S[o]),c=c||S[o].type,a=_G(a,c,n,l,u),c=c||Lf(a);let x=f.bindFramebuffer(36160,p);return f.readPixels(t,i,l,u,n,c,a),f.bindFramebuffer(36160,x||null),d&&h.delete(),a}function vm(s){let{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=Fs(s,{sourceAttachment:e}),{width:n,height:o}=s;for(;o>t;)({data:i,width:n,height:o}=$1({data:i,width:n,height:o}));J1({data:i,width:n,height:o});let a=document.createElement("canvas");a.width=n,a.height=o;let l=a.getContext("2d"),u=l.createImageData(n,o);return u.data.set(i),l.putImageData(u,0,0),a.toDataURL()}function Am(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{sourceX:i=0,sourceY:n=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:f,deleteFramebuffer:p}=dI(s);K(f);let{gl:S,handle:x}=f,T=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let O=S.bindFramebuffer(36160,x);K(e);let M=null;if(e instanceof wi&&(M=e,h=Number.isFinite(h)?h:M.width,d=Number.isFinite(d)?d:M.height,M.bind(0),e=M.target),!T)S.copyTexImage2D(e,o,a,i,n,h,d,0);else switch(e){case 3553:case 34067:S.copyTexSubImage2D(e,o,l,u,i,n,h,d);break;case 35866:case 32879:At(S).copyTexSubImage3D(e,o,l,u,c,i,n,h,d);break;default:}return M&&M.unbind(),S.bindFramebuffer(36160,O||null),p&&f.delete(),M}function dI(s){return s instanceof ze?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:fI(s),deleteFramebuffer:!0}}function _G(s,e,t,i,n){if(s)return s;e=e||5121;let o=Na(e,{clamped:!1}),a=hI(t);return new o(i*n*a)}var tt={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function MG(s){let e=new Je(s,{format:6408,type:5126,dataFormat:6408}),t=new ze(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),i=t.getStatus();return e.delete(),t.delete(),i===36053}var xE={[tt.WEBGL2]:[!1,!0],[tt.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[tt.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[tt.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[tt.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[tt.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[tt.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[tt.FLOAT_BLEND]:["EXT_float_blend"],[tt.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[tt.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[tt.TEXTURE_FLOAT]:["OES_texture_float",!0],[tt.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[tt.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[tt.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[tt.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[tt.COLOR_ATTACHMENT_RGBA32F]:[MG,"EXT_color_buffer_float"],[tt.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[tt.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[tt.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[tt.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[tt.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[tt.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var NG=2;function _f(s,e){return Da(s,e)}function Da(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>pI(s,t))}function Tm(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in xE)s.luma.caps[e]===void 0&&(s.luma.caps[e]=pI(s,e));return s.luma.caps}function pI(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=BG(s,e)),s.luma.caps[e]||ie.log(NG,"Feature: ".concat(e," not supported"))(),s.luma.caps[e]}function BG(s,e){let t=xE[e];K(t,e);let i,n=fe(s)&&t[1]||t[0];if(typeof n=="function")i=n(s);else if(Array.isArray(n)){i=!0;for(let o of n)i=i&&Boolean(s.getExtension(o))}else typeof n=="string"?i=Boolean(s.getExtension(n)):typeof n=="boolean"?i=n:K(!1);return i}var gI="Multiple render targets not supported",ze=class extends sr{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{colorBufferFloat:i,colorBufferHalfFloat:n}=t,o=!0;return i&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new ze(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=At(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=At(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:t=1,height:i=1,attachments:n=null,color:o=!0,depth:a=!0,stencil:l=!1,check:u=!0,readBuffer:c=void 0,drawBuffers:h=void 0}=e;if(K(t>=0&&i>=0,"Width and height need to be integers"),this.width=t,this.height=i,n)for(let d in n){let f=n[d];(Array.isArray(f)?f[0]:f).resize({width:t,height:i})}else n=this._createDefaultAttachments(o,a,l,t,i);this.update({clearAttachments:!0,attachments:n,readBuffer:c,drawBuffers:h}),n&&u&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:t={},readBuffer:i,drawBuffers:n,clearAttachments:o=!1,resizeAttachments:a=!0}=e;this.attach(t,{clearAttachments:o,resizeAttachments:a});let{gl:l}=this,u=l.bindFramebuffer(36160,this.handle);return i&&this._setReadBuffer(i),n&&this._setDrawBuffers(n),l.bindFramebuffer(36160,u||null),this}resize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:t,height:i}=e;if(this.handle===null)return K(t===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&ie.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(t,"x").concat(i))();for(let n in this.attachments)this.attachments[n].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e){let{clearAttachments:t=!1,resizeAttachments:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={};t&&Object.keys(this.attachments).forEach(a=>{n[a]=null}),Object.assign(n,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in n){K(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=n[l],c=u;if(!c)this._unattach(l);else if(c instanceof $i)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,f=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:f})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});i&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(FG(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{color:t,depth:i,stencil:n,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&Ba(this.gl,{color:t,depth:i,stencil:n}),o.forEach((l,u)=>{EE(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(e){let{attachments:t=[],x:i=0,y:n=0,width:o,height:a}=e,l=At(this.gl),u=l.bindFramebuffer(36008,this.handle);return i===0&&n===0&&o===void 0&&a===void 0?l.invalidateFramebuffer(36008,t):l.invalidateFramebuffer(36008,t,i,n,o,a),l.bindFramebuffer(36008,u),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return n===null&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=xn(this.gl,n)),n}getAttachmentParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[],n={};for(let o of i){let a=t?xn(this.gl,o):o;n[a]=this.getAttachmentParameter(e,o,t)}return n}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=Object.keys(this.attachments),i={};for(let n of t){let o=Number(n),a=e?xn(this.gl,o):o;i[a]=this.getAttachmentParameters(o,e)}return i}show(){return typeof window<"u"&&window.open(vm(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(e>ie.level||typeof window>"u")return this;t=t||"Framebuffer ".concat(this.id);let i=vm(this,{targetMaxHeight:100});return ie.image({logLevel:e,message:t,image:i},t)(),this}bind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,o){let a=null;return e&&(a=a||{},a[36064]=new Je(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:n,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&i?(a=a||{},a[33306]=new $i(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:n,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new $i(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:n,height:o}),this.ownResources.push(a[36096])):i&&K(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof $i?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:t=36064,renderbuffer:i}=e,{gl:n}=this;n.framebufferRenderbuffer(36160,t,36161,i.handle),this.attachments[t]=i}_attachTexture(e){let{attachment:t=36064,texture:i,layer:n,level:o}=e,{gl:a}=this;switch(a.bindTexture(i.target,i.handle),i.target){case 35866:case 32879:At(a).framebufferTextureLayer(36160,t,i.target,o,n);break;case 34067:let u=DG(n);a.framebufferTexture2D(36160,t,u,i.handle,o);break;case 3553:a.framebufferTexture2D(36160,t,3553,i.handle,o);break;default:K(!1,"Illegal texture type")}a.bindTexture(i.target,null),this.attachments[t]=i}_setReadBuffer(e){let t=aE(this.gl);t?t.readBuffer(e):K(e===36064||e===1029,gI),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,i=At(t);if(i)i.drawBuffers(e);else{let n=t.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(e):K(e.length===1&&(e[0]===36064||e[0]===1029),gI)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=Tm(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function DG(s){return s<34069?s+34069:s}function FG(s){return(ze.STATUS||{})[s]||"Framebuffer error ".concat(s)}var GG=[36049,36048,33296,33298,33299,33300,33301,33302,33303];ze.ATTACHMENT_PARAMETERS=GG;function Zc(s,e){K(s instanceof Je||s instanceof Kc||s instanceof Rf);let t=s.constructor,{gl:i,width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(i,d)}function fI(s,e){let{gl:t,width:i,height:n,id:o}=s;return new ze(t,Object.assign({},e,{id:"framebuffer-for-".concat(o),width:i,height:n,attachments:{[36064]:s}}))}function Fa(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed",t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=s.match(t);return i?i[1]:e}function CE(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function vE(s,e,t,i){let n=s.split(/\r?\n/),o={},a={},l=i||Fa(e)||"(unnamed)",u="".concat(CE(t)," shader ").concat(l);for(let h=0;h<n.length;h++){let d=n[h];if(d.length<=1)continue;let f=d.split(":"),p=f[0],S=parseInt(f[2],10);if(isNaN(S))throw new Error("GLSL compilation error in ".concat(u,": ").concat(s));p!=="WARNING"?o[S]=d:a[S]=d}let c=VG(e);return{shaderName:u,errors:mI(o,c),warnings:mI(a,c)}}function mI(s,e){let t="";for(let i=0;i<e.length;i++){let n=e[i];if(!(!s[i+3]&&!s[i+2]&&!s[i+1])&&(t+="".concat(n,`
`),s[i+1])){let o=s[i+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=bI("^^^ ".concat(l,": ").concat(c,`

`),u)}}return t}function VG(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ",i=s.split(/\r?\n/),n=String(i.length+e-1).length;return i.map((o,a)=>{let l=String(a+e),u=l.length;return bI(l,n-u)+t+o})}function bI(s,e){let t="";for(let i=0;i<e;++i)t+=" ";return"".concat(t).concat(s)}function Qc(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}return e}var kG="Shader: GLSL source code must be a JavaScript string",Jc=class extends sr{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return K(!1),"unknown"}}constructor(e,t){Ds(e),K(typeof t.source=="string",kG);let i=Fa(t.source,null)||t.id||Ii("unnamed ".concat(Jc.getTypeName(t.shaderType)));super(e,{id:i});this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize(e){let{source:t}=e,i=Fa(t,null);i&&(this.id=Ii(i)),this._compile(t)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(Jc.getTypeName(this.shaderType),":").concat(this.id)}getName(){return Fa(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(e.startsWith("#version ")||(e=`#version 100
`.concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let i=this.gl.getShaderInfoLog(this.handle),{shaderName:n,errors:o,warnings:a}=vE(i,this.source,this.shaderType,this.id);throw ie.error("GLSL compilation errors in ".concat(n,`
`).concat(o))(),ie.warn("GLSL compilation warnings in ".concat(n,`
`).concat(a))(),new Error("GLSL compilation errors in ".concat(n))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},$c=class extends Jc{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},eh=class extends Jc{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var zG={[5126]:Tt.bind(null,"uniform1fv",en,1,oi),[35664]:Tt.bind(null,"uniform2fv",en,2,oi),[35665]:Tt.bind(null,"uniform3fv",en,3,oi),[35666]:Tt.bind(null,"uniform4fv",en,4,oi),[5124]:Tt.bind(null,"uniform1iv",Ga,1,oi),[35667]:Tt.bind(null,"uniform2iv",Ga,2,oi),[35668]:Tt.bind(null,"uniform3iv",Ga,3,oi),[35669]:Tt.bind(null,"uniform4iv",Ga,4,oi),[35670]:Tt.bind(null,"uniform1iv",Ga,1,oi),[35671]:Tt.bind(null,"uniform2iv",Ga,2,oi),[35672]:Tt.bind(null,"uniform3iv",Ga,3,oi),[35673]:Tt.bind(null,"uniform4iv",Ga,4,oi),[35674]:Tt.bind(null,"uniformMatrix2fv",en,4,Gs),[35675]:Tt.bind(null,"uniformMatrix3fv",en,9,Gs),[35676]:Tt.bind(null,"uniformMatrix4fv",en,16,Gs),[35678]:Dr,[35680]:Dr,[5125]:Tt.bind(null,"uniform1uiv",Im,1,oi),[36294]:Tt.bind(null,"uniform2uiv",Im,2,oi),[36295]:Tt.bind(null,"uniform3uiv",Im,3,oi),[36296]:Tt.bind(null,"uniform4uiv",Im,4,oi),[35685]:Tt.bind(null,"uniformMatrix2x3fv",en,6,Gs),[35686]:Tt.bind(null,"uniformMatrix2x4fv",en,8,Gs),[35687]:Tt.bind(null,"uniformMatrix3x2fv",en,6,Gs),[35688]:Tt.bind(null,"uniformMatrix3x4fv",en,12,Gs),[35689]:Tt.bind(null,"uniformMatrix4x2fv",en,8,Gs),[35690]:Tt.bind(null,"uniformMatrix4x3fv",en,12,Gs),[35678]:Dr,[35680]:Dr,[35679]:Dr,[35682]:Dr,[36289]:Dr,[36292]:Dr,[36293]:Dr,[36298]:Dr,[36299]:Dr,[36300]:Dr,[36303]:Dr,[36306]:Dr,[36307]:Dr,[36308]:Dr,[36311]:Dr},UG={},WG={},HG={},PI=[0];function AE(s,e,t,i){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(PI[0]=s,s=PI);let n=s.length;if(n%e&&ie.warn("Uniform size should be multiples of ".concat(e),s)(),s instanceof t)return s;let o=i[n];o||(o=new t(n),i[n]=o);for(let a=0;a<n;a++)o[a]=s[a];return o}function en(s,e){return AE(s,e,Float32Array,UG)}function Ga(s,e){return AE(s,e,Int32Array,WG)}function Im(s,e){return AE(s,e,Uint32Array,HG)}function TE(s,e,t){let i=zG[t.type];if(!i)throw new Error("Unknown GLSL uniform type ".concat(t.type));return i().bind(null,s,e)}function yI(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(s));return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function SI(s,e,t){for(let i in s){let n=s[i];if((!t||Boolean(t[i]))&&!jG(n))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(i),n),new Error("".concat(e," Bad uniform ").concat(i))}return!0}function jG(s){return Array.isArray(s)||ArrayBuffer.isView(s)?qG(s):isFinite(s)||s===!0||s===!1||s instanceof wi||s instanceof $i?!0:s instanceof ze?Boolean(s.texture):!1}function EI(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let i=s[e];for(let n=0,o=t.length;n<o;++n)i[n]=t[n]}else s[e]=t.slice();else s[e]=t}function qG(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Dr(){let s=null;return(e,t,i)=>{let n=s!==i;return n&&(e.uniform1i(t,i),s=i),n}}function Tt(s,e,t,i){let n=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(n===null)n=new Float32Array(h),o=h,d=!0;else{K(o===h,"Uniform length cannot change.");for(let f=0;f<h;++f)if(c[f]!==n[f]){d=!0;break}}return d&&(i(a,s,l,c),n.set(c)),d}}function oi(s,e,t,i){s[e](t,i)}function Gs(s,e,t,i){s[e](t,!1,i)}var XG=5120,YG=5121,KG=5122,ZG=5123,xI=0,wm=1,QG=2,JG=3,Lm=4,$G=5,eV=6,gr=5126,tV=35664,rV=35665,iV=35666,Mf=5124,nV=35667,oV=35668,sV=35669,Nf=5125,aV=36294,lV=36295,uV=36296,cV=35670,hV=35671,dV=35672,fV=35673,pV=35674,gV=35675,mV=35676,bV=35685,PV=35686,yV=35687,SV=35688,EV=35689,xV=35690,IE={[gr]:[gr,1,"float"],[tV]:[gr,2,"vec2"],[rV]:[gr,3,"vec3"],[iV]:[gr,4,"vec4"],[Mf]:[Mf,1,"int"],[nV]:[Mf,2,"ivec2"],[oV]:[Mf,3,"ivec3"],[sV]:[Mf,4,"ivec4"],[Nf]:[Nf,1,"uint"],[aV]:[Nf,2,"uvec2"],[lV]:[Nf,3,"uvec3"],[uV]:[Nf,4,"uvec4"],[cV]:[gr,1,"bool"],[hV]:[gr,2,"bvec2"],[dV]:[gr,3,"bvec3"],[fV]:[gr,4,"bvec4"],[pV]:[gr,8,"mat2"],[bV]:[gr,8,"mat2x3"],[PV]:[gr,8,"mat2x4"],[gV]:[gr,12,"mat3"],[yV]:[gr,12,"mat3x2"],[SV]:[gr,12,"mat3x4"],[mV]:[gr,16,"mat4"],[EV]:[gr,16,"mat4x2"],[xV]:[gr,16,"mat4x3"]};function CI(s){switch(s){case xI:return xI;case wm:return wm;case JG:return wm;case QG:return wm;case Lm:return Lm;case $G:return Lm;case eV:return Lm;default:return K(!1),0}}function wE(s){let e=IE[s];if(!e)return null;let[t,i]=e;return{type:t,components:i}}function Om(s,e){switch(s){case XG:case YG:case KG:case ZG:s=gr;break;default:}for(let t in IE){let[i,n,o]=IE[t];if(i===s&&n===e)return{glType:t,name:o}}return null}var Rm=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,n),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((n,o)=>n.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!fe(t))return;let i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,o,a,l)}this.varyingInfos.sort((n,o)=>n.location-o.location)}_addAttribute(e,t,i,n){let{type:o,components:a}=wE(i),l={type:o,size:n*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new Ar(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){let{type:o,components:a}=wE(i),l=new Ar({type:o,size:n*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var vI=4,CV=35981,vV=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],Va=class extends sr{get[Symbol.toStringTag](){return"Program"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.stubRemovedMethods("Program","v6.0",vV),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{hash:t,vs:i,fs:n,varyings:o,bufferMode:a=CV}=e;return this.hash=t||"",this.vs=typeof i=="string"?new $c(this.gl,{id:"".concat(e.id,"-vs"),source:i}):i,this.fs=typeof n=="string"?new eh(this.gl,{id:"".concat(e.id,"-fs"),source:n}):n,K(this.vs instanceof $c),K(this.fs instanceof eh),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(At(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Rm(this),this.setProps(e)}delete(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:t,drawMode:i=4,vertexCount:n,offset:o=0,start:a,end:l,isIndexed:u=!1,indexType:c=5123,instanceCount:h=0,isInstanced:d=h>0,vertexArray:f=null,transformFeedback:p,framebuffer:S,parameters:x={},uniforms:T,samplers:O}=e;if((T||O)&&(ie.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(T||{})),ie.priority>=t){let M=S?S.id:"default",R="mode=".concat(xn(this.gl,i)," verts=").concat(n," ")+"instances=".concat(h," indexType=").concat(xn(this.gl,c)," ")+"isInstanced=".concat(d," isIndexed=").concat(u," ")+"Framebuffer=".concat(M);ie.log(t,R)()}return K(f),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||n===0||d&&h===0?!1:(f.bindForDraw(n,h,()=>{if(S!==void 0&&(x=Object.assign({},x,{framebuffer:S})),p){let M=CI(i);p.begin(M)}this._bindTextures(),yt(this.gl,x,()=>{u&&d?this.gl2.drawElementsInstanced(i,n,c,o,h):u&&fe(this.gl)&&!isNaN(a)&&!isNaN(l)?this.gl2.drawRangeElements(i,a,l,n,c,o):u?this.gl.drawElements(i,n,c,o):d?this.gl2.drawArraysInstanced(i,o,n,h):this.gl.drawArrays(i,o,n)}),p&&p.end()}),!0)}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ie.priority>=2&&SI(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let i=e[t],n=this._uniformSetters[t];if(n){let o=i,a=!1;if(o instanceof ze&&(o=o.texture),o instanceof wi)if(a=this.uniforms[t]!==i,a){n.textureIndex===void 0&&(n.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=n;l.bind(u),o=u,this._textureUniforms[t]=l}else o=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(o)||a)&&EI(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),i={};for(let n of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new $c({handle:n});break;case 35632:i.fs=new eh({handle:n});break;default:}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=Ii(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),ie.time(vI,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),ie.timeEnd(vI,"linkProgram for ".concat(this._getName()))(),e.debug||ie.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let i=this.gl.getActiveUniform(this.handle,t),{name:n}=yI(i.name),o=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=TE(e,o,i),i.size>1)for(let a=0;a<i.size;a++)o=e.getUniformLocation(this.handle,"".concat(n,"[").concat(a,"]")),this._uniformSetters["".concat(n,"[").concat(a,"]")]=TE(e,o,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var AV=34918,TV=34919,IV=35007,wV=36795,LV=35976,OV=35887,RV=36202,ka=class extends sr{get[Symbol.toStringTag](){return"Query"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],i=fe(e),n=Da(e,tt.TIMER_QUERY),o=i||n;for(let a of t)switch(a){case"queries":o=o&&i;break;case"timers":o=o&&n;break;default:K(!1)}return o}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(IV)}beginOcclusionQuery(){let{conservative:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.begin(e?RV:OV)}beginTransformFeedbackQuery(){return this.begin(LV)}begin(e){return this._queryPending?this:(this.target=e,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;let e=this.gl2.getQueryParameter(this.handle,TV);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(wV)}getResult(){return this.gl2.getQueryParameter(this.handle,AV)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((i,n)=>{let o=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}_createHandle(){return ka.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}};var za=class extends sr{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};At(e);super(e,t);this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Qo(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let i=this._getVaryingIndex(e),{buffer:n,byteSize:o,byteOffset:a}=this._getBufferParams(t);return i<0?(this.unused[e]=n,ie.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,a,o),this)}begin(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof ve?n=e:(n=e.buffer,i=e.byteSize,t=e.byteOffset),(t!==void 0||i!==void 0)&&(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0,o=t&&t.handle;return!o||n===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,i,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var _m=null;function _V(s){return(!_m||_m.byteLength<s)&&(_m=new ArrayBuffer(s)),_m}function AI(s,e){let t=_V(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function TI(s){let{target:e,source:t,start:i=0,count:n=1}=s,o=t.length,a=n*o,l=0;for(let u=i;l<o;l++)e[u++]=t[l];for(;l<a;)l<a-l?(e.copyWithin(i+l,i,i+l),l*=2):(e.copyWithin(i+l,i,i+a-l),l=a);return e}var MV="elements must be GL.ELEMENT_ARRAY_BUFFER",si=class extends sr{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?fe(e)||Wc()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new si(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return si.MAX_ATTRIBUTES=si.MAX_ATTRIBUTES||e.getParameter(34921),si.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:si._setConstantFloatArray(e,t,i);break;case Int32Array:si._setConstantIntArray(e,t,i);break;case Uint32Array:si._setConstantUintArray(e,t,i);break;default:K(!1)}}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:i}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return si.getMaxAttributes(this.gl)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(e)}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return K(!e||e.target===34963,MV),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,i){if(t.target===34963)return this.setElementBuffer(t,i);let{size:n,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=i,{gl:d,gl2:f}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(K(fe(d)),f.vertexAttribIPointer(e,n,o,a,l)):d.vertexAttribPointer(e,n,o,u,a,l),d.enableVertexAttribArray(e),f.vertexAttribDivisor(e,h||0)}),this}enable(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!t&&e===0&&!si.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,o=i.length*e,a=!this.buffer;if(this.buffer=this.buffer||new ve(this.gl,n),a=a||this.buffer.reallocate(n),a=a||!this._compareConstantArrayValues(i,this.bufferValue),a){let l=AI(t.constructor,o);TI({target:l,source:i,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:K(!1)}}static _setConstantIntArray(e,t,i){switch(K(fe(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:K(!1)}}static _setConstantUintArray(e,t,i){switch(K(fe(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:K(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,t){let{location:i}=t;return K(Number.isFinite(i)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(i,e);default:return this.gl.getVertexAttrib(i,e)}})}};var NV="VertexArray: attributes must be Buffers or constants (i.e. typed array)",BV=/^(.+)__LOCATION_([0-9]+)$/,DV=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],Bf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;this.id=i,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new si(e),Sm(this,"VertexArray","v6.0",DV),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let i=e[t];this._setAttribute(t,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t.target===34963)return this.setElementBuffer(t,i);let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,o)),this}setConstant(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new ve(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof ve&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof ve&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),n=i()}),n}_resolveLocationAndAccessor(e,t,i,n){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,ie.once(3,()=>"unused value ".concat(e," in ").concat(this.id))(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=Ar.resolve(u.accessor,c,i,n),{size:d,type:f}=h;return K(Number.isFinite(d)&&Number.isFinite(f)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let i=BV.exec(e),n=i?i[1]:e,o=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+o,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof ve)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof ve){let i=t[0],n=t[1];this.setBuffer(e,i,n)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let i=t;this.setConstant(e,i)}else if(t.buffer instanceof ve){let i=t;this.setBuffer(e,i.buffer,i)}else throw new Error(NV)}_setConstantAttributes(e,t){let i=Math.max(e|0,t|0),n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)n=this.values[o],ArrayBuffer.isView(n)&&this._setConstantAttribute(o,n)}_setConstantAttributeZero(e,t){if(si.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){si.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let i=this.values[t],n=this.accessors[t];if(!i)return;let{divisor:o}=n,a=o>0;if(e.isInstanced=e.isInstanced||a,i instanceof ve){let l=i;if(a){let u=l.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return ie.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function FV(s,e){let{maxElts:t=16,size:i=1}=e,n="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(n+=",".concat(a%i===0?" ":"")),n+=bu(s[a],e);let o=s.length>t?"...":"]";return"".concat(n).concat(o)}function bu(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=1e-16,{isInteger:i=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return FV(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<t)return i?"0":"0.";if(i||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let n=s.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function Mm(s){let{header:e="Uniforms",program:t,uniforms:i,undefinedOnly:n=!1}=s;K(t);let o=".*_.*",a=".*Matrix",l=t._uniformSetters,u={},c=Object.keys(l).sort(),h=0;for(let p of c)!p.match(o)&&!p.match(a)&&LE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)p.match(a)&&LE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)u[p]||LE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;let d=0,f={};if(!n)for(let p in i){let S=i[p];u[p]||(d++,f[p]={Type:"NOT USED: ".concat(S),[e]:bu(S)})}return{table:u,count:h,unusedTable:f,unusedCount:d}}function LE(s){let{table:e,header:t,uniforms:i,uniformName:n,undefinedOnly:o}=s,a=i[n],l=GV(a);return!o||!l?(e[n]={[t]:l?bu(a):"N/A","Uniform Type":l?a:"NOT PROVIDED"},!0):!1}function GV(s){return s!=null}function OE(s){let{vertexArray:e,header:t="Attributes"}=s;if(!e.configuration)return{};let i={};e.elements&&(i.ELEMENT_ARRAY_BUFFER=II(e,e.elements,null,t));let n=e.values;for(let o in n){let a=e._getAttributeInfo(o);if(a){let l="".concat(o,": ").concat(a.name),u=e.accessors[a.location];u&&(l="".concat(o,": ").concat(VV(a.name,u))),i[l]=II(e,n[o],u,t)}}return i}function II(s,e,t,i){let{gl:n}=s;if(!e)return{[i]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof ve){let f=e,{data:p,changed:S}=f.getDebugData();h=S?"*":"",d=p,u=f.byteLength,l=u/p.BYTES_PER_ELEMENT/a;let x;if(t){let T=t.divisor>0;x="".concat(T?"I ":"P "," ").concat(l," (x").concat(a,"=").concat(u," bytes ").concat(xn(n,o),")")}else c=!0,x="".concat(u," bytes");return{[i]:"".concat(h).concat(bu(d,{size:a,isInteger:c})),"Format ":x}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[i]:"".concat(bu(d,{size:a,isInteger:c})," (constant)"),"Format ":"".concat(a,"x").concat(o," (constant)")}}function VV(s,e){let{type:t,size:i}=e,n=Om(t,i);return n?"".concat(s," (").concat(n.name,")"):s}function RE(s){let e={},t="Accessors for ".concat(s.id);for(let i of s.attributeInfos)if(i){let n=wI(i);e["in ".concat(n)]={[t]:JSON.stringify(i.accessor)}}for(let i of s.varyingInfos)if(i){let n=wI(i);e["out ".concat(n)]={[t]:JSON.stringify(i.accessor)}}return e}function wI(s){let{type:e,size:t}=s.accessor,i=Om(e,t);return i?"".concat(i.name," ").concat(s.name):s.name}var LI=pr()&&typeof document<"u",zV=0,th=class{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{onCreateContext:t=T=>Xc(T),onAddHTML:i=null,onInitialize:n=()=>{},onRender:o=()=>{},onFinalize:a=()=>{},onError:l,gl:u=null,glOptions:c={},debug:h=!1,createFramebuffer:d=!1,autoResizeViewport:f=!0,autoResizeDrawingBuffer:p=!0,stats:S=En.get("animation-loop-".concat(zV++))}=e,{useDevicePixels:x=!0}=e;"useDevicePixelRatio"in e&&(ie.deprecated("useDevicePixelRatio","useDevicePixels")(),x=e.useDevicePixelRatio),this.props={onCreateContext:t,onAddHTML:i,onInitialize:n,onRender:o,onFinalize:a,onError:l,gl:u,glOptions:c,debug:h,createFramebuffer:d},this.gl=u,this.needsRedraw=null,this.timeline=null,this.stats=S,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:f,autoResizeDrawingBuffer:p,useDevicePixels:x}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return K(typeof e=="string"),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this._running)return this;this._running=!0;let t=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=ka.isSupported(this.gl,["timers"])?new ka(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(i=>{this._running&&(this._addCallbackData(i||{}),i!==!1&&this._startLoop())});return this.props.onError&&t.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.getElementById(e);return i?Number(i.value):t}setViewParameters(){return ie.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){let e=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=LI?new Promise((e,t)=>{if(LI&&document.readyState==="complete"){e(document);return}window.addEventListener("load",()=>{e(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):mE(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):gE(e)}_renderFrame(){if(this.display){this.display._renderFrame(...arguments);return}this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){typeof e=="object"&&e!==null&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&typeof OffscreenCanvas<"u"&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?gu(this.props.gl,e):this.onCreateContext(e),!Bs(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");bm(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){let e=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight,i=1,{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&pE(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new ze(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){let{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}};var Pu="vs",Df="fs";function Zt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var _E={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function RI(s){let e={};for(let t in s){let i=s[t],n=UV(i);e[t]=n}return e}function UV(s){let e=OI(s);return e==="object"?s?"type"in s?Object.assign({},s,_E[s.type]):"value"in s?(e=OI(s.value),Object.assign({type:e},s,_E[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},_E[e])}function OI(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var WV="vs",HV="fs",Ff=class{constructor(e){let{name:t,vs:i,fs:n,dependencies:o=[],uniforms:a,getUniforms:l,deprecations:u=[],defines:c={},inject:h={},vertexShader:d,fragmentShader:f}=e;Zt(typeof t=="string"),this.name=t,this.vs=i||d,this.fs=n||f,this.getModuleUniforms=l,this.dependencies=o,this.deprecations=this._parseDeprecationDefinitions(u),this.defines=c,this.injections=jV(h),a&&(this.uniforms=RI(a))}getModuleSource(e){let t;switch(e){case WV:t=this.vs||"";break;case HV:t=this.fs||"";break;default:Zt(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(t,"// END MODULE_").concat(this.name,`

`)}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp("\\b".concat(t.old,"\\("));break;default:t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))}}),e}_defaultGetUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t={},i=this.uniforms;for(let n in i){let o=i[n];n in e&&!o.private?(o.validate&&Zt(o.validate(e[n],o),"".concat(this.name,": invalid ").concat(n)),t[n]=e[n]):t[n]=o.value}return t}};function jV(s){let e={vs:{},fs:{}};for(let t in s){let i=s[t],n=t.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),e[n][t]=i}return e}function _I(s){return qV(NI(s))}function qV(s){let e={},t={};return MI({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((i,n)=>t[n]-t[i]).map(i=>e[i])}function MI(s){let{modules:e,level:t,moduleMap:i,moduleDepth:n}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(let o of e)i[o.name]=o,(n[o.name]===void 0||n[o.name]<t)&&(n[o.name]=t);for(let o of e)o.dependencies&&MI({modules:o.dependencies,level:t+1,moduleMap:i,moduleDepth:n})}function NI(s,e){return s.map(t=>(t instanceof Ff||(Zt(typeof t!="string","Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),Zt(t.name,"shader module has no name"),t=new Ff(t),t.dependencies=NI(t.dependencies)),t))}function ME(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n}var XV=7936,YV=7937,KV=7938,ZV=35724,BE={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Ua={};Object.keys(BE).forEach(s=>{Ua[s]=s});function QV(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function BI(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||XV),i=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||YV);return{gpuVendor:JV(t,i),vendor:t,renderer:i,version:s.getParameter(KV),shadingLanguageVersion:s.getParameter(ZV)}}function JV(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var NE={};function DE(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=BE[e];if(Zt(i,e),!ME(t))return!0;if(e in NE)return NE[e];let n=i[0],o=t.behavior||"enable",a="#extension GL_".concat(n," : ").concat(o,`
void main(void) {}`),l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),NE[e]=u,u}function $V(s,e){let t=BE[e];Zt(t,e);let i=QV(s)&&t[1]||t[0],n=typeof i=="string"?Boolean(s.getExtension(i)):i;return Zt(n===!1||n===!0),n}function Gf(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>$V(s,t))}function DI(s){switch(BI(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function FI(s,e,t){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Gf(s,Ua.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Gf(s,Ua.GLSL_DERIVATIVES)&&DE(s,Ua.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Gf(s,Ua.GLSL_FRAG_DATA)&&DE(s,Ua.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Gf(s,Ua.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}var GI=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,VI=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var ek={[Pu]:GI,[Df]:VI},Vf="__LUMA_INJECT_DECLARATIONS__",kI=/void\s+main\s*\([^)]*\)\s*\{\n?/,zI=/}\n?[^{}]*$/,FE=[];function Nm(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,n=e===Pu;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),FE.length=a.length;for(let u=0,c=a.length;u<c;++u)FE[u]=a[u].injection;let l="".concat(FE.join(`
`),`
`);switch(o){case"vs:#decl":n&&(s=s.replace(Vf,l));break;case"vs:#main-start":n&&(s=s.replace(kI,u=>u+l));break;case"vs:#main-end":n&&(s=s.replace(zI,u=>l+u));break;case"fs:#decl":n||(s=s.replace(Vf,l));break;case"fs:#main-start":n||(s=s.replace(kI,u=>u+l));break;case"fs:#main-end":n||(s=s.replace(zI,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(Vf,""),i&&(s=s.replace(/\}\s*$/,o=>o+ek[e])),s}function rh(s){let e={};return Zt(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let i in t)e[i]=e[i]?"".concat(e[i],`
`).concat(t[i]):t[i]}),e}function ih(s){return new RegExp("\\b".concat(s,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}var UI=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],tk=[...UI,[ih("attribute"),"in $1"],[ih("varying"),"out $1"]],rk=[...UI,[ih("varying"),"in $1"]],WI=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],ik=[...WI,[ih("in"),"attribute $1"],[ih("out"),"varying $1"]],nk=[...WI,[ih("in"),"varying $1"]],GE="gl_FragColor",VE=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,ok=/void\s+main\s*\([^)]*\)\s*\{\n?/;function kE(s,e,t){switch(e){case 300:return t?Bm(s,tk):sk(s);case 100:return t?Bm(s,ik):ak(s);default:throw new Error("unknown GLSL version ".concat(e))}}function Bm(s,e){for(let[t,i]of e)s=s.replace(t,i);return s}function sk(s){s=Bm(s,rk);let e=s.match(VE);if(e){let t=e[1];s=s.replace(new RegExp("\\b".concat(GE,"\\b"),"g"),t)}else{let t="fragmentColor";s=s.replace(ok,i=>"out vec4 ".concat(t,`;
`).concat(i)).replace(new RegExp("\\b".concat(GE,"\\b"),"g"),t)}return s}function ak(s){s=Bm(s,nk);let e=s.match(VE);if(e){let t=e[1];s=s.replace(VE,"").replace(new RegExp("\\b".concat(t,"\\b"),"g"),GE)}return s}var lk=`

`.concat(Vf,`

`),jI={[Pu]:"vertex",[Df]:"fragment"},uk=`precision highp float;

`;function zE(s,e){let{vs:t,fs:i}=e,n=_I(e.modules||[]);return{gl:s,vs:HI(s,Object.assign({},e,{source:t,type:Pu,modules:n})),fs:HI(s,Object.assign({},e,{source:i,type:Df,modules:n})),getUniforms:ck(n)}}function HI(s,e){let{id:t,source:i,type:n,modules:o,defines:a={},hookFunctions:l=[],inject:u={},transpileToGLSL100:c=!1,prologue:h=!0,log:d}=e;Zt(typeof i=="string","shader source must be a string");let f=n===Pu,p=i.split(`
`),S=100,x="",T=i;p[0].indexOf("#version ")===0?(S=300,x=p[0],T=p.slice(1).join(`
`)):x="#version ".concat(S);let O={};o.forEach(ne=>{Object.assign(O,ne.getDefines())}),Object.assign(O,a);let M=h?"".concat(x,`
`).concat(dk({id:t,source:i,type:n}),`
`).concat(hk({type:n}),`
`).concat(DI(s),`
`).concat(FI(s,S,!f),`
`).concat(fk(O),`
`).concat(f?"":uk,`
`):"".concat(x,`
`),R=gk(l),N={},H={},Q={};for(let ne in u){let he=typeof u[ne]=="string"?{injection:u[ne],order:0}:u[ne],se=ne.match(/^(v|f)s:(#)?([\w-]+)$/);if(se){let oe=se[2],ge=se[3];oe?ge==="decl"?H[ne]=[he]:Q[ne]=[he]:N[ne]=[he]}else Q[ne]=[he]}for(let ne of o){d&&ne.checkDeprecations(T,d),M+=ne.getModuleSource(n,S);let se=ne.injections[n];for(let oe in se){let ge=oe.match(/^(v|f)s:#([\w-]+)$/);if(ge){let pe=ge[2]==="decl"?H:Q;pe[oe]=pe[oe]||[],pe[oe].push(se[oe])}else N[oe]=N[oe]||[],N[oe].push(se[oe])}}return M+=lk,M=Nm(M,n,H),M+=pk(R[n],N),M+=T,M=Nm(M,n,Q),M=kE(M,c?100:S,f),M}function ck(s){return function(t){let i={};for(let n of s){let o=n.getUniforms(t,i);Object.assign(i,o)}return i}}function hk(s){let{type:e}=s;return`
#define SHADER_TYPE_`.concat(jI[e].toUpperCase(),`
`)}function dk(s){let{id:e,source:t,type:i}=s;return e&&typeof e=="string"&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(e,"_").concat(jI[i],`

`):""}function fk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=0,t="";for(let i in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let n=s[i];(n||Number.isFinite(n))&&(t+="#define ".concat(i.toUpperCase()," ").concat(s[i],`
`))}return e===0&&(t+=`
`),t}function pk(s,e){let t="";for(let i in s){let n=s[i];if(t+="void ".concat(n.signature,` {
`),n.header&&(t+="  ".concat(n.header)),e[i]){let o=e[i];o.sort((a,l)=>a.order-l.order);for(let a of o)t+="  ".concat(a.injection,`
`)}n.footer&&(t+="  ".concat(n.footer)),t+=`}
`}return t}function gk(s){let e={vs:{},fs:{}};return s.forEach(t=>{let i;typeof t!="string"?(i=t,t=i.hook):i={},t=t.trim();let[n,o]=t.split(":"),a=t.replace(/\(.+/,"");e[n][a]=Object.assign(i,{signature:o})}),e}var mk="void main() {gl_FragColor = vec4(0);}",qI=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,bk=`#version 300 es
`.concat(qI);function Dm(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[i,n,o]=t;if(!e.includes(i)||!n||!o)return null;let a=o.split(";")[0];return{qualifier:i,type:n,name:a}}function kf(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{version:e=100,input:t,inputType:i,output:n}=s;if(!t)return e===300?bk:e>300?"#version ".concat(e,`
`).concat(qI):mk;let o=XI(t,i);return e>=300?"#version ".concat(e," ").concat(e===300?"es":"",`
in `).concat(i," ").concat(t,`;
out vec4 `).concat(n,`;
void main() {
  `).concat(n," = ").concat(o,`;
}`):"varying ".concat(i," ").concat(t,`;
void main() {
  gl_FragColor = `).concat(o,`;
}`)}function UE(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Zt(!1),null}}function WE(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Zt(!1),null}}function XI(s,e){switch(e){case"float":return"vec4(".concat(s,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(s,", 0.0, 1.0)");case"vec3":return"vec4(".concat(s,", 1.0)");case"vec4":return s;default:return Zt(!1),null}}var Pk=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,Fm={name:"fp32",vs:Pk,fs:null};function oo(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var Wve=1/Math.PI*180,Hve=1/180*Math.PI,Qt={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function HE(s,{precision:e=Qt.precision}={}){return s=yk(s),"".concat(parseFloat(s.toPrecision(e)))}function so(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Dt(s,e,t){return Ek(s,i=>Math.max(e,Math.min(t,i)))}function yu(s,e,t){return so(s)?s.map((i,n)=>yu(i,e[n],t)):t*e+(1-t)*s}function Fr(s,e,t){let i=Qt.EPSILON;t&&(Qt.EPSILON=t);try{if(s===e)return!0;if(so(s)&&so(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!Fr(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=Qt.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{Qt.EPSILON=i}}function yk(s){return Math.round(s/Qt.EPSILON)*Qt.EPSILON}function Sk(s){return s.clone?s.clone():new Array(s.length)}function Ek(s,e,t){if(so(s)){let i=s;t=t||Sk(i);for(let n=0;n<t.length&&n<i.length;++n)t[n]=e(s[n],n,t);return t}return e(s)}function xk(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var Wa=class extends xk(Array){clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:so(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Qt)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+HE(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Fr(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(i===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){let o=e[n];this[n]=o+i*(t[n]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Qt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}};function Ck(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function $e(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function Ha(s,e,t=""){if(Qt.debug&&!Ck(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var nh=class extends Wa{get x(){return this[0]}set x(e){this[0]=$e(e)}get y(){return this[1]}set y(e){this[1]=$e(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let n=this[i]-e[i];t+=n*n}return $e(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return $e(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return oo(e>=0&&e<this.ELEMENTS,"index is out of range"),$e(this[e])}setComponent(e,t){return oo(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var ao=1e-6,Gr=typeof Float32Array<"u"?Float32Array:Array;var eAe=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function vk(){var s=new Gr(2);return Gr!=Float32Array&&(s[0]=0,s[1]=0),s}function sh(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function Gm(s,e){return s[0]=-e[0],s[1]=-e[1],s}function Vm(s,e,t,i){var n=e[0],o=e[1];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s}function YI(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[3]*n+t[6],s[1]=t[1]*i+t[4]*n+t[7],s}function KI(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[4]*n+t[12],s[1]=t[1]*i+t[5]*n+t[13],s}var tAe=function(){var s=vk();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function ZI(s,e,t){let i=e[0],n=e[1],o=t[3]*i+t[7]*n||1;return s[0]=(t[0]*i+t[4]*n)/o,s[1]=(t[1]*i+t[5]*n)/o,s}function km(s,e,t){let i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o||1;return s[0]=(t[0]*i+t[4]*n+t[8]*o)/a,s[1]=(t[1]*i+t[5]*n+t[9]*o)/a,s[2]=(t[2]*i+t[6]*n+t[10]*o)/a,s}function QI(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s}function JI(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s[3]=e[3],s}function zm(s,e,t){let i=e[0],n=e[1],o=e[2];return s[0]=t[0]*i+t[3]*n+t[6]*o,s[1]=t[1]*i+t[4]*n+t[7]*o,s[2]=t[2]*i+t[5]*n+t[8]*o,s[3]=e[3],s}function qE(){var s=new Gr(3);return Gr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Ak(s){var e=s[0],t=s[1],i=s[2];return Math.hypot(e,t,i)}function XE(s,e,t){var i=new Gr(3);return i[0]=s,i[1]=e,i[2]=t,i}function Tk(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function Ik(s){var e=s[0],t=s[1],i=s[2];return e*e+t*t+i*i}function $I(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function ew(s,e){var t=e[0],i=e[1],n=e[2],o=t*t+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),s[0]=e[0]*o,s[1]=e[1]*o,s[2]=e[2]*o,s}function YE(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function lh(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=n*u-o*l,s[1]=o*a-i*u,s[2]=i*l-n*a,s}function tw(s,e,t,i){var n=e[0],o=e[1],a=e[2];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s}function uh(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,s[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,s[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,s}function Um(s,e,t){var i=e[0],n=e[1],o=e[2];return s[0]=i*t[0]+n*t[3]+o*t[6],s[1]=i*t[1]+n*t[4]+o*t[7],s[2]=i*t[2]+n*t[5]+o*t[8],s}function Wm(s,e,t){var i=t[0],n=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=n*c-o*u,d=o*l-i*c,f=i*u-n*l,p=n*f-o*d,S=o*h-i*f,x=i*d-n*h,T=a*2;return h*=T,d*=T,f*=T,p*=2,S*=2,x*=2,s[0]=l+h+p,s[1]=u+d+S,s[2]=c+f+x,s}function rw(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function iw(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function nw(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function ow(s,e){var t=s[0],i=s[1],n=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+i*i+n*n),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&YE(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var Hm=Tk;var jm=Ak,qm=Ik,iAe=function(){var s=qE();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var KE=[0,0,0],Xm,ee=class extends nh{static get ZERO(){return Xm||(Xm=new ee(0,0,0),Object.freeze(Xm)),Xm}constructor(e=0,t=0,i=0){super(-0,-0,-0);arguments.length===1&&so(e)?this.copy(e):(Qt.debug&&($e(e),$e(t),$e(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Qt.debug&&($e(e.x),$e(e.y),$e(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=$e(e)}angle(e){return ow(this,e)}cross(e){return lh(this,this,e),this.check()}rotateX({radians:e,origin:t=KE}){return rw(this,this,t,e),this.check()}rotateY({radians:e,origin:t=KE}){return iw(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=KE}){return nw(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return uh(this,this,e),this.check()}transformAsVector(e){return km(this,this,e),this.check()}transformByMatrix3(e){return Um(this,this,e),this.check()}transformByMatrix2(e){return QI(this,this,e),this.check()}transformByQuaternion(e){return Wm(this,this,e),this.check()}};var Ym,ch=class extends nh{static get ZERO(){return Ym||(Ym=new ch(0,0,0,0),Object.freeze(Ym)),Ym}constructor(e=0,t=0,i=0,n=0){super(-0,-0,-0,-0);so(e)&&arguments.length===1?this.copy(e):(Qt.debug&&($e(e),$e(t),$e(i),$e(n)),this[0]=e,this[1]=t,this[2]=i,this[3]=n)}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return Qt.debug&&($e(e.x),$e(e.y),$e(e.z),$e(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=$e(e)}get w(){return this[3]}set w(e){this[3]=$e(e)}transform(e){return uh(this,this,e),this.check()}transformByMatrix3(e){return zm(this,this,e),this.check()}transformByMatrix2(e){return JI(this,this,e),this.check()}transformByQuaternion(e){return Wm(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}};var hh=class extends Wa{toString(){let e="[";if(Qt.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=$e(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[i+n];return t}setColumn(e,t){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)this[i+n]=t[n];return this}};function sw(){var s=new Gr(9);return Gr!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function aw(s,e){if(s===e){var t=e[1],i=e[2],n=e[5];s[1]=e[3],s[2]=e[6],s[3]=t,s[5]=e[7],s[6]=i,s[7]=n}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return s}function lw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=h*a-l*c,f=-h*o+l*u,p=c*o-a*u,S=t*d+i*f+n*p;return S?(S=1/S,s[0]=d*S,s[1]=(-h*i+n*c)*S,s[2]=(l*i-n*a)*S,s[3]=f*S,s[4]=(h*t-n*u)*S,s[5]=(-l*t+n*o)*S,s[6]=p*S,s[7]=(-c*t+i*u)*S,s[8]=(a*t-i*o)*S,s):null}function uw(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8];return e*(c*o-a*u)+t*(-c*n+a*l)+i*(u*n-o*l)}function ZE(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1],S=t[2],x=t[3],T=t[4],O=t[5],M=t[6],R=t[7],N=t[8];return s[0]=f*i+p*a+S*c,s[1]=f*n+p*l+S*h,s[2]=f*o+p*u+S*d,s[3]=x*i+T*a+O*c,s[4]=x*n+T*l+O*h,s[5]=x*o+T*u+O*d,s[6]=M*i+R*a+N*c,s[7]=M*n+R*l+N*h,s[8]=M*o+R*u+N*d,s}function cw(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1];return s[0]=i,s[1]=n,s[2]=o,s[3]=a,s[4]=l,s[5]=u,s[6]=f*i+p*a+c,s[7]=f*n+p*l+h,s[8]=f*o+p*u+d,s}function hw(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=Math.sin(t),p=Math.cos(t);return s[0]=p*i+f*a,s[1]=p*n+f*l,s[2]=p*o+f*u,s[3]=p*a-f*i,s[4]=p*l-f*n,s[5]=p*u-f*o,s[6]=c,s[7]=h,s[8]=d,s}function QE(s,e,t){var i=t[0],n=t[1];return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=n*e[3],s[4]=n*e[4],s[5]=n*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}function dw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,x=o*a,T=o*l,O=o*u;return s[0]=1-d-S,s[3]=h-O,s[6]=f+T,s[1]=h+O,s[4]=1-c-S,s[7]=p-x,s[2]=f-T,s[5]=p+x,s[8]=1-c-d,s}var JE;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(JE||(JE={}));var wk=Object.freeze([1,0,0,0,1,0,0,0,1]),Ft=class extends hh{static get IDENTITY(){return Ok()}static get ZERO(){return Lk()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return JE}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(wk)}fromObject(e){return this.check()}fromQuaternion(e){return dw(this,e),this.check()}set(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=n,this[2]=l,this[3]=t,this[4]=o,this[5]=u,this[6]=i,this[7]=a,this[8]=c,this.check()}determinant(){return uw(this)}transpose(){return aw(this,this),this.check()}invert(){return lw(this,this),this.check()}multiplyLeft(e){return ZE(this,e,this),this.check()}multiplyRight(e){return ZE(this,this,e),this.check()}rotate(e){return hw(this,this,e),this.check()}scale(e){return Array.isArray(e)?QE(this,this,e):QE(this,this,[e,e]),this.check()}translate(e){return cw(this,this,e),this.check()}transform(e,t){let i;switch(e.length){case 2:i=YI(t||[-0,-0],e,this);break;case 3:i=Um(t||[-0,-0,-0],e,this);break;case 4:i=zm(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ha(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}},Km,Zm;function Lk(){return Km||(Km=new Ft([0,0,0,0,0,0,0,0,0]),Object.freeze(Km)),Km}function Ok(){return Zm||(Zm=new Ft,Object.freeze(Zm)),Zm}function Rk(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function pw(s,e){if(s===e){var t=e[1],i=e[2],n=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=i,s[9]=o,s[11]=e[14],s[12]=n,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function zf(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],p=e[11],S=e[12],x=e[13],T=e[14],O=e[15],M=t*l-i*a,R=t*u-n*a,N=t*c-o*a,H=i*u-n*l,Q=i*c-o*l,ne=n*c-o*u,he=h*x-d*S,se=h*T-f*S,oe=h*O-p*S,ge=d*T-f*x,Pe=d*O-p*x,pe=f*O-p*T,Ue=M*pe-R*Pe+N*ge+H*oe-Q*se+ne*he;return Ue?(Ue=1/Ue,s[0]=(l*pe-u*Pe+c*ge)*Ue,s[1]=(n*Pe-i*pe-o*ge)*Ue,s[2]=(x*ne-T*Q+O*H)*Ue,s[3]=(f*Q-d*ne-p*H)*Ue,s[4]=(u*oe-a*pe-c*se)*Ue,s[5]=(t*pe-n*oe+o*se)*Ue,s[6]=(T*N-S*ne-O*R)*Ue,s[7]=(h*ne-f*N+p*R)*Ue,s[8]=(a*Pe-l*oe+c*he)*Ue,s[9]=(i*oe-t*Pe-o*he)*Ue,s[10]=(S*Q-x*N+O*M)*Ue,s[11]=(d*N-h*Q-p*M)*Ue,s[12]=(l*se-a*ge-u*he)*Ue,s[13]=(t*ge-i*se+n*he)*Ue,s[14]=(x*R-S*H-T*M)*Ue,s[15]=(h*H-d*R+f*M)*Ue,s):null}function gw(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],f=s[11],p=s[12],S=s[13],x=s[14],T=s[15],O=e*a-t*o,M=e*l-i*o,R=e*u-n*o,N=t*l-i*a,H=t*u-n*a,Q=i*u-n*l,ne=c*S-h*p,he=c*x-d*p,se=c*T-f*p,oe=h*x-d*S,ge=h*T-f*S,Pe=d*T-f*x;return O*Pe-M*ge+R*oe+N*se-H*he+Q*ne}function Jo(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],p=e[10],S=e[11],x=e[12],T=e[13],O=e[14],M=e[15],R=t[0],N=t[1],H=t[2],Q=t[3];return s[0]=R*i+N*l+H*d+Q*x,s[1]=R*n+N*u+H*f+Q*T,s[2]=R*o+N*c+H*p+Q*O,s[3]=R*a+N*h+H*S+Q*M,R=t[4],N=t[5],H=t[6],Q=t[7],s[4]=R*i+N*l+H*d+Q*x,s[5]=R*n+N*u+H*f+Q*T,s[6]=R*o+N*c+H*p+Q*O,s[7]=R*a+N*h+H*S+Q*M,R=t[8],N=t[9],H=t[10],Q=t[11],s[8]=R*i+N*l+H*d+Q*x,s[9]=R*n+N*u+H*f+Q*T,s[10]=R*o+N*c+H*p+Q*O,s[11]=R*a+N*h+H*S+Q*M,R=t[12],N=t[13],H=t[14],Q=t[15],s[12]=R*i+N*l+H*d+Q*x,s[13]=R*n+N*u+H*f+Q*T,s[14]=R*o+N*c+H*p+Q*O,s[15]=R*a+N*h+H*S+Q*M,s}function Su(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,f,p,S,x,T,O;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],p=e[7],S=e[8],x=e[9],T=e[10],O=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=p,s[8]=S,s[9]=x,s[10]=T,s[11]=O,s[12]=a*i+h*n+S*o+e[12],s[13]=l*i+d*n+x*o+e[13],s[14]=u*i+f*n+T*o+e[14],s[15]=c*i+p*n+O*o+e[15]),s}function dh(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function mw(s,e,t,i){var n=i[0],o=i[1],a=i[2],l=Math.hypot(n,o,a),u,c,h,d,f,p,S,x,T,O,M,R,N,H,Q,ne,he,se,oe,ge,Pe,pe,Ue,ui;return l<ao?null:(l=1/l,n*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],f=e[1],p=e[2],S=e[3],x=e[4],T=e[5],O=e[6],M=e[7],R=e[8],N=e[9],H=e[10],Q=e[11],ne=n*n*h+c,he=o*n*h+a*u,se=a*n*h-o*u,oe=n*o*h-a*u,ge=o*o*h+c,Pe=a*o*h+n*u,pe=n*a*h+o*u,Ue=o*a*h-n*u,ui=a*a*h+c,s[0]=d*ne+x*he+R*se,s[1]=f*ne+T*he+N*se,s[2]=p*ne+O*he+H*se,s[3]=S*ne+M*he+Q*se,s[4]=d*oe+x*ge+R*Pe,s[5]=f*oe+T*ge+N*Pe,s[6]=p*oe+O*ge+H*Pe,s[7]=S*oe+M*ge+Q*Pe,s[8]=d*pe+x*Ue+R*ui,s[9]=f*pe+T*Ue+N*ui,s[10]=p*pe+O*Ue+H*ui,s[11]=S*pe+M*Ue+Q*ui,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function Qm(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+f*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=f*n-u*i,s}function bw(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n-c*i,s[1]=a*n-h*i,s[2]=l*n-d*i,s[3]=u*n-f*i,s[8]=o*i+c*n,s[9]=a*i+h*n,s[10]=l*i+d*n,s[11]=u*i+f*n,s}function Jm(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+f*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=f*n-u*i,s}function Pw(s,e){var t=e[0],i=e[1],n=e[2],o=e[4],a=e[5],l=e[6],u=e[8],c=e[9],h=e[10];return s[0]=Math.hypot(t,i,n),s[1]=Math.hypot(o,a,l),s[2]=Math.hypot(u,c,h),s}function yw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,x=o*a,T=o*l,O=o*u;return s[0]=1-d-S,s[1]=h+O,s[2]=f-T,s[3]=0,s[4]=h-O,s[5]=1-c-S,s[6]=p+x,s[7]=0,s[8]=f+T,s[9]=p-x,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Sw(s,e,t,i,n,o,a){var l=1/(t-e),u=1/(n-i),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(n+i)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function _k(s,e,t,i,n){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,n!=null&&n!==1/0?(a=1/(i-n),s[10]=(n+i)*a,s[14]=2*n*i*a):(s[10]=-1,s[14]=-2*i),s}var $E=_k;function Mk(s,e,t,i,n,o,a){var l=1/(e-t),u=1/(i-n),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+i)*u,s[14]=(a+o)*c,s[15]=1,s}var Ew=Mk;function xw(s,e,t,i){var n,o,a,l,u,c,h,d,f,p,S=e[0],x=e[1],T=e[2],O=i[0],M=i[1],R=i[2],N=t[0],H=t[1],Q=t[2];return Math.abs(S-N)<ao&&Math.abs(x-H)<ao&&Math.abs(T-Q)<ao?Rk(s):(h=S-N,d=x-H,f=T-Q,p=1/Math.hypot(h,d,f),h*=p,d*=p,f*=p,n=M*f-R*d,o=R*h-O*f,a=O*d-M*h,p=Math.hypot(n,o,a),p?(p=1/p,n*=p,o*=p,a*=p):(n=0,o=0,a=0),l=d*a-f*o,u=f*n-h*a,c=h*o-d*n,p=Math.hypot(l,u,c),p?(p=1/p,l*=p,u*=p,c*=p):(l=0,u=0,c=0),s[0]=n,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=f,s[11]=0,s[12]=-(n*S+o*x+a*T),s[13]=-(l*S+u*x+c*T),s[14]=-(h*S+d*x+f*T),s[15]=1,s)}function Nk(){var s=new Gr(4);return Gr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Cw(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function fh(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function vw(s){var e=s[0],t=s[1],i=s[2],n=s[3];return Math.hypot(e,t,i,n)}function Aw(s){var e=s[0],t=s[1],i=s[2],n=s[3];return e*e+t*t+i*i+n*n}function Tw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o;return a>0&&(a=1/Math.sqrt(a)),s[0]=t*a,s[1]=i*a,s[2]=n*a,s[3]=o*a,s}function Iw(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]+s[3]*e[3]}function ww(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s[3]=l+i*(t[3]-l),s}function lo(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}function Lw(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2],c=t[3],h=c*i+l*o-u*n,d=c*n+u*i-a*o,f=c*o+a*n-l*i,p=-a*i-l*n-u*o;return s[0]=h*c+p*-a+d*-u-f*-l,s[1]=d*c+p*-l+f*-a-h*-u,s[2]=f*c+p*-u+h*-l-d*-a,s[3]=e[3],s}var xAe=function(){var s=Nk();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var rx;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(rx||(rx={}));var Bk=45*Math.PI/180,Dk=1,ex=.1,tx=500,Fk=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),mt=class extends hh{static get IDENTITY(){return Vk()}static get ZERO(){return Gk()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return rx}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,o,a,l,u,c,h,d,f,p,S,x,T){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=f,this[12]=p,this[13]=S,this[14]=x,this[15]=T,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c,h,d,f,p,S,x,T){return this[0]=e,this[1]=o,this[2]=c,this[3]=p,this[4]=t,this[5]=a,this[6]=h,this[7]=S,this[8]=i,this[9]=l,this[10]=d,this[11]=x,this[12]=n,this[13]=u,this[14]=f,this[15]=T,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(Fk)}fromObject(e){return this.check()}fromQuaternion(e){return yw(this,e),this.check()}frustum(e){let{left:t,right:i,bottom:n,top:o,near:a=ex,far:l=tx}=e;return l===1/0?kk(this,t,i,n,o,a):Sw(this,t,i,n,o,a,l),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:n=[0,1,0]}=e;return xw(this,t,i,n),this.check()}ortho(e){let{left:t,right:i,bottom:n,top:o,near:a=ex,far:l=tx}=e;return Ew(this,t,i,n,o,a,l),this.check()}orthographic(e){let{fovy:t=Bk,aspect:i=Dk,focalDistance:n=1,near:o=ex,far:a=tx}=e;Ow(t);let l=t/2,u=n*Math.tan(l),c=u*i;return this.ortho({left:-c,right:c,bottom:-u,top:u,near:o,far:a})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:o=500}=e;return Ow(t),$E(this,t,i,n,o),this.check()}determinant(){return gw(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*n,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*n,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return pw(this,this),this.check()}invert(){return zf(this,this),this.check()}multiplyLeft(e){return Jo(this,e,this),this.check()}multiplyRight(e){return Jo(this,this,e),this.check()}rotateX(e){return Qm(this,this,e),this.check()}rotateY(e){return bw(this,this,e),this.check()}rotateZ(e){return Jm(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return mw(this,this,e,t),this.check()}scale(e){return dh(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return Su(this,this,e),this.check()}transform(e,t){return e.length===4?(t=lo(t||[-0,-0,-0,-0],e,this),Ha(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:i}=e,n;switch(i){case 2:n=KI(t||[-0,-0],e,this);break;case 3:n=uh(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ha(n,e.length),n}transformAsVector(e,t){let i;switch(e.length){case 2:i=ZI(t||[-0,-0],e,this);break;case 3:i=km(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Ha(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}},$m,eb;function Gk(){return $m||($m=new mt([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze($m)),$m}function Vk(){return eb||(eb=new mt,Object.freeze(eb)),eb}function Ow(s){if(s>Math.PI*2)throw Error("expected radians")}function kk(s,e,t,i,n,o){let a=2*o/(t-e),l=2*o/(n-i),u=(t+e)/(t-e),c=(n+i)/(n-i),h=-1,d=-1,f=-2*o;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=l,s[6]=0,s[7]=0,s[8]=u,s[9]=c,s[10]=h,s[11]=d,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}function Rw(){var s=new Gr(4);return Gr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function _w(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function ix(s,e,t){t=t*.5;var i=Math.sin(t);return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=Math.cos(t),s}function nx(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=t[0],u=t[1],c=t[2],h=t[3];return s[0]=i*h+a*l+n*c-o*u,s[1]=n*h+a*u+o*l-i*c,s[2]=o*h+a*c+i*u-n*l,s[3]=a*h-i*l-n*u-o*c,s}function Mw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+a*l,s[1]=n*u+o*l,s[2]=o*u-n*l,s[3]=a*u-i*l,s}function Nw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u-o*l,s[1]=n*u+a*l,s[2]=o*u+i*l,s[3]=a*u-n*l,s}function Bw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+n*l,s[1]=n*u-i*l,s[2]=o*u+a*l,s[3]=a*u-o*l,s}function Dw(s,e){var t=e[0],i=e[1],n=e[2];return s[0]=t,s[1]=i,s[2]=n,s[3]=Math.sqrt(Math.abs(1-t*t-i*i-n*n)),s}function Wf(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3],u=t[0],c=t[1],h=t[2],d=t[3],f,p,S,x,T;return p=n*u+o*c+a*h+l*d,p<0&&(p=-p,u=-u,c=-c,h=-h,d=-d),1-p>ao?(f=Math.acos(p),S=Math.sin(f),x=Math.sin((1-i)*f)/S,T=Math.sin(i*f)/S):(x=1-i,T=i),s[0]=x*n+T*u,s[1]=x*o+T*c,s[2]=x*a+T*h,s[3]=x*l+T*d,s}function Fw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o,l=a?1/a:0;return s[0]=-t*l,s[1]=-i*l,s[2]=-n*l,s[3]=o*l,s}function Gw(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s[3]=e[3],s}function ox(s,e){var t=e[0]+e[4]+e[8],i;if(t>0)i=Math.sqrt(t+1),s[3]=.5*i,i=.5/i,s[0]=(e[5]-e[7])*i,s[1]=(e[6]-e[2])*i,s[2]=(e[1]-e[3])*i;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[n*3+n]&&(n=2);var o=(n+1)%3,a=(n+2)%3;i=Math.sqrt(e[n*3+n]-e[o*3+o]-e[a*3+a]+1),s[n]=.5*i,i=.5/i,s[3]=(e[o*3+a]-e[a*3+o])*i,s[o]=(e[o*3+n]+e[n*3+o])*i,s[a]=(e[a*3+n]+e[n*3+a])*i}return s}var Vw=Cw;var kw=fh,zw=Iw,Uw=ww,Ww=vw;var Hw=Aw;var jw=Tw;var qw=function(){var s=qE(),e=XE(1,0,0),t=XE(0,1,0);return function(i,n,o){var a=YE(n,o);return a<-.999999?(lh(s,e,n),jm(s)<1e-6&&lh(s,t,n),ew(s,s),ix(i,s,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(lh(s,n,o),i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=1+a,jw(i,i))}}(),MAe=function(){var s=Rw(),e=Rw();return function(t,i,n,o,a,l){return Wf(s,i,a,l),Wf(e,n,o,l),Wf(t,s,e,2*l*(1-l)),t}}(),NAe=function(){var s=sw();return function(e,t,i,n){return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=n[0],s[4]=n[1],s[7]=n[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],jw(e,ox(e,s))}}();var Uk=[0,0,0,1],gh=class extends Wa{constructor(e=0,t=0,i=0,n=1){super(-0,-0,-0,-0);Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,i,n)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return ox(this,e),this.check()}fromAxisRotation(e,t){return ix(this,e,t),this.check()}identity(){return _w(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=$e(e)}get y(){return this[1]}set y(e){this[1]=$e(e)}get z(){return this[2]}set z(e){this[2]=$e(e)}get w(){return this[3]}set w(e){this[3]=$e(e)}len(){return Ww(this)}lengthSquared(){return Hw(this)}dot(e){return zw(this,e)}rotationTo(e,t){return qw(this,e,t),this.check()}add(e){return Vw(this,this,e),this.check()}calculateW(){return Dw(this,this),this.check()}conjugate(){return Gw(this,this),this.check()}invert(){return Fw(this,this),this.check()}lerp(e,t,i){return i===void 0?this.lerp(this,e,t):(Uw(this,e,t,i),this.check())}multiplyRight(e){return nx(this,this,e),this.check()}multiplyLeft(e){return nx(this,e,this),this.check()}normalize(){let e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return Mw(this,this,e),this.check()}rotateY(e){return Nw(this,this,e),this.check()}rotateZ(e){return Bw(this,this,e),this.check()}scale(e){return kw(this,this,e),this.check()}slerp(e,t,i){let n,o,a;switch(arguments.length){case 1:({start:n=Uk,target:o,ratio:a}=e);break;case 2:n=this,o=e,a=t;break;default:n=e,o=t,a=i}return Wf(this,n,o,a),this.check()}transformVector4(e,t=new ch){return Lw(t,e,this),Ha(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}};var tb={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,PI_OVER_TWO:Math.PI/2,PI_OVER_FOUR:Math.PI/4,PI_OVER_SIX:Math.PI/6,TWO_PI:Math.PI*2};var sx=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))

struct AmbientLight {
 vec3 color;
};

struct PointLight {
 vec3 color;
 vec3 position;
 vec3 attenuation;
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;

uniform bool lighting_uEnabled;

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

#endif
`;var Wk={lightSources:{}};function ax(){let{color:s=[0,0,0],intensity:e=1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.map(t=>t*e/255)}function Hk(s){let{ambientLight:e,pointLights:t=[],directionalLights:i=[]}=s,n={};return e?n["lighting_uAmbientLight.color"]=ax(e):n["lighting_uAmbientLight.color"]=[0,0,0],t.forEach((o,a)=>{n["lighting_uPointLight[".concat(a,"].color")]=ax(o),n["lighting_uPointLight[".concat(a,"].position")]=o.position,n["lighting_uPointLight[".concat(a,"].attenuation")]=o.attenuation||[1,0,0]}),n.lighting_uPointLightCount=t.length,i.forEach((o,a)=>{n["lighting_uDirectionalLight[".concat(a,"].color")]=ax(o),n["lighting_uDirectionalLight[".concat(a,"].direction")]=o.direction}),n.lighting_uDirectionalLightCount=i.length,n}function Xw(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Wk;if("lightSources"in s){let{ambientLight:e,pointLights:t,directionalLights:i}=s.lightSources||{};return e||t&&t.length>0||i&&i.length>0?Object.assign({},Hk({ambientLight:e,pointLights:t,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in s){let e={pointLights:[],directionalLights:[]};for(let t of s.lights||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights.push(t);break;case"point":e.pointLights.push(t);break;default:}return Xw({lightSources:e})}return{}}var Yw={name:"lights",vs:sx,fs:sx,getUniforms:Xw,defines:{MAX_LIGHTS:3}};var jk=new Uint8Array([0,255,255,255]),qk={pickingSelectedColor:null,pickingHighlightColor:jk,pickingActive:!1,pickingAttribute:!1};function Xk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:qk,e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,i=>i/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var Yk=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,Kk=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,qa={name:"picking",vs:Yk,fs:Kk,getUniforms:Xk};var Kw=`
uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
    vec3 halfway_direction = normalize(light_direction + view_direction);
    float lambertian = dot(light_direction, normal_worldspace);
    float specular = 0.0;
    if (lambertian > 0.0) {
      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
      specular = pow(specular_angle, lighting_uShininess);
    }
    lambertian = max(lambertian, 0.0);
    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);
    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}

vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = vec3(0, 0, 0);
  vec3 surfaceColor = vec3(0, 0, 0);

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}
`;var Zk={};function Qk(s){let{ambient:e=.35,diffuse:t=.6,shininess:i=32,specularColor:n=[30,30,30]}=s;return{lighting_uAmbient:e,lighting_uDiffuse:t,lighting_uShininess:i,lighting_uSpecularColor:n.map(o=>o/255)}}function Jk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Zk;if(!("material"in s))return{};let{material:e}=s;return e?Qk(e):{lighting_uEnabled:!1}}var mh={name:"gouraud-lighting",dependencies:[Yw],vs:Kw,defines:{LIGHTING_VERTEX:1},getUniforms:Jk};var $k=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,lx={name:"transform",vs:$k,fs:null};var Cn=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new Cn(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{vs:t="",fs:i="",defines:n={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(i),f=c.map(R=>this._getHash(R.name)).sort(),p=a.map(R=>this._getHash(R)),S=Object.keys(n).sort(),x=Object.keys(o).sort(),T=[],O=[];for(let R of S)T.push(this._getHash(R)),T.push(this._getHash(n[R]));for(let R of x)O.push(this._getHash(R)),O.push(this._getHash(o[R]));let M="".concat(h,"/").concat(d,"D").concat(T.join("/"),"M").concat(f.join("/"),"I").concat(O.join("/"),"V").concat(p.join("/"),"H").concat(this.stateHash,"B").concat(l).concat(u?"T":"");if(!this._programCache[M]){let R=zE(this.gl,{vs:t,fs:i,modules:c,inject:o,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[M]=new Va(this.gl,{hash:M,vs:R.vs,fs:R.fs,varyings:a,bufferMode:l}),this._getUniforms[M]=R.getUniforms||(N=>{}),this._useCounts[M]=0}return this._useCounts[M]++,this._programCache[M]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=new Array(this._defaultModules.length+e.length),i={},n=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[n++]=l,i[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;i[u]||(t[n++]=l,i[u]=!0)}return t.length=n,t}};var e3={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function Zw(s,e,t){let i={},n=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=t3(o,t);if(o==="indices")n=a;else if(a.constant)i[l]=a.value;else{let u=a.value,c={...a};delete c.value,i[l]=[new ve(s,u),c],r3(o,c)}}if(n){let o=n.value||n;K(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:n.isIndexed===void 0?!0:n.isIndexed};i.indices=[new ve(s,{data:o,target:34963}),a]}return i}function t3(s,e){let{attributeMap:t=e3}=e||{};return t&&t[s]||s}function r3(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}K(Number.isFinite(e.size),"attribute ".concat(s," needs size"))}var bh=2,i3=1e4,n3="Model needs drawMode and vertexCount",Qw=()=>{},o3={},Gt=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{id:i=Ii("model")}=t;K(Bs(e)),this.id=i,this.gl=e,this.id=t.id||Ii("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||Cn.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},K(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),n3)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return K(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return K(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=Zw(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Qo(e))return this;let t={};for(let i in e){let n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return Ba(this.program.gl,e),this}draw(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();let{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(n);let c;ie.priority>=bh&&(c=this._logDrawCallStart(bh));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:f=h.indexType,indexOffset:p=h.indexOffset,vertexArrayInstanced:S=h.isInstanced}=this.props;S&&!this.isInstanced&&ie.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:x,instanceCount:T}=this,{onBeforeRender:O=Qw,onAfterRender:M=Qw}=this.props;O(),this.program.setUniforms(this.uniforms);let R=this.program.draw(Object.assign(o3,e,{logPriority:c,uniforms:null,framebuffer:i,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:f,isInstanced:x,instanceCount:T,offset:d?p:0}));return M(),ie.priority>=bh&&this._logDrawCallEnd(c,u,i),R}transform(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e,{parameters:o}=e;i&&this._setFeedbackBuffers(i),t&&(o=Object.assign({},o,{[35977]:t})),n.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{n.forEach(a=>a.vertexArray.bindBuffers())}return this}render(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ie.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}K(t instanceof Va,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Bf(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof ve&&t.delete()}}_setAnimationProps(e){this.animated&&K(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Qo(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new za(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:i3;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),ie.group(bh,">>> DRAWING MODEL ".concat(this.id),{collapsed:ie.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(e===void 0)return;let o=OE({vertexArray:t,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=Mm({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:c,count:h}=Mm({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});h>0&&ie.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&ie.log("UNUSED UNIFORMS",Object.keys(l))();let d=RE(this.vertexArray.configuration);ie.table(e,o)(),ie.table(e,a)(),ie.table(e+1,d)(),n&&n.log({logLevel:bh,message:"Rendered to ".concat(n.id)}),ie.groupEnd(bh)()}};var rb=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof ve?i:i.buffer:null}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&K(fe(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let n in this.feedbackMap){let o=this.feedbackMap[n];n in t&&(i[o]=n)}Object.assign(i,e.feedbackBuffers);for(let n in i){let o=i[n];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;i[n]=this._createNewBuffer(n,{byteLength:l,usage:u,accessor:c})}}return i}_setupBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,t){let{model:i}=t,{program:n}=i;e.transformFeedback=new za(this.gl,{program:n,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:i})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(let n in this.feedbackMap){let o=this.feedbackMap[n];t[n]=e.feedbackBuffers[o],i[o]=e.sourceBuffers[n],K(i[o]instanceof ve)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){let i=new ve(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}};var s3="transform_uSampler_",ib="transform_uSize_",Jw="transform_position";function $w(s){let{vs:e,sourceTextureMap:t,targetTextureVarying:i,targetTexture:n}=s,a=Object.keys(t).length,l=null,u={},c=e,h={};if(a>0||i){let d=c.split(`
`),f=d.slice();if(d.forEach((p,S,x)=>{if(a>0){let T=c3(p,t);if(T){let{updatedLine:O,inject:M}=T;f[S]=O,h=rh([h,M]),Object.assign(u,T.samplerTextureMap),a--}}i&&!l&&(l=u3(p,i))}),i){K(n);let p="".concat(ib).concat(i),S="uniform vec2 ".concat(p,`;
`),x="     vec2 ".concat(Jw," = transform_getPos(").concat(p,`);
     gl_Position = vec4(`).concat(Jw,`, 0, 1.);
`);h=rh([h,{"vs:#decl":S,"vs:#main-start":x}])}c=f.join(`
`)}return{vs:c,targetTextureType:l,inject:h,samplerTextureMap:u}}function eL(s){let{sourceTextureMap:e,targetTextureVarying:t,targetTexture:i}=s,n={},o,a;t&&({width:o,height:a}=i,n["".concat(ib).concat(t)]=[o,a]);for(let l in e)({width:o,height:a}=e[l]),n["".concat(ib).concat(l)]=[o,a];return n}function a3(s){return Dm(s,["attribute","in"])}function l3(s){let e="".concat(s3).concat(s),t="".concat(ib).concat(s),i="  uniform sampler2D ".concat(e,`;
  uniform vec2 `).concat(t,";");return{samplerName:e,sizeName:t,uniformDeclerations:i}}function u3(s,e){let t=Dm(s,["varying","out"]);return t&&t.name===e?t.type:null}function c3(s,e){let t={},i=a3(s);if(!i)return null;let{type:n,name:o}=i;if(o&&e[o]){let a="// ".concat(s," => Replaced by Transform with a sampler"),{samplerName:l,sizeName:u,uniformDeclerations:c}=l3(o),h=UE(n),d="  ".concat(n," ").concat(o," = transform_getInput(").concat(l,", ").concat(u,").").concat(h,`;
`);return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var h3={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},d3="transform_output",nb=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let f=this.samplerTextureMap[d];l[d]=i[f]}this._setSourceTextureParameters();let h=eL({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,n.width,n.height]),{attributes:a,framebuffer:n,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{framebuffer:t}=this.bindings[this.currentIndex],i=Fs(t);if(!e)return i;let n=i.constructor,o=WE(this.targetTextureType),a=new n(i.length*o/4),l=0;for(let u=0;u<i.length;u+=4)for(let c=0;c<o;c++)a[l++]=i[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Je)return i;let n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,o=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((i,n,o)=>{o[n]=n}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new ve(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:i})}}_updateBinding(e,t){let{sourceBuffers:i,sourceTextures:n,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new ze(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let i in t)t[i].setParameters(h3)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let i=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:i}}_createNewTexture(e){let t=Zc(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=$w({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),c=rh([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||kf({version:Qc(n),input:this.targetTextureVarying,inputType:a,output:d3}),d=this.hasSourceTextures||this.targetTextureVarying?[lx].concat(e.modules||[]):e.modules;return{vs:n,fs:h,modules:d,uniforms:o,inject:c}}};var vn=class{static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)e=e||i.swap();K(e,"Nothing to swap")}getBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t){let n=i.getData(e);if(n)return n}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)i.update(e)}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new Gt(t,Object.assign({},e,{fs:e.fs||kf({version:Qc(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=n.updateModelProps(t);return t}_buildResourceTransforms(e,t){f3(t)&&(this.bufferTransform=new rb(e,t)),p3(t)&&(this.textureTransform=new nb(e,t)),K(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=Object.assign(t,n.getDrawOptions(t));return t}};function f3(s){return!!(!Qo(s.feedbackBuffers)||!Qo(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function p3(s){return!!(!Qo(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var tL={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Tr=class{static get DRAW_MODE(){return tL}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{id:t=Ii("geometry"),drawMode:i=tL.TRIANGLES,attributes:n={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(n,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let i in e){let n=e[i];n=ArrayBuffer.isView(n)?{value:n}:n,K(ArrayBuffer.isView(n.value),"".concat(this._print(i),": must be typed array or object with value as typed array")),(i==="POSITION"||i==="positions")&&!n.size&&(n.size=3),i==="indices"?(K(!this.indices),this.indices=n):this.attributes[i]=n}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let n in e){let o=e[n],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(i=Math.min(i,a.length/l))}return K(Number.isFinite(i)),i}};var g3=1,m3=1,Eu=class{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){let{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:o=1}=e,a=g3++,l={time:0,delay:t,duration:i,rate:n,repeat:o};return this._setChannelTime(l,this.time),this.channels.set(a,l),a}removeChannel(e){this.channels.delete(e);for(let[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;let t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);let t=this.channels.values();for(let n of t)this._setChannelTime(n,this.time);let i=this.animations.values();for(let n of i){let{animation:o,channel:a}=n;o.setTime(this.getTime(a))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=m3++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay,n=e.duration*e.repeat;i>=n?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}};var rL="#define SMOOTH_EDGE_RADIUS 0.5",b3=`
`.concat(rL,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),P3=`
`.concat(rL,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),iL={name:"geometry",vs:b3,fs:P3};var Ve={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Ve,"IDENTITY",{get:()=>(ce.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var ai={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Vr={common:0,meters:1,pixels:2},cx={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},uo={DRAW:"draw",MASK:"mask"};var y3=Object.keys(Ve).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Ve[s],";")).join(""),S3=Object.keys(ai).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(ai[s],";")).join(""),E3=Object.keys(Vr).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(Vr[s],";")).join(""),nL="".concat(y3,`
`).concat(S3,`
`).concat(E3,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      float y = clamp(geometry.worldPosition.y, -89.9, 89.9);
      return 1.0 / cos(radians(y));
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}
//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size(position_world.z),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function x3(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}return!1}function co(s){let e={},t;return i=>{for(let n in i)if(!x3(i[n],e[n])){t=s(i),e=i;break}return t}}var oL=[0,0,0,0],C3=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],sL=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],v3=[0,0,0],aL=[0,0,0],A3=co(I3);function hx(s,e,t=aL){t.length<3&&(t=[t[0],t[1],0]);let i=t,n,o=!0;switch(e===Ve.LNGLAT_OFFSETS||e===Ve.METER_OFFSETS?n=t:n=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case ai.WEB_MERCATOR:(e===Ve.LNGLAT||e===Ve.CARTESIAN)&&(n=[0,0,0],o=!1);break;case ai.WEB_MERCATOR_AUTO_OFFSET:e===Ve.LNGLAT?i=n:e===Ve.CARTESIAN&&(i=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],n=s.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case ai.IDENTITY:i=s.position.map(Math.fround),i[2]=i[2]||0;break;case ai.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:i,offsetMode:o}}function T3(s,e,t){let{viewMatrixUncentered:i,projectionMatrix:n}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=oL,u=oL,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:f}=hx(s,e,t);return f&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=lo([],u,a),o=i||o,a=Jo([],n,o),a=Jo([],a,C3)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function lL({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Ve.DEFAULT,coordinateOrigin:n=aL,autoWrapLongitude:o=!1}){i===Ve.DEFAULT&&(i=s.isGeospatial?Ve.LNGLAT:Ve.CARTESIAN);let a=A3({viewport:s,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||sL,a}function I3({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){let{projectionCenter:n,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=T3(s,t,i),h=s.getDistanceScales(),d=[s.width*e,s.height*e],f=lo([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,p={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:n,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:v3,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:sL,project_uCameraPosition:l};if(c){let S=s.getDistanceScales(c);switch(t){case Ve.METER_OFFSETS:p.project_uCommonUnitsPerWorldUnit=S.unitsPerMeter,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerMeter2;break;case Ve.LNGLAT:case Ve.LNGLAT_OFFSETS:s._pseudoMeters||(p.project_uCommonUnitsPerMeter=S.unitsPerMeter),p.project_uCommonUnitsPerWorldUnit=S.unitsPerDegree,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerDegree2;break;case Ve.CARTESIAN:p.project_uCommonUnitsPerWorldUnit=[1,1,S.unitsPerMeter[2]],p.project_uCommonUnitsPerWorldUnit2=[0,0,S.unitsPerMeter2[2]];break;default:break}}return p}var w3={};function L3(s=w3){return"viewport"in s?lL(s):{}}var xu={name:"project",dependencies:[Fm,iL],vs:nL,getUniforms:L3};var O3=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,li={name:"project32",dependencies:[xu],vs:O3};function dx(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Xa(s,e){let t=lo([],e,s);return fh(t,t,1/t[3]),t}function fx(s,e){let t=s%e;return t<0?e+t:t}function Hf(s,e,t){return s<e?e:s>t?t:s}function R3(s){return Math.log(s)*Math.LOG2E}var Ph=Math.log2||R3;function An(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var ho=Math.PI,uL=ho/4,fo=ho/180,px=180/ho,jf=512,gx=4003e4,yh=85.051129,cL=1.5;function mx(s){return Ph(s)}function Tn(s){let[e,t]=s;An(Number.isFinite(e)),An(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");let i=e*fo,n=t*fo,o=jf*(i+ho)/(2*ho),a=jf*(ho+Math.log(Math.tan(uL+n*.5)))/(2*ho);return[o,a]}function tn(s){let[e,t]=s,i=e/jf*(2*ho)-ho,n=2*(Math.atan(Math.exp(t/jf*(2*ho)-ho))-uL);return[i*px,n*px]}function bx(s){let{latitude:e}=s;An(Number.isFinite(e));let t=Math.cos(e*fo);return mx(gx*t)-9}function Sh(s){let{latitude:e,longitude:t,highPrecision:i=!1}=s;An(Number.isFinite(e)&&Number.isFinite(t));let n=jf,o=Math.cos(e*fo),a=n/360,l=a/o,u=n/gx/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[a,l,u],degreesPerUnit:[1/a,1/l,1/u]};if(i){let h=fo*Math.tan(e*fo)/o,d=a*h/2,f=n/gx*h,p=f/l*u;c.unitsPerDegree2=[0,d,f],c.unitsPerMeter2=[p,0,p]}return c}function qf(s,e){let[t,i,n]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Sh({longitude:t,latitude:i,highPrecision:!0}),h=Tn(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=tn(h),f=(n||0)+(l||0);return Number.isFinite(n)||Number.isFinite(l)?[d[0],d[1],f]:d}function ob(s){let{height:e,pitch:t,bearing:i,altitude:n,scale:o,center:a}=s,l=dx();Su(l,l,[0,0,-n]),Qm(l,l,-t*fo),Jm(l,l,i*fo);let u=o/e;return dh(l,l,[u,u,u]),a&&Su(l,l,$I([],a)),l}function Px(s){let{width:e,height:t,altitude:i,pitch:n=0,offset:o,center:a,scale:l,nearZMultiplier:u=1,farZMultiplier:c=1}=s,{fovy:h=Cu(cL)}=s;i!==void 0&&(h=Cu(i));let d=h*fo,f=n*fo,p=Xf(h),S=p;a&&(S+=a[2]*l/Math.cos(f)/t);let x=d*(.5+(o?o[1]:0)/t),T=Math.sin(x)*S/Math.sin(Hf(Math.PI/2-f-x,.01,Math.PI-.01)),O=Math.sin(f)*T+S,M=S*10,R=Math.min(O*c,M);return{fov:d,aspect:e/t,focalDistance:p,near:u,far:R}}function Cu(s){return 2*Math.atan(.5/s)*px}function Xf(s){return .5/Math.tan(.5*s*fo)}function Eh(s,e){let[t,i,n=0]=s;return An(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(n)),Xa(e,[t,i,n,1])}function $o(s,e,t=0){let[i,n,o]=s;if(An(Number.isFinite(i)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(o))return Xa(e,[i,n,o,1]);let a=Xa(e,[i,n,0,1]),l=Xa(e,[i,n,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return Vm([],a,l,h)}function vu(s){let{width:e,height:t,bounds:i,minExtent:n=0,maxZoom:o=24,offset:a=[0,0]}=s,[[l,u],[c,h]]=i,d=_3(s.padding),f=Tn([l,Hf(h,-yh,yh)]),p=Tn([c,Hf(u,-yh,yh)]),S=[Math.max(Math.abs(p[0]-f[0]),n),Math.max(Math.abs(p[1]-f[1]),n)],x=[e-d.left-d.right-Math.abs(a[0])*2,t-d.top-d.bottom-Math.abs(a[1])*2];An(x[0]>0&&x[1]>0);let T=x[0]/S[0],O=x[1]/S[1],M=(d.right-d.left)/2/T,R=(d.bottom-d.top)/2/O,N=[(p[0]+f[0])/2+M,(p[1]+f[1])/2+R],H=tn(N),Q=Math.min(o,Ph(Math.abs(Math.min(T,O))));return An(Number.isFinite(Q)),{longitude:H[0],latitude:H[1],zoom:Q}}function _3(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(An(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}var hL=Math.PI/180;function Yf(s,e=0){let{width:t,height:i,unproject:n}=s,o={targetZ:e},a=n([0,i],o),l=n([t,i],o),u,c,h=s.fovy?.5*s.fovy*hL:Math.atan(.5/s.altitude),d=(90-s.pitch)*hL;return h>d-.01?(u=dL(s,0,e),c=dL(s,t,e)):(u=n([0,0],o),c=n([t,0],o)),[a,l,c,u]}function dL(s,e,t){let{pixelUnprojectionMatrix:i}=s,n=Xa(i,[e,0,1,1]),o=Xa(i,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-n[2])/(o[2]-n[2]),u=Vm([],n,o,l),c=tn(u);return c.push(t),c}var pL=512;function sb(s){let{width:e,height:t,pitch:i=0}=s,{longitude:n,latitude:o,zoom:a,bearing:l=0}=s;(n<-180||n>180)&&(n=fx(n+180,360)-180),(l<-180||l>180)&&(l=fx(l+180,360)-180);let u=Ph(t/pL);if(a<=u)a=u,o=0;else{let c=t/2/Math.pow(2,a),h=tn([0,c])[1];if(o<h)o=h;else{let d=tn([0,pL-c])[1];o>d&&(o=d)}}return{width:e,height:t,longitude:n,latitude:o,zoom:a,pitch:i,bearing:l}}var B3=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,D3=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,F3=co(U3),G3=co(W3),V3=[0,0,0,1],k3=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function z3(s,e){let[t,i,n]=s,o=$o([t,i,n],e);return Number.isFinite(n)?o:[o[0],o[1],0]}function U3({viewport:s,center:e}){return new mt(s.viewProjectionMatrix).invert().transform(e)}function W3({viewport:s,shadowMatrices:e}){let t=[],i=s.pixelUnprojectionMatrix,n=s.isGeospatial?void 0:1,o=[[0,0,n],[s.width,0,n],[0,s.height,n],[s.width,s.height,n],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(a=>z3(a,i));for(let a of e){let l=a.clone().translate(new ee(s.center).negate()),u=o.map(h=>l.transform(h)),c=new mt().ortho({left:Math.min(...u.map(h=>h[0])),right:Math.max(...u.map(h=>h[0])),bottom:Math.min(...u.map(h=>h[1])),top:Math.max(...u.map(h=>h[1])),near:Math.min(...u.map(h=>-h[2])),far:Math.max(...u.map(h=>-h[2]))});t.push(c.multiplyRight(a))}return t}function H3(s,e){let{shadowEnabled:t=!0}=s;if(!t||!s.shadowMatrices||!s.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};let i={shadow_uDrawShadowMap:Boolean(s.drawToShadowMap),shadow_uUseShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,shadow_uColor:s.shadowColor||V3,shadow_uLightId:s.shadowLightId||0,shadow_uLightCount:s.shadowMatrices.length},n=F3({viewport:s.viewport,center:e.project_uCenter}),o=[],a=G3({shadowMatrices:s.shadowMatrices,viewport:s.viewport}).slice();for(let l=0;l<s.shadowMatrices.length;l++){let u=a[l],c=u.clone().translate(new ee(s.viewport.center).negate());e.project_uCoordinateSystem===Ve.LNGLAT&&e.project_uProjectionMode===ai.WEB_MERCATOR?(a[l]=c,o[l]=n):(a[l]=u.clone().multiplyRight(k3),o[l]=c.transform(n))}for(let l=0;l<a.length;l++)i["shadow_uViewProjectionMatrices[".concat(l,"]")]=a[l],i["shadow_uProjectCenters[".concat(l,"]")]=o[l],s.shadowMaps&&s.shadowMaps.length>0?i["shadow_uShadowMap".concat(l)]=s.shadowMaps[l]:i["shadow_uShadowMap".concat(l)]=s.dummyShadowMap;return i}var Kf={name:"shadow",dependencies:[xu],vs:B3,fs:D3,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(s={},e={})=>"viewport"in s&&(s.drawToShadowMap||s.shadowMaps&&s.shadowMaps.length>0)?H3(s,e):{}};var In={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...qa};var j3=[xu],q3=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function gL(s){let e=Cn.getDefaultProgramManager(s);for(let t of j3)e.addDefaultModule(t);for(let t of q3)e.addShaderHook(t);return e}var X3=[255,255,255],Y3=1,K3=0,yx=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","ambient");let{color:t=X3}=e,{intensity:i=Y3}=e;this.id=e.id||"ambient-".concat(K3++),this.color=t,this.intensity=i}};var Z3=[255,255,255],Q3=1,J3=[0,0,-1],$3=0,ab=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","directional"),y(this,"direction",void 0),y(this,"shadow",void 0);let{color:t=Z3}=e,{intensity:i=Q3}=e,{direction:n=J3}=e,{_shadow:o=!1}=e;this.id=e.id||"directional-".concat($3++),this.color=t,this.intensity=i,this.type="directional",this.direction=new ee(n).normalize().toArray(),this.shadow=o}getProjectedLight(e){return this}};var lb=class{constructor(e,t={id:"pass"}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"props",void 0);let{id:i}=t;this.id=i,this.gl=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}};var es=class extends lb{constructor(...e){super(...e);y(this,"_lastRenderIndex",-1)}render(e){let t=this.gl;return Ti(t,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){let{target:t,moduleParameters:i,viewports:n,views:o,onViewportActive:a,clearStack:l=!0,clearCanvas:u=!0}=e;e.pass=e.pass||"unknown";let c=this.gl;u&&t5(c),l&&(this._lastRenderIndex=-1);let h=[];for(let d of n){let f=o&&o[d.id];a(d);let p=this._getDrawLayerParams(d,e),S=d.subViewports||[d];for(let x of S){let T=this._drawLayersInViewport(c,{target:t,moduleParameters:i,viewport:x,view:f,pass:e.pass,layers:e.layers},p);h.push(T)}}return h}_getDrawLayerParams(e,{layers:t,pass:i,layerFilter:n,cullRect:o,effects:a,moduleParameters:l}){let u=[],c=mL(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:i.startsWith("picking"),renderPass:i,cullRect:o},d={};for(let f=0;f<t.length;f++){let p=t[f],S=this._shouldDrawLayer(p,h,n,d),x={shouldDrawLayer:S};S&&(x.layerRenderIndex=c(p,S),x.moduleParameters=this._getModuleParameters(p,a,i,l),x.layerParameters=this.getLayerParameters(p,f,e)),u[f]=x}return u}_drawLayersInViewport(e,{layers:t,moduleParameters:i,pass:n,target:o,viewport:a,view:l},u){let c=e5(e,{moduleParameters:i,target:o,viewport:a});if(l&&l.props.clear){let d=l.props.clear===!0?{color:!0,depth:!0}:l.props.clear;yt(e,{scissorTest:!0,scissor:c},()=>Ba(e,d))}let h={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};Ti(e,{viewport:c});for(let d=0;d<t.length;d++){let f=t[d],{shouldDrawLayer:p,layerRenderIndex:S,moduleParameters:x,layerParameters:T}=u[d];if(p&&f.props.pickable&&h.pickableCount++,f.isComposite)h.compositeCount++;else if(p){h.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,S),x.viewport=a;try{f._drawLayer({moduleParameters:x,uniforms:{layerIndex:S},parameters:T})}catch(O){f.raiseError(O,"drawing ".concat(f," to ").concat(n))}}}return h}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,n){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let a=e.parent;for(;a;){if(!a.props.visible||!a.filterSubLayer(t))return!1;t.layer=a,a=a.parent}if(i){let l=t.layer.id;if(l in n||(n[l]=i(t)),!n[l])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,i,n){var o;let a=Object.assign(Object.create(((o=e.internalState)===null||o===void 0?void 0:o.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:no(this.gl)});if(t)for(let u of t){var l;Object.assign(a,(l=u.getModuleParameters)===null||l===void 0?void 0:l.call(u,e))}return Object.assign(a,this.getModuleParameters(e,t),n)}};function mL(s=0,e={}){let t={},i=(n,o)=>{let a=n.props._offset,l=n.id,u=n.parent&&n.parent.id,c;if(u&&!(u in e)&&i(n.parent,!1),u in t){let h=t[u]=t[u]||mL(e[u],e);c=h(n,o),t[l]=h}else Number.isFinite(a)?(c=a+(e[u]||0),t[l]=null):c=s;return o&&c>=s&&(s=c+1),e[l]=c,c};return i}function e5(s,{moduleParameters:e,target:t,viewport:i}){let n=t&&t.id!=="default-framebuffer",o=e&&e.devicePixelRatio||no(s),a=n?t.height:s.drawingBufferHeight,l=i;return[l.x*o,a-(l.y+l.height)*o,l.width*o,l.height*o]}function t5(s){let e=s.drawingBufferWidth,t=s.drawingBufferHeight;Ti(s,{viewport:[0,0,e,t]}),s.clear(16640)}var ub=class extends es{constructor(e,t){super(e,t);y(this,"shadowMap",void 0),y(this,"depthBuffer",void 0),y(this,"fbo",void 0),this.shadowMap=new Je(e,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new $i(e,{format:33189,width:1,height:1}),this.fbo=new ze(e,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(e){let t=this.fbo;yt(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{let i=e.viewports[0],n=no(this.gl),o=i.width*n,a=i.height*n;(o!==t.width||a!==t.height)&&t.resize({width:o,height:a}),super.render({...e,target:t,pass:"shadow"})})}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}};var r5={color:[255,255,255],intensity:1},bL=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],i5=[0,0,0,200/255],Zf=class{constructor(e={}){y(this,"id","lighting-effect"),y(this,"props",null),y(this,"shadowColor",i5),y(this,"shadow",void 0),y(this,"ambientLight",null),y(this,"directionalLights",[]),y(this,"pointLights",[]),y(this,"shadowPasses",[]),y(this,"shadowMaps",[]),y(this,"dummyShadowMap",null),y(this,"programManager",void 0),y(this,"shadowMatrices",void 0);for(let t in e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break;default:}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(e),this.programManager||(this.programManager=Cn.getDefaultProgramManager(e),Kf&&this.programManager.addDefaultModule(Kf)),this.dummyShadowMap||(this.dummyShadowMap=new Je(e,{width:1,height:1}));for(let l=0;l<this.shadowPasses.length;l++)this.shadowPasses[l].render({layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a,moduleParameters:{shadowLightId:l,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){let t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:e})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:e}))},t}cleanup(){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(Kf),this.programManager=null)}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new mt().lookAt({eye:new ee(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new ub(e);this.shadowPasses[t]=i,this.shadowMaps[t]=i.shadowMap}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new yx(r5),this.directionalLights.push(new ab(bL[0]),new ab(bL[1])))}};var PL=class{constructor(e={}){y(this,"_pool",[]),y(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:n,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=n||e&&e.constructor||Float32Array,h=t*i+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d=1/0;u&&(d=u*i+o);let f=this._allocate(c,h,l,d);return e&&a?f.set(e):l||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,i,n){let o=Math.max(Math.ceil(t*this.opts.overAlloc),1);o>n&&(o=n);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return i&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:n}=i,o=t.findIndex(a=>a.byteLength>=n);o<0?t.push(i):(o>0||t.length<this.opts.poolSize)&&t.splice(o,0,i),t.length>this.opts.poolSize&&t.shift()}},po=new PL;function Ch(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function SL(s,e){let t=s%e;return t<0?e+t:t}function EL(s){return[s[12],s[13],s[14]]}function xL(s){return{left:xh(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:xh(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:xh(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:xh(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:xh(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:xh(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var yL=new ee;function xh(s,e,t,i){yL.set(s,e,t);let n=yL.len();return{distance:i/n,normal:new ee(-s/n,-e/n,-t/n)}}function n5(s){return s-Math.fround(s)}var Qf;function cb(s,e){let{size:t=1,startIndex:i=0}=e,n=e.endIndex!==void 0?e.endIndex:s.length,o=(n-i)/t;Qf=po.allocate(Qf,o,{type:Float32Array,size:t*2});let a=i,l=0;for(;a<n;){for(let u=0;u<t;u++){let c=s[a++];Qf[l+u]=c,Qf[l+u+t]=n5(c)}l+=t*2}return Qf.subarray(0,o*t*2)}var o5=Math.PI/180,s5=Ch(),CL=[0,0,0],a5={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function l5({width:s,height:e,orthographic:t,fovyRadians:i,focalDistance:n,padding:o,near:a,far:l}){let u=s/e,c=t?new mt().orthographic({fovy:i,aspect:u,focalDistance:n,near:a,far:l}):new mt().perspective({fovy:i,aspect:u,near:a,far:l});if(o){let{left:h=0,right:d=0,top:f=0,bottom:p=0}=o,S=Dt((h+s-d)/2,0,s)-s/2,x=Dt((f+e-p)/2,0,e)-e/2;c[8]-=S*2/s,c[9]+=x*2/e}return c}var Li=class{constructor(e={}){y(this,"id",void 0),y(this,"x",void 0),y(this,"y",void 0),y(this,"width",void 0),y(this,"height",void 0),y(this,"isGeospatial",void 0),y(this,"zoom",void 0),y(this,"focalDistance",void 0),y(this,"position",void 0),y(this,"modelMatrix",void 0),y(this,"distanceScales",void 0),y(this,"scale",void 0),y(this,"center",void 0),y(this,"cameraPosition",void 0),y(this,"projectionMatrix",void 0),y(this,"viewMatrix",void 0),y(this,"viewMatrixUncentered",void 0),y(this,"viewMatrixInverse",void 0),y(this,"viewProjectionMatrix",void 0),y(this,"pixelProjectionMatrix",void 0),y(this,"pixelUnprojectionMatrix",void 0),y(this,"resolution",void 0),y(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.distanceScales=e.distanceScales||a5,this.focalDistance=e.focalDistance||1,this.position=e.position||CL,this.modelMatrix=e.modelMatrix||null;let{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?ai.WEB_MERCATOR:ai.WEB_MERCATOR_AUTO_OFFSET:ai.IDENTITY}equals(e){return e instanceof Li?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Fr(e.projectionMatrix,this.projectionMatrix)&&Fr(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let i=this.projectPosition(e),n=Eh(i,this.pixelProjectionMatrix),[o,a]=n,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,n[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,u=i&&i*this.distanceScales.unitsPerMeter[2],c=$o([n,l,a],this.pixelUnprojectionMatrix,u),[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i]=this.projectFlat(e),n=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,n]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e),n=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,n]}projectFlat(e){if(this.isGeospatial){let t=Tn(e);return t[1]=Dt(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?tn(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],o[0],a[0]),Math.min(i[1],n[1],o[1],a[1]),Math.max(i[0],n[0],o[0],a[0]),Math.max(i[1],n[1],o[1],a[1])]}getDistanceScales(e){return e?Sh({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,xL(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=bx({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Sh({latitude:i,longitude:t}));let n=Math.pow(2,this.zoom);this.scale=n;let{position:o,modelMatrix:a}=e,l=CL;if(o&&(l=a?new mt(a).transformAsVector(o,[]):o),this.isGeospatial){let u=this.projectPosition([t,i,0]);this.center=new ee(l).scale(this.distanceScales.unitsPerMeter).add(u)}else this.center=this.projectPosition(l)}_initMatrices(e){let{viewMatrix:t=s5,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:o,fovy:a=75,near:l=.1,far:u=1e3,padding:c=null,focalDistance:h=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new mt().multiplyRight(t).translate(new ee(this.center).negate()),this.projectionMatrix=i||l5({width:this.width,height:this.height,orthographic:n,fovyRadians:o||a*o5,focalDistance:h,padding:c,near:l,far:u});let d=Ch();Jo(d,d,this.projectionMatrix),Jo(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=zf([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=EL(this.viewMatrixInverse);let f=Ch(),p=Ch();dh(f,f,[this.width/2,-this.height/2,1]),Su(f,f,[1,-1,0]),Jo(p,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=p,this.pixelUnprojectionMatrix=zf(Ch(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ce.warn("Pixel project matrix not invertible")()}};y(Li,"displayName","Viewport");var u5=512,c5=4003e4,h5=Math.PI/180;function vL(s){let e=Math.cos(s*h5);return u5/c5/e}var kr=class extends Li{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,legacyMeterSizes:p=!1}=e,{width:S,height:x,altitude:T=1.5}=e,O=Math.pow(2,n);S=S||1,x=x||1;let M,R=null;h?(T=h[5]/2,M=Cu(T)):(e.fovy?(M=e.fovy,T=Xf(M)):M=Cu(T),R=Px({width:S,height:x,pitch:o,fovy:M,nearZMultiplier:l,farZMultiplier:u}));let N=ob({height:x,pitch:o,bearing:a,scale:O,altitude:T});f&&(N=new mt().translate([512*f,0,0]).multiplyLeft(N));super({...e,width:S,height:x,viewMatrix:N,longitude:i,latitude:t,zoom:n,...R,fovy:M,focalDistance:T});y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"pitch",void 0),y(this,"bearing",void 0),y(this,"altitude",void 0),y(this,"fovy",void 0),y(this,"orthographic",void 0),y(this,"_subViewports",void 0),y(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=o,this.bearing=a,this.altitude=T,this.fovy=M,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=p,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let n=t;n<=i;n++){let o=n?new kr({...this,worldOffset:n}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e),n=(e[2]||0)*vL(e[1]);return[t,i,n]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),n=(e[2]||0)/vL(i);return[t,i,n]}addMetersToLngLat(e,t){return qf(e,t)}panByPosition(e,t){let i=$o(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=sh([],n,Gm([],i)),a=sh([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=Yf(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:n}=this,{longitude:o,latitude:a,zoom:l}=vu({width:i,height:n,bounds:e,...t});return new kr({width:i,height:n,longitude:o,latitude:a,zoom:l})}};y(kr,"displayName","WebMercatorViewport");function Sx(s,e,t=!1){let i=e.projectPosition(s);if(t&&e instanceof kr){let[n,o,a=0]=s,l=e.getDistanceScales([n,o]);i[2]=a*l.unitsPerMeter[2]}return i}function d5(s){let{viewport:e,modelMatrix:t,coordinateOrigin:i}=s,{coordinateSystem:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return n===Ve.DEFAULT&&(n=e.isGeospatial?Ve.LNGLAT:Ve.CARTESIAN),o===void 0&&(o=n),a===void 0&&(a=i),{viewport:e,coordinateSystem:n,coordinateOrigin:i,modelMatrix:t,fromCoordinateSystem:o,fromCoordinateOrigin:a}}function Ex(s,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:n,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=lo([],[a,l,u,1],t)),i){case Ve.LNGLAT:return Sx([a,l,u],e,o);case Ve.LNGLAT_OFFSETS:return Sx([a+n[0],l+n[1],u+(n[2]||0)],e,o);case Ve.METER_OFFSETS:return Sx(qf(n,[a,l,u]),e,o);case Ve.CARTESIAN:default:return e.isGeospatial?[a+n[0],l+n[1],u+n[2]]:e.projectPosition([a,l,u])}}function AL(s,e){let{viewport:t,coordinateSystem:i,coordinateOrigin:n,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=d5(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=hx(t,i,n),d=Ex(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let f=t.projectPosition(u||c);Hm(d,d,f)}return d}var Ya={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},vh=Symbol.for("component"),Vs=Symbol.for("asyncPropDefaults"),ts=Symbol.for("asyncPropOriginal"),go=Symbol.for("asyncPropResolved");function ks(s,e=()=>!0){return Array.isArray(s)?TL(s,e,[]):e(s)?[s]:[]}function TL(s,e,t){let i=-1;for(;++i<s.length;){let n=s[i];Array.isArray(n)?TL(n,e,t):e(n)&&t.push(n)}return t}function xx({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var hb=class{constructor(e,t,i){y(this,"id",void 0),y(this,"context",void 0),y(this,"isLoaded",void 0),y(this,"persistent",void 0),y(this,"_loadCount",0),y(this,"_subscribers",new Set),y(this,"_data",void 0),y(this,"_loader",void 0),y(this,"_error",void 0),y(this,"_content",void 0),this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,n=e;typeof e=="string"&&(n=Ko(e)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=o)}).catch(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=o||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(let o of this._subscribers)o.onChange(this.getData())}};var db=class{constructor({gl:e,protocol:t}){y(this,"protocol",void 0),y(this,"_context",void 0),y(this,"_resources",void 0),y(this,"_consumers",void 0),y(this,"_pruneRequest",void 0),this.protocol=t||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:n=!0}){let o=this._resources[e];o?o.setData(t,i):(o=new hb(e,t,this._context),this._resources[e]=o),o.persistent=n}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let i in t){let n=t[i],o=this._resources[n.resourceId];o&&o.unsubscribe(n)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:n="default"}){let{_resources:o,protocol:a}=this;e.startsWith(a)&&(e=e.replace(a,""),o[e]||this.add({resourceId:e,data:null,persistent:!1}));let l=o[e];if(this._track(i,n,l,t),l)return l.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,n){let o=this._consumers,a=o[e]=o[e]||{},l=a[t]||{},u=l.resourceId&&this._resources[l.resourceId];u&&(u.unsubscribe(l),this.prune()),i&&(a[t]=l,l.onChange=n,l.resourceId=i.id,i.subscribe(l))}_prune(){this._pruneRequest=null;for(let e of Object.keys(this._resources)){let t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}};var f5="layerManager.setLayers",p5="layerManager.activateViewport",fb=class{constructor(e,{deck:t,stats:i,viewport:n,timeline:o}={}){y(this,"layers",void 0),y(this,"context",void 0),y(this,"resourceManager",void 0),y(this,"_lastRenderedLayers",[]),y(this,"_needsRedraw",!1),y(this,"_needsUpdate",!1),y(this,"_nextLayers",null),y(this,"_debug",!1),y(this,"activateViewport",a=>{kt(p5,this,a),a&&(this.context.viewport=a)}),this.layers=[],this.resourceManager=new db({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:t,programManager:e&&gL(e),stats:i||new yn({id:"deck.gl"}),viewport:n||new Li({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Eu,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(let e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(let i of this.layers){let n=i.getNeedsRedraw(e);t=t||n}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){kt(f5,this,t,e),this._lastRenderedLayers=e;let i=ks(e,Boolean);for(let n of i)n.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,t,i){i.raiseError(t,"".concat(e," of ").concat(i))}_updateLayers(e,t){let i={};for(let a of e)i[a.id]?ce.warn("Multiple old layers with same id ".concat(a.id))():i[a.id]=a;let n=[];this._updateSublayersRecursively(t,i,n),this._finalizeOldLayers(i);let o=!1;for(let a of n)if(a.hasUniformTransition()){o="Uniform transition in ".concat(a);break}this._needsUpdate=o,this.layers=n}_updateSublayersRecursively(e,t,i){for(let n of e){n.context=this.context;let o=t[n.id];o===null&&ce.warn("Multiple new layers with same id ".concat(n.id))(),t[n.id]=null;let a=null;try{this._debug&&o!==n&&n.validateProps(),o?(this._transferLayerState(o,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),a=n.isComposite?n.getSubLayers():null}catch(l){this._handleError("matching",l,n)}a&&this._updateSublayersRecursively(a,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Ya.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Ya.MATCHED,t!==e&&(e.lifecycle=Ya.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=Ya.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Ya.FINALIZED}catch(t){this._handleError("finalization",t,e)}}};function rn(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let i=s[t],n=e[t];if(!(i===n||Array.isArray(i)&&Array.isArray(n)&&rn(i,n)))return!1}return!0}var pb=class{constructor(e){y(this,"width",void 0),y(this,"height",void 0),y(this,"views",void 0),y(this,"viewState",void 0),y(this,"controllers",void 0),y(this,"timeline",void 0),y(this,"_viewports",void 0),y(this,"_viewportMap",void 0),y(this,"_isUpdating",void 0),y(this,"_needsRedraw",void 0),y(this,"_needsUpdate",void 0),y(this,"_eventManager",void 0),y(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),n={x:e[0],y:e[1]};for(let o=i.length-1;o>=0;--o){let a=i[o];if(a.containsPixel(n)){let l=e.slice();return l[0]-=a.x,l[1]-=a.y,a.unproject(l,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=ks(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!rn(e,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):ce.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,t){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...t,viewId:e})}_createController(e,t){let i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,t.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:o=>e.makeViewport({viewState:o,width:this.width,height:this.height})})}_updateController(e,t,i,n){let o=e.controller;if(o){let a={...t,...o,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return n||(n=this._createController(e,a)),n&&n.setProps(a),n}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=e.length;n--;){let o=e[n],a=this.getViewState(o),l=o.makeViewport({viewState:a,width:this.width,height:this.height}),u=t[o.id],c=Boolean(o.controller);c&&!u&&(i=!0),(i||!c)&&u&&(u.finalize(),u=null),this.controllers[o.id]=this._updateController(o,a,l,u),this._viewports.unshift(l)}for(let n in t){let o=t[n];o&&!this.controllers[n]&&o.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,n)=>!e[n].equals(t[n]))}};var g5=/([0-9]+\.?[0-9]*)(%|px)/;function zs(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":let e=g5.exec(s);if(e&&e.length>=3){let t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error("Could not parse position string ".concat(s))}}function Us(s,e){return s.relative?Math.round(s.position*e):s.position}function St(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}var Ah=class{constructor(e){y(this,"id",void 0),y(this,"viewportInstance",void 0),y(this,"_x",void 0),y(this,"_y",void 0),y(this,"_width",void 0),y(this,"_height",void 0),y(this,"_padding",void 0),y(this,"props",void 0);let{id:t,x:i=0,y:n=0,width:o="100%",height:a="100%",padding:l=null,viewportInstance:u}=e||{};St(!u||u instanceof Li),this.viewportInstance=u,this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=zs(i),this._y=zs(n),this._width=zs(o),this._height=zs(a),this._padding=l&&{left:zs(l.left||0),right:zs(l.right||0),top:zs(l.top||0),bottom:zs(l.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.viewportInstance?e.viewportInstance?this.viewportInstance.equals(e.viewportInstance):!1:this.ViewportType===e.ViewportType&&rn(this.props,e.props)}makeViewport({width:e,height:t,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);let n=this.getDimensions({width:e,height:t});return new this.ViewportType({...i,...this.props,...n})}getViewStateId(){let{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){let i={x:Us(this._x,e),y:Us(this._y,t),width:Us(this._width,e),height:Us(this._height,t)};return this._padding&&(i.padding={left:Us(this._padding.left,e),top:Us(this._padding.top,t),right:Us(this._padding.right,e),bottom:Us(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}};var wn=class{constructor(e){y(this,"_inProgress",void 0),y(this,"_handle",void 0),y(this,"_timeline",void 0),y(this,"time",void 0),y(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,(t=(i=this.settings).onStart)===null||t===void 0||t.call(i,this)}end(){if(this._inProgress){var e,t;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(t=this.settings).onEnd)===null||e===void 0||e.call(t,this)}}cancel(){if(this._inProgress){var e,t;(e=(t=this.settings).onInterrupt)===null||e===void 0||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:i,settings:n}=this;this._handle=i.addChannel({delay:i.getTime(),duration:n.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(t=this.settings).onUpdate)===null||e===void 0||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var IL=()=>{},Cx={BREAK:1,SNAP_TO_END:2,IGNORE:3},m5=s=>s,b5=Cx.BREAK,gb=class{constructor(e){y(this,"getControllerState",void 0),y(this,"props",void 0),y(this,"propsInTransition",void 0),y(this,"transition",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"_onTransitionUpdate",t=>{let{time:i,settings:{interpolator:n,startProps:o,endProps:a,duration:l,easing:u}}=t,c=u(i/l),h=n.interpolateProps(o,a,c);this.propsInTransition=this.getControllerState({...this.props,...h}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new wn(e.timeline),this.onViewStateChange=e.onViewStateChange||IL,this.onStateChange=e.onStateChange||IL}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let n=i;if(this.transition.inProgress){let{interruption:o,endProps:a}=this.transition.settings;n={...i,...o===Cx.SNAP_TO_END?a:this.propsInTransition||i}}this._triggerTransition(n,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&Boolean(i)}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===Cx.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){let i=this.getControllerState(e),n=this.getControllerState(t).shortestPathFrom(i),o=t.transitionInterpolator,a=o.getDuration?o.getDuration(e,t):t.transitionDuration;if(a===0)return;let l=o.initializeProps(e,n);this.propsInTransition={};let u={duration:a,easing:t.transitionEasing||m5,interpolator:o,interruption:t.transitionInterruption||b5,startProps:l.start,endProps:l.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(u),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}};var mb=class{constructor(e){y(this,"_propsToCompare",void 0),y(this,"_propsToExtract",void 0),y(this,"_requiredProps",void 0);let{compare:t,extract:i,required:n}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=n}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!Fr(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},n={};for(let o of this._propsToExtract)(o in e||o in t)&&(i[o]=e[o],n[o]=t[o]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){!this._requiredProps||this._requiredProps.forEach(t=>{let i=e[t];St(Number.isFinite(i)||Array.isArray(i),"".concat(t," is required for transition"))})}};var P5=["longitude","latitude","zoom","bearing","pitch"],y5=["longitude","latitude","zoom"],mo=class extends mb{constructor(e={}){let t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:P5,required:y5};super(i.transitionProps);y(this,"opts",void 0),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:n,around:o}=this.opts;if(n&&o){let a=n(e),l=n(t),u=a.unproject(o);i.start.around=o,Object.assign(i.end,{around:l.project(u),aroundPosition:u,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let n={};for(let o of this._propsToExtract)n[o]=yu(e[o]||0,t[o]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let o=this.opts.makeViewport({...t,...n});Object.assign(n,o.panByPosition(t.aroundPosition,yu(e.around,t.around,i)))}return n}};var Ka={transitionDuration:0},S5=300,bb=s=>1-(1-s)*(1-s),Th={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},Au={},Ih=class{constructor(e){y(this,"props",void 0),y(this,"state",{}),y(this,"transitionManager",void 0),y(this,"eventManager",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"makeViewport",void 0),y(this,"_controllerState",void 0),y(this,"_events",{}),y(this,"_interactionState",{isDragging:!1}),y(this,"_customEvents",[]),y(this,"_eventStartBlocked",null),y(this,"_panMove",!1),y(this,"invertPan",!1),y(this,"dragMode","rotate"),y(this,"inertia",0),y(this,"scrollZoom",!0),y(this,"dragPan",!0),y(this,"dragRotate",!0),y(this,"doubleClickZoom",!0),y(this,"touchZoom",!0),y(this,"touchRotate",!1),y(this,"keyboard",!0),this.transitionManager=new gb({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let t in this._events)if(this._events[t]){var e;(e=this.eventManager)===null||e===void 0||e.off(t,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return t?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:n}=e;return[n.x-t,n.y-i]}isPointInBounds(e,t){let{width:i,height:n}=this.props;if(t&&t.handled)return!1;let o=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=n;return o&&t&&t.stopPropagation(),o}isFunctionKeyPressed(e){let{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?S5:0;let{scrollZoom:i=!0,dragPan:n=!0,dragRotate:o=!0,doubleClickZoom:a=!0,touchZoom:l=!0,touchRotate:u=!1,keyboard:c=!0}=e,h=Boolean(this.onViewStateChange);this.toggleEvents(Th.WHEEL,h&&i),this.toggleEvents(Th.PAN,h&&(n||o)),this.toggleEvents(Th.PINCH,h&&(l||u)),this.toggleEvents(Th.TRIPLE_PAN,h&&u),this.toggleEvents(Th.DOUBLE_TAP,h&&a),this.toggleEvents(Th.KEYBOARD,h&&c),this.scrollZoom=i,this.dragPan=n,this.dragRotate=o,this.doubleClickZoom=a,this.touchZoom=l,this.touchRotate=u,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){let n={...e.getViewportProps(),...t},o=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),o){let a=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:a})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);let n=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(n,Ka,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,Ka,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.pan({pos:n}).panEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:bb},{isDragging:!1,isPanning:!0})}else{let i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,Ka,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.rotate({pos:n}).rotateEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:bb},{isDragging:!1,isRotating:!0})}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;e.srcEvent.preventDefault();let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let{speed:i=.01,smooth:n=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:o}=e,a=2/(1+Math.exp(-Math.abs(o*i)));o<0&&a!==0&&(a=1/a);let l=this.controllerState.zoom({pos:t,scale:a});return this.updateViewport(l,{...this._getTransitionProps({around:t}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,Ka,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,Ka,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),n=[i[0],i[1]+=e.velocityY*t/2],o=this.controllerState.rotate({pos:n});this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:bb},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Au._startPinchRotation=e.rotation,Au._lastPinchEvent=e,this.updateViewport(i,Ka,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,n=this.getCenter(e);t=t.zoom({pos:n,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:Au._startPinchRotation-i})}return this.updateViewport(t,Ka,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Au._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=Au;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let n=this.getCenter(e),o=this.controllerState.rotateEnd(),a=Math.log2(e.scale),l=(a-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),u=Math.pow(2,a+l*t/2);o=o.zoom({pos:n,scale:u}).zoomEnd(),this.updateViewport(o,{...this._getTransitionProps({around:n}),transitionDuration:t,transitionEasing:bb},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let n=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Au._startPinchRotation=null,Au._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),n=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;let t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:o,rotateSpeedY:a}=this.keyboard===!0?{}:this.keyboard,{controllerState:l}=this,u,c={};switch(e.srcEvent.code){case"Minus":u=t?l.zoomOut(i).zoomOut(i):l.zoomOut(i),c.isZooming=!0;break;case"Equal":u=t?l.zoomIn(i).zoomIn(i):l.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":t?(u=l.rotateLeft(o),c.isRotating=!0):(u=l.moveLeft(n),c.isPanning=!0);break;case"ArrowRight":t?(u=l.rotateRight(o),c.isRotating=!0):(u=l.moveRight(n),c.isPanning=!0);break;case"ArrowUp":t?(u=l.rotateUp(a),c.isRotating=!0):(u=l.moveUp(n),c.isPanning=!0);break;case"ArrowDown":t?(u=l.rotateDown(a),c.isRotating=!0):(u=l.moveDown(n),c.isPanning=!0);break;default:return!1}return this.updateViewport(u,this._getTransitionProps(),c),!0}_getTransitionProps(e){let{transition:t}=this;return!t||!t.transitionInterpolator?Ka:e?{...t,transitionInterpolator:new mo({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}};var wh=class{constructor(e,t){y(this,"_viewportProps",void 0),y(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}};var wL=5,E5=1.2,LL=class extends wh{constructor(e){let{width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l=0,pitch:u=0,altitude:c=1.5,position:h=[0,0,0],maxZoom:d=20,minZoom:f=0,maxPitch:p=60,minPitch:S=0,startPanLngLat:x,startZoomLngLat:T,startRotatePos:O,startBearing:M,startPitch:R,startZoom:N,normalize:H=!0}=e;St(Number.isFinite(o)),St(Number.isFinite(n)),St(Number.isFinite(a));super({width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l,pitch:u,altitude:c,maxZoom:d,minZoom:f,maxPitch:p,minPitch:S,normalize:H,position:h},{startPanLngLat:x,startZoomLngLat:T,startRotatePos:O,startBearing:M,startPitch:R,startZoom:N});y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startBearing:o,startPitch:a}=this.getState();if(!n||o===void 0||a===void 0)return this;let l;return e?l=this._getNewRotation(e,n,a,o):l={bearing:o+t,pitch:a+i},this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomLngLat:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let{maxZoom:a,minZoom:l}=this.getViewportProps(),u=n+Math.log2(i);u=Dt(u,l,a);let c=this.makeViewport({...this.getViewportProps(),zoom:u});return this._getUpdatedState({zoom:u,...c.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:o}=i;return Math.abs(n-t.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(o-t.longitude)>180&&(i.longitude=o<0?o+360:o-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n}=e;e.zoom=Dt(n,i,t);let{maxPitch:o,minPitch:a,pitch:l}=e;e.pitch=Dt(l,a,o);let{normalize:u=!0}=e;return u&&Object.assign(e,sb(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,n){let o=e[0]-t[0],a=e[1]-t[1],l=e[1],u=t[1],{width:c,height:h}=this.getViewportProps(),d=o/c,f=0;a>0?Math.abs(h-u)>wL&&(f=a/(u-h)*E5):a<0&&u>wL&&(f=1-l/u),f=Dt(f,-1,1);let{minPitch:p,maxPitch:S}=this.getViewportProps(),x=n+180*d,T=i;return f>0?T=i+f*(S-i):f<0&&(T=i-f*(p-i)),{pitch:T,bearing:x}}},Pb=class extends Ih{constructor(...e){super(...e);y(this,"ControllerState",LL),y(this,"transition",{transitionDuration:300,transitionInterpolator:new mo({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),y(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}};var Jf=class extends Ah{get ViewportType(){return kr}get ControllerType(){return Pb}};y(Jf,"displayName","MapView");var yb=class extends es{constructor(e,t){super(e,t);y(this,"maskMap",void 0),y(this,"fbo",void 0);let{mapSize:i=2048}=t;this.maskMap=new Je(e,{width:i,height:i,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new ze(e,{id:"maskmap",width:i,height:i,attachments:{[36064]:this.maskMap}})}render(e){let t=this.gl,i=[!1,!1,!1,!1];return i[e.channel]=!0,yt(t,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:i,depthTest:!1},()=>super.render({...e,target:this.fbo,pass:"mask"}))}shouldDrawLayer(e){return e.props.operation===uo.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}};var x5=new mt().lookAt({eye:[0,0,1]});function C5({width:s,height:e,near:t,far:i,padding:n}){let o=-s/2,a=s/2,l=-e/2,u=e/2;if(n){let{left:c=0,right:h=0,top:d=0,bottom:f=0}=n,p=Dt((c+s-h)/2,0,s)-s/2,S=Dt((d+e-f)/2,0,e)-e/2;o-=p,a-=p,l+=S,u+=S}return new mt().ortho({left:o,right:a,bottom:l,top:u,near:t,far:i})}var Sb=class extends Li{constructor(e){let{width:t,height:i,near:n=.1,far:o=1e3,zoom:a=0,target:l=[0,0,0],padding:u=null,flipY:c=!0}=e,h=Array.isArray(a)?a[0]:a,d=Array.isArray(a)?a[1]:a,f=Math.min(h,d),p=Math.pow(2,f),S;if(h!==d){let x=Math.pow(2,h),T=Math.pow(2,d);S={unitsPerMeter:[x/p,T/p,1],metersPerUnit:[p/x,p/T,1]}}super({...e,longitude:void 0,position:l,viewMatrix:x5.clone().scale([p,p*(c?-1:1),p]),projectionMatrix:C5({width:t||1,height:i||1,padding:u,near:n,far:o}),zoom:f,distanceScales:S})}projectFlat([e,t]){let{unitsPerMeter:i}=this.distanceScales;return[e*i[0],t*i[1]]}unprojectFlat([e,t]){let{metersPerUnit:i}=this.distanceScales;return[e*i[0],t*i[1]]}panByPosition(e,t){let i=$o(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=sh([],n,Gm([],i)),a=sh([],this.center,o);return{target:this.unprojectFlat(a)}}};var vx=class extends wh{constructor(e){let{width:t,height:i,rotationX:n=0,rotationOrbit:o=0,target:a=[0,0,0],zoom:l=0,minRotationX:u=-90,maxRotationX:c=90,minZoom:h=-1/0,maxZoom:d=1/0,startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:x,startZoomPosition:T,startZoom:O}=e;super({width:t,height:i,rotationX:n,rotationOrbit:o,target:a,zoom:l,minRotationX:u,maxRotationX:c,minZoom:h,maxZoom:d},{startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:x,startZoomPosition:T,startZoom:O});y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:t}){let i=this.getState().startPanPosition||t;if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startRotationX:o,startRotationOrbit:a}=this.getState(),{width:l,height:u}=this.getViewportProps();if(!n||o===void 0||a===void 0)return this;let c;if(e){let h=(e[0]-n[0])/l,d=(e[1]-n[1])/u;(o<-90||o>90)&&(h*=-1),c={rotationX:o+d*180,rotationOrbit:a+h*180}}else c={rotationX:o+i,rotationOrbit:a+t};return this._getUpdatedState(c)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:n}=i;return Math.abs(n-t.rotationOrbit)>180&&(i.rotationOrbit=n<0?n+360:n-360),i}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomPosition:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let a=this._calculateNewZoom({scale:i,startZoom:n}),l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=t+Math.log2(e);return Dt(o,n,i)}_panFromCenter(e){let{width:t,height:i,target:n}=this.getViewportProps();return this.pan({startPosition:n,pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n,maxRotationX:o,minRotationX:a,rotationOrbit:l}=e;return e.zoom=Array.isArray(n)?[Dt(n[0],i,t),Dt(n[1],i,t)]:Dt(n,i,t),e.rotationX=Dt(e.rotationX,a,o),(l<-180||l>180)&&(e.rotationOrbit=SL(l+180,360)-180),e}};var OL=class extends vx{constructor(e){super(e);y(this,"zoomAxis",void 0),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=Math.log2(e);if(Array.isArray(t)){let[a,l]=t;switch(this.zoomAxis){case"X":a=Dt(a+o,n,i);break;case"Y":l=Dt(l+o,n,i);break;default:let u=Math.min(a+o,l+o);u<n&&(o+=n-u),u=Math.max(a+o,l+o),u>i&&(o+=i-u),a+=o,l+=o}return[a,l]}return Dt(t+o,n,i)}},Eb=class extends Ih{constructor(...e){super(...e);y(this,"ControllerState",OL),y(this,"transition",{transitionDuration:300,transitionInterpolator:new mo(["target","zoom"])}),y(this,"dragMode","pan")}_onPanRotate(){return!1}};var Za=class extends Ah{get ViewportType(){return Sb}get ControllerType(){return Eb}};y(Za,"displayName","OrthographicView");function RL({layers:s,viewport:e}){let t=null;for(let o of s){let a=o.getBounds();a&&(t?(t[0]=Math.min(t[0],a[0][0]),t[1]=Math.min(t[1],a[0][1]),t[2]=Math.max(t[2],a[1][0]),t[3]=Math.max(t[3],a[1][1])):t=[a[0][0],a[0][1],a[1][0],a[1][1]])}let i=e.getBounds();if(!t)return i;let n=v5(i);return t[2]-t[0]<n[2]-n[0]||t[3]-t[1]<n[3]-n[1]||(t[0]=Math.max(t[0],n[0]),t[1]=Math.max(t[1],n[1]),t[2]=Math.min(t[2],n[2]),t[3]=Math.min(t[3],n[3])),t}function _L({bounds:s,viewport:e,width:t,height:i}){if(s[2]<=s[0]||s[3]<=s[1])return null;let n=1;if(t-=n*2,i-=n*2,e instanceof kr){let{longitude:l,latitude:u,zoom:c}=vu({width:t,height:i,bounds:[[s[0],s[1]],[s[2],s[3]]],maxZoom:20});return new kr({longitude:l,latitude:u,zoom:c,x:n,y:n,width:t,height:i})}let o=[(s[0]+s[2])/2,(s[1]+s[3])/2,0],a=Math.min(20,t/(s[2]-s[0]),i/(s[3]-s[1]));return new Za({x:n,y:n}).makeViewport({width:t,height:i,viewState:{target:o,zoom:Math.log2(a)}})}function v5(s){let e={x:s[2]-s[0],y:s[3]-s[1]},t={x:s[0]+.5*e.x,y:s[1]+.5*e.y};return[t.x-e.x,t.y-e.y,t.x+e.x,t.y+e.y]}var xb=class{constructor(){y(this,"id","mask-effect"),y(this,"props",null),y(this,"useInPicking",!0),y(this,"dummyMaskMap",void 0),y(this,"channels",[]),y(this,"masks",null),y(this,"maskPass",void 0),y(this,"maskMap",void 0),y(this,"lastViewport",void 0)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){this.dummyMaskMap||(this.dummyMaskMap=new Je(e,{width:1,height:1}));let l=t.filter(d=>d.props.visible&&d.props.operation===uo.MASK);if(l.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new yb(e,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);let u=this._sortMaskChannels(l),c=n[0],h=!this.lastViewport||!this.lastViewport.equals(c);for(let d in u)this._renderChannel(u[d],{layerFilter:i,onViewportActive:o,views:a,viewport:c,viewportChanged:h})}_renderChannel(e,{layerFilter:t,onViewportActive:i,views:n,viewport:o,viewportChanged:a}){let l=this.channels[e.index];if(!l)return;let u=e===l||l.layers.length!==e.layers.length||e.layerBounds.some((c,h)=>c!==l.layerBounds[h]);if(e.bounds=l.bounds,e.maskBounds=l.maskBounds,this.channels[e.index]=e,(u||a)&&(this.lastViewport=o,e.bounds=RL({layers:e.layers,viewport:o}),u||!Fr(e.bounds,l.bounds))){let{maskPass:c,maskMap:h}=this,d=_L({bounds:e.bounds,viewport:o,width:h.width,height:h.height});e.maskBounds=d?d.getBounds():[0,0,1,1],c.render({pass:"mask",channel:e.index,layers:e.layers,layerFilter:t,viewports:d?[d]:[],onViewportActive:i,views:n,moduleParameters:{devicePixelRatio:1}})}this.masks[e.id]={index:e.index,bounds:e.maskBounds,coordinateOrigin:e.coordinateOrigin,coordinateSystem:e.coordinateSystem}}_sortMaskChannels(e){let t={},i=0;for(let n of e){let{id:o}=n.root,a=t[o];if(!a){if(++i>4){ce.warn("Too many mask layers. The max supported is 4")();continue}a={id:o,index:this.channels.findIndex(l=>l?.id===o),layers:[],layerBounds:[],coordinateOrigin:n.root.props.coordinateOrigin,coordinateSystem:n.root.props.coordinateSystem},t[o]=a}a.layers.push(n),a.layerBounds.push(n.getBounds())}for(let n=0;n<4;n++){let o=this.channels[n];(!o||!(o.id in t))&&(this.channels[n]=null)}for(let n in t){let o=t[n];o.index<0&&(o.index=this.channels.findIndex(a=>!a),this.channels[o.index]=o)}return t}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}};var A5=new Zf,Cb=class{constructor(){y(this,"effects",void 0),y(this,"_internalEffects",void 0),y(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(e){"effects"in e&&(e.effects.length!==this.effects.length||!rn(e.effects,this.effects))&&(this.setEffects(e.effects),this._needsRedraw="effects changed")}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(e=[]){this.cleanup(),this.effects=e,this._internalEffects=e.slice(),this._internalEffects.push(new xb),e.some(t=>t instanceof Zf)||this._internalEffects.push(A5)}cleanup(){for(let e of this.effects)e.cleanup();for(let e of this._internalEffects)e.cleanup();this.effects.length=0,this._internalEffects.length=0}};var vb=class extends es{shouldDrawLayer(e){return e.props.operation===uo.DRAW}};var ML={blendFunc:[1,0,32771,0],blendEquation:32774},Lh=class extends es{constructor(...e){super(...e);y(this,"pickZ",void 0),y(this,"_colors",null)}render(e){return e.pickingFBO?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,pickingFBO:a,deviceRect:{x:l,y:u,width:c,height:h},cullRect:d,effects:f,pass:p="picking",pickZ:S}){let x=this.gl;this.pickZ=S;let T=S?null:{byLayer:new Map,byAlpha:[]};this._colors=T;let O=yt(x,{scissorTest:!0,scissor:[l,u,c,h],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...ML,blend:!S},()=>super.render({target:a,layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,cullRect:d,effects:f?.filter(R=>R.useInPicking),pass:p}));return this._colors=null,{decodePickingColor:T&&I5.bind(null,T),stats:O}}shouldDrawLayer(e){return e.props.pickable&&e.props.operation===uo.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,t,i){let n={...e.props.parameters};return this._colors?(Object.assign(n,ML),n.blend=!0,n.blendColor=T5(this._colors,e,i)):n.blend=!1,n}};function T5(s,e,t){let{byLayer:i,byAlpha:n}=s,o,a=i.get(e);return a?(a.viewports.push(t),o=a.a):(o=i.size+1,o<=255?(a={a:o,layer:e,viewports:[t]},i.set(e,a),n[o]=a):(ce.warn("Too many pickable layers, only picking the first 255")(),o=0)),[0,0,0,o/255]}function I5(s,e){let t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}var w5="deckRenderer.renderLayers",Ab=class{constructor(e){this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new vb(e),this.pickLayersPass=new Lh(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){"layerFilter"in e&&this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in e&&this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;e.layerFilter=e.layerFilter||this.layerFilter,e.effects=e.effects||[],e.target=e.target||ze.getDefaultFramebuffer(this.gl),this._preRender(e.effects,e);let i=this.lastPostProcessEffect?this.renderBuffers[0]:e.target,n=t.render({...e,target:i});this._postRender(e.effects,e),this.renderCount++,kt(w5,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){let i=null;for(let n of e)n.preRender(this.gl,t),n.postRender&&(i=n);i&&this._resizeRenderBuffers(),this.lastPostProcessEffect=i}_resizeRenderBuffers(){let{renderBuffers:e}=this;e.length===0&&e.push(new ze(this.gl),new ze(this.gl));for(let t of e)t.resize()}_postRender(e,t){let{renderBuffers:i}=this,n={inputBuffer:i[0],swapBuffer:i[1],target:null};for(let o of e)if(o.postRender){if(o===this.lastPostProcessEffect){n.target=t.target,o.postRender(this.gl,n);break}let a=o.postRender(this.gl,n);n.inputBuffer=a,n.swapBuffer=a===i[0]?i[1]:i[0]}}};var L5={pickedColor:null,pickedObjectIndex:-1};function NL({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:n,deviceRect:o}){let{x:a,y:l,width:u,height:c}=o,h=n*n,d=-1,f=0;for(let p=0;p<c;p++){let S=p+l-i,x=S*S;if(x>h)f+=4*u;else for(let T=0;T<u;T++){if(s[f+3]-1>=0){let M=T+a-t,R=M*M+x;R<=h&&(h=R,d=f)}f+=4}}if(d>=0){let p=s.slice(d,d+4),S=e(p);if(S){let x=Math.floor(d/4/u),T=d/4-x*u;return{...S,pickedColor:p,pickedX:a+T,pickedY:l+x}}ce.error("Picked non-existent layer. Is picking buffer corrupt?")()}return L5}function BL({pickedColors:s,decodePickingColor:e}){let t=new Map;if(s){for(let i=0;i<s.length;i+=4)if(s[i+3]-1>=0){let o=s.slice(i,i+4),a=o.join(",");if(!t.has(a)){let l=e(o);l?t.set(a,{...l,color:o}):ce.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function Ax({pickInfo:s,viewports:e,pixelRatio:t,x:i,y:n,z:o}){let a=e[0];e.length>1&&(a=O5(s?.pickedViewports||e,{x:i,y:n}));let l;if(a){let u=[i-a.x,n-a.y];o!==void 0&&(u[2]=o),l=a.unproject(u)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:i,y:n,pixel:[i,n],coordinate:l,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function DL(s){let{pickInfo:e,lastPickedInfo:t,mode:i,layers:n}=s,{pickedColor:o,pickedLayer:a,pickedObjectIndex:l}=e,u=a?[a]:[];if(i==="hover"){let d=t.index,f=t.layerId,p=a?a.props.id:null;if(p!==f||l!==d){if(p!==f){let S=n.find(x=>x.props.id===f);S&&u.unshift(S)}t.layerId=p,t.index=l,t.info=null}}let c=Ax(s),h=new Map;return h.set(null,c),u.forEach(d=>{let f={...c};d===a&&(f.color=o,f.index=l,f.picked=!0),f=Tx({layer:d,info:f,mode:i});let p=f.layer;d===a&&i==="hover"&&(t.info=f),h.set(p.id,f),i==="hover"&&p.updateAutoHighlight(f)}),h}function Tx({layer:s,info:e,mode:t}){for(;s&&e;){let i=e.layer||null;e.sourceLayer=i,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:i}),s=s.parent}return e}function O5(s,e){for(let t=s.length-1;t>=0;t--){let i=s[t];if(i.containsPixel(e))return i}return s[0]}var Tb=class{constructor(e){y(this,"gl",void 0),y(this,"pickingFBO",void 0),y(this,"depthFBO",void 0),y(this,"pickLayersPass",void 0),y(this,"layerFilter",void 0),y(this,"lastPickedInfo",void 0),y(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new Lh(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:n},o=this.lastPickedInfo.info){let a=o&&o.layer&&o.layer.id,l=o&&o.viewport&&o.viewport.id,u=a?i.find(f=>f.id===a):null,c=l&&n.find(f=>f.id===l)||n[0],h=c&&c.unproject([e-c.x,t-c.y]);return{...o,...{x:e,y:t,viewport:c,coordinate:h,layer:u}}}_resizeBuffer(){var e,t;let{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new ze(i),ze.isSupported(i,{colorBufferFloat:!0}))){let n=new ze(i);n.attach({[36064]:new Je(i,{format:fe(i)?34836:6408,type:5126})}),this.depthFBO=n}(e=this.pickingFBO)===null||e===void 0||e.resize({width:i.canvas.width,height:i.canvas.height}),(t=this.depthFBO)===null||t===void 0||t.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;let t=e.filter(i=>i.isPickable()&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:n,y:o,radius:a=0,depth:l=1,mode:u="query",unproject3D:c,onViewportActive:h,effects:d}){let f=this._getPickable(e),p=no(this.gl);if(!f)return{result:[],emptyInfo:Ax({viewports:i,x:n,y:o,pixelRatio:p})};this._resizeBuffer();let S=qc(this.gl,[n,o],!0),x=[S.x+Math.floor(S.width/2),S.y+Math.floor(S.height/2)],T=Math.round(a*p),{width:O,height:M}=this.pickingFBO,R=this._getPickingRect({deviceX:x[0],deviceY:x[1],deviceRadius:T,deviceWidth:O,deviceHeight:M}),N={x:n-a,y:o-a,width:a*2+1,height:a*2+1},H,Q=[],ne=new Set;for(let he=0;he<l;he++){let se;if(R){let ge=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:R,cullRect:N,effects:d,pass:"picking:".concat(u)});se=NL({...ge,deviceX:x[0],deviceY:x[1],deviceRadius:T,deviceRect:R})}else se={pickedColor:null,pickedObjectIndex:-1};let oe;se.pickedLayer&&c&&this.depthFBO&&(oe=this._drawAndSample({layers:[se.pickedLayer],views:t,viewports:i,onViewportActive:h,deviceRect:{x:se.pickedX,y:se.pickedY,width:1,height:1},cullRect:N,effects:d,pass:"picking:".concat(u,":z")},!0).pickedColors[0]),se.pickedLayer&&he+1<l&&(ne.add(se.pickedLayer),se.pickedLayer.disablePickingIndex(se.pickedObjectIndex)),H=DL({pickInfo:se,lastPickedInfo:this.lastPickedInfo,mode:u,layers:f,viewports:i,x:n,y:o,z:oe,pixelRatio:p});for(let ge of H.values())ge.layer&&Q.push(ge);if(!se.pickedColor)break}for(let he of ne)he.restorePickingColors();return{result:Q,emptyInfo:H.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:n,y:o,width:a=1,height:l=1,mode:u="query",maxObjects:c=null,onViewportActive:h,effects:d}){let f=this._getPickable(e);if(!f)return[];this._resizeBuffer();let p=no(this.gl),S=qc(this.gl,[n,o],!0),x=S.x,T=S.y+S.height,O=qc(this.gl,[n+a,o+l],!0),M=O.x+O.width,R=O.y,N={x,y:R,width:M-x,height:T-R},H=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:N,cullRect:{x:n,y:o,width:a,height:l},effects:d,pass:"picking:".concat(u)}),Q=BL(H),ne=new Map,he=Number.isFinite(c);for(let se=0;se<Q.length&&!(he&&c&&ne.size>=c);se++){let oe=Q[se],ge={color:oe.pickedColor,layer:null,index:oe.pickedObjectIndex,picked:!0,x:n,y:o,pixelRatio:p};ge=Tx({layer:oe.pickedLayer,info:ge,mode:u}),ne.has(ge.object)||ne.set(ge.object,ge)}return Array.from(ne.values())}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:n,deviceRect:o,cullRect:a,effects:l,pass:u},c=!1){let h=c?this.depthFBO:this.pickingFBO,{decodePickingColor:d}=this.pickLayersPass.render({layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:n,pickingFBO:h,deviceRect:o,cullRect:a,effects:l,pass:u,pickZ:c}),{x:f,y:p,width:S,height:x}=o,T=new(c?Float32Array:Uint8Array)(S*x*4);return Fs(h,{sourceX:f,sourceY:p,sourceWidth:S,sourceHeight:x,target:T}),{pickedColors:T,decodePickingColor:d}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:n,deviceHeight:o}){let a=Math.max(0,e-i),l=Math.max(0,t-i),u=Math.min(n,e+i+1)-a,c=Math.min(o,t+i+1)-l;return u<=0||c<=0?null:{x:a,y:l,width:u,height:c}}};var R5={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},Ib=class{constructor(e){y(this,"el",null),y(this,"isVisible",!1);let t=e.parentElement;t&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,R5),t.appendChild(this.el))}setTooltip(e,t,i){let n=this.el;if(!!n){if(typeof e=="string")n.innerText=e;else if(e)e.text&&(n.innerText=e.text),e.html&&(n.innerHTML=e.html),e.className&&(n.className=e.className),Object.assign(n.style,e.style);else{this.isVisible=!1,n.style.display="none";return}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(t,"px, ").concat(i,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}};var Tu=me(FL());var _5={mousedown:1,mousemove:2,mouseup:4};function M5(s,e){for(let t=0;t<s.length;t++)if(e(s[t]))return!0;return!1}function GL(s){let e=s.prototype.handler;s.prototype.handler=function(i){let n=this.store;i.button>0&&i.type==="pointerdown"&&(M5(n,o=>o.pointerId===i.pointerId)||n.push(i)),e.call(this,i)}}function VL(s){s.prototype.handler=function(t){let i=_5[t.type];i&1&&t.button>=0&&(this.pressed=!0),i&2&&t.which===0&&(i=4),this.pressed&&(i&4&&(this.pressed=!1),this.callback(this.manager,i,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}GL(Tu.PointerEventInput);VL(Tu.MouseInput);var kL=Tu.Manager,bo=Tu;var rs=class{constructor(e,t,i){this.element=e,this.callback=t,this.options={enable:!0,...i}}};var zL=bo?[[bo.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[bo.Rotate,{enable:!1}],[bo.Pinch,{enable:!1}],[bo.Swipe,{enable:!1}],[bo.Pan,{threshold:0,enable:!1}],[bo.Press,{enable:!1}],[bo.Tap,{event:"doubletap",taps:2,enable:!1}],[bo.Tap,{event:"anytap",enable:!1}],[bo.Tap,{enable:!1}]]:null,Ix={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},UL={doubletap:["tap"]},WL={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Oh={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},HL={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},wx={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"};var jL=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Iu=typeof window<"u"?window:global;var Lb=!1;try{let s={get passive(){return Lb=!0,!0}};Iu.addEventListener("test",null,s),Iu.removeEventListener("test",null)}catch{Lb=!1}var N5=jL.indexOf("firefox")!==-1,{WHEEL_EVENTS:B5}=Oh,qL="wheel",XL=4.000244140625,D5=40,F5=.25,Ob=class extends rs{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{if(!this.options.enable)return;let o=n.deltaY;Iu.WheelEvent&&(N5&&n.deltaMode===Iu.WheelEvent.DOM_DELTA_PIXEL&&(o/=Iu.devicePixelRatio),n.deltaMode===Iu.WheelEvent.DOM_DELTA_LINE&&(o*=D5)),o!==0&&o%XL===0&&(o=Math.floor(o/XL)),n.shiftKey&&o&&(o=o*F5),this.callback({type:qL,center:{x:n.clientX,y:n.clientY},delta:-o,srcEvent:n,pointerType:"mouse",target:n.target})},this.events=(this.options.events||[]).concat(B5),this.events.forEach(n=>e.addEventListener(n,this.handleEvent,Lb?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===qL&&(this.options.enable=t)}};var{MOUSE_EVENTS:G5}=Oh,YL="pointermove",KL="pointerover",ZL="pointerout",QL="pointerenter",JL="pointerleave",Rb=class extends rs{constructor(e,t,i){super(e,t,i);this.handleEvent=o=>{this.handleOverEvent(o),this.handleOutEvent(o),this.handleEnterEvent(o),this.handleLeaveEvent(o),this.handleMoveEvent(o)},this.pressed=!1;let{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(G5),this.events.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===YL&&(this.enableMoveEvent=t),e===KL&&(this.enableOverEvent=t),e===ZL&&(this.enableOutEvent=t),e===QL&&(this.enableEnterEvent=t),e===JL&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(KL,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(ZL,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(QL,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(JL,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(YL,e);break;case"mouseup":this.pressed=!1;break;default:}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}};var{KEY_EVENTS:V5}=Oh,$L="keydown",eO="keyup",_b=class extends rs{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{let o=n.target||n.srcElement;o.tagName==="INPUT"&&o.type==="text"||o.tagName==="TEXTAREA"||(this.enableDownEvent&&n.type==="keydown"&&this.callback({type:$L,srcEvent:n,key:n.key,target:n.target}),this.enableUpEvent&&n.type==="keyup"&&this.callback({type:eO,srcEvent:n,key:n.key,target:n.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(V5),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===$L&&(this.enableDownEvent=t),e===eO&&(this.enableUpEvent=t)}};var tO="contextmenu",Mb=class extends rs{constructor(e,t,i){super(e,t,i);this.handleEvent=n=>{!this.options.enable||this.callback({type:tO,center:{x:n.clientX,y:n.clientY},srcEvent:n,pointerType:"mouse",target:n.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===tO&&(this.options.enable=t)}};var k5={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},z5=1,U5=2,W5=3,H5=0,j5=1,q5=2,X5=1,Y5=2,K5=4;function rO(s){let e=k5[s.srcEvent.type];if(!e)return null;let{buttons:t,button:i,which:n}=s.srcEvent,o=!1,a=!1,l=!1;return e===4||e===2&&!Number.isFinite(t)?(o=n===z5,a=n===U5,l=n===W5):e===2?(o=Boolean(t&X5),a=Boolean(t&K5),l=Boolean(t&Y5)):e===1&&(o=i===H5,a=i===j5,l=i===q5),{leftButton:o,middleButton:a,rightButton:l}}function iO(s,e){let t=s.center;if(!t)return null;let i=e.getBoundingClientRect(),n=i.width/e.offsetWidth||1,o=i.height/e.offsetHeight||1,a={x:(t.x-i.left-e.clientLeft)/n,y:(t.y-i.top-e.clientTop)/o};return{center:t,offsetCenter:a}}var Lx={srcElement:"root",priority:0},Nb=class{constructor(e){this.handleEvent=t=>{if(this.isEmpty())return;let i=this._normalizeEvent(t),n=t.srcEvent.target;for(;n&&n!==i.rootElement;){if(this._emit(i,n),i.handled)return;n=n.parentNode}this._emit(i,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,n=!1,o=!1){let{handlers:a,handlersByElement:l}=this,u=Lx;typeof i=="string"||i&&i.addEventListener?u={...Lx,srcElement:i}:i&&(u={...Lx,...i});let c=l.get(u.srcElement);c||(c=[],l.set(u.srcElement,c));let h={type:e,handler:t,srcElement:u.srcElement,priority:u.priority};n&&(h.once=!0),o&&(h.passive=!0),a.push(h),this._active=this._active||!h.passive;let d=c.length-1;for(;d>=0&&!(c[d].priority>=h.priority);)d--;c.splice(d+1,0,h)}remove(e,t){let{handlers:i,handlersByElement:n}=this;for(let o=i.length-1;o>=0;o--){let a=i[o];if(a.type===e&&a.handler===t){i.splice(o,1);let l=n.get(a.srcElement);l.splice(l.indexOf(a),1),l.length===0&&n.delete(a.srcElement)}}this._active=i.some(o=>!o.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let n=!1,o=()=>{e.handled=!0},a=()=>{e.handled=!0,n=!0},l=[];for(let u=0;u<i.length;u++){let{type:c,handler:h,once:d}=i[u];if(h({...e,type:c,stopPropagation:o,stopImmediatePropagation:a}),d&&l.push(i[u]),n)break}for(let u=0;u<l.length;u++){let{type:c,handler:h}=l[u];this.remove(c,h)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,...rO(e),...iO(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}};var Z5={events:null,recognizers:null,recognizerOptions:{},Manager:kL,touchAction:"none",tabIndex:0},$f=class{constructor(e=null,t){this._onBasicInput=n=>{let{srcEvent:o}=n,a=WL[o.type];a&&this.manager.emit(a,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options={...Z5,...t},this.events=new Map,this.setElement(e);let{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;let{options:t}=this,i=t.Manager;this.manager=new i(e,{touchAction:t.touchAction,recognizers:t.recognizers||zL}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(Ix).forEach(n=>{let o=this.manager.get(n);o&&Ix[n].forEach(a=>{o.recognizeWith(a)})});for(let n in t.recognizerOptions){let o=this.manager.get(n);if(o){let a=t.recognizerOptions[n];delete a.enable,o.set(a)}}this.wheelInput=new Ob(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Rb(e,this._onOtherEvent,{enable:!1}),this.keyInput=new _b(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new Mb(e,this._onOtherEvent,{enable:!1});for(let[n,o]of this.events)o.isEmpty()||(this._toggleRecognizer(o.recognizerName,!0),this.manager.on(n,o.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let n=i.get(e);if(n&&n.options.enable!==t){n.set({enable:t});let o=UL[e];o&&!this.options.recognizers&&o.forEach(a=>{let l=i.get(a);t?(l.requireFailure(e),n.dropRequireFailure(a)):l.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,i,n,o){if(typeof e!="string"){i=t;for(let h in e)this._addEventHandler(h,e[h],i,n,o);return}let{manager:a,events:l}=this,u=wx[e]||e,c=l.get(u);c||(c=new Nb(this),l.set(u,c),c.recognizerName=HL[u]||u,a&&a.on(u,c.handleEvent)),c.add(e,t,i,n,o),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(let a in e)this._removeEventHandler(a,e[a]);return}let{events:i}=this,n=wx[e]||e,o=i.get(n);if(!!o&&(o.remove(e,t),o.isEmpty())){let{recognizerName:a}=o,l=!1;for(let u of i.values())if(u.recognizerName===a&&!u.isEmpty()){l=!0;break}l||this._toggleRecognizer(a,!1)}}};function wu(){}var Q5=({isDragging:s})=>s?"grabbing":"grab",nO={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:wu,onResize:wu,onViewStateChange:wu,onInteractionStateChange:wu,onBeforeRender:wu,onAfterRender:wu,onLoad:wu,onError:s=>ce.error(s.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:Q5,getTooltip:null,debug:!1,drawPickingColors:!1},Lu=class{constructor(e){y(this,"props",void 0),y(this,"width",0),y(this,"height",0),y(this,"userData",{}),y(this,"canvas",null),y(this,"viewManager",null),y(this,"layerManager",null),y(this,"effectManager",null),y(this,"deckRenderer",null),y(this,"deckPicker",null),y(this,"eventManager",null),y(this,"tooltip",null),y(this,"metrics",void 0),y(this,"animationLoop",void 0),y(this,"stats",void 0),y(this,"viewState",void 0),y(this,"cursorState",void 0),y(this,"_needsRedraw",void 0),y(this,"_pickRequest",void 0),y(this,"_lastPointerDownInfo",null),y(this,"_metricsCounter",void 0),y(this,"_onPointerMove",t=>{let{_pickRequest:i}=this;if(t.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(t.leftButton||t.rightButton)return;{let n=t.offsetCenter;if(!n)return;i.x=n.x,i.y=n.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=t}),y(this,"_onEvent",t=>{let i=cx[t.type],n=t.offsetCenter;if(!i||!n||!this.layerManager)return;let o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:l}=a,u=l&&(l[i.handler]||l.props[i.handler]),c=this.props[i.handler],h=!1;u&&(h=u.call(l,a,t)),!h&&c&&c(a,t)}),y(this,"_onPointerDown",t=>{let i=t.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo}),this.props={...nO,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&ce.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),Wc()==="IE"&&ce.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||typeof document<"u"&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new yn({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&po.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,n,o,a,l;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(e=this.layerManager)===null||e===void 0||e.finalize(),this.layerManager=null,(t=this.viewManager)===null||t===void 0||t.finalize(),this.viewManager=null,(i=this.effectManager)===null||i===void 0||i.finalize(),this.effectManager=null,(n=this.deckRenderer)===null||n===void 0||n.finalize(),this.deckRenderer=null,(o=this.deckPicker)===null||o===void 0||o.finalize(),this.deckPicker=null,(a=this.eventManager)===null||a===void 0||a.destroy(),this.eventManager=null,(l=this.tooltip)===null||l===void 0||l.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var u;(u=this.canvas.parentElement)===null||u===void 0||u.removeChild(this.canvas),this.canvas=null}}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ce.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ce.removed("onLayerClick","onClick")(),e.initialViewState&&!rn(this.props.initialViewState,e.initialViewState)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),n=this.layerManager.needsRedraw(e),o=this.effectManager.needsRedraw(e),a=this.deckRenderer.needsRedraw(e);return t=t||i||n||o||a,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return St(this.viewManager),this.viewManager.views}getViewports(e){return St(this.viewManager),this.viewManager.getViewports(e)}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_pick(e,t,i){St(this.deckPicker);let{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(t).timeStart();let o=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(t).timeEnd(),o}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),St(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||t===0){let o=Number.isFinite(t)?"".concat(t,"px"):t;this.canvas.style.width=o}if(i||i===0){var n;let o=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=((n=e.style)===null||n===void 0?void 0:n.position)||"absolute",this.canvas.style.height=o}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth||e.width,i=e.clientHeight||e.height;if(t!==this.width||i!==this.height){var n;this.width=t,this.height=i,(n=this.viewManager)===null||n===void 0||n.setProps({width:t,height:i}),this.props.onResize({width:t,height:i})}}_createAnimationLoop(e){let{width:t,height:i,gl:n,glOptions:o,debug:a,onError:l,onBeforeRender:u,onAfterRender:c,useDevicePixels:h}=e;return new th({width:t,height:i,useDevicePixels:h,autoResizeViewport:!1,gl:n,onCreateContext:d=>Xc({...o,...d,canvas:this.canvas,debug:a,onContextLost:()=>this._onContextLost()}),onInitialize:d=>this._setGLContext(d.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:u,onAfterRender:c,onError:l})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new Jf({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){let{_pickRequest:e}=this;if(e.event){let{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let o=n,a=!1;for(let l of i){var t;o=l,a=((t=l.layer)===null||t===void 0?void 0:t.onHover(l,e.event))||a}if(!a&&this.props.onHover&&this.props.onHover(o,e.event),this.props.getTooltip&&this.tooltip){let l=this.props.getTooltip(o);this.tooltip.setTooltip(l,o.x,o.y)}e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,gu(e,{enable:!0,copyState:!0})),this.tooltip=new Ib(this.canvas),Ti(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);let t=new Eu;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new $f(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(let n in cx)this.eventManager.on(n,this._onEvent);this.viewManager=new pb({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new fb(e,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new Cb,this.deckRenderer=new Ab(e),this.deckPicker=new Tb(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{gl:i}=this.layerManager.context;Ti(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:e,effects:this.effectManager.getEffects(),...t}),this.props.onAfterRender({gl:i})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),ce.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=En.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}};y(Lu,"defaultProps",nO);y(Lu,"VERSION",M1.VERSION);var Rh=class{constructor(e,t){y(this,"opts",void 0),y(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:i}=this.source,{size:n}=t,o=i;if(i&&i.length!==n){o=new Float32Array(n);let a=t.elementOffset||0;for(let l=0;l<n;++l)o[l]=i[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function oO(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function Bb(s){return s.stride||s.size*s.bytesPerElement}function sO(s,e){e.offset&&ce.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=Bb(s),i=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,n=e.elementOffset||0,o=i*t+n*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function J5(s,e){let t=sO(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var Db=class{constructor(e,t,i){y(this,"gl",void 0),y(this,"id",void 0),y(this,"size",void 0),y(this,"settings",void 0),y(this,"value",void 0),y(this,"doublePrecision",void 0),y(this,"_buffer",void 0),y(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;let n=t.logicalType||t.type,o=n===5130,{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0);let l;o?l=5126:!n&&t.isIndexed?l=e&&_f(e,tt.ELEMENT_INDEX_UINT32)?5125:5123:l=n||5126;let u=oO(n||l||5126);this.doublePrecision=o,o&&t.fp64===!1&&(u=Float32Array),this.value=null,this.settings={...t,defaultType:u,defaultValue:a,logicalType:n,type:l,size:this.size,bytesPerElement:u.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new ve(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Bb(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),po.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let i={},n=this.value instanceof Float64Array,o=J5(this.getAccessor(),t||{});return i[e]=new Rh(this,o.high),i["".concat(e,"64Low")]=n?new Rh(this,o.low):new Float32Array(this.size),i}if(t){let i=sO(this.getAccessor(),t);return{[e]:new Rh(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:n}=this,o=i*n;if(t&&o&&t.length>=o){let a=new Array(n).fill(1/0),l=new Array(n).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<n;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this,i;ArrayBuffer.isView(e)?i={value:e}:e instanceof ve?i={buffer:e}:i=e;let n={...this.settings,...i};if(t.bufferAccessor=n,t.bounds=null,i.constant){let o=i.value;if(o=this._normalizeValue(o,[],0),this.settings.normalized&&(o=this.normalizeConstant(o)),!(!t.constant||!this._areValuesEqual(o,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=o}else if(i.buffer){let o=i.buffer;t.externalBuffer=o,t.constant=!1,this.value=i.value||null;let a=i.value instanceof Float64Array;n.type=i.type||o.accessor.type,n.bytesPerElement=o.accessor.BYTES_PER_ELEMENT*(a?2:1),n.stride=Bb(n)}else if(i.value){this._checkExternalBuffer(i);let o=i.value;t.externalBuffer=null,t.constant=!1,this.value=o,n.bytesPerElement=o.BYTES_PER_ELEMENT,n.stride=Bb(n);let{buffer:a,byteOffset:l}=this;this.doublePrecision&&o instanceof Float64Array&&(o=cb(o,n));let u=o.byteLength+l+n.stride*2;a.byteLength<u&&a.reallocate(u),a.setAccessor(null),a.subData({data:o,offset:l}),n.type=i.type||a.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?cb(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){let{state:i}=this,n=i.allocatedValue,o=po.allocate(n,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&n&&a.subData({data:n instanceof Float64Array?cb(n,this):n,offset:l})),i.allocatedValue=o,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));let i=this.settings.defaultType,n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&ce.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:n,size:o}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e)return t[i]=n[0],t;switch(o){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let a=o;for(;--a>=0;)t[i+a]=Number.isFinite(e[a])?e[a]:n[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}};var aO=[],lO=[];function Po(s,e=0,t=1/0){let i=aO,n={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?i=s:s.length>0&&(lO.length=s.length,i=lO):i=aO,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),n.index=e-1),{iterable:i,objectInfo:n}}function Fb(s){return s&&s[Symbol.asyncIterator]}function Gb(s,e){let{size:t,stride:i,offset:n,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=i?i/l:t,c=n?n/l:0,h=Math.floor((s.length-c)/u);return(d,{index:f,target:p})=>{if(!o){let O=f*u+c;for(let M=0;M<t;M++)p[M]=s[O+M];return p}let S=o[f],x=o[f+1]||h,T;if(a){T=new Array(x-S);for(let O=S;O<x;O++){let M=O*u+c;p=new Array(t);for(let R=0;R<t;R++)p[R]=s[M+R];T[O-S]=p}}else if(u===t)T=s.subarray(S*t+c,x*t+c);else{T=new s.constructor((x-S)*t);let O=0;for(let M=S;M<x;M++){let R=M*u+c;for(let N=0;N<t;N++)T[O++]=s[R+N]}}return T}}var uO=[],ep=[[0,1/0]];function cO(s,e){if(s===ep||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],i=s.length,n=0;for(let o=0;o<i;o++){let a=s[o];a[1]<e[0]?(t.push(a),n=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(n,0,e),t}function Ox(s){let{source:e,target:t,start:i=0,size:n,getData:o}=s,a=s.end||t.length,l=e.length,u=a-i;if(l>u){t.set(e.subarray(0,u),i);return}if(t.set(e,i),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<n;d++)t[i+c]=h[d]||0,c++}}function hO({source:s,target:e,size:t,getData:i,sourceStartIndices:n,targetStartIndices:o}){if(!Array.isArray(o))return Ox({source:s,target:e,size:t,getData:i}),e;let a=0,l=0,u=i&&((h,d)=>i(h+l,d)),c=Math.min(n.length,o.length);for(let h=1;h<c;h++){let d=n[h]*t,f=o[h]*t;Ox({source:s.subarray(a,d),target:e,start:l,end:f,size:t,getData:u}),a=d,l=f}return l<e.length&&Ox({source:[],target:e,start:l,size:t,getData:u}),e}var e4={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function Vb(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});let t=s.type||"interpolation";return{...e4[t],...e,...s,type:t}}function kb(s,e){let t=e.getBuffer();return t?[t,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function zb(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function Ub(s){s.push(s.shift())}function tp(s,e){let{doublePrecision:t,settings:i,value:n,size:o}=s,a=t&&n instanceof Float64Array?2:1;return(i.noAlloc?n.length:e*o)*a}function Wb({buffer:s,numInstances:e,attribute:t,fromLength:i,fromStartIndices:n,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=n&&c,d=tp(t,e),f=t.isConstant;if(!h&&i>=d)return;let p=f?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!f){let O=o;o=(M,R)=>t.normalizeConstant(O(M,R))}let S=f?(O,M)=>o(p,M):(O,M)=>o(p.subarray(O,O+l),M),x=s.getData({length:i}),T=new Float32Array(d);hO({source:x,target:T,sourceStartIndices:n,targetStartIndices:c,size:l,getData:S}),s.byteLength<T.byteLength+u&&s.reallocate(T.byteLength+u),s.subData({data:T,offset:u})}var Qa=class extends Db{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:ep});y(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return Vb(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:i=0,endRow:n=1/0}=t;this.state.updateRanges=cO(this.state.updateRanges,[i,n])}else this.state.updateRanges=ep}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=uO}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,t.updateRanges!==ep),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(n,this,{data:t,startRow:c,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:f})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),n.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let a=e;St(ArrayBuffer.isView(a.value),"invalid ".concat(n.accessor));let l=Boolean(a.size)&&a.size!==this.size;return i.binaryAccessor=Gb(a.value,{size:a.size||this.size,stride:a.stride,offset:a.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:f,transform:p}=l,S=u.binaryAccessor||(typeof f=="function"?f:o[f]);St(typeof S=="function",'accessor "'.concat(f,'" is not a function'));let x=e.getVertexOffset(i),{iterable:T,objectInfo:O}=Po(t,i,n);for(let M of T){O.index++;let R=S(M,O);if(p&&(R=p.call(this,R)),d){let N=(O.index<d.length-1?d[O.index+1]:a)-d[O.index];if(R&&Array.isArray(R[0])){let H=x;for(let Q of R)e._normalizeValue(Q,c,H),H+=h}else R&&R.length>h?c.set(R,x):(e._normalizeValue(R,O.target,0),xx({target:c,source:O.target,start:x,count:N}));x+=N*h}else e._normalizeValue(R,c,x),x+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var Hb=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","interpolation"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.transition=new wn(i),this.attribute=t,this.attributeInTransition=new Qa(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=r4(e,t);let n={byteLength:0,usage:35050};this.buffers=[new ve(e,n),new ve(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}this.settings=e;let{gl:i,buffers:n,attribute:o}=this;Ub(n);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)Wb({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=tp(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:n[0],aTo:kb(i,o)},feedbackBuffers:{vCurrent:n[1]}})}update(){let e=this.transition.update();if(e){let{duration:t,easing:i}=this.settings,{time:n}=this.transition,o=n/t;i&&(o=i(o)),this.transform.run({uniforms:{time:o}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0}},t4=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function r4(s,e){let t=zb(e.size);return new vn(s,{vs:t4,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var jb=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","spring"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"texture",void 0),y(this,"framebuffer",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new wn(i),this.attribute=t,this.attributeInTransition=new Qa(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=n4(e),this.framebuffer=o4(e,this.texture),this.transform=i4(e,t,this.framebuffer);let n={byteLength:0,usage:35050};this.buffers=[new ve(e,n),new ve(e,n),new ve(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:i,buffers:n,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)Wb({buffer:l,...a});this.settings=e,this.currentStartIndices=o.startIndices,this.currentLength=tp(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:kb(i,o)}})}update(){let{buffers:e,transform:t,framebuffer:i,transition:n}=this;if(!n.update())return!1;let a=this.settings;return t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:a.stiffness,damping:a.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),Ub(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),Fs(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}};function i4(s,e,t){let i=zb(e.size);return new vn(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function n4(s){return new Je(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function o4(s,e){return new ze(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var s4={interpolation:Hb,spring:jb},qb=class{constructor(e,{id:t,timeline:i}){y(this,"id",void 0),y(this,"isSupported",void 0),y(this,"gl",void 0),y(this,"timeline",void 0),y(this,"transitions",void 0),y(this,"needsRedraw",void 0),y(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=vn.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(let n in e){let o=e[n],a=o.getTransitionSetting(t);!a||this._updateAttribute(n,o,a)}for(let n in this.transitions){let o=e[n];(!o||!o.getTransitionSetting(t))&&this._removeTransition(n)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){let n=this.transitions[e],o=!n||n.type!==i.type;if(o){if(!this.isSupported){ce.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}n&&this._removeTransition(e);let a=s4[i.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(ce.error("unsupported transition type '".concat(i.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}};var dO="attributeManager.invalidate",a4="attributeManager.updateStart",l4="attributeManager.updateEnd",u4="attribute.updateStart",c4="attribute.allocate",h4="attribute.updateEnd",Xb=class{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"attributes",void 0),y(this,"updateTriggers",void 0),y(this,"needsRedraw",void 0),y(this,"userData",void 0),y(this,"stats",void 0),y(this,"attributeTransitionManager",void 0),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new qb(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(let t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);kt(dO,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);kt(dO,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:o={},buffers:a={},context:l={}}){let u=!1;kt(a4,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=i,h.numInstances=t,o[c]&&ce.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(typeof d=="string"?a[d]:void 0,e.startIndices)||typeof d=="string"&&!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}u&&kt(l4,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!i.hasAttribute(o)&&(n[o]=a)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let i={};for(let n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}_add(e,t={}){for(let i in e){let n=e[i];this.attributes[i]=this._createAttribute(i,n,t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){let n={...t,id:e,size:t.isIndexed&&1||t.size||1,divisor:i.instanced?1:t.divisor||0};return new Qa(this.gl,n)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(n=>{e[n]||(e[n]=[]),e[n].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:n}=this,o=n[e];return o&&o.forEach(a=>{let l=i[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:i}=e;if(kt(u4,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&kt(c4,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,kt(h4,t,i))}};var Yb=class extends wn{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:o}}=this,a=o(e/n);this._value=yu(t,i,a)}};var fO=1e-5;function pO(s,e,t,i,n){let o=e-s,l=(t-e)*n,u=-o*i;return l+u+o+e}function d4(s,e,t,i,n){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=pO(s[a],e[a],t[a],i,n);return o}return pO(s,e,t,i,n)}function gO(s,e){if(Array.isArray(s)){let t=0;for(let i=0;i<s.length;i++){let n=s[i]-e[i];t+=n*n}return Math.sqrt(t)}return Math.abs(s-e)}var Kb=class extends wn{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=d4(o,a,t,i,n),u=gO(l,t),c=gO(l,a);u<fO&&c<fO&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var f4={interpolation:Yb,spring:Kb},Zb=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(n=Vb(n),!n)return;let a=f4[n.type];if(!a){ce.error("unsupported transition type '".concat(n.type,"'"))();return}let l=new a(this.timeline);l.start({...n,fromValue:t,toValue:i}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function bO(s){let e=_x(s);for(let t in e){let i=e[t],{validate:n}=i;if(n&&!n(s[t],i))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function PO(s,e){let t=yO({newProps:s,oldProps:e,propTypes:_x(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=g4(s,e),n=!1;return i||(n=m4(s,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:n,extensionsChanged:b4(s,e),transitionsChanged:p4(s,e)}}function p4(s,e){if(!s.transitions)return!1;let t={},i=_x(s),n=!1;for(let o in s.transitions){let a=i[o],l=a&&a.type;(l==="number"||l==="color"||l==="array")&&Rx(s[o],e[o],a)&&(t[o]=!0,n=!0)}return n?t:!1}function yO({newProps:s,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:n="props"}){if(e===s)return!1;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(n," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(n,".").concat(o," added");let a=Rx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(n,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=Rx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}}return!1}function Rx(s,e,t){let i=t&&t.equal;return i&&!i(s,e,t)||!i&&(i=s&&e&&s.equals,i&&!i.call(s,e))?"changed deeply":!i&&e!==s?"changed shallowly":null}function g4(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1,{dataComparator:i,_dataDiff:n}=s;return i?i(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&n&&(t=n(s.data,e.data)||t),t}function m4(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&mO(s,e,"all"))return{all:!0};let t={},i=!1;for(let n in s.updateTriggers)n!=="all"&&mO(s,e,n)&&(t[n]=!0,i=!0);return i?t:!1}function b4(s,e){if(e===null)return!0;let t=e.extensions,{extensions:i}=s;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let n=0;n<i.length;n++)if(!i[n].equals(t[n]))return!0;return!1}function mO(s,e,t){let i=s.updateTriggers[t];i=i??{};let n=e.updateTriggers[t];return n=n??{},yO({oldProps:n,newProps:i,triggerName:t})}function _x(s){let e=s[vh],t=e&&e.constructor;return t?t._propTypes:{}}var P4="count(): argument not an object",y4="count(): argument not a container";function SO(s){if(!E4(s))throw new Error(P4);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(S4(s))return Object.keys(s).length;throw new Error(y4)}function S4(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function E4(s){return s!==null&&typeof s=="object"}function EO(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){let i=t.modules.findIndex(n=>n.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let i={...s.inject};for(let n in e.inject)i[n]=(i[n]||"")+e.inject[n];t.inject=i}return t}var x4={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},Mx={};function xO(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Je)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={[10241]:e.data.length>1?9985:9729});let n=new Je(t,{...e,parameters:{...x4,...i,...s.props.textureParameters}});return Mx[n.id]=!0,n}function CO(s){!s||!(s instanceof Je)||Mx[s.id]&&(s.delete(),delete Mx[s.id])}var C4={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||ip(s)&&(s.length===3||s.length===4)},equal(s,e,t){return Nx(s,e)}},accessor:{validate(s,e){let t=Qb(s);return t==="function"||t===Qb(e.value)},equal(s,e,t){return typeof e=="function"?!0:Nx(s,e)}},array:{validate(s,e){return e.optional&&!s||ip(s)},equal(s,e,t){return t.compare?Nx(s,e):s===e}},object:{equal(s,e,t){return t.compare?rn(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:i}=t.props;return i&&s?i(s):s}},image:{transform:(s,e,t)=>xO(t,s),release:s=>{CO(s)}}};function Nx(s,e){if(s===e)return!0;if(!ip(s)||!ip(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}function vO(s){let e={},t={},i={};for(let[n,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)i[n]=Array.isArray(a)?a:[a];else{let l=v4(n,o);e[n]=l,t[n]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function v4(s,e){switch(Qb(e)){case"object":return rp(s,e);case"array":return rp(s,{type:"array",value:e,compare:!1});case"boolean":return rp(s,{type:"boolean",value:e});case"number":return rp(s,{type:"number",value:e});case"function":return rp(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function rp(s,e){return"type"in e?{name:s,...C4[e.type],...e}:"value"in e?{name:s,type:Qb(e.value),...e}:{name:s,type:"object",value:e}}function ip(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function Qb(s){return ip(s)?"array":s===null?"null":typeof s}function AO(s,e){let t=TO(s.constructor),i=Object.create(t);i[vh]=s,i[ts]={},i[go]={};for(let n=0;n<e.length;++n){let o=e[n];for(let a in o)i[a]=o[a]}return Object.freeze(i),i}function TO(s){let e=Jb(s,"_mergedDefaultProps");return e||(A4(s),s._mergedDefaultProps)}function A4(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),i=TO(t),n=Jb(s,"defaultProps")||{},o=vO(n),a=T4(o.defaultProps,i,s),l={...t._propTypes,...o.propTypes};w4(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};I4(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function T4(s,e,t){let i=Object.create(null);Object.assign(i,e,s);let n=O4(t);return delete s.id,Object.defineProperties(i,{id:{writable:!0,value:n}}),i}function I4(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(i){let n="".concat(this.id,": ").concat(t);for(let o of e[t])IO(this,o)||(this[o]=i);ce.deprecated(n,e[t].join("/"))()}})}function w4(s,e){let t={},i={};for(let n in e){let o=e[n],{name:a,value:l}=o;o.async&&(t[a]=l,i[a]=L4(a))}s[Vs]=t,s[ts]={},Object.defineProperties(s,i)}function L4(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||Fb(e)?this[ts][s]=e:this[go][s]=e},get(){if(this[go]){if(s in this[go])return this[go][s]||this[Vs][s];if(s in this[ts]){let e=this[vh]&&this[vh].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[Vs][s]}}return this[Vs][s]}}}function IO(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Jb(s,e){return IO(s,e)&&s[e]}function O4(s){let e=Jb(s,"layerName")||Jb(s,"componentName");return e||ce.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var R4=0,_h=class{constructor(...e){y(this,"id",void 0),y(this,"props",void 0),y(this,"count",void 0),this.props=AO(this,e),this.id=this.props.id,this.count=R4++}clone(e){let{props:t}=this,i={};for(let n in t[Vs])n in t[go]?i[n]=t[go][n]:n in t[ts]&&(i[n]=t[ts][n]);return new this.constructor({...t,...i,...e})}};y(_h,"componentName","Component");y(_h,"defaultProps",{});var _4=Object.freeze({}),$b=class{constructor(e){y(this,"component",void 0),y(this,"onAsyncPropUpdated",void 0),y(this,"asyncProps",void 0),y(this,"oldProps",void 0),y(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||_4}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[go]||{},i=e[ts]||e,n=e[Vs]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in i){let a=i[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(Fb(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let n=i.pendingLoadCount;t.then(o=>{o=this._postProcessValue(i,o),this._setAsyncPropValue(e,o,n),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let n=i.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,n)}this._onResolve(e,o)}_postProcessValue(e,t){let i=e.type;return i&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let n=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var eP=class extends $b{constructor({attributeManager:e,layer:t}){super(t);y(this,"attributeManager",void 0),y(this,"needsRedraw",void 0),y(this,"needsUpdate",void 0),y(this,"subLayers",void 0),y(this,"usesPickingColorCache",void 0),y(this,"changeFlags",void 0),y(this,"viewport",void 0),y(this,"uniformTransitions",void 0),y(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let i=this.component.props.fetch;return i?i(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let i=this.component.props.onDataLoad;e==="data"&&i&&i(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var M4="layer.changeFlag",N4="layer.initialize",B4="layer.update",D4="layer.finalize",F4="layer.matched",wO=2**24-1,G4=Object.freeze([]),V4=co(({oldViewport:s,viewport:e})=>s.equals(e)),is=new Uint8ClampedArray(0),k4={data:{type:"data",value:G4,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:i,loadOptions:n,signal:o})=>{let{resourceManager:a}=t.context;if(n=n||t.getLoadOptions(),i=i||t.props.loaders,o){var l;n={...n,fetch:{...(l=n)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!n&&(a.add({resourceId:s,data:Ko(s,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>{var h;return(h=t.internalState)===null||h===void 0?void 0:h.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):Ko(s,i,n)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:uo.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Ve.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},Jt=class extends _h{constructor(...e){super(...e);y(this,"internalState",null),y(this,"lifecycle",Ya.NO_STATE),y(this,"context",void 0),y(this,"state",void 0),y(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){St(this.internalState);let t=this.internalState.viewport||this.context.viewport,i=Ex(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,o,a]=Eh(i,t.pixelProjectionMatrix);return e.length===2?[n,o]:[n,o,a]}unproject(e){return St(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){St(this.internalState);let i=this.internalState.viewport||this.context.viewport;return AL(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Ve.DEFAULT||e===Ve.LNGLAT||e===Ve.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){St(e instanceof Uint8Array);let[t,i,n]=e;return t+i*256+n*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:SO(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:i,instancePositions:n}=t.attributes;return(e=i||n)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(let t of this.props.extensions)e=EO(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let u of i)t.invalidateAll(u);else t.invalidateAll();let{props:n,oldProps:o}=e,a=Number.isInteger(o.highlightedObjectIndex)||o.pickable,l=Number.isInteger(n.highlightedObjectIndex)||n.pickable;if(a!==l&&t){let{pickingColors:u,instancePickingColors:c}=t.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,t.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(e){for(let i of this.getModels())i.delete();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:n}=e;return n>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[n]),e}raiseError(e,t){var i,n;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((i=(n=this.props).onError)!==null&&i!==void 0&&i.call(n,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!V4({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();!t||(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),n=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:n,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let n in t)Object.defineProperty(i,n,{value:t[n]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(is.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>wO&&ce.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),is=po.allocate(is,t,{size:3,copy:!0,maxCount:Math.max(t,wO)});let n=Math.floor(is.length/3),o=[];for(let a=i;a<n;a++)this.encodePickingColor(a,o),is[a*3+0]=o[0],is[a*3+1]=o[1],is[a*3+2]=o[2]}e.value=is.subarray(0,t*3)}_setModelAttributes(e,t){let i=this.getAttributeManager(),n=e.userData.excludeAttributes||{},o=i.getShaderAttributes(t,n);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i;if(!n)return;let o=n.getVertexOffset(e),a=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;!i||(this.internalState.usesPickingColorCache&&i.value.buffer!==is.buffer&&(i.value=is.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){St(!this.internalState),St(Number.isFinite(this.props.coordinateSystem)),kt(N4,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new eP({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ce.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Zb(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){kt(F4,this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(kt(B4,this,e),!e)return;let t=this.props,i=this.context,n=this.internalState,o=i.viewport,a=this._updateUniformTransition();n.propsInTransition=a,i.viewport=n.viewport||o,this.props=a;try{let l=this._getUpdateParams(),u=this.getModels();if(i.gl)this.updateState(l);else try{this.updateState(l)}catch{}for(let h of this.props.extensions)h.updateState.call(this,l,h);let c=this.getModels()[0]!==u[0];this._postUpdate(l,c)}finally{i.viewport=o,this.props=t,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){kt(D4,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();let n=this.props,o=this.context;this.props=this.internalState.propsInTransition||n;let a=this.props.opacity;t.opacity=Math.pow(a,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:l}=this.props,u=l&&l(t)||[0,0];Ti(o.gl,{polygonOffset:u}),yt(o.gl,i,()=>{let c={moduleParameters:e,uniforms:t,parameters:i,context:o};for(let h of this.props.extensions)h.draw.call(this,c,h);this.draw(c)})}finally{this.props=n}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let n in e)if(e[n]){let o=!1;switch(n){case"dataChanged":let a=e[n],l=t[n];a&&Array.isArray(l)&&(t.dataChanged=Array.isArray(a)?l.concat(a):a,o=!0);default:t[n]||(t[n]=e[n],o=!0)}o&&kt(M4,this,n,e)}let i=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i=PO(e,t);if(i.updateTriggersChanged)for(let o in i.updateTriggersChanged)i.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(i.transitionsChanged)for(let o in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(o,t[o],e[o],(n=e.transitions)===null||n===void 0?void 0:n[o])}return this.setChangeFlags(i)}validateProps(){bO(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new Xb(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:n}=e;this.setNeedsRedraw(),this._updateAttributes();let{model:o}=this.state;o?.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:l,highlightColor:u}=i;if(t||n.autoHighlight!==a||n.highlightedObjectIndex!==l||n.highlightColor!==u){let c={};a||(c.pickingSelectedColor=null),Array.isArray(u)&&(c.pickingHighlightColor=u),Number.isInteger(l)&&(c.pickingSelectedColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setModuleParameters(c)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let i=this.getAttributeManager(),n=i?i.getNeedsRedraw(e):!1;return t=t||n,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};y(Jt,"defaultProps",k4);y(Jt,"layerName","Layer");var z4="compositeLayer.renderLayers",Di=class extends Jt{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){var t;let{opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:x,extensions:T,fetch:O,operation:M,_subLayerProps:R}=this.props,N={id:"",updateTriggers:{},opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:x,extensions:T,fetch:O,operation:M},H=R&&e.id&&R[e.id],Q=H&&H.updateTriggers,ne=e.id||"sublayer";if(H){let he=this.constructor._propTypes,se=e.type?e.type._propTypes:{};for(let oe in H){let ge=se[oe]||he[oe];ge&&ge.type==="accessor"&&(H[oe]=this.getSubLayerAccessor(H[oe]))}}Object.assign(N,e,H),N.id="".concat(this.props.id,"-").concat(ne),N.updateTriggers={all:(t=this.props.updateTriggers)===null||t===void 0?void 0:t.all,...e.updateTriggers,...Q};for(let he of T){let se=he.getSubLayerProps.call(this,he);se&&Object.assign(N,se,{updateTriggers:Object.assign(N.updateTriggers,se.updateTriggers)})}return N}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,n=!i||this.needsUpdate();if(n){let o=this.renderLayers();i=ks(o,Boolean),this.internalState.subLayers=i}kt(z4,this,n,i);for(let o of i)o.parent=this}};y(Di,"layerName","CompositeLayer");var tP=Math.PI/180,LO=180/Math.PI,rP=6370972,Mh=256;function U4(){let s=Mh/rP,e=Math.PI/180*Mh;return{unitsPerMeter:[s,s,s],unitsPerMeter2:[0,0,0],metersPerUnit:[1/s,1/s,1/s],unitsPerDegree:[e,e,s],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/s]}}var np=class extends Li{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,nearZMultiplier:o=.1,farZMultiplier:a=2,resolution:l=10}=e,{height:u,altitude:c=1.5}=e;u=u||1,c=Math.max(.75,c);let h=new mt().lookAt({eye:[0,-c,0],up:[0,0,1]}),d=Math.pow(2,n);h.rotateX(t*tP),h.rotateZ(-i*tP),h.scale(d/u);let f=Math.atan(.5/c),p=Mh*2*d/u;super({...e,height:u,viewMatrix:h,longitude:i,latitude:t,zoom:n,distanceScales:U4(),fovyRadians:f*2,focalDistance:c,near:o,far:Math.min(2,1/p+1)*c*a});y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"resolution",void 0),this.latitude=t,this.longitude=i,this.resolution=l}get projectionMode(){return ai.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,this.height/2],t),n=this.unproject([this.width/2,0],t),o=this.unproject([this.width,this.height/2],t),a=this.unproject([this.width/2,this.height],t);return o[0]<this.longitude&&(o[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],o[0],n[0],a[0]),Math.min(i[1],o[1],n[1],a[1]),Math.max(i[0],o[0],n[0],a[0]),Math.max(i[1],o[1],n[1],a[1])]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,{pixelUnprojectionMatrix:u}=this,c;if(Number.isFinite(a))c=Bx(u,[n,l,a,1]);else{let p=Bx(u,[n,l,-1,1]),S=Bx(u,[n,l,1,1]),x=((i||0)/rP+1)*Mh,T=qm(Hm([],p,S)),O=qm(p),M=qm(S),R=(4*O*M-(T-O-M)**2)/16,N=4*R/T,H=Math.sqrt(O-N),Q=Math.sqrt(Math.max(0,x*x-N)),ne=(H-Q)/Math.sqrt(T);c=tw([],p,S,ne)}let[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i,n=0]=e,o=t*tP,a=i*tP,l=Math.cos(a),u=(n/rP+1)*Mh;return[Math.sin(o)*l*u,-Math.cos(o)*l*u,Math.sin(a)*u]}unprojectPosition(e){let[t,i,n]=e,o=jm(e),a=Math.asin(n/o),u=Math.atan2(t,-i)*LO,c=a*LO,h=(o/Mh-1)*rP;return[u,c,h]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){let i=this.unproject(t);return{longitude:e[0]-i[0]+this.longitude,latitude:e[1]-i[1]+this.latitude}}};function Bx(s,e){let t=lo([],e,s);return fh(t,t,1/t[3]),t}var Nh=class{constructor(e){y(this,"opts",void 0),e&&(this.opts=e)}equals(e){return this===e?!0:this.constructor===e.constructor&&rn(this.opts,e.opts)}getShaders(e){return null}getSubLayerProps(e){let{defaultProps:t}=e.constructor,i={updateTriggers:{}};for(let n in t)if(n in this.props){let o=t[n],a=this.props[n];i[n]=a,o&&o.type==="accessor"&&(i.updateTriggers[n]=this.props.updateTriggers[n],typeof a=="function"&&(i[n]=this.getSubLayerAccessor(a)))}return i}initializeState(e,t){}updateState(e,t){}draw(e,t){}finalizeState(e,t){}};y(Nh,"defaultProps",{});var Ou=class{constructor(e){y(this,"opts",void 0),y(this,"typedArrayManager",void 0),y(this,"indexStarts",[0]),y(this,"vertexStarts",[0]),y(this,"vertexCount",0),y(this,"instanceCount",0),y(this,"attributes",void 0),y(this,"_attributeDefs",void 0),y(this,"data",void 0),y(this,"getGeometry",void 0),y(this,"geometryBuffer",void 0),y(this,"buffers",void 0),y(this,"positionSize",void 0),y(this,"normalize",void 0);let{attributes:t={}}=e;this.typedArrayManager=po,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:n,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=i,this.normalize=u,o&&(St(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(i.positions=o)),this.geometryBuffer=i.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){let t=e.value||e;return ArrayBuffer.isView(t)?Gb(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){let{attributes:i,buffers:n,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in n)a.release(i[l]),i[l]=null;else{let u=o[l];u.copy=t,i[l]=a.allocate(i[l],e,u)}}_forEachGeometry(e,t,i){let{data:n,getGeometry:o}=this,{iterable:a,objectInfo:l}=Po(n,t,i);for(let u of a){l.index++;let c=o?o(u,l):null;e(c,l.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!a)this._forEachGeometry((d,f)=>{let p=d&&this.normalizeGeometry(d);c[f]=p,i[f+1]=i[f]+(p?this.getGeometrySize(p):0)},l,u),n=i[i.length-1];else if(i=o.startIndices,n=i[o.length]||0,ArrayBuffer.isView(a))n=n||a.length/this.positionSize;else if(a instanceof ve){let d=a.accessor.stride||this.positionSize*4;n=n||a.byteLength/d}else if(a.buffer){let d=a.stride||this.positionSize*4;n=n||a.buffer.byteLength/d}else if(a.value){let d=a.value,f=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;n=n||d.length/f}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;let h={};this._forEachGeometry((d,f)=>{let p=c[f]||d;h.vertexStart=i[f],h.indexStart=t[f];let S=f<i.length-1?i[f+1]:n;h.geometrySize=S-i[f],h.geometryIndex=f,this.updateGeometryAttributes(p,h)},l,u),this.vertexCount=t[t.length-1]}};var OO=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var RO=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var W4=1024,H4=4,_O=()=>{},j4={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function q4(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function X4(s,e,t,i){return t===e.width&&i===e.height?e:(s.canvas.height=i,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,i),s.canvas)}function op(s){return s&&(s.id||s.url)}function Y4(s,e,t){let i=s.width,n=s.height,o=Zc(s,{width:e,height:t});return Am(s,o,{targetY:0,width:i,height:n}),s.delete(),o}function MO(s,e,t){for(let i=0;i<e.length;i++){let{icon:n,xOffset:o}=e[i],a=op(n);s[a]={...n,x:o,y:t}}}function K4({icons:s,buffer:e,mapping:t={},xOffset:i=0,yOffset:n=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=op(c);if(!t[h]){let{height:d,width:f}=c;i+f+e>a&&(MO(t,l,n),i=0,n=o+n+e,o=0,l=[]),l.push({icon:c,xOffset:i}),i=i+f+e,o=Math.max(o,d)}}return l.length>0&&MO(t,l,n),{mapping:t,rowHeight:o,xOffset:i,yOffset:n,canvasWidth:a,canvasHeight:q4(o+n+e)}}function Z4(s,e,t){if(!s||!e)return null;t=t||{};let i={},{iterable:n,objectInfo:o}=Po(s);for(let a of n){o.index++;let l=e(a,o),u=op(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!i[u]&&(!t[u]||l.url!==t[u].url)&&(i[u]={...l,source:a,sourceIndex:o.index})}return i}var iP=class{constructor(e,{onUpdate:t=_O,onError:i=_O}){y(this,"gl",void 0),y(this,"onUpdate",void 0),y(this,"onError",void 0),y(this,"_loadOptions",null),y(this,"_texture",null),y(this,"_externalTexture",null),y(this,"_mapping",{}),y(this,"_textureParameters",null),y(this,"_pendingCount",0),y(this,"_autoPacking",!1),y(this,"_xOffset",0),y(this,"_yOffset",0),y(this,"_rowHeight",0),y(this,"_buffer",H4),y(this,"_canvasWidth",W4),y(this,"_canvasHeight",0),y(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=i}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?op(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n,textureParameters:o}){if(e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),n&&(this._mapping=n),i){var a;(a=this._texture)===null||a===void 0||a.delete(),this._texture=null,this._externalTexture=i}o&&(this._textureParameters=o)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;let i=Object.values(Z4(e,t,this._mapping)||{});if(i.length>0){let{mapping:n,xOffset:o,yOffset:a,rowHeight:l,canvasHeight:u}=K4({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=n,this._xOffset=o,this._yOffset=a,this._canvasHeight=u,this._texture||(this._texture=new Je(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||j4})),this._texture.height!==this._canvasHeight&&(this._texture=Y4(this._texture,this._canvasWidth,this._canvasHeight)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let i of e)this._pendingCount++,Ko(i.url,fu,this._loadOptions).then(n=>{let o=op(i),{x:a,y:l,width:u,height:c}=this._mapping[o],h=X4(t,n,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(n=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:n})}).finally(()=>{this._pendingCount--})}};var NO=[0,0,0,255],Q4={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:NO},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},yo=class extends Jt{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:OO,fs:RO,modules:[li,In]})}initializeState(){this.state={iconManager:new iP(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:NO},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager(),{iconAtlas:a,iconMapping:l,data:u,getIcon:c,textureParameters:h}=t,{iconManager:d}=this.state,f=a||this.internalState.isAsyncPropLoading("iconAtlas");if(d.setProps({loadOptions:t.loadOptions,autoPacking:!f,iconAtlas:a,iconMapping:f?l:null,textureParameters:h}),f?i.iconMapping!==t.iconMapping&&o.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&d.packIcons(u,c),n.extensionsChanged){var p;let{gl:S}=this.context;(p=this.state.model)===null||p===void 0||p.delete(),this.state.model=this._getModel(S),o.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:Vr[o],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;let i=(t=this.getCurrentLayer())===null||t===void 0?void 0:t.props.onIconError;i?i(e):ce.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:n=t/2,anchorY:o=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-n,i/2-o]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let{x:t,y:i,width:n,height:o}=this.state.iconManager.getIconMapping(e);return[t,i,n,o]}};y(yo,"defaultProps",Q4);y(yo,"layerName","IconLayer");var BO=`#define SHADER_NAME scatterplot-layer-vertex-shader

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceRadius;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;


void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  outerRadiusPixels = clamp(
    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
    radiusMinPixels, radiusMaxPixels
  );
  
  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  outerRadiusPixels += stroked * lineWidthPixels / 2.0;

  // Expand geometry to accomodate edge smoothing
  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;

  // position on the containing square in [-1, 1] space
  unitPosition = edgePadding * positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
  
  if (billboard) {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = edgePadding * positions * outerRadiusPixels;
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  }

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var DO=`#define SHADER_NAME scatterplot-layer-fragment-shader

precision highp float;

uniform bool filled;
uniform float stroked;
uniform bool antialiasing;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition) * outerRadiusPixels;
  float inCircle = antialiasing ? 
    smoothedge(distToCenter, outerRadiusPixels) : 
    step(distToCenter, outerRadiusPixels);

  if (inCircle == 0.0) {
    discard;
  }

  if (stroked > 0.5) {
    float isLine = antialiasing ? 
      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
      step(innerUnitRadius * outerRadiusPixels, distToCenter);

    if (filled) {
      gl_FragColor = mix(vFillColor, vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inCircle;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var FO=[0,0,0,255],J4={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:s=>s.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:FO},getLineColor:{type:"accessor",value:FO},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}},Bh=class extends Jt{getShaders(){return super.getShaders({vs:BO,fs:DO,modules:[li,In]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){if(super.updateState(e),e.changeFlags.extensionsChanged){var t;let{gl:i}=this.context;(t=this.state.model)===null||t===void 0||t.delete(),this.state.model=this._getModel(i),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{radiusUnits:t,radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,stroked:a,filled:l,billboard:u,antialiasing:c,lineWidthUnits:h,lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:a?1:0,filled:l,billboard:u,antialiasing:c,radiusUnits:Vr[t],radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,lineWidthUnits:Vr[h],lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}).draw()}_getModel(e){let t=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Bh,"defaultProps",J4);y(Bh,"layerName","ScatterplotLayer");var nP={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function sp(s,e,t={}){return GO(s,t)!==e?($4(s,t),!0):!1}function GO(s,e={}){return Math.sign(oP(s,e))}function oP(s,e={}){let{start:t=0,end:i=s.length}=e,n=e.size||2,o=0;for(let a=t,l=i-n;a<i;a+=n)o+=(s[a]-s[l])*(s[a+1]+s[l+1]),l=a;return o/2}function $4(s,e){let{start:t=0,end:i=s.length,size:n=2}=e,o=(i-t)/n,a=Math.floor(o/2);for(let l=0;l<a;++l){let u=t+l*n,c=t+(o-1-l)*n;for(let h=0;h<n;++h){let d=s[u+h];s[u+h]=s[c+h],s[c+h]=d}}}function Fi(s,e){let t=e.length,i=s.length;if(i>0){let n=!0;for(let o=0;o<t;o++)if(s[i-t+o]!==e[o]){n=!1;break}if(n)return!1}for(let n=0;n<t;n++)s[i+n]=e[n];return!0}function ap(s,e){let t=e.length;for(let i=0;i<t;i++)s[i]=e[i]}function Ja(s,e,t,i,n=[]){let o=i+e*t;for(let a=0;a<t;a++)n[a]=s[o+a];return n}function sP(s,e,t,i,n=[]){let o,a;if(t&8)o=(i[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(i[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(i[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(i[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)n[l]=(a&1)===l?i[a]:o*(e[l]-s[l])+s[l];return n}function lp(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function up(s,e){let{size:t=2,broken:i=!1,gridResolution:n=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e||{},u=(l-a)/t,c=[],h=[c],d=Ja(s,0,t,a),f,p,S=zO(d,n,o,[]),x=[];Fi(c,d);for(let T=1;T<u;T++){for(f=Ja(s,T,t,a,f),p=lp(f,S);p;){sP(d,f,p,S,x);let O=lp(x,S);O&&(sP(d,x,O,S,x),p=O),Fi(c,x),ap(d,x),r8(S,n,p),i&&c.length>t&&(c=[],h.push(c),Fi(c,d)),p=lp(f,S)}Fi(c,f),ap(d,f)}return i?h:h[0]}var VO=0,t8=1;function aP(s,e){for(let t=0;t<e.length;t++)s.push(e[t]);return s}function cp(s,e=null,t){if(!s.length)return[];let{size:i=2,gridResolution:n=10,gridOffset:o=[0,0],edgeTypes:a=!1}=t||{},l=[],u=[{pos:s,types:a?new Array(s.length/i).fill(t8):null,holes:e||[]}],c=[[],[]],h=[];for(;u.length;){let{pos:d,types:f,holes:p}=u.shift();i8(d,i,p[0]||d.length,c),h=zO(c[0],n,o,h);let S=lp(c[1],h);if(S){let x=kO(d,f,i,0,p[0]||d.length,h,S),T={pos:x[0].pos,types:x[0].types,holes:[]},O={pos:x[1].pos,types:x[1].types,holes:[]};u.push(T,O);for(let M=0;M<p.length;M++)x=kO(d,f,i,p[M],p[M+1]||d.length,h,S),x[0]&&(T.holes.push(T.pos.length),T.pos=aP(T.pos,x[0].pos),a&&(T.types=aP(T.types,x[0].types))),x[1]&&(O.holes.push(O.pos.length),O.pos=aP(O.pos,x[1].pos),a&&(O.types=aP(O.types,x[1].types)))}else{let x={positions:d};a&&(x.edgeTypes=f),p.length&&(x.holeIndices=p),l.push(x)}}return l}function kO(s,e,t,i,n,o,a){let l=(n-i)/t,u=[],c=[],h=[],d=[],f=[],p,S,x,T=Ja(s,l-1,t,i),O=Math.sign(a&8?T[1]-o[3]:T[0]-o[2]),M=e&&e[l-1],R=0,N=0;for(let H=0;H<l;H++)p=Ja(s,H,t,i,p),S=Math.sign(a&8?p[1]-o[3]:p[0]-o[2]),x=e&&e[i/t+H],S&&O&&O!==S&&(sP(T,p,a,o,f),Fi(u,f)&&h.push(M),Fi(c,f)&&d.push(M)),S<=0?(Fi(u,p)&&h.push(x),R-=S):h.length&&(h[h.length-1]=VO),S>=0?(Fi(c,p)&&d.push(x),N+=S):d.length&&(d[d.length-1]=VO),ap(T,p),O=S,M=x;return[R?{pos:u,types:e&&h}:null,N?{pos:c,types:e&&d}:null]}function zO(s,e,t,i){let n=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return i[0]=n,i[1]=o,i[2]=n+e,i[3]=o+e,i}function r8(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function i8(s,e,t,i){let n=1/0,o=-1/0,a=1/0,l=-1/0;for(let u=0;u<t;u+=e){let c=s[u],h=s[u+1];n=c<n?c:n,o=c>o?c:o,a=h<a?h:a,l=h>l?h:l}return i[0][0]=n,i[0][1]=a,i[1][0]=o,i[1][1]=l,i}var n8=85.051129;function Dx(s,e){let{size:t=2,startIndex:i=0,endIndex:n=s.length,normalize:o=!0}=e||{},a=s.slice(i,n);UO(a,t,0,n-i);let l=up(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)WO(u,t);return l}function Fx(s,e=null,t){let{size:i=2,normalize:n=!0,edgeTypes:o=!1}=t||{};e=e||[];let a=[],l=[],u=0,c=0;for(let d=0;d<=e.length;d++){let f=e[d]||s.length,p=c,S=o8(s,i,u,f);for(let x=S;x<f;x++)a[c++]=s[x];for(let x=u;x<S;x++)a[c++]=s[x];UO(a,i,p,c),s8(a,i,p,c,t?.maxLatitude),u=f,l[d]=c}l.pop();let h=cp(a,l,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:o});if(n)for(let d of h)WO(d.positions,i);return h}function o8(s,e,t,i){let n=-1,o=-1;for(let a=t+1;a<i;a+=e){let l=Math.abs(s[a]);l>n&&(n=l,o=a-1)}return o}function s8(s,e,t,i,n=n8){let o=s[t],a=s[i-e];if(Math.abs(o-a)>180){let l=Ja(s,0,e,t);l[0]+=Math.round((a-o)/360)*360,Fi(s,l),l[1]=Math.sign(l[1])*n,Fi(s,l),l[0]=o,Fi(s,l)}}function UO(s,e,t,i){let n=s[0],o;for(let a=t;a<i;a+=e){o=s[a];let l=o-n;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=n=o}}function WO(s,e){let t,i=s.length/e;for(let o=0;o<i&&(t=s[o*e],(t+180)%360===0);o++);let n=-Math.round(t/360)*360;if(n!==0)for(let o=0;o<i;o++)s[o*e]+=n}function HO(s,e,t,i){let n;if(Array.isArray(s[0])){let o=s.length*e;n=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)n[a*e+l]=s[a][l]||0}else n=s;return t?up(n,{size:e,gridResolution:t}):i?Dx(n,{size:e}):n}var l8=1,u8=2,Gx=4,lP=class extends Ou{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?HO(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(jO(e)){let i=0;for(let n of e)i+=this.getGeometrySize(n);return i}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&jO(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let i=this.attributes.segmentTypes,n=e?this.isClosed(e):!1,{vertexStart:o,geometrySize:a}=t;i.fill(0,o,o+a),n?(i[o]=Gx,i[o+a-2]=Gx):(i[o]+=l8,i[o+a-2]+=u8),i[o+a-1]=Gx}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i||!e)return;let{vertexStart:n,geometrySize:o}=t,a=new Array(3);for(let l=n,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),i[l*3]=a[0],i[l*3+1]=a[1],i[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);let o=t*n;return i[0]=e[o],i[1]=e[o+1],i[2]=n===3&&e[o+2]||0,i}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}};function jO(s){return Array.isArray(s[0])}var qO=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var XO=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var YO=[0,0,0,255],c8={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:YO},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Vx={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},Dh=class extends Jt{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:qO,fs:XO,modules:[li,In]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:Vx,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Vx,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:Vx,defaultValue:YO},instancePickingColors:{size:3,type:5121,accessor:(i,{index:n,target:o})=>this.encodePickingColor(i&&i.__source?i.__source.index:n,o)}}),this.setState({pathTesselator:new lP({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);let{props:t,changeFlags:i}=e,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),n.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:n,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:Vr[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};y(Dh,"defaultProps",c8);y(Dh,"layerName","PathLayer");var iR=me($O());var fP=nP.CLOCKWISE,eR=nP.COUNTER_CLOCKWISE,$a={isClosed:!0};function T8(s){if(s=s&&s.positions||s,!Array.isArray(s)&&!ArrayBuffer.isView(s))throw new Error("invalid polygon")}function Gh(s){return"positions"in s?s.positions:s}function pp(s){return"holeIndices"in s?s.holeIndices:null}function I8(s){return Array.isArray(s[0])}function w8(s){return s.length>=1&&s[0].length>=2&&Number.isFinite(s[0][0])}function L8(s){let e=s[0],t=s[s.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function O8(s,e,t,i){for(let n=0;n<e;n++)if(s[t+n]!==s[i-e+n])return!1;return!0}function tR(s,e,t,i,n){let o=e,a=t.length;for(let l=0;l<a;l++)for(let u=0;u<i;u++)s[o++]=t[l][u]||0;if(!L8(t))for(let l=0;l<i;l++)s[o++]=t[0][l]||0;return $a.start=e,$a.end=o,$a.size=i,sp(s,n,$a),o}function rR(s,e,t,i,n=0,o,a){o=o||t.length;let l=o-n;if(l<=0)return e;let u=e;for(let c=0;c<l;c++)s[u++]=t[n+c];if(!O8(t,i,n,o))for(let c=0;c<i;c++)s[u++]=t[n+c];return $a.start=e,$a.end=u,$a.size=i,sp(s,a,$a),u}function nR(s,e){T8(s);let t=[],i=[];if("positions"in s){let{positions:n,holeIndices:o}=s;if(o){let a=0;for(let l=0;l<=o.length;l++)a=rR(t,a,n,e,o[l-1],o[l],l===0?fP:eR),i.push(a);return i.pop(),{positions:t,holeIndices:i}}s=n}if(!I8(s))return rR(t,0,s,e,0,t.length,fP),t;if(!w8(s)){let n=0;for(let[o,a]of s.entries())n=tR(t,n,a,e,o===0?fP:eR),i.push(n);return i.pop(),{positions:t,holeIndices:i}}return tR(t,0,s,e,fP),t}function oR(s,e,t){let i=pp(s);i&&(i=i.map(o=>o/e));let n=Gh(s);if(t){let o=n.length;n=n.slice();let a=[];for(let l=0;l<o;l+=e){a[0]=n[l],a[1]=n[l+1];let u=t(a);n[l]=u[0],n[l+1]=u[1]}}return(0,iR.default)(n,i,e)}var pP=class extends Ou{constructor(e){let{fp64:t,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:i,size:1}}})}get(e){let{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);let t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){let t=nR(e,this.positionSize);return this.opts.resolution?cp(Gh(t),pp(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?Fx(Gh(t),pp(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(sR(e)){let t=0;for(let i of e)t+=this.getGeometrySize(i);return t}return Gh(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&sR(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n,t.indexStart=this.indexStarts[t.geometryIndex+1]}else this._updateIndices(e,t),this._updatePositions(e,t),this._updateVertexValid(e,t)}_updateIndices(e,{geometryIndex:t,vertexStart:i,indexStart:n}){let{attributes:o,indexStarts:a,typedArrayManager:l}=this,u=o.indices;if(!u||!e)return;let c=n,h=oR(e,this.positionSize,this.opts.preproject);u=l.allocate(u,n+h.length,{copy:!0});for(let d=0;d<h.length;d++)u[c++]=h[d]+i;a[t+1]=n+h.length,o.indices=u}_updatePositions(e,{vertexStart:t,geometrySize:i}){let{attributes:{positions:n},positionSize:o}=this;if(!n||!e)return;let a=Gh(e);for(let l=t,u=0;u<i;l++,u++){let c=a[u*o],h=a[u*o+1],d=o>2?a[u*o+2]:0;n[l*3]=c,n[l*3+1]=h,n[l*3+2]=d}}_updateVertexValid(e,{vertexStart:t,geometrySize:i}){let{positionSize:n}=this,o=this.attributes.vertexValid,a=e&&pp(e);if(e&&e.edgeTypes?o.set(e.edgeTypes,t):o.fill(1,t,t+i),a)for(let l=0;l<a.length;l++)o[t+a[l]/n-1]=0;o[t+i-1]=0}};function sR(s){return Array.isArray(s)&&s.length>0&&!Number.isFinite(s[0])}var gP=`
attribute vec2 vertexPositions;
attribute float vertexValid;

uniform bool extruded;
uniform bool isWireframe;
uniform float elevationScale;
uniform float opacity;

varying vec4 vColor;

struct PolygonProps {
  vec4 fillColors;
  vec4 lineColors;
  vec3 positions;
  vec3 nextPositions;
  vec3 pickingColors;
  vec3 positions64Low;
  vec3 nextPositions64Low;
  float elevations;
};

vec3 project_offset_normal(vec3 vector) {
  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
    // normals generated by the polygon tesselator are in lnglat offsets instead of meters
    return normalize(vector * project_uCommonUnitsPerWorldUnit);
  }
  return project_normal(vector);
}

void calculatePosition(PolygonProps props) {
#ifdef IS_SIDE_VERTEX
  if(vertexValid < 0.5){
    gl_Position = vec4(0.);
    return;
  }
#endif

  vec3 pos;
  vec3 pos64Low;
  vec3 normal;
  vec4 colors = isWireframe ? props.lineColors : props.fillColors;

  geometry.worldPosition = props.positions;
  geometry.worldPositionAlt = props.nextPositions;
  geometry.pickingColor = props.pickingColors;

#ifdef IS_SIDE_VERTEX
  pos = mix(props.positions, props.nextPositions, vertexPositions.x);
  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);
#else
  pos = props.positions;
  pos64Low = props.positions64Low;
#endif

  if (extruded) {
    pos.z += props.elevations * vertexPositions.y * elevationScale;
  }
  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  if (extruded) {
  #ifdef IS_SIDE_VERTEX
    normal = vec3(
      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),
      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),
      0.0);
    normal = project_offset_normal(normal);
  #else
    normal = project_normal(vec3(0.0, 0.0, 1.0));
  #endif
    geometry.normal = normal;
    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);
    vColor = vec4(lightColor, colors.a * opacity);
  } else {
    vColor = vec4(colors.rgb, colors.a * opacity);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var aR=`#define SHADER_NAME solid-polygon-layer-vertex-shader

attribute vec3 positions;
attribute vec3 positions64Low;
attribute float elevations;
attribute vec4 fillColors;
attribute vec4 lineColors;
attribute vec3 pickingColors;

`.concat(gP,`

void main(void) {
  PolygonProps props;

  props.positions = positions;
  props.positions64Low = positions64Low;
  props.elevations = elevations;
  props.fillColors = fillColors;
  props.lineColors = lineColors;
  props.pickingColors = pickingColors;

  calculatePosition(props);
}
`);var lR=`#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX


attribute vec3 instancePositions;
attribute vec3 nextPositions;
attribute vec3 instancePositions64Low;
attribute vec3 nextPositions64Low;
attribute float instanceElevations;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

`.concat(gP,`

void main(void) {
  PolygonProps props;

  #if RING_WINDING_ORDER_CW == 1
    props.positions = instancePositions;
    props.positions64Low = instancePositions64Low;
    props.nextPositions = nextPositions;
    props.nextPositions64Low = nextPositions64Low;
  #else
    props.positions = nextPositions;
    props.positions64Low = nextPositions64Low;
    props.nextPositions = instancePositions;
    props.nextPositions64Low = instancePositions64Low;
  #endif
  props.elevations = instanceElevations;
  props.fillColors = instanceFillColors;
  props.lineColors = instanceLineColors;
  props.pickingColors = instancePickingColors;

  calculatePosition(props);
}
`);var uR=`#define SHADER_NAME solid-polygon-layer-fragment-shader

precision highp float;

varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var bP=[0,0,0,255],_8={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:s=>s.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:bP},getLineColor:{type:"accessor",value:bP},material:!0},mP={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},Vh=class extends Jt{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(e){return super.getShaders({vs:e==="top"?aR:lR,fs:uR,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[li,mh,In]})}get wrapLongitude(){return!1}initializeState(){let{gl:e,viewport:t}=this.context,{coordinateSystem:i}=this.props;t.isGeospatial&&i===Ve.DEFAULT&&(i=Ve.LNGLAT),this.setState({numInstances:0,polygonTesselator:new pP({preproject:i===Ve.LNGLAT&&t.projectFlat.bind(t),fp64:this.use64bitPositions(),IndexType:!e||Da(e,tt.ELEMENT_INDEX_UINT32)?Uint32Array:Uint16Array})});let n=this.getAttributeManager(),o=!0;n.remove(["instancePickingColors"]),n.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:mP,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,transition:mP,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:mP,accessor:"getFillColor",defaultValue:bP,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:mP,accessor:"getLineColor",defaultValue:bP,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(a,{index:l,target:u})=>this.encodePickingColor(a&&a.__source?a.__source.index:l,u),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{extruded:t,filled:i,wireframe:n,elevationScale:o}=this.props,{topModel:a,sideModel:l,polygonTesselator:u}=this.state,c={...e,extruded:Boolean(t),elevationScale:o};l&&(l.setInstanceCount(u.instanceCount-1),l.setUniforms(c),n&&(l.setDrawMode(3),l.setUniforms({isWireframe:!0}).draw()),i&&(l.setDrawMode(6),l.setUniforms({isWireframe:!1}).draw())),a&&(a.setVertexCount(u.vertexCount),a.setUniforms(c).draw())}updateState(e){super.updateState(e),this.updateGeometry(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager();if(n.extensionsChanged||t.filled!==i.filled||t.extruded!==i.extruded){var l;(l=this.state.models)===null||l===void 0||l.forEach(u=>u.delete()),this.setState(this._getModels(this.context.gl)),o.invalidateAll()}}updateGeometry({props:e,oldProps:t,changeFlags:i}){if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon)){let{polygonTesselator:o}=this.state,a=e.data.attributes||{};o.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:a.getPolygon,buffers:a,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:i.dataChanged}),this.setState({numInstances:o.instanceCount,startIndices:o.vertexStarts}),i.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(e){let{id:t,filled:i,extruded:n}=this.props,o,a;if(i){let l=this.getShaders("top");l.defines.NON_INSTANCED_MODEL=1,o=new Gt(e,{...l,id:"".concat(t,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return n&&(a=new Gt(e,{...this.getShaders("side"),id:"".concat(t,"-side"),geometry:new Tr({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),a.userData.excludeAttributes={indices:!0}),{models:[a,o].filter(Boolean),topModel:o,sideModel:a}}calculateIndices(e){let{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){let{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}};y(Vh,"defaultProps",_8);y(Vh,"layerName","SolidPolygonLayer");function cR({data:s,getIndex:e,dataRange:t,replace:i}){let{startRow:n=0,endRow:o=1/0}=t,a=s.length,l=a,u=a;for(let f=0;f<a;f++){let p=e(s[f]);if(l>f&&p>=n&&(l=f),p>=o){u=f;break}}let c=l,d=u-l!==i.length?s.slice(u):void 0;for(let f=0;f<i.length;f++)s[c++]=i[f];if(d){for(let f=0;f<d.length;f++)s[c++]=d[f];s.length=c}return{startRow:l,endRow:l+i.length}}function hR(s,e){if(!s)return null;let t="startIndices"in s?s.startIndices[e]:e,i=s.featureIds.value[t];return t!==-1?M8(s,i,t):null}function M8(s,e,t){let i={properties:{...s.properties[e]}};for(let n in s.numericProps)i.properties[n]=s.numericProps[n].value[t];return i}function dR(s,e){let t={points:null,lines:null,polygons:null};for(let i in t){let n=s[i].globalFeatureIds.value;t[i]=new Uint8ClampedArray(n.length*3);let o=[];for(let a=0;a<n.length;a++)e(n[a],o),t[i][a*3+0]=o[0],t[i][a*3+1]=o[1],t[i][a*3+2]=o[2]}return t}var fR=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var pR=192/256,gR=[],N8={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},kh=class extends yo{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:fR}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:i,target:n})=>this.encodePickingColor(i,n)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map(o=>o/255),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&ce.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:pR,outlineBuffer:n?Math.max(i,pR*(1-n)):-1,gamma:i,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):gR}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):gR}};y(kh,"defaultProps",N8);y(kh,"layerName","MultiIconLayer");var TR=me(PR());var F8=32,G8=[];function V8(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function yR({characterSet:s,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:n,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a;for(let d of s)if(!o[d]){let f=e(d);c+f+i*2>n&&(c=0,u++),o[d]={x:c+i,y:l+u*(t+i*2)+i,width:f,height:t},c+=f+i*2}let h=t+i*2;return{mapping:o,xOffset:c,yOffset:l+u*h,canvasHeight:V8(l+(u+1)*h)}}function SR(s,e,t,i){let n=0;for(let a=e;a<t;a++){var o;let l=s[a];n+=((o=i[l])===null||o===void 0?void 0:o.width)||0}return n}function ER(s,e,t,i,n,o){let a=e,l=0;for(let u=e;u<t;u++){let c=SR(s,u,u+1,n);l+c>i&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function k8(s,e,t,i,n,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=SR(s,l,u,n);c+d>i&&(a<l&&(o.push(l),a=l,c=0),d>i&&(d=ER(s,l,u,i,n,o),a=o[o.length-1])),l=u,c+=d}return c}function z8(s,e,t,i,n=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?ER(s,n,o,t,i,a):k8(s,n,o,t,i,a),a}function U8(s,e,t,i,n,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=i[c];h?(l||(l=h.height),n[u]=a+h.width/2,a+=h.width):(ce.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),n[u]=a,a+=F8)}o[0]=a,o[1]=l}function jx(s,e,t,i,n){let o=Array.from(s),a=o.length,l=new Array(a),u=new Array(a),c=new Array(a),h=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,d=[0,0],f=[0,0],p=0,S=0,x=0;for(let T=0;T<=a;T++){let O=o[T];if((O===`
`||T===a)&&(x=T),x>S){let M=h?z8(o,t,i,n,S,x):G8;for(let R=0;R<=M.length;R++){let N=R===0?S:M[R-1],H=R<M.length?M[R]:x;U8(o,N,H,n,l,f);for(let Q=N;Q<H;Q++)u[Q]=p+f[1]/2,c[Q]=f[0];p=p+f[1]*e,d[0]=Math.max(d[0],f[0])}S=x}O===`
`&&(l[S]=0,u[S]=0,c[S]=0,S++)}return d[1]=p,{x:l,y:u,rowWidth:c,size:d}}function xR({value:s,length:e,stride:t,offset:i,startIndices:n,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=i?i/a:0,c=n[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),f=s;if(l>1||u>0){let p=s.constructor;f=new p(c);for(let S=0;S<c;S++)f[S]=s[S*l+u]}for(let p=0;p<e;p++){let S=n[p],x=n[p+1]||c,T=f.subarray(S,x);d[p]=String.fromCodePoint.apply(null,T),h&&T.forEach(h.add,h)}if(h)for(let p of h)o.add(String.fromCodePoint(p));return{texts:d,characterCount:c}}var mp=class{constructor(e=5){y(this,"limit",void 0),y(this,"_cache",{}),y(this,"_order",[]),this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function W8(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var Uh={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:W8(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},CR=1024,H8=.9,vR=1.2,IR=3,PP=new mp(IR);function j8(s,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);let i=PP.get(s);if(!i)return t;for(let n in i.mapping)t.has(n)&&t.delete(n);return t}function q8(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function AR(s,e,t,i){s.font="".concat(i," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="alphabetic",s.textAlign="left"}function wR(s){ce.assert(Number.isFinite(s)&&s>=IR,"Invalid cache limit"),PP=new mp(s)}var yP=class{constructor(){y(this,"props",{...Uh}),y(this,"_key",void 0),y(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return vR}setProps(e={}){Object.assign(this.props,e);let t=this._key;this._key=this._getKey();let i=j8(this._key,this.props.characterSet),n=PP.get(this._key);if(n&&i.size===0){this._key!==t&&(this._atlas=n);return}let o=this._generateFontAtlas(this._key,i,n);this._atlas=o,PP.set(this._key,o)}_generateFontAtlas(e,t,i){let{fontFamily:n,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=i&&i.data;d||(d=document.createElement("canvas"),d.width=CR);let f=d.getContext("2d");AR(f,n,a,o);let{mapping:p,canvasHeight:S,xOffset:x,yOffset:T}=yR({getFontWidth:O=>f.measureText(O).width,fontHeight:a*vR,buffer:l,characterSet:t,maxCanvasWidth:CR,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(d.height!==S){let O=f.getImageData(0,0,d.width,d.height);d.height=S,f.putImageData(O,0,0)}if(AR(f,n,a,o),u){let O=new TR.default(a,l,c,h,n,o),M=f.getImageData(0,0,O.size,O.size);for(let R of t)q8(O.draw(R),M),f.putImageData(M,p[R].x-l,p[R].y+l)}else for(let O of t)f.fillText(O,p[O].x,p[O].y+a*H8);return{xOffset:x,yOffset:T,mapping:p,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}};var LR=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var OR=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var X8={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},Wh=class extends Jt{constructor(...e){super(...e);y(this,"state",void 0)}getShaders(){return super.getShaders({vs:LR,fs:OR,modules:[li,In]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;if(t.extensionsChanged){var i;let{gl:n}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(n),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:Vr[n],sizeScale:i,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Wh,"defaultProps",X8);y(Wh,"layerName","TextBackgroundLayer");var RR={start:1,middle:0,end:-1},_R={top:1,center:0,bottom:-1},qx=[0,0,0,255],Y8=1,K8={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:qx},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:Uh.characterSet},fontFamily:Uh.fontFamily,fontWeight:Uh.fontWeight,lineHeight:Y8,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:qx},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:qx},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},nn=class extends Di{constructor(...e){super(...e);y(this,"state",void 0),y(this,"getBoundingRect",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{size:[f,p]}=jx(d,u,a,l,n),S=RR[typeof c=="function"?c(t,i):c],x=_R[typeof h=="function"?h(t,i):h];return[(S-1)*f/2,(x-1)*p/2,f,p]}),y(this,"getIconOffsets",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{x:f,y:p,rowWidth:S,size:[x,T]}=jx(d,u,a,l,n),O=RR[typeof c=="function"?c(t,i):c],M=_R[typeof h=="function"?h(t,i):h],R=f.length,N=new Array(R*2),H=0;for(let Q=0;Q<R;Q++){let ne=(1-O)*(x-S[Q])/2;N[H++]=(O-1)*x/2+ne+f[Q],N[H++]=(M-1)*T/2+p[Q]}return N})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new yP}}updateState(e){let{props:t,oldProps:i,changeFlags:n}=e;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:o}=this.state,a={...e,characterSet:o,fontFamily:t,fontWeight:i};if(!n.mapping)return n.setProps(a),!0;for(let l in a)if(a[l]!==n.props[l])return n.setProps(a),!0;return!1}_updateText(){var e;let{data:t,characterSet:i}=this.props,n=(e=t.attributes)===null||e===void 0?void 0:e.getText,{getText:o}=this.props,a=t.startIndices,l,u=i==="auto"&&new Set;if(n&&a){let{texts:c,characterCount:h}=xR({...ArrayBuffer.isView(n)?{value:n}:n,length:t.length,startIndices:a,characterSet:u});l=h,o=(d,{index:f})=>c[f]}else{let{iterable:c,objectInfo:h}=Po(t);a=[0],l=0;for(let d of c){h.index++;let f=Array.from(o(d,h)||"");u&&f.forEach(u.add,u),l+=f.length,a.push(l)}}this.setState({getText:o,startIndices:a,numInstances:l,characterSet:u||i})}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,getBackgroundColor:x,getBorderColor:T,getBorderWidth:O,backgroundPadding:M,background:R,billboard:N,fontSettings:H,outlineWidth:Q,outlineColor:ne,sizeScale:he,sizeUnits:se,sizeMinPixels:oe,sizeMaxPixels:ge,transitions:Pe,updateTriggers:pe}=this.props,Ue=this.getSubLayerClass("characters",kh),ui=this.getSubLayerClass("background",Wh);return[R&&new ui({getFillColor:x,getLineColor:T,getLineWidth:O,padding:M,getPosition:h,getSize:f,getAngle:p,getPixelOffset:S,billboard:N,sizeScale:he/this.state.fontAtlasManager.props.fontSize,sizeUnits:se,sizeMinPixels:oe,sizeMaxPixels:ge,transitions:Pe&&{getPosition:Pe.getPosition,getAngle:Pe.getAngle,getSize:Pe.getSize,getFillColor:Pe.getBackgroundColor,getLineColor:Pe.getBorderColor,getLineWidth:Pe.getBorderWidth,getPixelOffset:Pe.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:pe.getPosition,getAngle:pe.getAngle,getSize:pe.getSize,getFillColor:pe.getBackgroundColor,getLineColor:pe.getBorderColor,getLineWidth:pe.getBorderWidth,getPixelOffset:pe.getPixelOffset,getBoundingRect:{getText:pe.getText,getTextAnchor:pe.getTextAnchor,getAlignmentBaseline:pe.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new Ue({sdf:H.sdf,smoothing:Number.isFinite(H.smoothing)?H.smoothing:Uh.smoothing,outlineWidth:Q,outlineColor:ne,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,billboard:N,sizeScale:he*n,sizeUnits:se,sizeMinPixels:oe*n,sizeMaxPixels:ge*n,transitions:Pe&&{getPosition:Pe.getPosition,getAngle:Pe.getAngle,getColor:Pe.getColor,getSize:Pe.getSize,getPixelOffset:Pe.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:pe.getText,getPosition:pe.getPosition,getAngle:pe.getAngle,getColor:pe.getColor,getSize:pe.getSize,getPixelOffset:pe.getPixelOffset,getIconOffsets:{getText:pe.getText,getTextAnchor:pe.getTextAnchor,getAlignmentBaseline:pe.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){wR(e)}};y(nn,"defaultProps",K8);y(nn,"layerName","TextLayer");var bp={circle:{type:Bh,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:yo,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:nn,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Pp={type:Dh,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},SP={type:Vh,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function Hh({type:s,props:e}){let t={};for(let i in e)t[i]=s.defaultProps[e[i]];return t}function EP(s,e){let{transitions:t,updateTriggers:i}=s.props,n={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(let o in e){let a=e[o],l=s.props[o];o.startsWith("get")&&(l=s.getSubLayerAccessor(l),n.updateTriggers[a]=i[o],t&&(n.transitions[a]=t[o])),n[a]=l}return n}function NR(s){if(Array.isArray(s))return s;switch(ce.assert(s.type,"GeoJSON does not have type"),s.type){case"Feature":return[s];case"FeatureCollection":return ce.assert(Array.isArray(s.features),"GeoJSON does not have features array"),s.features;default:return[{geometry:s}]}}function Xx(s,e,t={}){let i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:n=0,endRow:o=s.length}=t;for(let a=n;a<o;a++){let l=s[a];ce.assert(l&&l.geometry,"GeoJSON does not have geometry");let{geometry:u}=l;if(u.type==="GeometryCollection"){ce.assert(Array.isArray(u.geometries),"GeoJSON does not have geometries array");let{geometries:c}=u;for(let h=0;h<c.length;h++){let d=c[h];MR(d,i,e,l,a)}}else MR(u,i,e,l,a)}return i}function MR(s,e,t,i,n){let{type:o,coordinates:a}=s,{pointFeatures:l,lineFeatures:u,polygonFeatures:c,polygonOutlineFeatures:h}=e;if(!Q8(o,a)){ce.warn("".concat(o," coordinates are malformed"))();return}switch(o){case"Point":l.push(t({geometry:s},i,n));break;case"MultiPoint":a.forEach(d=>{l.push(t({geometry:{type:"Point",coordinates:d}},i,n))});break;case"LineString":u.push(t({geometry:s},i,n));break;case"MultiLineString":a.forEach(d=>{u.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"Polygon":c.push(t({geometry:s},i,n)),a.forEach(d=>{h.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"MultiPolygon":a.forEach(d=>{c.push(t({geometry:{type:"Polygon",coordinates:d}},i,n)),d.forEach(f=>{h.push(t({geometry:{type:"LineString",coordinates:f}},i,n))})});break;default:}}var Z8={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function Q8(s,e){let t=Z8[s];for(ce.assert(t,"Unknown GeoJSON type ".concat(s));e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function BR(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function xP(s){return s.geometry.coordinates}function DR(s,e){let t=BR(),{pointFeatures:i,lineFeatures:n,polygonFeatures:o,polygonOutlineFeatures:a}=s;return t.points.data=i,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=xP,t.lines.data=n,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=xP,t.polygons.data=o,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=xP,t.polygonsOutline.data=a,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=xP,t}function FR(s,e){let t=BR(),{points:i,lines:n,polygons:o}=s,a=dR(s,e);return t.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:3,value:a.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},t.lines.data={length:n.pathIndices.value.length-1,startIndices:n.pathIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:3,value:a.lines}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},t.lines._pathType="open",t.polygons.data={length:o.polygonIndices.value.length-1,startIndices:o.polygonIndices.value,attributes:{...o.attributes,getPolygon:o.positions,pickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygons._normalize=!1,o.triangles&&(t.polygons.data.attributes.indices=o.triangles.value),t.polygonsOutline.data={length:o.primitivePolygonIndices.value.length-1,startIndices:o.primitivePolygonIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygonsOutline._pathType="open",t}var J8=["points","linestrings","polygons"],$8={...Hh(bp.circle),...Hh(bp.icon),...Hh(bp.text),...Hh(Pp),...Hh(SP),stroked:!0,filled:!0,extruded:!1,wireframe:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:s=>s.properties.icon},getText:{type:"accessor",value:s=>s.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}},_u=class extends Di{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;let{data:i}=this.props,n=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:n}),n?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){let i=FR(e.data,this.encodePickingColor);this.setState({layerProps:i})}_updateStateJSON({props:e,changeFlags:t}){let i=NR(e.data),n=this.getSubLayerRow.bind(this),o={},a={};if(Array.isArray(t.dataChanged)){let u=this.state.features;for(let c in u)o[c]=u[c].slice(),a[c]=[];for(let c of t.dataChanged){let h=Xx(i,n,c);for(let d in u)a[d].push(cR({data:o[d],getIndex:f=>f.__source.index,dataRange:c,replace:h[d]}))}}else o=Xx(i,n);let l=DR(o,a);this.setState({features:o,featuresDiff:a,layerProps:l})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i,sourceLayer:n}=t;return t.featureType=J8.find(o=>n.id.startsWith("".concat(this.id,"-").concat(o,"-"))),i>=0&&n.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[i]),t}_updateAutoHighlight(e){let t="".concat(this.id,"-points-"),i=e.featureType==="points";for(let n of this.getSubLayers())n.id.startsWith(t)===i&&n.updateAutoHighlight(e)}_renderPolygonLayer(){let{extruded:e,wireframe:t}=this.props,{layerProps:i}=this.state,n="polygons-fill",o=this.shouldRenderSubLayer(n,i.polygons.data)&&this.getSubLayerClass(n,SP.type);if(o){let a=EP(this,SP.props),l=e&&t;return l||delete a.getLineColor,a.updateTriggers.lineColors=l,new o(a,this.getSubLayerProps({id:n,updateTriggers:a.updateTriggers}),i.polygons)}return null}_renderLineLayers(){let{extruded:e,stroked:t}=this.props,{layerProps:i}=this.state,n="polygons-stroke",o="linestrings",a=!e&&t&&this.shouldRenderSubLayer(n,i.polygonsOutline.data)&&this.getSubLayerClass(n,Pp.type),l=this.shouldRenderSubLayer(o,i.lines.data)&&this.getSubLayerClass(o,Pp.type);if(a||l){let u=EP(this,Pp.props);return[a&&new a(u,this.getSubLayerProps({id:n,updateTriggers:u.updateTriggers}),i.polygonsOutline),l&&new l(u,this.getSubLayerProps({id:o,updateTriggers:u.updateTriggers}),i.lines)]}return null}_renderPointLayers(){let{pointType:e}=this.props,{layerProps:t,binary:i}=this.state,{highlightedObjectIndex:n}=this.props;!i&&Number.isFinite(n)&&(n=t.points.data.findIndex(l=>l.__source.index===n));let o=new Set(e.split("+")),a=[];for(let l of o){let u="points-".concat(l),c=bp[l],h=c&&this.shouldRenderSubLayer(u,t.points.data)&&this.getSubLayerClass(u,c.type);if(h){let d=EP(this,c.props),f=t.points;if(l==="text"&&i){let{instancePickingColors:p,...S}=f.data.attributes;f={...f,data:{...f.data,attributes:S}}}a.push(new h(d,this.getSubLayerProps({id:u,updateTriggers:d.updateTriggers,highlightedObjectIndex:n}),f))}}return a}renderLayers(){let{extruded:e}=this.props,t=this._renderPolygonLayer(),i=this._renderLineLayers(),n=this._renderPointLayers();return[!e&&t,i,n,e&&t]}getSubLayerAccessor(e){let{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(i,n)=>{let{data:o,index:a}=n,l=hR(o,a);return e(l,n)}}};y(_u,"layerName","GeoJsonLayer");y(_u,"defaultProps",$8);var CP=class{constructor(e){y(this,"index",void 0),y(this,"isVisible",void 0),y(this,"isSelected",void 0),y(this,"parent",void 0),y(this,"children",void 0),y(this,"content",void 0),y(this,"state",void 0),y(this,"layers",void 0),y(this,"id",void 0),y(this,"bbox",void 0),y(this,"zoom",void 0),y(this,"userData",void 0),y(this,"_abortController",void 0),y(this,"_loader",void 0),y(this,"_loaderId",void 0),y(this,"_isLoaded",void 0),y(this,"_isCancelled",void 0),y(this,"_needsReload",void 0),this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return Boolean(this._loader)&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){let e=this.content?this.content.byteLength:0;return Number.isFinite(e)||ce.error("byteLength not defined in tile data")(),e}async _loadData({getData:e,requestScheduler:t,onLoad:i,onError:n}){let{index:o,id:a,bbox:l,userData:u,zoom:c}=this,h=this._loaderId;this._abortController=new AbortController;let{signal:d}=this._abortController,f=await t.scheduleRequest(this,x=>x.isSelected?1:-1);if(!f){this._isCancelled=!0;return}if(this._isCancelled){f.done();return}let p=null,S;try{p=await e({index:o,id:a,bbox:l,userData:u,zoom:c,signal:d})}catch(x){S=x||!0}finally{f.done()}if(h===this._loaderId){if(this._loader=void 0,this.content=p,this._isCancelled&&!p){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,S?n(S,this):i(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){var e;this.isLoaded||(this._isCancelled=!0,(e=this._abortController)===null||e===void 0||e.abort())}};var $t={OUTSIDE:-1,INTERSECTING:0,INSIDE:1};var GR=new ee,ez=new ee,el=class{constructor(e=[0,0,0],t=[0,0,0],i){y(this,"center",void 0),y(this,"halfDiagonal",void 0),y(this,"minimum",void 0),y(this,"maximum",void 0),i=i||GR.copy(e).add(t).scale(.5),this.center=new ee(i),this.halfDiagonal=new ee(t).subtract(this.center),this.minimum=new ee(e),this.maximum=new ee(t)}clone(){return new el(this.minimum,this.maximum,this.center)}equals(e){return this===e||Boolean(e)&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){let{halfDiagonal:t}=this,i=ez.from(e.normal),n=t.x*Math.abs(i.x)+t.y*Math.abs(i.y)+t.z*Math.abs(i.z),o=this.center.dot(i)+e.distance;return o-n>0?$t.INSIDE:o+n<0?$t.OUTSIDE:$t.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=GR.from(e).subtract(this.center),{halfDiagonal:i}=this,n=0,o;return o=Math.abs(t.x)-i.x,o>0&&(n+=o*o),o=Math.abs(t.y)-i.y,o>0&&(n+=o*o),o=Math.abs(t.z)-i.z,o>0&&(n+=o*o),n}};var yp=new ee,VR=new ee,tl=class{constructor(e=[0,0,0],t=0){y(this,"center",void 0),y(this,"radius",void 0),this.radius=-0,this.center=new ee,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=yp.from(t),this.center=new ee().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new tl(this.center,this.radius)}union(e){let t=this.center,i=this.radius,n=e.center,o=e.radius,a=yp.copy(n).subtract(t),l=a.magnitude();if(i>=l+o)return this.clone();if(o>=l+i)return e.clone();let u=(i+l+o)*.5;return VR.copy(a).scale((-i+u)/l).add(t),this.center.copy(VR),this.radius=u,this}expand(e){let i=yp.from(e).subtract(this.center).magnitude();return i>this.radius&&(this.radius=i),this}transform(e){this.center.transform(e);let t=Pw(yp,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){let t=this.distanceTo(e);return t*t}distanceTo(e){let i=yp.from(e).subtract(this.center);return Math.max(0,i.len()-this.radius)}intersectPlane(e){let t=this.center,i=this.radius,o=e.normal.dot(t)+e.distance;return o<-i?$t.OUTSIDE:o<i?$t.INTERSECTING:$t.INSIDE}};var tz=new ee,rz=new ee,vP=new ee,AP=new ee,TP=new ee,iz=new ee,nz=new ee,Ws={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8},Mu=class{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){y(this,"center",void 0),y(this,"halfAxes",void 0),this.center=new ee().from(e),this.halfAxes=new Ft(t)}get halfSize(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new ee(e).len(),new ee(t).len(),new ee(i).len()]}get quaternion(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),n=new ee(e).normalize(),o=new ee(t).normalize(),a=new ee(i).normalize();return new gh().fromMatrix3(new Ft([...n,...o,...a]))}fromCenterHalfSizeQuaternion(e,t,i){let n=new gh(i),o=new Ft().fromQuaternion(n);return o[0]=o[0]*t[0],o[1]=o[1]*t[0],o[2]=o[2]*t[0],o[3]=o[3]*t[1],o[4]=o[4]*t[1],o[5]=o[5]*t[1],o[6]=o[6]*t[2],o[7]=o[7]*t[2],o[8]=o[8]*t[2],this.center=new ee().from(e),this.halfAxes=o,this}clone(){return new Mu(this.center,this.halfAxes)}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new tl){let t=this.halfAxes,i=t.getColumn(0,vP),n=t.getColumn(1,AP),o=t.getColumn(2,TP),a=tz.copy(i).add(n).add(o);return e.center.copy(this.center),e.radius=a.magnitude(),e}intersectPlane(e){let t=this.center,i=e.normal,n=this.halfAxes,o=i.x,a=i.y,l=i.z,u=Math.abs(o*n[Ws.COLUMN0ROW0]+a*n[Ws.COLUMN0ROW1]+l*n[Ws.COLUMN0ROW2])+Math.abs(o*n[Ws.COLUMN1ROW0]+a*n[Ws.COLUMN1ROW1]+l*n[Ws.COLUMN1ROW2])+Math.abs(o*n[Ws.COLUMN2ROW0]+a*n[Ws.COLUMN2ROW1]+l*n[Ws.COLUMN2ROW2]),c=i.dot(t)+e.distance;return c<=-u?$t.OUTSIDE:c>=u?$t.INSIDE:$t.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=rz.from(e).subtract(this.center),i=this.halfAxes,n=i.getColumn(0,vP),o=i.getColumn(1,AP),a=i.getColumn(2,TP),l=n.magnitude(),u=o.magnitude(),c=a.magnitude();n.normalize(),o.normalize(),a.normalize();let h=0,d;return d=Math.abs(t.dot(n))-l,d>0&&(h+=d*d),d=Math.abs(t.dot(o))-u,d>0&&(h+=d*d),d=Math.abs(t.dot(a))-c,d>0&&(h+=d*d),h}computePlaneDistances(e,t,i=[-0,-0]){let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=this.center,l=this.halfAxes,u=l.getColumn(0,vP),c=l.getColumn(1,AP),h=l.getColumn(2,TP),d=iz.copy(u).add(c).add(h).add(a),f=nz.copy(d).subtract(e),p=t.dot(f);return n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),i[0]=n,i[1]=o,i}transform(e){this.center.transformAsPoint(e);let t=this.halfAxes.getColumn(0,vP);t.transformAsPoint(e);let i=this.halfAxes.getColumn(1,AP);i.transformAsPoint(e);let n=this.halfAxes.getColumn(2,TP);return n.transformAsPoint(e),this.halfAxes=new Ft([...t,...i,...n]),this}getTransform(){throw new Error("not implemented")}};var kR=new ee,zR=new ee,Ln=class{constructor(e=[0,0,1],t=0){y(this,"normal",void 0),y(this,"distance",void 0),this.normal=new ee,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return oo(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=kR.from(e),this.normal.from(t).normalize();let i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,n){return this.normal.set(e,t,i),oo(Fr(this.normal.len(),1)),this.distance=n,this}clone(){return new Ln(this.normal,this.distance)}equals(e){return Fr(this.distance,e.distance)&&Fr(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){let t=zR.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){e=kR.from(e);let i=this.getPointDistance(e),n=zR.copy(this.normal).scale(i);return e.subtract(n).to(t)}};var UR=[new ee([1,0,0]),new ee([0,1,0]),new ee([0,0,1])],WR=new ee,oz=new ee,MDe=new Ln(new ee(1,0,0),0),Gi=class{constructor(e=[]){y(this,"planes",void 0),this.planes=e}fromBoundingSphere(e){this.planes.length=2*UR.length;let t=e.center,i=e.radius,n=0;for(let o of UR){let a=this.planes[n],l=this.planes[n+1];a||(a=this.planes[n]=new Ln),l||(l=this.planes[n+1]=new Ln);let u=WR.copy(o).scale(-i).add(t),c=-o.dot(u);a.fromPointNormal(u,o);let h=WR.copy(o).scale(i).add(t),d=oz.copy(o).negate(),f=-d.dot(h);l.fromPointNormal(h,d),n+=2}return this}computeVisibility(e){let t=$t.INSIDE;for(let i of this.planes)switch(e.intersectPlane(i)){case $t.OUTSIDE:return $t.OUTSIDE;case $t.INTERSECTING:t=$t.INTERSECTING;break;default:}return t}computeVisibilityWithPlaneMask(e,t){if(oo(Number.isFinite(t),"parentPlaneMask is required."),t===Gi.MASK_OUTSIDE||t===Gi.MASK_INSIDE)return t;let i=Gi.MASK_INSIDE,n=this.planes;for(let o=0;o<this.planes.length;++o){let a=o<31?1<<o:0;if(o<31&&(t&a)===0)continue;let l=n[o],u=e.intersectPlane(l);if(u===$t.OUTSIDE)return Gi.MASK_OUTSIDE;u===$t.INTERSECTING&&(i|=a)}return i}};y(Gi,"MASK_OUTSIDE",4294967295);y(Gi,"MASK_INSIDE",0);y(Gi,"MASK_INDETERMINATE",2147483647);var VDe=new ee,kDe=new ee,zDe=new ee,UDe=new ee,WDe=new ee;var ZDe=new ee,QDe=new ee,JDe=new ee,$De=new ee,eFe=new ee,tFe=new ee,rFe=new ee,iFe=new ee,nFe=new ee,oFe=new ee,sFe=new ee,aFe=new ee,lFe=4/3*Math.PI;var ns=new Ft,az=new Ft,lz=new Ft,IP=new Ft,HR=new Ft;function wP(s,e={}){let t=tb.EPSILON20,i=10,n=0,o=0,a=az,l=lz;a.identity(),l.copy(s);let u=t*uz(l);for(;o<i&&cz(l)>u;)hz(l,IP),HR.copy(IP).transpose(),l.multiplyRight(IP),l.multiplyLeft(HR),a.multiplyRight(IP),++n>2&&(++o,n=0);return e.unitary=a.toTarget(e.unitary),e.diagonal=l.toTarget(e.diagonal),e}function uz(s){let e=0;for(let t=0;t<9;++t){let i=s[t];e+=i*i}return Math.sqrt(e)}var Yx=[1,0,0],Kx=[2,2,1];function cz(s){let e=0;for(let t=0;t<3;++t){let i=s[ns.getElementIndex(Kx[t],Yx[t])];e+=2*i*i}return Math.sqrt(e)}function hz(s,e){let t=tb.EPSILON15,i=0,n=1;for(let c=0;c<3;++c){let h=Math.abs(s[ns.getElementIndex(Kx[c],Yx[c])]);h>i&&(n=c,i=h)}let o=Yx[n],a=Kx[n],l=1,u=0;if(Math.abs(s[ns.getElementIndex(a,o)])>t){let c=s[ns.getElementIndex(a,a)],h=s[ns.getElementIndex(o,o)],d=s[ns.getElementIndex(a,o)],f=(c-h)/2/d,p;f<0?p=-1/(-f+Math.sqrt(1+f*f)):p=1/(f+Math.sqrt(1+f*f)),l=1/Math.sqrt(1+p*p),u=p*l}return Ft.IDENTITY.to(e),e[ns.getElementIndex(o,o)]=e[ns.getElementIndex(a,a)]=l,e[ns.getElementIndex(a,o)]=u,e[ns.getElementIndex(o,a)]=-u,e}var rl=new ee,dz=new ee,fz=new ee,pz=new ee,gz=new ee,mz=new Ft,bz={diagonal:new Ft,unitary:new Ft};function Zx(s,e=new Mu){if(!s||s.length===0)return e.halfAxes=new Ft([0,0,0,0,0,0,0,0,0]),e.center=new ee,e;let t=s.length,i=new ee(0,0,0);for(let se of s)i.add(se);let n=1/t;i.multiplyByScalar(n);let o=0,a=0,l=0,u=0,c=0,h=0;for(let se of s){let oe=rl.copy(se).subtract(i);o+=oe.x*oe.x,a+=oe.x*oe.y,l+=oe.x*oe.z,u+=oe.y*oe.y,c+=oe.y*oe.z,h+=oe.z*oe.z}o*=n,a*=n,l*=n,u*=n,c*=n,h*=n;let d=mz;d[0]=o,d[1]=a,d[2]=l,d[3]=a,d[4]=u,d[5]=c,d[6]=l,d[7]=c,d[8]=h;let{unitary:f}=wP(d,bz),p=e.halfAxes.copy(f),S=p.getColumn(0,fz),x=p.getColumn(1,pz),T=p.getColumn(2,gz),O=-Number.MAX_VALUE,M=-Number.MAX_VALUE,R=-Number.MAX_VALUE,N=Number.MAX_VALUE,H=Number.MAX_VALUE,Q=Number.MAX_VALUE;for(let se of s)rl.copy(se),O=Math.max(rl.dot(S),O),M=Math.max(rl.dot(x),M),R=Math.max(rl.dot(T),R),N=Math.min(rl.dot(S),N),H=Math.min(rl.dot(x),H),Q=Math.min(rl.dot(T),Q);S=S.multiplyByScalar(.5*(N+O)),x=x.multiplyByScalar(.5*(H+M)),T=T.multiplyByScalar(.5*(Q+R)),e.center.copy(S).add(x).add(T);let ne=dz.set(O-N,M-H,R-Q).multiplyByScalar(.5),he=new Ft([ne[0],0,0,0,ne[1],0,0,0,ne[2]]);return e.halfAxes.multiplyRight(he),e}var jh=512,jR=3,qR=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],XR=qR.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),Pz=XR.concat([[.25,.5],[.75,.5]]),Nu=class{constructor(e,t,i){y(this,"x",void 0),y(this,"y",void 0),y(this,"z",void 0),y(this,"childVisible",void 0),y(this,"selected",void 0),y(this,"_children",void 0),this.x=e,this.y=t,this.z=i}get children(){if(!this._children){let e=this.x*2,t=this.y*2,i=this.z+1;this._children=[new Nu(e,t,i),new Nu(e,t+1,i),new Nu(e+1,t,i),new Nu(e+1,t+1,i)]}return this._children}update(e){let{viewport:t,cullingVolume:i,elevationBounds:n,minZ:o,maxZ:a,bounds:l,offset:u,project:c}=e,h=this.getBoundingVolume(n,u,c);if(l&&!this.insideBounds(l)||i.computeVisibility(h)<0)return!1;if(!this.childVisible){let{z:f}=this;if(f<a&&f>=o){let p=h.distanceTo(t.cameraPosition)*t.scale/t.height;f+=Math.floor(Math.log2(p))}if(f>=a)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(let f of this.children)f.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(let t of this._children)t.getSelected(e);return e}insideBounds([e,t,i,n]){let o=Math.pow(2,this.z),a=jh/o;return this.x*a<i&&this.y*a<n&&(this.x+1)*a>e&&(this.y+1)*a>t}getBoundingVolume(e,t,i){if(i){let u=this.z<1?Pz:this.z<2?XR:qR,c=[];for(let h of u){let d=LP(this.x+h[0],this.y+h[1],this.z);d[2]=e[0],c.push(i(d)),e[0]!==e[1]&&(d[2]=e[1],c.push(i(d)))}return Zx(c)}let n=Math.pow(2,this.z),o=jh/n,a=this.x*o+t*jh,l=jh-(this.y+1)*o;return new el([a,l,e[0]],[a+o,l+o,e[1]])}};function YR(s,e,t,i){let n=s instanceof np&&s.resolution?s.projectPosition:null,o=Object.values(s.getFrustumPlanes()).map(({normal:p,distance:S})=>new Ln(p.clone().negate(),S)),a=new Gi(o),l=s.distanceScales.unitsPerMeter[2],u=t&&t[0]*l||0,c=t&&t[1]*l||0,h=s instanceof kr&&s.pitch<=60?e:0;if(i){let[p,S,x,T]=i,O=Tn([p,T]),M=Tn([x,S]);i=[O[0],jh-O[1],M[0],jh-M[1]]}let d=new Nu(0,0,0),f={viewport:s,project:n,cullingVolume:a,elevationBounds:[u,c],minZ:h,maxZ:e,bounds:i,offset:0};if(d.update(f),s instanceof kr&&s.subViewports&&s.subViewports.length>1){for(f.offset=-1;d.update(f)&&!(--f.offset<-jR););for(f.offset=1;d.update(f)&&!(++f.offset>jR););}return d.getSelected()}var Hs=512,yz=[-1/0,-1/0,1/0,1/0],ZR={type:"url",value:null,validate:(s,e)=>e.optional&&s===null||typeof s=="string"||Array.isArray(s)&&s.every(t=>typeof t=="string"),equals:(s,e)=>{if(s===e)return!0;if(!Array.isArray(s)||!Array.isArray(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}};function QR(s,e){let t=[e.transformAsPoint([s[0],s[1]]),e.transformAsPoint([s[2],s[1]]),e.transformAsPoint([s[0],s[3]]),e.transformAsPoint([s[2],s[3]])];return[Math.min(...t.map(n=>n[0])),Math.min(...t.map(n=>n[1])),Math.max(...t.map(n=>n[0])),Math.max(...t.map(n=>n[1]))]}function Sz(s){return Math.abs(s.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function JR(s,e){if(!s||!s.length)return null;let{index:t,id:i}=e;if(Array.isArray(s)){let o=Sz(i)%s.length;s=s[o]}let n=s;for(let o of Object.keys(t)){let a=new RegExp("{".concat(o,"}"),"g");n=n.replace(a,String(t[o]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(n=n.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),n}function Ez(s,e,t){let i;if(e&&e.length===2){let[n,o]=e,a=s.getBounds({z:n}),l=s.getBounds({z:o});i=[Math.min(a[0],l[0]),Math.min(a[1],l[1]),Math.max(a[2],l[2]),Math.max(a[3],l[3])]}else i=s.getBounds();return s.isGeospatial?[Math.max(i[0],t[0]),Math.max(i[1],t[1]),Math.min(i[2],t[2]),Math.min(i[3],t[3])]:[Math.max(Math.min(i[0],t[2]),t[0]),Math.max(Math.min(i[1],t[3]),t[1]),Math.min(Math.max(i[2],t[0]),t[2]),Math.min(Math.max(i[3],t[1]),t[3])]}function Sp({viewport:s,z:e,cullRect:t}){let i=t.x-s.x,n=t.y-s.y,{width:o,height:a}=t;if(!Array.isArray(e)){let c={targetZ:e||0},h=s.unproject([i,n],c),d=s.unproject([i+o,n],c),f=s.unproject([i,n+a],c),p=s.unproject([i+o,n+a],c);return[Math.min(h[0],d[0],f[0],p[0]),Math.min(h[1],d[1],f[1],p[1]),Math.max(h[0],d[0],f[0],p[0]),Math.max(h[1],d[1],f[1],p[1])]}let l=Sp({viewport:s,z:e[0],cullRect:t}),u=Sp({viewport:s,z:e[1],cullRect:t});return[Math.min(l[0],u[0]),Math.min(l[1],u[1]),Math.max(l[2],u[2]),Math.max(l[3],u[3])]}function xz(s,e,t){return t?QR(s,t).map(n=>n*e/Hs):s.map(i=>i*e/Hs)}function Qx(s,e){return Math.pow(2,s)*Hs/e}function LP(s,e,t){let i=Qx(t,Hs),n=s/i*360-180,o=Math.PI-2*Math.PI*e/i,a=180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)));return[n,a]}function KR(s,e,t,i){let n=Qx(t,i);return[s/n*Hs,e/n*Hs]}function $R(s,e,t,i,n=Hs){if(s.isGeospatial){let[c,h]=LP(e,t,i),[d,f]=LP(e+1,t+1,i);return{west:c,north:h,east:d,south:f}}let[o,a]=KR(e,t,i,n),[l,u]=KR(e+1,t+1,i,n);return{left:o,top:a,right:l,bottom:u}}function Cz(s,e,t,i,n){let o=Ez(s,null,i),a=Qx(e,t),[l,u,c,h]=xz(o,a,n),d=[];for(let f=Math.floor(l);f<c;f++)for(let p=Math.floor(u);p<h;p++)d.push({x:f,y:p,z:e});return d}function e_({viewport:s,maxZoom:e,minZoom:t,zRange:i,extent:n,tileSize:o=Hs,modelMatrix:a,modelMatrixInverse:l,zoomOffset:u=0}){let c=s.isGeospatial?Math.round(s.zoom+Math.log2(Hs/o))+u:Math.ceil(s.zoom)+u;if(typeof t=="number"&&Number.isFinite(t)&&c<t){if(!n)return[];c=t}typeof e=="number"&&Number.isFinite(e)&&c>e&&(c=e);let h=n;return a&&l&&n&&!s.isGeospatial&&(h=QR(n,a)),s.isGeospatial?YR(s,c,i,n):Cz(s,c,o,h||yz,l)}var t_=1,OP=2,vz="never",Az="no-overlap",RP="best-available",Tz=5,Iz={[RP]:wz,[Az]:Lz,[vz]:()=>{}},_P=class{constructor(e){y(this,"opts",void 0),y(this,"_requestScheduler",void 0),y(this,"_cache",void 0),y(this,"_dirty",void 0),y(this,"_tiles",void 0),y(this,"_cacheByteSize",void 0),y(this,"_viewport",void 0),y(this,"_zRange",void 0),y(this,"_selectedTiles",void 0),y(this,"_frameNumber",void 0),y(this,"_modelMatrix",void 0),y(this,"_modelMatrixInverse",void 0),y(this,"_maxZoom",void 0),y(this,"_minZoom",void 0),y(this,"onTileLoad",void 0),y(this,"_getCullBounds",co(Sp)),this.opts=e,this.onTileLoad=t=>{this.opts.onTileLoad(t),this.opts.maxCacheByteSize&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new mf({maxRequests:e.maxRequests,throttleRequests:e.maxRequests>0}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new mt,this._modelMatrixInverse=new mt,this.setOptions(e)}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(let e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(let e of this._cache.keys()){let t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:i}={}){let n=new mt(i),o=!n.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!Fr(this._zRange,t)||o){o&&(this._modelMatrixInverse=n.clone().invert(),this._modelMatrix=n),this._viewport=e,this._zRange=t;let l=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=l.map(u=>this._getTile(u,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(l=>this._getTile(l.index,!0)));let a=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),a&&this._frameNumber++,this._frameNumber}isTileVisible(e,t){if(!e.isVisible)return!1;if(t&&this._viewport){let[i,n,o,a]=Sp({viewport:this._viewport,z:this._zRange,cullRect:t}),{bbox:l}=e;if("west"in l)return l.west<o&&l.east>i&&l.south<a&&l.north>n;let u=Math.min(l.top,l.bottom),c=Math.max(l.top,l.bottom);return l.left<o&&l.right>i&&u<a&&c>n}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:i,zRange:n,modelMatrix:o,modelMatrixInverse:a}){let{tileSize:l,extent:u,zoomOffset:c}=this.opts;return e_({viewport:e,maxZoom:t,minZoom:i,zRange:n,tileSize:l,extent:u,modelMatrix:o,modelMatrixInverse:a,zoomOffset:c})}getTileId(e){return"".concat(e.x,"-").concat(e.y,"-").concat(e.z)}getTileZoom(e){return e.z}getTileMetadata(e){let{tileSize:t}=this.opts;return{bbox:$R(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){let t=Math.floor(e.x/2),i=Math.floor(e.y/2),n=e.z-1;return{x:t,y:i,z:n}}updateTileStates(){let e=this.opts.refinementStrategy||RP,t=new Array(this._cache.size),i=0;for(let n of this._cache.values())t[i++]=n.isVisible,n.isSelected=!1,n.isVisible=!1;for(let n of this._selectedTiles)n.isSelected=!0,n.isVisible=!0;(typeof e=="function"?e:Iz[e])(Array.from(this._cache.values())),i=0;for(let n of this._cache.values())if(t[i++]!==n.isVisible)return!0;return!1}_pruneRequests(){let{maxRequests:e}=this.opts,t=[],i=0;for(let n of this._cache.values())n.isLoading&&(i++,!n.isSelected&&!n.isVisible&&t.push(n));for(;e>0&&i>e&&t.length>0;)t.shift().abort(),i--}_rebuildTree(){let{_cache:e}=this;for(let t of e.values())t.parent=null,t.children&&(t.children.length=0);for(let t of e.values()){let i=this._getNearestAncestor(t);t.parent=i,i!=null&&i.children&&i.children.push(t)}}_resizeCache(){let{_cache:e,opts:t}=this,i=t.maxCacheSize||(t.maxCacheByteSize?1/0:Tz*this.selectedTiles.length),n=t.maxCacheByteSize||1/0;if(e.size>i||this._cacheByteSize>n){for(let[a,l]of e)if(l.isVisible||(this._cacheByteSize-=t.maxCacheByteSize?l.byteLength:0,e.delete(a),this.opts.onTileUnload(l)),e.size<=i&&this._cacheByteSize<=n)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((a,l)=>a.zoom-l.zoom),this._dirty=!1)}_getTile(e,t){let i=this.getTileId(e),n=this._cache.get(i),o=!1;return!n&&t?(n=new CP(e),Object.assign(n,this.getTileMetadata(n.index)),Object.assign(n,{id:i,zoom:this.getTileZoom(n.index)}),o=!0,this._cache.set(i,n),this._dirty=!0):n&&n.needsReload&&(o=!0),n&&o&&n.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),n}_getNearestAncestor(e){let{_minZoom:t=0}=this,i=e.index;for(;this.getTileZoom(i)>t;){i=this.getParentIndex(i);let n=this._getTile(i);if(n)return n}return null}};function wz(s){for(let e of s)e.state=0;for(let e of s)e.isSelected&&!r_(e)&&Jx(e);for(let e of s)e.isVisible=Boolean(e.state&OP)}function Lz(s){for(let t of s)t.state=0;for(let t of s)t.isSelected&&r_(t);let e=Array.from(s).sort((t,i)=>t.zoom-i.zoom);for(let t of e)if(t.isVisible=Boolean(t.state&OP),t.children&&(t.isVisible||t.state&t_))for(let i of t.children)i.state=t_;else t.isSelected&&Jx(t)}function r_(s){let e=s;for(;e;){if(e.isLoaded||e.content)return e.state|=OP,!0;e=e.parent}return!1}function Jx(s){for(let e of s.children)e.isLoaded||e.content?e.state|=OP:Jx(e)}var Oz={TilesetClass:_P,data:{type:"data",value:[]},dataComparator:ZR.equals,renderSubLayers:{type:"function",value:s=>new _u(s),compare:!1},getTileData:{type:"function",optional:!0,value:null,compare:!1},onViewportLoad:{type:"function",optional:!0,value:null,compare:!1},onTileLoad:{type:"function",value:s=>{},compare:!1},onTileUnload:{type:"function",value:s=>{},compare:!1},onTileError:{type:"function",value:s=>console.error(s),compare:!1},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:RP,zRange:null,maxRequests:6,zoomOffset:0},Bu=class extends Di{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){var e,t;(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0||t.finalize()}get isLoaded(){var e,t;return(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0?void 0:t.selectedTiles.every(i=>i.isLoaded&&i.layers&&i.layers.every(n=>n.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state,i=e.propsOrDataChanged||e.updateTriggersChanged,n=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?i&&(t.setOptions(this._getTilesetOptions()),n?t.reloadAll():this.state.tileset.tiles.forEach(o=>{o.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){let{tileSize:e,maxCacheSize:t,maxCacheByteSize:i,refinementStrategy:n,extent:o,maxZoom:a,minZoom:l,maxRequests:u,zoomOffset:c}=this.props;return{maxCacheSize:t,maxCacheByteSize:i,maxZoom:a,minZoom:l,tileSize:e,refinementStrategy:n,extent:o,maxRequests:u,zoomOffset:c,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){let{tileset:e}=this.state,{zRange:t,modelMatrix:i}=this.props,n=e.update(this.context.viewport,{zRange:t,modelMatrix:i}),{isLoaded:o}=e,a=this.state.isLoaded!==o,l=this.state.frameNumber!==n;o&&(a||l)&&this._onViewportLoad(),l&&this.setState({frameNumber:n}),this.state.isLoaded=o}_onViewportLoad(){let{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){let{data:t,getTileData:i,fetch:n}=this.props,{signal:o}=e;return e.url=typeof t=="string"||Array.isArray(t)?JR(t,e):null,i?i(e):n&&e.url?n(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo({info:e,sourceLayer:t}){return e.tile=t.props.tile,e}_updateAutoHighlight(e){e.sourceLayer&&e.sourceLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{let t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(i=>e.layers[0].props[i]!==t[i])&&(e.layers=e.layers.map(i=>i.clone(t)));else{let i=this.renderSubLayers({...this.props,id:"".concat(this.id,"-").concat(e.id),data:e.content,_offset:0,tile:e});e.layers=ks(i,Boolean).map(n=>n.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){let{tile:i}=e.props;return this.state.tileset.isTileVisible(i,t)}};y(Bu,"defaultProps",Oz);y(Bu,"layerName","TileLayer");var i_={clipBounds:[0,0,1,1]},n_=`
uniform vec4 clip_bounds;

bool clip_isInBounds(vec2 position) {
  return position.x >= clip_bounds[0] && position.y >= clip_bounds[1] && position.x < clip_bounds[2] && position.y < clip_bounds[3];
}
`,Rz={name:"clip-vs",vs:n_},_z={"vs:#decl":`
varying float clip_isVisible;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_isVisible = float(clip_isInBounds(geometry.worldPosition.xy));
`,"fs:#decl":`
varying float clip_isVisible;
`,"fs:DECKGL_FILTER_COLOR":`
  if (clip_isVisible < 0.5) discard;
`},Mz={name:"clip-fs",fs:n_},Nz={"vs:#decl":`
varying vec2 clip_commonPosition;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_commonPosition = geometry.position.xy;
`,"fs:#decl":`
varying vec2 clip_commonPosition;
`,"fs:DECKGL_FILTER_COLOR":`
  if (!clip_isInBounds(clip_commonPosition)) discard;
`},Du=class extends Nh{getShaders(){let e="instancePositions"in this.getAttributeManager().attributes;return"clipByInstance"in this.props&&(e=this.props.clipByInstance),this.state.clipByInstance=e,e?{modules:[Rz],inject:_z}:{modules:[Mz],inject:Nz}}draw({uniforms:e}){let{clipBounds:t=i_.clipBounds}=this.props;if(this.state.clipByInstance)e.clip_bounds=t;else{let i=this.projectPosition([t[0],t[1],0]),n=this.projectPosition([t[2],t[3],0]);e.clip_bounds=[Math.min(i[0],n[0]),Math.min(i[1],n[1]),Math.max(i[0],n[0]),Math.max(i[1],n[1])]}}};y(Du,"defaultProps",i_);y(Du,"extensionName","ClipExtension");var _e={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var NP=`
uniform sampler2D nodeDepth;
uniform vec2 textureDim;

vec2 getCoordinate(vec3 nodeIdx) {
  // index = r + g * 256 + b * 65536
  // textureDim.x is always power of 2 and <= 65536
  // avoid making big integers (float32 precision)
  float x = nodeIdx.r + nodeIdx.g * 256.0;
  float y = floor(x / textureDim.x);
  x -= y * textureDim.x;
  y += 65536.0 / textureDim.x * nodeIdx.b;
  return vec2(x + 0.5, y + 0.5) / textureDim;
}

bool getDepth(vec3 nodeIdx, out float depth) {
  vec2 coord = getCoordinate(nodeIdx);
  vec4 c = texture2D(nodeDepth, coord);
  depth = c.r * 255.0;
  return c.a == 0.0;
}
`,Bz=new Uint8Array(4),BP=class{constructor(e){this._gl=e,this._nodeDepthTextures=[o_(e),o_(e)],this._nodeDepth=this._nodeDepthTextures[0],this._nodeDepthFB=new ze(e,{id:"graph-highlighter-framebuffer",width:this._nodeDepthTextures[0].width,height:1,attachments:{[_e.COLOR_ATTACHMENT0]:this._nodeDepthTextures[0]}}),this._model=Dz(e),this._transform=Fz(e)}delete(){var e,t,i,n;(e=this._edgeSourceBuffer)==null||e.delete(),(t=this._edgeTargetBuffer)==null||t.delete(),(i=this._edgeDirectionBuffer)==null||i.delete(),(n=this._edgeDepthBuffer)==null||n.delete(),this._nodeDepthTextures.forEach(o=>o.delete()),this._nodeDepthFB.delete(),this._model.delete(),this._transform.delete()}get nodeDepth(){return this._nodeDepth}get edgeDepth(){return this._edgeDepthBuffer}encodeNodeIndex(e,t){return $x(this._nodeMap.get(e.id),t)}getNode(e){return this._nodeList[e]}setGraph(e){if(this._graph===e.graph)return;this._graph=e.graph;let t=this._graph.deepEdgesCount();this._nodeMap=new Map,this._nodeList=[],this._hasBidirectionalEdge=!1;let i=this._gl;this._edgeSourceBuffer=MP(i,this._edgeSourceBuffer,{size:3,type:_e.UNSIGNED_BYTE},t),this._edgeTargetBuffer=MP(i,this._edgeTargetBuffer,{size:3,type:_e.UNSIGNED_BYTE},t),this._edgeDirectionBuffer=MP(i,this._edgeDirectionBuffer,{size:1,type:_e.UNSIGNED_BYTE},t),this._edgeDepthBuffer=MP(i,this._edgeDepthBuffer,{size:1,type:_e.FLOAT},t);let n=0,o=0;for(let f of e.deepNodesIt())this._nodeList[n]=f,this._nodeMap.set(f.id,n+1),n++;let a=new Uint8Array(t*3),l=new Uint8Array(t*3),u=new Uint8Array(t),c=[0,0,0];for(let f of e.deepEdges){let p=this._nodeMap.get(f.source.id);$x(p,c),a.set(c,o*3);let S=this._nodeMap.get(f.target.id);$x(S,c),l.set(c,o*3);let x=Qe.getDrawingObj(f.edge);this._hasBidirectionalEdge=this._hasBidirectionalEdge||!x.directed,u[o]=x.directed?1:0,o++}this._edgeSourceBuffer.subData(a),this._edgeTargetBuffer.subData(l),this._edgeDirectionBuffer.subData(u),this._nodeCount=this._nodeMap.size;let h=this._nodeDepthTextures[0].width,d=Math.ceil((this._nodeCount+1)/h);this._nodeDepthFB.resize({width:h,height:d}),this._transform.update({elementCount:t,sourceBuffers:{source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer},feedbackBuffers:{nextDepth:this._edgeDepthBuffer}}),this._model.setAttributes({source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer}),this._model.setVertexCount(t),this.update({sourceId:null})}update(e){let{sourceId:t,edgeDepth:i=!1,maxDepth:n=1}=e,o=[this._nodeDepthFB.width,this._nodeDepthFB.height],a=this._nodeDepthTextures[1],l=this._nodeDepthTextures[0];if(t){let u=this._nodeMap.get(t);this._resetNodeDepth(a,u),this._resetNodeDepth(l,u);for(let c=0;c<n;c++){[a,l]=[l,a],this._nodeDepthFB.attach({[_e.COLOR_ATTACHMENT0]:l});let h={nodeDepth:a,textureDim:o,testForward:!0};this._updateNodeDepth(h),this._hasBidirectionalEdge&&(h.testForward=!1,this._updateNodeDepth(h))}}else this._resetNodeDepth(l),this._nodeDepthFB.attach({[_e.COLOR_ATTACHMENT0]:l});this._nodeDepth=l,i&&(this._nodeDepthFB.attach({[_e.COLOR_ATTACHMENT0]:a}),this._transform.run({framebuffer:this._nodeDepthFB,clearRenderTarget:!1,discard:!0,uniforms:{nodeDepth:l,textureDim:o}}))}_resetNodeDepth(e,t){this._nodeDepthFB.attach({[_e.COLOR_ATTACHMENT0]:e}),yt(this._gl,{framebuffer:this._nodeDepthFB,viewport:[0,0,e.width,e.height],clearColor:[1,1,1,1]},()=>{this._gl.clear(_e.COLOR_BUFFER_BIT)}),t!==void 0&&e.setSubImageData({data:Bz,x:t%e.width,y:Math.floor(t/e.width),width:1,height:1})}_updateNodeDepth(e){this._model.draw({framebuffer:this._nodeDepthFB,uniforms:e,parameters:{depthTest:!1,blend:!0,viewport:[0,0,this._nodeDepthFB.width,this._nodeDepthFB.height],blendFunc:[_e.ONE,_e.ONE,_e.ONE,_e.ONE],blendEquation:[_e.MIN,_e.MIN]}})}};function MP(s,e,t,i){e||(e=new ve(s,{target:s.ARRAY_BUFFER,accessor:t}));let n=i*t.size*(t.type===_e.UNSIGNED_BYTE?1:4);return e.byteLength<n&&e.reallocate(n),e}function o_(s){let e=s.getParameter(s.MAX_TEXTURE_SIZE);return e=Math.min(1024,2**Math.floor(Math.log2(e))),new Je(s,{format:_e.RGBA,type:_e.UNSIGNED_BYTE,border:0,mipmaps:!1,dataFormat:_e.RGBA,width:e,height:1,parameters:{[_e.TEXTURE_MIN_FILTER]:_e.NEAREST,[_e.TEXTURE_MAG_FILTER]:_e.NEAREST,[_e.TEXTURE_WRAP_S]:_e.CLAMP_TO_EDGE,[_e.TEXTURE_WRAP_T]:_e.CLAMP_TO_EDGE}})}function Dz(s){return new Gt(s,{id:"graph-highlighter-nodes",vs:`
#define SHADER_NAME graph-highlighter-nodes-vertex-shader

uniform bool testForward;

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float targetDepth;

${NP}

void main(void) {
  vec3 sourceIdx = source;
  vec3 targetIdx = target;
  if (!testForward && direction == 0.0) {
    sourceIdx = target;
    targetIdx = source;
  }
  float sourceDepth;
  bool sourceDepthValid = getDepth(sourceIdx, sourceDepth);
  vec2 targetCoord = getCoordinate(targetIdx);

  gl_Position = vec4(targetCoord * 2.0 - 1.0, sourceDepthValid ? 0.0 : 2.0, 1.0);
  gl_PointSize = 1.0;

  targetDepth = sourceDepth + 1.0;
}
`,fs:`
#define SHADER_NAME graph-highlighter-nodes-fragment-shader
varying float targetDepth;

void main(void) {
  gl_FragColor = vec4(targetDepth / 255.0, 0.0, 0.0, 0.0);
}`,isInstanced:!1,drawMode:_e.POINTS})}function Fz(s){return new vn(s,{vs:`
#define SHADER_NAME graph-highlighter-edges-vertex-shader

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float nextDepth;

${NP}

float getDepth(vec3 sourceIdx) {
  float sourceDepth;
  if (getDepth(sourceIdx, sourceDepth)) {
    return sourceDepth + 1.0;
  }
  return 255.0;
}

void main(void) {
  nextDepth = getDepth(source);
  if (direction == 0.0) {
    nextDepth = min(nextDepth, getDepth(target));
  }

  gl_Position = vec4(0.0);
}
`,varyings:["nextDepth"]})}function $x(s,e){return e[0]=s&255,e[1]=s>>8&255,e[2]=s>>8>>8&255,e}var Gz={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColors:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPickingColor:{type:"accessor",value:[0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},Vz=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

${NP}

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  float depth;
  if (getDepth(instancePickingColors, depth)) {
    applyHighlight(int(depth));
  }
}
`,kz=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Fu=class extends Jt{getShaders(){return super.getShaders({vs:Vz,fs:kz,modules:[li,qa]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:_e.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:_e.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:_e.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:_e.UNSIGNED_BYTE,accessor:"getShape"},instancePickingColors:{size:3,type:_e.UNSIGNED_BYTE,accessor:"getPickingColor"}})}updateState(e){var a;super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=!1;if(n.extensionsChanged){let{gl:l}=this.context;(a=this.state.model)==null||a.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),o=!0}if(o||t.highlightColors!==i.highlightColors){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=t.highlightColors[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:i,cornerRadius:n,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:i,cornerRadius:n,lineWidthUnits:Vr[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c,textureDim:[c.width,c.height]}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:_e.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};Fu.defaultProps=Gz,Fu.layerName="GeometryLayer";function Ep(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!Ep(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!e.hasOwnProperty(n)||!Ep(s[n],e[n]))return!1;return!0}return!1}function s_(s){if(s instanceof Ie){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}var qh=class extends Di{getPickingInfo({sourceLayer:e,info:t}){return e.id.endsWith("boundary")&&t.picked&&(t.object=this.props.fromIndex(t.index)),t}renderLayers(){return[new Fu(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:e=>Wz(e.node),cornerRadius:zz(this.props.data[0]),getLineColor:a_,getFillColor:Uz}),new nn(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof Ie)||t.labelSize),getPosition:e=>s_(e),getText:e=>Bt.getDrawingObj(e.node).labelText,getColor:a_,getSize:this.props.getTextSize,sizeMaxPixels:48,sizeUnits:"common",characterSet:"auto"})]}};qh.defaultProps={...nn.defaultProps,...Fu.defaultProps,fromIndex:{type:"function",compare:!1},getTextSize:{type:"accessor",value:16}},qh.layerName="NodeLayer";function zz(s){return s?Bt.getDrawingObj(s.node).xRad:0}function a_(s){let e=Qe.getDrawingObj(s.node);if(e){let t=e.pencolor;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function Uz(s){let e=Qe.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}function Wz(s){let e=Qe.getDrawingObj(s);if(e==null)return 0;switch(e.shape){case 0:return 2;case 1:return 1;case 2:return 0;case 3:return 1;case 4:return 0;case 5:return 1;case 6:return 1;case 10:return 1;case 14:return 1;case 18:return 0;case 11:return 0;case 12:return 0;default:return 0}}var Hz="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",eC=4,l_=typeof Image!="undefined"&&Ko(Hz,fu,{imagebitmap:{resizeWidth:256*eC,resizeHeight:128*eC}}),u_=jz({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},eC);function jz(s,e){for(let t in s){let i=s[t];i.x*=e,i.y*=e,i.width*=e,i.height*=e,i.anchorX&&(i.anchorX*=e),i.anchorY&&(i.anchorY*=e)}return s}var qz=16;var Xz={widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getControlPoints:{type:"accessor",value:s=>s.points},getCurveType:{type:"accessor",value:0},getResolution:{type:"accessor",value:4},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},Yz=`#define SHADER_NAME curve-layer-vertex-shader
#define LINE    0.0
#define BEZIER  1.0
#define ARC     2.0

attribute vec2 positions;
attribute vec2 instanceSegments;
attribute vec4 instancePositions1;
attribute vec4 instancePositions2;
attribute float instanceTypes;
attribute float instanceWidths;
attribute vec4 instanceColors;

uniform float opacity;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform int widthUnits;

varying vec4 vColor;

void interpolateLine(float t, vec2 start, vec2 end, out vec2 point) {
  point = mix(start, end, t);
}

void interpolateBezierCurve(float t, vec2 start, vec2 c1, vec2 c2, vec2 end, out vec2 point) {
  vec2 c = (c1 - start) * 3.0;
  vec2 e = (c2 - c1) * 3.0 - c;
  vec2 l = end - start - c - e;

  float t2 = t * t;
  float t3 = t2 * t;
  
  point = l * t3 + e * t2 + c * t + start;
}

void interpolateArc(float t, vec2 center, vec2 aAxis, vec2 bAxis, float startAngle, float endAngle, out vec2 point) {
  float a = mix(startAngle, endAngle, t);
  point = center + cos(a) * aAxis + sin(a) * bAxis;
}

vec2 getExtrusionOffset(vec2 line, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir = normalize(line);
  // rotate by 90 degrees
  dir = vec2(-dir.y, dir.x);
  return dir * offset_direction * width / 2.0;
}

void main(void) {
  // Multiply out line width and clamp to limits
  float widthPixels = clamp(
    project_size_to_pixel(widthScale * instanceWidths, widthUnits),
    widthMinPixels, widthMaxPixels
  );
  float widthCommon = project_pixel_size(widthPixels);

  geometry.uv = positions.xy;

  vec2 pointOnCurve;
  vec2 nextPointOnCurve;
  vec2 pointOnCurve64Low = vec2(0.0);
  float r = (instanceSegments.x + positions.x) / instanceSegments.y;
  float rNext = r + 1.0 / instanceSegments.y;

  if (instanceTypes == BEZIER) {
    interpolateBezierCurve(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, pointOnCurve);
    interpolateBezierCurve(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, nextPointOnCurve);
  }
  else if (instanceTypes == ARC) {
    interpolateArc(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.z, instancePositions2.w, pointOnCurve);
    interpolateArc(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.z, instancePositions2.w, nextPointOnCurve);
  }
  else {
    interpolateLine(r, instancePositions1.xy, instancePositions1.zw, pointOnCurve);
    interpolateLine(rNext, instancePositions1.xy, instancePositions1.zw, nextPointOnCurve);
  }
  
  vec3 offset = vec3(getExtrusionOffset(
    nextPointOnCurve - pointOnCurve,
    positions.y,
    widthCommon), 0.0);

  gl_Position = project_position_to_clipspace(
    vec3(pointOnCurve, 0.0),
    vec3(pointOnCurve64Low, 0.0),
    offset,
    geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Kz=`#define SHADER_NAME curve-layer-fragment-shader
varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Xh=class extends Jt{getShaders(){return super.getShaders({vs:Yz,fs:Kz,modules:[li,qa]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:8,transition:!0,accessor:"getControlPoints",shaderAttributes:{instancePositions1:{size:4},instancePositions2:{size:4,elementOffset:4}}},instanceSegments:{size:2,type:_e.UNSIGNED_SHORT,update:this._getSegments},instanceTypes:{size:1,type:_e.UNSIGNED_BYTE,accessor:"getCurveType"},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceColors:{size:4,transition:!0,normalized:!0,type:_e.UNSIGNED_BYTE,accessor:"getColor"}})}updateState(e){var n;super.updateState(e);let{props:t,changeFlags:i}=e;if(i.dataChanged&&this.updateGeometry(),i.extensionsChanged){let{gl:o}=this.context;(n=this.state.model)==null||n.delete(),this.state.model=this._getModel(o),this.getAttributeManager().invalidateAll()}}updateGeometry(){let{data:e,getResolution:t,getCurveType:i}=this.props,{iterable:n,objectInfo:o}=Po(e),a=[0],l=0,u=[];for(let c of n){o.index++;let d=(typeof i=="function"?i(c,o):i)===0?1:Math.ceil(typeof t=="function"?t(c,o):t);l+=d,a.push(l);for(let f=0;f<d;f++)u.push(f,d)}this.setState({startIndices:a,numInstances:l,segments:new Uint16Array(u)})}draw({uniforms:e}){let{widthUnits:t,widthScale:i,widthMinPixels:n,widthMaxPixels:o}=this.props,a=Math.min(this.context.viewport.scale,qz);this.state.model.setUniforms(e).setUniforms({skip:Math.ceil(1/a),widthUnits:Vr[t],widthScale:i,widthMinPixels:n,widthMaxPixels:o});let l=Math.ceil(a);for(let u=0;u<l;u++)this.state.model.setUniforms({iteration:[u,l]}).draw()}_getModel(e){let t=[0,-1,1,-1,1,1,0,1];return new Gt(e,{...this.getShaders(),id:this.props.id,geometry:new Tr({drawMode:_e.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_getSegments(e){e.value=this.state.segments}};Xh.layerName="CurveLayer",Xh.defaultProps=Xz;var Zz={...nn.defaultProps,resolution:{type:"number",value:1},widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},Yh=class extends Di{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let{data:t,clipBounds:i}=e.props,n=[],o=Array.from(Qz(t,i));for(let a of e.props.data)a.sourceArrowhead&&(!i||i.contains(a.sourceArrowhead.tipPosition))&&n.push({edge:a,type:"triangle-n",tip:a.sourceArrowhead.tipPosition,end:a.curve.start}),a.targetArrowhead&&(!i||i.contains(a.targetArrowhead.tipPosition))&&n.push({edge:a,type:"triangle-n",tip:a.targetArrowhead.tipPosition,end:a.curve.end});this.setState({arrows:n,curves:o})}}renderLayers(){let{getWidth:e,getColor:t,resolution:i}=this.props;return[new Xh({getWidth:typeof e=="function"?n=>e(n.__source):e,getColor:typeof t=="function"?n=>t(n.__source):t},this.getSubLayerProps({id:"path"}),{data:this.state.curves,getCurveType:n=>n instanceof de?2:n instanceof Ge?1:0,getControlPoints:n=>n instanceof de?[n.center,n.aAxis,n.bAxis].flatMap(DP).concat(n.parStart,n.parEnd):n instanceof Ge?n.b.flatMap(DP):[n.start,n.end].flatMap(DP),widthUnits:"pixels",getResolution:n=>n.length*i}),new yo(this.getSubLayerProps({id:"arrow"}),{data:this.state.arrows,iconAtlas:l_,iconMapping:u_,getPosition:n=>[n.tip.x,n.tip.y],getColor:n=>c_(n.edge),getIcon:n=>n.type,getSize:n=>Jz(n.tip,n.end),getAngle:n=>$z(n.tip,n.end),sizeUnits:"common"}),new nn(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:n=>n.filter(o=>o.label),getPosition:n=>DP(n.label.center),getText:n=>Bi.getDrawingObj(n.edge).labelText,getColor:c_,getSize:this.props.getTextSize,sizeMaxPixels:48,sizeUnits:"common",characterSet:"auto"})]}};Yh.defaultProps=Zz,Yh.layerName="EdgeLayer";function*Qz(s,e){if(e){for(let t of s)for(let i of fy(t.curve,e))if(i instanceof L)for(let n of i.segs)n.__source=t,yield n;else i.__source=t,yield i;return}for(let t of s)if(t.curve instanceof L)for(let i of t.curve.segs)i.__source=t,yield i;else t.curve.__source=t,yield t.curve}function DP(s){return[s.x,s.y]}function c_(s){let e=Qe.getDrawingObj(s.edge);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function Jz(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}function $z(s,e){let t=s.x-e.x,i=s.y-e.y;return-Math.atan2(i,t)/Math.PI*180}var Kh=null,h_=!1;async function d_(s,e,t,i=!1){if(h_&&(Kh.terminate(),Kh=null),!Kh){s=new URL(s,location.href).href;let n=`importScripts( "${s}" )`,o=URL.createObjectURL(new Blob([n],{type:"text/javascript"}));Kh=new Worker(o)}return new Promise((n,o)=>{Kh.onmessage=({data:a})=>{if(a.type==="error")o(a.message);else if(a.type==="layout-done")try{e=su(a.graph),console.debug("graph transfer to main thread",Date.now()-a.timestamp+" ms"),n(e)}catch(l){o(l.message)}},Kh.postMessage({type:"layout",timestamp:Date.now(),graph:ff(e),options:t,forceUpdate:i}),h_=!0})}function FP(s,e,t=!1){let i=!1,n=t,o=or.getDrawingObj(s),a=Ie.getGeom(s);function l(u){if(!u)return;for(let d of u.subgraphs())l(d);let c=e6(o,u,e),h=t6(u.layoutSettings,c);n=n||h.layoutChanged,i=i||h.routingChanged,u.layoutSettings=c}if(l(a),n||i)for(let u of a.deepEdges)u.requireRouting();return n?(console.time("layoutGeomGraph"),J0(a,null),console.timeEnd("layoutGeomGraph")):i&&(console.time("routeEdges"),Zl(a,Array.from(a.deepEdges),null),console.time("routeEdges")),s}function e6(s,e,t){let i=!1;for(let o of e.edges())if(o.sourceArrowhead!=null||o.targetArrowhead!=null){i=!0;break}let n;switch(t.layoutType){case"Sugiyama LR":{let o=n=new Lr;o.layerDirection=1;break}case"Sugiyama RL":{let o=n=new Lr;o.layerDirection=3;break}case"Sugiyama TB":{let o=n=new Lr;o.layerDirection=0;break}case"Sugiyama BT":{let o=n=new Lr;o.layerDirection=2;break}case"MDS":n=new Si;break;case"FD":n=new bn;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.nodeCollection.edgeCount>4e3;if(i&&!o){let a=n=new Lr;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else n=new Si}}return t.edgeRoutingMode==null?n instanceof Lr?n.edgeRoutingSettings.EdgeRoutingMode=3:n.edgeRoutingSettings.EdgeRoutingMode=0:n.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,n}function t6(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.edgeRoutingSettings.EdgeRoutingMode!==e.edgeRoutingSettings.EdgeRoutingMode,i=t&&e.edgeRoutingSettings.EdgeRoutingMode===3,n=s instanceof Lr&&e instanceof Lr&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||i||n,routingChanged:t}}function f_(s,e,t){t[s]=t[s]||[],t[s].indexOf(e)<0&&t[s].push(e)}function tC(s,e,t){if(t[s]){let i=t[s].indexOf(e);i>=0&&t[s].splice(i,1)}}var GP=class{constructor(){this._listeners={};this._onceListeners={}}on(e,t){f_(e,t,this._listeners)}once(e,t){f_(e,t,this._onceListeners)}off(e,t){tC(e,t,this._listeners),tC(e,t,this._onceListeners)}emit(e){var a,l;let t;typeof e=="string"?t={type:e}:t=e;let i=t.type;if(!this._listens(i))return;t.target=this;let n=((a=this._listeners[i])==null?void 0:a.slice())||[];for(let u of n)u.call(this,t);let o=((l=this._onceListeners[i])==null?void 0:l.slice())||[];for(let u of o)tC(i,u,this._onceListeners),u.call(this,t)}_listens(e){return this._listeners[e]&&this._listeners[e].length>0||this._onceListeners[e]&&this._onceListeners[e].length>0}};var Gu=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:i,fontStyle:n,fontWeight:o}=this.opts;this.ctx.font=`${n} ${o} ${i}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:i,lineHeight:n}=this.opts,o=i*1.2,a=i*(n-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new Pr(l,u.length*o+(u.length-1)*a)}};var rC=4,xp=class extends GP{constructor(e=document.body,t){super();this._layoutOptions={};this._controls=[];this._layoutWorkerUrl=t,this._textMeasurer=new Gu,window.getComputedStyle(e).position==="static"&&(e.style.position="relative");let i=Array.from({length:2},()=>{let n=document.createElement("div");return Object.assign(n.style,{position:"absolute",top:0,bottom:0,left:0,right:0}),e.appendChild(n)});this._deck=new Lu({parent:i[0],views:[new Za({})],initialViewState:{target:[0,0,0],zoom:0,maxZoom:rC},controller:!0,onLoad:()=>{this.emit("load"),this._update()},onClick:({object:n})=>{!n&&this._highlightedNodeId&&this.highlight(null)}}),i[1].style.pointerEvents="none",this._controlsContainer=i[1]}addControl(e){if(this._controls.indexOf(e)<0){this._controls.push(e),e.onAdd(this);let t=e.getElement();t&&this._controlsContainer.appendChild(t)}}removeControl(e){let t=this._controls.indexOf(e);if(t>=0){let i=e.getElement();i&&i.remove(),e.onRemove(this),this._controls.splice(t,1)}}get graph(){return this._graph}async setGraph(e,t=this._layoutOptions){this._graph===e?t&&await this.setOptions(t):(this._graph=e,t?(this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{}),this._highlightedNodeId=null,(or.getDrawingObj(e)||new or(e)).createGeometry(this._textMeasurer.measure),await this._layoutGraph(!0)):this._deck.layerManager&&this._update())}async setOptions(e){let t=this._layoutOptions.label,i=e.label,n=!Ep(t,i);if(this._layoutOptions=e,!this._graph)return;let o=or.getDrawingObj(this._graph);n&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=n;await this._layoutGraph(a)}zoomTo(e){let t=Math.min(this._deck.width/e.width,this._deck.height/e.height),i=Math.min(Math.log2(t),rC);this._deck.setProps({initialViewState:{target:[e.center.x,e.center.y,0],zoom:i,transitionInterpolator:new mo(["target","zoom"]),transitionDuration:1e3,maxZoom:rC}})}highlight(e){this._highlightedNodeId=e,this._highlight(e)}_highlight(e,t=2){this._graph&&this._deck.layerManager&&(this._graphHighlighter.update({sourceId:e,maxDepth:t,edgeDepth:!1}),this._deck.layerManager.setNeedsRedraw("hightlight changed"))}async _layoutGraph(e){this._layoutWorkerUrl?this._graph=await d_(this._layoutWorkerUrl,this._graph,this._layoutOptions,e):FP(this._graph,this._layoutOptions,e),this._deck.layerManager&&this._update()}_update(){if(!this._graph)return;let e=this._textMeasurer.opts,t=Ie.getGeom(this._graph);if(!t)return;console.time("initial render"),this._graphHighlighter=this._graphHighlighter||new BP(this._deck.deckRenderer.gl),this._graphHighlighter.setGraph(t);let i=t.buildRTree(),n=t.boundingBox,o=new Bu({extent:[n.left,n.bottom,n.right,n.top],refinementStrategy:"no-overlap",getTileData:({bbox:a})=>{let l=new W({left:a.left,right:a.right,bottom:a.top,top:a.bottom}),u=[],c=[];for(let h of t.intersectedObjects(i,l,!1))h instanceof ft?u.push(h):h instanceof Xe&&c.push(h);return u.sort((h,d)=>p_(h)-p_(d)),{nodes:u,edges:c}},parameters:{depthTest:!1},autoHighlight:!0,onHover:({object:a,sourceLayer:l})=>{this._highlightedNodeId||(l.id.endsWith("nodes")&&a&&!(a instanceof Ie)?this._highlight(a.id):this._highlight(null))},renderSubLayers:({data:a,id:l,tile:u})=>{let{left:c,right:h,top:d,bottom:f}=u.bbox,p=new W({left:c,right:h,bottom:d,top:f});return[new qh({id:l+"nodes",data:a.nodes,getPickingColor:(S,{target:x})=>this._graphHighlighter.encodeNodeIndex(S,x),fromIndex:S=>this._graphHighlighter.getNode(S),nodeDepth:this._graphHighlighter.nodeDepth,getLineWidth:1,fontFamily:e.fontFamily,fontWeight:e.fontWeight,lineHeight:e.lineHeight,getTextSize:e.fontSize,pickable:!0,clipBounds:[c,d,h,f],clipByInstance:!1,extensions:[new Du]}),new Yh({id:l+"edges",data:a.edges,clipBounds:p,getWidth:1,getDepth:this._graphHighlighter.edgeDepth,resolution:2**(u.index.z-2),fontFamily:e.fontFamily,fontWeight:e.fontWeight,lineHeight:e.lineHeight,getTextSize:e.fontSize})]},updateTriggers:{getTileData:Date.now()}});this._deck.setProps({layers:[o]}),this.emit({type:"graphload",data:this._graph}),this.zoomTo(t.boundingBox),console.timeEnd("initial render")}};function p_(s){let e=0,t=s.node.parent;for(;t;)e++,t=t.parent;return e}var qP=me(tr()),$_=me(Q_()),e2=class{bind(){this.entity&&this.entity.setAttr(Ht.SvgObjectIndex,this)}constructor(e,t){this.entity=e,this.svgData=t,this.bind()}static getGeom(e){return e.getAttr(Ht.SvgObjectIndex)}},jP=class{constructor(e,t=!1){this._textMeasurer=new Gu;this.transformRequired=t,this.container=e}getSvgString(){return this.svg==null?null:new XMLSerializer().serializeToString(this.svg)}clearContainer(){for(;this.container.childNodes.length>0;)this.container.removeChild(this.container.firstChild)}setGraph(e){if(this.clearContainer(),this.graph=e,this.svg=Ap(this.graph,"svg"),this.svg.setAttribute("style","border: 1px solid black"),this.geomGraph=Ie.getGeom(this.graph),!this.geomGraph)return null;this.geomGraph.boundingBox=null,this.open();for(let t of this.graph.deepNodes)this.drawNode(t);for(let t of this.graph.deepEdges)this.drawEdge(t);this.close(),this.container.appendChild(this.svg),(0,$_.default)(this.svg)}drawEdge(e){if(Xe.getGeom(e).curve==null)return;let t=Ap(e,"g"),i=document.createElementNS(HP,"path");t.appendChild(i),i.setAttribute("fill","none");let n=Bi.getDrawingObj(e);this.setStroke(i,n);let o=Xe.getGeom(e);i.setAttribute("d",J_(o.curve));for(let a of this.AddArrows(e))t.appendChild(a);this.DrawEdgeLabel(e),this.svg.appendChild(t)}DrawEdgeLabel(e){let t=Bi.getDrawingObj(e),n=Xe.getGeom(e).label;!n||this.drawLabelAtXY(t,n.boundingBox)}*AddArrows(e){let t=Xe.getGeom(e),i=t.curve,n=this.AddArrowhead(e,t.sourceArrowhead,i.start);n&&(yield n),n=this.AddArrowhead(e,t.targetArrowhead,i.end),n&&(yield n)}AddArrowhead(e,t,i){if(!t)return;let n=Ap(e,"polygon"),o=Bi.getDrawingObj(e);this.setStroke(n,o);let a=G6(i,t.tipPosition);return n.setAttribute("points",r2(a)),n}setStroke(e,t){let i=WP(t.color);if(e.setAttribute("stroke",i),e.setAttribute("stroke-opacity",(t.color?t.color.A/255:1).toString()),e.setAttribute("stroke-width",t.penwidth.toString()),t.styles&&t.styles.length)for(let n of t.styles)this.attachStyleToPath(e,n)}attachStyleToPath(e,t){switch(t){case 1:e.setAttribute("stroke-dasharray","5");break;case 7:e.setAttribute("stroke-dasharray","2");break;default:break}}drawNode(e){let i=ke.getGeom(e).boundaryCurve;!i||this.drawNodeOnCurve(i,e)}drawNodeOnCurve(e,t){let i=Qe.getDrawingObj(t);if(i.shape!=5&&(this.makePathOnCurve(t,i,e),i.shape==10)){let n=e,o=n.aAxis.length-2*i.penwidth;n=we.mkCircle(o,n.center),this.makePathOnCurve(t,i,n)}this.drawLabel(t,i)}makePathOnCurve(e,t,i){var o,a;let n=Ap(e,"path");if(t.styles.find(l=>l==5)){let l=(a=(o=t.fillColor)!=null?o:t.color)!=null?a:Bt.defaultFillColor;n.setAttribute("fill",WP(l))}else n.setAttribute("fill","none");n.setAttribute("d",J_(i)),n.setAttribute("stroke",WP(t.color)),n.setAttribute("stroke-width",t.penwidth.toString()),this.svg.appendChild(n)}drawLabel(e,t){if(!!t&&!(!t.labelText||t.labelText.length==0))if(t instanceof Bt)this.writeLabelText(e,t.measuredTextSize);else throw new Error("not implemented")}writeLabelText(e,t){let i=ft.getGeom(e),n=Qe.getDrawingObj(e),a=e instanceof Te?W.creatRectangleWithSize(t,new m(i.boundaryCurve.boundingBox.center.x,i.boundaryCurve.boundingBox.bottom+t.height/2+n.LabelMargin)):W.creatRectangleWithSize(t,i.center);this.drawLabelAtXY(n,a)}drawLabelAtXY(e,t){let i=e.fontsize,n=Ap(e.entity,"text");n.setAttribute("text-anchor","middle"),n.setAttribute("x",t.center.x.toString()),n.setAttribute("fill",WP(e.fontColor)),n.setAttribute("font-family",e.fontname),n.setAttribute("font-size",i.toString()+"px"),this.createTspans(e.labelText,n,i,t),this.svg.appendChild(n)}createTspans(e,t,i,n){let o=`
`,a=e.split(o);if(a.length==1){let l=document.createElementNS(HP,"tspan");t.appendChild(l),l.textContent=e,l.setAttribute("text-anchor","middle"),l.setAttribute("x",n.center.x.toString()),l.setAttribute("alignment-baseline","middle"),l.setAttribute("y",n.center.y.toString())}else{let l=n.bottom+1;for(let u=0;u<a.length;u++){let c=document.createElementNS(HP,"tspan");t.appendChild(c),c.textContent=a[u],c.setAttribute("text-anchor","middle"),c.setAttribute("x",n.center.x.toString()),c.setAttribute("alignment-baseline","hanging"),c.setAttribute("y",l.toString()),l+=1.21*i}}}close(){if(this.transformRequired)throw new Error("not implemented")}open(){if(this.svg.setAttribute("width",this.geomGraph.width),this.svg.setAttribute("height",this.geomGraph.height),this.transformRequired)throw new Error("not implemented")}};jP.arrowAngle=25;var HP="http://www.w3.org/2000/svg";function J_(s){return qP.String.Join(" ",Array.from(N6(s)))}function*N6(s){if(yield"M",yield Vu(s.start),s instanceof L)for(let t of s.segs)yield D6(t);else if(s instanceof D)yield"L",yield Vu(s.end);else if(s instanceof Ge)yield t2(s);else if(s instanceof re){let o=s;for(let a of o.skip(1))yield"L",yield Vu(a.point);o.closed&&(yield"L",yield Vu(o.start))}else if(s instanceof de){let a=s;a.isFullEllipse()?(yield aC(new de(0,Math.PI,a.aAxis,a.bAxis,a.center)),yield aC(new de(Math.PI,Math.PI*2,a.aAxis,a.bAxis,a.center))):this.ellipseToString(a)}}function Vu(s){return Tp(s.x)+" "+Tp(s.y)}function Tp(s){return Math.abs(s)<1e-11?"0":s.toString()}function t2(s){return"C"+r2([s.B(1),s.B(2),s.B(3)])}function aC(s){let e=Math.abs(s.parEnd-s.parStart)>=Math.PI?"1":"0",t=s.orientedCounterclockwise()?"1":"0";return qP.String.Join(" ","A",B6(s),Tp(m.angle(new m(1,0),s.aAxis)/(Math.PI/180)),e,t,Vu(s.end))}function B6(s){return Tp(s.aAxis.length)+","+Tp(s.bAxis.length)}function r2(s){return qP.String.Join(" ",s.map(e=>Vu(e)))}function D6(s){if(s instanceof D)return F6(s);if(s instanceof Ge)return t2(s);if(s instanceof de)return aC(s);throw new Error("NotImplementedException")}function F6(s){return"L "+Vu(s.end)}function WP(s){return s?"rgba("+s.R+","+s.G+","+s.B+","+s.A/255+")":"Black"}function G6(s,e){let t=e.sub(s),i=t;t=t.normalize();let n=new m(-t.y,t.x),o=i.length*Math.tan(jP.arrowAngle*.5*(Math.PI/180));return n=n.mul(o),[s.add(n),e,s.sub(n)]}function Ap(s,e){let t=document.createElementNS(HP,e);return new e2(s,t),t}var V6=`
  .search-control { pointer-events: all; font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; position: absolute; top: 0; right: 0; margin: 20px; width: 200px; }
  .search-control-input { font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; padding: 8px; width: 100%; }
  .search-control-options { background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); padding: 12px 0; margin-top: 4px; overflow-x: hidden; overflow-y: auto; }
  .search-control-option { padding: 0 12px; line-height: 32px; white-space: nowrap; color: #000; cursor: pointer; }
  .search-control-option:hover { background: #f8f8f8; }
  .search-control-option.focus { color: #08f; background: #f8f8f8; }
`,Ip=class{constructor(){this._nodes=[];this._onGraphLoad=e=>{this._updateNodeList(e.data)}}onAdd(e){e.on("graphload",this._onGraphLoad),this._dropdown=new i2({getLabel:t=>Bt.getDrawingObj(t).labelText,onSelect:t=>{e.highlight(t.id);let i=ft.getGeom(t);e.zoomTo(i.boundingBox)}}),this._updateNodeList(e.graph)}onRemove(e){e.off("graphload",this._onGraphLoad),this._dropdown.delete(),this._dropdown=null}getElement(){return this._dropdown.element}_updateNodeList(e){this._nodes=e?Array.from(e.deepNodes):[],this._dropdown.update(this._nodes)}},i2=class{constructor(e){this.focus=-1;this.items=[];this.options={getLabel:e=>e.toString(),renderItem:(e,t)=>{if(!t)return e;let i=e.toLowerCase().indexOf(t);return`${e.slice(0,i)}<b>${e.slice(i,i+t.length)}</b>${e.slice(i+t.length)}`},filterItem:(e,t)=>{if(!t)return 1;let i=e.toLowerCase().indexOf(t);return i===0?2:i>0?1:0},onSelect:()=>{},buffer:2,itemHeight:32,maxHeight:240};this._active=!1;this._topOffset=0;this._keyword="";this._filteredItems=[];this._items=[];this._onScroll=()=>{let{itemHeight:e,buffer:t,getLabel:i,renderItem:n}=this.options,o=this._flyout.scrollTop;this._topOffset=Math.max(0,Math.floor(o/e)-t),this._scroller.style.paddingTop=this._topOffset*e+"px";for(let a=0;a<this._items.length;a++){let l=this._items[a],u=a+this._topOffset;u===this.focus?l.classList.add("focus"):l.classList.remove("focus");let c=this._filteredItems[u];if(c){let h=i(c);l.innerHTML=n(h,this._keyword,c)}}};let t=document.createElement("style");t.innerText=V6,document.head.appendChild(t),this._stylesheet=t;let i=document.createElement("div");i.className="search-control";let n=document.createElement("input");n.placeholder="Search...",n.className="search-control-input",i.appendChild(n),n.addEventListener("focus",()=>{n.value="",this._keyword="",this._active=!0,this._updateFilter()}),n.addEventListener("blur",()=>{setTimeout(()=>{this._active=!1,this._updateUI()},200)}),n.addEventListener("input",l=>{this._keyword=n.value.toLowerCase(),this._updateFilter()}),n.addEventListener("keydown",l=>{switch(l.key){case"ArrowDown":l.preventDefault(),this.focus=Math.min(this._filteredItems.length-1,this.focus+1),this._updateUI();break;case"ArrowUp":l.preventDefault(),this.focus=Math.max(0,this.focus-1),this._updateUI();break;case"Enter":this._select(this.focus);break}}),this._textbox=n;let o=document.createElement("div");o.className="search-control-options",o.addEventListener("scroll",this._onScroll),i.appendChild(o);let a=document.createElement("div");a.style.boxSizing="border-box",a.style.overflow="hidden",o.appendChild(a),this._flyout=o,this._scroller=a,this.element=i,this.setOptions(e)}delete(){this.items=null,this._stylesheet.remove(),this._stylesheet=null,this.element.remove(),this.element=null,this._scroller=null,this._flyout=null}setOptions(e){Object.assign(this.options,e);let t=Math.ceil(this.options.maxHeight/this.options.itemHeight)+this.options.buffer*2,i=this._items;if(i.length!==t){for(let n=i.length;n<t;n++){let o=this._makeItem(n);i.push(o)}for(let n=i.length;n>t;n--)i[n-1].remove()}this._updateFilter()}update(e){this.items=e,this._textbox.value="",this._keyword="",this._updateFilter()}_updateFilter(){let{getLabel:e,filterItem:t}=this.options,i=this.items.map(o=>{let a=e(o);return t(a,this._keyword,o)}),n=Array.from(i,(o,a)=>a).filter(o=>i[o]);n.sort((o,a)=>i[a]-i[o]),this._filteredItems=n.map(o=>this.items[o]),this.focus=0,this._updateUI()}_select(e){let t=this._filteredItems[e];t&&(this.options.onSelect(t),this._textbox.value=this.options.getLabel(t),this._textbox.blur())}_updateUI(){if(!this._active){this._flyout.style.display="none";return}this._flyout.style.display="block",this._flyout.style.maxHeight=this.options.maxHeight+"px";let{itemHeight:e,maxHeight:t}=this.options,i=this._filteredItems.length,n=Math.floor(t/e),o=Math.max(0,(this.focus+2-n)*e),a=Math.min(Math.max(0,i*e-t),Math.max(0,this.focus-1)*e),l=this._flyout.scrollTop;l<o&&(l=o),l>a&&(l=a),this._scroller.style.height=i*e+"px";for(let u=0;u<this._items.length;u++){let c=this._items[u];c.style.display=u<i?"block":"none"}this._flyout.scrollTo({left:0,top:l,behavior:"smooth"}),this._onScroll()}_makeItem(e){let t=document.createElement("div");return t.className="search-control-option",t.style.height=this.options.itemHeight+"px",this._scroller.appendChild(t),t.addEventListener("click",()=>{this._select(e+this._topOffset)}),t}};var n2="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),lC={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},uC={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",mds:"Pivot MDS",fd:"Force Directed"},o2=["Times New Roman","Arial","Georgia","Courier New","Verdana"];var k6="https://raw.githubusercontent.com/microsoft/msagljs/main/examples/data/gameofthrones.json",cC=new xp(document.getElementById("viewer"),null);cC.addControl(new Ip);async function Jh(s,e){let t=document.getElementById("settings");t.classList.add("disabled"),s instanceof Te?await cC.setGraph(s,e):await cC.setOptions(s),t.classList.remove("disabled")}var hC=document.getElementById("gv");for(let s of n2){let e=document.createElement("option");e.value=`${s}.gv`,e.innerText=s,hC.appendChild(e)}hC.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+hC.value;TS(s).then(e=>{Jh(e),document.getElementById("graph-name").innerText=e.id})};var dC=document.getElementById("routings");for(let s in lC){let e=document.createElement("option");e.value=s,e.innerText=lC[s],dC.appendChild(e)}dC.onchange=()=>{Jh(XP())};var fC=document.getElementById("layouts");for(let s in uC){let e=document.createElement("option");e.value=s,e.innerText=uC[s],fC.appendChild(e)}fC.onchange=()=>{Jh(XP())};var pC=document.getElementById("fonts");for(let s of o2){let e=document.createElement("option");e.value=s,e.innerText=s,e.style.fontFamily=s,pC.appendChild(e)}pC.onchange=()=>{Jh(XP())};_T("drop-target",async s=>{let e=await RT(s);Jh(e),document.getElementById("graph-name").innerText=e.id});(async()=>{let s=await TS(k6),e=Vg(s);Jh(s,e?null:XP()),document.getElementById("graph-name").innerText=s.id})();function XP(){let s={label:{fontFamily:pC.value}};switch(Qe.defaultLabelFontName=s.label.fontFamily,fC.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;case"fd":s.layoutType="FD";break;default:break}switch(dC.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)
   
   Copyright (c) .NET Foundation and Contributors
   
   All rights reserved.
   
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:
   
   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.
   
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   NOTE: The `murmur3` algorithm is public domain.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */
