(()=>{var yO=Object.create;var Fy=Object.defineProperty;var SO=Object.getOwnPropertyDescriptor;var EO=Object.getOwnPropertyNames;var xO=Object.getPrototypeOf,vO=Object.prototype.hasOwnProperty;var fn=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),CO=(s,e)=>{for(var t in e)Fy(s,t,{get:e[t],enumerable:!0})},AO=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of EO(e))!vO.call(s,n)&&n!==t&&Fy(s,n,{get:()=>e[n],enumerable:!(i=SO(e,n))||i.enumerable});return s};var Ae=(s,e,t)=>(t=s!=null?yO(xO(s)):{},AO(e||!s||!s.__esModule?Fy(t,"default",{value:s,enumerable:!0}):t,s));var ky=fn(Op=>{"use strict";Object.defineProperty(Op,"__esModule",{value:!0});var Vy=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,i=!1){if(i&&this.isDuplicate(e))return!1;let n=new cc(e),o=this._head;if(o)for(;;){if(o.value===t)return n.next=o.next,n.prev=o,o.next=n,n.next?n.next.prev=n:this._tail=n,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new cc(e);return this._tail?(this._tail.next=i,i.prev=this._tail,this._tail=i):this._head=this._tail=i,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new cc(e);return this._head?(i.next=this._head,this._head.prev=i,this._head=i):this._head=this._tail=i,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),i=[],n=Math.min(e,this.length);for(let o=0;o<n;o++){let a=t.next();i.push(a.value)}return i}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Op.LinkedList=Vy;var cc=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Op.LinkedListItem=cc});var kn=fn(zy=>{"use strict";Object.defineProperty(zy,"__esModule",{value:!0});var MO=ky(),Uy=class extends MO.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};zy.Queue=Uy});var mn=fn(Yy=>{"use strict";Object.defineProperty(Yy,"__esModule",{value:!0});var BO=ky(),Xy=class extends BO.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};Yy.Stack=Xy});var or=fn(sa=>{"use strict";var Vp=sa&&sa.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,n++)i[n]=o[a];return i};Object.defineProperty(sa,"__esModule",{value:!0});sa.StringBuilder=sa.String=void 0;var mc=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{var n=t[0];if(Array.isArray(n)||n instanceof Array){for(var o=s.Empty,a=0,l=0;l<n.length;l++){var u=n[l];l<n.length-1?o+=u+e:o+=u}return o}else if(typeof n=="object"){var c=s.Empty,h=n,d=Object.keys(n);return d.forEach(function(p){c+=h[p]+e}),c=c.slice(0,c.length-e.length),c}var f=t;return s.join.apply(s,Vp([e],f))}catch(p){return console.log(p),s.Empty}},s.Format=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(n){return console.log(n),s.Empty}},s.format=function(e,t,i,n){return n===void 0&&(n=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return n?u=i[0][a]:u=i[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var i=t.replace(/,/g,".");if(isNaN(parseFloat(i))||i.length<=3)break;var n=i.split(/[^0-9]+/g),o=n;n.length>1&&(o=[s.join.apply(s,Vp([""],n.splice(0,n.length-1))),n[n.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var i=parseFloat(e),n=i.toString(16);return t?n.toLocaleUpperCase():n},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var i=t[t.length-1],n=t[t.length-2],o=t[t.length-3];return i=i.split("T")[0],i=i.split(" ")[0],i+"."+n+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var i=t[t.length-1].split(" "),n=s.Empty;i.length>1&&(n=i[i.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(n)&&n.length>1?u+="T"+n:u+="T00:00:00",u},s.formatNumber=function(e,t){var i=t.length,n=e.toString();if(i<=n.length)return n;var o=i-n.length;return o+=1,new Array(o).join("0")+n},s.join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var n=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];n+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){n+=e,o=l-1;break}}return n},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();sa.String=mc;var zO=function(){function s(e){this.Values=[],mc.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(mc.Format.apply(mc,Vp([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(`\r
`+mc.Format.apply(mc,Vp([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();sa.StringBuilder=zO});var NC=fn((Kge,_C)=>{"use strict";function f_(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function nu(s,e,t,i){this.message=s,this.expected=e,this.found=t,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,nu)}f_(nu,Error);nu.buildMessage=function(s,e){var t={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,f;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,f=1;d<h.length;d++)h[d-1]!==h[d]&&(h[f]=h[d],f++);h.length=f}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function g_(s,e){e=e!==void 0?e:{};var t={},i={start:Ux},n=Ux,o="strict",a=Te("strict",!0),l="graph",u=Te("graph",!0),c="digraph",h=Te("digraph",!0),d="{",f=Te("{",!1),p="}",S=Te("}",!1),x=function(P,A,V,D){D===null&&(D=[]);var H={type:A.toLowerCase(),children:D};return P&&(H.strict=!0),V&&(H.id=V),H},C=";",O=Te(";",!1),B=function(P,A){return A},I=function(P,A){return[P].concat(A)},_="=",X=Te("=",!1),K=function(P,A){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:P,eq:A}]}},se="node",ge=Te("node",!0),ue="edge",F=Te("edge",!0),M=function(P,A){return{type:"attr_stmt",target:P,attr_list:A}},W="[",j=Te("[",!1),te="]",oe=Te("]",!1),he=function(P,A){return(P||[]).concat(A||[])},Le=function(P,A){return A},Ge=",",rr=Te(",",!1),fi=function(P,A,V){return[{type:"attr",id:P,eq:A}].concat(V||[])},Hr=function(P,A,V){var D=[P];return D=D.concat(A.map(function(H){return H.id})),{type:"edge_stmt",edge_list:D,attr_list:V||[]}},lp="->",Zh=Te("->",!1),up="--",hy=Te("--",!1),Lr=function(P,A,V){return[{type:"edgeRHS",edgeop:P,id:A}].concat(V||[])},ns=function(P,A){return{type:"node_stmt",node_id:P,attr_list:A||[]}},Nt=function(P,A){return A?{type:"node_id",id:P,port:A}:{type:"node_id",id:P}},jr=So("port"),Zs=":",os=Te(":",!1),yl=function(P,A){return A},Sl=function(P,A){return{type:"port",id:P,compass_pt:A||null}},El=function(P){return{type:"port",compass_pt:P||null}},un="subgraph",ss=Te("subgraph",!0),cp=function(P){return P?{type:"subgraph",id:P}:{type:"subgraph"}},hp=function(P,A){return P=P||{type:"subgraph"},P.children=A||[],P},$u="n",Ai=Te("n",!1),dp="ne",dy=Te("ne",!1),fy="e",gy=Te("e",!1),fp="se",gp=Te("se",!1),pp="s",mp=Te("s",!1),Qh="sw",ec=Te("sw",!1),Jh="w",py=Te("w",!1),bp="nw",my=Te("nw",!1),by=So("UNICODE_STRING"),Py=function(P,A){return P+A.join("")},tc=function(P,A){return P+A},yy="$",Sy=Te("$",!1),Pp="_",yp=Te("_",!1),$h=So("NUMBER"),Ey="-",xy=Te("-",!1),Sp=".",ed=Te(".",!1),Qs=/^[0-9]/,Js=Hi([["0","9"]],!1,!1),vy=function(P){return parseFloat(Gx())},rc=function(P){return{type:"id",value:P.slice(1,P.length-1),html:!0}},td="<",rd=Te("<",!1),ic=">",xl=Te(">",!1),Cy=function(P){return"<"+P.join("")+">"},Ui=XR(),$s=function(P){return P},Ep=function(P){return P.join("")},nc='"',oc=Te('"',!1),id=function(P){return P.join("")},nd=function(){return Gx()},cn="\\",bo=Te("\\",!1),vl=function(P){return P[1]==='"'?'"':P[0]+P[1]},Cl=function(){return""},od=/^[\n\r\u2028\u2029]/,Ay=Hi([`
`,"\r","\u2028","\u2029"],!1,!1),Ty=So("end of line"),sc=`
`,Ti=Te(`
`,!1),as=`\r
`,Po=Te(`\r
`,!1),Fn="\r",Al=Te("\r",!1),hn="\u2028",Gn=Te("\u2028",!1),xp="\u2029",vp=Te("\u2029",!1),ac=/^[^"\\\0-\x1F\x7F]/,zi=Hi(['"',"\\",["\0",""],"\x7F"],!0,!1),Tl='\\"',sd=Te('\\"',!1),ad=function(){return'"'},ld=function(){return"\\"},ud=So("COMMENT"),lc=So("BLOCK_COMMENT"),dn="/*",Iy=Te("/*",!1),ls="*/",Il=Te("*/",!1),cd=function(P){return P},wy=function(P){return P.join("")},Ly=So("C_COMMENT"),v="//",w=Te("//",!1),N=/^[\n]/,k=Hi([`
`],!1,!1),$=function(P){return P.join("")},ae=So("MACRO_COMMENT"),Ne="#",Qt=Te("#",!1),ir=So("WHITESPACE"),pr=/^[\n\r]/,Wi=Hi([`
`,"\r"],!1,!1),Dx=/^[ \t]/,Fx=Hi([" ","	"],!1,!1),NR=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,MR=Hi([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),BR=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,DR=Hi([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),FR=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,GR=Hi(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),VR=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,kR=Hi(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),UR=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,zR=Hi([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),WR=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,HR=Hi([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),jR=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,qR=Hi([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),E=0,Ee=0,Cp=[{line:1,column:1}],yo=0,Ry=[],z=0,Ap;if("startRule"in e){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=i[e.startRule]}function Gx(){return s.substring(Ee,E)}function r4(){return hd(Ee,E)}function i4(P,A){throw A=A!==void 0?A:hd(Ee,E),kx([So(P)],s.substring(Ee,E),A)}function n4(P,A){throw A=A!==void 0?A:hd(Ee,E),KR(P,A)}function Te(P,A){return{type:"literal",text:P,ignoreCase:A}}function Hi(P,A,V){return{type:"class",parts:P,inverted:A,ignoreCase:V}}function XR(){return{type:"any"}}function YR(){return{type:"end"}}function So(P){return{type:"other",description:P}}function Vx(P){var A=Cp[P],V;if(A)return A;for(V=P-1;!Cp[V];)V--;for(A=Cp[V],A={line:A.line,column:A.column};V<P;)s.charCodeAt(V)===10?(A.line++,A.column=1):A.column++,V++;return Cp[P]=A,A}function hd(P,A){var V=Vx(P),D=Vx(A);return{start:{offset:P,line:V.line,column:V.column},end:{offset:A,line:D.line,column:D.column}}}function Z(P){E<yo||(E>yo&&(yo=E,Ry=[]),Ry.push(P))}function KR(P,A){return new nu(P,null,null,A)}function kx(P,A,V){return new nu(nu.buildMessage(P,A),P,A,V)}function Ux(){var P,A;if(P=[],A=zx(),A!==t)for(;A!==t;)P.push(A),A=zx();else P=t;return P}function zx(){var P,A,V,D,H,Q,ce,Tt,It,xo,ji,Dy,rv;return P=E,A=at(),A!==t?(s.substr(E,6).toLowerCase()===o?(V=s.substr(E,6),E+=6):(V=t,z===0&&Z(a)),V===t&&(V=null),V!==t?(D=at(),D!==t?(s.substr(E,5).toLowerCase()===l?(H=s.substr(E,5),E+=5):(H=t,z===0&&Z(u)),H===t&&(s.substr(E,7).toLowerCase()===c?(H=s.substr(E,7),E+=7):(H=t,z===0&&Z(h))),H!==t?(Q=at(),Q!==t?(ce=Eo(),ce===t&&(ce=null),ce!==t?(Tt=at(),Tt!==t?(s.charCodeAt(E)===123?(It=d,E++):(It=t,z===0&&Z(f)),It!==t?(xo=Wx(),xo===t&&(xo=null),xo!==t?(ji=at(),ji!==t?(s.charCodeAt(E)===125?(Dy=p,E++):(Dy=t,z===0&&Z(S)),Dy!==t?(rv=at(),rv!==t?(Ee=P,A=x(V,H,ce,xo),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function Wx(){var P,A,V,D,H,Q,ce,Tt,It,xo,ji;if(P=E,A=at(),A!==t)if(V=Oy(),V!==t)if(D=at(),D!==t)if(s.charCodeAt(E)===59?(H=C,E++):(H=t,z===0&&Z(O)),H===t&&(H=null),H!==t){for(Q=[],ce=E,Tt=at(),Tt!==t?(It=Oy(),It!==t?(xo=at(),xo!==t?(s.charCodeAt(E)===59?(ji=C,E++):(ji=t,z===0&&Z(O)),ji===t&&(ji=null),ji!==t?(Ee=ce,Tt=B(V,It),ce=Tt):(E=ce,ce=t)):(E=ce,ce=t)):(E=ce,ce=t)):(E=ce,ce=t);ce!==t;)Q.push(ce),ce=E,Tt=at(),Tt!==t?(It=Oy(),It!==t?(xo=at(),xo!==t?(s.charCodeAt(E)===59?(ji=C,E++):(ji=t,z===0&&Z(O)),ji===t&&(ji=null),ji!==t?(Ee=ce,Tt=B(V,It),ce=Tt):(E=ce,ce=t)):(E=ce,ce=t)):(E=ce,ce=t)):(E=ce,ce=t);Q!==t?(Ee=P,A=I(V,Q),P=A):(E=P,P=t)}else E=P,P=t;else E=P,P=t;else E=P,P=t;else E=P,P=t;return P}function Oy(){var P,A,V,D,H,Q;return P=E,A=Eo(),A!==t?(V=at(),V!==t?(s.charCodeAt(E)===61?(D=_,E++):(D=t,z===0&&Z(X)),D!==t?(H=at(),H!==t?(Q=Eo(),Q!==t?(Ee=P,A=K(A,Q),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P===t&&(P=ZR(),P===t&&(P=QR(),P===t&&(P=Ny(),P===t&&(P=JR(),P===t&&(P=E,A=Eo(),A!==t?(s.charCodeAt(E)===61?(V=_,E++):(V=t,z===0&&Z(X)),V!==t?(D=Eo(),D!==t?(A=[A,V,D],P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)))))),P}function ZR(){var P,A,V;return P=E,s.substr(E,5).toLowerCase()===l?(A=s.substr(E,5),E+=5):(A=t,z===0&&Z(u)),A===t&&(s.substr(E,4).toLowerCase()===se?(A=s.substr(E,4),E+=4):(A=t,z===0&&Z(ge)),A===t&&(s.substr(E,4).toLowerCase()===ue?(A=s.substr(E,4),E+=4):(A=t,z===0&&Z(F)))),A!==t?(V=Tp(),V!==t?(Ee=P,A=M(A,V),P=A):(E=P,P=t)):(E=P,P=t),P}function Tp(){var P,A,V,D,H,Q,ce,Tt,It;return P=E,A=at(),A!==t?(s.charCodeAt(E)===91?(V=W,E++):(V=t,z===0&&Z(j)),V!==t?(D=at(),D!==t?(H=Hx(),H===t&&(H=null),H!==t?(Q=at(),Q!==t?(s.charCodeAt(E)===93?(ce=te,E++):(ce=t,z===0&&Z(oe)),ce!==t?(Tt=at(),Tt!==t?(It=Tp(),It===t&&(It=null),It!==t?(Ee=P,A=he(H,It),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function Hx(){var P,A,V,D,H,Q,ce,Tt;return P=E,A=at(),A!==t?(V=Eo(),V!==t?(D=E,H=at(),H!==t?(s.charCodeAt(E)===61?(Q=_,E++):(Q=t,z===0&&Z(X)),Q!==t?(ce=at(),ce!==t?(Tt=Eo(),Tt!==t?(Ee=D,H=Le(V,Tt),D=H):(E=D,D=t)):(E=D,D=t)):(E=D,D=t)):(E=D,D=t),D===t&&(D=null),D!==t?(H=at(),H!==t?(s.charCodeAt(E)===44?(Q=Ge,E++):(Q=t,z===0&&Z(rr)),Q===t&&(s.charCodeAt(E)===59?(Q=C,E++):(Q=t,z===0&&Z(O))),Q===t&&(Q=null),Q!==t?(ce=Hx(),ce===t&&(ce=null),ce!==t?(Ee=P,A=fi(V,D,ce),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function QR(){var P,A,V,D;return P=E,A=Ny(),A===t&&(A=_y()),A!==t?(V=jx(),V!==t?(D=Tp(),D===t&&(D=null),D!==t?(Ee=P,A=Hr(A,V,D),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function jx(){var P,A,V,D,H,Q,ce;return P=E,A=at(),A!==t?(s.substr(E,2)===lp?(V=lp,E+=2):(V=t,z===0&&Z(Zh)),V===t&&(s.substr(E,2)===up?(V=up,E+=2):(V=t,z===0&&Z(hy))),V!==t?(D=at(),D!==t?(H=Ny(),H===t&&(H=_y()),H!==t?(Q=at(),Q!==t?(ce=jx(),ce===t&&(ce=null),ce!==t?(Ee=P,A=Lr(V,H,ce),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function JR(){var P,A,V;return P=E,A=_y(),A!==t?(V=Tp(),V===t&&(V=null),V!==t?(Ee=P,A=ns(A,V),P=A):(E=P,P=t)):(E=P,P=t),P}function _y(){var P,A,V;return P=E,A=Eo(),A!==t?(V=$R(),V===t&&(V=null),V!==t?(Ee=P,A=Nt(A,V),P=A):(E=P,P=t)):(E=P,P=t),P}function $R(){var P,A,V,D,H,Q;return z++,P=E,s.charCodeAt(E)===58?(A=Zs,E++):(A=t,z===0&&Z(os)),A!==t?(V=Eo(),V!==t?(D=E,s.charCodeAt(E)===58?(H=Zs,E++):(H=t,z===0&&Z(os)),H!==t?(Q=qx(),Q!==t?(Ee=D,H=yl(V,Q),D=H):(E=D,D=t)):(E=D,D=t),D===t&&(D=null),D!==t?(Ee=P,A=Sl(V,D),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P===t&&(P=E,s.charCodeAt(E)===58?(A=Zs,E++):(A=t,z===0&&Z(os)),A!==t?(V=qx(),V!==t?(Ee=P,A=El(V),P=A):(E=P,P=t)):(E=P,P=t)),z--,P===t&&(A=t,z===0&&Z(jr)),P}function Ny(){var P,A,V,D,H,Q;return P=E,A=E,s.substr(E,8).toLowerCase()===un?(V=s.substr(E,8),E+=8):(V=t,z===0&&Z(ss)),V!==t?(D=at(),D!==t?(H=Eo(),H===t&&(H=null),H!==t?(Q=at(),Q!==t?(Ee=A,V=cp(H),A=V):(E=A,A=t)):(E=A,A=t)):(E=A,A=t)):(E=A,A=t),A===t&&(A=null),A!==t?(s.charCodeAt(E)===123?(V=d,E++):(V=t,z===0&&Z(f)),V!==t?(D=Wx(),D===t&&(D=null),D!==t?(H=at(),H!==t?(s.charCodeAt(E)===125?(Q=p,E++):(Q=t,z===0&&Z(S)),Q!==t?(Ee=P,A=hp(A,D),P=A):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t)):(E=P,P=t),P}function qx(){var P;return s.charCodeAt(E)===110?(P=$u,E++):(P=t,z===0&&Z(Ai)),P===t&&(s.substr(E,2)===dp?(P=dp,E+=2):(P=t,z===0&&Z(dy)),P===t&&(s.charCodeAt(E)===101?(P=fy,E++):(P=t,z===0&&Z(gy)),P===t&&(s.substr(E,2)===fp?(P=fp,E+=2):(P=t,z===0&&Z(gp)),P===t&&(s.charCodeAt(E)===115?(P=pp,E++):(P=t,z===0&&Z(mp)),P===t&&(s.substr(E,2)===Qh?(P=Qh,E+=2):(P=t,z===0&&Z(ec)),P===t&&(s.charCodeAt(E)===119?(P=Jh,E++):(P=t,z===0&&Z(py)),P===t&&(s.substr(E,2)===bp?(P=bp,E+=2):(P=t,z===0&&Z(my))))))))),P}function Eo(){var P;return P=Xx(),P===t&&(P=eO(),P===t&&(P=Zx(),P===t&&(P=rO(),P===t&&(P=tO())))),P}function Xx(){var P,A,V,D;if(z++,P=E,A=Yx(),A!==t){for(V=[],D=Kx();D!==t;)V.push(D),D=Kx();V!==t?(Ee=P,A=Py(A,V),P=A):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(A=t,z===0&&Z(by)),P}function eO(){var P,A,V;return P=E,A=Zx(),A!==t?(V=Xx(),V!==t?(Ee=P,A=tc(A,V),P=A):(E=P,P=t)):(E=P,P=t),P}function Yx(){var P;return P=hO(),P===t&&(s.charCodeAt(E)===36?(P=yy,E++):(P=t,z===0&&Z(Sy)),P===t&&(s.charCodeAt(E)===95?(P=Pp,E++):(P=t,z===0&&Z(yp)))),P}function Kx(){var P;return P=Yx(),P===t&&(P=PO()),P}function Zx(){var P,A,V,D,H,Q,ce,Tt,It;if(z++,P=E,A=E,s.charCodeAt(E)===45?(V=Ey,E++):(V=t,z===0&&Z(xy)),V===t&&(V=null),V!==t){if(D=E,s.charCodeAt(E)===46?(H=Sp,E++):(H=t,z===0&&Z(ed)),H!==t){if(Q=[],Qs.test(s.charAt(E))?(ce=s.charAt(E),E++):(ce=t,z===0&&Z(Js)),ce!==t)for(;ce!==t;)Q.push(ce),Qs.test(s.charAt(E))?(ce=s.charAt(E),E++):(ce=t,z===0&&Z(Js));else Q=t;Q!==t?(H=[H,Q],D=H):(E=D,D=t)}else E=D,D=t;if(D===t){if(D=E,H=[],Qs.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Js)),Q!==t)for(;Q!==t;)H.push(Q),Qs.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Js));else H=t;if(H!==t){if(Q=E,s.charCodeAt(E)===46?(ce=Sp,E++):(ce=t,z===0&&Z(ed)),ce!==t){for(Tt=[],Qs.test(s.charAt(E))?(It=s.charAt(E),E++):(It=t,z===0&&Z(Js));It!==t;)Tt.push(It),Qs.test(s.charAt(E))?(It=s.charAt(E),E++):(It=t,z===0&&Z(Js));Tt!==t?(ce=[ce,Tt],Q=ce):(E=Q,Q=t)}else E=Q,Q=t;Q===t&&(Q=null),Q!==t?(H=[H,Q],D=H):(E=D,D=t)}else E=D,D=t}D!==t?(V=[V,D],A=V):(E=A,A=t)}else E=A,A=t;return A!==t&&(Ee=P,A=vy(A)),P=A,z--,P===t&&(A=t,z===0&&Z($h)),P}function tO(){var P,A;return P=E,A=My(),A!==t&&(Ee=P,A=rc(A)),P=A,P}function My(){var P,A,V,D;if(P=E,s.charCodeAt(E)===60?(A=td,E++):(A=t,z===0&&Z(rd)),A!==t){for(V=[],D=Qx(),D===t&&(D=My());D!==t;)V.push(D),D=Qx(),D===t&&(D=My());V!==t?(s.charCodeAt(E)===62?(D=ic,E++):(D=t,z===0&&Z(xl)),D!==t?(Ee=P,A=Cy(V),P=A):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return P}function Qx(){var P,A,V,D,H;if(P=E,A=[],V=E,D=E,z++,s.charCodeAt(E)===62?(H=ic,E++):(H=t,z===0&&Z(xl)),H===t&&(s.charCodeAt(E)===60?(H=td,E++):(H=t,z===0&&Z(rd))),z--,H===t?D=void 0:(E=D,D=t),D!==t?(s.length>E?(H=s.charAt(E),E++):(H=t,z===0&&Z(Ui)),H!==t?(Ee=V,D=$s(H),V=D):(E=V,V=t)):(E=V,V=t),V!==t)for(;V!==t;)A.push(V),V=E,D=E,z++,s.charCodeAt(E)===62?(H=ic,E++):(H=t,z===0&&Z(xl)),H===t&&(s.charCodeAt(E)===60?(H=td,E++):(H=t,z===0&&Z(rd))),z--,H===t?D=void 0:(E=D,D=t),D!==t?(s.length>E?(H=s.charAt(E),E++):(H=t,z===0&&Z(Ui)),H!==t?(Ee=V,D=$s(H),V=D):(E=V,V=t)):(E=V,V=t);else A=t;return A!==t&&(Ee=P,A=Ep(A)),P=A,P}function rO(){var P,A,V,D;if(P=E,s.charCodeAt(E)===34?(A=nc,E++):(A=t,z===0&&Z(oc)),A!==t){for(V=[],D=Jx();D!==t;)V.push(D),D=Jx();V!==t?(s.charCodeAt(E)===34?(D=nc,E++):(D=t,z===0&&Z(oc)),D!==t?(Ee=P,A=id(V),P=A):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return P}function Jx(){var P,A,V;return P=iO(),P===t&&(P=E,A=E,z++,s.charCodeAt(E)===34?(V=nc,E++):(V=t,z===0&&Z(oc)),V===t&&(V=oO()),z--,V===t?A=void 0:(E=A,A=t),A!==t?(V=aO(),V!==t?(Ee=P,A=nd(),P=A):(E=P,P=t)):(E=P,P=t),P===t&&(P=nO())),P}function iO(){var P,A,V,D;return P=E,A=E,s.charCodeAt(E)===92?(V=cn,E++):(V=t,z===0&&Z(bo)),V!==t?(s.length>E?(D=s.charAt(E),E++):(D=t,z===0&&Z(Ui)),D!==t?(V=[V,D],A=V):(E=A,A=t)):(E=A,A=t),A!==t&&(Ee=P,A=vl(A)),P=A,P}function nO(){var P,A,V;return P=E,s.charCodeAt(E)===92?(A=cn,E++):(A=t,z===0&&Z(bo)),A!==t?(V=sO(),V!==t?(Ee=P,A=Cl(),P=A):(E=P,P=t)):(E=P,P=t),P}function oO(){var P;return od.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(Ay)),P}function sO(){var P,A;return z++,s.charCodeAt(E)===10?(P=sc,E++):(P=t,z===0&&Z(Ti)),P===t&&(s.substr(E,2)===as?(P=as,E+=2):(P=t,z===0&&Z(Po)),P===t&&(s.charCodeAt(E)===13?(P=Fn,E++):(P=t,z===0&&Z(Al)),P===t&&(s.charCodeAt(E)===8232?(P=hn,E++):(P=t,z===0&&Z(Gn)),P===t&&(s.charCodeAt(E)===8233?(P=xp,E++):(P=t,z===0&&Z(vp)))))),z--,P===t&&(A=t,z===0&&Z(Ty)),P}function aO(){var P;return s.length>E?(P=s.charAt(E),E++):(P=t,z===0&&Z(Ui)),P}function o4(){var P,A,V;if(P=E,A=[],V=$x(),V!==t)for(;V!==t;)A.push(V),V=$x();else A=t;return A!==t&&(Ee=P,A=id(A)),P=A,P}function $x(){var P,A,V;return ac.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(zi)),P===t&&(P=E,s.substr(E,2)===Tl?(A=Tl,E+=2):(A=t,z===0&&Z(sd)),A!==t&&(Ee=P,A=ad()),P=A,P===t&&(P=E,s.charCodeAt(E)===92?(A=cn,E++):(A=t,z===0&&Z(bo)),A!==t?(V=By(),V!==t?(Ee=P,A=Cl(),P=A):(E=P,P=t)):(E=P,P=t),P===t&&(P=E,s.charCodeAt(E)===92?(A=cn,E++):(A=t,z===0&&Z(bo)),A!==t&&(Ee=P,A=ld()),P=A))),P}function ev(){var P,A;return z++,P=lO(),P===t&&(P=uO(),P===t&&(P=cO())),z--,P===t&&(A=t,z===0&&Z(ud)),P}function lO(){var P,A,V,D,H,Q;if(z++,P=E,s.substr(E,2)===dn?(A=dn,E+=2):(A=t,z===0&&Z(Iy)),A!==t){for(V=[],D=E,H=E,z++,s.substr(E,2)===ls?(Q=ls,E+=2):(Q=t,z===0&&Z(Il)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=cd(Q),D=H):(E=D,D=t)):(E=D,D=t);D!==t;)V.push(D),D=E,H=E,z++,s.substr(E,2)===ls?(Q=ls,E+=2):(Q=t,z===0&&Z(Il)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=cd(Q),D=H):(E=D,D=t)):(E=D,D=t);V!==t?(s.substr(E,2)===ls?(D=ls,E+=2):(D=t,z===0&&Z(Il)),D!==t?(Ee=P,A=wy(V),P=A):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(A=t,z===0&&Z(lc)),P}function uO(){var P,A,V,D,H,Q;if(z++,P=E,s.substr(E,2)===v?(A=v,E+=2):(A=t,z===0&&Z(w)),A!==t){for(V=[],D=E,H=E,z++,N.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(k)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=$s(Q),D=H):(E=D,D=t)):(E=D,D=t);D!==t;)V.push(D),D=E,H=E,z++,N.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(k)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=$s(Q),D=H):(E=D,D=t)):(E=D,D=t);V!==t?(N.test(s.charAt(E))?(D=s.charAt(E),E++):(D=t,z===0&&Z(k)),D===t&&(D=null),D!==t?(Ee=P,A=$(V),P=A):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(A=t,z===0&&Z(Ly)),P}function cO(){var P,A,V,D,H,Q;if(z++,P=E,s.charCodeAt(E)===35?(A=Ne,E++):(A=t,z===0&&Z(Qt)),A!==t){for(V=[],D=E,H=E,z++,N.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(k)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=$s(Q),D=H):(E=D,D=t)):(E=D,D=t);D!==t;)V.push(D),D=E,H=E,z++,N.test(s.charAt(E))?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(k)),z--,Q===t?H=void 0:(E=H,H=t),H!==t?(s.length>E?(Q=s.charAt(E),E++):(Q=t,z===0&&Z(Ui)),Q!==t?(Ee=D,H=$s(Q),D=H):(E=D,D=t)):(E=D,D=t);V!==t?(N.test(s.charAt(E))?(D=s.charAt(E),E++):(D=t,z===0&&Z(k)),D===t&&(D=null),D!==t?(Ee=P,A=$(V),P=A):(E=P,P=t)):(E=P,P=t)}else E=P,P=t;return z--,P===t&&(A=t,z===0&&Z(ae)),P}function at(){var P,A;for(z++,P=[],A=tv(),A===t&&(A=ev());A!==t;)P.push(A),A=tv(),A===t&&(A=ev());return z--,P===t&&(A=t,z===0&&Z(ir)),P}function By(){var P,A;if(P=[],pr.test(s.charAt(E))?(A=s.charAt(E),E++):(A=t,z===0&&Z(Wi)),A!==t)for(;A!==t;)P.push(A),pr.test(s.charAt(E))?(A=s.charAt(E),E++):(A=t,z===0&&Z(Wi));else P=t;return P}function tv(){var P,A;if(P=[],Dx.test(s.charAt(E))?(A=s.charAt(E),E++):(A=t,z===0&&Z(Fx)),A===t&&(A=By()),A!==t)for(;A!==t;)P.push(A),Dx.test(s.charAt(E))?(A=s.charAt(E),E++):(A=t,z===0&&Z(Fx)),A===t&&(A=By());else P=t;return P}function hO(){var P;return P=mO(),P===t&&(P=dO(),P===t&&(P=pO(),P===t&&(P=fO(),P===t&&(P=gO(),P===t&&(P=bO()))))),P}function dO(){var P;return NR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(MR)),P}function fO(){var P;return BR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(DR)),P}function gO(){var P;return FR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(GR)),P}function pO(){var P;return VR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(kR)),P}function mO(){var P;return UR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(zR)),P}function bO(){var P;return WR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(HR)),P}function PO(){var P;return jR.test(s.charAt(E))?(P=s.charAt(E),E++):(P=t,z===0&&Z(qR)),P}if(Ap=n(),Ap!==t&&E===s.length)return Ap;throw Ap!==t&&E<s.length&&Z(YR()),kx(Ry,yo<s.length?s.charAt(yo):null,yo<s.length?hd(yo,yo+1):hd(yo,yo))}_C.exports={SyntaxError:nu,parse:g_}});var BC=fn((Zge,MC)=>{var p_=NC();MC.exports=p_.parse});var UC=fn((Qge,kC)=>{kC.exports={rgb2hsl:of,rgb2hsv:ab,rgb2hwb:sf,rgb2cmyk:af,rgb2keyword:lf,rgb2xyz:F0,rgb2lab:G0,rgb2lch:m_,hsl2rgb:lb,hsl2hsv:b_,hsl2hwb:P_,hsl2cmyk:y_,hsl2keyword:S_,hsv2rgb:ub,hsv2hsl:E_,hsv2hwb:x_,hsv2cmyk:v_,hsv2keyword:C_,hwb2rgb:uf,hwb2hsl:A_,hwb2hsv:T_,hwb2cmyk:I_,hwb2keyword:w_,cmyk2rgb:cf,cmyk2hsl:L_,cmyk2hsv:R_,cmyk2hwb:O_,cmyk2keyword:__,keyword2rgb:ou,keyword2hsl:D_,keyword2hsv:F_,keyword2hwb:G_,keyword2cmyk:V_,keyword2lab:k_,keyword2xyz:U_,xyz2rgb:DC,xyz2lab:FC,xyz2lch:N_,lab2xyz:V0,lab2rgb:GC,lab2lch:k0,lch2lab:U0,lch2xyz:M_,lch2rgb:B_};function of(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(n+o)/2,o==n?u=0:c<=.5?u=a/(o+n):u=a/(2-o-n),[l,u*100,c*100]}function ab(s){var e=s[0],t=s[1],i=s[2],n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function sf(s){var e=s[0],t=s[1],o=s[2],i=of(s)[0],n=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[i,n*100,o*100]}function af(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n,o,a,l;return l=Math.min(1-e,1-t,1-i),n=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-i-l)/(1-l)||0,[n*100,o*100,a*100,l*100]}function lf(s){return VC[JSON.stringify(s)]}function F0(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;var n=e*.4124+t*.3576+i*.1805,o=e*.2126+t*.7152+i*.0722,a=e*.0193+t*.1192+i*.9505;return[n*100,o*100,a*100]}function G0(s){var e=F0(s),t=e[0],i=e[1],n=e[2],o,a,l;return t/=95.047,i/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=116*i-16,a=500*(t-i),l=200*(i-n),[o,a,l]}function m_(s){return k0(G0(s))}function lb(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n,o,a,l,u;if(t==0)return u=i*255,[u,u,u];i<.5?o=i*(1+t):o=i+t-i*t,n=2*i-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=n+(o-n)*6*a:2*a<1?u=o:3*a<2?u=n+(o-n)*(2/3-a)*6:u=n,l[c]=u*255;return l}function b_(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return i===0?[0,0,0]:(i*=2,t*=i<=1?i:2-i,o=(i+t)/2,n=2*t/(i+t),[e,n*100,o*100])}function P_(s){return sf(lb(s))}function y_(s){return af(lb(s))}function S_(s){return lf(lb(s))}function ub(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,i=Math.floor(e)%6,n=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*n),l=255*u*(1-t*(1-n)),u=255*u;switch(i){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function E_(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return o=(2-t)*i,n=t*i,n/=o<=1?o:2-o,n=n||0,o/=2,[e,n*100,o*100]}function x_(s){return sf(ub(s))}function v_(s){return af(ub(s))}function C_(s){return lf(ub(s))}function uf(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n=t+i,o,a,l,u;switch(n>1&&(t/=n,i/=n),o=Math.floor(6*e),a=1-i,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function A_(s){return of(uf(s))}function T_(s){return ab(uf(s))}function I_(s){return af(uf(s))}function w_(s){return lf(uf(s))}function cf(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-n)+n),a=1-Math.min(1,t*(1-n)+n),l=1-Math.min(1,i*(1-n)+n),[o*255,a*255,l*255]}function L_(s){return of(cf(s))}function R_(s){return ab(cf(s))}function O_(s){return sf(cf(s))}function __(s){return lf(cf(s))}function DC(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n,o,a;return n=e*3.2406+t*-1.5372+i*-.4986,o=e*-.9689+t*1.8758+i*.0415,a=e*.0557+t*-.204+i*1.057,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n=n*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,n=Math.min(Math.max(0,n),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[n*255,o*255,a*255]}function FC(s){var e=s[0],t=s[1],i=s[2],n,o,a;return e/=95.047,t/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=116*t-16,o=500*(e-t),a=200*(t-i),[n,o,a]}function N_(s){return k0(FC(s))}function V0(s){var e=s[0],t=s[1],i=s[2],n,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),n=n/95.047<=.008856?n=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-i/200-16/116)/7.787:108.883*Math.pow(l-i/200,3),[n,o,a]}function k0(s){var e=s[0],t=s[1],i=s[2],n,o,a;return n=Math.atan2(i,t),o=n*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+i*i),[e,a,o]}function GC(s){return DC(V0(s))}function U0(s){var e=s[0],t=s[1],i=s[2],n,o,a;return a=i/360*2*Math.PI,n=t*Math.cos(a),o=t*Math.sin(a),[e,n,o]}function M_(s){return V0(U0(s))}function B_(s){return GC(U0(s))}function ou(s){return D0[s]}function D_(s){return of(ou(s))}function F_(s){return ab(ou(s))}function G_(s){return sf(ou(s))}function V_(s){return af(ou(s))}function k_(s){return G0(ou(s))}function U_(s){return F0(ou(s))}var D0={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},VC={};for(B0 in D0)VC[JSON.stringify(D0[B0])]=B0;var B0});var HC=fn((Jge,WC)=>{var z0=UC(),su=function(){return new hf};for(Zc in z0)su[Zc+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),z0[s](e)}}(Zc),W0=/(\w+)2(\w+)/.exec(Zc),cb=W0[1],zC=W0[2],su[cb]=su[cb]||{},su[cb][zC]=su[Zc]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=z0[s](e);if(typeof t=="string"||t===void 0)return t;for(var i=0;i<t.length;i++)t[i]=Math.round(t[i]);return t}}(Zc);var W0,cb,zC,Zc,hf=function(){this.convs={}};hf.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};hf.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};hf.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,i=this.convs[t];e=su[t][s](i),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){hf.prototype[s]=function(e){return this.routeSpace(s,arguments)}});WC.exports=su});var qC=fn(($ge,jC)=>{var H0=HC();jC.exports=function(s){var e,t,i,n;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=H0[a],i=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&i.push(1),n=i[l]===void 0?1:i[l],i=i.slice(0,l),t[a]=function(){return i}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=H0.rgb,i=a.split(l===3?/(.)/:/(..)/),i=i.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),n=1,t.rgb=function(){return i},i[0]||(i[0]=0),i[1]||(i[1]=0),i[2]||(i[2]=0)}else t=H0.keyword,t.keyword=function(){return s},i=s,n=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(i)}catch{}try{u.hsl=t.hsl(i)}catch{}try{u.hsv=t.hsv(i)}catch{}try{u.cmyk=t.cmyk(i)}catch{}try{u.keyword=t.keyword(i)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(n)),u.hsl&&(u.hsla=u.hsl.concat(n)),u.hsv&&(u.hsva=u.hsv.concat(n)),u.cmyk&&(u.cmyka=u.cmyk.concat(n)),u}});var ew=fn((HRe,xP)=>{(function(s,e,t,i){"use strict";var n=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",l=Math.round,u=Math.abs,c=Date.now;function h(v,w,N){return setTimeout(B(v,N),w)}function d(v,w,N){return Array.isArray(v)?(f(v,N[w],N),!0):!1}function f(v,w,N){var k;if(!!v)if(v.forEach)v.forEach(w,N);else if(v.length!==i)for(k=0;k<v.length;)w.call(N,v[k],k,v),k++;else for(k in v)v.hasOwnProperty(k)&&w.call(N,v[k],k,v)}function p(v,w,N){var k="DEPRECATED METHOD: "+w+`
`+N+` AT 
`;return function(){var $=new Error("get-stack-trace"),ae=$&&$.stack?$.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",Ne=s.console&&(s.console.warn||s.console.log);return Ne&&Ne.call(s.console,k,ae),v.apply(this,arguments)}}var S;typeof Object.assign!="function"?S=function(w){if(w===i||w===null)throw new TypeError("Cannot convert undefined or null to object");for(var N=Object(w),k=1;k<arguments.length;k++){var $=arguments[k];if($!==i&&$!==null)for(var ae in $)$.hasOwnProperty(ae)&&(N[ae]=$[ae])}return N}:S=Object.assign;var x=p(function(w,N,k){for(var $=Object.keys(N),ae=0;ae<$.length;)(!k||k&&w[$[ae]]===i)&&(w[$[ae]]=N[$[ae]]),ae++;return w},"extend","Use `assign`."),C=p(function(w,N){return x(w,N,!0)},"merge","Use `assign`.");function O(v,w,N){var k=w.prototype,$;$=v.prototype=Object.create(k),$.constructor=v,$._super=k,N&&S($,N)}function B(v,w){return function(){return v.apply(w,arguments)}}function I(v,w){return typeof v==a?v.apply(w&&w[0]||i,w):v}function _(v,w){return v===i?w:v}function X(v,w,N){f(ue(w),function(k){v.addEventListener(k,N,!1)})}function K(v,w,N){f(ue(w),function(k){v.removeEventListener(k,N,!1)})}function se(v,w){for(;v;){if(v==w)return!0;v=v.parentNode}return!1}function ge(v,w){return v.indexOf(w)>-1}function ue(v){return v.trim().split(/\s+/g)}function F(v,w,N){if(v.indexOf&&!N)return v.indexOf(w);for(var k=0;k<v.length;){if(N&&v[k][N]==w||!N&&v[k]===w)return k;k++}return-1}function M(v){return Array.prototype.slice.call(v,0)}function W(v,w,N){for(var k=[],$=[],ae=0;ae<v.length;){var Ne=w?v[ae][w]:v[ae];F($,Ne)<0&&k.push(v[ae]),$[ae]=Ne,ae++}return N&&(w?k=k.sort(function(ir,pr){return ir[w]>pr[w]}):k=k.sort()),k}function j(v,w){for(var N,k,$=w[0].toUpperCase()+w.slice(1),ae=0;ae<n.length;){if(N=n[ae],k=N?N+$:w,k in v)return k;ae++}return i}var te=1;function oe(){return te++}function he(v){var w=v.ownerDocument||v;return w.defaultView||w.parentWindow||s}var Le=/mobile|tablet|ip(ad|hone|od)|android/i,Ge="ontouchstart"in s,rr=j(s,"PointerEvent")!==i,fi=Ge&&Le.test(navigator.userAgent),Hr="touch",lp="pen",Zh="mouse",up="kinect",hy=25,Lr=1,ns=2,Nt=4,jr=8,Zs=1,os=2,yl=4,Sl=8,El=16,un=os|yl,ss=Sl|El,cp=un|ss,hp=["x","y"],$u=["clientX","clientY"];function Ai(v,w){var N=this;this.manager=v,this.callback=w,this.element=v.element,this.target=v.options.inputTarget,this.domHandler=function(k){I(v.options.enable,[v])&&N.handler(k)},this.init()}Ai.prototype={handler:function(){},init:function(){this.evEl&&X(this.element,this.evEl,this.domHandler),this.evTarget&&X(this.target,this.evTarget,this.domHandler),this.evWin&&X(he(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&K(this.element,this.evEl,this.domHandler),this.evTarget&&K(this.target,this.evTarget,this.domHandler),this.evWin&&K(he(this.element),this.evWin,this.domHandler)}};function dp(v){var w,N=v.options.inputClass;return N?w=N:rr?w=$h:fi?w=rc:Ge?w=xl:w=tc,new w(v,dy)}function dy(v,w,N){var k=N.pointers.length,$=N.changedPointers.length,ae=w&Lr&&k-$===0,Ne=w&(Nt|jr)&&k-$===0;N.isFirst=!!ae,N.isFinal=!!Ne,ae&&(v.session={}),N.eventType=w,fy(v,N),v.emit("hammer.input",N),v.recognize(N),v.session.prevInput=N}function fy(v,w){var N=v.session,k=w.pointers,$=k.length;N.firstInput||(N.firstInput=gp(w)),$>1&&!N.firstMultiple?N.firstMultiple=gp(w):$===1&&(N.firstMultiple=!1);var ae=N.firstInput,Ne=N.firstMultiple,Qt=Ne?Ne.center:ae.center,ir=w.center=pp(k);w.timeStamp=c(),w.deltaTime=w.timeStamp-ae.timeStamp,w.angle=Jh(Qt,ir),w.distance=ec(Qt,ir),gy(N,w),w.offsetDirection=Qh(w.deltaX,w.deltaY);var pr=mp(w.deltaTime,w.deltaX,w.deltaY);w.overallVelocityX=pr.x,w.overallVelocityY=pr.y,w.overallVelocity=u(pr.x)>u(pr.y)?pr.x:pr.y,w.scale=Ne?bp(Ne.pointers,k):1,w.rotation=Ne?py(Ne.pointers,k):0,w.maxPointers=N.prevInput?w.pointers.length>N.prevInput.maxPointers?w.pointers.length:N.prevInput.maxPointers:w.pointers.length,fp(N,w);var Wi=v.element;se(w.srcEvent.target,Wi)&&(Wi=w.srcEvent.target),w.target=Wi}function gy(v,w){var N=w.center,k=v.offsetDelta||{},$=v.prevDelta||{},ae=v.prevInput||{};(w.eventType===Lr||ae.eventType===Nt)&&($=v.prevDelta={x:ae.deltaX||0,y:ae.deltaY||0},k=v.offsetDelta={x:N.x,y:N.y}),w.deltaX=$.x+(N.x-k.x),w.deltaY=$.y+(N.y-k.y)}function fp(v,w){var N=v.lastInterval||w,k=w.timeStamp-N.timeStamp,$,ae,Ne,Qt;if(w.eventType!=jr&&(k>hy||N.velocity===i)){var ir=w.deltaX-N.deltaX,pr=w.deltaY-N.deltaY,Wi=mp(k,ir,pr);ae=Wi.x,Ne=Wi.y,$=u(Wi.x)>u(Wi.y)?Wi.x:Wi.y,Qt=Qh(ir,pr),v.lastInterval=w}else $=N.velocity,ae=N.velocityX,Ne=N.velocityY,Qt=N.direction;w.velocity=$,w.velocityX=ae,w.velocityY=Ne,w.direction=Qt}function gp(v){for(var w=[],N=0;N<v.pointers.length;)w[N]={clientX:l(v.pointers[N].clientX),clientY:l(v.pointers[N].clientY)},N++;return{timeStamp:c(),pointers:w,center:pp(w),deltaX:v.deltaX,deltaY:v.deltaY}}function pp(v){var w=v.length;if(w===1)return{x:l(v[0].clientX),y:l(v[0].clientY)};for(var N=0,k=0,$=0;$<w;)N+=v[$].clientX,k+=v[$].clientY,$++;return{x:l(N/w),y:l(k/w)}}function mp(v,w,N){return{x:w/v||0,y:N/v||0}}function Qh(v,w){return v===w?Zs:u(v)>=u(w)?v<0?os:yl:w<0?Sl:El}function ec(v,w,N){N||(N=hp);var k=w[N[0]]-v[N[0]],$=w[N[1]]-v[N[1]];return Math.sqrt(k*k+$*$)}function Jh(v,w,N){N||(N=hp);var k=w[N[0]]-v[N[0]],$=w[N[1]]-v[N[1]];return Math.atan2($,k)*180/Math.PI}function py(v,w){return Jh(w[1],w[0],$u)+Jh(v[1],v[0],$u)}function bp(v,w){return ec(w[0],w[1],$u)/ec(v[0],v[1],$u)}var my={mousedown:Lr,mousemove:ns,mouseup:Nt},by="mousedown",Py="mousemove mouseup";function tc(){this.evEl=by,this.evWin=Py,this.pressed=!1,Ai.apply(this,arguments)}O(tc,Ai,{handler:function(w){var N=my[w.type];N&Lr&&w.button===0&&(this.pressed=!0),N&ns&&w.which!==1&&(N=Nt),this.pressed&&(N&Nt&&(this.pressed=!1),this.callback(this.manager,N,{pointers:[w],changedPointers:[w],pointerType:Zh,srcEvent:w}))}});var yy={pointerdown:Lr,pointermove:ns,pointerup:Nt,pointercancel:jr,pointerout:jr},Sy={2:Hr,3:lp,4:Zh,5:up},Pp="pointerdown",yp="pointermove pointerup pointercancel";s.MSPointerEvent&&!s.PointerEvent&&(Pp="MSPointerDown",yp="MSPointerMove MSPointerUp MSPointerCancel");function $h(){this.evEl=Pp,this.evWin=yp,Ai.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}O($h,Ai,{handler:function(w){var N=this.store,k=!1,$=w.type.toLowerCase().replace("ms",""),ae=yy[$],Ne=Sy[w.pointerType]||w.pointerType,Qt=Ne==Hr,ir=F(N,w.pointerId,"pointerId");ae&Lr&&(w.button===0||Qt)?ir<0&&(N.push(w),ir=N.length-1):ae&(Nt|jr)&&(k=!0),!(ir<0)&&(N[ir]=w,this.callback(this.manager,ae,{pointers:N,changedPointers:[w],pointerType:Ne,srcEvent:w}),k&&N.splice(ir,1))}});var Ey={touchstart:Lr,touchmove:ns,touchend:Nt,touchcancel:jr},xy="touchstart",Sp="touchstart touchmove touchend touchcancel";function ed(){this.evTarget=xy,this.evWin=Sp,this.started=!1,Ai.apply(this,arguments)}O(ed,Ai,{handler:function(w){var N=Ey[w.type];if(N===Lr&&(this.started=!0),!!this.started){var k=Qs.call(this,w,N);N&(Nt|jr)&&k[0].length-k[1].length===0&&(this.started=!1),this.callback(this.manager,N,{pointers:k[0],changedPointers:k[1],pointerType:Hr,srcEvent:w})}}});function Qs(v,w){var N=M(v.touches),k=M(v.changedTouches);return w&(Nt|jr)&&(N=W(N.concat(k),"identifier",!0)),[N,k]}var Js={touchstart:Lr,touchmove:ns,touchend:Nt,touchcancel:jr},vy="touchstart touchmove touchend touchcancel";function rc(){this.evTarget=vy,this.targetIds={},Ai.apply(this,arguments)}O(rc,Ai,{handler:function(w){var N=Js[w.type],k=td.call(this,w,N);!k||this.callback(this.manager,N,{pointers:k[0],changedPointers:k[1],pointerType:Hr,srcEvent:w})}});function td(v,w){var N=M(v.touches),k=this.targetIds;if(w&(Lr|ns)&&N.length===1)return k[N[0].identifier]=!0,[N,N];var $,ae,Ne=M(v.changedTouches),Qt=[],ir=this.target;if(ae=N.filter(function(pr){return se(pr.target,ir)}),w===Lr)for($=0;$<ae.length;)k[ae[$].identifier]=!0,$++;for($=0;$<Ne.length;)k[Ne[$].identifier]&&Qt.push(Ne[$]),w&(Nt|jr)&&delete k[Ne[$].identifier],$++;if(!!Qt.length)return[W(ae.concat(Qt),"identifier",!0),Qt]}var rd=2500,ic=25;function xl(){Ai.apply(this,arguments);var v=B(this.handler,this);this.touch=new rc(this.manager,v),this.mouse=new tc(this.manager,v),this.primaryTouch=null,this.lastTouches=[]}O(xl,Ai,{handler:function(w,N,k){var $=k.pointerType==Hr,ae=k.pointerType==Zh;if(!(ae&&k.sourceCapabilities&&k.sourceCapabilities.firesTouchEvents)){if($)Cy.call(this,N,k);else if(ae&&$s.call(this,k))return;this.callback(w,N,k)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function Cy(v,w){v&Lr?(this.primaryTouch=w.changedPointers[0].identifier,Ui.call(this,w)):v&(Nt|jr)&&Ui.call(this,w)}function Ui(v){var w=v.changedPointers[0];if(w.identifier===this.primaryTouch){var N={x:w.clientX,y:w.clientY};this.lastTouches.push(N);var k=this.lastTouches,$=function(){var ae=k.indexOf(N);ae>-1&&k.splice(ae,1)};setTimeout($,rd)}}function $s(v){for(var w=v.srcEvent.clientX,N=v.srcEvent.clientY,k=0;k<this.lastTouches.length;k++){var $=this.lastTouches[k],ae=Math.abs(w-$.x),Ne=Math.abs(N-$.y);if(ae<=ic&&Ne<=ic)return!0}return!1}var Ep=j(o.style,"touchAction"),nc=Ep!==i,oc="compute",id="auto",nd="manipulation",cn="none",bo="pan-x",vl="pan-y",Cl=Ty();function od(v,w){this.manager=v,this.set(w)}od.prototype={set:function(v){v==oc&&(v=this.compute()),nc&&this.manager.element.style&&Cl[v]&&(this.manager.element.style[Ep]=v),this.actions=v.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var v=[];return f(this.manager.recognizers,function(w){I(w.options.enable,[w])&&(v=v.concat(w.getTouchAction()))}),Ay(v.join(" "))},preventDefaults:function(v){var w=v.srcEvent,N=v.offsetDirection;if(this.manager.session.prevented){w.preventDefault();return}var k=this.actions,$=ge(k,cn)&&!Cl[cn],ae=ge(k,vl)&&!Cl[vl],Ne=ge(k,bo)&&!Cl[bo];if($){var Qt=v.pointers.length===1,ir=v.distance<2,pr=v.deltaTime<250;if(Qt&&ir&&pr)return}if(!(Ne&&ae)&&($||ae&&N&un||Ne&&N&ss))return this.preventSrc(w)},preventSrc:function(v){this.manager.session.prevented=!0,v.preventDefault()}};function Ay(v){if(ge(v,cn))return cn;var w=ge(v,bo),N=ge(v,vl);return w&&N?cn:w||N?w?bo:vl:ge(v,nd)?nd:id}function Ty(){if(!nc)return!1;var v={},w=s.CSS&&s.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(N){v[N]=w?s.CSS.supports("touch-action",N):!0}),v}var sc=1,Ti=2,as=4,Po=8,Fn=Po,Al=16,hn=32;function Gn(v){this.options=S({},this.defaults,v||{}),this.id=oe(),this.manager=null,this.options.enable=_(this.options.enable,!0),this.state=sc,this.simultaneous={},this.requireFail=[]}Gn.prototype={defaults:{},set:function(v){return S(this.options,v),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(v){if(d(v,"recognizeWith",this))return this;var w=this.simultaneous;return v=ac(v,this),w[v.id]||(w[v.id]=v,v.recognizeWith(this)),this},dropRecognizeWith:function(v){return d(v,"dropRecognizeWith",this)?this:(v=ac(v,this),delete this.simultaneous[v.id],this)},requireFailure:function(v){if(d(v,"requireFailure",this))return this;var w=this.requireFail;return v=ac(v,this),F(w,v)===-1&&(w.push(v),v.requireFailure(this)),this},dropRequireFailure:function(v){if(d(v,"dropRequireFailure",this))return this;v=ac(v,this);var w=F(this.requireFail,v);return w>-1&&this.requireFail.splice(w,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(v){return!!this.simultaneous[v.id]},emit:function(v){var w=this,N=this.state;function k($){w.manager.emit($,v)}N<Po&&k(w.options.event+xp(N)),k(w.options.event),v.additionalEvent&&k(v.additionalEvent),N>=Po&&k(w.options.event+xp(N))},tryEmit:function(v){if(this.canEmit())return this.emit(v);this.state=hn},canEmit:function(){for(var v=0;v<this.requireFail.length;){if(!(this.requireFail[v].state&(hn|sc)))return!1;v++}return!0},recognize:function(v){var w=S({},v);if(!I(this.options.enable,[this,w])){this.reset(),this.state=hn;return}this.state&(Fn|Al|hn)&&(this.state=sc),this.state=this.process(w),this.state&(Ti|as|Po|Al)&&this.tryEmit(w)},process:function(v){},getTouchAction:function(){},reset:function(){}};function xp(v){return v&Al?"cancel":v&Po?"end":v&as?"move":v&Ti?"start":""}function vp(v){return v==El?"down":v==Sl?"up":v==os?"left":v==yl?"right":""}function ac(v,w){var N=w.manager;return N?N.get(v):v}function zi(){Gn.apply(this,arguments)}O(zi,Gn,{defaults:{pointers:1},attrTest:function(v){var w=this.options.pointers;return w===0||v.pointers.length===w},process:function(v){var w=this.state,N=v.eventType,k=w&(Ti|as),$=this.attrTest(v);return k&&(N&jr||!$)?w|Al:k||$?N&Nt?w|Po:w&Ti?w|as:Ti:hn}});function Tl(){zi.apply(this,arguments),this.pX=null,this.pY=null}O(Tl,zi,{defaults:{event:"pan",threshold:10,pointers:1,direction:cp},getTouchAction:function(){var v=this.options.direction,w=[];return v&un&&w.push(vl),v&ss&&w.push(bo),w},directionTest:function(v){var w=this.options,N=!0,k=v.distance,$=v.direction,ae=v.deltaX,Ne=v.deltaY;return $&w.direction||(w.direction&un?($=ae===0?Zs:ae<0?os:yl,N=ae!=this.pX,k=Math.abs(v.deltaX)):($=Ne===0?Zs:Ne<0?Sl:El,N=Ne!=this.pY,k=Math.abs(v.deltaY))),v.direction=$,N&&k>w.threshold&&$&w.direction},attrTest:function(v){return zi.prototype.attrTest.call(this,v)&&(this.state&Ti||!(this.state&Ti)&&this.directionTest(v))},emit:function(v){this.pX=v.deltaX,this.pY=v.deltaY;var w=vp(v.direction);w&&(v.additionalEvent=this.options.event+w),this._super.emit.call(this,v)}});function sd(){zi.apply(this,arguments)}O(sd,zi,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[cn]},attrTest:function(v){return this._super.attrTest.call(this,v)&&(Math.abs(v.scale-1)>this.options.threshold||this.state&Ti)},emit:function(v){if(v.scale!==1){var w=v.scale<1?"in":"out";v.additionalEvent=this.options.event+w}this._super.emit.call(this,v)}});function ad(){Gn.apply(this,arguments),this._timer=null,this._input=null}O(ad,Gn,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[id]},process:function(v){var w=this.options,N=v.pointers.length===w.pointers,k=v.distance<w.threshold,$=v.deltaTime>w.time;if(this._input=v,!k||!N||v.eventType&(Nt|jr)&&!$)this.reset();else if(v.eventType&Lr)this.reset(),this._timer=h(function(){this.state=Fn,this.tryEmit()},w.time,this);else if(v.eventType&Nt)return Fn;return hn},reset:function(){clearTimeout(this._timer)},emit:function(v){this.state===Fn&&(v&&v.eventType&Nt?this.manager.emit(this.options.event+"up",v):(this._input.timeStamp=c(),this.manager.emit(this.options.event,this._input)))}});function ld(){zi.apply(this,arguments)}O(ld,zi,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[cn]},attrTest:function(v){return this._super.attrTest.call(this,v)&&(Math.abs(v.rotation)>this.options.threshold||this.state&Ti)}});function ud(){zi.apply(this,arguments)}O(ud,zi,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:un|ss,pointers:1},getTouchAction:function(){return Tl.prototype.getTouchAction.call(this)},attrTest:function(v){var w=this.options.direction,N;return w&(un|ss)?N=v.overallVelocity:w&un?N=v.overallVelocityX:w&ss&&(N=v.overallVelocityY),this._super.attrTest.call(this,v)&&w&v.offsetDirection&&v.distance>this.options.threshold&&v.maxPointers==this.options.pointers&&u(N)>this.options.velocity&&v.eventType&Nt},emit:function(v){var w=vp(v.offsetDirection);w&&this.manager.emit(this.options.event+w,v),this.manager.emit(this.options.event,v)}});function lc(){Gn.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}O(lc,Gn,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[nd]},process:function(v){var w=this.options,N=v.pointers.length===w.pointers,k=v.distance<w.threshold,$=v.deltaTime<w.time;if(this.reset(),v.eventType&Lr&&this.count===0)return this.failTimeout();if(k&&$&&N){if(v.eventType!=Nt)return this.failTimeout();var ae=this.pTime?v.timeStamp-this.pTime<w.interval:!0,Ne=!this.pCenter||ec(this.pCenter,v.center)<w.posThreshold;this.pTime=v.timeStamp,this.pCenter=v.center,!Ne||!ae?this.count=1:this.count+=1,this._input=v;var Qt=this.count%w.taps;if(Qt===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=Fn,this.tryEmit()},w.interval,this),Ti):Fn}return hn},failTimeout:function(){return this._timer=h(function(){this.state=hn},this.options.interval,this),hn},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==Fn&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function dn(v,w){return w=w||{},w.recognizers=_(w.recognizers,dn.defaults.preset),new Il(v,w)}dn.VERSION="2.0.7",dn.defaults={domEvents:!1,touchAction:oc,enable:!0,inputTarget:null,inputClass:null,preset:[[ld,{enable:!1}],[sd,{enable:!1},["rotate"]],[ud,{direction:un}],[Tl,{direction:un},["swipe"]],[lc],[lc,{event:"doubletap",taps:2},["tap"]],[ad]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Iy=1,ls=2;function Il(v,w){this.options=S({},dn.defaults,w||{}),this.options.inputTarget=this.options.inputTarget||v,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=v,this.input=dp(this),this.touchAction=new od(this,this.options.touchAction),cd(this,!0),f(this.options.recognizers,function(N){var k=this.add(new N[0](N[1]));N[2]&&k.recognizeWith(N[2]),N[3]&&k.requireFailure(N[3])},this)}Il.prototype={set:function(v){return S(this.options,v),v.touchAction&&this.touchAction.update(),v.inputTarget&&(this.input.destroy(),this.input.target=v.inputTarget,this.input.init()),this},stop:function(v){this.session.stopped=v?ls:Iy},recognize:function(v){var w=this.session;if(!w.stopped){this.touchAction.preventDefaults(v);var N,k=this.recognizers,$=w.curRecognizer;(!$||$&&$.state&Fn)&&($=w.curRecognizer=null);for(var ae=0;ae<k.length;)N=k[ae],w.stopped!==ls&&(!$||N==$||N.canRecognizeWith($))?N.recognize(v):N.reset(),!$&&N.state&(Ti|as|Po)&&($=w.curRecognizer=N),ae++}},get:function(v){if(v instanceof Gn)return v;for(var w=this.recognizers,N=0;N<w.length;N++)if(w[N].options.event==v)return w[N];return null},add:function(v){if(d(v,"add",this))return this;var w=this.get(v.options.event);return w&&this.remove(w),this.recognizers.push(v),v.manager=this,this.touchAction.update(),v},remove:function(v){if(d(v,"remove",this))return this;if(v=this.get(v),v){var w=this.recognizers,N=F(w,v);N!==-1&&(w.splice(N,1),this.touchAction.update())}return this},on:function(v,w){if(v!==i&&w!==i){var N=this.handlers;return f(ue(v),function(k){N[k]=N[k]||[],N[k].push(w)}),this}},off:function(v,w){if(v!==i){var N=this.handlers;return f(ue(v),function(k){w?N[k]&&N[k].splice(F(N[k],w),1):delete N[k]}),this}},emit:function(v,w){this.options.domEvents&&wy(v,w);var N=this.handlers[v]&&this.handlers[v].slice();if(!(!N||!N.length)){w.type=v,w.preventDefault=function(){w.srcEvent.preventDefault()};for(var k=0;k<N.length;)N[k](w),k++}},destroy:function(){this.element&&cd(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function cd(v,w){var N=v.element;if(!!N.style){var k;f(v.options.cssProps,function($,ae){k=j(N.style,ae),w?(v.oldCssProps[k]=N.style[k],N.style[k]=$):N.style[k]=v.oldCssProps[k]||""}),w||(v.oldCssProps={})}}function wy(v,w){var N=e.createEvent("Event");N.initEvent(v,!0,!0),N.gesture=w,w.target.dispatchEvent(N)}S(dn,{INPUT_START:Lr,INPUT_MOVE:ns,INPUT_END:Nt,INPUT_CANCEL:jr,STATE_POSSIBLE:sc,STATE_BEGAN:Ti,STATE_CHANGED:as,STATE_ENDED:Po,STATE_RECOGNIZED:Fn,STATE_CANCELLED:Al,STATE_FAILED:hn,DIRECTION_NONE:Zs,DIRECTION_LEFT:os,DIRECTION_RIGHT:yl,DIRECTION_UP:Sl,DIRECTION_DOWN:El,DIRECTION_HORIZONTAL:un,DIRECTION_VERTICAL:ss,DIRECTION_ALL:cp,Manager:Il,Input:Ai,TouchAction:od,TouchInput:rc,MouseInput:tc,PointerEventInput:$h,TouchMouseInput:xl,SingleTouchInput:ed,Recognizer:Gn,AttrRecognizer:zi,Tap:lc,Pan:Tl,Swipe:ud,Pinch:sd,Rotate:ld,Press:ad,on:X,off:K,each:f,merge:C,extend:x,assign:S,inherit:O,bindFn:B,prefixed:j});var Ly=typeof s<"u"?s:typeof self<"u"?self:{};Ly.Hammer=dn,typeof define=="function"&&define.amd?define(function(){return dn}):typeof xP<"u"&&xP.exports?xP.exports=dn:s[t]=dn})(window,document,"Hammer")});var bL=fn((LMe,gx)=>{"use strict";gx.exports=zP;gx.exports.default=zP;function zP(s,e,t){t=t||2;var i=e&&e.length,n=i?e[0]*t:s.length,o=gL(s,0,n,t,!0),a=[];if(!o||o.next===o.prev)return a;var l,u,c,h,d,f,p;if(i&&(o=l3(s,e,o,t)),s.length>80*t){l=c=s[0],u=h=s[1];for(var S=t;S<n;S+=t)d=s[S],f=s[S+1],d<l&&(l=d),f<u&&(u=f),d>c&&(c=d),f>h&&(h=f);p=Math.max(c-l,h-u),p=p!==0?32767/p:0}return qg(o,a,t,l,u,p,0),a}function gL(s,e,t,i,n){var o,a;if(n===fx(s,e,t,i)>0)for(o=e;o<t;o+=i)a=fL(o,s[o],s[o+1],a);else for(o=t-i;o>=e;o-=i)a=fL(o,s[o],s[o+1],a);return a&&WP(a,a.next)&&(Yg(a),a=a.next),a}function ju(s,e){if(!s)return s;e||(e=s);var t=s,i;do if(i=!1,!t.steiner&&(WP(t,t.next)||_t(t.prev,t,t.next)===0)){if(Yg(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function qg(s,e,t,i,n,o,a){if(!!s){!a&&o&&f3(s,i,n,o);for(var l=s,u,c;s.prev!==s.next;){if(u=s.prev,c=s.next,o?o3(s,i,n,o):n3(s)){e.push(u.i/t|0),e.push(s.i/t|0),e.push(c.i/t|0),Yg(s),s=c.next,l=c.next;continue}if(s=c,s===l){a?a===1?(s=s3(ju(s),e,t),qg(s,e,t,i,n,o,2)):a===2&&a3(s,e,t,i,n,o):qg(ju(s),e,t,i,n,o,1);break}}}}function n3(s){var e=s.prev,t=s,i=s.next;if(_t(e,t,i)>=0)return!1;for(var n=e.x,o=t.x,a=i.x,l=e.y,u=t.y,c=i.y,h=n<o?n<a?n:a:o<a?o:a,d=l<u?l<c?l:c:u<c?u:c,f=n>o?n>a?n:a:o>a?o:a,p=l>u?l>c?l:c:u>c?u:c,S=i.next;S!==e;){if(S.x>=h&&S.x<=f&&S.y>=d&&S.y<=p&&Vh(n,l,o,u,a,c,S.x,S.y)&&_t(S.prev,S,S.next)>=0)return!1;S=S.next}return!0}function o3(s,e,t,i){var n=s.prev,o=s,a=s.next;if(_t(n,o,a)>=0)return!1;for(var l=n.x,u=o.x,c=a.x,h=n.y,d=o.y,f=a.y,p=l<u?l<c?l:c:u<c?u:c,S=h<d?h<f?h:f:d<f?d:f,x=l>u?l>c?l:c:u>c?u:c,C=h>d?h>f?h:f:d>f?d:f,O=hx(p,S,e,t,i),B=hx(x,C,e,t,i),I=s.prevZ,_=s.nextZ;I&&I.z>=O&&_&&_.z<=B;){if(I.x>=p&&I.x<=x&&I.y>=S&&I.y<=C&&I!==n&&I!==a&&Vh(l,h,u,d,c,f,I.x,I.y)&&_t(I.prev,I,I.next)>=0||(I=I.prevZ,_.x>=p&&_.x<=x&&_.y>=S&&_.y<=C&&_!==n&&_!==a&&Vh(l,h,u,d,c,f,_.x,_.y)&&_t(_.prev,_,_.next)>=0))return!1;_=_.nextZ}for(;I&&I.z>=O;){if(I.x>=p&&I.x<=x&&I.y>=S&&I.y<=C&&I!==n&&I!==a&&Vh(l,h,u,d,c,f,I.x,I.y)&&_t(I.prev,I,I.next)>=0)return!1;I=I.prevZ}for(;_&&_.z<=B;){if(_.x>=p&&_.x<=x&&_.y>=S&&_.y<=C&&_!==n&&_!==a&&Vh(l,h,u,d,c,f,_.x,_.y)&&_t(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function s3(s,e,t){var i=s;do{var n=i.prev,o=i.next.next;!WP(n,o)&&pL(n,i,i.next,o)&&Xg(n,o)&&Xg(o,n)&&(e.push(n.i/t|0),e.push(i.i/t|0),e.push(o.i/t|0),Yg(i),Yg(i.next),i=s=o),i=i.next}while(i!==s);return ju(i)}function a3(s,e,t,i,n,o){var a=s;do{for(var l=a.next.next;l!==a.prev;){if(a.i!==l.i&&m3(a,l)){var u=mL(a,l);a=ju(a,a.next),u=ju(u,u.next),qg(a,e,t,i,n,o,0),qg(u,e,t,i,n,o,0);return}l=l.next}a=a.next}while(a!==s)}function l3(s,e,t,i){var n=[],o,a,l,u,c;for(o=0,a=e.length;o<a;o++)l=e[o]*i,u=o<a-1?e[o+1]*i:s.length,c=gL(s,l,u,i,!1),c===c.next&&(c.steiner=!0),n.push(p3(c));for(n.sort(u3),o=0;o<n.length;o++)t=c3(n[o],t);return t}function u3(s,e){return s.x-e.x}function c3(s,e){var t=h3(s,e);if(!t)return e;var i=mL(t,s);return ju(i,i.next),ju(t,t.next)}function h3(s,e){var t=e,i=s.x,n=s.y,o=-1/0,a;do{if(n<=t.y&&n>=t.next.y&&t.next.y!==t.y){var l=t.x+(n-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(l<=i&&l>o&&(o=l,a=t.x<t.next.x?t:t.next,l===i))return a}t=t.next}while(t!==e);if(!a)return null;var u=a,c=a.x,h=a.y,d=1/0,f;t=a;do i>=t.x&&t.x>=c&&i!==t.x&&Vh(n<h?i:o,n,c,h,n<h?o:i,n,t.x,t.y)&&(f=Math.abs(n-t.y)/(i-t.x),Xg(t,s)&&(f<d||f===d&&(t.x>a.x||t.x===a.x&&d3(a,t)))&&(a=t,d=f)),t=t.next;while(t!==u);return a}function d3(s,e){return _t(s.prev,s,e.prev)<0&&_t(e.next,s,s.next)<0}function f3(s,e,t,i){var n=s;do n.z===0&&(n.z=hx(n.x,n.y,e,t,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==s);n.prevZ.nextZ=null,n.prevZ=null,g3(n)}function g3(s){var e,t,i,n,o,a,l,u,c=1;do{for(t=s,s=null,o=null,a=0;t;){for(a++,i=t,l=0,e=0;e<c&&(l++,i=i.nextZ,!!i);e++);for(u=c;l>0||u>0&&i;)l!==0&&(u===0||!i||t.z<=i.z)?(n=t,t=t.nextZ,l--):(n=i,i=i.nextZ,u--),o?o.nextZ=n:s=n,n.prevZ=o,o=n;t=i}o.nextZ=null,c*=2}while(a>1);return s}function hx(s,e,t,i,n){return s=(s-t)*n|0,e=(e-i)*n|0,s=(s|s<<8)&16711935,s=(s|s<<4)&252645135,s=(s|s<<2)&858993459,s=(s|s<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,s|e<<1}function p3(s){var e=s,t=s;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==s);return t}function Vh(s,e,t,i,n,o,a,l){return(n-a)*(e-l)>=(s-a)*(o-l)&&(s-a)*(i-l)>=(t-a)*(e-l)&&(t-a)*(o-l)>=(n-a)*(i-l)}function m3(s,e){return s.next.i!==e.i&&s.prev.i!==e.i&&!b3(s,e)&&(Xg(s,e)&&Xg(e,s)&&P3(s,e)&&(_t(s.prev,s,e.prev)||_t(s,e.prev,e))||WP(s,e)&&_t(s.prev,s,s.next)>0&&_t(e.prev,e,e.next)>0)}function _t(s,e,t){return(e.y-s.y)*(t.x-e.x)-(e.x-s.x)*(t.y-e.y)}function WP(s,e){return s.x===e.x&&s.y===e.y}function pL(s,e,t,i){var n=UP(_t(s,e,t)),o=UP(_t(s,e,i)),a=UP(_t(t,i,s)),l=UP(_t(t,i,e));return!!(n!==o&&a!==l||n===0&&kP(s,t,e)||o===0&&kP(s,i,e)||a===0&&kP(t,s,i)||l===0&&kP(t,e,i))}function kP(s,e,t){return e.x<=Math.max(s.x,t.x)&&e.x>=Math.min(s.x,t.x)&&e.y<=Math.max(s.y,t.y)&&e.y>=Math.min(s.y,t.y)}function UP(s){return s>0?1:s<0?-1:0}function b3(s,e){var t=s;do{if(t.i!==s.i&&t.next.i!==s.i&&t.i!==e.i&&t.next.i!==e.i&&pL(t,t.next,s,e))return!0;t=t.next}while(t!==s);return!1}function Xg(s,e){return _t(s.prev,s,s.next)<0?_t(s,e,s.next)>=0&&_t(s,s.prev,e)>=0:_t(s,e,s.prev)<0||_t(s,s.next,e)<0}function P3(s,e){var t=s,i=!1,n=(s.x+e.x)/2,o=(s.y+e.y)/2;do t.y>o!=t.next.y>o&&t.next.y!==t.y&&n<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==s);return i}function mL(s,e){var t=new dx(s.i,s.x,s.y),i=new dx(e.i,e.x,e.y),n=s.next,o=e.prev;return s.next=e,e.prev=s,t.next=n,n.prev=t,i.next=t,t.prev=i,o.next=i,i.prev=o,i}function fL(s,e,t,i){var n=new dx(s,e,t);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function Yg(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function dx(s,e,t){this.i=s,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}zP.deviation=function(s,e,t,i){var n=e&&e.length,o=n?e[0]*t:s.length,a=Math.abs(fx(s,0,o,t));if(n)for(var l=0,u=e.length;l<u;l++){var c=e[l]*t,h=l<u-1?e[l+1]*t:s.length;a-=Math.abs(fx(s,c,h,t))}var d=0;for(l=0;l<i.length;l+=3){var f=i[l]*t,p=i[l+1]*t,S=i[l+2]*t;d+=Math.abs((s[f]-s[S])*(s[p+1]-s[f+1])-(s[f]-s[p])*(s[S+1]-s[f+1]))}return a===0&&d===0?0:Math.abs((d-a)/a)};function fx(s,e,t,i){for(var n=0,o=e,a=t-i;o<t;o+=i)n+=(s[a]-s[o])*(s[o+1]+s[a+1]),a=o;return n}zP.flatten=function(s){for(var e=s[0][0].length,t={vertices:[],holes:[],dimensions:e},i=0,n=0;n<s.length;n++){for(var o=0;o<s[n].length;o++)for(var a=0;a<e;a++)t.vertices.push(s[n][o][a]);n>0&&(i+=s[n-1].length,t.holes.push(i))}return t}});var DL=fn((rBe,px)=>{"use strict";px.exports=Qg;px.exports.default=Qg;var Uh=1e20;function Qg(s,e,t,i,n,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=i||.25,this.fontFamily=n||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function w3(s,e,t,i,n,o,a){o.fill(Uh,0,e*t),a.fill(0,0,e*t);for(var l=(e-i)/2,u=0;u<n;u++)for(var c=0;c<i;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*i+c)+3]/255;if(d===1)o[h]=0,a[h]=Uh;else if(d===0)o[h]=Uh,a[h]=0;else{var f=Math.max(0,.5-d),p=Math.max(0,d-.5);o[h]=f*f,a[h]=p*p}}}function L3(s,e,t,i,n,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(i[l])-Math.sqrt(n[l]);s[l]=Math.round(255-255*(u/o+a))}}Qg.prototype._draw=function(s,e){var t=this.ctx.measureText(s),i=t.width,n=2*this.buffer,o,a,l,u,c,h,d,f;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),f=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+n,l=u+n,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,f=this.middle,this.ctx.textBaseline="middle");var p;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,f),p=this.ctx.getImageData(d,h,a,u));var S=new Uint8ClampedArray(o*l);return w3(p,o,l,a,u,this.gridOuter,this.gridInner),ML(this.gridOuter,o,l,this.f,this.v,this.z),ML(this.gridInner,o,l,this.f,this.v,this.z),L3(S,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:S,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:i}}};Qg.prototype.draw=function(s){return this._draw(s,!1).data};Qg.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function ML(s,e,t,i,n,o){for(var a=0;a<e;a++)BL(s,a,e,t,i,n,o);for(var l=0;l<t;l++)BL(s,l*e,1,e,i,n,o)}function BL(s,e,t,i,n,o,a){var l,u,c,h;for(o[0]=0,a[0]=-Uh,a[1]=Uh,l=0;l<i;l++)n[l]=s[e+l*t];for(l=1,u=0,c=0;l<i;l++){do h=o[u],c=(n[l]-n[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=Uh}for(l=0,u=0;l<i;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=n[h]+(l-h)*(l-h)}}});function iv(s,e){let t=document.getElementById(s);t.ondragover=i=>{i.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=i=>{i.preventDefault(),t.classList.remove("active");let n=i.dataTransfer.items[0];n.kind==="file"&&e(n.getAsFile())},t.onclick=()=>{let i=document.createElement("input");i.type="file",i.onchange=()=>i.files.length&&e(i.files[0]),i.click()}}var us=class{bind(e){this.entity&&this.entity.setAttr(e,this)}constructor(e,t){this.entity=e,this.bind(t)}};var qe=class{};qe.GeomObjectIndex=0,qe.DrawingObjectIndex=1,qe.AlgorithmDataIndex=2,qe.ViewerIndex=3;var xe=class extends us{constructor(t){super(t,qe.GeomObjectIndex)}static getGeom(t){return t.getAttr(qe.GeomObjectIndex)}get parent(){let t=this.entity.parent;return t?xe.getGeom(t):null}rebind(t){this.entity=t,this.bind(qe.GeomObjectIndex)}*getAncestors(){let t=this.parent;for(;t!=null;)yield t,t=t.parent}};var Gy=class{static solve(e,t,i,n,o,a){let l=e*o-n*t;if(!(Math.abs(l)<Gy.eps))return{x:(i*o-a*t)/l,y:(e*a-n*i)/l}}},gn=Gy;gn.eps=1e-8;var ea=class{static RoundPoint(e){return new m(ea.RoundDouble(e.x),ea.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*ea.mult)/ea.mult}},T=ea;T.distanceEpsilonPrecision=6,T.mult=Math.pow(10,6),T.defaultLeafBoxesOffset=.5,T.lineSegmentThreshold=.05,T.intersectionEpsilon=1e-4,T.distanceEpsilon=Math.pow(10,-ea.distanceEpsilonPrecision),T.squareOfDistanceEpsilon=Math.pow(10,-ea.distanceEpsilonPrecision*2),T.tolerance=1e-8;function nv(s,e){return(s?1:0)-(e?1:0)}function Re(s,e){let t=s-e;return t<0?-1:t===0?0:1}function uc(s,e){let t=Re(s.y,e.y);return t||Re(s.x,e.x)}function le(s,e){let t=s-e;return-T.distanceEpsilon<=t&&t<=T.distanceEpsilon}function Ip(s,e){return dd(s,e)>0}function dd(s,e){let t=s-e;return t<=-T.distanceEpsilon?-1:t>=T.distanceEpsilon?1:0}function Ue(s,e){return s.sub(e).length}var m=class{toJSON(){return{x:this.x,y:this.y}}static fromJSON(e){return new m(e.x,e.y)}static ProjectionToLine(e,t,i){let n=t.sub(e),o=n.length;if(o<T.distanceEpsilon)return e;n=n.div(o);let a=i.sub(e).dot(n);return e.add(n.mul(a))}static RayIntersectsRayInteriors(e,t,i,n){let o=m.lineLineIntersection(e,e.add(t),i,i.add(n));if(!!o&&o.sub(e).dot(t.div(t.l1))>T.distanceEpsilon&&o.sub(i).dot(n.div(n.l1))>T.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,i,n){let o=m.lineLineIntersection(e,t,i,i.add(n));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(i).dot(n)<0)&&a.dot(a)>T.squareOfDistanceEpsilon&&l.dot(l)>=T.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static PointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static PointIsInsideCone(e,t,i,n){return m.PointToTheRightOfLineOrOnLine(e,t,i)&&m.PointToTheLeftOfLineOrOnLine(e,t,n)}static PointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static PointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static closeIntersections(e,t){return m.close(e,t,T.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=Re(this.x,e.x);return t!==0?t:Re(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,i){return e.sub(t).length<=i}static closeSquare(e,t,i){let n=t.sub(e);return n.dot(n)<=i}static closeDistEps(e,t,i=T.distanceEpsilon){return e.sub(t).length<=i}normalize(){let e=this.length;return new m(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new m(this.x*e,this.y*t)}add(e){return new m(this.x+e.x,this.y+e.y)}sub(e){return new m(this.x-e.x,this.y-e.y)}mul(e){return new m(this.x*e,this.y*e)}div(e){return new m(this.x/e,this.y/e)}equal(e){return e.x===this.x&&e.y===this.y}neg(){return new m(-this.x,-this.y)}static lineLineIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=gn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!==void 0)return e.add(o.mul(u.x))}static segSegIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=T.tolerance,c=gn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!==void 0&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,i){let n=e.length,o=t.length;return n<i||o<i?!0:(e=e.div(n),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<i)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new m(-this.y,this.x)}rotate90Cw(){return new m(this.y,-this.x)}clone(){return new m(this.x,this.y)}rotate(e){let t=Math.cos(e),i=Math.sin(e);return new m(t*this.x-i*this.y,i*this.x+t*this.y)}static mkPoint(e,t,i,n){return t.mul(e).add(n.mul(i))}static convSum(e,t,i){return t.add(i.sub(t).mul(e))}static anglePCP(e,t,i){return m.angle(e.sub(t),i.sub(t))}static angle(e,t){let i=e.x,n=e.y,o=t.x,a=t.y,l=i*a-n*o,u=i*o+n*a;if(Math.abs(u)<T.tolerance)return Math.abs(l)<T.tolerance?0:l<-T.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<T.tolerance)return u<-T.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-T.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>T.distanceEpsilon?1:n<-T.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>T.intersectionEpsilon?1:n<-T.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o),l=n.dot(n);return a<=0+T.tolerance?t:l<=a+T.tolerance?i:t.add(n.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static pointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static pointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static pointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static canProject(e,t,i){let n=i.sub(t);return!(e.sub(t).dot(n)<0||e.sub(i).dot(n)>0)}static distToLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a,l;if((a=n.dot(o))<=T.tolerance)return{par:0,dist:o.length};if((l=n.dot(n))<=a+T.tolerance)return{par:1,dist:e.sub(i).length};let u=a/l;return{par:u,dist:t.add(n.mul(u)).length}}};var Mt=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new Mt;return t.point=e,t}};var Ie=class{contains(e){let t=e.sub(this.corner),i=T.distanceEpsilon,n=t.dot(this.bRot);if(n>this.abRot+i||n<-i)return!1;let o=t.dot(this.aRot);return o<=this.baRot+i&&o>=-i}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let i=new Ie,n=e.corner,o={minx:n.x,maxx:n.x,miny:n.y,maxy:n.y};return Ie.pumpMinMax(o,e.aPlusCorner),Ie.pumpMinMax(o,e.otherCorner),Ie.pumpMinMax(o,e.bPlusCorner),Ie.pumpMinMax(o,t.corner),Ie.pumpMinMax(o,t.aPlusCorner),Ie.pumpMinMax(o,t.otherCorner),Ie.pumpMinMax(o,t.bPlusCorner),i.corner=new m(o.minx,o.miny),i.a=new m(0,o.maxy-o.miny),i.b=new m(o.maxx-o.minx,0),i.aPlusCorner=i.a.add(i.corner),i.otherCorner=i.b.add(i.aPlusCorner),i.bPlusCorner=i.b.add(i.corner),i.aRot=new m(-i.a.y,i.a.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new m(-i.b.y,i.b.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.a.dot(i.bRot),i.baRot=i.b.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=i.a.sub(i.b).length<T.distanceEpsilon,i}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(Ie.separByA(e,t)||Ie.separByA(t,e)||Ie.separByB(e,t)||Ie.separByB(t,e))===!1?!1:!(e.isSeg&&t.isSeg)||!m.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:Ie.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let i=e.corner,n=e.otherCorner,o=t.corner,a=t.otherCorner,l=n.sub(i),u=0,c=l.dot(l),h=o.sub(i).dot(l),d=a.sub(i).dot(l);if(h>d){let f=h;h=d,d=f}return!(d<u-T.distanceEpsilon||h>c+T.distanceEpsilon)}static separByB(e,t){let i=T.distanceEpsilon,n=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(n>e.abRot+i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+i)return!1;return!0}else if(n<-i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-i)return!1;return!0}return!1}static separByA(e,t){let i=T.distanceEpsilon,n=t.corner.sub(e.corner),o=m.dot(n,e.aRot);return o>e.baRot+i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)<=e.baRot+i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i))):o<-i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)>=-i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)>=-i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)>=-i))):!1}static parallelogramByCornerSideSide(e,t,i){let n=new Ie;return n.corner=e,n.a=t,n.b=i,n.aRot=new m(-t.y,t.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new m(-i.y,i.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.bRot.dot(t),n.baRot=i.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=t.sub(i).length<T.distanceEpsilon,n.aPlusCorner=t.add(e),n.otherCorner=i.add(n.aPlusCorner),n.bPlusCorner=i.add(e),n}static getParallelogramOfAGroup(e){let t=0,i=0,n=0,o=0,a=!0;for(let l of e){let u=TO(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=i=h,n=o=d):(h<t?t=h:h>i&&(i=h),d<n?n=d:d>o&&(o=d))}}return Ie.parallelogramByCornerSideSide(new m(t,n),new m(0,o-n),new m(i-t,0))}};function*TO(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var G=class{constructor(e,t,i,n){this.parStart=0;this.parEnd=1;this.start=new m(e,t),this.end=new m(i,n)}static fromJSON(e){return G.mkPP(m.fromJSON(e.start),m.fromJSON(e.end))}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let i=this.value(e),n=this.value(t);return m.close(i,n,T.distanceEpsilon)?null:G.mkPP(i,n)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:Ie.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new m(-e.y,e.x)}static mkPP(e,t){return new G(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,i){return new G(e.x,e.y,t,i)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}reverse(){return G.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return G.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<T.tolerance)return 0;let i=e/t;return i>1?1:i<0?0:i}transform(e){return G.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,i){let n=this.closestParameter(e);return n<t&&(n=t),n>i&&(n=i),n}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return q.mkPP(this.start,this.end)}clone(){return G.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o);if(a<=0+T.tolerance)return 0;let l=n.dot(n);return l<=a+T.tolerance?1:a/l}closestParameter(e){return G.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,i,n){let o=m.lineLineIntersection(e,t,i,n);if(o!=null&&G.xIsBetweenPoints(e,t,o)&&G.xIsBetweenPoints(i,n,o))return o}static xIsBetweenPoints(e,t,i){return e.sub(i).dot(t.sub(i))<=T.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,i,n){let o=t.sub(e),a=n.sub(i),l=e.sub(i),u=m.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),f=o.dot(l),p=a.dot(l),S,x,C=Math.abs(u),O=C,B=C;C<T.tolerance?(S=0,O=1,x=p,B=d):(S=m.crossProduct(a,l),x=m.crossProduct(o,l),u<0&&(S=-S,x=-x),S<0?(S=0,x=p,B=d):S>O&&(S=O=1,x=p+h,B=d)),x<0?(x=0,-f<0?S=0:-f>c?S=O:(S=-f,O=c)):x>B&&(x=B=1,-f+h<0?S=0:-f+h>c?S=O:(S=-f+h,O=c));let I=Math.abs(S)<T.tolerance?0:S/O,_=Math.abs(x)<T.tolerance?0:x/B;return{parab:I,parcd:_,dist:l.add(o.mul(I).sub(a.mul(_))).length}}};function IO(s,e,t,i,n){return{parallelogram:t,seg:i,leafBoxesOffset:n,node:{low:s,high:e,chord:null}}}var ut=class{static distToSegm(e,t,i){let n=i.sub(t);if(n.length<T.intersectionEpsilon)return e.sub(t.add(i).div(2)).length;let o=new m(-n.y,n.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,i){let n=i.derivative(e),o=i.derivative(t),a=new m(-o.y,o.x),l=i.value(e),u=i.value(t),h=u.sub(l).dot(a),d=n.dot(a),f=Math.abs(h)<T.distanceEpsilon;if(!f&&Math.abs(d)<T.distanceEpsilon)return;let p=f?0:h/d;return n=n.mul(p),Ie.parallelogramByCornerSideSide(l,n,u.sub(l).sub(n))}static createParallelogramNodeForCurveSeg(e,t,i,n){if(e===i.parStart&&t===i.parEnd&&m.close(i.start,i.end,T.distanceEpsilon))return ut.createNodeWithSegmentSplit(e,t,i,n);let a=i.value(e),l=i.value(t),u=l.sub(a),c=i.value((e+t)/2);if(ut.distToSegm(c,a,l)<=T.intersectionEpsilon&&u.dot(u)<T.lineSegmentThreshold*T.lineSegmentThreshold&&t-e<T.lineSegmentThreshold){let h=G.mkPP(a,l),d=h.pNodeOverICurve();d.seg=i;let f=d.node;return f.low=e,f.high=t,f.chord=h,d}if(ut.WithinEpsilon(i,e,t,n)){let h=ut.createParallelogramOnSubSeg(e,t,i);if(h!==void 0)return IO(e,t,h,i,n)}return ut.createNodeWithSegmentSplit(e,t,i,n)}static WithinEpsilon(e,t,i,n){let a=(i-t)/3,l=e.value(t),u=e.value(i);return ut.distToSegm(e.value(t+a),l,u)>n?!1:ut.distToSegm(e.value(t+a*(3-1)),l,u)<=n}static createParallelogramNodeForCurveSegDefaultOffset(e){return ut.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,T.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,i,n){let o={parallelogram:null,seg:i,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(ut.createParallelogramNodeForCurveSeg(e,.5*(e+t),i,n)),a.children.push(ut.createParallelogramNodeForCurveSeg(.5*(e+t),t,i,n)),o.parallelogram=Ie.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var Vn=class{constructor(e,t,i,n,o){this.par0=e,this.par1=t,this.x=i,this.seg0=n,this.seg1=o}};var ta=class{static closestPoint(e,t,i,n,o){let u=i,c=0,h=0,d,f=!1;do{let p=e.value(u),S=e.derivative(u),x=e.secondDerivative(u),C=S.dot(S)+p.sub(t).dot(x);if(Math.abs(C)<T.tolerance)return u;d=p.sub(t).dot(S.div(C)),u-=d,u>o+T.tolerance?(u=o,h++):u<n-T.tolerance&&(u=n,h++),c++}while(Math.abs(d)>T.tolerance&&!(f=c>=5||h>=5));return f&&e.value(i).sub(t).length<T.distanceEpsilon&&(u=i),u}};var be=class{isFullEllipse(){return this.parEnd===Math.PI*2&&this.parStart===0}static fromJSON(e){return new be(e.parStart,e.parEnd,m.fromJSON(e.axis0),m.fromJSON(e.axis1),m.fromJSON(e.center))}toJSON(){return{parStart:this.parStart,parEnd:this.parEnd,axis0:this.aAxis.toJSON(),axis1:this.bAxis.toJSON(),center:this.center.toJSON()}}offsetCurve(e,t){let i=t.sub(this.center),n=m.angle(this.aAxis,i);if(this.aAxis.mul(Math.cos(n)).add(this.bAxis.mul(Math.sin(n))).length<i.length){let a=this.aAxis.length,l=this.bAxis.length;return be.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return be.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,i){return new be(0,Math.PI*2,e,t,i)}constructor(e,t,i,n,o){for(this.parStart=e,this.parEnd=t,this.aAxis=i,this.bAxis=n,this.center=o,this.pNode=null,this.setBoundingBox();this.parStart<0;)this.parStart+=Math.PI*2,this.parEnd+=Math.PI*2}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new be(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(m.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return m.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return m.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return m.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=ut.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(le(this.parStart,0)&&le(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=q.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,i,n,o,a){return new be(e,t,i,n,new m(o,a))}static mkFullEllipsePPP(e,t,i){return new be(0,Math.PI*2,e,t,i)}static mkFullEllipseNNP(e,t,i){return new be(0,Math.PI*2,new m(e,0),new m(0,t),i)}static mkCircle(e,t){return be.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new be(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let i=this.parStart,n=this.parEnd,o=e+.001,a=e-.001;for(;n-i>T.distanceEpsilon;){let l=.5*(n+i),u=this.lengthPartial(this.parStart,l);if(u>o)n=l;else if(u<a)i=l;else return l}return(n+i)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),i=e.multiplyPoint(this.bAxis).sub(e.offset());return new be(this.parStart,this.parEnd,t,i,e.multiplyPoint(this.center))}return this.clone()}closestParameterWithinBounds(e,t,i){let o=(i-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),f=d.dot(d);f<l&&(l=f,a=h)}a===0&&i===Math.PI*2&&(t=-Math.PI);let u=ta.closestPoint(this,e,a,t,i);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return R.lengthWithInterpolationAndThreshold(this.trim(e,t),T.lineSegmentThreshold/100)}get length(){return(this.aAxis.length+this.bAxis.length)*Math.abs(this.parEnd-this.parStart)/2}clone(){return new be(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,i=8,n=(this.parEnd-this.parStart)/(i+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=i;c++){let h=this.parStart+c*n,d=e.sub(this.value(h)),f=d.dot(d);f<a&&(a=f,o=h)}let l=!1;o===0&&this.parEnd===Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=ta.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return m.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return q.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<T.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<T.tolerance&&m.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var wp=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,i,n,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=i,this.bMin=o,this.aMax=n,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,i,n){return e*n-i*t}solve(){let e=0,t=10,i=0,n=100,o=!1;if(this.initValues(),this.curveA instanceof G&&this.curveB instanceof G){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<T.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<T.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<T.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+T.distanceEpsilon||u<this.aMin-T.distanceEpsilon||c>this.bMax+T.distanceEpsilon||c<this.bMin-T.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),i++,o=e>=t||i>=n||a.s===0&&a.t===0&&h}while((Math.abs(a.s)>=T.tolerance||Math.abs(a.t)>=T.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<T.distanceEpsilon*T.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!==0&&e.t!==0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let i=1;this.ti+e.t>this.bMax?i=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(i=(this.bMin-this.ti)/e.t);let n=Math.min(t,i);e.s*=n,e.t*=n}else e.s===0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,i=e.start,n=e.end,o=t.start,a=t.end,l=n.sub(i),u=l.length,c=0,h,d,f;if(u>T.distanceEpsilon){l=l.div(u),h=l.dot(n.sub(i)),d=l.dot(o.sub(i)),f=l.dot(a.sub(i));let p=!1;if(d>f){p=!0;let S=d;d=f,f=S}if(f<c)this.aSolution=0,this.bSolution=p?0:1;else if(d>h)this.aSolution=1,this.bSolution=p?1:0;else{let S=Math.min(h,f);this.aSolution=S/(h-c),this.bSolution=(S-d)/(f-d),p&&(this.bSolution=1-this.bSolution)}}else{let p=a.sub(o),S=p.length;if(S>T.distanceEpsilon)if(p=p.div(S),c=0,h=p.dot(a.sub(o)),d=p.dot(i.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let x=Math.min(h,d);this.bSolution=x/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Fe=class{constructor(e,t,i,n){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=i,this.b[3]=n,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}toJSON(){return{b:this.b.map(e=>e.toJSON())}}static fromJSON(e){return Fe.mkBezier(e.b.map(m.fromJSON))}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=ut.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,i=t*e;return this.l.mul(i).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Fe.adjustParamTo01(e),t=Fe.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-T.tolerance)return new Fe(this.b[3],this.b[3],this.b[3],this.b[3]);let i=new Array(3),n=new Array(2),o=this.casteljau(e,i,n),a=new Fe(o,n[1],i[2],this.b[3]),l=a.casteljau((t-e)/(1-e),i,n);return new Fe(a.b[0],i[0],n[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,i){let n=1-e;for(let o=0;o<3;o++)t[o]=m.mkPoint(n,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)i[o]=m.mkPoint(n,t[o],e,t[o+1]);return m.mkPoint(n,i[0],e,i[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return m.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Fe(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.bbox&&(this.bbox=q.translate(this.bbox,e)),this.pBoxNode=null}scaleFromOrigin(e,t){return new Fe(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Fe.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,i,n){let o=n.sub(e).length,a=t.sub(e).length+i.sub(t).length+n.sub(i).length;if(a-o>T.lineSegmentThreshold){let l=m.middle(e,t),u=m.middle(t,i),c=m.middle(i,n),h=m.middle(l,u),d=m.middle(c,u),f=m.middle(h,d);return Fe.lengthOnControlPolygon(e,l,h,f)+Fe.lengthOnControlPolygon(f,d,c,n)}return(a+o)/2}get boundingBox(){return this.bbox?this.bbox:this.bbox=q.mkOnPoints(this.b)}transform(e){return new Fe(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,i){let n=(i-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*n+t)),c=u.dot(u);c<a&&(a=c,o=l*n+t)}return ta.closestPoint(this,e,o,t,i)}clone(){return new Fe(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Fe(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),i=this.Yp(e),n=t*t+i*i;return Math.sqrt(n*n*n)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let i=0,n=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<n&&(n=l,i=o*.125)}return ta.closestPoint(this,e,i,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+i*i),c=t*n+i*o;return 3*(c*c/u+u*(n*n+t*a+o*o+i*l))}Gp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+i*i)*(t*n+i*o)}getParameterAtLength(e){let t=0,i=1;for(;i-t>T.tolerance;){let n=(i+t)/2,o=this.evaluateError(e,n);if(o>0)i=n;else if(o<0)t=n;else return n}return(t+i)/2}evaluateError(e,t){let i=1-t,n=m.mkPoint(i,this.b[0],t,this.b[1]),o=m.mkPoint(i,this.b[1],t,this.b[2]),a=m.mkPoint(i,this.b[2],t,this.b[3]),l=m.mkPoint(i,n,t,o),u=m.mkPoint(i,o,t,a),c=m.mkPoint(i,l,t,u),h=Fe.lengthOnControlPolygon(this.b[0],n,l,c);return h>e+T.distanceEpsilon?1:h<e-T.distanceEpsilon?-1:0}};function wO(s){return s.seg.value(s.par)}function LO(s){return s.seg.derivative(s.par)}function RO(s){return s.seg.secondDerivative(s.par)}function OO(s){return s.seg.thirdDerivative(s.par)}function _O(s){if(s instanceof be)return{tag:"ellipse",segData:s.toJSON()};if(s instanceof G)return{tag:"lineSegment",segData:s.toJSON()};if(s instanceof Fe)return{tag:"bezier",segData:s.toJSON()};throw new Error("not implemented")}var R=class{static fromJSON(e){let t=new R;for(let i of e.segs)switch(i.tag){case"bezier":t.addSegment(Fe.fromJSON(i.segData));break;case"ellipse":t.addSegment(be.fromJSON(i.segData));break;case"lineSegment":t.addSegment(G.fromJSON(i.segData));break;default:throw new Error("not implemented")}return t}toJSON(){return{segs:this.segs.map(e=>_O(e))}}static CurvesIntersect(e,t){return e===t||R.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(n.segIndex<o.segIndex){let a=this.segs[n.segIndex],l=a.lengthPartial(n.par,a.parEnd);for(let u=n.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new R;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=R.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let i=new R;for(let n of this.segs)i.addSegment(n.scaleFromOrigin(e,t));return i}trim(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(i.start),o=this.getSegIndexParam(i.end);if(n.segIndex===o.segIndex)return this.segs[n.segIndex].trim(n.par,o.par);let a=new R;n.par<this.segs[n.segIndex].parEnd&&(a=a.addSegment(this.segs[n.segIndex].trim(n.par,this.segs[n.segIndex].parEnd)));for(let l=n.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.boundingBox_&&(this.boundingBox_=q.translate(this.boundingBox_,e)),this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let i=new R;return i.addSegment(this.trim(e,this.parEnd)),i.addSegment(this.trim(this.parStart,t)),i}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(this.boundingBox_=null,!(e instanceof R))this.segs.push(e),this.parEnd_+=R.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=R.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let i of this.segs){let n=i.pNodeOverICurve();e.push(n.parallelogram),t.push(n)}return this.pBNode={parallelogram:Ie.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:T.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,i){let n=R.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return i&&n!=null&&(n=R.liftIntersectionToCurves(e,t,n)),n}static getAllIntersections(e,t,i){return e instanceof G?R.getAllIntersectionsOfLineAndICurve(e,t,i):R.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsInternal(e,t,i){let n=[];if(R.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),n),i)for(let o=0;o<n.length;o++)n[o]=R.liftIntersectionToCurves(e,t,n[o]);return n}static getAllIntersectionsOfLineAndICurve(e,t,i){return t instanceof ie?R.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof R?R.getAllIntersectionsOfLineAndCurve(e,t,i):t instanceof be&&t.isArc()?R.getAllIntersectionsOfLineAndArc(e,t):R.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsOfLineAndCurve(e,t,i){let n=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(Ie.intersect(o.parallelogram,a.parallelogram)===!1)return n;let l=0;for(let u of t.segs){let c=R.getAllIntersections(e,u,!1);if(i){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)R.alreadyInside(n,h)||n.push(h)}return n}static closeIntersections(e,t){return m.close(e.x,t.x,T.intersectionEpsilon)}static closeIntersectionPoints(e,t){return m.close(e,t,T.intersectionEpsilon)}static alreadyInside(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(R.closeIntersections(n,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let i=e.end.sub(e.start),n=[],o=i.length;if(o<T.distanceEpsilon){let d=e.start.sub(t.center);if(le(d.length,t.aAxis.length)){let f=m.angle(t.aAxis,d);t.parStart-T.tolerance<=f&&(f=Math.max(f,t.parStart),f<=t.parEnd+T.tolerance&&(f=Math.min(t.parEnd,f),n.push(new Vn(0,f,e.start,e,t))))}return n}let a=i.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-T.distanceEpsilon)return n;if(i=a.rotate90Cw(),le(c,h))R.tryToAddPointToLineCircleCrossing(e,t,n,u,o,i);else{let d=Math.sqrt(c*c-l*l),f=i.mul(d);R.tryToAddPointToLineCircleCrossing(e,t,n,u.add(f),o,i),R.tryToAddPointToLineCircleCrossing(e,t,n,u.sub(f),o,i)}return n}static tryToAddPointToLineCircleCrossing(e,t,i,n,o,a){let u=n.sub(e.start).dot(a);if(u<-T.distanceEpsilon||(u=Math.max(u,0),u>o+T.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=m.angle(t.aAxis,n.sub(t.center));t.parStart-T.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+T.tolerance&&(c=Math.min(t.parEnd,c),i.push(new Vn(u,c,n,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let i=[],n=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=R.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a&&(R.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),R.oldIntersection(i,a.x)||i.push(new Vn(a.aSol,n+a.bSol,a.x,e,t))),n++}if(t.closed){let a=R.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a&&(R.adjustSolution(e.start,e.end,o.point,t.start,a),R.oldIntersection(i,a.x)||i.push(new Vn(a.aSol,n+a.bSol,a.x,e,t)))}return i}static adjustSolution(e,t,i,n,o){R.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):R.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),R.closeIntersectionPoints(o.x,i)?(o.x=i,o.bSol=Math.floor(o.bSol)):R.closeIntersectionPoints(o.x,n)&&(o.x=n,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!Ie.intersect(e.parallelogram,t.parallelogram))return null;let i=e.node,n=t.node,o=i.hasOwnProperty("children"),a=n.hasOwnProperty("children");if(o&&a)for(let l of i.children)for(let u of n.children){let c=R.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of n.children){let u=R.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of i.children){let u=R.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return R.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,i){if(!Ie.intersect(e.parallelogram,t.parallelogram))return;let n=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(n&&o)for(let a of e.node.children)for(let l of t.node.children)R.curveCurveXWithParallelogramNodes(a,l,i);else if(o)for(let a of t.node.children)R.curveCurveXWithParallelogramNodes(e,a,i);else if(n)for(let a of e.node.children)R.curveCurveXWithParallelogramNodes(a,t,i);else i=R.crossOverLeaves(e,t,i)}static crossOverIntervalsOne(e,t){let i=e.node,n=t.node,o=(i.high-i.low)/2,a=(n.high-n.low)/2;for(let l=1;l<2;l++){let u=l*o+i.low;for(let c=1;c<2;c++){let h=c*a+n.low,d;if(i.chord==null&&n.chord==null?d=R.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,n.low,n.high,u,h):i.chord!=null&&n.chord==null?d=R.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,n.low,n.high,.5*l,h):i.chord==null?(d=R.crossWithinIntervalsWithGuess(e.seg,n.chord,i.low,i.high,0,1,u,.5*c),d&&(d.bSol=n.low+d.bSol*(n.high-n.low))):(d=R.crossWithinIntervalsWithGuess(i.chord,n.chord,0,1,0,1,.5*l,.5*c),d&&(d.aSol=i.low+d.aSol*(i.high-i.low),d.bSol=n.low+d.bSol*(n.high-n.low))),d)return R.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return R.goDeeperOne(e,t)}static crossOverLeaves(e,t,i){let n=e.node,o=t.node,a=!1,l=(n.high-n.low)/2+n.low,u=(o.high-o.low)/2+o.low,c;return n.chord==null&&o.chord==null?c=R.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,o.low,o.high,l,u):n.chord!=null&&o.chord==null?(c=R.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,o.low,o.high,.5,u),c&&(c.aSol=n.low+c.aSol*(n.high-n.low))):n.chord==null?(c=R.crossWithinIntervalsWithGuess(e.seg,o.chord,n.low,n.high,0,1,l,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=R.crossWithinIntervalsWithGuess(n.chord,o.chord,0,1,0,1,.5,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=n.low+c.aSol*(n.high-n.low))),c&&(R.addIntersection(e,t,i,c),a=!0),a||R.goDeeper(i,e,t),i}static addIntersection(e,t,i,n){let o=e.node;R.closeIntersectionPoints(n.x,e.seg.value(o.low))?(n.x=e.seg.value(o.low),n.aSol=o.low):R.closeIntersectionPoints(n.x,e.seg.value(o.high))&&(n.x=e.seg.value(o.high),n.aSol=o.high);let a=t.node;if(R.closeIntersectionPoints(n.x,t.seg.value(a.low))?(n.x=t.seg.value(a.low),n.bSol=a.low):R.closeIntersectionPoints(n.x,t.seg.value(a.high))&&(n.x=t.seg.value(a.high),n.bSol=a.high),!R.oldIntersection(i,n.x)){let u=new Vn(n.aSol,n.bSol,n.x,e.seg,t.seg);i.push(u)}}static oldIntersection(e,t){for(let i of e)if(t.sub(i.x).length<T.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,i,n,o){let a=e.node,l=t.node;return R.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),i=a.low):R.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),i=a.high),R.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),n=l.low):R.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),n=l.high),new Vn(i,n,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,i,n,o,a,l){let u=e instanceof R?R.liftParameterToCurve(e,i-a.parStart,a):i,c=t instanceof R?R.liftParameterToCurve(t,n-l.parStart,l):n;return new Vn(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,i;if(e.seg0 instanceof R){let a=e.seg0.getSegParam(e.par0);t=a.seg,i=a.par}else i=e.par0,t=e.seg0;let n,o;if(e.seg1 instanceof R){let a=e.seg1.getSegParam(e.par1);o=a.par,n=a.seg}else o=e.par1,n=e.seg1;return new Vn(i,o,e.x,t,n)}static liftIntersectionToCurves(e,t,i){return R.liftIntersectionToCurves_(e,t,i.par0,i.par1,i.x,i.seg0,i.seg1)}static liftParameterToCurve(e,t,i){if(e===i)return t;if(!e.hasOwnProperty("segs"))return;let n=e,o=0;for(let a of n.segs){if(a===i)return t+o;o+=R.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let i=e.node,n=t.node;if(e.leafBoxesOffset>T.distanceEpsilon&&t.leafBoxesOffset>T.distanceEpsilon){let l=ut.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2),u=ut.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return R.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>T.distanceEpsilon){let l=ut.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2);return R.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>T.distanceEpsilon){let l=ut.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return R.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(i.low),a=e.seg.value(i.high);if(!m.closeDistEps(o,a)){let l=t.seg.value(n.low),u=t.seg.value(n.high);if(!m.closeDistEps(l,u)){let c=e.seg instanceof G?e.seg:G.mkPP(o,a),h=t.seg instanceof G?t.seg:G.mkPP(l,u),d=R.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d)return R.adjustParameters(e,c,t,h,d),R.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,i){let n=t.node,o=i.node,a=t.leafBoxesOffset>T.distanceEpsilon,l=i.leafBoxesOffset>T.distanceEpsilon;if(a&&l){let u=ut.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2),c=ut.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);R.curveCurveXWithParallelogramNodes(u,c,e)}else if(a){let u=ut.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);R.curveCurveXWithParallelogramNodes(u,i,e)}else if(l){let u=ut.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);R.curveCurveXWithParallelogramNodes(t,u,e)}else{let u=t.seg.value(n.low),c=t.seg.value(n.high);if(!m.closeDistEps(u,c)){let h=i.seg.value(o.low),d=i.seg.value(o.high);if(!m.closeDistEps(h,d)){let f=t.seg instanceof G?t.seg:G.mkPP(u,c),p=i.seg instanceof G?i.seg:G.mkPP(h,d),S=R.crossWithinIntervalsWithGuess(f,p,0,1,0,1,.5,.5);S&&(R.adjustParameters(t,f,i,p,S),R.addIntersection(t,i,e,S))}}}}static adjustParameters(e,t,i,n,o){if(t!==e.seg&&!(e.seg instanceof ie))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(n!==i.seg&&!(i.seg instanceof ie))o.bSol=i.seg.closestParameter(o.x);else{let a=i.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let n of this.segs){let o=t+n.parEnd-n.parStart;if(e>=t&&e<=o)return{par:e-t+n.parStart,seg:n};t=o}let i=this.segs[this.segs.length-1];return{seg:i,par:i.parEnd}}getSegIndexParam(e){let t=0,i=this.segs.length;for(let o=0;o<i;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let n=this.segs[i-1];return{segIndex:i-1,par:n.parEnd}}value(e){return wO(this.getSegParam(e))}derivative(e){return LO(this.getSegParam(e))}secondDerivative(e){return RO(this.getSegParam(e))}thirdDerivative(e){return OO(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,i,n,o,a,l,u){if(e instanceof G&&t instanceof G){let d=R.crossTwoLineSegs(e.start,e.end,t.start,t.end,i,n,o,a);if(d!==void 0)return d}let c=R.minDistWithinIntervals(e,t,i,n,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=T.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:m.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,i,n,o,a,l,u){let c=t.sub(e),h=i.sub(n),d=i.sub(e),f=gn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(f==null)return;let p=f.x,S=f.y,x=e.add(c.mul(p));if(!(p<o-T.tolerance)&&(p=Math.max(p,o),!(p>a+T.tolerance)&&(p=Math.min(p,a),!(S<l-T.tolerance)&&(S=Math.max(S,l),!(S>u+T.tolerance)))))return S=Math.min(S,u),{aSol:p,bSol:S,x}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let i=2*t.boundingBox.diagonal,n=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new m(Math.cos(a*n),Math.sin(a*n)),u=G.mkPP(e,e.add(l.mul(i))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(R.AllIntersectionsAreGood(c,t)){for(let d of c)if(m.closeDistEps(d.x,e))return 1;if(c.length%2===1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let i=t.hasOwnProperty("segs"),n=null;if(i||t instanceof ie&&(n=t.toCurve()),n){for(let o of e)if(!R.RealCut(R.DropIntersectionToSegs(o),n,!1))return!1}return!0}static RealCut(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let x=0;x<t.segs.length-1;x++)if(t.segs[x]===o){f=t.segs[x+1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<T.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let x=t.segs.length-1;x>0;x--)if(t.segs[x]===o){f=t.segs[x-1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<T.tolerance)}let d=c.dot(h);return i?d>T.distanceEpsilon:Math.abs(d)>T.distanceEpsilon}static realCutWithClosedCurve(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let x=0;x<t.segs.length;x++)if(t.segs[x]===o){f=t.segs[(x+1)%t.segs.length];break}if(f==null)throw new Error;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<T.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let x=0;x<t.segs.length;x++)if(t.segs[x]===o){f=t.segs[x>0?x-1:t.segs.length-1];break}let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<T.tolerance)}let d=c.dot(h);return i?d>T.distanceEpsilon:Math.abs(d)>T.distanceEpsilon}static minDistWithinIntervals(e,t,i,n,o,a,l,u){let c=new wp(e,t,i,n,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.boundingBox_)return this.boundingBox_;if(this.segs.length===0)this.boundingBox_=q.mkEmpty();else{let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return this.boundingBox_=e}}clone(){let e=new R;for(let t of this.segs)e.addSegment(t.clone());return this.boundingBox_!=null&&(e.boundingBox_=this.boundingBox_.clone()),e}getParameterAtLength(e){let t=0;for(let i of this.segs){let n=i.length;if(n>=e)return t+i.getParameterAtLength(e);e-=n,t+=i.parEnd-i.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new R;for(let i of this.segs)t.addSegment(i.transform(e));return this.boundingBox_&&(t.boundingBox_=this.boundingBox_.transform(e)),t}closestParameterWithinBounds(e,t,i){let n=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>i)break;let u=R.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(i-a)),f=l.closestParameterWithinBounds(e,h,d),p=e.sub(l.value(f)),S=p.dot(p);S<o&&(n=a+f-l.parStart,o=S)}a+=u}return n}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);if(u<i){if(t=n+a-o.parStart,u===0)break;i=u}n+=R.paramSpan(o)}return t}static addLineSegment(e,t,i){return e.addSegment(G.mkPP(t,i))}static addLineSegmentCNNP(e,t,i,n){return R.addLineSegment(e,new m(t,i),n)}static addLineSegmentCNNNN(e,t,i,n,o){R.addLineSegment(e,new m(t,i),new m(n,o))}static continueWithLineSegmentNN(e,t,i){R.addLineSegment(e,e.end,new m(t,i))}static continueWithLineSegmentP(e,t){R.addLineSegment(e,e.end,t)}static closeCurve(e){return R.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<T.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=R.paramSpan(t),Math.abs(e)<T.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<T.tolerance)return this.start===this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<T.tolerance)return t;e-=R.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let i=R.getAllIntersections(e,t,!0);if(i.length===0)return R.NonIntersectingCurveIsInsideOther(e,t);if(i.length===1)return e.start.equal(i[0].x)?R.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:R.PointRelativeToCurveLocation(e.start,t)===2;for(let n of R.PointsBetweenIntersections(e,i))if(R.PointRelativeToCurveLocation(n,t)===0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let i=t[t.length-1].par0,n=t[0].par0,o=e.parEnd-i+(n-e.parStart),a=i+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let i=e.parStart;i<e.parEnd;i+=.5){let n=R.PointRelativeToCurveLocation(e.value(i),t);if(n!==1)return n===2}return R.PointRelativeToCurveLocation(e.end,t)!==0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let i=R.getAllIntersections(e,t,!0);if(i.length===0)return R.NonIntersectingCurveIsInsideOther(e,t)||R.NonIntersectingCurveIsInsideOther(t,e);if(i.length===1)return e.start.equal(i[0].x)?R.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)===2||!t.start.equal(i[0].x)?R.PointRelativeToCurveLocation(t.start,e)===2:R.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)===2:R.PointRelativeToCurveLocation(e.start,t)===2;for(let n of R.PointsBetweenIntersections(e,i))if(R.PointRelativeToCurveLocation(n,t)===2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,i,n,o){let a=m.mkPoint(e,i.point,1-e,n.point),l=m.mkPoint(t,o.point,1-t,n.point),u=n.point.mul(2/3);return new Fe(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,i,n){let o=i.mul(n);return new Fe(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let i=t.next;if(i!=null)return{b:t,c:i}}static trimEdgeSplineWithNodeBoundaries(e,t,i,n){let o=i.parStart,a=i.parEnd;e!=null&&(o=R.findNewStart(i,o,e,n)),t!=null&&(a=R.findNewEnd(i,t,n,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?i.trim(l,u):i}static findNewEnd(e,t,i,n){let o=R.getAllIntersections(e,t,!0);if(o.length===0)return n=e.parEnd,n;if(i){n=e.parEnd;for(let a of o)a.par0<n&&(n=a.par0)}else{n=e.parStart;for(let a of o)a.par0>n&&(n=a.par0)}return n}static findNewStart(e,t,i,n){let o=R.getAllIntersections(e,i,!0);if(o.length===0){t=e.parStart;return}if(n){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof be)return R.refineEllipse(e);if(e instanceof ie)return e;if(e instanceof R&&R.allSegsAreLines(e)){let t=new ie;for(let i of e.segs)t.addPoint(i.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof G))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),i=Math.PI/4,n=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(n*n+o*o),l=[];for(let c=0;c<4;c++){let h=i+c*Math.PI/2,d=e.value(h),f=e.derivative(h).normalize().mul(a),p=G.mkPP(d.sub(f),d.add(f));for(let S of R.getAllIntersections(t,p,!0))l.push(S)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new ie;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new ie;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};var ie=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}toJSON(){return{points:Array.from(this).map(e=>e.toJSON())}}static fromJSON(e){return ie.mkFromPoints(e.points.map(t=>m.fromJSON(t)))}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new m(e,t))}isClockwise(){return m.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new Mt;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=Mt.mkFromPoint(e);t.polyline=this,this.startPoint!=null?m.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let i=t.sub(e).div(2);return Ie.parallelogramByCornerSideSide(e,i,i)}static mkFromPoints(e){let t=new ie;for(let i of e)t.addPoint(i);return t}static mkClosedFromPoints(e){let t=ie.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],i=this.startPoint,n=0;for(;i.next!=null;){let o=ie.parallelogramOfLineSeg(i.point,i.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:G.mkPP(i.point,i.next.point)}}),i=i.next,n++}if(this.isClosed_){let o=ie.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:G.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:Ie.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=q.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return m.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new ie;t.addPoint(e.start);for(let i of e.segs)t.addPoint(i.end);return t.closed=e.start===e.end,t}trim(e,t){let i=this.toCurve();return i=i.trim(e,t),ie.polylineFromCurve(i)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t===this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new ie;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t===this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new ie;for(let i of this.polylinePoints())t.addPoint(e.multiplyPoint(i.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,i){throw new Error("Method not implemented.")}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0,o=this.startPoint;for(;o.next!=null;){let a=G.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<i&&(i=c,t=l+n),o=o.next,n++}if(this.closed){let a=G.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<i&&(t=l+n)}return t}clone(){let e=new ie;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t===this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new R;R.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)R.continueWithLineSegmentP(e,t.point);return this.closed&&R.continueWithLineSegmentP(e,this.startPoint.point),e}RemoveCollinearVertices(){for(let e=this.startPoint.next;e.next!=null;e=e.next)m.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2&&(e.prev.next=e.next,e.next.prev=e.prev);return this.setInitIsRequired(),this}};var Dt=class{pad(e){this.width+=e*2}constructor(e,t=e){this.width=e,this.height=t}},q=class{transform(e){return q.mkPP(e.multiplyPoint(this.leftTop),e.multiplyPoint(this.rightBottom))}translate(e){return q.mkSizeCenter(this.size,this.center.add(e))}equal(e){return this.left_===e.left&&this.right_===e.right&&this.top_===e.top&&this.bottom_===e.bottom}equalEps(e){return le(this.left_,e.left)&&le(this.right_,e.right)&&le(this.top_,e.top)&&le(this.bottom_,e.bottom)}static mkSizeCenter(e,t){let i=e.width/2,n=e.height/2;return new q({left:t.x-i,right:t.x+i,bottom:t.y-n,top:t.y+n})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return q.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=q.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),i=Math.min(this.right,e.right),n=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new q({left:t,bottom:n,right:i,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=this.leftTop.add(this.rightBottom).mul(.5),i=e.sub(t);this.leftTop=this.leftTop.add(i),this.rightBottom=this.rightBottom.add(i)}intersectsOnY(e){return!(e.bottom_>this.top_+T.distanceEpsilon||e.top_<this.bottom_-T.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+T.distanceEpsilon||e.right<this.left_-T.distanceEpsilon)}static mkEmpty(){return new q({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e,this.onUpdated()}get right(){return this.right_}set right(e){this.right_=e,this.onUpdated()}get top(){return this.top_}set top(e){this.top_=e,this.onUpdated()}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e,this.onUpdated()}get leftBottom(){return new m(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new m(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new m(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new m(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}onUpdated(){}static mkPP(e,t){let i=new q({left:e.x,right:e.x,top:e.y,bottom:e.y});return i.add(t),i}static rectangleOnPoint(e){return new q({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,i){let n=e+i.width,o=t+i.height;return new q({left:e,right:n,top:o,bottom:t})}static getRectangleOnCoords(e,t,i,n){let o=new q({left:e,bottom:t,right:e,top:t});return o.add(new m(i,n)),o}static mkOnPoints(e){let t=q.mkEmpty();for(let i of e)t.add(i);return t}static mkOnRectangles(e){let t=q.mkEmpty();for(let i of e)t.addRecSelf(i);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,i=(this.left_+this.right_)/2;this.left_=i-t,this.right_=i+t}isEmpty(){return this.right<this.left}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,i=(this.top_+this.bottom_)/2;this.top_=i+t,this.bottom=i-t}static rectangleOfTwo(e,t){let i=new q({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return i.addRecSelf(t),i}containsWithPadding(e,t){return this.left_-t-T.distanceEpsilon<=e.x&&e.x<=this.right_+t+T.distanceEpsilon&&this.bottom_-t-T.distanceEpsilon<=e.y&&e.y<=this.top_+t+T.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let i=e.clone();return i.center=e.center.add(t),i}static transform(e,t){return q.mkPP(t.multiplyPoint(e.leftTop),t.multiplyPoint(e.rightBottom))}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}containsRectWithPadding(e,t){return this.containsWithPadding(e.leftTop,t)&&this.containsWithPadding(e.rightBottom,t)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?q.mkPP(new m(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new m(Math.min(e.right,t.right),Math.min(e.top,t.top))):q.mkEmpty()}perimeter(){let e=new ie;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return new q({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get size(){return new Dt(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let i=e.width/2,n=t.x-i,o=t.x+i,a=e.height/2,l=t.y-a,u=t.y+a;return new q({left:n,right:o,top:u,bottom:l})}addPointWithSize(e,t){let i=e.width/2,n=e.height/2;this.add(new m(t.x-i,t.y-n)),this.add(new m(t.x+i,t.y-n)),this.add(new m(t.x-i,t.y+n)),this.add(new m(t.x+i,t.y+n))}};var Xe=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new Xe;return t.point=e,t}static mkSiteSP(e,t){let i=new Xe;return i.point=t,i.prev=e,e.next=i,i}static mkSiteSPS(e,t,i){let n=new Xe;return n.prev=e,n.point=t,n.next=i,e.next=n,i.prev=n,n}get turn(){return this.next==null||this.prev==null?0:m.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new Xe;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var nt=class{static mkFromPoints(e){let t=null,i=null;for(let n of e)if(i==null)i=Xe.mkSiteP(n),t=new nt(i);else{let o=Xe.mkSiteP(n);o.prev=i,i.next=o,i=o}return t}clone(){let e=this.headSite,t=null,i,n=null;for(;e!=null;)i=e.clone(),i.prev=t,t!=null?t.next=i:n=i,e=e.next,t=i;return new nt(n)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield G.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new R,t=this.headSite,i;do{let n=R.findCorner(t);if(n==null)break;let o=nt.createBezierSegOnSite(n.b);e.segs.length===0?m.closeDistEps(t.point,o.start)||R.addLineSegment(e,t.point,o.start):m.closeDistEps(e.end,o.start)||R.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=n.b}while(!0);return e.segs.length===0?m.closeDistEps(t.point,t.next.point)?e.segs.push(new Fe(t.point,t.point.add(new m(5,5)),t.point.add(new m(-5,5)),i.point)):R.addLineSegment(e,t.point,t.next.point):m.closeDistEps(e.end,t.next.point)||R.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,i=e.nextBezierCoefficient,n=e.prev,o=e.next,a=n.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(i).add(e.point.mul(1-i)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Fe.mkBezier([a,u,c,l])}};var xt=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,i){this.elements[e][t]=i}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return le(this.elements[0][0],1)&&le(this.elements[0][1],0)&&le(this.elements[0][2],0)&&le(this.elements[1][0],0)&&le(this.elements[1][1],1)&&le(this.elements[1][2],0)}offset(){return new m(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new xt(1,0,0,0,1,0)}constructor(e,t,i,n,o,a){this.elements=[[e,t,i],[n,o,a]]}static rotation(e){let t=Math.cos(e),i=Math.sin(e);return new xt(t,-i,0,i,t,0)}static scaleAroundCenterTransformation(e,t,i){let n=1-e,o=1-t;return new xt(e,0,n*i.x,0,t,o*i.y)}multiplyPoint(e){return new m(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new xt(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,i=-this.getElem(0,1)/e,n=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-i*this.getElem(1,2),l=-n*this.getElem(0,2)-o*this.getElem(1,2);return new xt(t,i,a,n,o,l)}};var vo=class{static mkEllipse(e,t,i){return be.mkFullEllipseNNP(e,t,i)}static createParallelogram(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y,u=80*Math.PI/180,c=n/Math.tan(u);return ie.mkClosedFromPoints([new m(-o-c+a,-n+l),new m(o+a,-n+l),new m(o+a+c,n+l),new m(-o+a,n+l)])}static createHexagon(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y;return ie.mkClosedFromPoints([new m(-o+a,-n+l),new m(o+a,-n+l),new m(o+(n+a),0+l),new m(o+a,n+l),new m(-o+a,n+l),new m(-(o-n)+a,0+l)])}static createOctagon(e,t,i){let n=e/2,o=t/2,a=new Array(8);a[0]=new m(n+vo.octagonPad*n,o-o*vo.octagonPad),a[3]=new m(a[0].x*-1,a[0].y),a[4]=new m(a[3].x,a[3].y*-1),a[7]=new m(a[0].x,a[0].y*-1),a[1]=new m(n-n*vo.octagonPad,o+o*vo.octagonPad),a[2]=new m(a[1].x*-1,a[1].y),a[6]=new m(a[1].x,a[1].y*-1),a[5]=new m(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(i);return ie.mkClosedFromPoints(a)}static createInvertedHouse(e,t,i){let n=vo.createHouse(e,t,i);return vo.rotateCurveAroundCenterByDegree(n,i,180)}static createHouse(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new R;return R.addLineSegmentCNNNN(u,a-n,l-o,a+n,l-o),R.continueWithLineSegmentNN(u,a+n,l+o),R.continueWithLineSegmentNN(u,a,l+2*o),R.continueWithLineSegmentNN(u,a-n,l+o),R.closeCurve(u)}static mkDiamond(e,t,i){let n=e,o=t,a=i.x,l=i.y,u=new R,c=[new m(a,l-o),new m(a+n,l),new m(a,l+o),new m(a-n,l)];return u.addSegs([G.mkPP(c[0],c[1]),G.mkPP(c[1],c[2]),G.mkPP(c[2],c[3]),G.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,i){return vo.rotateCurveAroundCenterByRadian(e,t,i*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,i){let n=Math.cos(i),o=Math.sin(i),a=new xt(1,0,t.x,0,1,t.y).multiply(new xt(n,-o,0,o,n,0)).multiply(new xt(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return be.mkCircle(e,t)}static createRectangle(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new R,c=[new m(a-n,l-o),new m(a+n,l-o),new m(a+n,l+o),new m(a-n,l+o)];return u.addSegs([G.mkPP(c[0],c[1]),G.mkPP(c[1],c[2]),G.mkPP(c[2],c[3]),G.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof R))return;let t=e.segs;if(t.length!==8&&t.length!==4)return;let i=t.length===8,n,o;for(let a=0;a<4;a++){let l=i?2*a+1:a;if(a===0){if(!(t[l]instanceof be))return;let u=t[l];n=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof be))return;let u=t[l];if(n!==u.aAxis.length||o!==u.bAxis.length)return}}return{radX:n,radY:o}}static mkRectangleWithRoundedCorners(e,t,i,n,o=new m(0,0)){if(i===0||n===0)return vo.createRectangle(e,t,o);let a=new R,l=e/2;i>l/2&&(i=l/2);let u=t/2;n>u/2&&(n=u/2);let c=o.x,h=o.y,d=l-i,f=u-n,p=h+u,S=h-u,x=c-l,C=c+l,O=new m(i,0),B=new m(0,n);return d>0&&a.addSegment(G.mkPP(new m(c-d,S),new m(c+d,S))),a.addSegment(be.mkEllipse(1.5*Math.PI,2*Math.PI,O,B,c+d,h-f)),f>0&&a.addSegment(G.mkPP(new m(C,h-f),new m(C,h+f))),a.addSegment(be.mkEllipse(0,.5*Math.PI,O,B,c+d,h+f)),d>0&&a.addSegment(G.mkPP(new m(c+d,p),new m(c-d,p))),a.addSegment(be.mkEllipse(.5*Math.PI,Math.PI,O,B,c-d,h+f)),f>0&&a.addSegment(G.mkPP(new m(x,h+f),new m(x,h-f))),a.addSegment(be.mkEllipse(Math.PI,1.5*Math.PI,O,B,c-d,h-f)),a}},_e=vo;_e.octagonPad=1/4;function pn(s){return s.parEnd-s.parStart}function Lp(s){switch(s.type){case"ellipse":return be.fromJSON(s.data);case"curve":return R.fromJSON(s.data);case"lineSegment":return G.fromJSON(s.data);case"bezier":return Fe.fromJSON(s.data);case"polyline":return ie.fromJSON(s.data)}}function NO(s){if(s instanceof be)return"ellipse";if(s instanceof R)return"curve";if(s instanceof G)return"lineSegment";if(s instanceof Fe)return"bezier";if(s instanceof ie)return"polyline";throw new Error("not implemented")}function Rp(s){return{type:NO(s),data:s.toJSON()}}var gi=class{static get DifferenceEpsilon(){return gi.differenceEpsilon}static EqualPP(e,t){return gi.Equal(e.x,t.x)&&gi.Equal(e.y,t.y)}static Equal(e,t){return gi.Compare(e,t)===0}static Compare(e,t){let i=0;return e+gi.DifferenceEpsilon<t?i=-1:t+gi.DifferenceEpsilon<e&&(i=1),i}static ComparePP(e,t){let i=gi.Compare(e.x,t.x);return i===0&&(i=gi.Compare(e.y,t.y)),i}static LessOrEqual(e,t){let i=gi.Compare(e,t);return i<0||i===0}static Less(e,t){return gi.Compare(e,t)<0}static GetDirections(e,t){return Y.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return Y.IsPureDirection(gi.GetDirections(e,t))}static IsPureDirectionD(e){return Y.IsPureDirection(e)}static IsPureLower(e,t){let i=gi.GetDirections(e,t);return 2===i||1===i}static GetPureDirectionVV(e,t){return gi.GetDirections(e.point,t.point)}},U=gi;U.differenceEpsilon=T.distanceEpsilon/2;var Y=class{constructor(e){this.Dir=e}get Right(){return new Y(Y.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>U.DifferenceEpsilon?t=2:e.x<-U.DifferenceEpsilon&&(t=8),e.y>U.DifferenceEpsilon?t=t|1:e.y<-U.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let i=0,n=t.x-e.x,o=t.y-e.y;return n>U.DifferenceEpsilon?i=2:-n>U.DifferenceEpsilon&&(i=8),o>U.DifferenceEpsilon?i|=1:-o>U.DifferenceEpsilon&&(i|=4),i}static DirectionFromPointToPoint(e,t){return Y.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return Y.IsPureDirection(Y.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e===t||e===Y.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)===2&&e++,(this.Dir&1)===1&&t++,(this.Dir&8)===8&&e--,(this.Dir&4)===4&&t--,new m(e,t)}static toPoint(e){return new Y(e).ToPoint()}static negate(e){return new Y(Y.OppositeDir(e.Dir))}};var Ii=class extends xe{constructor(t,i){super(t);this._isPositioned=!1;i&&(this.boundingBox=q.mkPP(new m(0,0),new m(i.width,i.height)))}clone(){let t=new Ii(null,null);return t.isPositioned=this.isPositioned,t._boundingBox=this._boundingBox.clone(),t.attachmentSegmentEnd=this.attachmentSegmentEnd,t.attachmentSegmentStart=this.attachmentSegmentStart,t}get isPositioned(){return this._isPositioned}set isPositioned(t){this._isPositioned=t}get boundingBox(){return this._boundingBox}set boundingBox(t){this._boundingBox=t}setBoundingBox(t){this.isPositioned=!0,this._boundingBox=t}get width(){return this.boundingBox.width}set width(t){this.boundingBox.width=t}get height(){return this.boundingBox.height}set height(t){this.boundingBox.height=t}get center(){return this.boundingBox.center}set center(t){this.boundingBox.center=t}translate(t){this.isPositioned&&(this.center=this.center.add(t))}transform(t){this.isPositioned&&(this.center=t.multiplyPoint(this.center))}positionCenter(t){this.boundingBox.center=t,this.isPositioned=!0}};var We=class extends xe{constructor(t){super(t);this.lineWidth=1}static getGeom(t){return xe.getGeom(t)}clone(){let t=new We(null);return this.smoothedPolyline&&(t.smoothedPolyline=this.smoothedPolyline.clone()),t.curve=this.curve.clone(),this.sourceArrowhead!=null&&(t.sourceArrowhead=this.sourceArrowhead.clone()),this.targetArrowhead!=null&&(t.targetArrowhead=this.targetArrowhead.clone()),t}get label(){return this.edge!=null&&this.edge.label!=null?xe.getGeom(this.edge.label):null}set label(t){this.edge.label.setAttr(qe.GeomObjectIndex,t)}RaiseLayoutChangeEvent(t){this.edge.raiseEvents(t)}requireRouting(){this.curve=null,this.smoothedPolyline=null}translate(t){if(!(t.x===0&&t.y===0)){if(this.curve!=null&&this.curve.translate(t),this.smoothedPolyline!=null)for(let i=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;i!=null;i=i.next,n=n.next)i.point=n.point.add(t);if(this.sourceArrowhead!=null&&this.sourceArrowhead.tipPosition&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(t)),this.targetArrowhead!=null&&this.targetArrowhead.tipPosition&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(t)),this.edge.label){let i=Ii.getGeom(this.edge.label);i&&i.translate(t)}}}GetMaxArrowheadLength(){let t=0;return this.sourceArrowhead!=null&&(t=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>t?this.targetArrowhead.length:t}transform(t){if(this.curve!=null){if(this.curve=this.curve.transform(t),this.smoothedPolyline!=null)for(let i=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;i!=null;i=i.next,n=n.next)i.point=t.multiplyPoint(i.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=t.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=t.multiplyPoint(this.targetArrowhead.tipPosition))}}get edge(){return this.entity}get source(){return xe.getGeom(this.edge.source)}*sourceArrowheadPoints(t){if(this.sourceArrowhead==null)return;yield this.sourceArrowhead.tipPosition;let i=this.sourceArrowhead.tipPosition.sub(this.curve.start);i=i.rotate90Cw().mul(Math.tan(t*.5*(Math.PI/180))),yield i.add(this.curve.start),yield this.curve.start.sub(i)}*targetArrowheadPoints(t){if(this.targetArrowhead==null)return;yield this.targetArrowhead.tipPosition;let i=this.targetArrowhead.tipPosition.sub(this.curve.end);i=i.rotate90Cw().mul(Math.tan(t*.5*(Math.PI/180))),yield i.add(this.curve.end),yield this.curve.end.sub(i)}get boundingBox(){let t=q.mkEmpty();if(this.smoothedPolyline!=null)for(let n of this.smoothedPolyline)t.add(n);this.curve!=null&&t.addRecSelf(this.curve.boundingBox);for(let n of this.sourceArrowheadPoints(25))t.add(n);for(let n of this.targetArrowheadPoints(25))t.add(n);this.label&&t.addRecSelf(this.label.boundingBox);let i=this.lineWidth;return t.left-=i,t.top+=i,t.right+=i,t.bottom-=i,t}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return xe.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(t,i,n){let o=t.boundingBox.width,a=t.boundingBox.height,l=t.boundingBox.center,u=new m(l.x-o/4,l.y),c=new m(l.x-o/4,l.y-a/2-i),h=new m(l.x+o/4,l.y-a/2-i),d=new m(l.x+o/4,l.y);return n.smoothedPolyline=nt.mkFromPoints([u,c,h,d]),n.smoothedPolyline.createCurve()}underCollapsedGraph(){return this.source.underCollapsedGraph()||this.target.underCollapsedGraph()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var Wy=Ae(kn(),1);var De=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var cs=class{constructor(){this.attrs=[];this._parent=null}addEvent(e){this.events.push(e)}removeEvent(e){let t=this.events.indexOf(e);t>=0&&(this.events=this.events.splice(t,1))}raiseEvents(e){this.events.forEach(t=>t(e))}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t===e)return!0;return!1}};var br=class extends cs{constructor(t,i){super();this.source=t,this.target=i,t!==i?(t.outEdges.add(this),i.inEdges.add(this)):t.selfEdges.add(this)}add(){this.source!==this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!==this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!==this.target.parent}EdgeToAncestor(){return this.source instanceof Ce&&this.target.isDescendantOf(this.source)?1:this.target instanceof Ce&&this.source.isDescendantOf(this.target)?2:0}};var Rr=class extends cs{constructor(t){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=t}removeOutEdge(t){this.outEdges.delete(t)}removeInEdge(t){this.inEdges.delete(t)}get id(){return this._id}set id(t){this._id=t}toString(){return this.id}*_edges(){for(let t of this.inEdges)yield t;for(let t of this.outEdges)yield t;for(let t of this.selfEdges)yield t}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}};var _p=class{constructor(){this.nodeMap=new Map}remove(e){this.nodeMap.delete(e.id)}get size(){return this.nodeMap.size}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof Ce&&(yield e)}findShallow(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}get nodeShallowCount(){return this.nodeMap.size}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.nodeMap.set(e.id,e)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!==e||t.source===t.target)return!1;for(let t of e.inEdges)if(t.target!==e||t.source===t.target)return!1;for(let t of e.selfEdges)if(t.target!==t.source||t.source!==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap.values())if(!this.nodeIsConsistent(e))return!1;return!0}};var Ce=class extends Rr{constructor(t="__graph__"){super(t);this.nodeCollection=new _p}remove(t){this.nodeCollection.remove(t)}removeSubgraph(){let t=this.parent;t&&t.removeNode(this);for(let i of this.outGoingEdges())i.attachedAtSource?i.node.removeOutEdge(i.edge):i.node.removeInEdge(i.edge)}*outGoingEdges(){for(let t of this.outEdges){let i=t.target;this.isAncestor(i)||(yield{edge:t,node:i,attachedAtSource:!1})}for(let t of this.inEdges){let i=t.source;this.isAncestor(i)||(yield{edge:t,node:i,attachedAtSource:!0})}for(let t of this.nodesBreadthFirst){for(let i of t.outEdges){let n=i.target;n!==this&&(this.isAncestor(n)||(yield{edge:i,node:n,attachedAtSource:!1}))}for(let i of t.inEdges){let n=i.source;n!==this&&(this.isAncestor(n)||(yield{edge:i,node:n,attachedAtSource:!0}))}}}isAncestor(t){for(let i of t.getAncestors())if(i===this)return!0;return!1}*getClusteredConnectedComponents(){let t=new Set,i=new Wy.Queue;for(let n of this.nodesBreadthFirst){if(t.has(n))continue;t.add(n),i.enqueue(n);let o=new Set;do{let a=i.dequeue();a.parent===this&&o.add(a);for(let l of this.reachableFrom(a))t.has(l)||(t.add(l),i.enqueue(l))}while(i.length>0);yield Array.from(o)}}*reachableFrom(t){for(let i of t.outEdges)yield i.target;for(let i of t.inEdges)yield i.source;t instanceof Ce&&(yield*t.shallowNodes),t.parent!=this&&(yield t.parent)}hasSomeAttrOnIndex(t){for(let i of this.nodesBreadthFirst)if(i.getAttr(t))return!0;for(let i of this.deepEdges)if(i.getAttr(t))return!0;return!1}*graphs(){for(let t of this.nodeCollection.graphs)yield t}noEmptySubgraphs(){for(let t of this.subgraphsBreadthFirst())if(t.shallowNodeCount===0)return!1;return!0}hasSubgraphs(){for(let t of this.shallowNodes)if(t instanceof Ce)return!0;return!1}*subgraphsBreadthFirst(){for(let t of this.nodesBreadthFirst)t instanceof Ce&&(yield t)}isEmpty(){return this.shallowNodeCount===0}setEdge(t,i){let n=this.nodeCollection.findShallow(t);if(n==null)return;let o=this.nodeCollection.findShallow(i);if(o!=null)return new br(n,o)}get shallowNodes(){return this.nodeCollection.nodesShallow}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let t of this.nodeCollection.nodesShallow)yield t,t instanceof Ce&&(yield*t.nodesBreadthFirst)}findNodeRecursive(t){let i=this.nodeCollection.findShallow(t);if(i)return i;for(let n of this.shallowNodes)if(n instanceof Ce){let o=n.findNodeRecursive(t);if(o)return o}return null}findNode(t){return this.nodeCollection.findShallow(t)}get shallowEdges(){return this.nodeCollection.edges}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let t of this.nodesBreadthFirst){for(let i of t.outEdges)yield i;for(let i of t.selfEdges)yield i;for(let i of t.inEdges)this.isAncestor(i.source)||(yield i)}}isConsistent(){return this.parent?this.parent.isConsistent():this.eachNodeIdIsUnique()&&this.nodeCollection.isConsistent()}nodeIsConsistent(t){return this.nodeCollection.nodeIsConsistent(t)}removeNode(t){for(let i of t.outEdges)i.target.inEdges.delete(i);for(let i of t.inEdges)i.source.outEdges.delete(i);this.nodeCollection.remove(t);for(let i of this.subgraphsBreadthFirst())i.removeNode(t)}addNode(t){return De.assert(this.findNodeRecursive(t.id)==null),t.parent=this,this.nodeCollection.addNode(t),t}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){let t=this.nodeCollection.size;for(let i of this.shallowNodes)i instanceof Ce&&(t+=i.nodeCountDeep);return t}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(t){for(;t!=null&&t.parent!==this;)t=t.parent;return t}get deepEdgesCount(){let t=0;for(let i of this.nodesBreadthFirst)t+=i.outDegree+i.selfDegree;return t}eachNodeIdIsUnique(){let t=new Set;for(let i of this.nodesBreadthFirst){if(t.has(i.id))return!1;t.add(i.id)}return!0}*allElements(){for(let t of this.allSuccessorsWidthFirst()){yield t;for(let i of t.selfEdges)yield i;for(let i of t.outEdges)yield i;for(let i of t.inEdges)this.isAncestor(i.source)||(yield i)}yield*this.edges}*allSuccessorsWidthFirst(){for(let t of this.shallowNodes)yield t;for(let t of this.shallowNodes)t instanceof Ce&&(yield*t.allSuccessorsWidthFirst())}*allSuccessorsDepthFirst(){for(let t of this.shallowNodes)t instanceof Ce&&(yield*t.allSuccessorsDepthFirst()),yield t}};function*sv(s){let e=new Set,t=new Wy.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(n(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of i(l))n(u,t,e)}yield a}function*i(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function n(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function Hy(s,e){e.parent&&e.parent.remove(e),s.addNode(e)}function jy(s,e){let t=new Map,i=s.nodeCountDeep,n=1/i;for(let o of s.nodesBreadthFirst)t.set(o,n);for(let o=0;o<50;o++){n=(1-e)/i;let a=new Map;for(let l of s.nodesBreadthFirst)a.set(l,n);for(let l of s.nodesBreadthFirst){let u=a.get(l);for(let c of l.inEdges){let h=c.source;u+=e*(t.get(h)/h.outDegree)}a.set(l,u)}t=a}return t}var wl=class extends xe{constructor(){super(...arguments);this.padding=1}clone(){let t=new wl(null);return this.boundaryCurve&&(t.boundaryCurve=this.boundaryCurve.clone()),t}translate(t){t.x===0&&t.y===0||this.boundaryCurve.translate(t)}toJSON(){return{boundaryCurve:this.boundaryCurve,padding:this.padding}}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(t){t!=null&&t.boundingBox&&(t.boundingBox.height<wl.minHeight||t.boundingBox.width<wl.minWidth)&&(t=_e.mkCircle(wl.minWidth,t.boundingBox.center)),this._boundaryCurve=t}get id(){return this.node.id}toString(){return this.id}static mkNode(t,i){let n=new wl(i);return n.boundaryCurve=t,n}get center(){return this.boundaryCurve.boundingBox.center}set center(t){let i=t.sub(this.center);this.boundaryCurve.translate(i)}fitBoundaryCurveToTarget(t){if(this.boundaryCurve!=null){let i=_e.isRoundedRect(this.boundaryCurve);if(i==null){let n=t.width/this.boundaryCurve.boundingBox.width,o=t.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(n,o),this.boundaryCurve.translate(t.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=_e.mkRectangleWithRoundedCorners(t.width,t.height,i.radX,i.radY,t.center)}}static getGeom(t){return t.getAttr(qe.GeomObjectIndex)}*inEdges(){for(let t of this.node.inEdges)yield xe.getGeom(t)}*outEdges(){for(let t of this.node.outEdges)yield xe.getGeom(t)}*selfEdges(){for(let t of this.node.selfEdges)yield xe.getGeom(t)}get boundingBoxWithPadding(){let t=this.boundingBox.clone();return t.pad(this.padding),t}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(t){!this.boundaryCurve||(Math.abs(t.width-this.width)<1e-4&&Math.abs(t.height-this.height)<1e-4?this.center=t.center:this.fitBoundaryCurveToTarget(t))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(t){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(t))}underCollapsedGraph(){let t=this.node.parent;if(t==null)return!1;let i=xe.getGeom(t);return i==null?!1:i.isCollapsed?!0:i.underCollapsedGraph()}*getAncestors(){for(let t of this.node.getAncestors())yield xe.getGeom(t)}},ot=wl;ot.minHeight=2,ot.minWidth=3;var Pe=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var qy=class{},Ll=qy;Ll.GoldenRatio=(1+Math.sqrt(5))/2,Ll.GoldenRatioRemainder=2-qy.GoldenRatio;var ra=class extends Pe{constructor(t,i){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=t,this.desiredAspectRatio=i}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(t,i,n){let o=ra.GetGoldenSectionStep(t,i),a=Math.max(n/10,(i-t)/ra.MaxSteps);i+=a,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length===1?this.PackLimit(t):this.rectangles.length===2?(this.PackLimit(t),this.PackLimit(i)):this.rectangles.length>2&&ra.GoldenSectionSearch(u=>this.PackLimit(u),t,o,i,a);let l=this.bestPacking.getRects();for(let u=0;u<this.rectangles.length;u++)this.rectangles[u]=l[u]}PackLimit(t){let i=this.cachedCosts.get(t);if(i==null){let n=this.createPacking(this.rectangles,t);n.run(),this.cachedCosts.set(t,i=Math.abs(n.PackedAspectRatio-this.desiredAspectRatio)),i<this.bestPackingCost&&(this.bestPackingCost=i,this.bestPacking=n)}return i}static GoldenSectionSearch(t,i,n,o,a){if(Math.abs(i-o)<a)return t(i)<t(o)?i:o;let l=ra.GetGoldenSectionStep(n,o),u=t(n),c=t(l),h=()=>ra.GoldenSectionSearch(t,l,n,i,a),d=()=>ra.GoldenSectionSearch(t,n,l,o,a);if(c<u)return d();if(c>u)return h();let f=d(),p=h();return t(p)<t(f)?p:f}static GetGoldenSectionStep(t,i){return t<i?t+Ll.GoldenRatioRemainder*(i-t):t-Ll.GoldenRatioRemainder*(t-i)}},fd=ra;fd.MaxSteps=1e3;var av=Ae(mn(),1);var Np=class extends Pe{get PackedWidth(){return this.packedWidth}set PackedWidth(t){this.packedWidth=t}get PackedHeight(){return this.packedHeight}set PackedHeight(t){this.packedHeight=t}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let t=[];for(let[i,n]of this.rectsToCenters)i.center=n,t.push(i);return t}};var Rl=class extends Np{constructor(t,i,n=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=n?t:Rl.SortRectangles(t),this.wrapWidth=i}static SortRectangles(t){return t.sort((i,n)=>n.height-i.height),t}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let t=new av.Stack,i=!1,n=0,o=0,a=0,l=this.rectanglesByDescendingHeight;for(let u=0;i||u<l.length;){let c=l[u],h=t.length>0?t.top:null;if(h==null||h.right+c.width<=this.wrapWidth&&n+c.height<=h.top){let f=new m(h?h.right:0,n).add(new m(c.width/2,c.height/2));c.center=f,this.rectsToCenters.set(c,f),o=Math.max(o,c.right),a=Math.max(a,c.top),t.push(c),i=!1}else n=h.top,t.pop(),i=!0;i||u++}this.PackedWidth=o,this.PackedHeight=a}};var hc=class extends fd{constructor(e,t){super(Rl.SortRectangles(e),t),this.createPacking=(i,n)=>new Rl(i,n,!0)}run(){let e=Number.MAX_VALUE,t=0,i=0;for(let n of this.rectangles){let o=n.width;i+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,i,e)}};var gd=Ae(mn(),1);function DO(s,e,t,i,n,o){for(let l=0;l<s.length;l++){if(l===e||l===t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;i.length*2<n.length?(i.push(s[l]),o.box0=u):n.length*2<i.length?(n.push(s[l]),o.box1=h):c<d?(i.push(s[l]),o.box0=u):d<c?(n.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(i.push(s[l]),o.box0=u):(n.push(s[l]),o.box1=h)}}function et(s){if(s.length===0)return null;if(s.length===1)return s[0];let e={b0:s[0].irect,seed0:1},t=FO(s,e),i=[],n=[];i.push(s[e.seed0]),n.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};DO(s,e.seed0,t,i,n,o);let a=uv(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=et(i),a.Right=et(n),a}function lv(s,e){return s.add_rect(e).area}function FO(s,e){let t=lv(e.b0,s[e.seed0].irect);for(let n=2;n<s.length;n++){let o=lv(e.b0,s[n].irect);o>t&&(e.seed0=n,t=o)}let i;for(let n=0;n<s.length;n++)if(n!==e.seed0){i=n;break}t=s[e.seed0].irect.add_rect(s[i].irect).area;for(let n=0;n<s.length;n++){if(n===e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[n].irect).area;o>t&&(i=n,t=o)}return i}function fc(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(i=>lt(i,e(i)));return et(t)}function uv(s){let e=new dc;return e.Count=s,e}function lt(s,e){let t=new dc;return t.UserData=s,t.irect=e,t.Count=1,t}function Ky(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)===0?s.Left!=null?Ky(s.Left,e,t)===0&&Ky(s.Right,e,t)===0?0:1:0:1:0}var dc=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent===this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent===this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this===this.Parent.Left}FirstHitNodePF(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)===1?this:null:this:(i=this.Left.FirstHitNodePF(e,t))!=null?i:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)===1?this:null:(i=this.Left.FirstHitNodeWithPredicate(e,t))!=null?i:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitByRectWithPredicate(e,t){var i;return this.irect.intersects_rect(e)?this.IsLeaf?t(this.UserData)===1?this:null:(i=this.Left.FirstHitByRectWithPredicate(e,t))!=null?i:this.Right.FirstHitByRectWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t=null){let i=new gd.Stack;for(i.push(this);i.size>0;){let n=i.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?(t==null||t(n.UserData))&&(yield n.UserData):(i.push(n.left),i.push(n.right)))}}*AllHitItems_(e){let t=new gd.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.contains_point(e)&&(i.IsLeaf?yield i.UserData:(t.push(i.left),t.push(i.right)))}}VisitTree(e,t){Ky(this,e,t)}Clone(){let e=uv(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new gd.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?yield i:(t.push(i.left),t.push(i.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new gd.Stack;for(t.push(this);t.size>0;){let i=t.pop();(i.IsLeaf||!e)&&(yield i),i.IsLeaf||(t.push(i.left),t.push(i.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function hs(s){return new Co(et(s.map(([e,t])=>lt(t,e))))}function GO(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function cv(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function VO(s,e){let t=new Array;for(let n of s.GetAllLeafNodes())n!==e&&t.push(n);let i=et(t);s.Count=i.Count,s.Left=i.Left,s.Right=i.Right,s.irect=i.Left.irect.add_rect(i.Right.irect)}function kO(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!hv(e))return e;return null}function hv(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function Zy(s,e,t,i){return s.irect.intersects_rect(e)?s.IsLeaf?i(s.UserData)?--t.bound!==0:!0:Zy(s.Left,e,t,i)&&Zy(s.Right,e,t,i):!0}var Co=class{clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,i){return Zy(this._rootNode,e,{bound:t},i)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(lt(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=et(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=et(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=lt(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let i,n;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{i=t.Left.irect.add_rect(e.irect);let o=i.area-t.Left.irect.area;n=t.Right.irect.add_rect(e.irect);let a=n.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n):i.area<n.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count===0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count===0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count===0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count===0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(i.UserData===t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let i;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))n.UserData===t&&(i=n);if(i!=null)return this.RootNode.Count===1?this.RootNode=null:this.RemoveLeaf(i),i.UserData}RemoveLeaf(e){let t=kO(e);if(t!=null)VO(t,e),cv(t);else{let i=e.Parent;i==null?this._rootNode=new dc:(GO(i,e.IsLeftChild?i.Right:i.Left),cv(i))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!hv(t))return t;return null}};var Mp=class extends q{constructor(t){super(t);this.radX=t.radX,this.radY=t.radY,this.roundedRect_=_e.mkRectangleWithRoundedCorners(this.width,this.height,t.radX,t.radY,this.center)}onUpdated(){this.isEmpty||(this.roundedRect_=_e.mkRectangleWithRoundedCorners(this.width,this.height,this.radX,this.radY,this.center))}isOk(){return this.isEmpty()?!0:this.roundedRect_.boundingBox.equalEps(this)}setRect(t){this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.isEmpty()||(this.roundedRect_=_e.mkRectangleWithRoundedCorners(t.width,t.height,this.radX,this.radY,this.center))}};var pt=class{constructor(e,t){uc(e,t)<0?(this._first=e,this._second=t):(this._first=t,this._second=e)}get first(){return this._first}get second(){return this._second}get Length(){return Ue(this._first,this._second)}CompareTo(e){let t=uc(this._first,e._first);return t!==0?t:uc(this._second,e._second)}static equal(e,t){return e._first.equal(t._first)&&e._second.equal(t._second)}toString(){return this._first+(" "+this._second)}};function Bp(s,e){let t=e.map(o=>[o,o.boundingBox]),i=t.map(o=>o[1]),n=new hc(i,1.5);n.run();for(let[o,a]of t){let l=a.leftBottom.sub(o.boundingBox.leftBottom);o.translate(l)}s.boundingBox=new q({left:0,bottom:0,right:n.PackedWidth,top:n.PackedHeight})}var me=class extends ot{constructor(t){super(t);this.margins={left:10,top:10,bottom:10,right:10};this.radX=10;this.radY=10;this.rrect=new Mp({left:0,right:-1,top:20,bottom:0,radX:this.radX,radY:this.radY})}isAncestor(t){return this.graph.isAncestor(t.node)}deepTranslate(t){for(let i of this.nodesBreadthFirst){i instanceof me?i.boundingBox=i.boundingBox.translate(t):i.translate(t);for(let n of i.selfEdges())n.translate(t);for(let n of i.outEdges())this.graph.isAncestor(n.target.node)&&n.translate(t)}this.boundingBox=this.boundingBox.translate(t)}clone(){let t=new me(null);return t.boundingBox=this.boundingBox.clone(),t.layoutSettings=this.layoutSettings,t.margins=this.margins,t.radX=this.radX,t.radY=this.radY,t}calculateBoundsFromChildren(){let t=q.mkEmpty();for(let i of this.shallowNodes)t.addRecSelf(i.boundingBoxWithPadding);return t.padEverywhere(this.margins),t}*allSuccessorsWidthFirst(){for(let t of this.graph.allSuccessorsWidthFirst())yield ot.getGeom(t)}static getGeom(t){return xe.getGeom(t)}edgeCurveOrArrowheadsIntersectRect(t,i){for(let a of t.sourceArrowheadPoints(25))if(i.contains(a))return!0;for(let a of t.targetArrowheadPoints(25))if(i.contains(a))return!0;let n=t.curve,o=i.perimeter();return R.intersectionOne(n,o,!1)!=null||R.PointRelativeToCurveLocation(n.start,o)===2}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(t){this.layoutSettings=t;for(let i of this.nodesBreadthFirst){let n=i;n.layoutSettings=t}}get layoutSettings(){return this._layoutSettings}set layoutSettings(t){this._layoutSettings=t}get labelSize(){return this._labelSize}set labelSize(t){this._labelSize=t}get boundingBox(){return this.rrect?this.rrect.clone():null}set boundingBox(t){t?this.rrect.setRect(t):this.rrect.roundedRect_=null}transform(t){if(!t.isIdentity()){for(let i of this.shallowNodes)i.transform(t);for(let i of this.shallowEdges)i.transform(t),i.label&&i.label.transform(t);this.boundingBox=this.rrect==null||this.rrect.isEmpty()?this.pumpTheBoxToTheGraphWithMargins():this.boundingBox.transform(t)}}translate(t){t.x===0&&t.y===0||this.deepTranslate(t)}get nodesBreadthFirst(){return this.nodesBreadthFirstIter()}*nodesBreadthFirstIter(){for(let t of this.graph.nodesBreadthFirst)yield xe.getGeom(t)}setEdge(t,i){let n=this.graph.setEdge(t,i);return new We(n)}getPumpedGraphWithMarginsBox(){let t={b:q.mkEmpty()};return Dp(this,t),t.b.padEverywhere(this.margins),t.b}pumpTheBoxToTheGraphWithMargins(){return this.boundingBox=this.getPumpedGraphWithMarginsBox()}get center(){return this.boundingBox||this.boundingBox.isEmpty?this.boundingBox.center:new m(0,0)}set center(t){let i=t.sub(this.center),n=new xt(1,0,i.x,0,1,i.y);this.transform(n)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}get boundaryCurve(){return this.rrect.roundedRect_}set boundaryCurve(t){throw new Error}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let t of this.graph.shallowNodes)yield xe.getGeom(t)}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let t of this.graph.deepEdges)yield xe.getGeom(t)}get shallowEdges(){return this.shallowEdgesIt()}*shallowEdgesIt(){for(let t of this.graph.shallowEdges)yield xe.getGeom(t)}static mk(t,i=new Dt(0,0)){let n=new me(new Ce(t));return n.labelSize=i,n}get Clusters(){return this.subgraphs()}*subgraphs(){for(let t of this.graph.subgraphsBreadthFirst())yield xe.getGeom(t)}static mkWithGraphAndLabel(t,i){let n=new me(t);return n.labelSize=i,n}get deepNodeCount(){let t=0;for(let i of this.graph.nodesBreadthFirst)t++;return t}get subgraphsDepthFirst(){return this.getSubgraphsDepthFirst()}*getSubgraphsDepthFirst(){for(let t of this.graph.allSuccessorsDepthFirst())t instanceof Ce&&(yield me.getGeom(t))}get uniformMargins(){return Math.max(this.margins.left,this.margins.right,this.margins.right,this.margins.bottom)}set uniformMargins(t){this.margins.left=this.margins.right=this.margins.right=this.margins.bottom=t}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(t){let i=this.graph.liftNode(t.node);return i?xe.getGeom(i):null}findNode(t){let i=this.graph.findNode(t);return i?xe.getGeom(i):null}addNode(t){return this.graph.addNode(t.node),t}addLabelToGraphBB(t){this.labelSize&&(t.top+=this.labelSize.height+2,t.width<this.labelSize.width&&(t.width=this.labelSize.width))}};function Dp(s,e){for(let i of s.shallowEdges){if(!t(i))continue;let n=i.curve.boundingBox;e.b.addRecSelf(n),i.edge.label!=null&&e.b.addRecSelf(xe.getGeom(i.edge.label).boundingBox)}for(let i of s.shallowNodes)"shallowEdges"in i&&Dp(i,e),!(i.underCollapsedGraph()||!i.boundingBox)&&e.b.addRecSelf(i.boundingBox);s instanceof me&&s.addLabelToGraphBB(e.b);function t(i){if(i.curve==null||i.underCollapsedGraph())return!1;if(s instanceof me){let n=s.entity;return n.isAncestor(i.source.entity)&&n.isAncestor(i.target.entity)}else return!0}}var ye=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x===this.y}};var Xr=class{isEmpty(){if(this.arrayOfMaps.length===0)return!0;for(let e of this.arrayOfMaps)if(e.size>0)return!1;return!0}set(e,t,i){this.arrayOfMaps[e].set(t,i)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield new ye(e,i[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield[new ye(e,i[0]),i[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield i[1]}}};var ia=class{isEmpty(){return this.curveClips.length==0&&this.arrowheads.length==0&&this.nodes.length==0&&this.labels.length==0}*entitiesOfTile(){for(let e of this.curveClips)yield e.edge;for(let e of this.labels)yield e.parent.edge;for(let e of this.arrowheads)yield e.edge;for(let e of this.nodes)yield e.node}clear(){this.curveClips=[],this.arrowheads=[],this.nodes=[],this.labels=[]}static mk(e,t,i,n,o){let a=new ia;return a.curveClips=e,a.arrowheads=t,a.nodes=i,a.labels=n,a.rect=o,a}get elementCount(){return this.curveClips.length+this.arrowheads.length+this.labels.length+this.nodes.length}addElement(e){e instanceof ot?this.nodes.push(e):e instanceof Ii?this.labels.push(e):"curve"in e?this.curveClips.push(e):this.arrowheads.push(e)}};var md=class{constructor(e,t){this.visualRank=new Map;this.tileCapacity=1e4;this.levels=[];this.highestRank=26;this.lowestRank=1;this.geomGraph=e,this.topLevelTileRect=t,this.fillTopLevelTile(),this.minTileSize=this.getMinTileSize()}getTileData(e,t,i){let n=this.levels[i];return n?n.get(e,t):null}*getTilesOfLevel(e){let t=this.levels[e];if(t!=null)for(let[i,n]of t.keyValues())yield{x:i.x,y:i.y,data:n}}getMinTileSize(){let e=0,t=0,i=0;for(let n of this.geomGraph.nodesBreadthFirst)n instanceof me||(i==0?(e=n.width,t=n.height):(e=(i*e+n.width)/(i+1),t=(i*t+n.height)/(i+1)),i++);return new Dt(e*8,t*8)}fillTopLevelTile(){let e=new Xr(1),t=jy(this.geomGraph.graph,.85);this.pageRank=new Map;for(let a of this.geomGraph.graph.deepEdges)this.pageRank.set(a,t.get(a.source)+t.get(a.target)),a.label&&this.pageRank.set(a.label,t.get(a.source)+t.get(a.target));for(let a of this.geomGraph.graph.nodesBreadthFirst){let l=t.get(a);this.pageRank.set(a,2*l)}let i=new ia;i.curveClips=[];let n=i.arrowheads=new Array,o=i.labels=new Array;for(let a of this.geomGraph.graph.deepEdges){let l=We.getGeom(a),u=We.getGeom(a).curve;if(u instanceof R)for(let c of u.segs)i.curveClips.push({curve:c,edge:a});else i.curveClips.push({curve:u,edge:a});l.sourceArrowhead&&n.push({edge:l.edge,tip:l.sourceArrowhead.tipPosition,base:l.curve.start}),l.targetArrowhead&&n.push({edge:l.edge,tip:l.targetArrowhead.tipPosition,base:l.curve.end}),l.label&&o.push(l.label)}i.nodes=Array.from(this.geomGraph.nodesBreadthFirst),i.rect=this.topLevelTileRect,e.set(0,0,i),this.levels.push(e)}buildUpToLevel(e){let t=!0;for(let n of this.levels[0].values())if(n.elementCount>this.tileCapacity){t=!1;break}if(t)return this.levels.length;for(let n=1;n<=e&&!this.subdivideLevel(n);n++);this.calculateVisualRank(),this.pushUpNodeRanksAboveTheirEdges();let i=Array.from(this.visualRank.keys()).sort((n,o)=>this.compareByVisPageRanks(n,o));for(let n=0;n<this.levels.length-1;n++)this.filterOutEntities(this.levels[n],i,n);return this.calculateRank(i),this.levels.length}calculateRank(e){let t=this.highestRank-this.lowestRank;this.entityRank=new Map;let i=Math.floor(e.length/t),n=this.highestRank,o=0;for(let a=0;a<e.length;a++,o++)this.entityRank.set(e[a],n),o==i&&n>this.lowestRank&&(o=0,n--)}pushUpNodeRanksAboveTheirEdges(){for(let e of this.geomGraph.nodesBreadthFirst){if(e instanceof me)continue;let t=this.visualRank.get(e.node),i=this.pageRank.get(e.node),n=!1;for(let o of e.node.edges)t=Math.max(t,this.visualRank.get(o)),i=Math.max(i,this.pageRank.get(o)),n=!0;n?(this.visualRank.set(e.node,t),this.pageRank.set(e.node,i)):(this.visualRank.set(e.node,2*t),this.pageRank.set(e.node,2*i))}}compareByVisPageRanks(e,t){let i=this.pageRank.get(t)-this.pageRank.get(e);return i||(t instanceof Rr&&e instanceof br?1:t instanceof br&&e instanceof Rr?-1:0)}calculateVisualRank(){for(let e of this.levels[this.levels.length-1].values())this.calculateVisualRankOnTile(e)}calculateVisualRankOnTile(e){let t=Array.from(new Set(e.entitiesOfTile())),i=2/t.length,n=i/(2*t.length);t.sort((o,a)=>this.pageRank.get(a)-this.pageRank.get(a));for(let o=0;o<t.length;o++){let a=t[o],l=this.visualRank.get(a);l?(this.visualRank.set(a,i+l),i-=n):this.visualRank.set(a,i)}}filterOutEntities(e,t,i){let n=this.transferDataOfLevelToMap(e),o=0;for(;o<t.length;o++){let a=t[o];if(!this.tryAddToLevel(e,a,n.get(a)))break}console.log("added",o,"visual elements to level",i)}tryAddToLevel(e,t,i,n=!1){if(!n){for(let o of i)if(o.tile.elementCount>=this.tileCapacity)return!1}for(let o of i){let a=o.tile,l=o.data;a.addElement(l)}return!0}transferDataOfLevelToMap(e){let t=new Map;for(let n of e.values()){for(let o of n.curveClips){let a=o.edge;i(a).push({tile:n,data:o})}for(let o of n.labels){let a=o.parent.edge;i(a).push({tile:n,data:o})}for(let o of n.nodes){let a=o.node;i(a).push({tile:n,data:o})}for(let o of n.arrowheads){let a=o.edge;i(a).push({tile:n,data:o})}n.clear()}return t;function i(n){let o=t.get(n);return o||t.set(n,o=new Array),o}}subdivideLevel(e){let t=Math.pow(2,e),i=this.levels[e]=new Xr(t),n=this.topLevelTileRect.width,o=this.topLevelTileRect.height;for(let l=0;l<e;l++)n/=2,o/=2;return!!(this.subdivideTilesOnLevel(e,n,o,i)||n<=this.minTileSize.width&&o<=this.minTileSize.height)}subdivideTilesOnLevel(e,t,i,n){let o=!0;for(let[a,l]of this.levels[e-1].keyValues())o=this.subdivideOneTile(a,t,i,l,n,o,e);return o}subdivideOneTile(e,t,i,n,o,a,l){let u=e.x,c=e.y,h=this.topLevelTileRect.left+u*t*2,d=this.topLevelTileRect.bottom+c*i*2,f=new Array(4);for(let S=0;S<2;S++)for(let x=0;x<2;x++){let C=new q({left:h+t*S,right:h+t*(S+1),bottom:d+i*x,top:d+i*(x+1)});f[S*2+x]=this.generateSubTileWithoutEdgeClips(n,C)}p();for(let S=0;S<2;S++)for(let x=0;x<2;x++){let C=f[S*2+x];C.isEmpty()||(o.set(2*u+S,2*c+x,C),a&&C.elementCount>this.tileCapacity&&(a=!1))}return a;function p(){let S=new G(h,d+i,h+2*t,d+i),x=new G(h+t,d,h+t,d+2*i);for(let C of n.curveClips){let O=Array.from(R.getAllIntersections(C.curve,S,!1)).concat(Array.from(R.getAllIntersections(C.curve,x,!1)));O.sort((I,_)=>I.par0-_.par0);let B=[C.curve.parStart];for(let I=0;I<O.length;I++){let _=O[I];_.par0>B[B.length-1]+T.distanceEpsilon&&B.push(_.par0)}C.curve.parEnd>B[B.length-1]+T.distanceEpsilon&&B.push(C.curve.parEnd);for(let I=0;I<B.length-1;I++){let _=B.length>2?C.curve.trim(B[I],B[I+1]):C.curve;if(!_)continue;let X=(_.parEnd-_.parStart)/5,K=_.parStart,se=_.boundingBox;for(let ge=0;ge<6;ge++,K+=X){let ue=_.value(K),F=ue.x<=h+t?0:1,M=ue.y<=d+i?0:1,W=2*F+M,j=f[W];if(!!j.rect.containsRect(se)){j.curveClips.push({curve:_,edge:C.edge});break}}}}}}generateSubTileWithoutEdgeClips(e,t){let i=ia.mk([],[],[],[],t);for(let n of e.nodes)n.boundingBox.intersects(t)&&i.nodes.push(n);for(let n of e.labels)n.boundingBox.intersects(t)&&i.labels.push(n);for(let n of e.arrowheads){let o=q.mkPP(n.base,n.tip),l=n.tip.sub(n.base).div(3).rotate90Cw();o.add(n.base.add(l)),o.add(n.base.sub(l)),o.intersects(t)&&i.arrowheads.push(n)}return i}};var ds=class extends cs{toString(){return"label of "+(this.parent?this.parent.toString():"null")}constructor(e){super(),this.parent=e}};var L=class{static mkWithKeyword(e,t,i,n,o){let a=new L(e,t,i,n);return a.keyword=o,a}static parse(e){switch(e.toLowerCase()){case"aliceblue":return L.AliceBlue;case"antiquewhite":return L.AntiqueWhite;case"aqua":return L.Aqua;case"aquamarine":return L.Aquamarine;case"azure":return L.Azure;case"beige":return L.Beige;case"bisque":return L.Bisque;case"black":return L.Black;case"blanchedalmond":return L.BlanchedAlmond;case"blue":return L.Blue;case"blueviolet":return L.BlueViolet;case"brown":return L.Brown;case"burlywood":return L.BurlyWood;case"cadetblue":return L.CadetBlue;case"chartreuse":return L.Chartreuse;case"chocolate":return L.Chocolate;case"coral":return L.Coral;case"cornflowerblue":return L.CornflowerBlue;case"cornsilk":return L.Cornsilk;case"crimson":return L.Crimson;case"cyan":return L.Cyan;case"darkblue":return L.DarkBlue;case"darkcyan":return L.DarkCyan;case"darkgoldenrod":return L.DarkGoldenrod;case"darkgray":return L.DarkGray;case"darkgreen":return L.DarkGreen;case"darkkhaki":return L.DarkKhaki;case"darkmagenta":return L.DarkMagenta;case"darkolivegreen":return L.DarkOliveGreen;case"darkorange":return L.DarkOrange;case"darkorchid":return L.DarkOrchid;case"darkred":return L.DarkRed;case"darksalmon":return L.DarkSalmon;case"darkseagreen":return L.DarkSeaGreen;case"darkslateblue":return L.DarkSlateBlue;case"darkslategray":return L.DarkSlateGray;case"darkturquoise":return L.DarkTurquoise;case"darkviolet":return L.DarkViolet;case"deeppink":return L.DeepPink;case"deepskyblue":return L.DeepSkyBlue;case"dimgray":return L.DimGray;case"dodgerblue":return L.DodgerBlue;case"firebrick":return L.Firebrick;case"floralwhite":return L.FloralWhite;case"forestgreen":return L.ForestGreen;case"fuchsia":return L.Fuchsia;case"gainsboro":return L.Gainsboro;case"ghostwhite":return L.GhostWhite;case"gold":return L.Gold;case"goldenrod":return L.Goldenrod;case"gray":return L.Gray;case"green":return L.Green;case"greenyellow":return L.GreenYellow;case"honeydew":return L.Honeydew;case"hotpink":return L.HotPink;case"indianred":return L.IndianRed;case"indigo":return L.Indigo;case"ivory":return L.Ivory;case"khaki":return L.Khaki;case"lavender":return L.Lavender;case"lavenderblush":return L.LavenderBlush;case"lawngreen":return L.LawnGreen;case"lemonchiffon":return L.LemonChiffon;case"lightblue":return L.LightBlue;case"lightcoral":return L.LightCoral;case"lightcyan":return L.LightCyan;case"lightgoldenrodyellow":return L.LightGoldenrodYellow;case"lightgray":case"lightgrey":return L.LightGray;case"lightgreen":return L.LightGreen;case"lightpink":return L.LightPink;case"lightsalmon":return L.LightSalmon;case"lightseagreen":return L.LightSeaGreen;case"lightskyblue":return L.LightSkyBlue;case"lightslategray":return L.LightSlateGray;case"lightsteelblue":return L.LightSteelBlue;case"lightyellow":return L.LightYellow;case"lime":return L.Lime;case"limegreen":return L.LimeGreen;case"linen":return L.Linen;case"magenta":return L.Magenta;case"maroon":return L.Maroon;case"mediumaquamarine":return L.MediumAquamarine;case"mediumblue":return L.MediumBlue;case"mediumorchid":return L.MediumOrchid;case"mediumpurple":return L.MediumPurple;case"mediumseagreen":return L.MediumSeaGreen;case"mediumslateblue":return L.MediumSlateBlue;case"mediumspringgreen":return L.MediumSpringGreen;case"mediumturquoise":return L.MediumTurquoise;case"mediumvioletred":return L.MediumVioletRed;case"midnightblue":return L.MidnightBlue;case"mintcream":return L.MintCream;case"mistyrose":return L.MistyRose;case"moccasin":return L.Moccasin;case"navajowhite":return L.NavajoWhite;case"navy":return L.Navy;case"oldlace":return L.OldLace;case"olive":return L.Olive;case"olivedrab":return L.OliveDrab;case"orange":return L.Orange;case"orangered":return L.OrangeRed;case"orchid":return L.Orchid;case"palegoldenrod":return L.PaleGoldenrod;case"palegreen":return L.PaleGreen;case"paleturquoise":return L.PaleTurquoise;case"palevioletred":return L.PaleVioletRed;case"papayawhip":return L.PapayaWhip;case"peachpuff":return L.PeachPuff;case"peru":return L.Peru;case"pink":return L.Pink;case"plum":return L.Plum;case"powderblue":return L.PowderBlue;case"purple":return L.Purple;case"red":return L.Red;case"rosybrown":return L.RosyBrown;case"royalblue":return L.RoyalBlue;case"saddlebrown":return L.SaddleBrown;case"salmon":return L.Salmon;case"sandybrown":return L.SandyBrown;case"seagreen":return L.SeaGreen;case"seashell":return L.SeaShell;case"sienna":return L.Sienna;case"silver":return L.Silver;case"skyblue":return L.SkyBlue;case"slateblue":return L.SlateBlue;case"slategray":return L.SlateGray;case"snow":return L.Snow;case"springgreen":return L.SpringGreen;case"steelblue":return L.SteelBlue;case"tan":return L.Tan;case"teal":return L.Teal;case"thistle":return L.Thistle;case"tomato":return L.Tomato;case"transparent":return L.Transparent;case"turquoise":return L.Turquoise;case"violet":return L.Violet;case"wheat":return L.Wheat;case"white":return L.White;case"whitesmoke":return L.WhiteSmoke;case"yellow":return L.Yellow;case"yellowgreen":return L.YellowGreen;default:return}}get keyword(){return this.keyword_}set keyword(e){this.keyword_=e}constructor(e,t,i,n){this.a=e,this.r=t,this.g=i,this.b=n}static mkRGB(e,t,i){return new L(255,e,t,i)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length===1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a===t.a&&e.r===t.r&&e.b===t.b&&e.g===t.g}toString(){return this.keyword?this.keyword:'"#'+L.Xex(this.R)+L.Xex(this.G)+L.Xex(this.B)+(this.A===255?"":L.Xex(this.A))+'"'}static get AliceBlue(){return L.mkWithKeyword(255,240,248,255,"aliceblue")}static get AntiqueWhite(){return L.mkWithKeyword(255,250,235,215,"antiquewhite")}static get Aqua(){return L.mkWithKeyword(255,0,255,255,"aqua")}static get Aquamarine(){return L.mkWithKeyword(255,127,255,212,"aquamarine")}static get Azure(){return L.mkWithKeyword(255,240,255,255,"azure")}static get Beige(){return L.mkWithKeyword(255,245,245,220,"beige")}static get Bisque(){return L.mkWithKeyword(255,255,228,196,"bisque")}static get Black(){return L.mkWithKeyword(255,0,0,0,"black")}static get BlanchedAlmond(){return L.mkWithKeyword(255,255,235,205,"blanchedalmond")}static get Blue(){return L.mkWithKeyword(255,0,0,255,"blue")}static get BlueViolet(){return L.mkWithKeyword(255,138,43,226,"blueviolet")}static get Brown(){return L.mkWithKeyword(255,165,42,42,"brown")}static get BurlyWood(){return L.mkWithKeyword(255,222,184,135,"burlywood")}static get CadetBlue(){return L.mkWithKeyword(255,95,158,160,"cadetblue")}static get Chartreuse(){return L.mkWithKeyword(255,127,255,0,"chartreuse")}static get Chocolate(){return L.mkWithKeyword(255,210,105,30,"chocolate")}static get Coral(){return L.mkWithKeyword(255,255,127,80,"coral")}static get CornflowerBlue(){return L.mkWithKeyword(255,100,149,237,"cornflowerblue")}static get Cornsilk(){return L.mkWithKeyword(255,255,248,220,"cornsilk")}static get Crimson(){return L.mkWithKeyword(255,220,20,60,"crimson")}static get Cyan(){return L.mkWithKeyword(255,0,255,255,"cyan")}static get DarkBlue(){return L.mkWithKeyword(255,0,0,139,"darkblue")}static get DarkCyan(){return L.mkWithKeyword(255,0,139,139,"darkcyan")}static get DarkGoldenrod(){return L.mkWithKeyword(255,184,134,11,"darkgoldenrod")}static get DarkGray(){return L.mkWithKeyword(255,169,169,169,"darkgray")}static get DarkGreen(){return L.mkWithKeyword(255,0,100,0,"darkgreen")}static get DarkKhaki(){return L.mkWithKeyword(255,189,183,107,"darkkhaki")}static get DarkMagenta(){return L.mkWithKeyword(255,139,0,139,"darkmagenta")}static get DarkOliveGreen(){return L.mkWithKeyword(255,85,107,47,"darkolivegreen")}static get DarkOrange(){return L.mkWithKeyword(255,255,140,0,"darkorange")}static get DarkOrchid(){return L.mkWithKeyword(255,153,50,204,"darkorchid")}static get DarkRed(){return L.mkWithKeyword(255,139,0,0,"darkred")}static get DarkSalmon(){return L.mkWithKeyword(255,233,150,122,"darksalmon")}static get DarkSeaGreen(){return L.mkWithKeyword(255,143,188,139,"darkseagreen")}static get DarkSlateBlue(){return L.mkWithKeyword(255,72,61,139,"darkslateblue")}static get DarkSlateGray(){return L.mkWithKeyword(255,47,79,79,"darkslategray")}static get DarkTurquoise(){return L.mkWithKeyword(255,0,206,209,"darkturquoise")}static get DarkViolet(){return L.mkWithKeyword(255,148,0,211,"darkviolet")}static get DeepPink(){return L.mkWithKeyword(255,255,20,147,"deeppink")}static get DeepSkyBlue(){return L.mkWithKeyword(255,0,191,255,"deepskyblue")}static get DimGray(){return L.mkWithKeyword(255,105,105,105,"dimgray")}static get DodgerBlue(){return L.mkWithKeyword(255,30,144,255,"dodgerblue")}static get Firebrick(){return L.mkWithKeyword(255,178,34,34,"firebrick")}static get FloralWhite(){return L.mkWithKeyword(255,255,250,240,"floralwhite")}static get ForestGreen(){return L.mkWithKeyword(255,34,139,34,"forestgreen")}static get Fuchsia(){return L.mkWithKeyword(255,255,0,255,"fuchsia")}static get Gainsboro(){return L.mkWithKeyword(255,220,220,220,"gainsboro")}static get GhostWhite(){return L.mkWithKeyword(255,248,248,255,"ghostwhite")}static get Gold(){return L.mkWithKeyword(255,255,215,0,"gold")}static get Goldenrod(){return L.mkWithKeyword(255,218,165,32,"goldenrod")}static get Gray(){return L.mkWithKeyword(255,128,128,128,"gray")}static get Green(){return L.mkWithKeyword(255,0,128,0,"green")}static get GreenYellow(){return L.mkWithKeyword(255,173,255,47,"greenyellow")}static get Honeydew(){return L.mkWithKeyword(255,240,255,240,"honeydew")}static get HotPink(){return L.mkWithKeyword(255,255,105,180,"hotpink")}static get IndianRed(){return L.mkWithKeyword(255,205,92,92,"indianred")}static get Indigo(){return L.mkWithKeyword(255,75,0,130,"indigo")}static get Ivory(){return L.mkWithKeyword(255,255,255,240,"ivory")}static get Khaki(){return L.mkWithKeyword(255,240,230,140,"khaki")}static get Lavender(){return L.mkWithKeyword(255,230,230,250,"lavender")}static get LavenderBlush(){return L.mkWithKeyword(255,255,240,245,"lavenderblush")}static get LawnGreen(){return L.mkWithKeyword(255,124,252,0,"lawngreen")}static get LemonChiffon(){return L.mkWithKeyword(255,255,250,205,"lemonchiffon")}static get LightBlue(){return L.mkWithKeyword(255,173,216,230,"lightblue")}static get LightCoral(){return L.mkWithKeyword(255,240,128,128,"lightcoral")}static get LightCyan(){return L.mkWithKeyword(255,224,255,255,"lightcyan")}static get LightGoldenrodYellow(){return L.mkWithKeyword(255,250,250,210,"lightgoldenrodyellow")}static get LightGray(){return L.mkWithKeyword(255,211,211,211,"lightgray")}static get LightGreen(){return L.mkWithKeyword(255,144,238,144,"lightgreen")}static get LightPink(){return L.mkWithKeyword(255,255,182,193,"lightpink")}static get LightSalmon(){return L.mkWithKeyword(255,255,160,122,"lightsalmon")}static get LightSeaGreen(){return L.mkWithKeyword(255,32,178,170,"lightseagreen")}static get LightSkyBlue(){return L.mkWithKeyword(255,135,206,250,"lightskyblue")}static get LightSlateGray(){return L.mkWithKeyword(255,119,136,153,"lightslategray")}static get LightSteelBlue(){return L.mkWithKeyword(255,176,196,222,"lightsteelblue")}static get LightYellow(){return L.mkWithKeyword(255,255,255,224,"lightyellow")}static get Lime(){return L.mkWithKeyword(255,0,255,0,"lime")}static get LimeGreen(){return L.mkWithKeyword(255,50,205,50,"limegreen")}static get Linen(){return L.mkWithKeyword(255,250,240,230,"linen")}static get Magenta(){return L.mkWithKeyword(255,255,0,255,"magenta")}static get Maroon(){return L.mkWithKeyword(255,128,0,0,"maroon")}static get MediumAquamarine(){return L.mkWithKeyword(255,102,205,170,"mediumaquamarine")}static get MediumBlue(){return L.mkWithKeyword(255,0,0,205,"mediumblue")}static get MediumOrchid(){return L.mkWithKeyword(255,186,85,211,"mediumorchid")}static get MediumPurple(){return L.mkWithKeyword(255,147,112,219,"mediumpurple")}static get MediumSeaGreen(){return L.mkWithKeyword(255,60,179,113,"mediumseagreen")}static get MediumSlateBlue(){return L.mkWithKeyword(255,123,104,238,"mediumslateblue")}static get MediumSpringGreen(){return L.mkWithKeyword(255,0,250,154,"mediumspringgreen")}static get MediumTurquoise(){return L.mkWithKeyword(255,72,209,204,"mediumturquoise")}static get MediumVioletRed(){return L.mkWithKeyword(255,199,21,133,"mediumvioletred")}static get MidnightBlue(){return L.mkWithKeyword(255,25,25,112,"midnightblue")}static get MintCream(){return L.mkWithKeyword(255,245,255,250,"mintcream")}static get MistyRose(){return L.mkWithKeyword(255,255,228,225,"mistyrose")}static get Moccasin(){return L.mkWithKeyword(255,255,228,181,"moccasin")}static get NavajoWhite(){return L.mkWithKeyword(255,255,222,173,"navajowhite")}static get Navy(){return L.mkWithKeyword(255,0,0,128,"navy")}static get OldLace(){return L.mkWithKeyword(255,253,245,230,"oldlace")}static get Olive(){return L.mkWithKeyword(255,128,128,0,"olive")}static get OliveDrab(){return L.mkWithKeyword(255,107,142,35,"olivedrab")}static get Orange(){return L.mkWithKeyword(255,255,165,0,"orange")}static get OrangeRed(){return L.mkWithKeyword(255,255,69,0,"orangered")}static get Orchid(){return L.mkWithKeyword(255,218,112,214,"orchid")}static get PaleGoldenrod(){return L.mkWithKeyword(255,238,232,170,"palegoldenrod")}static get PaleGreen(){return L.mkWithKeyword(255,152,251,152,"palegreen")}static get PaleTurquoise(){return L.mkWithKeyword(255,175,238,238,"paleturquoise")}static get PaleVioletRed(){return L.mkWithKeyword(255,219,112,147,"palevioletred")}static get PapayaWhip(){return L.mkWithKeyword(255,255,239,213,"papayawhip")}static get PeachPuff(){return L.mkWithKeyword(255,255,218,185,"peachpuff")}static get Peru(){return L.mkWithKeyword(255,205,133,63,"peru")}static get Pink(){return L.mkWithKeyword(255,255,192,203,"pink")}static get Plum(){return L.mkWithKeyword(255,221,160,221,"plum")}static get PowderBlue(){return L.mkWithKeyword(255,176,224,230,"powderblue")}static get Purple(){return L.mkWithKeyword(255,128,0,128,"purple")}static get Red(){return L.mkWithKeyword(255,255,0,0,"red")}static get RosyBrown(){return L.mkWithKeyword(255,188,143,143,"rosybrown")}static get RoyalBlue(){return L.mkWithKeyword(255,65,105,225,"royalblue")}static get SaddleBrown(){return L.mkWithKeyword(255,139,69,19,"saddlebrown")}static get Salmon(){return L.mkWithKeyword(255,250,128,114,"salmon")}static get SandyBrown(){return L.mkWithKeyword(255,244,164,96,"sandybrown")}static get SeaGreen(){return L.mkWithKeyword(255,46,139,87,"seagreen")}static get SeaShell(){return L.mkWithKeyword(255,255,245,238,"seashell")}static get Sienna(){return L.mkWithKeyword(255,160,82,45,"sienna")}static get Silver(){return L.mkWithKeyword(255,192,192,192,"silver")}static get SkyBlue(){return L.mkWithKeyword(255,135,206,235,"skyblue")}static get SlateBlue(){return L.mkWithKeyword(255,106,90,205,"slateblue")}static get SlateGray(){return L.mkWithKeyword(255,112,128,144,"slategray")}static get Snow(){return L.mkWithKeyword(255,255,250,250,"snow")}static get SpringGreen(){return L.mkWithKeyword(255,0,255,127,"springgreen")}static get SteelBlue(){return L.mkWithKeyword(255,70,130,180,"steelblue")}static get Tan(){return L.mkWithKeyword(255,210,180,140,"tan")}static get Teal(){return L.mkWithKeyword(255,0,128,128,"teal")}static get Thistle(){return L.mkWithKeyword(255,216,191,216,"thistle")}static get Tomato(){return L.mkWithKeyword(255,255,99,71,"tomato")}static get Transparent(){return L.mkWithKeyword(0,255,255,255,"transparent")}static get Turquoise(){return L.mkWithKeyword(255,64,224,208,"turquoise")}static get Violet(){return L.mkWithKeyword(255,238,130,238,"violet")}static get Wheat(){return L.mkWithKeyword(255,245,222,179,"wheat")}static get White(){return L.mkWithKeyword(255,255,255,255,"white")}static get WhiteSmoke(){return L.mkWithKeyword(255,245,245,245,"whitesmoke")}static get Yellow(){return L.mkWithKeyword(255,255,255,0,"yellow")}static get YellowGreen(){return L.mkWithKeyword(255,154,205,50,"yellowgreen")}};var gc=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(gc||{});var na=class extends us{constructor(t){super(t,qe.DrawingObjectIndex);this.labelfontcolor=L.Black;this.styles=[];this.penwidth=1;this.fontname=na.defaultLabelFontName,this.fontsize=na.defaultLabelFontSize}rebind(t){this.entity=t,this.bind(qe.DrawingObjectIndex)}static copyValidFields(t,i){t==null||i==null||(t.color&&t.color.keyword&&t.color.keyword.toLowerCase()!=="black"&&(i.color=t.color),t.fillColor&&(i.fillColor=t.fillColor),t.labelfontcolor&&t.labelfontcolor.keyword.toLowerCase()!=="black"&&(i.labelfontcolor=t.labelfontcolor),t.labelText!=null&&t.labelText!==""&&t.labelText!==t.id&&(i.labelText=t.labelText),t.fontColor&&t.fontColor.keyword&&t.fontColor.keyword.toLowerCase()!=="black"&&(i.fontColor=t.fontColor),t.styles&&t.styles.length&&(i.styles=t.styles.map(n=>n)),t.pencolor&&t.pencolor.keyword!=="black"&&(i.pencolor=t.pencolor),t.penwidth&&t.penwidth!==1&&(i.penwidth=t.penwidth),t.rankdir&&(i.rankdir=t.rankdir),t.fontname&&t.fontname!==na.defaultLabelFontName&&(i.fontname=t.fontname),t.margin&&(i.margin=t.margin),t.fontsize&&t.fontsize!==na.defaultLabelFontSize&&(i.fontsize=t.fontsize),t.orientation&&(i.orientation=t.orientation),t.ranksep&&(i.ranksep=t.ranksep),t.arrowtail&&(i.arrowtail=t.arrowtail),t.arrowhead&&(i.arrowhead=t.arrowhead),t.ordering&&(i.ordering=t.ordering),t.bgcolor&&(i.bgcolor=t.bgcolor),t.pos&&(i.pos=t.pos),t.nodesep&&(i.nodesep=t.nodesep),t.arrowsize&&(i.arrowsize=t.arrowsize),t.samehead&&(i.samehead=t.samehead),t.layersep&&(i.layersep=t.layersep),t.clusterRank&&(i.clusterRank=t.clusterRank))}*attrIter(){if(this.color&&this.color.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"color",eq:this.color.toString()}),this.fillColor&&(yield{type:"attr",id:"fillColor",eq:this.fillColor.toString()}),this.labelfontcolor&&this.labelfontcolor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"labelfontcolor",eq:this.labelfontcolor.toString()}),!(this.labelText==null||this.labelText==="")&&this.entity&&this.labelText!==this.id&&(yield{type:"attr",id:"label",eq:this.labelText}),this.fontColor&&this.fontColor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"fontColor",eq:this.fontColor.toString()}),this.styles&&this.styles.length){let t=this.styles.map(i=>gc[i]).reduce((i,n)=>i.concat(","+n));yield{type:"attr",id:"style",eq:t}}this.pencolor&&this.pencolor.keyword!=="black"&&(yield{type:"attr",id:"pencolor",eq:this.pencolor.toString()}),this.penwidth&&this.penwidth!==1&&(yield{type:"attr",id:"penwidth",eq:this.penwidth.toString()}),this.rankdir&&(yield{type:"attr",id:"rankdir",eq:this.rankdir.toString()}),this.fontname&&this.fontname!==na.defaultLabelFontName&&(yield{type:"attr",id:"fontname",eq:this.fontname}),this.margin&&(yield{type:"attr",id:"margin",eq:this.margin.toString()}),this.fontsize&&this.fontsize!==na.defaultLabelFontSize&&(yield{type:"attr",id:"fontsize",eq:this.fontsize.toString()}),this.orientation&&(yield{type:"attr",id:"orientation",eq:this.orientation.toString()}),this.ranksep&&(yield{type:"attr",id:"ranksep",eq:this.ranksep.toString()}),this.arrowtail&&(yield{type:"attr",id:"arrowtail",eq:this.arrowtail.toString()}),this.arrowhead&&(yield{type:"attr",id:"arrowhead",eq:this.arrowhead.toString()}),this.ordering&&(yield{type:"attr",id:"ordering",eq:this.ordering.toString()}),this.bgcolor&&(yield{type:"attr",id:"bgcolor",eq:this.bgcolor.toString()}),this.pos&&(yield{type:"attr",id:"pos",eq:this.pos.toString()}),this.nodesep&&(yield{type:"attr",id:"nodesep",eq:this.nodesep.toString()}),this.arrowsize&&(yield{type:"attr",id:"arrowsize",eq:this.arrowsize.toString()}),this.samehead&&(yield{type:"attr",id:"samehead",eq:this.samehead.toString()}),this.layersep&&(yield{type:"attr",id:"layersep",eq:this.layersep.toString()}),this.clusterRank&&(yield{type:"attr",id:"clusterrank",eq:this.clusterRank.toString()}),this.measuredTextSize&&(yield{type:"attr",id:"measuredTextSize",eq:JSON.stringify(this.measuredTextSize)})}get labelText(){return this._labelText}set labelText(t){this._labelText=t}get id(){return this._id}set id(t){this._id=t}static getDrawingObj(t){return t==null?null:t.getAttr(qe.DrawingObjectIndex)}},ke=na;ke.defaultLabelFontName="Times-Roman",ke.defaultLabelFontSize=12;var Ao=(I=>(I[I.normal=0]="normal",I[I.inv=1]="inv",I[I.dot=2]="dot",I[I.invdot=3]="invdot",I[I.odot=4]="odot",I[I.invodot=5]="invodot",I[I.none=6]="none",I[I.tee=7]="tee",I[I.empty=8]="empty",I[I.invempty=9]="invempty",I[I.diamond=10]="diamond",I[I.odiamond=11]="odiamond",I[I.ediamond=12]="ediamond",I[I.crow=13]="crow",I[I.box=14]="box",I[I.obox=15]="obox",I[I.open=16]="open",I[I.halfopen=17]="halfopen",I[I.vee=18]="vee",I))(Ao||{});var qi=class extends ke{constructor(t,i){super(t);this.directed=!0;this.directed=i,i?this.arrowhead=0:this.arrowhead=6,this.arrowtail=6}clone(){let t=new qi(null,this.directed);return ke.copyValidFields(this,t),t.directed=this.directed,t.arrowtail=this.arrowtail,t.arrowhead=this.arrowhead,t}};var fs=(_=>(_[_.diamond=0]="diamond",_[_.ellipse=1]="ellipse",_[_.box=2]="box",_[_.circle=3]="circle",_[_.record=4]="record",_[_.plaintext=5]="plaintext",_[_.point=6]="point",_[_.mdiamond=7]="mdiamond",_[_.msquare=8]="msquare",_[_.polygon=9]="polygon",_[_.doublecircle=10]="doublecircle",_[_.house=11]="house",_[_.invhouse=12]="invhouse",_[_.parallelogram=13]="parallelogram",_[_.octagon=14]="octagon",_[_.tripleoctagon=15]="tripleoctagon",_[_.triangle=16]="triangle",_[_.trapezium=17]="trapezium",_[_.drawFromGeometry=18]="drawFromGeometry",_[_.hexagon=19]="hexagon",_))(fs||{});var Fp=class extends ke{constructor(t){super(t);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;t!=null&&(this.labelText=t.id)}clone(){throw new Error("Method not implemented.")}*attrIter(){yield*super.attrIter(),this.shape&&this.shape!==2&&(yield{type:"attr",id:"shape",eq:this.shape.toString()}),this.xRad&&this.xRad!==3&&(yield{type:"attr",id:"xRad",eq:this.xRad.toString()}),this.yRad&&this.yRad!==3&&(yield{type:"attr",id:"yRad",eq:this.yRad.toString()}),this.padding&&this.padding!==2&&(yield{type:"attr",id:"padding",eq:this.padding.toString()})}get Padding(){return this.padding}set Padding(t){this.padding=Math.max(0,t)}get XRadius(){return this.xRad}set XRadius(t){this.xRad=t}get YRadius(){return this.yRad}set YRadius(t){this.yRad=t}static get DefaultFillColor(){return Fp.defaultFillColor}static set DefaultFillColor(t){Fp.defaultFillColor=t}get ShapeEnum(){return this.shape}set ShapeEnum(t){this.shape=t}get LabelMargin(){return this.labelMargin}set LabelMargin(t){this.labelMargin=t}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(t){this.labelWidthToHeightRatio=t}get node(){return this.entity}get id(){return this.node?this.node.id:null}},wt=Fp;wt.defaultFillColor=L.LightGray;var bn=class{constructor(){this.length=bn.defaultArrowheadLength;this.width=0}clone(){let e=new bn;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=bn.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let i=bn.findTrimEndForArrowheadAtTarget(e);if(i==null||t>i-T.intersectionEpsilon||R.closeIntersectionPoints(e.curve.value(t),e.curve.value(i)))return!1;let n=e.curve.trim(t,i);return n==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=n,!0)}static getIntersectionsWithArrowheadCircle(e,t,i){let n=be.mkFullEllipseNNP(t,t,i);return R.getAllIntersections(n,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=T.distanceEpsilon*T.distanceEpsilon,i=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=T.distanceEpsilon)return i;let n=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u===0)return;l=bn.getIntersectionsWithArrowheadCircle(n,o,n.end),i=l.length!==0?Math.max(...l.map(c=>c.par1)):n.parEnd,a=e.curve.value(i),o/=2}while(a.sub(n.start).lengthSquared<t||l.length===0);return i}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=T.distanceEpsilon)return e.curve.parStart;let t=T.distanceEpsilon*T.distanceEpsilon,i=e.sourceArrowhead.length,n,o=e.curve,a,l=10,u;for(;--l>0;){if(a=bn.getIntersectionsWithArrowheadCircle(o,i,o.start),a.length===0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),n=a.filter(c=>c.par1===u)[0].x,n.sub(o.end).lengthSquared>=t)return u;i/=2}}static trimSplineAndCalculateArrowheads(e,t,i){return bn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,i)}static trimSplineAndCalculateArrowheadsII(e,t,i,n,o){if(e.curve=R.trimEdgeSplineWithNodeBoundaries(t,i,n,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<T.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<T.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>T.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>T.intersectionEpsilon)&&!a&&(a=bn.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!==0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=n.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=n.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,i=e.target.center,n=i.sub(t),o=n.length,a;o<.001?(a=new m(1,0),i=t.add(a.rotate(Math.PI/2))):a=n.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=R.createBezierSegN(t,i,a,u);if(bn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}bn.createEdgeCurveWithNoTrimming(e,t,i)}static createEdgeCurveWithNoTrimming(e,t,i){let n=i.sub(t).normalize(),o=t,a=i,l=e.targetArrowhead;l!=null&&(l.tipPosition=i,a=i.sub(n.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(n.mul(u.length))),e.curve=G.mkPP(o,a)}},mt=bn;mt.defaultArrowheadLength=5;var oa=class{};var Or=class extends oa{get Location(){return this.curve.value(this.parameter)}set Location(t){throw new Error("Method should not be called.")}static mk(t,i){let n=new Or;return n.curve=t,n.parameter=i,n}get Parameter(){return this.parameter}set Parameter(t){this.parameter=t}get Curve(){return this.curve}set Curve(t){this.curve=t}};var Pr=class extends oa{constructor(t,i){super();this.curve=this.curve,this.location=i.clone()}get Location(){return this.location}set Location(t){this.location=t}Translate(t){this.location=this.location.add(t)}get Curve(){return this.curve}set Curve(t){this.curve=t}};var dv=Ae(mn(),1);var Qy=class{constructor(e,t){this.v=e,this.i=t}},wi=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,i,n){t[i]=1,e.push(new Qy(i,n))}static getFeedbackSet(e){let t=new Xr(e.nodeCount);if(e==null||e.nodeCount===0)return[];let i=new Array(e.nodeCount).fill(0);for(let n=0;n<e.nodeCount;n++){if(i[n]===2)continue;let o=new dv.Stack,a=0;for(wi.push(o,i,n,a);o.size>0;){let l=o.pop();n=l.v,i[n]=2,a=l.i;let u=e.outEdges[n];for(;a<u.length;a++){let c=u[a];if(c.source===c.target)continue;let h=i[c.target];h===1?t.set(c.source,c.target,c):h===0&&(wi.push(o,i,n,a+1),n=c.target,i[c.target]=2,u=e.outEdges[n],a=-1)}}}return Array.from(t.values())}};var fv=Ae(kn(),1);function pc(s){let e=new nr;return e.SetEdges(s,nr.vertexCount(s)),e}function Gp(s){let e=new nr;return e.SetEdges(s,nr.vertexCount(s)),e}function yr(s,e){let t=new nr;return t.SetEdges(s,e),t}var nr=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let i=e.indexOf(t,0);i>-1&&e.splice(i,1)}removeEdge(e){nr.deleteFromArray(this.edges,e),e.source!==e.target?(nr.deleteFromArray(this.outEdges[e.source],e),nr.deleteFromArray(this.inEdges[e.target],e)):nr.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let i of e)i.source>=t&&(t=i.source),i.target>=t&&(t=i.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let i=new Array(this.nodeCount).fill(0),n=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!==a.target?(i[a.source]++,n[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(i[a]),i[a]=0,this.inEdges[a]=new Array(n[a]),n[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!==u?(this.outEdges[l][i[l]++]=a,this.inEdges[u][n[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!==e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length===0)return;let e=new Set,t=new fv.Queue,i=this.edges[0].source;for(nr.enqueue(e,t,i),yield i;t.length>0;){i=t.dequeue();for(let n of this.outEdges[i]){let o=n.target;e.has(o)||(nr.enqueue(e,t,o),yield o)}for(let n of this.inEdges[i]){let o=n.source;e.has(o)||(nr.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,i){t.enqueue(i),e.add(i)}};var Xi=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>T.distanceEpsilon?1:e<-T.distanceEpsilon?-1:0}};var He=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new He;for(let i of e)t.add(i);return t}addxy(e,t){let i=this.mapOfSets.get(e);i==null&&this.mapOfSets.set(e,i=new Set),i.has(t)||this.size_++,i.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let i=this.mapOfSets.get(e);return i!=null&&i.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let i of this)e(i,i,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new m(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function gs(s,e){let t=new Set;for(let i of s)e.has(i)||t.add(i);return t}function gv(s,e){let t=new He;for(let i of s)e.has(i)||t.add(i);return t}function Un(s,e){let t=new Set(s);for(let i of e)t.add(i);return t}function To(s,e){for(let t of e)s.push(t)}function zn(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}function pv(s){if(s.length===0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=zn(e,s[t]);return e}function Ol(s,e){for(let t of e)s.add(t)}function _l(s,e){if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function Io(s,e){let t=[];for(let i of s)for(let n of e(i))t.push(n);return t}function Nl(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function Ml(s,e,t){let i=s.get(e);i||(i=new Array,s.set(e,i)),i.push(t)}function Jy(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function mv(s,e,t){Jy(s,new pt(e[0],e[1]),t)}function UO(s,e,t){let i=s.get(e);i&&i.delete(t)}function $y(s,e,t){UO(s,new pt(e[0],e[1]),t)}var e0=Ae(mn(),1),yv=Ae(or(),1);var bv=Ae(or(),1);var ps=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,i,n){let o=new ps(e);return o.Left=e,o.Right=t,o.Gap=i,o.IsEquality=n,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return bv.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t===0&&(t=this.Right.CompareTo(e.Right)),t===0&&(t=Re(this.Gap,e.Gap)),t}};var Pv=Ae(or(),1),aa=class{static constructorDCVV(e,t,i,n){let o=new aa(t);return o.Set(e,t,i,n),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,i,n){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=i,this.VariableDoneEval=n,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval===this.ConstraintToEval.Right}toString(){return Pv.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var t0=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Bl=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return yv.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new e0.Stack;let t=new ps(e);this.dfDvDummyParentNode=new aa(t);let i=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(i);;){let n=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!n.ChildrenHaveBeenPushed){n.ChildrenHaveBeenPushed=!0;for(let a of n.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Right,n.VariableToEval);a.Right.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of n.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Left,n.VariableToEval);a.Left.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(n),n===i)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,i,n){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,i,n):aa.constructorDCVV(e,t,i,n);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable===e.VariableToEval){for(;e.Parent!==this.dfDvDummyParentNode;)this.constraintPath.push(new t0(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let i=new Array;this.GetConnectedVariables(i,e.Right,e.Left);let n=e.Violation,o=i.length;for(let a=0;a<o;a++)i[a].OffsetInBlock=i[a].OffsetInBlock+n;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let i=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,n=this.Variables.length;for(let o=0;o<n;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<i&&(t=a,i=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Bl(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length===1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,i=e.OffsetInBlock/e.Scale,n=t*e.Weight;this.sumAd+=n*e.DesiredPos,this.sumAb+=n*i,this.sumA2+=n*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let i=0;i<t;i++){let n=this.Variables[i];n.ActualPos=(e+n.OffsetInBlock)/n.Scale}}GetConnectedVariables(e,t,i){this.RecurseGetConnectedVariables(e,t,i)}RecurseGetConnectedVariables(e,t,i){this.allConstraints.DfDvStack=new e0.Stack;let n=new ps(t);for(this.dfDvDummyParentNode=new aa(n),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,n,t,i)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!==o.VariableDoneEval&&(l.Right.ActiveConstraintCount===1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!==o.VariableDoneEval&&(l.Left.ActiveConstraintCount===1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,i){this.GetConnectedVariables(e.Variables,t,i);let n=e.Variables.length;for(let a=0;a<n;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block===e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length===0){for(let a=0;a<n;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var kp=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var r0=Ae(mn(),1),Up=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new r0.Stack;this.DfDvRecycleStack=new r0.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var bc=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new bd}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new bc;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},bd=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new bd;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var i0=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},n0=class{constructor(e,t){this.Value=e,this.Column=t}},Yr=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!==0&&(this.newMatrixRow.push(new n0(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new i0(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let i of this.matrixQ[t.Ordinal])i.Column===t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(i.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let i=0;i<t.length;i++)t[i].Column===e?t[i].Value=1:t[i].Value=t[i].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[i].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;Yr.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=Yr.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!==0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=Yr.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t===0)return!1;let i=e/t;Yr.VectorCopy(this.vectorPrevY,this.vectorCurY),Yr.VectorScaledVectorSubtract(this.vectorPrevY,i,this.gradientVector,this.vectorCurY);for(let n=0;n<this.vectorCurY.length;n++)this.vectorQpscVars[n].Variable.DesiredPos=this.vectorCurY[n];return!0}PostProject(){for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;Yr.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=Yr.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!==0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let i=Yr.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=i===0?1:e/i,t>1?t=1:t<0&&(t=0)}return Yr.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let i=this.previousFunctionValue-e,n=0;if(i!==0){let o=this.previousFunctionValue!==0?this.previousFunctionValue:e;n=Math.abs(i/o)}(Math.abs(i)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(n)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return Yr.VectorVectorMultiply(this.gradientVector,e)/2+Yr.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let i=0;for(let n=0;n<e.length;n++)i=i+e[n]*t[n];return i}MatrixVectorMultiply(e,t){let i=0;for(let n of this.matrixQ){let o=0;for(let a of n)o=o+a.Value*e[a.Column];t[i++]=o}}static VectorVectorAdd(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]+t[n]}static VectorVectorSubtract(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]-t[n]}static VectorScaledVectorSubtract(e,t,i,n){for(let o=0;o<e.length;o++)n[o]=e[o]-t*i[o]}static VectorCopy(e,t){for(let i=0;i<t.length;i++)e[i]=t[i]}};var Dl=class{constructor(){this.NumberOfUnsatisfiableConstraints=0;this.OuterProjectIterations=0;this.InnerProjectIterationsTotal=0;this.MinInnerProjectIterations=0;this.MaxInnerProjectIterations=0;this.MaxConstraintTreeDepth=0;this.GoalFunctionValue=0;this.TimeLimitExceeded=!1;this.OuterProjectIterationsLimitExceeded=!1;this.InnerProjectIterationsLimitExceeded=!1}get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Dl;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var Sv=Ae(or(),1);var o0=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},zp=class{constructor(e,t,i,n,o){this.ActiveConstraintCount=0;if(n<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=i*n;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=i*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=i,this.Weight=n,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new o0(e,t))}toString(){return Sv.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return Re(this.Ordinal,e.Ordinal)}};var Wp=class{get IsFull(){return this.numConstraints===Wp.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(Wp.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let i=this.numConstraints-1;i>=0;i--){let n=this.constraints[i];if(n.Left.Block===e||n.Right.Block===e||n.IsActive||n.IsUnsatisfiable)i<this.numConstraints-1&&(this.constraints[i]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints===0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let i=0;i<this.numConstraints;i++){let n=this.constraints[i],o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o>e&&(e=o,t=n)}return t}Insert(e,t){let i=0,n=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<n?(o=n,i=a,n=u):u<o&&(o=u)}this.IsFull?(this.constraints[i]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=n))}},Pd=Wp;Pd.MaxConstraints=20;var Hp=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},jp=class{constructor(){this.allBlocks=new kp;this.allConstraints=new Up;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new Pd;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new bc;this.solverSolution=new Dl}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,i){return this.AddVariableANNN(e,t,i,1)}AddVariableANNN(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new zp(this.nextVariableOrdinal++,e,t,i,n),a=new Bl(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new Hp(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return Io(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let i=t.Constraints.length;for(let n=0;n<i;n++){let o=t.Constraints[n];if(e===o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!0)}AddConstraintVVNB(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e===t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=ps.constructorVVNB(e,t,i,n);return this.loadedVariablesAndConstraintLists.set(e,new Hp(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,n&&this.equalityConstraints.push(l),l}AddConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!1)}SetConstraintUpdate(e,t){t!==e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,i){if(i<=0||Number.isNaN(i)||!Number.isFinite(i))throw new Error("relationshipWeight");if(e===t)throw new Error;e.AddNeighbor(t,i),t.AddNeighbor(e,i),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.floor(Math.log2(this.numberOfVariables))+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.max(0,Math.floor(Math.log2(this.numberOfConstraints)))+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Dl,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints===0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length===0)return;let e=this.IsQpsc;for(let[t,i]of this.updatedConstraints){let n=t;if(n.UpdateGap(i),!e&&!n.IsEquality){this.SplitOnConstraintIfActive(n);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),i=t.Constraints,n=0,o=0,a=0;i!=null&&(n=i.length,o=t.NumberOfLeftConstraints,a=n-o);let l=this.emptyConstraintList;o!==0&&(l=new Array(o));let u=this.emptyConstraintList;a!==0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<n;d++){let f=i[d];e===f.Left?l[c++]=f:u[h++]=f}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){if(!this.RunProject())return;if(!this.SplitBlocks())break}}RunProject(){return this.solverSolution.OuterProjectIterations++,this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let i=this.allBlocks.item(t),n=i.Variables.length;for(let o=0;o<n;o++){let a=i.Variables[o];this.solverSolution.GoalFunctionValue+=a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue-=2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new Yr(this.solverParams,this.numberOfVariables);for(let i of this.allBlocks.Vector)for(let n of i.Variables)e.AddVariable(n);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1;for(;!(!e.PreProject()&&!t||(t=this.SplitBlocks(),!this.RunProject())||!e.PostProject()&&!t););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){return this.RunProject()}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let i of t.Variables){i.Reinitialize();let n=new Bl(i,this.allConstraints);this.allBlocks.Add(n)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block===e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints===0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,i={maxViolation:0},n=this.GetMaxViolatedConstraint(i,e);if(!n)return!1;for(;n;){if(n.Left.Block===n.Right.Block?(n.Left.Block.Expand(n),n.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=n.Left.Block):this.lastModifiedBlock=this.MergeBlocks(n),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};n=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,i=e.Right.Block,n=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);i.Variables.length>t.Variables.length&&(t=e.Right.Block,i=e.Left.Block,n=-n);let o=i.Variables.length;for(let a=0;a<o;a++){let l=i.Variables[a];l.OffsetInBlock+=n,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(i),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let n=0;n<t;n++){let a=this.allBlocks.item(n).Split(this.IsQpsc);a!=null&&e.push(a)}let i=e.length;for(let n=0;n<i;n++){let o=e[n];this.allBlocks.Add(o)}return e.length!==0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let i=this.SearchViolationCache(e.maxViolation);return i!=null?i:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let i=this.lastModifiedBlock.Variables.length;for(let o=0;o<i;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Ip(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!==this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Ip(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let n=this.violationCache.FindIfGreater(e);return n!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=n),t}SearchAllConstraints(e,t){let i=null;this.violationCache.Clear();for(let n of this.allConstraints.Vector){if(n.IsActive)break;if(n.IsUnsatisfiable)continue;let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale),a=null,l=0;Ip(o,e)&&(e>this.violationCache.LowViolation&&(a=i,l=e),e=o,i=n),t&&(a==null&&n!==i&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=n,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return i}};var qp=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,i){this.variables.set(e,this.solver.AddVariableANN(e,t,i))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,i,n){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,i,n)}AddLeftRightSeparationConstraintNNN(e,t,i){this.AddLeftRightSeparationConstraintNNNB(e,t,i,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,i){let n=this.GetVariable(e);if(n==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(n,o,i)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let i;do{this.solution=null;let n=null;if(e!=null&&(n=e,n==null))throw new Error("parameters");this.solution=this.solver.SolvePar(n),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,i=this.AdjustConstraintsForMovedFixedVars()}while(i&&this.solution.ExecutionLimitExceeded===!1);return this.solution.ExecutionLimitExceeded===!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,i]of this.fixedVars.entries())qp.Close(i,this.GetVariableResolvedPosition(t))||e.add(t);return e.size===0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let i of e){t=i;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let i={successInAdjusting:!1},n=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,i);if(!i.successInAdjusting||n.length===0)return!1;for(let o of n)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let i=this.variables.get(e).Block.Variables,n=new Xi,o=new Xi,a=1;for(let l of i)!this.fixedVars.has(l.UserData)||(n.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,n.length/o.length)));return a===1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(i,a),i.map(l=>l.UserData)}FixActiveConstraints(e,t){let i=!1;for(let n of e)for(let o of n.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(i=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return i}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new jp,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,qp.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},yd=qp;yd.FixedVarWeight=1e9;var Xp=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var Yp=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new yd;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let i=this.Var(t);i.LowBound=Math.max(e,i.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let i=this.Var(e);i.UpperBound=Math.min(t,i.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!==Number.NEGATIVE_INFINITY&&this.constraints.add(new ye(this.GetBoundId(t.LowBound),e)),t.UpperBound!==Number.POSITIVE_INFINITY&&this.constraints.add(new ye(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!==Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!==Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=yr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=wi.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new ye(e,t))}AddVariableNNNN(e,t,i,n){this.idealPositions.set(e,i),this.AddVariableNNBN(e,t,!1,n)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,i,n){let o=new Xp;o.Position=t,o.IsFixed=i,o.Width=n,this.varList.push(o)}};var la=class{clone(){let e=new la;return e.transparency=this.transparency,e.width=this.width,e.color=this.color,e.icurve=this.icurve.clone(),e.label=this.label,e.dashArray=this.dashArray,e.drawPN=this.drawPN,e}static mkDebugCurveTWCILD(e,t,i,n,o,a,l=!1){let u=new la;return u.transparency=e,u.width=t,u.color=i,u.icurve=n,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,i,n){return la.mkDebugCurveTWCILD(e,t,i,n,null,null)}static mkDebugCurveWCI(e,t,i){return la.mkDebugCurveTWCI(255,e,t,i)}static mkDebugCurveCI(e,t){return la.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return la.mkDebugCurveCI("Black",e)}},pe=la;pe.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var xv=Ae(kn(),1);var bt=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,i){let n=this.mapOfMaps.get(e);n==null&&this.mapOfMaps.set(e,n=new Map),n.has(t)||this.size_++,n.set(t,i)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let i=this.mapOfMaps.get(e);return i!=null?(i.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let i=this.mapOfMaps.get(e);return i!=null&&i.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let i=this.mapOfMaps.get(e);if(i!=null)return i.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new m(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new m(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var Ev=Ae(or(),1),Pc=class{constructor(e,t,i=1){this.LengthMultiplier=1;this.Source=e,this.Target=t,this.Weight=i}static closeuv(e,t){return m.closeDistEps(e.point,Pc.u,.1)&&m.closeDistEps(t.point,Pc.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return Ev.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new Pc(this.Target,this.Source)}Clone(){return new Pc(this.Source,this.Target)}},pi=Pc;pi.u=new m(545.833,840.458),pi.v=new m(606.1667261889578,786.2917261889578),pi.DefaultWeight=1;var yc=class{constructor(e,t,i,n,o){this.color=e,t!==void 0&&(this.item=t),i!==void 0&&(this.parent=i),n!==void 0&&(this.left=n),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var ct=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new yc(1)}clear(){this.root=this.nil=new yc(1)}toNull(e){return e!==this.nil?e:null}isEmpty(){return this.root===this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let i;for(;t!==this.nil&&(i=this.comparer(e,t.item))!==0;)t=i<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).left:t.right;return i}findLast(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).right:t.left;return i}treeMinimum(e=this.root){for(;e.left!==this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!==this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!==this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!==this.nil&&e===t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!==this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!==this.nil&&e===t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!==this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!==this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!==this.root&&e.color===1;)if(e===e.parent.left){let t=e.parent.right;t.color===0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color===1&&t.right.color===1?(t.color=0,e=e.parent):(t.right.color===1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color===0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color===1&&t.left.color===1?(t.color=0,e=e.parent):(t.left.color===1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left===this.nil||e.right===this.nil)t=e;else for(t=e.right;t.left!==this.nil;)t=t.left;let i=t.left!==this.nil?t.left:t.right;return i.parent=t.parent,t.parent===this.nil?this.root=i:t===t.parent.left?t.parent.left=i:t.parent.right=i,t!==e&&(e.item=t.item),t.color===1&&this.deleteFixup(i),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,i=this.root,n=0;for(;i!==this.nil;)t=i,n=this.comparer(e,i.item),i=n<0?i.left:i.right;let o=new yc(1,e,t,this.nil,this.nil);return t===this.nil?this.root=o:n<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!==this.root&&e.parent.color===0;)if(e.parent===e.parent.parent.left){let t=e.parent.parent.right;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let i of this.allNodes())e+=i.toString(),t!==this.count-1&&(e+=`
`),t++;return e+"}"}};var wo=class{constructor(e){this._inEdges=new Array;this._outEdges=new ct((t,i)=>this.Compare(t,i)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t===-1)return;let i=this._inEdges.length-1;t!==i&&(this._inEdges[t]=this._inEdges[i]),this._inEdges.pop()}static FindFirst(e,t){return wo.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,i){if(e===t.nil)return null;let n=null;for(;e!==t.nil;)e=e.item.TargetPoint.compareTo(i)>=0?(n=e).left:e.right;return n}get(e){let t=wo.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target===e||(t=wo.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target===this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var Ye=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new wo(e);this.pointToVertexMap=new bt}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source===e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!==e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let i=t.startPoint;;i=i.next){let n=m.getTriangleOrientation(i.point,i.next.point,i.next.next.point);if(n!==2){yield n===0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let i=this.VertexFactory(e);return this.pointToVertexMap.set(e,i),i}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let i;if(i=e.get(t))return i;if(e===t)throw new Error("Self-edges are not allowed");let n=new pi(e,t);return e.OutEdges.insert(n),t.InEdges.push(n),n}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,i){let n=this.FindVertex(e),o=null;if(n!=null&&(o=this.FindVertex(t),o!=null)){let l=n.get(o);if(l)return l}n==null?(n=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=i(n,o);return n.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(i,n)=>new pi(i,n))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let i=this.FindVertex(e);if(i==null)return null;let n=this.FindVertex(t);return n==null?null:i.get(n)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var Kp=class extends pi{constructor(t,i){super(t,i);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=Y.DirectionFromPointToPoint(t.point,i.point)}AddRightNeighbor(t){this.RightNeighbors.add(t)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(t){this.setOfLongestSegs.add(t)}BoundFromRight(t){t=Math.max(t,this.LeftBound),this.RightBound=Math.min(t,this.RightBound)}BoundFromLeft(t){t=Math.min(t,this.RightBound),this.LeftBound=Math.max(t,this.LeftBound)}};var mi=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,i){for(t--;e<t;t--)this.SetNewNext(i[t])}InsertVertsInReverse(e,t,i){for(e++;e<t;e++)this.SetNewNext(i[e])}SetNewNext(e){let t=new mi(e),i=this.Next;this.Next=t,t.Next=i}};var Fl=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return le(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return Fl.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?Y.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var Kr=class{constructor(e){this.pathVisibilityGraph=new Ye;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(n(),e.Width),i=t.next();for(i.done||e.SetFirstEdge(i.value);(i=t.next()).done===!1;)e.AddEdge(i.value);function*n(){if(e.PathPoints instanceof mi)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let i=e.next(),n=i.value;for(;!(i=e.next()).done;)yield this.CreatePathEdge(n,i.value,t),n=i.value}CreatePathEdge(e,t,i){switch(Y.DirectionFromPointToPoint(e,t)){case 2:case 1:return new Fl(this.GetAxisEdge(e,t),i);case 4:case 8:{let o=new Fl(this.GetAxisEdge(t,e),i);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(i,n)=>new Kp(i,n))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of Kr.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(Kr.CompareTwoPathEdges);let i=0;for(let n of t)n.Index=i++}static CompareTwoPathEdges(e,t){if(e===t)return 0;let i=Kr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return i!==0?i:-Kr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,Y.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,i,n){for(;;){if(e=Kr.GetNextPathEdgeInDirection(e,i,n),e==null||(t=Kr.GetNextPathEdgeInDirection(t,i,n),t==null))return 0;if(e.AxisEdge===t.AxisEdge){n=Kr.FindContinuedDirection(i,n,e.AxisEdge),i=e.AxisEdge;let c=Kr.GetExistingOrder(e,t);if(c===Kr.NotOrdered)continue;return n===i.Direction?c:-c}let o=n===i.Direction?i.Target:i.Source,a=Kr.OtherVertex(e.AxisEdge,o),l=Kr.OtherVertex(t.AxisEdge,o),u=Kr.ProjectionForCompare(i,n!==i.Direction);return Re(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,i){return e.Direction===t?i.Source===e.Target?i.Direction:Y.OppositeDir(i.Direction):i.Source===e.Source?i.Direction:Y.OppositeDir(i.Direction)}static OtherVertex(e,t){return e.Source===t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction===1?t?i=>-i.x:i=>i.x:t?i=>i.y:i=>-i.y}static GetNextPathEdgeInDirection(e,t,i){return t.Direction===i?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let i=e.Index;if(i===-1)return Kr.NotOrdered;let n=t.Index;return Re(i,n)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,i){for(let n of i.Vertices()){let o=n.InEdgesLength();t.set(n,o),o===0&&e.enqueue(n)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new xv.Queue,i=new Map;for(Kr.InitQueueOfSources(t,i,e);t.length>0;){let n=t.dequeue();for(let o of n.OutEdges){let a=i.get(o.Target);i.set(o.Target,a-1),a===1&&t.enqueue(o.Target),yield o}}}},Sd=Kr;Sd.NotOrdered=Number.MAX_VALUE;var ua=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var ca=class extends ua{constructor(t){super();this.Init(t)}Init(t){this.StartVertex=t}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var Lo=class extends ca{constructor(t){super(t);this.end=t.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var Jt=class{};var Li=class extends Jt{constructor(t){super();this.Vertex=t}get Site(){return this.Vertex.point}get Polyline(){return this.Vertex.polyline}};var Wn=class extends Li{constructor(e){super(e)}};var Ro=class extends ca{constructor(t){super(t);this.end=t.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var Hn=class extends Li{constructor(e){super(e)}};var ha=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let i=t>>1,n,o;for(;t>1&&this.Less(n=this.A[t],o=this.A[i]);)this.A[i]=n,this.A[t]=o,t=i,i=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,i=2,n=!1;for(;i<this.heapSize&&!n;){n=!0;let o=this.A[i],a=this.A[i+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e,n=!1,t=i,i=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[i+1]=e,n=!1,t=i+1,i=t<<1)}if(i===this.heapSize){let o=this.A[i];this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Zp=class extends Li{constructor(e){super(e)}};var Qp=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(m.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),i=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}};var Jp=class extends Jt{constructor(t){super();this.site=t}get Site(){return this.site}};var Sc=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new ha((i,n)=>this.Compare(i,n)),this.ObstacleSideComparer=new Qp(this),this.LeftObstacleSideTree=new ct((i,n)=>this.ObstacleSideComparer.Compare(i,n)),this.RightObstacleSideTree=new ct((i,n)=>this.ObstacleSideComparer.Compare(i,n))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+T.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>T.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(i=>m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(i=>!m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new Jp(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new Zp(t))}GetLowestPoint(e){let t=e.startPoint,i=e.startPoint.next;for(;i!=null;i=i.next)this.Less(i.point,t.point)&&(t=i);return t}Compare(e,t){let i=e.Site,n=t.Site;return this.ComparePoints(i,n)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let i=this.SweepDirection.dot(e),n=this.SweepDirection.dot(t);return i<n?-1:i>n?1:(i=this.directionPerp.dot(e),n=this.directionPerp.dot(t),i<n?-1:i>n?1:0)}};var $p=class extends Jt{constructor(t,i){super();this.site=i,this.AxisEdge=t}get Site(){return this.site}};var Ed=class extends Jt{constructor(t,i){super();this.site=i,this.AxisEdge=t}get Site(){return this.site}};var em=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size===0}};var da=class extends Sc{constructor(t,i,n,o,a){super(i,new Y(t).ToPoint());this.DirectionPerp=new Y(t).Right.ToPoint(),this.PathOrders=o,this.xProjection=t===1?l=>l.x:l=>-l.y,this.edgeContainersTree=new ct((l,u)=>this.CompareAA(l,u)),this.SweepPole=Y.VectorDirection(this.SweepDirection),this.AxisEdges=a,this.AxisEdgesToObstaclesTheyOriginatedFrom=n}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(t){t instanceof Li?this.ProcessVertexEvent(t):(this.Z=this.GetZP(t.Site),t instanceof Ed?this.ProcessLowEdgeEvent(t):this.ProcessHighEdgeEvent(t))}ProcessHighEdgeEvent(t){let i=t.AxisEdge;this.RemoveEdge(i),this.ConstraintEdgeWithObstaclesAtZ(i,i.Target.point)}ProcessLowEdgeEvent(t){let i=t.AxisEdge,n=this.GetOrCreateAxisEdgesContainer(i);n.item.AddEdge(i);let o=this.edgeContainersTree.previous(n);if(o!=null)for(let l of o.item.edges)for(let u of n.item.edges)this.TryToAddRightNeighbor(l,u);let a=this.edgeContainersTree.next(n);if(a!=null)for(let l of n.item.Edges)for(let u of a.item.edges)this.TryToAddRightNeighbor(l,u);this.ConstraintEdgeWithObstaclesAtZ(i,i.Source.point)}TryToAddRightNeighbor(t,i){this.ProjectionsOfEdgesOverlap(t,i)&&t.AddRightNeighbor(i)}ProjectionsOfEdgesOverlap(t,i){return this.SweepPole===1?!(t.TargetPoint.y<i.SourcePoint.y-T.distanceEpsilon||i.TargetPoint.y<t.SourcePoint.y-T.distanceEpsilon):!(t.TargetPoint.x<i.SourcePoint.x-T.distanceEpsilon||i.TargetPoint.x<t.SourcePoint.x-T.distanceEpsilon)}GetObstacleBoundaries(t){return this.Obstacles.map(i=>pe.mkDebugCurveWCI(1,t,i))}ConstraintEdgeWithObstaclesAtZ(t,i){this.ConstraintEdgeWithObstaclesAtZFromLeft(t,i),this.ConstraintEdgeWithObstaclesAtZFromRight(t,i)}ConstraintEdgeWithObstaclesAtZFromRight(t,i){let n=this.GetActiveSideFromRight(i);if(n==null||this.NotRestricting(t,n.item.Polyline))return;let o=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);t.BoundFromRight(o.dot(this.DirectionPerp))}GetActiveSideFromRight(t){return this.LeftObstacleSideTree.findFirst(i=>da.PointToTheLeftOfLineOrOnLineLocal(t,i.Start,i.End))}ConstraintEdgeWithObstaclesAtZFromLeft(t,i){let n=this.GetActiveSideFromLeft(i);if(n==null||this.NotRestricting(t,n.item.Polyline))return;let o=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);t.BoundFromLeft(o.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(t,i,n){return m.signedDoubledTriangleArea(t,i,n)>-da.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(t,i,n){return m.signedDoubledTriangleArea(i,n,t)<da.AreaComparisonEpsilon}GetActiveSideFromLeft(t){return this.RightObstacleSideTree.findLast(i=>da.PointToTheRightOfLineOrOnLineLocal(t,i.Start,i.End))}static EdgeMidPoint(t){return m.middle(t.SourcePoint,t.TargetPoint)}GetOrCreateAxisEdgesContainer(t){let i=t.Source.point,n=this.GetAxisEdgesContainerNode(i);return n!=null?n:this.edgeContainersTree.insert(new em(i))}GetAxisEdgesContainerNode(t){let i=this.xProjection(t),n=this.edgeContainersTree.findFirst(o=>this.xProjection(o.Source)>=i-T.distanceEpsilon/2);return n!=null&&this.xProjection(n.item.Source)<=i+T.distanceEpsilon/2?n:null}ProcessVertexEvent(t){this.Z=this.GetZS(t),t instanceof Wn?this.ProcessLeftVertex(t,t.Vertex.nextOnPolyline):t instanceof Hn?this.ProcessRightVertex(t,t.Vertex.prevOnPolyline):(this.ProcessLeftVertex(t,t.Vertex.nextOnPolyline),this.ProcessRightVertex(t,t.Vertex.prevOnPolyline))}ProcessRightVertex(t,i){let n=t.Site;this.ProcessPrevSegmentForRightVertex(t,n);let o=i.point.sub(t.Site),a=o.dot(this.DirectionPerp),l=o.dot(this.SweepDirection);l<=T.distanceEpsilon?a>0&&l>=0?this.EnqueueEvent(new Hn(i)):this.RestrictEdgeContainerToTheRightOfEvent(t.Vertex):(this.InsertRightSide(new Ro(t.Vertex)),this.EnqueueEvent(new Hn(i)),this.RestrictEdgeContainerToTheRightOfEvent(t.Vertex))}RestrictEdgeContainerToTheRightOfEvent(t){let i=t.point,n=this.xProjection(i),o=this.edgeContainersTree.findFirst(a=>n<=this.xProjection(a.Source));if(o!=null)for(let a of o.item.Edges)this.NotRestricting(a,t.polyline)||a.BoundFromLeft(this.DirectionPerp.dot(i))}NotRestricting(t,i){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(t)===i}ProcessPrevSegmentForRightVertex(t,i){let n=t.Vertex.nextOnPolyline.point;i.sub(n).dot(this.SweepDirection)>T.distanceEpsilon&&this.RemoveRightSide(new Ro(t.Vertex.nextOnPolyline))}RemoveEdge(t){let i=this.GetAxisEdgesContainerNode(t.Source.point);i.item.RemoveAxis(t),i.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(i)}ProcessLeftVertex(t,i){let n=t.Site;this.ProcessPrevSegmentForLeftVertex(t,n);let o=i.point.sub(t.Site),a=o.dot(this.DirectionPerp),l=o.dot(this.SweepDirection);l<=T.distanceEpsilon?a<0&&l>=0&&this.EnqueueEvent(new Wn(i)):(this.InsertLeftSide(new Lo(t.Vertex)),this.EnqueueEvent(new Wn(i))),this.RestrictEdgeFromTheLeftOfEvent(t.Vertex)}RestrictEdgeFromTheLeftOfEvent(t){let i=t.point,n=this.GetContainerNodeToTheLeftOfEvent(i);if(n!=null)for(let o of n.item.Edges)this.NotRestricting(o,t.polyline)||o.BoundFromRight(i.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(t){let i=this.xProjection(t);return this.edgeContainersTree.findLast(n=>this.xProjection(n.Source)<=i)}ProcessPrevSegmentForLeftVertex(t,i){let n=t.Vertex.prevOnPolyline.point;i.sub(n).dot(this.SweepDirection)>T.distanceEpsilon&&this.RemoveLeftSide(new Lo(t.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let t of this.AxisEdges)this.EnqueueEventsForEdge(t)}EnqueueEventsForEdge(t){this.EdgeIsParallelToSweepDir(t)&&(this.EnqueueEvent(da.EdgeLowPointEvent(t,t.Source.point)),this.EnqueueEvent(da.EdgeHighPointEvent(t,t.Target.point)))}EdgeIsParallelToSweepDir(t){return t.Direction===this.SweepPole||t.Direction===Y.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(t,i){return new $p(t,i)}static EdgeLowPointEvent(t,i){return new Ed(t,i)}CompareAA(t,i){return Re(t.Source.dot(this.DirectionPerp),i.Source.dot(this.DirectionPerp))}},xd=da;xd.AreaComparisonEpsilon=T.intersectionEpsilon;var tm=class extends ua{constructor(t){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=t}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(t){if(this.Edges.length===0){let i=Y.VectorDirectionPP(t.Source,t.Target);switch(i){case 4:i=1;break;case 8:i=2;break}this.CompassDirection=i,this.start=t.Source,this.end=t.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(t.Source),this.TryPointForStartAndEndNorth(t.Target);break;case 2:this.TryPointForStartAndEndEast(t.Source),this.TryPointForStartAndEndEast(t.Target);break}this.Edges.push(t)}TryPointForStartAndEndNorth(t){t.y<this.start.y?this.start=t:t.y>this.end.y&&(this.end=t)}TryPointForStartAndEndEast(t){t.x<this.start.x?this.start=t:t.x>this.end.x&&(this.end=t)}get IsFixed(){return this._isFixed}set IsFixed(t){this._isFixed=t}get Width(){let t=0;for(let i of this.edges)t=Math.max(t,i.Width);return t}GetLeftBound(){if(!this.IsFixed){let t=Number.NEGATIVE_INFINITY;for(let i of this.edges)t=Math.max(t,i.AxisEdge.LeftBound);return t}return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let t=Number.POSITIVE_INFINITY;for(let i of this.edges)t=Math.min(t,i.AxisEdge.RightBound);return t}return this.Position()}Position(){return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var vv=Ae(or(),1);var rm=class{constructor(e,t,i){this.indexToA=e,this.priority=t,this.v=i}};var Sr=class{constructor(e=Re){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let i=++this.heapSize,n=new rm(i,t,e);for(this.cache.set(e,n),this.A[i]=n;i>1&&this.compare(this.A[i>>1].priority,t)>0;)this.SwapWithParent(i),i>>=1}IsEmpty(){return this.heapSize===0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this.compare(this.A[n].priority,this.A[t].priority)<0&&(i=n);let o=n+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[i].priority)<0&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}this.heapSize--}DecreasePriority(e,t){let i=this.cache.get(e);if(!i)return;i.priority=t;let n=i.indexToA;for(;n>1&&this.compare(this.A[n].priority,this.A[n>>1].priority)<0;){this.SwapWithParent(n);n>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count===0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new vv.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var Yi=class{constructor(e,t){this.tree=new ct((e,t)=>Re(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length===0||this.HorizontalPoints.length===0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){le(e.Next.Point.x,e.Point.x)?t===Yi.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,i,n,o=e.Y;if(e.Point.x<e.Next.Point.x?(i=e.Point.x,t=e.Next.Point.x,n=!0):(t=e.Point.x,i=e.Next.Point.x,n=!1),n)for(let a=this.tree.findFirst(l=>i<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new m(a.item.Point.x,o);e=Yi.TrySplitHorizontalPoint(e,l,!0),Yi.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=i;a=this.tree.previous(a)){let l=new m(a.item.Point.x,o);e=Yi.TrySplitHorizontalPoint(e,l,!1),Yi.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){Yi.Low(e)+T.distanceEpsilon<t.y&&t.y+T.distanceEpsilon<Yi.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,i){return i&&e.X+T.distanceEpsilon<t.x&&t.x+T.distanceEpsilon<e.Next.X||!i&&e.Next.X+T.distanceEpsilon<t.x&&t.x+T.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new Sr(Re);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,Yi.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var ms=class{constructor(e){this.verticesToPathOffsets=new bt;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,i=null;for(let n=e.PathPoints;n!=null;n=n.Next){let o=this.verticesToPathOffsets.get(n.Point);if(i!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,n),t.delete(a))}for(let[a,l]of i)o.has(a)||t.set(a,l)}i=o}}CollapseLoopingPath(e,t,i,n,o){let a=ms.FindLinkedPointInPath(n,t.Point),l=Array.from(ms.GetPointsInBetween(a,o));ms.Before(t,i)?(this.CleanDisappearedPiece(t,i,e),this.ReplacePiece(t,i,l,e)):(this.CleanDisappearedPiece(i,t,e),this.ReplacePiece(i,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let i=e.Next;i!==t;i=i.Next)yield i.Point}ReplacePiece(e,t,i,n){let o=e;for(let a of i){let l=new mi(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(n,o)}o.Next=t}CleanDisappearedPiece(e,t,i){for(let n of ms.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(n).delete(i)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e===t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let i=e.PathPoints;;i=i.Next)if(i.Point.equal(t))return i}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let i=this.verticesToPathOffsets.get(t.Point);i||this.verticesToPathOffsets.set(t.Point,i=new Map);let n=i.get(e);n?(this.CleanDisappearedPiece(n,t,e),n.Next=t.Next):i.set(e,t)}}};var im=class{constructor(e){this.projection=e}compare(e,t){return Re(this.projection(e),this.projection(t))}};var Ec;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has"),s.name="ReadonlyContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t}s.hasInstance=e})(Ec||(Ec={}));var vd;(function(s){s.has=Ec.has,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.name="Container";function e(t){return Ec.hasInstance(t)&&s.add in t&&s.delete in t}s.hasInstance=e})(vd||(vd={}));var bi;(function(s){s.has=Ec.has,s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.name="ReadonlyCollection";function e(t){return Ec.hasInstance(t)&&(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t}s.hasInstance=e})(bi||(bi={}));var Wt;(function(s){s.size=bi.size,s.has=bi.has,s.add=vd.add,s.delete=vd.delete,s.clear=Symbol.for("@esfx/collection-core!Collection.clear"),s.name="Collection";function e(t){return bi.hasInstance(t)&&vd.hasInstance(t)&&s.clear in t}s.hasInstance=e})(Wt||(Wt={}));var Gl;(function(s){s.size=bi.size,s.has=bi.has,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt"),s.name="ReadonlyIndexedCollection";function e(t){return bi.hasInstance(t)&&s.indexOf in t&&s.getAt in t}s.hasInstance=e})(Gl||(Gl={}));var nm;(function(s){s.size=bi.size,s.has=bi.has,s.indexOf=Gl.indexOf,s.getAt=Gl.getAt,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt"),s.name="FixedSizeIndexedCollection";function e(t){return Gl.hasInstance(t)&&s.setAt in t}s.hasInstance=e})(nm||(nm={}));var Cv;(function(s){s.size=bi.size,s.has=bi.has,s.indexOf=Gl.indexOf,s.getAt=Gl.getAt,s.setAt=nm.setAt,s.add=Wt.add,s.delete=Wt.delete,s.clear=Wt.clear,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt"),s.name="IndexedCollection";function e(t){return nm.hasInstance(t)&&s.insertAt in t&&s.removeAt in t}s.hasInstance=e})(Cv||(Cv={}));var fa;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.get"),s.name="ReadonlyKeyedContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t&&s.get in t}s.hasInstance=e})(fa||(fa={}));var Cd;(function(s){s.has=fa.has,s.get=fa.get,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.name="KeyedContainer";function e(t){return fa.hasInstance(t)&&s.set in t&&s.delete in t}s.hasInstance=e})(Cd||(Cd={}));var Ri;(function(s){s.has=fa.has,s.get=fa.get,s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values"),s.name="ReadonlyKeyedCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&fa.hasInstance(t)&&s.size in t&&s.keys in t&&s.values in t}s.hasInstance=e})(Ri||(Ri={}));var Pi;(function(s){s.size=Ri.size,s.has=Ri.has,s.get=Ri.get,s.keys=Ri.keys,s.values=Ri.values,s.set=Cd.set,s.delete=Cd.delete,s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear"),s.name="KeyedCollection";function e(t){return Ri.hasInstance(t)&&Cd.hasInstance(t)&&s.clear in t}s.hasInstance=e})(Pi||(Pi={}));var Zr;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values"),s.name="ReadonlyKeyedMultiCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t&&s.has in t&&s.hasValue in t&&s.get in t&&s.keys in t&&s.values in t}s.hasInstance=e})(Zr||(Zr={}));var Vl;(function(s){s.size=Zr.size,s.has=Zr.has,s.hasValue=Zr.hasValue,s.get=Zr.get,s.keys=Zr.keys,s.values=Zr.values,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear"),s.name="KeyedMultiCollection";function e(t){return Zr.hasInstance(t)&&s.add in t&&s.delete in t&&s.deleteValue in t&&s.clear in t}s.hasInstance=e})(Vl||(Vl={}));function Av(s,e,t,i){if(e%4)throw new TypeError("Pointer not aligned");let n=new Uint32Array(s),o,a,l,u,c,h,d;if(a=e+t,e>>=2,t>=16){l=a-16>>2,u=(i+2654435761|0)+2246822519|0,c=i+2246822519|0,h=i+0|0,d=i+2654435761|0;do u=u+n[e++]*2246822519|0|0,u=(u<<13|u>>>19)*2654435761|0,c=c+n[e++]*2246822519|0|0,c=(c<<13|c>>>19)*2654435761|0,h=h+n[e++]*2246822519|0|0,h=(h<<13|h>>>19)*2654435761|0,d=d+n[e++]*2246822519|0|0,d=(d<<13|d>>>19)*2654435761|0;while(e<=l);o=(u<<1|u>>>31)+(c<<7|c>>>25)|(h<<12|h>>>20)|(d<<18|d>>>14)}else o=i+374761393|0;for(o=o+t|0,l=a-4>>2;e<=l;)o=o+n[e++]*3266489917|0|0,o=(o<<17|o>>>15)*668265263|0;if(e=e<<2,e<a){let f=new Uint8Array(n.buffer);do o=o+f[e++]*374761393|0|0,o=(o<<11|o>>>21)*2654435761|0;while(e<a)}return o=(o^o>>>15)*2246822519|0,o=(o^o>>>13)*3266489917|0,o=o^o>>>16,o>>>0}var HO=typeof WebAssembly<"u"&&typeof WebAssembly.Module=="function"&&typeof WebAssembly.Instance=="function",jO=new Uint8Array([0,97,115,109,1,0,0,0,1,8,1,96,3,127,127,126,1,126,3,2,1,0,5,3,1,0,1,7,15,2,3,109,101,109,2,0,5,120,120,104,54,52,0,0,10,130,6,1,255,5,2,3,126,1,127,32,0,32,1,106,33,6,32,1,65,32,79,4,126,32,6,65,32,107,33,6,32,2,66,214,235,130,238,234,253,137,245,224,0,124,33,3,32,2,66,177,169,172,193,173,184,212,166,61,125,33,4,32,2,66,249,234,208,208,231,201,161,228,225,0,124,33,5,3,64,32,3,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,3,32,4,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,2,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,5,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,6,32,0,65,8,106,34,0,79,13,0,11,32,2,66,12,137,32,5,66,18,137,124,32,4,66,7,137,124,32,3,66,1,137,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,2,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,33,2,32,0,32,1,65,31,113,106,33,1,3,64,32,1,32,0,65,8,106,79,4,64,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,32,2,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,33,2,32,0,65,8,106,33,0,12,1,11,11,32,0,65,4,106,32,1,77,4,64,32,2,32,0,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,2,32,0,65,4,106,33,0,11,3,64,32,0,32,1,73,4,64,32,2,32,0,49,0,0,66,197,207,217,178,241,229,186,234,39,126,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,0,65,1,106,33,0,12,1,11,11,32,2,32,2,66,33,136,133,66,207,214,211,190,210,199,171,217,66,126,34,2,66,29,136,32,2,133,66,249,243,221,241,153,246,153,171,22,126,34,2,66,32,136,32,2,133,11]),kl=HO?new WebAssembly.Instance(new WebAssembly.Module(jO)).exports:void 0;var Ul=kl===null||kl===void 0?void 0:kl.mem,s0=kl===null||kl===void 0?void 0:kl.xxh64;var YO=typeof TextEncoder=="function",Tv=(s,e)=>(Tv=KO())(s,e),a0=(s,e)=>Tv(s,e);function KO(){function s(){let t=new TextEncoder;function i(n,o){let{written:a=0}=t.encodeInto(n,o);return a}return i}function e(){function t(i,n){let o=i.length,a=0;for(let l=0;l<o;l++){let u=i.charCodeAt(l);if((u&55296)!==0&&(u&4294910976)===0&&l<o-1){let c=i.charCodeAt(l+1);(c&64512)===56320&&(u=((u&1023)<<10)+(c&1023)+65536,l++)}if((u&4294967168)===0)n[a++]=u;else if((u&4294965248)===0)n[a++]=u>>6|192,n[a++]=u&63|128;else if((u&268431360)===0)n[a++]=u>>12|224,n[a++]=u>>6&63|128,n[a++]=u&63|128;else if((u&4292870144)===0)n[a++]=u>>18|240,n[a++]=u>>12&63|128,n[a++]=u>>6&63|128,n[a++]=u&63|128;else throw new RangeError("Unsupported charCode.")}return a}return t}return YO?s():e()}var l0=typeof BigInt=="function"&&typeof BigInt(0)=="bigint",Iv=typeof BigUint64Array=="function",QO=typeof Ul=="object"&&typeof s0=="function",u0=new ArrayBuffer(8),JO=new Float64Array(u0),bs=new Uint32Array(u0),vc=()=>(vc=$O())(),wv=s=>(wv=e2())(s),Lv=s=>(Lv=t2())(s),Rv=s=>(Rv=vc())(s),Ov=s=>(Ov=r2())(s),_v=s=>(_v=i2())(s),Nv=s=>wv(s),Mv=s=>Lv(s),Bv=s=>Rv(s),Dv=s=>Ov(s),c0=s=>_v(s);function $O(){function s(){let t=new BigUint64Array(bs.buffer),i=new Uint8Array(Ul.buffer);function n(c){Ul.buffer.byteLength<c&&(Ul.grow(Math.ceil((c-Ul.buffer.byteLength)/65536)),i=new Uint8Array(Ul.buffer))}function o(c){t[0]=c;let h=bs[0],d=bs[1];return(h<<7|h>>>25)^d}function a(){return bs[0]=om(),bs[1]=om(),t[0]}function l(c,h){n(c.length*3);let d=a0(c,i);return o(s0(0,d,h))}function u(){let c=a();function h(d){return l(d,c)}return h}return u}function e(){let t=new Uint8Array(65536);function i(a){t.byteLength<a&&(t=new Uint8Array(a+(65536-a%65536)))}function n(a,l){i(a.length*3);let u=a0(a,t);return Av(t.buffer,0,u,l)>>0}function o(){let a=om();function l(u){return n(u,a)}return l}return o}return l0&&Iv&&QO?s():e()}function e2(){function s(t){JO[0]=t;let i=bs[0],n=bs[1];return(i<<7|i>>>25)^n|0}function e(t){return t>>0===t?t|0:s(t)}return e}function t2(){function s(){let i=new BigUint64Array(u0),n=BigInt(0),o=BigInt(1),a=BigInt(2),l=BigInt(2)**BigInt(31)-BigInt(1),u=~l,c=BigInt(64);function h(d){if(d===n)return 0;if(d>=u&&d<=l)return Number(d);d=d<n?~d*a+o:d*a;let f=0;for(;d;)i[0]=d,f=(f<<7|f>>>25)^bs[0],f=(f<<7|f>>>25)^bs[1],d=d>>c;return f|0}return h}function e(){let i=BigInt(0),n=BigInt(1),o=BigInt(2),a=BigInt(2)**BigInt(31)-BigInt(1),l=~a,u=BigInt(32),c=BigInt("0xFFFFFFFF");function h(d){if(d===i)return 0;if(d>=l&&d<=a)return Number(d);d=d<i?~d*o+n:d*o;let f=0;for(;d!==i;)f=(f<<7|f>>>25)^Number(d&c),d>>=u,f=(f<<7|f>>>25)^Number(d&c),d>>=u;return f|0}return h}function t(){let i=vc();function n(o){return i(o.toString())}return n}return l0&&Iv?s():l0?e():t()}function r2(){let s="description"in Symbol.prototype?p=>p.description:p=>{let S=p.toString();return S.length>=8&&S.slice(0,7)==="Symbol("&&S.slice(-1)===")"?S.slice(7,-1):S},e=vc(),t,i;try{new WeakMap().set(Symbol.iterator,null),t=new WeakMap,i=new WeakMap}catch{t=new Map,i=new Map}for(let p of Object.getOwnPropertyNames(Symbol))if(typeof p=="string"){let S=Symbol[p];typeof S=="symbol"&&i.set(S,`Symbol.${p}`)}let n=vc(),o;try{new WeakMap().set(Symbol.for("@esfx/equatable!~globalSymbolTest"),null),o=new WeakMap}catch{o=new Map}let a=vc(),l,u=1;try{new WeakMap().set(Symbol(),null),l=new WeakMap}catch{l=new Map}function c(p,S){let x=o.get(p);return x===void 0&&(x=n(S),o.set(p,x)),x}function h(p,S){let x=t.get(p);return x===void 0&&(x=e(S),t.set(p,x)),x}function d(p){let S=l.get(p);return S===void 0&&(S=a(`${u++}#${s(p)}`),l.set(p,S)),S}function f(p){let S=i.get(p);if(S!==void 0)return h(p,S);let x=Symbol.keyFor(p);return x!==void 0?c(p,x):d(p)}return f}function i2(){let s=new WeakMap,e=om(),t=1;function i(o){return o=~o+(o<<15),o=o^o>>12,o=o+(o<<2),o=o^o>>4,o=o*2057,o=o^o>>16,o>>>0}function n(o){let a=s.get(o);return a===void 0&&(a=i(t++^e)^e,s.set(o,a)),a}return n}function om(){return Math.floor(Math.random()*4294967295)>>>0}var sm=typeof globalThis=="object"?globalThis:typeof global=="object"?global:typeof self=="object"?self:void 0,h0=Symbol.for("@esfx/equatable!~hashUnknown"),am;sm&&typeof sm[h0]=="function"?am=sm[h0]:(am=function(e){switch(typeof e){case"boolean":return e?1:0;case"number":return Nv(e);case"bigint":return Mv(e);case"string":return Bv(e);case"symbol":return Dv(e);case"function":return c0(e);case"object":return e===null?0:c0(e);case"undefined":return 0;default:throw new TypeError(`Unsupported type: ${typeof e}`)}},Object.defineProperty(sm,h0,{value:am}));function Fv(s){return am(s)}var ga;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let i;return t!=null&&s.equals in(i=Object(t))&&s.hash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(ga||(ga={}));var Cc;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Cc||(Cc={}));var pa;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let i;return t!=null&&s.structuralEquals in(i=Object(t))&&s.structuralHash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(pa||(pa={}));var Ac;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Ac||(Ac={}));var _r;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>ga.hasInstance(o)?o[ga.equals](a):ga.hasInstance(a)?a[ga.equals](o):Object.is(o,a),o=>ga.hasInstance(o)?o[ga.hash]():o2(o)),s.structuralEqualer=t((o,a)=>pa.hasInstance(o)?o[pa.structuralEquals](a,s.structuralEqualer):pa.hasInstance(a)?a[pa.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>pa.hasInstance(o)?o[pa.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function i(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=i;function n(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(_r||(_r={}));var QH=_r.defaultEqualer,JH=_r.structuralEqualer,$H=_r.tupleEqualer,ej=_r.tupleEqualer,tj=_r.combineHashes,Pn;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((n,o)=>Cc.hasInstance(n)?n[Cc.compareTo](o):Cc.hasInstance(o)?-o[Cc.compareTo](n):n<o?-1:n>o?1:0),s.structuralComparer=t((n,o)=>Ac.hasInstance(n)?n[Ac.structuralCompareTo](o,s.structuralComparer):Ac.hasInstance(o)?-o[Ac.structuralCompareTo](n,s.structuralComparer):s.defaultComparer.compare(n,o)),s.tupleComparer=t((n,o)=>{if(n!=null&&!Array.isArray(n)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.defaultComparer.compare(n[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((n,o)=>{if(n!=null&&!Array.isArray(n)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.structuralComparer.compare(n[l],o[l]))return a;return 0});function t(n){return Object.setPrototypeOf({compare:n},e)}s.create=t;function i(n){return typeof n=="object"&&n!==null&&typeof n.compare=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(Pn||(Pn={}));var rj=Pn.defaultComparer,ij=Pn.structuralComparer,nj=Pn.tupleComparer,oj=Pn.tupleStructuralComparer;function o2(s){return Fv(s)}var Gv,lm=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function n(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=n}(s,s.exports,null),s.exports}(),Oo=class{constructor(...e){this._keys=[],this._values=[];let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=Pn.defaultComparer),this._comparer=typeof i=="function"?Pn.create(i):i,t)for(let[n,o]of t)this.set(n,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return(0,lm.binarySearch)(this._keys,e,this._comparer)>=0}get(e){let t=(0,lm.binarySearch)(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let i=(0,lm.binarySearch)(this._keys,e,this._comparer);return i>=0?this._values[i]=t:(this._keys.splice(~i,0,e),this._values.splice(~i,0,t)),this}delete(e){let t=(0,lm.binarySearch)(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[i,n]of this)e.call(t,n,i,this)}get[Pi.size](){return this.size}[Pi.has](e){return this.has(e)}[Pi.get](e){return this.get(e)}[Pi.set](e,t){this.set(e,t)}[Pi.delete](e){return this.delete(e)}[Pi.clear](){this.clear()}[Pi.keys](){return this.keys()}[Pi.values](){return this.values()}};Gv=Oo;Object.defineProperty(Gv.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedMap"});var sr=class{static RefinePaths(e,t){sr.AdjustPaths(e);let i=sr.CreatePathsToFirstLinkedVerticesMap(e);sr.Refine(Array.from(i.values())),sr.CrossVerticalAndHorizontalSegs(i.values()),sr.ReconstructPathsFromLinkedVertices(i),t&&new ms(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=sr.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length===0)return;let t=[],i=T.RoundPoint(e[0]);t.push(i);for(let n=1;n<e.length;n++){let o=T.RoundPoint(e[n]);i.equal(o)||(i=o,t.push(i))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,i=new Array;for(let n of e)for(let o=n;o.Next!=null;o=o.Next)le(o.Point.x,o.Next.Point.x)?i.push(o):t.push(o);new Yi(t,i).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,i]of e)t.PathPoints=i}static Refine(e){sr.RefineInDirection(1,e),sr.RefineInDirection(2,e)}static*groupByProj(e,t){let i=new Map;for(let n of t){let o=e(n.Point),a=i.get(o);a||(a=new Array,i.set(o,a)),a.push(n)}for(let n of i.values())yield n}static RefineInDirection(e,t){let i={projectionToPerp:void 0,projectionToDirection:void 0};sr.GetProjectionsDelegates(e,i);let n=Array.from(sr.GetAllLinkedVertsInDirection(i.projectionToPerp,t)),o=sr.groupByProj(i.projectionToPerp,n);for(let a of o)sr.RefineCollinearBucket(a,i.projectionToDirection)}static GetProjectionsDelegates(e,t){e===2?(t.projectionToDirection=i=>i.x,t.projectionToPerp=i=>i.y):(t.projectionToPerp=i=>i.x,t.projectionToDirection=i=>i.y)}static*GetAllLinkedVertsInDirection(e,t){for(let i of t)for(let n=i;n.Next!=null;n=n.Next)le(e(n.Point),e(n.Next.Point))&&(yield n)}static RefineCollinearBucket(e,t){let i=new Oo(new im(t));for(let a of e)i.has(a.Point)||i.set(a.Point,0),i.has(a.Next.Point)||i.set(a.Next.Point,0);let n=new Array(i.size),o=0;for(let a of i.keys())n[o++]=a;for(o=0;o<n.length;o++)i.set(n[o],o);for(let a of e){o=i.get(a.Point);let l=i.get(a.Next.Point);Math.abs(l-o)>1&&sr.InsertPoints(a,n,o,l)}}static InsertPoints(e,t,i,n){i<n?e.InsertVerts(i,n,t):e.InsertVertsInReverse(n,i,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let i of e)t.set(i,sr.CreateLinkedVertexOfEdgePath(i));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,i=new mi(t[0]),n=i;for(let o=1;o<t.length;o++)i.Next=new mi(t[o]),i=i.Next;return n}};var _o=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I===t.I&&e.Points===t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var No=class{constructor(e,t){this.segTree=new Co(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new Co(t),this.Paths=e}static RemoveStaircases(e,t){new No(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(i=>!this.crossedOutPaths.has(i)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new _o(e.pts,0),new _o(e.pts,1),new _o(e.pts,2),new _o(e.pts,3)],i=0;for(let n=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,n,t,o))return e.canHaveStaircase=!0,n;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,n++,e.pts.length<n+5)return-1;t[i]=new _o(e.pts,n+3),i++,i%=4}}static GetFlippedPoint(e,t){return le(e[t].y,e[t+1].y)?new m(e[t+4].x,e[t].y):new m(e[t].x,e[t+4].y)}Crossing(e,t,i){return No.IsCrossing(G.mkPP(e,t),this.segTree,i)}static IsCrossing(e,t,i){for(let n of t.GetAllIntersecting(e.boundingBox))if(i.findIndex(o=>o===n)===-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,i){return this.IntersectObstacleHierarchyL(G.mkPP(e,t))||this.IntersectObstacleHierarchyL(G.mkPP(t,i))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>R.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,i,n){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return n.canHaveStaircaseAtI=!1,Y.DirectionFromPointToPoint(o,a)!==Y.DirectionFromPointToPoint(l,u)||Y.DirectionFromPointToPoint(a,l)!==Y.DirectionFromPointToPoint(u,c)||(l=No.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(n.canHaveStaircaseAtI=!0,!this.Crossing(a,l,i))}RemoveStaircasePN(e,t){let i=e[t],n=e[t+1],o=Math.abs(i.y-n.y)<T.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,i){this.RemoveSegs(e);let n=new Array(e.length-2);a2(e,n,t+1);let o=e[t+1],a=e[t+3];return n[t+1]=i?new m(a.x,o.y):new m(o.x,a.y),s2(e,t+4,n,t+2,n.length-t-2),this.InsertNewSegs(n,t),n}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new _o(e,t))}RemoveSeg(e){this.segTree.Remove(No.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let i=new _o(e,t);this.segTree.Add(No.Rect(i),i)}static Rect(e){return q.mkPP(e.Start,e.End)}};function s2(s,e,t,i,n){for(;n-- >0;)t[i++]=s[e++]}function a2(s,e,t){let i=0;for(;t-- >0;)e[i++]=s[i++]}var st=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,i,n){this.AncestorsSets=n,this.HierarchyOfGroups=et(Array.from(n.keys()).filter(o=>o.IsGroup).map(o=>lt(o,o.BoundingBox))),this.Obstacles=i,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=et(i.map(o=>lt(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length===0)return;let t=e.PathPoints,i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],st.ObstacleTest),n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],st.ObstacleTest);i!=null&&n!=null&&this.PathToObstacles.set(e,[i.UserData,n.UserData])}static ObstacleTest(e,t){return R.PointRelativeToCurveLocation(e,t)!==0?1:0}Calculate(e,t){this.NudgingDirection=e,sr.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let i=this.FindLastUnmappedEdge(e);for(let n=t;n!=null&&n!==i;n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(n.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.LastEdge;i!=null&&Y.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.FirstEdge;i!=null&&Y.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new Sd(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let i=new Array;for(let n of e){let o=new ie;for(let a of n.PathPoints)o.addPoint(a);i.push(o)}return i.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)st.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let i=e.LastEdge;i.Width=Math.max(t.targetArrowhead.width,i.Width)}if(t.sourceArrowhead!=null){let i=e.FirstEdge;i.Width=Math.max(t.sourceArrowhead.width,i.Width)}}PositionShiftedEdges(){this.Solver=new Yp(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];st.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),i=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>i&&(e.IdealPosition=i)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return st.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x===t.x||e.y===t.y)return t;let i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i<n?new m(e.x,t.y):new m(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],i=e.FirstEdge;t.push(this.ShiftedPoint(i.Source,i.LongestNudgedSegment));for(let n of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(n));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let i=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection===1?new m(i,e.y):new m(e.x,-i)}static LineSegOfLongestSeg(e,t){let i=t===2?o=>o.x:o=>o.y,n={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)st.UpdateMinMaxWithPoint(n,i,o.Source),st.UpdateMinMaxWithPoint(n,i,o.Target);return t===2?new G(n.min,-e.IdealPosition,n.max,-e.IdealPosition):new G(e.IdealPosition,n.min,e.IdealPosition,n.max)}static UpdateMinMaxWithPoint(e,t,i){let n=t(i);e.min>n&&(e.min=n),e.max<n&&(e.max=n)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let i of e.Edges){let n=i.AxisEdge;if(n!=null)for(let o of n.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let i of t)this.ConstraintTwoLongestSegs(e,i)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)st.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return le(e.SourcePoint.x,e.TargetPoint.x);default:return le(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let i of e.filter(n=>n.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,i.LongestNudgedSegment),t=i}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,st.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),i=e.GetRightBound();t>=i?(this.Solver.AddFixedVariable(e.Id,st.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,st.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!==Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),i!==Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,i))}}static SegmentPosition(e,t){return t===1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new xd(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let i=t.BoundingBox;for(let n of e.PathEdges()){let o=n.AxisEdge;o.Direction===this.NudgingDirection&&this.BoundAxisEdgeByRect(i,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=st.MapPortsToShapes(this.AncestorsSets.keys()));let t=l2(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(i=>!i.Children.some(n=>t.has(n)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(q.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection===2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),st.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let i=null,n=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(i=a.LongestNudgedSegment,n!=null){let l;st.SetIdealPositionForSeg(n,l=t(n.start),o,t(i.Start)),o=l,n=null}}else i!=null&&(n=i,i=null);n!=null?st.SetIdealPositionForSeg(n,t(n.Start),o,t(e.End)):i!=null&&(i.IdealPosition=t(i.Start))}static SetIdealPositionForSeg(e,t,i,n){let o=Math.max(i,n),a=Math.min(i,n);a+T.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,i=Y.OppositeDir(this.NudgingDirection);for(let n of e.PathEdges()){let o=n.Direction;o===this.NudgingDirection||o===i?(t==null?(n.LongestNudgedSegment=t=new tm(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):n.LongestNudgedSegment=t,n.IsFixed&&(t.IsFixed=!0)):(n.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(i=>i.clone())};return st.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){st.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),st.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let i=e.points.length-1,n=Y.VectorDirectionPP(e.points[i-1],e.points[i]);if(st.ProjectionsAreClose(e.points[i-1],n,t)){e.points=e.points.slice(0,i);return}let o=e.points[i];n===2||n===8?e.points[i]=new m(t.x,o.y):e.points[i]=new m(o.x,t.y)}static ProjectionsAreClose(e,t,i){return t===2||t===8?le(e.x,i.x):le(e.y,i.y)}static ExtendPolylineToSourcePort(e,t){let i=Y.VectorDirectionPP(e.points[0],e.points[1]);if(st.ProjectionsAreClose(e.points[1],i,t)){e.points=e.points.slice(1);return}let n=e.points[0];i===2||i===8?e.points[0]=new m(t.x,n.y):e.points[0]=new m(n.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],i=e[0];t.push(i);let n=e[1],o=Y.VectorDirectionPP(i,n),a=1;for(;++a<e.length;){let l=Y.VectorDirectionPP(n,e[a]);l===o||Y.OppositeDir(l)===o||l===0||(m.closeDistEps(i,n)||t.push(i=st.Rectilinearise(i,n)),o=l),n=e[a]}return m.closeDistEps(i,n)||t.push(st.Rectilinearise(i,n)),t}static NudgePaths(e,t,i,n,o){if(e.length===0)return;let a=new st(e,t,i,n);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=ie.mkFromPoints(st.BuildPolylineForPath(l))}RemoveStaircases(){No.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let i of e)for(let n of i.Ports)t.set(n,i);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,i,n){let o=n.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield pe.mkDebugCurveTWCI(200,e+l*u,i,G.mkPP(o[u],o[u+1]))}};function l2(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}var Ft=class extends oa{constructor(t){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=t,this.location=this.curve().start}mk(t,i){let n=new Ft(t);return n.HookSize=i,n}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(t){this.location=t}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(t){this.adjustmentAngle=t}get HookSize(){return this.hookSize}set HookSize(t){this.hookSize=t}};var Qr=class extends Pr{constructor(t,i,n){super(null,i().add(n));this.LocationOffset=n,this.CurveDelegate=t,this.CenterDelegate=i}static mk(t,i){return new Qr(t,i,new m(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(t){this.centerDelegate=t}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(t){this.curveDelegate=t}get LocationOffset(){return this.locationOffset}set LocationOffset(t){this.locationOffset=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var Er=class extends Qr{constructor(t,i,n=new m(0,0)){super(t,i,n)}get LoosePolyline(){return this.loosePolyline}set LoosePolyline(t){this.loosePolyline=t}static mk(t,i){return new Er(t,i)}};var d0=Ae(kn(),1),um=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.id=um.debugCount++,this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new um(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new d0.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Children)e.enqueue(i)}}*Ancestors(){let e=new d0.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Parents)e.enqueue(i)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}},Mo=um;Mo.debugCount=0;var ma=class extends Mo{constructor(t){super(null);this.curveDelegate=t}get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(t){if(t)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}};var Nr=class{static GetShapes(e,t=Array.from(e.shallowEdges)){let i=new Map;Vv(e,i);for(let n of t){let o=i.get(n.source);o&&n.sourcePort!=null&&o.Ports.add(n.sourcePort),o=i.get(n.target),o&&n.targetPort!=null&&o.Ports.add(n.targetPort)}return Array.from(i.values())}static CreateShapeWithCenterPort(e){let t=new ma(()=>e.boundaryCurve),i=Qr.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);for(let n of e.inEdges())Nr.FixPortAtTarget(i,n);for(let n of e.outEdges())Nr.FixPortAtSource(i,n);for(let n of e.selfEdges())Nr.FixPortAtSource(i,n),Nr.FixPortAtTarget(i,n);return t}static CreateShapeWithClusterBoundaryPort(e){let t=new ma(()=>e.boundaryCurve),i=Er.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);let n;for(let o of e.inEdges())o.EdgeToAncestor()===2?(n==null&&(n=new Ft(()=>e.boundaryCurve)),o.targetPort=n):Nr.FixPortAtTarget(i,o);for(let o of e.outEdges())o.EdgeToAncestor()===1?(n==null&&(n=new Ft(()=>e.boundaryCurve)),o.sourcePort=n):Nr.FixPortAtSource(i,o);for(let o of e.selfEdges())Nr.FixPortAtSource(i,o),Nr.FixPortAtTarget(i,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function Vv(s,e){for(let t of s.shallowNodes)if(t instanceof me){let i=Nr.CreateShapeWithClusterBoundaryPort(t);e.set(t,i);let n=t;if(!n.isCollapsed){Vv(n,e);for(let o of n.shallowNodes)i.AddChild(e.get(o))}}else e.set(t,Nr.CreateShapeWithCenterPort(t))}var ar=class extends pi{static constructorVV(e,t){return new ar(e,t,0)}constructor(e,t,i=0){super(e,t,i)}};var ba=class{constructor(){this.Removed=!1}};var yn=class extends ba{constructor(t,i,n){super();this.start=t,this.EndVertex=i,this.ConeSide=n}get Start(){return this.start}get End(){return this.EndVertex.point}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Ic=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var Td=class extends Jt{constructor(t,i){super();this.site=t,this.coneToClose=i}get ConeToClose(){return this.coneToClose}get Site(){return this.site}toString(){return"ConeClosureEvent "+this.site}};var Oi=class extends ba{constructor(e){super(),this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var jn=class extends ba{constructor(e){super(),this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var zl=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let i=e instanceof yn,n=t instanceof yn;return i?n?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):n?this.CompareConeSideAndObstacleSide(e,t):zl.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(m.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=m.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t===1?-1:t===0?1:e instanceof Oi?-1:1}CompareConeSideAndObstacleSide(e,t){let i=m.getTriangleOrientation(this.x,t.start,t.End);return i===1?-1:i===0||e instanceof Oi?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),i=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}CompareBrokenSides(e,t){return e.EndVertex===t.EndVertex?zl.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):m.getTriangleOrientation(this.x,t.start,t.EndVertex.point)===1?-1:1}};var Pa=class extends Jt{constructor(t,i,n){super();this.coneLeftSide=t,this.intersectionPoint=i,this.endVertex=n}get EndVertex(){return this.endVertex}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var Id=class extends Jt{constructor(t,i,n){super();this.coneRightSide=t,this.intersectionPoint=i,this.endVertex=n}get EndVertex(){return this.endVertex}set EndVertex(t){this.endVertex=t}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var Gt=class extends Sc{constructor(t,i,n,o,a,l,u){super(t,i);this.visibilityGraph=a,this.ConeRightSideDirection=n,this.ConeLeftSideDirection=o,this.coneSideComparer=new zl(this),this.leftConeSides=new ct((c,h)=>this.coneSideComparer.Compare(c,h)),this.rightConeSides=new ct((c,h)=>this.coneSideComparer.Compare(c,h)),this.Ports=l,this.BorderPolyline=u,this.PortEdgesCreator=(c,h)=>new ar(c,h,0)}static Sweep(t,i,n,o,a,l){new Gt(t,i,i.rotate(-n/2),i.rotate(n/2),o,a,l).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let t of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(t.SourcePoint,t.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count===0)return;let t=this.BorderPolyline.startPoint,i=this.leftConeSides.count;do{let n=this.leftConeSides.treeMinimum().item.Cone;t=this.FindPolylineSideIntersectingConeRightSide(t,n),t=this.GetPolylinePointInsideOfConeAndRemoveCones(t,n),i--}while(this.leftConeSides.count>0&&i>0)}GetPolylinePointInsideOfConeAndRemoveCones(t,i){let n=t.nextOnPolyline,o=Gt.FindInsidePoint(t.point,n.point,i);return m.closeDistEps(o,t.point)?(this.AddEdgeAndRemoveCone(i,t.point),this.AddEdgesAndRemoveRemainingConesByPoint(t.point)):m.closeDistEps(o,n.point)?(this.AddEdgeAndRemoveCone(i,n.point),this.AddEdgesAndRemoveRemainingConesByPoint(n.point),t=n):(t=Gt.InsertPointIntoPolylineAfter(this.BorderPolyline,t,o),this.AddEdgeAndRemoveCone(i,t.point),this.AddEdgesAndRemoveRemainingConesByPoint(t.point)),t}static FindInsidePoint(t,i,n){return Gt.FindInsidePointBool(t,i,n.Apex,n.Apex.add(n.LeftSideDirection),n.Apex.add(n.RightSideDirection))}static FindInsidePointBool(t,i,n,o,a){if(m.closeDistEps(t,i)||m.PointIsInsideCone(t,n,o,a))return t;if(m.PointIsInsideCone(i,n,o,a))return i;let l=m.middle(t,i);return m.pointToTheLeftOfLine(l,n,o)?Gt.FindInsidePointBool(l,i,n,o,a):Gt.FindInsidePointBool(t,l,n,o,a)}AddEdgesAndRemoveRemainingConesByPoint(t){let i=new Array;for(let n of this.leftConeSides)if(m.PointToTheRightOfLineOrOnLine(t,n.Start,n.Start.add(n.Direction)))i.push(n.Cone);else break;for(let n of i)this.AddEdgeAndRemoveCone(n,t)}FindPolylineSideIntersectingConeRightSide(t,i){let n=t,o=i.Apex,a=i.Apex.add(this.ConeRightSideDirection),l=Gt.GetSign(t,o,a);for(;;){let u=t.nextOnPolyline,c=Gt.GetSign(u,o,a);if(c-l>0)return t;if(t=u,l=c,t===n)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(t,i,n){let o=m.signedDoubledTriangleArea(i,n,t.point);return o<0?1:o>0?-1:0}AddEdgeAndRemoveCone(t,i){this.Ports!=null&&this.Ports.has(t.Apex)?this.CreatePortEdge(t,i):this.visibilityGraph.AddEdgePP(t.Apex,i),this.RemoveCone(t)}CreatePortEdge(t,i){this.portEdgesGraph==null&&(this.portEdgesGraph=new Ye);let n=this.portEdgesGraph.FindVertex(t.Apex),o=n!=null?Array.from(n.InEdges).concat(Array.from(n.OutEdges.allNodes())):null;if(o)for(let a of o){let l=(a.Target===n?a.Source:a.Target).point;Ye.RemoveEdge(a),this.portEdgesGraph.AddEdgePP(l,i)}this.portEdgesGraph.AddEdgePP(t.Apex,i)}static InsertPointIntoPolylineAfter(t,i,n){let o;return i.next!=null?(o=Mt.mkFromPoint(n),o.prev=i,o.next=i.next,i.next.prev=o,i.next=o):(o=Mt.mkFromPoint(n),o.prev=i,i.next=o,t.endPoint=o),o.polyline=t,t.setInitIsRequired(),o}ProcessEvent(t){t instanceof Li?this.ProcessVertexEvent(t):t instanceof Id?this.ProcessRightIntersectionEvent(t):t instanceof Pa?this.ProcessLeftIntersectionEvent(t):(t instanceof Td?t.ConeToClose.Removed||this.RemoveCone(t.ConeToClose):this.ProcessPortObstacleEvent(t),this.Z=this.GetZS(t))}ProcessPortObstacleEvent(t){this.Z=this.GetZS(t),this.GoOverConesSeeingVertexEvent(t),this.CreateConeOnVertex(t)}ProcessLeftIntersectionEvent(t){if(t.coneLeftSide.Removed===!1)if(Math.abs(t.EndVertex.point.sub(t.Site).dot(this.SweepDirection))<T.distanceEpsilon)this.RemoveCone(t.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(t.coneLeftSide),this.Z=this.GetZP(t.Site);let i=new yn(t.Site,t.EndVertex,t.coneLeftSide);this.InsertToTree(this.leftConeSides,i),t.coneLeftSide.Cone.LeftSide=i,this.LookForIntersectionOfObstacleSideAndLeftConeSide(t.Site,t.EndVertex),this.TryCreateConeClosureForLeftSide(i)}else this.Z=this.GetZP(t.Site)}TryCreateConeClosureForLeftSide(t){if(t.Cone.RightSide instanceof jn){let i=t.Cone.RightSide;m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.EndVertex.point)==0&&this.CreateConeClosureEvent(t,i)}}CreateConeClosureEvent(t,i){let n=m.RayIntersectsRayInteriors(t.start,t.Direction,i.Start,i.Direction);if(n){let o=new Td(n,t.Cone);this.EnqueueEvent(o)}}ProcessRightIntersectionEvent(t){if(t.coneRightSide.Removed===!1){this.RemoveSegFromRightTree(t.coneRightSide),this.Z=this.GetZP(t.Site);let i=new yn(t.Site,t.EndVertex,t.coneRightSide);this.InsertToTree(this.rightConeSides,i),t.coneRightSide.Cone.RightSide=i,this.LookForIntersectionOfObstacleSideAndRightConeSide(t.Site,t.EndVertex),this.TryCreateConeClosureForRightSide(i)}else this.Z=this.GetZP(t.Site)}TryCreateConeClosureForRightSide(t){if(t.Cone.LeftSide instanceof Oi){let n=t.Cone.LeftSide;m.getTriangleOrientation(n.Start,n.Start.add(n.Direction),t.EndVertex.point)==1&&this.CreateConeClosureEvent(t,n)}}RemoveConesClosedBySegment(t,i){this.CloseConesCoveredBySegment(t,i,this.GetZP(t)>this.GetZP(i)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(t,i,n){let o=n.findFirst(u=>m.getTriangleOrientation(u.Start,u.Start.add(u.Direction),t)===1);if(o==null||!m.IntervalIntersectsRay(t,i,o.item.Start,o.item.Direction))return;let l=new Array;do l.push(o.item.Cone),o=n.next(o);while(o!=null&&m.IntervalIntersectsRay(t,i,o.item.Start,o.item.Direction)!==void 0);for(let u of l)this.RemoveCone(u)}ProcessVertexEvent(t){this.Z=this.GetZS(t),this.GoOverConesSeeingVertexEvent(t),this.AddConeAndEnqueueEvents(t)}static Diamond(t){return _e.mkDiamond(2,2,t)}AddConeAndEnqueueEvents(t){if(t instanceof Wn){let n=t.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(t,n)}else if(t instanceof Hn){let o=t.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(t,o)}else this.CloseConesAddConeAtLeftVertex(t,t.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(t,t.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(t,i){let n=t.Vertex.nextOnPolyline.point;this.directionPerp.dot(t.Site.sub(n))>T.distanceEpsilon&&this.RemoveConesClosedBySegment(n,t.Vertex.point),this.directionPerp.dot(i.point.sub(t.Site))>T.distanceEpsilon&&this.RemoveConesClosedBySegment(t.Site,i.point);let o=t.Site,a=o.add(this.ConeLeftSideDirection),l=o.add(this.ConeRightSideDirection),u=i.point;this.GetZP(o.sub(n))>T.distanceEpsilon&&this.RemoveRightSide(new Ro(t.Vertex.nextOnPolyline)),this.GetZP(o.sub(i.point))>T.distanceEpsilon&&this.RemoveLeftSide(new Lo(i)),this.GetZP(u)+T.distanceEpsilon<this.GetZS(t)&&this.CreateConeOnVertex(t),m.PointToTheRightOfLineOrOnLine(u,o,a)?m.PointToTheLeftOfLineOrOnLine(u,o,l)?this.CaseToTheLeftOfLineOrOnLineConeRp(t,i):(this.GetZP(u.sub(o))>T.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(t.Site,i),this.InsertRightSide(new Ro(t.Vertex))),this.EnqueueRightVertexEvent(new Hn(i))):(this.CreateConeOnVertex(t),m.PointToTheLeftOfLineOrOnLine(u.add(this.DirectionPerp),u,o)&&this.EnqueueRightVertexEvent(new Hn(i)))}CaseToTheLeftOfLineOrOnLineConeRp(t,i){this.EnqueueRightVertexEvent(new Hn(i));let n=new Ic(t.Vertex.point,this),o=new yn(n.Apex,i,new Oi(n));n.LeftSide=o,n.RightSide=new jn(n);let a=this.InsertToTree(this.rightConeSides,n.RightSide);this.LookForIntersectionWithConeRightSide(a);let l=this.InsertToTree(this.leftConeSides,n.LeftSide);this.FixConeLeftSideIntersections(o,l),this.GetZP(i.point.sub(t.Site))>T.distanceEpsilon&&this.InsertRightSide(new Ro(t.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(t,i){let n=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(t);if(n!=null&&n.item instanceof jn!=null){let a=m.IntervalIntersectsRay(t,i.point,n.item.Start,this.ConeRightSideDirection);a&&this.SegmentIsNotHorizontal(a,i.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n.item,a,i))}}CreateRightIntersectionEvent(t,i,n){return new Id(t,i,n)}GetLastNodeToTheLeftOfPointInRightSegmentTree(t){return this.rightConeSides.findLast(i=>Gt.PointIsToTheRightOfSegment(t,i))}LookForIntersectionOfObstacleSideAndLeftConeSide(t,i){let n=this.GetFirstNodeToTheRightOfPoint(t);if(n==null||!(n.item instanceof Oi))return;let o=n.item,a=m.IntervalIntersectsRay(t,i.point,o.Start,this.ConeLeftSideDirection);a&&this.EnqueueEvent(new Pa(o,a,i))}GetFirstNodeToTheRightOfPoint(t){return this.leftConeSides.findFirst(i=>Gt.PointIsToTheLeftOfSegment(t,i))}static PointIsToTheLeftOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t)===1}static PointIsToTheRightOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t)===0}FixConeLeftSideIntersections(t,i){do i=this.leftConeSides.next(i);while(i!=null&&m.PointToTheRightOfLineOrOnLine(t.Start,i.item.Start,i.item.Start.add(i.item.Direction)));if(i!=null&&i.item instanceof Oi){let n=i.item,o=m.IntervalIntersectsRay(t.start,t.End,n.Start,n.Direction);o&&this.EnqueueEvent(new Pa(n,o,t.EndVertex))}}InsertToTree(t,i){return this.coneSideComparer.SetOperand(i),t.insert(i)}CloseConesAddConeAtLeftVertex(t,i){let n=t.Vertex.prevOnPolyline.point;t.Site.sub(n).dot(this.directionPerp)<-T.distanceEpsilon&&this.RemoveConesClosedBySegment(t.Site,n),i.point.sub(t.Site).dot(this.directionPerp)<-T.distanceEpsilon&&this.RemoveConesClosedBySegment(i.point,t.Site);let o=t.Site,a=o.add(this.ConeLeftSideDirection),l=o.add(this.ConeRightSideDirection),u=i.point;this.GetZP(o.sub(n))>T.distanceEpsilon&&this.RemoveLeftSide(new Lo(t.Vertex.prevOnPolyline));let c=this.GetZP(u)-this.Z;c<-T.distanceEpsilon&&this.RemoveRightSide(new Ro(i));let h=u.sub(t.Site);if(c<-T.distanceEpsilon||le(c,0)&&this.GetZP(h)>0&&h.dot(this.directionPerp)>-T.distanceEpsilon)this.CreateConeOnVertex(t);else if(!m.PointToTheLeftOfLineOrOnLine(u,o,l))this.CreateConeOnVertex(t),this.EnqueueEvent(new Wn(i));else if(m.PointToTheLeftOfLineOrOnLine(u,o,a))this.EnqueueEvent(new Wn(i)),this.GetZP(h)>T.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(t.Site,i),this.InsertLeftSide(new Lo(t.Vertex)));else{this.EnqueueEvent(new Wn(i));let d=new Ic(t.Vertex.point,this),f=new yn(t.Vertex.point,i,new jn(d));d.RightSide=f,d.LeftSide=new Oi(d),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,d.LeftSide));let p=this.InsertToTree(this.rightConeSides,f);this.FixConeRightSideIntersections(f,p),this.GetZP(h)>T.distanceEpsilon&&this.InsertLeftSide(new Lo(t.Vertex))}}RemoveCone(t){t.Removed=!0,this.RemoveSegFromLeftTree(t.LeftSide),this.RemoveSegFromRightTree(t.RightSide)}RemoveSegFromRightTree(t){this.coneSideComparer.SetOperand(t);let i=this.rightConeSides.remove(t);if(t.Removed=!0,i==null){let n=this.Z;this.Z=Math.max(this.GetZP(t.Start),this.Z-.01),this.coneSideComparer.SetOperand(t),i=this.rightConeSides.remove(t),this.Z=n}}RemoveSegFromLeftTree(t){if(t.Removed=!0,this.coneSideComparer.SetOperand(t),this.leftConeSides.remove(t)==null){let n=this.Z;this.Z=Math.max(this.GetZP(t.Start),this.Z-.01),this.coneSideComparer.SetOperand(t),this.leftConeSides.remove(t),this.Z=n}}FixConeRightSideIntersections(t,i){do i=this.rightConeSides.previous(i);while(i!=null&&m.PointToTheLeftOfLineOrOnLine(t.start,i.item.Start,i.item.Start.add(i.item.Direction)));if(i!=null){let n;if(i.item instanceof jn){let o=i.item;(n=m.IntervalIntersectsRay(t.start,t.End,o.Start,o.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(o,n,t.EndVertex))}}}CreateConeOnVertex(t){let i=new Ic(t.Site,this);i.LeftSide=new Oi(i),i.RightSide=new jn(i);let n=this.InsertToTree(this.leftConeSides,i.LeftSide),o=this.InsertToTree(this.rightConeSides,i.RightSide);this.LookForIntersectionWithConeRightSide(o),this.LookForIntersectionWithConeLeftSide(n)}LookForIntersectionWithConeLeftSide(t){if(t.item instanceof Oi){let n=t.item,o=this.FindFirstObstacleSideToTheLeftOfPoint(n.Start);o!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(n,o)}else{let n=t.item;t=this.leftConeSides.next(t),t!=null&&t.item instanceof Oi&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(t.item,n)}}LookForIntersectionWithConeRightSide(t){if(t.item instanceof jn){let n=t.item,o=this.FindFirstObstacleSideToToTheRightOfPoint(n.Start);o!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(n,o)}else{let n=t.item;t=this.rightConeSides.previous(t),t!=null&&t.item instanceof jn&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(t.item,n)}}TryIntersectionOfConeRightSideAndObstacleConeSide(t,i){let n=m.IntervalIntersectsRay(i.start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(t,n,i.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(t,i){let n=m.IntervalIntersectsRay(i.Start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(t,n,i.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(t,i){let n=m.IntervalIntersectsRay(i.start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(new Pa(t,n,i.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(t,i){let n=m.IntervalIntersectsRay(i.Start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(new Pa(t,n,i.EndVertex))}Show(t,i){let n=Array.from(this.Obstacles).map(o=>pe.mkDebugCurveTWCI(200,.5,"Blue",o));for(let o of this.rightConeSides)n.push(pe.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(o))),o instanceof yn&&n.push(pe.mkDebugCurveCI("brown",Gt.Diamond(o.start))),n.push(pe.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(o.Cone.LeftSide))),o.Cone.LeftSide instanceof yn&&n.push(pe.mkDebugCurveCI("green",Gt.Diamond(o.Cone.LeftSide.start)));n=n.concat(Array.from(this.visibilityGraph.Edges).map(o=>pe.mkDebugCurveWCI(2,"Black",G.mkPP(o.SourcePoint,o.TargetPoint)))),n=n.concat(t.map(o=>pe.mkDebugCurveCI("Red",o)))}ExtendSegmentToZ(t){let i=t.Direction.dot(this.SweepDirection),n=(this.Z+40-t.Start.dot(this.SweepDirection))/i;return G.mkPP(t.Start,t.Start.add(t.Direction.mul(n)))}GoOverConesSeeingVertexEvent(t){let i=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(t);if(i==null)return;let o=i.item.Cone,a=o.LeftSide;if(Gt.VertexIsToTheLeftOfSegment(t,a))return;let l=[o];if(this.coneSideComparer.SetOperand(a),i=this.leftConeSides.find(a),i==null){let u=this.Z;this.Z=Math.max(this.GetZP(a.Start),this.PreviousZ),this.coneSideComparer.SetOperand(a),i=this.leftConeSides.find(a),this.Z=u}if(!(i==null&&(i=this.GetRbNodeEmergency(a),i==null))){for(i=this.leftConeSides.next(i);i!=null&&!Gt.VertexIsToTheLeftOfSegment(t,i.item);)l.push(i.item.Cone),i=this.leftConeSides.next(i);for(let u of l)this.AddEdgeAndRemoveCone(u,t.Site)}}GetRbNodeEmergency(t){if(this.leftConeSides.count===0)return null;for(let i=this.leftConeSides.treeMinimum();i!=null;i=this.leftConeSides.next(i))if(i.item===t)return i;return null}static VertexIsToTheLeftOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.Site)===1}static VertexIsToTheRightOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.Site)===0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(t){return this.rightConeSides.findFirst(i=>!Gt.VertexIsToTheRightOfSegment(t,i))}EnqueueRightVertexEvent(t){this.GetZP(t.Site.sub(t.Vertex.prevOnPolyline.point))>T.tolerance||this.EnqueueEvent(t)}invariant(){for(let t of this.leftConeSides)if(t.Removed)return!1;for(let t of this.rightConeSides)if(t.Removed)return!1;return!0}};var Bo=class extends Pe{constructor(t,i){super(null);this.coneAngle=Math.PI/6;this.ports=new He;this._obstacles=Array.from(Ye.OrientHolesClockwise(t)),this._visibilityGraph=i}static mk(t,i,n,o,a){let l=new Bo(t,i);return l.Ports=o,l.BorderPolyline=a,l.ConeAngle=n,l}get ConeAngle(){return this.coneAngle}set ConeAngle(t){this.coneAngle=t}get Ports(){return this.ports}set Ports(t){this.ports=t}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(t){this.borderPolyline=t}get Bidirectional(){return this._bidirectional}set Bidirectional(t){this._bidirectional=t}static GetTotalSteps(t){return Math.floor((2*Math.PI-t/2)/t)+1}run(){let t=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let i;for(let n=0;(i=this.coneAngle*n)<=t;n++)super.ProgressStep(),this.AddDirection(new m(Math.cos(i),Math.sin(i)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let t=Math.PI/this.coneAngle;for(let i=0;i<t;i++){let n=i*this.coneAngle,o=new Ye;this.AddDirection(new m(Math.cos(n),Math.sin(n)),this.BorderPolyline,o);let a=new Ye;this.AddDirection(new m(Math.cos(n)*-1,Math.sin(n)*-1),this.BorderPolyline,a),this.AddIntersectionOfBothDirectionSweepsToTheResult(o,a)}}AddIntersectionOfBothDirectionSweepsToTheResult(t,i){for(let n of t.Edges)i.FindEdgePP(n.SourcePoint,n.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(n.SourcePoint,n.TargetPoint)}AddDirection(t,i,n){Gt.Sweep(this._obstacles,t,this.coneAngle,n,this.Ports,i)}};var qn=class{constructor(){this.capacityOverflowCoefficient=qn.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=qn.DefaultPathLengthImportance;this.inkImportance=qn.DefaultInkImportance;this.edgeSeparation=qn.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.useCubicBezierSegmentsInsideOfHubs=!1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}toJSON(){let e={};return this.capacityOverflowCoefficient!=qn.DefaultCapacityOverflowCoefficientMultiplier&&(e.capacityOverflowCoefficient=this.capacityOverflowCoefficient),this.RotateBundles&&(e.RotateBundles=this.RotateBundles),this.MaxHubRadius!=50&&(e.MaxHubRadius=this.MaxHubRadius),this.MinHubRadius!=.1&&(e.MinHubRadius=this.MinHubRadius),this.CreateUnderlyingPolyline&&(e.CreateUnderlyingPolyline=this.CreateUnderlyingPolyline),this.pathLengthImportance!=qn.DefaultPathLengthImportance&&(e.pathLengthImportance=this.pathLengthImportance),this.inkImportance!=qn.DefaultInkImportance&&(e.inkImportance=this.inkImportance),this.edgeSeparation!=qn.DefaultEdgeSeparation&&(e.edgeSeparation=this.edgeSeparation),this._edgeWidthShrinkCoeff!=1&&(e._edgeWidthShrinkCoeff=this._edgeWidthShrinkCoeff),this.useCubicBezierSegmentsInsideOfHubs&&(e.useCubicBezierSegmentsInsideOfHubs=this.useCubicBezierSegmentsInsideOfHubs),this.angleThreshold!=Math.PI/180*45&&(e.angleThreshold=this.angleThreshold),this.hubRepulsionImportance!=100&&(e.hubRepulsionImportance=this.hubRepulsionImportance),this.bundleRepulsionImportance!=100&&(e.bundleRepulsionImportance=this.bundleRepulsionImportance),this.minimalRatioOfGoodCdtEdges!=.9&&(e.minimalRatioOfGoodCdtEdges=this.minimalRatioOfGoodCdtEdges),this.highestQuality||(e.highestQuality=this.highestQuality),this.KeepOverlaps&&(e.KeepOverlaps=this.KeepOverlaps),this.StopAfterShortestPaths&&(e.StopAfterShortestPaths=this.StopAfterShortestPaths),e}static createFromJSON(e){let t=new qn;return e.capacityOverflowCoefficient&&(t.capacityOverflowCoefficient=e.capacityOverflowCoefficient),e.RotateBundles&&(t.RotateBundles=e.RotateBundles),e.MaxHubRadius&&(t.MaxHubRadius=e.MaxHubRadius),e.MinHubRadius&&(t.MinHubRadius=e.MinHubRadius),e.CreateUnderlyingPolyline&&(t.CreateUnderlyingPolyline=e.CreateUnderlyingPolyline),e.pathLengthImportance&&(t.pathLengthImportance=e.pathLengthImportance),e.inkImportance&&(t.inkImportance=e.inkImportance),e.edgeSeparation&&(t.edgeSeparation=e.edgeSeparation),e._edgeWidthShrinkCoeff&&(t._edgeWidthShrinkCoeff=e._edgeWidthShrinkCoeff),e.useCubicBezierSegmentsInsideOfHubs&&(t.useCubicBezierSegmentsInsideOfHubs=e.useCubicBezierSegmentsInsideOfHubs),e.angleThreshold&&(t.angleThreshold=e.angleThreshold),e.hubRepulsionImportance&&(t.hubRepulsionImportance=e.hubRepulsionImportance),e.bundleRepulsionImportance&&(t.bundleRepulsionImportance=e.bundleRepulsionImportance),e.minimalRatioOfGoodCdtEdges&&(t.minimalRatioOfGoodCdtEdges=e.minimalRatioOfGoodCdtEdges),e.highestQuality&&(t.HighestQuality=e.highestQuality),e.KeepOverlaps&&(t.KeepOverlaps=e.KeepOverlaps),e.StopAfterShortestPaths&&(t.StopAfterShortestPaths=e.StopAfterShortestPaths),t}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},Sn=qn;Sn.DefaultCapacityOverflowCoefficientMultiplier=1e3,Sn.DefaultPathLengthImportance=500,Sn.DefaultInkImportance=.01,Sn.DefaultEdgeSeparation=.5;var _i=class{static GetShapes(e,t){let i=new Map;for(let n of e)_i.ProcessAncestorDescendantCouple(n.target,n.source,i),_i.InsertEdgePortsToShapes(i,n);for(let n of t)_i.ProcessAncestorDescendantCouple(n.source,n.target,i),_i.InsertEdgePortsToShapes(i,n);return _i.BindShapes(i),Array.from(i.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,i]of e){if(!(t instanceof me))continue;let n=t;for(let o of f0(n)){let a=e.get(o);a&&i.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,i){let n=cm(t);do{for(let o of f0(n))_i.CreateShapeIfNeeeded(o,i);if(n===e)break;n=cm(n)}while(!0);_i.CreateShapeIfNeeeded(n,i)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new ma(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,i){let n=new Set;for(let o of e)if(_i.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,n,i))return!1;for(let o of t)if(_i.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,n,i))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,i,n){let o=cm(t);for(;;){for(let a of f0(o))if(i.add(a),i.size>n)return!0;if(o===e)break;o=cm(o)}return i.add(o),i.size>n}};function cm(s){let e=s.node.parent;return xe.getGeom(e)}function*f0(s){for(let e of s.graph.shallowNodes)yield xe.getGeom(e)}var Jr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new m(0,Number.MAX_SAFE_INTEGER);let t=-1,i=0;for(let n of e)n.y<this.pivot.y?(this.pivot=n,t=i):n.y===this.pivot.y&&n.x>this.pivot.x&&(this.pivot=n,t=i),i++;if(i>=1){this.hullPoints=new Array(i-1),i=0;for(let n of e)i!==t?this.hullPoints[i++]={point:n,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new Jr(e);for(let i of t.Calculate())yield i}*Calculate(){if(this.pivot.y!==Number.MAX_SAFE_INTEGER){if(this.hullPoints.length===0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return m.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)===1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=m.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t===1?!0:t===0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+T.distanceEpsilon&&e.x<this.pivot.x-T.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(u2(this.pivot))}static createConvexHullAsClosedPolyline(e){return ie.mkClosedFromPoints(Array.from(Jr.CalculateConvexHull(e)))}};function u2(s){return(e,t)=>{if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;switch(m.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let i=e.point.x-s.x,n=t.point.x-s.x;if(i>T.distanceEpsilon&&n<-T.distanceEpsilon)return-1;if(i<-T.distanceEpsilon&&n>T.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function $r(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):($r(s,e.Left,t),$r(s,e.Right,t)):e.Left!=null?($r(s.Left,e.Left,t),$r(s.Left,e.Right,t),$r(s.Right,e.Left,t),$r(s.Right,e.Right,t)):($r(s.Left,e,t),$r(s.Right,e,t)))}function Ht(s,e,t){!s.irect.intersects_rect(e.irect)||(s===e?h2(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Ht(s,e.Left,t),Ht(s,e.Right,t)):e.Left!=null?(Ht(s.Left,e.Left,t),Ht(s.Left,e.Right,t),Ht(s.Right,e.Left,t),Ht(s.Right,e.Right,t)):(Ht(s.Left,e,t),Ht(s.Right,e,t)))}function Ki(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s===e)return c2(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(Ki(s,e.Left,t)||Ki(s,e.Right,t))return!0}else if(e.Left!=null){if(Ki(s.Left,e.Left,t)||Ki(s.Left,e.Right,t)||Ki(s.Right,e.Left,t)||Ki(s.Right,e.Right,t))return!0}else if(Ki(s.Left,e,t)||Ki(s.Right,e,t))return!0;return!1}function c2(s,e){return s.Left==null?!1:Ki(s.Left,s.Left,e)||Ki(s.Left,s.Right,e)||Ki(s.Right,s.Right,e)}function h2(s,e){s.Left!=null&&(Ht(s.Left,s.Left,e),Ht(s.Left,s.Right,e),Ht(s.Right,s.Right,e))}var Uv=Ae(kn(),1);function*Xn(s){let e=new Array(s.nodeCount).fill(!1),t=new Uv.Queue;for(let i=0;i<s.nodeCount;i++)if(!e[i]){let n=new Array;for(kv(i,t,e);t.length>0;){let o=t.dequeue();n.push(o);for(let a of d2(s,o))kv(a,t,e)}yield n}}function*d2(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function kv(s,e,t){t[s]===!1&&(e.enqueue(s),t[s]=!0)}var zv=BigInt("6364136223846793005"),g0=(BigInt(1)<<BigInt(32))-BigInt(1),Ps=(BigInt(1)<<BigInt(64))-BigInt(1),ya=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&Ps,this._random_b(),this._state=this._state+BigInt(e)&Ps,this._random_b()}_random_b(){let e=this._state;this._state=e*zv+this._inc&Ps;let t=(e>>BigInt(18)^e)>>BigInt(27),i=e>>BigInt(59),n=i^BigInt(31);return(t>>i|t<<n)&g0}_advance(e){e&=Ps;let t=BigInt(1),i=zv,n=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*i&Ps,n=n*i+o&Ps),o=(i+BigInt(1))*o&Ps,i=i*i&Ps,e>>=BigInt(1);this._state=t*this._state+n&Ps}randint(e){if(e>g0)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),i=(g0^t)%t;for(;;){let n=this._random_b();if(n>=i)return Number(n%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var Wl;function Sa(s){return Wl==null&&(Wl=new ya(0,0)),Wl.randint(s)}function wc(s){Wl=new ya(s,0)}function Do(){return Wl==null&&(Wl=new ya(0,0)),Wl.random()}var Hl=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n>=this.f(0)&&n>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:e=i;break;case 0:t=i;break;case 2:return i}return e===t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e===0){let o=this.f(1);return o===t?2:o>t?0:1}if(e===this.length-1){let o=this.f(this.length-2);return o===t?2:o>t?1:0}let i=t-this.f(e-1),n=this.f(e+1)-t;return i*n<=0?2:i>0?0:1}FindMaximum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n<=this.f(0)&&n<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:t=i;break;case 0:e=i;break;case 2:return i}return e===t||this.f(e)>=this.f(t)?e:t}};var hm=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.min(this.f(n),e+i*n)}GetAdjustedSequenceForMaximum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.max(this.f(n),e+i*n)}FindMinimum(){return this.f(0)===this.f(this.length-1)?new Hl(this.f,this.length).FindMinimum():new Hl(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)===this.f(this.length-1)?new Hl(this.f,this.length).FindMaximum():new Hl(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var Ea=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,i){let n=this.P.pnt(e);return this.upperBranchOnP?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}LeftFromLineOnQ(e,t,i){let n=this.Q.pnt(e);return this.lowerBranchOnQ?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,i,n){for(;t!==e||n!==i;){let o=t!==e?this.MedianOnP(e,t):e,a=n!==i?this.MedianOnQ(i,n):i,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!==e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(i,n)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?i=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?n=a:h=!1:n!==i?this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:h=!1:h=!1,!c&&!h&&(e=o,t=o,i=a,n=a)}return[e,n]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=m.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.sub(t.qClosest).rotate(Math.PI/2),e.p1=t.p1,e.p2=t.p2,e.q1=t.q1,e.q2=t.q2}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2===e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2===e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1===e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1===e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=m.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),m.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:m.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=m.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),m.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:m.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,i,n){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(n-i)+1;return a>2||o===2&&a===2}ShrinkChunks(e){let t=e.p1===e.p2?e.p1:this.P.Median(e.p1,e.p2),i=e.q1===e.q2?e.q1:this.Q.Median(e.q2,e.q1),n=this.P.pp(t).point,o=this.Q.pp(i).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,i,n,o,a),!this.InternalCut(e,t,i,a.a1,a.a2,a.b1,a.b2)&&!Ea.OneOfChunksContainsOnlyOneVertex(e,t,i,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:i},a)){if(e.p2===this.P.Next(e.p1)&&e.q1===this.Q.Next(e.q2)){let l=G.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab===0?e.p2=e.p1:l.parab===1?e.p1=e.p2:l.parcd===0?e.q2=e.q1:l.parcd===1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=i:a.a2>=Math.PI/2?e.p2=t:e.q2=i:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=i:e.q2=i}}InternalCut(e,t,i,n,o,a,l){let u=!1;if(n>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.P.pp(this.P.Next(t)).point,f=m.getTriangleOrientation(c,h,this.Q.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.Q.pp(this.Q.Next(i)).point,f=m.getTriangleOrientation(c,h,this.P.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.q2=this.Q.Next(i):e.q1=this.Q.Prev(i),u=!0}return u}GetAnglesAtTheMedian(e,t,i,n,o){o.a1=m.anglePCP(n,i,this.P.pnt(this.P.Prev(e))),o.a2=m.anglePCP(this.P.pnt(this.P.Next(e)),i,n),o.b1=m.anglePCP(this.Q.pnt(this.Q.Next(t)),n,i),o.b2=m.anglePCP(i,n,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,i){let n=e.p2===this.P.Next(e.p1),o=e.q1===this.Q.Next(e.q2);return n&&!o?(this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),!0):o&&!n?(this.SwapEverything(e,t,i),this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),this.SwapEverything(e,t,i),!0):!1}SwapEverything(e,t,i){this.SwapPq();let n=e.p2;e.p2=e.q1,e.q1=n,n=e.q2,e.q2=e.p1,e.p1=n,n=t.mq,t.mq=t.mp,t.mp=n,n=i.a2,i.a2=i.b1,i.b1=n,n=i.b2,i.b2=i.a1,i.a1=n}ProcessShortSide(e,t,i,n,o,a,l){t===e.p2?this.ProcessSide(e,i,n,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=i:o>=Math.PI/2?e.q1=i:a<l&&(m.canProject(this.Q.pnt(i),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=i:e.p1=e.p2):n+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,i,n,o){let a=this.Q.pnt(t);i<=Math.PI?i+n>=Math.PI?i>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:i<o&&(m.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,n>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,i,n,o){return e.p1===e.p2?(o>=Math.PI/2?e.q1=i:e.q2=i,!0):e.q1===e.q2?(n>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,i,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,i,e.q2)}CalculateRightTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,i,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,i,e.q2)}};var $t=class{static mkFromPoints(e){return new $t(ie.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,i,n){let o=n.rotate(Math.PI/2);this.polyline.startPoint.point.sub(i).dot(o)<0&&(o=o.mul(-1)),e===t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!==t);return e}static TestPolygonDist(e,t){let i=Number.MAX_SAFE_INTEGER;for(let n=0;n<e.count;n++)for(let o=0;o<t.count;o++){let a=G.minDistBetweenLineSegments(e.pnt(n),e.pnt(n+1),t.pnt(o),t.pnt(o+1));i=Math.min(i,a.dist)}return i}static Distance(e,t){let n=new Ea(e,t).FindClosestPoints();return{p:n.pClosest,q:n.qClosest,dist:n.pClosest.sub(n.qClosest).length}}static DistanceOnly(e,t){return $t.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let i=t.startPoint;i.next!=null&&i.next.next!=null;i=i.next)if(m.getTriangleOrientation(i.point,i.next.point,i.next.next.point)===2)return!1;return!0}static DistancePoint(e,t){let i=Number.MAX_VALUE;for(let n=0;n<e.count;n++){let o=m.distToLineSegment(t,e.points[n].point,e.points[(n+1)%e.count].point).dist;i=Math.min(i,o)}return i}GetTangentPoints(e,t){let i=new hm(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=i.FindMaximum(),e.rightTangentPoint=i.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return i=>{let n=m.anglePCP(t,e,this.pnt(i));return n<Math.PI?n:n-2*Math.PI}}};var we=class{constructor(e,t,i,n){this.randomizeLoosePolylines=!1;this.TightObstacles=new Set;this.Obstacles=e,this.TightPadding=t,this.LoosePadding=i,this.IgnoreTightPadding=n}ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(G.mkPP(e,t))}static PadCorner(e,t,i,n,o){let a=we.GetPaddedCorner(t,i,n,o);return a.numberOfPoints===-1?!1:(e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return m.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t,i=!1){return we.CreatePaddedPolyline(R.polylineAroundClosedCurve(e),t,i)}static LoosePolylineWithFewCorners(e,t,i){return t<T.distanceEpsilon?e:we.CreateLoosePolylineOnBisectors(e,t,i)}static CreateLoosePolylineOnBisectors(e,t,i){let n=Array.from(we.BisectorPoints(e,t));i&&a();let o=Jr.CalculateConvexHull(n);return ie.mkClosedFromPoints(o);function a(){for(let l=0;l<n.length;l++){let u=n[l];n[l]=new m(u.x+.001*Do(),u.y+.001*Do())}}}static CreateRectNodeOfPolyline(e){return lt(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=we.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(we.LoosePolylineWithFewCorners(e,t,this.randomizeLoosePolylines))}this.RootOfLooseHierarchy=we.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=this.CreateTightObstacles_(),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size===0}ObstaclesIntersectICurve(e){let t=e.boundingBox;return we.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,i){if(!i.irect.intersects(t))return!1;if(i.UserData!=null){let n=i.UserData;return R.intersectionOne(n,e,!1)!=null||we.PointIsInside(n.start,e)}return we.CurveIntersectsRectangleNode(e,t,i.Left)||we.CurveIntersectsRectangleNode(e,t,i.Right)}static PointIsInside(e,t){return R.PointRelativeToCurveLocation(e,t)===2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(n=>R.polylineAroundClosedCurve(n)),t=we.CalculateHierarchy(e),i=we.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,i.size===0){for(let n of e){let o=we.FindMaxPaddingForTightPolyline(t,n,this.TightPadding);this.TightObstacles.add(we.LoosePolylineWithFewCorners(n,o,this.randomizeLoosePolylines))}this.RootOfTightHierarchy=we.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let n of e)this.TightObstacles.add(we.CreatePaddedPolyline(n,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=we.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;we.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=we.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(i)),this.OverlapsDetected=!0}}CreateTightObstacles_(){if(this.Obstacles.length===0)return null;for(let e of this.Obstacles)we.CalculateTightPolyline(this.TightObstacles,this.TightPadding,e);return we.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(this.TightObstacles)}static CalculateTightPolyline(e,t,i){let n=we.PaddedPolylineBoundaryOfNode(i,t);e.add(n)}static CalculateHierarchy(e){let t=e.map(i=>we.CreateRectNodeOfPolyline(i));return et(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=we.CalculateHierarchy(Array.from(e)),i;for(;(i=we.GetOverlappedPairSet(t)).size>0;)t=we.ReplaceTightObstaclesWithConvexHulls(e,Array.from(i));return t}static MapToInt(e){let t=new Map;for(let i=0;i<e.length;i++)t.set(e[i],i);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let i=new Set;for(let u of t)i.add(u[0]),i.add(u[1]);let n=Array.from(i),o=we.MapToInt(n),a=Gp(Array.from(t).map(u=>new ye(o.get(u[0]),o.get(u[1])))),l=Xn(a);for(let u of l){let c=u.map(f=>n[f]),h=Io(c,f=>f),d=Jr.createConvexHullAsClosedPolyline(h);for(let f of c)e.delete(f);e.add(d)}return we.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return R.PointRelativeToCurveLocation(e.start,t)!==0||R.PointRelativeToCurveLocation(t.start,e)!==0}static PolylinesIntersect(e,t){return R.CurvesIntersect(e,t)||we.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return Ht(e,e,(i,n)=>{we.PolylinesIntersect(i,n)&&t.add([i,n])}),t}static*BisectorPoints(e,t){for(let i=e.startPoint;i!=null;i=i.next){let n={skip:!1},o=we.GetStickingVertexOnBisector(i,t,n);n.skip||(yield o)}}static GetStickingVertexOnBisector(e,t,i){let n=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(n).normalize().add(o.sub(a).normalize()),u=l.length;return u<T.tolerance?i.skip=!0:(i.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,i){let n=i,o=new $t(t),a=t.boundingBox.clone();a.pad(2*i);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!==t)){let u=$t.Distance(o,new $t(l)).dist;n=Math.min(n,u/we.LooseDistCoefficient)}return n}static GetPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point;if(m.getTriangleOrientation(o,a,l)===1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(we.CornerIsNotTooSharp(o,a,l)){u=u.mul(n);let S=l.sub(a).normalize().mul(n).rotate(Math.PI/2),x=m.lineLineIntersection(o.add(u),a.add(u),a.add(S),l.add(S));return{a:x,b:x,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<T.intersectionEpsilon){let S=a.add(u.mul(n));return{a:S,b:S,numberOfPoints:1}}let h=c.normalize().mul(n),d=h.rotate(Math.PI/2),f=(n-h.dot(u))/d.dot(u),p=d.mul(f);return{a:h.add(p).add(a),b:h.sub(p).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,i){let n=e.sub(t).rotate(Math.PI/4).add(t);return m.getTriangleOrientation(t,n,i)===1}static CreatePaddedPolyline(e,t,i=!1){let n=new ie,o=i?f2(e):e;if(!we.PadCorner(n,o.endPoint.prev,o.endPoint,o.startPoint,t))return we.CreatePaddedPolyline(ie.mkClosedFromPoints(Array.from(Jr.CalculateConvexHull(o))),t);if(!we.PadCorner(n,o.endPoint,o.startPoint,o.startPoint.next,t))return we.CreatePaddedPolyline(ie.mkClosedFromPoints(Array.from(Jr.CalculateConvexHull(o))),t);for(let a=o.startPoint;a.next.next!=null;a=a.next)if(!we.PadCorner(n,a,a.next,a.next.next,t))return we.CreatePaddedPolyline(ie.mkClosedFromPoints(Array.from(Jr.CalculateConvexHull(o))),t);return n.closed=!0,n}},er=we;er.LooseDistCoefficient=2.1;function f2(s){let e=new ie,t=.01;for(let i=s.startPoint;i;i=i.next){let n=i.point.x+t*Do(),o=i.point.y+t*Do();e.addPointXY(n,o)}return e.closed=s.closed,e}var Lc=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,i){let n=new Lc;return n.TightPolyline=e,n.LooseShape=t,n.Distance=i,n}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Rc=class{constructor(e,t,i,n){this.MainShape=e,this.TightPadding=t,this.LoosePadding=i,this.ShapesToTightLooseCouples=n}Calculate(e){this.MainShape.Children.length!==0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(e),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=et(this.MainShape.Children.map(t=>lt(t,t.BoundingBox)));$r(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Rc.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return R.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)===2}CreateTigthLooseCouples(e){let t=new Array;for(let i of this.tightHierarchy.GetAllLeaves()){let n=er.FindMaxPaddingForTightPolyline(this.tightHierarchy,i,this.LoosePadding),o=er.LoosePolylineWithFewCorners(i,n,e);t.push(Lc.mk(i,new Mo(o),n))}this.coupleHierarchy=et(t.map(i=>lt(i,i.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=er.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=er.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),i=Io(this.LoosePolylinesUnderShape(e),o=>o).filter(o=>R.PointRelativeToCurveLocation(o,t)===0);if(i.length<=0)return t;let n=Array.from(t).concat(i);return ie.mkClosedFromPoints(Jr.CalculateConvexHull(n))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var ys=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,this._visGraph.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new Sr(Re);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source===this.source||this.targets.has(e.Target)||!ys.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target===this.source||!ys.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ar}ProcessNeighbor(e,t,i){let n=t.Length,o=this.current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),i!==this.source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!==this.source);return e.push(this.source),e.reverse()}};var jl=class{constructor(e,t,i){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=i,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new Sr(Re);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let i={priority:0},n=t.DequeueAndGetPriority(i);if(i.priority>=this._target.Distance)break;for(let o of n.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,n,o,a)}for(let o of n.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,n,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source===this._source||e.Target===this._target||!jl.IsForbidden(e)}PassableInEdge(e){return e.Source===this._target||e.Target===this._source||!jl.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ar}ProcessNeighborN(e,t,i,n,o){let a=i.Length+o,l=t.Distance+a;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&l<n.Distance&&(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}ProcessNeighbor(e,t,i,n){let o=i.Length,a=t.Distance+o;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&a<n.Distance&&(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,i=this._target;do t.push(i),e&&this._visGraph.ShrinkLengthOfPrevEdge(i,this.LengthMultiplier),i=this._visGraph.PreviosVertex(i);while(i!==this._source);return t.push(this._source),t.reverse()}};var Wv=Ae(or(),1),wd=class{toString(){return Wv.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var Hv=Ae(or(),1),Ld=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return Hv.String.Format("{0},{1}",this.Start,this.End)}};var Rd=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(m.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,i){return m.closeDistEps(e,m.ClosestPointAtLineSegment(e,t,i))}static IntersectDiagonalWithRay(e,t,i){let n=t.sub(e),o=i.Start,a=i.End,l=gn.solve(a.x-o.x,n.x*-1,e.x-o.x,a.y-o.y,n.y*-1,e.y-o.y);return e.add(n.mul(l.y))}};var Fo=class{constructor(e){this.pivot=e}IComparer(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=e.Start.point.sub(this.pivot),n=t.Start.point.sub(this.pivot);return Fo.CompareVectorsByAngleToXAxis(i,n)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Fo.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Fo.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let i=e.x*t.y-e.y*t.x;if(i>T.tolerance)return-1;if(i<-T.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let n=Math.abs(e.x)-Math.abs(t.x);return n<0?-1:n>0?1:(n=Math.abs(e.y)-Math.abs(t.y),n<0?-1:n>0?1:0)}};var Yn=class extends Pe{constructor(t,i,n){super(null);this.polygons=[];this.activeDiagonalComparer=new Rd;this.polygons=t,this.visibilityGraph=n,this.addedPolygons=i}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let t of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(t);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(t){this.currentPolygon=t,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new ct(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let t=1;t<this.tangents.length;t++){let i=this.tangents[t];i.Diagonal!=null?(i.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(i),i.IsHigh&&this.RemoveDiagonalFromActiveNodes(i.Diagonal)):i.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=i.End.point,this.InsertActiveDiagonal(new wd(i,i.Comp)),i.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(i))}}AddVisibleEdge(t){Ye.AddEdgeVV(jv(this.visibilityGraph,t.start),jv(this.visibilityGraph,t.End))}InitActiveDiagonals(){if(this.tangents.length===0)return;let t=this.tangents[0],i=t.start.point,n=t.End.point;for(let o of this.diagonals)Yn.RayIntersectDiagonal(i,n,o)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=Rd.IntersectDiagonalWithRay(i,n,o),this.InsertActiveDiagonal(o));if(t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsLow===!1){let o=t.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(t){let i=this.activeDiagonalTree.deleteSubTree(t.RbNode);i!=null&&i.item!=null&&(i.item.RbNode=i),t.LeftTangent.Diagonal=null,t.RightTangent.Diagonal=null}InsertActiveDiagonal(t){t.RbNode=this.activeDiagonalTree.insert(t),Yn.MarkDiagonalAsActiveInTangents(t)}static MarkDiagonalAsActiveInTangents(t){t.LeftTangent.Diagonal=t,t.RightTangent.Diagonal=t}static RayIntersectDiagonal(t,i,n){let o=n.Start,a=n.End;return m.getTriangleOrientation(t,o,a)===1&&m.getTriangleOrientation(t,i,o)!==1&&m.getTriangleOrientation(t,i,a)!==0}static TangentComparison(t,i){return Fo.CompareVectorsByAngleToXAxis(t.End.point.sub(t.start.point),i.End.point.sub(i.start.point))}*AllObstacles(){for(let t of this.addedPolygons)yield t;if(this.polygons)for(let t of this.polygons)yield t}OrganizeTangents(){for(let t of this.AllObstacles())t!==this.currentPolygon&&this.ProcessPolygonQ(t);this.tangents.sort(Yn.TangentComparison)}ProcessPolygonQ(t){let i=new Ea(this.currentPolygon,t);this.useLeftPTangents?i.CalculateLeftTangents():i.CalculateRightTangents();let n=this.useLeftPTangents?i.leftPLeftQ:i.rightPLeftQ,o=new Ld(this.currentPolygon.pp(n[0]),t.pp(n[1]));o.IsLow=!0,o.SeparatingPolygons=!this.useLeftPTangents,n=this.useLeftPTangents?i.leftPRightQ:i.rightPRightQ;let a=new Ld(this.currentPolygon.pp(n[0]),t.pp(n[1]));a.IsLow=!1,a.SeparatingPolygons=this.useLeftPTangents,o.Comp=a,a.Comp=o,this.tangents.push(o),this.tangents.push(a),this.diagonals.push(new wd(o,a))}};function jv(s,e){return s.FindVertex(e.point)}var Oc=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(m.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),i=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*i.y-i.x*t.y)<T.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,i){let n=gn.solve(t.x-e.x,-i.x,this.Pivot.x-e.x,t.y-e.y,-i.y,this.Pivot.y-e.y);if(!(-T.tolerance<=n.x&&n.x<=1+T.tolerance))throw new Error;if(!n)throw new Error;return this.Pivot.add(i.mul(n.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let i=new Oc;return i.pivot=e,i.pointOnTheRay=t,i}};var qv=Ae(or(),1),xa=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!==this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!==this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return qv.String.Format("Stem({0},{1})",this.Start,this.End)}};var En=class{constructor(e,t,i,n){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=i,this.qPolylinePoint=Mt.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=n;let o=new Fo(this.q);this.heapForSorting=new ha(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,i,n){let o=t.FindVertex(i);if(o!=null)return o;let a=new En(e,t,i,n);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!==0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let i=!1;for(let n of t.Sides()){let o=n;if(o.point.y<this.q.y){if(n.nextOnPolyline.point.y>=this.q.y){let a=m.getTriangleOrientation(this.q,o.point,n.nextOnPolyline.point);if(a===1||a===2){i=!0,yield new xa(t.Start,n),yield new xa(n.nextOnPolyline,t.End),this.RegisterActiveSide(n);break}}}else{if(o.point.y>this.q.y)break;if(n.point.x>=this.q.x){i=!0,yield new xa(n,t.End),n!==t.Start&&(yield new xa(t.Start,e.prev(o))),this.RegisterActiveSide(n);break}}}i||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new m(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=En.GetIncomingSide(e),i=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let n;if(n=this.sideNodes.get(t)){if(n===this.activeSidesTree.treeMinimum()&&this.AddEdge(e),i!=null)n.item=i,this.sideNodes.set(i,n);else{let o=this.activeSidesTree.deleteSubTree(n);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(i!=null){let o;(o=this.sideNodes.get(i))||(o=this.activeSidesTree.insert(i),this.sideNodes.set(i,o),o===this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind===0||this.visibilityKind===1&&En.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,i)=>new ar(t,i))}static LineTouchesPolygon(e,t){let i=t.polyline.prev(t).point,n=t.polyline.next(t).point,o=t.point;return m.signedDoubledTriangleArea(e,o,i)*m.signedDoubledTriangleArea(e,o,n)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e===t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Oc,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new ct(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,i=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))i=!1;let n=e.next(t);if(i)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,n);n=e.next(n));this.visibleBoundaries.set(e,new xa(t,n))}HoleSideIsVisibleFromQ(e,t){return m.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-T.squareOfDistanceEpsilon}};var Ke=class extends Pe{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=q.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}static constructorANNN(t,i,n,o){return Ke.constructorANNNB(t,i,n,o,!1)}get Obstacles(){return this.obstacles_}set Obstacles(t){this.obstacles_=t}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(t){this.enteringAngleBound_=t}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(t){this._sourceTightPolyline=t}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(t){this.targetTightPolyline=t}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(t){this.targetLoosePolyline=t}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(t){this.visibilityGraph=t}get SourcePort(){return this.sourcePort}set SourcePort(t){if(this.sourcePort=t,this.sourcePort!=null)if(this.SourceTightPolyline=Ke.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Pr)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let i=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(i.Curve,i.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(t){this.targetPort=t}get LoosePadding(){return this.loosePadding}set LoosePadding(t){this.loosePadding=t,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=t)}get OffsetForPolylineRelaxing(){return this.TightPadding*.75}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(t){this.startPointOfRouting_=t}ExtendVisibilityGraphToLocation(t){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ye);let i=null;if(!this.activeRectangle.contains(t)){this.activeRectangle.isEmpty?this.activeRectangle=q.mkPP(this.SourcePort.Location,t):this.activeRectangle.add(t),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of i)this.VisibilityGraph.AddHole(n.Polyline)}i==null||i.length===0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(t)):(this.RemovePointVisibilityGraphs(),new Yn(i,this.activePolygons,this.VisibilityGraph).run(),To(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraph(t),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(t){this.targetVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,t,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(t,i,n){let o=t.value(i),a=t.leftDerivative(i).normalize().add(t.rightDerivative(i).normalize()).normalize();m.getTriangleOrientation(Ke.PointInsideOfConvexCurve(t),o,o.add(a))==1&&(a=a.mul(-1)),a=a.rotate(Math.PI/2);let l=n.boundingBox.diagonal,u=G.mkPP(o,o.add(a.mul(l))),c=R.intersectionOne(u,n,!1).x,h=a.mul(c.sub(o).length/2);for(;;){u=G.mkPP(o,c.add(h));let d=!1;for(let f of Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(u,this.ObstacleCalculator.RootOfLooseHierarchy))if(f.seg1!==n){h=h.div(1.5),d=!0;break}if(!d)break}return u.end}static PointInsideOfConvexCurve(t){return t.value(0).add(t.value(1.5)).div(2)}*GetActivePolylines(){for(let t of this.activePolygons)yield t.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let t=this.activeRectangle,i=new Array,n;do{n=!1;for(let o of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(o)||(t.addRec(o.boundingBox),i.push(new $t(o)),this.alreadyAddedOrExcludedPolylines.add(o),n=!0);n&&(this.activeRectangle=t)}while(n);return i}PolylineSegmentIntersectsTightHierarchy(t,i){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(t,i,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(t,i,n){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(G.mkPP(t,i),n)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i){if(!t.boundingBox.intersects(i.irect))return!1;if(i.UserData!=null){for(let n of R.getAllIntersections(t,i.UserData,!1))if(n.seg1!==this.SourceTightPolyline&&n.seg1!==this.TargetTightPolyline||(n.seg1===this.SourceTightPolyline&&this.SourcePort)instanceof Or||(n.seg1===this.TargetTightPolyline&&this.TargetPort)instanceof Or)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,i){let n=new Array;return Ke.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i,n),n}static IntersectionsOfLineAndRectangleNodeOverPolyline(t,i,n){if(i!=null&&!!t.boundingBox.intersects(i.irect)){if(i.UserData!=null){To(n,R.getAllIntersections(t,i.UserData,!0));return}Ke.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i.Left,n),Ke.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i.Right,n)}}LineCanBeAcceptedForRouting(t){let i=this.SourcePort instanceof Pr,n=this.TargetPort instanceof Pr;if(!i&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(t.end,this.SourcePort)||!n&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(t.start,this.TargetPort))return!1;let o=Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy);for(let a of o)if(a.seg1!==this.SourceTightPolyline&&a.seg1!==this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(t,i){let n=i.Curve,o=er.CurveIsClockwise(n,Ke.PointInsideOfConvexCurve(n)),a=i.Location,l=this.GetPointOnTheRightBoundaryPortConeSide(a,n,o,i.Parameter),u=this.GetPointOnTheLeftBoundaryPortConeSide(a,n,o,i.Parameter);return m.getTriangleOrientation(a,l,t)!==0&&m.getTriangleOrientation(a,t,u)!==0}GetPointOnTheRightBoundaryPortConeSide(t,i,n,o){let a=n?i.rightDerivative(o):i.leftDerivative(o).neg();return t.add(a.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(t,i,n,o){let a=n?i.leftDerivative(o).neg():i.rightDerivative(o);return t.add(a.rotate(-this.EnteringAngleBound))}SmoothenCorners(t){let i=t.headSite,n={b:null,c:null};for(;n=R.findCorner(i);)i=this.SmoothOneCorner(i,n.c,n.b)}SmoothOneCorner(t,i,n){let l=.5,u,c,h;t.prev==null?(h=2,c=1):i.next==null?(h=1,c=2):h=c=1;do u=R.createBezierSeg(l*h,l*c,t,n,i),n.previouisBezierCoefficient=l*h,n.nextBezierCoefficient=l*c,l/=1.5;while(d()>this.loosePadding&&l>.01);return l*=1.5,l<.5&&l>.01&&(l=.5*(l+l*1.5),u=R.createBezierSeg(l*h,l*c,t,n,i),d()>this.loosePadding&&(n.previouisBezierCoefficient=l*h,n.nextBezierCoefficient=l*c)),n;function d(){let f=u.closestParameter(n.point);return n.point.sub(u.value(f)).length}}TryToRemoveInflectionsAndCollinearSegments(t){let i=!0,n={s:null};for(;i;)for(i=!1,n.s=t.headSite;n.s!=null&&n.s.next!=null;n.s=n.s.next)n.s.turn*n.s.next.turn<0&&(i=this.TryToRemoveInflectionEdge(n)||i)}TryToRemoveInflectionEdge(t){if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.prev.point,t.s.next.point)){let i=t.s.prev,n=t.s.next;return i.next=n,n.prev=i,t.s=i,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.prev.point,t.s.next.next.point)){let i=t.s.prev,n=t.s.next.next;return i.next=n,n.prev=i,t.s=i,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.point,t.s.next.next.point)){let i=t.s.next.next;return t.s.next=i,i.prev=t.s,!0}return!1}GetShortestPolyline(t,i){this.CleanTheGraphForShortestPath();let o=new jl(this.visibilityGraph,t,i).GetPath(this.UseEdgeLengthMultiplier);if(o==null)return null;let a=new ie;for(let l of o)a.addPoint(l.point);return a=a.RemoveCollinearVertices(),this.pathOptimizer?(this.pathOptimizer.run(a,this.SourceLoosePolyline,this.targetLoosePolyline),this.pathOptimizer.poly):a}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(t){this.ObstacleCalculator.RootOfTightHierarchy=t}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(t){this.ObstacleCalculator.RootOfLooseHierarchy=t}CalculateObstacles(){this.ObstacleCalculator=new er(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}static constructorANNNB(t,i,n,o,a){let l=new Ke(null);return l.IgnoreTightPadding=a,l.EnteringAngleBound=80*(Math.PI/180),l.TightPadding=i,l.LoosePadding=n,o>0?(De.assert(o>Math.PI/180),De.assert(o<=90*(Math.PI/180)),l.UseSpanner=!0,l.ExpectedProgressSteps=Bo.GetTotalSteps(o)):l.ExpectedProgressSteps=t.length,l.ConeSpannerAngle=o,l.Obstacles=t,l.CalculateObstacles(),l}RouteEdgeToLocation(t){this.TargetPort=new Pr(null,t),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let i=new We(null),n=G.mkPP(this.SourcePort.Location,t);return this.LineCanBeAcceptedForRouting(n)?(this._polyline=new ie,this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),i.smoothedPolyline=nt.mkFromPoints(this._polyline),i.curve=i.smoothedPolyline.createCurve(),i):this.SourcePort instanceof Or&&(n=G.mkPP(this.StartPointOfEdgeRouting,t),Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(n,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new ie,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),i.smoothedPolyline=nt.mkFromPoints(this._polyline),i.curve=i.smoothedPolyline.createCurve(),i):(this.ExtendVisibilityGraphToLocation(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.SourcePort instanceof Or&&this._polyline.PrependPoint(this.SourcePort.Location),i.smoothedPolyline=nt.mkFromPoints(this._polyline),i.curve=i.smoothedPolyline.createCurve(),i)}RouteEdgeToPort(t,i,n,o){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(o.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),G.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=t,this.TargetTightPolyline=Ke.GetFirstHitPolyline(t.Location,this.ObstacleCalculator.RootOfTightHierarchy),t instanceof Or?this.RouteEdgeToBoundaryPort(i,n,o):this.RouteEdgeToFloatingPortOfNode(i,n,o))}SmoothedPolylineFromTwoPoints(t,i){return this._polyline=new ie,this._polyline.addPoint(t),this._polyline.addPoint(i),nt.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(t,i,n){return this.sourcePort instanceof Pr?this.RouteFromFloatingPortToFloatingPort(t,i,n):this.RouteFromBoundaryPortToFloatingPort(t,i,n)}RouteFromBoundaryPortToFloatingPort(t,i,n){let o=this.SourcePort.Location,a=this.targetPort.Location,l=G.mkPP(o,a);if(this.LineCanBeAcceptedForRouting(l))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),l;if(!this.targetIsInsideOfSourceTightPolyline){let c=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(l=G.mkPP(c,a),this.LineAvoidsTightHierarchyLP(l,t))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),l}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let u=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=u,this._polyline.PrependPoint(o),this.SmoothCornersAndReturnCurve(i,n)}SmoothCornersAndReturnCurve(t,i){return i.smoothedPolyline=nt.mkFromPoints(this._polyline),t&&this.SmoothenCorners(i.smoothedPolyline),i.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(t,i,n){let o=this.TargetPort.Location,a=G.mkPP(this.StartPointOfEdgeRouting,o);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(a,this.SourceTightPolyline,this.targetTightPolyline)?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),n.smoothedPolyline=nt.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(i,n)))}TryShortcutPolyline(){}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let t=this._polyline.endPoint,i=t.prev;if(i==null)return!1;let n=i.prev;if(n==null)return!1;if(this.LineAvoidsTightHierarchyPPPP(t.point,n.point,this._sourceTightPolyline,this.targetTightPolyline))return t.prev=n,n.next=t,t.polyline.setInitIsRequired(),!0;let o=m.middle(i.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(t.point,o,this._sourceTightPolyline,this.targetTightPolyline)){let a=Mt.mkFromPoint(o);return a.next=t,a.prev=n,t.prev=a,n.next=a,t.polyline.setInitIsRequired(),!0}return!1}TryShortcutPolylineStart(){let t=this._polyline.startPoint,i=t.next;if(i==null)return;let n=i.next;if(n==null)return;if(this.LineAvoidsTightHierarchyPPPP(t.point,n.point,this._sourceTightPolyline,this.targetTightPolyline))return t.next=n,n.prev=t,t.polyline.setInitIsRequired(),!0;let o=m.middle(i.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(t.point,o,this._sourceTightPolyline,this.targetTightPolyline)){let a=Mt.mkFromPoint(o);return a.prev=t,a.next=n,t.next=a,n.prev=a,t.polyline.setInitIsRequired(),!0}}ShortcutPolylineOneTime(){let t=!1;for(let i=this._polyline.startPoint;i.next!=null&&i.next.next!=null;i=i.next)t=t||this.TryShortcutPolyPoint(i);return t}TryShortcutPolyPoint(t){return this.LineAvoidsTightHierarchyLPP(G.mkPP(t.point,t.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(t.next=t.next.next,t.next.prev=t,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(t){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ye);let i=null,n=this.targetPort.Location;if(!this.activeRectangle.contains(n)){this.activeRectangle.isEmpty?this.activeRectangle=q.mkPP(this.SourcePort.Location,n):this.activeRectangle.add(n),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let o of i)this.VisibilityGraph.AddHole(o.Polyline)}i==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,t),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new Yn(i,this.activePolygons,this.VisibilityGraph).run(),To(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,t),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(t,i){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(t,i):this.targetVV=En.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(i),this.VisibilityGraph,t,1)}AddTransientVisibilityEdgesForPort(t,i){let n=this.GetVertex(t);if(n!=null)return n;if(n=this.visibilityGraph.AddVertexP(t),i!=null)for(let o of i)this.visibilityGraph.AddEdgeF(t,o,(a,l)=>new ar(a,l));else n=En.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,t,1);return n}GetVertex(t){let i=this.visibilityGraph.FindVertex(t);return i==null&&this.LookForRoundedVertices&&(i=this.visibilityGraph.FindVertex(T.RoundPoint(t))),i}*GetActivePolylinesWithException(t){for(let i of this.activePolygons)i.Polyline!==t&&(yield i.Polyline)}RouteEdgeToBoundaryPort(t,i,n){return this.TargetLoosePolyline=t,this.sourcePort instanceof Pr?this.RouteFromFloatingPortToBoundaryPort(i,n):this.RouteFromBoundaryPortToBoundaryPort(i,n)}RouteFromBoundaryPortToBoundaryPort(t,i){let n=this.SourcePort.Location,o,a=this.targetPort.Location,l=G.mkPP(n,a);if(this.LineCanBeAcceptedForRouting(l))this._polyline=new ie,this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),o=nt.mkFromPoints(this._polyline).createCurve();else{let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(l=G.mkPP(n,u),this.InsideOfTheAllowedConeOfBoundaryPort(u,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(l,this._sourceTightPolyline))this._polyline=new ie,this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(l=G.mkPP(this.StartPointOfEdgeRouting,a),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(l))this._polyline=new ie,this._polyline.addPoint(n),this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),o=this.SmoothCornersAndReturnCurve(t,i);else{let c;if(c=G.IntersectPPPP(n,this.StartPointOfEdgeRouting,a,u))this._polyline=new ie,this._polyline.addPoint(n),this._polyline.addPoint(c),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(m.closeDistEps(this.StartPointOfEdgeRouting,u))this._polyline=new ie,this._polyline.addPoint(n),this._polyline.addPoint(u),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(this.LineAvoidsTightHierarchy(G.mkPP(this.StartPointOfEdgeRouting,u)))this._polyline=new ie,this._polyline.addPoint(n),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(u),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else{this.ExtendVisibilityGraphToTargetBoundaryPort(u),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let h={tmpTargetTight:null},d=this.HideSourceTargetTightsIfNeeded(h);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(d,h.tmpTargetTight),this._polyline.PrependPoint(n),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i)}}}return o}RecoverSourceTargetTights(t,i){this.SourceTightPolyline=t,this.TargetTightPolyline=i}HideSourceTargetTightsIfNeeded(t){let i=this.SourceTightPolyline;return t.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,i}LineAvoidsTightHierarchy(t){return Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy).length===0}RouteFromFloatingPortToBoundaryPort(t,i){let n=this.targetPort.Location,o;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(o=G.mkPP(this.SourcePort.Location,n),this.LineCanBeAcceptedForRouting(o)))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o;let a=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(o=G.mkPP(this.SourcePort.Location,a),this.LineAvoidsTightHierarchyLP(o,this._sourceTightPolyline))return this._polyline=ie.mkFromPoints([o.start,o.end,n]),i.smoothedPolyline=nt.mkFromPoints(this._polyline),i.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(a),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline.addPoint(n);let l={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(t,l)}LineAvoidsTightHierarchyLP(t,i){let n=!0;for(let o of Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy))if(o.seg1!==i){n=!1;break}return n}LineAvoidsTightHierarchyLPP(t,i,n){let o=!0;for(let a of Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy))if(!(a.seg1===i||a.seg1===n)){o=!1;break}return o}LineAvoidsTightHierarchyPPPP(t,i,n,o){return this.LineAvoidsTightHierarchyLPP(G.mkPP(t,i),n,o)}ExtendVisibilityGraphToTargetBoundaryPort(t){let i=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new Ye),!this.activeRectangle.contains(t)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(t)):(this.activeRectangle.add(t),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of i)this.VisibilityGraph.AddHole(n.Polyline)}i==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(t)):(this.RemovePointVisibilityGraphs(),new Yn(i,this.activePolygons,this.VisibilityGraph).run(),To(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraph(t),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(t){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:Ke.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(t,i){let n=Ke.GetFirstHitRectangleNode(t,i);return n?n.UserData:null}static GetFirstHitRectangleNode(t,i){return i==null?null:i.FirstHitNodePF(t,(n,o)=>R.PointRelativeToCurveLocation(n,o)!==0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(t,i){this.SourceLoosePolyline=i,this.sourcePort=t,this.sourcePort!=null&&(this.SourceTightPolyline=Ke.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Pr?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new Ye,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let i of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(i);let t;this.UseSpanner?t=new Bo(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):t=new Yn(new Array,this.activePolygons,this.visibilityGraph),t.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(t,i,n,o){let a=t instanceof Pr&&i instanceof Or||t instanceof Ft;if(a){let u=t;t=i,i=u}this.sourcePort=t,this.targetPort=i,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let l=this.GetEdgeGeomByRouting(n,o);return l==null?null:(this.targetVV=null,this.sourceVV=null,a&&(l=l.reverse()),l)}GetEdgeGeomByRouting(t,i){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||R.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)===2;let n;if(this.sourcePort instanceof Or){let o=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?o.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(o.Curve,o.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let a={smoothedPolyline:null};this.targetPort instanceof Or?n=this.RouteFromBoundaryPortToBoundaryPort(t,a):n=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,t,a)}else this.targetPort instanceof Pr?(this.ExtendVisibilityGraphFromFloatingSourcePort(),n=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,t,i)):n=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,t,i,this.targetPort);return n}RouteFromFloatingPortToAnywherePort(t,i,n,o){return o.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(t))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.FixLastPolylinePointForAnywherePort(o),o.HookSize>0&&this.BuildHook(o),this.SmoothCornersAndReturnCurve(i,n))):(n.smoothedPolyline=null,null)}BuildHook(t){let i=t.Curve,n=be.mkFullEllipseNNP(t.HookSize,t.HookSize,this._polyline.end),o=R.getAllIntersections(i,n,!0);m.getTriangleOrientation(o[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&o.reverse();let a=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),l=i.derivative(o[0].par0).normalize(),u=l.dot(a);if(Math.abs(u)<.2)this.ExtendPolyline(l,o[0],a,t);else{let c=i.derivative(o[1].par0).normalize();c.dot(a)<u?this.ExtendPolyline(c,o[1],a,t):this.ExtendPolyline(l,o[0],a,t)}}ExtendPolyline(t,i,n,o){let a=t.rotate(Math.PI/2);a.dot(n)<0&&(a=a.neg());let l=i.x.add(a.mul(o.HookSize)),u;!(u=m.lineLineIntersection(l,l.add(t),this._polyline.end,this._polyline.end.add(n)))||(this._polyline.addPoint(u),this._polyline.addPoint(l),this._polyline.addPoint(i.x))}FixLastPolylinePointForAnywherePort(t){for(;;){let i=this.GetLastPointInsideOfCurveOnPolyline(t.Curve);i.next.next=null,this._polyline.endPoint=i.next;let n=i.next.point.sub(i.point);n=n.normalize().mul(t.Curve.boundingBox.diagonal);let o=n.rotate(t.AdjustmentAngle*-1),a=n.rotate(t.AdjustmentAngle),l=R.intersectionOne(t.Curve,G.mkPP(i.point,i.point.add(o)),!0),u=R.intersectionOne(t.Curve,G.mkPP(i.point,i.point.add(a)),!0);if(l==null||u==null)return;let c=Ke.GetTrimmedCurveForHookingUpAnywhere(t.Curve,i,l,u),h=c.value(c.closestParameter(i.point));if(!this.LineAvoidsTightHierarchyLPP(G.mkPP(i.point,h),this.SourceTightPolyline,null)){let d=R.intersectionOne(t.Curve,G.mkPP(i.point,i.next.point),!1);if(d==null)return;this._polyline.endPoint.point=d.x;break}if(this._polyline.endPoint.point=h,i.prev==null||!this.TryShortcutPolyPoint(i.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(t,i,n,o){let a=m.getTriangleOrientation(o.x,n.x,i.point)===0,l=n.par0,u=o.par0,c,h,d;return a?l<u?t.trim(l,u):(h=t.trim(l,t.parEnd),c=t.trim(t.parStart,u),d=new R,d.addSegs([h,c])):u<l?t.trim(u,l):(h=t.trim(u,t.parEnd),c=t.trim(t.parStart,l),d=new R,d.addSegs([h,c]))}GetLastPointInsideOfCurveOnPolyline(t){for(let i=this._polyline.endPoint.prev;i!=null;i=i.prev)if(i.prev==null||R.PointRelativeToCurveLocation(i.point,t)===2)return i;throw new Error}GetShortestPolylineToMulitpleTargets(t,i){this.CleanTheGraphForShortestPath();let o=new ys(t,i,this.VisibilityGraph).GetPath();if(o==null)return null;let a=new ie;for(let l of o)a.addPoint(l.point);return a.RemoveCollinearVertices()}Targets(t){return Array.from(t).map(i=>this.visibilityGraph.FindVertex(i))}ExtendVisibilityGraphFromFloatingSourcePort(){let t=this.sourcePort;this.StartPointOfEdgeRouting=t.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(i=>i!==this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let t=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=Ke.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=Ke.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy),t=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=Ke.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=Ke.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=q.mkPP(new m(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new m(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let t of this.ObstacleCalculator.LooseObstacles)yield new $t(t)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(t){To(this.activePolygons,t)}ClearActivePolygons(){this.activePolygons=[]}};var oC=Ae(kn(),1);var Kn=class{constructor(){this.size_=0;this.mapOfMaps=new bt}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let i=e._first,n=e._second,o=this.mapOfMaps.get(i);o==null&&this.mapOfMaps.set(i,o=new bt),o.has(n)||this.size_++,o.set(n,t)}delete(e){let t=e._first,i=e._second,n=this.mapOfMaps.get(t);n!=null&&n.deleteP(i)&&this.size_--}has(e){let t=this.mapOfMaps.get(e._first);return t!=null&&t.has(e._second)}get_(e,t){return this.get(new pt(e,t))}get(e){let t=this.mapOfMaps.get(e._first);if(t!=null)return t.get(e._second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new pt(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[i,n]of t)yield[new pt(e,i),n]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var _c=class{static constructorStatic(e,t){let i=new _c;i.edges=e,i.nodeBoundaries=t,i.boundingBox=q.mkEmpty();for(let n of i.nodeBoundaries)i.boundingBox=i.boundingBox.addRec(n.boundingBox);return i}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=Un(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var rC=Ae(mn(),1);var Xv=Ae(or(),1);var dm=class{constructor(e,t){this.constrained=!1;this.Capacity=1e6;je.AbovePP(e.point,t.point)===1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e===this.upperSite||e===this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle===e?this.cwTriangle:this.ccwTriangle}toString(){return Xv.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite===e?this.lowerSite:this.upperSite}};var va=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let i=new va(e);return i.Owner=t,i}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite===e)return t}return null}AddInEdge(e){this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let i=t.upperSite===this?t.CcwTriangle:t.CwTriangle;if(i==null){t=null;break}yield i,t=i.Edges.getItem(i.Edges.index(t)+2)}while(t!==e);if(t!==e){t=e;do{let i=t.upperSite===this?t.CwTriangle:t.CcwTriangle;if(i==null)break;yield i,t=i.Edges.getItem(i.Edges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var p0=Ae(mn(),1);var Go=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite===e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var Od=class{has(e){return e===this.item0||e===this.item1||e===this.item2}index(e){return e===this.item0?0:e===this.item1?1:e===this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var lr=class{constructor(){this.Edges=new Od;this.Sites=new Od}containsPoint(e){return lr.PointLocationForTriangle(e,this)!==0}static PointLocationForTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<-T.distanceEpsilon)return 0;o<T.distanceEpsilon&&(i=!0)}return i?1:2}intersectsLine(e,t){if(lr.PointLocationForTriangle(e,this)!=0||lr.PointLocationForTriangle(t,this)!=0)return!0;for(let i of this.Edges)if(G.IntersectPPPP(e,t,i.lowerSite.point,i.upperSite.point))return!0;return!1}static mkSSSD(e,t,i,n){let o=m.getTriangleOrientation(e.point,t.point,i.point),a=new lr;switch(o){case 1:a.FillCcwTriangle(e,t,i,n);break;case 0:a.FillCcwTriangle(e,i,t,n);break;default:throw new Error}return a}static mkSED(e,t,i){let n=new lr;switch(m.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=n,n.Sites.setItem(0,t.upperSite),n.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=n,n.Sites.setItem(0,t.lowerSite),n.Sites.setItem(1,t.upperSite);break;default:throw new Error}return n.Edges.setItem(0,t),n.Sites.setItem(2,e),n.CreateEdge(1,i),n.CreateEdge(2,i),n}static mkSSSEE(e,t,i,n,o,a){let l=lr.mkSSSD(e,t,i,a);return l.Edges.setItem(0,n),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e===t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,i,n){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,i);for(let o=0;o<3;o++)this.CreateEdge(o,n)}CreateEdge(e,t){let i=this.Sites.getItem(e),n=this.Sites.getItem(e+1),o=t(i,n);this.Edges.setItem(e,o),this.BindEdgeToTriangle(i,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.Edges.getItem(t+1)}OppositeSite(e){let t=this.Edges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=q.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,i,n,o,a){let l=new lr;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,i),l.Edges.setItem(0,n),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var fm=class{constructor(e,t,i,n,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.leftPolygon=n,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(m.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite===this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,i=(o=t.CcwTriangle)!=null?o:t.CwTriangle,n=i.Edges.index(t);for(let a=1;a<=2;a++){let l=i.Edges.getItem(a+n),u=Xi.sign(m.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(Xi.sign(m.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=i,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.Edges)if(t.CcwTriangle==null&&t.CwTriangle==null){let i=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,n=jt.FindNodeInFrontBySite(this.front,i);n.item.Edge===t&&this.elementsToBeRemovedFromFront.push(n.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle===this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var i,n;let e=(i=this.piercedEdge.CwTriangle)!=null?i:this.piercedEdge.CcwTriangle,t=e.Edges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.Edges.getItem(o+t),l=Xi.sign(m.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(Xi.sign(m.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=jt.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((n=a.CwTriangle)!=null?n:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.Edges)t.CwTriangle===e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(m.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite===this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!==this.b&&(t.length===0||t[t.length-1]!==e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=jt.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(m.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(m.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let i of this.a.Edges){let n=i.CcwTriangle;if(n==null||m.pointToTheLeftOfLine(this.b.point,i.lowerSite.point,i.upperSite.point))continue;let o=n.Edges.index(i),a=n.Sites.getItem(o+2);if(m.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,i.upperSite.point)){this.piercedEdge=n.Edges.getItem(o+1),this.piercedTriangle=n;break}}}};var Nc=class{constructor(e,t,i,n){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.createEdgeDelegate=n}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let i of t.Edges)(i.CwTriangle==null||i.CcwTriangle==null)&&e.add(i);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new Go(t,e))}TriangulatePolygon0(e,t,i,n){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,i,n)}TriangulatePolygon1(e,t,i,n,o,a){let l=i[e],u=e;for(let h=e+1;h<=t;h++){let d=i[h];Nc.LocalInCircle(d,n,o,l,a)&&(u=h,l=d)}let c=lr.mkSSSD(n,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,i,n,l,a),u<t&&this.TriangulatePolygon1(u+1,t,i,l,o,a)}static LocalInCircle(e,t,i,n,o){return o?gm(e,t,n,i):gm(e,t,i,n)}TraceEdgeThroughTriangles(){new fm(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var _d=class{constructor(e){this.Edge=e}};var jt=class extends Pe{constructor(t,i,n,o){super(null);this.front=new ct((t,i)=>t.x-i.x);this.triangles=new Set;if(this.listOfSites=t,this.listOfSites.length===0)return;this.p_1=i,this.p_2=n,this.createEdgeDelegate=o;let a=lr.mkSSSD(i,n,this.listOfSites[0],o);this.triangles.add(a),this.front.insert(new Go(i,a.Edges.getItem(2))),this.front.insert(new Go(this.listOfSites[0],a.Edges.getItem(1)))}run(){if(this.listOfSites.length!==0){for(let t=1;t<this.listOfSites.length;t++)this.ProcessSite(this.listOfSites[t]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let t=this.CreateDoubleLinkedListOfPerimeter();do{let i=this.FindConcaveEdge(t);if(i==null)return;t=this.ShortcutTwoListElements(i)}while(!0)}FindConcaveEdge(t){let i=t,n;do{if(n=i.Next,m.getTriangleOrientation(i.Start.point,i.End.point,n.End.point)===1)return i;i=n}while(n!==t);return null}static FindPivot(t){let i=t,n=t;do n=n.Next,(n.Start.point.x<i.Start.point.x||n.Start.point.x===i.Start.point.x&&n.Start.point.y<i.Start.point.y)&&(i=n);while(n!==t);return i}FindFirsePerimeterEdge(){for(let t of this.triangles)for(let i of t.Edges)if(i.GetOtherTriangle_T(t)==null)return i;return null}CreateDoubleLinkedListOfPerimeter(){let t=this.FindFirsePerimeterEdge(),i=t,n=null,o,a=null,l=new Array;do o=jt.CreatePerimeterElementFromEdge(i),l.push(G.mkPP(o.Start.point,o.End.point)),i=jt.FindNextEdgeOnPerimeter(i),a!=null?(o.Prev=a,a.Next=o):n=o,a=o;while(i!==t);return n.Prev=o,o.Next=n,n}static FindNextEdgeOnPerimeter(t){var n;let i=(n=t.CwTriangle)!=null?n:t.CcwTriangle;for(t=i.Edges.getItem(i.Edges.index(t)+2);t.CwTriangle!=null&&t.CcwTriangle!=null;)i=t.GetOtherTriangle_T(i),t=i.Edges.getItem(i.Edges.index(t)+2);return t}static CreatePerimeterElementFromEdge(t){let i=new _d(t);return t.CwTriangle!=null?(i.Start=t.upperSite,i.End=t.lowerSite):(i.End=t.upperSite,i.Start=t.lowerSite),i}RemoveP1AndP2Triangles(){let t=new Set;for(let i of this.triangles)(i.Sites.has(this.p_1)||i.Sites.has(this.p_2))&&t.add(i);for(let i of t)jt.RemoveTriangleWithEdges(this.triangles,i)}static RemoveTriangleWithEdges(t,i){t.delete(i);for(let n of i.Edges)n.CwTriangle===i?n.CwTriangle=null:n.CcwTriangle=null,n.CwTriangle==null&&n.CcwTriangle==null&&m0(n.upperSite.Edges,n)}static RemoveTriangleButLeaveEdges(t,i){t.delete(i);for(let n of i.Edges)n.CwTriangle===i?n.CwTriangle=null:n.CcwTriangle=null}ProcessSite(t){this.PointEvent(t);for(let i=0;i<t.Edges.length;i++){let n=t.Edges[i];n.constrained&&this.EdgeEvent(n)}}EdgeEvent(t){if(jt.EdgeIsProcessed(t))return;new Nc(t,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(t){return t.CwTriangle!=null||t.CcwTriangle!=null}ShowFrontWithSite(t,i=null){let n=new Array;if(t.Edges!=null)for(let o of t.Edges)n.push(pe.mkDebugCurveTWCI(200,.8,o.constrained?"Pink":"Brown",G.mkPP(o.upperSite.point,o.lowerSite.point)));n.push(pe.mkDebugCurveTWCI(200,1,"Brown",be.mkFullEllipseNNP(.5,.5,t.point)));for(let o of this.triangles)for(let a=0;a<3;a++){let l=o.Edges.getItem(a);n.push(pe.mkDebugCurveTWCI(l.constrained?155:100,l.constrained?.8:.4,l.constrained?"Pink":"Navy",G.mkPP(l.upperSite.point,l.lowerSite.point)))}if(i!=null)for(let o of i)n.push(pe.mkDebugCurveTWCI(100,.5,"Red",o));for(let o of this.front)n.push(pe.mkDebugCurveTWCI(100,5.5,"Green",G.mkPP(o.Edge.upperSite.point,o.Edge.lowerSite.point)))}Show(t){jt.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],t)}static ShowCdt(t,i,n,o,a,l){let u=new Array;if(n!=null)for(let c of n)u.push(pe.mkDebugCurveTWCI(200,.1,"Red",c));if(o!=null)for(let c of o)u.push(pe.mkDebugCurveTWCI(200,.1,"Blue",c));if(i!=null)for(let c of i)u.push(pe.mkDebugCurveTWCI(200,.1,"Green",G.mkPP(c.Edge.upperSite.point,c.Edge.lowerSite.point)));for(let c of t)for(let h=0;h<3;h++){let d=c.Edges.getItem(h);u.push(jt.GetDebugCurveOfCdtEdge(d))}u=u.concat(a)}static GetDebugCurveOfCdtEdge(t){return t.CcwTriangle==null||t.CwTriangle==null?pe.mkDebugCurveTWCI(255,.5,t.constrained?"Brown":"Black",G.mkPP(t.upperSite.point,t.lowerSite.point)):pe.mkDebugCurveTWCI(200,t.constrained?.8:.2,t.constrained?"Pink":"Navy",G.mkPP(t.upperSite.point,t.lowerSite.point))}PointEvent(t){let i=this.ProjectToFront(t),n={rightSite:null},o=i.item.x+T.distanceEpsilon<t.point.x?this.MiddleCase(t,i,n):this.LeftCase(t,i,n),a=this.InsertSiteIntoFront(o,t,n.rightSite);this.TriangulateEmptySpaceToTheRight(a),a=jt.FindNodeInFrontBySite(this.front,o),this.TriangulateEmptySpaceToTheLeft(a)}LeftCase(t,i,n){let o=i.item;this.InsertAndLegalizeTriangle(t,o);let a=this.front.previous(i),l=a.item.LeftSite;n.rightSite=i.item.RightSite,this.InsertAndLegalizeTriangle(t,a.item),this.front.deleteNodeInternal(a);let u=this.front.remove(o);return l}MiddleCase(t,i,n){let o=i.item.LeftSite;return n.rightSite=i.item.RightSite,this.InsertAndLegalizeTriangle(t,i.item),this.front.deleteNodeInternal(i),o}TriangulateEmptySpaceToTheLeft(t){let i=t.item.RightSite,n=this.front.previous(t);for(;n!=null;){let o=n.item,a=o.LeftSite,l=o.RightSite;if(l.point.sub(i.point).dot(a.point.sub(l.point))<0)t=this.ShortcutTwoFrontElements(n,t),n=this.front.previous(t);else{this.TryTriangulateBasinToTheLeft(t);break}}}ShortcutTwoListElements(t){var l;let i=t.Next,n=lr.mkSSSEE(t.Start,t.End,i.End,t.Edge,i.Edge,this.createEdgeDelegate);this.triangles.add(n);let o=n.Edges.getItem(2);this.LegalizeEdge(t.Start,n.OppositeEdge(t.Start)),n=(l=o.CcwTriangle)!=null?l:o.CwTriangle,this.LegalizeEdge(i.End,n.OppositeEdge(i.End));let a=new _d(o);return a.Start=t.Start,a.End=i.End,t.Prev.Next=a,a.Prev=t.Prev,a.Next=i.Next,i.Next.Prev=a,a}ShortcutTwoFrontElements(t,i){var u;let n=t.item,o=i.item,a=lr.mkSSSEED(n.LeftSite,n.RightSite,o.RightSite,n.Edge,o.Edge,this.createEdgeDelegate);this.triangles.add(a),this.front.deleteNodeInternal(t),this.front.remove(o);let l=a.Edges.getItem(2);return this.LegalizeEdge(n.LeftSite,a.OppositeEdge(n.LeftSite)),a=(u=l.CcwTriangle)!=null?u:l.CwTriangle,this.LegalizeEdge(o.RightSite,a.OppositeEdge(o.RightSite)),this.front.insert(new Go(n.LeftSite,l))}TryTriangulateBasinToTheLeft(t){if(!jt.DropsSharpEnoughToTheLeft(t.item))return;let i=new p0.Stack;for(i.push(t.item.LeftSite);;){let n=i.pop();t=jt.FindNodeInFrontBySite(this.front,n);let o=this.front.previous(t);if(o==null)return;if(m.getTriangleOrientation(o.item.LeftSite.point,t.item.LeftSite.point,t.item.RightSite.point)==1)i.push(o.item.LeftSite),this.ShortcutTwoFrontElements(o,t);else if(t.item.LeftSite.point.y>t.item.RightSite.point.y)i.push(o.item.LeftSite);else{if(o.item.LeftSite.point.y<=o.item.RightSite.point.y)return;i.push(o.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(t){let i=t.Edge;if(t.RightSite!==i.upperSite)return!1;let n=i.lowerSite.point.sub(i.upperSite.point);return n.x>=.5*n.y}InsertSiteIntoFront(t,i,n){let o=null,a=null;for(let l of i.Edges)if(a==null&&l.lowerSite===t&&(a=l),o==null&&l.lowerSite===n&&(o=l),a!=null&&o!=null)break;return this.front.insert(new Go(t,a)),this.front.insert(new Go(i,o))}TriangulateEmptySpaceToTheRight(t){let n=t.item.LeftSite.point,o=this.front.next(t);for(;o!=null;){let a=o.item,l=a.LeftSite,u=a.RightSite;if(l.point.sub(n).dot(u.point.sub(l.point))<0)t=this.ShortcutTwoFrontElements(t,o),o=this.front.next(t);else{this.TryTriangulateBasinToTheRight(t);break}}}TryTriangulateBasinToTheRight(t){if(!jt.DropsSharpEnoughToTheRight(t.item))return;let i=new p0.Stack;for(i.push(t.item.LeftSite);;){let n=i.pop();t=jt.FindNodeInFrontBySite(this.front,n);let o=this.front.next(t);if(o==null)return;if(m.getTriangleOrientation(t.item.LeftSite.point,t.item.RightSite.point,o.item.RightSite.point)==1)this.ShortcutTwoFrontElements(t,o),i.push(n);else if(t.item.LeftSite.point.y>t.item.RightSite.point.y)i.push(t.item.RightSite);else{if(o.item.LeftSite.point.y>=o.item.RightSite.point.y)return;i.push(t.item.RightSite)}}}static DropsSharpEnoughToTheRight(t){let i=t.Edge;if(t.LeftSite!==i.upperSite)return!1;let n=i.lowerSite.point.sub(i.upperSite.point);return n.x<=-.5*n.y}static FindNodeInFrontBySite(t,i){return t.findLast(n=>n.LeftSite.point.x<=i.point.x)}InsertAndLegalizeTriangle(t,i){var n;if(m.getTriangleOrientation(t.point,i.LeftSite.point,i.RightSite.point)!==2){let o=lr.mkSED(t,i.Edge,this.createEdgeDelegate);this.triangles.add(o),this.LegalizeEdge(t,o.Edges.getItem(0))}else{let o=i.Edge;m0(o.upperSite.Edges,o);let a=(n=o.CcwTriangle)!=null?n:o.CwTriangle,l=a.OppositeSite(o);jt.RemoveTriangleButLeaveEdges(this.triangles,a),a=lr.mkSSSD(i.LeftSite,l,t,this.createEdgeDelegate);let u=lr.mkSSSD(i.RightSite,l,t,this.createEdgeDelegate);this.triangles.add(a),this.triangles.add(u),this.LegalizeEdge(t,a.OppositeEdge(t)),this.LegalizeEdge(t,u.OppositeEdge(t))}}LegalizeEdge(t,i){i.constrained||i.CcwTriangle==null||i.CwTriangle==null||(i.CcwTriangle.Contains(t)?this.LegalizeEdgeForOtherCwTriangle(t,i):this.LegalizeEdgeForOtherCcwTriangle(t,i))}LegalizeEdgeForOtherCwTriangle(t,i){let n=i.CwTriangle.Edges.index(i);if(Yv(t,i.upperSite,i.CwTriangle.Sites.getItem(n+2),i.lowerSite)){let o=Kv(t,i);this.LegalizeEdge(t,o.CwTriangle.OppositeEdge(t)),this.LegalizeEdge(t,o.CcwTriangle.OppositeEdge(t))}}LegalizeEdgeForOtherCcwTriangle(t,i){let n=i.CcwTriangle.Edges.index(i);if(Yv(t,i.lowerSite,i.CcwTriangle.Sites.getItem(n+2),i.upperSite)){let o=Kv(t,i);this.LegalizeEdge(t,o.CwTriangle.OppositeEdge(t)),this.LegalizeEdge(t,o.CcwTriangle.OppositeEdge(t))}}ProjectToFront(t){return this.front.findLast(i=>i.x<=t.point.x)}};function m0(s,e){if(s.length===0)return;let t=s.findIndex(i=>e===i);t>=0&&(t!==s.length-1&&(s[t]=s[s.length-1]),s.pop())}function Yv(s,e,t,i){return p2(s,e,t,i)&&gm(s,e,t,i)}function p2(s,e,t,i){return m.getTriangleOrientation(e.point,s.point,t.point)===0&&m.getTriangleOrientation(t.point,s.point,i.point)===0}function gm(s,e,t,i){let n=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=i.point.x-s.point.x,c=i.point.y-s.point.y,h=n*n+o*o,d=a*a+l*l,f=u*u+c*c;return n*(l*f-c*d)-a*(o*f-c*h)+u*(o*d-l*h)>T.tolerance}function Kv(s,e){let t,i;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,i=e.CwTriangle):(t=e.CwTriangle,i=e.CcwTriangle);let n=t.Edges.index(e),o=i.Edges.index(e),a=i.Sites.getItem(o+2),l=t.Edges.getItem(n+1),u=i.Edges.getItem(o+1),c=je.GetOrCreateEdge(s,a);return t.Sites.setItem(n+1,a),t.Edges.setItem(n,u),t.Edges.setItem(n+1,c),i.Sites.setItem(o+1,s),i.Edges.setItem(o,l),i.Edges.setItem(o+1,c),u.lowerSite===a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite===s?l.CcwTriangle=i:l.CwTriangle=i,c.upperSite===s?(c.CcwTriangle=i,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=i),m0(e.upperSite.Edges,e),c}var je=class extends Pe{constructor(t,i,n){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new bt;this.rectangleNodeOnTriangles=null;this.isolatedSites=t,this.obstacles=i,this.isolatedSegments=n}static constructor_(t){let i=new je(null,null,null);return i.isolatedSitesWithObject=t,i}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let t of this.isolatedSitesWithObject)this.AddSite(t[0],t[1]);if(this.isolatedSites!=null)for(let t of this.isolatedSites)this.AddSite(t,null);if(this.obstacles!=null)for(let t of this.obstacles)this.AddPolylineToAllInputSites(t);if(this.isolatedSegments!=null)for(let t of this.isolatedSegments)this.AddConstrainedEdge(t.A,t.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(t,i){let n;return(n=this.PointsToSites.get(t))?n.Owner=i:(n=va.mkSO(t,i),this.PointsToSites.set(t,n)),n}AddP1AndP2(){let t=q.mkEmpty();for(let o of this.PointsToSites.keys())t.add(o);let i=Math.max(t.width/3,1),n=Math.max(t.height/3,1);this.P1=new va(t.leftBottom.add(new m(-i,-n))),this.P2=new va(t.rightBottom.add(new m(i,-n)))}AddPolylineToAllInputSites(t){for(let i=t.startPoint;i.next!=null;i=i.next)this.AddConstrainedEdge(i.point,i.next.point,t);t.closed&&this.AddConstrainedEdge(t.endPoint.point,t.startPoint.point,t)}AddConstrainedEdge(t,i,n){let o=je.AbovePP(t,i),a,l;o>0?(a=this.AddSite(t,n),l=this.AddSite(i,n)):(a=this.AddSite(i,n),l=this.AddSite(t,n));let u=je.CreateEdgeOnOrderedCouple(a,l);u.constrained=!0}static GetOrCreateEdge(t,i){if(je.AboveCC(t,i)===1){let n=t.EdgeBetweenUpperSiteAndLowerSite(i);return n!=null?n:je.CreateEdgeOnOrderedCouple(t,i)}else{let n=i.EdgeBetweenUpperSiteAndLowerSite(t);return n!=null?n:je.CreateEdgeOnOrderedCouple(i,t)}}static CreateEdgeOnOrderedCouple(t,i){return new dm(t,i)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new jt(this.allInputSites,this.P1,this.P2,je.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(je.OnComparison)}static OnComparison(t,i){return je.AboveCC(t,i)}static AbovePP(t,i){let n=t.y-i.y;return n>0?1:n<0?-1:(n=t.x-i.x,n>0?-1:n<0?1:0)}static AboveCC(t,i){return je.AbovePP(t.point,i.point)}RestoreEdgeCapacities(){for(let t of this.allInputSites)for(let i of t.Edges)i.constrained||(i.ResidualCapacity=i.Capacity)}SetInEdges(){for(let t of this.PointsToSites.values())for(let i of t.Edges)i.lowerSite.AddInEdge(i)}FindSite(t){return this.PointsToSites.get(t)}static PointIsInsideOfTriangle(t,i){for(let n=0;n<3;n++){let o=i.Sites.getItem(n).point,a=i.Sites.getItem(n+1).point;if(m.signedDoubledTriangleArea(t,o,a)<T.distanceEpsilon*-1)return!1}return!0}getRectangleNodeOnTriangles(){return this.rectangleNodeOnTriangles==null&&(this.rectangleNodeOnTriangles=et(Array.from(this.GetTriangles().values()).map(t=>lt(t,t.BoundingBox())))),this.rectangleNodeOnTriangles}EdgeIsCorrect(t){let i=t.upperSite,n=!1;for(let a of i.Edges)if(a===t){n=!0;break}return n?this.PointsToSites.get(i.point)===i:!1}};function pm(s){let e=Array.from(s.GetAllLeaves()),t=s.irect,i=t.diagonal/4,n=t.clone();return n.pad(i),m2(e.concat([n.perimeter()]))}function m2(s){let e=new je(null,s,null);return e.run(),e}var Zv,b0=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function n(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=n}(s,s.exports,null),s.exports}(),P0=class{constructor(...e){this._values=[];let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=Pn.defaultComparer),this._comparer=typeof i=="function"?Pn.create(i):i,t)for(let n of t)this.add(n)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return(0,b0.binarySearch)(this._values,e,this._comparer)>=0}add(e){let t=(0,b0.binarySearch)(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=(0,b0.binarySearch)(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let i of this)e.call(t,i,i,this)}get[Wt.size](){return this.size}[Wt.has](e){return this.has(e)}[Wt.add](e){this.add(e)}[Wt.delete](e){return this.delete(e)}[Wt.clear](){this.clear()}};Zv=P0;Object.defineProperty(Zv.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedSet"});var Qv,yi=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(M){if(M&1){let W=Math.sqrt(M)|0;for(let j=3;j<=W;j+=2)if(!(M%j))return!1;return!0}return M===2}function c(M){if(M<0)throw new RangeError;for(let W=0;W<l.length;W++){let j=l[W];if(j>=M)return j}for(let W=M|1;W<n;W+=2)if(u(W)&&(W-1)%a)return W;return M}function h(M){let W=2*M;return W>o&&o>M?o:c(W)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function f(M,W){let j=d(),te={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:M,head:j,tail:j};return p(te,W),te}t.createHashData=f;function p(M,W){let j=c(W);return M.freeList=-1,M.buckets=new Int32Array(j),M.entries=new Array(j),j}function S(M,W){let j=M.size,te=new Int32Array(W),oe=M.entries?M.entries.slice():[];oe.length=W;for(let he=0;he<j;he++){let Le=oe[he];if(Le&&Le.hashCode>=0){let Ge=Le.hashCode%W;Le.next=te[Ge]-1,te[Ge]=he+1}}M.buckets=te,M.entries=oe}function x(M,W){let j=-1;if(M.buckets&&M.entries){let te=M.equaler.hash(W)&n;j=M.buckets[te%M.buckets.length]-1;let oe=M.entries.length;for(;j>>>0<oe;){let he=M.entries[j];if(he.hashCode===te&&M.equaler.equals(he.key,W))break;j=he.next}}return j}t.findEntryIndex=x;function C(M,W){let j=x(M,W);return j>=0?M.entries[j].value:void 0}t.findEntryValue=C;function O(M,W,j){if(M.buckets||p(M,0),!M.buckets||!M.entries)throw new Error;let te=M.equaler.hash(W)&n,oe=te%M.buckets.length,he=M.buckets[oe]-1;for(;he>>>0<M.entries.length;){let Hr=M.entries[he];if(Hr.hashCode===te&&M.equaler.equals(Hr.key,W)){Hr.value=j;return}he=Hr.next}let Le=!1,Ge;if(M.freeSize>0)Ge=M.freeList,Le=!0,M.freeSize--;else{let Hr=M.size;if(Hr===M.entries.length){if(S(M,h(M.size)),!M.buckets||!M.entries)throw new Error;oe=te%M.buckets.length}Ge=Hr,M.size=Hr+1}let rr=M.entries[Ge]||(M.entries[Ge]=d());Le&&(M.freeList=rr.next),rr.hashCode=te,rr.next=M.buckets[oe]-1,rr.key=W,rr.value=j,rr.skipNextEntry=!1;let fi=M.tail;fi.nextEntry=rr,rr.prevEntry=fi,M.tail=rr,M.buckets[oe]=Ge+1}t.insertEntry=O;function B(M,W){if(M.buckets&&M.entries){let j=M.equaler.hash(W)&n,te=j%M.buckets.length,oe=-1,he;for(let Le=M.buckets[te]-1;Le>=0;Le=he.next){if(he=M.entries[Le],he.hashCode===j&&M.equaler.equals(he.key,W)){oe<0?M.buckets[te]=he.next+1:M.entries[oe].next=he.next;let Ge=he.prevEntry;return Ge.nextEntry=he.nextEntry,Ge.nextEntry&&(Ge.nextEntry.prevEntry=Ge),M.tail===he&&(M.tail=Ge),he.hashCode=-1,he.next=M.freeList,he.key=void 0,he.value=void 0,he.prevEntry=void 0,he.nextEntry=Ge,he.skipNextEntry=!0,M.freeList=Le,M.freeSize++,!0}oe=Le}}return!1}t.deleteEntry=B;function I(M){if(M.size>0){M.buckets&&M.buckets.fill(0),M.entries&&M.entries.fill(void 0);let j=M.head.nextEntry;for(;j;){let te=j.nextEntry;j.prevEntry=void 0,j.nextEntry=M.head,j.skipNextEntry=!0,j=te}M.head.nextEntry=void 0,M.tail=M.head,M.size=0,M.freeList=-1,M.freeSize=0}}t.clearEntries=I;function _(M,W){if(W<0)throw new RangeError;let j=M.entries?M.entries.length:0;if(j>=W)return j;if(!M.buckets)return p(M,W);let te=c(W);return S(M,c(W)),te}t.ensureCapacity=_;function X(M,W=M.size-M.freeSize){if(W<M.size)throw new RangeError;if(!M.buckets||!M.entries)return;let j=c(W),te=M.entries;if(j>=(te?te.length:0))return;let oe=M.size;if(p(M,j),!M.buckets||!M.entries)throw new Error;let he=0;for(let Le=0;Le<oe;Le++){let Ge=te[Le].hashCode;if(Ge>=0){let rr=Ge%j;M.entries[he]=te[Le],M.entries[he].next=M.buckets[rr]-1,M.buckets[rr]=he+1,he++}}M.size=he,M.freeSize=0}t.trimExcessEntries=X;function K(M){return M.key}t.selectEntryKey=K;function se(M){return M.value}t.selectEntryValue=se;function ge(M){return[M.key,M.value]}t.selectEntryEntry=ge;function*ue(M,W){let j=M;for(;j;){let te=j.skipNextEntry;j=j.nextEntry,!te&&j&&(yield W(j))}}t.iterateEntries=ue;function F(M,W,j,te){let oe=W;for(;oe;){let he=oe.skipNextEntry;oe=oe.nextEntry,!he&&oe&&j.call(te,oe.value,oe.key,M)}}t.forEachEntry=F}(s,s.exports,null),s.exports}(),Nd=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(n=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t??(t=0),n??(n=_r.defaultEqualer),this._hashData=(0,yi.createHashData)(n,t),i)for(let[o,a]of i)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,yi.findEntryIndex)(this._hashData,e)>=0}get(e){return(0,yi.findEntryValue)(this._hashData,e)}set(e,t){return(0,yi.insertEntry)(this._hashData,e,t),this}delete(e){return(0,yi.deleteEntry)(this._hashData,e)}clear(){(0,yi.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,yi.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,yi.trimExcessEntries)(this._hashData,e)}keys(){return(0,yi.iterateEntries)(this._hashData.head,yi.selectEntryKey)}values(){return(0,yi.iterateEntries)(this._hashData.head,yi.selectEntryValue)}entries(){return(0,yi.iterateEntries)(this._hashData.head,yi.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,yi.forEachEntry)(this,this._hashData.head,e,t)}get[Ri.size](){return this.size}[Ri.has](e){return this.has(e)}[Ri.get](e){return this.get(e)}[Ri.keys](){return this.keys()}[Ri.values](){return this.values()}[Pi.set](e,t){this.set(e,t)}[Pi.delete](e){return this.delete(e)}[Pi.clear](){this.clear()}};Qv=Nd;Object.defineProperty(Qv.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashMap"});var Jv,Si=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(F){if(F&1){let M=Math.sqrt(F)|0;for(let W=3;W<=M;W+=2)if(!(F%W))return!1;return!0}return F===2}function c(F){if(F<0)throw new RangeError;for(let M=0;M<l.length;M++){let W=l[M];if(W>=F)return W}for(let M=F|1;M<n;M+=2)if(u(M)&&(M-1)%a)return M;return F}function h(F){let M=2*F;return M>o&&o>F?o:c(M)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function f(F,M){let W=d(),j={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:F,head:W,tail:W};return p(j,M),j}t.createHashData=f;function p(F,M){let W=c(M);return F.freeList=-1,F.buckets=new Int32Array(W),F.entries=new Array(W),W}function S(F,M){let W=F.size,j=new Int32Array(M),te=F.entries?F.entries.slice():[];te.length=M;for(let oe=0;oe<W;oe++){let he=te[oe];if(he&&he.hashCode>=0){let Le=he.hashCode%M;he.next=j[Le]-1,j[Le]=oe+1}}F.buckets=j,F.entries=te}function x(F,M){let W=-1;if(F.buckets&&F.entries){let j=F.equaler.hash(M)&n;W=F.buckets[j%F.buckets.length]-1;let te=F.entries.length;for(;W>>>0<te;){let oe=F.entries[W];if(oe.hashCode===j&&F.equaler.equals(oe.key,M))break;W=oe.next}}return W}t.findEntryIndex=x;function C(F,M,W){if(F.buckets||p(F,0),!F.buckets||!F.entries)throw new Error;let j=F.equaler.hash(M)&n,te=j%F.buckets.length,oe=F.buckets[te]-1;for(;oe>>>0<F.entries.length;){let fi=F.entries[oe];if(fi.hashCode===j&&F.equaler.equals(fi.key,M)){fi.value=W;return}oe=fi.next}let he=!1,Le;if(F.freeSize>0)Le=F.freeList,he=!0,F.freeSize--;else{let fi=F.size;if(fi===F.entries.length){if(S(F,h(F.size)),!F.buckets||!F.entries)throw new Error;te=j%F.buckets.length}Le=fi,F.size=fi+1}let Ge=F.entries[Le]||(F.entries[Le]=d());he&&(F.freeList=Ge.next),Ge.hashCode=j,Ge.next=F.buckets[te]-1,Ge.key=M,Ge.value=W,Ge.skipNextEntry=!1;let rr=F.tail;rr.nextEntry=Ge,Ge.prevEntry=rr,F.tail=Ge,F.buckets[te]=Le+1}t.insertEntry=C;function O(F,M){if(F.buckets&&F.entries){let W=F.equaler.hash(M)&n,j=W%F.buckets.length,te=-1,oe;for(let he=F.buckets[j]-1;he>=0;he=oe.next){if(oe=F.entries[he],oe.hashCode===W&&F.equaler.equals(oe.key,M)){te<0?F.buckets[j]=oe.next+1:F.entries[te].next=oe.next;let Le=oe.prevEntry;return Le.nextEntry=oe.nextEntry,Le.nextEntry&&(Le.nextEntry.prevEntry=Le),F.tail===oe&&(F.tail=Le),oe.hashCode=-1,oe.next=F.freeList,oe.key=void 0,oe.value=void 0,oe.prevEntry=void 0,oe.nextEntry=Le,oe.skipNextEntry=!0,F.freeList=he,F.freeSize++,!0}te=he}}return!1}t.deleteEntry=O;function B(F){if(F.size>0){F.buckets&&F.buckets.fill(0),F.entries&&F.entries.fill(void 0);let W=F.head.nextEntry;for(;W;){let j=W.nextEntry;W.prevEntry=void 0,W.nextEntry=F.head,W.skipNextEntry=!0,W=j}F.head.nextEntry=void 0,F.tail=F.head,F.size=0,F.freeList=-1,F.freeSize=0}}t.clearEntries=B;function I(F,M){if(M<0)throw new RangeError;let W=F.entries?F.entries.length:0;if(W>=M)return W;if(!F.buckets)return p(F,M);let j=c(M);return S(F,c(M)),j}t.ensureCapacity=I;function _(F,M=F.size-F.freeSize){if(M<F.size)throw new RangeError;if(!F.buckets||!F.entries)return;let W=c(M),j=F.entries;if(W>=(j?j.length:0))return;let te=F.size;if(p(F,W),!F.buckets||!F.entries)throw new Error;let oe=0;for(let he=0;he<te;he++){let Le=j[he].hashCode;if(Le>=0){let Ge=Le%W;F.entries[oe]=j[he],F.entries[oe].next=F.buckets[Ge]-1,F.buckets[Ge]=oe+1,oe++}}F.size=oe,F.freeSize=0}t.trimExcessEntries=_;function X(F){return F.key}t.selectEntryKey=X;function K(F){return F.value}t.selectEntryValue=K;function se(F){return[F.key,F.value]}t.selectEntryEntry=se;function*ge(F,M){let W=F;for(;W;){let j=W.skipNextEntry;W=W.nextEntry,!j&&W&&(yield M(W))}}t.iterateEntries=ge;function ue(F,M,W,j){let te=M;for(;te;){let oe=te.skipNextEntry;te=te.nextEntry,!oe&&te&&W.call(j,te.value,te.key,F)}}t.forEachEntry=ue}(s,s.exports,null),s.exports}(),Ss=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(n=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t??(t=0),n??(n=_r.defaultEqualer),this._hashData=(0,Si.createHashData)(n,t),i)for(let o of i)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,Si.findEntryIndex)(this._hashData,e)>=0}add(e){return(0,Si.insertEntry)(this._hashData,e,e),this}tryAdd(e){let t=this.size;return(0,Si.insertEntry)(this._hashData,e,e),this.size>t}delete(e){return(0,Si.deleteEntry)(this._hashData,e)}clear(){(0,Si.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,Si.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,Si.trimExcessEntries)(this._hashData,e)}keys(){return(0,Si.iterateEntries)(this._hashData.head,Si.selectEntryKey)}values(){return(0,Si.iterateEntries)(this._hashData.head,Si.selectEntryValue)}entries(){return(0,Si.iterateEntries)(this._hashData.head,Si.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,Si.forEachEntry)(this,this._hashData.head,e,t)}get[Wt.size](){return this.size}[Wt.has](e){return this.has(e)}[Wt.add](e){this.add(e)}[Wt.delete](e){return this.delete(e)}[Wt.clear](){this.clear()}};Jv=Ss;Object.defineProperty(Jv.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashSet"});var $v,y0=class{constructor(...e){var t,i;this._size=0;let n,o,a;S2(e)?[n,a={}]=e:(n=0,y2(e)?[o,a={}]=e:a={});let l=(t=a?.keyEqualer)!==null&&t!==void 0?t:_r.defaultEqualer,u=(i=a?.valueEqualer)!==null&&i!==void 0?i:_r.defaultEqualer;if(this._map=new Nd(n,l),this._keyEqualer=l,this._valueEqualer=u,o)for(let[c,h]of o)this.add(c,h)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let i=this._map.get(e);return i?i.has(t):!1}get(e){return this._map.get(e)}add(e,t){let i=this._map.get(e);i||(i=new Ss(this._valueEqualer),this._map.set(e,i));let n=i.size;return i.add(t),this._size+=i.size-n,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let i=this._map.get(e);if(i){let n=i.size;if(i.delete(t))return this._size+=i.size-n,i.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let i of t)yield[e,i]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[i,n]of this._map)for(let o of n)e.call(t,o,i,this)}get[Zr.size](){return this.size}[Zr.has](e){return this.has(e)}[Zr.hasValue](e,t){return this.hasValue(e,t)}[Zr.get](e){return this.get(e)}[Zr.keys](){return this.keys()}[Zr.values](){return this.values()}[Vl.add](e,t){this.add(e,t)}[Vl.delete](e){return this.delete(e)}[Vl.deleteValue](e,t){return this.deleteValue(e,t)}[Vl.clear](){this.clear()}};$v=y0;Object.defineProperty($v.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"MultiMap"});function y2(s){let[e,t]=s;return(e===void 0||e!=null&&Symbol.iterator in Object(e))&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}function S2(s){let[e,t]=s;return typeof e=="number"&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}var eC,tC,S0,ql,Ca,Xl,Aa,xr=class{constructor(e){this._list=void 0,this._previous=void 0,this._next=void 0,this.value=e}get list(){return this._list}get previous(){if(this._previous&&this._list&&this!==this._list.first)return this._previous}get next(){if(this._next&&this._list&&this._next!==this._list.first)return this._next}detachSelf(){return this._list?this._list.deleteNode(this):!1}};eC=xr;S0=(s,e)=>{s._list=e},ql=s=>s._previous,Ca=(s,e)=>{s._previous=e},Xl=s=>s._next,Aa=(s,e)=>{s._next=e},Object.defineProperty(eC.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedListNode"});var Vo=class{constructor(...e){this._size=0,this._head=void 0;let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=_r.defaultEqualer),this._equaler=typeof i=="function"?_r.create(i):i,t)for(let n of t)this.push(n)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return ql(this._head)}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(t!=null&&!(t instanceof xr))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t??this.first;i;i=i.next)if(this._equaler.equals(i.value,e))return i}lastNodeOf(e,t){if(t!=null&&!(t instanceof xr))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t??this.last;i;i=i.previous)if(this._equaler.equals(i.value,e))return i}find(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;){i=n,n=i.next;let o=i.value;if(e.call(t,o,i,this))return o}}findLast(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;){i=n,n=i.previous;let o=i.value;if(e.call(t,o,i,this))return o}}findNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,e.call(t,i.value,i,this))return i}findLastNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;)if(i=n,n=i.previous,e.call(t,i.value,i,this))return i}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(e!=null&&!(e instanceof xr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e??void 0,new xr(t),0)}insertNodeBefore(e,t){if(e!=null&&!(e instanceof xr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof xr))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(e!=null&&!(e instanceof xr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e||void 0,new xr(t),1)}insertNodeAfter(e,t){if(e!=null&&!(e instanceof xr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof xr))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new xr(e),1)}pushNode(e){if(!(e instanceof xr))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new xr(e),0)}unshiftNode(e){if(!(e instanceof xr))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(e!=null&&!(e instanceof xr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return e==null||!e.list?!1:this._deleteNode(e)}deleteAll(e,t){if(typeof e!="function")throw new TypeError("Function expected: predicate");let i=0,n=this.first;for(;n;){let o=n.next;e.call(t,n.value,n,this)&&n.list===this&&(this._deleteNode(n),++i),n=o}return i}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)i=n,n=i.next,e.call(t,i.value,i,this)}map(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=new Vo,n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=e.call(t,n.value,n,this);i.push(a)}return i}filter(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=new Vo(this.equaler),n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=n.value;e.call(t,a,n,this)&&i.push(a)}return i}reduce(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0)}return n}reduceRight(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0),a=o.previous}return n}some(e,t){if(e!==void 0&&typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,!e||e.call(t,i.value,i,this))return!0;return!1}every(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=!1,n,o=this.first;for(;o!==void 0;){if(n=o,o=n.next,!e.call(t,n.value,n,this))return!1;i=!0}return i}_deleteNode(e){return Xl(e)===e?this._head=void 0:(Ca(Xl(e),ql(e)),Aa(ql(e),Xl(e)),this._head===e&&(this._head=Xl(e))),S0(e,void 0),Ca(e,void 0),Aa(e,void 0),this._size--,!0}_insertNode(e,t,i){if(S0(t,this),this._head===void 0)Aa(t,t),Ca(t,t),this._head=t;else switch(i){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),Aa(t,e),Ca(t,ql(e)),Aa(ql(e),t),Ca(e,t);break;case 1:e===void 0&&(e=ql(this._head)),Ca(t,e),Aa(t,Xl(e)),Ca(Xl(e),t),Aa(e,t);break}return this._size++,t}get[bi.size](){return this.size}[bi.has](e){return this.has(e)}[Wt.add](e){this.push(e)}[Wt.delete](e){return!!this.delete(e)}[Wt.clear](){this.clear()}};tC=Vo;Object.defineProperty(tC.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedList"});var Ta=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,i){this.currentTriangle=e,this.start=t,this.end=i}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!==t&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.Edges.item0;let i=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!==i&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=i,this.currentTriangle.Edges.item1):(this.positiveSign=i,this.negativeSign=e,this.currentTriangle.Edges.item2)}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.Edges.index(this.currentPiercedEdge),t,i=this.currentTriangle.Sites.getItem(e+2),n=this.GetHyperplaneSign(i);this.negativeSign===0?n===-1||n===0?(this.negativeSign=n,t=e+1):t=e+2:this.positiveSign===0?n===1||n===0?(this.positiveSign=n,t=e+2):t=e+1:n!==this.positiveSign?(this.negativeSign=n,t=e+1):(this.positiveSign=n,t=e+2),this.currentPiercedEdge=m.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-T.distanceEpsilon?this.currentTriangle.Edges.getItem(t):null}GetHyperplaneSign(e){let t=m.signedDoubledTriangleArea(this.start,e.point,this.end);return t>T.distanceEpsilon?1:t<-T.distanceEpsilon?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var Mc=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,i,n){if(je.PointIsInsideOfTriangle(t,i))return!0;let o=new Ta(i,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.constrained){let l=a.lowerSite.Owner;if(!n.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,i,n,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.cdtTriangle,n,i,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,i,n,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,i,n,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new Ss;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(n.has(d))continue;let f=Mc.FindPolylinePoint(d,h.point),p=G.minDistBetweenLineSegments(f.point,f.nextOnPolyline.point,t,i),S=p.dist,x=p.parab,C=p.parcd,O=G.minDistBetweenLineSegments(f.point,f.prevOnPolyline.point,t,i),B=O.dist,I=O.parab,_=O.parcd,X,K,se;if(S<B){if(se=S,se>o)continue;X=f.point.add(f.nextOnPolyline.point.sub(f.point).mul(x)),K=t.add(i.sub(t).mul(C))}else{if(se=B,se>o)continue;X=f.point.add(f.prevOnPolyline.point.sub(f.point).mul(I)),K=t.add(i.sub(t).mul(_))}a.get(d)||a.set(d,[X,K])}return a}ThreadLineSegmentThroughTriangles(e,t,i,n,o){if(je.PointIsInsideOfTriangle(i,e))return o.push(e),!0;let a=new Ta(e,t,i);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.constrained){let u=l.lowerSite.Owner;if(!n.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<T.distanceEpsilon*-1)return 0;o<T.distanceEpsilon&&(i=!0)}return i?1:2}static FindPolylinePoint(e,t){for(let i of e.polylinePoints())if(i.point.equal(t))return i;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,i,n){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.cdtTriangle,i,n,a,o)}EdgeIsLegalSSPPS(e,t,i){let n=e.Position,o=e.cdtTriangle,a=t.Position;if(je.PointIsInsideOfTriangle(a,o))return!0;let l=new Ta(o,n,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.constrained){let c=u.lowerSite.Owner;if(!i.has(c))return!1}}return!0}};var ei=class{constructor(e,t,i,n){this.metroGraphData=e,this.obstaclesToIgnoreLambda=n,this.bundlingSettings=t,this.obstacleTree=i}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?Un(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,i,n){let o={minimalDistance:i};return ei.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,i){let n={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,i,n,o)}GetMinimalDistanceToObstacles(e,t,i){let n=new Array,o={minimalDistance:i};return ei.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,i,n,o){return n.touchedObstacles=new Array,o.minimalDistance=t,ei.IntersectCircleWithTree(this.obstacleTree,e,t,i,n.touchedObstacles,o)}static IntersectCircleWithTree(e,t,i,n,o,a){if(!e.irect.contains_point_radius(t,i))return!0;if(e.UserData==null){let l=ei.IntersectCircleWithTree(e.Left,t,i,n,o,a);if(!l||(l=ei.IntersectCircleWithTree(e.Right,t,i,n,o,a),!l))return!1}else{let l=e.UserData;if(n.has(l))return!0;if(R.PointRelativeToCurveLocation(t,l)!==0)return ei.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=i&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,i,n){let o=t.sub(e).normalize();return o=new m(o.y,o.x*-1),ie.mkFromPoints([e.add(o.mul(i/2)),e.sub(o.mul(i/2)),t.sub(o.mul(n/2)),t.add(o.mul(n/2))])}};var mm=class{constructor(e,t,i,n){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=i,this.Index=n}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var bm=class{constructor(e,t,i){this.metroline=e,this.station=t,this.polyPoint=i}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var Pm=class{constructor(e,t,i){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=i}debStop(){return this.SerialNumber===28&&this.Position.sub(new m(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var ym=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Vt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Vt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new Sr(Re);for(let n of this.metroGraphData.VirtualStations())t.Enqueue(n,-this.CalculatePotential(n,e));let i=!1;for(;!t.IsEmpty();){let n={priority:0},o=t.DequeueAndGetPriority(n);if(n.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),i=!0)}return i}TryGrowHub(e,t){let i=this.CalculateAllowedHubRadius(e);if(e.Radius>=i)return!1;let n=t?Vt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=n)return!1;let a=.05*(n-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,i);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let i=t?Vt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return i<=e.Radius?0:(i-e.Radius)/i}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let n of e.Neighbors){let o=n.Position.sub(e.Position).length;t=Math.min(t,o/1.05-n.Radius)}let i=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return i<t&&(t=i-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,i){let n=1;for(let o of i.Neighbors){let l=e.GetWidthSSN(o,i,t.EdgeSeparation)/2+t.EdgeSeparation;n=Math.max(n,l)}return n=Math.min(n,2*t.MaxHubRadius),n}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,i){return Vt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,i.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,n){let o=Vt.CalculateIdealHubRadius(e,t,i);if(i.Neighbors.length>1){let a=i.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Vt.GetMinRadiusForTwoAdjacentBundles(o,i,n,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let i=e.MaxHubRadius;for(let n of t.Neighbors)i=Math.min(i,t.Position.sub(n.Position).length/2);return i}static GetMinRadiusForTwoAdjacentBundles(e,t,i,n,o,a,l){let u=a.GetWidthSSN(t,n,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Vt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,i,n.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,i,n,o,a,l){if(o<T.distanceEpsilon||a<T.distanceEpsilon)return e;let u=m.anglePCP(i,t,n);if(u=Math.min(u,Math.PI*2-u),u<T.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),f=a/(4*c),p=2*Math.sqrt(d*d+(f*f+2*(d*(f*h))));return p=Math.min(p,2*l.MaxHubRadius),p=Math.max(p,e),p}};var Ia=class{constructor(e,t,i,n){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=i,this.cdt=n}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Vt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],i=e[1],n=this.metroGraphData.GetIjInfo(t,i);n.cachedBundleCost=this.costCalculator.BundleCost(t,i,t.Position),t.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.getRectangleNodeOnTriangles();e.cdtTriangle=t.FirstHitNodeWithPredicate(e.Position,Ia.testPointInside).UserData,e.cachedIdealRadius=Vt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let i of e.Neighbors){i.IsReal||(i.cachedIdealRadius=Vt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,i),i.cachedRadiusCost=this.costCalculator.RadiusCost(i,i.Position));let n=this.metroGraphData.GetIjInfo(e,i);i.cachedBundleCost-=n.cachedBundleCost,n.cachedBundleCost=this.costCalculator.BundleCost(e,i,e.Position),e.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}static testPointInside(e,t){return je.PointIsInsideOfTriangle(e,t)?1:0}};var Bc=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size===0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let i=this.mainMap.get(e);if(i)return i.get(t)}has(e,t){let i=this.mainMap.get(e);return i?i.has(t):!1}set(e,t,i){let n=this.mainMap.get(e);n||(n=new Map,this.mainMap.set(e,n)),n.set(t,i)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[i,n]of t)yield[e,i,n]}*keys(){for(let[e,t]of this.mainMap)for(let[i]of t)yield[e,i]}};var Sm=class{constructor(e,t,i,n,o,a,l,u){this.cachedEnterableLooseForEnd=new bt;this.bundlingSettings=n,this.regularEdges=e,o!=null?this.cdt=o:this.cdt=pm(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new ei(this,n,t,c=>c.getELP()),this.tightIntersections=new ei(this,n,i,c=>c.EnterableTightPolylines),this.cdtIntersections=new Mc(this,n),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],n=this.edgeInfoDictionary.get(i[0],i[1]);return n?n.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(i[0],i[1])}MoveNode(e,t){let i=e.Position;this.PointToStations.deleteP(i),this.PointToStations.set(t,e),e.Position=t;for(let n of this.MetroNodeInfosOfNode(e))n.PolyPoint.point=t;for(let n of this.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(i).length-a.sub(i).length}for(let n of e.Neighbors)this.ink+=t.sub(n.Position).length-i.sub(n.Position).length;this.SortNeighbors(e);for(let n of e.Neighbors)this.SortNeighbors(n)}GetWidthSSN(e,t,i){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(n[0],n[1]);return o?o.Width+(o.Count-1)*i:0}GetWidthAN(e,t){let i=0;for(let o of e)i+=o.Width;let n=e.length;return i+=n>0?(n-1)*t:0,i}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,i=new rC.Stack,n=new He;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(n.has(o.point)){let l=o.next;do{let u=i.top;if(!u.equal(a))n.delete(u),i.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else i.push(a),n.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new bt;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!==e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let i=new Pm(this.Stations.length,t,e.point);this.PointToStations.set(e.point,i),this.Stations.push(i)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let i=new mm(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(i),this.PointToStations.get(i.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(i.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let i=this.PointToStations.get(t.Polyline.start),n;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,i=n)n=this.PointToStations.get(o.next.point),Nl(e,i,n),Nl(e,n,i)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new m(360.561,428.416)).length<.1&&t.Position.sub(new m(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let i=this.edgeInfoDictionary.get(e,t);return i||(i=new ym,this.edgeInfoDictionary.set(e,t,i),i)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new Bc,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let i=this.metrolines[t];this.InitMetroNodeInfos(i),this.InitNodeEnterableLoosePolylines(i,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(i,this.regularEdges[t]),i.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let i=this.PointToStations.get(t.point);i.MetroNodeInfos.push(new bm(e,i,t))}}InitNodeEnterableLoosePolylines(e,t){let i=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point);o.getELP()!=null?o.setELP(zn(o.getELP(),i)):o.setELP(new Set(i))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let i of this.LooseTree.AllHitItems_(e))R.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableLoosePolyline(i);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let i of this.TightTree.AllHitItems_(e))R.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableTightPolyline(i)}InitNodeEnterableTightPolylines(e,t){let i=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=zn(a,i):o.EnterableTightPolylines=new Set(i)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,i=e.Position;e.Neighbors.sort((n,o)=>ko(t.sub(i),n.Position.sub(i),o.Position.sub(i)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,i=this.PointToStations.get(t.start),n;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,i=n){n=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(i,n);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.cdt.getRectangleNodeOnTriangles();for(let t of this.Stations)t.cdtTriangle=e.FirstHitNodeWithPredicate(t.Position,Ia.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let i=e.sourceAndTargetLoosePolylines();return R.PointRelativeToCurveLocation(t,i[0])===0&&R.PointRelativeToCurveLocation(t,i[1])===0}};function ko(s,e,t){let i=m.crossProduct(s,t),n=s.dot(t),o=m.crossProduct(s,e),a=s.dot(e);return le(o,0)&&Md(a,0)?le(i,0)&&Md(n,0)?0:1:le(i,0)&&Md(n,0)?-1:le(o,0)||le(i,0)||o*i>0?dd(m.crossProduct(t,e),0):-dd(Math.sign(o),0)}function Md(s,e){return dd(s,e)>=0}var nC=Ae(mn(),1);var Uo=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,i){return(e-t)*i.InkImportance}static PathLengthsError(e,t,i,n){return(e-t)*(n.PathLengthImportance/i)}static RError(e,t,i){return e<=t?0:i.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,i){return e<=t?0:i.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let i=t.InkImportance*e.Ink;for(let n of e.Metrolines)i+=t.PathLengthImportance*n.Length/n.IdealLength;return i+=this.CostOfForces(e),i}static CostOfForces(e){let t=0;for(let i of e.VirtualStations())t=t+i.cachedRadiusCost;for(let i of e.VirtualEdges()){let n=i[0],o=i[1];t+=e.GetIjInfo(n,o).cachedBundleCost}return t}InkGain(e,t){let i=this.metroGraphData.Ink,n=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;n-=a.sub(e.Position).length,n+=a.sub(t).length}return Uo.InkError(i,n,this.bundlingSettings)}PathLengthsGain(e,t){let i=0;for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline.Length,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point,u=n.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;i+=Uo.PathLengthsError(o,u,n.Metroline.IdealLength,this.bundlingSettings)}return i}RadiusGain(e,t){let i=0;return i=i+e.cachedRadiusCost,i=i-this.RadiusCost(e,t),i}RadiusCost(e,t){let i;m.closeDistEps(e.Position,t)?i=e.cachedIdealRadius:i=Vt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,i,n))return Uo.Inf;let o=0;for(let a of n.touchedObstacles){let l=a[1].sub(t).length;o+=Uo.RError(i,l,this.bundlingSettings)}return o}BundleGain(e,t){let i=e.cachedBundleCost;for(let n of e.Neighbors){let o=this.BundleCost(e,n,t);if(Md(o,Uo.Inf))return-Uo.Inf;i-=o}return i}BundleCost(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,i,t.Position,n,o))return Uo.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=Uo.BundleError(n/2,u,this.bundlingSettings)}return a}},vr=Uo;vr.Inf=1e9;var iC=Ae(kn(),1);var Em=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new bt;this.interestingPoints=new He;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){E2(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){x2(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new iC.Queue;for(let i of this.Polylines)t.enqueue(i);for(;t.length>0;){let i=t.dequeue();e.delete(i);let n=this.ProcessPolyline(i);n!=null&&(e.has(i)||(e.add(i),t.enqueue(i)),e.has(n)||(e.add(n),t.enqueue(n)))}}ProcessPolyline(e){let t=new Map;for(let i=e.startPoint.next;i!=null;i=i.next){this.FillDepartedPolylinePoints(i,t);for(let n of this.pathsThroughPoints.get(i.point)){let o=t.get(n.polyline);if(o){if(this.ProcessFlip(i,o))return n.polyline;t.delete(n.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let i=e.prev.point;for(let n of this.pathsThroughPoints.get(i))this.IsNeighborOnTheSamePolyline(n,e)||t.has(n.polyline)||t.set(n.polyline,n)}ProcessFlip(e,t){let i=e.polyline,n=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(i),u=this.polylineToEdgeGeom.get(n);if(l.lineWidth!==u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!_l(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(i,o,a),h=c[0],d=c[1],f=c[2];c=this.FindPointsOnPolyline(n,o,a);let p=c[0],S=c[1],x=c[2],C=this.FindRelationOnFirstPoint(h,p,f,x),O=this.FindRelationOnLastPoint(d,S,f,x);return C!==2&&O!==2||C===1||O===1?!1:(this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.Swap(h,p,d,S,f,x),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,i){let n,o;for(let a=e.startPoint;a!=null;a=a.next)if(n==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];n=a}else o==null&&a.point.equal(i)&&(o=a);else if(a.point.equal(i))return[n,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let i=e;i!=null;i=i.next)if(i===t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Prev(e,i),u=this.Prev(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,i,n)}FindRelationOnLastPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Next(e,i),u=this.Next(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,i).point.equal(this.Prev(t,n).point);)e=this.Next(e,i),t=this.Prev(t,n);return this.PolylinesIntersect(e,t,o,a,i,n)}PolylinesIntersect(e,t,i,n,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(i,o),h=this.Prev(i,o),d=this.Next(t,a),f=this.Prev(n,a);if(e.point.equal(i.point)){let p=e.point,S=ko(h.point.sub(p),f.point.sub(p),u.point.sub(p)),x=ko(h.point.sub(p),d.point.sub(p),u.point.sub(p));return S===x?1:2}else{let p=ko(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),S=ko(c.point.sub(i.point),f.point.sub(i.point),h.point.sub(i.point));return p===S?1:2}}Swap(e,t,i,n,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),i,o),u=this.GetRangeOnPolyline(this.Next(t,a),n,a);this.ChangePolylineSegment(e,i,o,u),this.ChangePolylineSegment(t,n,a,l),Es.RemoveSelfCyclesFromPolyline(e.polyline),Es.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,i,n){let o=e;for(let a of n){let l=Mt.mkFromPoint(a.point);l.polyline=o.polyline,i?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}i?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,i){let n=new Array;for(let o=e;o!==t;o=this.Next(o,i))n.push(o);return n}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new He;for(let i=e.startPoint;i!=null;i=i.next){if(i===e.startPoint){if(i.prev!=null)return!1}else if(i.prev.next!==i)return!1;if(i===e.endPoint){if(i.next!=null)return!1}else if(i.next.prev!==i)return!1;if(t.has(i.point))return!1;t.add(i.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function E2(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function x2(s,e,t){let i=s.get(e);!i||(i.delete(t),i.size===0&&s.deleteP(e))}var Es=class{constructor(e,t){this.foundCrossings=new He;this.crossingsThatShouldBecomeHubs=new He;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new Kn;for(let t of this.Vertices())t.next&&e.set(new pt(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length===0)return!1;let e=new Kn,t=new Co(null);for(let l of this.Vertices()){let u=q.mkOnPoints([l.point]);u.pad(T.intersectionEpsilon),t.Add(u,l.point)}let i=fc(this.Edges(),l=>q.mkPP(l.first,l.second));Ht(i,i,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let n=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||n||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((i,n)=>Re(Ue(i,e.first),Ue(n,e.first)))}InsertPointsIntoPolylines(e){let t=!1;for(let i of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(i,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let i=!1;for(let n=e.Polyline.startPoint;n.next!=null;n=n.next)this.InsertPointsOnPolypoint(n,t,e)&&(i=!0);return i}InsertPointsOnPolypoint(e,t,i){let n=new pt(e.point,e.next.point),o=e.point!==n.first,a=t.get(n);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Mt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Mt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)Es.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,i=new bt;for(let n=e.startPoint;n!=null;n=n.next){let o=n.point,a=i.get(o);if(a){for(let l=a.next;l!==n.next;l=l.next)i.deleteP(l.point);a.next=n.next,n.next.prev=a,t=!0}else i.set(n.point,n)}return t}ReduceEdgeCrossings(){let e=new Em(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=gv(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let i=e.startPoint.next;i!=null&&i.next!=null;i=i.next)if(this.pointsToDelete.has(i.point)&&m.getTriangleOrientation(i.prev.point,i.point,i.next.point)===2){let n=i.prev,o=i.next;n.next=o,o.prev=n,i=n,t=!0}return t}IntersectTwoEdges(e,t,i,n){let o=G.IntersectPPPP(e.first,e.second,t.first,t.second);if(o){let a=this.FindExistingVertexOrCreateNew(n,o);(this.AddVertexToSplittingList(e,i,a)||this.AddVertexToSplittingList(t,i,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let i=e.RootNode.FirstHitNode(t);if(i!=null)return i.UserData;let n=q.mkOnPoints([t]);return n.pad(T.intersectionEpsilon),e.Add(n,t),t}AddVertexToSplittingList(e,t,i){if(!R.closeIntersectionPoints(i,e.first)&&!R.closeIntersectionPoints(i,e.second)){let n=t.get(e);if(n||(n=new Array,t.set(e,n)),!n.find(o=>o.equal(i)))return n.push(i),!0}return!1}};var Bd=class{isCorrectlyOrienected(){return m.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!==1}get Count(){return this.points.length}constructor(e,t,i,n){this.BelongsToRealNode=n,this.Curve=t,this.Position=i,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return m.middle(this.StartPoint,this.EndPoint)}get Span(){return this.SpanBetweenTwoParameters(this.parStart,this.parEnd)}SpanBetweenTwoParameters(e,t){return e<=t?t-e:t-e+pn(this.Curve)}RotateLeftPoint(e,t){return e===0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e===0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,i){let n=pn(this.Curve)*i;return t+=e*n,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,i){let n=pn(this.Curve)*i;e!==0&&(this.ParStart=this.AdjustParam(this.ParStart+e*n)),t!==0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*n))}RelativeOrderOfBasesIsPreserved(e,t,i){let n=pn(this.Curve)*i,o=this.parStart+e*n,a=this.parStart<this.parEnd?this.parEnd+t*n:this.parEnd+pn(this.Curve)+t*n;if(o>a||this.SpanBetweenTwoParameters(o,a)>pn(this.Curve)/2)return!1;if(this.Prev==null||this.SpanBetweenTwoParameters(this.Prev.ParMid,this.ParMid)>n&&this.SpanBetweenTwoParameters(this.ParMid,this.Next.ParMid)>n)return!0;let l=this.RotateLeftPoint(t,i),u=this.RotateRigthPoint(e,i),c=m.middle(l,u),h=this.MidPoint;return!(m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var Yl=class{constructor(e,t,i,n){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=i,this.HalfWidthArray=n,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let i=this.SourceBase.Curve.boundingBox.diagonal/2,n=this.TargetBase.Curve.boundingBox.diagonal/2,o=ei.Create4gon(this.SourceBase.Position,this.TargetBase.Position,i*2,n*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&R.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,i=e.sub(t).normalize(),n=i.rotate90Ccw(),o=m.middle(e,t),a=i.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(n.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>Yl.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(n.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=Yl.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(n.mul(Yl.FeasibleWidthEpsilon),new m(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new m(0,0),n.mul(-Yl.FeasibleWidthEpsilon),l,u))&&(d=2*Yl.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"./tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,i){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,i)}SetRLParamsIfWidthIsFeasible_(e,t,i,n){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(G.mkPP(i.add(e),n.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>R.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(G.mkPP(i.add(t),n.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>R.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(G.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"./tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,i){let n=R.getAllIntersections(e,this.SourceBase.Curve,!0);if(n.length===0)return i.par=0,t.par=0,null;let o;if(n.length===1?o=n[0]:this.SourceBase.IsParent?o=n[0].par0<n[1].par0?n[1]:n[0]:o=n[0].par0<n[1].par0?n[0]:n[1],n=R.getAllIntersections(e,this.TargetBase.Curve,!0),n.length===0)return i.par=0,t.par=0,null;let a;return n.length===1?a=n[0]:this.TargetBase.IsParent?a=n[0].par0>n[1].par0?n[1]:n[0]:a=n[0].par0>n[1].par0?n[0]:n[1],t.par=o.par1,i.par=a.par1,G.mkPP(o.x,a.x)}RotateBy(e,t,i,n,o){let a=e!==0||t!==0,l=i!==0||n!==0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(i,n,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let i=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),n=i.length;n>=T.tolerance&&(i=i.div(n),this.TargetBase.Tangents[t]=i,this.SourceBase.Tangents[e-1-t]=i.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,i=e.Points,n=G.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];i[0]=n.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],i[l]=n.value(a*o)}RotationIsLegal(e,t,i,n,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!==0||i!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||n!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!==0||n!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||i!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!==0||t!==0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(i!==0||n!==0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(i,n,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(i=>R.intersectionOne(G.mkPP(e,t),i,!1)!=null)==null}},Dd=Yl;Dd.FeasibleWidthEpsilon=.1;var Fd=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,i,n){this.Segment=e,this.Reversed=t,this.Index=i,this.BundleBase=n}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var Ze=class{constructor(e,t,i){this.fixedBundles=new Ss;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=i}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=be.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let i=new Bd(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,i);let n=new Bd(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,n),R.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!==0?(i.IsParent=!0,Ml(this.internalBases,e,i),Ml(this.externalBases,t,n)):R.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!==0?(n.IsParent=!0,Ml(this.externalBases,e,i),Ml(this.internalBases,t,n)):(Ml(this.externalBases,e,i),Ml(this.externalBases,t,n));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new Dd(i,n,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));i.OutgoingBundleInfo=n.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,i=e[0].CurveCenter;e.sort((n,o)=>ko(t.sub(i),n.OppositeBase.Position.sub(i),o.OppositeBase.Position.sub(i)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++)e[i].Prev=e[(i-1+t)%t],e[i].Next=e[(i+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=a.OrientedHubSegments[u]=new Fd(null,!1,u,a),d=l.OrientedHubSegments[c]=new Fd(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,i=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,i.Position),i.ParEnd=i.ParStart=this.GetBaseMiddleParamInDirection(i,i.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,i){let n=e.Curve;if(n instanceof be){let l=n;if(l.isArc())return m.angle(l.aAxis,i.sub(t))}let a=R.getAllIntersections(n,G.mkPP(t,i),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(i))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++){let n=e[i],o=n.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(n,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let i=v2(e,t);if(i==null||le(i.start,i.end))return;let n=i.rbaseMiddle,o=i.lbaseMiddle;if(n<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(i.end*a+i.start*l)/(l+a);e.ParStart=e.AdjustParam(u+T.distanceEpsilon),t.ParEnd=t.AdjustParam(u-T.distanceEpsilon)}RegularCut(e,t,i,n,o,a){let l=(o*n+a*e)/(o+a),u=Math.min(t,n),c=Math.max(e,i);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=Ze.MaxParameterChange,t={cost:this.Cost()},i=0;for(;i++<Ze.MaxIterations;){let n=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,n,t.cost),e<Ze.MinParameterChange)break}}UpdateParameterChange(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let i=!1;for(let n of this.Bundles)this.fixedBundles.has(n)||(this.OptimizeBundle(n,e,t)?i=!0:this.fixedBundles.add(n));return i}OptimizeBundle(e,t,i){let n=this.CostBi(e);if(n<Ze.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<Ze.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(Ze.Deltas[u][0],Ze.Deltas[u][1],0,0,e,n,t);c>Ze.CostDeltaThreshold&&c>o&&(l=u,a=Ze.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,Ze.Deltas[u][0],Ze.Deltas[u][1],e,n,t),c>Ze.CostDeltaThreshold&&c>o&&(l=Ze.Deltas.length-1,a=u,o=c)}return o<Ze.CostDeltaThreshold?!1:(i.cost-=o,e.RotateBy(Ze.Deltas[l][0],Ze.Deltas[l][1],Ze.Deltas[a][0],Ze.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,i,n,o,a,l){if(!o.RotationIsLegal(e,t,i,n,l))return 0;o.RotateBy(e,t,i,n,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,i*-1,n*-1,l),a-u}CostBi(e){return Ze.SeparationCoeff*this.SeparationCost(e)+(Ze.SqueezeCoeff*this.SqueezeCost(e)+(Ze.AssymetryCoeff*this.AssymetryCost(e)+Ze.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let i=0;return i=i+Ze.CenterCoeff*this.CenterCostBi(e),i>t||(i=i+Ze.SeparationCoeff*this.SeparationCost(e),i>t)||(i=i+Ze.SqueezeCoeff*this.SqueezeCost(e),i>t)||(i=i+Ze.AssymetryCoeff*this.AssymetryCost(e)),i}SqueezeCost(e){let i=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),n=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(i)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(i)),a=Math.abs(e.TotalRequiredWidth-n)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(n-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,i=Math.min(e.InitialMidParameter,t),n=Math.max(e.InitialMidParameter,t),o=Math.min(n-i,i+(pn(e.Curve)-n));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,i=0;for(let n of e.OrientedHubSegments){let o=n.Index,a=n.Other.Index,l=e.Points[o],u=e.Tangents[o],c=n.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],f=e.Count+c.Count;i+=this.GetAssymetryCostOnData(l,u,h,d,t)/f}return i}GetAssymetryCostOnData(e,t,i,n,o){let a=e.sub(i),l=a.length;if(l<T.distanceEpsilon)return 0;let u=t.add(n).dot(a),c=m.crossProduct(a,t),h=m.crossProduct(a,n),d=c-h,f=u*u+d*d,p=c*c+h*h;return 10*f+o*p}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let i=e.Curve,n=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,i),o=Math.min(e.Span,t.Span);return Math.exp(n/(o*10))-1}IntervalsOverlapLength(e,t,i,n,o){let a=o.parStart,l=o.parEnd;return e<t?i<n?this.IntersectRegularIntervals(e,t,i,n):this.IntersectRegularIntervals(e,t,i,l)+this.IntersectRegularIntervals(e,t,a,n):i<n?this.IntersectRegularIntervals(e,l,i,n)+this.IntersectRegularIntervals(a,t,i,n):this.IntersectRegularIntervals(e,l,i,l)+this.IntersectRegularIntervals(a,t,a,n)}IntersectRegularIntervals(e,t,i,n){let o=Math.max(e,i),a=Math.min(t,n);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let i=Ze.SeparationCoeff*this.SeparationCost(t),n=Ze.AssymetryCoeff*this.AssymetryCost(t),o=Ze.SqueezeCoeff*this.SqueezeCost(t),a=Ze.CenterCoeff*this.CenterCostBi(t);e+=(i+n)/2+o+a}return e}},Ni=Ze;Ni.Deltas=[[1,-1],[1,-1]],Ni.SeparationCoeff=1,Ni.SqueezeCoeff=1,Ni.CenterCoeff=10,Ni.AssymetryCoeff=1,Ni.MaxIterations=200,Ni.MaxParameterChange=8/360,Ni.MinParameterChange=.1/360,Ni.CostThreshold=1e-5,Ni.CostDeltaThreshold=.01;function v2(s,e){let t=pn(s.Curve),i=s.ParEnd,n=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-t,o=e.ParEnd,a=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-t;i>o?i-a>t&&(a+=t,o+=t):o-n>t&&(n+=t,i+=t);let l=Math.min(i,o),u=Math.max(n,a);return u<=l?{start:u,end:l,rbaseMiddle:(n+i)/2,lbaseMiddle:(a+o)/2}:null}var xm=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var Kl=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let i=new pt(e.Position,t.Position),n=this.bundles.get(i).Metrolines;if(e.Position===i.first)for(let o=0;o<n.length;o++)yield n[o];else for(let o=n.length-1;o>=0;o--)yield n[o]}GetLineIndexInOrder(e,t,i){let n=new pt(e.Position,t.Position),o=e.Position!==n.first,a=this.bundles.get(n).LineIndexInOrder;return o?a.size-1-a.get(i):a.get(i)}BuildOrder(){this.bundles=new Kn;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let i=new pt(t.point,t.next.point),n=this.bundles.get(i);n||this.bundles.set(i,n=new xm),n.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((i,n)=>this.CompareLines(i,n,e.first,e.second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let i=0;i<t.Metrolines.length;i++)t.LineIndexInOrder.set(t.Metrolines[i],i)}}CompareLines(e,t,i,n){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(i,n,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(i,n,t,o);let c=o.polyPoint,h=o.next,d=o.prev,f=a,p=c,S,x;for(;(x=u(f))!=null&&(S=d(p))!=null&&x.point.equal(S.point);){let C=new pt(x.point,f.point);if(this.bundles.get(C).orderFixed)return this.CompareOnFixedOrder(C,e,t,!x.point.equal(C.first));f=x,p=S}if(x!=null&&S!=null){let C=f.point;return-Kl.IsLeft(l(f).point.sub(C),x.point.sub(C),S.point.sub(C))}for(f=a,p=c;(x=l(f))!=null&&(S=h(p))!=null&&x.point.equal(S.point);){let C=new pt(x.point,f.point);if(this.bundles.get(C).orderFixed)return this.CompareOnFixedOrder(C,e,t,!f.point.equal(C.first));f=x,p=S}if(x!=null&&S!=null){let C=f.point;return Kl.IsLeft(u(f).point.sub(C),x.point.sub(C),S.point.sub(C))}return Re(e.Index,t.Index)}CompareOnFixedOrder(e,t,i,n){let o=this.bundles.get(e).LineIndexInOrder;return(n?-1:1)*Re(o.get(t),o.get(i))}FindStationOnLine(e,t,i,n){for(let o=i.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){n.next=a=>a.next,n.prev=a=>a.prev,n.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){n.next=a=>a.prev,n.prev=a=>a.next,n.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,i){return ko(e,t,i)}};var tt=class extends Pe{constructor(t,i){super(null);this.metroGraphData=t,this.bundlingSettings=i}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Vt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new Kl(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new Ni(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let t=0;t<this.metroGraphData.Metrolines.length;t++)this.CreateCurveLine(this.metroGraphData.Metrolines[t],this.metroGraphData.Edges[t])}CreateCurveLine(t,i){let n=new R,a=tt.FindCurveStart(this.metroGraphData,this.metroOrdering,t),l=tt.HubSegsOfLine(this.metroGraphData,this.metroOrdering,t);for(let u of l)u!=null&&(n.addSegment(G.mkPP(a,u.start)),n.addSegment(u),a=u.end);n.addSegment(G.mkPP(a,tt.FindCurveEnd(this.metroGraphData,this.metroOrdering,t))),i.curve=n}static FindCurveStart(t,i,n){let o=t.PointToStations.get(n.Polyline.startPoint.point),a=t.PointToStations.get(n.Polyline.startPoint.next.point),l=o.BundleBases.get(a),u=l.IsParent?i.GetLineIndexInOrder(o,a,n):i.GetLineIndexInOrder(a,o,n);return l.Points[u]}static FindCurveEnd(t,i,n){let o=t.PointToStations.get(n.Polyline.endPoint.prev.point),a=t.PointToStations.get(n.Polyline.endPoint.point),l=a.BundleBases.get(o),u=l.IsParent?i.GetLineIndexInOrder(a,o,n):i.GetLineIndexInOrder(o,a,n);return l.Points[u]}static*HubSegsOfLine(t,i,n){for(let o=n.Polyline.startPoint.next;o.next!=null;o=o.next)yield tt.SegOnLineVertex(t,i,n,o)}static SegOnLineVertex(t,i,n,o){let a=t.PointToStations.get(o.prev.point),l=t.PointToStations.get(o.point),u=l.BundleBases.get(a),c=i.GetLineIndexInOrder(a,l,n);if(u.OrientedHubSegments[c]==null||u.OrientedHubSegments[c].Segment==null){let h=t.PointToStations.get(o.next.point),d=l.BundleBases.get(h),f=i.GetLineIndexInOrder(h,l,n);return G.mkPP(u.Points[c],d.Points[f])}return u.OrientedHubSegments[c].Segment}CreateSegmentsInsideHubs(){for(let t of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(t);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(t){for(let i=t.Polyline.startPoint.next;i.next!=null;i=i.next)this.CreateICurveForOrientedSeg(t,i)}CreateICurveForOrientedSeg(t,i){let n=this.metroGraphData.PointToStations.get(i.prev.point),o=this.metroGraphData.PointToStations.get(i.point),a=this.metroGraphData.PointToStations.get(i.next.point),l=o.BundleBases.get(n),u=o.BundleBases.get(a),c=this.metroOrdering.GetLineIndexInOrder(n,o,t),h=this.metroOrdering.GetLineIndexInOrder(a,o,t),d=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?tt.StandardBezier(l.Points[c],l.Tangents[c],u.Points[h],u.Tangents[h]):tt.BiArc(l.Points[c],l.Tangents[c],u.Points[h],u.Tangents[h]);l.OrientedHubSegments[c].Segment=d,u.OrientedHubSegments[h].Segment=d}static ShowHubs(t,i,n,o,a=[]){let l=tt.GetAllDebugCurves(i,t);n!=null&&l.push(pe.mkDebugCurveTWCI(255,1,"red",_e.mkDiamond(5,25,n.Position))),l=l.concat(a)}static GetAllDebugCurves(t,i){return tt.GraphNodes(i).concat(tt.VertexDebugCurves(t,i)).concat(tt.DebugEdges(i))}static DebugEdges(t){return t.Edges.map(i=>pe.mkDebugCurveTWCI(40,.1,"gray",i.curve))}static VertexDebugCurves(t,i){return tt.DebugCircles(i).concat(tt.DebugHubBases(i)).concat(tt.DebugSegs(i)).concat(tt.BetweenHubs(t,i))}static BetweenHubs(t,i){let n=[];for(let o of i.Metrolines){let a=tt.GetInterestingSegs(i,t,o),l=tt.GetMonotoneColor(o.Polyline.start,o.Polyline.end,a);for(let u of a)n.push(pe.mkDebugCurveTWCI(100,o.Width,l,G.mkPP(u[0],u[1])))}return n}static GetInterestingSegs(t,i,n){let o=new Array;if(t.Stations.length===0||t.Stations[0].BundleBases==null||t.Stations[0].BundleBases.size===0)return[];let a=tt.FindCurveStart(t,i,n),l=tt.HubSegsOfLine(t,i,n);for(let u of l)u!=null&&(o.push([a,u.start]),a=u.end);return o.push([a,tt.FindCurveEnd(t,i,n)]),o}static GetMonotoneColor(t,i,n){return"green"}static DebugHubBases(t){let i=new Array;for(let n of t.Stations)for(let o of n.BundleBases.values())i.push(pe.mkDebugCurveTWCI(100,1,"red",G.mkPP(o.EndPoint,o.StartPoint)));return i}static DebugCircles(t){return t.Stations.map(i=>pe.mkDebugCurveTWCI(100,.1,"blue",_e.mkCircle(i.Radius,i.Position)))}static DebugSegs(t){let i=new Array;for(let n of t.VirtualStations())for(let o of n.BundleBases.values())for(let a of o.OrientedHubSegments)if(a!=null)if(a.Segment==null){let l=a.Other.BundleBase,u=a.Index,c=a.Other.Index;i.push(G.mkPP(o.Points[u],l.Points[c]))}else i.push(a.Segment);return i.map(n=>pe.mkDebugCurveTWCI(100,.01,"green",n))}static GraphNodes(t){return t.Edges.map(n=>n.sourcePort.Curve).concat(t.Edges.map(n=>n.targetPort.Curve)).map(n=>pe.mkDebugCurveTWCI(40,1,"black",n))}static BiArc(t,i,n,o){let a=t.sub(n);if(a.length<T.distanceEpsilon)return null;let l=a.dot(i.sub(o)),u=-i.dot(o);if(i.dot(n.sub(t))<=0&&i.dot(o)<=0)return tt.StandardBezier(t,i,n,o);let c=2*(u-1),h=2*l,d=a.dot(a),f;if(Math.abs(c)<T.distanceEpsilon)if(Math.abs(h)>T.distanceEpsilon)f=-d/h;else return null;else{let I=h*h-4*c*d;I<0&&(I=0),I=Math.sqrt(I),f=(-h+I)/(2*c),f<0&&(f=(-h-I)/(2*c))}let p=t.add(i.mul(f)),S=n.add(o.mul(f)),x=m.middle(p,S),C=m.getTriangleOrientation(t,p,x),O=m.getTriangleOrientation(x,S,n);if(C!==O)return tt.StandardBezier(t,i,n,o);let B=new R;return B.addSegs([tt.ArcOn(t,p,x),tt.ArcOn(x,S,n)]),B}static ArcOn(t,i,n){let o={center:null};if(Math.abs(m.signedDoubledTriangleArea(t,i,n))<1e-4||!tt.FindArcCenter(t,i,n,o))return G.mkPP(t,n);let a=o.center,l=Ue(t,a);if(Ue(t,i)/l<1e-4)return G.mkPP(t,n);let c=t.sub(a),h=Math.atan2(c.y,c.x),d=n.sub(a),f=Math.atan2(d.y,d.x),p=f-h;if(p<0&&(p+=2*Math.PI,f+=2*Math.PI),p<=Math.PI)return new be(h,f,new m(l,0),new m(0,l),a);for(f>2*Math.PI&&(f-=2*Math.PI),h=Math.PI-h,f=Math.PI-f,h<0&&(h+=2*Math.PI);f<h;)f+=2*Math.PI;return p=f-h,new be(h,f,new m(-l,0),new m(0,l),a)}static FindArcCenter(t,i,n,o){let a=i.sub(t).rotate90Cw(),l=i.sub(n).rotate90Cw();return o.center=m.lineLineIntersection(t,t.add(a),n,n.add(l)),o.center!=null}static StandardBezier(t,i,n,o){let a=Ue(t,n)/4;return Fe.mkBezier([t,t.add(i.mul(a)),n.add(o.mul(a)),n])}FanBezierSegs(){let t=!0,i=5,n=0;for(;t&&n++<i;){t=!1;for(let o of this.metroGraphData.Stations)for(let a of o.BundleBases.values())t||(t=this.FanEdgesOfHubSegment(a))}}FanEdgesOfHubSegment(t){let i=!1;for(let n=0;n<t.Count-1;n++)i||(i=this.FanCouple(t,n,t.CurveCenter,t.Curve.boundingBox.diagonal/2));return i}FanCouple(t,i,n,o){let a=t.OrientedHubSegments[i],l=t.OrientedHubSegments[i+1];if(a==null||G.IntersectPPPP(a.Segment.start,a.Segment.end,l.Segment.start,l.Segment.end)||m.getTriangleOrientation(a.value(0),a.value(.5),a.value(1))!=m.getTriangleOrientation(l.value(0),l.value(.5),l.value(1)))return!1;let c=this.BaseLength(a),h=this.BaseLength(l);return Math.abs(c-h)<T.intersectionEpsilon?!1:c>h?this.AdjustLongerSeg(a,l,n,o):this.AdjustLongerSeg(l,a,n,o)}AdjustLongerSeg(t,i,n,o){let a=t.value(0).sub(i.value(0)),l=t.value(1).sub(i.value(1)),u=Math.min(a.length,l.length),c=i.value(.5),h=Math.max(a.length,l.length);return this.NicelyAligned(t.Segment,a,l,c,u,h)===0?!1:this.FitLonger(t,a,l,c,u,h,n,o)}FitLonger(t,i,n,o,a,l,u,c){let h=t.Segment,d=h.start,f=h.end,p=0,S=10,x=h.start.mul(1-tt.SqueezeBound).add(h.B(1).mul(tt.SqueezeBound)),C=h.end.mul(1-tt.SqueezeBound).add(h.B(2).mul(tt.SqueezeBound)),O=h.B(1).mul(2).sub(h.start),B=h.B(2).mul(2).sub(h.end),I={highP:O};this.PullControlPointToTheCircle(h.start,I,u,c),O=I.highP;let _=this.NicelyAligned(h,i,n,o,a,l);do{if(_===-1){let X=m.middle(h.B(1),x),K=m.middle(h.B(2),C);O=h.B(1),B=h.B(2),h=new Fe(d,X,K,f)}else{let X=m.middle(h.B(1),O),K=(h.B(2),B);x=h.B(1),C=h.B(2),h=new Fe(d,X,K,f)}if((_=this.NicelyAligned(h,i,n,o,a,l))===0)return t.Segment=h,t.Other.Segment=h,!0;if(p++>S)return!1}while(!0)}PullControlPointToTheCircle(t,i,n,o){let a=m.ProjectionToLine(t,i.highP,n),l=Math.sqrt(o*o-a.sub(n).lengthSquared),u=i.highP.sub(a),c=u.length;c>l&&(i.highP=a.add(u.mul(l/c)))}NicelyAligned(t,i,n,o,a,l){let c=t.value(.5).sub(o),h=c.length;return i.dot(c)<0||n.dot(c)<0||h<a-.001?1:h>l+.001?-1:0}BaseLength(t){return t.value(0).sub(t.value(1)).lengthSquared}},xs=tt;xs.SqueezeBound=.2;var xn=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new vr(this.metroGraphData,this.bundlingSettings),this.cache=new Ia(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,i){return new xn(e,t).FixRoutingP(i)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=xn.MaxStep,i=Number.POSITIVE_INFINITY,n=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<xn.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=i;i=vr.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,i);let u=n;if(n=this.metroGraphData.VirtualStations().map(c=>c.Position),t<xn.MinStep||this.Converged(t,u,n))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let i=e[0],n=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(i,n),a=G.mkPP(i.Position,n.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>R.CurvesIntersect(a,u));return l.length>0?(xs.ShowHubs(t,null,null,"./tmp/badcross.svg",[pe.mkDebugCurveTWCI(200,1,"Brown",a),pe.mkDebugCurveTWCI(200,1,"Red",_e.mkCircle(2,i.Position)),pe.mkDebugCurveTWCI(200,1,"Blue",_e.mkCircle(5,n.Position)),pe.mkDebugCurveTWCI(100,1,"Blue",_e.mkCircle(5,n.Position))].concat(l.map(u=>pe.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let i of e){let n=this.metroGraphData.PointToStations.get(i);n&&!n.IsReal&&t.add(n)}return t}}Converged(e,t,i){let n=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(i[l]).lengthSquared,n+=t[l].lengthSquared;return Math.sqrt(o/n)<xn.MinRelativeChange}UpdateMaxStep(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(xn.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let i of this.stationsForOptimizations)if(this.TryMoveStation(i)){e=!0,t.add(i);for(let n of i.Neighbors)n.IsReal||t.add(n)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length===0)return!1;let i=this.BuildStepLength(e,t);if(i<xn.MinStep&&(t=C2(),i=this.BuildStepLength(e,t),i<xn.MinStep))return!1;let n=t.mul(i),o=e.Position.add(n);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let i of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(q.mkOnPoints([t]),n=>R.PointRelativeToCurveLocation(t,n)!==0))if(e.getELP().has(i)===!1)return!1;for(let i of e.Neighbors){let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(i,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(i.Position,t,i.cdtTriangle,n))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),i=this.BuildForceForPathLengths(e),n=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(i.add(n.add(o)));return a.length<.1?new m(0,0):a.normalize()}BuildStepLength(e,t){let i=xn.MinStep,n=this.CostGain(e,e.Position.add(t.mul(i)));if(n<.01)return 0;for(;2*i<=xn.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(i*2)));if(o<=n)break;i*=2,n=o}return i}CostGain(e,t){let n=this.costCalculator.RadiusGain(e,t);if(n<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return n+a+l+o}BuildForceForInk(e){let t=new m(0,0);for(let n of e.Neighbors){let o=n.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new m(0,0);for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.next.point,l=n.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new m(0,0),i=e.cachedIdealRadius,n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,i,n))throw xs.ShowHubs(this.metroGraphData,null,e,"./tmp/hubs.svg",[pe.mkDebugCurveTWCI(255,1,"Brown",ei.containingPoly),pe.mkDebugCurveTWCI(100,1,"Blue",_e.mkCircle(i,e.Position))]),new Error;for(let l of n.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/i),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new m(0,0);for(let n of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,n,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,n,e.Position,n.Position,o/2,a)||xs.ShowHubs(this.metroGraphData,null,e,"./tmp/inside_forbid.svg",[pe.mkDebugCurveTWCI(100,.2,"Blue",G.mkPP(e.Position,n.Position)),pe.mkDebugCurveTWCI(100,.2,"Red",_e.mkCircle(2,e.Position)),pe.mkDebugCurveTWCI(100,.2,"Red",_e.mkCircle(3,n.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},vn=xn;vn.MaxIterations=100,vn.MaxStep=50,vn.MinStep=1,vn.MinRelativeChange=5e-4;function C2(){return new m(1+2*Do(),1+2*Do())}var zo=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let i=new zo(e,t);i.GlueConflictingStations(),i.UnglueEdgesFromBundleToSaveInk(!0);let n=0,o=10;for(;++n<o;){let a=i.GlueConflictingStations();if(a||(a=i.RelaxConstrainedEdges()),a||(a=n<=3&&i.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=i.GlueCollinearNeighbors(n)),a||(a=n===3&&i.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,i.RemoveDoublePathCrossings(),i.UnglueEdgesFromBundleToSaveInk(!0);i.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,i=new Set;if(Ht(e,e,(o,a)=>this.TryToGlueStations(o,a,t,i)),t.size===0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let n=new He;for(let o of i){n.add(o.Position);for(let a of o.Neighbors)a.IsReal||n.add(a.Position)}return this.metroGraphData.Initialize(!1),vn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,n),!0}GetCirclesHierarchy(){for(let i of this.metroGraphData.VirtualStations())i.Radius=this.GetCurrentHubRadius(i);let e=this.metroGraphData.VirtualStations().map(t);return et(e);function t(i){let n=i.Position,o=Math.max(i.Radius,5),a=new m(o,o),l=q.mkPP(n.add(a),n.sub(a));return lt(i,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,i=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let n of e.Neighbors)i=Math.min(i,e.Position.sub(n.Position).length);return i}}TryToGlueStations(e,t,i,n){if(!_l(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,n,i)||this.TryGlueOrdered(t,e,n,i)}TryGlueOrdered(e,t,i,n){return!n.has(e)&&!i.has(e)&&this.StationGluingIsAllowed(e,t,n)?(this.Map(e,t,i,n),!0):!1}Map(e,t,i,n){n.set(e,t),i.add(t)}StationGluingIsAllowed(e,t,i){for(let o of e.Neighbors){let a=zo.Glued(o,i),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,i)<0)}ComputeCostDeltaAfterStationGluing(e,t,i){let n=e.Position.sub(t.Position).length;if(e.Radius>=n||t.Radius>=n)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=zo.Glued(u,i);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)===0?c.Position.sub(t.Position).length:0}o+=vr.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,f=d.prev,p=d.next;h-=f.point.sub(e.Position).length+p.point.sub(e.Position).length,h+=f.point.sub(t.Position).length+p.point.sub(t.Position).length,o+=vr.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let i=this.metroGraphData.Metrolines[t].Polyline;for(let a of i)if(!this.metroGraphData.PointToStations.has(a))return;let n=!1;for(let a of i)if(e.has(this.metroGraphData.PointToStations.get(a))){n=!0;break}if(!n)return;let o=Array.from(i).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=ie.mkFromPoints(zo.GluedPolyline(o,e))}static GluedPolyline(e,t){let i,n=new nC.Stack;n.push(e[0]);let o=new Set;for(i=1;i<e.length-1;i++){let a=zo.Glued(e[i],t);if(o.has(a)){for(;n.top!==a;)o.delete(n.pop());continue}m.closeDistEps(a.Position,n.top.Position)||(o.add(a),n.push(a))}return n.push(e[i]),Array.from(n).reverse().map(a=>a.Position)}static Glued(e,t){var i;return(i=t.get(e))!=null?i:e}UnglueEdgesFromBundleToSaveInk(e){let t=new Kn;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new pt(a.point,a.next.point);Jy(t,l,o)}}let i=new He,n=!1;for(let o of this.metroGraphData.Metrolines){let a=zn(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,i,a)&&(n=!0)}return n&&this.metroGraphData.Initialize(!1),(e||n)&&vn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:i),n}TrySeparateOnPolyline(e,t,i,n){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,i,n)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,i,n){return this.SeparationShortcutAllowed(e,t,n)?(i.add(e.point),i.add(e.next.point),i.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,i){let n=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(n),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=Un(l.getELP(),c.getELP()),d=pv([i,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,n,o,a)<0)}GetInkgain(e,t,i,n,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,f=i.sub(n).length,p=n.sub(o).length,S=i.sub(o).length;a.size===u.size&&(d-=f),l.size===u.size&&(d-=p);let x=t.get(new pt(i,o));(!x||x.size===0)&&(d+=S),c+=vr.InkError(h,d,this.bundlingSettings);for(let X of u){let K=this.polylineLength.get(X),se=K-(f+p-S);c+=vr.PathLengthsError(K,se,X.IdealLength,this.bundlingSettings)}let C=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(i)),O=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),B=this.metroGraphData.GetWidthAN(Array.from(gs(a,u)),this.bundlingSettings.EdgeSeparation),I=Vt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(C,i,o,n,O,B,this.bundlingSettings);I>C&&(c-=vr.RError(I,C,this.bundlingSettings)),C=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let _=this.metroGraphData.GetWidthAN(Array.from(gs(l,u)),this.bundlingSettings.EdgeSeparation);return I=Vt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(C,o,n,i,_,O,this.bundlingSettings),I>C&&(c-=vr.RError(I,C,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=Ue(i,n),h=Ue(n,o),d=Ue(i,o);a.size===u.size&&(this.ink-=c),l.size===u.size&&(this.ink-=h);let f=t.get(new pt(i,o));(!f||f.size===0)&&(this.ink+=d);for(let p of u){let S=this.polylineLength.get(p);this.polylineLength.set(p,S-(c+h-d))}for(let p of u){let S=Array.from(p.Polyline.polylinePoints()).find(x=>x.point.equal(n));this.RemovePolypoint(S),$y(t,[i,n],p),$y(t,[n,o],p),mv(t,[i,o],p)}}FindPolylines(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,a=t.get_(i,n),l=t.get_(n,o),u=zn(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,i=e.next;t.next=i,i.prev=t}GlueCollinearNeighbors(e){let t=new He,i=!1;for(let n of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(n,t,e)&&(i=!0);return i&&(this.metroGraphData.Initialize(!1),vn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),i}GlueCollinearNeighborsSPN(e,t,i){if(e.Neighbors.length<=1)return!1;let n=new Bc,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],n,i);if(n.isEmpty)return!1;for(let a of n)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,i,n,o){if(m.anglePCP(t.Position,e.Position,i.Position)<this.bundlingSettings.AngleThreshold){let l=Ue(t.Position,e.Position),u=Ue(i.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,i)){this.AddEdgeToGlue(e,i,t,t.Position,n);return}}else if(this.EdgeGluingIsAllowedSSS(e,i,t)){this.AddEdgeToGlue(e,t,i,i.Position,n);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,i);this.EdgeGluingIsAllowedSSSP(e,t,i,h)&&this.AddEdgeToGlue(e,i,t,h,n)}}}ConstructGluingPoint(e,t,i){let n=Math.min(Ue(t.Position,e.Position),Ue(i.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(i.Position.sub(e.Position).normalize());return e.Position.add(o.mul(n/2))}EdgeGluingIsAllowedSSS(e,t,i){if(t.IsReal||i.IsReal||!_l(t.getELP(),i.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,i,t.Position,i.Position))return!1;let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,i);return!(Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(G.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||Ke.IntersectionsOfLineAndRectangleNodeOverPolylineLR(G.mkPP(t.Position,i.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,i,n){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(n,0,zn(t.getELP(),i.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(i,null,i.Position,n)||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,n)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,i,n){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-Ue(e.Position,i.Position)-Ue(e.Position,t.Position)+Ue(e.Position,n)+Ue(n,t.Position)+Ue(n,i.Position);o+=vr.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,i).Metrolines){let f=d.Length,p=d.Length-Ue(e.Position,i.Position)+Ue(e.Position,n)+Ue(n,i.Position);o+=vr.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let f=d.Length,p=d.Length-Ue(e.Position,t.Position)+Ue(e.Position,n)+Ue(n,t.Position);o+=vr.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Vt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,i,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=vr.RError(h,c,this.bundlingSettings)),u>Ue(e.Position,n)&&!e.IsReal&&(o-=vr.RError(u,Ue(e.Position,n),this.bundlingSettings)),o}AddEdgeToGlue(e,t,i,n,o){o.has(i,e)||o.has(t,e)||o.has(e,i)||o.has(e,t)||(o.set(e,i,n),o.set(e,t,n))}GlueEdge(e){let t=e[0],i=e[1],n=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(i.Position)?this.SplitPolylinePoint(o,n):o.prev!=null&&o.prev.point.equal(i.Position)&&this.SplitPolylinePoint(o.prev,n)}SplitPolylinePoint(e,t){if(e.point===t||e.next.point===t)return;let i=Mt.mkFromPoint(t);i.polyline=e.polyline,i.next=e.next,i.prev=e,i.next.prev=i,i.prev.next=i}RelaxConstrainedEdges(){let e=new He,t=!1;for(let i of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(i[0],i[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),vn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*n/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(Ue(e.Position,c[1]),Ue(t.Position,c[1])),d=Ue(e.Position,t.Position);if(h/d<.1)continue;let p=Ue(c[0],c[1]);(l===-1||p<l)&&(l=p,u=c[1])}if(l===-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,zn(e.getELP(),t.getELP())))return!1;i.add(u),i.add(e.Position),i.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new Es(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),vn.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var Zl=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,i.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new Sr;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!Zl.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!Zl.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof ar}ProcessNeighbor(e,t,i){let n=t.Length,o=this._current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var vs=class extends Pe{constructor(t,i,n,o,a,l,u,c,h,d){super(null);this.bundlingSettings=o,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=t,this.regularEdges=t.filter(f=>f.source!==f.target),this.VisibilityGraph=n,this.shortestPathRouter=i,this.LoosePadding=a,this.LooseHierarchy=u,this.TightHierarchy=l,this.EdgeLooseEnterable=c,this.EdgeTightEnterable=h,this.loosePolylineOfPort=d,wc(0)}ThereAreOverlaps(t){return Ki(t,t,R.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let t=new Sm(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.cdt,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);zo.FixRouting(t,this.bundlingSettings),new xs(t,this.bundlingSettings).run()}FixChildParentEdges(){for(let t of this.regularEdges){let i=t.sourcePort,n=t.targetPort;if(i.Curve.boundingBox.containsRect(n.Curve.boundingBox)){let o=R.intersectionOne(i.Curve,G.mkPP(t.curve.start,t.curve.end),!1),a=t.curve;a.startPoint.point=o.x}if(n.Curve.boundingBox.containsRect(i.Curve.boundingBox)){let o=R.intersectionOne(n.Curve,G.mkPP(t.curve.start,t.curve.end),!0),a=t.curve;a.endPoint.point=o.x}}}FixLocationsForHookAnywherePorts(t){for(let i of t){let n=i.sourcePort instanceof Ft;if(n){let o=i.sourcePort;o.SetLocation(this.FigureOutHookLocation(o.LoosePolyline,i.targetPort,i))}else if(n=i.targetPort instanceof Ft,n){let o=i.targetPort;o.SetLocation(this.FigureOutHookLocation(o.LoosePolyline,i.sourcePort,i))}}}FigureOutHookLocation(t,i,n){return i instanceof Er?this.FigureOutHookLocationForClusterOtherPort(t,i,n):this.FigureOutHookLocationForSimpleOtherPort(t,i,n)}FigureOutHookLocationForClusterOtherPort(t,i,n){let o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),l=new Zl(Array.from(i.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(t).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}FigureOutHookLocationForSimpleOtherPort(t,i,n){let o=i.Location,a=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),u=new ys(this.VisibilityGraph.FindVertex(o),Array.from(t).map(c=>this.VisibilityGraph.FindVertex(c)),this.VisibilityGraph).GetPath();for(let c of a)c.IsTransparent=!1;return u[u.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.cdt!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let t=new Map;this.shortestPathRouter.FillCrossedCdtEdges(t);let i=this.GetPathsOnCdtEdge(t);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(i)}GetPathsOnCdtEdge(t){let i=new Map;for(let n of t.keys())for(let o of t.get(n))Nl(i,o,n);return i}CalculateEdgeWidthShrinkCoeff(t){let i=0,n=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(t,n))return n;let o=!1;for(;!o||Math.abs(n-i)>.01;){let a=(i+n)/2;this.EdgeSeparationIsOkMN(t,a)?(i=a,o=!0):n=a}return i}EdgeSeparationIsOkMN(t,i){for(let n of t.keys())if(!this.EdgeSeparationIsOk(n,t.get(n),i))return!1;return!0}EdgeSeparationIsOk(t,i,n){return Array.from(i).map(a=>this.bundlingSettings.ActualEdgeWidth(a,n)).reduce((a,l)=>a+l,0)<=t.Capacity}RouteSelfEdges(){for(let t of this.edgesToRoute)if(t.source===t.target){let i={smoothedPolyline:null};t.curve=We.RouteSelfEdge(t.source.boundaryCurve,this.LoosePadding*2,i)}}FixArrowheads(){for(let t of this.edgesToRoute)mt.trimSplineAndCalculateArrowheadsII(t,t.source.boundaryCurve,t.target.boundaryCurve,t.curve,!1)}};vs.SuperLoosePaddingCoefficient=1.1;var vm=class{constructor(e,t,i){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=i}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var Cm=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source===this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var Cn=class{constructor(e,t,i){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.cdt=t,this.Gates=i}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let i of t.InEdges){let n=new vm(i,this.VisibilityVerticesToSdVerts.get(i.Source),this.VisibilityVerticesToSdVerts.get(i.Target)),o=this.VisibilityVerticesToSdVerts.get(i.Source);e.InBoneEdges.push(n),o.OutBoneEdges.push(n)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new Cm(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new ie,i=this.EdgesToRouteSources.get(e);t.addPoint(i.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(i.Point)?(t.addPoint(a.TargetPoint),i=a.Target):(t.addPoint(a.SourcePoint),i=a.Source);e.curve=t,e.sourcePort instanceof Er&&Cn.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof Er&&Cn.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let i=t.closestParameter(e.end);e.addPoint(t.value(i))}static ExtendPolylineStartToClusterBoundary(e,t){let i=t.closestParameter(e.start);e.PrependPoint(t.value(i))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.cdt!=null&&this.cdt.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let i of t)i.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let n=0;n<this.vertexArray.length;n++){let o=this.vertexArray[n];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),i=this.RouteEdgeWithGroups();for(let n of t)n.IsTransparent=!1;return i}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new Sr,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e===0);if(t!=null)return t;for(let i=0;i<this.vertexArray.length;i++)this.vertexArray[i].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let i={priority:0},n=this.Queue.DequeueAndGetPriority(i);if(!(i.priority>=this.LowestCostToTarget)){for(let o=0;o<n.OutBoneEdges.length;o++){let a=n.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(n,a,e,t)}for(let o=0;o<n.InBoneEdges.length;o++){let a=n.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(n,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,i,n){n&&i.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,i,n){n&&i.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,i){let n=this.GetEdgeAdditionalCost(i,e.Cost);if(!(t.Cost<=n))if(t.Cost=n,t.PrevEdge=i,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,n);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof Er&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),n+o<this.LowestCostToTarget&&(this.LowestCostToTarget=n+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.cdt!=null&&this.BundlingSettings.CapacityOverflowCoefficient!==0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity===t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let i=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*i+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*i)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.cdt==null||this.BundlingSettings.CapacityOverflowCoefficient===0)return 0;let t=0;for(let i of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,i);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,i=e.Source.Triangle,n=new Set,o=e.TargetPoint;if(je.PointIsInsideOfTriangle(o,i))return n;let a=new Ta(i,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&n.add(l)}return n}static CostOfCrossingCdtEdge(e,t,i,n){let o=i.lineWidth*t.edgeWidthShrinkCoeff;n.Capacity!==n.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=n.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,i,n){return this.AdjacentToSourceOrTarget(n)?0:Cn.CostOfCrossingCdtEdge(e,t,i,n)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner===this.sourceLoosePoly||e.lowerSite.Owner===this.sourceLoosePoly||e.upperSite.Owner===this.targetLoosePoly||e.lowerSite.Owner===this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let i;if(e instanceof Er){i=e.LoosePolyline;for(let o of i){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof Ft){i=e.LoosePolyline;for(let o of i)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let n=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=n[0].boundingBox.diagonal;i=n[0];for(let a=1;a<n.length;a++){let l=n[a],u=l.boundingBox.diagonal;u<o&&(o=u,i=l)}}return i}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,i){let n=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(n);t?(o.IsSourceOfRouting=!0,o.Cost=i,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.cdt!=null&&(this.capacityOverlowPenaltyMultiplier=Cn.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)Cn.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,i=e.lowerSite.Owner;if(t!==i){let n=$t.DistancePoint(new $t(t),e.lowerSite.point),o=$t.DistancePoint(new $t(i),e.upperSite.point);e.Capacity=(n+o)/2}}SetVertexTriangles(){let e=et(Array.from(this.cdt.GetTriangles()).map(i=>lt(i,i.BoundingBox()))),t=et(this.vertexArray.map(i=>lt(i,q.mkOnPoints([i.Point]))));$r(e,t,(i,n)=>this.TryToAssigenTriangleToVertex(i,n))}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&je.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let i of this.EdgesToRoutes.get(t))for(let n of this.CrossedCdtEdgesOfBoneEdge(i))this.AdjacentToSourceOrTarget(n)||Nl(e,t,n)}}};var Ql=class{constructor(e,t,i,n,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=fc(i,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new vs(e.edges,new Cn(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(i,n)=>R.PointRelativeToCurveLocation(i,n)!==0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,i={preGraphs:e};if(this.UniteConnectedPreGraphs(i),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=Ql.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let i=Xn(t),n=new Array;for(let o of i){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],n.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=n;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let i of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(i)}static GetIntersectionGraphOfPreGraphs(e){let t=Ql.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?yr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),i=fc(t,o=>e[o].boundingBox),n=new Array;return Ht(i,i,(o,a)=>n.push(new ye(o,a))),n}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,i=e[0],n=this.GetPortCurve(i.sourcePort),o=n.boundingBox;t.add(n),t.add(i.targetPort.Curve),o.addRec(i.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return _c.constructorStatic(e,t)}};var E0=Ae(kn(),1);var Am=class{constructor(){this.triangles=new Set}setCdt(e){this.cdt=e,e&&(this.cdtTree=this.cdt.getRectangleNodeOnTriangles())}findTrianglesIntersectingThePolyline(){this.triangles.clear();let e=this.getPointTrianglesInTheGlobalCdt(this.poly.start);for(let t=this.poly.startPoint;t.next;t=t.next)this.addLineSeg(e,t.point,t.next.point)}getPointTrianglesInTheGlobalCdt(e){let t=new Set;for(let i of this.cdtTree.AllHitItems(q.mkOnPoints([e]),n=>n.containsPoint(e)))t.add(i);return t}addLineSeg(e,t,i){let n=new E0.Queue,o=new Set,a=[];for(let c of e)u(c,()=>!0),c.containsPoint(i)&&a.push(c);e.clear();for(let c of a)e.add(c);let l;for(;n.length>0;){l=n.dequeue(),this.addToTriangles(l);for(let c of l.Edges){let h=c.GetOtherTriangle_T(l);h==null||o.has(h)||h.intersectsLine(t,i)&&u(h,d=>this.canBelongToTriangles(d))}}return e;function u(c,h){n.enqueue(c),o.add(c),h(c)&&c.containsPoint(i)&&e.add(c)}}canBelongToTriangles(e){let t=e.Sites.item0.Owner;return t===this.sourcePoly||t===this.targetPoly||!A2(e)}addToTriangles(e){this.canBelongToTriangles(e)&&this.triangles.add(e)}run(e,t,i){if(this.poly=e,e.count<=2||this.cdt==null)return;this.sourcePoly=t,this.targetPoly=i,this.findTrianglesIntersectingThePolyline();let n=this.getPerimeterEdges(),o=new je([],[],Array.from(n).map(l=>({A:l.lowerSite.point,B:l.upperSite.point})));o.run();let a=this.getSleeve(this.findSourceTriangle(o));a!=null&&(this.initDiagonals(a),this.refineFunnel())}findSourceTriangle(e){let t;for(let i of e.GetTriangles())if(i.containsPoint(this.poly.start)){t=i;break}return t}refineFunnel(){let e=[],t=this.poly.start,i={point:t},n={point:t},o={point:this.d[0].left,prev:i},a={point:this.d[0].right,prev:n};i.next=o,n.next=a;let l;for(let I=1;I<this.d.length;I++)c(I,this.d);this.d.push({right:this.poly.end,left:o.point}),c(this.d.length-1,this.d);let u=ie.mkFromPoints(e);for(let I=n;I!=null;I=I.next)u.addPoint(I.point);this.poly=u;function c(I,_){if(_[I-1].left!==_[I].left){l=_[I].left;let K=o;for(;!(C(K)||f(K));K=K.prev);C(K)?S():B(K)}else{l=_[I].right;let K=a;for(;!(C(K)||p(K));K=K.prev);C(K)?x():O(K)}}function h(I){return I.next==null?!0:m.pointToTheLeftOfLineOrOnLine(l,I.point,I.next.point)}function d(I){return I.next==null?!0:m.pointToTheRightOfLineOrOnLine(l,I.point,I.next.point)}function f(I){return m.pointToTheLeftOfLine(l,I.prev.point,I.point)}function p(I){return m.pointToTheRightOfLine(l,I.prev.point,I.point)}function S(){let I=n;for(;!h(I);)I=I.next;if(!C(I)){let _=n;for(;!_.point.equal(I.point);_=_.next)e.push(_.point);n.point=_.point,n.next=_.next,t=_.point,a.point.equal(n.point)&&(a.prev=a.next=null)}i.point=t,o.point=l,o.prev=i,i.next=o}function x(){let I=i;for(;!d(I);)I=I.next;if(!C(I)){let _=i;for(;!_.point.equal(I.point);_=_.next)e.push(_.point);i.point=_.point,i.next=_.next,t=_.point,o.point.equal(i.point)&&(o.prev=i.next=null)}n.point=t,a.point=l,a.prev=n,n.next=a}function C(I){return I.point==t}function O(I){I!=a?(a.point=l,a.prev=I,I.next=a):(a={point:l,prev:I},I.next=a)}function B(I){I!=o?(o.point=l,o.prev=I,I.next=o):(o={point:l,prev:I},I.next=o)}}initDiagonals(e){this.d=[];for(let t of e){let i=t.edge,n=t.source.OppositeSite(i);m.getTriangleOrientation(n.point,i.lowerSite.point,i.upperSite.point)==1?this.d.push({left:i.upperSite.point,right:i.lowerSite.point}):this.d.push({right:i.upperSite.point,left:i.lowerSite.point})}}getSleeve(e){let t=new E0.Queue;t.enqueue(e);let i=new Map;for(i.set(e,void 0);t.length>0;){let n=t.dequeue(),o=i.get(n);if(n.containsPoint(this.poly.end))return this.recoverPath(e,i,n);for(let a of n.Edges){if(a.constrained||o!==void 0&&a===o.edge)continue;let l=a.GetOtherTriangle_T(n);l!=null&&(i.set(l,{source:n,edge:a}),t.enqueue(l))}}}recoverPath(e,t,i){let n=[];for(let o=i;o!=e&&o!==e;){let a=t.get(o);n.push(a),o=a.source}return n.reverse()}getPerimeterEdges(){let e=new Set;for(let t of this.triangles)for(let i of t.Edges)this.triangles.has(i.GetOtherTriangle_T(t))||e.add(i);return e}};function A2(s){return s.Sites.item0.Owner!=null&&s.Sites.item0.Owner==s.Sites.item1.Owner&&s.Sites.item0.Owner==s.Sites.item2.Owner}var ze=class extends Pe{constructor(t,i,n=1,o=2,a=30*(Math.PI/180),l=null,u=null){super(u);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.multiEdgesSeparation=.5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this.edges=i,this.BundlingSettings=l,this.geomGraph=t,this.LoosePadding=o,this.tightPadding=n,this.coneAngle=a,this.routeMultiEdgesAsBundles=i.length<1e3&&t.deepNodeCount<1e3}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(t){this.continueOnOverlaps=t}get LoosePadding(){return this.loosePadding}set LoosePadding(t){this.loosePadding=t}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(t){this.multiEdgesSeparation=t}static mk2(t,i){return ze.mk5(t,i.Padding,i.PolylinePadding,i.ConeAngle,i.bundlingSettings)}static mk4(t,i,n,o){return new ze(t,Array.from(t.deepEdges),i,n,o,null)}static mk5(t,i,n,o,a){return new ze(t,Array.from(t.deepEdges),i,n,o,a)}static mk6(t,i,n,o,a,l){let u=ze.mk4(t,i,n,o),c=_i.GetShapes(a,l);return u.Initialize(c,o),u}Initialize(t,i){this.rootShapes=t.filter(n=>n.Parents==null||n.Parents.length===0),this.coneAngle=i,this.coneAngle===0&&(this.coneAngle=Math.PI/6)}run(){if(this.edges.length==0||this.geomGraph.isEmpty())return;let t=Nr.GetShapes(this.geomGraph,this.edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings),this.Initialize(t,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){wc(0),this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[t,i]of this.portsToShapes){let n=new Set;ze.EdgesAttachedToPortAvoidTheNode(t)||n.add(i),this.portsToEnterableShapes.set(t,n)}for(let t of this.rootShapes)for(let i of t.Descendants())for(let n of i.Ports){let o=this.portsToEnterableShapes.get(n);Ol(o,Array.from(i.Ancestors()).filter(a=>a.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(t){return t instanceof Or||t instanceof Er}SetLoosePolylinesForAnywherePorts(){for(let[t,i]of this.shapesToTightLooseCouples)for(let n of t.Ports){if(n instanceof Ft){let a=n;a.LoosePolyline=i.LooseShape.BoundaryCurve}if(n instanceof Er){let a=n;a.LoosePolyline=i.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new Mo;for(let t of this.root.Children){let i=this.shapesToTightLooseCouples.get(t).LooseShape;this.BindLooseShapesUnderShape(t),this.looseRoot.AddChild(i)}}BindLooseShapesUnderShape(t){let i=this.shapesToTightLooseCouples.get(t).LooseShape;for(let n of t.Children){let o=this.shapesToTightLooseCouples.get(n).LooseShape;i.AddChild(o),this.BindLooseShapesUnderShape(n)}}CalculateShapeToBoundaries(t){if(this.ProgressStep(),t.Children.length!==0){for(let i of t.Children)this.CalculateShapeToBoundaries(i);this.obstacleCalculator=new Rc(t,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples),this.obstacleCalculator.Calculate(!0),this.OverlapsDetected||(this.OverlapsDetected=this.obstacleCalculator.OverlapsDetected)}}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(t){this._overlapsDetected=t}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*vs.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let t=new Array;for(let i of this.edges){let n=this.EdgePassport(i),o=t.find(a=>_l(a.passport,n));o||(o={passport:n,edges:[]},t.push(o)),o.edges.push(i)}return t}RouteOnVisGraph(){if(this.ancestorSets=ze.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let t of this.GroupEdgesByPassport()){let i=t.passport,n=this.GetObstaclesFromPassport(i),o=this.CreateInteractiveEdgeRouter(Array.from(n));this.RouteEdgesWithTheSamePassport(t,o,n)}else this.RouteBundles()}getDebugCurvesFromEdgesAndCdt(t){let i=Array.from(this.geomGraph.deepEdges).map(n=>n.curve).filter(n=>n!=null).filter(n=>n.count>5).map(n=>pe.mkDebugCurveTWCI(200,1,"Red",n));for(let n of t.PointsToSites.values())for(let o of n.Edges)i.push(pe.mkDebugCurveTWCI(200,.5,o.constrained?"Blue":"Green",G.mkPP(o.lowerSite.point,o.upperSite.point)));return i}RouteEdgesWithTheSamePassport(t,i,n){let o={regularEdges:[],multiEdges:[]};try{let a=this.getCdtFromShapes(n);i.pathOptimizer.setCdt(a)}catch(a){console.log(a),i.pathOptimizer.setCdt(null)}if(this.RouteMultiEdgesAsBundles){if(this.SplitOnRegularAndMultiedges(t.edges,o),o.regularEdges.length>0)for(let a=0;a<o.regularEdges.length;a++)this.routeEdge(i,o.regularEdges[a]);o.multiEdges!=null&&(this.ScaleDownLooseHierarchy(i,n),this.RouteMultiEdges(o.multiEdges,i,t.passport))}else for(let a of t.edges)this.routeEdge(i,a)}getCdtFromShapes(t){let i=new Set;for(let l of t){let u=this.LoosePolyOfOriginalShape(l);u!=null&&i.add(u)}let n=this.geomGraph.boundingBox.clone();n.pad(Math.max(n.diagonal/4,100));let o=Array.from(i);o.push(n.perimeter());let a=new je([],o,[]);return a.run(),a}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(t){this.routeMultiEdgesAsBundles=t}routeEdge(t,i){let n=this.makeTransparentShapesOfEdgeAndGetTheShapes(i);this.ProgressStep(),this.RouteEdgeInternal(i,t),ze.SetTransparency(n,!1)}ScaleDownLooseHierarchy(t,i){let n=new Array;for(let o of i){let a=this.shapesToTightLooseCouples.get(o);n.push(er.LoosePolylineWithFewCorners(a.TightPolyline,a.Distance/1.1,!1))}t.LooseHierarchy=ze.CreateLooseObstacleHierarachy(n),t.ClearActivePolygons(),t.AddActivePolygons(n.map(o=>new $t(o)))}RouteMultiEdges(t,i,n){let o=[];for(let u of n)for(let c of u.Children)o.push(c.BoundaryCurve);let a=new Sn;a.InkImportance=1e-5,a.EdgeSeparation=this.MultiEdgesSeparation,new Ql(t,i,o,a,u=>this.makeTransparentShapesOfEdgeAndGetTheShapes(u)).run()}SplitOnRegularAndMultiedges(t,i){let n=new Kn;for(let o of t)ze.IsEdgeToParent(o)?i.regularEdges.push(o):ze.RegisterInPortLocationsToEdges(o,n);i.multiEdges=null;for(let o of n.values())o.length===1||this.OverlapsDetected?To(i.regularEdges,o):(i.multiEdges==null&&(i.multiEdges=new Array),i.multiEdges.push(o))}static RegisterInPortLocationsToEdges(t,i){let n,o=new pt(t.sourcePort.Location,t.targetPort.Location);n=i.get(o),n||(n=new Array,i.set(o,n)),n.push(t)}static IsEdgeToParent(t){return t.sourcePort instanceof Ft||t.targetPort instanceof Ft}CreateInteractiveEdgeRouter(t){let i=new Set(t.map(o=>this.shapesToTightLooseCouples.get(o).LooseShape.BoundaryCurve)),n=new Ke(this.cancelToken);return n.pathOptimizer=new Am,n.ObstacleCalculator=new er(t.map(o=>o.BoundaryCurve),this.tightPadding,this.loosePadding,!1),n.VisibilityGraph=this.visGraph,n.TightHierarchy=this.CreateTightObstacleHierarachy(t),n.LooseHierarchy=ze.CreateLooseObstacleHierarachy(Array.from(i)),n.UseSpanner=!0,n.LookForRoundedVertices=!0,n.TightPadding=this.tightPadding,n.LoosePadding=this.LoosePadding,n.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,n.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,n.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,n.AllowedShootingStraightLines=this.AllowedShootingStraightLines,n.AddActivePolygons(Array.from(i).map(o=>new $t(o))),n}GetObstaclesFromPassport(t){if(t.size===0)return new Set(this.root.Children);let i=this.GetCommonAncestorsAbovePassport(t),n=this.GetAllAncestors(t),o=new Set;for(let u of t)for(let c of u.Children)n.has(c)||o.add(c);let a=Un(new Set(t),o),l=new oC.Queue;for(let u of t)i.has(u)||l.enqueue(u);for(;l.length>0;){let u=l.dequeue();for(let c of u.Parents){for(let h of c.Children)n.has(h)||o.add(h);!i.has(c)&&!a.has(c)&&(l.enqueue(c),a.add(c))}}return o}GetAllAncestors(t){if(t.size===0)return new Set;let i=new Set(t);for(let n of t)i=Un(i,this.ancestorSets.get(n));return i}GetCommonAncestorsAbovePassport(t){if(t.size===0)return new Set;let i=Array.from(t),n=this.ancestorSets.get(i[0]);for(let o=1;o<i.length;o++){let a=i[o];n=zn(n,this.ancestorSets.get(a))}return n}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let t=this.GetLooseHierarchy(),i=pm(t),n=new Cn(a=>this.makeTransparentShapesOfEdgeAndGetTheShapes(a),i,this.FindCdtGates(i));new vs(this.edges,n,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),t,this.enterableLoose,this.enterableTight,a=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(a))).run()}CreateTheMapToParentLooseShapes(t,i){for(let n of t.Children){let a=this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve;i.set(a,t),this.CreateTheMapToParentLooseShapes(n,i)}}FindCdtGates(t){let i=new Map;this.CreateTheMapToParentLooseShapes(this.root,i);let n=new Set;for(let o of t.PointsToSites.values())for(let a of o.Edges){if(a.CwTriangle==null&&a.CcwTriangle==null)continue;let l=o.Owner,u=a.lowerSite.Owner;if(l===u)continue;let c=i.get(l);if(c){let h=i.get(u);c===h&&n.add(a)}}return n}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let t of this.edges){let i=new Set,n=new Set;this.GetEdgeEnterablePolylines(t,i,n),this.enterableLoose.set(t,i),this.enterableTight.set(t,n)}}GetEdgeEnterablePolylines(t,i,n){let o=this.portsToShapes.get(t.sourcePort),a=this.portsToShapes.get(t.targetPort);o!==this.root&&this.GetEnterablesForShape(o,i,n),a!==this.root&&this.GetEnterablesForShape(a,i,n)}GetEnterablesForShape(t,i,n){for(let o of this.ancestorSets.get(t)){let a=this.LoosePolyOfOriginalShape(o);a&&i.add(a);let l=this.TightPolyOfOriginalShape(o);l&&n.add(l)}}GetTightHierarchy(){return et(Array.from(this.shapesToTightLooseCouples.values()).map(t=>lt(t.TightPolyline,t.TightPolyline.boundingBox)))}GetLooseHierarchy(){let t=new Set;for(let i of this.shapesToTightLooseCouples.values())t.add(i.LooseShape.BoundaryCurve);return et(Array.from(t).map(i=>lt(i,i.boundingBox)))}ScaleLooseShapesDown(){for(let[,t]of this.shapesToTightLooseCouples)t.LooseShape.BoundaryCurve=er.LoosePolylineWithFewCorners(t.TightPolyline,t.Distance/vs.SuperLoosePaddingCoefficient,!1)}EdgePassport(t){let i=new Set,n=this.portsToShapes.get(t.sourcePort),o=this.portsToShapes.get(t.targetPort);return this.IsAncestor(n,o)?(Ol(i,o.Parents),i.add(n),i):this.IsAncestor(o,n)?(Ol(i,n.Parents),i.add(o),i):(n!==this.looseRoot&&Ol(i,n.Parents),o!==this.looseRoot&&Ol(i,o.Parents),i)}*AllPorts(){for(let t of this.edges)yield t.sourcePort,yield t.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let t of this.root.Descendants())for(let i of t.Ports)this.portsToShapes.set(i,t);for(let t of this.AllPorts())this.portsToShapes.has(t)||(this.root.Ports.add(t),this.portsToShapes.set(t,this.root))}RouteEdgeInternal(t,i){let n=new Array;t.sourcePort instanceof Ft||To(n,this.AddVisibilityEdgesFromPort(t.sourcePort)),t.targetPort instanceof Ft||To(n,this.AddVisibilityEdgesFromPort(t.targetPort));let o={smoothedPolyline:null};if(m.closeDistEps(t.sourcePort.Location,t.targetPort.Location)?t.curve=We.RouteSelfEdge(t.sourcePort.Curve,Math.max(this.LoosePadding*2,t.GetMaxArrowheadLength()),o):t.curve=i.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(t.sourcePort,t.targetPort,!0,o),t.smoothedPolyline=o.smoothedPolyline,t.curve==null)throw new Error;for(let a of n)Ye.RemoveEdge(a);mt.trimSplineAndCalculateArrowheadsII(t,t.sourcePort.Curve,t.targetPort.Curve,t.curve,!1)}*AddVisibilityEdgesFromPort(t){let i,n;if(t instanceof Or||!(i=this.portsToShapes.get(t))||!(n=this.shapesToTightLooseCouples.get(i)))return;let o=n.LooseShape;for(let a of o.BoundaryCurve)this.visGraph.FindEdgePP(t.Location,a)==null&&(yield this.visGraph.AddEdgePP(t.Location,a))}makeTransparentShapesOfEdgeAndGetTheShapes(t){let i=this.portsToShapes.get(t.sourcePort),n=this.portsToShapes.get(t.targetPort),o=new Array;for(let a of this.GetTransparentShapes(t.sourcePort,t.targetPort,i,n))a!=null&&o.push(this.LooseShapeOfOriginalShape(a));for(let a of this.portsToEnterableShapes.get(t.sourcePort))o.push(this.LooseShapeOfOriginalShape(a));for(let a of this.portsToEnterableShapes.get(t.targetPort))o.push(this.LooseShapeOfOriginalShape(a));return ze.SetTransparency(o,!0),o}LooseShapeOfOriginalShape(t){return t===this.root?this.looseRoot:this.shapesToTightLooseCouples.get(t).LooseShape}LoosePolyOfOriginalShape(t){return this.LooseShapeOfOriginalShape(t).BoundaryCurve}TightPolyOfOriginalShape(t){return t===this.root?null:this.shapesToTightLooseCouples.get(t).TightPolyline}*GetTransparentShapes(t,i,n,o){for(let a of this.ancestorSets.get(n))yield a;for(let a of this.ancestorSets.get(o))yield a;ze.EdgesAttachedToPortAvoidTheNode(t)||(yield n),ze.EdgesAttachedToPortAvoidTheNode(i)||(yield o)}static SetTransparency(t,i){for(let n of t)n.IsTransparent=i}IsAncestor(t,i){let n;return i!=null&&(n=this.ancestorSets.get(i))!=null&&n.has(t)}static CreateLooseObstacleHierarachy(t){return et(t.map(i=>lt(i,i.boundingBox)))}CreateTightObstacleHierarachy(t){let i=t.map(n=>this.shapesToTightLooseCouples.get(n).TightPolyline);return et(i.map(n=>lt(n,n.boundingBox)))}CalculateVisibilityGraph(){let t=this.LineSweeperPorts!=null?He.mk(this.LineSweeperPorts):new He;this.ProcessHookAnyWherePorts(t),this.portRTree=hs(Array.from(t.values()).map(i=>[q.rectangleOnPoint(i),i])),this.visGraph=new Ye,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(t,i,n,o=null,a=null){let l=Array.from(i.Edges).map(u=>pe.mkDebugCurveTWCI(100,1,u.IsPassable!=null&&u.IsPassable()?"green":"black",G.mkPP(u.SourcePoint,u.TargetPoint)));if(n!=null)for(let u of n){l.push(pe.mkDebugCurveTWCI(100,.3,"brown",u));for(let c of u)l.push(pe.mkDebugCurveTWCI(100,1,"green",_e.mkCircle(1,c)))}if(o!=null)for(let u of o)l.push(pe.mkDebugCurveTWCI(100,10,"navy",u));if(a!=null)for(let u of a)l.push(pe.mkDebugCurveTWCI(100,10,"red",u))}ProcessHookAnyWherePorts(t){for(let i of this.edges)i.sourcePort instanceof Ft||i.sourcePort instanceof Er||t.add(i.sourcePort.Location),i.targetPort instanceof Ft||i.targetPort instanceof Er||t.add(i.targetPort.Location)}FillVisibilityGraphUnderShape(t){let i=t.Children;for(let d of i)this.FillVisibilityGraphUnderShape(d);let n=this.shapesToTightLooseCouples.get(t),o=n?n.LooseShape.BoundaryCurve:null,a=n?n.LooseShape:this.looseRoot,l=new Set(a.Children.map(d=>d.BoundaryCurve)),u=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(o),c=new Ye,h=Bo.mk([],c,this.coneAngle,u,o);h.run(),c=new Ye,h=Bo.mk(Array.from(l),c,this.coneAngle,u,o),h.run(),this.ProgressStep();for(let d of c.Edges)this.TryToCreateNewEdgeAndSetIsPassable(d,a);this.AddBoundaryEdgesToVisGraph(o)}get Bidirectional(){return this.bidirectional}set Bidirectional(t){this.bidirectional=t}TryToCreateNewEdgeAndSetIsPassable(t,i){let n=this.visGraph.FindEdgePP(t.SourcePoint,t.TargetPoint);n==null&&(n=this.visGraph.AddEdgePP(t.SourcePoint,t.TargetPoint),i!=null&&(n.IsPassable=()=>i.IsTransparent))}AddBoundaryEdgesToVisGraph(t){if(t==null)return;let i;for(let n=t.startPoint;i=n.nextOnPolyline,this.visGraph.AddEdgePP(n.point,i.point),i!==t.startPoint;n=i);}RemoveInsidePortsAndSplitBoundaryIfNeeded(t){let i=new He;if(t==null){for(let a of this.portRTree.GetAllLeaves())i.add(a);return this.portRTree.clear(),i}let n=t.boundingBox,o=this.portRTree.GetAllIntersecting(n);for(let a of o)switch(R.PointRelativeToCurveLocation(a,t)){case 2:i.add(a),this.portRTree.Remove(q.rectangleOnPoint(a),a);break;case 1:this.portRTree.Remove(q.rectangleOnPoint(a),a);let l=ze.FindPointOnPolylineToInsertAfter(t,a);if(l!=null)Gt.InsertPointIntoPolylineAfter(t,l,a);else throw new Error;break}return i}static FindPointOnPolylineToInsertAfter(t,i){for(let n=t.startPoint;;){let o=n.nextOnPolyline;if(m.closeDistEps(i,n.point)||m.closeDistEps(i,o.point))return null;let a=m.distToLineSegment(i,n.point,o.point).dist;if(le(a,0))return n;if(n=o,n===t.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length===1){let t=this.rootShapes[0];if(t.BoundaryCurve==null){this.root=t;return}}this.rootWasCreated=!0,this.root=new Mo(null);for(let t of this.rootShapes)this.root.AddChild(t)}RemoveRoot(){if(this.rootWasCreated)for(let t of this.rootShapes)t.RemoveParent(this.root)}static GetAncestorSetsMap(t){let i=new Map;for(let n of t.filter(o=>!i.has(o)))i.set(n,ze.GetAncestorSet(n,i));return i}static GetAncestorSet(t,i){let n=new Set(t.Parents);for(let o of t.Parents){let a=i.get(o);a||i.set(o,a=ze.GetAncestorSet(o,i));for(let l of a)n.add(l)}return n}static CreatePortsIfNeeded(t){for(let i of t){if(i.sourcePort==null){let n=i;new Qr(()=>n.source.boundaryCurve,()=>n.source.center,new m(0,0))}if(i.targetPort==null){let n=i;new Qr(()=>n.target.boundaryCurve,()=>n.target.center,new m(0,0))}}}static ComputeLooseSplinePadding(t,i){let n=2*i;return(t-n)/8}};function sC(s,e,t){let i=x0(s);new ze(s,e,i.Padding,i.PolylinePadding,i.coneAngle,i.bundlingSettings,t).run()}var aC=Ae(or(),1);var Tm=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var Wo=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new Tm(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:U.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,i=0,n=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;i<t||o<n;){if(i>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=n){a.push(this.ListOfPointsAndCrossings[i++]);continue}let l=this.ListOfPointsAndCrossings[i],u=e.ListOfPointsAndCrossings[o],c=U.ComparePP(l.Location,u.Location);c===0?(a.push(l),++i,++o):c===-1?(a.push(l),++i):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length===0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(i=>U.ComparePP(i.Location,e)>=0&&U.ComparePP(i.Location,t)<=0))}static ToCrossingArray(e,t){let i=0,n=e.length;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&i++;if(i===0)return null;let o=new Array(i),a=0;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&(o[a++]=e[l]);return o}ToString(){return aC.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var ee=class{static EdgeDirectionVE(e){return ee.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return U.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let i=ee.EdgeDirectionVE(e);return t===i?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let i of e.InEdges)if(U.GetDirections(e.point,i.SourcePoint)===t)return i.Source;for(let i of e.OutEdges)if(U.GetDirections(e.point,i.TargetPoint)===t)return i.Target;return null}static FindAdjacentEdge(e,t){for(let i of e.InEdges)if(U.GetDirections(i.SourcePoint,e.point)===t)return i;for(let i of e.OutEdges)if(U.GetDirections(e.point,i.TargetPoint)===t)return i;return null}static FindBendPointBetween(e,t,i){return ee.IsVerticalD(i)?new m(t.x,e.y):new m(e.x,t.y)}static SegmentIntersectionPPP(e,t,i){let n=U.GetDirections(e,t);return ee.IsVerticalD(n)?new m(e.x,i.y):new m(i.x,e.y)}static SegmentIntersectionSP(e,t){return ee.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return ee.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return ee.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return ee.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,i,n){return ee.IntervalsAreCollinear(e,t,i,n)&&U.ComparePP(e,n)!==U.ComparePP(t,i)}static IntervalsAreCollinear(e,t,i,n){let o=ee.IsVerticalPP(e,t);return ee.IsVerticalPP(i,n)===o?o?U.Equal(e.x,i.x):U.Equal(e.y,i.y):!1}static IntervalsAreSame(e,t,i,n){return U.EqualPP(e,i)&&U.EqualPP(t,n)}static IntervalsIntersect(e,t,i,n){let o=ee.SegmentIntersectionPPP(e,t,i);return ee.PointIsOnSegmentPPP(e,t,o)&&ee.PointIsOnSegmentPPP(i,n,o)?o:void 0}static SegmentIntersectionEP(e,t){return ee.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,i){return U.EqualPP(e,i)||U.EqualPP(t,i)||U.GetDirections(e,i)===U.GetDirections(i,t)}static PointIsOnSegmentSP(e,t){return ee.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!==0}static IsVerticalE(e){return ee.IsVerticalD(U.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return ee.IsVerticalD(U.GetDirections(e,t))}static IsVertical(e){return ee.IsVerticalD(U.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!==0}static Slope(e,t,i){let n=t.sub(e);return n.dot(i.PerpDirectionAsPoint)/n.dot(i.DirectionAsPoint)}static SortAscending(e,t){let i=U.GetDirections(e,t);return 0===i||ee.IsAscending(i)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,i){switch(i){case 1:case 4:return new m(t.x,ee.GetRectangleBound(e,i));case 2:case 8:return new m(ee.GetRectangleBound(e,i),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return U.Compare(e.bottom,t.top)<0&&U.Compare(t.bottom,e.top)<0&&U.Compare(e.left,t.right)<0&&U.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return U.Compare(e.y,t.top)<0&&U.Compare(t.bottom,e.y)<0&&U.Compare(e.x,t.right)<0&&U.Compare(t.left,e.x)<0}};var wa=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=Y.toPoint(this.Dir),this.PerpDirection=1===e?2:1,this.PerpDirectionAsPoint=Y.toPoint(this.PerpDirection),this.OppositeDirection=Y.OppositeDir(e)}get IsHorizontal(){return 2===this.Dir}get IsVertical(){return 1===this.Dir}Compare(e,t){let i=this.ComparePerpCoord(e,t);return i!==0?i:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return U.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return U.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return U.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return U.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?wa.VerticalInstance:wa.HorizontalInstance}static GetInstance(e){return ee.IsVerticalD(e)?wa.VerticalInstance:wa.HorizontalInstance}ToString(){return this.Dir.toString()}},vt=wa;vt.HorizontalInstance=new wa(2),vt.VerticalInstance=new wa(1);var Cs=class extends ua{constructor(t,i,n,o){super();this.Update(t,i),this.Weight=n,this.GroupBoundaryPointAndCrossingsList=o}static mk(t,i){return new Cs(t,i,Cs.NormalWeight,null)}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Cs.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?vt.VerticalInstance:vt.HorizontalInstance}get IsOverlapped(){return Cs.OverlappedWeight===this.Weight}get IsReflection(){return Cs.ReflectionWeight===this.Weight}static IsVerticalSegment(t,i){return t.x===i.x}MergeGroupBoundaryCrossingList(t){t!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new Wo),this.GroupBoundaryPointAndCrossingsList.MergeFrom(t))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(t,i){this.startPoint=t,this.endPoint=i}SetInitialVisibilityVertex(t){this.LowestVisibilityVertex=t,this.HighestVisibilityVertex=t}AppendVisibilityVertex(t,i){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(t,i)||this.SetInitialVisibilityVertex(i);else{if(U.IsPureLower(i.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(t,i)||this.AppendHighestVisibilityVertex(i)}}AddVisibilityEdge(t,i){let n=new pi(t,i,this.Weight);return Ye.AddEdge(n),n}AppendHighestVisibilityVertex(t){U.EqualPP(this.HighestVisibilityVertex.point,t.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t)}LoadStartOverlapVertexIfNeeded(t){if(this.NeedStartOverlapVertex){let i=t.FindVertex(this.Start);this.AppendVisibilityVertex(t,i!=null?i:t.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(t){if(this.NeedEndOverlapVertex){let i=t.FindVertex(this.End);this.AppendVisibilityVertex(t,i!=null?i:t.AddVertexP(this.End))}}OnSegmentIntersectorBegin(t){this.AppendGroupCrossingsThroughPoint(t,this.Start)||this.LoadStartOverlapVertexIfNeeded(t)}OnSegmentIntersectorEnd(t){this.AppendGroupCrossingsThroughPoint(t,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||U.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(t)}static Subsume(t,i,n,o,a,l,u,c){return c.extendStart=!0,c.extendEnd=!0,t.seg==null||!ee.IntervalsOverlapPPPP(t.seg.Start,t.seg.End,i,n)?!1:t.seg.Weight!==o?t.seg.Start===i&&t.seg.End===n?(t.seg.Weight=Math.min(t.seg.Weight,o),!0):!1:(c.extendStart=l.CompareScanCoord(i,t.seg.Start)===-1,c.extendEnd=l.CompareScanCoord(n,t.seg.End)===1,(c.extendStart||c.extendEnd)&&(u.Remove(t.seg),t.seg.startPoint=l.Min(t.seg.Start,i),t.seg.endPoint=l.Max(t.seg.End,n),t.seg=u.InsertUnique(t.seg).item,t.seg.MergeGroupBoundaryCrossingList(a)),!0)}IntersectsSegment(t){return ee.SegmentsIntersection(this,t)!==void 0}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(t){return U.EqualPP(this.Start,t)||U.EqualPP(this.End,t)||U.GetDirections(this.Start,t)===U.GetDirections(t,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(t){return this.IsVertical?new m(this.Start.x,t):new m(t,this.Start.y)}AddSparseVertexCoord(t){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(t)}AddSparseEndpoint(t){return this.sparsePerpendicularCoords.has(t)?!1:(this.sparsePerpendicularCoords.add(t),!0)}CreateSparseVerticesAndEdges(t){var i;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(t,this.Start);for(let n of Array.from(this.sparsePerpendicularCoords.values()).sort(Re)){let o=this.CreatePointFromPerpCoord(n);this.AppendVisibilityVertex(t,(i=t.FindVertex(o))!=null?i:t.AddVertexP(o))}this.AppendGroupCrossingsThroughPoint(t,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(t,i){return this.AppendGroupCrossingsThroughPoint(t,i.point)?(U.IsPureLower(this.HighestVisibilityVertex.point,i.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,i),this.HighestVisibilityVertex=i),!0):!1}AppendGroupCrossingsThroughPoint(t,i){var o;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let n=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(i);){let a=this.GroupBoundaryPointAndCrossingsList.Pop(),l=null,u=null;U.ComparePP(a.Location,this.Start)>0&&(l=Wo.ToCrossingArray(a.Crossings,this.ScanDirection.OppositeDirection)),U.ComparePP(a.Location,this.End)<0&&(u=Wo.ToCrossingArray(a.Crossings,this.ScanDirection.Dir)),n=!0;let c=(o=t.FindVertex(a.Location))!=null?o:t.AddVertexP(a.Location);t.AddVertexP(a.Location),l!=null||u!=null?(this.AddLowCrossings(t,c,l),this.AddHighCrossings(t,c,u)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(c):this.AppendHighestVisibilityVertex(c)}return n}static GetCrossingInteriorVertex(t,i,n){var a;let o=n.GetInteriorVertexPoint(i.point);return(a=t.FindVertex(o))!=null?a:t.AddVertexP(o)}AddCrossingEdge(t,i,n,o){let a=null;this.HighestVisibilityVertex!=null&&(U.EqualPP(this.HighestVisibilityVertex.point,n.point)?a=t.FindEdgePP(i.point,n.point):this.AppendHighestVisibilityVertex(i)),a==null&&(a=this.AddVisibilityEdge(i,n));let l=o.map(c=>c.Group.InputShape),u=a.IsPassable;u==null?a.IsPassable=()=>{for(let c of l)if(c.IsTransparent)return!0;return!1}:a.IsPassable=()=>{for(let c of l)if(c.IsTransparent||u())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(i),this.HighestVisibilityVertex=n}AddLowCrossings(t,i,n){if(n!=null){let o=Cs.GetCrossingInteriorVertex(t,i,n[0]);this.AddCrossingEdge(t,o,i,n)}}AddHighCrossings(t,i,n){if(n!=null){let o=Cs.GetCrossingInteriorVertex(t,i,n[0]);this.AddCrossingEdge(t,i,o,n)}}},ve=Cs;ve.NormalWeight=pi.DefaultWeight,ve.ReflectionWeight=5,ve.OverlappedWeight=500;var Gd=class{constructor(e,t,i,n,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?Y.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,i,n,o)}ResetEntry(e,t,i,n){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=i,this.Cost=n}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var Vd=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},Lt=class{constructor(){this.nextNeighbors=[new Vd,new Vd,new Vd];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,i){if(t===i||!this.InitEntryDirectionsAtTarget(i))return!1;this.Target=i,this.Source=t;let n=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return n>=this.upperBoundOnCost?!1:(this.queue=new Sr(Re),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(n):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|Y.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|Y.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!==0}static IsInDirs(e,t){return e===(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let i=this.Target.point.sub(e);if(le(i.x,0)&&le(i.y,0))return this.targetCostAdjustment;let n=Y.VectorDirection(i),o;return t===0?(t=15,o=this.GetNumberOfBends(t,n)):o=this.GetNumberOfBends(t,n),this.CombinedCost(Lt.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return Y.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):Lt.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)===t?Lt.IsInDirs(t,this.EntryDirectionsToTarget)?0:Lt.IsInDirs(Lt.Left(t),this.EntryDirectionsToTarget)||Lt.IsInDirs(Lt.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(Lt.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,i){let n=e&t;if(n===0)return Lt.GetBendsForNotPureDirection(e,Lt.AddOneTurn[t],i)+1;let o=e&i;return o===0?Lt.GetBendsForNotPureDirection(e,t,Lt.AddOneTurn[i])+1:(n|o)===e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return Lt.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let i=new Array,n=!1,o=0;for(;;){o===e.entry.Direction?n=!0:(n=!1,i.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex===t)break;e.entry=a}return n&&i.push(e.entry.Vertex.point),i.reverse(),i}QueueReversedEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=t.PreviousVertex,a=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,o,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree===1){let l=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,n.length,n.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,n.length,n.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,i){let n={numberOfBends:0,length:0},o=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n),a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,n.length,n.numberOfBends,a))}EnqueueEntry(e,t,i,n,o){let a=new Gd(t,e,i,n,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n){n.length=e.Length+Lt.ManhattanDistance(e.Vertex.point,t.point)*i;let o=Y.DirectionFromPointToPoint(e.Vertex.point,t.point);return n.numberOfBends=e.NumberOfBends,e.Direction!==0&&o!==e.Direction&&n.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,i,n,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=i,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c===this.Target){if(n==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget===0){let d=0;for(let f of this.Target.VertexEntries)n[d++]=f;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=Lt.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(n!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)n[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,i){for(let n of t)this.ExtendPathAlongEdge(e,n,!0,i)}ExtendPathAlongOutEdges(e,t,i){let n=t.isEmpty()?null:t.treeMinimum();for(;n!=null;n=t.next(n))this.ExtendPathAlongEdge(e,n.item,!1,i)}ExtendPathAlongEdge(e,t,i,n){if(!Lt.IsPassable(t))return;let o=i?t.Source:t.Target;if(o===e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!==this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=Y.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!==e.Direction&&(l=this.nextNeighbors[a===n?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new Gd(this.Source,null,0,0,e);for(let i of this.Source.OutEdges)!Lt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Target,i.Weight);for(let i of this.Source.InEdges)!Lt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Source,i.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,i){let n=Y.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[Y.ToIndex(n)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,i):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,i)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i){if(e.Vertex.VertexEntries!=null){let n=Y.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[Y.ToIndex(n)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,i),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},Zi=Lt;Zi.DefaultBendPenaltyAsAPercentageOfDistance=4,Zi.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var La=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=Zi.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let i={entry:this.GetPathStage(null,e,null,t)};return Zi.RestorePathV(i)}GetPathStage(e,t,i,n){let o=new Zi,a={bestEntry:null,bestCost:Number.MAX_VALUE/ve.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=La.Barycenter(t),c=La.Barycenter(n),h=Zi.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,f=i!=null?this.currentPassTargetEntries:null,p=[];for(let C of t)for(let O of n)p.push([C,O]);p.sort(([C,O],[B,I])=>S(C,O)-S(B,I));for(let[C,O]of p){if(m.closeDistEps(C.point,O.point))continue;let B=x(C,u)*d,I=x(O,c)*d,_=a.bestCost;if(i!=null){for(let se=0;se<f.length;se++)f[se]=null;_=o.MultistageAdjustedCostBound(a.bestCost)}let X=o.GetPathWithCost(e,C,B,f,O,I,_);if(f!=null){La.UpdateTargetEntriesForEachDirection(i,f,a);continue}if(X==null)continue;let K=X.Cost/S(C,O);(X.Cost<a.bestCost||le(X.Cost,a.bestCost)&&K<l)&&(a.bestCost=X.Cost,a.bestEntry=X,l=X.Cost/S(C,O))}return a.bestEntry;function S(C,O){return Zi.ManhattanDistance(C.point,O.point)}function x(C,O){return Zi.ManhattanDistance(C.point,O)}}static UpdateTargetEntriesForEachDirection(e,t,i){for(let n=0;n<t.length;n++){let o=t[n];o!=null&&(e[n]==null||o.Cost<e[n].Cost)&&(e[n]=o,o.Cost<i.bestCost&&(i.bestCost=o.Cost,i.bestEntry=o))}}static Barycenter(e){let t=new m(0,0);for(let i of e)t=t.add(i.point);return t.div(e.length)}};var uC=Ae(or(),1);var Im=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof mi?Array.from(lC(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new uC.StringBuilder;this.PathPoints instanceof mi&&e.Append("L");for(let t of lC(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*lC(s){if(s instanceof mi)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var wm=class extends ca{constructor(t,i,n,o){super(i);this.Slope=0;this.SlopeInverse=0;this.Obstacle=t,this.endVertex=o?i.nextOnPolyline:i.prevOnPolyline,n.IsPerpendicularPP(i.point,this.endVertex.point)||(this.Slope=ee.Slope(i.point,this.endVertex.point,n),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(t){this.obstacle=t}get EndVertex(){return this.endVertex}},Mr=class extends wm{constructor(e,t,i){super(e,t,i,i.IsHorizontal)}},As=class extends wm{constructor(e,t,i){super(e,t,i,i.IsVertical)}};var Jl=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=gs(this.InputShape.Ports,this.Ports),e.removedPorts=gs(this.Ports,this.InputShape.Ports),e.addedPorts.size===0&&e.removedPorts.size===0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,i,n){let o=Jl.mk(e,t,n);return o.CreateInitialSides(o.PaddedPolyline.startPoint,i),o}CreateInitialSides(e,t){this.ActiveLowSide=new Mr(this,e,t),this.ActiveHighSide=new As(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new As(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t){e!=null&&(this.PaddedPolyline=er.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,t),Jl.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports))}static mk(e,t,i){let n=new Jl(null,0);return n.PaddedPolyline=ie.mkClosedFromPoints([T.RoundPoint(e),T.RoundPoint(t)]),n.Ordinal=i,n}IsPolylineRectangle(){if(this.PaddedPolyline.count!==4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,i=Y.VectorDirectionPP(e.point,t.point);if(!Y.IsPureDirection(i))return!1;do{e=t,t=e.nextOnPolyline;let n=Y.DirectionFromPointToPoint(e.point,t.point);if(n!==Y.RotateRight(i))return!1;i=n}while(e!==this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=T.RoundPoint(t.point),t=t.nextOnPolyline;while(t!==e.startPoint);Jl.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this===this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=T.intersectionEpsilon*10;for(let i=e.startPoint.next;i!=null;i=i.next)m.close(i.prev.point,i.point,t)&&(i.next==null?e.RemoveEndPoint():(i.prev.next=i.next,i.next.prev=i.prev));return m.close(e.start,e.end,t)&&e.RemoveStartPoint(),e=e.RemoveCollinearVertices(),e.endPoint.prev!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)===2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)===2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!==void 0&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump===e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=er.CreatePaddedPolyline(e,T.intersectionEpsilon*10);return Jl.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},Cr=Jl;Cr.FirstSentinelOrdinal=1,Cr.FirstNonSentinelOrdinal=10;var cC=Ae(or(),1);var Lm=class{constructor(e,t,i,n){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=ve.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=i;let o=G.mkPP(this.UnpaddedBorderIntersect,ee.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,i)),a=R.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=T.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=n.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=n.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,vt.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(n))&&(this.unpaddedToPaddedBorderWeight=ve.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight===ve.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(n)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight}get IsCollinearWithPort(){return Y.IsPureDirection(U.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return ee.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return U.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!==0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=ve.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=q.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,i=>i.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(i=>!i.UserData.IsGroup&&i.UserData!==this.Obstacle).map(i=>i.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=q.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!==this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,i){let n=null;for(let o of i){let a=t(o);if(!ee.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(n=n!=null?n:G.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),R.intersectionOne(n,a,!1)!=null||0!==R.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=ee.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return U.GetDirections(this.MaxVisibilitySegment.start,t.Location)===U.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,i,n){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,i,n);return}this.OutwardDirection===U.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,i,n)}ExtendEdgeChain(e,t,i,n,o){e.ExtendEdgeChainVRLPB(i,n,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return cC.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var Rm=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=q.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=T.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,i){let n=new Lm(this,e,t,i);this.PortEntrances.push(n),this.VisibilityRectangle.add(n.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||n.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!m.closeDistEps(this.Location,T.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var Om=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight}get IsOutOfBounds(){return 0!==this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,i,n){let o=ee.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,i,n):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,i,n),a}AddToAdjacentVertex(e,t,i,n){U.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,i,n)}ExtendEdgeChain(e,t,i,n){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,i));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,i,e);e.ExtendEdgeChainVRLPB(t,n,a[0],a[1],o)}GetSegmentAndCrossings(e,t,i){let n=Y.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[n];if(o==null){let a={pacList:null};o=[i.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[n]=o}else U.GetDirections(e.point,o[0].start)===t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let i=U.GetDirections(t,this.Vertex.point),n=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(n,this.Vertex,i&5,ve.NormalWeight),e.ConnectVertexToTargetVertex(n,this.Vertex,i&10,ve.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var fC=Ae(or(),1);var hC=Ae(or(),1);var $l=class{constructor(e,t){this.BoundaryWidth=T.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return T.RoundPoint(e.add(Y.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return hC.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};$l.BoundaryWidth=T.distanceEpsilon;var Dc=class extends Jt{constructor(t){super();this.site=t}get Site(){return this.site}};var Ra=class extends Li{constructor(t,i){super(i);this.Obstacle=t}};var Oa=class extends Ra{constructor(e,t){super(e,t)}};var _m=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!U.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||U.GetDirections(this.CurrentSegment.End,e)==U.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&m.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(U.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new m(e,this.Coord):new m(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y === "+this.Coord:"(V) X === "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var kd=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let i=Array.from(e).sort((n,o)=>n>o?1:n<o?-1:0);for(let n of i)this.vector.push(new _m(n))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,i,n){this.CurrentSlot.AppendScanSegment(new ve(e,t,i,n))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let i=0,n=this.vector.length-1;if(e<=this.vector[i].Coord)return i;if(e>=this.vector[n].Coord)return n;for(;n-i>2;){let o=i+(n-i>>1),a=this.vector[o];if(e<a.Coord){n=o;continue}if(e>a.Coord){i=o;continue}return o}for(i++;i<=n;i++){let o=this.vector[i];if(e<o.Coord)return t>0?i:i-1;if(e===o.Coord)break}return i}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let i=t.FirstSegment;i!=null;i=i.NextSegment)i.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let i=t.NextSegment;i!=null;i=i.NextSegment){if(i.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&i.Start===t.End){let n=this.GetPerpendicularCoord(i.Start);t.AddSparseEndpoint(n),i.AddSparseEndpoint(n)}t=i}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count === ")+this.vector.length}};var Qi=class extends Jt{constructor(t,i,n){super();this.InitialObstacle=t,this.ReflectingObstacle=i,this.site=n}static mk(t,i,n){let o=new Qi(t.ReflectingObstacle,i,n);return o.PreviousSite=t,o}IsStaircaseStep(t){return this.InitialObstacle===t}get Site(){return this.site}};var Ud=class{constructor(){this.eventTree=new ha((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(i)return i;let n=e instanceof Qi?0:1,o=t instanceof Qi?0:1;return i=n-o,i||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var dC=Ae(or(),1);var Fc=class{constructor(){this.pointCrossingMap=new bt;this.pointList=new Array}AddIntersection(e,t,i){let n=this.pointCrossingMap.get(e);n||(n=new Array,this.pointCrossingMap.set(e,n));let o=n.length;for(let l=0;l<o;l++){let u=n[l];if(u.Group===t)return u}let a=new $l(t,i);return n.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size===0)return null;if(U.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())U.ComparePP(o,e)>=0&&U.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let i=new Wo,n=this.pointList.length;for(let o=0;o<n;o++){let a=this.pointList[o];i.Add(a,this.pointCrossingMap.get(a))}return i}toString(){return dC.String.Format("{0}",this.pointCrossingMap.size)}};var zd=class extends Qi{constructor(t,i,n){super(t.ReflectingObstacle,i.Obstacle,n);this.Side=i}};var Nm=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new ct((t,i)=>this.CompareBB(t,i)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let i=this.FindFirstInRange(e,t);i!=null;i=this.FindNextInRange(i,t))this.MarkStaleSite(i.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site===e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let i=this.eventTree.findFirst(this.findFirstPred);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let i=this.eventTree.next(e);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Wd=class extends Ra{constructor(e,t){super(e,t)}},Hd=class extends Ra{constructor(e,t){super(e,t)}},jd=class extends Ra{constructor(e,t){super(e,t)}};var qd=class extends Qi{constructor(t,i,n){super(t.ReflectingObstacle,i.obstacle,n);this.Side=i}};var Xd=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,i,n){if(ee.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=i,this.GroupSideInterveningBeforeHighNeighbor=n;return}this.LowNeighbor=t,this.LowOverlapEnd=i,this.GroupSideInterveningBeforeLowNeighbor=n}};var Ar=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let i=this.arrayOfSets[e];return i!==void 0&&i.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new Ar;for(let i of e)t.add(i);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let i of t.values())yield new ye(e,i)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let i=this.arrayOfSets[e];i==null&&(this.arrayOfSets[e]=i=new Set),i.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var Yd=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],Cr.RoundVerticesAndSimplify(this.Polyline)}};var Ho=class{static MungeClosestIntersectionInfo(e,t,i){let n=t.seg1.boundingBox,o=T.RoundPoint(t.x).clone();return i?new m(Ho.MungeIntersect(e.x,o.x,n.left,n.right),o.y):new m(o.x,Ho.MungeIntersect(e.y,o.y,n.bottom,n.top))}static MungeIntersect(e,t,i,n){if(e<t){let o=Math.min(i,n);t<o&&(t=o)}else if(e>t){let o=Math.max(i,n);t>o&&(t=o)}return T.RoundDouble(t)}};var ht=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new Fc;this.overlapPairs=new Ar;this.hasOverlaps=!1;this.lookupIntPair=new ye(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,i){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=i}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=Cr.FirstNonSentinelOrdinal;for(let i of this.allObstacles)i.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-Cr.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=ht.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=ht.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(Ht(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let i={bIsInsideA:!1,aIsInsideB:!1};if(ht.ObstaclesIntersect(e,t,i)){this.hasOverlaps=!0;return}!i.aIsInsideB&&!i.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&i.bIsInsideA||t.IsGroup&&i.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(i=>lt(i,i.VisibilityBoundingBox));return et(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=ht.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&$r(e,e,(t,i)=>this.EvaluateOverlappedPairForClump(t,i))}EvaluateOverlappedPairForClump(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!ht.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=ht.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&$r(e,e,(t,i)=>this.EvaluateOverlappedPairForConvexHull(t,i))}EvaluateOverlappedPairForConvexHull(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!ht.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=ht.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsGroup)),t=ht.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsPrimaryObstacle));e==null||t==null||$r(e,t,(i,n)=>this.EvaluateOverlappedPairForGroup(i,n))}EvaluateOverlappedPairForGroup(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1},n=ht.ObstaclesIntersect(e,t,i);if(!(!n&&!i.aIsInsideB&&!i.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(i.aIsInsideB||ht.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!n&&(t.IsGroup||i.bIsInsideA)||this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return R.PointRelativeToCurveLocation(e.start,t)!==0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=pc(Array.from(this.overlapPairs.values())),t=Xn(e);for(let i of t){if(i.length===1)continue;let n=i.map(o=>this.OrdinalToObstacle(o));for(let o of n)o.clump=n}}CreateConvexHulls(){let e=!1,t=pc(Array.from(this.overlapPairs.values())),i=Xn(t);for(let n of i){if(n.length===1)continue;e=!0;let o=n.map(this.OrdinalToObstacle),a=Io(o,u=>u.VisibilityPolyline),l=new Yd(Jr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let i=this.OrdinalToObstacle(t.x),n=this.OrdinalToObstacle(t.y);ht.ResolveGroupAndGroupOverlap(i,n)||ht.ResolveGroupAndObstacleOverlap(i,n)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?ht.ResolveGroupAndObstacleOverlap(e,t):ht.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let i=t.looseVisibilityPolyline;ht.GrowGroupAroundLoosePolyline(e,i);let n={bIsInsideA:!1,aIsInsideB:!1};for(;ht.ObstaclesIntersect(t,e,n)||!n.aIsInsideB;)i=Cr.CreateLoosePolyline(i),ht.GrowGroupAroundLoosePolyline(e,i)}static GrowGroupAroundLoosePolyline(e,t){let i=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new Yd(Jr.createConvexHullAsClosedPolyline(i),[e]))}static ObstaclesIntersect(e,t,i){return R.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):(i.aIsInsideB=ht.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),i.bIsInsideA=!i.aIsInsideB&&ht.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:ht.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i.aIsInsideB,i.bIsInsideA)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i,n){if(!i&&!n)return R.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=i?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=i?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(R.PointRelativeToCurveLocation(l,a)===0){let u=R.ClosestPoint(a,l);if(!m.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let i=t.VisibilityBoundingBox;for(let n of this.Root.GetNodeItemsIntersectingRectangle(i))if(n!==t&&R.ClosedCurveInteriorsIntersect(n.VisibilityPolyline,t.VisibilityPolyline)){if(n.IsInConvexHull)for(let o of n.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(n.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let i=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(n=>!i.intersects(this.shapeIdToObstacleMap.get(n).VisibilityBoundingBox)));for(let n of e)this.AncestorSets.get(t.InputShape).delete(n);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,i){let n=ee.RectangleBorderIntersect(this.GraphBox,e,t);if(U.GetDirections(e,n)===0)return i.pacList=null,G.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,n);return i.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,i,n){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=n,this.Root.FirstHitNodeWithPredicate(i,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,vt.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t===this.insideHitTestIgnoreObstacle1||t===this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!ee.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let i=ee.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),n=ee.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=G.mkPP(n,i),a=R.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length===2){let l=T.RoundPoint(a[0].x),u=T.RoundPoint(a[1].x);if(!U.EqualPP(e,l)&&!U.EqualPP(e,u)&&e.compareTo(l)!==e.compareTo(u)&&!le(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!U.EqualPP(i.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!U.EqualPP(i.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=G.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let i=U.GetDirections(e,t),n=8===i?this.GraphBox.right:2===i?this.GraphBox.left:e.x,o=8===i?this.GraphBox.left:2===i?this.GraphBox.right:t.x,a=4===i?this.GraphBox.top*2:1===i?this.GraphBox.bottom:e.y,l=4===i?this.GraphBox.bottom:1===i?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=G.mkPP(new m(n,a),new m(o,l))}RecurseRestrictRayWithObstacles(e){if(!ee.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let i=R.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(i);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,i);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,i=null,n=this.restrictedRayLengthSquared,o=U.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=T.RoundPoint(a.x),u=U.GetDirections(this.currentRestrictedRay.start,l);if(u===Y.OppositeDir(o))continue;if(t++,0===u){n=0,i=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<n){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<T.squareOfDistanceEpsilon)continue;n=c,i=a}}if(i!=null){if(t===1){let a=T.RoundPoint(i.x);if(m.closeIntersections(a,this.currentRestrictedRay.start)||m.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=n,this.currentRestrictedRay.end=Ho.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,i,!ee.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let i of t){let n=T.RoundPoint(i.x);if(n.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=U.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=i.seg1,u=Y.VectorDirection(l.derivative(i.par1)),c=a;(u&Y.RotateRight(a))!==0&&(c=Y.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,e,c)}}};var Mm=class{constructor(e,t){this.scanDirection=e,this.SideTree=new ct((i,n)=>this.Compare(i,n)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)===-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return ee.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle===t.Obstacle)return e===t?0:e instanceof Mr?-1:1;let i=_a.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),n=_a.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=i.compareTo(n);if(o===0){let a=e instanceof Mr,l=t instanceof Mr;o=nv(a,l),o===0&&(o=Re(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var eu=class{constructor(e){this.lookupSegment=ve.mk(new m(0,0),new m(0,1));this.ScanDirection=e,this.segmentTree=new ct((t,i)=>this.Compare(t,i)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let i=this.segmentTree.find(this.lookupSegment);return i!=null&&U.EqualPP(i.item.End,t)?i.item:null}FindLowestIntersector(e,t){let i=this.FindLowestIntersectorNode(e,t);return i!=null?i.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let i=this.segmentTree.findLast(this.findIntersectorPred);if(U.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.Start,t)>0)return null;i=this.segmentTree.next(i)}return i}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let i=this.segmentTree.findLast(this.findIntersectorPred);if(U.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.End,e)<0)return null;i=this.segmentTree.previous(i)}return i!=null?i.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,i){this.lookupSegment.Update(e,t);let n=this.segmentTree.findFirst(this.findPointPred);if(n!=null){let o=n.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)===-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped===e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!==t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start===t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End===t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let n=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),n.Update(o.End,n.End),this.segmentTree.insert(n),n.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.ScanDirection.Compare(e.Start,t.Start);return i===0&&(i=this.ScanDirection.Compare(e.End,t.End)*-1),i}};var Bm=class extends wo{constructor(t){super(t)}SetVertexEntry(t){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[Y.ToIndex(t.Direction)]=t}RemoveVertexEntries(){this.VertexEntries=null}};var tr=class{constructor(e){this.ObstacleTree=new ht;this.CurrentGroupBoundaryCrossingMap=new Fc;this.LowNeighborSides=new Xd;this.HighNeighborSides=new Xd;this.ScanDirection=vt.HorizontalInstance,this.eventQueue=new Ud,this.HorizontalScanSegments=new eu(vt.HorizontalInstance),this.VerticalScanSegments=new eu(vt.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new Ye;return e.VertexFactory=t=>new Bm(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(vt.HorizontalInstance);let e=Cr.FirstSentinelOrdinal,t=new m(this.ObstacleTree.GraphBox.left-tr.SentinelOffset,this.ObstacleTree.GraphBox.bottom-tr.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.left-tr.SentinelOffset,this.ObstacleTree.GraphBox.top+tr.SentinelOffset),n=Cr.CreateSentinel(t,i,this.ScanDirection,e++);this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.right+tr.SentinelOffset,this.ObstacleTree.GraphBox.bottom-tr.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+tr.SentinelOffset,this.ObstacleTree.GraphBox.top+tr.SentinelOffset),n=Cr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(vt.VerticalInstance),t=new m(this.ObstacleTree.GraphBox.left-tr.SentinelOffset,this.ObstacleTree.GraphBox.bottom-tr.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+tr.SentinelOffset,this.ObstacleTree.GraphBox.bottom-tr.SentinelOffset),n=Cr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.left-tr.SentinelOffset,this.ObstacleTree.GraphBox.top+tr.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+tr.SentinelOffset,this.ObstacleTree.GraphBox.top+tr.SentinelOffset),n=Cr.CreateSentinel(t,i,this.ScanDirection,e),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,i){let n=t.Direction,o=t.Start.x,a=t.Start.y;return i.IsHorizontal?(o+=n.x/n.y*(e.y-t.Start.y),o=Ho.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=n.y/n.x*(e.x-t.Start.x),a=Ho.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new m(o,a)}GetOpenVertex(e){let t=e.startPoint,i=this.TraversePolylineForEvents(t),n=this.PointCompare(i.point,t.point);for(;;i=this.TraversePolylineForEvents(i)){let o=this.PointCompare(i.point,t.point);if(o<=0)t=i;else if(o>0&&n<=0)break;n=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new Mm(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new Nm(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new Oa(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return tr.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof Mr?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof Mr?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,i,n){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!n&&!ee.PointIsInRectangleInterior(i,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(i)==null&&this.lookaheadScan.Add(new Qi(e,t.Obstacle,i))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let i=q.mkPP(e.Start,e.End),n=q.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!i.intersectsOnX(n):!i.intersectsOnY(n))return;let o=q.intersect(i,n),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=tr.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!==e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,i){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!ee.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(i!=null&&e.IsStaircaseStep(i.Obstacle))return this.ScanLineCrossesObstacle(e.Site,i.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,i,n){{let o=this.ScanLineIntersectSide(n.Site,t!=null?t:i),a=t!=null?o:n.Site,l=t!=null?n.Site:o;return t==null?t=this.scanLine.NextLowB(i).item:i=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,i,n)}}AddReflectionEvent(e,t,i){let n=t;n!=null?this.eventQueue.Enqueue(new qd(e,n,i)):this.eventQueue.Enqueue(new zd(e,t,i))}AddSideToScanLine(e,t){let i=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),i}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Ud,this.HorizontalScanSegments=new eu(vt.HorizontalInstance),this.VerticalScanSegments=new eu(vt.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof Oa?this.ProcessEventO(e):e instanceof Wd?this.ProcessEventLB(e):e instanceof Hd?this.ProcessEventHB(e):e instanceof jd?this.ProcessEventCV(e):e instanceof qd?this.ProcessEventLR(e):e instanceof zd?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,i){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,i,this.HighNeighborSides)}FindNeighbors(e,t,i){let n=e instanceof Oa?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,n,o.lowNborSideNode,i),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,n,o.highNborSideNode,i)}SkipToNeighbor(e,t,i,n,o){let a=null,l=null;for(;;n=this.scanLine.Next(e,n))if(n.item.Obstacle!==t.Obstacle){if(n.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(n,i,e)&&l==null&&(l=n.item);continue}if(n.item instanceof As===ee.IsAscending(e)){this.ScanLineCrossesObstacle(i,n.item.Obstacle)&&(a=n,l=null);continue}break}o.SetSides(e,n,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,i){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let n=e.item instanceof Mr===ee.IsAscending(i)?i:Y.OppositeDir(i),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,n),!0}FindNeighborsAndProcessVertexEvent(e,t,i){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(i,e,t),this.ProcessVertexEvent(e,t,i),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let i=this.AddSideToScanLine(t.ActiveHighSide,e.Site),n=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(n,i,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!==t.ActiveLowSide.Start){let c=new As(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,i=new Mr(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(i.End,i.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(i,e.Site),t.ActiveLowSide=i,this.EnqueueLowBendVertexEvent(i))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Wd(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,i=new As(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let n=this.AddSideToScanLine(i,e.Site);if(t.ActiveHighSide=i,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&i.Start.x===t.VisibilityBoundingBox.right&&this.SideReflectsUpward(i)){let o=this.scanLine.NextHighR(n);o.item instanceof Mr&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(i.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,i,i.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,i=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(i.point,e.End)>0?this.eventQueue.Enqueue(new Hd(t,e.EndVertex)):this.eventQueue.Enqueue(new jd(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,i=this.scanLine.Find(t.ActiveLowSide),n=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)===1){let o=i;i=n,n=o}if(this.FindNeighborsAndProcessVertexEvent(i,n,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(i);o.item!==n.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,i=this.HighNeighborSides.HighNeighbor.item,n=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(i),n.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,i=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,i,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,i=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,null,i,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),i=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new m(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(i,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return U.EqualPP(e,this.MakeInBoundsLocation(e))}},_a=tr;_a.SentinelOffset=1;var Br=class extends _a{constructor(){super(!1);this.horizontalVertexPoints=new He;this.verticalVertexPoints=new He;this.boundingBoxSteinerPoints=new He;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let t of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(t.VisibilityBoundingBox.left),this.xCoordAccumulator.add(t.VisibilityBoundingBox.right),this.yCoordAccumulator.add(t.VisibilityBoundingBox.top),this.yCoordAccumulator.add(t.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new kd(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new kd(this.xCoordAccumulator,!1);for(let t=0;t<this.horizontalScanSegmentVector.Length;t++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(t).Coord,t);for(let t=0;t<this.verticalScanSegmentVector.Length;t++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(t).Coord,t)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(t){super.InitializeEventQueue(t),this.SetVectorsAndCoordMaps(t),this.AddAxisCoordinateEvents(t)}AddAxisCoordinateEvents(t){if(t.IsHorizontal){for(let i of this.yCoordAccumulator)this.eventQueue.Enqueue(new Dc(new m(this.ObstacleTree.GraphBox.left-Br.SentinelOffset,i)));return}for(let i of this.xCoordAccumulator)this.eventQueue.Enqueue(new Dc(new m(i,this.ObstacleTree.GraphBox.bottom-Br.SentinelOffset)))}ProcessCustomEvent(t){this.ProcessAxisCoordinate(t)||this.ProcessCustomEvent(t)}ProcessAxisCoordinate(t){return t instanceof Dc?(this.CreateScanSegmentsOnAxisCoordinate(t.Site),!0):!1}InsertPerpendicularReflectionSegment(t,i){return!1}InsertParallelReflectionSegment(t,i,n,o,a,l){return!1}ProcessVertexEvent(t,i,n){let o=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;o.add(n.Site);let a=this.LowNeighborSides.LowNeighbor.item,l=this.HighNeighborSides.HighNeighbor.item,u=this.ScanDirection.Dir,c=this.ScanDirection.OppositeDirection,h=this.ScanLineIntersectSide(n.Site,a),d=this.ScanLineIntersectSide(n.Site,l);if(this.ObstacleTree.GraphBox.contains(h)){let p=ee.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);U.IsPureLower(p,n.Site)&&this.boundingBoxSteinerPoints.add(p)}if(this.ObstacleTree.GraphBox.contains(d)){let p=ee.RectangleBorderIntersect(l.Obstacle.VisibilityBoundingBox,d,c);U.IsPureLower(n.Site,p)&&this.boundingBoxSteinerPoints.add(p)}let f={lowCorner:void 0,highCorner:void 0};Br.GetBoundingCorners(t.item.Obstacle.VisibilityBoundingBox,n instanceof Oa,this.ScanDirection.IsHorizontal,f),(U.IsPureLower(h,f.lowCorner)||a.Obstacle.IsInSameClump(n.Obstacle))&&o.add(f.lowCorner),(U.IsPureLower(f.highCorner,d)||l.Obstacle.IsInSameClump(n.Obstacle))&&o.add(f.highCorner)}static GetBoundingCorners(t,i,n,o){if(i){o.lowCorner=t.leftBottom,o.highCorner=n?t.rightBottom:t.leftTop;return}o.lowCorner=n?t.leftTop:t.rightBottom,o.highCorner=t.rightTop}CreateScanSegmentsOnAxisCoordinate(t){this.CurrentGroupBoundaryCrossingMap.Clear();let i=this.scanLine.Lowest(),n=this.scanLine.NextHighR(i),o=0,a=t,l=!1;for(;n!=null;n=this.scanLine.NextHighR(n)){if(this.SkipSide(a,n.item))continue;if(n.item.Obstacle.IsGroup){(o===0||l)&&this.HandleGroupCrossing(t,n.item);continue}if(n.item instanceof Mr){if(o>0){o++;continue}a=this.CreateScanSegment(a,n.item,ve.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),o=1,l=n.item.Obstacle.isOverlapped;continue}o++,!(o>0)&&(a=n.item.Obstacle.isOverlapped||n.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(a,n.item,ve.OverlappedWeight):this.ScanLineIntersectSide(a,n.item),this.CurrentGroupBoundaryCrossingMap.Clear(),l=!1)}let u=this.ScanDirection.IsHorizontal?new m(this.ObstacleTree.GraphBox.right+Br.SentinelOffset,a.y):new m(a.x,this.ObstacleTree.GraphBox.top+Br.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(a,u,ve.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(a,u)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(t,i){if(!this.ScanLineCrossesObstacle(t,i.Obstacle))return;let n=i instanceof Mr?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,o=this.ScanLineIntersectSide(t,i),a=this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,i.Obstacle,n);this.AddPerpendicularCoordForGroupCrossing(o);let l=a.GetInteriorVertexPoint(o);this.AddPerpendicularCoordForGroupCrossing(l)}AddPerpendicularCoordForGroupCrossing(t){let i=this.FindPerpendicularSlot(t,0);i!==-1&&this.perpendicularSegmentVector.Item(i).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(t,i){if(i.Obstacle.IsSentinel)return!0;let n=i.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?t.y===n.bottom||t.y===n.top:t.x===n.left||t.x===n.right}CreateScanSegment(t,i,n){let o=this.ScanLineIntersectSide(t,i);return t!==o&&this.parallelSegmentVector.CreateScanSegment(t,o,n,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(t,o)),o}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=Br.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=uc;let t=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),i=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=vt.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(t,i)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(n,o)=>n.compareTo(o);let t=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),i=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=vt.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(t,i)}SetVectorsAndCoordMaps(t){t.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(t,i){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let n=1,o={j:0};for(let a of this.parallelSegmentVector.Items())for(;!(!a.CurrentSegment.ContainsPoint(t[n])&&(!this.AddSteinerPointsToInterveningSegments(t[n],i,o,a)||!a.TraverseToSegmentContainingPoint(t[n])));){if(this.AddPointsToCurrentSegmentIntersections(i,o,a),this.GenerateIntersectionsFromVertexPointForCurrentSegment(t[n],a),a.PointIsCurrentEndAndNextStart(t[n])){a.MoveNext();continue}if(++n>=t.length)return}}AddSteinerPointsToInterveningSegments(t,i,n,o){for(;n.j<i.length&&this.currentAxisPointComparer(i[n.j],t)===-1;){if(!o.TraverseToSegmentContainingPoint(i[n.j]))return!1;this.AddPointsToCurrentSegmentIntersections(i,n,o)}return!0}AddPointsToCurrentSegmentIntersections(t,i,n){for(;i.j<t.length&&n.CurrentSegment.ContainsPoint(t[i.j]);i.j++){let o=this.FindPerpendicularSlot(t[i.j],0);this.AddSlotToSegmentIntersections(n,o)}}GenerateIntersectionsFromVertexPointForCurrentSegment(t,i){let n=this.FindPerpendicularSlot(i.CurrentSegment.Start,1),o=this.FindPerpendicularSlot(i.CurrentSegment.End,-1),a=this.FindPerpendicularSlot(t,0);n>=o||(this.AddSlotToSegmentIntersections(i,n),this.AddSlotToSegmentIntersections(i,o),a>n&&a<o&&(this.AddSlotToSegmentIntersections(i,a),this.AddBinaryDivisionSlotsToSegmentIntersections(i,n,a,o)))}FindPerpendicularSlot(t,i){return Br.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,t,i)}static FindIntersectingSlot(t,i,n,o){let a=t.GetParallelCoord(n),l=i.get(a);return l!==void 0?l:o===0?-1:t.FindNearest(a,o)}AddSlotToSegmentIntersections(t,i){let n=this.perpendicularSegmentVector.Item(i);t.CurrentSegment.AddSparseVertexCoord(n.Coord),n.AddPerpendicularCoord(t.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(t,i,n,o){let a=0,l=this.perpendicularSegmentVector.Length-1;for(;l-a>1;){let u=a+Math.floor((l-a)/2);if(n<=u){l=u,n<l&&l<=o&&this.AddSlotToSegmentIntersections(t,l);continue}a=u,n>a&&a>=i&&this.AddSlotToSegmentIntersections(t,a)}}CreateScanSegmentTrees(){Br.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),Br.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(t,i){for(let n of t.Items())for(let o=n.FirstSegment;o!=null;o=o.NextSegment)o.HasVisibility()&&i.InsertUnique(o)}};var ti=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof Br}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,ve.NormalWeight)}FindOrAddEdge(e,t,i){let n=U.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};ti.GetBrackets(e,t,n,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,i),a}static GetBrackets(e,t,i,n){if(n.splitVertex=t,!ti.FindBracketingVertices(e,t.point,i,n)){let o={bracketSource:null,bracketTarget:null};ti.FindBracketingVertices(t,e.point,Y.OppositeDir(i),o)&&(n.bracketSource=o.bracketTarget,n.splitVertex=e),n.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,i,n){for(n.bracketSource=e;n.bracketTarget=ee.FindAdjacentVertex(n.bracketSource,i),n.bracketTarget!=null;){if(m.closeDistEps(n.bracketTarget.point,t))return!0;if(i!==U.GetDirections(n.bracketTarget.point,t))break;n.bracketSource=n.bracketTarget}return n.bracketTarget!=null}CreateEdge(e,t,i){let n=e,o=t;U.IsPureLower(n.point,o.point)||(n=t,o=e);let a=new ar(n,o,i);return Ye.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&Ye.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)Ye.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return ee.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,i){for(;;){let n=ee.FindAdjacentVertex(e,t);if(n==null)break;let o=U.GetDirections(n.point,i);if((Y.OppositeDir(t)&o)!==0)return this.VisGraph.FindEdgePP(e.point,n.point);e=n}return null}FindNearestPerpendicularOrContainingEdge(e,t,i){let n;t&U.GetDirections(e.point,i);let o=e,a=n;for(;0!==a;){let u=ee.FindAdjacentVertex(o,n);if(u==null||(Y.OppositeDir(n)&U.GetDirections(u.point,i))!==0)break;o=u,t&U.GetDirections(o.point,i)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,i),!(l!=null||o===e);)o=ee.FindAdjacentVertex(o,Y.OppositeDir(n));return l}ConnectVertexToTargetVertex(e,t,i,n){if(m.closeDistEps(e.point,t.point))return;let o=U.GetDirections(e.point,t.point);if(U.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=ee.FindBendPointBetween(e.point,t.point,i),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,n),this.FindOrAddEdge(l,t,n)}AddEdgeToTargetEdge(e,t,i){let n=this.VisGraph.FindVertex(i);return n==null&&(n=this.AddVertex(i),this.SplitEdge(t,n)),this.FindOrAddEdgeVV(e,n),n}SplitEdge(e,t){return e==null?null:m.closeDistEps(e.Source.point,t.point)||m.closeDistEps(e.Target.point,t.point)?e:(e instanceof ar||this.edgesToRestore.push(e),Ye.RemoveEdge(e),(this.IsSparseVg||e.Weight===ve.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,i,n,o){let a=U.GetDirections(i.start,i.end);if(a===0)return;let l=ee.GetRectangleBound(t,a),u=ee.IsVerticalD(a)?T.RoundPoint(new m(e.point.x,l)):T.RoundPoint(new m(l,e.point.y));if(m.closeDistEps(u,e.point)||U.GetDirections(e.point,u)!==a)return;let c=i;U.GetDirections(u,c.end)===a&&(c=G.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,i,n,o)}ExtendEdgeChain(e,t,i,n,o,a){if(U.GetDirections(e.point,i.end)!==t)return;let u=Y.RotateLeft(t),c=ee.FindAdjacentVertex(e,u);if(c==null&&(u=Y.OppositeDir(u),c=ee.FindAdjacentVertex(e,u),c==null))return;let h=Y.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,i,n,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,i,n,a,d),this.SpliceGroupBoundaryCrossings(o,e,i)}SpliceGroupBoundaryCrossings(e,t,i){if(e==null||e.Count()===0)return;e.Reset();let n=i.start,o=i.end,a=U.GetDirections(n,o);ee.IsAscending(a)||(n=i.end,o=i.start,a=Y.OppositeDir(a)),t=ti.TraverseToFirstVertexAtOrAbove(t,n,Y.OppositeDir(a));for(let l=t;l!=null;l=ee.FindAdjacentVertex(l,a)){let u=U.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();U.ComparePP(c.Location,t.point)>0&&U.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,Y.OppositeDir(a)),U.ComparePP(c.Location,t.point)>=0&&U.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,i){let n=e,o=Y.OppositeDir(i);for(;;){let a=ee.FindAdjacentVertex(n,i);if(a==null||U.GetDirections(a.point,t)===o)break;n=a}return n}SpliceGroupBoundaryCrossing(e,t,i){var o,a;let n=Wo.ToCrossingArray(t.Crossings,i);if(n!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=n[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=n.map(f=>f.Group.InputShape);h.IsPassable=()=>d.some(f=>f.IsTransparent)}}ExtendSpliceWorker(e,t,i,n,o,a,l){let u=ee.FindAdjacentVertex(e,i);l.spliceTarget=ee.FindAdjacentVertex(u,i);let c={spliceSource:e};for(;ti.GetNextSpliceSource(c,i,t);){let h=ee.FindBendPointBetween(u.point,c.spliceSource.point,Y.OppositeDir(i));if(ti.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=ti.GetSpliceTarget(c,i,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?ve.OverlappedWeight:ve.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?ve.OverlappedWeight:ve.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?ve.OverlappedWeight:ve.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&U.GetDirections(h,n.end))===0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,i){let n=ee.FindAdjacentVertex(e.spliceSource,i);if(n==null)for(n=e.spliceSource;;){if(n=ee.FindAdjacentVertex(n,Y.OppositeDir(t)),n==null)return!1;let o=ee.FindAdjacentVertex(n,i);if(o!=null){n=o;break}}return e.spliceSource=n,!0}static GetSpliceTarget(e,t,i){let n=U.GetDirections(e.spliceSource.point,i),o=n,a=e.spliceSource;for(;o===n&&(e.spliceSource=a,a=ee.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(m.closeDistEps(a.point,i)){a=ee.FindAdjacentVertex(a,t);break}o=U.GetDirections(a.point,i)}return a}SeeIfSpliceIsStillOverlapped(e,t){let i=this.FindNextEdge(t,Y.RotateLeft(e)),n=i==null?!1:ve.NormalWeight===i.Weight;return n||(i=this.FindNextEdge(t,Y.RotateRight(e)),n=i==null?!1:ve.NormalWeight===i.Weight),!n||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(ti.IsSkippableSpliceSourceEdgeWithNullTarget(ee.FindAdjacentEdge(e,t)))return!0;let i=ee.FindAdjacentEdge(e,Y.OppositeDir(t));return ti.IsSkippableSpliceSourceEdgeWithNullTarget(i)||ti.IsReflectionEdge(i)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&le(e.Length,$l.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight===ve.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return U.GetDirections(e.start,e.end)===U.GetDirections(e.end,t)}toString(){return fC.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var Na=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new bt;this.freePointLocationsUsedByRouteEdges=new He;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new ti(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let i=T.RoundPoint(t.Location);if(0===R.PointRelativeToCurveLocation(i,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!==t.Curve&&0===R.PointRelativeToCurveLocation(i,t.Curve))return null;let n=new Rm(t,e);return this.obstaclePortMap.set(t,n),n}FindVertices(e){let t=new Array,i=this.obstaclePortMap.get(e);if(i)if(this.RouteToCenterOfObstacles)t.push(i.CenterVertex);else for(let n of i.PortEntrances){let o=this.VisGraph.FindVertex(n.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(T.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);if(this.AncestorSets.size>0&&i.oport!=null&&n.oport!=null){let l=gs(a,o),u=gs(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,i.oport),this.AddPortToGraph(e.targetPort,n.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let i=this.FindVertices(t),n=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i),n=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i)}ConnectToGraphAtPointsCollinearWithVertices(e,t,i){if(0===t)return;let n=Y.OppositeDir(t);for(let o of i){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,n,ve.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size===0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size===0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(q.mkPP(e.Location,e.Location),i=>i.IsGroup)).map(i=>i.InputShape))}ActivateAncestors(e,t,i){for(let n of Un(e,t)){let o=i.get(n);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=q.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let i={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(i)){for(let n of i.addedPorts)this.CreateObstaclePort(t.Obstacle,n);for(let n of i.removedPorts)this.RemoveObstaclePort(n);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),i=this.FindObstaclePort(e.targetPort);if(t==null||i==null||t.Obstacle.IsInConvexHull||i.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(i),!t.VisibilityRectangle.intersects(i.VisibilityRectangle)))return null;for(let n of t.PortEntrances)if(!!n.WantVisibilityIntersection)for(let o of i.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=n.IsVertical===o.IsVertical?Na.GetPathPointsFromOverlappingCollinearVisibility(n,o):Na.GetPathPointsFromIntersectingVisibility(n,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!ee.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||m.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let i=ee.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!i||e.HasGroupCrossingBeforePoint(i)||t.HasGroupCrossingBeforePoint(i)?null:[e.UnpaddedBorderIntersect,i,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,i=q.mkPP(T.RoundPoint(e.PortCurve.boundingBox.leftBottom),T.RoundPoint(e.PortCurve.boundingBox.rightTop)),n=T.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!U.Equal(n.y,i.top)&&!U.Equal(n.y,i.bottom)){o=!0;let l=new G(t.left,n.y,t.right,n.y);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(Math.min(a.xx0.x,a.xx1.x),n.y);u.x<i.left&&(u=new m(i.left,u.y));let c=new m(Math.max(a.xx0.x,a.xx1.x),n.y);c.x>i.right&&(c=new m(i.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}if(!U.Equal(n.x,i.left)&&!U.Equal(n.x,i.right)){o=!0;let l=new G(n.x,t.bottom,n.x,t.top);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(n.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new m(u.x,t.bottom));let c=new m(n.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new m(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}o||this.CreateEntrancesForCornerPort(i,e,n)}GetBorderIntersections(e,t,i,n){let o=R.getAllIntersections(t,i,!0);n.xx0=T.RoundPoint(o[0].x),n.xx1=T.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,i,n,o){let a=U.GetDirections(n,o);U.EqualPP(n,i)||this.CreatePortEntrance(e,t,o,a),U.EqualPP(o,i)||this.CreatePortEntrance(e,t,n,Y.OppositeDir(a))}static GetDerivative(e,t){let i=e.PortCurve.closestParameter(t),n=e.PortCurve.derivative(i),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return er.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(n=n.mul(-1)),n}CreatePortEntrance(e,t,i,n){t.CreatePortEntrance(i,n,this.ObstacleTree);let o=vt.GetInstance(n),a=ee.GetRectangleBound(e,n)-o.Coord(i);if(a<0&&(a=-a),a>T.intersectionEpsilon){let l=Y.VectorDirection(Na.GetDerivative(t,i)),u;n|Y.OppositeDir(n),0!==(n&l)&&(u=Y.OppositeDir(u)),t.CreatePortEntrance(i,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,i){let n=1;U.EqualPP(i,e.leftBottom)?n=4:U.EqualPP(i,e.leftTop)?n=8:U.EqualPP(i,e.rightTop)?n=1:U.EqualPP(i,e.rightBottom)&&(n=2),t.CreatePortEntrance(i,n,this.ObstacleTree),t.CreatePortEntrance(i,Y.RotateRight(n),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let i={targetVertex:null},n=e.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,n,i)!=null&&e.AddToAdjacentVertex(this.TransUtil,i.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return ee.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,i,n){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o)}FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o){let a=ee.SortAscending(e,t),l=a[0],u=a[1],c=ee.IsVerticalD(i)?this.HScanSegments:this.VScanSegments,h=ee.IsAscending(i)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=ee.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(ee.IsAscending(i)?l:u,h,d,n,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,i,n,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(i),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,i,t,n,a);if(d!=null)return d}else if(U.EqualPP(e,i))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,Y.OppositeDir(t.ScanDirection.Dir));let l=U.GetDirections(i,e),u=U.GetDirections(a.segsegVertex.point,e);if(l===u){let d={bracketTarget:null,bracketSource:null};return ti.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,Y.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,Y.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(i),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=ee.GetEdgeEnd(c,Y.OppositeDir(u)),i=ee.SegmentIntersectionPPP(e,i,a.segsegVertex.point),U.EqualPP(a.segsegVertex.point,i)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(i),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,n)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,i,n,o){let l=(i.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(i.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,i.LowestVisibilityVertex,i.Weight);let u=ee.SegmentsIntersection(i,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(i,o.segsegVertex,i.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),U.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return U.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,n)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,i){return U.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,i):U.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,i):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():q.mkOnPoints([T.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new Om(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=T.RoundPoint(e);let t=this.VisGraph.FindVertex(e),i=this.FindOrCreateFreePoint(e);if(t!=null)return i;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(i),i;let n=null;i.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(i.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};n=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,i.InitialWeight,l)}let a=4;if(n!=null)a=ee.EdgeDirectionVE(n),this.ConnectFreePointToLateralEdge(i,Y.RotateLeft(a)),this.ConnectFreePointToLateralEdge(i,Y.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(i,a),a=Y.RotateLeft(a);return i}CreateOutOfBoundsFreePoint(e){let t=e.Point,i=this.graphGenerator.MakeInBoundsLocation(t),n=U.GetDirections(i,t);if(e.OutOfBoundsDirectionFromGraph=n,!U.IsPureDirectionD(n)){e.AddOobEdgesFromGraphCorner(this.TransUtil,i);return}let o=this.VisGraph.FindVertex(i),a=Y.OppositeDir(n);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,i,n,ve.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=ee.FindAdjacentVertex(o,Y.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,ve.NormalWeight);let u=ee.FindAdjacentVertex(o,Y.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,ve.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let i=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),n=this.FindorCreateNearestPerpEdgePPDN(i,e.Point,t,e.InitialWeight);n!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,n,t,this.portSpliceLimitRectangle)}};var ur=class extends Pe{constructor(t,i,n){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=i,this.CornerFitRadius=n,this.BendPenaltyAsAPercentageOfDistance=Zi.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new Br,this.PortManager=new Na(this.GraphGenerator),this.AddShapes(t)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(t){this.PortManager.RouteToCenterOfObstacles=t}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(t){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=t}AddEdgeGeometryToRoute(t){m.closeDistEps(T.RoundPoint(t.sourcePort.Location),T.RoundPoint(t.targetPort.Location))?this.selfEdges.push(t):this.EdgesToRoute.push(t)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof Br}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(t=>t.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(t=>t.PaddedPolyline)}AddObstacles(t){this.AddShapes(t),this.RebuildTreeAndGraph()}AddShapes(t){for(let i of t)this.AddObstacleWithoutRebuild(i)}AddObstacle(t){this.AddObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}UpdateObstacles(t){for(let i of t)this.UpdateObstacleWithoutRebuild(i);this.RebuildTreeAndGraph()}UpdateObstacle(t){this.UpdateObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}RemoveObstacles(t){for(let i of t)this.RemoveObstacleWithoutRebuild(i);this.RebuildTreeAndGraph()}RemoveObstacle(t){this.RemoveObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(t){if(t.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(t)}UpdateObstacleWithoutRebuild(t){if(t.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(t)),this.CreatePaddedObstacle(t)}CreatePaddedObstacle(t){let i=new Cr(t,this.Padding);this.ShapeToObstacleMap.set(t,i),this.PortManager.CreateObstaclePorts(i)}RemoveObstacleWithoutRebuild(t){let i=this.ShapeToObstacleMap.get(t);this.ShapeToObstacleMap.delete(t),this.PortManager.RemoveObstaclePorts(i)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let t=this.ObsTree.Root!=null,i=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),t&&this.GenerateObstacleTree(),i&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return ur.constructorC(null)}static constructorC(t){return new ur([],ur.DefaultPadding,ur.DefaultCornerFitRadius)}static constructorI(t){return new ur(t,ur.DefaultPadding,ur.DefaultCornerFitRadius)}static constructorINN(t,i,n){return new ur(t,i,n)}static constructorGNAN(t,i,n,o){let a=new ur(Nr.GetShapes(t),n,o);if(i==null)for(let l of t.deepEdges)a.AddEdgeGeometryToRoute(l);else for(let l of i)a.AddEdgeGeometryToRoute(l);return a}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let t=this.EdgesToRoute.map(i=>new Im(i));this.FillEdgePathsWithShortestPaths(t),this.NudgePaths(t),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let t of this.selfEdges){let i={smoothedPolyline:null};t.curve=We.RouteSelfEdge(t.sourcePort.Curve,Math.max(this.Padding,2*t.GetMaxArrowheadLength()),i)}}FillEdgePathsWithShortestPaths(t){this.PortManager.BeginRouteEdges();let i=new La(this.BendPenaltyAsAPercentageOfDistance);for(let n of t)this.AddControlPointsAndGeneratePath(i,n);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(t,i){let n=this.PortManager.GetPortVisibilityIntersection(i.GeomEdge);if(n!=null){this.GeneratePathThroughVisibilityIntersection(i,n);return}this.SpliceVisibilityAndGeneratePath(t,i)}GeneratePathThroughVisibilityIntersection(t,i){t.PathPoints=i}SpliceVisibilityAndGeneratePath(t,i){this.PortManager.AddControlPointsToGraph(i.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(t,i,!1)||this.RetryPathsWithAdditionalGroupsEnabled(t,i),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(t,i,n){let o=this.PortManager.FindVertices(i.GeomEdge.sourcePort),a=this.PortManager.FindVertices(i.GeomEdge.targetPort);return ur.GetSingleStagePath(i,t,o,a,n)}static GetSingleStagePath(t,i,n,o,a){return t.PathPoints=i.GetPath(n,o),a&&ur.EnsureNonNullPath(t),t.PathPoints!=null&&t.PathPoints.length>0}static EnsureNonNullPath(t){t.PathPoints==null&&(U.IsPureDirection(t.GeomEdge.sourcePort.Location,t.GeomEdge.targetPort.Location)?t.PathPoints=[t.GeomEdge.sourcePort.Location,t.GeomEdge.targetPort.Location]:t.PathPoints=[t.GeomEdge.sourcePort.Location,new m(t.GeomEdge.sourcePort.Location.x,t.GeomEdge.targetPort.Location.y),t.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(t,i){(!this.PortManager.SetAllAncestorsActive(i.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(t,i,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(t,i,!0))}NudgePaths(t){let i=this.ObsTree.SpatialAncestorsAdjusted?ze.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;st.NudgePaths(t,this.CornerFitRadius,this.PaddedObstacles,i,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(t){this.removeStaircases=t}FinaliseEdgeGeometries(){for(let t of this.EdgesToRoute.concat(this.selfEdges)){if(t.curve==null)continue;t.curve instanceof ie&&(t.curve=ur.FitArcsIntoCorners(this.CornerFitRadius,Array.from(t.curve))),ur.CalculateArrowheads(t)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(t){mt.trimSplineAndCalculateArrowheadsII(t,t.sourcePort.Curve,t.targetPort.Curve,t.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=ze.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(t){this.GraphGenerator.Clear(),this.ClearShortestPaths(),t?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let t of this.EdgesToRoute)t.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(t,i){let n=ur.GetFittedArcSegs(t,i),o=new R,a=null;for(let l of n){let u=ur.EllipseIsAlmostLineSegment(l);a!=null?u?R.continueWithLineSegmentP(o,ur.CornerPoint(l)):(R.continueWithLineSegmentP(o,l.start),o.addSegment(l)):u?R.addLineSegment(o,i[0],ur.CornerPoint(l)):(R.addLineSegment(o,i[0],l.start),o.addSegment(l)),a=l}return o.segs.length>0?R.continueWithLineSegmentP(o,i[i.length-1]):R.addLineSegment(o,i[0],i[i.length-1]),o}static CornerPoint(t){return t.center.add(t.aAxis.add(t.bAxis))}static EllipseIsAlmostLineSegment(t){return t.aAxis.lengthSquared<1e-4||t.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(t,i){let n=i[1].sub(i[0]),o=n.normalize(),a=Math.min(t,n.length/2);for(let l=1;l<i.length-1;l++){n=i[l+1].sub(i[l]);let u=n.length;if(u<T.intersectionEpsilon){yield new be(0,0,new m(0,0),new m(0,0),i[l]);continue}let c=n.div(u);Math.abs(c.dot(o))>.9&&(yield new be(0,0,new m(0,0),new m(0,0),i[l]));let h=Math.min(t,n.length/2),d=c.mul(-h),f=o.mul(a);yield new be(0,Math.PI/2,d,f,i[l].sub(f.add(d))),o=c,a=h}}},Ma=ur;Ma.DefaultPadding=1,Ma.DefaultCornerFitRadius=3;var gC=Ae(or(),1),Mi=class{constructor(e,t,i,n=1){this.Source=e,this.Target=t,this.CrossingWeight=i,this.Weight=n}toString(){return gC.String.Format("{0}->{1}",this.Source,this.Target)}};var Ba=class{static FindClosestPoints(e,t){let i=R.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(i)return{curveClosestPoint:i.aX,labelSideClosest:i.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof R){for(let i of e.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static ShiftLabel(e,t,i){let n=e.lineWidth/2,o=t.sub(i),a=o.length;a>n&&e.label.positionCenter(e.label.center.add(o.div(a*(a-n))))}static updateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new m(t.x+t.rightAnchor/2,t.y)),i=G.mkPP(e.label.boundingBox.leftTop,e.label.boundingBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new m(t.x-t.leftAnchor/2,t.y)),i=G.mkPP(e.label.boundingBox.rightTop,e.label.boundingBox.rightBottom));let n=Ba.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&R.getAllIntersections(e.curve,R.polyFromBox(e.label.boundingBox),!1).length===0){let o=Ba.FindClosestPoints(n,i);if(o)Ba.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=n.closestParameter(i.start),c=n.closestParameter(i.end);n.value(u).sub(i.start).length<n.value(c).sub(i.end).length?(a=n.value(u),l=i.start):(a=n.value(c),l=i.end),Ba.ShiftLabel(e,a,l)}}}},Dr=class{constructor(e,t,i,n=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=i,this.weight=n,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.smoothedPolyline}set underlyingPolyline(e){this.edge.smoothedPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source===this.target}reversedClone(){let e=new Dr(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let i=0;i<t;i++){let n=this.LayerEdges[t-1-i];e.LayerEdges[i]=new Mi(n.Target,n.Source,n.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e===this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,i=this.LayerEdges[t];Ba.updateLabel(this.edge,e[i.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var Dm=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new Ar;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size===0&&this.minLayerOfGeomGraph.size===0&&this.sameLayerConstraints.length===0&&this.upDownConstraints.length===0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=yr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=wi.getFeedbackSetWithConstraints(e,null);for(let i of t)this.gluedUpDownIntConstraints.remove(i)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new ye(this.maxRepresentative,t))}if(this.minRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.minRepresentative&&this.gluedUpDownIntConstraints.add(new ye(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new Ar}gluedIntPairNN(e){return new ye(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new ye(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new ye(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),i=this.nodeToRepr(e.target),n=new Dr(t,i,e.edge);return n.separation=e.separation,n.weight=0,n}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Xn(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return yr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!==-1&&this.maxLayerInt.filter(t=>t!==this.maxRepresentative).map(t=>new ye(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!==-1&&this.minLayerInt.filter(t=>t!==this.minRepresentative).map(t=>new ye(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new ye(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.minRepresentative);else for(let i of e)t===-1&&(t=i),this.sameLayerDictionaryOfRepresentatives.set(i,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative===t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative===t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!==-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(wi.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let i of this.unglueEdge(t))yield i}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let i of this.intGraph.outEdges[t])this.nodeToRepr(i.target)===e.target&&(yield i)}createGluedGraph(){let e=new Ar;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),yr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function T2(s,e){return[s,e]}var Fm=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length===0&&this.upDownVerticalConstraints.length===0&&this.leftRightConstraints.length===0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length===0&&!this.nodeToBlockRoot.has(t)){let i=new Array,n=t;for(let o=e.outEdges[n];o.length>0;o=e.outEdges[n])n=o[0].y,i.push(n),this.nodeToBlockRoot.set(n,t);i.length>0&&this.BlockRootToBlock.set(t,i)}}BasicGraphFromLeftRightIntNeibs(){return pc(Array.from(this.LeftRightIntNeibs.values()).map(e=>new ye(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=Ar.mk(this.leftRightConstraints.map(t=>T2(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new ye(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!==t.x));let e=wi.getFeedbackSet(pc(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new ye(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=Ar.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new ye(t[0],t[1]))),this.VerticalInts=Ar.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1&&e[t[0]]>e[t[1]]).map(t=>new ye(t[0],t[1])))}};var tu=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(tu||{});var jo=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=2;this.polylinePadding=1;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}toJSON(){let e={};return this.EdgeRoutingMode!=0&&(e.edgeRoutingMode=0),this.ConeAngle!=30*(Math.PI/180)&&(e.coneAngle=this.ConeAngle),this.padding!=3&&(e.padding=this.padding),this.polylinePadding!=1.5&&(e.polylinePadding=this.polylinePadding),this.bundlingSettings&&(e.bundlingSettingsJSON=this.bundlingSettings.toJSON()),e}static fromJSON(e){let t=new jo;return e.edgeRoutingMode&&(e.edgeRoutingMode=t.edgeRoutingMode),e.coneAngle&&(t.coneAngle=e.coneAngle),e.padding&&(t.padding=e.padding),e.polylinePadding&&(t.polylinePadding=e.polylinePadding),e.bundlingSettingsJSON&&(t.bundlingSettings=Sn.createFromJSON(e.bundlingSettingsJSON)),e.routingToParentConeAngle&&(t.routingToParentConeAngle=e.routingToParentConeAngle),e.simpleSelfLoopsForParentEdgesThreshold&&(t.simpleSelfLoopsForParentEdgesThreshold=e.simpleSelfLoopsForParentEdgesThreshold),e.incrementalRoutingThreshold&&(t.incrementalRoutingThreshold=e.incrementalRoutingThreshold),e.routeMultiEdgesAsBundles&&(t.routeMultiEdgesAsBundles=e.routeMultiEdgesAsBundles),e.KeepOriginalSpline&&(t.KeepOriginalSpline=e.KeepOriginalSpline),t}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e===1&&this.bundlingSettings==null&&this.bundlingSettings==null&&(this.bundlingSettings=new Sn),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var Zn=class{constructor(){this.edgeRoutingSettings=new jo;this.nodeSeparation=10;this.packingAspectRatio=1.5}static fromJSON(e){let t=new Zn;return e.nodeSeparation!=10&&(t.nodeSeparation=e.nodeSeparation),e.packingAspectRatio&&(t.packingAspectRatio=e.packingAspectRatio),e.edgeRoutingSettings&&(t.edgeRoutingSettings=jo.fromJSON(e.edgeRoutingSettings)),t}toJSON(){let e=!1,t={};return this.nodeSeparation!=10&&(t.nodeSeparation=this.nodeSeparation,e=!0),this.packingAspectRatio!=1.5&&(t.packingAspectRatio=this.packingAspectRatio,e=!0),(t.edgeRoutingSettings=this.edgeRoutingSettings.toJSON())&&(e=!0),e?t:void 0}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}};var Rt=class{constructor(){this.commonSettings=new Zn;this.verticalConstraints=new Dm;this.horizontalConstraints=new Fm;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=xt.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.commonSettings.edgeRoutingSettings.EdgeRoutingMode=3}get NodeSeparation(){return this.commonSettings.NodeSeparation}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}toJSON(){let e={};return this.sameRanks&&(e.sameRanks=this.sameRanks),this.verticalConstraints&&(e.verticalConstraints=this.verticalConstraints),this.horizontalConstraints&&(e.horizontalConstraints=this.horizontalConstraints),this.NoGainAdjacentSwapStepsBound!=5&&(e.horizontalConstraints=this.horizontalConstraints),this.RepetitionCoefficientForOrdering!=1&&(e.RepetitionCoefficientForOrdering=this.RepetitionCoefficientForOrdering),this.AspectRatio&&(e.AspectRatio=this.AspectRatio),this.MaxNumberOfPassesInOrdering!=24&&(e.MaxNumberOfPassesInOrdering=this.MaxNumberOfPassesInOrdering),this.BrandesThreshold!=600&&(e.BrandesThreshold=this.BrandesThreshold),this.LabelCornersPreserveCoefficient!=.1&&(e.LabelCornersPreserveCoefficient=this.LabelCornersPreserveCoefficient),this.MinNodeHeight!=72*.5/4&&(e.MinNodeHeight=this.MinNodeHeight),this.MinNodeWidth!=72*.75/4&&(e.MinNodeWidth=this.MinNodeWidth),this.SnapToGridByY!=0&&(e.SnapToGridByY=this.SnapToGridByY),this.yLayerSep!=10*3&&(e.yLayerSep=this.yLayerSep),this.transform&&(e.transform=this.transform.elements),this.GridSizeByY&&(e.GridSizeByY=this.GridSizeByY),this.GridSizeByX&&(e.GridSizeByX=this.GridSizeByX),e.commonLayoutSettings=this.commonSettings.toJSON(),e}static fromJSON(e){let t=new Rt;return e.sameRanks&&(t.sameRanks=e.sameRanks),e.verticalConstraints&&(t.verticalConstraints=e.verticalConstraints),e.horizontalConstraints&&(t.horizontalConstraints=e.horizontalConstraints),e.NoGainAdjacentSwapStepsBound&&(t.horizontalConstraints=e.horizontalConstraints),e.RepetitionCoefficientForOrdering&&(t.RepetitionCoefficientForOrdering=e.RepetitionCoefficientForOrdering),e.AspectRatio&&(t.AspectRatio=e.AspectRatio),e.MaxNumberOfPassesInOrdering&&(t.MaxNumberOfPassesInOrdering=e.MaxNumberOfPassesInOrdering),e.BrandesThreshold&&(t.BrandesThreshold=e.BrandesThreshold),e.LabelCornersPreserveCoefficient&&(t.LabelCornersPreserveCoefficient=e.LabelCornersPreserveCoefficient),e.MinNodeHeight&&(t.MinNodeHeight=e.MinNodeHeight),e.MinNodeWidth&&(t.MinNodeWidth=t.MinNodeWidth),e.SnapToGridByY&&(t.SnapToGridByY=e.SnapToGridByY),e.yLayerSep&&(t.yLayerSep=e.yLayerSep),e.transform&&(t.transform=new xt(e.transform[0][0],e.transform[0][1],e.transform[0][2],e.transform[1][0],e.transform[1][1],e.transform[1][2])),e.GridSizeByY&&(t.GridSizeByY=e.GridSizeByY),e.GridSizeByX&&(t.GridSizeByX=e.GridSizeByX),e.commonLayoutSettings&&(t.commonSettings=Zn.fromJSON(e.commonLayoutSettings)),t}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=xt.rotation(e);for(let i=0;i<2;i++)for(let n=0;n<3;n++)if(!le(t.elements[i][n],this.transform.elements[i][n]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=xt.getIdentity();break;case 1:this.transform=xt.rotation(Math.PI/2);break;case 3:this.transform=xt.rotation(-Math.PI/2);break;case 2:this.transform=xt.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var Gc=class extends Pe{constructor(t,i,n){super(null);this.graph=t,this.source=i,this.length=n}get Result(){return this.result}run(){let t=new Sr((o,a)=>o-a),i=new Map;for(let o of this.graph.shallowNodes){let a=o===this.source?0:Number.POSITIVE_INFINITY;t.Enqueue(o,a),i.set(o,a)}for(;t.count>0;){let o={priority:0},a=t.DequeueAndGetPriority(o);i.set(a,o.priority);let l=i.get(a);for(let u of a.inEdges()){let c=u.source,h=l+this.length(u);i.get(c)>h&&(i.set(c,h),t.DecreasePriority(c,h))}for(let u of a.outEdges()){let c=u.target,h=l+this.length(u);i.get(c)>h&&(i.set(c,h),t.DecreasePriority(c,h))}}this.result=new Array(this.graph.shallowNodeCount);let n=0;for(let o of this.graph.shallowNodes){let a=i.get(o);a!==void 0?this.result[n++]=a:this.result[n++]=Number.POSITIVE_INFINITY}}};var Vc=class extends Pe{constructor(t,i){super(null);this.graph=t,this.length=i}get Result(){return this.result}set Result(t){this.result=t}run(){this.result=new Array(this.graph.shallowNodeCount);let t=0;for(let i of this.graph.shallowNodes){let n=new Gc(this.graph,i,this.length);n.run(),this.Result[t++]=n.Result}}static Stress(t,i){let n=0;if(t.edgeCount===0)return n;let o=new Vc(t,i);o.run();let a=o.Result,l=0;for(let c of t.shallowEdges)l+=i(c);l/=t.edgeCount;let u=0;for(let c of t.shallowNodes){let h=0;for(let d of t.shallowNodes){if(u!==h){let f=c.center.sub(d.center).length,p=l*a[u][h],S=p-f;n+=S*S/(p*p)}h++}u++}return n}};var Gm=class extends Pe{constructor(t,i,n){super(null);this.graph=t,this.pivotArray=i,this.length=n}get Result(){return this.result}run(){this.result=new Array(this.pivotArray.length);let t=Array.from(this.graph.shallowNodes),i=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),n=t[0];this.pivotArray[0]=0;for(let o=0;;o++){let a=new Gc(this.graph,n,this.length);if(a.run(),this.Result[o]=a.Result,o+1<this.pivotArray.length){let l=0;for(let u=0;u<this.Result[o].length;u++)i[u]=Math.min(i[u],this.Result[o][u]),i[u]>i[l]&&(l=u);n=t[l],this.pivotArray[o+1]=l}else break}}};var Vm=class{static Rotate(e,t,i){let n=Math.sin(i*(Math.PI/180)),o=Math.cos(i*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+n*t[a];t[a]=o*t[a]-n*e[a],e[a]=l}}};var rt=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),i=new Array(e[0].length).fill(0),n=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],i[a]+=e[o][a],n+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)i[o]/=e[0].length;n/=e.length,n/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+i[a]-n}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[0].length;i++)e[t][i]=Math.pow(e[t][i],2)}static Multiply(e,t){for(let i=0;i<e.length;i++)for(let n=0;n<e[0].length;n++)e[i][n]*=t}static MultiplyX(e,t){if(e[0].length!==t.length)return null;let i=new Array(t.length).fill(0);for(let n=0;n<e.length;n++)for(let o=0;o<e[0].length;o++)i[n]+=e[n][o]*t[o];return i}static Norm(e){let t=0;for(let i=0;i<e.length;i++)t+=Math.pow(e[i],2);return Math.sqrt(t)}static Normalize(e){let t=rt.Norm(e);if(t<=0)return 0;for(let i=0;i<e.length;i++)e[i]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let i=0;i<e;i++)t[i]=Do();return rt.Normalize(t),t}static SpectralDecomposition(e,t){rt.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,i,n){let o=e[0].length;t.u1=rt.RandomUnitLengthVector(o),t.lambda1=0,t.u2=rt.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-n;for(let u=0;u<i&&a<l;u++){let c=rt.MultiplyX(e,t.u1),h=rt.MultiplyX(e,t.u2);t.lambda1=rt.Normalize(c),t.lambda2=rt.Normalize(h),rt.MakeOrthogonal(h,c),rt.Normalize(h),a=Math.min(rt.DotProduct(t.u1,c),rt.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!==t.length)return 0;let i=0;for(let n=0;n<e.length;n++)i+=e[n]*t[n];return i}static MakeOrthogonal(e,t){if(e.length!==t.length)return;let i=rt.DotProduct(e,t)/rt.DotProduct(t,t);for(let n=0;n<e.length;n++)e[n]-=i*t[n]}static ClassicalScaling(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=e[n].slice();rt.SquareEntries(i),rt.DoubleCenter(i),rt.Multiply(i,-.5),rt.SpectralDecomposition(i,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let n=0;n<t.u1.length;n++)t.u1[n]*=t.lambda1,t.u2[n]*=t.lambda2}static DistanceScalingSubset(e,t,i,n,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]===0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!==d&&(c[h]+=n[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let f=0,p=0;for(let S=0;S<a;S++)if(d!==S){let x=Math.sqrt(Math.pow(t[u[d]]-t[S],2)+Math.pow(i[u[d]]-i[S],2));x>0&&(x=1/x),f+=n[d][S]*(t[S]+e[d][S]*(t[u[d]]-t[S])*x),p+=n[d][S]*(i[S]+e[d][S]*(i[u[d]]-i[S])*x)}t[u[d]]=f/c[d],i[u[d]]=p/c[d]}}static DistanceScaling(e,t,i,n,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!==c&&(l[u]+=n[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let f=0;f<a;f++)if(c!==f){let p=Math.sqrt(Math.pow(t[c]-t[f],2)+Math.pow(i[c]-i[f],2));p>0&&(p=1/p),h+=n[c][f]*(t[f]+e[c][f]*(t[c]-t[f])*p),d+=n[c][f]*(i[f]+e[c][f]*(i[c]-i[f])*p)}t[c]=h/l[c],i[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e[n].length).fill(0);for(let o=0;o<e[n].length;o++)e[n][o]>0&&(i[n][o]=Math.pow(e[n][o],t))}return i}static EuclideanDistanceMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e.length);for(let o=0;o<e.length;o++)i[n][o]=Math.sqrt(Math.pow(e[n]-e[o],2)+Math.pow(t[n]-t[o],2))}return i}static LandmarkClassicalScaling(e,t,i){let n=new Array(e.length);for(let l=0;l<e.length;l++){n[l]=new Array(e.length);for(let u=0;u<e.length;u++)n[l][u]=e[l][i[u]]}rt.SquareEntries(n);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=n[l][u];o[l]/=e.length}rt.DoubleCenter(n),rt.Multiply(n,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};rt.SpectralDecomposition(n,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<n.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var Da=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,i=this.clone();return i.add_d(t.start),i.add_d(t.end),i}clone(){return new Da(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new Da(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let i=new Da(e.start,e.end);return i.add_d(t.start),i.add_d(t.end),i}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+T.distanceEpsilon?!1:!(e.end<this.start-T.distanceEpsilon)}};var kc=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let i=this.heapSize;for(this._priors[e]=t,this.PutAtI(i,e);i>1&&this._priors[this._heap[i>>1]]>t;)this.SwapWithParent(i),i>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize===0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this._priors[this._heap[n]]<this._priors[this._heap[t]]&&(i=n);let o=n+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[i]]&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}}return this.heapSize--,e}IsEmpty(){return this.heapSize===0}DecreasePriority(e,t){this._priors[e]=t;let i=this._reverse_heap[e];for(;i>1&&this._priors[this._heap[i]]<this._priors[this._heap[i>>1]];){this.SwapWithParent(i);i>>=1}}};var km=class{constructor(e,t,i,n){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=i,this._forLayers=n,this._q=new kc(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=hs([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let i of this._intervalTree.GetAllIntersecting(t)){let n=ri.GetIdealEdge(e,i,this._nodePositions[e],this._nodePositions[i],this._nodeSizes);if(n.overlapFactor<=1)return;this._proximityEdges.push(n),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,i=this._nodePositions[e].x;return new Da(i-t,i+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,i=this._nodePositions[e].y;this._q.Enqueue(e,i-t),this._q.Enqueue(this._nodeSizes.length+e,i+t)}}};var Kd=class{constructor(e,t,i){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=i,this.q=new kc(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),i=this.hedgehog.get(t);this.treeNodes.add(t),e.push(i),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let i=t.target;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let i=t.source;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var Uc=class{static GetMst(e,t){if(e.length===0)return null;let i=e.map(u=>new ye(u.source,u.target)),n=i.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new Xr(n+1);for(let u=0;u<e.length;u++)o.setPair(i[u],e[u]);let a=yr(i,t);return new Kd(a,u=>o.get(u.source,u.target).weight,i[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let i=Array.from(e.PointsToSites.values()),n=new Map;for(let u=0;u<i.length;u++)n.set(i[u],u);let o=Uc.GetEdges(i,n),a=Gp(Array.from(o.keys()));return new Kd(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let i=new Xr(e.length);for(let n=0;n<e.length;n++){let o=e[n],a=t.get(o);for(let l of o.Edges)i.set(a,t.get(l.lowerSite),l)}return i}};var zc=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new zc;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var ri=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let i=new zc;i.RandomizeAllPointsOnStart=!0,i.NodeSeparation=t,new ri(i,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(I2(this._settings,this._nodes,e,this._settings.randomizeAllPointsOnStart),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!==1&&this._nodes.length===2){let e=this._nodes[0],t=this._nodes[1];m.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new m(.001,0)));let i=this.GetIdealDistanceBetweenTwoNodes(e,t),n=m.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(i/a)),e.center=n.add(o),t.center=n.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let i=e.center.sub(t.center),n=Math.abs(i.x),o=Math.abs(i.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return n>T.tolerance&&(u=a/n),o>T.tolerance&&(c=l/o),Math.min(u,c)*i.length}static AvgEdgeLength(e){let t=0,i=0;for(let n of e)for(let o of n.outEdges())i+=n.center.sub(o.target.center).length,t++;return t>0?i/t:1}OneIteration(e,t,i){let n=new Array;for(let h=0;h<e.length;h++)n.push([e[h],h]);let o=je.constructor_(n);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let f=d.upperSite.point,p=d.lowerSite.point,S=a.get(d.upperSite),x=a.get(d.lowerSite),C=ri.GetIdealEdge(S,x,f,p,t);u.push(C),C.overlapFactor>1&&l++}if(l===0||i){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l===0&&h===0||l===0&&!i)return!1}let c=Uc.GetMst(u,e.length);return ri.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,i){return new km(e,t,i,this._overlapForLayers).Run()}static GetIdealEdge(e,t,i,n,o){let a={overlapFactor:0},l=ri.GetIdealEdgeLength(e,t,i,n,o,a),u=i.sub(n).length,c=q.mkSizeCenter(o[e],i),h=q.mkSizeCenter(o[t],n),d=a.overlapFactor>1?u-l:ri.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,i,n,o,a){let l=i.sub(n),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,f=(o[e].height+o[t].height)/2;if(c>=d||h>=f)return a.overlapFactor=1,l.length;let p,S=1e-10;if(c>S)h>S?p=Math.min(d/c,f/h):p=d/c;else if(h>S)p=f/h;else return a.overlapFactor=2,Math.sqrt(d*d+f*f)/4;return p=Math.max(p,1.001),a.overlapFactor=p,p*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let i=0,n=0;return(e.right<t.left||t.right<e.left)&&(n=e.left-t.right),e.top<t.bottom?i=t.bottom-e.top:t.top<e.bottom&&(i=e.bottom-t.top),Math.sqrt(n*n+i*i)}static MoveNodePositions(e,t,i){let n=t.map(a=>a.clone()),o=new Set;o.add(i);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?ri.MoveNode(l.source,l.target,n,t,o,l.idealDistance):ri.MoveNode(l.target,l.source,n,t,o,l.idealDistance)}}static MoveNode(e,t,i,n,o,a){let l=i[t].sub(i[e]);l=l.mul(a/l.length+.01),n[t]=n[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function I2(s,e,t,i){t.nodePositions=e.map(n=>n.center),w2(t.nodePositions,new ya(0,0),.01,i),t.nodeSizes=e.map(n=>{let o=n.boundingBox.size;return o.width+=s.NodeSeparation,o.height+=s.NodeSeparation,o})}function w2(s,e,t,i){let n=new He;for(let o=0;o<s.length;o++){let a=s[o];if(i||n.has(a))do{let l=a.x+(2*e.random()-1)*t,u=a.y+(2*e.random()-1)*t;a=new m(l,u)}while(n.has(a));s[o]=a,n.add(a)}}var Is=class extends Pe{constructor(t,i,n,o){super(n);this.settings=t,this.graph=i,this.length=o}run(){this.LayoutConnectedGraphWithMds(),this.graph.pumpTheBoxToTheGraphWithMargins()}static ScaleToAverageEdgeLength(t,i,n,o){let a=new Map,l=0;for(let h of t.shallowNodes)a.set(h,l),l++;let u=0,c=0;for(let h of t.shallowEdges){let d=a.get(h.source),f=a.get(h.target);c+=Math.sqrt(Math.pow(i[d]-i[f],2)+Math.pow(n[d]-n[f],2)),u+=o(h)}if(u>0&&(c/=u),c>0)for(let h=0;h<i.length;h++)i[h]/=c,n[h]/=c}static LayoutGraphWithMds(t,i,n,o){if(n.x=new Array(t.shallowNodeCount),n.y=new Array(t.shallowNodeCount),n.x.length===0)return;if(n.x.length===1){n.x[0]=n.y[0]=0;return}let a=Math.min(i.PivotNumber,t.shallowNodeCount),l=i.GetNumberOfIterationsWithMajorization(t.shallowNodeCount),u=i.Exponent,c=new Array(a),h=new Gm(t,c,o);h.run();let d=h.Result;if(rt.LandmarkClassicalScaling(d,n,c),Is.ScaleToAverageEdgeLength(t,n.x,n.y,o),l>0){let f=new Vc(t,o);f.run();let p=f.Result,S=rt.ExponentialWeightMatrix(p,u);rt.DistanceScalingSubset(p,n.x,n.y,S,l)}}LayoutConnectedGraphWithMds(){let t={x:[],y:[]};Is.LayoutGraphWithMds(this.graph,this.settings,t,this.length),this.settings.RotationAngle!==0&&Vm.Rotate(t.x,t.y,this.settings.RotationAngle);let i=0;for(let n of this.graph.shallowNodes)n.boundingBox&&(n.center=new m(t.x[i]*this.settings.ScaleX,t.y[i]*this.settings.ScaleY)),i++;this.settings.removeOverlaps&&ri.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins()}ScaleNodes(t,i){for(let n of t)n.center=n.center.mul(i)}static PackGraphs(t,i){if(t.length===0)return q.mkEmpty();if(t.length===1)return t[0].boundingBox;let n=t.map(l=>l.boundingBox),o=new Array;for(let l of t)o.push({g:l,lb:l.boundingBox.leftBottom.clone()});let a=new hc(n,i.PackingAspectRatio);a.run();for(let{g:l,lb:u}of o){let c=l.boundingBox.leftBottom.sub(u);l.translate(c)}return new q({left:0,bottom:0,right:a.PackedWidth,top:a.PackedHeight})}};var Bi=class{constructor(){this.commonSettings=new Zn;this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this._removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=2e3;this.adjustScale=!1}static fromJSON(e){let t=new Bi;return e.pivotNumber&&(t.pivotNumber=e.pivotNumber),e.iterationsWithMajorization&&(t.iterationsWithMajorization=e.iterationsWithMajorization),e.scaleX&&(t.scaleX=e.scaleX),e.scaleY&&(t.scaleY=e.scaleY),e.exponent&&(t.exponent=e.exponent),e.rotationAngle&&(t.rotationAngle=e.rotationAngle),e.removeOverlaps!=null&&(t._removeOverlaps=e.removeOverlaps),e._callIterationsWithMajorizationThreshold&&(t._callIterationsWithMajorizationThreshold=e._callIterationsWithMajorizationThreshold),t}toJSON(){let e={};return this.pivotNumber!=50&&(e.pivotNumber=this.pivotNumber),this.iterationsWithMajorization!=30&&(e.iterationsWithMajorization=this.iterationsWithMajorization),this.scaleX!=200&&(e.scaleX=this.scaleX),this.scaleY!=200&&(e.scaleY=this.scaleY),this.exponent!=-2&&(e.exponent=this.exponent),this.rotationAngle!=0&&(e.rotationAngle=this.rotationAngle),this._removeOverlaps||(e.removeOverlaps=this._removeOverlaps),this._callIterationsWithMajorizationThreshold!=3e3&&(e._callIterationsWithMajorizationThreshold=this._callIterationsWithMajorizationThreshold),e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get removeOverlaps(){return this._removeOverlaps}set removeOverlaps(e){this._removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var Wc=class extends Pe{constructor(t,i,n,o){super(i);this.graph=t,this.length=n,this.settings=o,this.settings.ScaleX=this.settings.ScaleY=200}get scaleX(){return this.settings.ScaleX}set scaleX(t){this.settings.ScaleX=t}get scaleY(){return this.settings.ScaleY}set scaleY(t){this.settings.ScaleY=t}run(){new Is(this.settings,this.graph,this.cancelToken,this.length).run()}};function Um(s,e,t){if(e)for(let i of e){if(t&&t.canceled)return;Fr.RouteEdge(i,s.padding)}else for(let i of s.nodesBreadthFirst){if(t&&t.canceled)return;for(let n of i.outEdges())n.curve==null&&Fr.RouteEdge(n,s.padding);for(let n of i.selfEdges())n.curve==null&&Fr.RouteEdge(n,s.padding)}}var Fr=class extends Pe{constructor(t,i){super(null);this.edges=t,this.padding=i}run(){ze.CreatePortsIfNeeded(this.edges);for(let t of this.edges)Fr.RouteEdge(t,this.padding)}static RouteEdge(t,i){let n=t;n.sourcePort==null&&(n.sourcePort=Qr.mk(()=>t.source.boundaryCurve,()=>t.source.center)),n.targetPort==null&&(n.targetPort=Qr.mk(()=>t.target.boundaryCurve,()=>t.target.center)),Fr.ContainmentLoop(n,i)||(n.curve=Fr.GetEdgeLine(t)),mt.trimSplineAndCalculateArrowheadsII(n,n.sourcePort.Curve,n.targetPort.Curve,t.curve,!1)}static ContainmentLoop(t,i){let n=t.sourcePort.Curve,o=t.targetPort.Curve;if(n==null||o==null)return!1;let a=n.boundingBox,l=o.boundingBox,u=a.containsRect(l),c=!u&&l.containsRect(a);return u||c?(t.curve=Fr.CreateLoop(a,l,c,i),!0):!1}static CreateLoop(t,i,n,o){return n?Fr.CreateLoop_(t,i,o,!1):Fr.CreateLoop_(i,t,o,!0)}static CreateLoop_(t,i,n,o){let a=t.center,l=Fr.FindClosestPointOnBoxBoundary(t.center,i),u=l.sub(a),h=(Math.abs(u.x)<T.distanceEpsilon?Math.min(a.y-i.bottom,i.top-a.y):Math.min(a.x-i.left,i.right-a.x))/2,d=Math.min(n,h);u.length<=T.distanceEpsilon&&(u=new m(1,0));let f=u.normalize(),p=f.rotate(Math.PI/2),S=l.add(f.mul(n)),x=S.add(p.mul(d)),C=l.add(p.mul(d)),O=a.add(p.mul(d));return(o?nt.mkFromPoints([O,C,x,S,l,a]):nt.mkFromPoints([a,l,S,x,C,O])).createCurve()}static FindClosestPointOnBoxBoundary(t,i){let n=t.x-i.left<i.right-t.x?i.left:i.right,o=t.y-i.bottom<i.top-t.y?i.bottom:i.top;return Math.abs(n-t.x)<Math.abs(o-t.y)?new m(n,t.y):new m(t.x,o)}static GetEdgeLine(t){let i,n;t.sourcePort==null?(i=t.source.center,n=t.source.boundaryCurve):(i=t.sourcePort.Location,n=t.sourcePort.Curve);let o,a;t.targetPort==null?(o=t.target.center,a=t.target.boundaryCurve):(o=t.targetPort.Location,a=t.targetPort.Curve);let l=G.mkPP(i,o),u=R.getAllIntersections(n,l,!1);if(u.length>0){let c=l.trim(u[0].par1,1);c instanceof G&&(l=c,u=R.getAllIntersections(a,l,!1),u.length>0&&(c=l.trim(0,u[0].par1),c instanceof G&&(l=c)))}return l}static CreateSimpleEdgeCurveWithUnderlyingPolyline(t){let i=t.sourcePort?t.sourcePort.Location:t.source.center,n=t.targetPort?t.targetPort.Location:t.target.center;if(t.source===t.target){let o=2/(3*t.source.boundaryCurve.boundingBox.width),a=t.source.boundingBox.height/4;t.smoothedPolyline=Fr.CreateUnderlyingPolylineForSelfEdge(i,o,a),t.curve=t.smoothedPolyline.createCurve()}else t.smoothedPolyline=nt.mkFromPoints([i,n]),t.curve=t.smoothedPolyline.createCurve();mt.trimSplineAndCalculateArrowheadsII(t,t.source.boundaryCurve,t.target.boundaryCurve,t.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(t,i,n){let o=t.add(new m(0,n)),a=t.add(new m(i,n)),l=t.add(new m(i,n*-1)),u=t.add(new m(0,n*-1)),c=Xe.mkSiteP(t),h=new nt(c);return c=Xe.mkSiteSP(c,o),c=Xe.mkSiteSP(c,a),c=Xe.mkSiteSP(c,l),c=Xe.mkSiteSP(c,u),Xe.mkSiteSP(c,t),h}static SetStraightLineEdgesWithUnderlyingPolylines(t){ze.CreatePortsIfNeeded(Array.from(t.deepEdges));for(let i of t.deepEdges)Fr.CreateSimpleEdgeCurveWithUnderlyingPolyline(i)}};var pC=(n=>(n[n.OverlapsOtherLabels=0]="OverlapsOtherLabels",n[n.OverlapsNodes=1]="OverlapsNodes",n[n.OverlapsEdges=2]="OverlapsEdges",n[n.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",n))(pC||{});var v0=class{},C0=class{constructor(){this.points=new Vo;this.coveredLength=0}AddFirst(e){if(this.points.size!==0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!==0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var zm=class{constructor(e){this.location=e,this.boundingBox=q.rectangleOnPoint(e)}},ru=class{constructor(e,t){this.data=t,this.boundingBox=e}},A0=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},Qe=class extends Pe{constructor(t,i){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=Qe.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(i.length):Qe.MinGranularity,this.InitializeObstacles(t,i),this.edges=i}get CollisionGranularity(){return this.granularity}set CollisionGranularity(t){this.granularity=t}static constructorG(t){return new Qe(Array.from(t.nodesBreadthFirst),Array.from(t.deepEdges).filter(i=>i.label))}static constructorGA(t,i){return new Qe(Array.from(t.nodesBreadthFirst),i.filter(n=>n.label))}interpolateGranularity(t){if(t<=Qe.LowerEdgeBound)return Qe.MaxGranularity;if(t>=Qe.UpperEdgeBound)return Qe.MinGranularity;let i=(Qe.UpperEdgeBound-Qe.LowerEdgeBound)/(t-Qe.LowerEdgeBound);return Math.ceil(Qe.MinGranularity+i)}InitializeObstacles(t,i){let n=this.GetEdgeObstacles(i);this.obstacleMaps[1]=hs(t.map(o=>[o.boundingBox,new ru(o.boundingBox,o)])),this.obstacleMaps[2]=hs(n.map(o=>[o.boundingBox,new ru(o.boundingBox,o)]))}static CurvePoints(t,i){let n=[],o=t.end.sub(t.start).lengthSquared/(i*i);return Qe.SubdivideCurveSegment(n,t,o,t.parStart,t.parEnd),n.sort(Qe.compareByArgument),n}static compareByArgument(t,i){return t[0]<i[0]?-1:t[0]>i[0]?1:0}static SubdivideCurveSegment(t,i,n,o,a){if(t.length>64)return;let l=i.value(o),u=i.value(a);if(l.sub(u).lengthSquared>n){let c=(o+a)/2;Qe.SubdivideCurveSegment(t,i,n,o,c),Qe.SubdivideCurveSegment(t,i,n,c,a)}else t.push([o,l])}static PlaceLabelsAtDefaultPositions(t,i){for(let n of i)n.label&&new Qe([n.source,n.target],[n]).run()}GetEdgeObstacles(t){let i=[];for(let n of t){if(n.curve==null)continue;let o=Qe.CurvePoints(n.curve,this.CollisionGranularity);this.edgeInfos.set(n,new A0(o));for(let a of o)i.push(new zm(a[1]))}return i}AddLabelObstacle(t){this.labelObstacleMap==null?(this.labelObstacleMap=hs([[t.boundingBox,t]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(t.boundingBox,t)}run(){this.edges.sort((t,i)=>this.edgeInfos.get(t).edgePoints.length-this.edgeInfos.get(i).edgePoints.length);for(let t of this.edges)this.PlaceLabel(t)}PlaceLabel(t){let i=!1;for(let n of this.placementStrategy){switch(n){case 0:i=this.PlaceEdgeLabelOnCurve(t.label);break;case 1:i=this.PlaceEdgeLabelHorizontally(t);break;default:throw new Error("unexpected case")}if(i)break}i?this.CalculateCenterLabelInfoCenter(t.label):this.PlaceLabelAtFirstPosition(t.label)}getLabelInfo(t){let i=t.parent;return this.edgeInfos.get(i)}PlaceLabelAtFirstPosition(t){let i=t.parent,n=i.curve,o=this.edgeInfos.get(i).edgePoints,a=this.StartIndex(t,o.map(p=>p[1])),l=o[a][1],u=n.derivative(o[a][0]);u.length<T.distanceEpsilon&&(u=new m(1,1)),u=u.normalize();let c=new Dt(t.width,t.height),h=this.getLabelInfo(t),d=Qe.GetPossibleSides(h.placementSide,u)[0],f=Qe.GetLabelBounds(l,u,c,d);this.SetLabelBounds(this.getLabelInfo(t),f)}StartIndex(t,i){let n=this.getLabelInfo(t);return Math.min(i.length-1,Math.max(0,Math.floor(i.length*n.placementOffset)))}CalculateCenterLabelInfoCenter(t){let i=this.getLabelInfo(t),n=new m(0,0);for(let o of i.innerPoints)n=n.add(o);for(let o of i.outerPoints)n=n.add(o);t.positionCenter(n.div(i.innerPoints.length+i.outerPoints.length))}PlaceEdgeLabelHorizontally(t){let i=t.label,o=this.getLabelInfo(i).edgePoints,a=new Dt(i.width,i.height),l=-1,u=q.mkEmpty(),c=t.curve;for(let h of Qe.ExpandingSearch(this.StartIndex(i,o.map(d=>d[1])),0,o.length)){let d=o[h],f=c.derivative(d[0]);if(!le(f.lengthSquared,0)){f=f.normalize();for(let p of Qe.GetPossibleSides(this.getLabelInfo(i).placementSide,f)){let S=Qe.GetLabelBounds(d[1],f,a,p),x=this.ConflictIndexRL(S,i);if(x>l&&(l=x,u=S,l===Number.MAX_VALUE))break}if(l===Number.MAX_VALUE)break}}if(l>=0){this.SetLabelBounds(this.getLabelInfo(i),u);let h=new ru(u,null);this.AddLabelObstacle(h);let d=this.getLabelInfo(i);return l===0?d.placementResult=0:l===1?d.placementResult=1:l===2?d.placementResult=2:d.placementResult=pC.OverlapsNothing,!0}return!1}static GetLabelBounds(t,i,n,o){let a=i.rotate(Math.PI/2).mul(o),l=t.add(a),u=1,c=a.x>0?l.x:l.x-n.width,h=a.y>0?l.y:l.y-n.height;if(Math.abs(a.x)<.75){let d=Math.acos(Math.abs(a.y)/u),f=u/Math.sin(d),p=u/Math.cos(d);c+=(a.x>0?-1:1)*Math.min(f,n.width/2),h+=(a.y>0?1:-1)*p}else if(Math.abs(a.y)<.75){let d=Math.acos(Math.abs(a.x)/u),f=u/Math.sin(d),p=u/Math.cos(d);c+=(a.x>0?1:-1)*p,h+=(a.y>0?-1:1)*Math.min(f,n.height/2)}return q.mkLeftBottomSize(c,h,n)}SetLabelBounds(t,i){t.innerPoints=[i.leftTop,i.rightTop],t.outerPoints=[i.leftBottom,i.rightBottom]}static GetPossibleSides(t,i){switch(i.length===0&&(t=0),t){case 1:return[-1];case 2:return[1];case 3:return le(i.x,0)?Qe.GetPossibleSides(5,i):[1];case 4:return le(i.x,0)?Qe.GetPossibleSides(6,i):[i.x<0?-1:1];case 5:return le(i.y,0)?Qe.GetPossibleSides(3,i):[i.y<0?-1:1];case 6:return le(i.y,0)?Qe.GetPossibleSides(4,i):[i.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(t,i,n){let o=t+1,a=o;for(;a>i;)yield--a;for(;o<n;)yield o++}static PointSetLength(t){let i=0,n=null;for(let o of t)n!=null&&(i+=n.sub(o.Center).length),n=o.Center;return i}PlaceEdgeLabelOnCurve(t){let i=t.parent,n=this.getLabelInfo(t);n.innerPoints=null;let o=n.edgePoints,a=3,l=t.height/2,u=new Dt(l,l),c=t.width;for(let h of Qe.ExpandingSearch(this.StartIndex(t,o),0,o.length)){let d=this.GetSidesAndEdgeCurve(t,i,o,h);for(let f of d){let p=new C0,S={coveredLength:0};if(this.ProcessExpandingSearchOnSide(h,o,i.curve,f,l,a,u,S,p,c),S.coveredLength>=c)return this.CaseOfCoveredLengthGreaterThanLabelLength(t,p,S.coveredLength,c,u),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(t,i,n,o,a){let l=new Array,u=new Array,c=Array.from(i.points),h=n-o;if(h>0){let f=c[c.length-1],p=c[c.length-2],S=f.Center.sub(p.Center),x=S.length;h>x&&(f=c[0],p=c[1],S=f.Center.sub(p.Center),x=S.length);let C=S.mul((x-h)/x);f.Center=p.Center.add(C),f.Inner=p.Inner.add(C),f.Outer=p.Outer.add(C)}this.GoOverOrderedPointsAndAddLabelObstacels(c,l,u,a);let d=this.getLabelInfo(t);d.innerPoints=l,d.outerPoints=u}GoOverOrderedPointsAndAddLabelObstacels(t,i,n,o){for(let a of t){let l=a.Center;i.push(a.Inner),n.push(a.Outer);let u=new ru(q.mkSizeCenter(new Dt(o.width*2,o.height*2),l),null);this.AddLabelObstacle(u)}}ProcessExpandingSearchOnSide(t,i,n,o,a,l,u,c,h,d){for(let f of Qe.ExpandingSearch(t,0,i.length)){let[p,S]=i[f],x=n.derivative(p);if(le(x.lengthSquared,0))continue;let C=x.rotate(Math.PI/2).normalize().mul(o),O=S.add(C.mul(a+l));if(this.Conflict(O,a,u))break;{let B=new v0;if(B.Center=O,B.Inner=S.add(C.mul(l)),B.Outer=S.add(C.mul(2*a+l)),c.coveredLength=f<=t?h.AddFirst(B):h.AddLast(B),c.coveredLength>=d)break}}}GetSidesAndEdgeCurve(t,i,n,o){let a=i.curve.derivative(n[o][0]);return Qe.GetPossibleSides(this.getLabelInfo(t).placementSide,a)}Conflict(t,i,n){return this.ConflictIndex(t,i,n)!==Number.MAX_VALUE}ConflictIndexRL(t,i){let n=i.parent,o=n.source,a=n.target;for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null){for(let u of this.obstacleMaps[l].GetAllIntersecting(t))if(!(l===1&&u instanceof ru&&u.data instanceof me!=null&&(o.node.isDescendantOf(u.data.graph)||a.node.isDescendantOf(u.data))))return l}return Number.MAX_VALUE}ConflictIndex(t,i,n){let o=q.creatRectangleWithSize(new Dt(n.width*2,n.height*2),t),a=i*i;for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null){for(let u=0;u<this.obstacleMaps.length;u++)if(this.obstacleMaps[u]!=null)for(let c of this.obstacleMaps[u].GetAllIntersecting(o))if(c instanceof zm){if(t.sub(c.location).lengthSquared<a)return u}else return u;return Number.MAX_VALUE}}},An=Qe;An.MinGranularity=5,An.MaxGranularity=50,An.LowerEdgeBound=500,An.UpperEdgeBound=3e3;var Ji=class extends us{constructor(t,i=null){super(t,qe.AlgorithmDataIndex);this.data=i}clone(){throw new Error("Method not implemented.")}rebind(t){this.entity=t,this.bind(qe.AlgorithmDataIndex)}static getAlgData(t){return t.getAttr(qe.AlgorithmDataIndex)}};function Qd(s){let e=Ji.getAlgData(s.node);return e==null?null:e.data}var Wm=class{constructor(e,t){this.force=new m(0,0);this.stayWeight=1;this.index=e,this.geomNode=t,this.ResetBounds()}get Center(){return this.center}set Center(e){this.geomNode.center=e,this.center=e}ResetBounds(){this.previousCenter=this.geomNode.center,this.center=this.geomNode.center,this.Width=this.geomNode.width,this.Height=this.geomNode.height}ToString(){return"FINode("+(this.index+("):"+this.geomNode))}};var Hm=class{constructor(e){this._length=1;this.mEdge=e,this.sourceFiNode=Qd(this.mEdge.source),this.targetFiNode=Qd(this.mEdge.target)}get source(){return this.sourceFiNode.index}get target(){return this.targetFiNode.index}get length(){return this._length}set length(e){this._length=e}vector(){return this.sourceFiNode.geomNode.center.sub(this.targetFiNode.geomNode.center)}};var mC=Ae(kn(),1);var Tn=class{get Center(){return this.c}get Radius(){return this.r}Distance2(e){let t=this.c.y-e.y,i=this.c.x-e.x;return i*i+t*t}Contains(e){return this.Distance2(e)-1e-7<=this.r2}ContainsPN(e,t){for(let i=0;i<e.length;i++)if(t.findIndex(n=>n==i)==-1&&!this.Contains(e[i]))return!1;return!0}static constructorP(e){let t=new Tn;return t.c=e,t.r=0,t.r2=0,t}static midPoint(e,t){return new m((t.x+e.x)/2,(t.y+e.y)/2)}static constructorPP(e,t){let i=new Tn;return i.c=Tn.midPoint(e,t),i.r2=i.Distance2(e),i.r=Math.sqrt(i.r2),De.assert(i.OnBoundary(e)),De.assert(i.OnBoundary(t)),i}OnBoundary(e){let t=this.Distance2(e);return Math.abs(t-this.r2)/(t+this.r2)<1e-5}static centre(e,t,i){De.assert(t.x!=e.x),De.assert(i.x!=t.x);let n=(t.y-e.y)/(t.x-e.x),o=(i.y-t.y)/(i.x-t.x);De.assert(o!=n);let a,l=(n*o*(e.y-i.y)+o*(e.x+t.x)-n*(t.x+i.x))/(2*(o-n));return Math.abs(n)>Math.abs(o)?a=(e.y+t.y)/2-(l-(e.x+t.x)/2)/n:a=(t.y+i.y)/2-(l-(t.x+i.x)/2)/o,new m(l,a)}static Collinear(e,t,i){return e.x*(t.y-i.y)+(t.x*(i.y-e.y)+i.x*(e.y-t.y))==0}static constructorPPP(e,t,i){Tn.count++;let n=new Tn;if(Tn.Collinear(e,t,i)){let o=new m(Math.min(e.x,Math.min(t.x,i.x)),Math.min(e.y,Math.max(t.y,i.y))),a=new m(Math.max(e.x,Math.max(t.x,i.x)),Math.max(e.y,Math.max(t.y,i.y)));n.c=Tn.midPoint(o,a),n.r2=n.Distance2(a),n.r=Math.sqrt(n.r2)}else{let o=t.x-e.x,a=i.x-t.x,l=i.x-e.x;o!=0?a!=0?n.c=Tn.centre(e,t,i):(De.assert(l!=0),n.c=Tn.centre(t,e,i)):(De.assert(a!=0),n.c=Tn.centre(t,i,e)),n.r2=n.Distance2(e),n.r=Math.sqrt(n.r2),De.assert(n.OnBoundary(e)),De.assert(n.OnBoundary(t)),De.assert(n.OnBoundary(i))}return n}},Qn=Tn;Qn.count=0;var T0=class{constructor(e,t){switch(this.boundary=t,De.assert(t.length<=3),t.length){case 0:this.disc=null;break;case 1:this.disc=Qn.constructorP(e[t[0]]);break;case 2:this.disc=Qn.constructorPP(e[t[0]],e[t[1]]);break;case 3:this.disc=Qn.constructorPPP(e[t[0]],e[t[1]],e[t[2]]);break}}contains(e){return this.disc==null?!1:this.disc.Contains(e)}},I0=class{constructor(e){this.ps=e,this.L=new Vo;for(let i=0;i<this.ps.length;i++)this.L.push(i);let t=this.mtf_md(null,new Array);this.disc=t.disc,this.boundary=t.boundary}collinear3(e){return e.length==3?Qn.Collinear(this.ps[e[0]],this.ps[e[1]],this.ps[e[2]]):!1}mtf_md(e,t){De.assert(t.length<=3);let i=new T0(this.ps,t);if(t.length==3)return i;let n=this.L.first;for(;n!=null&&n!=e;){let o=n.next,a=n.value;if(!i.contains(this.ps[a])){let l=Array.from(t);l.push(a),De.assert(!this.collinear3(l),"Collinear points on boundary of minimal enclosing disc"),i=this.mtf_md(n,l),this.L.deleteNode(n),this.L.insertNodeBefore(null,n)}n=o}return i}},jm=class{static LinearComputation(e){return new I0(e).disc}static SlowComputation(e){let t=e.length,i=null,n=null;for(let o=0;o<t;o++)for(let a=0;a<t;a++){if(o!=a){let l=Qn.constructorPP(e[o],e[a]);l.ContainsPN(e,[o,a])&&(i==null||i.Radius>l.Radius)&&(i=l,n=[o,a])}for(let l=0;l<t;l++)if(l!=o&&l!=a&&!Qn.Collinear(e[o],e[a],e[l])){let u=Qn.constructorPPP(e[o],e[a],e[l]);u.ContainsPN(e,[o,a,l])&&(i==null||i.Radius>u.Radius)&&(i=u,n=[o,a,l])}}return De.assert(n!=null),i}};var ii=class{static constructorNPA(e,t,i){let n=new ii;n.p=e,n.z0=new Pt(t.x,t.y),n.a=new Array(e);for(let o=0;o<e;o++)n.a[o]=n.compute(o,i);return n}static constructorPMM(e,t,i){let n=new ii;De.assert(t.p==i.p),n.p=t.p,n.z0=new Pt(e.x,e.y);let o=i.shift(n.z0),a=t.shift(n.z0);n.a=new Array(n.p);for(let l=0;l<n.p;l++)n.a[l]=w0(a[l],o[l]);return n}static factorial(e){let t=1;for(let i=2;i<=e;i++)t*=i;return t}static binomial(e,t){return ii.factorial(e)/(ii.factorial(t)*ii.factorial(e-t))}sum(e,t){let i=Pt.constructorN(0);for(let n=1;n<=e;n++){let o=Pt.constructorN(ii.binomial(e-1,n-1));i=w0(i,Ga(this.a[n],Ga(Pt.Pow(t,e-n),o)))}return i}shift(e){let t=new Array(this.p),i=t[0]=this.a[0],n=Jd(this.z0,e);for(let o=1;o<this.p;o++){let a=Pt.constructorN(o);t[o]=w0(Ga(O2(i),L0(Pt.Pow(n,o),a)),this.sum(o,n))}return t}compute(e,t){let i=t.length,n=Pt.constructorN(0);if(e==0)n.re=i;else{for(let o=0;o<i;o++){let a=t[o],l=new Pt(a.x,a.y);n=Jd(n,Pt.Pow(Jd(l,this.z0),e))}n.divideBy(e)}return n}ApproximateForce(e){let t=new Pt(e.x,e.y),i=Jd(t,this.z0),n=L0(this.a[0],i),o=i,a=0;for(;n=Jd(n,L0(R2(this.a[a],a),o)),a++,a!=this.p;)o=Ga(o,i);return new m(n.re,-n.im)}static Force(e,t){let i=t.sub(e),n=i.lengthSquared;return n<.1?n!=0?i.div(.1):new m(1,0):i.div(n)}},Pt=class{constructor(e,t){this.re=e,this.im=t}static constructorN(e){return new Pt(e,0)}divideBy(e){this.re/=e,this.im/=e}static Pow(e,t){switch(De.assert(t>=0),t){case 0:return Pt.constructorN(1);case 1:return e;case 2:return Ga(e,e);case 3:return Ga(e,Ga(e,e));default:return Ga(Pt.Pow(e,t/2),Pt.Pow(e,t/2+t%2))}}};function w0(s,e){return new Pt(s.re+e.re,s.im+e.im)}function Ga(s,e){return new Pt(s.re*e.re-s.im*e.im,s.re*e.im+e.re*s.im)}function R2(s,e){return new Pt(s.re*e,s.im*e)}function Jd(s,e){return new Pt(s.re-e.re,s.im-e.im)}function O2(s){return new Pt(-s.re,-s.im)}function L0(s,e){let t=e.re*e.re+e.im*e.im;if(t==0)return Pt.constructorN(0);let i=s.re*e.re+s.im*e.im,n=s.im*e.re-s.re*e.im;return new Pt(i/t,n/t)}var qm=class{intersects(e){return e.med.Center.sub(this.med.Center).length<e.med.Radius+this.med.Radius}},R0=class extends qm{constructor(t,i,n){super();this.med=t,this.parent=i.parent,this.parent!=null&&(this.parent.leftChild==i?this.parent.leftChild=this:this.parent.rightChild=this),this.leftChild=i,this.rightChild=n,i.parent=this,n.parent=this}computeMultipoleCoefficients(t){this.leftChild.computeMultipoleCoefficients(t),this.rightChild.computeMultipoleCoefficients(t),this.multipoleCoefficients=ii.constructorPMM(this.med.Center,this.leftChild.multipoleCoefficients,this.rightChild.multipoleCoefficients)}},Hc=class extends qm{constructor(t){super();this.particles=t,this.ComputeMinimumEnclosingDisc()}computeMultipoleCoefficients(t){this.multipoleCoefficients=ii.constructorNPA(t,this.med.Center,this.ps)}ComputeMinimumEnclosingDisc(){let t=this.Size();this.ps=new Array(t);for(let i=0;i<t;i++)this.ps[i]=this.particles[0][i].point;return this.med=jm.LinearComputation(this.ps)}Min(t){return this.particles[t][0].pos(t)}Size(){return this.particles[0].length}Max(t){return this.particles[t][this.Size()-1].pos(t)}Dimension(t){return this.Max(t)-this.Min(t)}Split(t){let i=this.Dimension(0)>this.Dimension(1)?0:1,n=i==0?1:0,o=this.Size(),a=o>>1,l=o-a,u=[new Array(a),new Array(a)],c=[new Array(l),new Array(l)],h=0,d=0;for(let p=0;p<o;p++){let S=this.particles[i][p];p<a?(u[i][p]=S,S.splitLeft=!0):(c[i][p-a]=S,S.splitLeft=!1)}for(let p=0;p<o;p++){let S=this.particles[n][p];S.splitLeft?u[n][d++]=S:c[n][h++]=S}let f=this.med;return this.particles=u,this.ComputeMinimumEnclosingDisc(),t.rightSibling=new Hc(c),new R0(f,this,t.rightSibling)}ComputeForces(){for(let t of this.particles[0])for(let i of this.particles[0])t!=i&&(t.force=t.force.add(ii.Force(t.point,i.point)))}},Xm=class{pos(e){return e==0?this.point.x:this.point.y}constructor(e){this.point=e,this.force=new m(0,0)}},Ym=class{particlesBy(e){return this.particles.map(t=>t).sort((t,i)=>t.pos(e)-i.pos(e))}constructor(e,t){this.particles=e;let i=new Array;i.push(this.particlesBy(0)),i.push(this.particlesBy(1)),this.leaves=new Array;let n=new Hc(i);this.leaves.push(n);let o={rightSibling:null};this.root=n.Split(o),this.leaves.push(o.rightSibling);let a=new O0(t);for(a.EnqueueLL(n,o.rightSibling);a.length>0;)n=a.dequeue(),n.Split(o),this.leaves.push(o.rightSibling),a.EnqueueLL(n,o.rightSibling)}ComputeForces(e){this.root.computeMultipoleCoefficients(e);for(let t of this.leaves){t.ComputeForces();let i=new Array;for(i.push(this.root);i.length>0;){let n=i.pop();if(t.intersects(n))if(n instanceof Hc)for(let o of t.particles[0])for(let a of n.particles[0])o!=a&&(o.force=o.force.add(ii.Force(o.point,a.point)));else{let o=n;i.push(o.leftChild),i.push(o.rightChild)}else for(let o of t.particles[0])o.force=o.force.sub(n.multipoleCoefficients.ApproximateForce(o.point))}}}},O0=class extends mC.Queue{constructor(t){super();this.B=t}EnqueueLL(t,i){t.Size()>this.B&&this.enqueue(t),i.Size()>this.B&&this.enqueue(i)}};var ws=class extends Pe{constructor(t,i,n){super(null);this.clustersInfo=new Map;this.clusterEdges=new Array;if(this.graph=t,this.settings=i,this.initFiNodesEdges(),this.edges=Array.from(this.graph.shallowEdges).map(o=>Ji.getAlgData(o.edge).data),this.nodes=Array.from(this.graph.shallowNodes).map(o=>Ji.getAlgData(o.node).data),this.components=new Array,this.settings.InterComponentForces)this.components.push(this.nodes);else{this.basicGraph=yr(this.edges,this.nodes.length);for(let o of Xn(this.basicGraph)){let a=new Array(o.length),l=0;for(let u of o)a[l++]=this.nodes[u];this.components.push(a)}}this.computeWeight(t),this.setCurrentConstraintLevel(n)}initFiNodesEdges(){let t=0;for(let i of this.graph.shallowNodes){let n=new Wm(t++,i);new Ji(i.node,n)}for(let i of this.graph.shallowEdges){let n=new Hm(i);new Ji(i.edge,n)}}getCurrentConstraintLevel(){return this.currentConstraintLevel}setCurrentConstraintLevel(t){this.currentConstraintLevel=t,this.settings.Unconverge()}ResetNodePositions(){for(let t of this.nodes)t.ResetBounds()}AddRepulsiveForce(t,i){t.force=i.mul(10*this.settings.RepulsiveForceConstant)}AddLogSpringForces(t,i,n){let o=i.length,a=7e-4*this.settings.AttractiveForceConstant*o*Math.log((o+.1)/(n+.1));t.sourceFiNode.force=t.sourceFiNode.force.add(i.mul(a)),t.targetFiNode.force=t.targetFiNode.force.sub(i.mul(a))}AddSquaredSpringForces(t,i,n){let o=i.length,a=n*n+.1,l=this.settings.AttractiveForceConstant*(o-n)/a;t.sourceFiNode.force=t.sourceFiNode.force.add(i.mul(l)),t.targetFiNode.force=t.targetFiNode.force.sub(i.mul(l))}AddSpringForces(t){let i;if(this.settings.RespectEdgePorts){let n=t.sourceFiNode.Center,o=t.targetFiNode.Center,a=t.mEdge.sourcePort;a instanceof Pr&&(n=a.Location);let l=t.mEdge.targetPort;l instanceof Pr&&(o=l.Location),i=n.sub(o)}else i=t.vector();this.settings.LogScaleEdgeForces?this.AddLogSpringForces(t,i,t.length):this.AddSquaredSpringForces(t,i,t.length)}static AddGravityForce(t,i,n){n!=null&&(n.force=n.force.sub(t.sub(n.Center).mul(i*1e-4)))}ComputeRepulsiveForces(t){let i=t.length;if(i>16&&this.settings.ApproximateRepulsion){let n=new Array(t.length),o=2*(Math.PI/i),a=0;for(let u=0;u<i;u++)n[u]=new Xm(t[u].Center.add(new m(Math.cos(a),Math.sin(a)).mul(1e-5))),a+=o;new Ym(n,8).ComputeForces(5);for(let u=0;u<t.length;u++)this.AddRepulsiveForce(t[u],n[u].force)}else for(let n of t){let o=new m(0,0);for(let a of t)n!=a&&(o=o.add(ii.Force(n.Center,a.Center)));this.AddRepulsiveForce(n,o)}}SetBarycenter(t){let i=this.clustersInfo.get(t);if(i!=null)return i.barycenter;let n=new m(0,0);if(t.shallowNodeCount||_2(t)){let o=this.clustersInfo.get(t);if((o==null||o.weight==null)&&this.computeWeight(t),o.weight!=null){for(let a of t.shallowNodes)a instanceof ot?n=n.add(a.center):n=n.add(this.SetBarycenter(a).mul(this.clustersInfo.get(a).weight));this.clustersInfo.get(t).barycenter=n=n.div(o.weight)}}else this.clustersInfo.get(t).barycenter=n;return n}computeWeight(t){let i=0;for(let o of t.shallowNodes)o.entity instanceof Ce?i+=this.computeWeight(o):i++;let n=this.clustersInfo.get(t);return n==null&&this.clustersInfo.set(t,n={barycenter:new m(0,0)}),n.weight=i,i}AddClusterForces(t){if(t!=null){this.SetBarycenter(t);for(let i of this.clusterEdges){let n=xe.getGeom(i.source),o=xe.getGeom(i.target),a=Ji.getAlgData(i.source).data,l=Ji.getAlgData(i.target).data,u=n.hasOwnProperty("shallowNodes"),c=u?this.clustersInfo.get(n).barycenter:n.center,h=o.hasOwnProperty("shallowNodes"),d=h?this.clustersInfo.get(o).barycenter:o.center,f=c.sub(d),p=f.length,S=1e-8*(this.settings.AttractiveInterClusterForceConstant*(p*Math.log(p+.1)));if(f=f.mul(S),u){let x=n;for(let C of x.shallowNodes){let O=Ji.getAlgData(C.node).data;O.force=O.force.add(f)}}else a.force=a.force.add(f);if(h){let x=o;for(let C of x.shallowNodes){let O=Ji.getAlgData(C.node).data;O.force=O.force.sub(f)}}else l.force=l.force.sub(f)}for(let i of t.subgraphsDepthFirst){let n=this.clustersInfo.get(i).barycenter;for(let o of i.shallowNodes)ws.AddGravityForce(n,this.settings.ClusterGravity,Qd(o))}}}ComputeForces(){if(this.components!=null)for(let t of this.components)this.ComputeRepulsiveForces(t);else this.ComputeRepulsiveForces(this.nodes);this.edges.forEach(t=>this.AddSpringForces(t));for(let t of this.components){let i=new m(0,0);for(let o=0;o<t.length;o++)i=i.add(t[o].Center);i=i.div(t.length);let n=Number.NEGATIVE_INFINITY;for(let o=0;o<t.length;o++){let a=t[o];ws.AddGravityForce(i,this.settings.GravityConstant,a),a.force.length>n&&(n=a.force.length)}if(n>100)for(let o=0;o<t.length;o++)t[o].force=t[o].force.mul(100/n)}this.AddClusterForces(this.graph)}VerletIntegration(){let t=this.energy;this.energy=this.ComputeDescentDirection(1),this.UpdateStepSize(t);let i=0;for(let n=0;n<this.nodes.length;n++){let o=this.nodes[n];i+=o.Center.sub(o.previousCenter).lengthSquared}return i}ComputeDescentDirection(t){this.ResetForceVectors(),this.settings.ApplyForces&&this.ComputeForces();let i=0;for(let n of this.nodes){i=i+n.force.lengthSquared;let o=n.Center.sub(n.previousCenter).mul(this.settings.Friction),a=n.force.mul(-this.stepSize*t);n.previousCenter=n.Center,De.assert(!Number.isNaN(a.x),"!double.IsNaN(a.X)"),De.assert(!Number.isNaN(a.y),"!double.IsNaN(a.Y)"),De.assert(Number.isFinite(a.x),"!double.IsInfinity(a.X)"),De.assert(Number.isFinite(a.y),"!double.IsInfinity(a.Y)"),o=o.add(a),o=o.div(n.stayWeight),n.Center=n.Center.add(o)}return i}ResetForceVectors(){for(let t of this.nodes)t.force=new m(0,0)}UpdateStepSize(t){this.energy<t?++this.progress>=3&&(this.progress=0,this.stepSize/=this.settings.Decay):(this.progress=0,this.stepSize*=this.settings.Decay)}RungeKuttaIntegration(){let t=new Array(this.nodes.length),i=new Array(this.nodes.length),n=new Array(this.nodes.length),o=new Array(this.nodes.length),a=new Array(this.nodes.length),l=this.energy;for(let c=0;c<this.nodes.length;c++)this.nodes[c].previousCenter=this.nodes[c].Center,t[c]=this.nodes[c].Center;let u=3;this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)i[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].Center=t[c].add(i[c].mul(.5));this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)n[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c],this.nodes[c].Center=t[c].add(n[c].mul(.5));this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)o[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c],this.nodes[c].Center=t[c].add(o[c]);this.energy=this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++){a[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c];let h=i[c].add(n[c].mul(2).add(o[c].mul(2)).add(a[c])).div(6);this.nodes[c].Center=t[c].add(h)}return this.UpdateStepSize(l),this.nodes.reduce((c,h)=>h.Center.sub(h.previousCenter).lengthSquared+c,0)}run(){this.settings.Converged=!1,this.settings.EdgeRoutesUpToDate=!1,this.settings.Iterations++==0&&(this.stepSize=this.settings.InitialStepSize,this.energy=Number.MAX_VALUE,this.progress=0);for(let t=0;t<this.settings.MinorIterations;t++){if((this.settings.RungeKuttaIntegration?this.RungeKuttaIntegration():this.VerletIntegration())<this.settings.DisplacementThreshold||this.settings.Iterations>this.settings.MaxIterations){this.settings.Converged=!0;break}this.ProgressStep()}}};function _2(s){for(let e of s.Clusters)return!0;return!1}var Tr=class{constructor(){this.commonSettings=new Zn;this.maxIterations=100;this.clusterMargin=10;this.minorIterations=3;this.projectionIterations=5;this.approximateRepulsion=!0;this.RungeKuttaIntegration=!1;this.initialStepSize=1.4;this.decay=.9;this.friction=.8;this.repulsiveForceConstant=1;this.attractiveForceConstant=1;this.gravity=1;this.interComponentForces=!0;this.applyForces=!0;this.AvoidOverlaps=!0;this.approximateRouting=!0;this.logScaleEdgeForces=!0;this.displacementThreshold=.1;this.maxConstraintLevel=2;this.minConstraintLevel=0;this.attractiveInterClusterForceConstant=1;this.clusterGravity=1;this.commonSettings.NodeSeparation*=2}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get PackingAspectRatio(){return this.commonSettings.PackingAspectRatio}set PackingAspectRatio(e){this.commonSettings.PackingAspectRatio=e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get MaxIterations(){return this.maxIterations}set MaxIterations(e){this.maxIterations=e}get MinorIterations(){return this.minorIterations}set MinorIterations(e){this.minorIterations=e}get Iterations(){return this.iterations}set Iterations(e){this.iterations=e}get ProjectionIterations(){return this.projectionIterations}set ProjectionIterations(e){this.projectionIterations=e}get ApproximateRepulsion(){return this.approximateRepulsion}set ApproximateRepulsion(e){this.approximateRepulsion=e}get InitialStepSize(){return this.initialStepSize}set InitialStepSize(e){if(e<=0||e>2)throw new Error("ForceScalar should be greater than 0 and less than 2 (if we let you set it to 0 nothing would happen, greater than 2 would most likely be very unstable!)");this.initialStepSize=e}get Decay(){return this.decay}set Decay(e){if(e<.1||e>1)throw new Error("Setting decay too small gives no progress.  1==no decay, 0.1==minimum allowed value");this.decay=e}get Friction(){return this.friction}set Friction(e){if(e<0||e>1)throw new Error("Setting friction less than 0 or greater than 1 would just be strange.  1==no friction, 0==no conservation of velocity");this.friction=e}get RepulsiveForceConstant(){return this.repulsiveForceConstant}set RepulsiveForceConstant(e){this.repulsiveForceConstant=e}get AttractiveForceConstant(){return this.attractiveForceConstant}set AttractiveForceConstant(e){this.attractiveForceConstant=e}get GravityConstant(){return this.gravity}set GravityConstant(e){this.gravity=e}get InterComponentForces(){return this.interComponentForces}set InterComponentForces(e){this.interComponentForces=e}get ApplyForces(){return this.applyForces}set ApplyForces(e){this.applyForces=e}ResetLayout(){this.Unconverge(),this.algorithm!=null&&this.algorithm.ResetNodePositions()}Unconverge(){this.iterations=0,this.converged=!1}InitializeLayoutGN(e,t){this.InitializeLayout(e,t)}InitializeLayout(e,t){this.algorithm=new ws(e,this,t),this.ResetLayout()}Uninitialize(){this.algorithm=null}get IsInitialized(){return this.algorithm!=null}IncrementalRunG(e){this.IncrementalRunGF(e)}SetupIncrementalRun(e){this.IsInitialized?this.IsDone&&this.ResetLayout():this.InitializeLayout(e,this.MaxConstraintLevel)}IncrementalRunGF(e){this.SetupIncrementalRun(e),this.algorithm.run()}IncrementalRun(e,t){e!=null&&e.throwIfCanceled(),this.SetupIncrementalRun(t),this.algorithm.cancelToken=e,this.algorithm.run()}Clone(){return Tr.ctorClone(this)}get ApproximateRouting(){return this.approximateRouting}set ApproximateRouting(e){this.approximateRouting=e}get LogScaleEdgeForces(){return this.logScaleEdgeForces}set LogScaleEdgeForces(e){this.logScaleEdgeForces=e}get DisplacementThreshold(){return this.displacementThreshold}set DisplacementThreshold(e){this.displacementThreshold=e}get Converged(){return this.converged}set Converged(e){this.converged=e}get PercentDone(){return this.Converged?100:100*this.iterations/this.MaxIterations}get IsDone(){return this.Converged||this.iterations>=this.MaxIterations}get Energy(){return this.algorithm!=null?this.algorithm.energy:0}get MaxConstraintLevel(){return this.maxConstraintLevel}set MaxConstraintLevel(e){this.maxConstraintLevel!=e&&(this.maxConstraintLevel=e,this.IsInitialized&&this.Uninitialize())}get MinConstraintLevel(){return this.minConstraintLevel}set MinConstraintLevel(e){this.minConstraintLevel=e}getCurrentConstraintLevel(){return this.algorithm==null?0:this.algorithm.getCurrentConstraintLevel()}setCurrentConstraintLevel(e){this.algorithm.setCurrentConstraintLevel(e)}get AttractiveInterClusterForceConstant(){return this.attractiveInterClusterForceConstant}set AttractiveInterClusterForceConstant(e){this.attractiveInterClusterForceConstant=e}static ctorClone(e){let t=new Tr;return t.maxIterations=e.maxIterations,t.minorIterations=e.minorIterations,t.projectionIterations=e.projectionIterations,t.approximateRepulsion=e.approximateRepulsion,t.initialStepSize=e.initialStepSize,t.RungeKuttaIntegration=e.RungeKuttaIntegration,t.decay=e.decay,t.friction=e.friction,t.repulsiveForceConstant=e.repulsiveForceConstant,t.attractiveForceConstant=e.attractiveForceConstant,t.gravity=e.gravity,t.interComponentForces=e.interComponentForces,t.applyForces=e.applyForces,t.AvoidOverlaps=e.AvoidOverlaps,t.RespectEdgePorts=e.RespectEdgePorts,t.RouteEdges=e.RouteEdges,t.approximateRouting=e.approximateRouting,t.logScaleEdgeForces=e.logScaleEdgeForces,t.displacementThreshold=e.displacementThreshold,t.minConstraintLevel=e.minConstraintLevel,t.maxConstraintLevel=e.maxConstraintLevel,t.attractiveInterClusterForceConstant=e.attractiveInterClusterForceConstant,t.clusterGravity=e.clusterGravity,t.PackingAspectRatio=e.PackingAspectRatio,t.NodeSeparation=e.NodeSeparation,t.clusterMargin=e.clusterMargin,t}get ClusterGravity(){return this.clusterGravity}set ClusterGravity(e){this.clusterGravity=e}static CreateFastIncrementalLayoutSettings(){let e=new Tr;return e.ApplyForces=!1,e.ApproximateRepulsion=!0,e.ApproximateRouting=!0,e.AttractiveForceConstant=1,e.AttractiveInterClusterForceConstant=1,e.AvoidOverlaps=!0,e.ClusterGravity=1,e.Decay=.9,e.DisplacementThreshold=5e-8,e.Friction=.8,e.GravityConstant=1,e.InitialStepSize=2,e.InterComponentForces=!1,e.Iterations=0,e.LogScaleEdgeForces=!1,e.MaxConstraintLevel=2,e.MaxIterations=20,e.MinConstraintLevel=0,e.MinorIterations=1,e.ProjectionIterations=5,e.RepulsiveForceConstant=2,e.RespectEdgePorts=!1,e.RouteEdges=!1,e.RungeKuttaIntegration=!0,e.NodeSeparation=20,e}};var Km=class{constructor(e){this.topNodes=e}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let e of this.topNodes)if(yield ot.getGeom(e),e instanceof Ce)for(let t of e.nodesBreadthFirst)yield ot.getGeom(t)}get Clusters(){return this.clusters()}*clusters(){for(let e of this.topNodes)e instanceof Ce&&(yield me.getGeom(e))}get subgraphsDepthFirst(){return this.subgraphsDepthFirst_()}*subgraphsDepthFirst_(){for(let e of this.topNodes)if(e instanceof Ce){let t=me.getGeom(e);yield*t.subgraphsDepthFirst,yield t}}get shallowEdges(){return this.edges_()}*edges_(){for(let e of this.topNodes){for(let t of e.outEdges)yield We.getGeom(t);for(let t of e.selfEdges)yield We.getGeom(t)}}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.topNodes)yield ot.getGeom(e)}pumpTheBoxToTheGraphWithMargins(){let e={b:q.mkEmpty()};return Dp(this,e),this.boundingBox=e.b}get shallowNodeCount(){return this.topNodes.length}translate(e){this.boundingBox&&(this.boundingBox.center=this.boundingBox.center.add(e));for(let t of this.topNodes)ot.getGeom(t).translate(e)}};var $d=class{static LinearInterpolation(e,t,i,n,o){if(e<t)return n;if(e>i)return o;let a=(e-t)/(i-t);return n+a*(o-n)}static NegativeLinearInterpolation(e,t,i,n,o){if(e<t)return o;if(e>i)return n;let a=(e-t)/(i-t);return n+(1-a)*(o-n)}};var Zm=class extends Pe{constructor(t,i){super(null);this.SingleComponent=!1;this.graph=t,this.settings=Tr.ctorClone(i),this.settings.ApplyForces=!0,this.settings.InterComponentForces=!0,this.settings.RungeKuttaIntegration=!1,this.settings.RespectEdgePorts=!1}run(){if(this.SingleComponent)this.componentCount=1,this.LayoutComponent(this.graph);else{let t=Array.from(this.graph.graph.getClusteredConnectedComponents()).map(i=>new Km(i));this.componentCount=t.length;for(let i of t)this.LayoutComponent(i);this.graph.boundingBox=Is.PackGraphs(t,this.settings.commonSettings)}}LayoutComponent(t){if(t.shallowNodeCount>1){if(this.settings.MaxIterations=$d.NegativeLinearInterpolation(t.shallowNodeCount,50,500,5,10),this.settings.MinorIterations=$d.NegativeLinearInterpolation(t.shallowNodeCount,50,500,3,20),this.settings.MinConstraintLevel==0){let n=new Bi;n.removeOverlaps=!1,n.IterationsWithMajorization=0,new Wc(t,null,()=>1,new Bi).run()}let i=new ws(t,this.settings,this.settings.MinConstraintLevel);for(let n of this.GetConstraintLevels(t)){if(n>this.settings.MaxConstraintLevel)break;n>this.settings.MinConstraintLevel&&i.setCurrentConstraintLevel(n);do i.run();while(!this.settings.IsDone)}this.settings.AvoidOverlaps&&ri.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation)}t.pumpTheBoxToTheGraphWithMargins(),t.uniformMargins=this.settings.NodeSeparation,t.translate(t.boundingBox.leftBottom.mul(-1))}GetConstraintLevels(t){let i=new Set;return i.add(0),this.settings.AvoidOverlaps&&t.shallowNodeCount<2e3&&i.add(2),i}};function bC(s){s.layoutSettings||(s.layoutSettings=PC(s))}function N2(s){let e=s.parent;for(;e;){if(e.layoutSettings)return e.layoutSettings;e=e.parent}return null}function PC(s){let e=N2(s);if(e)return e;if(s.graph.shallowNodeCount>2e3||s.graph.deepEdgesCount>4e3)return new Tr;let i=!1;for(let n of s.deepEdges)if(n.sourceArrowhead!=null||n.targetArrowhead!=null){i=!0;break}return i?new Rt:new Tr}function M2(s,e){if(bC(s),s.layoutSettings instanceof Rt)new qc(s,s.layoutSettings,e).run();else if(s.layoutSettings instanceof Bi)new Wc(s,e,()=>1,s.layoutSettings).run();else if(s.layoutSettings instanceof Tr){let t=new Zm(s,s.layoutSettings);t.SingleComponent=!0,t.run()}else throw new Error("not implemented")}function ef(s,e=null){bC(s),Zd(s,e,M2,Fa,Bp)}function x0(s){do{if(s.layoutSettings&&s.layoutSettings.commonSettings.edgeRoutingSettings)return s.layoutSettings.commonSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=xe.getGeom(t);else break}while(!0);let e=new jo;return e.EdgeRoutingMode=0,e}function Fa(s,e,t){let i=x0(s);i.EdgeRoutingMode===4?yC(s,e,t):i.EdgeRoutingMode===0||i.EdgeRoutingMode===1?sC(s,e,t):i.EdgeRoutingMode===2?Um(s,e,t):i.EdgeRoutingMode!==6&&new ze(s,e).run(),SC(s,e)}function Zd(s,e,t,i,n,o=1){if(s.graph.isEmpty())return;s.parent==null&&(wc(o),F2(s));let a=d();h(s);let l=B2(s.graph),u=D2(s);if(f(),l.forEach(p=>{p[0].edge.remove(),p[1].add()}),u.forEach(p=>{for(let S of p.graph.shallowNodes)S.parent=s.graph}),a.forEach(p=>p.add()),s.graph.parent==null){let p=c(s);i(s,p,e),SC(s,p),s.pumpTheBoxToTheGraphWithMargins()}function c(p){let S=[];for(let x of p.nodesBreadthFirst){for(let C of x.outEdges())C.curve==null&&S.push(C);for(let C of x.selfEdges())C.curve==null&&S.push(C)}return S}function h(p){for(let S of p.shallowNodes)S instanceof me&&Zd(S,e,t,i,n)}function d(){let p=new Set,S=s.graph;if(S.parent==null)return p;for(let x of S.shallowNodes){for(let C of x.outEdges){let O=S.liftNode(C.target);(O==null||O===x)&&p.add(C)}for(let C of x.inEdges){let O=S.liftNode(C.source);(O==null||O===x)&&p.add(C)}}for(let x of p)x.remove();return p}function f(){if(u.length===1)t(s,e);else{for(let p of u)t(p,e),p.boundingBox=p.pumpTheBoxToTheGraphWithMargins();n(s,u)}}}function B2(s){let e=new Array;for(let t of s.nodesBreadthFirst){let i=s.liftNode(t);if(i!=null)for(let n of t.outEdges.values()){let o=n.target,a=s.liftNode(o);if(a==null||i===t&&a===o||i===a)continue;n.remove();let l=new br(i,a),u=new We(l);e.push([u,n])}}return e}function D2(s){var o;let e=s.graph,t=sv(e),i=[],n=0;for(let a of t){let l=new Ce(e.id+n++);l.parent=e;let u=new me(l);u.layoutSettings=(o=s.layoutSettings)!=null?o:PC(s);for(let c of a)c.parent=l,l.addNode(c);i.push(u)}return i}function yC(s,e,t,i=1,n=3){Ma.constructorGNAN(s,e,i,n).run()}function SC(s,e){if(e.length===0)return;An.constructorGA(s,e).run()}function F2(s){for(let e of s.deepEdges)e.label&&(e.label.isPositioned=!1)}function jc(s){if(me.getGeom(s)==null)return!1;for(let e of s.shallowNodes){let t=xe.getGeom(e);if(t==null||t.boundaryCurve==null||e instanceof Ce&&jc(e)===!1)return!1}for(let e of s.edges)if(We.getGeom(e)==null)return!1;return!0}var G2=Ae(kn(),1);var Qm=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(Qm||{});var Jm=(n=>(n[n.forward=0]="forward",n[n.back=1]="back",n[n.both=2]="both",n[n.none=3]="none",n))(Jm||{});var $m=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))($m||{});var yt=class extends wt{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get defaultNodeObject(){return this._defaultNodeObject}set defaultNodeObject(t){this._defaultNodeObject=t}static getDrawingGraph(t){return ke.getDrawingObj(t)}get graph(){return this.entity}findNode(t){let n=this.graph.findNode(t);return n==null?null:ke.getDrawingObj(n)}hasDirectedEdge(){for(let t of this.graph.deepEdges)if(ke.getDrawingObj(t).directed)return!0;return!1}createGeometry(t=i=>i?new Dt(i.length*8+8,20):null){let i=new me(this.graph);this.textMeasure=t;let n={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};i.labelSize=t(this.labelText,n);for(let o of this.graph.nodesBreadthFirst)this.createNodeGeometry(o);for(let o of this.graph.deepEdges)this.createEdgeGeometry(o);if(this.rankdir){let o=i.layoutSettings=new Rt;o.layerDirection=this.rankdir}return i}createEdgeGeometry(t){let i=qi.getDrawingObj(t),n=new We(t);if(i.arrowhead!=6?n.targetArrowhead=new mt:n.targetArrowhead=null,i.arrowtail!=6?n.sourceArrowhead=new mt:n.sourceArrowhead=null,i.labelText){let o=this.textMeasure(i.labelText,{fontSize:i.fontsize,fontFamily:i.fontname,fontStyle:"normal"}),a=t.label=new ds(t);new Ii(a,q.mkPP(new m(0,0),new m(o.width,o.height))),i.measuredTextSize=o}i.penwidth&&(n.lineWidth=i.penwidth)}curveByShape(t,i,n,o){let a;switch(o.shape){case 0:a=_e.mkDiamond(t,i,n);break;case 1:a=_e.mkEllipse(t/1.6,i/1.6,n);break;case 4:case 2:a=_e.mkRectangleWithRoundedCorners(t,i,o.XRadius,o.YRadius,n);break;case 3:a=_e.mkCircle(Math.sqrt(t*t+i*i),n);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=_e.mkCircle(Math.sqrt(t*t+i*i)+2*o.penwidth,n);break;case 11:a=_e.createHouse(t,i,n);break;case 12:a=_e.createInvertedHouse(t,i,n);break;case 13:a=_e.createParallelogram(t,i,n);break;case 14:a=_e.createOctagon(t,i,n);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=_e.createHexagon(t,i,n);break}return a!=null?a:_e.mkRectangleWithRoundedCorners(t,i,o.XRadius,o.YRadius,n)}createNodeGeometry(t,i=new m(0,0)){if(t instanceof Ce){let n=ke.getDrawingObj(t),o=new me(t);n.labelText&&(o.labelSize=n.measuredTextSize=_0(n,this.textMeasure))}else{let n=wt.getDrawingObj(t),o=new Dt(1,1);n.labelText&&(o=_0(n,this.textMeasure)),n.measuredTextSize=o;let a=new ot(t),l=o.width+n.LabelMargin*2,u=o.height+n.LabelMargin*2;a.boundaryCurve=this.curveByShape(l,u,i,n)}}measureLabelSizes(t){var i;for(let n of this.graph.nodesBreadthFirst){let o=wt.getDrawingObj(n);o.measuredTextSize=(i=_0(o,t))!=null?i:new Dt(1,1)}}};function _0(s,e){return s.labelText?e(s.labelText,{fontSize:s.fontsize,fontFamily:s.fontname,fontStyle:"normal"}):null}var qo=class extends nr{constructor(t,i){super();this.SetEdges(t,i)}};var eb=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new Xr(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let i=new ye(t.source,t.target),n=new ye(t.target,t.source),o=this.Multiedges.get(i.x,i.y);for(let a of o)a.reverse();if(this.Multiedges.has(n.x,n.y)){let a=this.Multiedges.get(n.x,n.y);for(let l of o)a.push(l)}else this.Multiedges.set(n.x,n.y,o);this.Multiedges.delete(i.x,i.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new ye(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function tf(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var Di=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length===0&&t++;if(t===0)return this;let i=new Array(this.y.length);for(let a=0;a<i.length;a++)i[a]=this.y[a]-e[this.y[a]];let n=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(n[a-e[a]]=Array.from(this.layers[a]));let o=new Di(i);return o.layers=n,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)tf(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let i of e)this.verticesToX[i]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let i=0;i<this.y.length;i++)e[i]=t-this.y[i];return new Di(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let i of this.y)i+1>e&&(e=i+1);let t=new Array(e).fill(0);for(let i of this.y)t[i]++;this.layers=new Array(e);for(let i=0;i<e;i++)this.layers[i]=new Array(t[i]),t[i]=0;for(let i=0;i<this.y.length;i++){let n=this.y[i];this.layers[n][t[n]++]=i}}};var Xc=class extends Pe{constructor(t,i,n,o){super(o);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=n,this.dag=t,this.layering=i,this.Init()}static Balance(t,i,n,o){new Xc(t,i,n,o).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(t){this.jumpers.delete(t);let i=this.possibleJumperFeasibleIntervals.get(t),n=this.CalcJumpInfo(i.x,i.y,t);if(n==null)return;this.layering[t]=n.layerToJumpTo;let o=this.nodeCount[t];this.vertsCounts[n.jumperLayer]-=o,this.vertsCounts[n.layerToJumpTo]+=o,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(n.jumperLayer,t)}IsJumper(t){return this.possibleJumperFeasibleIntervals.has(t)}UpdateRegionsForPossibleJumpersAndInsertJumpers(t,i){let n=new Set;for(let a of this.dag.pred(i))this.IsJumper(a)&&(this.CalculateRegionAndInsertJumper(a),n.add(a));for(let a of this.dag.succ(i))this.IsJumper(a)&&(this.CalculateRegionAndInsertJumper(a),n.add(a));let o=new Array;for(let a of this.possibleJumperFeasibleIntervals)n.has(a[0])||a[1].x>t&&a[1].y<t&&o.push(a[0]);for(let a of o)this.CalculateRegionAndInsertJumper(a)}InitJumpers(){let t=new Array(this.dag.nodeCount).fill(0);for(let i of this.dag.edges)t[i.source]-=i.weight,t[i.target]+=i.weight;this.possibleJumperFeasibleIntervals=new Map;for(let i=0;i<this.dag.nodeCount;i++)t[i]===0&&this.CalculateRegionAndInsertJumper(i)}CalculateRegionAndInsertJumper(t){let i=new ye(this.Up(t),this.Down(t));this.possibleJumperFeasibleIntervals.set(t,i),this.InsertJumper(i.x,i.y,t)}InsertJumper(t,i,n){this.CalcJumpInfo(t,i,n)!=null&&this.jumpers.add(n)}CalcJumpInfo(t,i,n){let o=this.layering[n],a=-1,l=this.vertsCounts[o]-2*this.nodeCount[n];for(let u=t-1;u>o;u--)this.vertsCounts[u]<l&&(l=this.vertsCounts[u],a=u);for(let u=o-1;u>i;u--)this.vertsCounts[u]<l&&(l=this.vertsCounts[u],a=u);if(a!==-1)return{jumperLayer:o,layerToJumpTo:a}}Up(t){let i=Number.MAX_SAFE_INTEGER;for(let n of this.dag.inEdges[t]){let o=this.layering[n.source]-n.separation+1;o<i&&(i=o)}return i===Number.MAX_SAFE_INTEGER&&(i=this.layering[t]+1),i}Down(t){let i=Number.NEGATIVE_INFINITY;for(let n of this.dag.outEdges[t]){let o=this.layering[n.target]+n.separation-1;o>i&&(i=o)}return i===Number.NEGATIVE_INFINITY&&(i=this.layering[t]-1),i}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let t of this.layering)this.vertsCounts[t]+=this.nodeCount[t]}ChooseJumper(){for(let t of this.jumpers)return t;throw new Error("there are no jumpers to choose")}};var In=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i of t.LayerEdges){let n=Math.max(i.Source,i.Target)+1;n>this.totalNumberOfNodes&&(this.totalNumberOfNodes=n)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i=1;i<t.LayerEdges.length;i++){let n=t.LayerEdges[i];this.firstVirtualNode=Math.min(this.firstVirtualNode,n.Source)}this.firstVirtualNode===Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let i of t.LayerEdges)i.Target!==t.target&&(this.virtualNodesToInEdges[i.Target-this.firstVirtualNode]=i),i.Source!==t.source&&(this.virtualNodesToOutEdges[i.Source-this.firstVirtualNode]=i)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield In.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield In.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new In(new qo(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var Ls=class{constructor(e,t,i,n){this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}static InsertLayers(e,t,i,n){let o=new Ls(e,t,i,n);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let i=0,n=t[0];if(i=n.LayerSpan*2,i>0){for(let o of n.LayerEdges)o.Target!==n.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(i-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let i=this.la.x[t],n=this.la.y[t],o=this.la.Layers[n];o[i]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges[n];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let i=this.NLayering[t];i%2===1&&(this.Nla.Layers[i][e[i]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!==e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!==e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,i=!0;for(let n of e)if(i&&(i=!1,t=n.LayerSpan*2),t>0){n.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=Jn.GetSource(a,n,o);this.totalNodes=a.currentVV;let u=Jn.GetTarget(this.totalNodes,n,o,t);n.LayerEdges[o]=new Mi(l,u,n.CrossingWeight)}Ls.RegisterDontStepOnVertex(this.database,n)}}this.nLayeredGraph=new In(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new Oo,i=this.Nla.Layers[e];for(let o of i){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let n=0;for(let o of t.values())if(typeof o=="number")i[n++]=o;else for(let a of o)i[n++]=a;for(let o=0;o<i.length;o++)this.Nla.x[i[o]]=o}}InitNewLayering(){this.Nla=new Di(new Array(this.totalNodes));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i]*2;for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=this.la.y[i.x]*2;for(let a of n){let l=o-1;for(let u of a.LayerEdges)u.Target!==a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Di(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let i=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(i.Source)}}};var Jn=class{constructor(e,t,i,n){this.virtNodesToIntEdges=new Map;this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}get NLayering(){return this.Nla.y}static InsertPaths(e,t,i,n){let o=new Jn(e,t,i,n);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(n);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}EdgeIsFlat(e){return this.la.y[e.source]===this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let i of t.LayerEdges)i.Target!==t.target&&this.virtNodesToIntEdges.set(i.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!==t.y){let n=!0,o=0;for(let a of i){if(n)n=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o===1)a.LayerEdges[0]=new Mi(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=Jn.GetSource(u,a,l);e=u.currentVV;let h=Jn.GetTarget(e,a,l,o);a.LayerEdges[l]=new Mi(c,h,a.CrossingWeight)}Ls.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new In(this.intGraph)}static GetTarget(e,t,i,n){return i<n-1?e:t.target}static GetSource(e,t,i){return i===0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new Di(new Array(this.NLayeredGraph.NodeCount));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i];for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=0,a=!0;for(let l of n){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Di(this.NLayering),this.Nla.Layers=e}};var Va=class{constructor(e,t,i){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=i}LayerGroupDisbalance(e,t,i){return t===1?this.LayerGroupDisbalanceWithOrigSeparators(e,i):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentOrigGroupDelta(n,e,t);n=o.i,i+=o.ret}return i}CurrentOrigGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentVirtGroupDelta(n,e,t);i+=o.ret,n=o.i}return i}CurrentVirtGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings===0}};var xC=Ae(mn(),1);var tb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Source]-this.x[t.Source];return i!==0?i:this.x[e.Target]-this.x[t.Target]}};var rb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Target]-this.x[t.Target];return i!==0?i:this.x[e.Source]-this.x[t.Source]}};function ib(){return Sa(2)===0}function z2(s,e,t){let i=t.Layers[s+1],n=t.Layers[s];return n.length<=i.length?H2(n,e,t):W2(i,n,e,t)}function W2(s,e,t,i){let n=vC(e,t),o=new rb(i.x);n.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of n){let h=a+i.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!==0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function H2(s,e,t){let i=vC(s,e),n=new tb(t.x);i.sort((u,c)=>n.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of i){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!==0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function vC(s,e){return Io(s,t=>e.InEdges(t))}function EC(s,e){let t=0;for(let i=0;i<e.Layers.length-1;i++)t+=z2(i,s,e);return t}var Rs=class extends Pe{constructor(t,i,n,o,a,l,u){super(u);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=u,this.tryReverse=i,this.startOfVirtNodes=o,this.layerArrays=n,this.layering=n.y,this.nOfLayers=n.Layers.length,this.layers=n.Layers,this.properLayeredGraph=t,this.hasCrossWeights=a,this.SugSettings=l}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return Sa(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(t,i,n,o,a){let l=!1;for(let c of t.Edges)if(c.CrossingWeight!==1){l=!0;break}new Rs(t,!0,i,n,l,o,a).run()}run(){if(this.Calculate(),this.tryReverse){let t=this.layerArrays.ReversedClone(),i=new Rs(this.properLayeredGraph.ReversedClone(),!1,t,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(i.run(),Va.less(i.measure,this.measure)){for(let n=0;n<this.nOfLayers;n++)tf(t.Layers[n],this.layerArrays.Layers[this.nOfLayers-1-n]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=Rs.CloneLayers(this.layers,this.layerArraysCopy);let t=0;this.measure=new Va(this.layerArraysCopy,EC(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let i=0;i<this.MaxOfIterations&&t<this.NoGainStepsBound&&!this.measure.IsPerfect();i++){let n=i%2===0;this.LayerByLayerSweep(n),this.AdjacentExchange();let o=new Va(this.layerArrays.Layers,EC(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);Va.less(this.measure,o)?(this.Restore(),t++):(Va.less(o,this.measure)||ib())&&(t=0,this.layerArraysCopy=Rs.CloneLayers(this.layers,this.layerArraysCopy),this.measure=o)}}static CloneLayers(t,i){if(i==null){i=new Array(t.length);for(let n=0;n<t.length;n++)i[n]=t[n].map(o=>o)}else for(let n=0;n<t.length;n++)tf(t[n],i[n]);return i}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(t){if(t)for(let i=1;i<this.nOfLayers;i++)this.SweepLayer(i,!0);else for(let i=this.nOfLayers-2;i>=0;i--)this.SweepLayer(i,!1)}SweepLayer(t,i){let n=this.layers[t],o=new Array(n.length);for(let l=0;l<o.length;l++)o[l]=this.WMedian(n[l],i);this.Sort(t,o);let a=this.layerArrays.Layers[t];for(let l=0;l<a.length;l++)this.layerArrays.x[a[l]]=l}Sort(t,i){let n=new Oo,o=this.layers[t],a=0;for(let u of i){let c=o[a++];if(u!==-1)if(!n.has(u))n.set(u,c);else{let h=n.get(u);if(typeof h!="number"){let d=h;if(ib())d.push(c);else{let f=Sa(d.length),p=d[f];d[f]=c,d.push(p)}}else{let d=h,f=new Array;n.set(u,f),ib()?(f.push(d),f.push(c)):(f.push(c),f.push(d))}}}let l=n.values();for(a=0;a<o.length;)if(i[a]!==-1){let u=l.next().value;if(typeof u=="number")o[a++]=u;else{let c=u;for(let h of c){for(;i[a]===-1;)a++;o[a++]=h}}}else a++}WMedian(t,i){let n,o;if(i?(n=this.properLayeredGraph.OutEdges(t),o=this.properLayeredGraph.OutEdgesCount(t)):(n=this.properLayeredGraph.InEdges(t),o=this.properLayeredGraph.InEdgesCount(t)),o===0)return-1;let a=new Array(o),l=0;if(i)for(let d of n)a[l++]=this.X[d.Target];else for(let d of n)a[l++]=this.X[d.Source];a.sort((d,f)=>d-f);let u=Math.floor(o/2);if(o%2===1)return a[u];if(o===2)return .5*(a[0]+a[1]);let c=a[u-1]-a[0],h=a[o-1]-a[u];return Math.floor((a[u-1]*c+a[u]*h)/(c+h))}Init(){let t=new Array(this.nOfLayers).fill(0),i=new xC.Stack;for(let o=0;o<this.properLayeredGraph.NodeCount;o++)this.properLayeredGraph.InEdgesCount(o)===0&&i.push(o);let n=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;i.size>0;){let o=i.pop(),a=this.layerArrays.y[o];this.layerArrays.Layers[a][t[a]]=o,this.layerArrays.x[o]=t[a],t[a]++;for(let l of this.properLayeredGraph.Succ(o))n[l]||(n[l]=!0,i.push(l))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let t=0,i=!0;for(;i&&t++<this.MaxNumberOfAdjacentExchanges;){i=!1;for(let n=0;n<this.layers.length;n++)i=this.AdjExchangeLayer(n)||i;for(let n=this.layers.length-2;n>=0;n--)i=this.AdjExchangeLayer(n)||i}}AllocArrays(){let t=this.properLayeredGraph.NodeCount;this.predecessors=new Array(t),this.successors=new Array(t),this.pOrder=new Array(t),this.sOrder=new Array(t),this.hasCrossWeights&&(this.outCrossingCount=new Array(t),this.inCrossingCount=new Array(t));for(let i=0;i<t;i++){let n=this.properLayeredGraph.InEdgesCount(i);if(this.predecessors[i]=new Array(n),this.hasCrossWeights){let o=this.inCrossingCount[i]=new Map;for(let a of this.properLayeredGraph.InEdges(i))o.set(a.Source,a.CrossingWeight)}if(this.pOrder[i]=new Map,n=this.properLayeredGraph.OutEdgesCount(i),this.successors[i]=new Array(n),this.sOrder[i]=new Map,this.hasCrossWeights){let o=this.outCrossingCount[i]=new Map;for(let a of this.properLayeredGraph.OutEdges(i))o.set(a.Target,a.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let t=0;t<this.properLayeredGraph.NodeCount;t++)this.pOrder[t]=new Map,this.sOrder[t]=new Map;for(let t of this.layers)this.InitPsArraysForLayer(t)}CalcPair(t,i){let n=this.successors[t],o=this.successors[i],a=this.predecessors[t],l=this.predecessors[i];if(this.hasCrossWeights){let u=this.outCrossingCount[t],c=this.outCrossingCount[i],h=this.inCrossingCount[t],d=this.inCrossingCount[i];return{cuv:this.CountOnArraysUV(n,o,u,c)+this.CountOnArraysUV(a,l,h,d),cvu:this.CountOnArraysUV(o,n,c,u)+this.CountOnArraysUV(l,a,d,h)}}else return{cuv:this.CountOnArrays(n,o)+this.CountOnArrays(a,l),cvu:this.CountOnArrays(o,n)+this.CountOnArrays(l,a)}}InitPsArraysForLayer(t){for(let i of t){for(let n of this.properLayeredGraph.Pred(i)){let o=this.sOrder[n],a=o.size;this.successors[n][a]=i,o.set(i,a)}for(let n of this.properLayeredGraph.Succ(i)){let o=this.pOrder[n],a=o.size;this.predecessors[n][a]=i,o.set(i,a)}}}CountOnArrays(t,i){let n=0,o=i.length-1,a=-1,l=0;for(let u of t){let c=this.X[u];for(;a<o&&this.X[i[a+1]]<c;a++)l++;n+=l}return n}CountOnArraysUV(t,i,n,o){let a=0,l=i.length-1,u=-1,c=0;for(let h of t){let d=this.X[h],f;for(;u<l&&this.X[f=i[u+1]]<d;u++)c+=o.get(f);a+=c*n.get(h)}return a}AdjExchangeLayer(t){let i=this.layers[t];return this.ExchangeWithGainWithNoDisturbance(i)?!0:(this.DisturbLayer(i),this.ExchangeWithGainWithNoDisturbance(i))}Swap(t,i){let n=this.X[t],o=this.X[i],a=this.layering[t],l=this.layers[a];l[n]=i,l[o]=t,this.X[t]=o,this.X[i]=n,this.UpdateSsContainingUv(t,i),this.UpdatePsContainingUv(t,i)}UpdatePsContainingUv(t,i){if(this.successors[t].length<=this.successors[i].length)for(let n of this.successors[t]){let o=this.pOrder[n];if(o.has(i)){let a=o.get(i),l=this.predecessors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}else for(let n of this.successors[i]){let o=this.pOrder[n];if(o.has(t)){let a=o.get(i),l=this.predecessors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}}UpdateSsContainingUv(t,i){if(this.predecessors[t].length<=this.predecessors[i].length)for(let n of this.predecessors[t]){let o=this.sOrder[n];if(o.has(i)){let a=o.get(i),l=this.successors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}else for(let n of this.predecessors[i]){let o=this.sOrder[n];if(o.has(t)){let a=o.get(i),l=this.successors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}}DisturbLayer(t){for(let i=0;i<t.length-1;i++)this.AdjacentSwapToTheRight(t,i)}ExchangeWithGainWithNoDisturbance(t){let i=!1,n;do n=this.ExchangeWithGain(t),i=i||n;while(n);return i}ExchangeWithGain(t){for(let i=0;i<t.length-1;i++)if(this.SwapWithGain(t[i],t[i+1]))return this.SwapToTheLeft(t,i),this.SwapToTheRight(t,i+1),!0;return!1}SwapToTheLeft(t,i){for(let n=i-1;n>=0;n--)this.AdjacentSwapToTheRight(t,n)}SwapToTheRight(t,i){for(let n=i;n<t.length-1;n++)this.AdjacentSwapToTheRight(t,n)}AdjacentSwapToTheRight(t,i){let n=t[i],o=t[i+1],a=this.SwapGain(n,o);(a>0||a===0&&ib())&&this.Swap(n,o)}SwapGain(t,i){let n=this.CalcPair(t,i);return n.cuv-n.cvu}UvAreOfSameKind(t,i){return t<this.startOfVirtNodes&&i<this.startOfVirtNodes||t>=this.startOfVirtNodes&&i>=this.startOfVirtNodes}NeighborsForbidTheSwap(t,i){return this.UpperNeighborsForbidTheSwap(t,i)||this.LowerNeighborsForbidTheSwap(t,i)}LowerNeighborsForbidTheSwap(t,i){let n,o;return(n=this.properLayeredGraph.OutEdgesCount(t))===0||(o=this.properLayeredGraph.OutEdgesCount(i))===0?!1:this.X[this.successors[t][n>>1]]<this.X[this.successors[i][o>>1]]}UpperNeighborsForbidTheSwap(t,i){let n=this.properLayeredGraph.InEdgesCount(t),o=this.properLayeredGraph.InEdgesCount(i);return n===0||o===0?!1:this.X[this.predecessors[t][n>>1]]<this.X[this.predecessors[i][o>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(t,i,n){let o=this.GetKindDelegate(n),a=0;for(let u=i-1;u>=0&&!o(t[u]);u--)a++;let l=0;for(let u=i+1;u<t.length&&!o(t[u]);u++)l++;return a-l}IsOriginal(t){return t<this.startOfVirtNodes}IsVirtual(t){return t>=this.startOfVirtNodes}GetKindDelegate(t){return this.IsVirtual(t)?this.IsVirtual:this.IsOriginal}SwapWithGain(t,i){return this.SwapGain(t,i)>0?(this.Swap(t,i),!0):!1}};var iu=class{constructor(e,t,i){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=i}static UpdateLayerArrays0(e,t,i){new iu(e,t,i).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let i=iu.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,i)}static BuildInitialNodePositions(e,t){let i=new Map;for(let n=0;n<t.Layers.length;n++){let o=0,a=0;for(;o<t.Layers[n].length;){for(;o<t.Layers[n].length&&e.IsVirtualNode(t.Layers[n][o]);)o++;for(let l=a;l<o;l++)i.set(t.Layers[n][l],new m(n,a));o<t.Layers[n].length&&i.set(t.Layers[n][o],new m(n,o)),o++,a=o}}return i}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new bt;for(let t of this.layerArrays.Layers)for(let i of t){let n=this.nodePositions.get(i);e.hasxy(n.x,n.y)||e.setxy(n.x,n.y,[]),e.getxy(n.x,n.y).push(i)}return e}BuildOrdering(e){let t=new bt,i=new Map;for(let n of this.layerArrays.Layers)for(let o of n){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),i),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let i=0;i<e.length;i++)t.set(e[i],i)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,i)=>{let n=this.firstSucc(t),o=this.firstSucc(i),a=this.firstPred(t),l=this.firstPred(i),u=this.nodePositions.get(n),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(n)){if(!h.equal(d))return h.compareTo(d);let f=e.get(n),p=e.get(o);return Re(f,p)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?Re(t,i):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let i=0,n=0;for(;i<t.length;){for(;i<t.length&&this.nodePositions.get(t[n]).equal(this.nodePositions.get(t[i]));)i++;let o=e.get(this.nodePositions.get(t[n]));for(let a=n;a<i;a++)t[a]=o[a-n];n=i}}this.layerArrays.UpdateXFromLayers()}};var AC=Ae(or(),1);var CC=Ae(mn(),1);var ka=class{static getOrder(e,t){let i=yr(t.map(([n,o])=>new ye(n,o)),e);return ka.getOrderOnGraph(i)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),i=new CC.Stack,n=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,i.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(n.push(l),i.length>0){let c=i.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return n.reverse()}};var nb=class{GetLayers(){let e=ka.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),i=this.graph.nodeCount;for(;i-- >0;){let n=e[i];for(let o of this.graph.inEdges[n]){let a=o.source,l=t[n]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(j2(t,e))return!1;return!0}constructor(e){this.graph=e}};function j2(s,e){let t=e.findIndex(n=>n===s.source),i=e.findIndex(n=>n===s.target);return t===-1||i===-1||t>=i}var N0=class{constructor(e){this.inTree=!1;this.cut=N0.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},Ei=N0;Ei.infinity=Number.MAX_SAFE_INTEGER;var Ua=Ae(mn(),1);function q2(s){let e=new Array;for(let t of s.edges)e.push(new Ei(t));return yr(e,s.nodeCount)}var rf=class{constructor(e,t,i,n,o){this.v=e,this.outEnum=t,this.i=i,this.inEnum=n,this.j=o}},Yc=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=q2(e),this.networkCancelToken=t;for(let i=0;i<this.graph.nodeCount;i++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let i of this.treeVertices)this.layers[i]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let i=t.source,n=t.target;return this.lim(i)>this.lim(n)?this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?0:1:this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut===Ei.infinity&&t!==this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new Ua.Stack;for(let i of this.leaves)e.push(i);let t=new Ua.Stack;for(;e.length>0;){for(;e.length>0;){let n=e.pop(),o=this.parent(n);if(o==null)continue;let a=0;for(let u of this.incidentEdges(n))if(u.inTree===!1){let c=this.edgeSourceTargetVal(u,o);c!==0&&(a+=c*u.weight)}else if(u===o)a+=u.weight;else{let c=o.source===u.target||o.target===u.source?1:-1;a+=this.edgeContribution(u,n)*c}o.cut=a;let l=o.source===n?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let i=e;e=t,t=i}}edgeContribution(e,t){let i=e.cut-e.weight;for(let n of this.incidentEdges(t))if(n.inTree===!1){let o=this.edgeSourceTargetVal(n,e);o===-1?i+=n.weight:o===1&&(i-=n.weight)}return i}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let i=new Ua.Stack,n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(i.push(new rf(t,n,o,a,l)),this.vertices[t].low=e;i.length>0;){let u=i.pop();t=u.v,n=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<n.length;){let h=n[o];!h.inTree||this.vertices[h.target].low>0||(i.push(new rf(t,n,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){i.push(new rf(t,n,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)===this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,i=this.vertices[e].lim;this.leaves=[];for(let n=0;n<this.nodeCount;n++)t<=this.vertices[n].lim&&this.vertices[n].lim<=i?this.setLow(n,0):this.low(n)===this.lim(n)&&this.leaves.push(n);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=Ei.infinity;for(let i of this.treeVertices){for(let n of this.graph.outEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}for(let n of this.graph.inEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new Ua.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let i of this.graph.outEdges[t])this.vertexInTree(i.target)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.target),this.addVertexToTree(i.target),this.treeVertices.push(i.target),i.inTree=!0);for(let i of this.graph.inEdges[t])this.vertexInTree(i.source)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.source),this.addVertexToTree(i.source),this.treeVertices.push(i.source),i.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,i=0;for(let a of this.graph.edges)a.inTree&&a.cut<i&&(i=a.cut,e=a);if(e==null)return null;let n=!1,o=Ei.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree===!1&&this.edgeSourceTargetVal(a,e)===-1&&(l<o||l===o&&(n=Sa(2)===1))){if(o=l,t=a,o===0&&!n)break;n=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let i=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,i),this.updateLimLowLeavesAndParentsUnderNode(i),this.updateCuts(e),this.updateLayersUnderNode(i)}updateLayersUnderNode(e){let t=new Ua.Stack;t.push(e);for(let i=0;i<this.nodeCount;i++)this.low(e)<=this.lim(i)&&this.lim(i)<=this.lim(e)&&i!==e&&(this.layers[i]=Ei.infinity);for(;t.length>0;){let i=t.pop();for(let n of this.graph.outEdges[i])n.inTree&&this.layers[n.target]===Ei.infinity&&(this.layers[n.target]=this.layers[i]-n.separation,t.push(n.target));for(let n of this.graph.inEdges[i])n.inTree&&this.layers[n.source]===Ei.infinity&&(this.layers[n.source]=this.layers[i]+n.separation,t.push(n.source))}}updateCuts(e){let t=new Ua.Stack,i=new Ua.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!==Ei.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree===!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c===a)l+=c.weight;else{let h=a.source===c.target||a.target===c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source===o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&i.push(u)}let n=t;t=i,i=n}}createPathForCutUpdates(e,t,i){let n=t.target;for(;n!==i;){let o=this.parent(n);o.cut=Ei.infinity,n=o.source===n?o.target:o.source}t.cut=Ei.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,i;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),i=this.lim(e.target)):(t=this.lim(e.target),i=this.lim(e.source));let n=e.source;for(;!(this.low(n)<=t&&i<=this.lim(n));){let o=this.parent(n);o.cut=Ei.infinity,n=o.source===n?o.target:o.source}return n}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let i of this.graph.edges)t+=this.edgeSourceTargetVal(i,e)*i.weight;e.cut!==t&&console.log(AC.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new nb(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length===0&&this.graph.nodeCount===0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var ob=class{GetLayers(){return new Yc(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let i of e){let n=i[0],o=i[1];for(let a of this.graph.outEdges[n]){let l=new Dr(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new qo(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var ni=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new m(this.left,this.top)}get leftBottom(){return new m(this.left,this.bottom)}get rightBottom(){return new m(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new m(this.right,this.top)}static mkAnchor(e,t,i,n,o,a){let l=new ni(a);return l.la=e,l.ra=t,l.ta=i,l.ba=n,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new m(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=ni.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t===0?e:ni.curveIsConvex(e)?ni.padConvexCurve(e,t):ni.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,i,n,o){let a=ni.getPaddedCorner(t,i,n,o);e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b)}static padConvexCurve(e,t){let i=new ie;ni.padCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t),ni.padCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t);for(let n=e.startPoint;n.next.next!=null;n=n.next)ni.padCorner(i,n,n.next,n.next.next,t);return i.closed=!0,i}static getPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point,u=m.getTriangleOrientation(o,a,l)===1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<T.intersectionEpsilon)return{a:a.add(h.mul(n)),b:null,numberOfPoints:1};let f=d.normalize().mul(n),p=f.rotate(Math.PI/2),S=(n-f.dot(h))/p.dot(h);return{a:f.add(p.mul(S)).add(a),b:f.sub(p.mul(S)).add(a),numberOfPoints:2}}static*orientations(e){yield m.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield m.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield m.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let i of ni.orientations(e))if(i!==2){if(t===2)t=i;else if(i!==t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():R.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new ie;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ie.mkClosedFromPoints([new m(e,this.top),this.rightTop,this.rightBottom,new m(e,this.bottom),new m(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ie.mkClosedFromPoints([new m(e,this.top),new m(this.right,this.y),new m(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var Kc=class{constructor(e,t,i,n,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=i,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new Ar,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=n,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,i,n,o){new Kc(e,t,i,n,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.InEdges(e))i[t++]=o.Source;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.upperMedians[e]=new ye(i[n-1],i[n]):this.upperMedians[e]=i[n]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.OutEdges(e))i[t++]=o.Target;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.lowMedians[e]=new ye(i[n-1],i[n]):this.lowMedians[e]=i[n]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),i=new Array(4),n=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,i[a]=l.b;let u=i[a]-t[a];u<n&&(e=a,n=u)}for(let a=0;a<4;a++){let l;if(Kc.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=i[e]-i[a],this.x=this.xCoords[a],l!==0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e===0||e===2}AssignmentBounds(e,t){if(this.nOfVertices===0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let i=1;i<this.nOfVertices;i++){let n=this.x[i];n<t.a?t.a=n:n>t.b&&(t.b=n)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let n=t;this.LR?(yield n.x,yield n.y):(yield n.y,yield n.x)}else{let n=t;n>=0&&(yield n)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,i=this.UpperOf(0,this.h-1),n=this.NextLower(i);for(;this.IsBelow(e,i);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,n)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],i=null,n=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(n,o)&&i==null;n=this.NextRight(n))i=this.InnerEdgeByTarget(t[n]);if(i!=null){let a=this.Pos(this.Source(i));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,n);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(i));for(;this.IsNotRightFrom(n,o);){let u=this.AlignmentToTheRightOfInner(t,n,a);if(n=this.NextRight(n),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,i,u,l,c),i=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(i)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(i)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,i,n,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(i)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,n)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,i){if(this.NumberOfInEdges(e[t])===1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(i,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let n=0;n<this.nOfVertices;n++)if(n===this.root[n]){let o=n;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Dr(n,this.root[a.neighbor],null)),o=this.align[o]}while(o!==n)}let t=yr(e,this.nOfVertices),i=ka.getOrderOnGraph(t);for(let n of i)if(n===this.root[n]){let o=0,a=!0,l=n;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!==n);this.x[n]=o}for(let n of i)if(n===this.root[n]&&t.inEdges[n].length===0){let o=n,a=this.RightMost(-Kc.infinity,Kc.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!==n);l!==a&&(this.x[n]=a)}for(let n=0;n<this.nOfVertices;n++)n!==this.root[n]&&(this.x[n]=this.x[this.root[n]])}TryToGetRightNeighbor(e,t){let i=this.NextRight(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}TryToGetLeftNeighbor(e,t){let i=this.NextLeft(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let i=this.la.Layers[t],n=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,i.length-1);for(let a=this.LeftMost(0,i.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=i[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(n,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],n=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let i;if(this.Pos(e)>this.Pos(t)){let n=e;e=t,t=n,i=-1}else i=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*i}},nf=Kc;nf.infinity=1e7;var sb=class extends nr{constructor(t,i,n,o,a){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(o,a),this.virtualVerticesStart=t.nodeCount,this.virtualVerticesEnd=i.NodeCount-1,this.layeredGraph=i,this.layerArrays=n}EdgeWeightMultiplier(t){let i=t.source,n=t.target;if(i<this.layeredGraph.NodeCount&&this.layerArrays.y[i]===this.layerArrays.y[n]&&this.layerArrays.x[i]===this.layerArrays.x[n]+1)return 0;let o=0,a=-1,l=-1;for(let c of this.outEdges[i])l===-1?l=c.target:a=c.target;return l>=this.virtualVerticesStart&&l<=this.virtualVerticesEnd&&o++,a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&o++,o===0?this.weightMultiplierOfOriginalOriginal:o===1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let t of this.edges)t.weight=t.weight*this.EdgeWeightMultiplier(t)}};var Os=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new Os(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length===0)return null;if(e.length===1)return e[0];let t=e[0].parallelogram,i=1,n=Ie.parallelogramOfTwo(t,e[i].parallelogram).area;for(let h=2;h<e.length;h++){let d=Ie.parallelogramOfTwo(t,e[h].parallelogram).area;d>n&&(i=h,n=d)}let o;for(let h=0;h<e.length;h++)if(h!==i){o=h;break}n=Ie.parallelogramOfTwo(e[i].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h===i)continue;let d=Ie.parallelogramOfTwo(e[i].parallelogram,e[h].parallelogram).area;d>n&&(o=h,n=d)}let a=new Array,l=new Array;a.push(e[i]),l.push(e[o]);let u=e[i].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h===i||h===o)continue;let d=Ie.parallelogramOfTwo(u,e[h].parallelogram),f=d.area-u.area,p=Ie.parallelogramOfTwo(c,e[h].parallelogram),S=p.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=p):f<S?(a.push(e[h]),u=d):(l.push(e[h]),c=p)}return{parallelogram:Ie.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var oi=class{constructor(e,t,i,n,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=i,this.bottomSite=i.next,this.currentTopSite=i,this.currentBottomSite=i.next,this.layerArrays=n,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,i,n,o,a,l,u){new oi(e,t,i,o,a,l,n,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,i){if(e.equal(t))return t;let n=m.ClosestPointAtLineSegment(t,e,i),o=t.sub(n),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return Sa(2)===0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=oi.absCotan(e),i,n=!1;for(let o of this.bottomCorners()){let a=oi.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,i=o,n=!0)}return n?le(t,oi.absCotan(e))?!1:(this.currentBottomSite=Xe.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=oi.absCotan(e),i,n=!1;for(let o of this.topCorners()){let a=oi.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,i=o,n=!0)}return n?le(t,oi.absCotan(e))?!1:(this.currentTopSite=Xe.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&oi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&oi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&oi.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&oi.PossibleCorner(t,i,o)&&(yield o)}static PossibleCorner(e,t,i){return i.x>e&&i.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>n&&(d.topAnchor>l+T.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+T.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=n)break;d.left<o&&(d.topAnchor>l+T.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+T.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var cr=class{constructor(e,t,i,n,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=i,this.settings=n,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinEastHierarchy=Os.Calculate(this.thinRightNodes),Os.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinWestHierarchy=Os.Calculate(this.thinWestNodes),Os.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let i of this.edgePath){let n=null;for(let o of this.EastBoundaryNodesOfANode(i,wn.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(n==null||n.origin.x>a.origin.x)&&(n=a),e.push(a.polygonalBoundary)}n!=null&&this.thinRightNodes.push(G.mkLinePXY(n.origin,this.originalGraph.right,n.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let i of this.edgePath.nodes()){let n=-1;for(let o of this.LeftBoundaryNodesOfANode(i,wn.GetNodeKind(t,this.edgePath)))(n===-1||this.layerArrays.x[o]>this.layerArrays.x[n])&&(n=o),e.push(this.anchors[o].polygonalBoundary);if(n!==-1){let o=this.anchors[n];this.thinWestNodes.push(G.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,i){let n=0,o=0;i===2?n=Number.MAX_VALUE:i===0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>n&&(n=c.bottomAnchor),yield u):c.bottomAnchor>n&&(this.NodeUCanBeCrossedByNodeV(u,a)||(n=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,i){let n=0,o=0;i===0?o=Number.MAX_VALUE:i===2&&(n=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+T.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,n=Math.max(n,c.bottomAnchor),yield u):c.bottomAnchor>n+T.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),n=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)===this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let i=this.OutcomingEdge(e),n=this.OutcomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Target,t=n.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}IntersectAbove(e,t){do{let i=this.IncomingEdge(e),n=this.IncomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Source,t=n.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}Intersect(e,t){let i=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],n=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return i>0&&n<0||i<0&&n>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new nt(this.headSite)}LineSegIntersectBound(e,t){let i=G.mkPP(e,t);return cr.CurveIntersectsHierarchy(i,this.westHierarchy)||cr.CurveIntersectsHierarchy(i,this.thinWestHierarchy)||cr.CurveIntersectsHierarchy(i,this.eastHierarchy)||cr.CurveIntersectsHierarchy(i,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return cr.SegIntersectsBound(e,t,this.westHierarchy)||cr.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return cr.SegIntersectsBound(e,t,this.eastHierarchy)||cr.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn===1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn===0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,i){return cr.CurveIntersectsHierarchy(G.mkPP(e.point,t.point),i)}static CurveIntersectsHierarchy(e,t){if(t==null||!Ie.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let i=t.node;return cr.CurveIntersectsHierarchy(e,i.children[0])||cr.CurveIntersectsHierarchy(e,i.children[1])}return R.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return m.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2}Reverse(){let e=new cr(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,i=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=i,i!=null&&(i.prev=e.headSite),i=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,i;for(let n=0;n<this.edgePath.count;n++)i=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(n),this.EdgePathNode(n+1)),t=i;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,i){oi.Refine(t,i,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=Xe.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=Xe.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),i=this.anchors[e],n=this.anchors[t];if(le(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindLegalPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y);let c=this.headSite.next,h=c.point.y;c.point=new m(this.MiddlePos(o.ax,o.bx,i,n,h),h),c.next.point=new m(o.bx,n.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),i=this.anchors[e],n=this.anchors[t];if(le(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y),this.headSite.next.point=new m(o.bx,n.y)}FindLegalPositions(e,t,i){return this.FindPositions(e,t,i)?this.PositionsAreLegal(i.ax,i.bx,i.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,i){let n,o;if(i.ax<i.bx?(i.sign=1,o=Math.max(i.ax,t.left),n=Math.min(e.right,i.bx)):(i.sign=-1,o=Math.max(e.left,i.bx),n=Math.min(t.right,i.ax)),o<=n)i.bx=.5*(o+n),i.ax=.5*(o+n);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;i.sign===1?(i.ax=e.right-.1*e.rightAnchor,i.bx=t.left):(i.ax=e.left+.1*e.leftAnchor,i.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let i=G.mkPP(e.origin,t.origin);return e.x<t.x&&R.CurvesIntersect(i,G.mkPP(e.rightBottom,e.rightTop))||R.CurvesIntersect(i,G.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&R.CurvesIntersect(i,G.mkPP(e.leftBottom,e.leftTop))||R.CurvesIntersect(i,G.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count===2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count===1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,i,n,o,a){if(!le(e,t)&&(e-t)*i>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,n,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new m(e,n.bottom),new m(t,o.top)):!1}MiddleAnchorLegal(e,t,i){let n=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-i.x;return!(o>0&&this.anchors[n[o-1]].right>a+i.left||o<n.length-1&&this.anchors[n[o+1]].left<a+i.right)}MiddlePos(e,t,i,n,o){let a=i.y-o,l=o-n.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let i=t.turn;if(e===0)i>0?e=1:i<0&&(e=-1);else if(e*i<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e===this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new R,t=this.headSite,i=R.findCorner(t);return i!==void 0?(this.createFilletCurve(e,{a:t,b:i.b,c:i.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(G.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)cr.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!m.closeDistEps(t,e.start)){let i=new R;i.addSegs([G.mkPP(t,e.start),e]),e=i}return t=this.TailSite.point,m.closeDistEps(t,e.end)||e.addSegment(G.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,i,n){let o=.5,a;do a=R.createBezierSeg(o,o,e,t,i),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=R.createBezierSeg(o,o,e,t,i);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}n.segs.length>0&&!m.closeDistEps(n.end,a.start)&&n.addSegment(G.mkPP(n.end,a.start)),n.addSegment(a)}BezierSegIntersectsBoundary(e){return m.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(Ie.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let i=t.node;return this.BezierSegIntersectsTree(e,i.children[0])||this.BezierSegIntersectsTree(e,i.children[1])}else return cr.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let i of R.getAllIntersections(e,t,!1))if(t instanceof R){let n=t;if(R.realCutWithClosedCurve(i,n,!1))return!0}else return!0;return!1}};var wn=class extends Pe{constructor(t,i,n,o,a,l){super(null);this.settings=t,this.OriginalGraph=i,this.Database=n,this.ProperLayeredGraph=a,this.LayerArrays=o,this.IntGraph=l}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){let t=[];for(let l of this.OriginalGraph.deepEdges)l.curve||t.push(l);if(t.length==0)return;let n=(this.OriginalGraph.layoutSettings?this.OriginalGraph.layoutSettings:new Rt).commonSettings.edgeRoutingSettings;new ze(this.OriginalGraph,t,n.padding,n.polylinePadding,n.coneAngle,n.bundlingSettings,this.cancelToken).run(),An.constructorGA(this.OriginalGraph,t).run()}RouteFlatEdges(){}createRegularSplines(){for(let t of this.Database.RegularMultiedges()){if(X2(t))continue;let i=t.length,n=i===1&&this.MayOptimizeEdge(t[0]);for(let o=Math.floor(i/2);o<i;o++)this.createSplineForNonSelfEdge(t[o],n);for(let o=Math.floor(i/2)-1;o>=0;o--)this.createSplineForNonSelfEdge(t[o],n)}}MayOptimizeEdge(t){return!(this.ProperLayeredGraph.OutDegreeIsMoreThanOne(t.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(t.target)||IC(t.edge.source)||IC(t.edge.target))}createSelfSplines(){for(let[t,i]of this.Database.Multiedges.keyValues()){let n=t;if(n.x===n.y){let o=this.Database.Anchors[n.x],a=o.leftAnchor;for(let l of i){let u=this.settings.NodeSeparation+(this.settings.MinNodeWidth+a),c=o.bottomAnchor/2,h=o.origin,d=h.add(new m(0,c)),f=h.add(new m(u,c)),p=h.add(new m(u,-c)),S=h.add(new m(0,-c)),x=Xe.mkSiteP(h),C=new nt(x);x=Xe.mkSiteSP(x,d),x=Xe.mkSiteSP(x,f),x=Xe.mkSiteSP(x,p),x=Xe.mkSiteSP(x,S),Xe.mkSiteSP(x,h);let O=C.createCurve();if(l.curve=O,l.edge.smoothedPolyline=C,a=u,l.edge.label!=null){a+=l.edge.label.width;let B=O.value((O.parStart+O.parEnd)/2),I=new m(B.x+l.labelWidth/2,o.y),_=new m(l.edge.label.width/2,l.edge.label.height/2),X=q.mkPP(I.add(_),I.sub(_));l.edge.label.width=X.width,l.edge.label.height=X.height,l.edge.label.positionCenter(I)}mt.trimSplineAndCalculateArrowheadsII(l.edge,l.edge.source.boundaryCurve,l.edge.target.boundaryCurve,O,!1)}}}}createSplineForNonSelfEdge(t,i){t.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(t,i),t.IsVirtualEdge||(t.updateEdgeLabelPosition(this.Database.Anchors),mt.trimSplineAndCalculateArrowheadsII(t.edge,t.edge.source.boundaryCurve,t.edge.target.boundaryCurve,t.curve,!0)))}drawSplineBySmothingThePolyline(t,i){let n=new cr(t,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),o=n.getSpline(i);t.reversed?(t.curve=o.reverse(),t.underlyingPolyline=n.Reverse().GetPolyline):(t.curve=o,t.underlyingPolyline=n.GetPolyline)}static UpdateLabel(t,i){let n=null;i.labelIsToTheRightOfTheSpline?(t.label.positionCenter(new m(i.x+i.rightAnchor/2,i.y)),n=G.mkPP(t.label.boundingBox.leftTop,t.label.boundingBox.leftBottom)):i.labelIsToTheLeftOfTheSpline&&(t.label.positionCenter(new m(i.x-i.leftAnchor/2,i.y)),n=G.mkPP(t.label.boundingBox.rightTop,t.label.boundingBox.rightBottom));let o=wn.GetSegmentInFrontOfLabel(t.curve,t.label.center.y);if(o!=null&&R.getAllIntersections(t.curve,R.polyFromBox(t.label.boundingBox),!1).length===0){let a={curveClosestPoint:void 0,labelSideClosest:void 0};if(wn.FindClosestPoints(a,o,n))wn.ShiftLabel(t,a);else{let l=o.closestParameter(n.start),u=o.closestParameter(n.end);o.value(l).sub(n.start).length<o.value(u).sub(n.end).length?(a.curveClosestPoint=o.value(l),a.labelSideClosest=n.start):(a.curveClosestPoint=o.value(u),a.labelSideClosest=n.end),wn.ShiftLabel(t,a)}}}static ShiftLabel(t,i){let n=t.lineWidth/2,o=i.curveClosestPoint.sub(i.labelSideClosest),a=o.length;a>n&&t.label.positionCenter(t.label.center.add(o.div(a*(a-n))))}static FindClosestPoints(t,i,n){let o=R.minDistWithinIntervals(i,n,i.parStart,i.parEnd,n.parStart,n.parEnd,(i.parStart+i.parEnd)/2,(n.parStart+n.parEnd)/2);return o?(t.curveClosestPoint=o.aX,t.labelSideClosest=o.bX,!0):!1}static GetSegmentInFrontOfLabel(t,i){if(t instanceof R){let n=t;for(let o of n.segs)if((o.start.y-i)*(o.end.y-i)<=0)return o}return null}static GetNodeKind(t,i){return t===0?0:t<i.count?1:2}};function X2(s){if(s.length<4)return!1;for(let e of s)if(e.edge.label)return!1;return!0}function IC(s){return s.node.selfEdges.size>0}var qc=class extends Pe{constructor(t,i,n){super(n);this.LayersAreDoubled=!1;if(t==null)return;this.originalGraph=t,this.sugiyamaSettings=i;let o=Array.from(t.shallowNodes);this.nodeIdToIndex=new Map;let a=0;for(let u of o)this.nodeIdToIndex.set(u.id,a++);let l=[];for(let u of this.originalGraph.shallowEdges){let c=this.nodeIdToIndex.get(u.source.id);if(c==null)continue;let h=this.nodeIdToIndex.get(u.target.id);if(h==null)continue;let d=new Dr(c,h,u);l.push(d)}this.IntGraph=new qo(l,t.shallowNodeCount),this.IntGraph.nodes=o,this.database=new eb(o.length);for(let u of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(u);this.cycleRemoval()}get extremeAspectRatio(){let t=this.originalGraph.boundingBox,i=t.width/t.height;return i<1/50||i>50}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount===0){this.originalGraph.boundingBox=q.mkEmpty();return}l_(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode===3&&this.runPostLayering(),u_(this.originalGraph,this.sugiyamaSettings.transform)}runPostLayering(){let t=this.sugiyamaSettings.commonSettings.edgeRoutingSettings,i=this.constrainedOrdering!=null?0:t.EdgeRoutingMode;this.extremeAspectRatio?Um(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken):i===3?this.calculateEdgeSplines():Fa(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let t=this.sugiyamaSettings.verticalConstraints,i=t.isEmpty?wi.getFeedbackSet(this.IntGraph):t.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(i)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let t=this.CalculateLayerArrays();return this.UpdateNodePositionData(),t}UpdateNodePositionData(){for(let t=0;t<this.IntGraph.nodeCount&&t<this.database.Anchors.length;t++)this.IntGraph.nodes[t].center=this.database.Anchors[t].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let t=0;t<this.originalGraph.shallowNodeCount;t++)this.SnapLeftSidesOfTheNodeToGrid(t,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(t,i){let n=this.IntGraph.nodes[t],o=this.database.Anchors[t];o.leftAnchor-=i/2,o.rightAnchor-=i/2;let a=n.boundingBox.left,l=Math.floor(a/i),u=a-l*i;Math.abs(u)<.001||(Math.abs(u)<=i/2?n.center=n.center.add(new m(-u,0)):n.center=n.center.add(new m(i-u,0)),o.x=n.center.x)}GetCurrentHeight(){let t=new Xi;for(let i of this.NodeAnchors())t.AddValue(i.top),t.AddValue(i.bottom);return t.length}*NodeAnchors(){let t=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let i=0;i<t;i++)yield this.anchors[i]}GetCurrentWidth(){let t=new Xi;for(let i of this.NodeAnchors())t.AddValue(i.left),t.AddValue(i.right);return t.length}ExtendLayeringToUngluedSameLayerVertices(t){let i=this.verticalConstraints;for(let n=0;n<t.length;n++)t[n]=t[i.nodeToRepr(n)];return t}calculateEdgeSplines(){new wn(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(t){let i=t.GetLayers();Xc.Balance(this.gluedDagSkeletonForLayering,i,this.GetNodeCountsOfGluedDag(),null),i=this.ExtendLayeringToUngluedSameLayerVertices(i);let n=new Di(i);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return n=this.YLayeringAndOrderingWithoutHorizontalConstraints(n),n;throw new Error("not implemented")}CreateProperLayeredGraph(t){let i=t.length,n=0;for(let a of this.database.SkeletonEdges()){let l=J2(t,a);l>0&&(a.LayerEdges=new Array(l));let u=0;if(l>1){let c=i+n++,h=new Mi(a.source,c,a.CrossingWeight,a.weight);a.LayerEdges[u++]=h;for(let d=0;d<l-2;d++)c++,n++,h=new Mi(c-1,c,a.CrossingWeight,a.weight),a.LayerEdges[u++]=h;h=new Mi(c,a.target,a.CrossingWeight,a.weight),a.LayerEdges[u]=h}else if(l===1){let c=new Mi(a.source,a.target,a.CrossingWeight,a.weight);a.LayerEdges[u]=c}}let o=new Array(this.originalGraph.shallowNodeCount+n).fill(0);for(let a of this.database.SkeletonEdges())if(a.LayerEdges!=null){let l=t[a.source];o[a.source]=l--;for(let u of a.LayerEdges)o[u.Target]=l--}else o[a.source]=t[a.source],o[a.target]=t[a.target];return this.properLayeredGraph=new In(new qo(Array.from(this.database.SkeletonEdges()),t.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new Di(o)}YLayeringAndOrderingWithoutHorizontalConstraints(t){let i=this.CreateProperLayeredGraph(t.y);return Rs.OrderLayers(this.properLayeredGraph,i,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),iu.UpdateLayerArrays1(this.properLayeredGraph,i),i}CalculateYLayers(){let t=this.YLayeringAndOrdering(new ob(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?t:this.InsertLayersIfNeeded(t)}InsertLayersIfNeeded(t){this.InsertVirtualEdgesIfNeeded(t);let i=this.AnalyzeNeedToInsertLayersAndHasMultiedges(t);if(i.needToInsertLayers){let n=Ls.InsertLayers(this.properLayeredGraph,t,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,t=n.la,this.LayersAreDoubled=!0}else if(i.multipleEdges){let n=Jn.InsertPaths(this.properLayeredGraph,t,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,t=n.la}return this.RecreateIntGraphFromDataBase(),t}RecreateIntGraphFromDataBase(){let t=new Array;for(let i of this.database.Multiedges.values())t=t.concat(i);this.IntGraph.SetEdges(t,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(t){if(this.constrainedOrdering==null){for(let[i,n]of this.database.Multiedges.keyValues())if(n.length%2===0&&t.y[i.x]-1===t.y[i.y]){let o=new We(null),a=new Dr(i.x,i.y,o);a.IsVirtualEdge=!0,n.splice(n.length/2,0,a),this.IntGraph.addEdge(a)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(t){let i=!1,n=!1;for(let o of this.IntGraph.edges)if(o.hasLabel&&t.y[o.source]!==t.y[o.target]){i=!0;break}if(i===!1&&this.constrainedOrdering==null){for(let[o,a]of this.database.Multiedges.keyValues())if(a.length>1&&(n=!0,t.y[o.x]-t.y[o.y]===1)){i=!0;break}}return{needToInsertLayers:i,multipleEdges:n}}UseBrandesXCalculations(t){return t.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(t){this.anchors=K2(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),Z2(t,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let t=0;t<this.anchors.length;t++){let i=this.anchors[t];if(i.labelIsToTheRightOfTheSpline){let n=this.GetSuccessorAndPredecessor(t);if(!r_(i,n.predecessor,n.successor)){let o=n.predecessor.origin.sub(i.origin).length+n.successor.origin.sub(i.origin).length,a=i.right-i.leftAnchor,l=new m(a,i.y);n.predecessor.origin.sub(l).length+n.successor.origin.sub(l).length<o&&OC(i)}}}}GetSuccessorAndPredecessor(t){let i;for(let o of this.properLayeredGraph.InEdges(t))i=o.Source;let n;for(let o of this.properLayeredGraph.OutEdges(t))n=o.Target;return{predecessor:this.anchors[i],successor:this.anchors[n]}}CalculateLayerArrays(){let t=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(t),this.UseBrandesXCalculations(t)?this.CalculateXPositionsByBrandes(t):this.CalculateXLayersByGansnerNorth(t)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=t,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),t}StretchToDesiredAspectRatio(t,i){t>i?this.StretchInYDirection(t/i):t<i&&this.StretchInXDirection(i/t)}StretchInYDirection(t){let i=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let o of this.database.Anchors)o.bottomAnchor=o.bottomAnchor*t,o.topAnchor=o.topAnchor*t,o.y=i+t*(o.y-i);let n=this.originalGraph.height*t;this.originalGraph.boundingBox=new q({left:this.originalGraph.boundingBox.left,top:i+n/2,right:this.originalGraph.boundingBox.right,bottom:i-n/2})}StretchInXDirection(t){let i=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let o of this.database.Anchors)o.leftAnchor=o.leftAnchor*t,o.rightAnchor=o.rightAnchor*t,o.x=i+t*(o.x-i);let n=this.originalGraph.width*t;this.originalGraph.boundingBox=new q({left:i-n/2,top:this.originalGraph.boundingBox.top,right:i+n/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length===0)return;let t=new q({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let i=1;i<this.anchors.length;i++){let n=this.anchors[i];t.add(n.leftTop),t.add(n.rightBottom)}this.originalGraph.labelSize&&this.originalGraph.addLabelToGraphBB(t),t.padEverywhere(this.originalGraph.margins),this.originalGraph.boundingBox=t}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let t=!1;for(let i of this.database.AllIntEdges())i.LayerSpan===2&&(t=this.ShiftVertexWithNeighbors(i.LayerEdges[0].Source,i.LayerEdges[0].Target,i.LayerEdges[1].Target)||t);return t}ShiftVertexWithNeighbors(t,i,n){let o=this.database.Anchors[t],a=this.database.Anchors[n],l=this.database.Anchors[i],u=(l.y-o.y)*((a.x-o.x)/(a.y-o.y))+o.x,c=1e-4;return u>l.x+c?this.TryShiftToTheRight(u,i):u<l.x-c?this.TryShiftToTheLeft(u,i):!1}TryShiftToTheLeft(t,i){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[i]],o=this.engineLayerArrays.x[i];if(o>0){let a=this.database.Anchors[n[o-1]],l=Math.max(a.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[i].leftAnchor),t);return l<this.database.Anchors[i].x-1?(this.database.Anchors[i].x=l,!0):!1}return this.database.Anchors[i].x=t,!0}TryShiftToTheRight(t,i){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[i]],o=this.engineLayerArrays.x[i];if(o<n.length-1){let a=this.database.Anchors[n[o+1]],l=Math.min(a.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[i].rightAnchor),t);return l>this.database.Anchors[i].x+1?(this.database.Anchors[i].x=l,!0):!1}return this.database.Anchors[i].x=t,!0}CalculateXLayersByGansnerNorth(t){this.xLayoutGraph=this.CreateXLayoutGraph(t),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let t=new Yc(this.xLayoutGraph,null).GetLayers();for(let i=0;i<this.database.Anchors.length;i++)this.anchors[i].x=t[i]}CreateXLayoutGraph(t){let i=this.properLayeredGraph.NodeCount,n=new Array;for(let a of this.properLayeredGraph.Edges){let l=new Dr(i,a.Source,null),u=new Dr(i,a.Target,null);u.weight=a.Weight,l.weight=a.Weight,l.separation=0,u.separation=0,i++,n.push(l),n.push(u)}for(let a of t.Layers)for(let l=a.length-1;l>0;l--){let u=a[l],c=a[l-1],h=new Dr(u,c,null),d=this.database.Anchors[u],f=this.database.Anchors[c],p=d.leftAnchor+(f.rightAnchor+this.sugiyamaSettings.NodeSeparation);h.separation=Math.ceil(p+.5),n.push(h)}let o=new sb(this.IntGraph,this.properLayeredGraph,t,n,i);return o.SetEdgeWeights(),o}CalculateXPositionsByBrandes(t){nf.CalculateXCoordinates(t,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let t=new Xr(this.IntGraph.nodeCount);for(let[n,o]of this.database.Multiedges.keyValues()){if(n.isDiagonal())continue;let a=this.verticalConstraints.gluedIntEdge(o[0]);a.source!==a.target&&t.set(a.source,a.target,a)}let i=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(n=>Q2(n,null));for(let n of i)t.set(n.source,n.target,n);return Array.from(t.values())}static CalcAnchorsForOriginalNode(t,i,n,o,a){let l={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(i.nodes!=null){let h=i.nodes[t];o_(l,h,a)}s_(t,l,o,a);let u=a.MinNodeWidth/2;l.leftAnchor<u&&(l.leftAnchor=u),l.rightAnchor<u&&(l.rightAnchor=u);let c=a.MinNodeHeight/2;l.topAnchor<c&&(l.topAnchor=c),l.bottomAnchor<c&&(l.bottomAnchor=c),n[t]=ni.mkAnchor(l.leftAnchor,l.rightAnchor,l.topAnchor,l.bottomAnchor,i.nodes[t],a.LabelCornersPreserveCoefficient),n[t].padding=i.nodes[t].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new qo(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let t=new Xr(this.IntGraph.nodeCount);for(let i of this.gluedDagSkeletonForLayering.edges)t.set(i.source,i.target,i);for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y){let o=this.verticalConstraints.gluedIntPair(i);if(o.x===o.y)continue;let a=t.get(o.x,o.y);for(let l of n)a.weight+=l.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function wC(s,e){if(e===0)return 0;let t=Math.floor(s/e),i=s-t*e;return Math.abs(i)<1e-4?0:e-i}function Y2(s,e){for(let t of s)if(t<e)return!0;return!1}function K2(s,e,t,i,n){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new ni(n.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)qc.CalcAnchorsForOriginalNode(a,i,o,s,n);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!==a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=M0()*4,c.topAnchor=c.bottomAnchor=LC(n)/2):(c.leftAnchor=c.rightAnchor=M0()/2,c.topAnchor=c.bottomAnchor=LC(n)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=M0()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function M0(){return 1}function LC(s){return s.MinNodeHeight*1.5/8}function RC(s,e,t,i,n,o){let a=0;if(t>0){let l=i_(e.Layers[t-1],e.y,i);if(l.length){let u=n.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>n_(h,c,u,s)))}}return a}function Z2(s,e,t,i,n,o,a){let l=i.Anchors,u=t.margins.top+e,c=0;for(let h of s.Layers){let d=0,f=0;for(let O of h){let B=l[O];B.bottomAnchor>d&&(d=B.bottomAnchor),B.topAnchor>f&&(f=B.topAnchor)}$2(h,d,f,t.shallowNodeCount,i.Anchors);let p=RC(i,s,c,n,o,u),S=u+d+p,x=S+f;if(e_(o)){x+=wC(x,o.GridSizeByY);for(let O of h)l[O].top=x}else if(t_(o)){let O=S-d;O+=wC(O,O);for(let B of h)l[B].bottom=O,x=Math.max(l[B].top,x)}else for(let O of h)l[O].y=S;let C=o.ActualLayerSeparation(a);u=x+C,c++}RC(i,s,c,n,o,u)}function Q2(s,e){let t=new Dr(s.x,s.y,e);return t.weight=0,t.separation=1,t}function J2(s,e){return s[e.source]-s[e.target]}function $2(s,e,t,i,n){if(Y2(s,i)){for(let o of s)if(o>=i){let a=n[o];a.bottomAnchor=e,a.topAnchor=t}}}function e_(s){return s.SnapToGridByY===1}function t_(s){return s.SnapToGridByY===2}function r_(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(m.getTriangleOrientation(e.origin,s.origin,t.origin)===0)return!0;let i=s.leftAnchor,n=s.rightAnchor,o=s.x;return OC(s),m.getTriangleOrientation(e.origin,s.origin,t.origin)===1?!0:(s.x=o,s.leftAnchor=i,s.rightAnchor=n,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function OC(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function i_(s,e,t){let i=new Ar;for(let n of s)if(!(n>=t.nodeCount))for(let o of t.outEdges[n])e[o.source]===e[o.target]&&i.addNN(o.source,o.target);return Array.from(i.values())}function n_(s,e,t,i){let n=0,o=i.GetMultiedgeI(s);for(let a of o){n+=t;let l=a.edge.label;l!=null&&(l.positionCenter(new m(l.center.x,e+n+l.height/2)),n+=l.height)}return n}function o_(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function s_(s,e,t,i){let n=a_(t,s,e,i);e.rightAnchor+=n}function a_(s,e,t,i){let n=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));n+=(i.NodeSeparation+i.MinNodeWidth)*o.length}return n}function l_(s,e){if(e.isIdentity())return;let t=e.inverse();for(let i of s.shallowNodes)i.transform(t);for(let i of s.shallowEdges)if(i.label!=null){let n=q.mkPP(t.multiplyPoint(new m(0,0)),t.multiplyPoint(new m(i.label.width,i.label.height)));i.label.width=n.width,i.label.height=n.height}}function u_(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes)t.transform(e);for(let t of s.shallowEdges)if(t.label!=null){let i=q.mkPP(e.multiplyPoint(new m(0,0)),e.multiplyPoint(new m(t.label.width,t.label.height)));t.label.width=i.width,t.label.height=i.height}c_(s,e),s.graph.parent==null&&(s.boundingBox=null)}}function c_(s,e){for(let t of s.shallowEdges)t.label&&t.label.transform(e),h_(e,t)}function h_(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),d_(e,s)}}function d_(s,e){if(s.smoothedPolyline!=null)for(let t=s.smoothedPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var QC=Ae(BC(),1);var XC=Ae(qC(),1);function Xo(s){let e=(0,XC.default)(s);if(e.keyword!=null)return L.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new L(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return L.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return L.Black}function za(s){return"nodes"in s?z_(s):YC(s)}function z_(s){let e=new Ce;for(let t of s.nodes){let i=String(t.id),n=e.addNode(new Rr(i)),o=new wt(n),{label:a=i,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=fs[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=Xo(t.color))}for(let t of s.edges){let i=e.setEdge(String(t.source),String(t.target)),n=new qi(i,!1),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;n.arrowhead=Ao[o],n.arrowtail=Ao[a],n.directed=l,"weight"in t&&(n.weight=t.weight),"color"in t&&(n.color=Xo(t.color))}return new yt(e),e}function q0(s,e,t){for(let n of t.attr_list)if(n.type==="attr"){let o=n.eq;switch(n.id){case"edgeCurve":{let a=df(s),l=JSON.parse(o);a.curve=Lp(l)}break;case"graphBoundingBox":{let a=df(s),l=JSON.parse(o);a.boundingBox=new q(l)}break;case"boundaryCurve":{let a=df(s),l=JSON.parse(o),u=Lp(l);a instanceof me?a.boundingBox=u.boundingBox:a.boundaryCurve=u}break;case"sourceArrowhead":{let a=df(s);a.sourceArrowhead==null&&(a.sourceArrowhead=new mt),a.sourceArrowhead.tipPosition=m.fromJSON(JSON.parse(o));break}case"targetArrowhead":{let a=df(s);a.targetArrowhead==null&&(a.targetArrowhead=new mt),a.targetArrowhead.tipPosition=m.fromJSON(JSON.parse(o));break}case"geomEdgeLabel":{let a=JSON.parse(o),l=s;i(l),new Ii(l.label,new q(a)).setBoundingBox(new q(a));break}case"color":e.color=Xo(o);break;case"pencolor":e.pencolor=Xo(o);break;case"labelfontcolor":e.labelfontcolor=Xo(o);break;case"fontcolor":e.fontColor=Xo(o);break;case"fillcolor":e.fillColor=Xo(o);break;case"style":for(let a of W_(o))e.styles.push(a);break;case"shape":{let a=e;a.shape=H_(o);break}case"peripheries":e.peripheries=parseInt(o);break;case"headlabel":e.headlabel=o;break;case"label":if(typeof o=="string"){let a="\\n",l=0;e.labelText="";do{let u=o.indexOf(a,l);if(u>=0)e.labelText+=o.substring(l,u)+`
`,l=u+2;else{e.labelText+=o.substring(l);break}}while(!0)}else typeof o=="number"&&(e.labelText=o.toString());s instanceof br&&i(s);break;case"size":e.size=j0(o);break;case"pos":e.pos=j0(o);break;case"rankdir":e.rankdir=j_(o);break;case"fontname":e.fontname=o;break;case"fontsize":e.fontsize=parseFloat(o);break;case"width":e.width=parseFloat(o);break;case"penwidth":e.penwidth=parseFloat(o);break;case"height":e.height=parseFloat(o);break;case"margin":e.margin=parseFloat(o);break;case"len":e.len=parseFloat(o);break;case"minlen":e.minlen=parseFloat(o);break;case"rank":e.rank=q_(o);break;case"charset":e.charset=o;break;case"orientation":e.orientation=o;break;case"ratio":e.ratio=o;break;case"weight":e.weight=parseFloat(o);break;case"nodesep":e.nodesep=parseFloat(o);break;case"layersep":e.layersep=parseFloat(o);break;case"arrowsize":e.arrowsize=parseFloat(o);break;case"rotate":e.rotate=parseFloat(o);break;case"ranksep":e.ranksep=parseFloat(o);break;case"splines":e.splines=o==="true";break;case"overlap":e.overlap=o==="true";break;case"arrowtail":e.arrowtail=KC(o);break;case"taillabel":e.taillabel=o;break;case"arrowhead":e.arrowhead=KC(o);break;case"ordering":e.ordering=X_(o);break;case"URL":e.URL=o;break;case"dir":e.dir=Y_(o);break;case"concentrate":e.concentrate=o==="true";break;case"compound":e.compound=o==="true";break;case"lhead":e.lhead=o;break;case"ltail":e.ltail=o;break;case"bgcolor":e.bgcolor=Xo(o);break;case"center":e.center=o===!0||parseInt(o)===1;break;case"colorscheme":e.colorscheme=o;break;case"sides":e.sides=parseInt(o);break;case"distortion":e.distortion=parseFloat(o);break;case"skew":e.skew=parseFloat(o);break;case"bb":e.bb=K_(o);break;case"labelloc":e.labelloc=o;break;case"decorate":e.decorate=o==="true";break;case"tailclip":e.tailclip=o==="true";break;case"headclip":e.headclip=o==="true";break;case"constraint":e.constraint=o==="true";break;case"gradientangle":e.gradientangle=parseFloat(o);break;case"samehead":e.samehead=o;break;case"href":e.href=o;break;case"imagepath":e.imagepath=o;break;case"image":e.image=o;break;case"labeljust":e.labejust=o;break;case"layers":e.layers=o.split(",");break;case"layer":e.layer=o;break;case"f":e.f=parseFloat(o);break;case"nojustify":e.nojustify=o==="true";break;case"root":e.root=o==="true";break;case"page":e.page=j0(o);break;case"pname":e.pname=o;break;case"kind":e.kind=o;break;case"fname":e.fname=o;break;case"subkind":e.subkind=o;break;case"area":e.area=parseFloat(o);break;case"tailport":e.tailport=o;break;case"headport":e.headport=o;break;case"wt":e.wt=o;break;case"id":e instanceof wt||(e.id=o);break;case"edgetooltip":e.edgetooltip=o;break;case"headtooltip":e.headtooltip=o;break;case"tailtooltip":e.tailtooltip=o;break;case"headURL":e.headURL=o;break;case"tailURL":e.tailURL=o;break;case"labelURL":e.labelURL=o;break;case"edgeurl":e.edgeurl=o;break;case"shapefile":e.shapefile=o;break;case"xlabel":e.xlabel=o;break;case"sametail":e.sametail=o;break;case"clusterrank":e.clusterRank=o;break;case"measuredTextSize":e.measuredTextSize=JSON.parse(o);break;default:break}}else throw new Error("unexpected type "+n.type);function i(n){n.label==null&&(n.label=new ds(n))}}function Qc(s,e){let t=ke.getDrawingObj(e);s.attr_list!=null&&q0(e,t,s)}var hb=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,i,n,o){let a,l;if(e.type==="node_id"){let c=e.id.toString();a=this.nodeMap.get(c),a==null?a=this.newNode(c,i,!1):this.tryToMoveToADeeperGraph(a,i)}else{let c=[];for(let h of e.children)if(h.type==="node_stmt")for(let d of this.parseEdge(h.node_id,t,i,n,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of e.children)if(h.type==="attr_stmt")for(let d of c)Qc(h,d);return c}if(t.type==="node_id"){let c=t.id.toString();l=this.nodeMap.get(c),l==null?l=this.newNode(c,i,!1):this.tryToMoveToADeeperGraph(l,i)}else if(t.type==="subgraph"){let c=new Array;for(let h of t.children)if(h.type==="node_stmt")for(let d of this.parseEdge(e,h.node_id,i,n,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of t.children)if(h.type==="attr_stmt")for(let d of c)Qc(h,d);return c}let u=new br(a,l);return new qi(u,n),Qc(o,u),[u]}tryToMoveToADeeperGraph(e,t){De.assert(e.parent!=null);let i=e.parent;i!=t&&n(i)<n(t)&&(i.remove(e),t.addNode(e));function n(o){let a=0,l=o.parent;for(;l;)a++,l=l.parent;return a}}newNode(e,t,i){let n=this.nodeMap.get(e);if(n==null){n=new Rr(e),this.nodeMap.set(e,n),t.addNode(n);let o=new wt(n);o.labelText=e;let a=yt.getDrawingObj(t);ke.copyValidFields(a.defaultNodeObject,o)}else i&&Hy(t,n);return n}parseNode(e,t,i){let n=e.node_id.id.toString(),o=this.newNode(n,t,i);return ke.getDrawingObj(o)==null&&new wt(o),Qc(e,o),o}parse(){return this.ast==null?null:(this.graph=new Ce(this.ast[0].id?this.ast[0].id.toString():"__graph__"),this.drawingGraph=new yt(this.graph),this.parseUnderGraph(this.ast[0].children,this.graph,this.ast[0].type==="digraph",!1),Q_(this.graph),J_(this.graph),this.graph)}parseGraphAttr(e,t){if(e.target==="node"){let i=yt.getDrawingObj(t);i.defaultNodeObject==null&&(i.defaultNodeObject=new wt(null)),q0(null,i.defaultNodeObject,e)}else e.target==="graph"&&Qc(e,t)}getEntitiesSubg(e,t,i){let n=[];for(let o of e.children)if(o.type==="edge_stmt")for(let a=0;a<o.edge_list.length-1;a++)for(let l of this.parseEdge(o.edge_list[a],o.edge_list[a+1],t,i,o))n.push(l);else if(o.type!=="attr_stmt")if(o.type==="node_stmt")n.push(this.parseNode(o,t,!0));else if(o.type==="subgraph")if(o.id!=null){let a=new Ce(o.id.toString());t.addNode(a),this.nodeMap.set(a.id,a);let l=new yt(a);this.parseUnderGraph(o.children,a,i,!0),n.push(l.graph),a.isEmpty&&(t.removeNode(a),this.nodeMap.delete(a.id))}else n=n.concat(this.getEntitiesSubg(o,t,i));else throw new Error("Function not implemented.");return n}parseUnderGraph(e,t,i,n){for(let o of e)switch(o.type){case"node_stmt":this.parseNode(o,t,n);break;case"edge_stmt":{let a=o.edge_list;for(let l=0;l<a.length-1;l++)this.parseEdge(a[l],a[l+1],t,i,o)}break;case"subgraph":if(!this.process_same_rank(o,yt.getDrawingGraph(t)))if(o.id==null){let a=this.getEntitiesSubg(o,t,i);Z_(o,yt.getDrawingGraph(t),a)}else{let a=new Ce(o.id.toString());this.nodeMap.set(o.id.toString(),a),t.addNode(a),new yt(a),this.parseUnderGraph(o.children,a,i,!0),a.isEmpty()&&(t.remove(a),this.nodeMap.delete(a.id))}break;case"attr_stmt":this.parseGraphAttr(o,t);break;default:throw new Error("not implemented")}}process_same_rank(e,t){let i=e.children[0];if(i==null||i.type!=="attr_stmt")return!1;let n=i.attr_list;if(n==null||n.length===0)return!1;let o=n[0];if(o.type!=="attr"||o.id!=="rank")return!1;switch(o.eq){case"min":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"max":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"same":{let a=[];for(let l=1;l<e.children.length;l++){let u=e.children[l];u.type==="node_stmt"?(this.newNode(u.node_id.id.toString(),t.graph,!1),a.push(u.node_id.id.toString())):u.type==="attr_stmt"&&u.target==="node"&&(t.defaultNodeObject==null&&(t.defaultNodeObject=new wt(null)),q0(null,t.defaultNodeObject,u))}return t.graphVisData.sameRanks.push(a),!0}case"source":{for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sourceRanks.push(l.node_id.id.toString());else throw new Error}return!0}case"sink":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sinkRanks.push(l.node_id.id.toString());else throw new Error}return!0;default:throw new Error("incorrect rank")}}};function X0(s){try{return new hb((0,QC.default)(s)).parse()}catch(e){return console.log("cannot parse the graph"),null}}function YC(s){try{return new hb([s]).parse()}catch(e){return console.log(e.message),null}}function*W_(s){let e=s.split(",");for(let t of e){let n=gc[t];n&&(yield n)}}function H_(s){let e=s.toLowerCase();return fs[e]}function j0(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function j_(s){return tu[s]}function q_(s){return Qm[s]}function KC(s){return Ao[s]}function X_(s){return $m[s]}function Y_(s){return Jm[s]}function K_(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function Z_(s,e,t){for(let i of s.children)if(i.type==="attr_stmt")for(let n of t)Qc(i,n)}function Q_(s){let e=[];for(let t of s.subgraphsBreadthFirst())t.isEmpty()&&e.push(t);for(let t of e){let i=t.parent;i&&i.removeNode(t)}}function J_(s){for(let e of s.subgraphsBreadthFirst())me.getGeom(e)==null&&e.hasSomeAttrOnIndex(qe.GeomObjectIndex)&&new me(e);me.getGeom(s)==null&&s.hasSomeAttrOnIndex(qe.GeomObjectIndex)&&new me(s)}function ff(s){let e=aN(s);return{type:oN(s),id:s.id,children:eN(s,e)}}function $_(s){return{type:"edge_stmt",edge_list:[{type:"node_id",id:s.source.id},{type:"node_id",id:s.target.id}],attr_list:Array.from(tN(s))}}function eN(s,e){let t=new Map,i=[],n=me.getGeom(s);if(n){let o=Array.from($C(n));i.push({type:"attr_stmt",target:"graph",attr_list:o})}uN(i,s);for(let o of s.nodesBreadthFirst)t.set(o.id,rN(o));for(let o of s.nodesBreadthFirst){if(o.parent===s)continue;t.get(o.parent.id).children.push(t.get(o.id))}for(let o of s.deepEdges){let a=$_(o),l=sN(o,e);l===s?i.push(a):t.get(l.id).children.push(a)}for(let o of s.shallowNodes)i.push(t.get(o.id));return i}function*tN(s){let e=xe.getGeom(s);if(e&&e.curve&&(yield{type:"attr",id:"edgeCurve",eq:JSON.stringify(Rp(e.curve))},e.sourceArrowhead&&(yield{type:"attr",id:"sourceArrowhead",eq:JSON.stringify(e.sourceArrowhead.tipPosition.toJSON())}),e.targetArrowhead&&(yield{type:"attr",id:"targetArrowhead",eq:JSON.stringify(e.targetArrowhead.tipPosition.toJSON())}),s.label)){let t=s.label.getAttr(qe.GeomObjectIndex).boundingBox,i={left:t.left,right:t.right,top:t.top,bottom:t.bottom};yield{type:"attr",id:"geomEdgeLabel",eq:JSON.stringify(i)}}yield*Y0(ke.getDrawingObj(s))}function rN(s){if(s instanceof Ce){let t=Array.from($C(me.getGeom(s))),i=[],n={type:"attr_stmt",target:"graph",attr_list:t};return i.push(n),{type:"subgraph",children:i,id:s.id}}else return{type:"node_stmt",node_id:{type:"node_id",id:s.id},attr_list:Array.from(nN(s))}}function iN(s){let e=ot.getGeom(s).boundaryCurve;return{type:"attr",id:"boundaryCurve",eq:JSON.stringify(Rp(e))}}function*nN(s){xe.getGeom(s)&&(yield iN(s)),yield*Y0(ke.getDrawingObj(s))}function*Y0(s){if(s)for(let e of s.attrIter())yield e}function oN(s){return yt.getDrawingGraph(s).hasDirectedEdge()?"digraph":"graph"}function sN(s,e){let t=s.source,i=s.target,n=e.get(t.id),o=e.get(i.id);for(;n>o;)t=t.parent,n--;for(;n<o;)i=i.parent,o--;for(;t.parent!==i.parent;)t=t.parent,i=i.parent;return t.parent}function aN(s){let e=new Map;return e.set(s.id,0),JC(s,e),e}function JC(s,e){let t=e.get(s.id)+1;for(let i of s.shallowNodes)e.set(i.id,t),i instanceof Ce&&JC(i,e)}function df(s){var e;return(e=xe.getGeom(s))!=null?e:lN(s)}function lN(s){if(s instanceof Ce)return new me(s);if(s instanceof Rr)return new ot(s);if(s instanceof br)return new We(s);throw new Error("unsupported type "+s)}function uN(s,e){let t=yt.getDrawingObj(e);if(t==null)return;let i=t.defaultNodeObject;i&&s.push({type:"attr_stmt",target:"node",attr_list:Array.from(Y0(i))})}function*$C(s){if(s==null)return;let e=s.boundingBox;if(e&&e.isEmpty()===!1){let t={left:e.left,right:e.right,top:e.top,bottom:e.bottom};yield{type:"attr",id:"graphBoundingBox",eq:JSON.stringify(t)}}s.radX!==10&&(yield{type:"attr",id:"radX",eq:s.radX.toString()}),s.radY!==10&&(yield{type:"attr",id:"radY",eq:s.radY.toString()})}function K0(s){let e=new Ce;try{let t=s.split(/\r\n|\r|\n/);for(let i of t){if(i.length==0||i.charAt(0)=="#")continue;let n=i.split(/\t/);if(n.length!=2)return console.log("cannot parse",i),null;let o=n[0],a=n[1],l=ZC(e,o),u=ZC(e,a),c=new br(l,u);new qi(c,!0)}}catch(t){console.log(t.message)}return new yt(e),e}function ZC(s,e){let t=s.findNode(e);return t==null&&(t=s.addNode(new Rr(e)),new wt(t)),t}async function Z0(s){let e=await s.text(),t;return s.name.toLowerCase().endsWith(".json")?t=za(JSON.parse(e)):s.name.toLowerCase().endsWith(".txt")?t=K0(e):t=X0(e),t&&(t.id=s.name),t}async function db(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),i;if(e.endsWith(".json")){let n=await t.json();i=za(n)}else if(e.endsWith(".txt")){let n=await t.text();i=K0(n)}else{let n=await t.text();i=X0(n)}return i&&(i.id=e),i}var Jc=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"},this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:i,fontStyle:n,fontWeight:o}=this.opts;this.ctx.font=`${n} ${o} ${i}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:i,lineHeight:n}=this.opts,o=i*1.2,a=i*(n-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new Dt(l,u.length*o+(u.length-1)*a)}};function gf(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!gf(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!e.hasOwnProperty(n)||!gf(s[n],e[n]))return!1;return!0}return!1}function Q0(s){if(s instanceof me){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}function Wa(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var Yo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},dN=Yo.self||Yo.window||Yo.global||{},fN=Yo.window||Yo.self||Yo.global||{},gN=Yo.global||Yo.self||Yo.window||{},pN=Yo.document||{};var au=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var eA=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),mN=eA&&parseFloat(eA[1])||0;var tA="3.2.12";function si(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var Ko={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},jpe=Ko.self||Ko.window||Ko.global||{},qpe=Ko.window||Ko.self||Ko.global||{},Xpe=Ko.global||Ko.self||Ko.window||{},Ype=Ko.document||{};var lu=typeof process!="object"||String(process)!=="[object process]"||process.browser;var iA=typeof window<"u"&&typeof window.orientation<"u",rA=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),Kpe=rA&&parseFloat(rA[1])||0;function y(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var pf=class{constructor(e,t){y(this,"name",void 0),y(this,"workerThread",void 0),y(this,"isRunning",!0),y(this,"result",void 0),y(this,"_resolve",()=>{}),y(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,n)=>{this._resolve=i,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){si(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){si(this.isRunning),this.isRunning=!1,this._reject(e)}};var $c=class{};var J0=new Map;function nA(s){si(s.source&&!s.url||!s.source&&s.url);let e=J0.get(s.source||s.url);return e||(s.url&&(e=bN(s.url),J0.set(s.url,e)),s.source&&(e=oA(s.source),J0.set(s.source,e))),si(e),e}function bN(s){if(!s.startsWith("http"))return s;let e=PN(s);return oA(e)}function oA(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function PN(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function $0(s,e=!0,t){let i=t||new Set;if(s){if(sA(s))i.add(s);else if(sA(s.buffer))i.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let n in s)$0(s[n],e,i)}}return t===void 0?Array.from(i):[]}function sA(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var eS=()=>{},Ha=class{static isSupported(){return typeof Worker<"u"&&lu||typeof $c<"u"&&!lu}constructor(e){y(this,"name",void 0),y(this,"source",void 0),y(this,"url",void 0),y(this,"terminated",!1),y(this,"worker",void 0),y(this,"onMessage",void 0),y(this,"onError",void 0),y(this,"_loadableURL","");let{name:t,source:i,url:n}=e;si(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=eS,this.onError=o=>console.log(o),this.worker=lu?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=eS,this.onError=eS,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||$0(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=nA({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){let i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new $c(i,{eval:!1})}else if(this.source)e=new $c(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}};var mf=class{static isSupported(){return Ha.isSupported()}constructor(e){y(this,"name","unnamed"),y(this,"source",void 0),y(this,"url",void 0),y(this,"maxConcurrency",1),y(this,"maxMobileConcurrency",1),y(this,"onDebug",()=>{}),y(this,"reuseWorkers",!0),y(this,"props",{}),y(this,"jobQueue",[]),y(this,"idleQueue",[]),y(this,"count",0),y(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,o,a)=>n.done(a),i=(n,o)=>n.error(o)){let n=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new pf(t.name,e);e.onMessage=n=>t.onMessage(i,n.type,n.payload),e.onError=n=>t.onError(i,n),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new Ha({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return iA?this.maxMobileConcurrency:this.maxConcurrency}};var yN={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Fi=class{static isSupported(){return Ha.isSupported()}static getWorkerFarm(e={}){return Fi._workerFarm=Fi._workerFarm||new Fi({}),Fi._workerFarm.setProps(e),Fi._workerFarm}constructor(e){y(this,"props",void 0),y(this,"workerPools",new Map),this.props={...yN},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:n}=e,o=this.workerPools.get(t);return o||(o=new mf({name:t,source:i,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};y(Fi,"_workerFarm",void 0);var SN="latest";function tS(s,e={}){let t=e[s.id]||{},i="".concat(s.id,"-worker.js"),n=t.workerUrl;if(!n&&s.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(n="modules/".concat(s.module,"/dist/").concat(i)),!n){let o=s.version;o==="latest"&&(o=SN);let a=o?"@".concat(o):"";n="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(i)}return si(n),n}function rS(s,e=tA){si(s,"no worker provided");let t=s.version;return!(!e||!t)}function iS(s,e){return!Fi.isSupported()||!lu&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&e?.worker}async function nS(s,e,t,i,n){let o=s.id,a=tS(s,t),u=Fi.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));let c=await u.startJob("process-on-worker",EN.bind(null,n));return c.postMessage("process",{input:e,options:t,context:i}),await(await c.result).result}async function EN(s,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":let{id:n,input:o,options:a}=i;try{let l=await s(o,a);e.postMessage("done",{id:n,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:n,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function oS(s){return s&&typeof s=="object"&&s.isBuffer}function aA(s){return oS(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function fb(s){if(oS(s))return aA(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function sS(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let i=new Uint8Array(s),n=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==n[o])return!1;return!0}function aS(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),i=new Uint8Array(t),n=0;for(let o of e)i.set(o,n),n+=o.byteLength;return i.buffer}async function lS(s){let e=[];for await(let t of s)e.push(t);return aS(...e)}function bf(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var ja=class{constructor(e,t){y(this,"name",void 0),y(this,"type",void 0),y(this,"sampleSize",1),y(this,"time",void 0),y(this,"count",void 0),y(this,"samples",void 0),y(this,"lastTiming",void 0),y(this,"lastSampleTime",void 0),y(this,"lastSampleCount",void 0),y(this,"_count",0),y(this,"_time",0),y(this,"_samples",0),y(this,"_startTime",0),y(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=bf(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(bf()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var $i=class{constructor(e){y(this,"id",void 0),y(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:i}=e;return this.stats[t]||(e instanceof ja?this.stats[t]=e:this.stats[t]=new ja(t,i)),this.stats[t]}};var xN="Queued Requests",vN="Active Requests",CN="Cancelled Requests",AN="Queued Requests Ever",TN="Active Requests Ever",IN={id:"request-scheduler",throttleRequests:!0,maxRequests:6},eh=class{constructor(e={}){y(this,"props",void 0),y(this,"stats",void 0),y(this,"activeRequestCount",0),y(this,"requestQueue",[]),y(this,"requestMap",new Map),y(this,"deferredUpdate",null),this.props={...IN,...e},this.stats=new $i({id:this.props.id}),this.stats.get(xN),this.stats.get(vN),this.stats.get(CN),this.stats.get(AN),this.stats.get(TN)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);let i={handle:e,priority:0,getPriority:t},n=new Promise(o=>(i.resolve=o,i));return this.requestQueue.push(i),this.requestMap.set(e,n),this._issueNewRequests(),n}_issueRequest(e){let{handle:t,resolve:i}=e,n=!1,o=()=>{n||(n=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:o}):Promise.resolve({done:o})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout(()=>this._issueNewRequestsAsync(),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;let e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){let i=this.requestQueue.shift();i&&this._issueRequest(i)}}}_updateAllRequests(){let e=this.requestQueue;for(let t=0;t<e.length;++t){let i=e[t];this._updateRequest(i)||(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort((t,i)=>t.priority-i.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}};var wN="",lA={};function uS(s){for(let e in lA)if(s.startsWith(e)){let t=lA[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(wN).concat(s)),s}var gb={};CO(gb,{dirname:()=>RN,filename:()=>LN,join:()=>ON});function LN(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function RN(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function ON(...s){let e="/";return s=s.map((t,i)=>(i&&(t=t.replace(new RegExp("^".concat(e)),"")),i!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var _N=s=>typeof s=="boolean",Pf=s=>typeof s=="function",th=s=>s!==null&&typeof s=="object",cS=s=>th(s)&&s.constructor==={}.constructor;var uA=s=>s&&typeof s[Symbol.iterator]=="function",cA=s=>s&&typeof s[Symbol.asyncIterator]=="function";var $n=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var eo=s=>typeof Blob<"u"&&s instanceof Blob,hA=s=>s&&typeof s=="object"&&s.isBuffer;var NN=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||th(s)&&Pf(s.tee)&&Pf(s.cancel)&&Pf(s.getReader);var MN=s=>th(s)&&Pf(s.read)&&Pf(s.pipe)&&_N(s.readable),pb=s=>NN(s)||MN(s);var BN=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,DN=/^([-\w.]+\/[-\w.+]+)/;function dA(s){let e=DN.exec(s);return e?e[1]:s}function hS(s){let e=BN.exec(s);return e?e[1]:""}var FN=/\?.*/;function uu(s){if($n(s)){let e=dS(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:dA(t)||hS(e)}}return eo(s)?{url:dS(s.name||""),type:s.type||""}:typeof s=="string"?{url:dS(s),type:hS(s)}:{url:"",type:""}}function fA(s){return $n(s)?s.headers["content-length"]||-1:eo(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function dS(s){return s.replace(FN,"")}async function mb(s){if($n(s))return s;let e={},t=fA(s);t>=0&&(e["content-length"]=String(t));let{url:i,type:n}=uu(s);n&&(e["content-type"]=n);let o=await VN(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:i}),a}async function gA(s){if(!s.ok){let e=await GN(s);throw new Error(e)}}async function GN(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),i=s.statusText;t.includes("application/json")&&(i+=" ".concat(await s.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function VN(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(i=>{let n=new FileReader;n.onload=o=>{var a;return i(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},n.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),i=kN(t);return"data:base64,".concat(i)}return null}function kN(s){let e="",t=new Uint8Array(s);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function fS(s,e){if(typeof s=="string"){s=uS(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await mb(s)}function yf(s){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;let e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}function hr(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||yf()}var qa={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process};var UN=qa.self||qa.window||qa.global,rh=qa.window||qa.self||qa.global,zN=qa.document||{},cu=qa.process||{};var bb=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",_be=hr();var gS=globalThis;function ih(s){if(!s&&!hr())return"Node";if(yf(s))return"Electron";let t=s||(typeof navigator<"u"?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";let i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n?"IE":gS.chrome?"Chrome":gS.safari?"Safari":gS.mozInnerScreenX?"Firefox":"Unknown"}function WN(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var Sf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";y(this,"storage",void 0),y(this,"id",void 0),y(this,"config",{}),this.storage=WN(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function pA(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function mA(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function Pb(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,n=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>i&&(t=Math.min(t,i/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(n,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var yb;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(yb||(yb={}));function bA(s){return typeof s=="string"?yb[s.toUpperCase()]||yb.WHITE:s}function PA(s,e,t){return!hr&&typeof s=="string"&&(e&&(e=bA(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=bA(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function yA(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),i=Object.getOwnPropertyNames(t);for(let n of i)typeof s[n]=="function"&&(e.find(o=>n===o)||(s[n]=s[n].bind(s)))}function nh(s,e){if(!s)throw new Error(e||"Assertion failed")}function hu(){let s;if(hr&&"performance"in rh){var e,t;s=rh===null||rh===void 0||(e=rh.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in cu){var i;let n=cu===null||cu===void 0||(i=cu.hrtime)===null||i===void 0?void 0:i.call(cu);s=n[0]*1e3+n[1]/1e6}else s=Date.now();return s}var oh={debug:hr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},HN={enabled:!0,level:0};function Ln(){}var SA={},EA={once:!0},ai=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};y(this,"id",void 0),y(this,"VERSION",bb),y(this,"_startTs",hu()),y(this,"_deltaTs",hu()),y(this,"_storage",void 0),y(this,"userData",{}),y(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new Sf("__probe-".concat(this.id,"__"),HN),this.userData={},this.timeStamp("".concat(this.id," started")),yA(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((hu()-this._startTs).toPrecision(10))}getDelta(){return Number((hu()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){nh(e,t)}warn(e){return this._getLogFunction(0,e,oh.warn,arguments,EA)}error(e){return this._getLogFunction(0,e,oh.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,oh.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,oh.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),o=2;o<i;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,oh.debug||oh.info,arguments,EA)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Ln,i&&[i],{tag:YN(t)}):Ln}image(e){let{logLevel:t,priority:i,image:n,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?hr?XN({image:n,message:o,scale:a}):qN({image:n,message:o,scale:a}):Ln}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Ln)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},n=xA({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Ln)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=vA(e)}_getLogFunction(e,t,i,n,o){if(this._shouldLog(e)){o=xA({logLevel:e,message:t,args:n,opts:o}),i=i||o.method,nh(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=hu();let a=o.tag||o.message;if(o.once)if(!SA[a])SA[a]=hu();else return Ln;return t=jN(this.id,o.message,o),i.bind(console,t,...o.args)}return Ln}};y(ai,"VERSION",bb);function vA(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return nh(Number.isFinite(e)&&e>=0),e}function xA(s){let{logLevel:e,message:t}=s;s.logLevel=vA(e);let i=s.args?Array.from(s.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let n=typeof s.message;return nh(n==="string"||n==="object"),Object.assign(s,{args:i},s.opts)}function jN(s,e,t){if(typeof e=="string"){let i=t.time?mA(pA(t.total)):"";e=t.time?"".concat(s,": ").concat(i,"  ").concat(e):"".concat(s,": ").concat(e),e=PA(e,t.color,t.background)}return e}function qN(s){let{image:e,message:t="",scale:i=1}=s,n=null;try{n=module.require("asciify-image")}catch{}return n?()=>n(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):Ln}function XN(s){let{image:e,message:t="",scale:i=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=Pb(o,t,i);console.log(...a)},o.src=e,Ln}let n=e.nodeName||"";if(n.toLowerCase()==="img")return console.log(...Pb(e,t,i)),Ln;if(n.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...Pb(o,t,i)),o.src=e.toDataURL(),Ln}return Ln}function YN(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var hPe=new ai({id:"@probe.gl/log"});var pS=new ai({id:"loaders.gl"}),Sb=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},Eb=class{constructor(){y(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var mS={fetch:null,mimeType:void 0,nothrow:!1,log:new Eb,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:au,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},CA={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function bS(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var IA=()=>{let s=bS();return s.globalOptions=s.globalOptions||{...mS},s.globalOptions};function wA(s,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],KN(s,t),QN(e,s,i)}function xb(s,e){let t=IA(),i=s||t;return typeof i.fetch=="function"?i.fetch:th(i.fetch)?n=>fS(n,i):e!=null&&e.fetch?e?.fetch:fS}function KN(s,e){AA(s,null,mS,CA,e);for(let t of e){let i=s&&s[t.id]||{},n=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};AA(i,t.id,n,o,e)}}function AA(s,e,t,i,n){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&th(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in i)pS.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(i[l],"'"))();else if(!u){let d=ZN(l,n);pS.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function ZN(s,e){let t=s.toLowerCase(),i="";for(let n of e)for(let o in n.options){if(s===o)return"Did you mean '".concat(n.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(i=i||"Did you mean '".concat(n.id,".").concat(o,"'?"))}return i}function QN(s,e,t){let n={...s.options||{}};return JN(n,t),n.log===null&&(n.log=new Sb),TA(n,IA()),TA(n,e),n}function TA(s,e){for(let t in e)if(t in e){let i=e[t];cS(i)&&cS(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function JN(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function Ef(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function xf(s){var e,t;Wa(s,"null loader"),Wa(Ef(s),"invalid loader");let i;return Array.isArray(s)&&(i=s[1],s=s[0],s={...s,options:{...s.options,...i}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var LA=()=>{let s=bS();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function PS(s){let e=LA();s=Array.isArray(s)?s:[s];for(let t of s){let i=xf(t);e.find(n=>i===n)||e.unshift(i)}}function RA(){return LA()}var OA=new ai({id:"loaders.gl"});var $N=/\.([^.]+)$/;async function MA(s,e=[],t,i){if(!BA(s))return null;let n=_A(s,e,{...t,nothrow:!0},i);if(n)return n;if(eo(s)&&(s=await s.slice(0,10).arrayBuffer(),n=_A(s,e,t,i)),!n&&!(t!=null&&t.nothrow))throw new Error(DA(s));return n}function _A(s,e=[],t,i){if(!BA(s))return null;if(e&&!Array.isArray(e))return xf(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...RA()),tM(n);let o=eM(s,n,t,i);if(!o&&!(t!=null&&t.nothrow))throw new Error(DA(s));return o}function eM(s,e,t,i){let{url:n,type:o}=uu(s),a=n||i?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=yS(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||rM(e,a),u=u||(l?"matched url ".concat(a):""),l=l||yS(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||nM(e,s),u=u||(l?"matched initial data ".concat(FA(s)):""),l=l||yS(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;OA.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function BA(s){return!(s instanceof Response&&s.status===204)}function DA(s){let{url:e,type:t}=uu(s),i="No valid loader found (";i+=e?"".concat(gb.filename(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let n=s?FA(s):"";return i+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",i+=")",i}function tM(s){for(let e of s)xf(e)}function rM(s,e){let t=e&&$N.exec(e),i=t&&t[1];return i?iM(s,i):null}function iM(s,e){e=e.toLowerCase();for(let t of s)for(let i of t.extensions)if(i.toLowerCase()===e)return t;return null}function yS(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function nM(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(oM(e,t))return t}else if(ArrayBuffer.isView(e)){if(NA(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&NA(e,0,t))return t;return null}function oM(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>s.startsWith(i))}function NA(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>sM(s,e,t,n))}function sM(s,e,t,i){if(i instanceof ArrayBuffer)return sS(i,s,i.byteLength);switch(typeof i){case"function":return i(s,t);case"string":let n=SS(s,e,i.length);return i===n;default:return!1}}function FA(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?SS(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?SS(s,0,e):""}function SS(s,e,t){if(s.byteLength<e+t)return"";let i=new DataView(s),n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i.getUint8(e+o));return n}function*GA(s,e){let t=e?.chunkSize||262144,i=0,n=new TextEncoder;for(;i<s.length;){let o=Math.min(s.length-i,t),a=s.slice(i,i+o);i+=o,yield n.encode(a)}}function*VA(s,e={}){let{chunkSize:t=262144}=e,i=0;for(;i<s.byteLength;){let n=Math.min(s.byteLength-i,t),o=new ArrayBuffer(n),a=new Uint8Array(s,i,n);new Uint8Array(o).set(a),i+=n,yield o}}async function*kA(s,e){let t=e?.chunkSize||1048576,i=0;for(;i<s.size;){let n=i+t,o=await s.slice(i,n).arrayBuffer();i=n,yield o}}function ES(s,e){return au?aM(s,e):lM(s,e)}async function*aM(s,e){let t=s.getReader(),i;try{for(;;){let n=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());let{done:o,value:a}=await n;if(o)return;yield fb(a)}}catch{t.releaseLock()}}async function*lM(s,e){for await(let t of s)yield fb(t)}function UA(s,e){if(typeof s=="string")return GA(s,e);if(s instanceof ArrayBuffer)return VA(s,e);if(eo(s))return kA(s,e);if(pb(s))return ES(s,e);if($n(s))return ES(s.body,e);throw new Error("makeIterator")}var zA="Cannot convert supplied data type";function uM(s,e,t){if(e.text&&typeof s=="string")return s;if(hA(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let i=s.buffer,n=s.byteLength||s.length;return(s.byteOffset!==0||n!==i.byteLength)&&(i=i.slice(s.byteOffset,s.byteOffset+n)),i}throw new Error(zA)}async function WA(s,e,t){let i=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||i)return uM(s,e,t);if(eo(s)&&(s=await mb(s)),$n(s)){let n=s;return await gA(n),e.binary?await n.arrayBuffer():await n.text()}if(pb(s)&&(s=UA(s,t)),uA(s)||cA(s))return lS(s);throw new Error(zA)}function HA(s,e,t=null){if(t)return t;let i={fetch:xb(e,s),...s};return Array.isArray(i.loaders)||(i.loaders=null),i}function jA(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function vb(s,e,t,i){si(!i||typeof i=="object"),e&&!Array.isArray(e)&&!Ef(e)&&(i=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:n}=uu(s),a=jA(e,i),l=await MA(s,a,t);return l?(t=wA(t,l,a,n),i=HA({url:n,parse:vb,loaders:a},t,i),await cM(l,s,t,i)):null}async function cM(s,e,t,i){if(rS(s),$n(e)){let n=e,{ok:o,redirected:a,status:l,statusText:u,type:c,url:h}=n,d=Object.fromEntries(n.headers.entries());i.response={headers:d,ok:o,redirected:a,status:l,statusText:u,type:c,url:h}}if(e=await WA(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,i,s);if(iS(s,t))return await nS(s,e,t,i,vb);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,i,s);if(s.parse)return await s.parse(e,t,i,s);throw si(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function Zo(s,e,t,i){!Array.isArray(e)&&!Ef(e)&&(i=void 0,t=e,e=void 0);let n=xb(t),o=s;return typeof s=="string"&&(o=await n(s)),eo(s)&&(o=await n(s)),await vb(o,e,t)}var qA="3.2.12";var{_parseImageNode:hM}=globalThis,xS=typeof Image<"u",vS=typeof ImageBitmap<"u",dM=Boolean(hM),CS=au?!0:dM;function XA(s){switch(s){case"auto":return vS||xS||CS;case"imagebitmap":return vS;case"image":return xS;case"data":return CS;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function YA(){if(vS)return"imagebitmap";if(xS)return"image";if(CS)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function fM(s){let e=gM(s);if(!e)throw new Error("Not an image");return e}function KA(s){switch(fM(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function gM(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var pM=/^data:image\/svg\+xml/,mM=/\.svg((\?|#).*)?$/;function Cb(s){return s&&(pM.test(s)||mM.test(s))}function ZA(s,e){if(Cb(e)){let i=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return AS(s,e)}function AS(s,e){if(Cb(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function vf(s,e,t){let i=ZA(s,t),n=self.URL||self.webkitURL,o=typeof i!="string"&&n.createObjectURL(i);try{return await bM(o||i,e)}finally{o&&n.revokeObjectURL(o)}}async function bM(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,n)=>{try{t.onload=()=>i(t),t.onerror=o=>n(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){n(o)}})}var PM={},QA=!0;async function TS(s,e,t){let i;Cb(t)?i=await vf(s,e,t):i=AS(s,t);let n=e&&e.imagebitmap;return await yM(i,n)}async function yM(s,e=null){if((SM(e)||!QA)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),QA=!1}return await createImageBitmap(s)}function SM(s){for(let e in s||PM)return!1;return!0}function Ab(s){let e=Cf(s);return EM(e)||CM(e)||xM(e)||vM(e)}function EM(s){let e=Cf(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function xM(s){let e=Cf(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function vM(s){let e=Cf(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function CM(s){let e=Cf(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:i,sofMarkers:n}=AM(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(n.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!i.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function AM(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Cf(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function IS(s,e){let{mimeType:t}=Ab(s)||{},i=globalThis._parseImageNode;return Wa(i),await i(s,t)}async function wS(s,e,t){e=e||{};let n=(e.image||{}).type||"auto",{url:o}=t||{},a=TM(n),l;switch(a){case"imagebitmap":l=await TS(s,e,o);break;case"image":l=await vf(s,e,o);break;case"data":l=await IS(s,e);break;default:Wa(!1)}return n==="data"&&(l=KA(l)),l}function TM(s){switch(s){case"auto":case"data":return YA();default:return XA(s),s}}var IM=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],wM=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],LM={image:{type:"auto",decode:!0}},du={id:"image",module:"images",name:"Images",version:qA,mimeTypes:wM,extensions:IM,parse:wS,tests:[s=>Boolean(Ab(new DataView(s)))],options:LM};var de=new ai({id:"deck"});var LS={};function JA(s){LS=s}function kt(s,e,t,i){de.level>0&&LS[s]&&LS[s].call(null,e,t,i)}function RM(s){let e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}var $A={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:RM,parseTextSync:JSON.parse};var Af="8.8.20",Tb=globalThis.deck&&globalThis.deck.VERSION;if(Tb&&Tb!==Af)throw new Error("deck.gl - multiple versions detected: ".concat(Tb," vs ").concat(Af));Tb||(de.log(1,"deck.gl ".concat(Af))(),globalThis.deck={...globalThis.deck,VERSION:Af,version:Af,log:de,_registerLoggers:JA},PS([$A,[du,{imagebitmap:{premultiplyAlpha:"none"}}]]));var e1=globalThis.deck;var ne=new ai({id:"luma.gl"});function qt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var OM="Invalid WebGLRenderingContext";var _M="Requires WebGL2";function _s(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function fe(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function RS(s){return fe(s)?s:null}function Ns(s){return qt(_s(s),OM),s}function St(s){return qt(fe(s),_M),s}var Tf={};function NM(s){globalThis.console&&globalThis.console.error&&globalThis.console.error(s)}function MM(s){globalThis.console&&globalThis.console.log&&globalThis.console.log(s)}function BM(s,e){Tf[s]=!0,e!==void 0&&NM(e)}function DM(s){let e=s.getError;s.getError=function(){let i;do i=e.apply(s),i!==0&&(Tf[i]=!0);while(i!==0);for(i in Tf)if(Tf[i])return delete Tf[i],parseInt(i,10);return 0}}var If=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){let n=new s.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};If.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};If.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var fu=function(e){let t=this;this.gl=e,DM(e);let i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let f=d.attribs[o];return f.buffer=t.currentArrayBuffer,f.size=a,f.type=l,f.normalized=u,f.stride=c,f.offset=h,f.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{MM("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};fu.prototype.VERTEX_ARRAY_BINDING_OES=34229;fu.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new If(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};fu.prototype.createVertexArrayOES=function(){let e=new If(this);return this.vertexArrayObjects.push(e),e};fu.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};fu.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof If&&e.hasBeenBound&&e.ext===this)};fu.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){BM(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(n===o)return;(!n||o.elementArrayBuffer!==n.elementArrayBuffer)&&i.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(n?n.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=n?n.attribs[u]:null;if((!n||c.enabled!==h.enabled)&&(c.enabled?i.enableVertexAttribArray.call(t,u):i.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!n||c.buffer!==h.buffer)&&(a!==c.buffer&&(i.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&i.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};function t1(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let n=e.call(this)||[];return n.indexOf("OES_vertex_array_object")<0&&n.push("OES_vertex_array_object"),n};let t=s.getExtension;s.getExtension=function(n){let o=t.call(this,n);return o||(n!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new fu(this)),this.__OESVertexArrayObject))}}var r1="OES_element_index",i1="WEBGL_draw_buffers",FM="EXT_disjoint_timer_query",GM="EXT_disjoint_timer_query_webgl2",VM="EXT_texture_filter_anisotropic",n1="WEBGL_debug_renderer_info",kM=35723,UM=4352,zM=36795,WM=34047,HM=37445,jM=37446,dt=s=>fe(s)?void 0:0,qM={[3074]:s=>fe(s)?void 0:36064,[kM]:s=>fe(s)?void 0:UM,[35977]:dt,[32937]:dt,[zM]:(s,e)=>{let t=fe(s)?s.getExtension(GM):s.getExtension(FM);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[HM]:(s,e)=>{let t=s.getExtension(n1);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[jM]:(s,e)=>{let t=s.getExtension(n1);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[WM]:(s,e)=>{let t=s.luma.extensions[VM];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:dt,[35071]:dt,[37447]:dt,[36063]:(s,e)=>{if(!fe(s)){let t=s.getExtension(i1);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:dt,[35374]:dt,[35377]:dt,[34852]:s=>{if(!fe(s)){let e=s.getExtension(i1);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(r1)?2147483647:65535,[33001]:s=>s.getExtension(r1)?16777216:65535,[33e3]:s=>16777216,[37157]:dt,[35373]:dt,[35657]:dt,[36183]:dt,[37137]:dt,[34045]:dt,[35978]:dt,[35979]:dt,[35968]:dt,[35376]:dt,[35375]:dt,[35659]:dt,[37154]:dt,[35371]:dt,[35658]:dt,[35076]:dt,[35077]:dt,[35380]:dt};function o1(s,e,t){let i=qM[t],n=typeof i=="function"?i(s,e,t):i;return n!==void 0?n:e(t)}var XM="OES_vertex_array_object",s1="ANGLE_instanced_arrays",YM="WEBGL_draw_buffers",KM="EXT_disjoint_timer_query",ZM="EXT_texture_filter_anisotropic",QM="VertexArray requires WebGL2 or OES_vertex_array_object extension";function JM(s,e){return{webgl2:fe(s),ext:s.getExtension(e)}}var OS={[XM]:{meta:{suffix:"OES"},createVertexArray:()=>{qt(!1,QM)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[s1]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){qt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[YM]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{qt(!1)}},[KM]:{meta:{suffix:"EXT"},createQuery:()=>{qt(!1)},deleteQuery:()=>{qt(!1)},beginQuery:()=>{qt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},Ib={readBuffer:(s,e,t)=>{fe(s)&&e(t)},getVertexAttrib:(s,e,t,i)=>{let{webgl2:n,ext:o}=JM(s,s1),a;switch(i){case 35069:a=n?void 0:!1;break;case 35070:a=!n&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,i)},getProgramParameter:(s,e,t,i)=>{if(!fe(s))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,i)},getInternalformatParameter:(s,e,t,i,n)=>{if(!fe(s))switch(n){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,i,n)},getTexParameter(s,e,t,i){switch(i){case 34046:let{extensions:n}=s.luma,o=n[ZM];i=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,i)},getParameter:o1,hint(s,e,t,i){return e(t,i)}};function a1(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(t1(s),$M(s),tB(s,OS),eB(s,{target:e,target2:s}),e.polyfilled=!0),s}globalThis.polyfillContext=a1;function $M(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function eB(s,e){let{target:t,target2:i}=e;Object.keys(Ib).forEach(n=>{if(typeof Ib[n]=="function"){let o=s[n]?s[n].bind(s):()=>{},a=Ib[n].bind(null,s,o);t[n]=a,i[n]=a}})}function tB(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&rB(s,{extension:t,target:s.luma,target2:s})}function rB(s,e){let{extension:t,target:i,target2:n}=e,o=OS[t];qt(o);let{meta:a={}}=o,{suffix:l=""}=a,u=s.getExtension(t);for(let c of Object.keys(o)){let h="".concat(c).concat(l),d=null;c==="meta"||typeof s[c]=="function"||(u&&typeof u[h]=="function"?d=function(){return u[h](...arguments)}:typeof o[c]=="function"&&(d=o[c].bind(i))),d&&(i[c]=d,n[c]=d)}}var Lf={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Xa=(s,e,t)=>e?s.enable(t):s.disable(t),l1=(s,e,t)=>s.hint(t,e),en=(s,e,t)=>s.pixelStorei(t,e),iB=(s,e)=>{let t=fe(s)?36009:36160;return s.bindFramebuffer(t,e)},nB=(s,e)=>s.bindFramebuffer(36008,e);function wf(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var u1={[3042]:Xa,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Xa,[2885]:(s,e)=>s.cullFace(e),[2929]:Xa,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Xa,[35723]:l1,[36006]:iB,[2886]:(s,e)=>s.frontFace(e),[33170]:l1,[2849]:(s,e)=>s.lineWidth(e),[32823]:Xa,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Xa,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Xa,[3088]:(s,e)=>s.scissor(...e),[2960]:Xa,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:en,[3317]:en,[37440]:en,[37441]:en,[37443]:en,[3330]:en,[3332]:en,[3331]:en,[36010]:nB,[3314]:en,[32878]:en,[3316]:en,[3315]:en,[32877]:en,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=wf(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=wf(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=wf(e)?e:[e,e];let[t,i]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,i)},stencilFunc:(s,e)=>{e=wf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilFuncSeparate(1028,t,i,n),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=wf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilOpSeparate(1028,t,i,n),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function Ut(s,e,t){return e[s]!==void 0?e[s]:t[s]}var c1={blendEquation:(s,e,t)=>s.blendEquationSeparate(Ut(32777,e,t),Ut(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(Ut(32969,e,t),Ut(32968,e,t),Ut(32971,e,t),Ut(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(Ut(32824,e,t),Ut(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(Ut(32938,e,t),Ut(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,Ut(2962,e,t),Ut(2967,e,t),Ut(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,Ut(34816,e,t),Ut(36003,e,t),Ut(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,Ut(2964,e,t),Ut(2965,e,t),Ut(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,Ut(34817,e,t),Ut(34818,e,t),Ut(34819,e,t))},_S={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,i,n)=>s({[32773]:new Float32Array([e,t,i,n])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,i,n)=>s({[32969]:e,[32968]:t,[32971]:i,[32970]:n}),clearColor:(s,e,t,i,n)=>s({[3106]:new Float32Array([e,t,i,n])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,i,n)=>s({[3107]:[e,t,i,n]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,i,n)=>s({[3088]:new Int32Array([e,t,i,n])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,i)=>s({[2962]:e,[2967]:t,[2963]:i,[34816]:e,[36003]:t,[36004]:i}),stencilFuncSeparate:(s,e,t,i,n)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:n}),stencilOp:(s,e,t,i)=>s({[2964]:e,[2965]:t,[2966]:i,[34817]:e,[34818]:t,[34819]:i}),stencilOpSeparate:(s,e,t,i,n)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:n}),viewport:(s,e,t,i,n)=>s({[2978]:[e,t,i,n]})},Qo=(s,e)=>s.isEnabled(e),NS={[3042]:Qo,[2884]:Qo,[2929]:Qo,[3024]:Qo,[32823]:Qo,[32926]:Qo,[32928]:Qo,[3089]:Qo,[2960]:Qo,[35977]:Qo};function MS(s){for(let e in s)return!1;return!0}function h1(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&s.length===e.length){for(let n=0;n<s.length;++n)if(s[n]!==e[n])return!1;return!0}return!1}function d1(s,e){let t=s[e].bind(s);s[e]=function(){let n=arguments.length<=0?void 0:arguments[0];return n in s.state.cache?s.state.enable?s.state.cache[n]:t(...arguments):t(...arguments)},Object.defineProperty(s[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function oB(s,e,t){let i=s[e].bind(s);s[e]=function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];let{valueChanged:u,oldValue:c}=t(s.state._updateCache,...a);return u&&i(...a),c},Object.defineProperty(s[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}function sB(s){let e=s.useProgram.bind(s);s.useProgram=function(i){s.state.program!==i&&(e(i),s.state.program=i)}}var BS=class{constructor(e){let{copyState:t=!1,log:i=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?Rb(e):Object.assign({},Lf),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.stateStack.push({})}pop(){qt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];xi(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,i,n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){qt(o!==void 0);let a=e[o],l=this.cache[o];h1(a,l)||(t=!0,i=l,n&&!(o in n)&&(n[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:i}}};function wb(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{enable:t=!0,copyState:i}=e;if(qt(i!==void 0),!s.state){let{polyfillContext:n}=globalThis;n&&n(s),s.state=new BS(s,{copyState:i}),sB(s);for(let o in _S){let a=_S[o];oB(s,o,a)}d1(s,"getParameter"),d1(s,"isEnabled")}return s.state.enable=t,s}function DS(s){s.state||wb(s,{copyState:!1}),s.state.push()}function Lb(s){qt(s.state),s.state.pop()}function xi(s,e){if(qt(_s(s),"setParameters requires a WebGL context"),MS(e))return;let t={};for(let n in e){let o=Number(n),a=u1[n];a&&(typeof a=="string"?t[a]=!0:a(s,e[n],o))}let i=s.state&&s.state.cache;if(i)for(let n in t){let o=c1[n];o(s,e,i)}}function Rb(s,e){if(e=e||Lf,typeof e=="number"){let n=e,o=NS[n];return o?o(s,n):s.getParameter(n)}let t=Array.isArray(e)?e:Object.keys(e),i={};for(let n of t){let o=NS[n];i[n]=o?o(s,Number(n)):s.getParameter(Number(n))}return i}function Ob(s){xi(s,Lf)}function ft(s,e,t){if(MS(e))return t(s);let{nocatch:i=!0}=e;DS(s),xi(s,e);let n;if(i)n=t(s),Lb(s);else try{n=t(s)}finally{Lb(s)}return n}function to(s){let{luma:e}=s;if(s.canvas&&e){let{clientWidth:t}=e.canvasSizeInfo;return t?s.drawingBufferWidth/t:1}return 1}function sh(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=to(s),n=s.drawingBufferWidth,o=s.drawingBufferHeight;return aB(e,i,n,o,t)}function p1(s){let e=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(s)?s<=0?1:s:s?e:1}function aB(s,e,t,i,n){let o=f1(s[0],e,t),a=g1(s[1],e,i,n),l=f1(s[0]+1,e,t),u=l===t-1?l:l-1;l=g1(s[1]+1,e,i,n);let c;return n?(l=l===0?l:l+1,c=a,a=l):c=l===i-1?l:l-1,{x:o,y:a,width:Math.max(u-o+1,1),height:Math.max(c-a+1,1)}}function f1(s,e,t){return Math.min(Math.round(s*e),t-1)}function g1(s,e,t,i){return i?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}var FS=hr(),lB=FS&&typeof document<"u",m1={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function ah(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};qt(FS,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),s=Object.assign({},m1,s);let{width:e,height:t}=s;function i(l){if(s.throwOnError)throw new Error(l);return console.error(l),null}s.onError=i;let n,{canvas:o}=s,a=cB({canvas:o,width:e,height:t,onError:i});return n=uB(a,s),n?(n=gu(n,s),hB(n),n):null}function gu(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!s||s._instrumented)return s;s._version=s._version||dB(s),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{},e=Object.assign({},m1,e);let{manageState:t,debug:i}=e;return t&&wb(s,{copyState:!1,log:function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return ne.log(1,...o)()}}),FS&&i&&(globalThis.makeDebugContext?(s=globalThis.makeDebugContext(s,e),ne.level=Math.max(ne.level,1)):ne.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),s._instrumented=!0,s}function b1(s){let e=s.getParameter(7936),t=s.getParameter(7937),i=s.getExtension("WEBGL_debug_renderer_info"),n=i&&s.getParameter(i.UNMASKED_VENDOR_WEBGL||7936),o=i&&s.getParameter(i.UNMASKED_RENDERER_WEBGL||7937);return{vendor:n||e,renderer:o||t,vendorMasked:e,rendererMasked:t,version:s.getParameter(7938),shadingLanguageVersion:s.getParameter(35724)}}function GS(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(s.canvas){let i=p1(e.useDevicePixels);fB(s,i,e);return}let t=s.getExtension("STACKGL_resize_drawingbuffer");t&&"width"in e&&"height"in e&&t.resize(e.width,e.height)}function uB(s,e){let{onError:t}=e,i=null,n=u=>i=u.statusMessage||i;s.addEventListener("webglcontextcreationerror",n,!1);let{webgl1:o=!0,webgl2:a=!0}=e,l=null;return a&&(l=l||s.getContext("webgl2",e),l=l||s.getContext("experimental-webgl2",e)),o&&(l=l||s.getContext("webgl",e),l=l||s.getContext("experimental-webgl",e)),s.removeEventListener("webglcontextcreationerror",n,!1),l?(e.onContextLost&&s.addEventListener("webglcontextlost",e.onContextLost,!1),e.onContextRestored&&s.addEventListener("webglcontextrestored",e.onContextRestored,!1),l):t("Failed to create ".concat(a&&!o?"WebGL2":"WebGL"," context: ").concat(i||"Unknown error"))}function cB(s){let{canvas:e,width:t=800,height:i=600,onError:n}=s,o;return typeof e=="string"?(lB&&document.readyState==="complete"||n("createGLContext called on canvas '".concat(e,"' before page was loaded")),o=document.getElementById(e)):e?o=e:(o=document.createElement("canvas"),o.id="lumagl-canvas",o.style.width=Number.isFinite(t)?"".concat(t,"px"):"100%",o.style.height=Number.isFinite(i)?"".concat(i,"px"):"100%",document.body.insertBefore(o,document.body.firstChild)),o}function hB(s){let e=fe(s)?"WebGL2":"WebGL1",t=b1(s),i=t?"(".concat(t.vendor,",").concat(t.renderer,")"):"",n=s.debug?" debug":"";ne.info(1,"".concat(e).concat(n," context ").concat(i))()}function dB(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?2:1}function fB(s,e,t){let i="width"in t?t.width:s.canvas.clientWidth,n="height"in t?t.height:s.canvas.clientHeight;(!i||!n)&&(ne.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=s.canvas.width||1,n=s.canvas.height||1),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{};let o=s.luma.canvasSizeInfo;if(o.clientWidth!==i||o.clientHeight!==n||o.devicePixelRatio!==e){let a=e,l=Math.floor(i*a),u=Math.floor(n*a);s.canvas.width=l,s.canvas.height=u,(s.drawingBufferWidth!==l||s.drawingBufferHeight!==u)&&(ne.warn("Device pixel ratio clamped")(),a=Math.min(s.drawingBufferWidth/i,s.drawingBufferHeight/n),s.canvas.width=Math.floor(i*a),s.canvas.height=Math.floor(n*a)),Object.assign(s.luma.canvasSizeInfo,{clientWidth:i,clientHeight:n,devicePixelRatio:e})}}var Rf="8.5.16",gB="set luma.log.level=1 (or higher) to trace rendering",Of=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new $i({id:e})),this.stats.get(e)}},Rn=new Of;if(globalThis.luma&&globalThis.luma.VERSION!==Rf)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(Rf));globalThis.luma||(hr()&&ne.log(1,"luma.gl ".concat(Rf," - ").concat(gB))(),globalThis.luma=globalThis.luma||{VERSION:Rf,version:Rf,log:ne,stats:Rn,globals:{modules:{},nodeIO:{}}});var nSe=globalThis.luma;function VS(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function kS(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}function J(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function _b(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let i=s[e];return J(i!==void 0,"Accessing undefined constant GL.".concat(e)),i}function On(s,e){e=Number(e);for(let t in s)if(s[t]===e)return"GL.".concat(t);return String(e)}var US={};function vi(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";US[s]=US[s]||1;let e=US[s]++;return"".concat(s,"-").concat(e)}function zS(s){return J(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function Jo(s){let e=!0;for(let t in s){e=!1;break}return e}function Nb(s,e,t,i){let n="See luma.gl ".concat(t," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),o=Object.getPrototypeOf(s);i.forEach(a=>{o.methodName||(o[a]=()=>{throw ne.removed("Calling removed method ".concat(e,".").concat(a,": "),n)(),new Error(a)})})}var lh="Resource subclass must define virtual methods",Xt=class{get[Symbol.toStringTag](){return"Resource"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ns(e);let{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||vi(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._initStats(),this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(i=>i.delete()),this}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e=_b(this.gl,e),J(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=fe(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){let l=n.webgl1,u="webgl2"in n?n.webgl2:n.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},o=fe(this.gl),a={},l=t||Object.keys(n);for(let u of l){let c=n[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=i?On(this.gl,u):u;a[d]=this.getParameter(u,e),i&&c.type==="GLenum"&&(a[d]=On(this.gl,a[d]))}}return a}setParameter(e,t){e=_b(this.gl,e),J(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=fe(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");n.type==="GLenum"&&(t=_b(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return Nb(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(lh)}_deleteHandle(){throw new Error(lh)}_bindHandle(e){throw new Error(lh)}_getOptsFromHandle(){throw new Error(lh)}_getParameter(e,t){throw new Error(lh)}_setParameter(e,t){throw new Error(lh)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_initStats(){this.gl.stats=this.gl.stats||new Of}_addStats(){let e=this[Symbol.toStringTag],t=Rn.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get("".concat(e,"s Created")).incrementCount(),t.get("".concat(e,"s Active")).incrementCount()}_removeStats(){let e=this[Symbol.toStringTag];Rn.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._doTrackAllocatedMemory(e,t),this._doTrackAllocatedMemory(e,t,this.gl.stats.get("Memory Usage"))}_doTrackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Rn.get("Memory Usage");i.get("GPU Memory").addCount(e),i.get("".concat(t," Memory")).addCount(e),this.byteLength=e}_trackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._doTrackDeallocatedMemory(e),this._doTrackDeallocatedMemory(e,this.gl.stats.get("Memory Usage"))}_doTrackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Rn.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get("".concat(e," Memory")).subtractCount(this.byteLength),this.byteLength=0}};var pB="Failed to deduce GL constant from typed array";function _f(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(pB)}}function Ya(s){let{clamped:e=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function P1(s){let{data:e,width:t,height:i,bytesPerPixel:n=4,temp:o}=s,a=t*n;o=o||new Uint8Array(a);for(let l=0;l<i/2;++l){let u=l*a,c=(i-l-1)*a;o.set(e.subarray(u,u+a)),e.copyWithin(u,c,c+a),e.set(o,c)}}function y1(s){let{data:e,width:t,height:i}=s,n=Math.round(t/2),o=Math.round(i/2),a=new Uint8Array(n*o*4);for(let l=0;l<o;l++)for(let u=0;u<n;u++)for(let c=0;c<4;c++)a[(l*n+u)*4+c]=e[(l*2*t+u*2)*4+c];return{data:a,width:n,height:o}}function Nf(s,e,t){let{removedProps:i={},deprecatedProps:n={},replacedProps:o={}}=t;for(let l in i)if(l in e){let c=i[l]?"".concat(s,".").concat(i[l]):"N/A";ne.removed("".concat(s,".").concat(l),c)()}for(let l in n)if(l in e){let u=n[l];ne.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))()}let a=null;for(let l in o)if(l in e){let u=o[l];ne.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var mB={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},bB={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},dr=class{static getBytesPerElement(e){return Ya(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return J(e.size),Ya(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new dr(mB,...t)}constructor(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach(n=>this._assign(n)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return dr.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return dr.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e=Nf("Accessor",e,bB),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var S1=10,E1={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},PB={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:E1},yB={removedProps:E1},Se=class extends Xt{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/dr.getBytesPerElement(e))}getVertexCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/dr.getBytesPerVertex(e))}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Nf("Buffer",e,PB),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Nf("Buffer",e,yB),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new dr(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:i=0,srcOffset:n=0}=e,o=e.byteLength||e.length;J(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),n!==0||o!==void 0?(St(this.gl),this.gl.bufferSubData(this.target,i,t,n,o)):this.gl.bufferSubData(a,i,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData(e){let{sourceBuffer:t,readOffset:i=0,writeOffset:n=0,size:o}=e,{gl:a}=this;return St(a),a.bindBuffer(36662,t.handle),a.bindBuffer(36663,this.handle),a.copyBufferSubData(36662,36663,i,n,o),a.bindBuffer(36662,null),a.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};St(this.gl);let o=Ya(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=i,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,n||a),c=l+u);let h=Math.min(a,u);return n=n||h,J(n<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?n!==void 0?this.gl.bindBufferRange(e,t,this.handle,i,n):(J(i===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(S1,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e.byteLength+t;J(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,S1),this.bytesUsed=i,this._trackAllocatedMemory(i);let o=_f(e);return J(o),this.setAccessor(new dr(this.accessor,{type:o})),this}_setByteLength(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;J(e>=0),this._trackDeallocatedMemory();let i=e;e===0&&(i=new Float32Array(0));let n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=Ya(this.accessor.type||5126,{clamped:!1}),i=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(e){this.accessor.type||this.setAccessor(new dr(this.accessor,{type:_f(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return ne.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return ne.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return ne.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return ne.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new dr(this.accessor,e),this}};var Mb={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},Bb={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},Db={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function x1(s,e){let t=Mb[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let i=fe(s)&&t.gl2||t.gl1;return typeof i=="string"?s.getExtension(i):i}function v1(s,e){let t=Mb[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var SB=[9729,9728],C1=globalThis.WebGLBuffer||function(){},li=class extends Xt{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{format:i,linearFiltering:n}=t,o=!0;return i&&(o=o&&x1(e,i),o=o&&(!n||v1(e,i))),o}constructor(e,t){let{id:i=vi("texture"),handle:n,target:o}=t;super(e,{id:i,handle:n}),this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data;if(t instanceof Promise)return t.then(B=>this.initialize(Object.assign({},e,{pixels:B,data:B}))),this;let i=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:n=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=n);let{width:d,height:f,dataFormat:p,type:S,compressed:x=!1,mipmaps:C=!0}=e,{depth:O=0}=e;return{width:d,height:f,compressed:x,dataFormat:p,type:S}=this._deduceParameters({format:o,type:S,dataFormat:p,compressed:x,data:t,width:d,height:f}),this.width=d,this.height=f,this.depth=O,this.format=o,this.type=S,this.dataFormat=p,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),C&&this._isNPOT()&&(ne.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),C=!1,this._updateForNPOT(u)),this.mipmaps=C,this.setImageData({data:t,width:d,height:f,depth:O,format:o,type:S,dataFormat:p,border:a,mipmaps:C,parameters:c,compressed:x}),C&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),i&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:t,width:i,mipmaps:n=!1}=e;return i!==this.width||t!==this.height?this.initialize({width:i,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(ne.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),ft(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:i=null,level:n=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:f=this.height,dataFormat:p=this.dataFormat,compressed:S=!1}=e;c||(c=i),{type:h,dataFormat:p,compressed:S,width:d,height:f}=this._deduceParameters({format:o,type:h,dataFormat:p,compressed:S,data:c,width:d,height:f});let{gl:x}=this;x.bindTexture(this.target,this.handle);let C=null;({data:c,dataType:C}=this._getDataType({data:c,compressed:S}));let O,B=0;if(ft(this.gl,u,()=>{switch(C){case"null":x.texImage2D(t,n,o,d,f,a,p,h,c);break;case"typed-array":x.texImage2D(t,n,o,d,f,a,p,h,c,l);break;case"buffer":O=St(x),O.bindBuffer(35052,c.handle||c),O.texImage2D(t,n,o,d,f,a,p,h,l),O.bindBuffer(35052,null);break;case"browser-object":fe(x)?x.texImage2D(t,n,o,d,f,a,p,h,c):x.texImage2D(t,n,o,p,h,c);break;case"compressed":for(let[I,_]of c.entries())x.compressedTexImage2D(t,I,_.format,_.width,_.height,a,_.data),B+=_.levelSize;break;default:J(!1,"Unknown image data type")}}),C==="compressed")this._trackAllocatedMemory(B,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let I=Bb[this.dataFormat]||4,_=Db[this.type]||1;this._trackAllocatedMemory(this.width*this.height*I*_,"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:t=this.target,pixels:i=null,data:n=null,x:o=0,y:a=0,width:l=this.width,height:u=this.height,level:c=0,format:h=this.format,type:d=this.type,dataFormat:f=this.dataFormat,compressed:p=!1,offset:S=0,border:x=this.border,parameters:C={}}=e;if({type:d,dataFormat:f,compressed:p,width:l,height:u}=this._deduceParameters({format:h,type:d,dataFormat:f,compressed:p,data:n,width:l,height:u}),J(this.depth===0,"texSubImage not supported for 3D textures"),n||(n=i),n&&n.data){let O=n;n=O.data,l=O.shape[0],u=O.shape[1]}n instanceof Se&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),ft(this.gl,C,()=>{if(p)this.gl.compressedTexSubImage2D(t,c,o,a,l,u,h,n);else if(n===null)this.gl.texSubImage2D(t,c,o,a,l,u,f,d,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(t,c,o,a,l,u,f,d,n,S);else if(n instanceof C1){let O=St(this.gl);O.bindBuffer(35052,n),O.texSubImage2D(t,c,o,a,l,u,f,d,S),O.bindBuffer(35052,null)}else fe(this.gl)?St(this.gl).texSubImage2D(t,c,o,a,l,u,f,d,n):this.gl.texSubImage2D(t,c,o,a,f,d,n)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType(e){let{data:t,compressed:i=!1}=e;return i?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof Se?{data:t.handle,dataType:"buffer"}:t instanceof C1?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:i}=e,{width:n,height:o,dataFormat:a,type:l,compressed:u}=e,c=Mb[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:n,height:o}=this._deduceImageSize(i,n,o),{dataFormat:a,type:l,compressed:u,width:n,height:o,format:t,data:i}}_deduceImageSize(e,t,i){let n;return typeof ImageData<"u"&&e instanceof ImageData?n={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?n={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?n={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?n={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?n={width:e.videoWidth,height:e.videoHeight}:e?n={width:t,height:i}:n={width:t>=0?t:1,height:i>=0?i:1},J(n,"Could not deduced texture size"),J(t===void 0||n.width===t,"Deduced texture width does not match supplied width"),J(i===void 0||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:J(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return fe(this.gl)||!this.width||!this.height?!1:!zS(this.width)||!zS(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:SB.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var EB="";function A1(s,e){return J(typeof s=="string"),s=EB+s,new Promise((t,i)=>{try{let n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error("Could not load image ".concat(s,"."))),n.crossOrigin=e&&e.crossOrigin||"anonymous",n.src=s}catch(n){i(n)}})}var Ve=class extends li{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return li.isSupported(e,t)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ns(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:A1(t.data)})),super(e,Object.assign({},t,{target:3553})),this.initialize(t),Object.seal(this)}};var WS=[34069,34070,34071,34072,34073,34074],pu=class extends li{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ns(e),super(e,Object.assign({},t,{target:34067})),this.initialize(t),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)}),this}subImage(e){let{face:t,data:i,x:n=0,y:o=0,mipmapLevel:a=0}=e;return this._subImage({target:t,data:i,x:n,y:o,mipmapLevel:a})}async setCubeMapImageData(e){let{width:t,height:i,pixels:n,data:o,border:a=0,format:l=6408,type:u=5121}=e,{gl:c}=this,h=n||o,d=await Promise.all(WS.map(f=>{let p=h[f];return Promise.all(Array.isArray(p)?p:[p])}));this.bind(),WS.forEach((f,p)=>{d[p].length>1&&this.opts.mipmaps!==!1&&ne.warn("".concat(this.id," has mipmap and multiple LODs."))(),d[p].forEach((S,x)=>{t&&i?c.texImage2D(f,x,l,t,i,a,l,u,S):c.texImage2D(f,x,l,l,u,S)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:i,height:n,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(f=>this.setImageDataForFace(Object.assign({},e,{face:t,data:f,pixels:f}))):this.width||this.height?h.texImage2D(t,0,u,i,n,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};pu.FACES=WS;var uh=class extends li{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};St(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1}),super(e,t),this.initialize(t),Object.seal(this)}setImageData(e){let{level:t=0,dataFormat:i=6408,width:n,height:o,depth:a=1,border:l=0,format:u,type:c=5121,offset:h=0,data:d,parameters:f={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),ft(this.gl,f,()=>{ArrayBuffer.isView(d)&&this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,d),d instanceof Se&&(this.gl.bindBuffer(35052,d.handle),this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,h))}),d&&d.byteLength)this._trackAllocatedMemory(d.byteLength,"Texture");else{let p=Bb[this.dataFormat]||4,S=Db[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*p*S,"Texture")}return this.loaded=!0,this}};var mu="EXT_color_buffer_float",HS={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:mu,bpp:2},[33327]:{gl2:mu,bpp:4},[34842]:{gl2:mu,bpp:8},[33326]:{gl2:mu,bpp:4},[33328]:{gl2:mu,bpp:8},[34836]:{gl2:mu,bpp:16},[35898]:{gl2:mu,bpp:4}};function xB(s,e,t){let i=t[e];if(!i)return!1;let n=fe(s)&&i.gl2||i.gl1;return typeof n=="string"?s.getExtension(n):n}var Gi=class extends Xt{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!t||xB(e,t,HS)}static getSamplesForFormat(e,t){let{format:i}=t;return e.getInternalformatParameter(36161,i,32937)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.initialize(t),Object.seal(this)}initialize(e){let{format:t,width:i=1,height:n=1,samples:o=0}=e;return J(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),o!==0&&fe(this.gl)?this.gl.renderbufferStorageMultisample(36161,o,t,i,n):this.gl.renderbufferStorage(36161,t,i,n),this.format=t,this.width=i,this.height=n,this.samples=o,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*HS[this.format].bpp),this}resize(e){let{width:t,height:i}=e;return t!==this.width||i!==this.height?this.initialize({width:t,height:i,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var vB=256,CB=1024,AB=16384,T1=6144,I1=6145,w1=6146,L1=34041,R1="clear: bad arguments";function Ka(s){let{framebuffer:e=null,color:t=null,depth:i=null,stencil:n=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o={};e&&(o.framebuffer=e);let a=0;t&&(a|=AB,t!==!0&&(o.clearColor=t)),i&&(a|=vB,i!==!0&&(o.clearDepth=i)),n&&(a|=CB,i!==!0&&(o.clearStencil=i)),J(a!==0,R1),ft(s,o,()=>{s.clear(a)})}function jS(s){let{framebuffer:e=null,buffer:t=T1,drawBuffer:i=0,value:n=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};St(s),ft(s,{framebuffer:e},()=>{switch(t){case T1:switch(n.constructor){case Int32Array:s.clearBufferiv(t,i,n);break;case Uint32Array:s.clearBufferuiv(t,i,n);break;case Float32Array:default:s.clearBufferfv(t,i,n)}break;case I1:s.clearBufferfv(I1,0,[n]);break;case w1:s.clearBufferiv(w1,0,[n]);break;case L1:let[o,a]=n;s.clearBufferfi(L1,0,o,a);break;default:J(!1,R1)}})}function O1(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return J(!1),0}}function Ms(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{sourceX:t=0,sourceY:i=0,sourceFormat:n=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=_1(s);J(h);let{gl:f,handle:p,attachments:S}=h;l=l||h.width,u=u||h.height,o===36064&&p===null&&(o=1028),J(S[o]),c=c||S[o].type,a=TB(a,c,n,l,u),c=c||_f(a);let x=f.bindFramebuffer(36160,p);return f.readPixels(t,i,l,u,n,c,a),f.bindFramebuffer(36160,x||null),d&&h.delete(),a}function Fb(s){let{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=Ms(s,{sourceAttachment:e}),{width:n,height:o}=s;for(;o>t;)({data:i,width:n,height:o}=y1({data:i,width:n,height:o}));P1({data:i,width:n,height:o});let a=document.createElement("canvas");a.width=n,a.height=o;let l=a.getContext("2d"),u=l.createImageData(n,o);return u.data.set(i),l.putImageData(u,0,0),a.toDataURL()}function Gb(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{sourceX:i=0,sourceY:n=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:f,deleteFramebuffer:p}=_1(s);J(f);let{gl:S,handle:x}=f,C=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let O=S.bindFramebuffer(36160,x);J(e);let B=null;if(e instanceof li&&(B=e,h=Number.isFinite(h)?h:B.width,d=Number.isFinite(d)?d:B.height,B.bind(0),e=B.target),!C)S.copyTexImage2D(e,o,a,i,n,h,d,0);else switch(e){case 3553:case 34067:S.copyTexSubImage2D(e,o,l,u,i,n,h,d);break;case 35866:case 32879:St(S).copyTexSubImage3D(e,o,l,u,c,i,n,h,d);break;default:}return B&&B.unbind(),S.bindFramebuffer(36160,O||null),p&&f.delete(),B}function _1(s){return s instanceof Me?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:N1(s),deleteFramebuffer:!0}}function TB(s,e,t,i,n){if(s)return s;e=e||5121;let o=Ya(e,{clamped:!1}),a=O1(t);return new o(i*n*a)}var $e={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function IB(s){let e=new Ve(s,{format:6408,type:5126,dataFormat:6408}),t=new Me(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),i=t.getStatus();return e.delete(),t.delete(),i===36053}var qS={[$e.WEBGL2]:[!1,!0],[$e.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[$e.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[$e.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[$e.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[$e.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[$e.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[$e.FLOAT_BLEND]:["EXT_float_blend"],[$e.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[$e.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[$e.TEXTURE_FLOAT]:["OES_texture_float",!0],[$e.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[$e.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[$e.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[$e.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[$e.COLOR_ATTACHMENT_RGBA32F]:[IB,"EXT_color_buffer_float"],[$e.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[$e.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[$e.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[$e.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[$e.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[$e.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var wB=2;function Mf(s,e){return Za(s,e)}function Za(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>M1(s,t))}function Vb(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in qS)s.luma.caps[e]===void 0&&(s.luma.caps[e]=M1(s,e));return s.luma.caps}function M1(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=LB(s,e)),s.luma.caps[e]||ne.log(wB,"Feature: ".concat(e," not supported"))(),s.luma.caps[e]}function LB(s,e){let t=qS[e];J(t,e);let i,n=fe(s)&&t[1]||t[0];if(typeof n=="function")i=n(s);else if(Array.isArray(n)){i=!0;for(let o of n)i=i&&Boolean(s.getExtension(o))}else typeof n=="string"?i=Boolean(s.getExtension(n)):typeof n=="boolean"?i=n:J(!1);return i}var B1="Multiple render targets not supported",Me=class extends Xt{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{colorBufferFloat:i,colorBufferHalfFloat:n}=t,o=!0;return i&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new Me(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=St(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=St(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:t=1,height:i=1,attachments:n=null,color:o=!0,depth:a=!0,stencil:l=!1,check:u=!0,readBuffer:c=void 0,drawBuffers:h=void 0}=e;if(J(t>=0&&i>=0,"Width and height need to be integers"),this.width=t,this.height=i,n)for(let d in n){let f=n[d];(Array.isArray(f)?f[0]:f).resize({width:t,height:i})}else n=this._createDefaultAttachments(o,a,l,t,i);this.update({clearAttachments:!0,attachments:n,readBuffer:c,drawBuffers:h}),n&&u&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:t={},readBuffer:i,drawBuffers:n,clearAttachments:o=!1,resizeAttachments:a=!0}=e;this.attach(t,{clearAttachments:o,resizeAttachments:a});let{gl:l}=this,u=l.bindFramebuffer(36160,this.handle);return i&&this._setReadBuffer(i),n&&this._setDrawBuffers(n),l.bindFramebuffer(36160,u||null),this}resize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:t,height:i}=e;if(this.handle===null)return J(t===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&ne.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(t,"x").concat(i))();for(let n in this.attachments)this.attachments[n].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e){let{clearAttachments:t=!1,resizeAttachments:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={};t&&Object.keys(this.attachments).forEach(a=>{n[a]=null}),Object.assign(n,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in n){J(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=n[l],c=u;if(!c)this._unattach(l);else if(c instanceof Gi)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,f=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:f})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});i&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(OB(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{color:t,depth:i,stencil:n,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&Ka(this.gl,{color:t,depth:i,stencil:n}),o.forEach((l,u)=>{jS(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(e){let{attachments:t=[],x:i=0,y:n=0,width:o,height:a}=e,l=St(this.gl),u=l.bindFramebuffer(36008,this.handle);return i===0&&n===0&&o===void 0&&a===void 0?l.invalidateFramebuffer(36008,t):l.invalidateFramebuffer(36008,t,i,n,o,a),l.bindFramebuffer(36008,u),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return n===null&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=On(this.gl,n)),n}getAttachmentParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[],n={};for(let o of i){let a=t?On(this.gl,o):o;n[a]=this.getAttachmentParameter(e,o,t)}return n}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=Object.keys(this.attachments),i={};for(let n of t){let o=Number(n),a=e?On(this.gl,o):o;i[a]=this.getAttachmentParameters(o,e)}return i}show(){return typeof window<"u"&&window.open(Fb(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(e>ne.level||typeof window>"u")return this;t=t||"Framebuffer ".concat(this.id);let i=Fb(this,{targetMaxHeight:100});return ne.image({logLevel:e,message:t,image:i},t)(),this}bind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,o){let a=null;return e&&(a=a||{},a[36064]=new Ve(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:n,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&i?(a=a||{},a[33306]=new Gi(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:n,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new Gi(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:n,height:o}),this.ownResources.push(a[36096])):i&&J(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof Gi?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:t=36064,renderbuffer:i}=e,{gl:n}=this;n.framebufferRenderbuffer(36160,t,36161,i.handle),this.attachments[t]=i}_attachTexture(e){let{attachment:t=36064,texture:i,layer:n,level:o}=e,{gl:a}=this;switch(a.bindTexture(i.target,i.handle),i.target){case 35866:case 32879:St(a).framebufferTextureLayer(36160,t,i.target,o,n);break;case 34067:let u=RB(n);a.framebufferTexture2D(36160,t,u,i.handle,o);break;case 3553:a.framebufferTexture2D(36160,t,3553,i.handle,o);break;default:J(!1,"Illegal texture type")}a.bindTexture(i.target,null),this.attachments[t]=i}_setReadBuffer(e){let t=RS(this.gl);t?t.readBuffer(e):J(e===36064||e===1029,B1),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,i=St(t);if(i)i.drawBuffers(e);else{let n=t.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(e):J(e.length===1&&(e[0]===36064||e[0]===1029),B1)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=Vb(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function RB(s){return s<34069?s+34069:s}function OB(s){return(Me.STATUS||{})[s]||"Framebuffer error ".concat(s)}var _B=[36049,36048,33296,33298,33299,33300,33301,33302,33303];Me.ATTACHMENT_PARAMETERS=_B;function kb(s,e){J(s instanceof Ve||s instanceof pu||s instanceof uh);let t=s.constructor,{gl:i,width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(i,d)}function N1(s,e){let{gl:t,width:i,height:n,id:o}=s;return new Me(t,Object.assign({},e,{id:"framebuffer-for-".concat(o),width:i,height:n,attachments:{[36064]:s}}))}function Qa(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed",t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=s.match(t);return i?i[1]:e}function XS(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function YS(s,e,t,i){let n=s.split(/\r?\n/),o={},a={},l=i||Qa(e)||"(unnamed)",u="".concat(XS(t)," shader ").concat(l);for(let h=0;h<n.length;h++){let d=n[h];if(d.length<=1)continue;let f=d.split(":"),p=f[0],S=parseInt(f[2],10);if(isNaN(S))throw new Error("GLSL compilation error in ".concat(u,": ").concat(s));p!=="WARNING"?o[S]=d:a[S]=d}let c=NB(e);return{shaderName:u,errors:D1(o,c),warnings:D1(a,c)}}function D1(s,e){let t="";for(let i=0;i<e.length;i++){let n=e[i];if(!(!s[i+3]&&!s[i+2]&&!s[i+1])&&(t+="".concat(n,`
`),s[i+1])){let o=s[i+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=F1("^^^ ".concat(l,": ").concat(c,`

`),u)}}return t}function NB(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ",i=s.split(/\r?\n/),n=String(i.length+e-1).length;return i.map((o,a)=>{let l=String(a+e),u=l.length;return F1(l,n-u)+t+o})}function F1(s,e){let t="";for(let i=0;i<e;++i)t+=" ";return"".concat(t).concat(s)}function ch(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}return e}var MB="Shader: GLSL source code must be a JavaScript string",bu=class extends Xt{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return J(!1),"unknown"}}constructor(e,t){Ns(e),J(typeof t.source=="string",MB);let i=Qa(t.source,null)||t.id||vi("unnamed ".concat(bu.getTypeName(t.shaderType)));super(e,{id:i}),this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize(e){let{source:t}=e,i=Qa(t,null);i&&(this.id=vi(i)),this._compile(t)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(bu.getTypeName(this.shaderType),":").concat(this.id)}getName(){return Qa(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(e.startsWith("#version ")||(e=`#version 100
`.concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let i=this.gl.getShaderInfoLog(this.handle),{shaderName:n,errors:o,warnings:a}=YS(i,this.source,this.shaderType,this.id);throw ne.error("GLSL compilation errors in ".concat(n,`
`).concat(o))(),ne.warn("GLSL compilation warnings in ".concat(n,`
`).concat(a))(),new Error("GLSL compilation errors in ".concat(n))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},Pu=class extends bu{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){typeof t=="string"&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},yu=class extends bu{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){typeof t=="string"&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var BB={[5126]:Et.bind(null,"uniform1fv",tn,1,ui),[35664]:Et.bind(null,"uniform2fv",tn,2,ui),[35665]:Et.bind(null,"uniform3fv",tn,3,ui),[35666]:Et.bind(null,"uniform4fv",tn,4,ui),[5124]:Et.bind(null,"uniform1iv",Ja,1,ui),[35667]:Et.bind(null,"uniform2iv",Ja,2,ui),[35668]:Et.bind(null,"uniform3iv",Ja,3,ui),[35669]:Et.bind(null,"uniform4iv",Ja,4,ui),[35670]:Et.bind(null,"uniform1iv",Ja,1,ui),[35671]:Et.bind(null,"uniform2iv",Ja,2,ui),[35672]:Et.bind(null,"uniform3iv",Ja,3,ui),[35673]:Et.bind(null,"uniform4iv",Ja,4,ui),[35674]:Et.bind(null,"uniformMatrix2fv",tn,4,Bs),[35675]:Et.bind(null,"uniformMatrix3fv",tn,9,Bs),[35676]:Et.bind(null,"uniformMatrix4fv",tn,16,Bs),[35678]:Gr,[35680]:Gr,[5125]:Et.bind(null,"uniform1uiv",Ub,1,ui),[36294]:Et.bind(null,"uniform2uiv",Ub,2,ui),[36295]:Et.bind(null,"uniform3uiv",Ub,3,ui),[36296]:Et.bind(null,"uniform4uiv",Ub,4,ui),[35685]:Et.bind(null,"uniformMatrix2x3fv",tn,6,Bs),[35686]:Et.bind(null,"uniformMatrix2x4fv",tn,8,Bs),[35687]:Et.bind(null,"uniformMatrix3x2fv",tn,6,Bs),[35688]:Et.bind(null,"uniformMatrix3x4fv",tn,12,Bs),[35689]:Et.bind(null,"uniformMatrix4x2fv",tn,8,Bs),[35690]:Et.bind(null,"uniformMatrix4x3fv",tn,12,Bs),[35678]:Gr,[35680]:Gr,[35679]:Gr,[35682]:Gr,[36289]:Gr,[36292]:Gr,[36293]:Gr,[36298]:Gr,[36299]:Gr,[36300]:Gr,[36303]:Gr,[36306]:Gr,[36307]:Gr,[36308]:Gr,[36311]:Gr},DB={},FB={},GB={},G1=[0];function KS(s,e,t,i){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(G1[0]=s,s=G1);let n=s.length;if(n%e&&ne.warn("Uniform size should be multiples of ".concat(e),s)(),s instanceof t)return s;let o=i[n];o||(o=new t(n),i[n]=o);for(let a=0;a<n;a++)o[a]=s[a];return o}function tn(s,e){return KS(s,e,Float32Array,DB)}function Ja(s,e){return KS(s,e,Int32Array,FB)}function Ub(s,e){return KS(s,e,Uint32Array,GB)}function ZS(s,e,t){let i=BB[t.type];if(!i)throw new Error("Unknown GLSL uniform type ".concat(t.type));return i().bind(null,s,e)}function V1(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(s));return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function k1(s,e,t){for(let i in s){let n=s[i];if((!t||Boolean(t[i]))&&!VB(n))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(i),n),new Error("".concat(e," Bad uniform ").concat(i))}return!0}function VB(s){return Array.isArray(s)||ArrayBuffer.isView(s)?kB(s):isFinite(s)||s===!0||s===!1||s instanceof li||s instanceof Gi?!0:s instanceof Me?Boolean(s.texture):!1}function U1(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let i=s[e];for(let n=0,o=t.length;n<o;++n)i[n]=t[n]}else s[e]=t.slice();else s[e]=t}function kB(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Gr(){let s=null;return(e,t,i)=>{let n=s!==i;return n&&(e.uniform1i(t,i),s=i),n}}function Et(s,e,t,i){let n=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(n===null)n=new Float32Array(h),o=h,d=!0;else{J(o===h,"Uniform length cannot change.");for(let f=0;f<h;++f)if(c[f]!==n[f]){d=!0;break}}return d&&(i(a,s,l,c),n.set(c)),d}}function ui(s,e,t,i){s[e](t,i)}function Bs(s,e,t,i){s[e](t,!1,i)}var UB=5120,zB=5121,WB=5122,HB=5123,z1=0,zb=1,jB=2,qB=3,Wb=4,XB=5,YB=6,fr=5126,KB=35664,ZB=35665,QB=35666,Bf=5124,JB=35667,$B=35668,eD=35669,Df=5125,tD=36294,rD=36295,iD=36296,nD=35670,oD=35671,sD=35672,aD=35673,lD=35674,uD=35675,cD=35676,hD=35685,dD=35686,fD=35687,gD=35688,pD=35689,mD=35690,QS={[fr]:[fr,1,"float"],[KB]:[fr,2,"vec2"],[ZB]:[fr,3,"vec3"],[QB]:[fr,4,"vec4"],[Bf]:[Bf,1,"int"],[JB]:[Bf,2,"ivec2"],[$B]:[Bf,3,"ivec3"],[eD]:[Bf,4,"ivec4"],[Df]:[Df,1,"uint"],[tD]:[Df,2,"uvec2"],[rD]:[Df,3,"uvec3"],[iD]:[Df,4,"uvec4"],[nD]:[fr,1,"bool"],[oD]:[fr,2,"bvec2"],[sD]:[fr,3,"bvec3"],[aD]:[fr,4,"bvec4"],[lD]:[fr,8,"mat2"],[hD]:[fr,8,"mat2x3"],[dD]:[fr,8,"mat2x4"],[uD]:[fr,12,"mat3"],[fD]:[fr,12,"mat3x2"],[gD]:[fr,12,"mat3x4"],[cD]:[fr,16,"mat4"],[pD]:[fr,16,"mat4x2"],[mD]:[fr,16,"mat4x3"]};function W1(s){switch(s){case z1:return z1;case zb:return zb;case qB:return zb;case jB:return zb;case Wb:return Wb;case XB:return Wb;case YB:return Wb;default:return J(!1),0}}function JS(s){let e=QS[s];if(!e)return null;let[t,i]=e;return{type:t,components:i}}function Hb(s,e){switch(s){case UB:case zB:case WB:case HB:s=fr;break;default:}for(let t in QS){let[i,n,o]=QS[t];if(i===s&&n===e)return{glType:t,name:o}}return null}var Ff=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,n),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((n,o)=>n.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!fe(t))return;let i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,o,a,l)}this.varyingInfos.sort((n,o)=>n.location-o.location)}_addAttribute(e,t,i,n){let{type:o,components:a}=JS(i),l={type:o,size:n*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new dr(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){let{type:o,components:a}=JS(i),l=new dr({type:o,size:n*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var H1=4,bD=35981,PD=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],Ds=class extends Xt{get[Symbol.toStringTag](){return"Program"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.stubRemovedMethods("Program","v6.0",PD),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{hash:t,vs:i,fs:n,varyings:o,bufferMode:a=bD}=e;return this.hash=t||"",this.vs=typeof i=="string"?new Pu(this.gl,{id:"".concat(e.id,"-vs"),source:i}):i,this.fs=typeof n=="string"?new yu(this.gl,{id:"".concat(e.id,"-fs"),source:n}):n,J(this.vs instanceof Pu),J(this.fs instanceof yu),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(St(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Ff(this),this.setProps(e)}delete(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:t,drawMode:i=4,vertexCount:n,offset:o=0,start:a,end:l,isIndexed:u=!1,indexType:c=5123,instanceCount:h=0,isInstanced:d=h>0,vertexArray:f=null,transformFeedback:p,framebuffer:S,parameters:x={},uniforms:C,samplers:O}=e;if((C||O)&&(ne.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(C||{})),ne.priority>=t){let B=S?S.id:"default",I="mode=".concat(On(this.gl,i)," verts=").concat(n," ")+"instances=".concat(h," indexType=").concat(On(this.gl,c)," ")+"isInstanced=".concat(d," isIndexed=").concat(u," ")+"Framebuffer=".concat(B);ne.log(t,I)()}return J(f),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||n===0||d&&h===0?!1:(f.bindForDraw(n,h,()=>{if(S!==void 0&&(x=Object.assign({},x,{framebuffer:S})),p){let B=W1(i);p.begin(B)}this._bindTextures(),ft(this.gl,x,()=>{u&&d?this.gl2.drawElementsInstanced(i,n,c,o,h):u&&fe(this.gl)&&!isNaN(a)&&!isNaN(l)?this.gl2.drawRangeElements(i,a,l,n,c,o):u?this.gl.drawElements(i,n,c,o):d?this.gl2.drawArraysInstanced(i,o,n,h):this.gl.drawArrays(i,o,n)}),p&&p.end()}),!0)}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ne.priority>=2&&k1(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let i=e[t],n=this._uniformSetters[t];if(n){let o=i,a=!1;if(o instanceof Me&&(o=o.texture),o instanceof li)if(a=this.uniforms[t]!==i,a){n.textureIndex===void 0&&(n.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=n;l.bind(u),o=u,this._textureUniforms[t]=l}else o=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(o)||a)&&U1(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),i={};for(let n of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new Pu({handle:n});break;case 35632:i.fs=new yu({handle:n});break;default:}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=vi(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),ne.time(H1,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),ne.timeEnd(H1,"linkProgram for ".concat(this._getName()))(),e.debug||ne.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let i=this.gl.getActiveUniform(this.handle,t),{name:n}=V1(i.name),o=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=ZS(e,o,i),i.size>1)for(let a=0;a<i.size;a++)o=e.getUniformLocation(this.handle,"".concat(n,"[").concat(a,"]")),this._uniformSetters["".concat(n,"[").concat(a,"]")]=ZS(e,o,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var yD=34918,SD=34919,ED=35007,xD=36795,vD=35976,CD=35887,AD=36202,Fs=class extends Xt{get[Symbol.toStringTag](){return"Query"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],i=fe(e),n=Za(e,$e.TIMER_QUERY),o=i||n;for(let a of t)switch(a){case"queries":o=o&&i;break;case"timers":o=o&&n;break;default:J(!1)}return o}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(ED)}beginOcclusionQuery(){let{conservative:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.begin(e?AD:CD)}beginTransformFeedbackQuery(){return this.begin(vD)}begin(e){return this._queryPending?this:(this.target=e,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;let e=this.gl2.getQueryParameter(this.handle,SD);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(xD)}getResult(){return this.gl2.getQueryParameter(this.handle,yD)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((i,n)=>{let o=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}_createHandle(){return Fs.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}};var Gs=class extends Xt{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};St(e),super(e,t),this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Jo(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let i=this._getVaryingIndex(e),{buffer:n,byteSize:o,byteOffset:a}=this._getBufferParams(t);return i<0?(this.unused[e]=n,ne.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,a,o),this)}begin(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof Se?n=e:(n=e.buffer,i=e.byteSize,t=e.byteOffset),(t!==void 0||i!==void 0)&&(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0,o=t&&t.handle;return!o||n===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,i,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var jb=null;function TD(s){return(!jb||jb.byteLength<s)&&(jb=new ArrayBuffer(s)),jb}function j1(s,e){let t=TD(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function q1(s){let{target:e,source:t,start:i=0,count:n=1}=s,o=t.length,a=n*o,l=0;for(let u=i;l<o;l++)e[u++]=t[l];for(;l<a;)l<a-l?(e.copyWithin(i+l,i,i+l),l*=2):(e.copyWithin(i+l,i,i+a-l),l=a);return e}var ID="elements must be GL.ELEMENT_ARRAY_BUFFER",Vr=class extends Xt{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?fe(e)||ih()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new Vr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return Vr.MAX_ATTRIBUTES=Vr.MAX_ATTRIBUTES||e.getParameter(34921),Vr.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:Vr._setConstantFloatArray(e,t,i);break;case Int32Array:Vr._setConstantIntArray(e,t,i);break;case Uint32Array:Vr._setConstantUintArray(e,t,i);break;default:J(!1)}}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:i})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return Vr.getMaxAttributes(this.gl)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(e)}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return J(!e||e.target===34963,ID),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,i){if(t.target===34963)return this.setElementBuffer(t,i);let{size:n,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=i,{gl:d,gl2:f}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(J(fe(d)),f.vertexAttribIPointer(e,n,o,a,l)):d.vertexAttribPointer(e,n,o,u,a,l),d.enableVertexAttribArray(e),f.vertexAttribDivisor(e,h||0)}),this}enable(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!t&&e===0&&!Vr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,o=i.length*e,a=!this.buffer;if(this.buffer=this.buffer||new Se(this.gl,n),a=a||this.buffer.reallocate(n),a=a||!this._compareConstantArrayValues(i,this.bufferValue),a){let l=j1(t.constructor,o);q1({target:l,source:i,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:J(!1)}}static _setConstantIntArray(e,t,i){switch(J(fe(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:J(!1)}}static _setConstantUintArray(e,t,i){switch(J(fe(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:J(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,t){let{location:i}=t;return J(Number.isFinite(i)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(i,e);default:return this.gl.getVertexAttrib(i,e)}})}};var wD="VertexArray: attributes must be Buffers or constants (i.e. typed array)",LD=/^(.+)__LOCATION_([0-9]+)$/,RD=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],hh=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;this.id=i,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new Vr(e),Nb(this,"VertexArray","v6.0",RD),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let i=e[t];this._setAttribute(t,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t.target===34963)return this.setElementBuffer(t,i);let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,o)),this}setConstant(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new Se(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof Se&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof Se&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),n=i()}),n}_resolveLocationAndAccessor(e,t,i,n){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,ne.once(3,()=>"unused value ".concat(e," in ").concat(this.id))(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=dr.resolve(u.accessor,c,i,n),{size:d,type:f}=h;return J(Number.isFinite(d)&&Number.isFinite(f)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let i=LD.exec(e),n=i?i[1]:e,o=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+o,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof Se)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof Se){let i=t[0],n=t[1];this.setBuffer(e,i,n)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let i=t;this.setConstant(e,i)}else if(t.buffer instanceof Se){let i=t;this.setBuffer(e,i.buffer,i)}else throw new Error(wD)}_setConstantAttributes(e,t){let i=Math.max(e|0,t|0),n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)n=this.values[o],ArrayBuffer.isView(n)&&this._setConstantAttribute(o,n)}_setConstantAttributeZero(e,t){if(Vr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){Vr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let i=this.values[t],n=this.accessors[t];if(!i)return;let{divisor:o}=n,a=o>0;if(e.isInstanced=e.isInstanced||a,i instanceof Se){let l=i;if(a){let u=l.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return ne.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function OD(s,e){let{maxElts:t=16,size:i=1}=e,n="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(n+=",".concat(a%i===0?" ":"")),n+=Su(s[a],e);let o=s.length>t?"...":"]";return"".concat(n).concat(o)}function Su(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=1e-16,{isInteger:i=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return OD(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<t)return i?"0":"0.";if(i||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let n=s.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function qb(s){let{header:e="Uniforms",program:t,uniforms:i,undefinedOnly:n=!1}=s;J(t);let o=".*_.*",a=".*Matrix",l=t._uniformSetters,u={},c=Object.keys(l).sort(),h=0;for(let p of c)!p.match(o)&&!p.match(a)&&$S({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)p.match(a)&&$S({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)u[p]||$S({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;let d=0,f={};if(!n)for(let p in i){let S=i[p];u[p]||(d++,f[p]={Type:"NOT USED: ".concat(S),[e]:Su(S)})}return{table:u,count:h,unusedTable:f,unusedCount:d}}function $S(s){let{table:e,header:t,uniforms:i,uniformName:n,undefinedOnly:o}=s,a=i[n],l=_D(a);return!o||!l?(e[n]={[t]:l?Su(a):"N/A","Uniform Type":l?a:"NOT PROVIDED"},!0):!1}function _D(s){return s!=null}function eE(s){let{vertexArray:e,header:t="Attributes"}=s;if(!e.configuration)return{};let i={};e.elements&&(i.ELEMENT_ARRAY_BUFFER=X1(e,e.elements,null,t));let n=e.values;for(let o in n){let a=e._getAttributeInfo(o);if(a){let l="".concat(o,": ").concat(a.name),u=e.accessors[a.location];u&&(l="".concat(o,": ").concat(ND(a.name,u))),i[l]=X1(e,n[o],u,t)}}return i}function X1(s,e,t,i){let{gl:n}=s;if(!e)return{[i]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof Se){let f=e,{data:p,changed:S}=f.getDebugData();h=S?"*":"",d=p,u=f.byteLength,l=u/p.BYTES_PER_ELEMENT/a;let x;if(t){let C=t.divisor>0;x="".concat(C?"I ":"P "," ").concat(l," (x").concat(a,"=").concat(u," bytes ").concat(On(n,o),")")}else c=!0,x="".concat(u," bytes");return{[i]:"".concat(h).concat(Su(d,{size:a,isInteger:c})),"Format ":x}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[i]:"".concat(Su(d,{size:a,isInteger:c})," (constant)"),"Format ":"".concat(a,"x").concat(o," (constant)")}}function ND(s,e){let{type:t,size:i}=e,n=Hb(t,i);return n?"".concat(s," (").concat(n.name,")"):s}function tE(s){let e={},t="Accessors for ".concat(s.id);for(let i of s.attributeInfos)if(i){let n=Y1(i);e["in ".concat(n)]={[t]:JSON.stringify(i.accessor)}}for(let i of s.varyingInfos)if(i){let n=Y1(i);e["out ".concat(n)]={[t]:JSON.stringify(i.accessor)}}return e}function Y1(s){let{type:e,size:t}=s.accessor,i=Hb(e,t);return i?"".concat(i.name," ").concat(s.name):s.name}var K1=hr()&&typeof document<"u",BD=0,Eu=class{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{onCreateContext:t=C=>ah(C),onAddHTML:i=null,onInitialize:n=()=>{},onRender:o=()=>{},onFinalize:a=()=>{},onError:l,gl:u=null,glOptions:c={},debug:h=!1,createFramebuffer:d=!1,autoResizeViewport:f=!0,autoResizeDrawingBuffer:p=!0,stats:S=Rn.get("animation-loop-".concat(BD++))}=e,{useDevicePixels:x=!0}=e;"useDevicePixelRatio"in e&&(ne.deprecated("useDevicePixelRatio","useDevicePixels")(),x=e.useDevicePixelRatio),this.props={onCreateContext:t,onAddHTML:i,onInitialize:n,onRender:o,onFinalize:a,onError:l,gl:u,glOptions:c,debug:h,createFramebuffer:d},this.gl=u,this.needsRedraw=null,this.timeline=null,this.stats=S,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:f,autoResizeDrawingBuffer:p,useDevicePixels:x}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return J(typeof e=="string"),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this._running)return this;this._running=!0;let t=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Fs.isSupported(this.gl,["timers"])?new Fs(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(i=>{this._running&&(this._addCallbackData(i||{}),i!==!1&&this._startLoop())});return this.props.onError&&t.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.getElementById(e);return i?Number(i.value):t}setViewParameters(){return ne.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){let e=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=K1?new Promise((e,t)=>{if(K1&&document.readyState==="complete"){e(document);return}window.addEventListener("load",()=>{e(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):kS(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):VS(e)}_renderFrame(){if(this.display){this.display._renderFrame(...arguments);return}this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){typeof e=="object"&&e!==null&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&typeof OffscreenCanvas<"u"&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?gu(this.props.gl,e):this.onCreateContext(e),!_s(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");Ob(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){let e=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight,i=1,{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&GS(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new Me(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){let{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}};var xu="vs",Gf="fs";function Yt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var rE={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function Q1(s){let e={};for(let t in s){let i=s[t],n=DD(i);e[t]=n}return e}function DD(s){let e=Z1(s);return e==="object"?s?"type"in s?Object.assign({},s,rE[s.type]):"value"in s?(e=Z1(s.value),Object.assign({type:e},s,rE[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},rE[e])}function Z1(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var FD="vs",GD="fs",dh=class{constructor(e){let{name:t,vs:i,fs:n,dependencies:o=[],uniforms:a,getUniforms:l,deprecations:u=[],defines:c={},inject:h={},vertexShader:d,fragmentShader:f}=e;Yt(typeof t=="string"),this.name=t,this.vs=i||d,this.fs=n||f,this.getModuleUniforms=l,this.dependencies=o,this.deprecations=this._parseDeprecationDefinitions(u),this.defines=c,this.injections=VD(h),a&&(this.uniforms=Q1(a))}getModuleSource(e){let t;switch(e){case FD:t=this.vs||"";break;case GD:t=this.fs||"";break;default:Yt(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(t,"// END MODULE_").concat(this.name,`

`)}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp("\\b".concat(t.old,"\\("));break;default:t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))}}),e}_defaultGetUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t={},i=this.uniforms;for(let n in i){let o=i[n];n in e&&!o.private?(o.validate&&Yt(o.validate(e[n],o),"".concat(this.name,": invalid ").concat(n)),t[n]=e[n]):t[n]=o.value}return t}};function VD(s){let e={vs:{},fs:{}};for(let t in s){let i=s[t],n=t.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),e[n][t]=i}return e}function J1(s){return kD(eT(s))}function kD(s){let e={},t={};return $1({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((i,n)=>t[n]-t[i]).map(i=>e[i])}function $1(s){let{modules:e,level:t,moduleMap:i,moduleDepth:n}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(let o of e)i[o.name]=o,(n[o.name]===void 0||n[o.name]<t)&&(n[o.name]=t);for(let o of e)o.dependencies&&$1({modules:o.dependencies,level:t+1,moduleMap:i,moduleDepth:n})}function eT(s,e){return s.map(t=>(t instanceof dh||(Yt(typeof t!="string","Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),Yt(t.name,"shader module has no name"),t=new dh(t),t.dependencies=eT(t.dependencies)),t))}function iE(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n}var UD=7936,zD=7937,WD=7938,HD=35724,oE={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},$a={};Object.keys(oE).forEach(s=>{$a[s]=s});function jD(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function tT(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||UD),i=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||zD);return{gpuVendor:qD(t,i),vendor:t,renderer:i,version:s.getParameter(WD),shadingLanguageVersion:s.getParameter(HD)}}function qD(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var nE={};function sE(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=oE[e];if(Yt(i,e),!iE(t))return!0;if(e in nE)return nE[e];let n=i[0],o=t.behavior||"enable",a="#extension GL_".concat(n," : ").concat(o,`
void main(void) {}`),l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),nE[e]=u,u}function XD(s,e){let t=oE[e];Yt(t,e);let i=jD(s)&&t[1]||t[0],n=typeof i=="string"?Boolean(s.getExtension(i)):i;return Yt(n===!1||n===!0),n}function Vf(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>XD(s,t))}function rT(s){switch(tT(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function iT(s,e,t){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Vf(s,$a.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Vf(s,$a.GLSL_DERIVATIVES)&&sE(s,$a.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Vf(s,$a.GLSL_FRAG_DATA)&&sE(s,$a.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Vf(s,$a.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}var nT=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,oT=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var YD={[xu]:nT,[Gf]:oT},kf="__LUMA_INJECT_DECLARATIONS__",sT=/void\s+main\s*\([^)]*\)\s*\{\n?/,aT=/}\n?[^{}]*$/,aE=[];function Xb(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,n=e===xu;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),aE.length=a.length;for(let u=0,c=a.length;u<c;++u)aE[u]=a[u].injection;let l="".concat(aE.join(`
`),`
`);switch(o){case"vs:#decl":n&&(s=s.replace(kf,l));break;case"vs:#main-start":n&&(s=s.replace(sT,u=>u+l));break;case"vs:#main-end":n&&(s=s.replace(aT,u=>l+u));break;case"fs:#decl":n||(s=s.replace(kf,l));break;case"fs:#main-start":n||(s=s.replace(sT,u=>u+l));break;case"fs:#main-end":n||(s=s.replace(aT,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(kf,""),i&&(s=s.replace(/\}\s*$/,o=>o+YD[e])),s}function fh(s){let e={};return Yt(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let i in t)e[i]=e[i]?"".concat(e[i],`
`).concat(t[i]):t[i]}),e}function gh(s){return new RegExp("\\b".concat(s,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}var lT=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],KD=[...lT,[gh("attribute"),"in $1"],[gh("varying"),"out $1"]],ZD=[...lT,[gh("varying"),"in $1"]],uT=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],QD=[...uT,[gh("in"),"attribute $1"],[gh("out"),"varying $1"]],JD=[...uT,[gh("in"),"varying $1"]],lE="gl_FragColor",uE=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,$D=/void\s+main\s*\([^)]*\)\s*\{\n?/;function cE(s,e,t){switch(e){case 300:return t?Yb(s,KD):eF(s);case 100:return t?Yb(s,QD):tF(s);default:throw new Error("unknown GLSL version ".concat(e))}}function Yb(s,e){for(let[t,i]of e)s=s.replace(t,i);return s}function eF(s){s=Yb(s,ZD);let e=s.match(uE);if(e){let t=e[1];s=s.replace(new RegExp("\\b".concat(lE,"\\b"),"g"),t)}else{let t="fragmentColor";s=s.replace($D,i=>"out vec4 ".concat(t,`;
`).concat(i)).replace(new RegExp("\\b".concat(lE,"\\b"),"g"),t)}return s}function tF(s){s=Yb(s,JD);let e=s.match(uE);if(e){let t=e[1];s=s.replace(uE,"").replace(new RegExp("\\b".concat(t,"\\b"),"g"),lE)}return s}var rF=`

`.concat(kf,`

`),hT={[xu]:"vertex",[Gf]:"fragment"},iF=`precision highp float;

`;function hE(s,e){let{vs:t,fs:i}=e,n=J1(e.modules||[]);return{gl:s,vs:cT(s,Object.assign({},e,{source:t,type:xu,modules:n})),fs:cT(s,Object.assign({},e,{source:i,type:Gf,modules:n})),getUniforms:nF(n)}}function cT(s,e){let{id:t,source:i,type:n,modules:o,defines:a={},hookFunctions:l=[],inject:u={},transpileToGLSL100:c=!1,prologue:h=!0,log:d}=e;Yt(typeof i=="string","shader source must be a string");let f=n===xu,p=i.split(`
`),S=100,x="",C=i;p[0].indexOf("#version ")===0?(S=300,x=p[0],C=p.slice(1).join(`
`)):x="#version ".concat(S);let O={};o.forEach(se=>{Object.assign(O,se.getDefines())}),Object.assign(O,a);let B=h?"".concat(x,`
`).concat(sF({id:t,source:i,type:n}),`
`).concat(oF({type:n}),`
`).concat(rT(s),`
`).concat(iT(s,S,!f),`
`).concat(aF(O),`
`).concat(f?"":iF,`
`):"".concat(x,`
`),I=uF(l),_={},X={},K={};for(let se in u){let ge=typeof u[se]=="string"?{injection:u[se],order:0}:u[se],ue=se.match(/^(v|f)s:(#)?([\w-]+)$/);if(ue){let F=ue[2],M=ue[3];F?M==="decl"?X[se]=[ge]:K[se]=[ge]:_[se]=[ge]}else K[se]=[ge]}for(let se of o){d&&se.checkDeprecations(C,d),B+=se.getModuleSource(n,S);let ue=se.injections[n];for(let F in ue){let M=F.match(/^(v|f)s:#([\w-]+)$/);if(M){let j=M[2]==="decl"?X:K;j[F]=j[F]||[],j[F].push(ue[F])}else _[F]=_[F]||[],_[F].push(ue[F])}}return B+=rF,B=Xb(B,n,X),B+=lF(I[n],_),B+=C,B=Xb(B,n,K),B=cE(B,c?100:S,f),B}function nF(s){return function(t){let i={};for(let n of s){let o=n.getUniforms(t,i);Object.assign(i,o)}return i}}function oF(s){let{type:e}=s;return`
#define SHADER_TYPE_`.concat(hT[e].toUpperCase(),`
`)}function sF(s){let{id:e,source:t,type:i}=s;return e&&typeof e=="string"&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(e,"_").concat(hT[i],`

`):""}function aF(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=0,t="";for(let i in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let n=s[i];(n||Number.isFinite(n))&&(t+="#define ".concat(i.toUpperCase()," ").concat(s[i],`
`))}return e===0&&(t+=`
`),t}function lF(s,e){let t="";for(let i in s){let n=s[i];if(t+="void ".concat(n.signature,` {
`),n.header&&(t+="  ".concat(n.header)),e[i]){let o=e[i];o.sort((a,l)=>a.order-l.order);for(let a of o)t+="  ".concat(a.injection,`
`)}n.footer&&(t+="  ".concat(n.footer)),t+=`}
`}return t}function uF(s){let e={vs:{},fs:{}};return s.forEach(t=>{let i;typeof t!="string"?(i=t,t=i.hook):i={},t=t.trim();let[n,o]=t.split(":"),a=t.replace(/\(.+/,"");e[n][a]=Object.assign(i,{signature:o})}),e}var cF="void main() {gl_FragColor = vec4(0);}",dT=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,hF=`#version 300 es
`.concat(dT);function Kb(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[i,n,o]=t;if(!e.includes(i)||!n||!o)return null;let a=o.split(";")[0];return{qualifier:i,type:n,name:a}}function Uf(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{version:e=100,input:t,inputType:i,output:n}=s;if(!t)return e===300?hF:e>300?"#version ".concat(e,`
`).concat(dT):cF;let o=fT(t,i);return e>=300?"#version ".concat(e," ").concat(e===300?"es":"",`
in `).concat(i," ").concat(t,`;
out vec4 `).concat(n,`;
void main() {
  `).concat(n," = ").concat(o,`;
}`):"varying ".concat(i," ").concat(t,`;
void main() {
  gl_FragColor = `).concat(o,`;
}`)}function dE(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Yt(!1),null}}function fE(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Yt(!1),null}}function fT(s,e){switch(e){case"float":return"vec4(".concat(s,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(s,", 0.0, 1.0)");case"vec3":return"vec4(".concat(s,", 1.0)");case"vec4":return s;default:return Yt(!1),null}}var dF=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,Zb={name:"fp32",vs:dF,fs:null};function ro(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var LCe=1/Math.PI*180,RCe=1/180*Math.PI,Kt={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function gE(s,{precision:e=Kt.precision}={}){return s=fF(s),"".concat(parseFloat(s.toPrecision(e)))}function io(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Ot(s,e,t){return pF(s,i=>Math.max(e,Math.min(t,i)))}function vu(s,e,t){return io(s)?s.map((i,n)=>vu(i,e[n],t)):t*e+(1-t)*s}function kr(s,e,t){let i=Kt.EPSILON;t&&(Kt.EPSILON=t);try{if(s===e)return!0;if(io(s)&&io(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!kr(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=Kt.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{Kt.EPSILON=i}}function fF(s){return Math.round(s/Kt.EPSILON)*Kt.EPSILON}function gF(s){return s.clone?s.clone():new Array(s.length)}function pF(s,e,t){if(io(s)){let i=s;t=t||gF(i);for(let n=0;n<t.length&&n<i.length;++n)t[n]=e(s[n],n,t);return t}return e(s)}function mF(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var Vs=class extends mF(Array){clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:io(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Kt)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+gE(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!kr(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(i===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){let o=e[n];this[n]=o+i*(t[n]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Kt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}};function bF(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Je(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function el(s,e,t=""){if(Kt.debug&&!bF(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var Cu=class extends Vs{get x(){return this[0]}set x(e){this[0]=Je(e)}get y(){return this[1]}set y(e){this[1]=Je(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let n=this[i]-e[i];t+=n*n}return Je(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return Je(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return ro(e>=0&&e<this.ELEMENTS,"index is out of range"),Je(this[e])}setComponent(e,t){return ro(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var no=1e-6,Ur=typeof Float32Array<"u"?Float32Array:Array;var kCe=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function PF(){var s=new Ur(2);return Ur!=Float32Array&&(s[0]=0,s[1]=0),s}function mh(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function Qb(s,e){return s[0]=-e[0],s[1]=-e[1],s}function Jb(s,e,t,i){var n=e[0],o=e[1];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s}function gT(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[3]*n+t[6],s[1]=t[1]*i+t[4]*n+t[7],s}function pT(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[4]*n+t[12],s[1]=t[1]*i+t[5]*n+t[13],s}var UCe=function(){var s=PF();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function mT(s,e,t){let i=e[0],n=e[1],o=t[3]*i+t[7]*n||1;return s[0]=(t[0]*i+t[4]*n)/o,s[1]=(t[1]*i+t[5]*n)/o,s}function $b(s,e,t){let i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o||1;return s[0]=(t[0]*i+t[4]*n+t[8]*o)/a,s[1]=(t[1]*i+t[5]*n+t[9]*o)/a,s[2]=(t[2]*i+t[6]*n+t[10]*o)/a,s}function bT(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s}function PT(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s[3]=e[3],s}function eP(s,e,t){let i=e[0],n=e[1],o=e[2];return s[0]=t[0]*i+t[3]*n+t[6]*o,s[1]=t[1]*i+t[4]*n+t[7]*o,s[2]=t[2]*i+t[5]*n+t[8]*o,s[3]=e[3],s}function mE(){var s=new Ur(3);return Ur!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function yF(s){var e=s[0],t=s[1],i=s[2];return Math.hypot(e,t,i)}function bE(s,e,t){var i=new Ur(3);return i[0]=s,i[1]=e,i[2]=t,i}function SF(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function EF(s){var e=s[0],t=s[1],i=s[2];return e*e+t*t+i*i}function yT(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function ST(s,e){var t=e[0],i=e[1],n=e[2],o=t*t+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),s[0]=e[0]*o,s[1]=e[1]*o,s[2]=e[2]*o,s}function PE(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function Ph(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=n*u-o*l,s[1]=o*a-i*u,s[2]=i*l-n*a,s}function ET(s,e,t,i){var n=e[0],o=e[1],a=e[2];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s}function yh(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,s[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,s[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,s}function tP(s,e,t){var i=e[0],n=e[1],o=e[2];return s[0]=i*t[0]+n*t[3]+o*t[6],s[1]=i*t[1]+n*t[4]+o*t[7],s[2]=i*t[2]+n*t[5]+o*t[8],s}function rP(s,e,t){var i=t[0],n=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=n*c-o*u,d=o*l-i*c,f=i*u-n*l,p=n*f-o*d,S=o*h-i*f,x=i*d-n*h,C=a*2;return h*=C,d*=C,f*=C,p*=2,S*=2,x*=2,s[0]=l+h+p,s[1]=u+d+S,s[2]=c+f+x,s}function xT(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function vT(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function CT(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function AT(s,e){var t=s[0],i=s[1],n=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+i*i+n*n),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&PE(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var iP=SF;var nP=yF,oP=EF,WCe=function(){var s=mE();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var yE=[0,0,0],sP,re=class extends Cu{static get ZERO(){return sP||(sP=new re(0,0,0),Object.freeze(sP)),sP}constructor(e=0,t=0,i=0){super(-0,-0,-0),arguments.length===1&&io(e)?this.copy(e):(Kt.debug&&(Je(e),Je(t),Je(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Kt.debug&&(Je(e.x),Je(e.y),Je(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Je(e)}angle(e){return AT(this,e)}cross(e){return Ph(this,this,e),this.check()}rotateX({radians:e,origin:t=yE}){return xT(this,this,t,e),this.check()}rotateY({radians:e,origin:t=yE}){return vT(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=yE}){return CT(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return yh(this,this,e),this.check()}transformAsVector(e){return $b(this,this,e),this.check()}transformByMatrix3(e){return tP(this,this,e),this.check()}transformByMatrix2(e){return bT(this,this,e),this.check()}transformByQuaternion(e){return rP(this,this,e),this.check()}};var aP,Au=class extends Cu{static get ZERO(){return aP||(aP=new Au(0,0,0,0),Object.freeze(aP)),aP}constructor(e=0,t=0,i=0,n=0){super(-0,-0,-0,-0),io(e)&&arguments.length===1?this.copy(e):(Kt.debug&&(Je(e),Je(t),Je(i),Je(n)),this[0]=e,this[1]=t,this[2]=i,this[3]=n)}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return Kt.debug&&(Je(e.x),Je(e.y),Je(e.z),Je(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=Je(e)}get w(){return this[3]}set w(e){this[3]=Je(e)}transform(e){return yh(this,this,e),this.check()}transformByMatrix3(e){return eP(this,this,e),this.check()}transformByMatrix2(e){return PT(this,this,e),this.check()}transformByQuaternion(e){return rP(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}};var Tu=class extends Vs{toString(){let e="[";if(Kt.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=Je(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[i+n];return t}setColumn(e,t){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)this[i+n]=t[n];return this}};function TT(){var s=new Ur(9);return Ur!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function IT(s,e){if(s===e){var t=e[1],i=e[2],n=e[5];s[1]=e[3],s[2]=e[6],s[3]=t,s[5]=e[7],s[6]=i,s[7]=n}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return s}function wT(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=h*a-l*c,f=-h*o+l*u,p=c*o-a*u,S=t*d+i*f+n*p;return S?(S=1/S,s[0]=d*S,s[1]=(-h*i+n*c)*S,s[2]=(l*i-n*a)*S,s[3]=f*S,s[4]=(h*t-n*u)*S,s[5]=(-l*t+n*o)*S,s[6]=p*S,s[7]=(-c*t+i*u)*S,s[8]=(a*t-i*o)*S,s):null}function LT(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8];return e*(c*o-a*u)+t*(-c*n+a*l)+i*(u*n-o*l)}function SE(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1],S=t[2],x=t[3],C=t[4],O=t[5],B=t[6],I=t[7],_=t[8];return s[0]=f*i+p*a+S*c,s[1]=f*n+p*l+S*h,s[2]=f*o+p*u+S*d,s[3]=x*i+C*a+O*c,s[4]=x*n+C*l+O*h,s[5]=x*o+C*u+O*d,s[6]=B*i+I*a+_*c,s[7]=B*n+I*l+_*h,s[8]=B*o+I*u+_*d,s}function RT(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1];return s[0]=i,s[1]=n,s[2]=o,s[3]=a,s[4]=l,s[5]=u,s[6]=f*i+p*a+c,s[7]=f*n+p*l+h,s[8]=f*o+p*u+d,s}function OT(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=Math.sin(t),p=Math.cos(t);return s[0]=p*i+f*a,s[1]=p*n+f*l,s[2]=p*o+f*u,s[3]=p*a-f*i,s[4]=p*l-f*n,s[5]=p*u-f*o,s[6]=c,s[7]=h,s[8]=d,s}function EE(s,e,t){var i=t[0],n=t[1];return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=n*e[3],s[4]=n*e[4],s[5]=n*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}function _T(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,x=o*a,C=o*l,O=o*u;return s[0]=1-d-S,s[3]=h-O,s[6]=f+C,s[1]=h+O,s[4]=1-c-S,s[7]=p-x,s[2]=f-C,s[5]=p+x,s[8]=1-c-d,s}var xE;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(xE||(xE={}));var xF=Object.freeze([1,0,0,0,1,0,0,0,1]),Ct=class extends Tu{static get IDENTITY(){return CF()}static get ZERO(){return vF()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return xE}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(xF)}fromObject(e){return this.check()}fromQuaternion(e){return _T(this,e),this.check()}set(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=n,this[2]=l,this[3]=t,this[4]=o,this[5]=u,this[6]=i,this[7]=a,this[8]=c,this.check()}determinant(){return LT(this)}transpose(){return IT(this,this),this.check()}invert(){return wT(this,this),this.check()}multiplyLeft(e){return SE(this,e,this),this.check()}multiplyRight(e){return SE(this,this,e),this.check()}rotate(e){return OT(this,this,e),this.check()}scale(e){return Array.isArray(e)?EE(this,this,e):EE(this,this,[e,e]),this.check()}translate(e){return RT(this,this,e),this.check()}transform(e,t){let i;switch(e.length){case 2:i=gT(t||[-0,-0],e,this);break;case 3:i=tP(t||[-0,-0,-0],e,this);break;case 4:i=eP(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return el(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}},lP,uP;function vF(){return lP||(lP=new Ct([0,0,0,0,0,0,0,0,0]),Object.freeze(lP)),lP}function CF(){return uP||(uP=new Ct,Object.freeze(uP)),uP}function AF(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function MT(s,e){if(s===e){var t=e[1],i=e[2],n=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=i,s[9]=o,s[11]=e[14],s[12]=n,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function zf(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],p=e[11],S=e[12],x=e[13],C=e[14],O=e[15],B=t*l-i*a,I=t*u-n*a,_=t*c-o*a,X=i*u-n*l,K=i*c-o*l,se=n*c-o*u,ge=h*x-d*S,ue=h*C-f*S,F=h*O-p*S,M=d*C-f*x,W=d*O-p*x,j=f*O-p*C,te=B*j-I*W+_*M+X*F-K*ue+se*ge;return te?(te=1/te,s[0]=(l*j-u*W+c*M)*te,s[1]=(n*W-i*j-o*M)*te,s[2]=(x*se-C*K+O*X)*te,s[3]=(f*K-d*se-p*X)*te,s[4]=(u*F-a*j-c*ue)*te,s[5]=(t*j-n*F+o*ue)*te,s[6]=(C*_-S*se-O*I)*te,s[7]=(h*se-f*_+p*I)*te,s[8]=(a*W-l*F+c*ge)*te,s[9]=(i*F-t*W-o*ge)*te,s[10]=(S*K-x*_+O*B)*te,s[11]=(d*_-h*K-p*B)*te,s[12]=(l*ue-a*M-u*ge)*te,s[13]=(t*M-i*ue+n*ge)*te,s[14]=(x*I-S*X-C*B)*te,s[15]=(h*X-d*I+f*B)*te,s):null}function BT(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],f=s[11],p=s[12],S=s[13],x=s[14],C=s[15],O=e*a-t*o,B=e*l-i*o,I=e*u-n*o,_=t*l-i*a,X=t*u-n*a,K=i*u-n*l,se=c*S-h*p,ge=c*x-d*p,ue=c*C-f*p,F=h*x-d*S,M=h*C-f*S,W=d*C-f*x;return O*W-B*M+I*F+_*ue-X*ge+K*se}function $o(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],p=e[10],S=e[11],x=e[12],C=e[13],O=e[14],B=e[15],I=t[0],_=t[1],X=t[2],K=t[3];return s[0]=I*i+_*l+X*d+K*x,s[1]=I*n+_*u+X*f+K*C,s[2]=I*o+_*c+X*p+K*O,s[3]=I*a+_*h+X*S+K*B,I=t[4],_=t[5],X=t[6],K=t[7],s[4]=I*i+_*l+X*d+K*x,s[5]=I*n+_*u+X*f+K*C,s[6]=I*o+_*c+X*p+K*O,s[7]=I*a+_*h+X*S+K*B,I=t[8],_=t[9],X=t[10],K=t[11],s[8]=I*i+_*l+X*d+K*x,s[9]=I*n+_*u+X*f+K*C,s[10]=I*o+_*c+X*p+K*O,s[11]=I*a+_*h+X*S+K*B,I=t[12],_=t[13],X=t[14],K=t[15],s[12]=I*i+_*l+X*d+K*x,s[13]=I*n+_*u+X*f+K*C,s[14]=I*o+_*c+X*p+K*O,s[15]=I*a+_*h+X*S+K*B,s}function Iu(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,f,p,S,x,C,O;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],p=e[7],S=e[8],x=e[9],C=e[10],O=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=p,s[8]=S,s[9]=x,s[10]=C,s[11]=O,s[12]=a*i+h*n+S*o+e[12],s[13]=l*i+d*n+x*o+e[13],s[14]=u*i+f*n+C*o+e[14],s[15]=c*i+p*n+O*o+e[15]),s}function Sh(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function DT(s,e,t,i){var n=i[0],o=i[1],a=i[2],l=Math.hypot(n,o,a),u,c,h,d,f,p,S,x,C,O,B,I,_,X,K,se,ge,ue,F,M,W,j,te,oe;return l<no?null:(l=1/l,n*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],f=e[1],p=e[2],S=e[3],x=e[4],C=e[5],O=e[6],B=e[7],I=e[8],_=e[9],X=e[10],K=e[11],se=n*n*h+c,ge=o*n*h+a*u,ue=a*n*h-o*u,F=n*o*h-a*u,M=o*o*h+c,W=a*o*h+n*u,j=n*a*h+o*u,te=o*a*h-n*u,oe=a*a*h+c,s[0]=d*se+x*ge+I*ue,s[1]=f*se+C*ge+_*ue,s[2]=p*se+O*ge+X*ue,s[3]=S*se+B*ge+K*ue,s[4]=d*F+x*M+I*W,s[5]=f*F+C*M+_*W,s[6]=p*F+O*M+X*W,s[7]=S*F+B*M+K*W,s[8]=d*j+x*te+I*oe,s[9]=f*j+C*te+_*oe,s[10]=p*j+O*te+X*oe,s[11]=S*j+B*te+K*oe,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function cP(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+f*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=f*n-u*i,s}function FT(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n-c*i,s[1]=a*n-h*i,s[2]=l*n-d*i,s[3]=u*n-f*i,s[8]=o*i+c*n,s[9]=a*i+h*n,s[10]=l*i+d*n,s[11]=u*i+f*n,s}function hP(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+f*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=f*n-u*i,s}function GT(s,e){var t=e[0],i=e[1],n=e[2],o=e[4],a=e[5],l=e[6],u=e[8],c=e[9],h=e[10];return s[0]=Math.hypot(t,i,n),s[1]=Math.hypot(o,a,l),s[2]=Math.hypot(u,c,h),s}function VT(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,x=o*a,C=o*l,O=o*u;return s[0]=1-d-S,s[1]=h+O,s[2]=f-C,s[3]=0,s[4]=h-O,s[5]=1-c-S,s[6]=p+x,s[7]=0,s[8]=f+C,s[9]=p-x,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function kT(s,e,t,i,n,o,a){var l=1/(t-e),u=1/(n-i),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(n+i)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function TF(s,e,t,i,n){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,n!=null&&n!==1/0?(a=1/(i-n),s[10]=(n+i)*a,s[14]=2*n*i*a):(s[10]=-1,s[14]=-2*i),s}var vE=TF;function IF(s,e,t,i,n,o,a){var l=1/(e-t),u=1/(i-n),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+i)*u,s[14]=(a+o)*c,s[15]=1,s}var UT=IF;function zT(s,e,t,i){var n,o,a,l,u,c,h,d,f,p,S=e[0],x=e[1],C=e[2],O=i[0],B=i[1],I=i[2],_=t[0],X=t[1],K=t[2];return Math.abs(S-_)<no&&Math.abs(x-X)<no&&Math.abs(C-K)<no?AF(s):(h=S-_,d=x-X,f=C-K,p=1/Math.hypot(h,d,f),h*=p,d*=p,f*=p,n=B*f-I*d,o=I*h-O*f,a=O*d-B*h,p=Math.hypot(n,o,a),p?(p=1/p,n*=p,o*=p,a*=p):(n=0,o=0,a=0),l=d*a-f*o,u=f*n-h*a,c=h*o-d*n,p=Math.hypot(l,u,c),p?(p=1/p,l*=p,u*=p,c*=p):(l=0,u=0,c=0),s[0]=n,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=f,s[11]=0,s[12]=-(n*S+o*x+a*C),s[13]=-(l*S+u*x+c*C),s[14]=-(h*S+d*x+f*C),s[15]=1,s)}function wF(){var s=new Ur(4);return Ur!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function WT(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function Eh(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function HT(s){var e=s[0],t=s[1],i=s[2],n=s[3];return Math.hypot(e,t,i,n)}function jT(s){var e=s[0],t=s[1],i=s[2],n=s[3];return e*e+t*t+i*i+n*n}function qT(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o;return a>0&&(a=1/Math.sqrt(a)),s[0]=t*a,s[1]=i*a,s[2]=n*a,s[3]=o*a,s}function XT(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]+s[3]*e[3]}function YT(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s[3]=l+i*(t[3]-l),s}function oo(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}function KT(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2],c=t[3],h=c*i+l*o-u*n,d=c*n+u*i-a*o,f=c*o+a*n-l*i,p=-a*i-l*n-u*o;return s[0]=h*c+p*-a+d*-u-f*-l,s[1]=d*c+p*-l+f*-a-h*-u,s[2]=f*c+p*-u+h*-l-d*-a,s[3]=e[3],s}var lAe=function(){var s=wF();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var TE;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(TE||(TE={}));var LF=45*Math.PI/180,RF=1,CE=.1,AE=500,OF=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),it=class extends Tu{static get IDENTITY(){return NF()}static get ZERO(){return _F()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return TE}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,o,a,l,u,c,h,d,f,p,S,x,C){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=f,this[12]=p,this[13]=S,this[14]=x,this[15]=C,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c,h,d,f,p,S,x,C){return this[0]=e,this[1]=o,this[2]=c,this[3]=p,this[4]=t,this[5]=a,this[6]=h,this[7]=S,this[8]=i,this[9]=l,this[10]=d,this[11]=x,this[12]=n,this[13]=u,this[14]=f,this[15]=C,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(OF)}fromObject(e){return this.check()}fromQuaternion(e){return VT(this,e),this.check()}frustum(e){let{left:t,right:i,bottom:n,top:o,near:a=CE,far:l=AE}=e;return l===1/0?MF(this,t,i,n,o,a):kT(this,t,i,n,o,a,l),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:n=[0,1,0]}=e;return zT(this,t,i,n),this.check()}ortho(e){let{left:t,right:i,bottom:n,top:o,near:a=CE,far:l=AE}=e;return UT(this,t,i,n,o,a,l),this.check()}orthographic(e){let{fovy:t=LF,aspect:i=RF,focalDistance:n=1,near:o=CE,far:a=AE}=e;ZT(t);let l=t/2,u=n*Math.tan(l),c=u*i;return this.ortho({left:-c,right:c,bottom:-u,top:u,near:o,far:a})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:o=500}=e;return ZT(t),vE(this,t,i,n,o),this.check()}determinant(){return BT(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*n,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*n,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return MT(this,this),this.check()}invert(){return zf(this,this),this.check()}multiplyLeft(e){return $o(this,e,this),this.check()}multiplyRight(e){return $o(this,this,e),this.check()}rotateX(e){return cP(this,this,e),this.check()}rotateY(e){return FT(this,this,e),this.check()}rotateZ(e){return hP(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return DT(this,this,e,t),this.check()}scale(e){return Sh(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return Iu(this,this,e),this.check()}transform(e,t){return e.length===4?(t=oo(t||[-0,-0,-0,-0],e,this),el(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:i}=e,n;switch(i){case 2:n=pT(t||[-0,-0],e,this);break;case 3:n=yh(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return el(n,e.length),n}transformAsVector(e,t){let i;switch(e.length){case 2:i=mT(t||[-0,-0],e,this);break;case 3:i=$b(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return el(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}},dP,fP;function _F(){return dP||(dP=new it([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(dP)),dP}function NF(){return fP||(fP=new it,Object.freeze(fP)),fP}function ZT(s){if(s>Math.PI*2)throw Error("expected radians")}function MF(s,e,t,i,n,o){let a=2*o/(t-e),l=2*o/(n-i),u=(t+e)/(t-e),c=(n+i)/(n-i),h=-1,d=-1,f=-2*o;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=l,s[6]=0,s[7]=0,s[8]=u,s[9]=c,s[10]=h,s[11]=d,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}function QT(){var s=new Ur(4);return Ur!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function JT(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function IE(s,e,t){t=t*.5;var i=Math.sin(t);return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=Math.cos(t),s}function wE(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=t[0],u=t[1],c=t[2],h=t[3];return s[0]=i*h+a*l+n*c-o*u,s[1]=n*h+a*u+o*l-i*c,s[2]=o*h+a*c+i*u-n*l,s[3]=a*h-i*l-n*u-o*c,s}function $T(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+a*l,s[1]=n*u+o*l,s[2]=o*u-n*l,s[3]=a*u-i*l,s}function eI(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u-o*l,s[1]=n*u+a*l,s[2]=o*u+i*l,s[3]=a*u-n*l,s}function tI(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+n*l,s[1]=n*u-i*l,s[2]=o*u+a*l,s[3]=a*u-o*l,s}function rI(s,e){var t=e[0],i=e[1],n=e[2];return s[0]=t,s[1]=i,s[2]=n,s[3]=Math.sqrt(Math.abs(1-t*t-i*i-n*n)),s}function Hf(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3],u=t[0],c=t[1],h=t[2],d=t[3],f,p,S,x,C;return p=n*u+o*c+a*h+l*d,p<0&&(p=-p,u=-u,c=-c,h=-h,d=-d),1-p>no?(f=Math.acos(p),S=Math.sin(f),x=Math.sin((1-i)*f)/S,C=Math.sin(i*f)/S):(x=1-i,C=i),s[0]=x*n+C*u,s[1]=x*o+C*c,s[2]=x*a+C*h,s[3]=x*l+C*d,s}function iI(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o,l=a?1/a:0;return s[0]=-t*l,s[1]=-i*l,s[2]=-n*l,s[3]=o*l,s}function nI(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s[3]=e[3],s}function LE(s,e){var t=e[0]+e[4]+e[8],i;if(t>0)i=Math.sqrt(t+1),s[3]=.5*i,i=.5/i,s[0]=(e[5]-e[7])*i,s[1]=(e[6]-e[2])*i,s[2]=(e[1]-e[3])*i;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[n*3+n]&&(n=2);var o=(n+1)%3,a=(n+2)%3;i=Math.sqrt(e[n*3+n]-e[o*3+o]-e[a*3+a]+1),s[n]=.5*i,i=.5/i,s[3]=(e[o*3+a]-e[a*3+o])*i,s[o]=(e[o*3+n]+e[n*3+o])*i,s[a]=(e[a*3+n]+e[n*3+a])*i}return s}var oI=WT;var sI=Eh,aI=XT,lI=YT,uI=HT;var cI=jT;var hI=qT;var dI=function(){var s=mE(),e=bE(1,0,0),t=bE(0,1,0);return function(i,n,o){var a=PE(n,o);return a<-.999999?(Ph(s,e,n),nP(s)<1e-6&&Ph(s,t,n),ST(s,s),IE(i,s,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(Ph(s,n,o),i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=1+a,hI(i,i))}}(),yAe=function(){var s=QT(),e=QT();return function(t,i,n,o,a,l){return Hf(s,i,a,l),Hf(e,n,o,l),Hf(t,s,e,2*l*(1-l)),t}}(),SAe=function(){var s=TT();return function(e,t,i,n){return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=n[0],s[4]=n[1],s[7]=n[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],hI(e,LE(e,s))}}();var DF=[0,0,0,1],wu=class extends Vs{constructor(e=0,t=0,i=0,n=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,i,n)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return LE(this,e),this.check()}fromAxisRotation(e,t){return IE(this,e,t),this.check()}identity(){return JT(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=Je(e)}get y(){return this[1]}set y(e){this[1]=Je(e)}get z(){return this[2]}set z(e){this[2]=Je(e)}get w(){return this[3]}set w(e){this[3]=Je(e)}len(){return uI(this)}lengthSquared(){return cI(this)}dot(e){return aI(this,e)}rotationTo(e,t){return dI(this,e,t),this.check()}add(e){return oI(this,this,e),this.check()}calculateW(){return rI(this,this),this.check()}conjugate(){return nI(this,this),this.check()}invert(){return iI(this,this),this.check()}lerp(e,t,i){return i===void 0?this.lerp(this,e,t):(lI(this,e,t,i),this.check())}multiplyRight(e){return wE(this,this,e),this.check()}multiplyLeft(e){return wE(this,e,this),this.check()}normalize(){let e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return $T(this,this,e),this.check()}rotateY(e){return eI(this,this,e),this.check()}rotateZ(e){return tI(this,this,e),this.check()}scale(e){return sI(this,this,e),this.check()}slerp(e,t,i){let n,o,a;switch(arguments.length){case 1:({start:n=DF,target:o,ratio:a}=e);break;case 2:n=this,o=e,a=t;break;default:n=e,o=t,a=i}return Hf(this,n,o,a),this.check()}transformVector4(e,t=new Au){return KT(t,e,this),el(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}};var gP={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,PI_OVER_TWO:Math.PI/2,PI_OVER_FOUR:Math.PI/4,PI_OVER_SIX:Math.PI/6,TWO_PI:Math.PI*2};var RE=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))

struct AmbientLight {
 vec3 color;
};

struct PointLight {
 vec3 color;
 vec3 position;
 vec3 attenuation;
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;

uniform bool lighting_uEnabled;

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

#endif
`;var FF={lightSources:{}};function OE(){let{color:s=[0,0,0],intensity:e=1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.map(t=>t*e/255)}function GF(s){let{ambientLight:e,pointLights:t=[],directionalLights:i=[]}=s,n={};return e?n["lighting_uAmbientLight.color"]=OE(e):n["lighting_uAmbientLight.color"]=[0,0,0],t.forEach((o,a)=>{n["lighting_uPointLight[".concat(a,"].color")]=OE(o),n["lighting_uPointLight[".concat(a,"].position")]=o.position,n["lighting_uPointLight[".concat(a,"].attenuation")]=o.attenuation||[1,0,0]}),n.lighting_uPointLightCount=t.length,i.forEach((o,a)=>{n["lighting_uDirectionalLight[".concat(a,"].color")]=OE(o),n["lighting_uDirectionalLight[".concat(a,"].direction")]=o.direction}),n.lighting_uDirectionalLightCount=i.length,n}function fI(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:FF;if("lightSources"in s){let{ambientLight:e,pointLights:t,directionalLights:i}=s.lightSources||{};return e||t&&t.length>0||i&&i.length>0?Object.assign({},GF({ambientLight:e,pointLights:t,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in s){let e={pointLights:[],directionalLights:[]};for(let t of s.lights||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights.push(t);break;case"point":e.pointLights.push(t);break;default:}return fI({lightSources:e})}return{}}var gI={name:"lights",vs:RE,fs:RE,getUniforms:fI,defines:{MAX_LIGHTS:3}};var VF=new Uint8Array([0,255,255,255]),kF={pickingSelectedColor:null,pickingHighlightColor:VF,pickingActive:!1,pickingAttribute:!1};function UF(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:kF,e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,i=>i/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var zF=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,WF=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,rl={name:"picking",vs:zF,fs:WF,getUniforms:UF};var pI=`
uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
    vec3 halfway_direction = normalize(light_direction + view_direction);
    float lambertian = dot(light_direction, normal_worldspace);
    float specular = 0.0;
    if (lambertian > 0.0) {
      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
      specular = pow(specular_angle, lighting_uShininess);
    }
    lambertian = max(lambertian, 0.0);
    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);
    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}

vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = vec3(0, 0, 0);
  vec3 surfaceColor = vec3(0, 0, 0);

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}
`;var HF={};function jF(s){let{ambient:e=.35,diffuse:t=.6,shininess:i=32,specularColor:n=[30,30,30]}=s;return{lighting_uAmbient:e,lighting_uDiffuse:t,lighting_uShininess:i,lighting_uSpecularColor:n.map(o=>o/255)}}function qF(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:HF;if(!("material"in s))return{};let{material:e}=s;return e?jF(e):{lighting_uEnabled:!1}}var vh={name:"gouraud-lighting",dependencies:[gI],vs:pI,defines:{LIGHTING_VERTEX:1},getUniforms:qF};var XF=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,_E={name:"transform",vs:XF,fs:null};var rn=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new rn(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{vs:t="",fs:i="",defines:n={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(i),f=c.map(I=>this._getHash(I.name)).sort(),p=a.map(I=>this._getHash(I)),S=Object.keys(n).sort(),x=Object.keys(o).sort(),C=[],O=[];for(let I of S)C.push(this._getHash(I)),C.push(this._getHash(n[I]));for(let I of x)O.push(this._getHash(I)),O.push(this._getHash(o[I]));let B="".concat(h,"/").concat(d,"D").concat(C.join("/"),"M").concat(f.join("/"),"I").concat(O.join("/"),"V").concat(p.join("/"),"H").concat(this.stateHash,"B").concat(l).concat(u?"T":"");if(!this._programCache[B]){let I=hE(this.gl,{vs:t,fs:i,modules:c,inject:o,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[B]=new Ds(this.gl,{hash:B,vs:I.vs,fs:I.fs,varyings:a,bufferMode:l}),this._getUniforms[B]=I.getUniforms||(_=>{}),this._useCounts[B]=0}return this._useCounts[B]++,this._programCache[B]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=new Array(this._defaultModules.length+e.length),i={},n=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[n++]=l,i[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;i[u]||(t[n++]=l,i[u]=!0)}return t.length=n,t}};var YF={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function mI(s,e,t){let i={},n=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=KF(o,t);if(o==="indices")n=a;else if(a.constant)i[l]=a.value;else{let u=a.value,c={...a};delete c.value,i[l]=[new Se(s,u),c],ZF(o,c)}}if(n){let o=n.value||n;J(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:n.isIndexed===void 0?!0:n.isIndexed};i.indices=[new Se(s,{data:o,target:34963}),a]}return i}function KF(s,e){let{attributeMap:t=YF}=e||{};return t&&t[s]||s}function ZF(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}J(Number.isFinite(e.size),"attribute ".concat(s," needs size"))}var Ch=2,QF=1e4,JF="Model needs drawMode and vertexCount",bI=()=>{},$F={},At=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{id:i=vi("model")}=t;J(_s(e)),this.id=i,this.gl=e,this.id=t.id||vi("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||rn.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},J(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),JF)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return J(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return J(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=mI(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Jo(e))return this;let t={};for(let i in e){let n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return Ka(this.program.gl,e),this}draw(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();let{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(n);let c;ne.priority>=Ch&&(c=this._logDrawCallStart(Ch));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:f=h.indexType,indexOffset:p=h.indexOffset,vertexArrayInstanced:S=h.isInstanced}=this.props;S&&!this.isInstanced&&ne.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:x,instanceCount:C}=this,{onBeforeRender:O=bI,onAfterRender:B=bI}=this.props;O(),this.program.setUniforms(this.uniforms);let I=this.program.draw(Object.assign($F,e,{logPriority:c,uniforms:null,framebuffer:i,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:f,isInstanced:x,instanceCount:C,offset:d?p:0}));return B(),ne.priority>=Ch&&this._logDrawCallEnd(c,u,i),I}transform(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e,{parameters:o}=e;i&&this._setFeedbackBuffers(i),t&&(o=Object.assign({},o,{[35977]:t})),n.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{n.forEach(a=>a.vertexArray.bindBuffers())}return this}render(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ne.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}J(t instanceof Ds,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new hh(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof Se&&t.delete()}}_setAnimationProps(e){this.animated&&J(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Jo(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new Gs(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:QF;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),ne.group(Ch,">>> DRAWING MODEL ".concat(this.id),{collapsed:ne.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(e===void 0)return;let o=eE({vertexArray:t,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=qb({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:c,count:h}=qb({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});h>0&&ne.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&ne.log("UNUSED UNIFORMS",Object.keys(l))();let d=tE(this.vertexArray.configuration);ne.table(e,o)(),ne.table(e,a)(),ne.table(e+1,d)(),n&&n.log({logLevel:Ch,message:"Rendered to ".concat(n.id)}),ne.groupEnd(Ch)()}};var jf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof Se?i:i.buffer:null}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&J(fe(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let n in this.feedbackMap){let o=this.feedbackMap[n];n in t&&(i[o]=n)}Object.assign(i,e.feedbackBuffers);for(let n in i){let o=i[n];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;i[n]=this._createNewBuffer(n,{byteLength:l,usage:u,accessor:c})}}return i}_setupBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,t){let{model:i}=t,{program:n}=i;e.transformFeedback=new Gs(this.gl,{program:n,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:i})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(let n in this.feedbackMap){let o=this.feedbackMap[n];t[n]=e.feedbackBuffers[o],i[o]=e.sourceBuffers[n],J(i[o]instanceof Se)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){let i=new Se(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}};var eG="transform_uSampler_",pP="transform_uSize_",PI="transform_position";function yI(s){let{vs:e,sourceTextureMap:t,targetTextureVarying:i,targetTexture:n}=s,a=Object.keys(t).length,l=null,u={},c=e,h={};if(a>0||i){let d=c.split(`
`),f=d.slice();if(d.forEach((p,S,x)=>{if(a>0){let C=nG(p,t);if(C){let{updatedLine:O,inject:B}=C;f[S]=O,h=fh([h,B]),Object.assign(u,C.samplerTextureMap),a--}}i&&!l&&(l=iG(p,i))}),i){J(n);let p="".concat(pP).concat(i),S="uniform vec2 ".concat(p,`;
`),x="     vec2 ".concat(PI," = transform_getPos(").concat(p,`);
     gl_Position = vec4(`).concat(PI,`, 0, 1.);
`);h=fh([h,{"vs:#decl":S,"vs:#main-start":x}])}c=f.join(`
`)}return{vs:c,targetTextureType:l,inject:h,samplerTextureMap:u}}function SI(s){let{sourceTextureMap:e,targetTextureVarying:t,targetTexture:i}=s,n={},o,a;t&&({width:o,height:a}=i,n["".concat(pP).concat(t)]=[o,a]);for(let l in e)({width:o,height:a}=e[l]),n["".concat(pP).concat(l)]=[o,a];return n}function tG(s){return Kb(s,["attribute","in"])}function rG(s){let e="".concat(eG).concat(s),t="".concat(pP).concat(s),i="  uniform sampler2D ".concat(e,`;
  uniform vec2 `).concat(t,";");return{samplerName:e,sizeName:t,uniformDeclerations:i}}function iG(s,e){let t=Kb(s,["varying","out"]);return t&&t.name===e?t.type:null}function nG(s,e){let t={},i=tG(s);if(!i)return null;let{type:n,name:o}=i;if(o&&e[o]){let a="// ".concat(s," => Replaced by Transform with a sampler"),{samplerName:l,sizeName:u,uniformDeclerations:c}=rG(o),h=dE(n),d="  ".concat(n," ").concat(o," = transform_getInput(").concat(l,", ").concat(u,").").concat(h,`;
`);return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var oG={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},sG="transform_output",qf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let f=this.samplerTextureMap[d];l[d]=i[f]}this._setSourceTextureParameters();let h=SI({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,n.width,n.height]),{attributes:a,framebuffer:n,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{framebuffer:t}=this.bindings[this.currentIndex],i=Ms(t);if(!e)return i;let n=i.constructor,o=fE(this.targetTextureType),a=new n(i.length*o/4),l=0;for(let u=0;u<i.length;u+=4)for(let c=0;c<o;c++)a[l++]=i[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Ve)return i;let n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,o=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((i,n,o)=>{o[n]=n}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new Se(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:i})}}_updateBinding(e,t){let{sourceBuffers:i,sourceTextures:n,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new Me(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let i in t)t[i].setParameters(oG)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let i=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:i}}_createNewTexture(e){let t=kb(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=yI({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),c=fh([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||Uf({version:ch(n),input:this.targetTextureVarying,inputType:a,output:sG}),d=this.hasSourceTextures||this.targetTextureVarying?[_E].concat(e.modules||[]):e.modules;return{vs:n,fs:h,modules:d,uniforms:o,inject:c}}};var nn=class{static isSupported(e){return fe(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)e=e||i.swap();J(e,"Nothing to swap")}getBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t){let n=i.getData(e);if(n)return n}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)i.update(e)}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new At(t,Object.assign({},e,{fs:e.fs||Uf({version:ch(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=n.updateModelProps(t);return t}_buildResourceTransforms(e,t){aG(t)&&(this.bufferTransform=new jf(e,t)),lG(t)&&(this.textureTransform=new qf(e,t)),J(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=Object.assign(t,n.getDrawOptions(t));return t}};function aG(s){return!!(!Jo(s.feedbackBuffers)||!Jo(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function lG(s){return!!(!Jo(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var EI={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},gr=class{static get DRAW_MODE(){return EI}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{id:t=vi("geometry"),drawMode:i=EI.TRIANGLES,attributes:n={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(n,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let i in e){let n=e[i];n=ArrayBuffer.isView(n)?{value:n}:n,J(ArrayBuffer.isView(n.value),"".concat(this._print(i),": must be typed array or object with value as typed array")),(i==="POSITION"||i==="positions")&&!n.size&&(n.size=3),i==="indices"?(J(!this.indices),this.indices=n):this.attributes[i]=n}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let n in e){let o=e[n],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(i=Math.min(i,a.length/l))}return J(Number.isFinite(i)),i}};var uG=1,cG=1,il=class{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){let{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:o=1}=e,a=uG++,l={time:0,delay:t,duration:i,rate:n,repeat:o};return this._setChannelTime(l,this.time),this.channels.set(a,l),a}removeChannel(e){this.channels.delete(e);for(let[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;let t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);let t=this.channels.values();for(let n of t)this._setChannelTime(n,this.time);let i=this.animations.values();for(let n of i){let{animation:o,channel:a}=n;o.setTime(this.getTime(a))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=cG++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay,n=e.duration*e.repeat;i>=n?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}};var xI="#define SMOOTH_EDGE_RADIUS 0.5",hG=`
`.concat(xI,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),dG=`
`.concat(xI,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),vI={name:"geometry",vs:hG,fs:dG};var Be={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Be,"IDENTITY",{get:()=>(de.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var ci={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},zr={common:0,meters:1,pixels:2},ME={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},so={DRAW:"draw",MASK:"mask"};var fG=Object.keys(Be).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Be[s],";")).join(""),gG=Object.keys(ci).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(ci[s],";")).join(""),pG=Object.keys(zr).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(zr[s],";")).join(""),CI="".concat(fG,`
`).concat(gG,`
`).concat(pG,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function mG(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}return!1}function ao(s){let e={},t;return i=>{for(let n in i)if(!mG(i[n],e[n])){t=s(i),e=i;break}return t}}var AI=[0,0,0,0],bG=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],TI=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],PG=[0,0,0],II=[0,0,0],yG=ao(EG);function BE(s,e,t=II){t.length<3&&(t=[t[0],t[1],0]);let i=t,n,o=!0;switch(e===Be.LNGLAT_OFFSETS||e===Be.METER_OFFSETS?n=t:n=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case ci.WEB_MERCATOR:(e===Be.LNGLAT||e===Be.CARTESIAN)&&(n=[0,0,0],o=!1);break;case ci.WEB_MERCATOR_AUTO_OFFSET:e===Be.LNGLAT?i=n:e===Be.CARTESIAN&&(i=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],n=s.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case ci.IDENTITY:i=s.position.map(Math.fround),i[2]=i[2]||0;break;case ci.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:i,offsetMode:o}}function SG(s,e,t){let{viewMatrixUncentered:i,projectionMatrix:n}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=AI,u=AI,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:f}=BE(s,e,t);return f&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=oo([],u,a),o=i||o,a=$o([],n,o),a=$o([],a,bG)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function wI({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Be.DEFAULT,coordinateOrigin:n=II,autoWrapLongitude:o=!1}){i===Be.DEFAULT&&(i=s.isGeospatial?Be.LNGLAT:Be.CARTESIAN);let a=yG({viewport:s,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||TI,a}function EG({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){let{projectionCenter:n,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=SG(s,t,i),h=s.getDistanceScales(),d=[s.width*e,s.height*e],f=oo([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,p={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:n,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:PG,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:TI,project_uCameraPosition:l};if(c){let S=s.getDistanceScales(c);switch(t){case Be.METER_OFFSETS:p.project_uCommonUnitsPerWorldUnit=S.unitsPerMeter,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerMeter2;break;case Be.LNGLAT:case Be.LNGLAT_OFFSETS:s._pseudoMeters||(p.project_uCommonUnitsPerMeter=S.unitsPerMeter),p.project_uCommonUnitsPerWorldUnit=S.unitsPerDegree,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerDegree2;break;case Be.CARTESIAN:p.project_uCommonUnitsPerWorldUnit=[1,1,S.unitsPerMeter[2]],p.project_uCommonUnitsPerWorldUnit2=[0,0,S.unitsPerMeter2[2]];break;default:break}}return p}var xG={};function vG(s=xG){return"viewport"in s?wI(s):{}}var Lu={name:"project",dependencies:[Zb,vI],vs:CI,getUniforms:vG};var CG=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,hi={name:"project32",dependencies:[Lu],vs:CG};function DE(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function nl(s,e){let t=oo([],e,s);return Eh(t,t,1/t[3]),t}function FE(s,e){let t=s%e;return t<0?e+t:t}function Xf(s,e,t){return s<e?e:s>t?t:s}function AG(s){return Math.log(s)*Math.LOG2E}var Ah=Math.log2||AG;function _n(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var lo=Math.PI,LI=lo/4,uo=lo/180,GE=180/lo,Yf=512,VE=4003e4,Th=85.051129,RI=1.5;function kE(s){return Ah(s)}function Nn(s){let[e,t]=s;_n(Number.isFinite(e)),_n(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");let i=e*uo,n=t*uo,o=Yf*(i+lo)/(2*lo),a=Yf*(lo+Math.log(Math.tan(LI+n*.5)))/(2*lo);return[o,a]}function on(s){let[e,t]=s,i=e/Yf*(2*lo)-lo,n=2*(Math.atan(Math.exp(t/Yf*(2*lo)-lo))-LI);return[i*GE,n*GE]}function UE(s){let{latitude:e}=s;_n(Number.isFinite(e));let t=Math.cos(e*uo);return kE(VE*t)-9}function Ih(s){let{latitude:e,longitude:t,highPrecision:i=!1}=s;_n(Number.isFinite(e)&&Number.isFinite(t));let n=Yf,o=Math.cos(e*uo),a=n/360,l=a/o,u=n/VE/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[a,l,u],degreesPerUnit:[1/a,1/l,1/u]};if(i){let h=uo*Math.tan(e*uo)/o,d=a*h/2,f=n/VE*h,p=f/l*u;c.unitsPerDegree2=[0,d,f],c.unitsPerMeter2=[p,0,p]}return c}function Kf(s,e){let[t,i,n]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Ih({longitude:t,latitude:i,highPrecision:!0}),h=Nn(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=on(h),f=(n||0)+(l||0);return Number.isFinite(n)||Number.isFinite(l)?[d[0],d[1],f]:d}function mP(s){let{height:e,pitch:t,bearing:i,altitude:n,scale:o,center:a}=s,l=DE();Iu(l,l,[0,0,-n]),cP(l,l,-t*uo),hP(l,l,i*uo);let u=o/e;return Sh(l,l,[u,u,u]),a&&Iu(l,l,yT([],a)),l}function zE(s){let{width:e,height:t,altitude:i,pitch:n=0,offset:o,center:a,scale:l,nearZMultiplier:u=1,farZMultiplier:c=1}=s,{fovy:h=Ru(RI)}=s;i!==void 0&&(h=Ru(i));let d=h*uo,f=n*uo,p=Zf(h),S=p;a&&(S+=a[2]*l/Math.cos(f)/t);let x=d*(.5+(o?o[1]:0)/t),C=Math.sin(x)*S/Math.sin(Xf(Math.PI/2-f-x,.01,Math.PI-.01)),O=Math.sin(f)*C+S,B=S*10,I=Math.min(O*c,B);return{fov:d,aspect:e/t,focalDistance:p,near:u,far:I}}function Ru(s){return 2*Math.atan(.5/s)*GE}function Zf(s){return .5/Math.tan(.5*s*uo)}function wh(s,e){let[t,i,n=0]=s;return _n(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(n)),nl(e,[t,i,n,1])}function es(s,e,t=0){let[i,n,o]=s;if(_n(Number.isFinite(i)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(o))return nl(e,[i,n,o,1]);let a=nl(e,[i,n,0,1]),l=nl(e,[i,n,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return Jb([],a,l,h)}function Ou(s){let{width:e,height:t,bounds:i,minExtent:n=0,maxZoom:o=24,offset:a=[0,0]}=s,[[l,u],[c,h]]=i,d=TG(s.padding),f=Nn([l,Xf(h,-Th,Th)]),p=Nn([c,Xf(u,-Th,Th)]),S=[Math.max(Math.abs(p[0]-f[0]),n),Math.max(Math.abs(p[1]-f[1]),n)],x=[e-d.left-d.right-Math.abs(a[0])*2,t-d.top-d.bottom-Math.abs(a[1])*2];_n(x[0]>0&&x[1]>0);let C=x[0]/S[0],O=x[1]/S[1],B=(d.right-d.left)/2/C,I=(d.bottom-d.top)/2/O,_=[(p[0]+f[0])/2+B,(p[1]+f[1])/2+I],X=on(_),K=Math.min(o,Ah(Math.abs(Math.min(C,O))));return _n(Number.isFinite(K)),{longitude:X[0],latitude:X[1],zoom:K}}function TG(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(_n(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}var OI=Math.PI/180;function Qf(s,e=0){let{width:t,height:i,unproject:n}=s,o={targetZ:e},a=n([0,i],o),l=n([t,i],o),u,c,h=s.fovy?.5*s.fovy*OI:Math.atan(.5/s.altitude),d=(90-s.pitch)*OI;return h>d-.01?(u=_I(s,0,e),c=_I(s,t,e)):(u=n([0,0],o),c=n([t,0],o)),[a,l,c,u]}function _I(s,e,t){let{pixelUnprojectionMatrix:i}=s,n=nl(i,[e,0,1,1]),o=nl(i,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-n[2])/(o[2]-n[2]),u=Jb([],n,o,l),c=on(u);return c.push(t),c}var MI=512;function bP(s){let{width:e,height:t,pitch:i=0}=s,{longitude:n,latitude:o,zoom:a,bearing:l=0}=s;(n<-180||n>180)&&(n=FE(n+180,360)-180),(l<-180||l>180)&&(l=FE(l+180,360)-180);let u=Ah(t/MI);if(a<=u)a=u,o=0;else{let c=t/2/Math.pow(2,a),h=on([0,c])[1];if(o<h)o=h;else{let d=on([0,MI-c])[1];o>d&&(o=d)}}return{width:e,height:t,longitude:n,latitude:o,zoom:a,pitch:i,bearing:l}}var LG=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,RG=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,OG=ao(DG),_G=ao(FG),NG=[0,0,0,1],MG=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function BG(s,e){let[t,i,n]=s,o=es([t,i,n],e);return Number.isFinite(n)?o:[o[0],o[1],0]}function DG({viewport:s,center:e}){return new it(s.viewProjectionMatrix).invert().transform(e)}function FG({viewport:s,shadowMatrices:e}){let t=[],i=s.pixelUnprojectionMatrix,n=s.isGeospatial?void 0:1,o=[[0,0,n],[s.width,0,n],[0,s.height,n],[s.width,s.height,n],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(a=>BG(a,i));for(let a of e){let l=a.clone().translate(new re(s.center).negate()),u=o.map(h=>l.transform(h)),c=new it().ortho({left:Math.min(...u.map(h=>h[0])),right:Math.max(...u.map(h=>h[0])),bottom:Math.min(...u.map(h=>h[1])),top:Math.max(...u.map(h=>h[1])),near:Math.min(...u.map(h=>-h[2])),far:Math.max(...u.map(h=>-h[2]))});t.push(c.multiplyRight(a))}return t}function GG(s,e){let{shadowEnabled:t=!0}=s;if(!t||!s.shadowMatrices||!s.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};let i={shadow_uDrawShadowMap:Boolean(s.drawToShadowMap),shadow_uUseShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,shadow_uColor:s.shadowColor||NG,shadow_uLightId:s.shadowLightId||0,shadow_uLightCount:s.shadowMatrices.length},n=OG({viewport:s.viewport,center:e.project_uCenter}),o=[],a=_G({shadowMatrices:s.shadowMatrices,viewport:s.viewport}).slice();for(let l=0;l<s.shadowMatrices.length;l++){let u=a[l],c=u.clone().translate(new re(s.viewport.center).negate());e.project_uCoordinateSystem===Be.LNGLAT&&e.project_uProjectionMode===ci.WEB_MERCATOR?(a[l]=c,o[l]=n):(a[l]=u.clone().multiplyRight(MG),o[l]=c.transform(n))}for(let l=0;l<a.length;l++)i["shadow_uViewProjectionMatrices[".concat(l,"]")]=a[l],i["shadow_uProjectCenters[".concat(l,"]")]=o[l],s.shadowMaps&&s.shadowMaps.length>0?i["shadow_uShadowMap".concat(l)]=s.shadowMaps[l]:i["shadow_uShadowMap".concat(l)]=s.dummyShadowMap;return i}var Jf={name:"shadow",dependencies:[Lu],vs:LG,fs:RG,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(s={},e={})=>"viewport"in s&&(s.drawToShadowMap||s.shadowMaps&&s.shadowMaps.length>0)?GG(s,e):{}};var Mn={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...rl};var VG=[Lu],kG=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function BI(s){let e=rn.getDefaultProgramManager(s);for(let t of VG)e.addDefaultModule(t);for(let t of kG)e.addShaderHook(t);return e}var UG=[255,255,255],zG=1,WG=0,PP=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","ambient");let{color:t=UG}=e,{intensity:i=zG}=e;this.id=e.id||"ambient-".concat(WG++),this.color=t,this.intensity=i}};var HG=[255,255,255],jG=1,qG=[0,0,-1],XG=0,$f=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","directional"),y(this,"direction",void 0),y(this,"shadow",void 0);let{color:t=HG}=e,{intensity:i=jG}=e,{direction:n=qG}=e,{_shadow:o=!1}=e;this.id=e.id||"directional-".concat(XG++),this.color=t,this.intensity=i,this.type="directional",this.direction=new re(n).normalize().toArray(),this.shadow=o}getProjectedLight(e){return this}};var eg=class{constructor(e,t={id:"pass"}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"props",void 0);let{id:i}=t;this.id=i,this.gl=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}};var co=class extends eg{constructor(...e){super(...e),y(this,"_lastRenderIndex",-1)}render(e){let t=this.gl;return xi(t,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){let{target:t,moduleParameters:i,viewports:n,views:o,onViewportActive:a,clearStack:l=!0,clearCanvas:u=!0}=e;e.pass=e.pass||"unknown";let c=this.gl;u&&KG(c),l&&(this._lastRenderIndex=-1);let h=[];for(let d of n){let f=o&&o[d.id];a(d);let p=this._getDrawLayerParams(d,e),S=d.subViewports||[d];for(let x of S){let C=this._drawLayersInViewport(c,{target:t,moduleParameters:i,viewport:x,view:f,pass:e.pass,layers:e.layers},p);h.push(C)}}return h}_getDrawLayerParams(e,{layers:t,pass:i,layerFilter:n,cullRect:o,effects:a,moduleParameters:l}){let u=[],c=DI(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:i.startsWith("picking"),renderPass:i,cullRect:o},d={};for(let f=0;f<t.length;f++){let p=t[f],S=this._shouldDrawLayer(p,h,n,d),x={shouldDrawLayer:S};S&&(x.layerRenderIndex=c(p,S),x.moduleParameters=this._getModuleParameters(p,a,i,l),x.layerParameters=this.getLayerParameters(p,f,e)),u[f]=x}return u}_drawLayersInViewport(e,{layers:t,moduleParameters:i,pass:n,target:o,viewport:a,view:l},u){let c=YG(e,{moduleParameters:i,target:o,viewport:a});if(l&&l.props.clear){let d=l.props.clear===!0?{color:!0,depth:!0}:l.props.clear;ft(e,{scissorTest:!0,scissor:c},()=>Ka(e,d))}let h={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};xi(e,{viewport:c});for(let d=0;d<t.length;d++){let f=t[d],{shouldDrawLayer:p,layerRenderIndex:S,moduleParameters:x,layerParameters:C}=u[d];if(p&&f.props.pickable&&h.pickableCount++,f.isComposite)h.compositeCount++;else if(p){h.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,S),x.viewport=a;try{f._drawLayer({moduleParameters:x,uniforms:{layerIndex:S},parameters:C})}catch(O){f.raiseError(O,"drawing ".concat(f," to ").concat(n))}}}return h}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,n){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let a=e.parent;for(;a;){if(!a.props.visible||!a.filterSubLayer(t))return!1;t.layer=a,a=a.parent}if(i){let l=t.layer.id;if(l in n||(n[l]=i(t)),!n[l])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,i,n){var o;let a=Object.assign(Object.create(((o=e.internalState)===null||o===void 0?void 0:o.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:to(this.gl)});if(t)for(let u of t){var l;Object.assign(a,(l=u.getModuleParameters)===null||l===void 0?void 0:l.call(u,e))}return Object.assign(a,this.getModuleParameters(e,t),n)}};function DI(s=0,e={}){let t={},i=(n,o)=>{let a=n.props._offset,l=n.id,u=n.parent&&n.parent.id,c;if(u&&!(u in e)&&i(n.parent,!1),u in t){let h=t[u]=t[u]||DI(e[u],e);c=h(n,o),t[l]=h}else Number.isFinite(a)?(c=a+(e[u]||0),t[l]=null):c=s;return o&&c>=s&&(s=c+1),e[l]=c,c};return i}function YG(s,{moduleParameters:e,target:t,viewport:i}){let n=t&&t.id!=="default-framebuffer",o=e&&e.devicePixelRatio||to(s),a=n?t.height:s.drawingBufferHeight,l=i;return[l.x*o,a-(l.y+l.height)*o,l.width*o,l.height*o]}function KG(s){let e=s.drawingBufferWidth,t=s.drawingBufferHeight;xi(s,{viewport:[0,0,e,t]}),s.clear(16640)}var tg=class extends co{constructor(e,t){super(e,t),y(this,"shadowMap",void 0),y(this,"depthBuffer",void 0),y(this,"fbo",void 0),this.shadowMap=new Ve(e,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new Gi(e,{format:33189,width:1,height:1}),this.fbo=new Me(e,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(e){let t=this.fbo;ft(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{let i=e.viewports[0],n=to(this.gl),o=i.width*n,a=i.height*n;(o!==t.width||a!==t.height)&&t.resize({width:o,height:a}),super.render({...e,target:t,pass:"shadow"})})}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}};var ZG={color:[255,255,255],intensity:1},FI=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],QG=[0,0,0,200/255],Lh=class{constructor(e={}){y(this,"id","lighting-effect"),y(this,"props",null),y(this,"shadowColor",QG),y(this,"shadow",void 0),y(this,"ambientLight",null),y(this,"directionalLights",[]),y(this,"pointLights",[]),y(this,"shadowPasses",[]),y(this,"shadowMaps",[]),y(this,"dummyShadowMap",null),y(this,"programManager",void 0),y(this,"shadowMatrices",void 0);for(let t in e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break;default:}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(e),this.programManager||(this.programManager=rn.getDefaultProgramManager(e),Jf&&this.programManager.addDefaultModule(Jf)),this.dummyShadowMap||(this.dummyShadowMap=new Ve(e,{width:1,height:1}));for(let l=0;l<this.shadowPasses.length;l++)this.shadowPasses[l].render({layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a,moduleParameters:{shadowLightId:l,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){let t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:e})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:e}))},t}cleanup(){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(Jf),this.programManager=null)}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new it().lookAt({eye:new re(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new tg(e);this.shadowPasses[t]=i,this.shadowMaps[t]=i.shadowMap}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new PP(ZG),this.directionalLights.push(new $f(FI[0]),new $f(FI[1])))}};var WE=class{constructor(e={}){y(this,"_pool",[]),y(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:n,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=n||e&&e.constructor||Float32Array,h=t*i+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d=1/0;u&&(d=u*i+o);let f=this._allocate(c,h,l,d);return e&&a?f.set(e):l||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,i,n){let o=Math.max(Math.ceil(t*this.opts.overAlloc),1);o>n&&(o=n);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return i&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:n}=i,o=t.findIndex(a=>a.byteLength>=n);o<0?t.push(i):(o>0||t.length<this.opts.poolSize)&&t.splice(o,0,i),t.length>this.opts.poolSize&&t.shift()}},ho=new WE;function Oh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function VI(s,e){let t=s%e;return t<0?e+t:t}function kI(s){return[s[12],s[13],s[14]]}function UI(s){return{left:Rh(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:Rh(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:Rh(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:Rh(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:Rh(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:Rh(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var GI=new re;function Rh(s,e,t,i){GI.set(s,e,t);let n=GI.len();return{distance:i/n,normal:new re(-s/n,-e/n,-t/n)}}function JG(s){return s-Math.fround(s)}var rg;function yP(s,e){let{size:t=1,startIndex:i=0}=e,n=e.endIndex!==void 0?e.endIndex:s.length,o=(n-i)/t;rg=ho.allocate(rg,o,{type:Float32Array,size:t*2});let a=i,l=0;for(;a<n;){for(let u=0;u<t;u++){let c=s[a++];rg[l+u]=c,rg[l+u+t]=JG(c)}l+=t*2}return rg.subarray(0,o*t*2)}var $G=Math.PI/180,eV=Oh(),zI=[0,0,0],tV={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function rV({width:s,height:e,orthographic:t,fovyRadians:i,focalDistance:n,padding:o,near:a,far:l}){let u=s/e,c=t?new it().orthographic({fovy:i,aspect:u,focalDistance:n,near:a,far:l}):new it().perspective({fovy:i,aspect:u,near:a,far:l});if(o){let{left:h=0,right:d=0,top:f=0,bottom:p=0}=o,S=Ot((h+s-d)/2,0,s)-s/2,x=Ot((f+e-p)/2,0,e)-e/2;c[8]-=S*2/s,c[9]+=x*2/e}return c}var di=class{constructor(e={}){y(this,"id",void 0),y(this,"x",void 0),y(this,"y",void 0),y(this,"width",void 0),y(this,"height",void 0),y(this,"padding",void 0),y(this,"isGeospatial",void 0),y(this,"zoom",void 0),y(this,"focalDistance",void 0),y(this,"position",void 0),y(this,"modelMatrix",void 0),y(this,"distanceScales",void 0),y(this,"scale",void 0),y(this,"center",void 0),y(this,"cameraPosition",void 0),y(this,"projectionMatrix",void 0),y(this,"viewMatrix",void 0),y(this,"viewMatrixUncentered",void 0),y(this,"viewMatrixInverse",void 0),y(this,"viewProjectionMatrix",void 0),y(this,"pixelProjectionMatrix",void 0),y(this,"pixelUnprojectionMatrix",void 0),y(this,"resolution",void 0),y(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||tV,this.focalDistance=e.focalDistance||1,this.position=e.position||zI,this.modelMatrix=e.modelMatrix||null;let{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?ci.WEB_MERCATOR:ci.WEB_MERCATOR_AUTO_OFFSET:ci.IDENTITY}equals(e){return e instanceof di?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&kr(e.projectionMatrix,this.projectionMatrix)&&kr(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let i=this.projectPosition(e),n=wh(i,this.pixelProjectionMatrix),[o,a]=n,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,n[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,u=i&&i*this.distanceScales.unitsPerMeter[2],c=es([n,l,a],this.pixelUnprojectionMatrix,u),[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i]=this.projectFlat(e),n=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,n]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e),n=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,n]}projectFlat(e){if(this.isGeospatial){let t=Nn(e);return t[1]=Ot(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?on(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],o[0],a[0]),Math.min(i[1],n[1],o[1],a[1]),Math.max(i[0],n[0],o[0],a[0]),Math.max(i[1],n[1],o[1],a[1])]}getDistanceScales(e){return e?Ih({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,UI(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=UE({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Ih({latitude:i,longitude:t}));let n=Math.pow(2,this.zoom);this.scale=n;let{position:o,modelMatrix:a}=e,l=zI;if(o&&(l=a?new it(a).transformAsVector(o,[]):o),this.isGeospatial){let u=this.projectPosition([t,i,0]);this.center=new re(l).scale(this.distanceScales.unitsPerMeter).add(u)}else this.center=this.projectPosition(l)}_initMatrices(e){let{viewMatrix:t=eV,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:o,fovy:a=75,near:l=.1,far:u=1e3,padding:c=null,focalDistance:h=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new it().multiplyRight(t).translate(new re(this.center).negate()),this.projectionMatrix=i||rV({width:this.width,height:this.height,orthographic:n,fovyRadians:o||a*$G,focalDistance:h,padding:c,near:l,far:u});let d=Oh();$o(d,d,this.projectionMatrix),$o(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=zf([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=kI(this.viewMatrixInverse);let f=Oh(),p=Oh();Sh(f,f,[this.width/2,-this.height/2,1]),Iu(f,f,[1,-1,0]),$o(p,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=p,this.pixelUnprojectionMatrix=zf(Oh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||de.warn("Pixel project matrix not invertible")()}};y(di,"displayName","Viewport");var iV=512,nV=4003e4,oV=Math.PI/180;function WI(s){let e=Math.cos(s*oV);return iV/nV/e}var Ir=class extends di{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,legacyMeterSizes:p=!1}=e,{width:S,height:x,altitude:C=1.5}=e,O=Math.pow(2,n);S=S||1,x=x||1;let B,I=null;h?(C=h[5]/2,B=Ru(C)):(e.fovy?(B=e.fovy,C=Zf(B)):B=Ru(C),I=zE({width:S,height:x,pitch:o,fovy:B,nearZMultiplier:l,farZMultiplier:u}));let _=mP({height:x,pitch:o,bearing:a,scale:O,altitude:C});f&&(_=new it().translate([512*f,0,0]).multiplyLeft(_)),super({...e,width:S,height:x,viewMatrix:_,longitude:i,latitude:t,zoom:n,...I,fovy:B,focalDistance:C}),y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"pitch",void 0),y(this,"bearing",void 0),y(this,"altitude",void 0),y(this,"fovy",void 0),y(this,"orthographic",void 0),y(this,"_subViewports",void 0),y(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=o,this.bearing=a,this.altitude=C,this.fovy=B,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=p,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let n=t;n<=i;n++){let o=n?new Ir({...this,worldOffset:n}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e),n=(e[2]||0)*WI(e[1]);return[t,i,n]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),n=(e[2]||0)/WI(i);return[t,i,n]}addMetersToLngLat(e,t){return Kf(e,t)}panByPosition(e,t){let i=es(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=mh([],n,Qb([],i)),a=mh([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=Qf(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:n}=this,{longitude:o,latitude:a,zoom:l}=Ou({width:i,height:n,bounds:e,...t});return new Ir({width:i,height:n,longitude:o,latitude:a,zoom:l})}};y(Ir,"displayName","WebMercatorViewport");function HE(s,e,t=!1){let i=e.projectPosition(s);if(t&&e instanceof Ir){let[n,o,a=0]=s,l=e.getDistanceScales([n,o]);i[2]=a*l.unitsPerMeter[2]}return i}function sV(s){let{viewport:e,modelMatrix:t,coordinateOrigin:i}=s,{coordinateSystem:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return n===Be.DEFAULT&&(n=e.isGeospatial?Be.LNGLAT:Be.CARTESIAN),o===void 0&&(o=n),a===void 0&&(a=i),{viewport:e,coordinateSystem:n,coordinateOrigin:i,modelMatrix:t,fromCoordinateSystem:o,fromCoordinateOrigin:a}}function jE(s,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:n,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=oo([],[a,l,u,1],t)),i){case Be.LNGLAT:return HE([a,l,u],e,o);case Be.LNGLAT_OFFSETS:return HE([a+n[0],l+n[1],u+(n[2]||0)],e,o);case Be.METER_OFFSETS:return HE(Kf(n,[a,l,u]),e,o);case Be.CARTESIAN:default:return e.isGeospatial?[a+n[0],l+n[1],u+n[2]]:e.projectPosition([a,l,u])}}function HI(s,e){let{viewport:t,coordinateSystem:i,coordinateOrigin:n,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=sV(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=BE(t,i,n),d=jE(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let f=t.projectPosition(u||c);iP(d,d,f)}return d}var ol={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},_h=Symbol.for("component"),ks=Symbol.for("asyncPropDefaults"),ts=Symbol.for("asyncPropOriginal"),fo=Symbol.for("asyncPropResolved");function Us(s,e=()=>!0){return Array.isArray(s)?jI(s,e,[]):e(s)?[s]:[]}function jI(s,e,t){let i=-1;for(;++i<s.length;){let n=s[i];Array.isArray(n)?jI(n,e,t):e(n)&&t.push(n)}return t}function qE({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var ig=class{constructor(e,t,i){y(this,"id",void 0),y(this,"context",void 0),y(this,"isLoaded",void 0),y(this,"persistent",void 0),y(this,"_loadCount",0),y(this,"_subscribers",new Set),y(this,"_data",void 0),y(this,"_loader",void 0),y(this,"_error",void 0),y(this,"_content",void 0),this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,n=e;typeof e=="string"&&(n=Zo(e)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=o)}).catch(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=o||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(let o of this._subscribers)o.onChange(this.getData())}};var ng=class{constructor({gl:e,protocol:t}){y(this,"protocol",void 0),y(this,"_context",void 0),y(this,"_resources",void 0),y(this,"_consumers",void 0),y(this,"_pruneRequest",void 0),this.protocol=t||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:n=!0}){let o=this._resources[e];o?o.setData(t,i):(o=new ig(e,t,this._context),this._resources[e]=o),o.persistent=n}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let i in t){let n=t[i],o=this._resources[n.resourceId];o&&o.unsubscribe(n)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:n="default"}){let{_resources:o,protocol:a}=this;e.startsWith(a)&&(e=e.replace(a,""),o[e]||this.add({resourceId:e,data:null,persistent:!1}));let l=o[e];if(this._track(i,n,l,t),l)return l.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,n){let o=this._consumers,a=o[e]=o[e]||{},l=a[t]||{},u=l.resourceId&&this._resources[l.resourceId];u&&(u.unsubscribe(l),this.prune()),i&&(a[t]=l,l.onChange=n,l.resourceId=i.id,i.subscribe(l))}_prune(){this._pruneRequest=null;for(let e of Object.keys(this._resources)){let t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}};var aV="layerManager.setLayers",lV="layerManager.activateViewport",og=class{constructor(e,{deck:t,stats:i,viewport:n,timeline:o}={}){y(this,"layers",void 0),y(this,"context",void 0),y(this,"resourceManager",void 0),y(this,"_lastRenderedLayers",[]),y(this,"_needsRedraw",!1),y(this,"_needsUpdate",!1),y(this,"_nextLayers",null),y(this,"_debug",!1),y(this,"activateViewport",a=>{kt(lV,this,a),a&&(this.context.viewport=a)}),this.layers=[],this.resourceManager=new ng({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:t,programManager:e&&BI(e),stats:i||new $i({id:"deck.gl"}),viewport:n||new di({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new il,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(let e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(let i of this.layers){let n=i.getNeedsRedraw(e);t=t||n}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){kt(aV,this,t,e),this._lastRenderedLayers=e;let i=Us(e,Boolean);for(let n of i)n.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,t,i){i.raiseError(t,"".concat(e," of ").concat(i))}_updateLayers(e,t){let i={};for(let a of e)i[a.id]?de.warn("Multiple old layers with same id ".concat(a.id))():i[a.id]=a;let n=[];this._updateSublayersRecursively(t,i,n),this._finalizeOldLayers(i);let o=!1;for(let a of n)if(a.hasUniformTransition()){o="Uniform transition in ".concat(a);break}this._needsUpdate=o,this.layers=n}_updateSublayersRecursively(e,t,i){for(let n of e){n.context=this.context;let o=t[n.id];o===null&&de.warn("Multiple new layers with same id ".concat(n.id))(),t[n.id]=null;let a=null;try{this._debug&&o!==n&&n.validateProps(),o?(this._transferLayerState(o,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),a=n.isComposite?n.getSubLayers():null}catch(l){this._handleError("matching",l,n)}a&&this._updateSublayersRecursively(a,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=ol.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=ol.MATCHED,t!==e&&(e.lifecycle=ol.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=ol.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=ol.FINALIZED}catch(t){this._handleError("finalization",t,e)}}};function sn(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let i=s[t],n=e[t];if(!(i===n||Array.isArray(i)&&Array.isArray(n)&&sn(i,n)))return!1}return!0}var sg=class{constructor(e){y(this,"width",void 0),y(this,"height",void 0),y(this,"views",void 0),y(this,"viewState",void 0),y(this,"controllers",void 0),y(this,"timeline",void 0),y(this,"_viewports",void 0),y(this,"_viewportMap",void 0),y(this,"_isUpdating",void 0),y(this,"_needsRedraw",void 0),y(this,"_needsUpdate",void 0),y(this,"_eventManager",void 0),y(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),n={x:e[0],y:e[1]};for(let o=i.length-1;o>=0;--o){let a=i[o];if(a.containsPixel(n)){let l=e.slice();return l[0]-=a.x,l[1]-=a.y,a.unproject(l,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Us(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!sn(e,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):de.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,t){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...t,viewId:e})}_createController(e,t){let i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,t.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:o=>{var a;return(a=this.getView(e.id))===null||a===void 0?void 0:a.makeViewport({viewState:o,width:this.width,height:this.height})}})}_updateController(e,t,i,n){let o=e.controller;if(o){let a={...t,...o,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return n||(n=this._createController(e,a)),n&&n.setProps(a),n}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=e.length;n--;){let o=e[n],a=this.getViewState(o),l=o.makeViewport({viewState:a,width:this.width,height:this.height}),u=t[o.id],c=Boolean(o.controller);c&&!u&&(i=!0),(i||!c)&&u&&(u.finalize(),u=null),this.controllers[o.id]=this._updateController(o,a,l,u),this._viewports.unshift(l)}for(let n in t){let o=t[n];o&&!this.controllers[n]&&o.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,n)=>!e[n].equals(t[n]))}};var uV=/([0-9]+\.?[0-9]*)(%|px)/;function zs(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":let e=uV.exec(s);if(e&&e.length>=3){let t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error("Could not parse position string ".concat(s))}}function Ws(s,e){return s.relative?Math.round(s.position*e):s.position}function gt(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}var _u=class{constructor(e){y(this,"id",void 0),y(this,"viewportInstance",void 0),y(this,"_x",void 0),y(this,"_y",void 0),y(this,"_width",void 0),y(this,"_height",void 0),y(this,"_padding",void 0),y(this,"props",void 0);let{id:t,x:i=0,y:n=0,width:o="100%",height:a="100%",padding:l=null,viewportInstance:u}=e||{};gt(!u||u instanceof di),this.viewportInstance=u,this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=zs(i),this._y=zs(n),this._width=zs(o),this._height=zs(a),this._padding=l&&{left:zs(l.left||0),right:zs(l.right||0),top:zs(l.top||0),bottom:zs(l.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.viewportInstance?e.viewportInstance?this.viewportInstance.equals(e.viewportInstance):!1:this.ViewportType===e.ViewportType&&sn(this.props,e.props)}makeViewport({width:e,height:t,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);let n=this.getDimensions({width:e,height:t});return new this.ViewportType({...i,...this.props,...n})}getViewStateId(){let{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){let i={x:Ws(this._x,e),y:Ws(this._y,t),width:Ws(this._width,e),height:Ws(this._height,t)};return this._padding&&(i.padding={left:Ws(this._padding.left,e),top:Ws(this._padding.top,t),right:Ws(this._padding.right,e),bottom:Ws(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}};var an=class{constructor(e){y(this,"_inProgress",void 0),y(this,"_handle",void 0),y(this,"_timeline",void 0),y(this,"time",void 0),y(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,(t=(i=this.settings).onStart)===null||t===void 0||t.call(i,this)}end(){if(this._inProgress){var e,t;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(t=this.settings).onEnd)===null||e===void 0||e.call(t,this)}}cancel(){if(this._inProgress){var e,t;(e=(t=this.settings).onInterrupt)===null||e===void 0||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:i,settings:n}=this;this._handle=i.addChannel({delay:i.getTime(),duration:n.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(t=this.settings).onUpdate)===null||e===void 0||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var qI=()=>{},XE={BREAK:1,SNAP_TO_END:2,IGNORE:3},cV=s=>s,hV=XE.BREAK,ag=class{constructor(e){y(this,"getControllerState",void 0),y(this,"props",void 0),y(this,"propsInTransition",void 0),y(this,"transition",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"_onTransitionUpdate",t=>{let{time:i,settings:{interpolator:n,startProps:o,endProps:a,duration:l,easing:u}}=t,c=u(i/l),h=n.interpolateProps(o,a,c);this.propsInTransition=this.getControllerState({...this.props,...h}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new an(e.timeline),this.onViewStateChange=e.onViewStateChange||qI,this.onStateChange=e.onStateChange||qI}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let n=i;if(this.transition.inProgress){let{interruption:o,endProps:a}=this.transition.settings;n={...i,...o===XE.SNAP_TO_END?a:this.propsInTransition||i}}this._triggerTransition(n,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&Boolean(i)}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===XE.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){let i=this.getControllerState(e),n=this.getControllerState(t).shortestPathFrom(i),o=t.transitionInterpolator,a=o.getDuration?o.getDuration(e,t):t.transitionDuration;if(a===0)return;let l=o.initializeProps(e,n);this.propsInTransition={};let u={duration:a,easing:t.transitionEasing||cV,interpolator:o,interruption:t.transitionInterruption||hV,startProps:l.start,endProps:l.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(u),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}};var lg=class{constructor(e){y(this,"_propsToCompare",void 0),y(this,"_propsToExtract",void 0),y(this,"_requiredProps",void 0);let{compare:t,extract:i,required:n}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=n}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!kr(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},n={};for(let o of this._propsToExtract)(o in e||o in t)&&(i[o]=e[o],n[o]=t[o]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){!this._requiredProps||this._requiredProps.forEach(t=>{let i=e[t];gt(Number.isFinite(i)||Array.isArray(i),"".concat(t," is required for transition"))})}};var dV=["longitude","latitude","zoom","bearing","pitch"],fV=["longitude","latitude","zoom"],Bn=class extends lg{constructor(e={}){let t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:dV,required:fV},super(i.transitionProps),y(this,"opts",void 0),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:n,around:o}=this.opts;if(n&&o){let a=n(e),l=n(t),u=a.unproject(o);i.start.around=o,Object.assign(i.end,{around:l.project(u),aroundPosition:u,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let n={};for(let o of this._propsToExtract)n[o]=vu(e[o]||0,t[o]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let o=this.opts.makeViewport({...t,...n});Object.assign(n,o.panByPosition(t.aroundPosition,vu(e.around,t.around,i)))}return n}};var sl={transitionDuration:0},gV=300,SP=s=>1-(1-s)*(1-s),Nh={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},Nu={},Mu=class{constructor(e){y(this,"props",void 0),y(this,"state",{}),y(this,"transitionManager",void 0),y(this,"eventManager",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"makeViewport",void 0),y(this,"_controllerState",void 0),y(this,"_events",{}),y(this,"_interactionState",{isDragging:!1}),y(this,"_customEvents",[]),y(this,"_eventStartBlocked",null),y(this,"_panMove",!1),y(this,"invertPan",!1),y(this,"dragMode","rotate"),y(this,"inertia",0),y(this,"scrollZoom",!0),y(this,"dragPan",!0),y(this,"dragRotate",!0),y(this,"doubleClickZoom",!0),y(this,"touchZoom",!0),y(this,"touchRotate",!1),y(this,"keyboard",!0),this.transitionManager=new ag({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let t in this._events)if(this._events[t]){var e;(e=this.eventManager)===null||e===void 0||e.off(t,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return t?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:n}=e;return[n.x-t,n.y-i]}isPointInBounds(e,t){let{width:i,height:n}=this.props;if(t&&t.handled)return!1;let o=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=n;return o&&t&&t.stopPropagation(),o}isFunctionKeyPressed(e){let{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?gV:0;let{scrollZoom:i=!0,dragPan:n=!0,dragRotate:o=!0,doubleClickZoom:a=!0,touchZoom:l=!0,touchRotate:u=!1,keyboard:c=!0}=e,h=Boolean(this.onViewStateChange);this.toggleEvents(Nh.WHEEL,h&&i),this.toggleEvents(Nh.PAN,h&&(n||o)),this.toggleEvents(Nh.PINCH,h&&(l||u)),this.toggleEvents(Nh.TRIPLE_PAN,h&&u),this.toggleEvents(Nh.DOUBLE_TAP,h&&a),this.toggleEvents(Nh.KEYBOARD,h&&c),this.scrollZoom=i,this.dragPan=n,this.dragRotate=o,this.doubleClickZoom=a,this.touchZoom=l,this.touchRotate=u,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){let n={...e.getViewportProps(),...t},o=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),o){let a=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:a})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);let n=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(n,sl,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,sl,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.pan({pos:n}).panEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:SP},{isDragging:!1,isPanning:!0})}else{let i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,sl,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.rotate({pos:n}).rotateEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:SP},{isDragging:!1,isRotating:!0})}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;e.srcEvent.preventDefault();let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let{speed:i=.01,smooth:n=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:o}=e,a=2/(1+Math.exp(-Math.abs(o*i)));o<0&&a!==0&&(a=1/a);let l=this.controllerState.zoom({pos:t,scale:a});return this.updateViewport(l,{...this._getTransitionProps({around:t}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,sl,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,sl,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),n=[i[0],i[1]+=e.velocityY*t/2],o=this.controllerState.rotate({pos:n});this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:SP},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Nu._startPinchRotation=e.rotation,Nu._lastPinchEvent=e,this.updateViewport(i,sl,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,n=this.getCenter(e);t=t.zoom({pos:n,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:Nu._startPinchRotation-i})}return this.updateViewport(t,sl,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Nu._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=Nu;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let n=this.getCenter(e),o=this.controllerState.rotateEnd(),a=Math.log2(e.scale),l=(a-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),u=Math.pow(2,a+l*t/2);o=o.zoom({pos:n,scale:u}).zoomEnd(),this.updateViewport(o,{...this._getTransitionProps({around:n}),transitionDuration:t,transitionEasing:SP},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let n=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Nu._startPinchRotation=null,Nu._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),n=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;let t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:o,rotateSpeedY:a}=this.keyboard===!0?{}:this.keyboard,{controllerState:l}=this,u,c={};switch(e.srcEvent.code){case"Minus":u=t?l.zoomOut(i).zoomOut(i):l.zoomOut(i),c.isZooming=!0;break;case"Equal":u=t?l.zoomIn(i).zoomIn(i):l.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":t?(u=l.rotateLeft(o),c.isRotating=!0):(u=l.moveLeft(n),c.isPanning=!0);break;case"ArrowRight":t?(u=l.rotateRight(o),c.isRotating=!0):(u=l.moveRight(n),c.isPanning=!0);break;case"ArrowUp":t?(u=l.rotateUp(a),c.isRotating=!0):(u=l.moveUp(n),c.isPanning=!0);break;case"ArrowDown":t?(u=l.rotateDown(a),c.isRotating=!0):(u=l.moveDown(n),c.isPanning=!0);break;default:return!1}return this.updateViewport(u,this._getTransitionProps(),c),!0}_getTransitionProps(e){let{transition:t}=this;return!t||!t.transitionInterpolator?sl:e?{...t,transitionInterpolator:new Bn({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}};var Bu=class{constructor(e,t){y(this,"_viewportProps",void 0),y(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}};var XI=5,pV=1.2,YE=class extends Bu{constructor(e){let{width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l=0,pitch:u=0,altitude:c=1.5,position:h=[0,0,0],maxZoom:d=20,minZoom:f=0,maxPitch:p=60,minPitch:S=0,startPanLngLat:x,startZoomLngLat:C,startRotatePos:O,startBearing:B,startPitch:I,startZoom:_,normalize:X=!0}=e;gt(Number.isFinite(o)),gt(Number.isFinite(n)),gt(Number.isFinite(a)),super({width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l,pitch:u,altitude:c,maxZoom:d,minZoom:f,maxPitch:p,minPitch:S,normalize:X,position:h},{startPanLngLat:x,startZoomLngLat:C,startRotatePos:O,startBearing:B,startPitch:I,startZoom:_}),y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startBearing:o,startPitch:a}=this.getState();if(!n||o===void 0||a===void 0)return this;let l;return e?l=this._getNewRotation(e,n,a,o):l={bearing:o+t,pitch:a+i},this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomLngLat:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let{maxZoom:a,minZoom:l}=this.getViewportProps(),u=n+Math.log2(i);u=Ot(u,l,a);let c=this.makeViewport({...this.getViewportProps(),zoom:u});return this._getUpdatedState({zoom:u,...c.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:o}=i;return Math.abs(n-t.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(o-t.longitude)>180&&(i.longitude=o<0?o+360:o-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n}=e;e.zoom=Ot(n,i,t);let{maxPitch:o,minPitch:a,pitch:l}=e;e.pitch=Ot(l,a,o);let{normalize:u=!0}=e;return u&&Object.assign(e,bP(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,n){let o=e[0]-t[0],a=e[1]-t[1],l=e[1],u=t[1],{width:c,height:h}=this.getViewportProps(),d=o/c,f=0;a>0?Math.abs(h-u)>XI&&(f=a/(u-h)*pV):a<0&&u>XI&&(f=1-l/u),f=Ot(f,-1,1);let{minPitch:p,maxPitch:S}=this.getViewportProps(),x=n+180*d,C=i;return f>0?C=i+f*(S-i):f<0&&(C=i-f*(p-i)),{pitch:C,bearing:x}}},ug=class extends Mu{constructor(...e){super(...e),y(this,"ControllerState",YE),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Bn({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),y(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}};var Mh=class extends _u{get ViewportType(){return Ir}get ControllerType(){return ug}};y(Mh,"displayName","MapView");var cg=class extends co{constructor(e,t){super(e,t),y(this,"maskMap",void 0),y(this,"fbo",void 0);let{mapSize:i=2048}=t;this.maskMap=new Ve(e,{width:i,height:i,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new Me(e,{id:"maskmap",width:i,height:i,attachments:{[36064]:this.maskMap}})}render(e){let t=this.gl,i=[!1,!1,!1,!1];return i[e.channel]=!0,ft(t,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:i,depthTest:!1},()=>super.render({...e,target:this.fbo,pass:"mask"}))}shouldDrawLayer(e){return e.props.operation===so.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}};var mV=new it().lookAt({eye:[0,0,1]});function bV({width:s,height:e,near:t,far:i,padding:n}){let o=-s/2,a=s/2,l=-e/2,u=e/2;if(n){let{left:c=0,right:h=0,top:d=0,bottom:f=0}=n,p=Ot((c+s-h)/2,0,s)-s/2,S=Ot((d+e-f)/2,0,e)-e/2;o-=p,a-=p,l+=S,u+=S}return new it().ortho({left:o,right:a,bottom:l,top:u,near:t,far:i})}var hg=class extends di{constructor(e){let{width:t,height:i,near:n=.1,far:o=1e3,zoom:a=0,target:l=[0,0,0],padding:u=null,flipY:c=!0}=e,h=Array.isArray(a)?a[0]:a,d=Array.isArray(a)?a[1]:a,f=Math.min(h,d),p=Math.pow(2,f),S;if(h!==d){let x=Math.pow(2,h),C=Math.pow(2,d);S={unitsPerMeter:[x/p,C/p,1],metersPerUnit:[p/x,p/C,1]}}super({...e,longitude:void 0,position:l,viewMatrix:mV.clone().scale([p,p*(c?-1:1),p]),projectionMatrix:bV({width:t||1,height:i||1,padding:u,near:n,far:o}),zoom:f,distanceScales:S})}projectFlat([e,t]){let{unitsPerMeter:i}=this.distanceScales;return[e*i[0],t*i[1]]}unprojectFlat([e,t]){let{metersPerUnit:i}=this.distanceScales;return[e*i[0],t*i[1]]}panByPosition(e,t){let i=es(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=mh([],n,Qb([],i)),a=mh([],this.center,o);return{target:this.unprojectFlat(a)}}};var EP=class extends Bu{constructor(e){let{width:t,height:i,rotationX:n=0,rotationOrbit:o=0,target:a=[0,0,0],zoom:l=0,minRotationX:u=-90,maxRotationX:c=90,minZoom:h=-1/0,maxZoom:d=1/0,startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:x,startZoomPosition:C,startZoom:O}=e;super({width:t,height:i,rotationX:n,rotationOrbit:o,target:a,zoom:l,minRotationX:u,maxRotationX:c,minZoom:h,maxZoom:d},{startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:x,startZoomPosition:C,startZoom:O}),y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:t}){let i=this.getState().startPanPosition||t;if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startRotationX:o,startRotationOrbit:a}=this.getState(),{width:l,height:u}=this.getViewportProps();if(!n||o===void 0||a===void 0)return this;let c;if(e){let h=(e[0]-n[0])/l,d=(e[1]-n[1])/u;(o<-90||o>90)&&(h*=-1),c={rotationX:o+d*180,rotationOrbit:a+h*180}}else c={rotationX:o+i,rotationOrbit:a+t};return this._getUpdatedState(c)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:n}=i;return Math.abs(n-t.rotationOrbit)>180&&(i.rotationOrbit=n<0?n+360:n-360),i}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomPosition:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let a=this._calculateNewZoom({scale:i,startZoom:n}),l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=t+Math.log2(e);return Ot(o,n,i)}_panFromCenter(e){let{width:t,height:i,target:n}=this.getViewportProps();return this.pan({startPosition:n,pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n,maxRotationX:o,minRotationX:a,rotationOrbit:l}=e;return e.zoom=Array.isArray(n)?[Ot(n[0],i,t),Ot(n[1],i,t)]:Ot(n,i,t),e.rotationX=Ot(e.rotationX,a,o),(l<-180||l>180)&&(e.rotationOrbit=VI(l+180,360)-180),e}};var KE=class extends EP{constructor(e){super(e),y(this,"zoomAxis",void 0),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=Math.log2(e);if(Array.isArray(t)){let[a,l]=t;switch(this.zoomAxis){case"X":a=Ot(a+o,n,i);break;case"Y":l=Ot(l+o,n,i);break;default:let u=Math.min(a+o,l+o);u<n&&(o+=n-u),u=Math.max(a+o,l+o),u>i&&(o+=i-u),a+=o,l+=o}return[a,l]}return Ot(t+o,n,i)}},dg=class extends Mu{constructor(...e){super(...e),y(this,"ControllerState",KE),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Bn(["target","zoom"])}),y(this,"dragMode","pan")}_onPanRotate(){return!1}};var Hs=class extends _u{get ViewportType(){return hg}get ControllerType(){return dg}};y(Hs,"displayName","OrthographicView");function YI({layers:s,viewport:e}){let t=null;for(let o of s){let a=o.getBounds();a&&(t?(t[0]=Math.min(t[0],a[0][0]),t[1]=Math.min(t[1],a[0][1]),t[2]=Math.max(t[2],a[1][0]),t[3]=Math.max(t[3],a[1][1])):t=[a[0][0],a[0][1],a[1][0],a[1][1]])}let i=e.getBounds();if(!t)return i;let n=PV(i);return t[2]-t[0]<n[2]-n[0]||t[3]-t[1]<n[3]-n[1]||(t[0]=Math.max(t[0],n[0]),t[1]=Math.max(t[1],n[1]),t[2]=Math.min(t[2],n[2]),t[3]=Math.min(t[3],n[3])),t}function KI({bounds:s,viewport:e,width:t,height:i}){if(s[2]<=s[0]||s[3]<=s[1])return null;let n=1;if(t-=n*2,i-=n*2,e instanceof Ir){let{longitude:l,latitude:u,zoom:c}=Ou({width:t,height:i,bounds:[[s[0],s[1]],[s[2],s[3]]],maxZoom:20});return new Ir({longitude:l,latitude:u,zoom:c,x:n,y:n,width:t,height:i})}let o=[(s[0]+s[2])/2,(s[1]+s[3])/2,0],a=Math.min(20,t/(s[2]-s[0]),i/(s[3]-s[1]));return new Hs({x:n,y:n}).makeViewport({width:t,height:i,viewState:{target:o,zoom:Math.log2(a)}})}function PV(s){let e={x:s[2]-s[0],y:s[3]-s[1]},t={x:s[0]+.5*e.x,y:s[1]+.5*e.y};return[t.x-e.x,t.y-e.y,t.x+e.x,t.y+e.y]}var fg=class{constructor(){y(this,"id","mask-effect"),y(this,"props",null),y(this,"useInPicking",!0),y(this,"dummyMaskMap",void 0),y(this,"channels",[]),y(this,"masks",null),y(this,"maskPass",void 0),y(this,"maskMap",void 0),y(this,"lastViewport",void 0)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){this.dummyMaskMap||(this.dummyMaskMap=new Ve(e,{width:1,height:1}));let l=t.filter(d=>d.props.visible&&d.props.operation===so.MASK);if(l.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new cg(e,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);let u=this._sortMaskChannels(l),c=n[0],h=!this.lastViewport||!this.lastViewport.equals(c);for(let d in u)this._renderChannel(u[d],{layerFilter:i,onViewportActive:o,views:a,viewport:c,viewportChanged:h})}_renderChannel(e,{layerFilter:t,onViewportActive:i,views:n,viewport:o,viewportChanged:a}){let l=this.channels[e.index];if(!l)return;let u=e===l||l.layers.length!==e.layers.length||e.layerBounds.some((c,h)=>c!==l.layerBounds[h]);if(e.bounds=l.bounds,e.maskBounds=l.maskBounds,this.channels[e.index]=e,(u||a)&&(this.lastViewport=o,e.bounds=YI({layers:e.layers,viewport:o}),u||!kr(e.bounds,l.bounds))){let{maskPass:c,maskMap:h}=this,d=KI({bounds:e.bounds,viewport:o,width:h.width,height:h.height});e.maskBounds=d?d.getBounds():[0,0,1,1],c.render({pass:"mask",channel:e.index,layers:e.layers,layerFilter:t,viewports:d?[d]:[],onViewportActive:i,views:n,moduleParameters:{devicePixelRatio:1}})}this.masks[e.id]={index:e.index,bounds:e.maskBounds,coordinateOrigin:e.coordinateOrigin,coordinateSystem:e.coordinateSystem}}_sortMaskChannels(e){let t={},i=0;for(let n of e){let{id:o}=n.root,a=t[o];if(!a){if(++i>4){de.warn("Too many mask layers. The max supported is 4")();continue}a={id:o,index:this.channels.findIndex(l=>l?.id===o),layers:[],layerBounds:[],coordinateOrigin:n.root.props.coordinateOrigin,coordinateSystem:n.root.props.coordinateSystem},t[o]=a}a.layers.push(n),a.layerBounds.push(n.getBounds())}for(let n=0;n<4;n++){let o=this.channels[n];(!o||!(o.id in t))&&(this.channels[n]=null)}for(let n in t){let o=t[n];o.index<0&&(o.index=this.channels.findIndex(a=>!a),this.channels[o.index]=o)}return t}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}};var yV=new Lh,gg=class{constructor(){y(this,"effects",void 0),y(this,"_internalEffects",void 0),y(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(e){"effects"in e&&(e.effects.length!==this.effects.length||!sn(e.effects,this.effects))&&(this.setEffects(e.effects),this._needsRedraw="effects changed")}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(e=[]){this.cleanup(),this.effects=e,this._internalEffects=e.slice(),this._internalEffects.push(new fg),e.some(t=>t instanceof Lh)||this._internalEffects.push(yV)}cleanup(){for(let e of this.effects)e.cleanup();for(let e of this._internalEffects)e.cleanup();this.effects.length=0,this._internalEffects.length=0}};var pg=class extends co{shouldDrawLayer(e){return e.props.operation===so.DRAW}};var ZI={blendFunc:[1,0,32771,0],blendEquation:32774},Du=class extends co{constructor(...e){super(...e),y(this,"pickZ",void 0),y(this,"_colors",null)}render(e){return e.pickingFBO?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,pickingFBO:a,deviceRect:{x:l,y:u,width:c,height:h},cullRect:d,effects:f,pass:p="picking",pickZ:S}){let x=this.gl;this.pickZ=S;let C=S?null:{byLayer:new Map,byAlpha:[]};this._colors=C;let O=ft(x,{scissorTest:!0,scissor:[l,u,c,h],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...ZI,blend:!S},()=>super.render({target:a,layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,cullRect:d,effects:f?.filter(I=>I.useInPicking),pass:p}));return this._colors=null,{decodePickingColor:C&&EV.bind(null,C),stats:O}}shouldDrawLayer(e){return e.props.pickable&&e.props.operation===so.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,t,i){let n={...e.props.parameters};return this._colors?(Object.assign(n,ZI),n.blend=!0,n.blendColor=SV(this._colors,e,i)):n.blend=!1,n}};function SV(s,e,t){let{byLayer:i,byAlpha:n}=s,o,a=i.get(e);return a?(a.viewports.push(t),o=a.a):(o=i.size+1,o<=255?(a={a:o,layer:e,viewports:[t]},i.set(e,a),n[o]=a):(de.warn("Too many pickable layers, only picking the first 255")(),o=0)),[0,0,0,o/255]}function EV(s,e){let t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}var xV="deckRenderer.renderLayers",mg=class{constructor(e){this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new pg(e),this.pickLayersPass=new Du(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){"layerFilter"in e&&this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in e&&this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;e.layerFilter=e.layerFilter||this.layerFilter,e.effects=e.effects||[],e.target=e.target||Me.getDefaultFramebuffer(this.gl),this._preRender(e.effects,e);let i=this.lastPostProcessEffect?this.renderBuffers[0]:e.target,n=t.render({...e,target:i});this._postRender(e.effects,e),this.renderCount++,kt(xV,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){let i=null;for(let n of e)n.preRender(this.gl,t),n.postRender&&(i=n);i&&this._resizeRenderBuffers(),this.lastPostProcessEffect=i}_resizeRenderBuffers(){let{renderBuffers:e}=this;e.length===0&&e.push(new Me(this.gl),new Me(this.gl));for(let t of e)t.resize()}_postRender(e,t){let{renderBuffers:i}=this,n={inputBuffer:i[0],swapBuffer:i[1],target:null};for(let o of e)if(o.postRender){if(o===this.lastPostProcessEffect){n.target=t.target,o.postRender(this.gl,n);break}let a=o.postRender(this.gl,n);n.inputBuffer=a,n.swapBuffer=a===i[0]?i[1]:i[0]}}};var vV={pickedColor:null,pickedObjectIndex:-1};function QI({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:n,deviceRect:o}){let{x:a,y:l,width:u,height:c}=o,h=n*n,d=-1,f=0;for(let p=0;p<c;p++){let S=p+l-i,x=S*S;if(x>h)f+=4*u;else for(let C=0;C<u;C++){if(s[f+3]-1>=0){let B=C+a-t,I=B*B+x;I<=h&&(h=I,d=f)}f+=4}}if(d>=0){let p=s.slice(d,d+4),S=e(p);if(S){let x=Math.floor(d/4/u),C=d/4-x*u;return{...S,pickedColor:p,pickedX:a+C,pickedY:l+x}}de.error("Picked non-existent layer. Is picking buffer corrupt?")()}return vV}function JI({pickedColors:s,decodePickingColor:e}){let t=new Map;if(s){for(let i=0;i<s.length;i+=4)if(s[i+3]-1>=0){let o=s.slice(i,i+4),a=o.join(",");if(!t.has(a)){let l=e(o);l?t.set(a,{...l,color:o}):de.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function ZE({pickInfo:s,viewports:e,pixelRatio:t,x:i,y:n,z:o}){let a=e[0];e.length>1&&(a=CV(s?.pickedViewports||e,{x:i,y:n}));let l;if(a){let u=[i-a.x,n-a.y];o!==void 0&&(u[2]=o),l=a.unproject(u)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:i,y:n,pixel:[i,n],coordinate:l,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function $I(s){let{pickInfo:e,lastPickedInfo:t,mode:i,layers:n}=s,{pickedColor:o,pickedLayer:a,pickedObjectIndex:l}=e,u=a?[a]:[];if(i==="hover"){let d=t.index,f=t.layerId,p=a?a.props.id:null;if(p!==f||l!==d){if(p!==f){let S=n.find(x=>x.props.id===f);S&&u.unshift(S)}t.layerId=p,t.index=l,t.info=null}}let c=ZE(s),h=new Map;return h.set(null,c),u.forEach(d=>{let f={...c};d===a&&(f.color=o,f.index=l,f.picked=!0),f=QE({layer:d,info:f,mode:i});let p=f.layer;d===a&&i==="hover"&&(t.info=f),h.set(p.id,f),i==="hover"&&p.updateAutoHighlight(f)}),h}function QE({layer:s,info:e,mode:t}){for(;s&&e;){let i=e.layer||null;e.sourceLayer=i,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:i}),s=s.parent}return e}function CV(s,e){for(let t=s.length-1;t>=0;t--){let i=s[t];if(i.containsPixel(e))return i}return s[0]}var bg=class{constructor(e){y(this,"gl",void 0),y(this,"pickingFBO",void 0),y(this,"depthFBO",void 0),y(this,"pickLayersPass",void 0),y(this,"layerFilter",void 0),y(this,"lastPickedInfo",void 0),y(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new Du(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:n},o=this.lastPickedInfo.info){let a=o&&o.layer&&o.layer.id,l=o&&o.viewport&&o.viewport.id,u=a?i.find(f=>f.id===a):null,c=l&&n.find(f=>f.id===l)||n[0],h=c&&c.unproject([e-c.x,t-c.y]);return{...o,...{x:e,y:t,viewport:c,coordinate:h,layer:u}}}_resizeBuffer(){var e,t;let{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new Me(i),Me.isSupported(i,{colorBufferFloat:!0}))){let n=new Me(i);n.attach({[36064]:new Ve(i,{format:fe(i)?34836:6408,type:5126})}),this.depthFBO=n}(e=this.pickingFBO)===null||e===void 0||e.resize({width:i.canvas.width,height:i.canvas.height}),(t=this.depthFBO)===null||t===void 0||t.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;let t=e.filter(i=>i.isPickable()&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:n,y:o,radius:a=0,depth:l=1,mode:u="query",unproject3D:c,onViewportActive:h,effects:d}){let f=this._getPickable(e),p=to(this.gl);if(!f)return{result:[],emptyInfo:ZE({viewports:i,x:n,y:o,pixelRatio:p})};this._resizeBuffer();let S=sh(this.gl,[n,o],!0),x=[S.x+Math.floor(S.width/2),S.y+Math.floor(S.height/2)],C=Math.round(a*p),{width:O,height:B}=this.pickingFBO,I=this._getPickingRect({deviceX:x[0],deviceY:x[1],deviceRadius:C,deviceWidth:O,deviceHeight:B}),_={x:n-a,y:o-a,width:a*2+1,height:a*2+1},X,K=[],se=new Set;for(let ge=0;ge<l;ge++){let ue;if(I){let M=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:I,cullRect:_,effects:d,pass:"picking:".concat(u)});ue=QI({...M,deviceX:x[0],deviceY:x[1],deviceRadius:C,deviceRect:I})}else ue={pickedColor:null,pickedObjectIndex:-1};let F;ue.pickedLayer&&c&&this.depthFBO&&(F=this._drawAndSample({layers:[ue.pickedLayer],views:t,viewports:i,onViewportActive:h,deviceRect:{x:ue.pickedX,y:ue.pickedY,width:1,height:1},cullRect:_,effects:d,pass:"picking:".concat(u,":z")},!0).pickedColors[0]),ue.pickedLayer&&ge+1<l&&(se.add(ue.pickedLayer),ue.pickedLayer.disablePickingIndex(ue.pickedObjectIndex)),X=$I({pickInfo:ue,lastPickedInfo:this.lastPickedInfo,mode:u,layers:f,viewports:i,x:n,y:o,z:F,pixelRatio:p});for(let M of X.values())M.layer&&K.push(M);if(!ue.pickedColor)break}for(let ge of se)ge.restorePickingColors();return{result:K,emptyInfo:X.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:n,y:o,width:a=1,height:l=1,mode:u="query",maxObjects:c=null,onViewportActive:h,effects:d}){let f=this._getPickable(e);if(!f)return[];this._resizeBuffer();let p=to(this.gl),S=sh(this.gl,[n,o],!0),x=S.x,C=S.y+S.height,O=sh(this.gl,[n+a,o+l],!0),B=O.x+O.width,I=O.y,_={x,y:I,width:B-x,height:C-I},X=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:_,cullRect:{x:n,y:o,width:a,height:l},effects:d,pass:"picking:".concat(u)}),K=JI(X),se=new Map,ge=Number.isFinite(c);for(let ue=0;ue<K.length&&!(ge&&c&&se.size>=c);ue++){let F=K[ue],M={color:F.pickedColor,layer:null,index:F.pickedObjectIndex,picked:!0,x:n,y:o,pixelRatio:p};M=QE({layer:F.pickedLayer,info:M,mode:u}),se.has(M.object)||se.set(M.object,M)}return Array.from(se.values())}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:n,deviceRect:o,cullRect:a,effects:l,pass:u},c=!1){let h=c?this.depthFBO:this.pickingFBO,{decodePickingColor:d}=this.pickLayersPass.render({layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:n,pickingFBO:h,deviceRect:o,cullRect:a,effects:l,pass:u,pickZ:c}),{x:f,y:p,width:S,height:x}=o,C=new(c?Float32Array:Uint8Array)(S*x*4);return Ms(h,{sourceX:f,sourceY:p,sourceWidth:S,sourceHeight:x,target:C}),{pickedColors:C,decodePickingColor:d}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:n,deviceHeight:o}){let a=Math.max(0,e-i),l=Math.max(0,t-i),u=Math.min(n,e+i+1)-a,c=Math.min(o,t+i+1)-l;return u<=0||c<=0?null:{x:a,y:l,width:u,height:c}}};var AV={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},Pg=class{constructor(e){y(this,"el",null),y(this,"isVisible",!1);let t=e.parentElement;t&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,AV),t.appendChild(this.el))}setTooltip(e,t,i){let n=this.el;if(!!n){if(typeof e=="string")n.innerText=e;else if(e)e.text&&(n.innerText=e.text),e.html&&(n.innerHTML=e.html),e.className&&(n.className=e.className),Object.assign(n.style,e.style);else{this.isVisible=!1,n.style.display="none";return}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(t,"px, ").concat(i,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}};var Fu=Ae(ew());var TV={mousedown:1,mousemove:2,mouseup:4};function IV(s,e){for(let t=0;t<s.length;t++)if(e(s[t]))return!0;return!1}function tw(s){let e=s.prototype.handler;s.prototype.handler=function(i){let n=this.store;i.button>0&&i.type==="pointerdown"&&(IV(n,o=>o.pointerId===i.pointerId)||n.push(i)),e.call(this,i)}}function rw(s){s.prototype.handler=function(t){let i=TV[t.type];i&1&&t.button>=0&&(this.pressed=!0),i&2&&t.which===0&&(i=4),this.pressed&&(i&4&&(this.pressed=!1),this.callback(this.manager,i,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}tw(Fu.PointerEventInput);rw(Fu.MouseInput);var iw=Fu.Manager,go=Fu;var po=class{constructor(e,t,i){this.element=e,this.callback=t,this.options={enable:!0,...i}}};var nw=go?[[go.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[go.Rotate,{enable:!1}],[go.Pinch,{enable:!1}],[go.Swipe,{enable:!1}],[go.Pan,{threshold:0,enable:!1}],[go.Press,{enable:!1}],[go.Tap,{event:"doubletap",taps:2,enable:!1}],[go.Tap,{event:"anytap",enable:!1}],[go.Tap,{enable:!1}]]:null,JE={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},ow={doubletap:["tap"]},sw={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Bh={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},aw={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},$E={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"};var lw=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Gu=typeof window<"u"?window:global;var vP=!1;try{let s={get passive(){return vP=!0,!0}};Gu.addEventListener("test",null,s),Gu.removeEventListener("test",null)}catch{vP=!1}var wV=lw.indexOf("firefox")!==-1,{WHEEL_EVENTS:LV}=Bh,uw="wheel",cw=4.000244140625,RV=40,OV=.25,yg=class extends po{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{if(!this.options.enable)return;let o=n.deltaY;Gu.WheelEvent&&(wV&&n.deltaMode===Gu.WheelEvent.DOM_DELTA_PIXEL&&(o/=Gu.devicePixelRatio),n.deltaMode===Gu.WheelEvent.DOM_DELTA_LINE&&(o*=RV)),o!==0&&o%cw===0&&(o=Math.floor(o/cw)),n.shiftKey&&o&&(o=o*OV),this.callback({type:uw,center:{x:n.clientX,y:n.clientY},delta:-o,srcEvent:n,pointerType:"mouse",target:n.target})},this.events=(this.options.events||[]).concat(LV),this.events.forEach(n=>e.addEventListener(n,this.handleEvent,vP?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===uw&&(this.options.enable=t)}};var{MOUSE_EVENTS:_V}=Bh,hw="pointermove",dw="pointerover",fw="pointerout",gw="pointerenter",pw="pointerleave",Sg=class extends po{constructor(e,t,i){super(e,t,i),this.handleEvent=o=>{this.handleOverEvent(o),this.handleOutEvent(o),this.handleEnterEvent(o),this.handleLeaveEvent(o),this.handleMoveEvent(o)},this.pressed=!1;let{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(_V),this.events.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===hw&&(this.enableMoveEvent=t),e===dw&&(this.enableOverEvent=t),e===fw&&(this.enableOutEvent=t),e===gw&&(this.enableEnterEvent=t),e===pw&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(dw,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(fw,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(gw,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(pw,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(hw,e);break;case"mouseup":this.pressed=!1;break;default:}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}};var{KEY_EVENTS:NV}=Bh,mw="keydown",bw="keyup",Eg=class extends po{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{let o=n.target||n.srcElement;o.tagName==="INPUT"&&o.type==="text"||o.tagName==="TEXTAREA"||(this.enableDownEvent&&n.type==="keydown"&&this.callback({type:mw,srcEvent:n,key:n.key,target:n.target}),this.enableUpEvent&&n.type==="keyup"&&this.callback({type:bw,srcEvent:n,key:n.key,target:n.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(NV),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===mw&&(this.enableDownEvent=t),e===bw&&(this.enableUpEvent=t)}};var Pw="contextmenu",xg=class extends po{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{!this.options.enable||this.callback({type:Pw,center:{x:n.clientX,y:n.clientY},srcEvent:n,pointerType:"mouse",target:n.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===Pw&&(this.options.enable=t)}};var MV={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},BV=1,DV=2,FV=3,GV=0,VV=1,kV=2,UV=1,zV=2,WV=4;function yw(s){let e=MV[s.srcEvent.type];if(!e)return null;let{buttons:t,button:i,which:n}=s.srcEvent,o=!1,a=!1,l=!1;return e===4||e===2&&!Number.isFinite(t)?(o=n===BV,a=n===DV,l=n===FV):e===2?(o=Boolean(t&UV),a=Boolean(t&WV),l=Boolean(t&zV)):e===1&&(o=i===GV,a=i===VV,l=i===kV),{leftButton:o,middleButton:a,rightButton:l}}function Sw(s,e){let t=s.center;if(!t)return null;let i=e.getBoundingClientRect(),n=i.width/e.offsetWidth||1,o=i.height/e.offsetHeight||1,a={x:(t.x-i.left-e.clientLeft)/n,y:(t.y-i.top-e.clientTop)/o};return{center:t,offsetCenter:a}}var ex={srcElement:"root",priority:0},vg=class{constructor(e){this.handleEvent=t=>{if(this.isEmpty())return;let i=this._normalizeEvent(t),n=t.srcEvent.target;for(;n&&n!==i.rootElement;){if(this._emit(i,n),i.handled)return;n=n.parentNode}this._emit(i,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,n=!1,o=!1){let{handlers:a,handlersByElement:l}=this,u=ex;typeof i=="string"||i&&i.addEventListener?u={...ex,srcElement:i}:i&&(u={...ex,...i});let c=l.get(u.srcElement);c||(c=[],l.set(u.srcElement,c));let h={type:e,handler:t,srcElement:u.srcElement,priority:u.priority};n&&(h.once=!0),o&&(h.passive=!0),a.push(h),this._active=this._active||!h.passive;let d=c.length-1;for(;d>=0&&!(c[d].priority>=h.priority);)d--;c.splice(d+1,0,h)}remove(e,t){let{handlers:i,handlersByElement:n}=this;for(let o=i.length-1;o>=0;o--){let a=i[o];if(a.type===e&&a.handler===t){i.splice(o,1);let l=n.get(a.srcElement);l.splice(l.indexOf(a),1),l.length===0&&n.delete(a.srcElement)}}this._active=i.some(o=>!o.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let n=!1,o=()=>{e.handled=!0},a=()=>{e.handled=!0,n=!0},l=[];for(let u=0;u<i.length;u++){let{type:c,handler:h,once:d}=i[u];if(h({...e,type:c,stopPropagation:o,stopImmediatePropagation:a}),d&&l.push(i[u]),n)break}for(let u=0;u<l.length;u++){let{type:c,handler:h}=l[u];this.remove(c,h)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,...yw(e),...Sw(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}};var HV={events:null,recognizers:null,recognizerOptions:{},Manager:iw,touchAction:"none",tabIndex:0},Dh=class{constructor(e=null,t){this._onBasicInput=n=>{let{srcEvent:o}=n,a=sw[o.type];a&&this.manager.emit(a,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options={...HV,...t},this.events=new Map,this.setElement(e);let{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;let{options:t}=this,i=t.Manager;this.manager=new i(e,{touchAction:t.touchAction,recognizers:t.recognizers||nw}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(JE).forEach(n=>{let o=this.manager.get(n);o&&JE[n].forEach(a=>{o.recognizeWith(a)})});for(let n in t.recognizerOptions){let o=this.manager.get(n);if(o){let a=t.recognizerOptions[n];delete a.enable,o.set(a)}}this.wheelInput=new yg(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Sg(e,this._onOtherEvent,{enable:!1}),this.keyInput=new Eg(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new xg(e,this._onOtherEvent,{enable:!1});for(let[n,o]of this.events)o.isEmpty()||(this._toggleRecognizer(o.recognizerName,!0),this.manager.on(n,o.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let n=i.get(e);if(n&&n.options.enable!==t){n.set({enable:t});let o=ow[e];o&&!this.options.recognizers&&o.forEach(a=>{let l=i.get(a);t?(l.requireFailure(e),n.dropRequireFailure(a)):l.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,i,n,o){if(typeof e!="string"){i=t;for(let h in e)this._addEventHandler(h,e[h],i,n,o);return}let{manager:a,events:l}=this,u=$E[e]||e,c=l.get(u);c||(c=new vg(this),l.set(u,c),c.recognizerName=aw[u]||u,a&&a.on(u,c.handleEvent)),c.add(e,t,i,n,o),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(let a in e)this._removeEventHandler(a,e[a]);return}let{events:i}=this,n=$E[e]||e,o=i.get(n);if(!!o&&(o.remove(e,t),o.isEmpty())){let{recognizerName:a}=o,l=!1;for(let u of i.values())if(u.recognizerName===a&&!u.isEmpty()){l=!0;break}l||this._toggleRecognizer(a,!1)}}};function Vu(){}var jV=({isDragging:s})=>s?"grabbing":"grab",Ew={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:Vu,onResize:Vu,onViewStateChange:Vu,onInteractionStateChange:Vu,onBeforeRender:Vu,onAfterRender:Vu,onLoad:Vu,onError:s=>de.error(s.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:jV,getTooltip:null,debug:!1,drawPickingColors:!1},al=class{constructor(e){y(this,"props",void 0),y(this,"width",0),y(this,"height",0),y(this,"userData",{}),y(this,"canvas",null),y(this,"viewManager",null),y(this,"layerManager",null),y(this,"effectManager",null),y(this,"deckRenderer",null),y(this,"deckPicker",null),y(this,"eventManager",null),y(this,"tooltip",null),y(this,"metrics",void 0),y(this,"animationLoop",void 0),y(this,"stats",void 0),y(this,"viewState",void 0),y(this,"cursorState",void 0),y(this,"_needsRedraw",void 0),y(this,"_pickRequest",void 0),y(this,"_lastPointerDownInfo",null),y(this,"_metricsCounter",void 0),y(this,"_onPointerMove",t=>{let{_pickRequest:i}=this;if(t.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(t.leftButton||t.rightButton)return;{let n=t.offsetCenter;if(!n)return;i.x=n.x,i.y=n.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=t}),y(this,"_onEvent",t=>{let i=ME[t.type],n=t.offsetCenter;if(!i||!n||!this.layerManager)return;let o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:l}=a,u=l&&(l[i.handler]||l.props[i.handler]),c=this.props[i.handler],h=!1;u&&(h=u.call(l,a,t)),!h&&c&&c(a,t)}),y(this,"_onPointerDown",t=>{let i=t.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo}),this.props={...Ew,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&de.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),ih()==="IE"&&de.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||typeof document<"u"&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new $i({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&ho.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,n,o,a,l;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(e=this.layerManager)===null||e===void 0||e.finalize(),this.layerManager=null,(t=this.viewManager)===null||t===void 0||t.finalize(),this.viewManager=null,(i=this.effectManager)===null||i===void 0||i.finalize(),this.effectManager=null,(n=this.deckRenderer)===null||n===void 0||n.finalize(),this.deckRenderer=null,(o=this.deckPicker)===null||o===void 0||o.finalize(),this.deckPicker=null,(a=this.eventManager)===null||a===void 0||a.destroy(),this.eventManager=null,(l=this.tooltip)===null||l===void 0||l.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var u;(u=this.canvas.parentElement)===null||u===void 0||u.removeChild(this.canvas),this.canvas=null}}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&de.removed("onLayerHover","onHover")(),"onLayerClick"in e&&de.removed("onLayerClick","onClick")(),e.initialViewState&&!sn(this.props.initialViewState,e.initialViewState)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),n=this.layerManager.needsRedraw(e),o=this.effectManager.needsRedraw(e),a=this.deckRenderer.needsRedraw(e);return t=t||i||n||o||a,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return gt(this.viewManager),this.viewManager.views}getViewports(e){return gt(this.viewManager),this.viewManager.getViewports(e)}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_pick(e,t,i){gt(this.deckPicker);let{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(t).timeStart();let o=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(t).timeEnd(),o}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),gt(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||t===0){let o=Number.isFinite(t)?"".concat(t,"px"):t;this.canvas.style.width=o}if(i||i===0){var n;let o=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=((n=e.style)===null||n===void 0?void 0:n.position)||"absolute",this.canvas.style.height=o}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth||e.width,i=e.clientHeight||e.height;if(t!==this.width||i!==this.height){var n;this.width=t,this.height=i,(n=this.viewManager)===null||n===void 0||n.setProps({width:t,height:i}),this.props.onResize({width:t,height:i})}}_createAnimationLoop(e){let{width:t,height:i,gl:n,glOptions:o,debug:a,onError:l,onBeforeRender:u,onAfterRender:c,useDevicePixels:h}=e;return new Eu({width:t,height:i,useDevicePixels:h,autoResizeViewport:!1,gl:n,onCreateContext:d=>ah({...o,...d,canvas:this.canvas,debug:a,onContextLost:()=>this._onContextLost()}),onInitialize:d=>this._setGLContext(d.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:u,onAfterRender:c,onError:l})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new Mh({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){let{_pickRequest:e}=this;if(e.event){let{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let o=n,a=!1;for(let l of i){var t;o=l,a=((t=l.layer)===null||t===void 0?void 0:t.onHover(l,e.event))||a}if(!a&&this.props.onHover&&this.props.onHover(o,e.event),this.props.getTooltip&&this.tooltip){let l=this.props.getTooltip(o);this.tooltip.setTooltip(l,o.x,o.y)}e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,gu(e,{enable:!0,copyState:!0})),this.tooltip=new Pg(this.canvas),xi(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);let t=new il;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new Dh(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(let n in ME)this.eventManager.on(n,this._onEvent);this.viewManager=new sg({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new og(e,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new gg,this.deckRenderer=new mg(e),this.deckPicker=new bg(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{gl:i}=this.layerManager.context;xi(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:e,effects:this.effectManager.getEffects(),...t}),this.props.onAfterRender({gl:i})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),de.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=Rn.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}};y(al,"defaultProps",Ew);y(al,"VERSION",e1.VERSION);var ku=class{constructor(e,t){y(this,"opts",void 0),y(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:i}=this.source,{size:n}=t,o=i;if(i&&i.length!==n){o=new Float32Array(n);let a=t.elementOffset||0;for(let l=0;l<n;++l)o[l]=i[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function xw(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function CP(s){return s.stride||s.size*s.bytesPerElement}function vw(s,e){e.offset&&de.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=CP(s),i=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,n=e.elementOffset||0,o=i*t+n*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function qV(s,e){let t=vw(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var Cg=class{constructor(e,t,i){y(this,"gl",void 0),y(this,"id",void 0),y(this,"size",void 0),y(this,"settings",void 0),y(this,"value",void 0),y(this,"doublePrecision",void 0),y(this,"_buffer",void 0),y(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;let n=t.logicalType||t.type,o=n===5130,{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0);let l;o?l=5126:!n&&t.isIndexed?l=e&&Mf(e,$e.ELEMENT_INDEX_UINT32)?5125:5123:l=n||5126;let u=xw(n||l||5126);this.doublePrecision=o,o&&t.fp64===!1&&(u=Float32Array),this.value=null,this.settings={...t,defaultType:u,defaultValue:a,logicalType:n,type:l,size:this.size,bytesPerElement:u.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new Se(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*CP(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),ho.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let i={},n=this.value instanceof Float64Array,o=qV(this.getAccessor(),t||{});return i[e]=new ku(this,o.high),i["".concat(e,"64Low")]=n?new ku(this,o.low):new Float32Array(this.size),i}if(t){let i=vw(this.getAccessor(),t);return{[e]:new ku(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:n}=this,o=i*n;if(t&&o&&t.length>=o){let a=new Array(n).fill(1/0),l=new Array(n).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<n;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this,i;ArrayBuffer.isView(e)?i={value:e}:e instanceof Se?i={buffer:e}:i=e;let n={...this.settings,...i};if(t.bufferAccessor=n,t.bounds=null,i.constant){let o=i.value;if(o=this._normalizeValue(o,[],0),this.settings.normalized&&(o=this.normalizeConstant(o)),!(!t.constant||!this._areValuesEqual(o,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=o}else if(i.buffer){let o=i.buffer;t.externalBuffer=o,t.constant=!1,this.value=i.value||null;let a=i.value instanceof Float64Array;n.type=i.type||o.accessor.type,n.bytesPerElement=o.accessor.BYTES_PER_ELEMENT*(a?2:1),n.stride=CP(n)}else if(i.value){this._checkExternalBuffer(i);let o=i.value;t.externalBuffer=null,t.constant=!1,this.value=o,n.bytesPerElement=o.BYTES_PER_ELEMENT,n.stride=CP(n);let{buffer:a,byteOffset:l}=this;this.doublePrecision&&o instanceof Float64Array&&(o=yP(o,n));let u=o.byteLength+l+n.stride*2;a.byteLength<u&&a.reallocate(u),a.setAccessor(null),a.subData({data:o,offset:l}),n.type=i.type||a.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?yP(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){let{state:i}=this,n=i.allocatedValue,o=ho.allocate(n,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&n&&a.subData({data:n instanceof Float64Array?yP(n,this):n,offset:l})),i.allocatedValue=o,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));let i=this.settings.defaultType,n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&de.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:n,size:o}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e)return t[i]=n[0],t;switch(o){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let a=o;for(;--a>=0;)t[i+a]=Number.isFinite(e[a])?e[a]:n[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}};var Cw=[],Aw=[];function mo(s,e=0,t=1/0){let i=Cw,n={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?i=s:s.length>0&&(Aw.length=s.length,i=Aw):i=Cw,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),n.index=e-1),{iterable:i,objectInfo:n}}function AP(s){return s&&s[Symbol.asyncIterator]}function TP(s,e){let{size:t,stride:i,offset:n,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=i?i/l:t,c=n?n/l:0,h=Math.floor((s.length-c)/u);return(d,{index:f,target:p})=>{if(!o){let O=f*u+c;for(let B=0;B<t;B++)p[B]=s[O+B];return p}let S=o[f],x=o[f+1]||h,C;if(a){C=new Array(x-S);for(let O=S;O<x;O++){let B=O*u+c;p=new Array(t);for(let I=0;I<t;I++)p[I]=s[B+I];C[O-S]=p}}else if(u===t)C=s.subarray(S*t+c,x*t+c);else{C=new s.constructor((x-S)*t);let O=0;for(let B=S;B<x;B++){let I=B*u+c;for(let _=0;_<t;_++)C[O++]=s[I+_]}}return C}}var Tw=[],Ag=[[0,1/0]];function Iw(s,e){if(s===Ag||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],i=s.length,n=0;for(let o=0;o<i;o++){let a=s[o];a[1]<e[0]?(t.push(a),n=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(n,0,e),t}function tx(s){let{source:e,target:t,start:i=0,size:n,getData:o}=s,a=s.end||t.length,l=e.length,u=a-i;if(l>u){t.set(e.subarray(0,u),i);return}if(t.set(e,i),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<n;d++)t[i+c]=h[d]||0,c++}}function ww({source:s,target:e,size:t,getData:i,sourceStartIndices:n,targetStartIndices:o}){if(!Array.isArray(o))return tx({source:s,target:e,size:t,getData:i}),e;let a=0,l=0,u=i&&((h,d)=>i(h+l,d)),c=Math.min(n.length,o.length);for(let h=1;h<c;h++){let d=n[h]*t,f=o[h]*t;tx({source:s.subarray(a,d),target:e,start:l,end:f,size:t,getData:u}),a=d,l=f}return l<e.length&&tx({source:[],target:e,start:l,size:t,getData:u}),e}var YV={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function IP(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});let t=s.type||"interpolation";return{...YV[t],...e,...s,type:t}}function wP(s,e){let t=e.getBuffer();return t?[t,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function LP(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function RP(s){s.push(s.shift())}function Tg(s,e){let{doublePrecision:t,settings:i,value:n,size:o}=s,a=t&&n instanceof Float64Array?2:1;return(i.noAlloc?n.length:e*o)*a}function OP({buffer:s,numInstances:e,attribute:t,fromLength:i,fromStartIndices:n,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=n&&c,d=Tg(t,e),f=t.isConstant;if(!h&&i>=d)return;let p=f?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!f){let O=o;o=(B,I)=>t.normalizeConstant(O(B,I))}let S=f?(O,B)=>o(p,B):(O,B)=>o(p.subarray(O,O+l),B),x=s.getData({length:i}),C=new Float32Array(d);ww({source:x,target:C,sourceStartIndices:n,targetStartIndices:c,size:l,getData:S}),s.byteLength<C.byteLength+u&&s.reallocate(C.byteLength+u),s.subData({data:C,offset:u})}var js=class extends Cg{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:Ag}),y(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return IP(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:i=0,endRow:n=1/0}=t;this.state.updateRanges=Iw(this.state.updateRanges,[i,n])}else this.state.updateRanges=Ag}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Tw}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,t.updateRanges!==Ag),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(n,this,{data:t,startRow:c,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:f})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),n.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let a=e;gt(ArrayBuffer.isView(a.value),"invalid ".concat(n.accessor));let l=Boolean(a.size)&&a.size!==this.size;return i.binaryAccessor=TP(a.value,{size:a.size||this.size,stride:a.stride,offset:a.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:f,transform:p}=l,S=u.binaryAccessor||(typeof f=="function"?f:o[f]);gt(typeof S=="function",'accessor "'.concat(f,'" is not a function'));let x=e.getVertexOffset(i),{iterable:C,objectInfo:O}=mo(t,i,n);for(let B of C){O.index++;let I=S(B,O);if(p&&(I=p.call(this,I)),d){let _=(O.index<d.length-1?d[O.index+1]:a)-d[O.index];if(I&&Array.isArray(I[0])){let X=x;for(let K of I)e._normalizeValue(K,c,X),X+=h}else I&&I.length>h?c.set(I,x):(e._normalizeValue(I,O.target,0),qE({target:c,source:O.target,start:x,count:_}));x+=_*h}else e._normalizeValue(I,c,x),x+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var Ig=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","interpolation"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.transition=new an(i),this.attribute=t,this.attributeInTransition=new js(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=ZV(e,t);let n={byteLength:0,usage:35050};this.buffers=[new Se(e,n),new Se(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}this.settings=e;let{gl:i,buffers:n,attribute:o}=this;RP(n);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)OP({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=Tg(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:n[0],aTo:wP(i,o)},feedbackBuffers:{vCurrent:n[1]}})}update(){let e=this.transition.update();if(e){let{duration:t,easing:i}=this.settings,{time:n}=this.transition,o=n/t;i&&(o=i(o)),this.transform.run({uniforms:{time:o}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0}},KV=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function ZV(s,e){let t=LP(e.size);return new nn(s,{vs:KV,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var wg=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","spring"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"texture",void 0),y(this,"framebuffer",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new an(i),this.attribute=t,this.attributeInTransition=new js(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=JV(e),this.framebuffer=$V(e,this.texture),this.transform=QV(e,t,this.framebuffer);let n={byteLength:0,usage:35050};this.buffers=[new Se(e,n),new Se(e,n),new Se(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:i,buffers:n,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)OP({buffer:l,...a});this.settings=e,this.currentStartIndices=o.startIndices,this.currentLength=Tg(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:wP(i,o)}})}update(){let{buffers:e,transform:t,framebuffer:i,transition:n}=this;if(!n.update())return!1;let a=this.settings;return t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:a.stiffness,damping:a.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),RP(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),Ms(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}};function QV(s,e,t){let i=LP(e.size);return new nn(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function JV(s){return new Ve(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function $V(s,e){return new Me(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var ek={interpolation:Ig,spring:wg},Lg=class{constructor(e,{id:t,timeline:i}){y(this,"id",void 0),y(this,"isSupported",void 0),y(this,"gl",void 0),y(this,"timeline",void 0),y(this,"transitions",void 0),y(this,"needsRedraw",void 0),y(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=nn.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(let n in e){let o=e[n],a=o.getTransitionSetting(t);!a||this._updateAttribute(n,o,a)}for(let n in this.transitions){let o=e[n];(!o||!o.getTransitionSetting(t))&&this._removeTransition(n)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){let n=this.transitions[e],o=!n||n.type!==i.type;if(o){if(!this.isSupported){de.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}n&&this._removeTransition(e);let a=ek[i.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(de.error("unsupported transition type '".concat(i.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}};var Lw="attributeManager.invalidate",tk="attributeManager.updateStart",rk="attributeManager.updateEnd",ik="attribute.updateStart",nk="attribute.allocate",ok="attribute.updateEnd",Rg=class{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"attributes",void 0),y(this,"updateTriggers",void 0),y(this,"needsRedraw",void 0),y(this,"userData",void 0),y(this,"stats",void 0),y(this,"attributeTransitionManager",void 0),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new Lg(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(let t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);kt(Lw,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);kt(Lw,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:o={},buffers:a={},context:l={}}){let u=!1;kt(tk,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=i,h.numInstances=t,o[c]&&de.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(typeof d=="string"?a[d]:void 0,e.startIndices)||typeof d=="string"&&!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}u&&kt(rk,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!i.hasAttribute(o)&&(n[o]=a)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let i={};for(let n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}_add(e,t={}){for(let i in e){let n=e[i];this.attributes[i]=this._createAttribute(i,n,t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){let n={...t,id:e,size:t.isIndexed&&1||t.size||1,divisor:i.instanced?1:t.divisor||0};return new js(this.gl,n)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(n=>{e[n]||(e[n]=[]),e[n].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:n}=this,o=n[e];return o&&o.forEach(a=>{let l=i[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:i}=e;if(kt(ik,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&kt(nk,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,kt(ok,t,i))}};var Og=class extends an{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:o}}=this,a=o(e/n);this._value=vu(t,i,a)}};var Rw=1e-5;function Ow(s,e,t,i,n){let o=e-s,l=(t-e)*n,u=-o*i;return l+u+o+e}function sk(s,e,t,i,n){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=Ow(s[a],e[a],t[a],i,n);return o}return Ow(s,e,t,i,n)}function _w(s,e){if(Array.isArray(s)){let t=0;for(let i=0;i<s.length;i++){let n=s[i]-e[i];t+=n*n}return Math.sqrt(t)}return Math.abs(s-e)}var _g=class extends an{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=sk(o,a,t,i,n),u=_w(l,t),c=_w(l,a);u<Rw&&c<Rw&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var ak={interpolation:Og,spring:_g},Ng=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(n=IP(n),!n)return;let a=ak[n.type];if(!a){de.error("unsupported transition type '".concat(n.type,"'"))();return}let l=new a(this.timeline);l.start({...n,fromValue:t,toValue:i}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function Mw(s){let e=ix(s);for(let t in e){let i=e[t],{validate:n}=i;if(n&&!n(s[t],i))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function Bw(s,e){let t=Dw({newProps:s,oldProps:e,propTypes:ix(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=uk(s,e),n=!1;return i||(n=ck(s,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:n,extensionsChanged:hk(s,e),transitionsChanged:lk(s,e)}}function lk(s,e){if(!s.transitions)return!1;let t={},i=ix(s),n=!1;for(let o in s.transitions){let a=i[o],l=a&&a.type;(l==="number"||l==="color"||l==="array")&&rx(s[o],e[o],a)&&(t[o]=!0,n=!0)}return n?t:!1}function Dw({newProps:s,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:n="props"}){if(e===s)return!1;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(n," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(n,".").concat(o," added");let a=rx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(n,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=rx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}}return!1}function rx(s,e,t){let i=t&&t.equal;return i&&!i(s,e,t)||!i&&(i=s&&e&&s.equals,i&&!i.call(s,e))?"changed deeply":!i&&e!==s?"changed shallowly":null}function uk(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1,{dataComparator:i,_dataDiff:n}=s;return i?i(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&n&&(t=n(s.data,e.data)||t),t}function ck(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&Nw(s,e,"all"))return{all:!0};let t={},i=!1;for(let n in s.updateTriggers)n!=="all"&&Nw(s,e,n)&&(t[n]=!0,i=!0);return i?t:!1}function hk(s,e){if(e===null)return!0;let t=e.extensions,{extensions:i}=s;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let n=0;n<i.length;n++)if(!i[n].equals(t[n]))return!0;return!1}function Nw(s,e,t){let i=s.updateTriggers[t];i=i??{};let n=e.updateTriggers[t];return n=n??{},Dw({oldProps:n,newProps:i,triggerName:t})}function ix(s){let e=s[_h],t=e&&e.constructor;return t?t._propTypes:{}}var dk="count(): argument not an object",fk="count(): argument not a container";function Fw(s){if(!pk(s))throw new Error(dk);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(gk(s))return Object.keys(s).length;throw new Error(fk)}function gk(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function pk(s){return s!==null&&typeof s=="object"}function Gw(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){let i=t.modules.findIndex(n=>n.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let i={...s.inject};for(let n in e.inject)i[n]=(i[n]||"")+e.inject[n];t.inject=i}return t}var mk={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},nx={};function Vw(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Ve)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={[10241]:e.data.length>1?9985:9729});let n=new Ve(t,{...e,parameters:{...mk,...i,...s.props.textureParameters}});return nx[n.id]=!0,n}function kw(s){!s||!(s instanceof Ve)||nx[s.id]&&(s.delete(),delete nx[s.id])}var bk={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||Bg(s)&&(s.length===3||s.length===4)},equal(s,e,t){return ox(s,e)}},accessor:{validate(s,e){let t=_P(s);return t==="function"||t===_P(e.value)},equal(s,e,t){return typeof e=="function"?!0:ox(s,e)}},array:{validate(s,e){return e.optional&&!s||Bg(s)},equal(s,e,t){return t.compare?ox(s,e):s===e}},object:{equal(s,e,t){return t.compare?sn(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:i}=t.props;return i&&s?i(s):s}},image:{transform:(s,e,t)=>Vw(t,s),release:s=>{kw(s)}}};function ox(s,e){if(s===e)return!0;if(!Bg(s)||!Bg(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}function Uw(s){let e={},t={},i={};for(let[n,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)i[n]=Array.isArray(a)?a:[a];else{let l=Pk(n,o);e[n]=l,t[n]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function Pk(s,e){switch(_P(e)){case"object":return Mg(s,e);case"array":return Mg(s,{type:"array",value:e,compare:!1});case"boolean":return Mg(s,{type:"boolean",value:e});case"number":return Mg(s,{type:"number",value:e});case"function":return Mg(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function Mg(s,e){return"type"in e?{name:s,...bk[e.type],...e}:"value"in e?{name:s,type:_P(e.value),...e}:{name:s,type:"object",value:e}}function Bg(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function _P(s){return Bg(s)?"array":s===null?"null":typeof s}function zw(s,e){let t=Ww(s.constructor),i=Object.create(t);i[_h]=s,i[ts]={},i[fo]={};for(let n=0;n<e.length;++n){let o=e[n];for(let a in o)i[a]=o[a]}return Object.freeze(i),i}function Ww(s){let e=NP(s,"_mergedDefaultProps");return e||(yk(s),s._mergedDefaultProps)}function yk(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),i=Ww(t),n=NP(s,"defaultProps")||{},o=Uw(n),a=Sk(o.defaultProps,i,s),l={...t._propTypes,...o.propTypes};xk(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};Ek(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function Sk(s,e,t){let i=Object.create(null);Object.assign(i,e,s);let n=Ck(t);return delete s.id,Object.defineProperties(i,{id:{writable:!0,value:n}}),i}function Ek(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(i){let n="".concat(this.id,": ").concat(t);for(let o of e[t])Hw(this,o)||(this[o]=i);de.deprecated(n,e[t].join("/"))()}})}function xk(s,e){let t={},i={};for(let n in e){let o=e[n],{name:a,value:l}=o;o.async&&(t[a]=l,i[a]=vk(a))}s[ks]=t,s[ts]={},Object.defineProperties(s,i)}function vk(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||AP(e)?this[ts][s]=e:this[fo][s]=e},get(){if(this[fo]){if(s in this[fo])return this[fo][s]||this[ks][s];if(s in this[ts]){let e=this[_h]&&this[_h].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[ks][s]}}return this[ks][s]}}}function Hw(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function NP(s,e){return Hw(s,e)&&s[e]}function Ck(s){let e=NP(s,"layerName")||NP(s,"componentName");return e||de.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var Ak=0,Uu=class{constructor(...e){y(this,"id",void 0),y(this,"props",void 0),y(this,"count",void 0),this.props=zw(this,e),this.id=this.props.id,this.count=Ak++}clone(e){let{props:t}=this,i={};for(let n in t[ks])n in t[fo]?i[n]=t[fo][n]:n in t[ts]&&(i[n]=t[ts][n]);return new this.constructor({...t,...i,...e})}};y(Uu,"componentName","Component");y(Uu,"defaultProps",{});var Tk=Object.freeze({}),Dg=class{constructor(e){y(this,"component",void 0),y(this,"onAsyncPropUpdated",void 0),y(this,"asyncProps",void 0),y(this,"oldProps",void 0),y(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||Tk}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[fo]||{},i=e[ts]||e,n=e[ks]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in i){let a=i[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(AP(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let n=i.pendingLoadCount;t.then(o=>{o=this._postProcessValue(i,o),this._setAsyncPropValue(e,o,n),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let n=i.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,n)}this._onResolve(e,o)}_postProcessValue(e,t){let i=e.type;return i&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let n=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var Fg=class extends Dg{constructor({attributeManager:e,layer:t}){super(t),y(this,"attributeManager",void 0),y(this,"needsRedraw",void 0),y(this,"needsUpdate",void 0),y(this,"subLayers",void 0),y(this,"usesPickingColorCache",void 0),y(this,"changeFlags",void 0),y(this,"viewport",void 0),y(this,"uniformTransitions",void 0),y(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let i=this.component.props.fetch;return i?i(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let i=this.component.props.onDataLoad;e==="data"&&i&&i(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var Ik="layer.changeFlag",wk="layer.initialize",Lk="layer.update",Rk="layer.finalize",Ok="layer.matched",jw=2**24-1,_k=Object.freeze([]),Nk=ao(({oldViewport:s,viewport:e})=>s.equals(e)),rs=new Uint8ClampedArray(0),Mk={data:{type:"data",value:_k,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:i,loadOptions:n,signal:o})=>{let{resourceManager:a}=t.context;if(n=n||t.getLoadOptions(),i=i||t.props.loaders,o){var l;n={...n,fetch:{...(l=n)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!n&&(a.add({resourceId:s,data:Zo(s,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>{var h;return(h=t.internalState)===null||h===void 0?void 0:h.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):Zo(s,i,n)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:so.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Be.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},zt=class extends Uu{constructor(...e){super(...e),y(this,"internalState",null),y(this,"lifecycle",ol.NO_STATE),y(this,"context",void 0),y(this,"state",void 0),y(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){gt(this.internalState);let t=this.internalState.viewport||this.context.viewport,i=jE(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,o,a]=wh(i,t.pixelProjectionMatrix);return e.length===2?[n,o]:[n,o,a]}unproject(e){return gt(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){gt(this.internalState);let i=this.internalState.viewport||this.context.viewport;return HI(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Be.DEFAULT||e===Be.LNGLAT||e===Be.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){gt(e instanceof Uint8Array);let[t,i,n]=e;return t+i*256+n*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:Fw(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:i,instancePositions:n}=t.attributes;return(e=i||n)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(let t of this.props.extensions)e=Gw(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let u of i)t.invalidateAll(u);else t.invalidateAll();let{props:n,oldProps:o}=e,a=Number.isInteger(o.highlightedObjectIndex)||o.pickable,l=Number.isInteger(n.highlightedObjectIndex)||n.pickable;if(a!==l&&t){let{pickingColors:u,instancePickingColors:c}=t.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,t.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(e){for(let i of this.getModels())i.delete();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:n}=e;return n>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[n]),e}raiseError(e,t){var i,n;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((i=(n=this.props).onError)!==null&&i!==void 0&&i.call(n,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!Nk({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();!t||(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),n=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:n,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let n in t)Object.defineProperty(i,n,{value:t[n]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(rs.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>jw&&de.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),rs=ho.allocate(rs,t,{size:3,copy:!0,maxCount:Math.max(t,jw)});let n=Math.floor(rs.length/3),o=[];for(let a=i;a<n;a++)this.encodePickingColor(a,o),rs[a*3+0]=o[0],rs[a*3+1]=o[1],rs[a*3+2]=o[2]}e.value=rs.subarray(0,t*3)}_setModelAttributes(e,t){let i=this.getAttributeManager(),n=e.userData.excludeAttributes||{},o=i.getShaderAttributes(t,n);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i;if(!n)return;let o=n.getVertexOffset(e),a=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;!i||(this.internalState.usesPickingColorCache&&i.value.buffer!==rs.buffer&&(i.value=rs.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){gt(!this.internalState),gt(Number.isFinite(this.props.coordinateSystem)),kt(wk,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Fg({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(de.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Ng(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){kt(Ok,this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(kt(Lk,this,e),!e)return;let t=this.props,i=this.context,n=this.internalState,o=i.viewport,a=this._updateUniformTransition();n.propsInTransition=a,i.viewport=n.viewport||o,this.props=a;try{let l=this._getUpdateParams(),u=this.getModels();if(i.gl)this.updateState(l);else try{this.updateState(l)}catch{}for(let h of this.props.extensions)h.updateState.call(this,l,h);let c=this.getModels()[0]!==u[0];this._postUpdate(l,c)}finally{i.viewport=o,this.props=t,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){kt(Rk,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();let n=this.props,o=this.context;this.props=this.internalState.propsInTransition||n;let a=this.props.opacity;t.opacity=Math.pow(a,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:l}=this.props,u=l&&l(t)||[0,0];xi(o.gl,{polygonOffset:u}),ft(o.gl,i,()=>{let c={moduleParameters:e,uniforms:t,parameters:i,context:o};for(let h of this.props.extensions)h.draw.call(this,c,h);this.draw(c)})}finally{this.props=n}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let n in e)if(e[n]){let o=!1;switch(n){case"dataChanged":let a=e[n],l=t[n];a&&Array.isArray(l)&&(t.dataChanged=Array.isArray(a)?l.concat(a):a,o=!0);default:t[n]||(t[n]=e[n],o=!0)}o&&kt(Ik,this,n,e)}let i=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i=Bw(e,t);if(i.updateTriggersChanged)for(let o in i.updateTriggersChanged)i.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(i.transitionsChanged)for(let o in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(o,t[o],e[o],(n=e.transitions)===null||n===void 0?void 0:n[o])}return this.setChangeFlags(i)}validateProps(){Mw(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new Rg(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:n}=e;this.setNeedsRedraw(),this._updateAttributes();let{model:o}=this.state;o?.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:l,highlightColor:u}=i;if(t||n.autoHighlight!==a||n.highlightedObjectIndex!==l||n.highlightColor!==u){let c={};a||(c.pickingSelectedColor=null),Array.isArray(u)&&(c.pickingHighlightColor=u),Number.isInteger(l)&&(c.pickingSelectedColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setModuleParameters(c)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let i=this.getAttributeManager(),n=i?i.getNeedsRedraw(e):!1;return t=t||n,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};y(zt,"defaultProps",Mk);y(zt,"layerName","Layer");var Bk="compositeLayer.renderLayers",Wr=class extends zt{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){var t;let{opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:x,extensions:C,fetch:O,operation:B,_subLayerProps:I}=this.props,_={id:"",updateTriggers:{},opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:x,extensions:C,fetch:O,operation:B},X=I&&e.id&&I[e.id],K=X&&X.updateTriggers,se=e.id||"sublayer";if(X){let ge=this.constructor._propTypes,ue=e.type?e.type._propTypes:{};for(let F in X){let M=ue[F]||ge[F];M&&M.type==="accessor"&&(X[F]=this.getSubLayerAccessor(X[F]))}}Object.assign(_,e,X),_.id="".concat(this.props.id,"-").concat(se),_.updateTriggers={all:(t=this.props.updateTriggers)===null||t===void 0?void 0:t.all,...e.updateTriggers,...K};for(let ge of C){let ue=ge.getSubLayerProps.call(this,ge);ue&&Object.assign(_,ue,{updateTriggers:Object.assign(_.updateTriggers,ue.updateTriggers)})}return _}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,n=!i||this.needsUpdate();if(n){let o=this.renderLayers();i=Us(o,Boolean),this.internalState.subLayers=i}kt(Bk,this,n,i);for(let o of i)o.parent=this}};y(Wr,"layerName","CompositeLayer");var MP=Math.PI/180,qw=180/Math.PI,BP=6370972,Fh=256;function Dk(){let s=Fh/BP,e=Math.PI/180*Fh;return{unitsPerMeter:[s,s,s],unitsPerMeter2:[0,0,0],metersPerUnit:[1/s,1/s,1/s],unitsPerDegree:[e,e,s],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/s]}}var Gh=class extends di{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,nearZMultiplier:o=.1,farZMultiplier:a=2,resolution:l=10}=e,{height:u,altitude:c=1.5}=e;u=u||1,c=Math.max(.75,c);let h=new it().lookAt({eye:[0,-c,0],up:[0,0,1]}),d=Math.pow(2,n);h.rotateX(t*MP),h.rotateZ(-i*MP),h.scale(d/u);let f=Math.atan(.5/c),p=Fh*2*d/u;super({...e,height:u,viewMatrix:h,longitude:i,latitude:t,zoom:n,distanceScales:Dk(),fovyRadians:f*2,focalDistance:c,near:o,far:Math.min(2,1/p+1)*c*a}),y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"resolution",void 0),this.latitude=t,this.longitude=i,this.resolution=l}get projectionMode(){return ci.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,this.height/2],t),n=this.unproject([this.width/2,0],t),o=this.unproject([this.width,this.height/2],t),a=this.unproject([this.width/2,this.height],t);return o[0]<this.longitude&&(o[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],o[0],n[0],a[0]),Math.min(i[1],o[1],n[1],a[1]),Math.max(i[0],o[0],n[0],a[0]),Math.max(i[1],o[1],n[1],a[1])]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,{pixelUnprojectionMatrix:u}=this,c;if(Number.isFinite(a))c=sx(u,[n,l,a,1]);else{let p=sx(u,[n,l,-1,1]),S=sx(u,[n,l,1,1]),x=((i||0)/BP+1)*Fh,C=oP(iP([],p,S)),O=oP(p),B=oP(S),I=(4*O*B-(C-O-B)**2)/16,_=4*I/C,X=Math.sqrt(O-_),K=Math.sqrt(Math.max(0,x*x-_)),se=(X-K)/Math.sqrt(C);c=ET([],p,S,se)}let[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i,n=0]=e,o=t*MP,a=i*MP,l=Math.cos(a),u=(n/BP+1)*Fh;return[Math.sin(o)*l*u,-Math.cos(o)*l*u,Math.sin(a)*u]}unprojectPosition(e){let[t,i,n]=e,o=nP(e),a=Math.asin(n/o),u=Math.atan2(t,-i)*qw,c=a*qw,h=(o/Fh-1)*BP;return[u,c,h]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){let i=this.unproject(t);return{longitude:e[0]-i[0]+this.longitude,latitude:e[1]-i[1]+this.latitude}}};function sx(s,e){let t=oo([],e,s);return Eh(t,t,1/t[3]),t}var zu=class{constructor(e){y(this,"opts",void 0),e&&(this.opts=e)}equals(e){return this===e?!0:this.constructor===e.constructor&&sn(this.opts,e.opts)}getShaders(e){return null}getSubLayerProps(e){let{defaultProps:t}=e.constructor,i={updateTriggers:{}};for(let n in t)if(n in this.props){let o=t[n],a=this.props[n];i[n]=a,o&&o.type==="accessor"&&(i.updateTriggers[n]=this.props.updateTriggers[n],typeof a=="function"&&(i[n]=this.getSubLayerAccessor(a)))}return i}initializeState(e,t){}updateState(e,t){}draw(e,t){}finalizeState(e,t){}};y(zu,"defaultProps",{});var ll=class{constructor(e){y(this,"opts",void 0),y(this,"typedArrayManager",void 0),y(this,"indexStarts",[0]),y(this,"vertexStarts",[0]),y(this,"vertexCount",0),y(this,"instanceCount",0),y(this,"attributes",void 0),y(this,"_attributeDefs",void 0),y(this,"data",void 0),y(this,"getGeometry",void 0),y(this,"geometryBuffer",void 0),y(this,"buffers",void 0),y(this,"positionSize",void 0),y(this,"normalize",void 0);let{attributes:t={}}=e;this.typedArrayManager=ho,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:n,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=i,this.normalize=u,o&&(gt(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(i.positions=o)),this.geometryBuffer=i.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){let t=e.value||e;return ArrayBuffer.isView(t)?TP(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){let{attributes:i,buffers:n,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in n)a.release(i[l]),i[l]=null;else{let u=o[l];u.copy=t,i[l]=a.allocate(i[l],e,u)}}_forEachGeometry(e,t,i){let{data:n,getGeometry:o}=this,{iterable:a,objectInfo:l}=mo(n,t,i);for(let u of a){l.index++;let c=o?o(u,l):null;e(c,l.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!a)this._forEachGeometry((d,f)=>{let p=d&&this.normalizeGeometry(d);c[f]=p,i[f+1]=i[f]+(p?this.getGeometrySize(p):0)},l,u),n=i[i.length-1];else if(i=o.startIndices,n=i[o.length]||0,ArrayBuffer.isView(a))n=n||a.length/this.positionSize;else if(a instanceof Se){let d=a.accessor.stride||this.positionSize*4;n=n||a.byteLength/d}else if(a.buffer){let d=a.stride||this.positionSize*4;n=n||a.buffer.byteLength/d}else if(a.value){let d=a.value,f=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;n=n||d.length/f}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;let h={};this._forEachGeometry((d,f)=>{let p=c[f]||d;h.vertexStart=i[f],h.indexStart=t[f];let S=f<i.length-1?i[f+1]:n;h.geometrySize=S-i[f],h.geometryIndex=f,this.updateGeometryAttributes(p,h)},l,u),this.vertexCount=t[t.length-1]}};var Xw=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var Yw=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var Fk=1024,Gk=4,Kw=()=>{},Zw={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function Vk(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function kk(s,e,t,i){return t===e.width&&i===e.height?e:(s.canvas.height=i,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,i),s.canvas)}function Gg(s){return s&&(s.id||s.url)}function Uk(s,e,t,i){let n=s.width,o=s.height,a=new Ve(s.gl,{width:e,height:t,parameters:i});return Gb(s,a,{targetY:0,width:n,height:o}),s.delete(),a}function Qw(s,e,t){for(let i=0;i<e.length;i++){let{icon:n,xOffset:o}=e[i],a=Gg(n);s[a]={...n,x:o,y:t}}}function zk({icons:s,buffer:e,mapping:t={},xOffset:i=0,yOffset:n=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=Gg(c);if(!t[h]){let{height:d,width:f}=c;i+f+e>a&&(Qw(t,l,n),i=0,n=o+n+e,o=0,l=[]),l.push({icon:c,xOffset:i}),i=i+f+e,o=Math.max(o,d)}}return l.length>0&&Qw(t,l,n),{mapping:t,rowHeight:o,xOffset:i,yOffset:n,canvasWidth:a,canvasHeight:Vk(o+n+e)}}function Wk(s,e,t){if(!s||!e)return null;t=t||{};let i={},{iterable:n,objectInfo:o}=mo(s);for(let a of n){o.index++;let l=e(a,o),u=Gg(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!i[u]&&(!t[u]||l.url!==t[u].url)&&(i[u]={...l,source:a,sourceIndex:o.index})}return i}var Vg=class{constructor(e,{onUpdate:t=Kw,onError:i=Kw}){y(this,"gl",void 0),y(this,"onUpdate",void 0),y(this,"onError",void 0),y(this,"_loadOptions",null),y(this,"_texture",null),y(this,"_externalTexture",null),y(this,"_mapping",{}),y(this,"_textureParameters",null),y(this,"_pendingCount",0),y(this,"_autoPacking",!1),y(this,"_xOffset",0),y(this,"_yOffset",0),y(this,"_rowHeight",0),y(this,"_buffer",Gk),y(this,"_canvasWidth",Fk),y(this,"_canvasHeight",0),y(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=i}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?Gg(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n,textureParameters:o}){if(e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),n&&(this._mapping=n),i){var a;(a=this._texture)===null||a===void 0||a.delete(),this._texture=null,this._externalTexture=i}o&&(this._textureParameters=o)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;let i=Object.values(Wk(e,t,this._mapping)||{});if(i.length>0){let{mapping:n,xOffset:o,yOffset:a,rowHeight:l,canvasHeight:u}=zk({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=n,this._xOffset=o,this._yOffset=a,this._canvasHeight=u,this._texture||(this._texture=new Ve(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||Zw})),this._texture.height!==this._canvasHeight&&(this._texture=Uk(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||Zw)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let i of e)this._pendingCount++,Zo(i.url,du,this._loadOptions).then(n=>{let o=Gg(i),{x:a,y:l,width:u,height:c}=this._mapping[o],h=kk(t,n,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(n=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:n})}).finally(()=>{this._pendingCount--})}};var Jw=[0,0,0,255],Hk={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:Jw},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},Dn=class extends zt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:Xw,fs:Yw,modules:[hi,Mn]})}initializeState(){this.state={iconManager:new Vg(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:Jw},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager(),{iconAtlas:a,iconMapping:l,data:u,getIcon:c,textureParameters:h}=t,{iconManager:d}=this.state,f=a||this.internalState.isAsyncPropLoading("iconAtlas");if(d.setProps({loadOptions:t.loadOptions,autoPacking:!f,iconAtlas:a,iconMapping:f?l:null,textureParameters:h}),f?i.iconMapping!==t.iconMapping&&o.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&d.packIcons(u,c),n.extensionsChanged){var p;let{gl:S}=this.context;(p=this.state.model)===null||p===void 0||p.delete(),this.state.model=this._getModel(S),o.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:zr[o],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;let i=(t=this.getCurrentLayer())===null||t===void 0?void 0:t.props.onIconError;i?i(e):de.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:n=t/2,anchorY:o=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-n,i/2-o]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let{x:t,y:i,width:n,height:o}=this.state.iconManager.getIconMapping(e);return[t,i,n,o]}};y(Dn,"defaultProps",Hk);y(Dn,"layerName","IconLayer");var $w=`#define SHADER_NAME scatterplot-layer-vertex-shader

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceRadius;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;


void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  outerRadiusPixels = clamp(
    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
    radiusMinPixels, radiusMaxPixels
  );
  
  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  outerRadiusPixels += stroked * lineWidthPixels / 2.0;

  // Expand geometry to accomodate edge smoothing
  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;

  // position on the containing square in [-1, 1] space
  unitPosition = edgePadding * positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
  
  if (billboard) {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = edgePadding * positions * outerRadiusPixels;
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  }

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var eL=`#define SHADER_NAME scatterplot-layer-fragment-shader

precision highp float;

uniform bool filled;
uniform float stroked;
uniform bool antialiasing;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition) * outerRadiusPixels;
  float inCircle = antialiasing ? 
    smoothedge(distToCenter, outerRadiusPixels) : 
    step(distToCenter, outerRadiusPixels);

  if (inCircle == 0.0) {
    discard;
  }

  if (stroked > 0.5) {
    float isLine = antialiasing ? 
      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
      step(innerUnitRadius * outerRadiusPixels, distToCenter);

    if (filled) {
      gl_FragColor = mix(vFillColor, vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inCircle;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var tL=[0,0,0,255],jk={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:s=>s.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:tL},getLineColor:{type:"accessor",value:tL},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}},Wu=class extends zt{getShaders(){return super.getShaders({vs:$w,fs:eL,modules:[hi,Mn]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){if(super.updateState(e),e.changeFlags.extensionsChanged){var t;let{gl:i}=this.context;(t=this.state.model)===null||t===void 0||t.delete(),this.state.model=this._getModel(i),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{radiusUnits:t,radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,stroked:a,filled:l,billboard:u,antialiasing:c,lineWidthUnits:h,lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:a?1:0,filled:l,billboard:u,antialiasing:c,radiusUnits:zr[t],radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,lineWidthUnits:zr[h],lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}).draw()}_getModel(e){let t=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Wu,"defaultProps",jk);y(Wu,"layerName","ScatterplotLayer");var DP={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function kg(s,e,t={}){return rL(s,t)!==e?(qk(s,t),!0):!1}function rL(s,e={}){return Math.sign(FP(s,e))}function FP(s,e={}){let{start:t=0,end:i=s.length}=e,n=e.size||2,o=0;for(let a=t,l=i-n;a<i;a+=n)o+=(s[a]-s[l])*(s[a+1]+s[l+1]),l=a;return o/2}function qk(s,e){let{start:t=0,end:i=s.length,size:n=2}=e,o=(i-t)/n,a=Math.floor(o/2);for(let l=0;l<a;++l){let u=t+l*n,c=t+(o-1-l)*n;for(let h=0;h<n;++h){let d=s[u+h];s[u+h]=s[c+h],s[c+h]=d}}}function Vi(s,e){let t=e.length,i=s.length;if(i>0){let n=!0;for(let o=0;o<t;o++)if(s[i-t+o]!==e[o]){n=!1;break}if(n)return!1}for(let n=0;n<t;n++)s[i+n]=e[n];return!0}function Ug(s,e){let t=e.length;for(let i=0;i<t;i++)s[i]=e[i]}function ul(s,e,t,i,n=[]){let o=i+e*t;for(let a=0;a<t;a++)n[a]=s[o+a];return n}function GP(s,e,t,i,n=[]){let o,a;if(t&8)o=(i[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(i[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(i[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(i[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)n[l]=(a&1)===l?i[a]:o*(e[l]-s[l])+s[l];return n}function zg(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function Wg(s,e){let{size:t=2,broken:i=!1,gridResolution:n=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e||{},u=(l-a)/t,c=[],h=[c],d=ul(s,0,t,a),f,p,S=oL(d,n,o,[]),x=[];Vi(c,d);for(let C=1;C<u;C++){for(f=ul(s,C,t,a,f),p=zg(f,S);p;){GP(d,f,p,S,x);let O=zg(x,S);O&&(GP(d,x,O,S,x),p=O),Vi(c,x),Ug(d,x),Kk(S,n,p),i&&c.length>t&&(c=[],h.push(c),Vi(c,d)),p=zg(f,S)}Vi(c,f),Ug(d,f)}return i?h:h[0]}var iL=0,Yk=1;function VP(s,e){for(let t=0;t<e.length;t++)s.push(e[t]);return s}function Hg(s,e=null,t){if(!s.length)return[];let{size:i=2,gridResolution:n=10,gridOffset:o=[0,0],edgeTypes:a=!1}=t||{},l=[],u=[{pos:s,types:a?new Array(s.length/i).fill(Yk):null,holes:e||[]}],c=[[],[]],h=[];for(;u.length;){let{pos:d,types:f,holes:p}=u.shift();Zk(d,i,p[0]||d.length,c),h=oL(c[0],n,o,h);let S=zg(c[1],h);if(S){let x=nL(d,f,i,0,p[0]||d.length,h,S),C={pos:x[0].pos,types:x[0].types,holes:[]},O={pos:x[1].pos,types:x[1].types,holes:[]};u.push(C,O);for(let B=0;B<p.length;B++)x=nL(d,f,i,p[B],p[B+1]||d.length,h,S),x[0]&&(C.holes.push(C.pos.length),C.pos=VP(C.pos,x[0].pos),a&&(C.types=VP(C.types,x[0].types))),x[1]&&(O.holes.push(O.pos.length),O.pos=VP(O.pos,x[1].pos),a&&(O.types=VP(O.types,x[1].types)))}else{let x={positions:d};a&&(x.edgeTypes=f),p.length&&(x.holeIndices=p),l.push(x)}}return l}function nL(s,e,t,i,n,o,a){let l=(n-i)/t,u=[],c=[],h=[],d=[],f=[],p,S,x,C=ul(s,l-1,t,i),O=Math.sign(a&8?C[1]-o[3]:C[0]-o[2]),B=e&&e[l-1],I=0,_=0;for(let X=0;X<l;X++)p=ul(s,X,t,i,p),S=Math.sign(a&8?p[1]-o[3]:p[0]-o[2]),x=e&&e[i/t+X],S&&O&&O!==S&&(GP(C,p,a,o,f),Vi(u,f)&&h.push(B),Vi(c,f)&&d.push(B)),S<=0?(Vi(u,p)&&h.push(x),I-=S):h.length&&(h[h.length-1]=iL),S>=0?(Vi(c,p)&&d.push(x),_+=S):d.length&&(d[d.length-1]=iL),Ug(C,p),O=S,B=x;return[I?{pos:u,types:e&&h}:null,_?{pos:c,types:e&&d}:null]}function oL(s,e,t,i){let n=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return i[0]=n,i[1]=o,i[2]=n+e,i[3]=o+e,i}function Kk(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function Zk(s,e,t,i){let n=1/0,o=-1/0,a=1/0,l=-1/0;for(let u=0;u<t;u+=e){let c=s[u],h=s[u+1];n=c<n?c:n,o=c>o?c:o,a=h<a?h:a,l=h>l?h:l}return i[0][0]=n,i[0][1]=a,i[1][0]=o,i[1][1]=l,i}var Qk=85.051129;function ax(s,e){let{size:t=2,startIndex:i=0,endIndex:n=s.length,normalize:o=!0}=e||{},a=s.slice(i,n);sL(a,t,0,n-i);let l=Wg(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)aL(u,t);return l}function lx(s,e=null,t){let{size:i=2,normalize:n=!0,edgeTypes:o=!1}=t||{};e=e||[];let a=[],l=[],u=0,c=0;for(let d=0;d<=e.length;d++){let f=e[d]||s.length,p=c,S=Jk(s,i,u,f);for(let x=S;x<f;x++)a[c++]=s[x];for(let x=u;x<S;x++)a[c++]=s[x];sL(a,i,p,c),$k(a,i,p,c,t?.maxLatitude),u=f,l[d]=c}l.pop();let h=Hg(a,l,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:o});if(n)for(let d of h)aL(d.positions,i);return h}function Jk(s,e,t,i){let n=-1,o=-1;for(let a=t+1;a<i;a+=e){let l=Math.abs(s[a]);l>n&&(n=l,o=a-1)}return o}function $k(s,e,t,i,n=Qk){let o=s[t],a=s[i-e];if(Math.abs(o-a)>180){let l=ul(s,0,e,t);l[0]+=Math.round((a-o)/360)*360,Vi(s,l),l[1]=Math.sign(l[1])*n,Vi(s,l),l[0]=o,Vi(s,l)}}function sL(s,e,t,i){let n=s[0],o;for(let a=t;a<i;a+=e){o=s[a];let l=o-n;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=n=o}}function aL(s,e){let t,i=s.length/e;for(let o=0;o<i&&(t=s[o*e],(t+180)%360===0);o++);let n=-Math.round(t/360)*360;if(n!==0)for(let o=0;o<i;o++)s[o*e]+=n}function lL(s,e,t,i){let n;if(Array.isArray(s[0])){let o=s.length*e;n=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)n[a*e+l]=s[a][l]||0}else n=s;return t?Wg(n,{size:e,gridResolution:t}):i?ax(n,{size:e}):n}var t3=1,r3=2,ux=4,jg=class extends ll{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?lL(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(uL(e)){let i=0;for(let n of e)i+=this.getGeometrySize(n);return i}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&uL(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let i=this.attributes.segmentTypes,n=e?this.isClosed(e):!1,{vertexStart:o,geometrySize:a}=t;i.fill(0,o,o+a),n?(i[o]=ux,i[o+a-2]=ux):(i[o]+=t3,i[o+a-2]+=r3),i[o+a-1]=ux}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i||!e)return;let{vertexStart:n,geometrySize:o}=t,a=new Array(3);for(let l=n,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),i[l*3]=a[0],i[l*3+1]=a[1],i[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);let o=t*n;return i[0]=e[o],i[1]=e[o+1],i[2]=n===3&&e[o+2]||0,i}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}};function uL(s){return Array.isArray(s[0])}var cL=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var hL=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var dL=[0,0,0,255],i3={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:dL},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},cx={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},Hu=class extends zt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:cL,fs:hL,modules:[hi,Mn]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:cx,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:cx,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:cx,defaultValue:dL},instancePickingColors:{size:3,type:5121,accessor:(i,{index:n,target:o})=>this.encodePickingColor(i&&i.__source?i.__source.index:n,o)}}),this.setState({pathTesselator:new jg({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);let{props:t,changeFlags:i}=e,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),n.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:n,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:zr[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};y(Hu,"defaultProps",i3);y(Hu,"layerName","PathLayer");var EL=Ae(bL());var HP=DP.CLOCKWISE,PL=DP.COUNTER_CLOCKWISE,cl={isClosed:!0};function y3(s){if(s=s&&s.positions||s,!Array.isArray(s)&&!ArrayBuffer.isView(s))throw new Error("invalid polygon")}function kh(s){return"positions"in s?s.positions:s}function Kg(s){return"holeIndices"in s?s.holeIndices:null}function S3(s){return Array.isArray(s[0])}function E3(s){return s.length>=1&&s[0].length>=2&&Number.isFinite(s[0][0])}function x3(s){let e=s[0],t=s[s.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function v3(s,e,t,i){for(let n=0;n<e;n++)if(s[t+n]!==s[i-e+n])return!1;return!0}function yL(s,e,t,i,n){let o=e,a=t.length;for(let l=0;l<a;l++)for(let u=0;u<i;u++)s[o++]=t[l][u]||0;if(!x3(t))for(let l=0;l<i;l++)s[o++]=t[0][l]||0;return cl.start=e,cl.end=o,cl.size=i,kg(s,n,cl),o}function SL(s,e,t,i,n=0,o,a){o=o||t.length;let l=o-n;if(l<=0)return e;let u=e;for(let c=0;c<l;c++)s[u++]=t[n+c];if(!v3(t,i,n,o))for(let c=0;c<i;c++)s[u++]=t[n+c];return cl.start=e,cl.end=u,cl.size=i,kg(s,a,cl),u}function xL(s,e){y3(s);let t=[],i=[];if("positions"in s){let{positions:n,holeIndices:o}=s;if(o){let a=0;for(let l=0;l<=o.length;l++)a=SL(t,a,n,e,o[l-1],o[l],l===0?HP:PL),i.push(a);return i.pop(),{positions:t,holeIndices:i}}s=n}if(!S3(s))return SL(t,0,s,e,0,t.length,HP),t;if(!E3(s)){let n=0;for(let[o,a]of s.entries())n=yL(t,n,a,e,o===0?HP:PL),i.push(n);return i.pop(),{positions:t,holeIndices:i}}return yL(t,0,s,e,HP),t}function vL(s,e,t){let i=Kg(s);i&&(i=i.map(o=>o/e));let n=kh(s);if(t){let o=n.length;n=n.slice();let a=[];for(let l=0;l<o;l+=e){a[0]=n[l],a[1]=n[l+1];let u=t(a);n[l]=u[0],n[l+1]=u[1]}}return(0,EL.default)(n,i,e)}var Zg=class extends ll{constructor(e){let{fp64:t,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:i,size:1}}})}get(e){let{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);let t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){let t=xL(e,this.positionSize);return this.opts.resolution?Hg(kh(t),Kg(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?lx(kh(t),Kg(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(CL(e)){let t=0;for(let i of e)t+=this.getGeometrySize(i);return t}return kh(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&CL(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n,t.indexStart=this.indexStarts[t.geometryIndex+1]}else this._updateIndices(e,t),this._updatePositions(e,t),this._updateVertexValid(e,t)}_updateIndices(e,{geometryIndex:t,vertexStart:i,indexStart:n}){let{attributes:o,indexStarts:a,typedArrayManager:l}=this,u=o.indices;if(!u||!e)return;let c=n,h=vL(e,this.positionSize,this.opts.preproject);u=l.allocate(u,n+h.length,{copy:!0});for(let d=0;d<h.length;d++)u[c++]=h[d]+i;a[t+1]=n+h.length,o.indices=u}_updatePositions(e,{vertexStart:t,geometrySize:i}){let{attributes:{positions:n},positionSize:o}=this;if(!n||!e)return;let a=kh(e);for(let l=t,u=0;u<i;l++,u++){let c=a[u*o],h=a[u*o+1],d=o>2?a[u*o+2]:0;n[l*3]=c,n[l*3+1]=h,n[l*3+2]=d}}_updateVertexValid(e,{vertexStart:t,geometrySize:i}){let{positionSize:n}=this,o=this.attributes.vertexValid,a=e&&Kg(e);if(e&&e.edgeTypes?o.set(e.edgeTypes,t):o.fill(1,t,t+i),a)for(let l=0;l<a.length;l++)o[t+a[l]/n-1]=0;o[t+i-1]=0}};function CL(s){return Array.isArray(s)&&s.length>0&&!Number.isFinite(s[0])}var jP=`
attribute vec2 vertexPositions;
attribute float vertexValid;

uniform bool extruded;
uniform bool isWireframe;
uniform float elevationScale;
uniform float opacity;

varying vec4 vColor;

struct PolygonProps {
  vec4 fillColors;
  vec4 lineColors;
  vec3 positions;
  vec3 nextPositions;
  vec3 pickingColors;
  vec3 positions64Low;
  vec3 nextPositions64Low;
  float elevations;
};

vec3 project_offset_normal(vec3 vector) {
  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
    // normals generated by the polygon tesselator are in lnglat offsets instead of meters
    return normalize(vector * project_uCommonUnitsPerWorldUnit);
  }
  return project_normal(vector);
}

void calculatePosition(PolygonProps props) {
#ifdef IS_SIDE_VERTEX
  if(vertexValid < 0.5){
    gl_Position = vec4(0.);
    return;
  }
#endif

  vec3 pos;
  vec3 pos64Low;
  vec3 normal;
  vec4 colors = isWireframe ? props.lineColors : props.fillColors;

  geometry.worldPosition = props.positions;
  geometry.worldPositionAlt = props.nextPositions;
  geometry.pickingColor = props.pickingColors;

#ifdef IS_SIDE_VERTEX
  pos = mix(props.positions, props.nextPositions, vertexPositions.x);
  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);
#else
  pos = props.positions;
  pos64Low = props.positions64Low;
#endif

  if (extruded) {
    pos.z += props.elevations * vertexPositions.y * elevationScale;
  }
  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  if (extruded) {
  #ifdef IS_SIDE_VERTEX
    normal = vec3(
      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),
      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),
      0.0);
    normal = project_offset_normal(normal);
  #else
    normal = project_normal(vec3(0.0, 0.0, 1.0));
  #endif
    geometry.normal = normal;
    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);
    vColor = vec4(lightColor, colors.a * opacity);
  } else {
    vColor = vec4(colors.rgb, colors.a * opacity);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var AL=`#define SHADER_NAME solid-polygon-layer-vertex-shader

attribute vec3 positions;
attribute vec3 positions64Low;
attribute float elevations;
attribute vec4 fillColors;
attribute vec4 lineColors;
attribute vec3 pickingColors;

`.concat(jP,`

void main(void) {
  PolygonProps props;

  props.positions = positions;
  props.positions64Low = positions64Low;
  props.elevations = elevations;
  props.fillColors = fillColors;
  props.lineColors = lineColors;
  props.pickingColors = pickingColors;

  calculatePosition(props);
}
`);var TL=`#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX


attribute vec3 instancePositions;
attribute vec3 nextPositions;
attribute vec3 instancePositions64Low;
attribute vec3 nextPositions64Low;
attribute float instanceElevations;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

`.concat(jP,`

void main(void) {
  PolygonProps props;

  #if RING_WINDING_ORDER_CW == 1
    props.positions = instancePositions;
    props.positions64Low = instancePositions64Low;
    props.nextPositions = nextPositions;
    props.nextPositions64Low = nextPositions64Low;
  #else
    props.positions = nextPositions;
    props.positions64Low = nextPositions64Low;
    props.nextPositions = instancePositions;
    props.nextPositions64Low = instancePositions64Low;
  #endif
  props.elevations = instanceElevations;
  props.fillColors = instanceFillColors;
  props.lineColors = instanceLineColors;
  props.pickingColors = instancePickingColors;

  calculatePosition(props);
}
`);var IL=`#define SHADER_NAME solid-polygon-layer-fragment-shader

precision highp float;

varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var XP=[0,0,0,255],A3={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:s=>s.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:XP},getLineColor:{type:"accessor",value:XP},material:!0},qP={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},qu=class extends zt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(e){return super.getShaders({vs:e==="top"?AL:TL,fs:IL,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[hi,vh,Mn]})}get wrapLongitude(){return!1}initializeState(){let{gl:e,viewport:t}=this.context,{coordinateSystem:i}=this.props;t.isGeospatial&&i===Be.DEFAULT&&(i=Be.LNGLAT),this.setState({numInstances:0,polygonTesselator:new Zg({preproject:i===Be.LNGLAT&&t.projectFlat.bind(t),fp64:this.use64bitPositions(),IndexType:!e||Za(e,$e.ELEMENT_INDEX_UINT32)?Uint32Array:Uint16Array})});let n=this.getAttributeManager(),o=!0;n.remove(["instancePickingColors"]),n.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:qP,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,transition:qP,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:qP,accessor:"getFillColor",defaultValue:XP,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:qP,accessor:"getLineColor",defaultValue:XP,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(a,{index:l,target:u})=>this.encodePickingColor(a&&a.__source?a.__source.index:l,u),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{extruded:t,filled:i,wireframe:n,elevationScale:o}=this.props,{topModel:a,sideModel:l,polygonTesselator:u}=this.state,c={...e,extruded:Boolean(t),elevationScale:o};l&&(l.setInstanceCount(u.instanceCount-1),l.setUniforms(c),n&&(l.setDrawMode(3),l.setUniforms({isWireframe:!0}).draw()),i&&(l.setDrawMode(6),l.setUniforms({isWireframe:!1}).draw())),a&&(a.setVertexCount(u.vertexCount),a.setUniforms(c).draw())}updateState(e){super.updateState(e),this.updateGeometry(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager();if(n.extensionsChanged||t.filled!==i.filled||t.extruded!==i.extruded){var l;(l=this.state.models)===null||l===void 0||l.forEach(u=>u.delete()),this.setState(this._getModels(this.context.gl)),o.invalidateAll()}}updateGeometry({props:e,oldProps:t,changeFlags:i}){if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon)){let{polygonTesselator:o}=this.state,a=e.data.attributes||{};o.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:a.getPolygon,buffers:a,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:i.dataChanged}),this.setState({numInstances:o.instanceCount,startIndices:o.vertexStarts}),i.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(e){let{id:t,filled:i,extruded:n}=this.props,o,a;if(i){let l=this.getShaders("top");l.defines.NON_INSTANCED_MODEL=1,o=new At(e,{...l,id:"".concat(t,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return n&&(a=new At(e,{...this.getShaders("side"),id:"".concat(t,"-side"),geometry:new gr({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),a.userData.excludeAttributes={indices:!0}),{models:[a,o].filter(Boolean),topModel:o,sideModel:a}}calculateIndices(e){let{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){let{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}};y(qu,"defaultProps",A3);y(qu,"layerName","SolidPolygonLayer");function wL({data:s,getIndex:e,dataRange:t,replace:i}){let{startRow:n=0,endRow:o=1/0}=t,a=s.length,l=a,u=a;for(let f=0;f<a;f++){let p=e(s[f]);if(l>f&&p>=n&&(l=f),p>=o){u=f;break}}let c=l,d=u-l!==i.length?s.slice(u):void 0;for(let f=0;f<i.length;f++)s[c++]=i[f];if(d){for(let f=0;f<d.length;f++)s[c++]=d[f];s.length=c}return{startRow:l,endRow:l+i.length}}function LL(s,e){if(!s)return null;let t="startIndices"in s?s.startIndices[e]:e,i=s.featureIds.value[t];return t!==-1?T3(s,i,t):null}function T3(s,e,t){let i={properties:{...s.properties[e]}};for(let n in s.numericProps)i.properties[n]=s.numericProps[n].value[t];return i}function RL(s,e){let t={points:null,lines:null,polygons:null};for(let i in t){let n=s[i].globalFeatureIds.value;t[i]=new Uint8ClampedArray(n.length*3);let o=[];for(let a=0;a<n.length;a++)e(n[a],o),t[i][a*3+0]=o[0],t[i][a*3+1]=o[1],t[i][a*3+2]=o[2]}return t}var OL=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var _L=192/256,NL=[],I3={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},Xu=class extends Dn{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:OL}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:i,target:n})=>this.encodePickingColor(i,n)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map(o=>o/255),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&de.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:_L,outlineBuffer:n?Math.max(i,_L*(1-n)):-1,gamma:i,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):NL}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):NL}};y(Xu,"defaultProps",I3);y(Xu,"layerName","MultiIconLayer");var HL=Ae(DL());var R3=32,O3=[];function _3(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function FL({characterSet:s,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:n,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a;for(let d of s)if(!o[d]){let f=e(d);c+f+i*2>n&&(c=0,u++),o[d]={x:c+i,y:l+u*(t+i*2)+i,width:f,height:t},c+=f+i*2}let h=t+i*2;return{mapping:o,xOffset:c,yOffset:l+u*h,canvasHeight:_3(l+(u+1)*h)}}function GL(s,e,t,i){let n=0;for(let a=e;a<t;a++){var o;let l=s[a];n+=((o=i[l])===null||o===void 0?void 0:o.width)||0}return n}function VL(s,e,t,i,n,o){let a=e,l=0;for(let u=e;u<t;u++){let c=GL(s,u,u+1,n);l+c>i&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function N3(s,e,t,i,n,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=GL(s,l,u,n);c+d>i&&(a<l&&(o.push(l),a=l,c=0),d>i&&(d=VL(s,l,u,i,n,o),a=o[o.length-1])),l=u,c+=d}return c}function M3(s,e,t,i,n=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?VL(s,n,o,t,i,a):N3(s,n,o,t,i,a),a}function B3(s,e,t,i,n,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=i[c];h?(l||(l=h.height),n[u]=a+h.width/2,a+=h.width):(de.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),n[u]=a,a+=R3)}o[0]=a,o[1]=l}function mx(s,e,t,i,n){let o=Array.from(s),a=o.length,l=new Array(a),u=new Array(a),c=new Array(a),h=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,d=[0,0],f=[0,0],p=0,S=0,x=0;for(let C=0;C<=a;C++){let O=o[C];if((O===`
`||C===a)&&(x=C),x>S){let B=h?M3(o,t,i,n,S,x):O3;for(let I=0;I<=B.length;I++){let _=I===0?S:B[I-1],X=I<B.length?B[I]:x;B3(o,_,X,n,l,f);for(let K=_;K<X;K++)u[K]=p+f[1]/2,c[K]=f[0];p=p+f[1]*e,d[0]=Math.max(d[0],f[0])}S=x}O===`
`&&(l[S]=0,u[S]=0,c[S]=0,S++)}return d[1]=p,{x:l,y:u,rowWidth:c,size:d}}function kL({value:s,length:e,stride:t,offset:i,startIndices:n,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=i?i/a:0,c=n[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),f=s;if(l>1||u>0){let p=s.constructor;f=new p(c);for(let S=0;S<c;S++)f[S]=s[S*l+u]}for(let p=0;p<e;p++){let S=n[p],x=n[p+1]||c,C=f.subarray(S,x);d[p]=String.fromCodePoint.apply(null,C),h&&C.forEach(h.add,h)}if(h)for(let p of h)o.add(String.fromCodePoint(p));return{texts:d,characterCount:c}}var zh=class{constructor(e=5){y(this,"limit",void 0),y(this,"_cache",{}),y(this,"_order",[]),this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function D3(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var Wh={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:D3(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},UL=1024,F3=.9,zL=1.2,jL=3,YP=new zh(jL);function G3(s,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);let i=YP.get(s);if(!i)return t;for(let n in i.mapping)t.has(n)&&t.delete(n);return t}function V3(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function WL(s,e,t,i){s.font="".concat(i," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="alphabetic",s.textAlign="left"}function qL(s){de.assert(Number.isFinite(s)&&s>=jL,"Invalid cache limit"),YP=new zh(s)}var Jg=class{constructor(){y(this,"props",{...Wh}),y(this,"_key",void 0),y(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return zL}setProps(e={}){Object.assign(this.props,e);let t=this._key;this._key=this._getKey();let i=G3(this._key,this.props.characterSet),n=YP.get(this._key);if(n&&i.size===0){this._key!==t&&(this._atlas=n);return}let o=this._generateFontAtlas(this._key,i,n);this._atlas=o,YP.set(this._key,o)}_generateFontAtlas(e,t,i){let{fontFamily:n,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=i&&i.data;d||(d=document.createElement("canvas"),d.width=UL);let f=d.getContext("2d");WL(f,n,a,o);let{mapping:p,canvasHeight:S,xOffset:x,yOffset:C}=FL({getFontWidth:O=>f.measureText(O).width,fontHeight:a*zL,buffer:l,characterSet:t,maxCanvasWidth:UL,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(d.height!==S){let O=f.getImageData(0,0,d.width,d.height);d.height=S,f.putImageData(O,0,0)}if(WL(f,n,a,o),u){let O=new HL.default(a,l,c,h,n,o),B=f.getImageData(0,0,O.size,O.size);for(let I of t)V3(O.draw(I),B),f.putImageData(B,p[I].x-l,p[I].y+l)}else for(let O of t)f.fillText(O,p[O].x,p[O].y+a*F3);return{xOffset:x,yOffset:C,mapping:p,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}};var XL=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var YL=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var k3={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},Yu=class extends zt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:XL,fs:YL,modules:[hi,Mn]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;if(t.extensionsChanged){var i;let{gl:n}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(n),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:zr[n],sizeScale:i,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Yu,"defaultProps",k3);y(Yu,"layerName","TextBackgroundLayer");var KL={start:1,middle:0,end:-1},ZL={top:1,center:0,bottom:-1},bx=[0,0,0,255],U3=1,z3={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:bx},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:Wh.characterSet},fontFamily:Wh.fontFamily,fontWeight:Wh.fontWeight,lineHeight:U3,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:bx},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:bx},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},ki=class extends Wr{constructor(...e){super(...e),y(this,"state",void 0),y(this,"getBoundingRect",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{size:[f,p]}=mx(d,u,a,l,n),S=KL[typeof c=="function"?c(t,i):c],x=ZL[typeof h=="function"?h(t,i):h];return[(S-1)*f/2,(x-1)*p/2,f,p]}),y(this,"getIconOffsets",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{x:f,y:p,rowWidth:S,size:[x,C]}=mx(d,u,a,l,n),O=KL[typeof c=="function"?c(t,i):c],B=ZL[typeof h=="function"?h(t,i):h],I=f.length,_=new Array(I*2),X=0;for(let K=0;K<I;K++){let se=(1-O)*(x-S[K])/2;_[X++]=(O-1)*x/2+se+f[K],_[X++]=(B-1)*C/2+p[K]}return _})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new Jg}}updateState(e){let{props:t,oldProps:i,changeFlags:n}=e;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:o}=this.state,a={...e,characterSet:o,fontFamily:t,fontWeight:i};if(!n.mapping)return n.setProps(a),!0;for(let l in a)if(a[l]!==n.props[l])return n.setProps(a),!0;return!1}_updateText(){var e;let{data:t,characterSet:i}=this.props,n=(e=t.attributes)===null||e===void 0?void 0:e.getText,{getText:o}=this.props,a=t.startIndices,l,u=i==="auto"&&new Set;if(n&&a){let{texts:c,characterCount:h}=kL({...ArrayBuffer.isView(n)?{value:n}:n,length:t.length,startIndices:a,characterSet:u});l=h,o=(d,{index:f})=>c[f]}else{let{iterable:c,objectInfo:h}=mo(t);a=[0],l=0;for(let d of c){h.index++;let f=Array.from(o(d,h)||"");u&&f.forEach(u.add,u),l+=f.length,a.push(l)}}this.setState({getText:o,startIndices:a,numInstances:l,characterSet:u||i})}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,getBackgroundColor:x,getBorderColor:C,getBorderWidth:O,backgroundPadding:B,background:I,billboard:_,fontSettings:X,outlineWidth:K,outlineColor:se,sizeScale:ge,sizeUnits:ue,sizeMinPixels:F,sizeMaxPixels:M,transitions:W,updateTriggers:j}=this.props,te=this.getSubLayerClass("characters",Xu),oe=this.getSubLayerClass("background",Yu);return[I&&new oe({getFillColor:x,getLineColor:C,getLineWidth:O,padding:B,getPosition:h,getSize:f,getAngle:p,getPixelOffset:S,billboard:_,sizeScale:ge/this.state.fontAtlasManager.props.fontSize,sizeUnits:ue,sizeMinPixels:F,sizeMaxPixels:M,transitions:W&&{getPosition:W.getPosition,getAngle:W.getAngle,getSize:W.getSize,getFillColor:W.getBackgroundColor,getLineColor:W.getBorderColor,getLineWidth:W.getBorderWidth,getPixelOffset:W.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:j.getPosition,getAngle:j.getAngle,getSize:j.getSize,getFillColor:j.getBackgroundColor,getLineColor:j.getBorderColor,getLineWidth:j.getBorderWidth,getPixelOffset:j.getPixelOffset,getBoundingRect:{getText:j.getText,getTextAnchor:j.getTextAnchor,getAlignmentBaseline:j.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new te({sdf:X.sdf,smoothing:Number.isFinite(X.smoothing)?X.smoothing:Wh.smoothing,outlineWidth:K,outlineColor:se,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,billboard:_,sizeScale:ge*n,sizeUnits:ue,sizeMinPixels:F*n,sizeMaxPixels:M*n,transitions:W&&{getPosition:W.getPosition,getAngle:W.getAngle,getColor:W.getColor,getSize:W.getSize,getPixelOffset:W.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:j.getText,getPosition:j.getPosition,getAngle:j.getAngle,getColor:j.getColor,getSize:j.getSize,getPixelOffset:j.getPixelOffset,getIconOffsets:{getText:j.getText,getTextAnchor:j.getTextAnchor,getAlignmentBaseline:j.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){qL(e)}};y(ki,"defaultProps",z3);y(ki,"layerName","TextLayer");var $g={circle:{type:Wu,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Dn,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:ki,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},ep={type:Hu,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},KP={type:qu,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function Hh({type:s,props:e}){let t={};for(let i in e)t[i]=s.defaultProps[e[i]];return t}function ZP(s,e){let{transitions:t,updateTriggers:i}=s.props,n={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(let o in e){let a=e[o],l=s.props[o];o.startsWith("get")&&(l=s.getSubLayerAccessor(l),n.updateTriggers[a]=i[o],t&&(n.transitions[a]=t[o])),n[a]=l}return n}function JL(s){if(Array.isArray(s))return s;switch(de.assert(s.type,"GeoJSON does not have type"),s.type){case"Feature":return[s];case"FeatureCollection":return de.assert(Array.isArray(s.features),"GeoJSON does not have features array"),s.features;default:return[{geometry:s}]}}function Px(s,e,t={}){let i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:n=0,endRow:o=s.length}=t;for(let a=n;a<o;a++){let l=s[a],{geometry:u}=l;if(!!u)if(u.type==="GeometryCollection"){de.assert(Array.isArray(u.geometries),"GeoJSON does not have geometries array");let{geometries:c}=u;for(let h=0;h<c.length;h++){let d=c[h];QL(d,i,e,l,a)}}else QL(u,i,e,l,a)}return i}function QL(s,e,t,i,n){let{type:o,coordinates:a}=s,{pointFeatures:l,lineFeatures:u,polygonFeatures:c,polygonOutlineFeatures:h}=e;if(!H3(o,a)){de.warn("".concat(o," coordinates are malformed"))();return}switch(o){case"Point":l.push(t({geometry:s},i,n));break;case"MultiPoint":a.forEach(d=>{l.push(t({geometry:{type:"Point",coordinates:d}},i,n))});break;case"LineString":u.push(t({geometry:s},i,n));break;case"MultiLineString":a.forEach(d=>{u.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"Polygon":c.push(t({geometry:s},i,n)),a.forEach(d=>{h.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"MultiPolygon":a.forEach(d=>{c.push(t({geometry:{type:"Polygon",coordinates:d}},i,n)),d.forEach(f=>{h.push(t({geometry:{type:"LineString",coordinates:f}},i,n))})});break;default:}}var W3={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function H3(s,e){let t=W3[s];for(de.assert(t,"Unknown GeoJSON type ".concat(s));e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function $L(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function QP(s){return s.geometry.coordinates}function eR(s,e){let t=$L(),{pointFeatures:i,lineFeatures:n,polygonFeatures:o,polygonOutlineFeatures:a}=s;return t.points.data=i,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=QP,t.lines.data=n,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=QP,t.polygons.data=o,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=QP,t.polygonsOutline.data=a,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=QP,t}function tR(s,e){let t=$L(),{points:i,lines:n,polygons:o}=s,a=RL(s,e);return t.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:3,value:a.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},t.lines.data={length:n.pathIndices.value.length-1,startIndices:n.pathIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:3,value:a.lines}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},t.lines._pathType="open",t.polygons.data={length:o.polygonIndices.value.length-1,startIndices:o.polygonIndices.value,attributes:{...o.attributes,getPolygon:o.positions,pickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygons._normalize=!1,o.triangles&&(t.polygons.data.attributes.indices=o.triangles.value),t.polygonsOutline.data={length:o.primitivePolygonIndices.value.length-1,startIndices:o.primitivePolygonIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygonsOutline._pathType="open",t}var j3=["points","linestrings","polygons"],q3={...Hh($g.circle),...Hh($g.icon),...Hh($g.text),...Hh(ep),...Hh(KP),stroked:!0,filled:!0,extruded:!1,wireframe:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:s=>s.properties.icon},getText:{type:"accessor",value:s=>s.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}},hl=class extends Wr{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;let{data:i}=this.props,n=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:n}),n?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){let i=tR(e.data,this.encodePickingColor);this.setState({layerProps:i})}_updateStateJSON({props:e,changeFlags:t}){let i=JL(e.data),n=this.getSubLayerRow.bind(this),o={},a={};if(Array.isArray(t.dataChanged)){let u=this.state.features;for(let c in u)o[c]=u[c].slice(),a[c]=[];for(let c of t.dataChanged){let h=Px(i,n,c);for(let d in u)a[d].push(wL({data:o[d],getIndex:f=>f.__source.index,dataRange:c,replace:h[d]}))}}else o=Px(i,n);let l=eR(o,a);this.setState({features:o,featuresDiff:a,layerProps:l})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i,sourceLayer:n}=t;return t.featureType=j3.find(o=>n.id.startsWith("".concat(this.id,"-").concat(o,"-"))),i>=0&&n.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[i]),t}_updateAutoHighlight(e){let t="".concat(this.id,"-points-"),i=e.featureType==="points";for(let n of this.getSubLayers())n.id.startsWith(t)===i&&n.updateAutoHighlight(e)}_renderPolygonLayer(){let{extruded:e,wireframe:t}=this.props,{layerProps:i}=this.state,n="polygons-fill",o=this.shouldRenderSubLayer(n,i.polygons.data)&&this.getSubLayerClass(n,KP.type);if(o){let a=ZP(this,KP.props),l=e&&t;return l||delete a.getLineColor,a.updateTriggers.lineColors=l,new o(a,this.getSubLayerProps({id:n,updateTriggers:a.updateTriggers}),i.polygons)}return null}_renderLineLayers(){let{extruded:e,stroked:t}=this.props,{layerProps:i}=this.state,n="polygons-stroke",o="linestrings",a=!e&&t&&this.shouldRenderSubLayer(n,i.polygonsOutline.data)&&this.getSubLayerClass(n,ep.type),l=this.shouldRenderSubLayer(o,i.lines.data)&&this.getSubLayerClass(o,ep.type);if(a||l){let u=ZP(this,ep.props);return[a&&new a(u,this.getSubLayerProps({id:n,updateTriggers:u.updateTriggers}),i.polygonsOutline),l&&new l(u,this.getSubLayerProps({id:o,updateTriggers:u.updateTriggers}),i.lines)]}return null}_renderPointLayers(){let{pointType:e}=this.props,{layerProps:t,binary:i}=this.state,{highlightedObjectIndex:n}=this.props;!i&&Number.isFinite(n)&&(n=t.points.data.findIndex(l=>l.__source.index===n));let o=new Set(e.split("+")),a=[];for(let l of o){let u="points-".concat(l),c=$g[l],h=c&&this.shouldRenderSubLayer(u,t.points.data)&&this.getSubLayerClass(u,c.type);if(h){let d=ZP(this,c.props),f=t.points;if(l==="text"&&i){let{instancePickingColors:p,...S}=f.data.attributes;f={...f,data:{...f.data,attributes:S}}}a.push(new h(d,this.getSubLayerProps({id:u,updateTriggers:d.updateTriggers,highlightedObjectIndex:n}),f))}}return a}renderLayers(){let{extruded:e}=this.props,t=this._renderPolygonLayer(),i=this._renderLineLayers(),n=this._renderPointLayers();return[!e&&t,i,n,e&&t]}getSubLayerAccessor(e){let{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(i,n)=>{let{data:o,index:a}=n,l=LL(o,a);return e(l,n)}}};y(hl,"layerName","GeoJsonLayer");y(hl,"defaultProps",q3);var tp=class{constructor(e){y(this,"index",void 0),y(this,"isVisible",void 0),y(this,"isSelected",void 0),y(this,"parent",void 0),y(this,"children",void 0),y(this,"content",void 0),y(this,"state",void 0),y(this,"layers",void 0),y(this,"id",void 0),y(this,"bbox",void 0),y(this,"zoom",void 0),y(this,"userData",void 0),y(this,"_abortController",void 0),y(this,"_loader",void 0),y(this,"_loaderId",void 0),y(this,"_isLoaded",void 0),y(this,"_isCancelled",void 0),y(this,"_needsReload",void 0),this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return Boolean(this._loader)&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){let e=this.content?this.content.byteLength:0;return Number.isFinite(e)||de.error("byteLength not defined in tile data")(),e}async _loadData({getData:e,requestScheduler:t,onLoad:i,onError:n}){let{index:o,id:a,bbox:l,userData:u,zoom:c}=this,h=this._loaderId;this._abortController=new AbortController;let{signal:d}=this._abortController,f=await t.scheduleRequest(this,x=>x.isSelected?1:-1);if(!f){this._isCancelled=!0;return}if(this._isCancelled){f.done();return}let p=null,S;try{p=await e({index:o,id:a,bbox:l,userData:u,zoom:c,signal:d})}catch(x){S=x||!0}finally{f.done()}if(h===this._loaderId){if(this._loader=void 0,this.content=p,this._isCancelled&&!p){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,S?n(S,this):i(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){var e;this.isLoaded||(this._isCancelled=!0,(e=this._abortController)===null||e===void 0||e.abort())}};var Zt={OUTSIDE:-1,INTERSECTING:0,INSIDE:1};var rR=new re,X3=new re,qs=class{constructor(e=[0,0,0],t=[0,0,0],i){y(this,"center",void 0),y(this,"halfDiagonal",void 0),y(this,"minimum",void 0),y(this,"maximum",void 0),i=i||rR.copy(e).add(t).scale(.5),this.center=new re(i),this.halfDiagonal=new re(t).subtract(this.center),this.minimum=new re(e),this.maximum=new re(t)}clone(){return new qs(this.minimum,this.maximum,this.center)}equals(e){return this===e||Boolean(e)&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){let{halfDiagonal:t}=this,i=X3.from(e.normal),n=t.x*Math.abs(i.x)+t.y*Math.abs(i.y)+t.z*Math.abs(i.z),o=this.center.dot(i)+e.distance;return o-n>0?Zt.INSIDE:o+n<0?Zt.OUTSIDE:Zt.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=rR.from(e).subtract(this.center),{halfDiagonal:i}=this,n=0,o;return o=Math.abs(t.x)-i.x,o>0&&(n+=o*o),o=Math.abs(t.y)-i.y,o>0&&(n+=o*o),o=Math.abs(t.z)-i.z,o>0&&(n+=o*o),n}};var rp=new re,iR=new re,Xs=class{constructor(e=[0,0,0],t=0){y(this,"center",void 0),y(this,"radius",void 0),this.radius=-0,this.center=new re,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=rp.from(t),this.center=new re().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new Xs(this.center,this.radius)}union(e){let t=this.center,i=this.radius,n=e.center,o=e.radius,a=rp.copy(n).subtract(t),l=a.magnitude();if(i>=l+o)return this.clone();if(o>=l+i)return e.clone();let u=(i+l+o)*.5;return iR.copy(a).scale((-i+u)/l).add(t),this.center.copy(iR),this.radius=u,this}expand(e){let i=rp.from(e).subtract(this.center).magnitude();return i>this.radius&&(this.radius=i),this}transform(e){this.center.transform(e);let t=GT(rp,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){let t=this.distanceTo(e);return t*t}distanceTo(e){let i=rp.from(e).subtract(this.center);return Math.max(0,i.len()-this.radius)}intersectPlane(e){let t=this.center,i=this.radius,o=e.normal.dot(t)+e.distance;return o<-i?Zt.OUTSIDE:o<i?Zt.INTERSECTING:Zt.INSIDE}};var Y3=new re,K3=new re,JP=new re,$P=new re,ey=new re,Z3=new re,Q3=new re,Ys={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8},dl=class{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){y(this,"center",void 0),y(this,"halfAxes",void 0),this.center=new re().from(e),this.halfAxes=new Ct(t)}get halfSize(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new re(e).len(),new re(t).len(),new re(i).len()]}get quaternion(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),n=new re(e).normalize(),o=new re(t).normalize(),a=new re(i).normalize();return new wu().fromMatrix3(new Ct([...n,...o,...a]))}fromCenterHalfSizeQuaternion(e,t,i){let n=new wu(i),o=new Ct().fromQuaternion(n);return o[0]=o[0]*t[0],o[1]=o[1]*t[0],o[2]=o[2]*t[0],o[3]=o[3]*t[1],o[4]=o[4]*t[1],o[5]=o[5]*t[1],o[6]=o[6]*t[2],o[7]=o[7]*t[2],o[8]=o[8]*t[2],this.center=new re().from(e),this.halfAxes=o,this}clone(){return new dl(this.center,this.halfAxes)}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new Xs){let t=this.halfAxes,i=t.getColumn(0,JP),n=t.getColumn(1,$P),o=t.getColumn(2,ey),a=Y3.copy(i).add(n).add(o);return e.center.copy(this.center),e.radius=a.magnitude(),e}intersectPlane(e){let t=this.center,i=e.normal,n=this.halfAxes,o=i.x,a=i.y,l=i.z,u=Math.abs(o*n[Ys.COLUMN0ROW0]+a*n[Ys.COLUMN0ROW1]+l*n[Ys.COLUMN0ROW2])+Math.abs(o*n[Ys.COLUMN1ROW0]+a*n[Ys.COLUMN1ROW1]+l*n[Ys.COLUMN1ROW2])+Math.abs(o*n[Ys.COLUMN2ROW0]+a*n[Ys.COLUMN2ROW1]+l*n[Ys.COLUMN2ROW2]),c=i.dot(t)+e.distance;return c<=-u?Zt.OUTSIDE:c>=u?Zt.INSIDE:Zt.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=K3.from(e).subtract(this.center),i=this.halfAxes,n=i.getColumn(0,JP),o=i.getColumn(1,$P),a=i.getColumn(2,ey),l=n.magnitude(),u=o.magnitude(),c=a.magnitude();n.normalize(),o.normalize(),a.normalize();let h=0,d;return d=Math.abs(t.dot(n))-l,d>0&&(h+=d*d),d=Math.abs(t.dot(o))-u,d>0&&(h+=d*d),d=Math.abs(t.dot(a))-c,d>0&&(h+=d*d),h}computePlaneDistances(e,t,i=[-0,-0]){let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=this.center,l=this.halfAxes,u=l.getColumn(0,JP),c=l.getColumn(1,$P),h=l.getColumn(2,ey),d=Z3.copy(u).add(c).add(h).add(a),f=Q3.copy(d).subtract(e),p=t.dot(f);return n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),i[0]=n,i[1]=o,i}transform(e){this.center.transformAsPoint(e);let t=this.halfAxes.getColumn(0,JP);t.transformAsPoint(e);let i=this.halfAxes.getColumn(1,$P);i.transformAsPoint(e);let n=this.halfAxes.getColumn(2,ey);return n.transformAsPoint(e),this.halfAxes=new Ct([...t,...i,...n]),this}getTransform(){throw new Error("not implemented")}};var nR=new re,oR=new re,ln=class{constructor(e=[0,0,1],t=0){y(this,"normal",void 0),y(this,"distance",void 0),this.normal=new re,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return ro(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=nR.from(e),this.normal.from(t).normalize();let i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,n){return this.normal.set(e,t,i),ro(kr(this.normal.len(),1)),this.distance=n,this}clone(){return new ln(this.normal,this.distance)}equals(e){return kr(this.distance,e.distance)&&kr(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){let t=oR.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){e=nR.from(e);let i=this.getPointDistance(e),n=oR.copy(this.normal).scale(i);return e.subtract(n).to(t)}};var sR=[new re([1,0,0]),new re([0,1,0]),new re([0,0,1])],aR=new re,J3=new re,yDe=new ln(new re(1,0,0),0),Ci=class{constructor(e=[]){y(this,"planes",void 0),this.planes=e}fromBoundingSphere(e){this.planes.length=2*sR.length;let t=e.center,i=e.radius,n=0;for(let o of sR){let a=this.planes[n],l=this.planes[n+1];a||(a=this.planes[n]=new ln),l||(l=this.planes[n+1]=new ln);let u=aR.copy(o).scale(-i).add(t),c=-o.dot(u);a.fromPointNormal(u,o);let h=aR.copy(o).scale(i).add(t),d=J3.copy(o).negate(),f=-d.dot(h);l.fromPointNormal(h,d),n+=2}return this}computeVisibility(e){let t=Zt.INSIDE;for(let i of this.planes)switch(e.intersectPlane(i)){case Zt.OUTSIDE:return Zt.OUTSIDE;case Zt.INTERSECTING:t=Zt.INTERSECTING;break;default:}return t}computeVisibilityWithPlaneMask(e,t){if(ro(Number.isFinite(t),"parentPlaneMask is required."),t===Ci.MASK_OUTSIDE||t===Ci.MASK_INSIDE)return t;let i=Ci.MASK_INSIDE,n=this.planes;for(let o=0;o<this.planes.length;++o){let a=o<31?1<<o:0;if(o<31&&(t&a)===0)continue;let l=n[o],u=e.intersectPlane(l);if(u===Zt.OUTSIDE)return Ci.MASK_OUTSIDE;u===Zt.INTERSECTING&&(i|=a)}return i}};y(Ci,"MASK_OUTSIDE",4294967295);y(Ci,"MASK_INSIDE",0);y(Ci,"MASK_INDETERMINATE",2147483647);var ADe=new re,TDe=new re,IDe=new re,wDe=new re,LDe=new re;var DDe=new re,FDe=new re,GDe=new re,VDe=new re,kDe=new re,UDe=new re,zDe=new re,WDe=new re,HDe=new re,jDe=new re,qDe=new re,XDe=new re,YDe=4/3*Math.PI;var is=new Ct,e5=new Ct,t5=new Ct,ty=new Ct,lR=new Ct;function ry(s,e={}){let t=gP.EPSILON20,i=10,n=0,o=0,a=e5,l=t5;a.identity(),l.copy(s);let u=t*r5(l);for(;o<i&&i5(l)>u;)n5(l,ty),lR.copy(ty).transpose(),l.multiplyRight(ty),l.multiplyLeft(lR),a.multiplyRight(ty),++n>2&&(++o,n=0);return e.unitary=a.toTarget(e.unitary),e.diagonal=l.toTarget(e.diagonal),e}function r5(s){let e=0;for(let t=0;t<9;++t){let i=s[t];e+=i*i}return Math.sqrt(e)}var yx=[1,0,0],Sx=[2,2,1];function i5(s){let e=0;for(let t=0;t<3;++t){let i=s[is.getElementIndex(Sx[t],yx[t])];e+=2*i*i}return Math.sqrt(e)}function n5(s,e){let t=gP.EPSILON15,i=0,n=1;for(let c=0;c<3;++c){let h=Math.abs(s[is.getElementIndex(Sx[c],yx[c])]);h>i&&(n=c,i=h)}let o=yx[n],a=Sx[n],l=1,u=0;if(Math.abs(s[is.getElementIndex(a,o)])>t){let c=s[is.getElementIndex(a,a)],h=s[is.getElementIndex(o,o)],d=s[is.getElementIndex(a,o)],f=(c-h)/2/d,p;f<0?p=-1/(-f+Math.sqrt(1+f*f)):p=1/(f+Math.sqrt(1+f*f)),l=1/Math.sqrt(1+p*p),u=p*l}return Ct.IDENTITY.to(e),e[is.getElementIndex(o,o)]=e[is.getElementIndex(a,a)]=l,e[is.getElementIndex(a,o)]=u,e[is.getElementIndex(o,a)]=-u,e}var fl=new re,o5=new re,s5=new re,a5=new re,l5=new re,u5=new Ct,c5={diagonal:new Ct,unitary:new Ct};function Ex(s,e=new dl){if(!s||s.length===0)return e.halfAxes=new Ct([0,0,0,0,0,0,0,0,0]),e.center=new re,e;let t=s.length,i=new re(0,0,0);for(let ue of s)i.add(ue);let n=1/t;i.multiplyByScalar(n);let o=0,a=0,l=0,u=0,c=0,h=0;for(let ue of s){let F=fl.copy(ue).subtract(i);o+=F.x*F.x,a+=F.x*F.y,l+=F.x*F.z,u+=F.y*F.y,c+=F.y*F.z,h+=F.z*F.z}o*=n,a*=n,l*=n,u*=n,c*=n,h*=n;let d=u5;d[0]=o,d[1]=a,d[2]=l,d[3]=a,d[4]=u,d[5]=c,d[6]=l,d[7]=c,d[8]=h;let{unitary:f}=ry(d,c5),p=e.halfAxes.copy(f),S=p.getColumn(0,s5),x=p.getColumn(1,a5),C=p.getColumn(2,l5),O=-Number.MAX_VALUE,B=-Number.MAX_VALUE,I=-Number.MAX_VALUE,_=Number.MAX_VALUE,X=Number.MAX_VALUE,K=Number.MAX_VALUE;for(let ue of s)fl.copy(ue),O=Math.max(fl.dot(S),O),B=Math.max(fl.dot(x),B),I=Math.max(fl.dot(C),I),_=Math.min(fl.dot(S),_),X=Math.min(fl.dot(x),X),K=Math.min(fl.dot(C),K);S=S.multiplyByScalar(.5*(_+O)),x=x.multiplyByScalar(.5*(X+B)),C=C.multiplyByScalar(.5*(K+I)),e.center.copy(S).add(x).add(C);let se=o5.set(O-_,B-X,I-K).multiplyByScalar(.5),ge=new Ct([se[0],0,0,0,se[1],0,0,0,se[2]]);return e.halfAxes.multiplyRight(ge),e}var jh=512,uR=3,cR=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],hR=cR.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),h5=hR.concat([[.25,.5],[.75,.5]]),gl=class{constructor(e,t,i){y(this,"x",void 0),y(this,"y",void 0),y(this,"z",void 0),y(this,"childVisible",void 0),y(this,"selected",void 0),y(this,"_children",void 0),this.x=e,this.y=t,this.z=i}get children(){if(!this._children){let e=this.x*2,t=this.y*2,i=this.z+1;this._children=[new gl(e,t,i),new gl(e,t+1,i),new gl(e+1,t,i),new gl(e+1,t+1,i)]}return this._children}update(e){let{viewport:t,cullingVolume:i,elevationBounds:n,minZ:o,maxZ:a,bounds:l,offset:u,project:c}=e,h=this.getBoundingVolume(n,u,c);if(l&&!this.insideBounds(l)||i.computeVisibility(h)<0)return!1;if(!this.childVisible){let{z:f}=this;if(f<a&&f>=o){let p=h.distanceTo(t.cameraPosition)*t.scale/t.height;f+=Math.floor(Math.log2(p))}if(f>=a)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(let f of this.children)f.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(let t of this._children)t.getSelected(e);return e}insideBounds([e,t,i,n]){let o=Math.pow(2,this.z),a=jh/o;return this.x*a<i&&this.y*a<n&&(this.x+1)*a>e&&(this.y+1)*a>t}getBoundingVolume(e,t,i){if(i){let u=this.z<1?h5:this.z<2?hR:cR,c=[];for(let h of u){let d=iy(this.x+h[0],this.y+h[1],this.z);d[2]=e[0],c.push(i(d)),e[0]!==e[1]&&(d[2]=e[1],c.push(i(d)))}return Ex(c)}let n=Math.pow(2,this.z),o=jh/n,a=this.x*o+t*jh,l=jh-(this.y+1)*o;return new qs([a,l,e[0]],[a+o,l+o,e[1]])}};function dR(s,e,t,i){let n=s instanceof Gh&&s.resolution?s.projectPosition:null,o=Object.values(s.getFrustumPlanes()).map(({normal:p,distance:S})=>new ln(p.clone().negate(),S)),a=new Ci(o),l=s.distanceScales.unitsPerMeter[2],u=t&&t[0]*l||0,c=t&&t[1]*l||0,h=s instanceof Ir&&s.pitch<=60?e:0;if(i){let[p,S,x,C]=i,O=Nn([p,C]),B=Nn([x,S]);i=[O[0],jh-O[1],B[0],jh-B[1]]}let d=new gl(0,0,0),f={viewport:s,project:n,cullingVolume:a,elevationBounds:[u,c],minZ:h,maxZ:e,bounds:i,offset:0};if(d.update(f),s instanceof Ir&&s.subViewports&&s.subViewports.length>1){for(f.offset=-1;d.update(f)&&!(--f.offset<-uR););for(f.offset=1;d.update(f)&&!(++f.offset>uR););}return d.getSelected()}var Ks=512,d5=[-1/0,-1/0,1/0,1/0],gR={type:"url",value:null,validate:(s,e)=>e.optional&&s===null||typeof s=="string"||Array.isArray(s)&&s.every(t=>typeof t=="string"),equals:(s,e)=>{if(s===e)return!0;if(!Array.isArray(s)||!Array.isArray(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}};function pR(s,e){let t=[e.transformAsPoint([s[0],s[1]]),e.transformAsPoint([s[2],s[1]]),e.transformAsPoint([s[0],s[3]]),e.transformAsPoint([s[2],s[3]])];return[Math.min(...t.map(n=>n[0])),Math.min(...t.map(n=>n[1])),Math.max(...t.map(n=>n[0])),Math.max(...t.map(n=>n[1]))]}function f5(s){return Math.abs(s.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function mR(s,e){if(!s||!s.length)return null;let{index:t,id:i}=e;if(Array.isArray(s)){let o=f5(i)%s.length;s=s[o]}let n=s;for(let o of Object.keys(t)){let a=new RegExp("{".concat(o,"}"),"g");n=n.replace(a,String(t[o]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(n=n.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),n}function g5(s,e,t){let i;if(e&&e.length===2){let[n,o]=e,a=s.getBounds({z:n}),l=s.getBounds({z:o});i=[Math.min(a[0],l[0]),Math.min(a[1],l[1]),Math.max(a[2],l[2]),Math.max(a[3],l[3])]}else i=s.getBounds();return s.isGeospatial?[Math.max(i[0],t[0]),Math.max(i[1],t[1]),Math.min(i[2],t[2]),Math.min(i[3],t[3])]:[Math.max(Math.min(i[0],t[2]),t[0]),Math.max(Math.min(i[1],t[3]),t[1]),Math.min(Math.max(i[2],t[0]),t[2]),Math.min(Math.max(i[3],t[1]),t[3])]}function ip({viewport:s,z:e,cullRect:t}){let i=t.x-s.x,n=t.y-s.y,{width:o,height:a}=t;if(!Array.isArray(e)){let c={targetZ:e||0},h=s.unproject([i,n],c),d=s.unproject([i+o,n],c),f=s.unproject([i,n+a],c),p=s.unproject([i+o,n+a],c);return[Math.min(h[0],d[0],f[0],p[0]),Math.min(h[1],d[1],f[1],p[1]),Math.max(h[0],d[0],f[0],p[0]),Math.max(h[1],d[1],f[1],p[1])]}let l=ip({viewport:s,z:e[0],cullRect:t}),u=ip({viewport:s,z:e[1],cullRect:t});return[Math.min(l[0],u[0]),Math.min(l[1],u[1]),Math.max(l[2],u[2]),Math.max(l[3],u[3])]}function p5(s,e,t){return t?pR(s,t).map(n=>n*e/Ks):s.map(i=>i*e/Ks)}function xx(s,e){return Math.pow(2,s)*Ks/e}function iy(s,e,t){let i=xx(t,Ks),n=s/i*360-180,o=Math.PI-2*Math.PI*e/i,a=180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)));return[n,a]}function fR(s,e,t,i){let n=xx(t,i);return[s/n*Ks,e/n*Ks]}function bR(s,e,t,i,n=Ks){if(s.isGeospatial){let[c,h]=iy(e,t,i),[d,f]=iy(e+1,t+1,i);return{west:c,north:h,east:d,south:f}}let[o,a]=fR(e,t,i,n),[l,u]=fR(e+1,t+1,i,n);return{left:o,top:a,right:l,bottom:u}}function m5(s,e,t,i,n){let o=g5(s,null,i),a=xx(e,t),[l,u,c,h]=p5(o,a,n),d=[];for(let f=Math.floor(l);f<c;f++)for(let p=Math.floor(u);p<h;p++)d.push({x:f,y:p,z:e});return d}function PR({viewport:s,maxZoom:e,minZoom:t,zRange:i,extent:n,tileSize:o=Ks,modelMatrix:a,modelMatrixInverse:l,zoomOffset:u=0}){let c=s.isGeospatial?Math.round(s.zoom+Math.log2(Ks/o))+u:Math.ceil(s.zoom)+u;if(typeof t=="number"&&Number.isFinite(t)&&c<t){if(!n)return[];c=t}typeof e=="number"&&Number.isFinite(e)&&c>e&&(c=e);let h=n;return a&&l&&n&&!s.isGeospatial&&(h=pR(n,a)),s.isGeospatial?dR(s,c,i,n):m5(s,c,o,h||d5,l)}var yR=1,ny=2,b5="never",P5="no-overlap",oy="best-available",y5=5,S5={[oy]:E5,[P5]:x5,[b5]:()=>{}},np=class{constructor(e){y(this,"opts",void 0),y(this,"_requestScheduler",void 0),y(this,"_cache",void 0),y(this,"_dirty",void 0),y(this,"_tiles",void 0),y(this,"_cacheByteSize",void 0),y(this,"_viewport",void 0),y(this,"_zRange",void 0),y(this,"_selectedTiles",void 0),y(this,"_frameNumber",void 0),y(this,"_modelMatrix",void 0),y(this,"_modelMatrixInverse",void 0),y(this,"_maxZoom",void 0),y(this,"_minZoom",void 0),y(this,"onTileLoad",void 0),y(this,"_getCullBounds",ao(ip)),this.opts=e,this.onTileLoad=t=>{this.opts.onTileLoad(t),this.opts.maxCacheByteSize&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new eh({maxRequests:e.maxRequests,throttleRequests:e.maxRequests>0}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new it,this._modelMatrixInverse=new it,this.setOptions(e)}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(let e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(let e of this._cache.keys()){let t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:i}={}){let n=new it(i),o=!n.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!kr(this._zRange,t)||o){o&&(this._modelMatrixInverse=n.clone().invert(),this._modelMatrix=n),this._viewport=e,this._zRange=t;let l=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=l.map(u=>this._getTile(u,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(l=>this._getTile(l.index,!0)));let a=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),a&&this._frameNumber++,this._frameNumber}isTileVisible(e,t){if(!e.isVisible)return!1;if(t&&this._viewport){let[i,n,o,a]=ip({viewport:this._viewport,z:this._zRange,cullRect:t}),{bbox:l}=e;if("west"in l)return l.west<o&&l.east>i&&l.south<a&&l.north>n;let u=Math.min(l.top,l.bottom),c=Math.max(l.top,l.bottom);return l.left<o&&l.right>i&&u<a&&c>n}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:i,zRange:n,modelMatrix:o,modelMatrixInverse:a}){let{tileSize:l,extent:u,zoomOffset:c}=this.opts;return PR({viewport:e,maxZoom:t,minZoom:i,zRange:n,tileSize:l,extent:u,modelMatrix:o,modelMatrixInverse:a,zoomOffset:c})}getTileId(e){return"".concat(e.x,"-").concat(e.y,"-").concat(e.z)}getTileZoom(e){return e.z}getTileMetadata(e){let{tileSize:t}=this.opts;return{bbox:bR(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){let t=Math.floor(e.x/2),i=Math.floor(e.y/2),n=e.z-1;return{x:t,y:i,z:n}}updateTileStates(){let e=this.opts.refinementStrategy||oy,t=new Array(this._cache.size),i=0;for(let n of this._cache.values())t[i++]=n.isVisible,n.isSelected=!1,n.isVisible=!1;for(let n of this._selectedTiles)n.isSelected=!0,n.isVisible=!0;(typeof e=="function"?e:S5[e])(Array.from(this._cache.values())),i=0;for(let n of this._cache.values())if(t[i++]!==n.isVisible)return!0;return!1}_pruneRequests(){let{maxRequests:e}=this.opts,t=[],i=0;for(let n of this._cache.values())n.isLoading&&(i++,!n.isSelected&&!n.isVisible&&t.push(n));for(;e>0&&i>e&&t.length>0;)t.shift().abort(),i--}_rebuildTree(){let{_cache:e}=this;for(let t of e.values())t.parent=null,t.children&&(t.children.length=0);for(let t of e.values()){let i=this._getNearestAncestor(t);t.parent=i,i!=null&&i.children&&i.children.push(t)}}_resizeCache(){let{_cache:e,opts:t}=this,i=t.maxCacheSize||(t.maxCacheByteSize?1/0:y5*this.selectedTiles.length),n=t.maxCacheByteSize||1/0;if(e.size>i||this._cacheByteSize>n){for(let[a,l]of e)if(!l.isVisible&&!l.isSelected&&(this._cacheByteSize-=t.maxCacheByteSize?l.byteLength:0,e.delete(a),this.opts.onTileUnload(l)),e.size<=i&&this._cacheByteSize<=n)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((a,l)=>a.zoom-l.zoom),this._dirty=!1)}_getTile(e,t){let i=this.getTileId(e),n=this._cache.get(i),o=!1;return!n&&t?(n=new tp(e),Object.assign(n,this.getTileMetadata(n.index)),Object.assign(n,{id:i,zoom:this.getTileZoom(n.index)}),o=!0,this._cache.set(i,n),this._dirty=!0):n&&n.needsReload&&(o=!0),n&&o&&n.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),n}_getNearestAncestor(e){let{_minZoom:t=0}=this,i=e.index;for(;this.getTileZoom(i)>t;){i=this.getParentIndex(i);let n=this._getTile(i);if(n)return n}return null}};function E5(s){for(let e of s)e.state=0;for(let e of s)e.isSelected&&!SR(e)&&vx(e);for(let e of s)e.isVisible=Boolean(e.state&ny)}function x5(s){for(let t of s)t.state=0;for(let t of s)t.isSelected&&SR(t);let e=Array.from(s).sort((t,i)=>t.zoom-i.zoom);for(let t of e)if(t.isVisible=Boolean(t.state&ny),t.children&&(t.isVisible||t.state&yR))for(let i of t.children)i.state=yR;else t.isSelected&&vx(t)}function SR(s){let e=s;for(;e;){if(e.isLoaded||e.content)return e.state|=ny,!0;e=e.parent}return!1}function vx(s){for(let e of s.children)e.isLoaded||e.content?e.state|=ny:vx(e)}var v5={TilesetClass:np,data:{type:"data",value:[]},dataComparator:gR.equals,renderSubLayers:{type:"function",value:s=>new hl(s),compare:!1},getTileData:{type:"function",optional:!0,value:null,compare:!1},onViewportLoad:{type:"function",optional:!0,value:null,compare:!1},onTileLoad:{type:"function",value:s=>{},compare:!1},onTileUnload:{type:"function",value:s=>{},compare:!1},onTileError:{type:"function",value:s=>console.error(s),compare:!1},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:oy,zRange:null,maxRequests:6,zoomOffset:0},pl=class extends Wr{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){var e,t;(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0||t.finalize()}get isLoaded(){var e,t;return(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0?void 0:t.selectedTiles.every(i=>i.isLoaded&&i.layers&&i.layers.every(n=>n.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state,i=e.propsOrDataChanged||e.updateTriggersChanged,n=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?i&&(t.setOptions(this._getTilesetOptions()),n?t.reloadAll():this.state.tileset.tiles.forEach(o=>{o.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){let{tileSize:e,maxCacheSize:t,maxCacheByteSize:i,refinementStrategy:n,extent:o,maxZoom:a,minZoom:l,maxRequests:u,zoomOffset:c}=this.props;return{maxCacheSize:t,maxCacheByteSize:i,maxZoom:a,minZoom:l,tileSize:e,refinementStrategy:n,extent:o,maxRequests:u,zoomOffset:c,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){let{tileset:e}=this.state,{zRange:t,modelMatrix:i}=this.props,n=e.update(this.context.viewport,{zRange:t,modelMatrix:i}),{isLoaded:o}=e,a=this.state.isLoaded!==o,l=this.state.frameNumber!==n;o&&(a||l)&&this._onViewportLoad(),l&&this.setState({frameNumber:n}),this.state.isLoaded=o}_onViewportLoad(){let{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){let{data:t,getTileData:i,fetch:n}=this.props,{signal:o}=e;return e.url=typeof t=="string"||Array.isArray(t)?mR(t,e):null,i?i(e):n&&e.url?n(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo({info:e,sourceLayer:t}){return e.picked&&(e.tile=t.props.tile),e}_updateAutoHighlight(e){e.sourceLayer&&e.sourceLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{let t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(i=>e.layers[0].props[i]!==t[i])&&(e.layers=e.layers.map(i=>i.clone(t)));else{let i=this.renderSubLayers({...this.props,id:"".concat(this.id,"-").concat(e.id),data:e.content,_offset:0,tile:e});e.layers=Us(i,Boolean).map(n=>n.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){let{tile:i}=e.props;return this.state.tileset.isTileVisible(i,t)}};y(pl,"defaultProps",v5);y(pl,"layerName","TileLayer");var ER={clipBounds:[0,0,1,1]},xR=`
uniform vec4 clip_bounds;

bool clip_isInBounds(vec2 position) {
  return position.x >= clip_bounds[0] && position.y >= clip_bounds[1] && position.x < clip_bounds[2] && position.y < clip_bounds[3];
}
`,C5={name:"clip-vs",vs:xR},A5={"vs:#decl":`
varying float clip_isVisible;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_isVisible = float(clip_isInBounds(geometry.worldPosition.xy));
`,"fs:#decl":`
varying float clip_isVisible;
`,"fs:DECKGL_FILTER_COLOR":`
  if (clip_isVisible < 0.5) discard;
`},T5={name:"clip-fs",fs:xR},I5={"vs:#decl":`
varying vec2 clip_commonPosition;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_commonPosition = geometry.position.xy;
`,"fs:#decl":`
varying vec2 clip_commonPosition;
`,"fs:DECKGL_FILTER_COLOR":`
  if (!clip_isInBounds(clip_commonPosition)) discard;
`},ml=class extends zu{getShaders(){let e="instancePositions"in this.getAttributeManager().attributes;return"clipByInstance"in this.props&&(e=this.props.clipByInstance),this.state.clipByInstance=e,e?{modules:[C5],inject:A5}:{modules:[T5],inject:I5}}draw({uniforms:e}){let{clipBounds:t=ER.clipBounds}=this.props;if(this.state.clipByInstance)e.clip_bounds=t;else{let i=this.projectPosition([t[0],t[1],0]),n=this.projectPosition([t[2],t[3],0]);e.clip_bounds=[Math.min(i[0],n[0]),Math.min(i[1],n[1]),Math.max(i[0],n[0]),Math.max(i[1],n[1])]}}};y(ml,"defaultProps",ER);y(ml,"extensionName","ClipExtension");var w5="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",Cx=4,sy;function vR(s){return sy||(sy=typeof Image!="undefined"&&Zo(w5,du,{imagebitmap:{resizeWidth:256*Cx,resizeHeight:128*Cx}}).then(e=>{let t=new Ve(s,{data:e,parameters:{[s.TEXTURE_MIN_FILTER]:s.LINEAR_MIPMAP_LINEAR,[s.TEXTURE_MAG_FILTER]:s.LINEAR,[s.TEXTURE_WRAP_S]:s.CLAMP_TO_EDGE,[s.TEXTURE_WRAP_T]:s.CLAMP_TO_EDGE}});return sy=t,t})),sy}var CR=L5({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},Cx);function L5(s,e){for(let t in s){let i=s[t];i.x*=e,i.y*=e,i.width*=e,i.height*=e,i.anchorX&&(i.anchorX*=e),i.anchorY&&(i.anchorY*=e)}return s}var Oe={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var ly=`
uniform sampler2D nodeDepth;
uniform vec2 textureDim;

vec2 getCoordinate(vec3 nodeIdx) {
  // index = r + g * 256 + b * 65536
  // textureDim.x is always power of 2 and <= 65536
  // avoid making big integers (float32 precision)
  float x = nodeIdx.r + nodeIdx.g * 256.0;
  float y = floor(x / textureDim.x);
  x -= y * textureDim.x;
  y += 65536.0 / textureDim.x * nodeIdx.b;
  return vec2(x + 0.5, y + 0.5) / textureDim;
}

bool getDepth(vec3 nodeIdx, out float depth) {
  vec2 coord = getCoordinate(nodeIdx);
  vec4 c = texture2D(nodeDepth, coord);
  depth = c.r * 255.0;
  return c.a == 0.0;
}
`,R5=new Uint8Array(4),op=class{constructor(e){this._gl=e,this._nodeDepthTextures=[AR(e),AR(e)],this._nodeDepth=this._nodeDepthTextures[0],this._nodeDepthFB=new Me(e,{id:"graph-highlighter-framebuffer",width:this._nodeDepthTextures[0].width,height:1,attachments:{[Oe.COLOR_ATTACHMENT0]:this._nodeDepthTextures[0]}}),this._model=O5(e),this._transform=_5(e)}delete(){var e,t,i,n;(e=this._edgeSourceBuffer)===null||e===void 0||e.delete(),(t=this._edgeTargetBuffer)===null||t===void 0||t.delete(),(i=this._edgeDirectionBuffer)===null||i===void 0||i.delete(),(n=this._edgeDepthBuffer)===null||n===void 0||n.delete(),this._nodeDepthTextures.forEach(o=>o.delete()),this._nodeDepthFB.delete(),this._model.delete(),this._transform.delete()}get nodeDepth(){return this._nodeDepth}get edgeDepth(){return this._edgeDepthBuffer}encodeNodeIndex(e,t){return Ax(this._nodeMap.get(e.id),t)}getNode(e){return this._nodeList[e]}setGraph(e){if(this._graph===e.graph)return;this._graph=e.graph;let t=this._graph.deepEdgesCount;this._nodeMap=new Map,this._nodeList=[],this._hasBidirectionalEdge=!1;let i=this._gl;this._edgeSourceBuffer=ay(i,this._edgeSourceBuffer,{size:3,type:Oe.UNSIGNED_BYTE},t),this._edgeTargetBuffer=ay(i,this._edgeTargetBuffer,{size:3,type:Oe.UNSIGNED_BYTE},t),this._edgeDirectionBuffer=ay(i,this._edgeDirectionBuffer,{size:1,type:Oe.UNSIGNED_BYTE},t),this._edgeDepthBuffer=ay(i,this._edgeDepthBuffer,{size:1,type:Oe.FLOAT},t);let n=0,o=0;for(let f of e.nodesBreadthFirst)this._nodeList[n]=f,this._nodeMap.set(f.id,n+1),n++;let a=new Uint8Array(t*3),l=new Uint8Array(t*3),u=new Uint8Array(t),c=[0,0,0];for(let f of e.deepEdges){let p=this._nodeMap.get(f.source.id);Ax(p,c),a.set(c,o*3);let S=this._nodeMap.get(f.target.id);Ax(S,c),l.set(c,o*3);let x=ke.getDrawingObj(f.edge);this._hasBidirectionalEdge=this._hasBidirectionalEdge||!x.directed,u[o]=x.directed?1:0,o++}this._edgeSourceBuffer.subData(a),this._edgeTargetBuffer.subData(l),this._edgeDirectionBuffer.subData(u),this._nodeCount=this._nodeMap.size;let h=this._nodeDepthTextures[0].width,d=Math.ceil((this._nodeCount+1)/h);this._nodeDepthFB.resize({width:h,height:d}),this._transform.update({elementCount:t,sourceBuffers:{source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer},feedbackBuffers:{nextDepth:this._edgeDepthBuffer}}),this._model.setAttributes({source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer}),this._model.setVertexCount(t),this.update({sourceId:null})}update(e){let{sourceId:t,edgeDepth:i=!1,maxDepth:n=1}=e,o=[this._nodeDepthFB.width,this._nodeDepthFB.height],a=this._nodeDepthTextures[1],l=this._nodeDepthTextures[0];if(t){let u=this._nodeMap.get(t);this._resetNodeDepth(a,u),this._resetNodeDepth(l,u);for(let c=0;c<n;c++){[a,l]=[l,a],this._nodeDepthFB.attach({[Oe.COLOR_ATTACHMENT0]:l});let h={nodeDepth:a,textureDim:o,testForward:!0};this._updateNodeDepth(h),this._hasBidirectionalEdge&&(h.testForward=!1,this._updateNodeDepth(h))}}else this._resetNodeDepth(l),this._nodeDepthFB.attach({[Oe.COLOR_ATTACHMENT0]:l});this._nodeDepth=l,i&&(this._nodeDepthFB.attach({[Oe.COLOR_ATTACHMENT0]:a}),this._transform.run({framebuffer:this._nodeDepthFB,clearRenderTarget:!1,discard:!0,uniforms:{nodeDepth:l,textureDim:o}}))}_resetNodeDepth(e,t){this._nodeDepthFB.attach({[Oe.COLOR_ATTACHMENT0]:e}),ft(this._gl,{framebuffer:this._nodeDepthFB,viewport:[0,0,e.width,e.height],clearColor:[1,1,1,1]},()=>{this._gl.clear(Oe.COLOR_BUFFER_BIT)}),t!==void 0&&e.setSubImageData({data:R5,x:t%e.width,y:Math.floor(t/e.width),width:1,height:1})}_updateNodeDepth(e){this._model.draw({framebuffer:this._nodeDepthFB,uniforms:e,parameters:{depthTest:!1,blend:!0,viewport:[0,0,this._nodeDepthFB.width,this._nodeDepthFB.height],blendFunc:[Oe.ONE,Oe.ONE,Oe.ONE,Oe.ONE],blendEquation:[Oe.MIN,Oe.MIN]}})}};function ay(s,e,t,i){e||(e=new Se(s,{target:s.ARRAY_BUFFER,accessor:t}));let n=i*t.size*(t.type===Oe.UNSIGNED_BYTE?1:4);return e.byteLength<n&&e.reallocate(n),e}function AR(s){let e=s.getParameter(s.MAX_TEXTURE_SIZE);return e=Math.min(1024,2**Math.floor(Math.log2(e))),new Ve(s,{format:Oe.RGBA,type:Oe.UNSIGNED_BYTE,border:0,mipmaps:!1,dataFormat:Oe.RGBA,width:e,height:1,parameters:{[Oe.TEXTURE_MIN_FILTER]:Oe.NEAREST,[Oe.TEXTURE_MAG_FILTER]:Oe.NEAREST,[Oe.TEXTURE_WRAP_S]:Oe.CLAMP_TO_EDGE,[Oe.TEXTURE_WRAP_T]:Oe.CLAMP_TO_EDGE}})}function O5(s){return new At(s,{id:"graph-highlighter-nodes",vs:`
#define SHADER_NAME graph-highlighter-nodes-vertex-shader

uniform bool testForward;

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float targetDepth;

${ly}

void main(void) {
  vec3 sourceIdx = source;
  vec3 targetIdx = target;
  if (!testForward && direction == 0.0) {
    sourceIdx = target;
    targetIdx = source;
  }
  float sourceDepth;
  bool sourceDepthValid = getDepth(sourceIdx, sourceDepth);
  vec2 targetCoord = getCoordinate(targetIdx);

  gl_Position = vec4(targetCoord * 2.0 - 1.0, sourceDepthValid ? 0.0 : 2.0, 1.0);
  gl_PointSize = 1.0;

  targetDepth = sourceDepth + 1.0;
}
`,fs:`
#define SHADER_NAME graph-highlighter-nodes-fragment-shader
varying float targetDepth;

void main(void) {
  gl_FragColor = vec4(targetDepth / 255.0, 0.0, 0.0, 0.0);
}`,isInstanced:!1,drawMode:Oe.POINTS})}function _5(s){return new nn(s,{vs:`
#define SHADER_NAME graph-highlighter-edges-vertex-shader

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float nextDepth;

${ly}

float getDepth(vec3 sourceIdx) {
  float sourceDepth;
  if (getDepth(sourceIdx, sourceDepth)) {
    return sourceDepth + 1.0;
  }
  return 255.0;
}

void main(void) {
  nextDepth = getDepth(source);
  if (direction == 0.0) {
    nextDepth = min(nextDepth, getDepth(target));
  }

  gl_Position = vec4(0.0);
}
`,varyings:["nextDepth"]})}function Ax(s,e){return e[0]=s&255,e[1]=s>>8&255,e[2]=s>>8>>8&255,e}var wr;(function(s){s[s.Rectangle=0]="Rectangle",s[s.Oval=1]="Oval",s[s.Diamond=2]="Diamond"})(wr||(wr={}));var N5={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColors:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPickingColor:{type:"accessor",value:[0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:wr.Rectangle}},M5=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

${ly}

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  float depth;
  if (getDepth(instancePickingColors, depth)) {
    applyHighlight(int(depth));
  }
}
`,B5=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,bl=class extends zt{getShaders(){return super.getShaders({vs:M5,fs:B5,modules:[hi,rl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:Oe.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:Oe.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:Oe.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:Oe.UNSIGNED_BYTE,accessor:"getShape"},instancePickingColors:{size:3,type:Oe.UNSIGNED_BYTE,accessor:"getPickingColor"}})}updateState(e){var t;super.updateState(e);let{props:i,oldProps:n,changeFlags:o}=e,a=!1;if(o.extensionsChanged){let{gl:l}=this.context;(t=this.state.model)===null||t===void 0||t.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),a=!0}if(a||i.highlightColors!==n.highlightColors){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=i.highlightColors[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:i,cornerRadius:n,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:i,cornerRadius:n,lineWidthUnits:zr[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c,textureDim:[c.width,c.height]}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:Oe.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};bl.defaultProps=N5;bl.layerName="GeometryLayer";var Ku=class extends Wr{getPickingInfo({sourceLayer:e,info:t}){return e.id.endsWith("boundary")&&t.picked&&(t.object=this.props.fromIndex(t.index)),t}renderLayers(){return[new bl(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:e=>G5(e.node),cornerRadius:D5(this.props.data[0]),getLineColor:TR,getFillColor:F5}),new ki(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof me)||t.labelSize),getPosition:e=>Q0(e),getText:e=>wt.getDrawingObj(e.node).labelText,getColor:TR,getSize:this.props.getTextSize,billboard:!1,sizeUnits:"common",characterSet:"auto",_subLayerProps:{characters:{clipByInstance:!1}}})]}};Ku.defaultProps={...ki.defaultProps,...bl.defaultProps,fromIndex:{type:"function",compare:!1},getTextSize:{type:"accessor",value:16}};Ku.layerName="NodeLayer";function D5(s){return s?wt.getDrawingObj(s.node).xRad:0}function TR(s){let e=ke.getDrawingObj(s.node);if(e){let t=e.pencolor;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function F5(s){let e=ke.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}function G5(s){let e=ke.getDrawingObj(s);if(e==null)return wr.Rectangle;switch(e.shape){case 0:return wr.Diamond;case 1:return wr.Oval;case 2:return wr.Rectangle;case 3:return wr.Oval;case 4:return wr.Rectangle;case 5:return wr.Oval;case 6:return wr.Oval;case 10:return wr.Oval;case 14:return wr.Oval;case 18:return wr.Rectangle;case 11:return wr.Rectangle;case 12:return wr.Rectangle;default:return wr.Rectangle}}var Pl;(function(s){s[s.Line=0]="Line",s[s.Bezier=1]="Bezier",s[s.Arc=2]="Arc"})(Pl||(Pl={}));var V5={widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getControlPoints:{type:"accessor",value:s=>s.points},getCurveType:{type:"accessor",value:Pl.Line},getResolution:{type:"accessor",value:4},getRange:{type:"accessor",value:[0,1]},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},k5=`#define SHADER_NAME curve-layer-vertex-shader
#define LINE    0.0
#define BEZIER  1.0
#define ARC     2.0

attribute vec2 positions;
attribute vec2 instanceSegments;
attribute vec4 instancePositions1;
attribute vec4 instancePositions2;
attribute float instanceTypes;
attribute float instanceWidths;
attribute vec4 instanceColors;

uniform float opacity;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform int widthUnits;

varying vec4 vColor;

void interpolateLine(float t, vec2 start, vec2 end, out vec2 point) {
  point = mix(start, end, t);
}

void interpolateBezierCurve(float t, vec2 start, vec2 c1, vec2 c2, vec2 end, out vec2 point) {
  vec2 c = (c1 - start) * 3.0;
  vec2 e = (c2 - c1) * 3.0 - c;
  vec2 l = end - start - c - e;

  float t2 = t * t;
  float t3 = t2 * t;
  
  point = l * t3 + e * t2 + c * t + start;
}

void interpolateArc(float t, vec2 center, vec2 aAxis, vec2 bAxis, out vec2 point) {
  point = center + cos(t) * aAxis + sin(t) * bAxis;
}

vec2 getExtrusionOffset(vec2 line, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir = normalize(line);
  // rotate by 90 degrees
  dir = vec2(-dir.y, dir.x);
  return dir * offset_direction * width / 2.0;
}

void main(void) {
  // Multiply out line width and clamp to limits
  float widthPixels = clamp(
    project_size_to_pixel(widthScale * instanceWidths, widthUnits),
    widthMinPixels, widthMaxPixels
  );
  float widthCommon = project_pixel_size(widthPixels);

  geometry.uv = positions.xy;

  vec2 pointOnCurve;
  vec2 nextPointOnCurve;
  vec2 pointOnCurve64Low = vec2(0.0);
  float r = instanceSegments.x + positions.x * instanceSegments.y;
  float rNext = r + instanceSegments.y;

  if (instanceTypes == BEZIER) {
    interpolateBezierCurve(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, pointOnCurve);
    interpolateBezierCurve(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, nextPointOnCurve);
  }
  else if (instanceTypes == ARC) {
    interpolateArc(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, pointOnCurve);
    interpolateArc(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, nextPointOnCurve);
  }
  else {
    interpolateLine(r, instancePositions1.xy, instancePositions1.zw, pointOnCurve);
    interpolateLine(rNext, instancePositions1.xy, instancePositions1.zw, nextPointOnCurve);
  }
  
  vec3 offset = vec3(getExtrusionOffset(
    nextPointOnCurve - pointOnCurve,
    positions.y,
    widthCommon), 0.0);

  gl_Position = project_position_to_clipspace(
    vec3(pointOnCurve, 0.0),
    vec3(pointOnCurve64Low, 0.0),
    offset,
    geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,U5=`#define SHADER_NAME curve-layer-fragment-shader
varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Zu=class extends zt{getShaders(){return super.getShaders({vs:k5,fs:U5,modules:[hi,rl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:8,transition:!0,accessor:"getControlPoints",shaderAttributes:{instancePositions1:{size:4},instancePositions2:{size:4,elementOffset:4}}},instanceSegments:{size:2,update:this._getSegments},instanceTypes:{size:1,type:Oe.UNSIGNED_BYTE,accessor:"getCurveType"},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceColors:{size:4,transition:!0,normalized:!0,type:Oe.UNSIGNED_BYTE,accessor:"getColor"}})}updateState(e){var t;super.updateState(e);let{props:i,changeFlags:n}=e;if(n.dataChanged&&this.updateGeometry(),n.extensionsChanged){let{gl:o}=this.context;(t=this.state.model)===null||t===void 0||t.delete(),this.state.model=this._getModel(o),this.getAttributeManager().invalidateAll()}}updateGeometry(){let{data:e,getResolution:t,getCurveType:i,getRange:n}=this.props,{iterable:o,objectInfo:a}=mo(e),l=[0],u=0,c=[];for(let h of o){a.index++;let d=typeof i=="function"?i(h,a):i,f=typeof n=="function"?n(h,a):n,p=d===Pl.Line?1:Math.ceil(typeof t=="function"?t(h,a):t);u+=p;let S=(f[1]-f[0])/p;l.push(u);for(let x=0;x<p;x++)c.push(f[0]+S*x,S)}this.setState({startIndices:l,numInstances:u,segments:new Float32Array(c)})}draw({uniforms:e}){let{widthUnits:t,widthScale:i,widthMinPixels:n,widthMaxPixels:o}=this.props;this.state.model.setUniforms(e).setUniforms({widthUnits:zr[t],widthScale:i,widthMinPixels:n,widthMaxPixels:o}).draw()}_getModel(e){let t=[0,-1,1,-1,1,1,0,1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new gr({drawMode:Oe.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_getSegments(e){e.value=this.state.segments}};Zu.layerName="CurveLayer";Zu.defaultProps=V5;var z5={resolution:{type:"number",value:1},widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},Qu=class extends Wr{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let t=Array.from(j5(this.props.data,(i,n,o)=>this.getSubLayerRow(i,n,o)));this.setState({curves:t})}}renderLayers(){let{getWidth:e,getColor:t,resolution:i}=this.props;return[new Zu({getWidth:this.getSubLayerAccessor(e),getColor:this.getSubLayerAccessor(t)},this.getSubLayerProps({id:"path"}),{data:this.state.curves,getCurveType:W5,getControlPoints:H5,getRange:n=>[n.parStart,n.parEnd],widthUnits:"pixels",getResolution:n=>n.length*i,clipByInstance:!1})]}};Qu.defaultProps=z5;Qu.layerName="EdgeLayer";function W5(s){return s instanceof be?Pl.Arc:s instanceof Fe?Pl.Bezier:Pl.Line}function H5(s){return s instanceof be?[s.center,s.aAxis,s.bAxis].flatMap(Tx):s instanceof Fe?s.b.flatMap(Tx):[s.start,s.end].flatMap(Tx)}function*j5(s,e){let t=0;for(let i of s){let{curve:n}=i;e(n,i,t),yield n,t++}}function Tx(s){return[s.x,s.y]}var Ju=class extends Wr{renderLayers(){let e=this.props.data,{highlighter:t,resolution:i,fontFamily:n,fontWeight:o,lineHeight:a,getTextSize:l}=this.props;return[e.nodes.length>0&&new Ku(this.getSubLayerProps({id:"nodes"}),{data:e.nodes,getPickingColor:(u,{target:c})=>t.encodeNodeIndex(u,c),fromIndex:u=>t.getNode(u),nodeDepth:t.nodeDepth,getLineWidth:1,fontFamily:n,fontWeight:o,lineHeight:a,getTextSize:l,clipByInstance:!1}),e.curveClips.length>0&&new Qu(this.getSubLayerProps({id:"curves"}),{data:e.curveClips,getWidth:1,getDepth:t.edgeDepth,resolution:i}),e.arrowheads.length>0&&new Dn(this.getSubLayerProps({id:"arrowheads"}),{data:e.arrowheads,iconAtlas:"deck://arrowAtlas",iconMapping:CR,getPosition:u=>[u.tip.x,u.tip.y],getColor:u=>q5(u.edge),getIcon:u=>X5(u.edge),getSize:u=>Y5(u.tip,u.base),getAngle:u=>K5(u.tip,u.base),billboard:!1,sizeUnits:"common"}),e.labels.length>0&&new ki(this.getSubLayerProps({id:"labels"}),{data:e.labels,getText:u=>Ix(u).labelText,getSize:u=>Ix(u).fontsize,getColor:Z5,getPosition:u=>[u.center.x,u.center.y],fontFamily:n,fontWeight:o,lineHeight:a,sizeUnits:"common"})]}};Ju.defaultProps={...ki.defaultProps,resolution:{type:"number",value:1},highlighter:{type:"object"},getTextSize:{type:"accessor",value:16}};Ju.layerName="Graphayer";function q5(s){let e=ke.getDrawingObj(s);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function X5(s){return"triangle-n"}function Y5(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}function K5(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.atan2(i,t)/Math.PI*180}function Ix(s){let t=s.parent.entity;return ke.getDrawingObj(t)}function Z5(s){let e=Ix(s).labelfontcolor;return e?[e.R,e.G,e.B]:[0,0,0]}var qh=null,IR=!1;async function wR(s,e,t,i=!1){if(IR&&(qh.terminate(),qh=null),!qh){s=new URL(s,location.href).href;let n=`importScripts( "${s}" )`,o=URL.createObjectURL(new Blob([n],{type:"text/javascript"}));qh=new Worker(o)}return new Promise((n,o)=>{qh.onmessage=({data:a})=>{if(a.type==="error")o(a.message);else if(a.type==="layout-done")try{e=za(a.graph),console.debug("graph transfer to main thread",Date.now()-a.timestamp+" ms"),n(e)}catch(l){o(l.message)}},qh.postMessage({type:"layout",timestamp:Date.now(),graph:ff(e),options:t,forceUpdate:i}),IR=!0})}function LR(s,e,t=!1){let i=!1,n=t,o=yt.getDrawingObj(s),a=me.getGeom(s);function l(u){if(!u)return;for(let d of u.subgraphs())l(d);let c=Q5(o,u,e),h=J5(u.layoutSettings,c);n=n||h.layoutChanged,i=i||h.routingChanged,u.layoutSettings=c}if(l(a),n||i)for(let u of a.deepEdges)u.requireRouting();return n?ef(a,null):i&&Fa(a,Array.from(a.deepEdges),null),s}function Q5(s,e,t){let i=!1;for(let o of e.deepEdges)if(o.sourceArrowhead!=null||o.targetArrowhead!=null){i=!0;break}let n;switch(t.layoutType){case"Sugiyama LR":{let o=n=new Rt;o.layerDirection=1;break}case"Sugiyama RL":{let o=n=new Rt;o.layerDirection=3;break}case"Sugiyama TB":{let o=n=new Rt;o.layerDirection=0;break}case"Sugiyama BT":{let o=n=new Rt;o.layerDirection=2;break}case"MDS":n=new Bi;break;case"IPsepCola":n=new Tr;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.deepEdgesCount>4e3;if(i&&!o){let a=n=new Rt;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else n=new Tr}}return t.edgeRoutingMode==null?n instanceof Rt?n.edgeRoutingSettings.EdgeRoutingMode=3:n.edgeRoutingSettings.EdgeRoutingMode=0:n.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,n}function J5(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.commonSettings.edgeRoutingSettings.EdgeRoutingMode!==e.commonSettings.edgeRoutingSettings.EdgeRoutingMode,i=t&&e.commonSettings.edgeRoutingSettings.EdgeRoutingMode===3,n=s instanceof Rt&&e instanceof Rt&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||i||n,routingChanged:t}}function RR(s,e,t){t[s]=t[s]||[],t[s].indexOf(e)<0&&t[s].push(e)}function wx(s,e,t){if(t[s]){let i=t[s].indexOf(e);i>=0&&t[s].splice(i,1)}}var sp=class{constructor(){this._listeners={},this._onceListeners={}}on(e,t){RR(e,t,this._listeners)}once(e,t){RR(e,t,this._onceListeners)}off(e,t){wx(e,t,this._listeners),wx(e,t,this._onceListeners)}emit(e){var t,i;let n;typeof e=="string"?n={type:e}:n=e;let o=n.type;if(!this._listens(o))return;n.target=this;let a=((t=this._listeners[o])===null||t===void 0?void 0:t.slice())||[];for(let u of a)u.call(this,n);let l=((i=this._onceListeners[o])===null||i===void 0?void 0:i.slice())||[];for(let u of l)wx(o,u,this._onceListeners),u.call(this,n)}_listens(e){return this._listeners[e]&&this._listeners[e].length>0||this._onceListeners[e]&&this._onceListeners[e].length>0}};var ap=2,Xh=class extends sp{constructor(e=document.body,t){super(),this._layoutOptions={},this._controls=[],this._layoutWorkerUrl=t,this._textMeasurer=new Jc,window.getComputedStyle(e).position==="static"&&(e.style.position="relative");let i=Array.from({length:2},()=>{let n=document.createElement("div");return Object.assign(n.style,{position:"absolute",top:0,bottom:0,left:0,right:0}),e.appendChild(n)});this._deck=new al({parent:i[0],views:[new Hs({flipY:!1})],initialViewState:{target:[0,0,0],zoom:0,maxZoom:ap},controller:!0,onLoad:()=>{this.emit("load");let{gl:n}=this._deck.deckRenderer;this._deck._addResources({arrowAtlas:vR(n)}),this._update()},onClick:({object:n})=>{!n&&this._highlightedNodeId&&this.highlight(null)}}),i[1].style.pointerEvents="none",this._controlsContainer=i[1]}addControl(e){if(this._controls.indexOf(e)<0){this._controls.push(e),e.onAdd(this);let t=e.getElement();t&&this._controlsContainer.appendChild(t)}}removeControl(e){let t=this._controls.indexOf(e);if(t>=0){let i=e.getElement();i&&i.remove(),e.onRemove(this),this._controls.splice(t,1)}}get graph(){return this._graph}async setGraph(e,t=this._layoutOptions){this._graph===e?t&&await this.setOptions(t):(this._graph=e,t&&!jc(e)?(this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{}),this._highlightedNodeId=null,(yt.getDrawingObj(e)||new yt(e)).createGeometry(this._textMeasurer.measure),await this._layoutGraph(!0)):this._deck.layerManager&&this._update())}async setOptions(e){let t=this._layoutOptions.label,i=e.label,n=!gf(t,i);if(this._layoutOptions=e,!this._graph)return;let o=yt.getDrawingObj(this._graph);n&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=n;await this._layoutGraph(a)}zoomTo(e){let t=Math.min(this._deck.width/e.width,this._deck.height/e.height),i=Math.min(Math.log2(t),ap);this._deck.setProps({initialViewState:{target:[e.center.x,e.center.y,0],zoom:i,transitionInterpolator:new Bn(["target","zoom"]),transitionDuration:1e3,maxZoom:ap}})}highlight(e){this._highlightedNodeId=e,this._highlight(e)}_highlight(e,t=2){this._graph&&this._deck.layerManager&&(this._graphHighlighter.update({sourceId:e,maxDepth:t,edgeDepth:!1}),this._deck.layerManager.setNeedsRedraw("hightlight changed"))}async _layoutGraph(e){this._layoutWorkerUrl?this._graph=await wR(this._layoutWorkerUrl,this._graph,this._layoutOptions,e):LR(this._graph,this._layoutOptions,e),this._deck.layerManager&&this._update()}_update(){if(!this._graph)return;let e=this._textMeasurer.opts,t=me.getGeom(this._graph);if(!t)return;this._graphHighlighter=this._graphHighlighter||new op(this._deck.deckRenderer.gl),this._graphHighlighter.setGraph(t);let i=t.boundingBox;console.time("Generate tiles");let n=2**Math.ceil(Math.log2(Math.max(i.width,i.height))),o=Math.min(ap,Math.round(9-Math.log2(n))),a=new q({left:i.left-(n-i.width)/2,bottom:i.bottom-(n-i.height)/2,right:i.right+(n-i.width)/2,top:i.top+(n-i.height)/2}),l=new md(t,a),u=l.buildUpToLevel(20);console.timeEnd("Generate tiles"),console.time("initial render");let c=new it().translate([n/2-a.center.x,n/2-a.center.y,0]),h=new pl({extent:[0,0,n,n],refinementStrategy:"no-overlap",minZoom:o,maxZoom:u-1+o,tileSize:512,getTileData:d=>{let{x:f,y:p,z:S}=d.index;return d.bbox,l.getTileData(f,p,S-o)},parameters:{depthTest:!1},autoHighlight:!0,onHover:({object:d,sourceLayer:f})=>{this._highlightedNodeId||(d instanceof ot?this._highlight(d.id):this._highlight(null))},renderSubLayers:({data:d,id:f,tile:p})=>{if(!d)return null;let S=d.rect;return[new Ju({id:f,data:d,modelMatrix:c,highlighter:this._graphHighlighter,fontFamily:e.fontFamily,fontWeight:e.fontWeight,lineHeight:e.lineHeight,getTextSize:e.fontSize,resolution:2**(p.index.z-2),pickable:!0,clipBounds:[S.left,S.bottom,S.right,S.top],clipByInstance:!1,extensions:[new ml]})]},updateTriggers:{getTileData:Date.now()}});this._deck.setProps({layers:[h],initialViewState:{target:[n/2,n/2,0],zoom:o,minZoom:o,maxZoom:ap},onAfterRender:()=>{h.isLoaded&&(console.timeEnd("initial render"),this._deck.setProps({onAfterRender:$5}))}}),this.emit({type:"graphload",data:this._graph})}};function $5(){}var e4=`
  .search-control { pointer-events: all; font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; position: absolute; top: 0; right: 0; margin: 20px; width: 200px; }
  .search-control-input { font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; padding: 8px; width: 100%; }
  .search-control-options { background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); padding: 12px 0; margin-top: 4px; overflow-x: hidden; overflow-y: auto; }
  .search-control-option { padding: 0 12px; line-height: 32px; white-space: nowrap; color: #000; cursor: pointer; }
  .search-control-option:hover { background: #f8f8f8; }
  .search-control-option.focus { color: #08f; background: #f8f8f8; }
`,Yh=class{constructor(){this._nodes=[],this._onGraphLoad=e=>{this._updateNodeList(e.data)}}onAdd(e){e.on("graphload",this._onGraphLoad),this._dropdown=new Lx({getLabel:t=>wt.getDrawingObj(t).labelText,onSelect:t=>{e.highlight(t.id);let i=ot.getGeom(t);e.zoomTo(i.boundingBox)}}),this._updateNodeList(e.graph)}onRemove(e){e.off("graphload",this._onGraphLoad),this._dropdown.delete(),this._dropdown=null}getElement(){return this._dropdown.element}_updateNodeList(e){this._nodes=e?Array.from(e.nodesBreadthFirst):[],this._dropdown.update(this._nodes)}},Lx=class{constructor(e){this.focus=-1,this.items=[],this.options={getLabel:l=>l.toString(),renderItem:(l,u)=>{if(!u)return l;let c=l.toLowerCase().indexOf(u);return`${l.slice(0,c)}<b>${l.slice(c,c+u.length)}</b>${l.slice(c+u.length)}`},filterItem:(l,u)=>{if(!u)return 1;let c=l.toLowerCase().indexOf(u);return c===0?2:c>0?1:0},onSelect:()=>{},buffer:2,itemHeight:32,maxHeight:240},this._active=!1,this._topOffset=0,this._keyword="",this._filteredItems=[],this._items=[],this._onScroll=()=>{let{itemHeight:l,buffer:u,getLabel:c,renderItem:h}=this.options,d=this._flyout.scrollTop;this._topOffset=Math.max(0,Math.floor(d/l)-u),this._scroller.style.paddingTop=this._topOffset*l+"px";for(let f=0;f<this._items.length;f++){let p=this._items[f],S=f+this._topOffset;S===this.focus?p.classList.add("focus"):p.classList.remove("focus");let x=this._filteredItems[S];if(x){let C=c(x);p.innerHTML=h(C,this._keyword,x)}}};let t=document.createElement("style");t.innerText=e4,document.head.appendChild(t),this._stylesheet=t;let i=document.createElement("div");i.className="search-control";let n=document.createElement("input");n.placeholder="Search...",n.className="search-control-input",i.appendChild(n),n.addEventListener("focus",()=>{n.value="",this._keyword="",this._active=!0,this._updateFilter()}),n.addEventListener("blur",()=>{setTimeout(()=>{this._active=!1,this._updateUI()},200)}),n.addEventListener("input",l=>{this._keyword=n.value.toLowerCase(),this._updateFilter()}),n.addEventListener("keydown",l=>{switch(l.key){case"ArrowDown":l.preventDefault(),this.focus=Math.min(this._filteredItems.length-1,this.focus+1),this._updateUI();break;case"ArrowUp":l.preventDefault(),this.focus=Math.max(0,this.focus-1),this._updateUI();break;case"Enter":this._select(this.focus);break}}),this._textbox=n;let o=document.createElement("div");o.className="search-control-options",o.addEventListener("scroll",this._onScroll),i.appendChild(o);let a=document.createElement("div");a.style.boxSizing="border-box",a.style.overflow="hidden",o.appendChild(a),this._flyout=o,this._scroller=a,this.element=i,this.setOptions(e)}delete(){this.items=null,this._stylesheet.remove(),this._stylesheet=null,this.element.remove(),this.element=null,this._scroller=null,this._flyout=null}setOptions(e){Object.assign(this.options,e);let t=Math.ceil(this.options.maxHeight/this.options.itemHeight)+this.options.buffer*2,i=this._items;if(i.length!==t){for(let n=i.length;n<t;n++){let o=this._makeItem(n);i.push(o)}for(let n=i.length;n>t;n--)i[n-1].remove()}this._updateFilter()}update(e){this.items=e,this._textbox.value="",this._keyword="",this._updateFilter()}_updateFilter(){let{getLabel:e,filterItem:t}=this.options,i=this.items.map(o=>{let a=e(o);return t(a,this._keyword,o)}),n=Array.from(i,(o,a)=>a).filter(o=>i[o]);n.sort((o,a)=>i[a]-i[o]),this._filteredItems=n.map(o=>this.items[o]),this.focus=0,this._updateUI()}_select(e){let t=this._filteredItems[e];t&&(this.options.onSelect(t),this._textbox.value=this.options.getLabel(t),this._textbox.blur())}_updateUI(){if(!this._active){this._flyout.style.display="none";return}this._flyout.style.display="block",this._flyout.style.maxHeight=this.options.maxHeight+"px";let{itemHeight:e,maxHeight:t}=this.options,i=this._filteredItems.length,n=Math.floor(t/e),o=Math.max(0,(this.focus+2-n)*e),a=Math.min(Math.max(0,i*e-t),Math.max(0,this.focus-1)*e),l=this._flyout.scrollTop;l<o&&(l=o),l>a&&(l=a),this._scroller.style.height=i*e+"px";for(let u=0;u<this._items.length;u++){let c=this._items[u];c.style.display=u<i?"block":"none"}this._flyout.scrollTo({left:0,top:l,behavior:"smooth"}),this._onScroll()}_makeItem(e){let t=document.createElement("div");return t.className="search-control-option",t.style.height=this.options.itemHeight+"px",this._scroller.appendChild(t),t.addEventListener("click",()=>{this._select(e+this._topOffset)}),t}};var OR="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),Rx={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},Ox={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",ipsepCola:"IPSepCola",mds:"Pivot MDS"},_R=["Times New Roman","Arial","Georgia","Courier New","Verdana"];var t4="https://raw.githubusercontent.com/microsoft/msagljs/main/examples/data/gameofthrones.json",_x=new Xh(document.getElementById("viewer"),null);_x.addControl(new Yh);async function Kh(s,e){let t=document.getElementById("settings");t.classList.add("disabled"),s instanceof Ce?await _x.setGraph(s,e):await _x.setOptions(s),t.classList.remove("disabled")}var uy=document.getElementById("gv");for(let s of OR){let e=document.createElement("option");e.value=`${s}.gv`,e.innerText=s,uy.appendChild(e)}uy.selectedIndex=-1;uy.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+uy.value;db(s).then(e=>{Kh(e),document.getElementById("graph-name").innerText=e.id+"("+e.nodeCountDeep.toString()+","+e.deepEdgesCount.toString+")"})};var Nx=document.getElementById("routings");for(let s in Rx){let e=document.createElement("option");e.value=s,e.innerText=Rx[s],Nx.appendChild(e)}Nx.onchange=()=>{Kh(cy())};var Mx=document.getElementById("layouts");for(let s in Ox){let e=document.createElement("option");e.value=s,e.innerText=Ox[s],Mx.appendChild(e)}Mx.onchange=()=>{Kh(cy())};var Bx=document.getElementById("fonts");for(let s of _R){let e=document.createElement("option");e.value=s,e.innerText=s,e.style.fontFamily=s,Bx.appendChild(e)}Bx.onchange=()=>{Kh(cy())};iv("drop-target",async s=>{let e=await Z0(s);Kh(e),document.getElementById("graph-name").innerText=e.id+"("+e.nodeCountDeep.toString()+","+e.deepEdgesCount.toString()+")"});(async()=>{let s=await db(t4),e=jc(s);Kh(s,e?null:cy()),document.getElementById("graph-name").innerText=s.id+"("+s.nodeCountDeep.toString()+","+s.deepEdgesCount.toString()+")"})();function cy(){let s={label:{fontFamily:Bx.value}};switch(ke.defaultLabelFontName=s.label.fontFamily,Mx.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;case"ipsepCola":s.layoutType="IPsepCola";break;default:break}switch(Nx.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.
   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   xxHash Library
   Copyright (c) 2012-2021 Yann Collet
   All rights reserved.

   BSD 2-Clause License (https://www.opensource.org/licenses/bsd-license.php)

   Redistribution and use in source and binary forms, with or without modification,
   are permitted provided that the following conditions are met:

   * Redistributions of source code must retain the above copyright notice, this
     list of conditions and the following disclaimer.

   * Redistributions in binary form must reproduce the above copyright notice, this
     list of conditions and the following disclaimer in the documentation and/or
     other materials provided with the distribution.

   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */
/*! The following comments were added due to code inlined from "@esfx/internal-binarysearch": */
/*! The following comments were added due to code inlined from "@esfx/internal-collections-hash": */
