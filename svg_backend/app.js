(()=>{var YT=Object.create;var ig=Object.defineProperty;var $T=Object.getOwnPropertyDescriptor;var QT=Object.getOwnPropertyNames;var ZT=Object.getPrototypeOf,KT=Object.prototype.hasOwnProperty;var JT=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var be=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),eI=(s,e)=>{for(var t in e)ig(s,t,{get:e[t],enumerable:!0})},tI=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of QT(e))!KT.call(s,n)&&n!==t&&ig(s,n,{get:()=>e[n],enumerable:!(i=$T(e,n))||i.enumerable});return s};var Q=(s,e,t)=>(t=s!=null?YT(ZT(s)):{},tI(e||!s||!s.__esModule?ig(t,"default",{value:s,enumerable:!0}):t,s));var a0=be((OG,s0)=>{"use strict";function rI(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function Uo(s,e,t,i){this.message=s,this.expected=e,this.found=t,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Uo)}rI(Uo,Error);Uo.buildMessage=function(s,e){var t={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,p;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,p=1;d<h.length;d++)h[d-1]!==h[d]&&(h[p]=h[d],p++);h.length=p}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function iI(s,e){e=e!==void 0?e:{};var t={},i={start:HP},n=HP,o="strict",a=he("strict",!0),l="graph",u=he("graph",!0),c="digraph",h=he("digraph",!0),d="{",p=he("{",!1),y="}",x=he("}",!1),A=function(m,S,R,L){L===null&&(L=[]);var G={type:S.toLowerCase(),children:L};return m&&(G.strict=!0),R&&(G.id=R),G},T=";",I=he(";",!1),B=function(m,S){return S},w=function(m,S){return[m].concat(S)},M="=",F=he("=",!1),z=function(m,S){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:m,eq:S}]}},se="node",pe=he("node",!0),de="edge",Ae=he("edge",!0),$e=function(m,S){return{type:"attr_stmt",target:m,attr_list:S}},ge="[",me=he("[",!1),J="]",bn=he("]",!1),zA=function(m,S){return(m||[]).concat(S||[])},HA=function(m,S){return S},WA=",",jA=he(",",!1),qA=function(m,S,R){return[{type:"attr",id:m,eq:S}].concat(R||[])},XA=function(m,S,R){var L=[m];return L=L.concat(S.map(function(G){return G.id})),{type:"edge_stmt",edge_list:L,attr_list:R||[]}},SP="->",YA=he("->",!1),EP="--",$A=he("--",!1),QA=function(m,S,R){return[{type:"edgeRHS",edgeop:m,id:S}].concat(R||[])},ZA=function(m,S){return{type:"node_stmt",node_id:m,attr_list:S||[]}},KA=function(m,S){return S?{type:"node_id",id:m,port:S}:{type:"node_id",id:m}},JA=Ni("port"),Uf=":",zf=he(":",!1),ev=function(m,S){return S},tv=function(m,S){return{type:"port",id:m,compass_pt:S||null}},rv=function(m){return{type:"port",compass_pt:m||null}},iv="subgraph",nv=he("subgraph",!0),ov=function(m){return m?{type:"subgraph",id:m}:{type:"subgraph"}},sv=function(m,S){return m=m||{type:"subgraph"},m.children=S||[],m},av="n",lv=he("n",!1),xP="ne",uv=he("ne",!1),cv="e",hv=he("e",!1),CP="se",dv=he("se",!1),fv="s",gv=he("s",!1),AP="sw",pv=he("sw",!1),mv="w",bv=he("w",!1),vP="nw",Pv=he("nw",!1),yv=Ni("UNICODE_STRING"),Sv=function(m,S){return m+S.join("")},Ev=function(m,S){return m+S},xv="$",Cv=he("$",!1),Av="_",vv=he("_",!1),Tv=Ni("NUMBER"),Iv="-",wv=he("-",!1),TP=".",IP=he(".",!1),ta=/^[0-9]/,ra=Dr([["0","9"]],!1,!1),Lv=function(m){return parseFloat(kP())},Rv=function(m){return{type:"id",value:m.slice(1,m.length-1),html:!0}},Hf="<",Wf=he("<",!1),jf=">",qf=he(">",!1),Ov=function(m){return"<"+m.join("")+">"},Bi=xT(),ia=function(m){return m},Bv=function(m){return m.join("")},Xf='"',Yf=he('"',!1),wP=function(m){return m.join("")},Mv=function(){return kP()},wc="\\",Lc=he("\\",!1),Nv=function(m){return m[1]==='"'?'"':m[0]+m[1]},LP=function(){return""},Dv=/^[\n\r\u2028\u2029]/,Gv=Dr([`
`,"\r","\u2028","\u2029"],!1,!1),_v=Ni("end of line"),Fv=`
`,Vv=he(`
`,!1),RP=`\r
`,kv=he(`\r
`,!1),Uv="\r",zv=he("\r",!1),Hv="\u2028",Wv=he("\u2028",!1),jv="\u2029",qv=he("\u2029",!1),Xv=/^[^"\\\0-\x1F\x7F]/,Yv=Dr(['"',"\\",["\0",""],"\x7F"],!0,!1),OP='\\"',$v=he('\\"',!1),Qv=function(){return'"'},Zv=function(){return"\\"},Kv=Ni("COMMENT"),Jv=Ni("BLOCK_COMMENT"),BP="/*",eT=he("/*",!1),na="*/",$f=he("*/",!1),MP=function(m){return m},tT=function(m){return m.join("")},rT=Ni("C_COMMENT"),NP="//",iT=he("//",!1),oa=/^[\n]/,sa=Dr([`
`],!1,!1),DP=function(m){return m.join("")},nT=Ni("MACRO_COMMENT"),oT="#",sT=he("#",!1),aT=Ni("WHITESPACE"),GP=/^[\n\r]/,_P=Dr([`
`,"\r"],!1,!1),FP=/^[ \t]/,VP=Dr([" ","	"],!1,!1),lT=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,uT=Dr([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),cT=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,hT=Dr([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),dT=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,fT=Dr(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),gT=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,pT=Dr(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),mT=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,bT=Dr([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),PT=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,yT=Dr([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),ST=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,ET=Dr([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),P=0,te=0,Rc=[{line:1,column:1}],Mi=0,Qf=[],D=0,Oc;if("startRule"in e){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=i[e.startRule]}function kP(){return s.substring(te,P)}function vG(){return Bl(te,P)}function TG(m,S){throw S=S!==void 0?S:Bl(te,P),zP([Ni(m)],s.substring(te,P),S)}function IG(m,S){throw S=S!==void 0?S:Bl(te,P),AT(m,S)}function he(m,S){return{type:"literal",text:m,ignoreCase:S}}function Dr(m,S,R){return{type:"class",parts:m,inverted:S,ignoreCase:R}}function xT(){return{type:"any"}}function CT(){return{type:"end"}}function Ni(m){return{type:"other",description:m}}function UP(m){var S=Rc[m],R;if(S)return S;for(R=m-1;!Rc[R];)R--;for(S=Rc[R],S={line:S.line,column:S.column};R<m;)s.charCodeAt(R)===10?(S.line++,S.column=1):S.column++,R++;return Rc[m]=S,S}function Bl(m,S){var R=UP(m),L=UP(S);return{start:{offset:m,line:R.line,column:R.column},end:{offset:S,line:L.line,column:L.column}}}function k(m){P<Mi||(P>Mi&&(Mi=P,Qf=[]),Qf.push(m))}function AT(m,S){return new Uo(m,null,null,S)}function zP(m,S,R){return new Uo(Uo.buildMessage(m,S),m,S,R)}function HP(){var m,S;if(m=[],S=WP(),S!==t)for(;S!==t;)m.push(S),S=WP();else m=t;return m}function WP(){var m,S,R,L,G,U,Y,it,nt,Gi,Gr,rg,n0;return m=P,S=Ue(),S!==t?(s.substr(P,6).toLowerCase()===o?(R=s.substr(P,6),P+=6):(R=t,D===0&&k(a)),R===t&&(R=null),R!==t?(L=Ue(),L!==t?(s.substr(P,5).toLowerCase()===l?(G=s.substr(P,5),P+=5):(G=t,D===0&&k(u)),G===t&&(s.substr(P,7).toLowerCase()===c?(G=s.substr(P,7),P+=7):(G=t,D===0&&k(h))),G!==t?(U=Ue(),U!==t?(Y=Di(),Y===t&&(Y=null),Y!==t?(it=Ue(),it!==t?(s.charCodeAt(P)===123?(nt=d,P++):(nt=t,D===0&&k(p)),nt!==t?(Gi=jP(),Gi===t&&(Gi=null),Gi!==t?(Gr=Ue(),Gr!==t?(s.charCodeAt(P)===125?(rg=y,P++):(rg=t,D===0&&k(x)),rg!==t?(n0=Ue(),n0!==t?(te=m,S=A(R,G,Y,Gi),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function jP(){var m,S,R,L,G,U,Y,it,nt,Gi,Gr;if(m=P,S=Ue(),S!==t)if(R=Zf(),R!==t)if(L=Ue(),L!==t)if(s.charCodeAt(P)===59?(G=T,P++):(G=t,D===0&&k(I)),G===t&&(G=null),G!==t){for(U=[],Y=P,it=Ue(),it!==t?(nt=Zf(),nt!==t?(Gi=Ue(),Gi!==t?(s.charCodeAt(P)===59?(Gr=T,P++):(Gr=t,D===0&&k(I)),Gr===t&&(Gr=null),Gr!==t?(te=Y,it=B(R,nt),Y=it):(P=Y,Y=t)):(P=Y,Y=t)):(P=Y,Y=t)):(P=Y,Y=t);Y!==t;)U.push(Y),Y=P,it=Ue(),it!==t?(nt=Zf(),nt!==t?(Gi=Ue(),Gi!==t?(s.charCodeAt(P)===59?(Gr=T,P++):(Gr=t,D===0&&k(I)),Gr===t&&(Gr=null),Gr!==t?(te=Y,it=B(R,nt),Y=it):(P=Y,Y=t)):(P=Y,Y=t)):(P=Y,Y=t)):(P=Y,Y=t);U!==t?(te=m,S=w(R,U),m=S):(P=m,m=t)}else P=m,m=t;else P=m,m=t;else P=m,m=t;else P=m,m=t;return m}function Zf(){var m,S,R,L,G,U;return m=P,S=Di(),S!==t?(R=Ue(),R!==t?(s.charCodeAt(P)===61?(L=M,P++):(L=t,D===0&&k(F)),L!==t?(G=Ue(),G!==t?(U=Di(),U!==t?(te=m,S=z(S,U),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m===t&&(m=vT(),m===t&&(m=TT(),m===t&&(m=Jf(),m===t&&(m=IT(),m===t&&(m=P,S=Di(),S!==t?(s.charCodeAt(P)===61?(R=M,P++):(R=t,D===0&&k(F)),R!==t?(L=Di(),L!==t?(S=[S,R,L],m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)))))),m}function vT(){var m,S,R;return m=P,s.substr(P,5).toLowerCase()===l?(S=s.substr(P,5),P+=5):(S=t,D===0&&k(u)),S===t&&(s.substr(P,4).toLowerCase()===se?(S=s.substr(P,4),P+=4):(S=t,D===0&&k(pe)),S===t&&(s.substr(P,4).toLowerCase()===de?(S=s.substr(P,4),P+=4):(S=t,D===0&&k(Ae)))),S!==t?(R=Bc(),R!==t?(te=m,S=$e(S,R),m=S):(P=m,m=t)):(P=m,m=t),m}function Bc(){var m,S,R,L,G,U,Y,it,nt;return m=P,S=Ue(),S!==t?(s.charCodeAt(P)===91?(R=ge,P++):(R=t,D===0&&k(me)),R!==t?(L=Ue(),L!==t?(G=qP(),G===t&&(G=null),G!==t?(U=Ue(),U!==t?(s.charCodeAt(P)===93?(Y=J,P++):(Y=t,D===0&&k(bn)),Y!==t?(it=Ue(),it!==t?(nt=Bc(),nt===t&&(nt=null),nt!==t?(te=m,S=zA(G,nt),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function qP(){var m,S,R,L,G,U,Y,it;return m=P,S=Ue(),S!==t?(R=Di(),R!==t?(L=P,G=Ue(),G!==t?(s.charCodeAt(P)===61?(U=M,P++):(U=t,D===0&&k(F)),U!==t?(Y=Ue(),Y!==t?(it=Di(),it!==t?(te=L,G=HA(R,it),L=G):(P=L,L=t)):(P=L,L=t)):(P=L,L=t)):(P=L,L=t),L===t&&(L=null),L!==t?(G=Ue(),G!==t?(s.charCodeAt(P)===44?(U=WA,P++):(U=t,D===0&&k(jA)),U===t&&(s.charCodeAt(P)===59?(U=T,P++):(U=t,D===0&&k(I))),U===t&&(U=null),U!==t?(Y=qP(),Y===t&&(Y=null),Y!==t?(te=m,S=qA(R,L,Y),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function TT(){var m,S,R,L;return m=P,S=Jf(),S===t&&(S=Kf()),S!==t?(R=XP(),R!==t?(L=Bc(),L===t&&(L=null),L!==t?(te=m,S=XA(S,R,L),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function XP(){var m,S,R,L,G,U,Y;return m=P,S=Ue(),S!==t?(s.substr(P,2)===SP?(R=SP,P+=2):(R=t,D===0&&k(YA)),R===t&&(s.substr(P,2)===EP?(R=EP,P+=2):(R=t,D===0&&k($A))),R!==t?(L=Ue(),L!==t?(G=Jf(),G===t&&(G=Kf()),G!==t?(U=Ue(),U!==t?(Y=XP(),Y===t&&(Y=null),Y!==t?(te=m,S=QA(R,G,Y),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function IT(){var m,S,R;return m=P,S=Kf(),S!==t?(R=Bc(),R===t&&(R=null),R!==t?(te=m,S=ZA(S,R),m=S):(P=m,m=t)):(P=m,m=t),m}function Kf(){var m,S,R;return m=P,S=Di(),S!==t?(R=wT(),R===t&&(R=null),R!==t?(te=m,S=KA(S,R),m=S):(P=m,m=t)):(P=m,m=t),m}function wT(){var m,S,R,L,G,U;return D++,m=P,s.charCodeAt(P)===58?(S=Uf,P++):(S=t,D===0&&k(zf)),S!==t?(R=Di(),R!==t?(L=P,s.charCodeAt(P)===58?(G=Uf,P++):(G=t,D===0&&k(zf)),G!==t?(U=YP(),U!==t?(te=L,G=ev(R,U),L=G):(P=L,L=t)):(P=L,L=t),L===t&&(L=null),L!==t?(te=m,S=tv(R,L),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m===t&&(m=P,s.charCodeAt(P)===58?(S=Uf,P++):(S=t,D===0&&k(zf)),S!==t?(R=YP(),R!==t?(te=m,S=rv(R),m=S):(P=m,m=t)):(P=m,m=t)),D--,m===t&&(S=t,D===0&&k(JA)),m}function Jf(){var m,S,R,L,G,U;return m=P,S=P,s.substr(P,8).toLowerCase()===iv?(R=s.substr(P,8),P+=8):(R=t,D===0&&k(nv)),R!==t?(L=Ue(),L!==t?(G=Di(),G===t&&(G=null),G!==t?(U=Ue(),U!==t?(te=S,R=ov(G),S=R):(P=S,S=t)):(P=S,S=t)):(P=S,S=t)):(P=S,S=t),S===t&&(S=null),S!==t?(s.charCodeAt(P)===123?(R=d,P++):(R=t,D===0&&k(p)),R!==t?(L=jP(),L===t&&(L=null),L!==t?(G=Ue(),G!==t?(s.charCodeAt(P)===125?(U=y,P++):(U=t,D===0&&k(x)),U!==t?(te=m,S=sv(S,L),m=S):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function YP(){var m;return s.charCodeAt(P)===110?(m=av,P++):(m=t,D===0&&k(lv)),m===t&&(s.substr(P,2)===xP?(m=xP,P+=2):(m=t,D===0&&k(uv)),m===t&&(s.charCodeAt(P)===101?(m=cv,P++):(m=t,D===0&&k(hv)),m===t&&(s.substr(P,2)===CP?(m=CP,P+=2):(m=t,D===0&&k(dv)),m===t&&(s.charCodeAt(P)===115?(m=fv,P++):(m=t,D===0&&k(gv)),m===t&&(s.substr(P,2)===AP?(m=AP,P+=2):(m=t,D===0&&k(pv)),m===t&&(s.charCodeAt(P)===119?(m=mv,P++):(m=t,D===0&&k(bv)),m===t&&(s.substr(P,2)===vP?(m=vP,P+=2):(m=t,D===0&&k(Pv))))))))),m}function Di(){var m;return m=$P(),m===t&&(m=LT(),m===t&&(m=KP(),m===t&&(m=OT(),m===t&&(m=RT())))),m}function $P(){var m,S,R,L;if(D++,m=P,S=QP(),S!==t){for(R=[],L=ZP();L!==t;)R.push(L),L=ZP();R!==t?(te=m,S=Sv(S,R),m=S):(P=m,m=t)}else P=m,m=t;return D--,m===t&&(S=t,D===0&&k(yv)),m}function LT(){var m,S,R;return m=P,S=KP(),S!==t?(R=$P(),R!==t?(te=m,S=Ev(S,R),m=S):(P=m,m=t)):(P=m,m=t),m}function QP(){var m;return m=kT(),m===t&&(s.charCodeAt(P)===36?(m=xv,P++):(m=t,D===0&&k(Cv)),m===t&&(s.charCodeAt(P)===95?(m=Av,P++):(m=t,D===0&&k(vv)))),m}function ZP(){var m;return m=QP(),m===t&&(m=XT()),m}function KP(){var m,S,R,L,G,U,Y,it,nt;if(D++,m=P,S=P,s.charCodeAt(P)===45?(R=Iv,P++):(R=t,D===0&&k(wv)),R===t&&(R=null),R!==t){if(L=P,s.charCodeAt(P)===46?(G=TP,P++):(G=t,D===0&&k(IP)),G!==t){if(U=[],ta.test(s.charAt(P))?(Y=s.charAt(P),P++):(Y=t,D===0&&k(ra)),Y!==t)for(;Y!==t;)U.push(Y),ta.test(s.charAt(P))?(Y=s.charAt(P),P++):(Y=t,D===0&&k(ra));else U=t;U!==t?(G=[G,U],L=G):(P=L,L=t)}else P=L,L=t;if(L===t){if(L=P,G=[],ta.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(ra)),U!==t)for(;U!==t;)G.push(U),ta.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(ra));else G=t;if(G!==t){if(U=P,s.charCodeAt(P)===46?(Y=TP,P++):(Y=t,D===0&&k(IP)),Y!==t){for(it=[],ta.test(s.charAt(P))?(nt=s.charAt(P),P++):(nt=t,D===0&&k(ra));nt!==t;)it.push(nt),ta.test(s.charAt(P))?(nt=s.charAt(P),P++):(nt=t,D===0&&k(ra));it!==t?(Y=[Y,it],U=Y):(P=U,U=t)}else P=U,U=t;U===t&&(U=null),U!==t?(G=[G,U],L=G):(P=L,L=t)}else P=L,L=t}L!==t?(R=[R,L],S=R):(P=S,S=t)}else P=S,S=t;return S!==t&&(te=m,S=Lv(S)),m=S,D--,m===t&&(S=t,D===0&&k(Tv)),m}function RT(){var m,S;return m=P,S=eg(),S!==t&&(te=m,S=Rv(S)),m=S,m}function eg(){var m,S,R,L;if(m=P,s.charCodeAt(P)===60?(S=Hf,P++):(S=t,D===0&&k(Wf)),S!==t){for(R=[],L=JP(),L===t&&(L=eg());L!==t;)R.push(L),L=JP(),L===t&&(L=eg());R!==t?(s.charCodeAt(P)===62?(L=jf,P++):(L=t,D===0&&k(qf)),L!==t?(te=m,S=Ov(R),m=S):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return m}function JP(){var m,S,R,L,G;if(m=P,S=[],R=P,L=P,D++,s.charCodeAt(P)===62?(G=jf,P++):(G=t,D===0&&k(qf)),G===t&&(s.charCodeAt(P)===60?(G=Hf,P++):(G=t,D===0&&k(Wf))),D--,G===t?L=void 0:(P=L,L=t),L!==t?(s.length>P?(G=s.charAt(P),P++):(G=t,D===0&&k(Bi)),G!==t?(te=R,L=ia(G),R=L):(P=R,R=t)):(P=R,R=t),R!==t)for(;R!==t;)S.push(R),R=P,L=P,D++,s.charCodeAt(P)===62?(G=jf,P++):(G=t,D===0&&k(qf)),G===t&&(s.charCodeAt(P)===60?(G=Hf,P++):(G=t,D===0&&k(Wf))),D--,G===t?L=void 0:(P=L,L=t),L!==t?(s.length>P?(G=s.charAt(P),P++):(G=t,D===0&&k(Bi)),G!==t?(te=R,L=ia(G),R=L):(P=R,R=t)):(P=R,R=t);else S=t;return S!==t&&(te=m,S=Bv(S)),m=S,m}function OT(){var m,S,R,L;if(m=P,s.charCodeAt(P)===34?(S=Xf,P++):(S=t,D===0&&k(Yf)),S!==t){for(R=[],L=e0();L!==t;)R.push(L),L=e0();R!==t?(s.charCodeAt(P)===34?(L=Xf,P++):(L=t,D===0&&k(Yf)),L!==t?(te=m,S=wP(R),m=S):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return m}function e0(){var m,S,R;return m=BT(),m===t&&(m=P,S=P,D++,s.charCodeAt(P)===34?(R=Xf,P++):(R=t,D===0&&k(Yf)),R===t&&(R=NT()),D--,R===t?S=void 0:(P=S,S=t),S!==t?(R=GT(),R!==t?(te=m,S=Mv(),m=S):(P=m,m=t)):(P=m,m=t),m===t&&(m=MT())),m}function BT(){var m,S,R,L;return m=P,S=P,s.charCodeAt(P)===92?(R=wc,P++):(R=t,D===0&&k(Lc)),R!==t?(s.length>P?(L=s.charAt(P),P++):(L=t,D===0&&k(Bi)),L!==t?(R=[R,L],S=R):(P=S,S=t)):(P=S,S=t),S!==t&&(te=m,S=Nv(S)),m=S,m}function MT(){var m,S,R;return m=P,s.charCodeAt(P)===92?(S=wc,P++):(S=t,D===0&&k(Lc)),S!==t?(R=DT(),R!==t?(te=m,S=LP(),m=S):(P=m,m=t)):(P=m,m=t),m}function NT(){var m;return Dv.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(Gv)),m}function DT(){var m,S;return D++,s.charCodeAt(P)===10?(m=Fv,P++):(m=t,D===0&&k(Vv)),m===t&&(s.substr(P,2)===RP?(m=RP,P+=2):(m=t,D===0&&k(kv)),m===t&&(s.charCodeAt(P)===13?(m=Uv,P++):(m=t,D===0&&k(zv)),m===t&&(s.charCodeAt(P)===8232?(m=Hv,P++):(m=t,D===0&&k(Wv)),m===t&&(s.charCodeAt(P)===8233?(m=jv,P++):(m=t,D===0&&k(qv)))))),D--,m===t&&(S=t,D===0&&k(_v)),m}function GT(){var m;return s.length>P?(m=s.charAt(P),P++):(m=t,D===0&&k(Bi)),m}function wG(){var m,S,R;if(m=P,S=[],R=t0(),R!==t)for(;R!==t;)S.push(R),R=t0();else S=t;return S!==t&&(te=m,S=wP(S)),m=S,m}function t0(){var m,S,R;return Xv.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(Yv)),m===t&&(m=P,s.substr(P,2)===OP?(S=OP,P+=2):(S=t,D===0&&k($v)),S!==t&&(te=m,S=Qv()),m=S,m===t&&(m=P,s.charCodeAt(P)===92?(S=wc,P++):(S=t,D===0&&k(Lc)),S!==t?(R=tg(),R!==t?(te=m,S=LP(),m=S):(P=m,m=t)):(P=m,m=t),m===t&&(m=P,s.charCodeAt(P)===92?(S=wc,P++):(S=t,D===0&&k(Lc)),S!==t&&(te=m,S=Zv()),m=S))),m}function r0(){var m,S;return D++,m=_T(),m===t&&(m=FT(),m===t&&(m=VT())),D--,m===t&&(S=t,D===0&&k(Kv)),m}function _T(){var m,S,R,L,G,U;if(D++,m=P,s.substr(P,2)===BP?(S=BP,P+=2):(S=t,D===0&&k(eT)),S!==t){for(R=[],L=P,G=P,D++,s.substr(P,2)===na?(U=na,P+=2):(U=t,D===0&&k($f)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=MP(U),L=G):(P=L,L=t)):(P=L,L=t);L!==t;)R.push(L),L=P,G=P,D++,s.substr(P,2)===na?(U=na,P+=2):(U=t,D===0&&k($f)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=MP(U),L=G):(P=L,L=t)):(P=L,L=t);R!==t?(s.substr(P,2)===na?(L=na,P+=2):(L=t,D===0&&k($f)),L!==t?(te=m,S=tT(R),m=S):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return D--,m===t&&(S=t,D===0&&k(Jv)),m}function FT(){var m,S,R,L,G,U;if(D++,m=P,s.substr(P,2)===NP?(S=NP,P+=2):(S=t,D===0&&k(iT)),S!==t){for(R=[],L=P,G=P,D++,oa.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(sa)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=ia(U),L=G):(P=L,L=t)):(P=L,L=t);L!==t;)R.push(L),L=P,G=P,D++,oa.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(sa)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=ia(U),L=G):(P=L,L=t)):(P=L,L=t);R!==t?(oa.test(s.charAt(P))?(L=s.charAt(P),P++):(L=t,D===0&&k(sa)),L===t&&(L=null),L!==t?(te=m,S=DP(R),m=S):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return D--,m===t&&(S=t,D===0&&k(rT)),m}function VT(){var m,S,R,L,G,U;if(D++,m=P,s.charCodeAt(P)===35?(S=oT,P++):(S=t,D===0&&k(sT)),S!==t){for(R=[],L=P,G=P,D++,oa.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(sa)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=ia(U),L=G):(P=L,L=t)):(P=L,L=t);L!==t;)R.push(L),L=P,G=P,D++,oa.test(s.charAt(P))?(U=s.charAt(P),P++):(U=t,D===0&&k(sa)),D--,U===t?G=void 0:(P=G,G=t),G!==t?(s.length>P?(U=s.charAt(P),P++):(U=t,D===0&&k(Bi)),U!==t?(te=L,G=ia(U),L=G):(P=L,L=t)):(P=L,L=t);R!==t?(oa.test(s.charAt(P))?(L=s.charAt(P),P++):(L=t,D===0&&k(sa)),L===t&&(L=null),L!==t?(te=m,S=DP(R),m=S):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return D--,m===t&&(S=t,D===0&&k(nT)),m}function Ue(){var m,S;for(D++,m=[],S=i0(),S===t&&(S=r0());S!==t;)m.push(S),S=i0(),S===t&&(S=r0());return D--,m===t&&(S=t,D===0&&k(aT)),m}function tg(){var m,S;if(m=[],GP.test(s.charAt(P))?(S=s.charAt(P),P++):(S=t,D===0&&k(_P)),S!==t)for(;S!==t;)m.push(S),GP.test(s.charAt(P))?(S=s.charAt(P),P++):(S=t,D===0&&k(_P));else m=t;return m}function i0(){var m,S;if(m=[],FP.test(s.charAt(P))?(S=s.charAt(P),P++):(S=t,D===0&&k(VP)),S===t&&(S=tg()),S!==t)for(;S!==t;)m.push(S),FP.test(s.charAt(P))?(S=s.charAt(P),P++):(S=t,D===0&&k(VP)),S===t&&(S=tg());else m=t;return m}function kT(){var m;return m=jT(),m===t&&(m=UT(),m===t&&(m=WT(),m===t&&(m=zT(),m===t&&(m=HT(),m===t&&(m=qT()))))),m}function UT(){var m;return lT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(uT)),m}function zT(){var m;return cT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(hT)),m}function HT(){var m;return dT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(fT)),m}function WT(){var m;return gT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(pT)),m}function jT(){var m;return mT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(bT)),m}function qT(){var m;return PT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(yT)),m}function XT(){var m;return ST.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,D===0&&k(ET)),m}if(Oc=n(),Oc!==t&&P===s.length)return Oc;throw Oc!==t&&P<s.length&&k(CT()),zP(Qf,Mi<s.length?s.charAt(Mi):null,Mi<s.length?Bl(Mi,Mi+1):Bl(Mi,Mi))}s0.exports={SyntaxError:Uo,parse:iI}});var u0=be((BG,l0)=>{var nI=a0();l0.exports=nI.parse});var ng=be(Mc=>{"use strict";Object.defineProperty(Mc,"__esModule",{value:!0});var c0=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,i=!1){if(i&&this.isDuplicate(e))return!1;let n=new Ml(e),o=this._head;if(o)for(;;){if(o.value===t)return n.next=o.next,n.prev=o,o.next=n,n.next?n.next.prev=n:this._tail=n,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Ml(e);return this._tail?(this._tail.next=i,i.prev=this._tail,this._tail=i):this._head=this._tail=i,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Ml(e);return this._head?(i.next=this._head,this._head.prev=i,this._head=i):this._head=this._tail=i,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),i=[],n=Math.min(e,this.length);for(let o=0;o<n;o++){let a=t.next();i.push(a.value)}return i}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Mc.LinkedList=c0;var Ml=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Mc.LinkedListItem=Ml});var Xn=be(og=>{"use strict";Object.defineProperty(og,"__esModule",{value:!0});var oI=ng(),h0=class extends oI.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};og.Queue=h0});var ei=be(hg=>{"use strict";Object.defineProperty(hg,"__esModule",{value:!0});var fI=ng(),m0=class extends fI.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};hg.Stack=m0});var Pt=be(Jn=>{"use strict";var kc=Jn&&Jn.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,n++)i[n]=o[a];return i};Object.defineProperty(Jn,"__esModule",{value:!0});Jn.StringBuilder=Jn.String=void 0;var da=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{var n=t[0];if(Array.isArray(n)||n instanceof Array){for(var o=s.Empty,a=0,l=0;l<n.length;l++){var u=n[l];l<n.length-1?o+=u+e:o+=u}return o}else if(typeof n=="object"){var c=s.Empty,h=n,d=Object.keys(n);return d.forEach(function(y){c+=h[y]+e}),c=c.slice(0,c.length-e.length),c}var p=t;return s.join.apply(s,kc([e],p))}catch(y){return console.log(y),s.Empty}},s.Format=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(n){return console.log(n),s.Empty}},s.format=function(e,t,i,n){return n===void 0&&(n=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return n?u=i[0][a]:u=i[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var i=t.replace(/,/g,".");if(isNaN(parseFloat(i))||i.length<=3)break;var n=i.split(/[^0-9]+/g),o=n;n.length>1&&(o=[s.join.apply(s,kc([""],n.splice(0,n.length-1))),n[n.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var i=parseFloat(e),n=i.toString(16);return t?n.toLocaleUpperCase():n},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var i=t[t.length-1],n=t[t.length-2],o=t[t.length-3];return i=i.split("T")[0],i=i.split(" ")[0],i+"."+n+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var i=t[t.length-1].split(" "),n=s.Empty;i.length>1&&(n=i[i.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(n)&&n.length>1?u+="T"+n:u+="T00:00:00",u},s.formatNumber=function(e,t){var i=t.length,n=e.toString();if(i<=n.length)return n;var o=i-n.length;return o+=1,new Array(o).join("0")+n},s.join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var n=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];n+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){n+=e,o=l-1;break}}return n},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();Jn.String=da;var yI=function(){function s(e){this.Values=[],da.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(da.Format.apply(da,kc([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(`\r
`+da.Format.apply(da,kc([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();Jn.StringBuilder=yI});var eo=be(Be=>{"use strict";Object.defineProperty(Be,"__esModule",{value:!0});Be.isPrimitive=Be.isPropertyKey=Be.isString=Be.isBoolean=Be.isNumber=Be.isIterator=Be.isAsyncIterable=Be.isIterable=Be.isDefined=Be.isMissing=Be.isInstance=Be.isObject=Be.isFunctionOrUndefined=Be.isFunction=void 0;function w0(s){return typeof s=="function"}Be.isFunction=w0;function Uc(s){return typeof s=="function"||s===void 0}Be.isFunctionOrUndefined=Uc;function L0(s){return typeof s=="object"&&s!==null||typeof s=="function"}Be.isObject=L0;function xI(s,e){return!R0(s)&&s instanceof e}Be.isInstance=xI;function R0(s){return s==null}Be.isMissing=R0;function CI(s){return s!=null}Be.isDefined=CI;function AI(s){return s!=null&&Symbol.iterator in Object(s)}Be.isIterable=AI;function vI(s){return s!=null&&Symbol.asyncIterator in Object(s)}Be.isAsyncIterable=vI;function TI(s){return L0(s)&&w0(s.next)&&Uc(s.throw)&&Uc(s.return)&&Uc(s[Symbol.iterator])}Be.isIterator=TI;function II(s){return typeof s=="number"}Be.isNumber=II;function wI(s){return typeof s=="boolean"}Be.isBoolean=wI;function LI(s){return typeof s=="string"}Be.isString=LI;function RI(s){return typeof s=="string"||typeof s=="symbol"||typeof s=="number"}Be.isPropertyKey=RI;function OI(s){return typeof s!="function"&&(typeof s!="object"||s===null)}Be.isPrimitive=OI});var Pg=be(zc=>{"use strict";Object.defineProperty(zc,"__esModule",{value:!0});zc.binarySearch=void 0;function BI(s,e,t){if(s.length===0)return-1;let i=0,n=s.length-1;for(;i<=n;){let o=i+(n-i>>1),a=s[o];switch(Math.sign(t.compare(a,e))){case-1:i=o+1;break;case 0:return o;case 1:n=o-1;break}}return~i}zc.binarySearch=BI});var O0=be(ba=>{"use strict";Object.defineProperty(ba,"__esModule",{value:!0});ba.deprecateProperty=ba.deprecate=void 0;function MI(){try{return JT("util").deprecate}catch{}}function NI(){let s=typeof process=="object"&&typeof process.emitWarning=="function"?function e(t,i="Warning",n=e){process.emitWarning(t,i,n)}:typeof Error.captureStackTrace=="function"?function e(t,i="Warning",n=e){typeof t=="string"&&(t=new Error(t),t.name=i),Error.captureStackTrace(t,n),console.warn(t)}:function(t,i="Warning"){typeof t=="string"?console.warn(`${i}:`,t):console.warn(t)};return(e,t)=>{let i=!1;function n(...o){return i||(i=!0,s(t,"DeprecationWarning",e)),new.target?Reflect.construct(e,o,new.target):e.apply(this,o)}return Object.setPrototypeOf(n,e),e.prototype&&(n.prototype=e.prototype),n}}var DI=MI()||NI();function Hc(s,e){return DI(s,e)}ba.deprecate=Hc;function GI(s,e,t){let i=Object.getOwnPropertyDescriptor(s,e);if(i&&i.configurable){let n=!1;i.get&&(i.get=Hc(i.get,t),n=!0),i.set&&(i.set=Hc(i.set,t),n=!0),typeof i.value=="function"&&(i.value=Hc(i.value,t),n=!0),n&&Object.defineProperty(s,e,i)}return s}ba.deprecateProperty=GI});var Yo=be(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.KeyedMultiCollection=_e.ReadonlyKeyedMultiCollection=_e.KeyedCollection=_e.ReadonlyKeyedCollection=_e.IndexedCollection=_e.FixedSizeIndexedCollection=_e.ReadonlyIndexedCollection=_e.Collection=_e.ReadonlyCollection=void 0;var Wc=eo(),vt=O0(),er;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has");function e(i){return Wc.isIterable(i)&&s.size in i&&s.has in i}s.isReadonlyCollection=e,s.name="ReadonlyCollection";function t(i){return Wc.isIterable(i)&&s.size in i&&s.has in i}s.hasInstance=t})(er=_e.ReadonlyCollection||(_e.ReadonlyCollection={}));var qo;(function(s){s.size=er.size,s.has=er.has,s.isReadonlyCollection=er.isReadonlyCollection,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.clear=Symbol.for("@esfx/collection-core!Collection.clear");function e(i){return s.hasInstance(i)}s.isCollection=e,s.name="Collection";function t(i){return er.hasInstance(i)&&s.add in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(qo=_e.Collection||(_e.Collection={}));var Hi;(function(s){s.size=er.size,s.has=er.has,s.isReadonlyCollection=er.isReadonlyCollection,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt");function e(i){return s.hasInstance(i)}s.isReadonlyIndexedCollection=e,s.name="ReadonlyIndexedCollection";function t(i){return er.hasInstance(i)&&s.indexOf in i&&s.getAt in i}s.hasInstance=t})(Hi=_e.ReadonlyIndexedCollection||(_e.ReadonlyIndexedCollection={}));var Xo;(function(s){s.size=er.size,s.has=er.has,s.isReadonlyCollection=er.isReadonlyCollection,s.indexOf=Hi.indexOf,s.getAt=Hi.getAt,s.isReadonlyIndexedCollection=Hi.isReadonlyIndexedCollection,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt");function e(i){return s.hasInstance(i)}s.isFixedSizeIndexedCollection=e,s.name="FixedSizeIndexedCollection";function t(i){return Hi.hasInstance(i)&&s.setAt in i}s.hasInstance=t})(Xo=_e.FixedSizeIndexedCollection||(_e.FixedSizeIndexedCollection={}));var Pa;(function(s){s.size=er.size,s.has=er.has,s.isReadonlyCollection=er.isReadonlyCollection,s.indexOf=Hi.indexOf,s.getAt=Hi.getAt,s.isReadonlyIndexedCollection=Hi.isReadonlyIndexedCollection,s.setAt=Xo.setAt,s.isFixedSizeIndexedCollection=Xo.isFixedSizeIndexedCollection,s.add=qo.add,s.delete=qo.delete,s.clear=qo.clear,s.isCollection=qo.isCollection,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt");function e(i){return s.hasInstance(i)}s.isIndexedCollection=e,s.name="IndexedCollection";function t(i){return Xo.hasInstance(i)&&s.insertAt in i&&s.removeAt in i}s.hasInstance=t})(Pa=_e.IndexedCollection||(_e.IndexedCollection={}));var Sn;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedCollection=e,s.name="ReadonlyKeyedCollection";function t(i){return Wc.isIterable(i)&&s.size in i&&s.has in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(Sn=_e.ReadonlyKeyedCollection||(_e.ReadonlyKeyedCollection={}));var yg;(function(s){s.size=Sn.size,s.has=Sn.has,s.get=Sn.get,s.keys=Sn.keys,s.values=Sn.values,s.isReadonlyKeyedCollection=Sn.isReadonlyKeyedCollection,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedCollection=e,s.name="KeyedCollection";function t(i){return Sn.hasInstance(i)&&s.set in i&&s.delete in i&&s.clear in i}s.hasInstance=t})(yg=_e.KeyedCollection||(_e.KeyedCollection={}));var zi;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values");function e(i){return s.hasInstance(i)}s.isReadonlyKeyedMultiCollection=e,s.name="ReadonlyKeyedMultiCollection";function t(i){return Wc.isIterable(i)&&s.size in i&&s.has in i&&s.hasValue in i&&s.get in i&&s.keys in i&&s.values in i}s.hasInstance=t})(zi=_e.ReadonlyKeyedMultiCollection||(_e.ReadonlyKeyedMultiCollection={}));var Sg;(function(s){s.size=zi.size,s.has=zi.has,s.hasValue=zi.hasValue,s.get=zi.get,s.keys=zi.keys,s.values=zi.values,s.isReadonlyKeyedMultiCollection=zi.isReadonlyKeyedMultiCollection,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear");function e(i){return s.hasInstance(i)}s.isKeyedMultiCollection=e,s.name="KeyedMultiCollection";function t(i){return zi.hasInstance(i)&&s.add in i&&s.delete in i&&s.deleteValue in i&&s.clear in i}s.hasInstance=t})(Sg=_e.KeyedMultiCollection||(_e.KeyedMultiCollection={}));vt.deprecateProperty(er,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");vt.deprecateProperty(qo,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");vt.deprecateProperty(qo,"isCollection","Use 'Collection.hasInstance' instead.");vt.deprecateProperty(Hi,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");vt.deprecateProperty(Hi,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");vt.deprecateProperty(Xo,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");vt.deprecateProperty(Xo,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");vt.deprecateProperty(Xo,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");vt.deprecateProperty(Pa,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");vt.deprecateProperty(Pa,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");vt.deprecateProperty(Pa,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");vt.deprecateProperty(Pa,"isCollection","Use 'Collection.hasInstance' instead.");vt.deprecateProperty(Pa,"isIndexedCollection","Use 'IndexedCollection.hasInstance' instead.");vt.deprecateProperty(Sn,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");vt.deprecateProperty(yg,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");vt.deprecateProperty(yg,"isKeyedCollection","Use 'KeyedCollection.hasInstance' instead.");vt.deprecateProperty(zi,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");vt.deprecateProperty(Sg,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");vt.deprecateProperty(Sg,"isKeyedMultiCollection","Use 'KeyedMultiCollection.hasInstance' instead.")});var D0=be(to=>{"use strict";Object.defineProperty(to,"__esModule",{value:!0});to.hash=to.defaultSeed=to.createSeed=void 0;function N0(){return Math.random()*4294967295>>>0}to.createSeed=N0;to.defaultSeed=N0();var B0=3432918353,M0=461845907,_I=3864292196;function FI(s,e){let t=new DataView(s),i=e>>>0,n=0,o;for(;n<t.byteLength-4;)o=t.getUint32(n,!0),o*=B0,o=o<<15|o>>>17,o*=M0,i^=o,i=i<<13|i>>>19,i=i*5+_I,n+=4;if(n<t.byteLength){switch(o=0,t.byteLength-n){case 3:o|=t.getUint8(n+2)<<16;case 2:o|=t.getUint8(n+1)<<8;case 1:o|=t.getUint8(n+0)<<0}o*=B0,o=o<<15|o>>>17,o*=M0,i^=o}return i^=t.byteLength,i^=i>>>16,i*=2246822507,i^=i>>>13,i*=3266489909,i^=i>>>16,i}to.hash=FI});var W0=be(ya=>{"use strict";Object.defineProperty(ya,"__esModule",{value:!0});ya.hashUnknown=void 0;var Sa=D0(),$o,jc,Hl,Qo,Zo,Ko,_0=2**31-1,VI=~_0,kI=2**32-1,UI=0,Eg=new DataView(new ArrayBuffer(8)),F0=Sa.createSeed(),V0=Sa.createSeed(),k0=Sa.createSeed(),U0=Sa.createSeed(),z0=Sa.createSeed(),xg=F0,Cg=V0,Ag=z0,vg=k0,Tg=U0;function zI(s){return s?1:0}function HI(s){return Number.isInteger(s)&&s>=VI&&s<=_0}function WI(s){return Number.isInteger(s)&&s>=UI&&s<=kI}function jI(s){return s>>0}function qI(s){return Eg.setFloat64(0,s),Eg.getInt32(0,!0)^Eg.getInt32(4,!0)}function XI(s){return HI(s)?s:WI(s)?jI(s):qI(s)}function YI(s,e){let t=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);return Sa.hash(t,e)}function qc(s,e,t){if(!Buffer.isEncoding(e))throw new RangeError(`Invalid encoding: ${e}`);return YI(Buffer.from(s,e),t)}function Ig(s,e){return(s<<7|s>>>25)^e}function $I(){let s=BigInt(0),e=BigInt(4294967295),t=BigInt(32);function i(n){if(n===s)return 0;let o=n<s?-1:n>s?1:0;for(n<s&&(n=-n);n!==s;)o=Ig(o,Number(n&e)),n=n>>t;return o}return i}function QI(){function s(e){return qc(e.toString(),"ascii",Ag)}return s}var ZI=typeof BigInt=="function"?$I():QI();function KI(s){return qc(s,"utf8",Cg)}function JI(s,e){let t=Zo&&Zo.get(s);return t===void 0&&(t=qc(e,"utf8",Tg),Zo||(Zo=new Map),Zo.set(s,t)),t}var ew="description"in Symbol.prototype?s=>s.description:s=>{let e=s.toString();return e.startsWith("Symbol(")&&e.endsWith(")")?e.slice(7,-1):e};function tw(s){let e=Ko&&Ko.get(s);if(e===void 0){Hl||(Hl={next:1}),e=Ig(vg,Hl.next++);let t=ew(s);t&&(e=qc(t,"utf8",e)),Ko||(Ko=new Map),Ko.set(s,e)}return e}function rw(s){let e=Symbol.keyFor(s);return e!==void 0?JI(s,e):tw(s)}function iw(s){let e;return s===null?e=jc||(jc={next:1}):(e=$o&&$o.get(s),e||($o||($o=new WeakMap),$o.set(s,e={next:1}))),e}function G0(s){let e=Qo&&Qo.get(s);return e===void 0&&(Qo||(Qo=new WeakMap),e=iw(Object.getPrototypeOf(s)).next++,e=Ig(xg,e),Qo.set(s,e)),e}function H0(s){switch(typeof s){case"boolean":return zI(s);case"number":return XI(s);case"bigint":return ZI(s);case"string":return KI(s);case"symbol":return rw(s);case"function":return G0(s);case"object":if(s!==null)return G0(s);case"undefined":default:return 0}}ya.hashUnknown=H0;(function(s){function e(){return{weakPrototypeCounters:$o,nullPrototypeCounter:jc,localSymbolCounter:Hl,weakObjectHashes:Qo,globalSymbolHashes:Zo,localSymbolHashes:Ko,objectSeed:xg,stringSeed:Cg,bigIntSeed:Ag,localSymbolSeed:vg,globalSymbolSeed:Tg}}s.getState=e;function t(i){({weakPrototypeCounters:$o,nullPrototypeCounter:jc,localSymbolCounter:Hl,weakObjectHashes:Qo,globalSymbolHashes:Zo,localSymbolHashes:Ko,objectSeed:xg=F0,stringSeed:Cg=V0,bigIntSeed:Ag=z0,localSymbolSeed:vg=k0,globalSymbolSeed:Tg=U0}=i)}s.setState=t})(H0=ya.hashUnknown||(ya.hashUnknown={}))});var Jo=be(ie=>{"use strict";Object.defineProperty(ie,"__esModule",{value:!0});ie.rawHash=ie.tupleStructuralComparer=ie.tupleComparer=ie.structuralComparer=ie.defaultComparer=ie.Comparer=ie.combineHashes=ie.tupleStructuralEqualer=ie.tupleEqualer=ie.structuralEqualer=ie.defaultEqualer=ie.Equaler=ie.StructuralComparable=ie.StructuralEquatable=ie.Comparable=ie.Equatable=void 0;var j0=W0(),ro;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let i;return t!=null&&s.equals in(i=Object(t))&&s.hash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(ro=ie.Equatable||(ie.Equatable={}));(function(s){let e=Xc("Use 'Equatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isEquatable=t})(ro=ie.Equatable||(ie.Equatable={}));var Ea;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Ea=ie.Comparable||(ie.Comparable={}));(function(s){let e=Xc("Use 'Comparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isComparable=t})(Ea=ie.Comparable||(ie.Comparable={}));var io;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let i;return t!=null&&s.structuralEquals in(i=Object(t))&&s.structuralHash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(io=ie.StructuralEquatable||(ie.StructuralEquatable={}));(function(s){let e=Xc("Use 'StructuralEquatable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralEquatable=t})(io=ie.StructuralEquatable||(ie.StructuralEquatable={}));var xa;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(xa=ie.StructuralComparable||(ie.StructuralComparable={}));(function(s){let e=Xc("Use 'StructuralComparable.hasInstance' instead.");function t(i){return e(),s.hasInstance(i)}s.isStructuralComparable=t})(xa=ie.StructuralComparable||(ie.StructuralComparable={}));var Ca;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>ro.hasInstance(o)?o[ro.equals](a):ro.hasInstance(a)?a[ro.equals](o):Object.is(o,a),o=>ro.hasInstance(o)?o[ro.hash]():j0.hashUnknown(o)),s.structuralEqualer=t((o,a)=>io.hasInstance(o)?o[io.structuralEquals](a,s.structuralEqualer):io.hasInstance(a)?a[io.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>io.hasInstance(o)?o[io.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function i(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=i;function n(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(Ca=ie.Equaler||(ie.Equaler={}));ie.defaultEqualer=Ca.defaultEqualer;ie.structuralEqualer=Ca.structuralEqualer;ie.tupleEqualer=Ca.tupleEqualer;ie.tupleStructuralEqualer=Ca.tupleEqualer;ie.combineHashes=Ca.combineHashes;var Wl;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((n,o)=>Ea.hasInstance(n)?n[Ea.compareTo](o):Ea.hasInstance(o)?-o[Ea.compareTo](n):n<o?-1:n>o?1:0),s.structuralComparer=t((n,o)=>xa.hasInstance(n)?n[xa.structuralCompareTo](o,s.structuralComparer):xa.hasInstance(o)?-o[xa.structuralCompareTo](n,s.structuralComparer):s.defaultComparer.compare(n,o)),s.tupleComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.defaultComparer.compare(n[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((n,o)=>{if(!Array.isArray(n)&&n!==null&&n!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.structuralComparer.compare(n[l],o[l]))return a;return 0});function t(n){return Object.setPrototypeOf({compare:n},e)}s.create=t;function i(n){return typeof n=="object"&&n!==null&&typeof n.compare=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(Wl=ie.Comparer||(ie.Comparer={}));ie.defaultComparer=Wl.defaultComparer;ie.structuralComparer=Wl.structuralComparer;ie.tupleComparer=Wl.tupleComparer;ie.tupleStructuralComparer=Wl.tupleStructuralComparer;function nw(s){return j0.hashUnknown(s)}ie.rawHash=nw;function Xc(s){let e=!1;return()=>{e||(e=!0,typeof process=="object"&&process.emitWarning?process.emitWarning(s,"Deprecation"):typeof console=="object"&&console.warn(`Deprecation: ${s}`))}}});var jl=be($c=>{"use strict";Object.defineProperty($c,"__esModule",{value:!0});$c.SortedMap=void 0;var ow=eo(),Yc=Pg(),no=Yo(),q0=Jo(),wg=class{constructor(...e){this._keys=[],this._values=[];let t,i;if(e.length>0){let n=e[0];ow.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=q0.Comparer.defaultComparer),this._comparer=typeof i=="function"?q0.Comparer.create(i):i,t)for(let[n,o]of t)this.set(n,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return Yc.binarySearch(this._keys,e,this._comparer)>=0}get(e){let t=Yc.binarySearch(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let i=Yc.binarySearch(this._keys,e,this._comparer);return i>=0?this._values[i]=t:(this._keys.splice(~i,0,e),this._values.splice(~i,0,t)),this}delete(e){let t=Yc.binarySearch(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this)e.call(t,n,i,this)}get[no.KeyedCollection.size](){return this.size}[no.KeyedCollection.has](e){return this.has(e)}[no.KeyedCollection.get](e){return this.get(e)}[no.KeyedCollection.set](e,t){this.set(e,t)}[no.KeyedCollection.delete](e){return this.delete(e)}[no.KeyedCollection.clear](){this.clear()}[no.KeyedCollection.keys](){return this.keys()}[no.KeyedCollection.values](){return this.values()}};$c.SortedMap=wg;Object.defineProperty(wg,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedMap"})});var Jy=be((I$,Bh)=>{var My,Ny,Dy,Gy,_y,Fy,Vy,ky,Uy,Rh,Cp,zy,Hy,Wy,Va,jy,qy,Xy,Yy,$y,Qy,Zy,Ky,Oh;(function(s){var e=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(i){s(t(e,t(i)))}):typeof Bh=="object"&&typeof Bh.exports=="object"?s(t(e,t(Bh.exports))):s(t(e));function t(i,n){return i!==e&&(typeof Object.create=="function"?Object.defineProperty(i,"__esModule",{value:!0}):i.__esModule=!0),function(o,a){return i[o]=n?n(o,a):a}}})(function(s){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])};My=function(i,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(i,n);function o(){this.constructor=i}i.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},Ny=Object.assign||function(i){for(var n,o=1,a=arguments.length;o<a;o++){n=arguments[o];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(i[l]=n[l])}return i},Dy=function(i,n){var o={};for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&n.indexOf(a)<0&&(o[a]=i[a]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(i);l<a.length;l++)n.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(i,a[l])&&(o[a[l]]=i[a[l]]);return o},Gy=function(i,n,o,a){var l=arguments.length,u=l<3?n:a===null?a=Object.getOwnPropertyDescriptor(n,o):a,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(i,n,o,a);else for(var h=i.length-1;h>=0;h--)(c=i[h])&&(u=(l<3?c(u):l>3?c(n,o,u):c(n,o))||u);return l>3&&u&&Object.defineProperty(n,o,u),u},_y=function(i,n){return function(o,a){n(o,a,i)}},Fy=function(i,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,n)},Vy=function(i,n,o,a){function l(u){return u instanceof o?u:new o(function(c){c(u)})}return new(o||(o=Promise))(function(u,c){function h(y){try{p(a.next(y))}catch(x){c(x)}}function d(y){try{p(a.throw(y))}catch(x){c(x)}}function p(y){y.done?u(y.value):l(y.value).then(h,d)}p((a=a.apply(i,n||[])).next())})},ky=function(i,n){var o={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},a,l,u,c;return c={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function h(p){return function(y){return d([p,y])}}function d(p){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,l&&(u=p[0]&2?l.return:p[0]?l.throw||((u=l.return)&&u.call(l),0):l.next)&&!(u=u.call(l,p[1])).done)return u;switch(l=0,u&&(p=[p[0]&2,u.value]),p[0]){case 0:case 1:u=p;break;case 4:return o.label++,{value:p[1],done:!1};case 5:o.label++,l=p[1],p=[0];continue;case 7:p=o.ops.pop(),o.trys.pop();continue;default:if(u=o.trys,!(u=u.length>0&&u[u.length-1])&&(p[0]===6||p[0]===2)){o=0;continue}if(p[0]===3&&(!u||p[1]>u[0]&&p[1]<u[3])){o.label=p[1];break}if(p[0]===6&&o.label<u[1]){o.label=u[1],u=p;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(p);break}u[2]&&o.ops.pop(),o.trys.pop();continue}p=n.call(i,o)}catch(y){p=[6,y],l=0}finally{a=u=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}},Uy=function(i,n){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(n,o)&&Oh(n,i,o)},Oh=Object.create?function(i,n,o,a){a===void 0&&(a=o),Object.defineProperty(i,a,{enumerable:!0,get:function(){return n[o]}})}:function(i,n,o,a){a===void 0&&(a=o),i[a]=n[o]},Rh=function(i){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&i[n],a=0;if(o)return o.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&a>=i.length&&(i=void 0),{value:i&&i[a++],done:!i}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},Cp=function(i,n){var o=typeof Symbol=="function"&&i[Symbol.iterator];if(!o)return i;var a=o.call(i),l,u=[],c;try{for(;(n===void 0||n-- >0)&&!(l=a.next()).done;)u.push(l.value)}catch(h){c={error:h}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(c)throw c.error}}return u},zy=function(){for(var i=[],n=0;n<arguments.length;n++)i=i.concat(Cp(arguments[n]));return i},Hy=function(){for(var i=0,n=0,o=arguments.length;n<o;n++)i+=arguments[n].length;for(var a=Array(i),l=0,n=0;n<o;n++)for(var u=arguments[n],c=0,h=u.length;c<h;c++,l++)a[l]=u[c];return a},Wy=function(i,n,o){if(o||arguments.length===2)for(var a=0,l=n.length,u;a<l;a++)(u||!(a in n))&&(u||(u=Array.prototype.slice.call(n,0,a)),u[a]=n[a]);return i.concat(u||Array.prototype.slice.call(n))},Va=function(i){return this instanceof Va?(this.v=i,this):new Va(i)},jy=function(i,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=o.apply(i,n||[]),l,u=[];return l={},c("next"),c("throw"),c("return"),l[Symbol.asyncIterator]=function(){return this},l;function c(A){a[A]&&(l[A]=function(T){return new Promise(function(I,B){u.push([A,T,I,B])>1||h(A,T)})})}function h(A,T){try{d(a[A](T))}catch(I){x(u[0][3],I)}}function d(A){A.value instanceof Va?Promise.resolve(A.value.v).then(p,y):x(u[0][2],A)}function p(A){h("next",A)}function y(A){h("throw",A)}function x(A,T){A(T),u.shift(),u.length&&h(u[0][0],u[0][1])}},qy=function(i){var n,o;return n={},a("next"),a("throw",function(l){throw l}),a("return"),n[Symbol.iterator]=function(){return this},n;function a(l,u){n[l]=i[l]?function(c){return(o=!o)?{value:Va(i[l](c)),done:l==="return"}:u?u(c):c}:u}},Xy=function(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=i[Symbol.asyncIterator],o;return n?n.call(i):(i=typeof Rh=="function"?Rh(i):i[Symbol.iterator](),o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o);function a(u){o[u]=i[u]&&function(c){return new Promise(function(h,d){c=i[u](c),l(h,d,c.done,c.value)})}}function l(u,c,h,d){Promise.resolve(d).then(function(p){u({value:p,done:h})},c)}},Yy=function(i,n){return Object.defineProperty?Object.defineProperty(i,"raw",{value:n}):i.raw=n,i};var t=Object.create?function(i,n){Object.defineProperty(i,"default",{enumerable:!0,value:n})}:function(i,n){i.default=n};$y=function(i){if(i&&i.__esModule)return i;var n={};if(i!=null)for(var o in i)o!=="default"&&Object.prototype.hasOwnProperty.call(i,o)&&Oh(n,i,o);return t(n,i),n},Qy=function(i){return i&&i.__esModule?i:{default:i}},Zy=function(i,n,o,a){if(o==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?i!==n||!a:!n.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?a:o==="a"?a.call(i):a?a.value:n.get(i)},Ky=function(i,n,o,a,l){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!l)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?i!==n||!l:!n.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?l.call(i,o):l?l.value=o:n.set(i,o),o},s("__extends",My),s("__assign",Ny),s("__rest",Dy),s("__decorate",Gy),s("__param",_y),s("__metadata",Fy),s("__awaiter",Vy),s("__generator",ky),s("__exportStar",Uy),s("__createBinding",Oh),s("__values",Rh),s("__read",Cp),s("__spread",zy),s("__spreadArrays",Hy),s("__spreadArray",Wy),s("__await",Va),s("__asyncGenerator",jy),s("__asyncDelegator",qy),s("__asyncValues",Xy),s("__makeTemplateObject",Yy),s("__importStar",$y),s("__importDefault",Qy),s("__classPrivateFieldGet",Zy),s("__classPrivateFieldSet",Ky)})});var tS=be(Mh=>{"use strict";Object.defineProperty(Mh,"__esModule",{value:!0});Mh.SortedSet=void 0;var Ap=Pg(),xw=eo(),hu=Yo(),eS=Jo(),vp=class{constructor(...e){this._values=[];let t,i;if(e.length>0){let n=e[0];xw.isIterable(n)||n===void 0?(t=n,e.length>1&&(i=e[1])):i=n}if(i===void 0&&(i=eS.Comparer.defaultComparer),this._comparer=typeof i=="function"?eS.Comparer.create(i):i,t)for(let n of t)this.add(n)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return Ap.binarySearch(this._values,e,this._comparer)>=0}add(e){let t=Ap.binarySearch(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=Ap.binarySearch(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){for(let i of this)e.call(t,i,i,this)}get[hu.Collection.size](){return this.size}[hu.Collection.has](e){return this.has(e)}[hu.Collection.add](e){this.add(e)}[hu.Collection.delete](e){return this.delete(e)}[hu.Collection.clear](){this.clear()}};Mh.SortedSet=vp;Object.defineProperty(vp,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedSet"})});var oS=be(yo=>{"use strict";Object.defineProperty(yo,"__esModule",{value:!0});yo.expandPrime=yo.getPrime=yo.isPrime=void 0;var Cw=2**31-1,Tp=2146435069,Aw=101,rS=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function iS(s){if(s&1){let e=Math.sqrt(s)|0;for(let t=3;t<=e;t+=2)if(!(s%t))return!1;return!0}return s===2}yo.isPrime=iS;function nS(s){if(s<0)throw new RangeError;for(let e=0;e<rS.length;e++){let t=rS[e];if(t>=s)return t}for(let e=s|1;e<Cw;e+=2)if(iS(e)&&(e-1)%Aw)return e;return s}yo.getPrime=nS;function vw(s){let e=2*s;return e>Tp&&Tp>s?Tp:nS(e)}yo.expandPrime=vw});var Rp=be(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.forEachEntry=Ee.iterateEntries=Ee.selectEntryEntry=Ee.selectEntryValue=Ee.selectEntryKey=Ee.trimExcessEntries=Ee.ensureCapacity=Ee.clearEntries=Ee.deleteEntry=Ee.insertEntry=Ee.findEntryValue=Ee.findEntryIndex=Ee.resizeHashData=Ee.initializeHashData=Ee.createHashData=Ee.createHashEntry=void 0;var du=oS(),Ip=2**31-1;function wp(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}Ee.createHashEntry=wp;function Tw(s,e){let t=wp(),i={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:s,head:t,tail:t};return fu(i,e),i}Ee.createHashData=Tw;function fu(s,e){let t=du.getPrime(e);return s.freeList=-1,s.buckets=new Int32Array(t),s.entries=new Array(t),t}Ee.initializeHashData=fu;function Lp(s,e){let t=s.size,i=new Int32Array(e),n=s.entries?s.entries.slice():[];n.length=e;for(let o=0;o<t;o++){let a=n[o];if(a&&a.hashCode>=0){let l=a.hashCode%e;a.next=i[l]-1,i[l]=o+1}}s.buckets=i,s.entries=n}Ee.resizeHashData=Lp;function sS(s,e){let t=-1,{buckets:i,entries:n,equaler:o}=s;if(i&&n){let a=o.hash(e)&Ip;for(t=i[a%i.length]-1;t>>>0<n.length&&!(n[t].hashCode===a&&o.equals(n[t].key,e));)t=n[t].next}return t}Ee.findEntryIndex=sS;function Iw(s,e){let t=sS(s,e);return t>=0?s.entries[t].value:void 0}Ee.findEntryValue=Iw;function ww(s,e,t){if(s.buckets||fu(s,0),!s.buckets||!s.entries)throw new Error;let i=s.equaler.hash(e)&Ip,n=i%s.buckets.length,o=s.buckets[n]-1;for(;o>>>0<s.entries.length;){let h=s.entries[o];if(h.hashCode===i&&s.equaler.equals(h.key,e)){h.value=t;return}o=h.next}let a=!1,l;if(s.freeSize>0)l=s.freeList,a=!0,s.freeSize--;else{let h=s.size;if(h===s.entries.length){if(Lp(s,du.expandPrime(s.size)),!s.buckets||!s.entries)throw new Error;n=i%s.buckets.length}l=h,s.size=h+1}let u=s.entries[l]||(s.entries[l]=wp());a&&(s.freeList=u.next),u.hashCode=i,u.next=s.buckets[n]-1,u.key=e,u.value=t,u.skipNextEntry=!1;let c=s.tail;c.nextEntry=u,u.prevEntry=c,s.tail=u,s.buckets[n]=l+1}Ee.insertEntry=ww;function Lw(s,e){if(s.buckets&&s.entries){let t=s.equaler.hash(e)&Ip,i=t%s.buckets.length,n=-1,o;for(let a=s.buckets[i]-1;a>=0;a=o.next){if(o=s.entries[a],o.hashCode===t&&s.equaler.equals(o.key,e)){n<0?s.buckets[i]=o.next+1:s.entries[n].next=o.next;let l=o.prevEntry;return l.nextEntry=o.nextEntry,l.nextEntry&&(l.nextEntry.prevEntry=l),s.tail===o&&(s.tail=l),o.hashCode=-1,o.next=s.freeList,o.key=void 0,o.value=void 0,o.prevEntry=void 0,o.nextEntry=l,o.skipNextEntry=!0,s.freeList=a,s.freeSize++,!0}n=a}}return!1}Ee.deleteEntry=Lw;function Rw(s){if(s.size>0){s.buckets&&s.buckets.fill(0),s.entries&&s.entries.fill(void 0);let t=s.head.nextEntry;for(;t;){let i=t.nextEntry;t.prevEntry=void 0,t.nextEntry=s.head,t.skipNextEntry=!0,t=i}s.head.nextEntry=void 0,s.tail=s.head,s.size=0,s.freeList=-1,s.freeSize=0}}Ee.clearEntries=Rw;function Ow(s,e){if(e<0)throw new RangeError;let t=s.entries?s.entries.length:0;if(t>=e)return t;if(!s.buckets)return fu(s,e);let i=du.getPrime(e);return Lp(s,du.getPrime(e)),i}Ee.ensureCapacity=Ow;function Bw(s,e=s.size-s.freeSize){if(e<s.size)throw new RangeError;if(!s.buckets||!s.entries)return;let t=du.getPrime(e),i=s.entries;if(t>=(i?i.length:0))return;let n=s.size;if(fu(s,t),!s.buckets||!s.entries)throw new Error;let o=0;for(let a=0;a<n;a++){let l=i[a].hashCode;if(l>=0){let u=l%t;s.entries[o]=i[a],s.entries[o].next=s.buckets[u]-1,s.buckets[u]=o+1,o++}}s.size=o,s.freeSize=0}Ee.trimExcessEntries=Bw;function Mw(s){return s.key}Ee.selectEntryKey=Mw;function Nw(s){return s.value}Ee.selectEntryValue=Nw;function Dw(s){return[s.key,s.value]}Ee.selectEntryEntry=Dw;function*Gw(s,e){let t=s;for(;t;){let i=t.skipNextEntry;t=t.nextEntry,!i&&t&&(yield e(t))}}Ee.iterateEntries=Gw;function _w(s,e,t,i){let n=e;for(;n;){let o=n.skipNextEntry;n=n.nextEntry,!o&&n&&t.call(i,n.value,n.key,s)}}Ee.forEachEntry=_w});var Bp=be(Nh=>{"use strict";Object.defineProperty(Nh,"__esModule",{value:!0});Nh.HashMap=void 0;var So=Yo(),Fw=Jo(),Vw=eo(),Sr=Rp(),Op=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):Vw.isIterable(o)||o===void 0?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=Fw.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=Sr.createHashData(n,t),i)for(let[o,a]of i)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return Sr.findEntryIndex(this._hashData,e)>=0}get(e){return Sr.findEntryValue(this._hashData,e)}set(e,t){return Sr.insertEntry(this._hashData,e,t),this}delete(e){return Sr.deleteEntry(this._hashData,e)}clear(){Sr.clearEntries(this._hashData)}ensureCapacity(e){return Sr.ensureCapacity(this._hashData,e)}trimExcess(e){Sr.trimExcessEntries(this._hashData,e)}keys(){return Sr.iterateEntries(this._hashData.head,Sr.selectEntryKey)}values(){return Sr.iterateEntries(this._hashData.head,Sr.selectEntryValue)}entries(){return Sr.iterateEntries(this._hashData.head,Sr.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){Sr.forEachEntry(this,this._hashData.head,e,t)}get[So.ReadonlyKeyedCollection.size](){return this.size}[So.ReadonlyKeyedCollection.has](e){return this.has(e)}[So.ReadonlyKeyedCollection.get](e){return this.get(e)}[So.ReadonlyKeyedCollection.keys](){return this.keys()}[So.ReadonlyKeyedCollection.values](){return this.values()}[So.KeyedCollection.set](e,t){this.set(e,t)}[So.KeyedCollection.delete](e){return this.delete(e)}[So.KeyedCollection.clear](){this.clear()}};Nh.HashMap=Op;Object.defineProperty(Op,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashMap"})});var Np=be(Dh=>{"use strict";Object.defineProperty(Dh,"__esModule",{value:!0});Dh.HashSet=void 0;var gu=Yo(),kw=Jo(),Uw=eo(),Er=Rp(),Mp=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(n=e[1])):Uw.isIterable(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t===void 0&&(t=0),n===void 0&&(n=kw.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=Er.createHashData(n,t),i)for(let o of i)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return Er.findEntryIndex(this._hashData,e)>=0}add(e){return Er.insertEntry(this._hashData,e,e),this}tryAdd(e){let t=this.size;return Er.insertEntry(this._hashData,e,e),this.size>t}delete(e){return Er.deleteEntry(this._hashData,e)}clear(){Er.clearEntries(this._hashData)}ensureCapacity(e){return Er.ensureCapacity(this._hashData,e)}trimExcess(e){Er.trimExcessEntries(this._hashData,e)}keys(){return Er.iterateEntries(this._hashData.head,Er.selectEntryKey)}values(){return Er.iterateEntries(this._hashData.head,Er.selectEntryValue)}entries(){return Er.iterateEntries(this._hashData.head,Er.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){Er.forEachEntry(this,this._hashData.head,e,t)}get[gu.Collection.size](){return this.size}[gu.Collection.has](e){return this.has(e)}[gu.Collection.add](e){this.add(e)}[gu.Collection.delete](e){return this.delete(e)}[gu.Collection.clear](){this.clear()}};Dh.HashSet=Mp;Object.defineProperty(Mp,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashSet"})});var lS=be(Gh=>{"use strict";Object.defineProperty(Gh,"__esModule",{value:!0});Gh.MultiMap=void 0;var Cs=eo(),aS=Jo(),Ji=Yo(),zw=Bp(),Hw=Np(),Dp=class{constructor(...e){this._size=0;let t,i,n;jw(e)?[t,n={}]=e:(t=0,Ww(e)?[i,n={}]=e:n={});let{keyEqualer:o=aS.Equaler.defaultEqualer,valueEqualer:a=aS.Equaler.defaultEqualer}=n;if(this._map=new zw.HashMap(t,o),this._keyEqualer=o,this._valueEqualer=a,i)for(let[l,u]of i)this.add(l,u)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let i=this._map.get(e);return i?i.has(t):!1}get(e){return this._map.get(e)}add(e,t){let i=this._map.get(e);i||(i=new Hw.HashSet(this._valueEqualer),this._map.set(e,i));let n=i.size;return i.add(t),this._size+=i.size-n,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let i=this._map.get(e);if(i){let n=i.size;if(i.delete(t))return this._size+=i.size-n,i.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let i of t)yield[e,i]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[i,n]of this._map)for(let o of n)e.call(t,o,i,this)}get[Ji.ReadonlyKeyedMultiCollection.size](){return this.size}[Ji.ReadonlyKeyedMultiCollection.has](e){return this.has(e)}[Ji.ReadonlyKeyedMultiCollection.hasValue](e,t){return this.hasValue(e,t)}[Ji.ReadonlyKeyedMultiCollection.get](e){return this.get(e)}[Ji.ReadonlyKeyedMultiCollection.keys](){return this.keys()}[Ji.ReadonlyKeyedMultiCollection.values](){return this.values()}[Ji.KeyedMultiCollection.add](e,t){this.add(e,t)}[Ji.KeyedMultiCollection.delete](e){return this.delete(e)}[Ji.KeyedMultiCollection.deleteValue](e,t){return this.deleteValue(e,t)}[Ji.KeyedMultiCollection.clear](){this.clear()}};Gh.MultiMap=Dp;Object.defineProperty(Dp,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"MultiMap"});function Ww(s){return(s.length<1||!Cs.isDefined(s[0])||Cs.isIterable(s[0]))&&(s.length<2||!Cs.isDefined(s[1])||Cs.isObject(s[1]))}function jw(s){return(s.length<1||Cs.isNumber(s[0]))&&(s.length<2||!Cs.isDefined(s[1])||Cs.isObject(s[1]))}});var fS=be(Ua=>{"use strict";var cS,hS,dS;Object.defineProperty(Ua,"__esModule",{value:!0});Ua.LinkedList=Ua.LinkedListNode=void 0;var ne=eo(),pu=Yo(),uS=Jo(),_h=Symbol("LinkedListNode.list"),sr=Symbol("LinkedListNode.previous"),Wt=Symbol("LinkedListNode.next"),Dt=class{constructor(e){this[cS]=void 0,this[hS]=void 0,this[dS]=void 0,this.value=e}get list(){return this[_h]}get previous(){if(this[sr]&&this.list&&this!==this.list.first)return this[sr]}get next(){if(this[Wt]&&this.list&&this[Wt]!==this.list.first)return this[Wt]}detachSelf(){return this.list?this.list.deleteNode(this):!1}};Ua.LinkedListNode=Dt;cS=_h,hS=sr,dS=Wt;Object.defineProperty(Dt.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedListNode"});var ka=class{constructor(...e){this._size=0,this._head=void 0;let t,i;if(e.length>0&&(ne.isIterable(e[0])||ne.isMissing(e[0])?(t=e[0],e.length>1&&(i=e[1])):i=e[0]),ne.isMissing(i)&&(i=uS.Equaler.defaultEqualer),this._equaler=typeof i=="function"?uS.Equaler.create(i):i,t)for(let n of t)this.push(n)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return this._head[sr]}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(!ne.isMissing(t)&&!ne.isInstance(t,Dt))throw new TypeError("LinkedListNode expected: fromNode");if(!ne.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.first;i;i=i.next)if(this._equaler.equals(i.value,e))return i}lastNodeOf(e,t){if(!ne.isMissing(t)&&!ne.isInstance(t,Dt))throw new TypeError("LinkedListNode expected: fromNode");if(!ne.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t||this.last;i;i=i.previous)if(this._equaler.equals(i.value,e))return i}find(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;){i=n,n=i.next;let o=i.value;if(e.call(t,o,i,this))return o}}findLast(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;){i=n,n=i.previous;let o=i.value;if(e.call(t,o,i,this))return o}}findNode(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,e.call(t,i.value,i,this))return i}findLastNode(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;)if(i=n,n=i.previous,e.call(t,i.value,i,this))return i}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(!ne.isMissing(e)&&!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: node");if(!ne.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new Dt(t),0)}insertNodeBefore(e,t){if(!ne.isMissing(e)&&!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: node");if(!ne.isInstance(t,Dt))throw new TypeError("LinkedListNode expected: newNode");if(!ne.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ne.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(!ne.isMissing(e)&&!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: node");if(!ne.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new Dt(t),1)}insertNodeAfter(e,t){if(!ne.isMissing(e)&&!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: node");if(!ne.isInstance(t,Dt))throw new TypeError("LinkedListNode expected: newNode");if(!ne.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ne.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new Dt(e),1)}pushNode(e){if(!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: newNode");if(!ne.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new Dt(e),0)}unshiftNode(e){if(!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: newNode");if(!ne.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(!ne.isMissing(e)&&!ne.isInstance(e,Dt))throw new TypeError("LinkedListNode expected: node");if(!ne.isMissing(e)&&!ne.isMissing(e.list)&&e.list!==this)throw new TypeError("Wrong list.");return ne.isMissing(e)||ne.isMissing(e.list)?!1:this._deleteNode(e)}deleteAll(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: predicate");let i=0,n=this.first;for(;n;){let o=n.next;e.call(t,n.value,n,this)&&n.list===this&&(this._deleteNode(n),++i),n=o}return i}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)i=n,n=i.next,e.call(t,i.value,i,this)}map(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");[].map;let i=new ka,n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=e.call(t,n.value,n,this);i.push(a)}return i}filter(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i=new ka(this.equaler),n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=n.value;e.call(t,a,n,this)&&i.push(a)}return i}reduce(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0)}return n}reduceRight(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0),a=o.previous}return n}some(e,t){if(!ne.isMissing(e)&&!ne.isFunction(e))throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,!e||e.call(t,i.value,i,this))return!0;return!1}every(e,t){if(!ne.isFunction(e))throw new TypeError("Function expected: callback");let i=!1,n,o=this.first;for(;o!==void 0;){if(n=o,o=n.next,!e.call(t,n.value,n,this))return!1;i=!0}return i}_deleteNode(e){return e[Wt]===e?this._head=void 0:(e[Wt][sr]=e[sr],e[sr][Wt]=e[Wt],this._head===e&&(this._head=e[Wt])),e[_h]=void 0,e[Wt]=void 0,e[sr]=void 0,this._size--,!0}_insertNode(e,t,i){if(t[_h]=this,this._head===void 0)t[Wt]=t,t[sr]=t,this._head=t;else switch(i){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),t[Wt]=e,t[sr]=e[sr],e[sr][Wt]=t,e[sr]=t;break;case 1:e===void 0&&(e=this._head[sr]),t[sr]=e,t[Wt]=e[Wt],e[Wt][sr]=t,e[Wt]=t;break}return this._size++,t}get[pu.ReadonlyCollection.size](){return this.size}[pu.ReadonlyCollection.has](e){return this.has(e)}[pu.Collection.add](e){this.push(e)}[pu.Collection.delete](e){return!!this.delete(e)}[pu.Collection.clear](){this.clear()}};Ua.LinkedList=ka;Object.defineProperty(ka.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedList"})});var Fh=be(Eo=>{"use strict";Object.defineProperty(Eo,"__esModule",{value:!0});var za=Jy();za.__exportStar(jl(),Eo);za.__exportStar(tS(),Eo);za.__exportStar(Bp(),Eo);za.__exportStar(Np(),Eo);za.__exportStar(lS(),Eo);za.__exportStar(fS(),Eo)});var VS=be((pie,FS)=>{FS.exports={rgb2hsl:xu,rgb2hsv:Xh,rgb2hwb:Cu,rgb2cmyk:Au,rgb2keyword:vu,rgb2xyz:Kp,rgb2lab:Jp,rgb2lch:mL,hsl2rgb:Yh,hsl2hsv:bL,hsl2hwb:PL,hsl2cmyk:yL,hsl2keyword:SL,hsv2rgb:$h,hsv2hsl:EL,hsv2hwb:xL,hsv2cmyk:CL,hsv2keyword:AL,hwb2rgb:Tu,hwb2hsl:vL,hwb2hsv:TL,hwb2cmyk:IL,hwb2keyword:wL,cmyk2rgb:Iu,cmyk2hsl:LL,cmyk2hsv:RL,cmyk2hwb:OL,cmyk2keyword:BL,keyword2rgb:Ls,keyword2hsl:GL,keyword2hsv:_L,keyword2hwb:FL,keyword2cmyk:VL,keyword2lab:kL,keyword2xyz:UL,xyz2rgb:NS,xyz2lab:DS,xyz2lch:ML,lab2xyz:em,lab2rgb:GS,lab2lch:tm,lch2lab:rm,lch2xyz:NL,lch2rgb:DL};function xu(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(n+o)/2,o==n?u=0:c<=.5?u=a/(o+n):u=a/(2-o-n),[l,u*100,c*100]}function Xh(s){var e=s[0],t=s[1],i=s[2],n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function Cu(s){var e=s[0],t=s[1],o=s[2],i=xu(s)[0],n=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[i,n*100,o*100]}function Au(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n,o,a,l;return l=Math.min(1-e,1-t,1-i),n=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-i-l)/(1-l)||0,[n*100,o*100,a*100,l*100]}function vu(s){return _S[JSON.stringify(s)]}function Kp(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;var n=e*.4124+t*.3576+i*.1805,o=e*.2126+t*.7152+i*.0722,a=e*.0193+t*.1192+i*.9505;return[n*100,o*100,a*100]}function Jp(s){var e=Kp(s),t=e[0],i=e[1],n=e[2],o,a,l;return t/=95.047,i/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=116*i-16,a=500*(t-i),l=200*(i-n),[o,a,l]}function mL(s){return tm(Jp(s))}function Yh(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n,o,a,l,u;if(t==0)return u=i*255,[u,u,u];i<.5?o=i*(1+t):o=i+t-i*t,n=2*i-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=n+(o-n)*6*a:2*a<1?u=o:3*a<2?u=n+(o-n)*(2/3-a)*6:u=n,l[c]=u*255;return l}function bL(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return i===0?[0,0,0]:(i*=2,t*=i<=1?i:2-i,o=(i+t)/2,n=2*t/(i+t),[e,n*100,o*100])}function PL(s){return Cu(Yh(s))}function yL(s){return Au(Yh(s))}function SL(s){return vu(Yh(s))}function $h(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,i=Math.floor(e)%6,n=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*n),l=255*u*(1-t*(1-n)),u=255*u;switch(i){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function EL(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return o=(2-t)*i,n=t*i,n/=o<=1?o:2-o,n=n||0,o/=2,[e,n*100,o*100]}function xL(s){return Cu($h(s))}function CL(s){return Au($h(s))}function AL(s){return vu($h(s))}function Tu(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n=t+i,o,a,l,u;switch(n>1&&(t/=n,i/=n),o=Math.floor(6*e),a=1-i,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function vL(s){return xu(Tu(s))}function TL(s){return Xh(Tu(s))}function IL(s){return Au(Tu(s))}function wL(s){return vu(Tu(s))}function Iu(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-n)+n),a=1-Math.min(1,t*(1-n)+n),l=1-Math.min(1,i*(1-n)+n),[o*255,a*255,l*255]}function LL(s){return xu(Iu(s))}function RL(s){return Xh(Iu(s))}function OL(s){return Cu(Iu(s))}function BL(s){return vu(Iu(s))}function NS(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n,o,a;return n=e*3.2406+t*-1.5372+i*-.4986,o=e*-.9689+t*1.8758+i*.0415,a=e*.0557+t*-.204+i*1.057,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n=n*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,n=Math.min(Math.max(0,n),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[n*255,o*255,a*255]}function DS(s){var e=s[0],t=s[1],i=s[2],n,o,a;return e/=95.047,t/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=116*t-16,o=500*(e-t),a=200*(t-i),[n,o,a]}function ML(s){return tm(DS(s))}function em(s){var e=s[0],t=s[1],i=s[2],n,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),n=n/95.047<=.008856?n=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-i/200-16/116)/7.787:108.883*Math.pow(l-i/200,3),[n,o,a]}function tm(s){var e=s[0],t=s[1],i=s[2],n,o,a;return n=Math.atan2(i,t),o=n*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+i*i),[e,a,o]}function GS(s){return NS(em(s))}function rm(s){var e=s[0],t=s[1],i=s[2],n,o,a;return a=i/360*2*Math.PI,n=t*Math.cos(a),o=t*Math.sin(a),[e,n,o]}function NL(s){return em(rm(s))}function DL(s){return GS(rm(s))}function Ls(s){return Zp[s]}function GL(s){return xu(Ls(s))}function _L(s){return Xh(Ls(s))}function FL(s){return Cu(Ls(s))}function VL(s){return Au(Ls(s))}function kL(s){return Jp(Ls(s))}function UL(s){return Kp(Ls(s))}var Zp={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},_S={};for(Qp in Zp)_S[JSON.stringify(Zp[Qp])]=Qp;var Qp});var zS=be((mie,US)=>{var im=VS(),Rs=function(){return new wu};for($a in im)Rs[$a+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),im[s](e)}}($a),nm=/(\w+)2(\w+)/.exec($a),Qh=nm[1],kS=nm[2],Rs[Qh]=Rs[Qh]||{},Rs[Qh][kS]=Rs[$a]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=im[s](e);if(typeof t=="string"||t===void 0)return t;for(var i=0;i<t.length;i++)t[i]=Math.round(t[i]);return t}}($a);var nm,Qh,kS,$a,wu=function(){this.convs={}};wu.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};wu.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};wu.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,i=this.convs[t];e=Rs[t][s](i),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){wu.prototype[s]=function(e){return this.routeSpace(s,arguments)}});US.exports=Rs});var WS=be((bie,HS)=>{var om=zS();HS.exports=function(s){var e,t,i,n;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=om[a],i=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&i.push(1),n=i[l]===void 0?1:i[l],i=i.slice(0,l),t[a]=function(){return i}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=om.rgb,i=a.split(l===3?/(.)/:/(..)/),i=i.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),n=1,t.rgb=function(){return i},i[0]||(i[0]=0),i[1]||(i[1]=0),i[2]||(i[2]=0)}else t=om.keyword,t.keyword=function(){return s},i=s,n=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(i)}catch{}try{u.hsl=t.hsl(i)}catch{}try{u.hsv=t.hsv(i)}catch{}try{u.cmyk=t.cmyk(i)}catch{}try{u.keyword=t.keyword(i)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(n)),u.hsl&&(u.hsla=u.hsl.concat(n)),u.hsv&&(u.hsva=u.hsv.concat(n)),u.cmyk&&(u.cmyka=u.cmyk.concat(n)),u}});var Ns=be((coe,Bu)=>{function E2(s){return s&&s.__esModule?s:{default:s}}Bu.exports=E2,Bu.exports.__esModule=!0,Bu.exports.default=Bu.exports});var Mu=be((hoe,_n)=>{function vm(s){return _n.exports=vm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_n.exports.__esModule=!0,_n.exports.default=_n.exports,vm(s)}_n.exports=vm,_n.exports.__esModule=!0,_n.exports.default=_n.exports});var sd=be(Im=>{"use strict";var x2=Ns();Object.defineProperty(Im,"__esModule",{value:!0});Im.default=C2;var Tm=x2(Mu());function C2(s){if(typeof window<"u"&&(0,Tm.default)(window.process)==="object"&&window.process.type==="renderer"||typeof process<"u"&&(0,Tm.default)(process.versions)==="object"&&Boolean(process.versions.electron))return!0;var e=(typeof navigator>"u"?"undefined":(0,Tm.default)(navigator))==="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}});var ld=be(ad=>{"use strict";var pE=Ns();Object.defineProperty(ad,"__esModule",{value:!0});ad.default=mE;ad.isBrowserMainThread=T2;var A2=pE(Mu()),v2=pE(sd());function mE(){var s=(typeof process>"u"?"undefined":(0,A2.default)(process))==="object"&&String(process)==="[object process]"&&!process.browser;return!s||(0,v2.default)()}function T2(){return mE()&&typeof document<"u"}});var wm=be(Or=>{"use strict";var I2=Ns();Object.defineProperty(Or,"__esModule",{value:!0});Or.window=Or.self=Or.process=Or.global=Or.document=Or.console=void 0;var w2=I2(Mu()),vo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:(typeof process>"u"?"undefined":(0,w2.default)(process))==="object"&&process},L2=globalThis;Or.global=L2;var R2=vo.self||vo.window||vo.global;Or.self=R2;var O2=vo.window||vo.self||vo.global;Or.window=O2;var B2=vo.document||{};Or.document=B2;var M2=vo.process||{};Or.process=M2;var N2=console;Or.console=N2});var bE=be(si=>{"use strict";var D2=Ns();Object.defineProperty(si,"__esModule",{value:!0});si.VERSION=void 0;Object.defineProperty(si,"console",{enumerable:!0,get:function(){return Ja.console}});Object.defineProperty(si,"document",{enumerable:!0,get:function(){return Ja.document}});Object.defineProperty(si,"global",{enumerable:!0,get:function(){return Ja.global}});si.isBrowser=void 0;Object.defineProperty(si,"process",{enumerable:!0,get:function(){return Ja.process}});Object.defineProperty(si,"self",{enumerable:!0,get:function(){return Ja.self}});Object.defineProperty(si,"window",{enumerable:!0,get:function(){return Ja.window}});var G2=D2(ld()),Ja=wm(),_2=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";si.VERSION=_2;var F2=(0,G2.default)();si.isBrowser=F2});var yE=be(cd=>{"use strict";var PE=Ns();Object.defineProperty(cd,"__esModule",{value:!0});cd.default=z2;cd.isMobile=U2;var V2=PE(ld()),k2=PE(sd()),ud=globalThis;function U2(){return typeof ud.orientation<"u"}function z2(s){if(!s&&!(0,V2.default)())return"Node";if((0,k2.default)(s))return"Electron";var e=typeof navigator<"u"?navigator:{},t=s||e.userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";var i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n?"IE":ud.chrome?"Chrome":ud.safari?"Safari":ud.mozInnerScreenX?"Firefox":"Unknown"}});var SE=be(Lm=>{"use strict";Object.defineProperty(Lm,"__esModule",{value:!0});Lm.default=H2;function H2(s,e){if(!s)throw new Error(e||"Assertion failed")}});var tl=be(Cr=>{"use strict";var EE=Ns(),W2=Mu();Object.defineProperty(Cr,"__esModule",{value:!0});Object.defineProperty(Cr,"VERSION",{enumerable:!0,get:function(){return j2.VERSION}});Object.defineProperty(Cr,"assert",{enumerable:!0,get:function(){return X2.default}});Object.defineProperty(Cr,"console",{enumerable:!0,get:function(){return el.console}});Object.defineProperty(Cr,"document",{enumerable:!0,get:function(){return el.document}});Object.defineProperty(Cr,"getBrowser",{enumerable:!0,get:function(){return CE.default}});Object.defineProperty(Cr,"global",{enumerable:!0,get:function(){return el.global}});Object.defineProperty(Cr,"isBrowser",{enumerable:!0,get:function(){return xE.default}});Object.defineProperty(Cr,"isBrowserMainThread",{enumerable:!0,get:function(){return xE.isBrowserMainThread}});Object.defineProperty(Cr,"isElectron",{enumerable:!0,get:function(){return q2.default}});Object.defineProperty(Cr,"isMobile",{enumerable:!0,get:function(){return CE.isMobile}});Object.defineProperty(Cr,"process",{enumerable:!0,get:function(){return el.process}});Object.defineProperty(Cr,"self",{enumerable:!0,get:function(){return el.self}});Object.defineProperty(Cr,"window",{enumerable:!0,get:function(){return el.window}});var j2=bE(),el=wm(),xE=vE(ld()),CE=vE(yE()),q2=EE(sd()),X2=EE(SE());function AE(s){if(typeof WeakMap!="function")return null;var e=new WeakMap,t=new WeakMap;return(AE=function(n){return n?t:e})(s)}function vE(s,e){if(!e&&s&&s.__esModule)return s;if(s===null||W2(s)!=="object"&&typeof s!="function")return{default:s};var t=AE(e);if(t&&t.has(s))return t.get(s);var i={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in s)if(o!=="default"&&Object.prototype.hasOwnProperty.call(s,o)){var a=n?Object.getOwnPropertyDescriptor(s,o):null;a&&(a.get||a.set)?Object.defineProperty(i,o,a):i[o]=s[o]}return i.default=s,t&&t.set(s,i),i}});var Fu=be((Iae,cx)=>{cx.exports=tl()});var fA=be((L0e,lP)=>{"use strict";lP.exports=xc;lP.exports.default=xc;var wl=1e20;function xc(s,e,t,i,n,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=i||.25,this.fontFamily=n||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function _D(s,e,t,i,n,o,a){o.fill(wl,0,e*t),a.fill(0,0,e*t);for(var l=(e-i)/2,u=0;u<n;u++)for(var c=0;c<i;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*i+c)+3]/255;if(d===1)o[h]=0,a[h]=wl;else if(d===0)o[h]=wl,a[h]=0;else{var p=Math.max(0,.5-d),y=Math.max(0,d-.5);o[h]=p*p,a[h]=y*y}}}function FD(s,e,t,i,n,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(i[l])-Math.sqrt(n[l]);s[l]=Math.round(255-255*(u/o+a))}}xc.prototype._draw=function(s,e){var t=this.ctx.measureText(s),i=t.width,n=2*this.buffer,o,a,l,u,c,h,d,p;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),p=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+n,l=u+n,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,p=this.middle,this.ctx.textBaseline="middle");var y;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,p),y=this.ctx.getImageData(d,h,a,u));var x=new Uint8ClampedArray(o*l);return _D(y,o,l,a,u,this.gridOuter,this.gridInner),hA(this.gridOuter,o,l,this.f,this.v,this.z),hA(this.gridInner,o,l,this.f,this.v,this.z),FD(x,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:x,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:i}}};xc.prototype.draw=function(s){return this._draw(s,!1).data};xc.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function hA(s,e,t,i,n,o){for(var a=0;a<e;a++)dA(s,a,e,t,i,n,o);for(var l=0;l<t;l++)dA(s,l*e,1,e,i,n,o)}function dA(s,e,t,i,n,o,a){var l,u,c,h;for(o[0]=0,a[0]=-wl,a[1]=wl,l=0;l<i;l++)n[l]=s[e+l*t];for(l=1,u=0,c=0;l<i;l++){do h=o[u],c=(n[l]-n[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=wl}for(l=0,u=0;l<i;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=n[h]+(l-h)*(l-h)}}});function o0(s,e){let t=document.getElementById(s);t.ondragover=i=>{i.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=i=>{i.preventDefault(),t.classList.remove("active");let n=i.dataTransfer.items[0];n.kind==="file"&&e(n.getAsFile())},t.onclick=()=>{let i=document.createElement("input");i.type="file",i.onchange=()=>i.files.length&&e(i.files[0]),i.click()}}var XS=Q(u0());var d0=Q(Xn());var zo=class{constructor(){this.attrs=[];this._parent=null}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t==e)return!0;return!1}};var Yn=class extends zo{constructor(e,t){super();this.source=e,this.target=t,e!=t?(e.outEdges.add(this),t.inEdges.add(this)):e.selfEdges.add(this)}add(){this.source!=this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!=this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!=this.target.parent}EdgeToAncestor(){return this.source instanceof De&&this.target.isDescendantOf(this.source)?1:this.target instanceof De&&this.source.isDescendantOf(this.target)?2:0}};var $n=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var _i=class extends zo{constructor(e){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=e}get id(){return this._id}set id(e){this._id=e}toString(){return this.id}*_edges(){for(let e of this.inEdges)yield e;for(let e of this.outEdges)yield e;for(let e of this.selfEdges)yield e}addInEdge(e){$n.assert(e!=null),$n.assert(e.target==this),this.inEdges.add(e)}addOutEdge(e){this.outEdges.add(e)}addSelfEdge(e){this.selfEdges.add(e)}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isUnderCollapsedGraph(){return this.parent!=null&&this.parent.isCollapsed}};var sg=class{constructor(){this.nodeMap=new Map}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof De&&(yield e)}find(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}*nodesDeep(){for(let e of this.nodes_())if(yield e,e instanceof De)for(let t of e.nodeCollection.nodesDeep())yield t}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}hasNode(e){if(this.nodeMap.has(e))return!0;for(let t of this.nodeMap)if(t[1]instanceof De&&t[1].nodeCollection.hasNode(e))return!0;return!1}getNode(e){let t=this.nodeMap.get(e);if(t!=null)return t;for(let i of this.nodeMap)if(i[1]instanceof De&&(t=i[1].nodeCollection.getNode(e),t!=null))return t}get nodeShallowCount(){return this.nodeMap.size}get nodeDeepCount(){let e=this.nodeMap.size;for(let t of this.nodeMap.values())t instanceof De&&(e+=t.nodeCollection.nodeDeepCount);return e}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.getNode(e.id)==null&&this.nodeMap.set(e.id,e)}addEdge(e){this.addNode(e.source),this.addNode(e.target),e.source!=e.target?(e.source.outEdges.add(e),e.target.inEdges.add(e)):e.source.selfEdges.add(e)}removeNode(e){for(let t of e.outEdges)t.target.inEdges.delete(t);for(let t of e.inEdges)t.source.outEdges.delete(t);this.nodeMap.delete(e.id);for(let t of this.nodeMap.values())t instanceof De&&t.nodeCollection.nodeMap.delete(e.id)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!=e||t.source==t.target||!this.nodeMap.has(t.target.id))return!1;for(let t of e.inEdges)return!(t.target!=e||t.source==t.target||!this.nodeMap.has(t.source.id));for(let t of e.selfEdges)if(t.target!=t.source||t.source==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap)if(!this.nodeIsConsistent(e[1]))return!1;return!0}};var De=class extends _i{constructor(e="__graph__"){super(e);this.isCollapsed=!1;this.nodeCollection=new sg}*graphs(){for(let e of this.nodeCollection.graphs)yield e}noEmptySubgraphs(){for(let e of this.subgraphs())if(e.shallowNodeCount==0)return!1;return!0}hasSubgraphs(){for(let e of this.shallowNodes)if(e instanceof De)return!0;return!1}*subgraphs(){for(let e of this.deepNodes)e instanceof De&&(yield e)}isEmpty(){return this.shallowNodeCount==0}setEdge(e,t){let i=this.nodeCollection.find(e);if(i==null)return;let n=this.nodeCollection.find(t);if(n==null)return;let o=new Yn(i,n);return this.addEdge(o),o}get shallowNodes(){return this.nodeCollection.nodesShallow}get deepNodes(){return this.nodeCollection.nodesDeep()}findNode(e){return this.nodeCollection.find(e)}get edges(){return this.nodeCollection.edges}*deepEdges(){for(let e of this.deepNodes){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}isConsistent(){return this.nodeCollection.isConsistent()}nodeIsConsistent(e){return this.nodeCollection.nodeIsConsistent(e)}removeNode(e){this.nodeCollection.removeNode(e)}addNode(e){return e.parent=this,this.nodeCollection.addNode(e),e}addEdge(e){this.nodeCollection.addEdge(e)}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){return this.nodeCollection.nodeDeepCount}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(e){for(;e!=null&&e.parent!=this;)e=e.parent;return e}deepEdgesCount(){let e=0;for(let t of this.deepNodes)e+=t.outDegree+t.selfDegree;return e}};function*f0(s){let e=new Set,t=new d0.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(n(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of i(l))n(u,t,e)}yield a}function*i(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function n(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}var ag=class{static solve(e,t,i,n,o,a){let l=e*o-n*t;if(!(Math.abs(l)<ag.eps))return{x:(i*o-a*t)/l,y:(e*a-n*i)/l}}},fi=ag;fi.eps=1e-8;var Qn=class{static RoundPoint(e){return new f(Qn.RoundDouble(e.x),Qn.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*Qn.mult)/Qn.mult}},E=Qn;E.distanceEpsilonPrecision=6,E.mult=Math.pow(10,6),E.defaultLeafBoxesOffset=.5,E.lineSegmentThreshold=.05,E.intersectionEpsilon=1e-4,E.distanceEpsilon=Math.pow(10,-Qn.distanceEpsilonPrecision),E.squareOfDistanceEpsilon=Math.pow(10,-Qn.distanceEpsilonPrecision*2),E.tolerance=1e-8;function g0(s,e){return(s?1:0)-(e?1:0)}function ue(s,e){let t=s-e;return t<0?-1:t==0?0:1}function aa(s,e){let t=ue(s.y,e.y);return t||ue(s.x,e.x)}function p0(s,e){let t=ue(s.x,e.x);return t||ue(s.y,e.y)}function $(s,e){let t=s-e;return-E.distanceEpsilon<=t&&t<=E.distanceEpsilon}function Nc(s,e){return Zn(s,e)>0}function Zn(s,e){let t=s-e;return t<=-E.distanceEpsilon?-1:t>=E.distanceEpsilon?1:0}function ye(s,e){return s.sub(e).length}var f=class{static ProjectionToLine(e,t,i){let n=t.sub(e),o=n.length;if(o<E.distanceEpsilon)return e;n=n.div(o);let a=i.sub(e).dot(n);return e.add(n.mul(a))}static RayIntersectsRayInteriors(e,t,i,n){let o=f.lineLineIntersection(e,e.add(t),i,i.add(n));if(!!o&&o.sub(e).dot(t.div(t.l1))>E.distanceEpsilon&&o.sub(i).dot(n.div(n.l1))>E.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,i,n){let o=f.lineLineIntersection(e,t,i,i.add(n));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(i).dot(n)<0)&&a.dot(a)>E.squareOfDistanceEpsilon&&l.dot(l)>=E.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,i){return f.signedDoubledTriangleArea(e,t,i)>=0}static PointToTheLeftOfLine(e,t,i){return f.signedDoubledTriangleArea(e,t,i)>0}static PointIsInsideCone(e,t,i,n){return f.PointToTheRightOfLineOrOnLine(e,t,i)&&f.PointToTheLeftOfLineOrOnLine(e,t,n)}static PointToTheRightOfLineOrOnLine(e,t,i){return f.signedDoubledTriangleArea(t,i,e)<=0}static PointToTheRightOfLine(e,t,i){return f.signedDoubledTriangleArea(t,i,e)<0}static closeIntersections(e,t){return f.close(e,t,E.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=ue(this.x,e.x);return t!=0?t:ue(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,i){return e.sub(t).length<=i}static closeSquare(e,t,i){let n=t.sub(e);return n.dot(n)<=i}static closeDistEps(e,t,i=E.distanceEpsilon){return e.sub(t).length<=i}normalize(){let e=this.length;return new f(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new f(this.x*e,this.y*t)}add(e){return new f(this.x+e.x,this.y+e.y)}sub(e){return new f(this.x-e.x,this.y-e.y)}mul(e){return new f(this.x*e,this.y*e)}div(e){return new f(this.x/e,this.y/e)}equal(e){return e.x==this.x&&e.y==this.y}neg(){return new f(-this.x,-this.y)}static lineLineIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=fi.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!=null)return e.add(o.mul(u.x))}static segSegIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=E.tolerance,c=fi.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!=null&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,i){let n=e.length,o=t.length;return n<i||o<i?!0:(e=e.div(n),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<i)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new f(-this.y,this.x)}rotate90Cw(){return new f(this.y,-this.x)}clone(){return new f(this.x,this.y)}rotate(e){let t=Math.cos(e),i=Math.sin(e);return new f(t*this.x-i*this.y,i*this.x+t*this.y)}static mkPoint(e,t,i,n){return t.mul(e).add(n.mul(i))}static convSum(e,t,i){return t.add(i.sub(t).mul(e))}static anglePCP(e,t,i){return f.angle(e.sub(t),i.sub(t))}static angle(e,t){let i=e.x,n=e.y,o=t.x,a=t.y,l=i*a-n*o,u=i*o+n*a;if(Math.abs(u)<E.tolerance)return Math.abs(l)<E.tolerance?0:l<-E.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<E.tolerance)return u<-E.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-E.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,i){let n=f.signedDoubledTriangleArea(e,t,i);return n>E.distanceEpsilon?1:n<-E.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,i){let n=f.signedDoubledTriangleArea(e,t,i);return n>E.intersectionEpsilon?1:n<-E.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o),l=n.dot(n);return a<=0+E.tolerance?t:l<=a+E.tolerance?i:t.add(n.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,i){return f.signedDoubledTriangleArea(e,t,i)>=0}static pointToTheLeftOfLine(e,t,i){return f.signedDoubledTriangleArea(e,t,i)>0}static pointToTheRightOfLineOrOnLine(e,t,i){return f.signedDoubledTriangleArea(t,i,e)<=0}static pointToTheRightOfLine(e,t,i){return f.signedDoubledTriangleArea(t,i,e)<0}static canProject(e,t,i){let n=i.sub(t);return!(e.sub(t).dot(n)<0||e.sub(i).dot(n)>0)}static distToLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a,l;if((a=n.dot(o))<=E.tolerance)return{par:0,dist:o.length};if((l=n.dot(n))<=a+E.tolerance)return{par:1,dist:e.sub(i).length};let u=a/l;return{par:u,dist:t.add(n.mul(u)).length}}};var dt=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new dt;return t.point=e,t}};var fe=class{contains(e){let t=e.sub(this.corner),i=E.distanceEpsilon,n=t.dot(this.bRot);if(n>this.abRot+i||n<-i)return!1;let o=t.dot(this.aRot);return o<=this.baRot+i&&o>=-i}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let i=new fe,n=e.corner,o={minx:n.x,maxx:n.x,miny:n.y,maxy:n.y};return fe.pumpMinMax(o,e.aPlusCorner),fe.pumpMinMax(o,e.otherCorner),fe.pumpMinMax(o,e.bPlusCorner),fe.pumpMinMax(o,t.corner),fe.pumpMinMax(o,t.aPlusCorner),fe.pumpMinMax(o,t.otherCorner),fe.pumpMinMax(o,t.bPlusCorner),i.corner=new f(o.minx,o.miny),i.a=new f(0,o.maxy-o.miny),i.b=new f(o.maxx-o.minx,0),i.aPlusCorner=i.a.add(i.corner),i.otherCorner=i.b.add(i.aPlusCorner),i.bPlusCorner=i.b.add(i.corner),i.aRot=new f(-i.a.y,i.a.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new f(-i.b.y,i.b.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.a.dot(i.bRot),i.baRot=i.b.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=i.a.sub(i.b).length<E.distanceEpsilon,i}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(fe.separByA(e,t)||fe.separByA(t,e)||fe.separByB(e,t)||fe.separByB(t,e))==!1?!1:!(e.isSeg&&t.isSeg)||!f.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:fe.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let i=e.corner,n=e.otherCorner,o=t.corner,a=t.otherCorner,l=n.sub(i),u=0,c=l.dot(l),h=o.sub(i).dot(l),d=a.sub(i).dot(l);if(h>d){let p=h;h=d,d=p}return!(d<u-E.distanceEpsilon||h>c+E.distanceEpsilon)}static separByB(e,t){let i=E.distanceEpsilon,n=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(n>e.abRot+i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+i)return!1;return!0}else if(n<-i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-i)return!1;return!0}return!1}static separByA(e,t){let i=E.distanceEpsilon,n=t.corner.sub(e.corner),o=f.dot(n,e.aRot);return o>e.baRot+i?(n=t.aPlusCorner.sub(e.corner),!(f.dot(n,e.aRot)<=e.baRot+i||(n=t.bPlusCorner.sub(e.corner),f.dot(n,e.aRot)<=e.baRot+i)||(n=t.otherCorner.sub(e.corner),f.dot(n,e.aRot)<=e.baRot+i))):o<-i?(n=t.aPlusCorner.sub(e.corner),!(f.dot(n,e.aRot)>=-i||(n=t.bPlusCorner.sub(e.corner),f.dot(n,e.aRot)>=-i)||(n=t.otherCorner.sub(e.corner),f.dot(n,e.aRot)>=-i))):!1}static parallelogramByCornerSideSide(e,t,i){let n=new fe;return n.corner=e,n.a=t,n.b=i,n.aRot=new f(-t.y,t.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new f(-i.y,i.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.bRot.dot(t),n.baRot=i.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=t.sub(i).length<E.distanceEpsilon,n.aPlusCorner=t.add(e),n.otherCorner=i.add(n.aPlusCorner),n.bPlusCorner=i.add(e),n}static getParallelogramOfAGroup(e){let t=0,i=0,n=0,o=0,a=!0;for(let l of e){let u=sI(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=i=h,n=o=d):(h<t?t=h:h>i&&(i=h),d<n?n=d:d>o&&(o=d))}}return fe.parallelogramByCornerSideSide(new f(t,n),new f(0,o-n),new f(i-t,0))}};function*sI(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var O=class{constructor(e,t,i,n){this.parStart=0;this.parEnd=1;this.start=new f(e,t),this.end=new f(i,n)}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let i=this.value(e),n=this.value(t);return f.close(i,n,E.distanceEpsilon)?null:O.mkPP(i,n)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:fe.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new f(-e.y,e.x)}static mkPP(e,t){return new O(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,i){return new O(e.x,e.y,t,i)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new f(0,0)}thirdDerivative(e){return new f(0,0)}reverse(){return O.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return O.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<E.tolerance)return 0;let i=e/t;return i>1?1:i<0?0:i}transform(e){return O.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,i){let n=this.closestParameter(e);return n<t&&(n=t),n>i&&(n=i),n}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return V.mkPP(this.start,this.end)}clone(){return O.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o);if(a<=0+E.tolerance)return 0;let l=n.dot(n);return l<=a+E.tolerance?1:a/l}closestParameter(e){return O.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,i,n){let o=f.lineLineIntersection(e,t,i,n);if(o!=null&&O.xIsBetweenPoints(e,t,o)&&O.xIsBetweenPoints(i,n,o))return o}static xIsBetweenPoints(e,t,i){return e.sub(i).dot(t.sub(i))<=E.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,i,n){let o=t.sub(e),a=n.sub(i),l=e.sub(i),u=f.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),p=o.dot(l),y=a.dot(l),x,A,T=Math.abs(u),I=T,B=T;T<E.tolerance?(x=0,I=1,A=y,B=d):(x=f.crossProduct(a,l),A=f.crossProduct(o,l),u<0&&(x=-x,A=-A),x<0?(x=0,A=y,B=d):x>I&&(x=I=1,A=y+h,B=d)),A<0?(A=0,-p<0?x=0:-p>c?x=I:(x=-p,I=c)):A>B&&(A=B=1,-p+h<0?x=0:-p+h>c?x=I:(x=-p+h,I=c));let w=Math.abs(x)<E.tolerance?0:x/I,M=Math.abs(A)<E.tolerance?0:A/B;return{parab:w,parcd:M,dist:l.add(o.mul(w).sub(a.mul(M))).length}}};function aI(s,e,t,i,n){return{parallelogram:t,seg:i,leafBoxesOffset:n,node:{low:s,high:e,chord:null}}}var Qe=class{static distToSegm(e,t,i){let n=i.sub(t);if(n.length<E.intersectionEpsilon)return e.sub(t.add(i).div(2)).length;let o=new f(-n.y,n.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,i){let n=i.derivative(e),o=i.derivative(t),a=new f(-o.y,o.x),l=i.value(e),u=i.value(t),h=u.sub(l).dot(a),d=n.dot(a),p=Math.abs(h)<E.distanceEpsilon;if(!p&&Math.abs(d)<E.distanceEpsilon)return;let y=p?0:h/d;return n=n.mul(y),fe.parallelogramByCornerSideSide(l,n,u.sub(l).sub(n))}static createParallelogramNodeForCurveSeg(e,t,i,n){if(e==i.parStart&&t==i.parEnd&&f.close(i.start,i.end,E.distanceEpsilon))return Qe.createNodeWithSegmentSplit(e,t,i,n);let a=i.value(e),l=i.value(t),u=l.sub(a),c=i.value((e+t)/2);if(Qe.distToSegm(c,a,l)<=E.intersectionEpsilon&&u.dot(u)<E.lineSegmentThreshold*E.lineSegmentThreshold&&t-e<E.lineSegmentThreshold){let h=O.mkPP(a,l),d=h.pNodeOverICurve();d.seg=i;let p=d.node;return p.low=e,p.high=t,p.chord=h,d}if(Qe.WithinEpsilon(i,e,t,n)){let h=Qe.createParallelogramOnSubSeg(e,t,i);if(h!=null)return aI(e,t,h,i,n)}return Qe.createNodeWithSegmentSplit(e,t,i,n)}static WithinEpsilon(e,t,i,n){let a=(i-t)/3,l=e.value(t),u=e.value(i);return Qe.distToSegm(e.value(t+a),l,u)>n?!1:Qe.distToSegm(e.value(t+a*(3-1)),l,u)<=n}static createParallelogramNodeForCurveSegDefaultOffset(e){return Qe.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,E.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,i,n){let o={parallelogram:null,seg:i,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(Qe.createParallelogramNodeForCurveSeg(e,.5*(e+t),i,n)),a.children.push(Qe.createParallelogramNodeForCurveSeg(.5*(e+t),t,i,n)),o.parallelogram=fe.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var Fi=class{constructor(e,t,i,n,o){this.par0=e,this.par1=t,this.x=i,this.seg0=n,this.seg1=o}};var Ho=class{static closestPoint(e,t,i,n,o){let u=i,c=0,h=0,d,p=!1;do{let y=e.value(u),x=e.derivative(u),A=e.secondDerivative(u),T=x.dot(x)+y.sub(t).dot(A);if(Math.abs(T)<E.tolerance)return u;d=y.sub(t).dot(x.div(T)),u-=d,u>o+E.tolerance?(u=o,h++):u<n-E.tolerance&&(u=n,h++),c++}while(Math.abs(d)>E.tolerance&&!(p=c>=5||h>=5));return p&&e.value(i).sub(t).length<E.distanceEpsilon&&(u=i),u}};var re=class{offsetCurve(e,t){let i=t.sub(this.center),n=f.angle(this.aAxis,i);if(this.aAxis.mul(Math.cos(n)).add(this.bAxis.mul(Math.sin(n))).length<i.length){let a=this.aAxis.length,l=this.bAxis.length;return re.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return re.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,i){return new re(0,Math.PI*2,e,t,i)}constructor(e,t,i,n,o){this.parStart=e,this.parEnd=t,this.aAxis=i,this.bAxis=n,this.center=o,this.pNode=null,this.setBoundingBox()}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new re(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(f.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return f.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return f.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return f.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=Qe.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if($(this.parStart,0)&&$(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=V.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,i,n,o,a){return new re(e,t,i,n,new f(o,a))}static mkFullEllipsePPP(e,t,i){return new re(0,Math.PI*2,e,t,i)}static mkFullEllipseNNP(e,t,i){return new re(0,Math.PI*2,new f(e,0),new f(0,t),i)}static mkCircle(e,t){return re.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new re(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let i=this.parStart,n=this.parEnd,o=e+.001,a=e-.001;for(;n-i>E.distanceEpsilon;){let l=.5*(n+i),u=this.lengthPartial(this.parStart,l);if(u>o)n=l;else if(u<a)i=l;else return l}return(n+i)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),i=e.multiplyPoint(this.bAxis).sub(e.offset());return new re(this.parStart,this.parEnd,t,i,e.multiplyPoint(this.center))}return this}closestParameterWithinBounds(e,t,i){let o=(i-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),p=d.dot(d);p<l&&(l=p,a=h)}a==0&&i==Math.PI*2&&(t=-Math.PI);let u=Ho.closestPoint(this,e,a,t,i);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return v.lengthWithInterpolationAndThreshold(this.trim(e,t),E.lineSegmentThreshold/100)}get length(){return v.lengthWithInterpolation(this)}clone(){return new re(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,i=8,n=(this.parEnd-this.parStart)/(i+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=i;c++){let h=this.parStart+c*n,d=e.sub(this.value(h)),p=d.dot(d);p<a&&(a=p,o=h)}let l=!1;o==0&&this.parEnd==Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=Ho.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return f.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return V.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<E.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<E.tolerance&&f.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var lg=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,i,n,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=i,this.bMin=o,this.aMax=n,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,i,n){return e*n-i*t}solve(){let e=0,t=10,i=0,n=100,o=!1;if(this.initValues(),this.curveA instanceof O&&this.curveB instanceof O){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<E.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<E.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<E.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+E.distanceEpsilon||u<this.aMin-E.distanceEpsilon||c>this.bMax+E.distanceEpsilon||c<this.bMin-E.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),i++,o=e>=t||i>=n||a.s==0&&a.t==0&&h}while((Math.abs(a.s)>=E.tolerance||Math.abs(a.t)>=E.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<E.distanceEpsilon*E.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!=0&&e.t!=0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let i=1;this.ti+e.t>this.bMax?i=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(i=(this.bMin-this.ti)/e.t);let n=Math.min(t,i);e.s*=n,e.t*=n}else e.s==0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,i=e.start,n=e.end,o=t.start,a=t.end,l=n.sub(i),u=l.length,c=0,h,d,p;if(u>E.distanceEpsilon){l=l.div(u),h=l.dot(n.sub(i)),d=l.dot(o.sub(i)),p=l.dot(a.sub(i));let y=!1;if(d>p){y=!0;let x=d;d=p,p=x}if(p<c)this.aSolution=0,this.bSolution=y?0:1;else if(d>h)this.aSolution=1,this.bSolution=y?1:0;else{let x=Math.min(h,p);this.aSolution=x/(h-c),this.bSolution=(x-d)/(p-d),y&&(this.bSolution=1-this.bSolution)}}else{let y=a.sub(o),x=y.length;if(x>E.distanceEpsilon)if(y=y.div(x),c=0,h=y.dot(a.sub(o)),d=y.dot(i.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let A=Math.min(h,d);this.bSolution=A/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var we=class{constructor(e,t,i,n){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=i,this.b[3]=n,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=Qe.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,i=t*e;return this.l.mul(i).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=we.adjustParamTo01(e),t=we.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-E.tolerance)return new we(this.b[3],this.b[3],this.b[3],this.b[3]);let i=new Array(3),n=new Array(2),o=this.casteljau(e,i,n),a=new we(o,n[1],i[2],this.b[3]),l=a.casteljau((t-e)/(1-e),i,n);return new we(a.b[0],i[0],n[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,i){let n=1-e;for(let o=0;o<3;o++)t[o]=f.mkPoint(n,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)i[o]=f.mkPoint(n,t[o],e,t[o+1]);return f.mkPoint(n,i[0],e,i[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return f.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new we(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.pBoxNode=null}scaleFromOrigin(e,t){return new we(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return we.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,i,n){let o=n.sub(e).length,a=t.sub(e).length+i.sub(t).length+n.sub(i).length;if(a-o>E.lineSegmentThreshold){let l=f.middle(e,t),u=f.middle(t,i),c=f.middle(i,n),h=f.middle(l,u),d=f.middle(c,u),p=f.middle(h,d);return we.lengthOnControlPolygon(e,l,h,p)+we.lengthOnControlPolygon(p,d,c,n)}return(a+o)/2}get boundingBox(){let e=V.mkPP(this.b[0],this.b[1]);return e.add(this.b[2]),e.add(this.b[3]),e}transform(e){return new we(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,i){let n=(i-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*n+t)),c=u.dot(u);c<a&&(a=c,o=l*n+t)}return Ho.closestPoint(this,e,o,t,i)}clone(){return new we(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new we(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),i=this.Yp(e),n=t*t+i*i;return Math.sqrt(n*n*n)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let i=0,n=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<n&&(n=l,i=o*.125)}return Ho.closestPoint(this,e,i,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+i*i),c=t*n+i*o;return 3*(c*c/u+u*(n*n+t*a+o*o+i*l))}Gp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+i*i)*(t*n+i*o)}getParameterAtLength(e){let t=0,i=1;for(;i-t>E.tolerance;){let n=(i+t)/2,o=this.evaluateError(e,n);if(o>0)i=n;else if(o<0)t=n;else return n}return(t+i)/2}evaluateError(e,t){let i=1-t,n=f.mkPoint(i,this.b[0],t,this.b[1]),o=f.mkPoint(i,this.b[1],t,this.b[2]),a=f.mkPoint(i,this.b[2],t,this.b[3]),l=f.mkPoint(i,n,t,o),u=f.mkPoint(i,o,t,a),c=f.mkPoint(i,l,t,u),h=we.lengthOnControlPolygon(this.b[0],n,l,c);return h>e+E.distanceEpsilon?1:h<e-E.distanceEpsilon?-1:0}};function lI(s){return s.seg.value(s.par)}function uI(s){return s.seg.derivative(s.par)}function cI(s){return s.seg.secondDerivative(s.par)}function hI(s){return s.seg.thirdDerivative(s.par)}var v=class{static CurvesIntersect(e,t){return e==t||v.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(n.segIndex<o.segIndex){let a=this.segs[n.segIndex],l=a.lengthPartial(n.par,a.parEnd);for(let u=n.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new v;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=v.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let i=new v;for(let n of this.segs)i.addSegment(n.scaleFromOrigin(e,t));return i}trim(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(i.start),o=this.getSegIndexParam(i.end);if(n.segIndex==o.segIndex)return this.segs[n.segIndex].trim(n.par,o.par);let a=new v;n.par<this.segs[n.segIndex].parEnd&&(a=a.addSegment(this.segs[n.segIndex].trim(n.par,this.segs[n.segIndex].parEnd)));for(let l=n.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let i=new v;return i.addSegment(this.trim(e,this.parEnd)),i.addSegment(this.trim(this.parStart,t)),i}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(!(e instanceof v))this.segs.push(e),this.parEnd_+=v.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=v.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let i of this.segs){let n=i.pNodeOverICurve();e.push(n.parallelogram),t.push(n)}return this.pBNode={parallelogram:fe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:E.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,i){let n=v.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return i&&n!=null&&(n=v.liftIntersectionToCurves(e,t,n)),n}static getAllIntersections(e,t,i){return e instanceof O?v.getAllIntersectionsOfLineAndICurve(e,t,i):v.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsInternal(e,t,i){let n=[];if(v.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),n),i)for(let o=0;o<n.length;o++)n[o]=v.liftIntersectionToCurves(e,t,n[o]);return n}static getAllIntersectionsOfLineAndICurve(e,t,i){return t instanceof q?v.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof v?v.getAllIntersectionsOfLineAndCurve(e,t,i):t instanceof re&&t.isArc()?v.getAllIntersectionsOfLineAndArc(e,t):v.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsOfLineAndCurve(e,t,i){let n=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(fe.intersect(o.parallelogram,a.parallelogram)==!1)return n;let l=0;for(let u of t.segs){let c=v.getAllIntersections(e,u,!1);if(i){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)v.alreadyInside(n,h)||n.push(h)}return n}static closeIntersections(e,t){return f.close(e.x,t.x,E.intersectionEpsilon)}static closeIntersectionPoints(e,t){return f.close(e,t,E.intersectionEpsilon)}static alreadyInside(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(v.closeIntersections(n,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let i=e.end.sub(e.start),n=[],o=i.length;if(o<E.distanceEpsilon){let d=e.start.sub(t.center);if($(d.length,t.aAxis.length)){let p=f.angle(t.aAxis,d);t.parStart-E.tolerance<=p&&(p=Math.max(p,t.parStart),p<=t.parEnd+E.tolerance&&(p=Math.min(t.parEnd,p),n.push(new Fi(0,p,e.start,e,t))))}return n}let a=i.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-E.distanceEpsilon)return n;if(i=a.rotate90Cw(),$(c,h))v.tryToAddPointToLineCircleCrossing(e,t,n,u,o,i);else{let d=Math.sqrt(c*c-l*l),p=i.mul(d);v.tryToAddPointToLineCircleCrossing(e,t,n,u.add(p),o,i),v.tryToAddPointToLineCircleCrossing(e,t,n,u.sub(p),o,i)}return n}static tryToAddPointToLineCircleCrossing(e,t,i,n,o,a){let u=n.sub(e.start).dot(a);if(u<-E.distanceEpsilon||(u=Math.max(u,0),u>o+E.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=f.angle(t.aAxis,n.sub(t.center));t.parStart-E.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+E.tolerance&&(c=Math.min(t.parEnd,c),i.push(new Fi(u,c,n,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let i=[],n=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=v.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a!=null&&(v.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),v.oldIntersection(i,a.x)||i.push(new Fi(a.aSol,n+a.bSol,a.x,e,t))),n++}if(t.closed){let a=v.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a!=null&&(v.adjustSolution(e.start,e.end,o.point,t.start,a),v.oldIntersection(i,a.x)||i.push(new Fi(a.aSol,n+a.bSol,a.x,e,t)))}return i}static adjustSolution(e,t,i,n,o){v.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):v.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),v.closeIntersectionPoints(o.x,i)?(o.x=i,o.bSol=Math.floor(o.bSol)):v.closeIntersectionPoints(o.x,n)&&(o.x=n,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!fe.intersect(e.parallelogram,t.parallelogram))return null;let i=e.node,n=t.node,o=i.hasOwnProperty("children"),a=n.hasOwnProperty("children");if(o&&a)for(let l of i.children)for(let u of n.children){let c=v.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of n.children){let u=v.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of i.children){let u=v.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return v.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,i){if(!fe.intersect(e.parallelogram,t.parallelogram))return;let n=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(n&&o)for(let a of e.node.children)for(let l of t.node.children)v.curveCurveXWithParallelogramNodes(a,l,i);else if(o)for(let a of t.node.children)v.curveCurveXWithParallelogramNodes(e,a,i);else if(n)for(let a of e.node.children)v.curveCurveXWithParallelogramNodes(a,t,i);else i=v.crossOverLeaves(e,t,i)}static crossOverIntervalsOne(e,t){let i=e.node,n=t.node,o=(i.high-i.low)/2,a=(n.high-n.low)/2;for(let l=1;l<2;l++){let u=l*o+i.low;for(let c=1;c<2;c++){let h=c*a+n.low,d;if(i.chord==null&&n.chord==null?d=v.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,n.low,n.high,u,h):i.chord!=null&&n.chord==null?d=v.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,n.low,n.high,.5*l,h):i.chord==null?(d=v.crossWithinIntervalsWithGuess(e.seg,n.chord,i.low,i.high,0,1,u,.5*c),d!=null&&(d.bSol=n.low+d.bSol*(n.high-n.low))):(d=v.crossWithinIntervalsWithGuess(i.chord,n.chord,0,1,0,1,.5*l,.5*c),d!=null&&(d.aSol=i.low+d.aSol*(i.high-i.low),d.bSol=n.low+d.bSol*(n.high-n.low))),d!=null)return v.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return v.goDeeperOne(e,t)}static crossOverLeaves(e,t,i){let n=e.node,o=t.node,a=!1,l=(n.high-n.low)/2+n.low,u=(o.high-o.low)/2+o.low,c;return n.chord==null&&o.chord==null?c=v.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,o.low,o.high,l,u):n.chord!=null&&o.chord==null?(c=v.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,o.low,o.high,.5,u),c!=null&&(c.aSol=n.low+c.aSol*(n.high-n.low))):n.chord==null?(c=v.crossWithinIntervalsWithGuess(e.seg,o.chord,n.low,n.high,0,1,l,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=v.crossWithinIntervalsWithGuess(n.chord,o.chord,0,1,0,1,.5,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=n.low+c.aSol*(n.high-n.low))),c!=null&&(v.addIntersection(e,t,i,c),a=!0),a||v.goDeeper(i,e,t),i}static addIntersection(e,t,i,n){let o=e.node;v.closeIntersectionPoints(n.x,e.seg.value(o.low))?(n.x=e.seg.value(o.low),n.aSol=o.low):v.closeIntersectionPoints(n.x,e.seg.value(o.high))&&(n.x=e.seg.value(o.high),n.aSol=o.high);let a=t.node;if(v.closeIntersectionPoints(n.x,t.seg.value(a.low))?(n.x=t.seg.value(a.low),n.bSol=a.low):v.closeIntersectionPoints(n.x,t.seg.value(a.high))&&(n.x=t.seg.value(a.high),n.bSol=a.high),!v.oldIntersection(i,n.x)){let u=new Fi(n.aSol,n.bSol,n.x,e.seg,t.seg);i.push(u)}}static oldIntersection(e,t){for(let i of e)if(t.sub(i.x).length<E.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,i,n,o){let a=e.node,l=t.node;return v.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),i=a.low):v.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),i=a.high),v.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),n=l.low):v.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),n=l.high),new Fi(i,n,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,i,n,o,a,l){let u=this.liftParameterToCurve(e,i-a.parStart,a),c=this.liftParameterToCurve(t,n-l.parStart,l);return new Fi(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,i;if(e.seg0 instanceof v){let a=e.seg0.getSegParam(e.par0);t=a.seg,i=a.par}else i=e.par0,t=e.seg0;let n,o;if(e.seg1 instanceof v){let a=e.seg1.getSegParam(e.par1);o=a.par,n=a.seg}else o=e.par1,n=e.seg1;return new Fi(i,o,e.x,t,n)}static liftIntersectionToCurves(e,t,i){return v.liftIntersectionToCurves_(e,t,i.par0,i.par1,i.x,i.seg0,i.seg1)}static liftParameterToCurve(e,t,i){if(e==i)return t;if(!e.hasOwnProperty("segs"))return;let n=e,o=0;for(let a of n.segs){if(a==i)return t+o;o+=v.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let i=e.node,n=t.node;if(e.leafBoxesOffset>E.distanceEpsilon&&t.leafBoxesOffset>E.distanceEpsilon){let l=Qe.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2),u=Qe.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>E.distanceEpsilon){let l=Qe.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>E.distanceEpsilon){let l=Qe.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(i.low),a=e.seg.value(i.high);if(!f.closeDistEps(o,a)){let l=t.seg.value(n.low),u=t.seg.value(n.high);if(!f.closeDistEps(l,u)){let c=e.seg instanceof O?e.seg:O.mkPP(o,a),h=t.seg instanceof O?t.seg:O.mkPP(l,u),d=v.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d!=null)return v.adjustParameters(e,c,t,h,d),v.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,i){let n=t.node,o=i.node;if(t.leafBoxesOffset>E.distanceEpsilon&&i.leafBoxesOffset>E.distanceEpsilon){let a=Qe.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2),l=Qe.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(a,l,e)}else if(t.leafBoxesOffset>E.distanceEpsilon){let a=Qe.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(a,i,e)}else if(i.leafBoxesOffset>E.distanceEpsilon){let a=Qe.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(t,a,e)}else{let a=t.seg.value(n.low),l=t.seg.value(n.high);if(!f.closeDistEps(a,l)){let u=i.seg.value(o.low),c=i.seg.value(o.high);if(!f.closeDistEps(u,c)){let h=t.seg instanceof O?t.seg:O.mkPP(a,l),d=i.seg instanceof O?i.seg:O.mkPP(u,c),p=v.crossWithinIntervalsWithGuess(h,d,0,1,0,1,.5,.5);p!=null&&(v.adjustParameters(t,h,i,d,p),v.addIntersection(t,i,e,p))}}}}static adjustParameters(e,t,i,n,o){if(t!=e.seg&&!(e.seg instanceof q))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(n!=i.seg&&!(i.seg instanceof q))o.bSol=i.seg.closestParameter(o.x);else{let a=i.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let n of this.segs){let o=t+n.parEnd-n.parStart;if(e>=t&&e<=o)return{par:e-t+n.parStart,seg:n};t=o}let i=this.segs[this.segs.length-1];return{seg:i,par:i.parEnd}}getSegIndexParam(e){let t=0,i=this.segs.length;for(let o=0;o<i;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let n=this.segs[i-1];return{segIndex:i-1,par:n.parEnd}}value(e){return lI(this.getSegParam(e))}derivative(e){return uI(this.getSegParam(e))}secondDerivative(e){return cI(this.getSegParam(e))}thirdDerivative(e){return hI(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,i,n,o,a,l,u){if(e instanceof O&&t instanceof O){let d=v.crossTwoLineSegs(e.start,e.end,t.start,t.end,i,n,o,a);if(d!=null)return d}let c=v.minDistWithinIntervals(e,t,i,n,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=E.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:f.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,i,n,o,a,l,u){let c=t.sub(e),h=i.sub(n),d=i.sub(e),p=fi.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(p==null)return;let y=p.x,x=p.y,A=e.add(c.mul(y));if(!(y<o-E.tolerance)&&(y=Math.max(y,o),!(y>a+E.tolerance)&&(y=Math.min(y,a),!(x<l-E.tolerance)&&(x=Math.max(x,l),!(x>u+E.tolerance)))))return x=Math.min(x,u),{aSol:y,bSol:x,x:A}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let i=2*t.boundingBox.diagonal,n=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new f(Math.cos(a*n),Math.sin(a*n)),u=O.mkPP(e,e.add(l.mul(i))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(v.AllIntersectionsAreGood(c,t)){for(let d of c)if(f.closeDistEps(d.x,e))return 1;if(c.length%2==1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let i=t.hasOwnProperty("segs"),n=null;if(i||t instanceof q&&(n=t.toCurve()),n){for(let o of e)if(!v.RealCut(v.DropIntersectionToSegs(o),n,!1))return!1}return!0}static RealCut(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(f.closeDistEps(u,o.end)){let p=null;for(let A=0;A<t.segs.length-1;A++)if(t.segs[A]==o){p=t.segs[A+1];break}if(p==null)return!1;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parEnd))*y.dot(p.derivative(p.parStart))<E.tolerance)}if(f.closeDistEps(u,o.start)){let p=null;for(let A=t.segs.length-1;A>0;A--)if(t.segs[A]==o){p=t.segs[A-1];break}if(p==null)return!1;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parStart))*y.dot(p.derivative(p.parEnd))<E.tolerance)}let d=c.dot(h);return i?d>E.distanceEpsilon:Math.abs(d)>E.distanceEpsilon}static realCutWithClosedCurve(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(f.closeDistEps(u,o.end)){let p=null;for(let A=0;A<t.segs.length;A++)if(t.segs[A]==o){p=t.segs[(A+1)%t.segs.length];break}if(p==null)throw new Error;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parEnd))*y.dot(p.derivative(p.parStart))<E.tolerance)}if(f.closeDistEps(u,o.start)){let p=null;for(let A=0;A<t.segs.length;A++)if(t.segs[A]==o){p=t.segs[A>0?A-1:t.segs.length-1];break}let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parStart))*y.dot(p.derivative(p.parEnd))<E.tolerance)}let d=c.dot(h);return i?d>E.distanceEpsilon:Math.abs(d)>E.distanceEpsilon}static minDistWithinIntervals(e,t,i,n,o,a,l,u){let c=new lg(e,t,i,n,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.segs.length==0)return V.mkEmpty();let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return e}clone(){let e=new v;for(let t of this.segs)e.addSegment(t.clone());return e}getParameterAtLength(e){let t=0;for(let i of this.segs){let n=i.length;if(n>=e)return t+i.getParameterAtLength(e);e-=n,t+=i.parEnd-i.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new v;for(let i of this.segs)t.addSegment(i.transform(e));return t}closestParameterWithinBounds(e,t,i){let n=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>i)break;let u=v.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(i-a)),p=l.closestParameterWithinBounds(e,h,d),y=e.sub(l.value(p)),x=y.dot(y);x<o&&(n=a+p-l.parStart,o=x)}a+=u}return n}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);u<i&&(t=n+a-o.parStart,i=u),n+=v.paramSpan(o)}return t}static addLineSegment(e,t,i){return e.addSegment(O.mkPP(t,i))}static addLineSegmentCNNP(e,t,i,n){return v.addLineSegment(e,new f(t,i),n)}static addLineSegmentCNNNN(e,t,i,n,o){v.addLineSegment(e,new f(t,i),new f(n,o))}static continueWithLineSegmentNN(e,t,i){v.addLineSegment(e,e.end,new f(t,i))}static continueWithLineSegmentP(e,t){v.addLineSegment(e,e.end,t)}static closeCurve(e){return v.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<E.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=v.paramSpan(t),Math.abs(e)<E.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<E.tolerance)return this.start==this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<E.tolerance)return t;e-=v.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let i=v.getAllIntersections(e,t,!0);if(i.length==0)return v.NonIntersectingCurveIsInsideOther(e,t);if(i.length==1)return e.start.equal(i[0].x)?v.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:v.PointRelativeToCurveLocation(e.start,t)==2;for(let n of v.PointsBetweenIntersections(e,i))if(v.PointRelativeToCurveLocation(n,t)==0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let i=t[t.length-1].par0,n=t[0].par0,o=e.parEnd-i+(n-e.parStart),a=i+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let i=e.parStart;i<e.parEnd;i+=.5){let n=v.PointRelativeToCurveLocation(e.value(i),t);if(n!=1)return n==2}return v.PointRelativeToCurveLocation(e.end,t)!=0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let i=v.getAllIntersections(e,t,!0);if(i.length==0)return v.NonIntersectingCurveIsInsideOther(e,t)||v.NonIntersectingCurveIsInsideOther(t,e);if(i.length==1)return e.start.equal(i[0].x)?v.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2||!t.start.equal(i[0].x)?v.PointRelativeToCurveLocation(t.start,e)==2:v.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)==2:v.PointRelativeToCurveLocation(e.start,t)==2;for(let n of v.PointsBetweenIntersections(e,i))if(v.PointRelativeToCurveLocation(n,t)==2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,i,n,o){let a=f.mkPoint(e,i.point,1-e,n.point),l=f.mkPoint(t,o.point,1-t,n.point),u=n.point.mul(2/3);return new we(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,i,n){let o=i.mul(n);return new we(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let i=t.next;if(i!=null)return{b:t,c:i}}static trimEdgeSplineWithNodeBoundaries(e,t,i,n){let o=i.parStart,a=i.parEnd;e!=null&&(o=v.findNewStart(i,o,e,n)),t!=null&&(a=v.findNewEnd(i,t,n,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?i.trim(l,u):i}static findNewEnd(e,t,i,n){let o=v.getAllIntersections(e,t,!0);if(o.length==0)return n=e.parEnd,n;if(i){n=e.parEnd;for(let a of o)a.par0<n&&(n=a.par0)}else{n=e.parStart;for(let a of o)a.par0>n&&(n=a.par0)}return n}static findNewStart(e,t,i,n){let o=v.getAllIntersections(e,i,!0);if(o.length==0){t=e.parStart;return}if(n){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof re)return v.refineEllipse(e);if(e instanceof q)return e;if(e instanceof v&&v.allSegsAreLines(e)){let t=new q;for(let i of e.segs)t.addPoint(i.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof O))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),i=Math.PI/4,n=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(n*n+o*o),l=[];for(let c=0;c<4;c++){let h=i+c*Math.PI/2,d=e.value(h),p=e.derivative(h).normalize().mul(a),y=O.mkPP(d.sub(p),d.add(p));for(let x of v.getAllIntersections(t,y,!0))l.push(x)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new q;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new q;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};function dI(s,e,t,i,n,o){if(n instanceof O)return!0;for(let a of[1/3,.5,2/3]){let l=s*a+t*(1-a);if(f.closeSquare(n.value(l),f.mkPoint(a,e,1-a,i),o)==!1)return!1}return!0}function ug(s,e,t,i,n,o){let a=[];if(dI(s,e,t,i,n,o))a.push(e),a.push(i);else{let l=.5*(s+t),u=n.value(l);a=ug(s,e,l,u,n,o);let c=ug(l,u,t,i,n,o).slice(1);a=a.concat(c)}return a}function Dc(s,e){return ug(s.parStart,s.start,s.parEnd,s.end,s,e)}var q=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new f(e,t))}isClockwise(){return f.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new dt;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=dt.mkFromPoint(e);t.polyline=this,this.startPoint!=null?f.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let i=t.sub(e).div(2);return fe.parallelogramByCornerSideSide(e,i,i)}static mkFromPoints(e){let t=new q;for(let i of e)t.addPoint(i);return t}static mkClosedFromPoints(e){let t=q.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],i=this.startPoint,n=0;for(;i.next!=null;){let o=q.parallelogramOfLineSeg(i.point,i.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:O.mkPP(i.point,i.next.point)}}),i=i.next,n++}if(this.isClosed_){let o=q.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:O.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:fe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=V.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return f.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new f(0,0)}thirdDerivative(e){return new f(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new q;t.addPoint(e.start);for(let i of e.segs)t.addPoint(i.end);return t.closed=e.start==e.end,t}trim(e,t){let i=this.toCurve();return i=i.trim(e,t),q.polylineFromCurve(i)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t==this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new q;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t==this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new q;for(let i of this.polylinePoints())t.addPoint(e.multiplyPoint(i.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,i){throw new Error("Method not implemented.")}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0,o=this.startPoint;for(;o.next!=null;){let a=O.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<i&&(i=c,t=l+n),o=o.next,n++}if(this.closed){let a=O.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<i&&(t=l+n)}return t}clone(){let e=new q;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t==this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new v;v.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)v.continueWithLineSegmentP(e,t.point);return this.closed&&v.continueWithLineSegmentP(e,this.startPoint.point),e}};var At=class{pad(e){this.width+=e*2}constructor(e,t){this.width=e,this.height=t}},V=class{static mkSizeCenter(e,t){let i=e.width/2,n=e.height/2;return new V({left:t.x-i,right:t.x+i,bottom:t.y-n,top:t.y+n})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return V.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=V.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),i=Math.min(this.right,e.right),n=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new V({left:t,bottom:n,right:i,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=e.sub(this.center);this.leftTop=this.leftTop.add(t),this.rightBottom=this.rightBottom.add(t)}intersectsOnY(e){return!(e.bottom_>this.top_+E.distanceEpsilon||e.top_<this.bottom_-E.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+E.distanceEpsilon||e.right<this.left_-E.distanceEpsilon)}static mkEmpty(){return new V({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e}get right(){return this.right_}set right(e){this.right_=e}get top(){return this.top_}set top(e){this.top_=e}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e}get leftBottom(){return new f(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new f(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new f(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new f(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}static mkPP(e,t){let i=new V({left:e.x,right:e.x,top:e.y,bottom:e.y});return i.add(t),i}static rectangleOnPoint(e){return new V({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,i){let n=e+i.width,o=t+i.height;return new V({left:e,right:n,top:o,bottom:t})}static getRectangleOnCoords(e,t,i,n){let o=new V({left:e,bottom:t,right:e,top:t});return o.add(new f(i,n)),o}static mkOnPoints(e){let t=V.mkEmpty();for(let i of e)t.add(i);return t}static rectangleOnRectangles(e){let t=V.mkEmpty();for(let i of e)t.addRecSelf(i);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,i=(this.left_+this.right_)/2;this.left_=i-t,this.right_=i+t}isEmpty(){return this.width<0}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,i=(this.top_+this.bottom_)/2;this.top_=i+t,this.bottom=i-t}static rectangleOfTwo(e,t){let i=new V({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return i.addRecSelf(t),i}containsWithPadding(e,t){return this.left_-t-E.distanceEpsilon<=e.x&&e.x<=this.right_+t+E.distanceEpsilon&&this.bottom_-t-E.distanceEpsilon<=e.y&&e.y<=this.top_+t+E.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addWithCheck(e){let t;(t=e.x<this.left_)?this.left_=e.x:(t=this.right_<e.x)&&(this.right_=e.x);let i;return(i=e.y>this.top_)?this.top_=e.y:(i=this.bottom_>e.y)&&(this.bottom=e.y),t||i}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let i=e.clone();return i.center=e.center.add(t),i}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?V.mkPP(new f(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new f(Math.min(e.right,t.right),Math.min(e.top,t.top))):V.mkEmpty()}perimeter(){let e=new q;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return V.mkPP(this.leftTop,this.rightBottom)}get size(){return new At(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let i=e.width/2,n=t.x-i,o=t.x+i,a=e.height/2,l=t.y-a,u=t.y+a;return new V({left:n,right:o,top:u,bottom:l})}addPointWithSize(e,t){let i=e.width/2,n=e.height/2;this.add(new f(t.x-i,t.y-n)),this.add(new f(t.x+i,t.y-n)),this.add(new f(t.x-i,t.y+n)),this.add(new f(t.x+i,t.y+n))}};var Gc=class{bind(){this.entity&&this.entity.setAttr(Gc.attachIndex,this)}constructor(e){this.entity=e,this.bind()}static getGeom(e){return e.getAttr(Gc.attachIndex)}},Le=Gc;Le.attachIndex=0;var lt=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,i){this.elements[e][t]=i}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return $(this.elements[0][0],1)&&$(this.elements[0][1],0)&&$(this.elements[0][2],0)&&$(this.elements[1][0],0)&&$(this.elements[1][1],1)&&$(this.elements[1][2],0)}offset(){return new f(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new lt(1,0,0,0,1,0)}constructor(e,t,i,n,o,a){this.elements=[[e,t,i],[n,o,a]]}static rotation(e){let t=Math.cos(e),i=Math.sin(e);return new lt(t,-i,0,i,t,0)}static scaleAroundCenterTransformation(e,t,i){let n=1-e,o=1-t;return new lt(e,0,n*i.x,0,t,o*i.y)}multiplyPoint(e){return new f(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new lt(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,i=-this.getElem(0,1)/e,n=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-i*this.getElem(1,2),l=-n*this.getElem(0,2)-o*this.getElem(1,2);return new lt(t,i,a,n,o,l)}};var dr=class{static get DifferenceEpsilon(){return dr.differenceEpsilon}static EqualPP(e,t){return dr.Equal(e.x,t.x)&&dr.Equal(e.y,t.y)}static Equal(e,t){return dr.Compare(e,t)==0}static Compare(e,t){let i=0;return e+dr.DifferenceEpsilon<t?i=-1:t+dr.DifferenceEpsilon<e&&(i=1),i}static ComparePP(e,t){let i=dr.Compare(e.x,t.x);return i==0&&(i=dr.Compare(e.y,t.y)),i}static LessOrEqual(e,t){let i=dr.Compare(e,t);return i<0||i==0}static Less(e,t){return dr.Compare(e,t)<0}static GetDirections(e,t){return _.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return _.IsPureDirection(dr.GetDirections(e,t))}static IsPureDirectionD(e){return _.IsPureDirection(e)}static IsPureLower(e,t){let i=dr.GetDirections(e,t);return 2==i||1==i}static GetPureDirectionVV(e,t){return dr.GetDirections(e.point,t.point)}},N=dr;N.differenceEpsilon=E.distanceEpsilon/2;var _=class{constructor(e){this.Dir=e}get Right(){return new _(_.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>N.DifferenceEpsilon?t=2:e.x<-N.DifferenceEpsilon&&(t=8),e.y>N.DifferenceEpsilon?t=t|1:e.y<-N.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let i=0,n=t.x-e.x,o=t.y-e.y;return n>N.DifferenceEpsilon?i=2:-n>N.DifferenceEpsilon&&(i=8),o>N.DifferenceEpsilon?i|=1:-o>N.DifferenceEpsilon&&(i|=4),i}static DirectionFromPointToPoint(e,t){return _.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return _.IsPureDirection(_.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e==t||e==_.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)==2&&e++,(this.Dir&1)==1&&t++,(this.Dir&8)==8&&e--,(this.Dir&4)==4&&t--,new f(e,t)}static toPoint(e){return new _(e).ToPoint()}static negate(e){return new _(_.OppositeDir(e.Dir))}};var Vi=class{static createHexagon(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y;return q.mkClosedFromPoints([new f(o*-1+a,n*-1+l),new f(o+a,n*-1+l),new f(o+(n+a),0+l),new f(o+a,n+l),new f(o*-1+a,n+l),new f((o-n)*-1+a,0+l)])}static createOctagon(e,t,i){let n=e/2,o=t/2,a=new Array(8);a[0]=new f(n+Vi.octagonPad*n,o-o*Vi.octagonPad),a[3]=new f(a[0].x*-1,a[0].y),a[4]=new f(a[3].x,a[3].y*-1),a[7]=new f(a[0].x,a[0].y*-1),a[1]=new f(n-n*Vi.octagonPad,o+o*Vi.octagonPad),a[2]=new f(a[1].x*-1,a[1].y),a[6]=new f(a[1].x,a[1].y*-1),a[5]=new f(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(i);return q.mkClosedFromPoints(a)}static createInvertedHouse(e,t,i){let n=Vi.createHouse(e,t,i);return Vi.rotateCurveAroundCenterByDegree(n,i,180)}static createHouse(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new v;return v.addLineSegmentCNNNN(u,a-n,l-o,a+n,l-o),v.continueWithLineSegmentNN(u,a+n,l+o),v.continueWithLineSegmentNN(u,a,l+2*o),v.continueWithLineSegmentNN(u,a-n,l+o),v.closeCurve(u)}static CreateDiamond(e,t,i){let n=e,o=t,a=i.x,l=i.y,u=new v,c=[new f(a,l-o),new f(a+n,l),new f(a,l+o),new f(a-n,l)];return u.addSegs([O.mkPP(c[0],c[1]),O.mkPP(c[1],c[2]),O.mkPP(c[2],c[3]),O.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,i){return Vi.rotateCurveAroundCenterByRadian(e,t,i*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,i){let n=Math.cos(i),o=Math.sin(i),a=new lt(1,0,t.x,0,1,t.y).multiply(new lt(n,-o,0,o,n,0)).multiply(new lt(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return re.mkCircle(e,t)}static createRectangle(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new v,c=[new f(a-n,l-o),new f(a+n,l-o),new f(a+n,l+o),new f(a-n,l+o)];return u.addSegs([O.mkPP(c[0],c[1]),O.mkPP(c[1],c[2]),O.mkPP(c[2],c[3]),O.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof v))return;let t=e.segs;if(t.length!=8&&t.length!=4)return;let i=t.length==8,n,o;for(let a=0;a<4;a++){let l=i?2*a+1:a;if(a==0){if(!(t[l]instanceof re))return;let u=t[l];n=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof re))return;let u=t[l];if(n!=u.aAxis.length||o!=u.bAxis.length)return}}return{radX:n,radY:o}}static mkRectangleWithRoundedCorners(e,t,i,n,o=new f(0,0)){if(i==0||n==0)return Vi.createRectangle(e,t,o);let a=new v,l=e/2;i>l/2&&(i=l/2);let u=t/2;n>u/2&&(n=u/2);let c=o.x,h=o.y,d=l-i,p=u-n,y=h+u,x=h-u,A=c-l,T=c+l,I=new f(i,0),B=new f(0,n);return d>0&&a.addSegment(O.mkPP(new f(c-d,x),new f(c+d,x))),a.addSegment(re.mkEllipse(1.5*Math.PI,2*Math.PI,I,B,c+d,h-p)),p>0&&a.addSegment(O.mkPP(new f(T,h-p),new f(T,h+p))),a.addSegment(re.mkEllipse(0,.5*Math.PI,I,B,c+d,h+p)),d>0&&a.addSegment(O.mkPP(new f(c+d,y),new f(c-d,y))),a.addSegment(re.mkEllipse(.5*Math.PI,Math.PI,I,B,c-d,h+p)),p>0&&a.addSegment(O.mkPP(new f(A,h+p),new f(A,h-p))),a.addSegment(re.mkEllipse(Math.PI,1.5*Math.PI,I,B,c-d,h-p)),a}},Se=Vi;Se.octagonPad=1/4;var la=class extends Le{constructor(){super(...arguments);this.padding=1}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(e){(e!=null&&e.boundingBox.height<la.minHeight||e.boundingBox.width<la.minWidth)&&(e=Se.mkCircle(la.minWidth,e.boundingBox.center)),this._boundaryCurve=e}get id(){return this.node.id}toString(){return this.id}static mkNode(e,t){let i=new la(t);return i.boundaryCurve=e,i}get center(){return this.boundaryCurve.boundingBox.center}set center(e){let t=e.sub(this.center);this.boundaryCurve.translate(t)}fitBoundaryCurveToTarget(e){if(this.boundaryCurve!=null){let t=Se.isRoundedRect(this.boundaryCurve);if(t==null){let i=e.width/this.boundaryCurve.boundingBox.width,n=e.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(i,n),this.boundaryCurve.translate(e.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=Se.mkRectangleWithRoundedCorners(e.width,e.height,t.radX,t.radY,e.center)}}*inEdges(){for(let e of this.node.inEdges)yield Le.getGeom(e)}*outEdges(){for(let e of this.node.outEdges)yield Le.getGeom(e)}*selfEdges(){for(let e of this.node.selfEdges)yield Le.getGeom(e)}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(e){!this.boundaryCurve||(Math.abs(e.width-this.width)<1e-4&&Math.abs(e.height-this.height)<1e-4?this.center=e.center:this.fitBoundaryCurveToTarget(e))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(e,t=!0){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e))}underCollapsedCluster(){return this.node!=null&&this.node.isUnderCollapsedGraph()}},_r=la;_r.minHeight=2,_r.minWidth=3;var Ge=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new Ge;return t.point=e,t}static mkSiteSP(e,t){let i=new Ge;return i.point=t,i.prev=e,e.next=i,i}static mkSiteSPS(e,t,i){let n=new Ge;return n.prev=e,n.point=t,n.next=i,e.next=n,i.prev=n,n}get turn(){return this.next==null||this.prev==null?0:f.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new Ge;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var Ze=class{static mkFromPoints(e){let t=null,i=null;for(let n of e)if(i==null)i=Ge.mkSiteP(n),t=new Ze(i);else{let o=Ge.mkSiteP(n);o.prev=i,i.next=o,i=o}return t}clone(){let e=this.headSite,t=null,i,n=null;for(;e!=null;)i=e.clone(),i.prev=t,t!=null?t.next=i:n=i,e=e.next,t=i;return new Ze(n)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield O.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new v,t=this.headSite,i;do{let n=v.findCorner(t);if(n==null)break;let o=Ze.createBezierSegOnSite(n.b);e.segs.length==0?f.closeDistEps(t.point,o.start)||v.addLineSegment(e,t.point,o.start):f.closeDistEps(e.end,o.start)||v.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=n.b}while(!0);return e.segs.length==0?f.closeDistEps(t.point,t.next.point)?e.segs.push(new we(t.point,t.point.add(new f(5,5)),t.point.add(new f(-5,5)),i.point)):v.addLineSegment(e,t.point,t.next.point):f.closeDistEps(e.end,t.next.point)||v.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,i=e.nextBezierCoefficient,n=e.prev,o=e.next,a=n.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(i).add(e.point.mul(1-i)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return we.mkBezier([a,u,c,l])}};var Jr=class{constructor(){this.length=Jr.defaultArrowheadLength;this.width=0}clone(){let e=new Jr;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=Jr.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let i=Jr.findTrimEndForArrowheadAtTarget(e);if(i==null||t>i-E.intersectionEpsilon||v.closeIntersectionPoints(e.curve.value(t),e.curve.value(i)))return!1;let n=e.curve.trim(t,i);return n==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=n,!0)}static getIntersectionsWithArrowheadCircle(e,t,i){let n=re.mkFullEllipseNNP(t,t,i);return v.getAllIntersections(n,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=E.distanceEpsilon*E.distanceEpsilon,i=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=E.distanceEpsilon)return i;let n=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u==0)return;l=Jr.getIntersectionsWithArrowheadCircle(n,o,n.end),i=l.length!=0?Math.max(...l.map(c=>c.par1)):n.parEnd,a=e.curve.value(i),o/=2}while(a.sub(n.start).lengthSquared<t||l.length==0);return i}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=E.distanceEpsilon)return e.curve.parStart;let t=E.distanceEpsilon*E.distanceEpsilon,i=e.sourceArrowhead.length,n,o=e.curve,a,l=10,u;for(;--l>0;){if(a=Jr.getIntersectionsWithArrowheadCircle(o,i,o.start),a.length==0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),n=a.filter(c=>c.par1==u)[0].x,n.sub(o.end).lengthSquared>=t)return u;i/=2}}static trimSplineAndCalculateArrowheads(e,t,i){return Jr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,i)}static trimSplineAndCalculateArrowheadsII(e,t,i,n,o){if(e.curve=v.trimEdgeSplineWithNodeBoundaries(t,i,n,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<E.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<E.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>E.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>E.intersectionEpsilon)&&!a&&(a=Jr.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!=0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=n.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=n.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,i=e.target.center,n=i.sub(t),o=n.length,a;o<.001?(a=new f(1,0),i=t.add(a.rotate(Math.PI/2))):a=n.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=v.createBezierSegN(t,i,a,u);if(Jr.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}Jr.createEdgeCurveWithNoTrimming(e,t,i)}static createEdgeCurveWithNoTrimming(e,t,i){let n=i.sub(t).normalize(),o=t,a=i,l=e.targetArrowhead;l!=null&&(l.tipPosition=i,a=i.sub(n.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(n.mul(u.length))),e.curve=O.mkPP(o,a)}},Ft=Jr;Ft.defaultArrowheadLength=5;var Re=class extends Le{constructor(e){super(e);this.targetArrowhead=new Ft;this.lineWidth=1}requireRouting(){this.curve=null,this.underlyingPolyline=null}get sourcePort(){return this._sourcePort}set sourcePort(e){this._sourcePort=e}get targetPort(){return this._targetPort}set targetPort(e){this._targetPort=e}Translate(e){if(!(e.x==0&&e.y==0)){if(this.curve!=null&&this.curve.translate(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,i=this.smoothedPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=i.point.add(e);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(e)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(e))}}GetMaxArrowheadLength(){let e=0;return this.sourceArrowhead!=null&&(e=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>e?this.targetArrowhead.length:e}transform(e){if(this.curve!=null){if(this.curve=this.curve.transform(e),this.underlyingPolyline!=null)for(let t=this.underlyingPolyline.headSite,i=this.underlyingPolyline.headSite;t!=null;t=t.next,i=i.next)t.point=e.multiplyPoint(t.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=e.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=e.multiplyPoint(this.targetArrowhead.tipPosition)),this.label!=null&&(this.label.center=e.multiplyPoint(this.label.center))}}get labelBBox(){return this.label.boundingBox}get edge(){return this.entity}get source(){return Le.getGeom(this.edge.source)}get boundingBox(){let e=V.mkEmpty();if(this.underlyingPolyline!=null)for(let i of this.underlyingPolyline)e.add(i);this.curve!=null&&e.addRecSelf(this.curve.boundingBox),this.sourceArrowhead!=null&&e.add(this.sourceArrowhead.tipPosition),this.targetArrowhead!=null&&e.add(this.targetArrowhead.tipPosition),this.edge.label&&e.addRecSelf(this.label.boundingBox);let t=this.lineWidth;return e.left-=t,e.top+=t,e.right+=t,e.bottom-=t,e}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return Le.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(e,t,i){let n=e.boundingBox.width,o=e.boundingBox.height,a=e.boundingBox.center,l=new f(a.x-n/4,a.y),u=new f(a.x-n/4,a.y-o/2-t),c=new f(a.x+n/4,a.y-o/2-t),h=new f(a.x+n/4,a.y);return i.smoothedPolyline=Ze.mkFromPoints([l,u,c,h]),i.smoothedPolyline.createCurve()}underCollapsedCluster(){return this.source.underCollapsedCluster()||this.target.underCollapsedCluster()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var ae=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var cg=class{},ua=cg;ua.GoldenRatio=(1+Math.sqrt(5))/2,ua.GoldenRatioRemainder=2-cg.GoldenRatio;var Kn=class extends ae{constructor(e,t){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=e,this.desiredAspectRatio=t}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(e,t,i){let n=Kn.GetGoldenSectionStep(e,t),o=Math.max(i/10,(t-e)/Kn.MaxSteps);t+=o,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length==1?this.PackLimit(e):this.rectangles.length==2?(this.PackLimit(e),this.PackLimit(t)):this.rectangles.length>2&&Kn.GoldenSectionSearch(l=>this.PackLimit(l),e,n,t,o);let a=this.bestPacking.getRects();for(let l=0;l<this.rectangles.length;l++)this.rectangles[l]=a[l]}PackLimit(e){let t=this.cachedCosts.get(e);if(t==null){let i=this.createPacking(this.rectangles,e);i.run(),this.cachedCosts.set(e,t=Math.abs(i.PackedAspectRatio-this.desiredAspectRatio)),t<this.bestPackingCost&&(this.bestPackingCost=t,this.bestPacking=i)}return t}static GoldenSectionSearch(e,t,i,n,o){if(Math.abs(t-n)<o)return e(t)<e(n)?t:n;let a=Kn.GetGoldenSectionStep(i,n),l=e(i),u=e(a),c=()=>Kn.GoldenSectionSearch(e,a,i,t,o),h=()=>Kn.GoldenSectionSearch(e,i,a,n,o);if(u<l)return h();if(u>l)return c();let d=h(),p=c();return e(p)<e(d)?p:d}static GetGoldenSectionStep(e,t){return e<t?e+ua.GoldenRatioRemainder*(t-e):e-ua.GoldenRatioRemainder*(e-t)}},_c=Kn;_c.MaxSteps=1e3;var b0=Q(ei());var dg=class extends ae{get PackedWidth(){return this.packedWidth}set PackedWidth(e){this.packedWidth=e}get PackedHeight(){return this.packedHeight}set PackedHeight(e){this.packedHeight=e}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let e=[];for(let[t,i]of this.rectsToCenters)t.center=i,e.push(t);return e}};var ca=class extends dg{constructor(e,t,i=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=i?e:ca.SortRectangles(e),this.wrapWidth=t}static SortRectangles(e){return e.sort((t,i)=>i.height-t.height),e}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let e=new b0.Stack,t=!1,i=0,n=0,o=0,a=this.rectanglesByDescendingHeight;for(let l=0;t||l<a.length;){let u=a[l],c=e.length>0?e.top:null;if(c==null||c.right+u.width<=this.wrapWidth&&i+u.height<=c.top){let d=new f(c?c.right:0,i).add(new f(u.width/2,u.height/2));u.center=d,this.rectsToCenters.set(u,d),n=Math.max(n,u.right),o=Math.max(o,u.top),e.push(u),t=!1}else i=c.top,e.pop(),t=!0;t||l++}this.PackedWidth=n,this.PackedHeight=o}};var Nl=class extends _c{constructor(e,t){super(ca.SortRectangles(e),t);this.createPacking=(i,n)=>new ca(i,n,!0)}run(){let e=Number.MAX_VALUE,t=0,i=0;for(let n of this.rectangles){let o=n.width;i+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,i,e)}};var Dl=Q(ei());function gI(s,e,t,i,n,o){for(let l=0;l<s.length;l++){if(l==e||l==t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;i.length*2<n.length?(i.push(s[l]),o.box0=u):n.length*2<i.length?(n.push(s[l]),o.box1=h):c<d?(i.push(s[l]),o.box0=u):d<c?(n.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(i.push(s[l]),o.box0=u):(n.push(s[l]),o.box1=h)}}function Oe(s){if(s.length==0)return null;if(s.length==1)return s[0];let e={b0:s[0].irect,seed0:1},t=pI(s,e),i=[],n=[];i.push(s[e.seed0]),n.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};gI(s,e.seed0,t,i,n,o);let a=y0(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=Oe(i),a.Right=Oe(n),a}function P0(s,e){return s.add_rect(e).area}function pI(s,e){let t=P0(e.b0,s[e.seed0].irect);for(let n=2;n<s.length;n++){let o=P0(e.b0,s[n].irect);o>t&&(e.seed0=n,t=o)}let i;for(let n=0;n<s.length;n++)if(n!=e.seed0){i=n;break}t=s[e.seed0].irect.add_rect(s[i].irect).area;for(let n=0;n<s.length;n++){if(n==e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[n].irect).area;o>t&&(i=n,t=o)}return i}function _l(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(i=>We(i,e(i)));return Oe(t)}function y0(s){let e=new Fl;return e.Count=s,e}function We(s,e){let t=new Fl;return t.UserData=s,t.irect=e,t.Count=1,t}function fg(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)==0?s.Left!=null?fg(s.Left,e,t)==0&&fg(s.Right,e,t)==0?0:1:0:1:0}var Fl=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent==this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent==this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this==this.Parent.Left}FirstHitNodePF(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)==1?this:null:this:(i=this.Left.FirstHitNodePF(e,t))!=null?i:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)==1?this:null:(i=this.Left.FirstHitNodeWithPredicate(e,t))!=null?i:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t){let i=new Dl.Stack;for(i.push(this);i.size>0;){let n=i.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?(t==null||t(n.UserData))&&(yield n.UserData):(i.push(n.left),i.push(n.right)))}}*AllHitItems_(e){let t=new Dl.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.contains_point(e)&&(i.IsLeaf?yield i.UserData:(t.push(i.left),t.push(i.right)))}}VisitTree(e,t){fg(this,e,t)}Clone(){let e=y0(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new Dl.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?yield i:(t.push(i.left),t.push(i.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new Dl.Stack;for(t.push(this);t.size>0;){let i=t.pop();(i.IsLeaf||!e)&&(yield i),i.IsLeaf||(t.push(i.left),t.push(i.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function ki(s){return new Wo(Oe(s.map(([e,t])=>We(t,e))))}function mI(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function S0(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function bI(s,e){let t=new Array;for(let n of s.GetAllLeafNodes())n!=e&&t.push(n);let i=Oe(t);s.Count=i.Count,s.Left=i.Left,s.Right=i.Right,s.irect=i.Left.irect.add_rect(i.Right.irect)}function PI(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!E0(e))return e;return null}function E0(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function gg(s,e,t,i){return s.irect.intersects_rect(e)?s.IsLeaf?i(s.UserData)?--t.bound!=0:!0:gg(s.Left,e,t,i)&&gg(s.Right,e,t,i):!0}var Wo=class{Clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,i){return gg(this._rootNode,e,{bound:t},i)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(We(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=Oe(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=Oe(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=We(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let i,n;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{i=t.Left.irect.add_rect(e.irect);let o=i.area-t.Left.irect.area;n=t.Right.irect.add_rect(e.irect);let a=n.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n):i.area<n.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count==0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count==0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count==0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count==0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(i.UserData==t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let i;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))n.UserData==t&&(i=n);if(i!=null)return this.RootNode.Count==1?this.RootNode=null:this.RemoveLeaf(i),i.UserData}RemoveLeaf(e){let t=PI(e);if(t!=null)bI(t,e),S0(t);else{let i=e.Parent;i==null?this._rootNode=new Fl:(mI(i,e.IsLeftChild?i.Right:i.Left),S0(i))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!E0(t))return t;return null}};function Fc(s,e){let t=new Array;for(let o of e)t.push({g:o,lb:o.boundingBox.leftBottom.clone()});let i=e.map(o=>o.boundingBox),n=new Nl(i,1.5);n.run();for(let{g:o,lb:a}of t){let l=o.boundingBox.leftBottom.sub(a);o.translate(l)}s.boundingBox=new V({left:0,bottom:0,right:n.PackedWidth,top:n.PackedHeight}),s.addLabelToGraphBB(s.boundingBox)}var ze=class extends _r{constructor(e){super(e);this.MinimalWidth=0;this.MinimalHeight=0;this.Margins=10}static getGeom(e){return e.getAttr(0)}*intersectedObjects(e,t=!0){this._rtree==null&&(this._rtree=this.buildRTree());let i=this._rtree.GetAllIntersecting(e),n=e.perimeter();for(let o of i)if(o instanceof _r&&(yield o),!t&&o instanceof Re){let a=o.curve;(v.intersectionOne(a,n,!1)!=null||v.PointRelativeToCurveLocation(a.start,n)==2)&&(yield o)}}buildRTree(){let e=Array.from(this.deepNodes()).concat(Array.from(this.deepEdges())).map(t=>[t.boundingBox,t]);return ki(e)}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(e){this.layoutSettings=e;for(let t of this.deepNodes()){let i=t;i.layoutSettings=e}}get layoutSettings(){return this._layoutSettings}set layoutSettings(e){this._layoutSettings=e}translate(e){if(e.x==0&&e.y==0)return;let t=new lt(1,0,e.x,0,1,e.y);this.transform(t)}get labelSize(){return this._labelSize}set labelSize(e){this._labelSize=e}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}transform(e,t=!0){if(!e.isIdentity()){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e));for(let i of this.shallowNodes())i.transform(e,t);for(let i of this.edges())i.transform(e);t&&this.updateBoundingBox()}}*deepNodes(){for(let e of this.graph.deepNodes)yield Le.getGeom(e)}setEdge(e,t){let i=this.graph.setEdge(e,t);return new Re(i)}pumpTheBoxToTheGraphWithMargins(e){let t={b:V.mkEmpty()};return this.pumpTheBoxToTheGraph(t),t.b.pad(Math.max(this.Margins,e)),this.MinimalWidth>0&&(t.b.width=Math.max(t.b.width,this.MinimalWidth)),this.MinimalHeight>0&&(t.b.height=Math.max(t.b.height,this.MinimalHeight)),this._boundingBox=t.b,t.b}get center(){return this.boundingBox?this.boundingBox.center:new f(0,0)}set center(e){let t=e.sub(this.center),i=new lt(1,0,t.x,0,1,t.y);this.transform(i)}pumpTheBoxToTheGraph(e){for(let t of this.edges())if(!t.underCollapsedCluster()){if(t.curve!=null){let i=t.curve.boundingBox;i.pad(t.lineWidth),e.b.addRecSelf(i)}t.label!=null&&e.b.addRecSelf(t.label.boundingBox)}for(let t of this.shallowNodes())t.underCollapsedCluster()||!t.boundingBox||e.b.addRecSelf(t.boundingBox)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}*shallowNodes(){for(let e of this.graph.shallowNodes)yield Le.getGeom(e)}*edges(){for(let e of this.graph.edges)yield Le.getGeom(e)}*deepEdges(){for(let e of this.graph.deepEdges())yield Le.getGeom(e)}static mk(e,t=new At(0,0)){let i=new ze(new De(e));return i.labelSize=t,i}*subgraphs(){for(let e of this.graph.subgraphs())yield Le.getGeom(e)}static mkWithGraphAndLabel(e,t){let i=new ze(e);return i.labelSize=t,i}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(e){let t=this.graph.liftNode(e.node);return t?Le.getGeom(t):null}findNode(e){let t=this.graph.findNode(e);return t?Le.getGeom(t):null}addNode(e){return this.graph.addNode(e.node),e}updateBoundingBox(){if(this.graph.isEmpty())return;let e=V.mkEmpty(),t=0;for(let i of this.graph.edges){let n=Le.getGeom(i);n.curve!=null&&(e.addRecSelf(n.boundingBox),t=Math.max(t,n.lineWidth))}for(let i of this.shallowNodes())i.boundingBox&&(e.addRecSelf(i.boundingBox),t=Math.max(t,i.padding));this.addLabelToGraphBB(e),e.pad(Math.max(t,this.Margins)),this.boundingBox=e}addLabelToGraphBB(e){this.labelSize&&(e.top+=this.labelSize.height+2,e.width<this.labelSize.width&&(e.width=this.labelSize.width))}FlipYAndMoveLeftTopToOrigin(){let e=new lt(1,0,-this.left,0,-1,this.top);this.transform(e,!1);for(let i of this.deepNodes())if(i instanceof ze&&!i.graph.isEmpty()){let o=i.boundingBox;i.boundingBox=V.mkSizeCenter(new At(o.width,o.height),e.multiplyPoint(o.center))}let t=this.boundingBox;this.boundingBox=V.mkSizeCenter(new At(t.width,t.height),e.multiplyPoint(t.center))}};var Vl=class extends Le{constructor(e,t){super(t);this.boundingBox=V.mkPP(new f(0,0),new f(e.width,e.height))}get label(){return this.entity}get width(){return this.boundingBox.width}set width(e){this.boundingBox.width=e}get height(){return this.boundingBox.height}set height(e){this.boundingBox.height=e}get center(){return this.boundingBox.center}set center(e){this.boundingBox.center=e}get isPositioned(){let e=this.center;return e.x!=-77||e.y!=-77}requirePositioning(){this.boundingBox.center=new f(-77,-77)}};var x0=Q(Xn());function ha(s){let e=new Ot;return e.SetEdges(s,Ot.vertexCount(s)),e}function Vc(s){let e=new Ot;return e.SetEdges(s,Ot.vertexCount(s)),e}function Zt(s,e){let t=new Ot;return t.SetEdges(s,e),t}var Ot=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let i=e.indexOf(t,0);i>-1&&e.splice(i,1)}removeEdge(e){Ot.deleteFromArray(this.edges,e),e.source!=e.target?(Ot.deleteFromArray(this.outEdges[e.source],e),Ot.deleteFromArray(this.inEdges[e.target],e)):Ot.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let i of e)i.source>=t&&(t=i.source),i.target>=t&&(t=i.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let i=new Array(this.nodeCount).fill(0),n=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!=a.target?(i[a.source]++,n[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(i[a]),i[a]=0,this.inEdges[a]=new Array(n[a]),n[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!=u?(this.outEdges[l][i[l]++]=a,this.inEdges[u][n[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!=e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length==0)return;let e=new Set,t=new x0.Queue,i=this.edges[0].source;for(Ot.enqueue(e,t,i),yield i;t.length>0;){i=t.dequeue();for(let n of this.outEdges[i]){let o=n.target;e.has(o)||(Ot.enqueue(e,t,o),yield o)}for(let n of this.inEdges[i]){let o=n.source;e.has(o)||(Ot.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,i){t.enqueue(i),e.add(i)}};var ee=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x==this.y}};var C0=Q(ei());var gi=class{set(e,t,i){this.arrayOfMaps[e].set(t,i)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield new ee(e,i[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield[new ee(e,i[0]),i[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let i of t)yield i[1]}}};var A0=class{constructor(e,t){this.v=e,this.i=t}},Fr=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,i,n){t[i]=1,e.push(new A0(i,n))}static getFeedbackSet(e){let t=new gi(e.nodeCount);if(e==null||e.nodeCount==0)return[];let i=new Array(e.nodeCount).fill(0);for(let n=0;n<e.nodeCount;n++){if(i[n]==2)continue;let o=new C0.Stack,a=0;for(Fr.push(o,i,n,a);o.size>0;){let l=o.pop();n=l.v,i[n]=2,a=l.i;let u=e.outEdges[n];for(;a<u.length;a++){let c=u[a];if(c.source==c.target)continue;let h=i[c.target];h==1?t.set(c.source,c.target,c):h==0&&(Fr.push(o,i,n,a+1),n=c.target,i[c.target]=2,u=e.outEdges[n],a=-1)}}}return Array.from(t.values())}};var v0=Q(Pt()),Vr=class{constructor(e,t,i,n=1){this.Source=e,this.Target=t,this.CrossingWeight=i,this.Weight=n}toString(){return v0.String.Format("{0}->{1}",this.Source,this.Target)}};var jo=class{static FindClosestPoints(e,t){let i=v.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(i)return{curveClosestPoint:i.aX,labelSideClosest:i.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof v){for(let i of e.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static ShiftLabel(e,t,i){let n=e.lineWidth/2,o=t.sub(i),a=o.length;a>n&&(e.label.center=e.label.center.add(o.div(a*(a-n))))}static updateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new f(t.x+t.rightAnchor/2,t.y),i=O.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new f(t.x-t.leftAnchor/2,t.y),i=O.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=jo.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&v.getAllIntersections(e.curve,v.polyFromBox(e.labelBBox),!1).length==0){let o=jo.FindClosestPoints(n,i);if(o)jo.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=n.closestParameter(i.start),c=n.closestParameter(i.end);n.value(u).sub(i.start).length<n.value(c).sub(i.end).length?(a=n.value(u),l=i.start):(a=n.value(c),l=i.end),jo.ShiftLabel(e,a,l)}}}},Kt=class{constructor(e,t,i,n=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=i,this.weight=n,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.underlyingPolyline}set underlyingPolyline(e){this.edge.underlyingPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source==this.target}reversedClone(){let e=new Kt(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let i=0;i<t;i++){let n=this.LayerEdges[t-1-i];e.LayerEdges[i]=new Vr(n.Target,n.Source,n.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e==this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,i=this.LayerEdges[t];jo.updateLabel(this.edge,e[i.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var Vt=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let i=this.arrayOfSets[e];return i!=null&&i.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new Vt;for(let i of e)t.add(i);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let i of t.values())yield new ee(e,i)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let i=this.arrayOfSets[e];i==null&&(this.arrayOfSets[e]=i=new Set),i.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var I0=Q(Xn());function*Pn(s){let e=new Array(s.nodeCount).fill(!1),t=new I0.Queue;for(let i=0;i<s.nodeCount;i++)if(!e[i]){let n=new Array;for(T0(i,t,e);t.length>0;){let o=t.dequeue();n.push(o);for(let a of SI(s,o))T0(a,t,e)}yield n}}function*SI(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function T0(s,e,t){t[s]==!1&&(e.enqueue(s),t[s]=!0)}var pg=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new Vt;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size==0&&this.minLayerOfGeomGraph.size==0&&this.sameLayerConstraints.length==0&&this.upDownConstraints.length==0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=Zt(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=Fr.getFeedbackSetWithConstraints(e,null);for(let i of t)this.gluedUpDownIntConstraints.remove(i)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new ee(this.maxRepresentative,t))}if(this.minRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.minRepresentative&&this.gluedUpDownIntConstraints.add(new ee(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new Vt}gluedIntPairNN(e){return new ee(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new ee(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new ee(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),i=this.nodeToRepr(e.target),n=new Kt(t,i,e.edge);return n.separation=e.separation,n.weight=0,n}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Pn(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return Zt(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!=-1&&this.maxLayerInt.filter(t=>t!=this.maxRepresentative).map(t=>new ee(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!=-1&&this.minLayerInt.filter(t=>t!=this.minRepresentative).map(t=>new ee(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new ee(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.minRepresentative);else for(let i of e)t==-1&&(t=i),this.sameLayerDictionaryOfRepresentatives.set(i,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative==t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative==t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!=-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(Fr.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let i of this.unglueEdge(t))yield i}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let i of this.intGraph.outEdges[t])this.nodeToRepr(i.target)==e.target&&(yield i)}createGluedGraph(){let e=new Vt;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),Zt(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function EI(s,e){return[s,e]}var mg=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length==0&&this.upDownVerticalConstraints.length==0&&this.leftRightConstraints.length==0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length==0&&!this.nodeToBlockRoot.has(t)){let i=new Array,n=t;for(let o=e.outEdges[n];o.length>0;o=e.outEdges[n])n=o[0].y,i.push(n),this.nodeToBlockRoot.set(n,t);i.length>0&&this.BlockRootToBlock.set(t,i)}}BasicGraphFromLeftRightIntNeibs(){return ha(Array.from(this.LeftRightIntNeibs.values()).map(e=>new ee(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=Vt.mk(this.leftRightConstraints.map(t=>EI(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ee(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!=t.x));let e=Fr.getFeedbackSet(ha(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new ee(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=Vt.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ee(t[0],t[1]))),this.VerticalInts=Vt.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1&&e[t[0]]>e[t[1]]).map(t=>new ee(t[0],t[1])))}};var fa=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(fa||{});var ga=class{constructor(){this.capacityOverflowCoefficient=ga.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=ga.DefaultPathLengthImportance;this.inkImportance=ga.DefaultInkImportance;this.edgeSeparation=ga.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOriginalSpline=!1;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},Ui=ga;Ui.DefaultCapacityOverflowCoefficientMultiplier=1e3,Ui.DefaultPathLengthImportance=500,Ui.DefaultInkImportance=.01,Ui.DefaultEdgeSeparation=.5;var ma=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=3;this.polylinePadding=1.5;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e==1&&this.BundlingSettings==null&&this.BundlingSettings==null&&(this.BundlingSettings=new Ui),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var kl=class{constructor(){this.edgeRoutingSettings=new ma;this.minimalWidth=0;this.minimalHeight=0;this.nodeSeparation=10;this.packingAspectRatio=1.5}get MinimalWidth(){return this.minimalWidth}set MinimalWidth(e){this.minimalWidth=Math.max(e,0)}get MinimalHeight(){return this.minimalHeight}set MinimalHeight(e){this.minimalHeight=Math.max(e,0)}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}},fr=class extends kl{constructor(){super();this.margins={left:0,top:0,bottom:0,right:0};this.sameRanks=new Array;this.verticalConstraints=new pg;this.horizontalConstraints=new mg;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=lt.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.edgeRoutingSettings.EdgeRoutingMode=3}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=lt.rotation(e);for(let i=0;i<2;i++)for(let n=0;n<3;n++)if(!$(t.elements[i][n],this.transform.elements[i][n]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=lt.getIdentity();break;case 1:this.transform=lt.rotation(Math.PI/2);break;case 3:this.transform=lt.rotation(-Math.PI/2);break;case 2:this.transform=lt.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var Jt=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>E.distanceEpsilon?1:e<-E.distanceEpsilon?-1:0}};var yn=class extends Ot{constructor(e,t){super();this.SetEdges(e,t)}};var bg=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new gi(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let i=new ee(t.source,t.target),n=new ee(t.target,t.source),o=this.Multiedges.get(i.x,i.y);for(let a of o)a.reverse();if(this.Multiedges.has(n.x,n.y)){let a=this.Multiedges.get(n.x,n.y);for(let l of o)a.push(l)}else this.Multiedges.set(n.x,n.y,o);this.Multiedges.delete(i.x,i.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new ee(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function Ul(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var kr=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length==0&&t++;if(t==0)return this;let i=new Array(this.y.length);for(let a=0;a<i.length;a++)i[a]=this.y[a]-e[this.y[a]];let n=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(n[a-e[a]]=Array.from(this.layers[a]));let o=new kr(i);return o.layers=n,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)Ul(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let i of e)this.verticesToX[i]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let i=0;i<this.y.length;i++)e[i]=t-this.y[i];return new kr(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let i of this.y)i+1>e&&(e=i+1);let t=new Array(e).fill(0);for(let i of this.y)t[i]++;this.layers=new Array(e);for(let i=0;i<e;i++)this.layers[i]=new Array(t[i]),t[i]=0;for(let i=0;i<this.y.length;i++){let n=this.y[i];this.layers[n][t[n]++]=i}}};var zl=class extends ae{constructor(e,t,i,n){super(n);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=i,this.dag=e,this.layering=t,this.Init()}static Balance(e,t,i,n){new zl(e,t,i,n).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(e){this.jumpers.delete(e);let t=this.possibleJumperFeasibleIntervals.get(e),i=this.CalcJumpInfo(t.x,t.y,e);if(i==null)return;this.layering[e]=i.layerToJumpTo;let n=this.nodeCount[e];this.vertsCounts[i.jumperLayer]-=n,this.vertsCounts[i.layerToJumpTo]+=n,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(i.jumperLayer,e)}IsJumper(e){return this.possibleJumperFeasibleIntervals.has(e)}UpdateRegionsForPossibleJumpersAndInsertJumpers(e,t){let i=new Set;for(let o of this.dag.pred(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));for(let o of this.dag.succ(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),i.add(o));let n=new Array;for(let o of this.possibleJumperFeasibleIntervals)i.has(o[0])||o[1].x>e&&o[1].y<e&&n.push(o[0]);for(let o of n)this.CalculateRegionAndInsertJumper(o)}InitJumpers(){let e=new Array(this.dag.nodeCount).fill(0);for(let t of this.dag.edges)e[t.source]-=t.weight,e[t.target]+=t.weight;this.possibleJumperFeasibleIntervals=new Map;for(let t=0;t<this.dag.nodeCount;t++)e[t]==0&&this.CalculateRegionAndInsertJumper(t)}CalculateRegionAndInsertJumper(e){let t=new ee(this.Up(e),this.Down(e));this.possibleJumperFeasibleIntervals.set(e,t),this.InsertJumper(t.x,t.y,e)}InsertJumper(e,t,i){this.CalcJumpInfo(e,t,i)!=null&&this.jumpers.add(i)}CalcJumpInfo(e,t,i){let n=this.layering[i],o=-1,a=this.vertsCounts[n]-2*this.nodeCount[i];for(let l=e-1;l>n;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);for(let l=n-1;l>t;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);if(o!=-1)return{jumperLayer:n,layerToJumpTo:o}}Up(e){let t=Number.MAX_SAFE_INTEGER;for(let i of this.dag.inEdges[e]){let n=this.layering[i.source]-i.separation+1;n<t&&(t=n)}return t==Number.MAX_SAFE_INTEGER&&(t=this.layering[e]+1),t}Down(e){let t=Number.NEGATIVE_INFINITY;for(let i of this.dag.outEdges[e]){let n=this.layering[i.target]+i.separation-1;n>t&&(t=n)}return t==Number.NEGATIVE_INFINITY&&(t=this.layering[e]-1),t}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let e of this.layering)this.vertsCounts[e]+=this.nodeCount[e]}ChooseJumper(){for(let e of this.jumpers)return e;throw new Error("there are no jumpers to choose")}};var pi=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i of t.LayerEdges){let n=Math.max(i.Source,i.Target)+1;n>this.totalNumberOfNodes&&(this.totalNumberOfNodes=n)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i=1;i<t.LayerEdges.length;i++){let n=t.LayerEdges[i];this.firstVirtualNode=Math.min(this.firstVirtualNode,n.Source)}this.firstVirtualNode==Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let i of t.LayerEdges)i.Target!=t.target&&(this.virtualNodesToInEdges[i.Target-this.firstVirtualNode]=i),i.Source!=t.source&&(this.virtualNodesToOutEdges[i.Source-this.firstVirtualNode]=i)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield pi.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield pi.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new pi(new yn(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var X0=Q(jl()),oo=class{constructor(e,t,i,n){this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}static InsertLayers(e,t,i,n){let o=new oo(e,t,i,n);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let i=0,n=t[0];if(i=n.LayerSpan*2,i>0){for(let o of n.LayerEdges)o.Target!=n.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(i-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let i=this.la.x[t],n=this.la.y[t],o=this.la.Layers[n];o[i]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges[n];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!=o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let i=this.NLayering[t];i%2==1&&(this.Nla.Layers[i][e[i]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!=e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!=e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,i=!0;for(let n of e)if(i&&(i=!1,t=n.LayerSpan*2),t>0){n.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=Wi.GetSource(a,n,o);this.totalNodes=a.currentVV;let u=Wi.GetTarget(this.totalNodes,n,o,t);n.LayerEdges[o]=new Vr(l,u,n.CrossingWeight)}oo.RegisterDontStepOnVertex(this.database,n)}}this.nLayeredGraph=new pi(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new X0.SortedMap,i=this.Nla.Layers[e];for(let o of i){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let n=0;for(let o of t.values())if(typeof o=="number")i[n++]=o;else for(let a of o)i[n++]=a;for(let o=0;o<i.length;o++)this.Nla.x[i[o]]=o}}InitNewLayering(){this.Nla=new kr(new Array(this.totalNodes));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i]*2;for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!=i.y&&this.la.y[i.x]!=this.la.y[i.y]){let o=this.la.y[i.x]*2;for(let a of n){let l=o-1;for(let u of a.LayerEdges)u.Target!=a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new kr(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let i=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(i.Source)}}};var Wi=class{constructor(e,t,i,n){this.virtNodesToIntEdges=new Map;this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}get NLayering(){return this.Nla.y}static InsertPaths(e,t,i,n){let o=new Wi(e,t,i,n);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(n);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!=o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}EdgeIsFlat(e){return this.la.y[e.source]==this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let i of t.LayerEdges)i.Target!=t.target&&this.virtNodesToIntEdges.set(i.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!=t.y){let n=!0,o=0;for(let a of i){if(n)n=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o==1)a.LayerEdges[0]=new Vr(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=Wi.GetSource(u,a,l);e=u.currentVV;let h=Wi.GetTarget(e,a,l,o);a.LayerEdges[l]=new Vr(c,h,a.CrossingWeight)}oo.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new pi(this.intGraph)}static GetTarget(e,t,i,n){return i<n-1?e:t.target}static GetSource(e,t,i){return i==0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new kr(new Array(this.NLayeredGraph.NodeCount));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i];for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!=i.y&&this.la.y[i.x]!=this.la.y[i.y]){let o=0,a=!0;for(let l of n){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new kr(this.NLayering),this.Nla.Layers=e}};var Y0=BigInt("6364136223846793005"),Lg=(BigInt(1)<<BigInt(32))-BigInt(1),En=(BigInt(1)<<BigInt(64))-BigInt(1),ql=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&En,this._random_b(),this._state=this._state+BigInt(e)&En,this._random_b()}_random_b(){let e=this._state;this._state=e*Y0+this._inc&En;let t=(e>>BigInt(18)^e)>>BigInt(27),i=e>>BigInt(59),n=i^BigInt(31);return(t>>i|t<<n)&Lg}_advance(e){e&=En;let t=BigInt(1),i=Y0,n=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*i&En,n=n*i+o&En),o=(i+BigInt(1))*o&En,i=i*i&En,e>>=BigInt(1);this._state=t*this._state+n&En}randint(e){if(e>Lg)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),i=(Lg^t)%t;for(;;){let n=this._random_b();if(n>=i)return Number(n%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var es;function so(s){return es==null&&(es=new ql(0,0)),es.randint(s)}function $0(s){es=new ql(s,0)}function Xl(){return es==null&&(es=new ql(0,0)),es.random()}var Qc=class{constructor(e,t,i){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=i}LayerGroupDisbalance(e,t,i){return t==1?this.LayerGroupDisbalanceWithOrigSeparators(e,i):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentOrigGroupDelta(n,e,t);n=o.i,i+=o.ret}return i}CurrentOrigGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentVirtGroupDelta(n,e,t);i+=o.ret,n=o.i}return i}CurrentVirtGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings==0}};var ey=Q(jl()),ty=Q(ei());var Rg=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Source]-this.x[t.Source];return i!=0?i:this.x[e.Target]-this.x[t.Target]}};var Og=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Target]-this.x[t.Target];return i!=0?i:this.x[e.Source]-this.x[t.Source]}};var ot=class{constructor(e,t){aa(e,t)<0?(this.first=e,this.second=t):(this.first=t,this.second=e)}get First(){return this.first}get Second(){return this.second}get Length(){return ye(this.first,this.second)}CompareTo(e){let t=aa(this.first,e.first);return t!=0?t:aa(this.second,e.second)}static equal(e,t){return e.first.equal(t.first)&&e.second.equal(t.second)}toString(){return this.first+(" "+this.second)}};var Me=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new Me;for(let i of e)t.add(i);return t}addxy(e,t){let i=this.mapOfSets.get(e);i==null&&this.mapOfSets.set(e,i=new Set),i.has(t)||this.size_++,i.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let i=this.mapOfSets.get(e);return i!=null&&i.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let i of this)e(i,i,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new f(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function xn(s,e){let t=new Set;for(let i of s)e.has(i)||t.add(i);return t}function Q0(s,e){let t=new Me;for(let i of s)e.has(i)||t.add(i);return t}function mi(s,e){let t=new Set(s);for(let i of e)t.add(i);return t}function ji(s,e){for(let t of e)s.push(t)}function bi(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}function Z0(s){if(s.length==0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=bi(e,s[t]);return e}function Aa(s,e){for(let t of e)s.add(t)}function ts(s,e){if(s.size!=e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function qi(s,e){let t=[];for(let i of s)for(let n of e(i))t.push(n);return t}function rs(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function is(s,e,t){let i=s.get(e);i||(i=new Array,s.set(e,i)),i.push(t)}function Bg(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function K0(s,e,t){Bg(s,new ot(e[0],e[1]),t)}function sw(s,e,t){let i=s.get(e);i&&i.delete(t)}function Mg(s,e,t){sw(s,new ot(e[0],e[1]),t)}function Zc(){return so(2)==0}function aw(s,e,t){let i=t.Layers[s+1],n=t.Layers[s];return n.length<=i.length?uw(n,e,t):lw(i,n,e,t)}function lw(s,e,t,i){let n=ry(e,t),o=new Og(i.x);n.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of n){let h=a+i.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!=0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function uw(s,e,t){let i=ry(s,e),n=new Rg(t.x);i.sort((u,c)=>n.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of i){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!=0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function ry(s,e){return qi(s,t=>Array.from(e.InEdges(t)))}function J0(s,e){let t=0;for(let i=0;i<e.Layers.length-1;i++)t+=aw(i,s,e);return t}var ao=class extends ae{constructor(e,t,i,n,o,a,l){super(l);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=l,this.tryReverse=t,this.startOfVirtNodes=n,this.layerArrays=i,this.layering=i.y,this.nOfLayers=i.Layers.length,this.layers=i.Layers,this.properLayeredGraph=e,this.hasCrossWeights=o,this.SugSettings=a}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return so(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(e,t,i,n,o){let a=!1;for(let u of e.Edges)if(u.CrossingWeight!=1){a=!0;break}new ao(e,!0,t,i,a,n,o).run()}run(){if(this.Calculate(),this.tryReverse){let e=this.layerArrays.ReversedClone(),t=new ao(this.properLayeredGraph.ReversedClone(),!1,e,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(t.run(),t.measure<this.measure){for(let i=0;i<this.nOfLayers;i++)Ul(e.Layers[i],this.layerArrays.Layers[this.nOfLayers-1-i]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=ao.CloneLayers(this.layers,this.layerArraysCopy);let e=0;this.measure=new Qc(this.layerArraysCopy,J0(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let t=0;t<this.MaxOfIterations&&e<this.NoGainStepsBound&&!this.measure.IsPerfect();t++){let i=t%2==0;this.LayerByLayerSweep(i),this.AdjacentExchange();let n=new Qc(this.layerArrays.Layers,J0(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);this.measure<n?(this.Restore(),e++):(n<this.measure||Zc())&&(e=0,this.layerArraysCopy=ao.CloneLayers(this.layers,this.layerArraysCopy),this.measure=n)}}static CloneLayers(e,t){if(t==null){t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i].map(n=>n)}else for(let i=0;i<e.length;i++)Ul(e[i],t[i]);return t}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(e){if(e)for(let t=1;t<this.nOfLayers;t++)this.SweepLayer(t,!0);else for(let t=this.nOfLayers-2;t>=0;t--)this.SweepLayer(t,!1)}SweepLayer(e,t){let i=this.layers[e],n=new Array(i.length);for(let a=0;a<n.length;a++)n[a]=this.WMedian(i[a],t);this.Sort(e,n);let o=this.layerArrays.Layers[e];for(let a=0;a<o.length;a++)this.layerArrays.x[o[a]]=a}Sort(e,t){let i=new ey.SortedMap,n=this.layers[e],o=0;for(let l of t){let u=n[o++];if(l!=-1)if(!i.has(l))i.set(l,u);else{let c=i.get(l);if(typeof c!="number"){let h=c;if(Zc())h.push(u);else{let d=so(h.length),p=h[d];h[d]=u,h.push(p)}}else{let h=c,d=new Array;i.set(l,d),Zc()?(d.push(h),d.push(u)):(d.push(u),d.push(h))}}}let a=i.values();for(o=0;o<n.length;)if(t[o]!=-1){let l=a.next().value;if(typeof l=="number")n[o++]=l;else{let u=l;for(let c of u){for(;t[o]==-1;)o++;n[o++]=c}}}else o++}WMedian(e,t){let i,n;if(t?(i=this.properLayeredGraph.OutEdges(e),n=this.properLayeredGraph.OutEdgesCount(e)):(i=this.properLayeredGraph.InEdges(e),n=this.properLayeredGraph.InEdgesCount(e)),n==0)return-1;let o=new Array(n),a=0;if(t)for(let h of i)o[a++]=this.X[h.Target];else for(let h of i)o[a++]=this.X[h.Source];o.sort((h,d)=>h-d);let l=Math.floor(n/2);if(n%2==1)return o[l];if(n==2)return .5*(o[0]+o[1]);let u=o[l-1]-o[0],c=o[n-1]-o[l];return Math.floor((o[l-1]*u+o[l]*c)/(u+c))}Init(){let e=new Array(this.nOfLayers).fill(0),t=new ty.Stack;for(let n=0;n<this.properLayeredGraph.NodeCount;n++)this.properLayeredGraph.InEdgesCount(n)==0&&t.push(n);let i=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;t.size>0;){let n=t.pop(),o=this.layerArrays.y[n];this.layerArrays.Layers[o][e[o]]=n,this.layerArrays.x[n]=e[o],e[o]++;for(let a of this.properLayeredGraph.Succ(n))i[a]||(i[a]=!0,t.push(a))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let e=0,t=!0;for(;t&&e++<this.MaxNumberOfAdjacentExchanges;){t=!1;for(let i=0;i<this.layers.length;i++)t=this.AdjExchangeLayer(i)||t;for(let i=this.layers.length-2;i>=0;i--)t=this.AdjExchangeLayer(i)||t}}AllocArrays(){let e=this.properLayeredGraph.NodeCount;this.predecessors=new Array(e),this.successors=new Array(e),this.pOrder=new Array(e),this.sOrder=new Array(e),this.hasCrossWeights&&(this.outCrossingCount=new Array(e),this.inCrossingCount=new Array(e));for(let t=0;t<e;t++){let i=this.properLayeredGraph.InEdgesCount(t);if(this.predecessors[t]=new Array(i),this.hasCrossWeights){let n=this.inCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.InEdges(t))n.set(o.Source,o.CrossingWeight)}if(this.pOrder[t]=new Map,i=this.properLayeredGraph.OutEdgesCount(t),this.successors[t]=new Array(i),this.sOrder[t]=new Map,this.hasCrossWeights){let n=this.outCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.OutEdges(t))n.set(o.Target,o.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let e=0;e<this.properLayeredGraph.NodeCount;e++)this.pOrder[e]=new Map,this.sOrder[e]=new Map;for(let e of this.layers)this.InitPsArraysForLayer(e)}CalcPair(e,t){let i=this.successors[e],n=this.successors[t],o=this.predecessors[e],a=this.predecessors[t];if(this.hasCrossWeights){let l=this.outCrossingCount[e],u=this.outCrossingCount[t],c=this.inCrossingCount[e],h=this.inCrossingCount[t];return{cuv:this.CountOnArraysUV(i,n,l,u)+this.CountOnArraysUV(o,a,c,h),cvu:this.CountOnArraysUV(n,i,u,l)+this.CountOnArraysUV(a,o,h,c)}}else return{cuv:this.CountOnArrays(i,n)+this.CountOnArrays(o,a),cvu:this.CountOnArrays(n,i)+this.CountOnArrays(a,o)}}InitPsArraysForLayer(e){for(let t of e){for(let i of this.properLayeredGraph.Pred(t)){let n=this.sOrder[i],o=n.size;this.successors[i][o]=t,n.set(t,o)}for(let i of this.properLayeredGraph.Succ(t)){let n=this.pOrder[i],o=n.size;this.predecessors[i][o]=t,n.set(t,o)}}}CountOnArrays(e,t){let i=0,n=t.length-1,o=-1,a=0;for(let l of e){let u=this.X[l];for(;o<n&&this.X[t[o+1]]<u;o++)a++;i+=a}return i}CountOnArraysUV(e,t,i,n){let o=0,a=t.length-1,l=-1,u=0;for(let c of e){let h=this.X[c],d;for(;l<a&&this.X[d=t[l+1]]<h;l++)u+=n.get(d);o+=u*i.get(c)}return o}AdjExchangeLayer(e){let t=this.layers[e];return this.ExchangeWithGainWithNoDisturbance(t)?!0:(this.DisturbLayer(t),this.ExchangeWithGainWithNoDisturbance(t))}Swap(e,t){let i=this.X[e],n=this.X[t],o=this.layering[e],a=this.layers[o];a[i]=t,a[n]=e,this.X[e]=n,this.X[t]=i,this.UpdateSsContainingUv(e,t),this.UpdatePsContainingUv(e,t)}UpdatePsContainingUv(e,t){if(this.successors[e].length<=this.successors[t].length)for(let i of this.successors[e]){let n=this.pOrder[i];if(n.has(t)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.successors[t]){let n=this.pOrder[i];if(n.has(e)){let o=n.get(t),a=this.predecessors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}UpdateSsContainingUv(e,t){if(this.predecessors[e].length<=this.predecessors[t].length)for(let i of this.predecessors[e]){let n=this.sOrder[i];if(n.has(t)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}else for(let i of this.predecessors[t]){let n=this.sOrder[i];if(n.has(e)){let o=n.get(t),a=this.successors[i];a[o-1]=t,a[o]=e,n.set(t,o-1),n.set(e,o)}}}DisturbLayer(e){for(let t=0;t<e.length-1;t++)this.AdjacentSwapToTheRight(e,t)}ExchangeWithGainWithNoDisturbance(e){let t=!1,i;do i=this.ExchangeWithGain(e),t=t||i;while(i);return t}ExchangeWithGain(e){for(let t=0;t<e.length-1;t++)if(this.SwapWithGain(e[t],e[t+1]))return this.SwapToTheLeft(e,t),this.SwapToTheRight(e,t+1),!0;return!1}SwapToTheLeft(e,t){for(let i=t-1;i>=0;i--)this.AdjacentSwapToTheRight(e,i)}SwapToTheRight(e,t){for(let i=t;i<e.length-1;i++)this.AdjacentSwapToTheRight(e,i)}AdjacentSwapToTheRight(e,t){let i=e[t],n=e[t+1],o=this.SwapGain(i,n);(o>0||o==0&&Zc())&&this.Swap(i,n)}SwapGain(e,t){let i=this.CalcPair(e,t);return i.cuv-i.cvu}UvAreOfSameKind(e,t){return e<this.startOfVirtNodes&&t<this.startOfVirtNodes||e>=this.startOfVirtNodes&&t>=this.startOfVirtNodes}NeighborsForbidTheSwap(e,t){return this.UpperNeighborsForbidTheSwap(e,t)||this.LowerNeighborsForbidTheSwap(e,t)}LowerNeighborsForbidTheSwap(e,t){let i,n;return(i=this.properLayeredGraph.OutEdgesCount(e))==0||(n=this.properLayeredGraph.OutEdgesCount(t))==0?!1:this.X[this.successors[e][i>>1]]<this.X[this.successors[t][n>>1]]}UpperNeighborsForbidTheSwap(e,t){let i=this.properLayeredGraph.InEdgesCount(e),n=this.properLayeredGraph.InEdgesCount(t);return i==0||n==0?!1:this.X[this.predecessors[e][i>>1]]<this.X[this.predecessors[t][n>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(e,t,i){let n=this.GetKindDelegate(i),o=0;for(let l=t-1;l>=0&&!n(e[l]);l--)o++;let a=0;for(let l=t+1;l<e.length&&!n(e[l]);l++)a++;return o-a}IsOriginal(e){return e<this.startOfVirtNodes}IsVirtual(e){return e>=this.startOfVirtNodes}GetKindDelegate(e){return this.IsVirtual(e)?this.IsVirtual:this.IsOriginal}SwapWithGain(e,t){return this.SwapGain(e,t)>0?(this.Swap(e,t),!0):!1}};var je=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,i){let n=this.mapOfMaps.get(e);n==null&&this.mapOfMaps.set(e,n=new Map),n.has(t)||this.size_++,n.set(t,i)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let i=this.mapOfMaps.get(e);return i!=null?(i.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let i=this.mapOfMaps.get(e);return i!=null&&i.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let i=this.mapOfMaps.get(e);if(i!=null)return i.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new f(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new f(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var va=class{constructor(e,t,i){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=i}static UpdateLayerArrays0(e,t,i){new va(e,t,i).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let i=va.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,i)}static BuildInitialNodePositions(e,t){let i=new Map;for(let n=0;n<t.Layers.length;n++){let o=0,a=0;for(;o<t.Layers[n].length;){for(;o<t.Layers[n].length&&e.IsVirtualNode(t.Layers[n][o]);)o++;for(let l=a;l<o;l++)i.set(t.Layers[n][l],new f(n,a));o<t.Layers[n].length&&i.set(t.Layers[n][o],new f(n,o)),o++,a=o}}return i}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new je;for(let t of this.layerArrays.Layers)for(let i of t){let n=this.nodePositions.get(i);e.hasxy(n.x,n.y)||e.setxy(n.x,n.y,[]),e.getxy(n.x,n.y).push(i)}return e}BuildOrdering(e){let t=new je,i=new Map;for(let n of this.layerArrays.Layers)for(let o of n){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),i),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let i=0;i<e.length;i++)t.set(e[i],i)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,i)=>{let n=this.firstSucc(t),o=this.firstSucc(i),a=this.firstPred(t),l=this.firstPred(i),u=this.nodePositions.get(n),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(n)){if(!h.equal(d))return h.compareTo(d);let p=e.get(n),y=e.get(o);return ue(p,y)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?ue(t,i):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let i=0,n=0;for(;i<t.length;){for(;i<t.length&&this.nodePositions.get(t[n]).equal(this.nodePositions.get(t[i]));)i++;let o=e.get(this.nodePositions.get(t[n]));for(let a=n;a<i;a++)t[a]=o[a-n];n=i}}this.layerArrays.UpdateXFromLayers()}};var ny=Q(Pt());var iy=Q(ei());var ns=class{static getOrder(e,t){let i=Zt(t.map(([n,o])=>new ee(n,o)),e);return ns.getOrderOnGraph(i)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),i=new iy.Stack,n=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,i.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(n.push(l),i.length>0){let c=i.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return n.reverse()}};var Ng=class{GetLayers(){let e=ns.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),i=this.graph.nodeCount;for(;i-- >0;){let n=e[i];for(let o of this.graph.inEdges[n]){let a=o.source,l=t[n]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(cw(t,e))return!1;return!0}constructor(e){this.graph=e}};function cw(s,e){let t=e.findIndex(n=>n==s.source),i=e.findIndex(n=>n==s.target);return t==-1||i==-1||t>=i}var Dg=class{constructor(e){this.inTree=!1;this.cut=Dg.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},wr=Dg;wr.infinity=Number.MAX_SAFE_INTEGER;var lo=Q(ei());function hw(s){let e=new Array;for(let t of s.edges)e.push(new wr(t));return Zt(e,s.nodeCount)}var Kc=class{constructor(e,t,i,n,o){this.v=e,this.outEnum=t,this.i=i,this.inEnum=n,this.j=o}},Yl=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=hw(e),this.networkCancelToken=t;for(let i=0;i<this.graph.nodeCount;i++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let i of this.treeVertices)this.layers[i]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let i=t.source,n=t.target;return this.lim(i)>this.lim(n)?this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?0:1:this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut==wr.infinity&&t!=this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new lo.Stack;for(let i of this.leaves)e.push(i);let t=new lo.Stack;for(;e.length>0;){for(;e.length>0;){let n=e.pop(),o=this.parent(n);if(o==null)continue;let a=0;for(let u of this.incidentEdges(n))if(u.inTree==!1){let c=this.edgeSourceTargetVal(u,o);c!=0&&(a+=c*u.weight)}else if(u==o)a+=u.weight;else{let c=o.source==u.target||o.target==u.source?1:-1;a+=this.edgeContribution(u,n)*c}o.cut=a;let l=o.source==n?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let i=e;e=t,t=i}}edgeContribution(e,t){let i=e.cut-e.weight;for(let n of this.incidentEdges(t))if(n.inTree==!1){let o=this.edgeSourceTargetVal(n,e);o==-1?i+=n.weight:o==1&&(i-=n.weight)}return i}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let i=new lo.Stack,n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(i.push(new Kc(t,n,o,a,l)),this.vertices[t].low=e;i.length>0;){let u=i.pop();t=u.v,n=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<n.length;){let h=n[o];!h.inTree||this.vertices[h.target].low>0||(i.push(new Kc(t,n,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){i.push(new Kc(t,n,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)==this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,i=this.vertices[e].lim;this.leaves=[];for(let n=0;n<this.nodeCount;n++)t<=this.vertices[n].lim&&this.vertices[n].lim<=i?this.setLow(n,0):this.low(n)==this.lim(n)&&this.leaves.push(n);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=wr.infinity;for(let i of this.treeVertices){for(let n of this.graph.outEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o==1))return n}for(let n of this.graph.inEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o==1))return n}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new lo.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let i of this.graph.outEdges[t])this.vertexInTree(i.target)||this.layers[i.source]-this.layers[i.target]==i.separation&&(e.push(i.target),this.addVertexToTree(i.target),this.treeVertices.push(i.target),i.inTree=!0);for(let i of this.graph.inEdges[t])this.vertexInTree(i.source)||this.layers[i.source]-this.layers[i.target]==i.separation&&(e.push(i.source),this.addVertexToTree(i.source),this.treeVertices.push(i.source),i.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,i=0;for(let a of this.graph.edges)a.inTree&&a.cut<i&&(i=a.cut,e=a);if(e==null)return null;let n=!1,o=wr.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree==!1&&this.edgeSourceTargetVal(a,e)==-1&&(l<o||l==o&&(n=so(2)==1))){if(o=l,t=a,o==0&&!n)break;n=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let i=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,i),this.updateLimLowLeavesAndParentsUnderNode(i),this.updateCuts(e),this.updateLayersUnderNode(i)}updateLayersUnderNode(e){let t=new lo.Stack;t.push(e);for(let i=0;i<this.nodeCount;i++)this.low(e)<=this.lim(i)&&this.lim(i)<=this.lim(e)&&i!=e&&(this.layers[i]=wr.infinity);for(;t.length>0;){let i=t.pop();for(let n of this.graph.outEdges[i])n.inTree&&this.layers[n.target]==wr.infinity&&(this.layers[n.target]=this.layers[i]-n.separation,t.push(n.target));for(let n of this.graph.inEdges[i])n.inTree&&this.layers[n.source]==wr.infinity&&(this.layers[n.source]=this.layers[i]+n.separation,t.push(n.source))}}updateCuts(e){let t=new lo.Stack,i=new lo.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!=wr.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree==!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c==a)l+=c.weight;else{let h=a.source==c.target||a.target==c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source==o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&i.push(u)}let n=t;t=i,i=n}}createPathForCutUpdates(e,t,i){let n=t.target;for(;n!=i;){let o=this.parent(n);o.cut=wr.infinity,n=o.source==n?o.target:o.source}t.cut=wr.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,i;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),i=this.lim(e.target)):(t=this.lim(e.target),i=this.lim(e.source));let n=e.source;for(;!(this.low(n)<=t&&i<=this.lim(n));){let o=this.parent(n);o.cut=wr.infinity,n=o.source==n?o.target:o.source}return n}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let i of this.graph.edges)t+=this.edgeSourceTargetVal(i,e)*i.weight;e.cut!=t&&console.log(ny.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new Ng(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length==0&&this.graph.nodeCount==0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var Gg=class{GetLayers(){return new Yl(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let i of e){let n=i[0],o=i[1];for(let a of this.graph.outEdges[n]){let l=new Kt(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new yn(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var gr=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new f(this.left,this.top)}get leftBottom(){return new f(this.left,this.bottom)}get rightBottom(){return new f(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new f(this.right,this.top)}static mkAnchor(e,t,i,n,o,a){let l=new gr(a);return l.la=e,l.ra=t,l.ta=i,l.ba=n,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new f(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=gr.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t==0?e:gr.curveIsConvex(e)?gr.padConvexCurve(e,t):gr.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,i,n,o){let a=gr.getPaddedCorner(t,i,n,o);e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b)}static padConvexCurve(e,t){let i=new q;gr.padCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t),gr.padCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t);for(let n=e.startPoint;n.next.next!=null;n=n.next)gr.padCorner(i,n,n.next,n.next.next,t);return i.closed=!0,i}static getPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point,u=f.getTriangleOrientation(o,a,l)==1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<E.intersectionEpsilon)return{a:a.add(h.mul(n)),b:null,numberOfPoints:1};let p=d.normalize().mul(n),y=p.rotate(Math.PI/2),x=(n-p.dot(h))/y.dot(h);return{a:p.add(y.mul(x)).add(a),b:p.sub(y.mul(x)).add(a),numberOfPoints:2}}static*orientations(e){yield f.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield f.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield f.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let i of gr.orientations(e))if(i!=2){if(t==2)t=i;else if(i!=t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():v.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new q;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return q.mkClosedFromPoints([new f(e,this.top),this.rightTop,this.rightBottom,new f(e,this.bottom),new f(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return q.mkClosedFromPoints([new f(e,this.top),new f(this.right,this.y),new f(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var Ta=class{constructor(e,t,i,n,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=i,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new Vt,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=n,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,i,n,o){new Ta(e,t,i,n,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.InEdges(e))i[t++]=o.Source;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2==t?this.upperMedians[e]=new ee(i[n-1],i[n]):this.upperMedians[e]=i[n]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.OutEdges(e))i[t++]=o.Target;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2==t?this.lowMedians[e]=new ee(i[n-1],i[n]):this.lowMedians[e]=i[n]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),i=new Array(4),n=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,i[a]=l.b;let u=i[a]-t[a];u<n&&(e=a,n=u)}for(let a=0;a<4;a++){let l;if(Ta.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=i[e]-i[a],this.x=this.xCoords[a],l!=0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e==0||e==2}AssignmentBounds(e,t){if(this.nOfVertices==0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let i=1;i<this.nOfVertices;i++){let n=this.x[i];n<t.a?t.a=n:n>t.b&&(t.b=n)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let n=t;this.LR?(yield n.x,yield n.y):(yield n.y,yield n.x)}else{let n=t;n>=0&&(yield n)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,i=this.UpperOf(0,this.h-1),n=this.NextLower(i);for(;this.IsBelow(e,i);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,n)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],i=null,n=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(n,o)&&i==null;n=this.NextRight(n))i=this.InnerEdgeByTarget(t[n]);if(i!=null){let a=this.Pos(this.Source(i));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,n);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(i));for(;this.IsNotRightFrom(n,o);){let u=this.AlignmentToTheRightOfInner(t,n,a);if(n=this.NextRight(n),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,i,u,l,c),i=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(i)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(i)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,i,n,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(i)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,n)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,i){if(this.NumberOfInEdges(e[t])==1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(i,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let n=0;n<this.nOfVertices;n++)if(n==this.root[n]){let o=n;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Kt(n,this.root[a.neighbor],null)),o=this.align[o]}while(o!=n)}let t=Zt(e,this.nOfVertices),i=ns.getOrderOnGraph(t);for(let n of i)if(n==this.root[n]){let o=0,a=!0,l=n;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!=n);this.x[n]=o}for(let n of i)if(n==this.root[n]&&t.inEdges[n].length==0){let o=n,a=this.RightMost(-Ta.infinity,Ta.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!=n);l!=a&&(this.x[n]=a)}for(let n=0;n<this.nOfVertices;n++)n!=this.root[n]&&(this.x[n]=this.x[this.root[n]])}TryToGetRightNeighbor(e,t){let i=this.NextRight(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}TryToGetLeftNeighbor(e,t){let i=this.NextLeft(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let i=this.la.Layers[t],n=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,i.length-1);for(let a=this.LeftMost(0,i.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=i[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(n,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],n=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let i;if(this.Pos(e)>this.Pos(t)){let n=e;e=t,t=n,i=-1}else i=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*i}},Jc=Ta;Jc.infinity=1e7;var _g=class extends Ot{constructor(e,t,i,n,o){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(n,o),this.virtualVerticesStart=e.nodeCount,this.virtualVerticesEnd=t.NodeCount-1,this.layeredGraph=t,this.layerArrays=i}EdgeWeightMultiplier(e){let t=e.source,i=e.target;if(t<this.layeredGraph.NodeCount&&this.layerArrays.y[t]==this.layerArrays.y[i]&&this.layerArrays.x[t]==this.layerArrays.x[i]+1)return 0;let n=0,o=-1,a=-1;for(let u of this.outEdges[t])a==-1?a=u.target:o=u.target;return a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&n++,o>=this.virtualVerticesStart&&o<=this.virtualVerticesEnd&&n++,n==0?this.weightMultiplierOfOriginalOriginal:n==1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let e of this.edges)e.weight=e.weight*this.EdgeWeightMultiplier(e)}};var uo=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new uo(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length==0)return null;if(e.length==1)return e[0];let t=e[0].parallelogram,i=1,n=fe.parallelogramOfTwo(t,e[i].parallelogram).area;for(let h=2;h<e.length;h++){let d=fe.parallelogramOfTwo(t,e[h].parallelogram).area;d>n&&(i=h,n=d)}let o;for(let h=0;h<e.length;h++)if(h!=i){o=h;break}n=fe.parallelogramOfTwo(e[i].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h==i)continue;let d=fe.parallelogramOfTwo(e[i].parallelogram,e[h].parallelogram).area;d>n&&(o=h,n=d)}let a=new Array,l=new Array;a.push(e[i]),l.push(e[o]);let u=e[i].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h==i||h==o)continue;let d=fe.parallelogramOfTwo(u,e[h].parallelogram),p=d.area-u.area,y=fe.parallelogramOfTwo(c,e[h].parallelogram),x=y.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=y):p<x?(a.push(e[h]),u=d):(l.push(e[h]),c=y)}return{parallelogram:fe.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var os=class{static mkDebugCurveTWCILD(e,t,i,n,o,a,l=!1){let u=new os;return u.transparency=e,u.width=t,u.color=i,u.icurve=n,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,i,n){return os.mkDebugCurveTWCILD(e,t,i,n,null,null)}static mkDebugCurveWCI(e,t,i){return os.mkDebugCurveTWCI(255,e,t,i)}static mkDebugCurveCI(e,t){return os.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return os.mkDebugCurveCI("Black",e)}},Z=os;Z.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var pr=class{constructor(e,t,i,n,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=i,this.bottomSite=i.next,this.currentTopSite=i,this.currentBottomSite=i.next,this.layerArrays=n,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,i,n,o,a,l,u){new pr(e,t,i,o,a,l,n,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,i){if(e.equal(t))return t;let n=f.ClosestPointAtLineSegment(t,e,i),o=t.sub(n),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return so(2)==0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=pr.absCotan(e),i,n=!1;for(let o of this.bottomCorners()){let a=pr.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,i=o,n=!0)}return n?$(t,pr.absCotan(e))?!1:(this.currentBottomSite=Ge.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=pr.absCotan(e),i,n=!1;for(let o of this.topCorners()){let a=pr.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,i=o,n=!0)}return n?$(t,pr.absCotan(e))?!1:(this.currentTopSite=Ge.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&pr.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&pr.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&pr.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&pr.PossibleCorner(t,i,o)&&(yield o)}static PossibleCorner(e,t,i){return i.x>e&&i.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,i,n,o){let a=0,l=0;i==2&&(a=Number.MAX_VALUE),i==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>n&&(d.topAnchor>l+E.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+E.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,i,n,o){let a=0,l=0;i==2&&(a=Number.MAX_VALUE),i==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=n)break;d.left<o&&(d.topAnchor>l+E.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+E.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var Bt=class{constructor(e,t,i,n,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=i,this.settings=n,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinEastHierarchy=uo.Calculate(this.thinRightNodes),uo.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinWestHierarchy=uo.Calculate(this.thinWestNodes),uo.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let i of this.edgePath){let n=null;for(let o of this.EastBoundaryNodesOfANode(i,Pi.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(n==null||n.origin.x>a.origin.x)&&(n=a),e.push(a.polygonalBoundary)}n!=null&&this.thinRightNodes.push(O.mkLinePXY(n.origin,this.originalGraph.right,n.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let i of this.edgePath.nodes()){let n=-1;for(let o of this.LeftBoundaryNodesOfANode(i,Pi.GetNodeKind(t,this.edgePath)))(n==-1||this.layerArrays.x[o]>this.layerArrays.x[n])&&(n=o),e.push(this.anchors[o].polygonalBoundary);if(n!=-1){let o=this.anchors[n];this.thinWestNodes.push(O.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,i){let n=0,o=0;i==2?n=Number.MAX_VALUE:i==0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>n&&(n=c.bottomAnchor),yield u):c.bottomAnchor>n&&(this.NodeUCanBeCrossedByNodeV(u,a)||(n=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,i){let n=0,o=0;i==0?o=Number.MAX_VALUE:i==2&&(n=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+E.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,n=Math.max(n,c.bottomAnchor),yield u):c.bottomAnchor>n+E.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),n=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)==this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let i=this.OutcomingEdge(e),n=this.OutcomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Target,t=n.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}IntersectAbove(e,t){do{let i=this.IncomingEdge(e),n=this.IncomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Source,t=n.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}Intersect(e,t){let i=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],n=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return i>0&&n<0||i<0&&n>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new Ze(this.headSite)}LineSegIntersectBound(e,t){let i=O.mkPP(e,t);return Bt.CurveIntersectsHierarchy(i,this.westHierarchy)||Bt.CurveIntersectsHierarchy(i,this.thinWestHierarchy)||Bt.CurveIntersectsHierarchy(i,this.eastHierarchy)||Bt.CurveIntersectsHierarchy(i,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return Bt.SegIntersectsBound(e,t,this.westHierarchy)||Bt.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return Bt.SegIntersectsBound(e,t,this.eastHierarchy)||Bt.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn==1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn==0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,i){return Bt.CurveIntersectsHierarchy(O.mkPP(e.point,t.point),i)}static CurveIntersectsHierarchy(e,t){if(t==null||!fe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let i=t.node;return Bt.CurveIntersectsHierarchy(e,i.children[0])||Bt.CurveIntersectsHierarchy(e,i.children[1])}return v.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return f.getTriangleOrientation(e.prev.point,e.point,e.next.point)==2}Reverse(){let e=new Bt(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,i=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=i,i!=null&&(i.prev=e.headSite),i=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,i;for(let n=0;n<this.edgePath.count;n++)i=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(n),this.EdgePathNode(n+1)),t=i;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,i){pr.Refine(t,i,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=Ge.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=Ge.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),i=this.anchors[e],n=this.anchors[t];if($(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindLegalPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new f(o.ax,i.y);let c=this.headSite.next,h=c.point.y;c.point=new f(this.MiddlePos(o.ax,o.bx,i,n,h),h),c.next.point=new f(o.bx,n.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),i=this.anchors[e],n=this.anchors[t];if($(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new f(o.ax,i.y),this.headSite.next.point=new f(o.bx,n.y)}FindLegalPositions(e,t,i){return this.FindPositions(e,t,i)?this.PositionsAreLegal(i.ax,i.bx,i.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,i){let n,o;if(i.ax<i.bx?(i.sign=1,o=Math.max(i.ax,t.left),n=Math.min(e.right,i.bx)):(i.sign=-1,o=Math.max(e.left,i.bx),n=Math.min(t.right,i.ax)),o<=n)i.bx=.5*(o+n),i.ax=.5*(o+n);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;i.sign==1?(i.ax=e.right-.1*e.rightAnchor,i.bx=t.left):(i.ax=e.left+.1*e.leftAnchor,i.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let i=O.mkPP(e.origin,t.origin);return e.x<t.x&&v.CurvesIntersect(i,O.mkPP(e.rightBottom,e.rightTop))||v.CurvesIntersect(i,O.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&v.CurvesIntersect(i,O.mkPP(e.leftBottom,e.leftTop))||v.CurvesIntersect(i,O.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count==2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count==1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,i,n,o,a){if(!$(e,t)&&(e-t)*i>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,n,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new f(e,n.bottom),new f(t,o.top)):!1}MiddleAnchorLegal(e,t,i){let n=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-i.x;return!(o>0&&this.anchors[n[o-1]].right>a+i.left||o<n.length-1&&this.anchors[n[o+1]].left<a+i.right)}MiddlePos(e,t,i,n,o){let a=i.y-o,l=o-n.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let i=t.turn;if(e==0)i>0?e=1:i<0&&(e=-1);else if(e*i<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e==this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new v,t=this.headSite,i=v.findCorner(t);return i!=null?(this.createFilletCurve(e,{a:t,b:i.b,c:i.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(O.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)Bt.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!f.closeDistEps(t,e.start)){let i=new v;i.addSegs([O.mkPP(t,e.start),e]),e=i}return t=this.TailSite.point,f.closeDistEps(t,e.end)||e.addSegment(O.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,i,n){let o=.5,a;do a=v.createBezierSeg(o,o,e,t,i),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=v.createBezierSeg(o,o,e,t,i);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}n.segs.length>0&&!f.closeDistEps(n.end,a.start)&&n.addSegment(O.mkPP(n.end,a.start)),n.addSegment(a)}BezierSegIntersectsBoundary(e){return f.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(fe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let i=t.node;return this.BezierSegIntersectsTree(e,i.children[0])||this.BezierSegIntersectsTree(e,i.children[1])}else return Bt.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let i of v.getAllIntersections(e,t,!1))if(t instanceof v){let n=t;if(v.realCutWithClosedCurve(i,n,!1))return!0}else return!0;return!1}};var Fg=Q(Xn()),Xi=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new Xi(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new Fg.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Children)e.enqueue(i)}}*Ancestors(){let e=new Fg.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Parents)e.enqueue(i)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}};var ss=class{};var Ur=class extends ss{constructor(e,t){super();this.curve=this.curve,this.location=t.clone()}get Location(){return this.location}set Location(e){this.location=e}Translate(e){this.location=this.location.add(e)}get Curve(){return this.curve}set Curve(e){this.curve=e}};var zr=class extends Ur{static mk(e,t){return new zr(e,t,new f(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(e){this.centerDelegate=e}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(e){this.curveDelegate=e}get LocationOffset(){return this.locationOffset}set LocationOffset(e){this.locationOffset=e}constructor(e,t,i){super(null,t().add(i));this.LocationOffset=i,this.CurveDelegate=e,this.CenterDelegate=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var $l=class{constructor(e,t,i,n,o){this.color=e,t!==void 0&&(this.item=t),i!==void 0&&(this.parent=i),n!==void 0&&(this.left=n),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var Ke=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new $l(1)}clear(){this.root=this.nil=new $l(1)}toNull(e){return e!=this.nil?e:null}isEmpty(){return this.root==this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let i;for(;t!=this.nil&&(i=this.comparer(e,t.item))!=0;)t=i<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t==this.nil)return null;let i=null;for(;t!=this.nil;)t=e(t.item)?(i=t).left:t.right;return i}findLast(e,t=this.root){if(t==this.nil)return null;let i=null;for(;t!=this.nil;)t=e(t.item)?(i=t).right:t.left;return i}treeMinimum(e=this.root){for(;e.left!=this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!=this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!=this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!=this.nil&&e==t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!=this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!=this.nil&&e==t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!=this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!=this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!=this.root&&e.color==1;)if(e==e.parent.left){let t=e.parent.right;t.color==0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color==1&&t.right.color==1?(t.color=0,e=e.parent):(t.right.color==1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color==0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color==1&&t.left.color==1?(t.color=0,e=e.parent):(t.left.color==1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left==this.nil||e.right==this.nil)t=e;else for(t=e.right;t.left!=this.nil;)t=t.left;let i=t.left!=this.nil?t.left:t.right;return i.parent=t.parent,t.parent==this.nil?this.root=i:t==t.parent.left?t.parent.left=i:t.parent.right=i,t!=e&&(e.item=t.item),t.color==1&&this.deleteFixup(i),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,i=this.root,n=0;for(;i!=this.nil;)t=i,n=this.comparer(e,i.item),i=n<0?i.left:i.right;let o=new $l(1,e,t,this.nil,this.nil);return t==this.nil?this.root=o:n<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!=this.root&&e.parent.color==0;)if(e.parent==e.parent.parent.left){let t=e.parent.parent.right;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let i of this.allNodes())e+=i.toString(),t!=this.count-1&&(e+=`
`),t++;return e+"}"}};var as=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let i=t>>1,n,o;for(;t>1&&this.Less(n=this.A[t],o=this.A[i]);)this.A[i]=n,this.A[t]=o,t=i,i=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,i=2,n=!1;for(;i<this.heapSize&&!n;){n=!0;let o=this.A[i],a=this.A[i+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e,n=!1,t=i,i=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[i+1]=e,n=!1,t=i+1,i=t<<1)}if(i==this.heapSize){let o=this.A[i];this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Tt=class{};var Hr=class extends Tt{get Site(){return this.Vertex.point}constructor(e){super();this.Vertex=e}get Polyline(){return this.Vertex.polyline}};var Vg=class extends Hr{constructor(e){super(e)}};var kg=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(f.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),i=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}};var Ug=class extends Tt{constructor(e){super();this.site=e}get Site(){return this.site}};var Ql=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new as((i,n)=>this.Compare(i,n)),this.ObstacleSideComparer=new kg(this),this.LeftObstacleSideTree=new Ke((i,n)=>this.ObstacleSideComparer.Compare(i,n)),this.RightObstacleSideTree=new Ke((i,n)=>this.ObstacleSideComparer.Compare(i,n))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+E.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>E.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(i=>f.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(i=>!f.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new Ug(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new Vg(t))}GetLowestPoint(e){let t=e.startPoint,i=e.startPoint.next;for(;i!=null;i=i.next)this.Less(i.point,t.point)&&(t=i);return t}Compare(e,t){let i=e.Site,n=t.Site;return this.ComparePoints(i,n)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let i=this.SweepDirection.dot(e),n=this.SweepDirection.dot(t);return i<n?-1:i>n?1:(i=this.directionPerp.dot(e),n=this.directionPerp.dot(t),i<n?-1:i>n?1:0)}};var sy=Q(Pt()),co=class{constructor(e,t,i=1){this.LengthMultiplier=1;(co.closeuv(e,t)||co.closeuv(t,e))&&console.log(e),this.Source=e,this.Target=t,this.Weight=i}static closeuv(e,t){return f.closeDistEps(e.point,co.u,.1)&&f.closeDistEps(t.point,co.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return sy.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new co(this.Target,this.Source)}Clone(){return new co(this.Source,this.Target)}},Lr=co;Lr.u=new f(545.833,840.458),Lr.v=new f(606.1667261889578,786.2917261889578),Lr.DefaultWeight=1;var Mt=class extends Lr{static constructorVV(e,t){return new Mt(e,t,0)}constructor(e,t,i=0){super(e,t,i)}};var Cn=class{constructor(e){this._inEdges=new Array;this._outEdges=new Ke((t,i)=>this.Compare(t,i)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t==-1)return;let i=this._inEdges.length-1;t!=i&&(this._inEdges[t]=this._inEdges[i]),this._inEdges.pop()}static FindFirst(e,t){return Cn.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,i){if(e==t.nil)return null;let n=null;for(;e!=t.nil;)e=e.item.TargetPoint.compareTo(i)>=0?(n=e).left:e.right;return n}get(e){let t=Cn.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target==e||(t=Cn.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target==this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var Ie=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new Cn(e);this.pointToVertexMap=new je}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source==e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!=e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let i=t.startPoint;;i=i.next){let n=f.getTriangleOrientation(i.point,i.next.point,i.next.next.point);if(n!=2){yield n==0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let i=this.VertexFactory(e);return this.pointToVertexMap.set(e,i),i}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let i;if(i=e.get(t))return i;if(e==t)throw new Error("Self-edges are not allowed");let n=new Lr(e,t);return e.OutEdges.insert(n),t.InEdges.push(n),n}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,i){let n=this.FindVertex(e),o=null;if(n!=null&&(o=this.FindVertex(t),o!=null)){let l=n.get(o);if(l)return l}n==null?(n=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=i(n,o);return n.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(i,n)=>new Lr(i,n))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let i=this.FindVertex(e);if(i==null)return null;let n=this.FindVertex(t);return n==null?null:i.get(n)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var ls=class{constructor(){this.Removed=!1}};var yi=class extends ls{get Start(){return this.start}get End(){return this.EndVertex.point}constructor(e,t,i){super();this.start=e,this.EndVertex=t,this.ConeSide=i}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Zl=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var eh=class extends Tt{get ConeToClose(){return this.coneToClose}get Site(){return this.site}constructor(e,t){super();this.site=e,this.coneToClose=t}toString(){return"ConeClosureEvent "+this.site}};var Wr=class extends ls{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var Yi=class extends ls{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var Ia=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let i=e instanceof yi,n=t instanceof yi;return i?n?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):n?this.CompareConeSideAndObstacleSide(e,t):Ia.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(f.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=f.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t==1?-1:t==0?1:e instanceof Wr?-1:1}CompareConeSideAndObstacleSide(e,t){let i=f.getTriangleOrientation(this.x,t.start,t.End);return i==1?-1:i==0||e instanceof Wr?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),i=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}CompareBrokenSides(e,t){return e.EndVertex==t.EndVertex?Ia.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):f.getTriangleOrientation(this.x,t.start,t.EndVertex.point)==1?-1:1}};var us=class extends Tt{get EndVertex(){return this.endVertex}constructor(e,t,i){super();this.coneLeftSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var cs=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var hs=class extends cs{Init(e){this.StartVertex=e}constructor(e){super();this.Init(e)}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var An=class extends hs{constructor(e){super(e);this.end=e.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var $i=class extends Hr{constructor(e){super(e)}};var th=class extends Tt{get EndVertex(){return this.endVertex}set EndVertex(e){this.endVertex=e}constructor(e,t,i){super();this.coneRightSide=e,this.intersectionPoint=t,this.endVertex=i}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var vn=class extends hs{constructor(e){super(e);this.end=e.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var Qi=class extends Hr{constructor(e){super(e)}};var gt=class extends Ql{constructor(e,t,i,n,o,a,l){super(e,t);this.visibilityGraph=o,this.ConeRightSideDirection=i,this.ConeLeftSideDirection=n,this.coneSideComparer=new Ia(this),this.leftConeSides=new Ke((u,c)=>this.coneSideComparer.Compare(u,c)),this.rightConeSides=new Ke((u,c)=>this.coneSideComparer.Compare(u,c)),this.Ports=a,this.BorderPolyline=l,this.PortEdgesCreator=(u,c)=>new Mt(u,c,0)}static Sweep(e,t,i,n,o,a){new gt(e,t,t.rotate(-i/2),t.rotate(i/2),n,o,a).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let e of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(e.SourcePoint,e.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count==0)return;let e=this.BorderPolyline.startPoint,t=this.leftConeSides.count;do{let i=this.leftConeSides.treeMinimum().item.Cone;e=this.FindPolylineSideIntersectingConeRightSide(e,i),e=this.GetPolylinePointInsideOfConeAndRemoveCones(e,i),t--}while(this.leftConeSides.count>0&&t>0)}GetPolylinePointInsideOfConeAndRemoveCones(e,t){let i=e.nextOnPolyline,n=gt.FindInsidePoint(e.point,i.point,t);return f.closeDistEps(n,e.point)?(this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)):f.closeDistEps(n,i.point)?(this.AddEdgeAndRemoveCone(t,i.point),this.AddEdgesAndRemoveRemainingConesByPoint(i.point),e=i):(e=gt.InsertPointIntoPolylineAfter(this.BorderPolyline,e,n),this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)),e}static FindInsidePoint(e,t,i){return gt.FindInsidePointBool(e,t,i.Apex,i.Apex.add(i.LeftSideDirection),i.Apex.add(i.RightSideDirection))}static FindInsidePointBool(e,t,i,n,o){if(f.closeDistEps(e,t)||f.PointIsInsideCone(e,i,n,o))return e;if(f.PointIsInsideCone(t,i,n,o))return t;let a=f.middle(e,t);return f.pointToTheLeftOfLine(a,i,n)?gt.FindInsidePointBool(a,t,i,n,o):gt.FindInsidePointBool(e,a,i,n,o)}AddEdgesAndRemoveRemainingConesByPoint(e){let t=new Array;for(let i of this.leftConeSides)if(f.PointToTheRightOfLineOrOnLine(e,i.Start,i.Start.add(i.Direction)))t.push(i.Cone);else break;for(let i of t)this.AddEdgeAndRemoveCone(i,e)}FindPolylineSideIntersectingConeRightSide(e,t){let i=e,n=t.Apex,o=t.Apex.add(this.ConeRightSideDirection),a=gt.GetSign(e,n,o);for(;;){let l=e.nextOnPolyline,u=gt.GetSign(l,n,o);if(u-a>0)return e;if(e=l,a=u,e==i)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(e,t,i){let n=f.signedDoubledTriangleArea(t,i,e.point);return n<0?1:n>0?-1:0}AddEdgeAndRemoveCone(e,t){this.Ports!=null&&this.Ports.has(e.Apex)?this.CreatePortEdge(e,t):this.visibilityGraph.AddEdgePP(e.Apex,t),this.RemoveCone(e)}CreatePortEdge(e,t){this.portEdgesGraph==null&&(this.portEdgesGraph=new Ie);let i=this.portEdgesGraph.FindVertex(e.Apex),n=i!=null?Array.from(i.InEdges).concat(Array.from(i.OutEdges.allNodes())):null;if(n)for(let o of n){let a=(o.Target==i?o.Source:o.Target).point;Ie.RemoveEdge(o),this.portEdgesGraph.AddEdgePP(a,t)}this.portEdgesGraph.AddEdgePP(e.Apex,t)}static InsertPointIntoPolylineAfter(e,t,i){let n;return t.next!=null?(n=dt.mkFromPoint(i),n.prev=t,n.next=t.next,t.next.prev=n,t.next=n):(n=dt.mkFromPoint(i),n.prev=t,t.next=n,e.endPoint=n),n.polyline=e,e.setInitIsRequired(),n}ProcessEvent(e){e instanceof Hr?this.ProcessVertexEvent(e):e instanceof th?this.ProcessRightIntersectionEvent(e):e instanceof us?this.ProcessLeftIntersectionEvent(e):(e instanceof eh?e.ConeToClose.Removed||this.RemoveCone(e.ConeToClose):this.ProcessPortObstacleEvent(e),this.Z=this.GetZS(e))}ProcessPortObstacleEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.CreateConeOnVertex(e)}ProcessLeftIntersectionEvent(e){if(e.coneLeftSide.Removed==!1)if(Math.abs(e.EndVertex.point.sub(e.Site).dot(this.SweepDirection))<E.distanceEpsilon)this.RemoveCone(e.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(e.coneLeftSide),this.Z=this.GetZP(e.Site);let t=new yi(e.Site,e.EndVertex,e.coneLeftSide);this.InsertToTree(this.leftConeSides,t),e.coneLeftSide.Cone.LeftSide=t,this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForLeftSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForLeftSide(e){if(e.Cone.RightSide instanceof Yi){let t=e.Cone.RightSide;f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.EndVertex.point)==0&&this.CreateConeClosureEvent(e,t)}}CreateConeClosureEvent(e,t){let i=f.RayIntersectsRayInteriors(e.start,e.Direction,t.Start,t.Direction);if(i){let n=new eh(i,e.Cone);this.EnqueueEvent(n)}}ProcessRightIntersectionEvent(e){if(e.coneRightSide.Removed==!1){this.RemoveSegFromRightTree(e.coneRightSide),this.Z=this.GetZP(e.Site);let t=new yi(e.Site,e.EndVertex,e.coneRightSide);this.InsertToTree(this.rightConeSides,t),e.coneRightSide.Cone.RightSide=t,this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForRightSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForRightSide(e){if(e.Cone.LeftSide instanceof Wr){let i=e.Cone.LeftSide;f.getTriangleOrientation(i.Start,i.Start.add(i.Direction),e.EndVertex.point)==1&&this.CreateConeClosureEvent(e,i)}}RemoveConesClosedBySegment(e,t){this.CloseConesCoveredBySegment(e,t,this.GetZP(e)>this.GetZP(t)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(e,t,i){let n=i.findFirst(l=>f.getTriangleOrientation(l.Start,l.Start.add(l.Direction),e)==1);if(n==null||!f.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction))return;let a=new Array;do a.push(n.item.Cone),n=i.next(n);while(n!=null&&f.IntervalIntersectsRay(e,t,n.item.Start,n.item.Direction)!=null);for(let l of a)this.RemoveCone(l)}ProcessVertexEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.AddConeAndEnqueueEvents(e)}static Diamond(e){return Se.CreateDiamond(2,2,e)}AddConeAndEnqueueEvents(e){if(e instanceof $i){let i=e.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(e,i)}else if(e instanceof Qi){let n=e.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(e,n)}else this.CloseConesAddConeAtLeftVertex(e,e.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(e,e.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;this.directionPerp.dot(e.Site.sub(i))>E.distanceEpsilon&&this.RemoveConesClosedBySegment(i,e.Vertex.point),this.directionPerp.dot(t.point.sub(e.Site))>E.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,t.point);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>E.distanceEpsilon&&this.RemoveRightSide(new vn(e.Vertex.nextOnPolyline)),this.GetZP(n.sub(t.point))>E.distanceEpsilon&&this.RemoveLeftSide(new An(t)),this.GetZP(l)+E.distanceEpsilon<this.GetZS(e)&&this.CreateConeOnVertex(e),f.PointToTheRightOfLineOrOnLine(l,n,o)?f.PointToTheLeftOfLineOrOnLine(l,n,a)?this.CaseToTheLeftOfLineOrOnLineConeRp(e,t):(this.GetZP(l.sub(n))>E.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,t),this.InsertRightSide(new vn(e.Vertex))),this.EnqueueRightVertexEvent(new Qi(t))):(this.CreateConeOnVertex(e),f.PointToTheLeftOfLineOrOnLine(l.add(this.DirectionPerp),l,n)&&this.EnqueueRightVertexEvent(new Qi(t)))}CaseToTheLeftOfLineOrOnLineConeRp(e,t){this.EnqueueRightVertexEvent(new Qi(t));let i=new Zl(e.Vertex.point,this),n=new yi(i.Apex,t,new Wr(i));i.LeftSide=n,i.RightSide=new Yi(i);let o=this.InsertToTree(this.rightConeSides,i.RightSide);this.LookForIntersectionWithConeRightSide(o);let a=this.InsertToTree(this.leftConeSides,i.LeftSide);this.FixConeLeftSideIntersections(n,a),this.GetZP(t.point.sub(e.Site))>E.distanceEpsilon&&this.InsertRightSide(new vn(e.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(e,t){let i=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(e);if(i!=null&&i.item instanceof Yi!=null){let o=f.IntervalIntersectsRay(e,t.point,i.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,t.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(i.item,o,t))}}CreateRightIntersectionEvent(e,t,i){return new th(e,t,i)}GetLastNodeToTheLeftOfPointInRightSegmentTree(e){return this.rightConeSides.findLast(t=>gt.PointIsToTheRightOfSegment(e,t))}LookForIntersectionOfObstacleSideAndLeftConeSide(e,t){let i=this.GetFirstNodeToTheRightOfPoint(e);if(i==null||!(i.item instanceof Wr))return;let n=i.item,o=f.IntervalIntersectsRay(e,t.point,n.Start,this.ConeLeftSideDirection);o&&this.EnqueueEvent(new us(n,o,t))}GetFirstNodeToTheRightOfPoint(e){return this.leftConeSides.findFirst(t=>gt.PointIsToTheLeftOfSegment(e,t))}static PointIsToTheLeftOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==1}static PointIsToTheRightOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==0}FixConeLeftSideIntersections(e,t){do t=this.leftConeSides.next(t);while(t!=null&&f.PointToTheRightOfLineOrOnLine(e.Start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null&&t.item instanceof Wr){let i=t.item,n=f.IntervalIntersectsRay(e.start,e.End,i.Start,i.Direction);n&&this.EnqueueEvent(new us(i,n,e.EndVertex))}}InsertToTree(e,t){return this.coneSideComparer.SetOperand(t),e.insert(t)}CloseConesAddConeAtLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;e.Site.sub(i).dot(this.directionPerp)<-E.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,i),t.point.sub(e.Site).dot(this.directionPerp)<-E.distanceEpsilon&&this.RemoveConesClosedBySegment(t.point,e.Site);let n=e.Site,o=n.add(this.ConeLeftSideDirection),a=n.add(this.ConeRightSideDirection),l=t.point;this.GetZP(n.sub(i))>E.distanceEpsilon&&this.RemoveLeftSide(new An(e.Vertex.prevOnPolyline));let u=this.GetZP(l)-this.Z;u<-E.distanceEpsilon&&this.RemoveRightSide(new vn(t));let c=l.sub(e.Site);if(u<-E.distanceEpsilon||$(u,0)&&this.GetZP(c)>0&&c.dot(this.directionPerp)>-E.distanceEpsilon)this.CreateConeOnVertex(e);else if(!f.PointToTheLeftOfLineOrOnLine(l,n,a))this.CreateConeOnVertex(e),this.EnqueueEvent(new $i(t));else if(f.PointToTheLeftOfLineOrOnLine(l,n,o))this.EnqueueEvent(new $i(t)),this.GetZP(c)>E.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,t),this.InsertLeftSide(new An(e.Vertex)));else{this.EnqueueEvent(new $i(t));let h=new Zl(e.Vertex.point,this),d=new yi(e.Vertex.point,t,new Yi(h));h.RightSide=d,h.LeftSide=new Wr(h),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,h.LeftSide));let p=this.InsertToTree(this.rightConeSides,d);this.FixConeRightSideIntersections(d,p),this.GetZP(c)>E.distanceEpsilon&&this.InsertLeftSide(new An(e.Vertex))}}RemoveCone(e){e.Removed=!0,this.RemoveSegFromLeftTree(e.LeftSide),this.RemoveSegFromRightTree(e.RightSide)}RemoveSegFromRightTree(e){this.coneSideComparer.SetOperand(e);let t=this.rightConeSides.remove(e);if(e.Removed=!0,t==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),t=this.rightConeSides.remove(e),this.Z=i}}RemoveSegFromLeftTree(e){if(e.Removed=!0,this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e)==null){let i=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e),this.Z=i}}FixConeRightSideIntersections(e,t){do t=this.rightConeSides.previous(t);while(t!=null&&f.PointToTheLeftOfLineOrOnLine(e.start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null){let i;if(t.item instanceof Yi){let n=t.item;(i=f.IntervalIntersectsRay(e.start,e.End,n.Start,n.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n,i,e.EndVertex))}}}CreateConeOnVertex(e){let t=new Zl(e.Site,this);t.LeftSide=new Wr(t),t.RightSide=new Yi(t);let i=this.InsertToTree(this.leftConeSides,t.LeftSide),n=this.InsertToTree(this.rightConeSides,t.RightSide);this.LookForIntersectionWithConeRightSide(n),this.LookForIntersectionWithConeLeftSide(i)}LookForIntersectionWithConeLeftSide(e){if(e.item instanceof Wr){let i=e.item,n=this.FindFirstObstacleSideToTheLeftOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(i,n)}else{let i=e.item;e=this.leftConeSides.next(e),e!=null&&e.item instanceof Wr&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(e.item,i)}}LookForIntersectionWithConeRightSide(e){if(e.item instanceof Yi){let i=e.item,n=this.FindFirstObstacleSideToToTheRightOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(i,n)}else{let i=e.item;e=this.rightConeSides.previous(e),e!=null&&e.item instanceof Yi&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(e.item,i)}}TryIntersectionOfConeRightSideAndObstacleConeSide(e,t){let i=f.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(e,t){let i=f.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(e,t){let i=f.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new us(e,i,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(e,t){let i=f.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);i&&this.EnqueueEvent(new us(e,i,t.EndVertex))}Show(e,t){let i=Array.from(this.Obstacles).map(n=>Z.mkDebugCurveTWCI(200,.5,"Blue",n));for(let n of this.rightConeSides)i.push(Z.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(n))),n instanceof yi&&i.push(Z.mkDebugCurveCI("brown",gt.Diamond(n.start))),i.push(Z.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(n.Cone.LeftSide))),n.Cone.LeftSide instanceof yi&&i.push(Z.mkDebugCurveCI("green",gt.Diamond(n.Cone.LeftSide.start)));i=i.concat(Array.from(this.visibilityGraph.Edges).map(n=>Z.mkDebugCurveWCI(2,"Black",O.mkPP(n.SourcePoint,n.TargetPoint)))),i=i.concat(e.map(n=>Z.mkDebugCurveCI("Red",n)))}ExtendSegmentToZ(e){let t=e.Direction.dot(this.SweepDirection),i=(this.Z+40-e.Start.dot(this.SweepDirection))/t;return O.mkPP(e.Start,e.Start.add(e.Direction.mul(i)))}GoOverConesSeeingVertexEvent(e){let t=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e);if(t==null)return;let n=t.item.Cone,o=n.LeftSide;if(gt.VertexIsToTheLeftOfSegment(e,o))return;let a=[n];if(this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),t==null){let l=this.Z;this.Z=Math.max(this.GetZP(o.Start),this.PreviousZ),this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),this.Z=l}if(!(t==null&&(t=this.GetRbNodeEmergency(t,o),t==null))){for(t=this.leftConeSides.next(t);t!=null&&!gt.VertexIsToTheLeftOfSegment(e,t.item);)a.push(t.item.Cone),t=this.leftConeSides.next(t);for(let l of a)this.AddEdgeAndRemoveCone(l,e.Site)}}GetRbNodeEmergency(e,t){for(let i=this.leftConeSides.treeMinimum();i!=null;i=this.leftConeSides.next(i))if(i.item==t){e=i;break}return e}static VertexIsToTheLeftOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==1}static VertexIsToTheRightOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e){return this.rightConeSides.findFirst(t=>!gt.VertexIsToTheRightOfSegment(e,t))}EnqueueRightVertexEvent(e){this.GetZP(e.Site.sub(e.Vertex.prevOnPolyline.point))>E.tolerance||this.EnqueueEvent(e)}invariant(){for(let e of this.leftConeSides)if(e.Removed)return!1;for(let e of this.rightConeSides)if(e.Removed)return!1;return!0}};var ho=class extends ae{constructor(e,t){super(null);this.coneAngle=Math.PI/6;this.ports=new Me;this._obstacles=Array.from(Ie.OrientHolesClockwise(e)),this._visibilityGraph=t}static mk(e,t,i,n,o){let a=new ho(e,t);return a.Ports=n,a.BorderPolyline=o,a.ConeAngle=i,a}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Ports(){return this.ports}set Ports(e){this.ports=e}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(e){this.borderPolyline=e}get Bidirectional(){return this._bidirectional}set Bidirectional(e){this._bidirectional=e}static GetTotalSteps(e){return Math.floor((2*Math.PI-e/2)/e)+1}run(){let e=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let t;for(let i=0;(t=this.coneAngle*i)<=e;i++)super.ProgressStep(),this.AddDirection(new f(Math.cos(t),Math.sin(t)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let e=Math.PI/this.coneAngle;for(let t=0;t<e;t++){let i=t*this.coneAngle,n=new Ie;this.AddDirection(new f(Math.cos(i),Math.sin(i)),this.BorderPolyline,n);let o=new Ie;this.AddDirection(new f(Math.cos(i)*-1,Math.sin(i)*-1),this.BorderPolyline,o),this.AddIntersectionOfBothDirectionSweepsToTheResult(n,o)}}AddIntersectionOfBothDirectionSweepsToTheResult(e,t){for(let i of e.Edges)t.FindEdgePP(i.SourcePoint,i.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(i.SourcePoint,i.TargetPoint)}AddDirection(e,t,i){gt.Sweep(this._obstacles,e,this.coneAngle,i,this.Ports,t)}};var ut=class extends ss{constructor(e){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=e,this.location=this.curve().start}mk(e,t){let i=new ut(e);return i.HookSize=t,i}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(e){this.location=e}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(e){this.adjustmentAngle=e}get HookSize(){return this.hookSize}set HookSize(e){this.hookSize=e}};var kt=class extends zr{get LoosePolyline(){return this.loosePolyline}set LoosePolyline(e){this.loosePolyline=e}constructor(e,t,i=new f(0,0)){super(e,t,i)}static mk(e,t){return new kt(e,t)}};var Ut=class extends ss{get Location(){return this.curve.value(this.parameter)}set Location(e){throw new Error("Method should not be called.")}static mk(e,t){let i=new Ut;return i.curve=e,i.parameter=t,i}get Parameter(){return this.parameter}set Parameter(e){this.parameter=e}get Curve(){return this.curve}set Curve(e){this.curve=e}};var wa=class extends Xi{get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(e){if(e)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}constructor(e){super(null);this.curveDelegate=e}};var jr=class{static GetShapes(e,t){let i=new Map;for(let n of e)jr.ProcessAncestorDescendantCouple(n.target,n.source,i),jr.InsertEdgePortsToShapes(i,n);for(let n of t)jr.ProcessAncestorDescendantCouple(n.source,n.target,i),jr.InsertEdgePortsToShapes(i,n);return jr.BindShapes(i),Array.from(i.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,i]of e){if(!(t instanceof ze))continue;let n=t;for(let o of zg(n)){let a=e.get(o);a&&i.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,i){let n=rh(t);do{for(let o of zg(n))jr.CreateShapeIfNeeeded(o,i);if(n==e)break;n=rh(n)}while(!0);jr.CreateShapeIfNeeeded(n,i)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new wa(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,i){let n=new Set;for(let o of e)if(jr.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,n,i))return!1;for(let o of t)if(jr.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,n,i))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,i,n){let o=rh(t);for(;;){for(let a of zg(o))if(i.add(a),i.size>n)return!0;if(o==e)break;o=rh(o)}return i.add(o),i.size>n}};function rh(s){let e=s.node.parent;return Le.getGeom(e)}function*zg(s){for(let e of s.graph.shallowNodes)yield Le.getGeom(e)}var mr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new f(0,Number.MAX_SAFE_INTEGER);let t=-1,i=0;for(let n of e)n.y<this.pivot.y?(this.pivot=n,t=i):n.y==this.pivot.y&&n.x>this.pivot.x&&(this.pivot=n,t=i),i++;if(i>=1){this.hullPoints=new Array(i-1),i=0;for(let n of e)i!=t?this.hullPoints[i++]={point:n,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new mr(e);for(let i of t.Calculate())yield i}*Calculate(){if(this.pivot.y!=Number.MAX_SAFE_INTEGER){if(this.hullPoints.length==0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return f.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)==1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=f.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t==1?!0:t==0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+E.distanceEpsilon&&e.x<this.pivot.x-E.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(dw(this.pivot))}static createConvexHullAsClosedPolyline(e){return q.mkClosedFromPoints(Array.from(mr.CalculateConvexHull(e)))}};function dw(s){return(e,t)=>{if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;switch(f.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let i=e.point.x-s.x,n=t.point.x-s.x;if(i>E.distanceEpsilon&&n<E.distanceEpsilon*-1)return-1;if(i<E.distanceEpsilon*-1&&n>E.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function tr(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(tr(s,e.Left,t),tr(s,e.Right,t)):e.Left!=null?(tr(s.Left,e.Left,t),tr(s.Left,e.Right,t),tr(s.Right,e.Left,t),tr(s.Right,e.Right,t)):(tr(s.Left,e,t),tr(s.Right,e,t)))}function pt(s,e,t){!s.irect.intersects_rect(e.irect)||(s==e?gw(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(pt(s,e.Left,t),pt(s,e.Right,t)):e.Left!=null?(pt(s.Left,e.Left,t),pt(s.Left,e.Right,t),pt(s.Right,e.Left,t),pt(s.Right,e.Right,t)):(pt(s.Left,e,t),pt(s.Right,e,t)))}function qr(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s==e)return fw(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(qr(s,e.Left,t)||qr(s,e.Right,t))return!0}else if(e.Left!=null){if(qr(s.Left,e.Left,t)||qr(s.Left,e.Right,t)||qr(s.Right,e.Left,t)||qr(s.Right,e.Right,t))return!0}else if(qr(s.Left,e,t)||qr(s.Right,e,t))return!0;return!1}function fw(s,e){return s.Left==null?!1:qr(s.Left,s.Left,e)||qr(s.Left,s.Right,e)||qr(s.Right,s.Right,e)}function gw(s,e){s.Left!=null&&(pt(s.Left,s.Left,e),pt(s.Left,s.Right,e),pt(s.Right,s.Right,e))}var La=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n>=this.f(0)&&n>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:e=i;break;case 0:t=i;break;case 2:return i}return e==t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e==0){let o=this.f(1);return o==t?2:o>t?0:1}if(e==this.length-1){let o=this.f(this.length-2);return o==t?2:o>t?1:0}let i=t-this.f(e-1),n=this.f(e+1)-t;return i*n<=0?2:i>0?0:1}FindMaximum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n<=this.f(0)&&n<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:t=i;break;case 0:e=i;break;case 2:return i}return e==t||this.f(e)>this.f(t)?e:t}};var Hg=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.min(this.f(n),e+i*n)}GetAdjustedSequenceForMaximum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.max(this.f(n),e+i*n)}FindMinimum(){return this.f(0)==this.f(this.length-1)?new La(this.f,this.length).FindMinimum():new La(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)==this.f(this.length-1)?new La(this.f,this.length).FindMaximum():new La(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var ds=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,i){let n=this.P.pnt(e);return this.upperBranchOnP?f.pointToTheLeftOfLineOrOnLine(i,n,t):f.pointToTheRightOfLineOrOnLine(i,n,t)}LeftFromLineOnQ(e,t,i){let n=this.Q.pnt(e);return this.lowerBranchOnQ?f.pointToTheLeftOfLineOrOnLine(i,n,t):f.pointToTheRightOfLineOrOnLine(i,n,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,i,n){for(;t!=e||n!=i;){let o=t!=e?this.MedianOnP(e,t):e,a=n!=i?this.MedianOnQ(i,n):i,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!=e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(i,n)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?i=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?n=a:h=!1:n!=i?this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:h=!1:h=!1,!c&&!h&&(e=o,t=o,i=a,n=a)}return[e,n]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=f.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.add(t.qClosest).rotate(Math.PI/2)}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2==e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2==e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1==e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1==e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=f.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),f.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:f.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=f.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),f.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:f.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,i,n){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(n-i)+1;return a>2||o==2&&a==2}ShrinkChunks(e){let t=e.p1==e.p2?e.p1:this.P.Median(e.p1,e.p2),i=e.q1==e.q2?e.q1:this.Q.Median(e.q2,e.q1),n=this.P.pp(t).point,o=this.Q.pp(i).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,i,n,o,a),!this.InternalCut(e,t,i,a.a1,a.a2,a.b1,a.b2)&&!ds.OneOfChunksContainsOnlyOneVertex(e,t,i,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:i},a)){if(e.p2==this.P.Next(e.p1)&&e.q1==this.Q.Next(e.q2)){let l=O.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab==0?e.p2=e.p1:l.parab==1?e.p1=e.p2:l.parcd==0?e.q2=e.q1:l.parcd==1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=i:a.a2>=Math.PI/2?e.p2=t:e.q2=i:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=i:e.q2=i}}InternalCut(e,t,i,n,o,a,l){let u=!1;if(n>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.P.pp(this.P.Next(t)).point,p=f.getTriangleOrientation(c,h,this.Q.pp(0).point),y=f.getTriangleOrientation(c,h,d);p==y?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.Q.pp(this.Q.Next(i)).point,p=f.getTriangleOrientation(c,h,this.P.pp(0).point),y=f.getTriangleOrientation(c,h,d);p==y?e.q2=this.Q.Next(i):e.q1=this.Q.Prev(i),u=!0}return u}GetAnglesAtTheMedian(e,t,i,n,o){o.a1=f.anglePCP(n,i,this.P.pnt(this.P.Prev(e))),o.a2=f.anglePCP(this.P.pnt(this.P.Next(e)),i,n),o.b1=f.anglePCP(this.Q.pnt(this.Q.Next(t)),n,i),o.b2=f.anglePCP(i,n,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,i){let n=e.p2==this.P.Next(e.p1),o=e.q1==this.Q.Next(e.q2);return n&&!o?(this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),!0):o&&!n?(this.SwapEverything(e,t,i),this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),this.SwapEverything(e,t,i),!0):!1}SwapEverything(e,t,i){this.SwapPq();let n=e.p2;e.p2=e.q1,e.q1=n,n=e.q2,e.q2=e.p1,e.p1=n,n=t.mq,t.mq=t.mp,t.mp=n,n=i.a2,i.a2=i.b1,i.b1=n,n=i.b2,i.b2=i.a1,i.a1=n}ProcessShortSide(e,t,i,n,o,a,l){t==e.p2?this.ProcessSide(e,i,n,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=i:o>=Math.PI/2?e.q1=i:a<l&&(f.canProject(this.Q.pnt(i),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=i:e.p1=e.p2):n+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,i,n,o){let a=this.Q.pnt(t);i<=Math.PI?i+n>=Math.PI?i>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:i<o&&(f.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,n>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,i,n,o){return e.p1==e.p2?(o>=Math.PI/2?e.q1=i:e.q2=i,!0):e.q1==e.q2?(n>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,i,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,i,e.q2)}CalculateRightTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,i,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,i,e.q2)}};var It=class{static mkFromPoints(e){return new It(q.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,i,n){let o=n.rotate(Math.PI/2);this.polyline.startPoint.point.sub(i).dot(o)<0&&(o=o.mul(-1)),e==t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!=t);return e}static TestPolygonDist(e,t){let i=Number.MAX_SAFE_INTEGER;for(let n=0;n<e.count;n++)for(let o=0;o<t.count;o++){let a=O.minDistBetweenLineSegments(e.pnt(n),e.pnt(n+1),t.pnt(o),t.pnt(o+1));i=Math.min(i,a.dist)}return i}static Distance(e,t){let n=new ds(e,t).FindClosestPoints();return{p:n.pClosest,q:n.qClosest,dist:n.pClosest.sub(n.qClosest).length}}static DistanceOnly(e,t){return It.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let i=t.startPoint;i.next!=null&&i.next.next!=null;i=i.next)if(f.getTriangleOrientation(i.point,i.next.point,i.next.next.point)==2)return!1;return!0}static DistancePoint(e,t){let i=Number.MAX_VALUE;for(let n=0;n<e.count;n++){let o=f.distToLineSegment(t,e.points[n].point,e.points[(n+1)%e.count].point).dist;i=Math.min(i,o)}return i}GetTangentPoints(e,t){let i=new Hg(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=i.FindMaximum(),e.rightTangentPoint=i.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return i=>{let n=f.anglePCP(t,e,this.pnt(i));return n<Math.PI?n:n-2*Math.PI}}};var ce=class{ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(O.mkPP(e,t))}static PadCorner(e,t,i,n,o){let a=ce.GetPaddedCorner(t,i,n,o);return a.numberOfPoints==-1?!1:(e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return f.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t){return ce.CreatePaddedPolyline(v.polylineAroundClosedCurve(e),t)}static LoosePolylineWithFewCorners(e,t){return t<E.distanceEpsilon?e:ce.CreateLoosePolylineOnBisectors(e,t)}static CreateLoosePolylineOnBisectors(e,t){return q.mkClosedFromPoints(mr.CalculateConvexHull(ce.BisectorPoints(e,t)))}static CreateRectNodeOfPolyline(e){return We(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=ce.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(ce.LoosePolylineWithFewCorners(e,t))}this.RootOfLooseHierarchy=ce.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=ce.CreateTightObstacles_(this.Obstacles,this.TightPadding,this.TightObstacles),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size==0}constructor(e,t,i,n){this.Obstacles=e,this.TightPadding=t,this.LoosePadding=i,this.IgnoreTightPadding=n}ObstaclesIntersectICurve(e){let t=e.boundingBox;return ce.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,i){if(!i.irect.intersects(t))return!1;if(i.UserData!=null){let n=i.UserData;return v.intersectionOne(n,e,!1)!=null||ce.PointIsInside(n.start,e)}return ce.CurveIntersectsRectangleNode(e,t,i.Left)||ce.CurveIntersectsRectangleNode(e,t,i.Right)}static PointIsInside(e,t){return v.PointRelativeToCurveLocation(e,t)==2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(n=>v.polylineAroundClosedCurve(n)),t=ce.CalculateHierarchy(e),i=ce.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,i.size==0){for(let n of e){let o=ce.FindMaxPaddingForTightPolyline(t,n,this.TightPadding);this.TightObstacles.add(ce.LoosePolylineWithFewCorners(n,o))}this.RootOfTightHierarchy=ce.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let n of e)this.TightObstacles.add(ce.CreatePaddedPolyline(n,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=ce.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;ce.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=ce.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(i)),this.OverlapsDetected=!0}}static CreateTightObstacles_(e,t,i){if(e.length==0)return null;for(let n of e)ce.CalculateTightPolyline(i,t,n);return ce.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(i)}static CalculateTightPolyline(e,t,i){let n=ce.PaddedPolylineBoundaryOfNode(i,t);e.add(n)}static CalculateHierarchy(e){let t=e.map(i=>ce.CreateRectNodeOfPolyline(i));return Oe(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=ce.CalculateHierarchy(Array.from(e)),i;for(;(i=ce.GetOverlappedPairSet(t)).size>0;)t=ce.ReplaceTightObstaclesWithConvexHulls(e,Array.from(i));return t}static MapToInt(e){let t=new Map;for(let i=0;i<e.length;i++)t.set(e[i],i);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let i=new Set;for(let u of t)i.add(u[0]),i.add(u[1]);let n=Array.from(i),o=ce.MapToInt(n),a=Vc(Array.from(t).map(u=>new ee(o.get(u[0]),o.get(u[1])))),l=Pn(a);for(let u of l){let c=u.map(p=>n[p]),h=qi(c,p=>Array.from(p)),d=mr.createConvexHullAsClosedPolyline(h);for(let p of c)e.delete(p);e.add(d)}return ce.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return v.PointRelativeToCurveLocation(e.start,t)!=0||v.PointRelativeToCurveLocation(t.start,e)!=0}static PolylinesIntersect(e,t){return v.CurvesIntersect(e,t)||ce.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return pt(e,e,(i,n)=>{ce.PolylinesIntersect(i,n)&&t.add([i,n])}),t}static BisectorPoints(e,t){let i=new Array;for(let n=e.startPoint;n!=null;n=n.next){let o={skip:!1},a=ce.GetStickingVertexOnBisector(n,t,o);o.skip||i.push(a)}return i}static GetStickingVertexOnBisector(e,t,i){let n=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(n).normalize().add(o.sub(a).normalize()),u=l.length;return u<E.tolerance?i.skip=!0:(i.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,i){let n=i,o=new It(t),a=t.boundingBox.clone();a.pad(2*i);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!=t)){let u=It.Distance(o,new It(l)).dist;n=Math.min(n,u/ce.LooseDistCoefficient)}return n}static GetPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point;if(f.getTriangleOrientation(o,a,l)==1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(ce.CornerIsNotTooSharp(o,a,l)){u=u.mul(n);let x=l.sub(a).normalize().mul(n).rotate(Math.PI/2),A=f.lineLineIntersection(o.add(u),a.add(u),a.add(x),l.add(x));return{a:A,b:A,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<E.intersectionEpsilon){let x=a.add(u.mul(n));return{a:x,b:x,numberOfPoints:1}}let h=c.normalize().mul(n),d=h.rotate(Math.PI/2),p=(n-h.dot(u))/d.dot(u),y=d.mul(p);return{a:h.add(y).add(a),b:h.sub(y).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,i){let n=e.sub(t).rotate(Math.PI/4).add(t);return f.getTriangleOrientation(t,n,i)==1}static CreatePaddedPolyline(e,t){let i=new q;if(!ce.PadCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t))return ce.CreatePaddedPolyline(q.mkClosedFromPoints(Array.from(mr.CalculateConvexHull(e))),t);if(!ce.PadCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t))return ce.CreatePaddedPolyline(q.mkClosedFromPoints(Array.from(mr.CalculateConvexHull(e))),t);for(let n=e.startPoint;n.next.next!=null;n=n.next)if(!ce.PadCorner(i,n,n.next,n.next.next,t))return ce.CreatePaddedPolyline(q.mkClosedFromPoints(Array.from(mr.CalculateConvexHull(e))),t);return i.closed=!0,i}},wt=ce;wt.LooseDistCoefficient=2.1;var Kl=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,i){let n=new Kl;return n.TightPolyline=e,n.LooseShape=t,n.Distance=i,n}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Jl=class{constructor(e,t,i,n){this.MainShape=e,this.TightPadding=t,this.LoosePadding=i,this.ShapesToTightLooseCouples=n}Calculate(){this.MainShape.Children.length!=0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=Oe(this.MainShape.Children.map(t=>We(t,t.BoundingBox)));tr(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Jl.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return v.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)==2}CreateTigthLooseCouples(){let e=new Array;for(let t of this.tightHierarchy.GetAllLeaves()){let i=wt.FindMaxPaddingForTightPolyline(this.tightHierarchy,t,this.LoosePadding),n=wt.LoosePolylineWithFewCorners(t,i);e.push(Kl.mk(t,new Xi(n),i))}this.coupleHierarchy=Oe(e.map(t=>We(t,t.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=wt.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=wt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),i=qi(this.LoosePolylinesUnderShape(e),o=>Array.from(o)).filter(o=>v.PointRelativeToCurveLocation(o,t)==0);if(i.length<=0)return t;let n=Array.from(t).concat(i);return q.mkClosedFromPoints(mr.CalculateConvexHull(n))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var ay=Q(Pt());var Wg=class{constructor(e,t,i){this.indexToA=e,this.priority=t,this.v=i}};var zt=class{constructor(e=ue){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let i=++this.heapSize,n=new Wg(i,t,e);for(this.cache.set(e,n),this.A[i]=n;i>1&&this.compare(this.A[i>>1].priority,t)>0;)this.SwapWithParent(i),i>>=1}IsEmpty(){return this.heapSize==0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this.compare(this.A[n].priority,this.A[t].priority)<0&&(i=n);let o=n+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[i].priority)<0&&(i=o),i!=t)this.SwapWithParent(i);else break;t=i}this.heapSize--}DecreasePriority(e,t){let i=this.cache.get(e);if(!i)return;i.priority=t;let n=i.indexToA;for(;n>1&&this.compare(this.A[n].priority,this.A[n>>1].priority)<0;){this.SwapWithParent(n);n>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count==0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new ay.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var fo=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,this._visGraph.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new zt(ue);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source==this.source||this.targets.has(e.Target)||!fo.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target==this.source||!fo.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof Mt}ProcessNeighbor(e,t,i){let n=t.Length,o=this.current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),i!=this.source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!=this.source);return e.push(this.source),e.reverse()}};var Ra=class{constructor(e,t,i){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=i,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new zt(ue);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let i={priority:0},n=t.DequeueAndGetPriority(i);if(i.priority>=this._target.Distance)break;for(let o of n.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,n,o,a)}for(let o of n.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,n,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source==this._source||e.Target==this._target||!Ra.IsForbidden(e)}PassableInEdge(e){return e.Source==this._target||e.Target==this._source||!Ra.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof Mt}ProcessNeighborN(e,t,i,n,o){let a=i.Length+o,l=t.Distance+a;n!=this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.Enqueue(n,this.H(n))):n!=this._source&&l<n.Distance&&(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.DecreasePriority(n,this.H(n)))}ProcessNeighbor(e,t,i,n){let o=i.Length,a=t.Distance+o;n!=this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.Enqueue(n,this.H(n))):n!=this._source&&a<n.Distance&&(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!=this._target&&e.DecreasePriority(n,this.H(n)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,i=this._target;do t.push(i),e&&this._visGraph.ShrinkLengthOfPrevEdge(i,this.LengthMultiplier),i=this._visGraph.PreviosVertex(i);while(i!=this._source);return t.push(this._source),t.reverse()}};var ly=Q(Pt()),ih=class{toString(){return ly.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var uy=Q(Pt()),nh=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return uy.String.Format("{0},{1}",this.Start,this.End)}};var oh=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(f.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,i){return f.closeDistEps(e,f.ClosestPointAtLineSegment(e,t,i))}static IntersectDiagonalWithRay(e,t,i){let n=t.sub(e),o=i.Start,a=i.End,l=fi.solve(a.x-o.x,n.x*-1,e.x-o.x,a.y-o.y,n.y*-1,e.y-o.y);return e.add(n.mul(l.y))}};var Tn=class{constructor(e){this.pivot=e}IComparer(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=e.Start.point.sub(this.pivot),n=t.Start.point.sub(this.pivot);return Tn.CompareVectorsByAngleToXAxis(i,n)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Tn.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Tn.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let i=e.x*t.y-e.y*t.x;if(i>E.tolerance)return-1;if(i<-E.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let n=Math.abs(e.x)-Math.abs(t.x);return n<0?-1:n>0?1:(n=Math.abs(e.y)-Math.abs(t.y),n<0?-1:n>0?1:0)}};var Zi=class extends ae{constructor(e,t,i){super(null);this.activeDiagonalComparer=new oh;this.polygons=e,this.visibilityGraph=i,this.addedPolygons=t}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let e of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(e);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(e){this.currentPolygon=e,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new Ke(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let e=1;e<this.tangents.length;e++){let t=this.tangents[e];t.Diagonal!=null?(t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsHigh&&this.RemoveDiagonalFromActiveNodes(t.Diagonal)):t.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=t.End.point,this.InsertActiveDiagonal(new ih(t,t.Comp)),t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t))}}AddVisibleEdge(e){Ie.AddEdgeVV(cy(this.visibilityGraph,e.start),cy(this.visibilityGraph,e.End))}InitActiveDiagonals(){if(this.tangents.length==0)return;let e=this.tangents[0],t=e.start.point,i=e.End.point;for(let n of this.diagonals)if(Zi.RayIntersectDiagonal(t,i,n)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=oh.IntersectDiagonalWithRay(t,i,n),this.InsertActiveDiagonal(n)),e.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(e),e.IsLow==!1){let o=e.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(e){let t=this.activeDiagonalTree.deleteSubTree(e.RbNode);t!=null&&t.item!=null&&(t.item.RbNode=t),e.LeftTangent.Diagonal=null,e.RightTangent.Diagonal=null}InsertActiveDiagonal(e){e.RbNode=this.activeDiagonalTree.insert(e),Zi.MarkDiagonalAsActiveInTangents(e)}static MarkDiagonalAsActiveInTangents(e){e.LeftTangent.Diagonal=e,e.RightTangent.Diagonal=e}static RayIntersectDiagonal(e,t,i){let n=i.Start,o=i.End;return f.getTriangleOrientation(e,n,o)==1&&f.getTriangleOrientation(e,t,n)!=1&&f.getTriangleOrientation(e,t,o)!=0}static TangentComparison(e,t){return Tn.CompareVectorsByAngleToXAxis(e.End.point.sub(e.start.point),t.End.point.sub(t.start.point))}*AllObstacles(){for(let e of this.addedPolygons)yield e;for(let e of this.polygons)yield e}OrganizeTangents(){for(let e of this.AllObstacles())e!=this.currentPolygon&&this.ProcessPolygonQ(e);this.tangents.sort(Zi.TangentComparison)}ProcessPolygonQ(e){let t=new ds(this.currentPolygon,e);this.useLeftPTangents?t.CalculateLeftTangents():t.CalculateRightTangents();let i=this.useLeftPTangents?t.leftPLeftQ:t.rightPLeftQ,n=new nh(this.currentPolygon.pp(i[0]),e.pp(i[1]));n.IsLow=!0,n.SeparatingPolygons=!this.useLeftPTangents,i=this.useLeftPTangents?t.leftPRightQ:t.rightPRightQ;let o=new nh(this.currentPolygon.pp(i[0]),e.pp(i[1]));o.IsLow=!1,o.SeparatingPolygons=this.useLeftPTangents,n.Comp=o,o.Comp=n,this.tangents.push(n),this.tangents.push(o),this.diagonals.push(new ih(n,o))}};function cy(s,e){return s.FindVertex(e.point)}var eu=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(f.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),i=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*i.y-i.x*t.y)<E.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,i){let n=fi.solve(t.x-e.x,-i.x,this.Pivot.x-e.x,t.y-e.y,-i.y,this.Pivot.y-e.y);if(!(-E.tolerance<=n.x&&n.x<=1+E.tolerance))throw new Error;if(!n)throw new Error;return this.Pivot.add(i.mul(n.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let i=new eu;return i.pivot=e,i.pointOnTheRay=t,i}};var hy=Q(Pt()),fs=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!=this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!=this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return hy.String.Format("Stem({0},{1})",this.Start,this.End)}};var Si=class{constructor(e,t,i,n){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=i,this.qPolylinePoint=dt.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=n;let o=new Tn(this.q);this.heapForSorting=new as(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,i,n){let o=t.FindVertex(i);if(o!=null)return o;let a=new Si(e,t,i,n);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!=0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let i=!1;for(let n of t.Sides()){let o=n;if(o.point.y<this.q.y){if(n.nextOnPolyline.point.y>=this.q.y){let a=f.getTriangleOrientation(this.q,o.point,n.nextOnPolyline.point);if(a==1||a==2){i=!0,yield new fs(t.Start,n),yield new fs(n.nextOnPolyline,t.End),this.RegisterActiveSide(n);break}}}else{if(o.point.y>this.q.y)break;if(n.point.x>=this.q.x){i=!0,yield new fs(n,t.End),n!=t.Start&&(yield new fs(t.Start,e.prev(o))),this.RegisterActiveSide(n);break}}}i||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new f(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=Si.GetIncomingSide(e),i=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let n;if(n=this.sideNodes.get(t)){if(n==this.activeSidesTree.treeMinimum()&&this.AddEdge(e),i!=null)n.item=i,this.sideNodes.set(i,n);else{let o=this.activeSidesTree.deleteSubTree(n);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(i!=null){let o;(o=this.sideNodes.get(i))||(o=this.activeSidesTree.insert(i),this.sideNodes.set(i,o),o==this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind==0||this.visibilityKind==1&&Si.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,i)=>new Mt(t,i))}static LineTouchesPolygon(e,t){let i=t.polyline.prev(t).point,n=t.polyline.next(t).point,o=t.point;return f.signedDoubledTriangleArea(e,o,i)*f.signedDoubledTriangleArea(e,o,n)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e==t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new eu,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new Ke(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,i=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))i=!1;let n=e.next(t);if(i)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,n);n=e.next(n));this.visibleBoundaries.set(e,new fs(t,n))}HoleSideIsVisibleFromQ(e,t){return f.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-E.squareOfDistanceEpsilon}};var sh=class{constructor(e,t){this.next=null;this.prev=null;this.PolylinePoint=e,this.OriginalPosition=t}get PolylinePoint(){return this.polylinePoint}set PolylinePoint(e){this.polylinePoint=e}get OriginalPosition(){return this.originalPosition}set OriginalPosition(e){this.originalPosition=e}get Next(){return this.next}set Next(e){this.next=e}get Prev(){return this.prev}set Prev(e){this.prev=e}};var Pe=class extends ae{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=V.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}get Obstacles(){return this.obstacles_}set Obstacles(e){this.obstacles_=e}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(e){this.enteringAngleBound_=e}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(e){this._sourceTightPolyline=e}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(e){this.targetTightPolyline=e}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(e){this.targetLoosePolyline=e}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(e){this.visibilityGraph=e}get SourcePort(){return this.sourcePort}set SourcePort(e){if(this.sourcePort=e,this.sourcePort!=null)if(this.SourceTightPolyline=Pe.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Ur)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let t=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(t.Curve,t.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(e){this.targetPort=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=e)}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(e){this.startPointOfRouting_=e}ExtendVisibilityGraphToLocation(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ie);let t=null;if(!this.activeRectangle.contains(e)){this.activeRectangle.isEmpty?this.activeRectangle=V.mkPP(this.SourcePort.Location,e):this.activeRectangle.add(e),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null||t.length==0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Zi(t,this.activePolygons,this.VisibilityGraph).run(),ji(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(e){this.targetVV=Si.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,e,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=Si.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(e,t,i){let n=e.value(t),o=e.leftDerivative(t).normalize().add(e.rightDerivative(t).normalize()).normalize();f.getTriangleOrientation(Pe.PointInsideOfConvexCurve(e),n,n.add(o))==1&&(o=o.mul(-1)),o=o.rotate(Math.PI/2);let a=i.boundingBox.diagonal,l=O.mkPP(n,n.add(o.mul(a))),u=v.intersectionOne(l,i,!1).x,c=o.mul(u.sub(n).length/2);for(;;){l=O.mkPP(n,u.add(c));let h=!1;for(let d of Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(l,this.ObstacleCalculator.RootOfLooseHierarchy))if(d.seg1!=i){c=c.div(1.5),h=!0;break}if(!h)break}return l.end}static PointInsideOfConvexCurve(e){return e.value(0).add(e.value(1.5)).div(2)}*GetActivePolylines(){for(let e of this.activePolygons)yield e.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let e=this.activeRectangle,t=new Array,i;do{i=!1;for(let n of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(n)||(e.addRec(n.boundingBox),t.push(new It(n)),this.alreadyAddedOrExcludedPolylines.add(n),i=!0);i&&(this.activeRectangle=e)}while(i);return t}RelaxPolyline(){let e=Pe.CreateRelaxedPolylinePoints(this._polyline);for(e=e.Next;e.Next!=null;e=e.Next)this.RelaxPolylinePoint(e)}static CreateRelaxedPolylinePoints(e){let t=e.startPoint,i=new sh(t,t.point),n=i;for(;t.next!=null;){t=t.next;let o=new sh(t,t.point);o.Prev=n,n.Next=o,n=o}return i}RelaxPolylinePoint(e){if(!(e.PolylinePoint.prev.prev==null&&this.SourcePort instanceof Ut&&e.PolylinePoint.polyline!=this.SourceLoosePolyline)&&!(e.PolylinePoint.next.next==null&&this.TargetPort instanceof Ut&&e.PolylinePoint.polyline!=this.TargetLoosePolyline))for(let t=this.OffsetForPolylineRelaxing;t>E.distanceEpsilon&&!this.RelaxWithGivenOffset(t,e);)t/=2}RelaxWithGivenOffset(e,t){return Pe.SetRelaxedPointLocation(e,t),this.StickingSegmentDoesNotIntersectTightObstacles(t)?!0:(Pe.PullCloserRelaxedPoint(t.Prev),!1)}static PullCloserRelaxedPoint(e){e.PolylinePoint.point=e.OriginalPosition.mul(.2).add(e.PolylinePoint.point.mul(.8))}StickingSegmentDoesNotIntersectTightObstacles(e){return!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Prev.PolylinePoint.point)&&(e.Next==null||!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Next.PolylinePoint.point))}PolylineSegmentIntersectsTightHierarchy(e,t){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,i){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(O.mkPP(e,t),i)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t){if(!e.boundingBox.intersects(t.irect))return!1;if(t.UserData!=null){for(let i of v.getAllIntersections(e,t.UserData,!1))if(i.seg1!=this.SourceTightPolyline&&i.seg1!=this.TargetTightPolyline||(i.seg1==this.SourceTightPolyline&&this.SourcePort)instanceof Ut||(i.seg1==this.TargetTightPolyline&&this.TargetPort)instanceof Ut)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,t){let i=new Array;return Pe.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i),i}static IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,i){if(t!=null&&!!e.boundingBox.intersects(t.irect)){if(t.UserData!=null){ji(i,v.getAllIntersections(e,t.UserData,!0));return}Pe.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Left,i),Pe.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Right,i)}}LineCanBeAcceptedForRouting(e){let t=this.SourcePort instanceof Ur,i=this.TargetPort instanceof Ur;if(!t&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.end,this.SourcePort)||!i&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.start,this.TargetPort))return!1;let n=Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy);for(let o of n)if(o.seg1!=this.SourceTightPolyline&&o.seg1!=this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(e,t){let i=t.Curve,n=wt.CurveIsClockwise(i,Pe.PointInsideOfConvexCurve(i)),o=t.Location,a=this.GetPointOnTheRightBoundaryPortConeSide(o,i,n,t.Parameter),l=this.GetPointOnTheLeftBoundaryPortConeSide(o,i,n,t.Parameter);return f.getTriangleOrientation(o,a,e)!=0&&f.getTriangleOrientation(o,e,l)!=0}GetPointOnTheRightBoundaryPortConeSide(e,t,i,n){let o=i?t.rightDerivative(n):t.leftDerivative(n).neg();return e.add(o.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(e,t,i,n){let o=i?t.leftDerivative(n).neg():t.rightDerivative(n);return e.add(o.rotate(-this.EnteringAngleBound))}static SetRelaxedPointLocation(e,t){let i=f.getTriangleOrientation(t.Next.OriginalPosition,t.OriginalPosition,t.Prev.OriginalPosition)==1,n=t.Next.OriginalPosition.sub(t.Prev.OriginalPosition).normalize().mul(e).rotate(Math.PI/2);i||(n=n.neg()),t.PolylinePoint.point=t.OriginalPosition.add(n)}SmoothCorners(e){let t=e.headSite,i={b:null,c:null};for(;i=v.findCorner(t);)t=this.SmoothOneCorner(t,i.c,i.b)}SmoothOneCorner(e,t,i){let a=.5,l,u,c;e.prev==null?(c=2,u=1):t.next==null?(c=1,u=2):u=1,c=1;do l=v.createBezierSeg(a*c,a*u,e,i,t),i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u,a/=1.5;while(this.ObstacleCalculator.ObstaclesIntersectICurve(l)&&a>.01);return a*=1.5,a<.5&&a>.01&&(a=.5*(a+a*1.5),l=v.createBezierSeg(a*c,a*u,e,i,t),this.ObstacleCalculator.ObstaclesIntersectICurve(l)||(i.previouisBezierCoefficient=a*c,i.nextBezierCoefficient=a*u)),i}TryToRemoveInflectionsAndCollinearSegments(e){let t=!0,i={s:null};for(;t;)for(t=!1,i.s=e.headSite;i.s!=null&&i.s.next!=null;i.s=i.s.next)i.s.turn*i.s.next.turn<0&&(t=this.TryToRemoveInflectionEdge(i)||t)}TryToRemoveInflectionEdge(e){if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.point)){let t=e.s.prev,i=e.s.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.next.point)){let t=e.s.prev,i=e.s.next.next;return t.next=i,i.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.point,e.s.next.next.point)){let t=e.s.next.next;return e.s.next=t,t.prev=e.s,!0}return!1}GetShortestPolyline(e,t){this.CleanTheGraphForShortestPath();let n=new Ra(this.visibilityGraph,e,t).GetPath(this.UseEdgeLengthMultiplier);if(n==null)return null;let o=new q;for(let a of n)o.addPoint(a.point);return Pe.RemoveCollinearVertices(o)}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}static RemoveCollinearVertices(e){for(let t=e.startPoint.next;t.next!=null;t=t.next)f.getTriangleOrientation(t.prev.point,t.point,t.next.point)==2&&(t.prev.next=t.next,t.next.prev=t.prev);return e}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(e){this.ObstacleCalculator.RootOfTightHierarchy=e}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(e){this.ObstacleCalculator.RootOfLooseHierarchy=e}CalculateObstacles(){this.ObstacleCalculator=new wt(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}RouteEdgeToLocation(e){this.TargetPort=new Ur(null,e),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let t=new Re(null),i=O.mkPP(this.SourcePort.Location,e);return this.LineCanBeAcceptedForRouting(i)?(this._polyline=new q,this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=Ze.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):this.SourcePort instanceof Ut&&(i=O.mkPP(this.StartPointOfEdgeRouting,e),Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(i,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new q,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(i.start),this._polyline.addPoint(i.end),t.smoothedPolyline=Ze.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):(this.ExtendVisibilityGraphToLocation(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this.SourcePort instanceof Ut&&this._polyline.PrependPoint(this.SourcePort.Location),t.smoothedPolyline=Ze.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t)}RouteEdgeToPort(e,t,i,n){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),O.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=e,this.TargetTightPolyline=Pe.GetFirstHitPolyline(e.Location,this.ObstacleCalculator.RootOfTightHierarchy),e instanceof Ut?this.RouteEdgeToBoundaryPort(t,i,n):this.RouteEdgeToFloatingPortOfNode(t,i,n))}SmoothedPolylineFromTwoPoints(e,t){return this._polyline=new q,this._polyline.addPoint(e),this._polyline.addPoint(t),Ze.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(e,t,i){return this.sourcePort instanceof Ur?this.RouteFromFloatingPortToFloatingPort(e,t,i):this.RouteFromBoundaryPortToFloatingPort(e,t,i)}RouteFromBoundaryPortToFloatingPort(e,t,i){let n=this.SourcePort.Location,o=this.targetPort.Location,a=O.mkPP(n,o);if(this.LineCanBeAcceptedForRouting(a))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a;if(!this.targetIsInsideOfSourceTightPolyline){let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(a=O.mkPP(u,o),this.LineAvoidsTightHierarchyLP(a,e))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let l=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=l,this.RelaxPolyline(),this._polyline.PrependPoint(n),this.SmoothCornersAndReturnCurve(t,i)}SmoothCornersAndReturnCurve(e,t){return t.smoothedPolyline=Ze.mkFromPoints(this._polyline),e&&this.SmoothCorners(t.smoothedPolyline),t.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(e,t,i){let n=this.TargetPort.Location,o=O.mkPP(this.StartPointOfEdgeRouting,n);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(o,this.SourceTightPolyline,this.targetTightPolyline)?(i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),i.smoothedPolyline=Ze.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(t,i)))}TryShortcutPolyline(){if(this.UseInnerPolylingShortcutting)for(;this.ShortcutPolylineOneTime(););this.UsePolylineEndShortcutting&&this.TryShortCutThePolylineEnds()}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let e=this._polyline.endPoint,t=e.prev;if(t==null)return;let i=t.prev;if(i==null)return;let n=f.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=dt.mkFromPoint(n);o.next=e,o.prev=i,e.prev=o,i.next=o}}TryShortcutPolylineStart(){let e=this._polyline.startPoint,t=e.next;if(t==null)return;let i=t.next;if(i==null)return;let n=f.middle(t.point,i.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,n,this._sourceTightPolyline,this.targetTightPolyline)){let o=dt.mkFromPoint(n);o.prev=e,o.next=i,e.next=o,i.prev=o}}ShortcutPolylineOneTime(){let e=!1;for(let t=this._polyline.startPoint;t.next!=null&&t.next.next!=null;t=t.next)e=e||this.TryShortcutPolyPoint(t);return e}TryShortcutPolyPoint(e){return this.LineAvoidsTightHierarchyLPP(O.mkPP(e.point,e.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(e.next=e.next.next,e.next.prev=e,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ie);let t=null,i=this.targetPort.Location;if(!this.activeRectangle.contains(i)){this.activeRectangle.isEmpty?this.activeRectangle=V.mkPP(this.SourcePort.Location,i):this.activeRectangle.add(i),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new Zi(t,this.activePolygons,this.VisibilityGraph).run(),ji(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(i,e),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(e,t){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(e,t):this.targetVV=Si.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(t),this.VisibilityGraph,e,1)}AddTransientVisibilityEdgesForPort(e,t){let i=this.GetVertex(e);if(i!=null)return i;if(i=this.visibilityGraph.AddVertexP(e),t!=null)for(let n of t)this.visibilityGraph.AddEdgeF(e,n,(o,a)=>new Mt(o,a));else i=Si.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,e,1);return i}GetVertex(e){let t=this.visibilityGraph.FindVertex(e);return t==null&&this.LookForRoundedVertices&&(t=this.visibilityGraph.FindVertex(E.RoundPoint(e))),t}*GetActivePolylinesWithException(e){for(let t of this.activePolygons)t.Polyline!=e&&(yield t.Polyline)}RouteEdgeToBoundaryPort(e,t,i){return this.TargetLoosePolyline=e,this.sourcePort instanceof Ur?this.RouteFromFloatingPortToBoundaryPort(t,i):this.RouteFromBoundaryPortToBoundaryPort(t,i)}RouteFromBoundaryPortToBoundaryPort(e,t){let i=this.SourcePort.Location,n,o=this.targetPort.Location,a=O.mkPP(i,o);if(this.LineCanBeAcceptedForRouting(a))this._polyline=new q,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),n=Ze.mkFromPoints(this._polyline).createCurve();else{let l=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(a=O.mkPP(i,l),this.InsideOfTheAllowedConeOfBoundaryPort(l,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(a,this._sourceTightPolyline))this._polyline=new q,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(a=O.mkPP(this.StartPointOfEdgeRouting,o),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(a))this._polyline=new q,this._polyline.addPoint(i),this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),n=this.SmoothCornersAndReturnCurve(e,t);else{let u;if(u=O.IntersectPPPP(i,this.StartPointOfEdgeRouting,o,l))this._polyline=new q,this._polyline.addPoint(i),this._polyline.addPoint(u),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(f.closeDistEps(this.StartPointOfEdgeRouting,l))this._polyline=new q,this._polyline.addPoint(i),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else if(this.LineAvoidsTightHierarchy(O.mkPP(this.StartPointOfEdgeRouting,l)))this._polyline=new q,this._polyline.addPoint(i),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(l),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t);else{this.ExtendVisibilityGraphToTargetBoundaryPort(l),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let c={tmpTargetTight:null},h=this.HideSourceTargetTightsIfNeeded(c);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(h,c.tmpTargetTight),this.RelaxPolyline(),this._polyline.PrependPoint(i),this._polyline.addPoint(o),n=this.SmoothCornersAndReturnCurve(e,t)}}}return n}RecoverSourceTargetTights(e,t){this.SourceTightPolyline=e,this.TargetTightPolyline=t}HideSourceTargetTightsIfNeeded(e){let t=this.SourceTightPolyline;return e.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,t}LineAvoidsTightHierarchy(e){return Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy).length==0}RouteFromFloatingPortToBoundaryPort(e,t){let i=this.targetPort.Location,n;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(n=O.mkPP(this.SourcePort.Location,i),this.LineCanBeAcceptedForRouting(n)))return t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(n.start,n.end),n;let o=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(n=O.mkPP(this.SourcePort.Location,o),this.LineAvoidsTightHierarchyLP(n,this._sourceTightPolyline))return this._polyline=q.mkFromPoints([n.start,n.end,i]),t.smoothedPolyline=Ze.mkFromPoints(this._polyline),t.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(o),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this._polyline.addPoint(i);let a={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(e,a)}LineAvoidsTightHierarchyLP(e,t){let i=!0;for(let n of Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(n.seg1!=t){i=!1;break}return i}LineAvoidsTightHierarchyLPP(e,t,i){let n=!0;for(let o of Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(!(o.seg1==t||o.seg1==i)){n=!1;break}return n}LineAvoidsTightHierarchyPPPP(e,t,i,n){return this.LineAvoidsTightHierarchyLPP(O.mkPP(e,t),i,n)}ExtendVisibilityGraphToTargetBoundaryPort(e){let t=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new Ie),!this.activeRectangle.contains(e)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(e)):(this.activeRectangle.add(e),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Zi(t,this.activePolygons,this.VisibilityGraph).run(),ji(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(e){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:Pe.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(e,t){let i=Pe.GetFirstHitRectangleNode(e,t);return i?i.UserData:null}static GetFirstHitRectangleNode(e,t){return t==null?null:t.FirstHitNodePF(e,(i,n)=>v.PointRelativeToCurveLocation(i,n)!=0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(e,t){this.SourceLoosePolyline=t,this.sourcePort=e,this.sourcePort!=null&&(this.SourceTightPolyline=Pe.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Ur?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new Ie,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let t of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(t);let e;this.UseSpanner?e=new ho(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):e=new Zi(new Array,this.activePolygons,this.visibilityGraph),e.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e,t,i,n){let o=e instanceof Ur&&t instanceof Ut||e instanceof ut;if(o){let l=e;e=t,t=l}this.sourcePort=e,this.targetPort=t,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let a=this.GetEdgeGeomByRouting(i,n);return a==null?null:(this.targetVV=null,this.sourceVV=null,o&&(a=a.reverse()),a)}GetEdgeGeomByRouting(e,t){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||v.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)==2;let i;if(this.sourcePort instanceof Ut){let n=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?n.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(n.Curve,n.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let o={smoothedPolyline:null};this.targetPort instanceof Ut?i=this.RouteFromBoundaryPortToBoundaryPort(e,o):i=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,e,o)}else this.targetPort instanceof Ur?(this.ExtendVisibilityGraphFromFloatingSourcePort(),i=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,e,t)):($n.assert(this.targetPort instanceof ut),i=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,e,t,this.targetPort));return i}RouteFromFloatingPortToAnywherePort(e,t,i,n){return n.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(e))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),this.FixLastPolylinePointForAnywherePort(n),n.HookSize>0&&this.BuildHook(n),this.SmoothCornersAndReturnCurve(t,i))):(i.smoothedPolyline=null,null)}BuildHook(e){let t=e.Curve,i=re.mkFullEllipseNNP(e.HookSize,e.HookSize,this._polyline.end),n=v.getAllIntersections(t,i,!0);f.getTriangleOrientation(n[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&n.reverse();let o=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),a=t.derivative(n[0].par0).normalize(),l=a.dot(o);if(Math.abs(l)<.2)this.ExtendPolyline(a,n[0],o,e);else{let u=t.derivative(n[1].par0).normalize();u.dot(o)<l?this.ExtendPolyline(u,n[1],o,e):this.ExtendPolyline(a,n[0],o,e)}}ExtendPolyline(e,t,i,n){let o=e.rotate(Math.PI/2);o.dot(i)<0&&(o=o.neg());let a=t.x.add(o.mul(n.HookSize)),l;!(l=f.lineLineIntersection(a,a.add(e),this._polyline.end,this._polyline.end.add(i)))||(this._polyline.addPoint(l),this._polyline.addPoint(a),this._polyline.addPoint(t.x))}FixLastPolylinePointForAnywherePort(e){for(;;){let t=this.GetLastPointInsideOfCurveOnPolyline(e.Curve);t.next.next=null,this._polyline.endPoint=t.next;let i=t.next.point.sub(t.point);i=i.normalize().mul(e.Curve.boundingBox.diagonal);let n=i.rotate(e.AdjustmentAngle*-1),o=i.rotate(e.AdjustmentAngle),a=v.intersectionOne(e.Curve,O.mkPP(t.point,t.point.add(n)),!0),l=v.intersectionOne(e.Curve,O.mkPP(t.point,t.point.add(o)),!0);if(a==null||l==null)return;let u=Pe.GetTrimmedCurveForHookingUpAnywhere(e.Curve,t,a,l),c=u.value(u.closestParameter(t.point));if(!this.LineAvoidsTightHierarchyLPP(O.mkPP(t.point,c),this.SourceTightPolyline,null)){let h=v.intersectionOne(e.Curve,O.mkPP(t.point,t.next.point),!1);if(h==null)return;this._polyline.endPoint.point=h.x;break}if(this._polyline.endPoint.point=c,t.prev==null||!this.TryShortcutPolyPoint(t.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(e,t,i,n){let o=f.getTriangleOrientation(n.x,i.x,t.point)==0,a=i.par0,l=n.par0,u,c,h;return o?a<l?e.trim(a,l):(c=e.trim(a,e.parEnd),u=e.trim(e.parStart,l),h=new v,h.addSegs([c,u])):l<a?e.trim(l,a):(c=e.trim(l,e.parEnd),u=e.trim(e.parStart,a),h=new v,h.addSegs([c,u]))}GetLastPointInsideOfCurveOnPolyline(e){for(let t=this._polyline.endPoint.prev;t!=null;t=t.prev)if(t.prev==null||v.PointRelativeToCurveLocation(t.point,e)==2)return t;throw new Error}GetShortestPolylineToMulitpleTargets(e,t){this.CleanTheGraphForShortestPath();let n=new fo(e,t,this.VisibilityGraph).GetPath();if(n==null)return null;let o=new q;for(let a of n)o.addPoint(a.point);return Pe.RemoveCollinearVertices(o)}Targets(e){return Array.from(e).map(t=>this.visibilityGraph.FindVertex(t))}ExtendVisibilityGraphFromFloatingSourcePort(){let e=this.sourcePort;this.StartPointOfEdgeRouting=e.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=Si.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(t=>t!=this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let e=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=Pe.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=Pe.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),e=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=Pe.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=Pe.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=V.mkPP(new f(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new f(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let e of this.ObstacleCalculator.LooseObstacles)yield new It(e)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(e){ji(this.activePolygons,e)}ClearActivePolygons(){this.activePolygons=[]}};var LS=Q(Xn());var Ki=class{constructor(){this.size_=0;this.mapOfMaps=new je}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let i=e.first,n=e.second,o=this.mapOfMaps.get(i);o==null&&this.mapOfMaps.set(i,o=new je),o.has(n)||this.size_++,o.set(n,t)}delete(e){let t=e.first,i=e.second,n=this.mapOfMaps.get(t);n!=null&&n.deleteP(i)&&this.size_--}has(e){let t=this.mapOfMaps.get(e.first);return t!=null&&t.has(e.second)}get_(e,t){return this.get(new ot(e,t))}get(e){let t=this.mapOfMaps.get(e.first);if(t!=null)return t.get(e.second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new ot(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[i,n]of t)yield[new ot(e,i),n]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var rr=class{static GetShapes(e,t=Array.from(e.edges())){let i=new Map;dy(e,i);for(let n of t){let o=i.get(n.source);o&&n.sourcePort!=null&&o.Ports.add(n.sourcePort),o=i.get(n.target),o&&n.targetPort!=null&&o.Ports.add(n.targetPort)}return Array.from(i.values())}static CreateShapeWithCenterPort(e){let t=new wa(()=>e.boundaryCurve),i=zr.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);for(let n of e.inEdges())rr.FixPortAtTarget(i,n);for(let n of e.outEdges())rr.FixPortAtSource(i,n);for(let n of e.selfEdges())rr.FixPortAtSource(i,n),rr.FixPortAtTarget(i,n);return t}static CreateShapeWithClusterBoundaryPort(e){$n.assert(e instanceof ze);let t=new wa(()=>e.boundaryCurve),i=kt.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);let n;for(let o of e.inEdges())o.EdgeToAncestor()==2?(n==null&&(n=new ut(()=>e.boundaryCurve)),o.targetPort=n):rr.FixPortAtTarget(i,o);for(let o of e.outEdges())o.EdgeToAncestor()==1?(n==null&&(n=new ut(()=>e.boundaryCurve)),o.sourcePort=n):rr.FixPortAtSource(i,o);for(let o of e.selfEdges())rr.FixPortAtSource(i,o),rr.FixPortAtTarget(i,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function dy(s,e){for(let t of s.shallowNodes())if(t instanceof ze){let i=rr.CreateShapeWithClusterBoundaryPort(t);e.set(t,i);let n=t;if(!n.graph.isCollapsed){dy(n,e);for(let o of n.shallowNodes())i.AddChild(e.get(o))}}else e.set(t,rr.CreateShapeWithCenterPort(t))}var jg=Q(ei()),py=Q(Pt());var fy=Q(Pt());var go=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,i,n){let o=new go(e);return o.Left=e,o.Right=t,o.Gap=i,o.IsEquality=n,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return fy.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t==0&&(t=this.Right.CompareTo(e.Right)),t==0&&(t=ue(this.Gap,e.Gap)),t}};var gy=Q(Pt()),gs=class{static constructorDCVV(e,t,i,n){let o=new gs(t);return o.Set(e,t,i,n),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,i,n){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=i,this.VariableDoneEval=n,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval==this.ConstraintToEval.Right}toString(){return gy.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var my=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Oa=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return py.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new jg.Stack;let t=new go(e);this.dfDvDummyParentNode=new gs(t);let i=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(i);;){let n=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!n.ChildrenHaveBeenPushed){n.ChildrenHaveBeenPushed=!0;for(let a of n.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!=n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Right,n.VariableToEval);a.Right.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of n.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!=n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Left,n.VariableToEval);a.Left.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(n),n==i)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,i,n){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,i,n):gs.constructorDCVV(e,t,i,n);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable==e.VariableToEval){for(;e.Parent!=this.dfDvDummyParentNode;)this.constraintPath.push(new my(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let i=new Array;this.GetConnectedVariables(i,e.Right,e.Left);let n=e.Violation,o=i.length;for(let a=0;a<o;a++)i[a].OffsetInBlock=i[a].OffsetInBlock+n;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let i=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,n=this.Variables.length;for(let o=0;o<n;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<i&&(t=a,i=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Oa(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length==1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,i=e.OffsetInBlock/e.Scale,n=t*e.Weight;this.sumAd=this.sumAd+n*e.DesiredPos,this.sumAb=this.sumAb+n*i,this.sumA2=this.sumA2+n*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let i=0;i<t;i++){let n=this.Variables[i];n.ActualPos=(e+n.OffsetInBlock)/n.Scale}}GetConnectedVariables(e,t,i){this.RecurseGetConnectedVariables(e,t,i)}RecurseGetConnectedVariables(e,t,i){this.allConstraints.DfDvStack=new jg.Stack;let n=new go(t);for(this.dfDvDummyParentNode=new gs(n),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,n,t,i)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!=o.VariableDoneEval&&(l.Right.ActiveConstraintCount==1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!=o.VariableDoneEval&&(l.Left.ActiveConstraintCount==1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,i){this.GetConnectedVariables(e.Variables,t,i);let n=e.Variables.length;for(let a=0;a<n;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block==e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length==0){for(let a=0;a<n;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var qg=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var Xg=Q(ei()),Yg=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new Xg.Stack;this.DfDvRecycleStack=new Xg.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var tu=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new ah}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new tu;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},ah=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new ah;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var by=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},Py=class{constructor(e,t){this.Value=e,this.Column=t}},br=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!=0&&(this.newMatrixRow.push(new Py(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new by(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let i of this.matrixQ[t.Ordinal])i.Column==t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(i.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let i=0;i<t.length;i++)t[i].Column==e?t[i].Value=1:t[i].Value=t[i].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[i].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;br.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=br.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!=0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=br.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t==0)return!1;let i=e/t;br.VectorCopy(this.vectorPrevY,this.vectorCurY),br.VectorScaledVectorSubtract(this.vectorPrevY,i,this.gradientVector,this.vectorCurY);for(let n=0;n<this.vectorCurY.length;n++)this.vectorQpscVars[n].Variable.DesiredPos=this.vectorCurY[n];return!0}PostProject(){for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;br.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=br.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!=0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let i=br.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=i==0?1:e/i,t>1?t=1:t<0&&(t=0)}return br.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let i=this.previousFunctionValue-e,n=0;if(i!=0){let o=this.previousFunctionValue!=0?this.previousFunctionValue:e;n=Math.abs(i/o)}(Math.abs(i)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(n)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return br.VectorVectorMultiply(this.gradientVector,e)/2+br.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let i=0;for(let n=0;n<e.length;n++)i=i+e[n]*t[n];return i}MatrixVectorMultiply(e,t){let i=0;for(let n of this.matrixQ){let o=0;for(let a of n)o=o+a.Value*e[a.Column];t[i++]=o}}static VectorVectorAdd(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]+t[n]}static VectorVectorSubtract(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]-t[n]}static VectorScaledVectorSubtract(e,t,i,n){for(let o=0;o<e.length;o++)n[o]=e[o]-t*i[o]}static VectorCopy(e,t){for(let i=0;i<t.length;i++)e[i]=t[i]}};var Ba=class{get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Ba;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var yy=Q(Pt());var Sy=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},$g=class{constructor(e,t,i,n,o){this.ActiveConstraintCount=0;if(n<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=i*n;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=i*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=i,this.Weight=n,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new Sy(e,t))}toString(){return yy.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return ue(this.Ordinal,e.Ordinal)}};var uh=class{get IsFull(){return this.numConstraints==uh.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(uh.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let i=this.numConstraints-1;i>=0;i--){let n=this.constraints[i];if(n.Left.Block==e||n.Right.Block==e||n.IsActive||n.IsUnsatisfiable)i<this.numConstraints-1&&(this.constraints[i]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints==0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let i=0;i<this.numConstraints;i++){let n=this.constraints[i],o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o>e&&(e=o,t=n)}return t}Insert(e,t){let i=0,n=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<n?(o=n,i=a,n=u):u<o&&(o=u)}this.IsFull?(this.constraints[i]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=n))}},lh=uh;lh.MaxConstraints=20;var Qg=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},Zg=class{constructor(){this.allBlocks=new qg;this.allConstraints=new Yg;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new lh;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new tu;this.solverSolution=new Ba}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,i){return this.AddVariableANNN(e,t,i,1)}AddVariableANNN(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new $g(this.nextVariableOrdinal++,e,t,i,n),a=new Oa(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new Qg(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return qi(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let i=t.Constraints.length;for(let n=0;n<i;n++){let o=t.Constraints[n];if(e==o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!0)}AddConstraintVVNB(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e==t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=go.constructorVVNB(e,t,i,n);return this.loadedVariablesAndConstraintLists.set(e,new Qg(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,n&&this.equalityConstraints.push(l),l}AddConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!1)}SetConstraintUpdate(e,t){t!=e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,i){if(i<=0||Number.isNaN(i)||!Number.isFinite(i))throw new Error("relationshipWeight");if(e==t)throw new Error;e.AddNeighbor(t,i),t.AddNeighbor(e,i),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.log2(this.numberOfVariables)+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.log2(this.numberOfConstraints)+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Ba,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints==0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length==0)return;let e=this.IsQpsc;for(let[t,i]of this.updatedConstraints){let n=t;if(n.UpdateGap(i),!e&&!n.IsEquality){this.SplitOnConstraintIfActive(n);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),i=t.Constraints,n=0,o=0,a=0;i!=null&&(n=i.length,o=t.NumberOfLeftConstraints,a=n-o);let l=this.emptyConstraintList;o!=0&&(l=new Array(o));let u=this.emptyConstraintList;a!=0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<n;d++){let p=i[d];e==p.Left?l[c++]=p:u[h++]=p}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){let e;if(!this.RunProject(e))return;if(!this.SplitBlocks())break}}RunProject(e){return this.solverSolution.OuterProjectIterations++,e=this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let i=this.allBlocks.item(t),n=i.Variables.length;for(let o=0;o<n;o++){let a=i.Variables[o];this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue+a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue-2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new br(this.solverParams,this.numberOfVariables);for(let n of this.allBlocks.Vector)for(let o of n.Variables)e.AddVariable(o);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1,i=!1;for(;!(!e.PreProject()&&!t&&!i||(t=this.SplitBlocks(),!this.RunProject(i))||!e.PostProject()&&!t&&!i););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){let e;return this.RunProject(e)}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let i of t.Variables){i.Reinitialize();let n=new Oa(i,this.allConstraints);this.allBlocks.Add(n)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block==e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints==0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,i={maxViolation:0},n=this.GetMaxViolatedConstraint(i,e);if(!n)return!1;for(;n;){if(n.Left.Block==n.Right.Block?(n.Left.Block.Expand(n),n.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=n.Left.Block):this.lastModifiedBlock=this.MergeBlocks(n),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};n=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,i=e.Right.Block,n=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);i.Variables.length>t.Variables.length&&(t=e.Right.Block,i=e.Left.Block,n=n*-1);let o=i.Variables.length;for(let a=0;a<o;a++){let l=i.Variables[a];l.OffsetInBlock=l.OffsetInBlock+n,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(i),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let n=0;n<t;n++){let a=this.allBlocks.item(n).Split(this.IsQpsc);a!=null&&e.push(a)}let i=e.length;for(let n=0;n<i;n++){let o=e[n];this.allBlocks.Add(o)}return e.length!=0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let i=this.SearchViolationCache(e.maxViolation);return i!=null?i:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let i=this.lastModifiedBlock.Variables.length;for(let o=0;o<i;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Nc(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!=this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Nc(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let n=this.violationCache.FindIfGreater(e);return n!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=n),t}SearchAllConstraints(e,t){let i=null;this.violationCache.Clear();for(let n of this.allConstraints.Vector){if(n.IsActive)break;if(n.IsUnsatisfiable)continue;let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale),a=null,l=0;Nc(o,e)&&(e>this.violationCache.LowViolation&&(a=i,l=e),e=o,i=n),t&&(a==null&&n!=i&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=n,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return i}};var hh=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,i){this.variables.set(e,this.solver.AddVariableANN(e,t,i))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,i,n){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,i,n)}AddLeftRightSeparationConstraintNNN(e,t,i){this.AddLeftRightSeparationConstraintNNNB(e,t,i,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,i){let n=this.GetVariable(e);if(n==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(n,o,i)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let i;do{this.solution=null;let n=null;if(e!=null&&(n=e,n==null))throw new Error("parameters");this.solution=this.solver.SolvePar(n),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,i=this.AdjustConstraintsForMovedFixedVars()}while(i&&this.solution.ExecutionLimitExceeded==!1);return this.solution.ExecutionLimitExceeded==!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,i]of this.fixedVars.entries())hh.Close(i,this.GetVariableResolvedPosition(t))||e.add(t);return e.size==0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let i of e){t=i;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let i={successInAdjusting:!1},n=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,i);if(!i.successInAdjusting||n.length==0)return!1;for(let o of n)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let i=this.variables.get(e).Block.Variables,n=new Jt,o=new Jt,a=1;for(let l of i)!this.fixedVars.has(l.UserData)||(n.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,n.length/o.length)));return a==1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(i,a),i.map(l=>l.UserData)}FixActiveConstraints(e,t){let i=!1;for(let n of e)for(let o of n.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(i=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return i}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new Zg,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,hh.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},ch=hh;ch.FixedVarWeight=1e9;var Kg=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var Jg=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new ch;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let i=this.Var(t);i.LowBound=Math.max(e,i.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let i=this.Var(e);i.UpperBound=Math.min(t,i.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!=Number.NEGATIVE_INFINITY&&this.constraints.add(new ee(this.GetBoundId(t.LowBound),e)),t.UpperBound!=Number.POSITIVE_INFINITY&&this.constraints.add(new ee(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!=Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!=Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=Zt(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=Fr.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new ee(e,t))}AddVariableNNNN(e,t,i,n){this.idealPositions.set(e,i),this.AddVariableNNBN(e,t,!1,n)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,i,n){let o=new Kg;o.Position=t,o.IsFixed=i,o.Width=n,this.varList.push(o)}};var Ey=Q(Xn());var ep=class extends Lr{constructor(e,t){super(e,t);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=_.DirectionFromPointToPoint(e.point,t.point)}AddRightNeighbor(e){this.RightNeighbors.add(e)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(e){this.setOfLongestSegs.add(e)}BoundFromRight(e){e=Math.max(e,this.LeftBound),this.RightBound=Math.min(e,this.RightBound)}BoundFromLeft(e){e=Math.min(e,this.RightBound),this.LeftBound=Math.max(e,this.LeftBound)}};var Rr=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,i){for(t--;e<t;t--)this.SetNewNext(i[t])}InsertVertsInReverse(e,t,i){for(e++;e<t;e++)this.SetNewNext(i[e])}SetNewNext(e){let t=new Rr(e),i=this.Next;this.Next=t,t.Next=i}};var Ma=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return $(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return Ma.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?_.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var ir=class{constructor(e){this.pathVisibilityGraph=new Ie;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(n(),e.Width),i=t.next();for(i.done||e.SetFirstEdge(i.value);(i=t.next()).done==!1;)e.AddEdge(i.value);function*n(){if(e.PathPoints instanceof Rr)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let i=e.next(),n=i.value;for(;!(i=e.next()).done;)yield this.CreatePathEdge(n,i.value,t),n=i.value}CreatePathEdge(e,t,i){switch(_.DirectionFromPointToPoint(e,t)){case 2:case 1:return new Ma(this.GetAxisEdge(e,t),i);case 4:case 8:{let o=new Ma(this.GetAxisEdge(t,e),i);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(i,n)=>new ep(i,n))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of ir.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(ir.CompareTwoPathEdges);let i=0;for(let n of t)n.Index=i++}static CompareTwoPathEdges(e,t){if(e==t)return 0;let i=ir.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return i!=0?i:-ir.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,_.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,i,n){for(;;){if(e=ir.GetNextPathEdgeInDirection(e,i,n),e==null||(t=ir.GetNextPathEdgeInDirection(t,i,n),t==null))return 0;if(e.AxisEdge==t.AxisEdge){n=ir.FindContinuedDirection(i,n,e.AxisEdge),i=e.AxisEdge;let c=ir.GetExistingOrder(e,t);if(c==ir.NotOrdered)continue;return n==i.Direction?c:-c}let o=n==i.Direction?i.Target:i.Source,a=ir.OtherVertex(e.AxisEdge,o),l=ir.OtherVertex(t.AxisEdge,o),u=ir.ProjectionForCompare(i,n!=i.Direction);return ue(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,i){return e.Direction==t?i.Source==e.Target?i.Direction:_.OppositeDir(i.Direction):i.Source==e.Source?i.Direction:_.OppositeDir(i.Direction)}static OtherVertex(e,t){return e.Source==t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction==1?t?i=>-i.x:i=>i.x:t?i=>i.y:i=>-i.y}static GetNextPathEdgeInDirection(e,t,i){return t.Direction==i?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let i=e.Index;if(i==-1)return ir.NotOrdered;let n=t.Index;return ue(i,n)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,i){for(let n of i.Vertices()){let o=n.InEdgesLength();t.set(n,o),o==0&&e.enqueue(n)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new Ey.Queue,i=new Map;for(ir.InitQueueOfSources(t,i,e);t.length>0;){let n=t.dequeue();for(let o of n.OutEdges){let a=i.get(o.Target);i.set(o.Target,a-1),a==1&&t.enqueue(o.Target),yield o}}}},dh=ir;dh.NotOrdered=Number.MAX_VALUE;var tp=class extends Tt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var fh=class extends Tt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var rp=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size==0}};var po=class extends Ql{constructor(e,t,i,n,o){super(t,new _(e).ToPoint());this.DirectionPerp=new _(e).Right.ToPoint(),this.PathOrders=n,this.xProjection=e==1?a=>a.x:a=>-a.y,this.edgeContainersTree=new Ke((a,l)=>this.CompareAA(a,l)),this.SweepPole=_.VectorDirection(this.SweepDirection),this.AxisEdges=o,this.AxisEdgesToObstaclesTheyOriginatedFrom=i}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(e){e instanceof Hr?this.ProcessVertexEvent(e):(this.Z=this.GetZP(e.Site),e instanceof fh?this.ProcessLowEdgeEvent(e):this.ProcessHighEdgeEvent(e))}ProcessHighEdgeEvent(e){let t=e.AxisEdge;this.RemoveEdge(t),this.ConstraintEdgeWithObstaclesAtZ(t,t.Target.point)}ProcessLowEdgeEvent(e){let t=e.AxisEdge,i=this.GetOrCreateAxisEdgesContainer(t);i.item.AddEdge(t);let n=this.edgeContainersTree.previous(i);if(n!=null)for(let a of n.item.edges)for(let l of i.item.edges)this.TryToAddRightNeighbor(a,l);let o=this.edgeContainersTree.next(i);if(o!=null)for(let a of i.item.Edges)for(let l of o.item.edges)this.TryToAddRightNeighbor(a,l);this.ConstraintEdgeWithObstaclesAtZ(t,t.Source.point)}TryToAddRightNeighbor(e,t){this.ProjectionsOfEdgesOverlap(e,t)&&e.AddRightNeighbor(t)}ProjectionsOfEdgesOverlap(e,t){return this.SweepPole==1?!(e.TargetPoint.y<t.SourcePoint.y-E.distanceEpsilon||t.TargetPoint.y<e.SourcePoint.y-E.distanceEpsilon):!(e.TargetPoint.x<t.SourcePoint.x-E.distanceEpsilon||t.TargetPoint.x<e.SourcePoint.x-E.distanceEpsilon)}GetObstacleBoundaries(e){return this.Obstacles.map(t=>Z.mkDebugCurveWCI(1,e,t))}ConstraintEdgeWithObstaclesAtZ(e,t){this.ConstraintEdgeWithObstaclesAtZFromLeft(e,t),this.ConstraintEdgeWithObstaclesAtZFromRight(e,t)}ConstraintEdgeWithObstaclesAtZFromRight(e,t){let i=this.GetActiveSideFromRight(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromRight(n.dot(this.DirectionPerp))}GetActiveSideFromRight(e){return this.LeftObstacleSideTree.findFirst(t=>po.PointToTheLeftOfLineOrOnLineLocal(e,t.Start,t.End))}ConstraintEdgeWithObstaclesAtZFromLeft(e,t){let i=this.GetActiveSideFromLeft(t);if(i==null||this.NotRestricting(e,i.item.Polyline))return;let n=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(i.item);e.BoundFromLeft(n.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(e,t,i){return f.signedDoubledTriangleArea(e,t,i)>-po.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(e,t,i){return f.signedDoubledTriangleArea(t,i,e)<po.AreaComparisonEpsilon}GetActiveSideFromLeft(e){return this.RightObstacleSideTree.findLast(t=>po.PointToTheRightOfLineOrOnLineLocal(e,t.Start,t.End))}static EdgeMidPoint(e){return f.middle(e.SourcePoint,e.TargetPoint)}GetOrCreateAxisEdgesContainer(e){let t=e.Source.point,i=this.GetAxisEdgesContainerNode(t);return i!=null?i:this.edgeContainersTree.insert(new rp(t))}GetAxisEdgesContainerNode(e){let t=this.xProjection(e),i=this.edgeContainersTree.findFirst(n=>this.xProjection(n.Source)>=t-E.distanceEpsilon/2);return i!=null&&this.xProjection(i.item.Source)<=t+E.distanceEpsilon/2?i:null}ProcessVertexEvent(e){this.Z=this.GetZS(e),e instanceof $i?this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline):e instanceof Qi?this.ProcessRightVertex(e,e.Vertex.prevOnPolyline):(this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline),this.ProcessRightVertex(e,e.Vertex.prevOnPolyline))}ProcessRightVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForRightVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=E.distanceEpsilon?o>0&&a>=0?this.EnqueueEvent(new Qi(t)):this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex):(this.InsertRightSide(new vn(e.Vertex)),this.EnqueueEvent(new Qi(t)),this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex))}RestrictEdgeContainerToTheRightOfEvent(e){let t=e.point,i=this.xProjection(t),n=this.edgeContainersTree.findFirst(o=>i<=this.xProjection(o.Source));if(n!=null)for(let o of n.item.Edges)this.NotRestricting(o,e.polyline)||o.BoundFromLeft(this.DirectionPerp.dot(t))}NotRestricting(e,t){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(e)==t}ProcessPrevSegmentForRightVertex(e,t){let i=e.Vertex.nextOnPolyline.point;t.sub(i).dot(this.SweepDirection)>E.distanceEpsilon&&this.RemoveRightSide(new vn(e.Vertex.nextOnPolyline))}RemoveEdge(e){let t=this.GetAxisEdgesContainerNode(e.Source.point);t.item.RemoveAxis(e),t.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(t)}ProcessLeftVertex(e,t){let i=e.Site;this.ProcessPrevSegmentForLeftVertex(e,i);let n=t.point.sub(e.Site),o=n.dot(this.DirectionPerp),a=n.dot(this.SweepDirection);a<=E.distanceEpsilon?o<0&&a>=0&&this.EnqueueEvent(new $i(t)):(this.InsertLeftSide(new An(e.Vertex)),this.EnqueueEvent(new $i(t))),this.RestrictEdgeFromTheLeftOfEvent(e.Vertex)}RestrictEdgeFromTheLeftOfEvent(e){let t=e.point,i=this.GetContainerNodeToTheLeftOfEvent(t);if(i!=null)for(let n of i.item.Edges)this.NotRestricting(n,e.polyline)||n.BoundFromRight(t.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(e){let t=this.xProjection(e);return this.edgeContainersTree.findLast(i=>this.xProjection(i.Source)<=t)}ProcessPrevSegmentForLeftVertex(e,t){let i=e.Vertex.prevOnPolyline.point;t.sub(i).dot(this.SweepDirection)>E.distanceEpsilon&&this.RemoveLeftSide(new An(e.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let e of this.AxisEdges)this.EnqueueEventsForEdge(e)}EnqueueEventsForEdge(e){this.EdgeIsParallelToSweepDir(e)&&(this.EnqueueEvent(po.EdgeLowPointEvent(e,e.Source.point)),this.EnqueueEvent(po.EdgeHighPointEvent(e,e.Target.point)))}EdgeIsParallelToSweepDir(e){return e.Direction==this.SweepPole||e.Direction==_.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(e,t){return new tp(e,t)}static EdgeLowPointEvent(e,t){return new fh(e,t)}CompareAA(e,t){return ue(e.Source.dot(this.DirectionPerp),t.Source.dot(this.DirectionPerp))}},gh=po;gh.AreaComparisonEpsilon=E.intersectionEpsilon;var ip=class extends cs{constructor(e){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=e}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(e){if(this.Edges.length==0){let t=_.VectorDirectionPP(e.Source,e.Target);switch(t){case 4:t=1;break;case 8:t=2;break}this.CompassDirection=t,this.start=e.Source,this.end=e.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(e.Source),this.TryPointForStartAndEndNorth(e.Target);break;case 2:this.TryPointForStartAndEndEast(e.Source),this.TryPointForStartAndEndEast(e.Target);break}this.Edges.push(e)}TryPointForStartAndEndNorth(e){e.y<this.start.y?this.start=e:e.y>this.end.y&&(this.end=e)}TryPointForStartAndEndEast(e){e.x<this.start.x?this.start=e:e.x>this.end.x&&(this.end=e)}get IsFixed(){return this._isFixed}set IsFixed(e){this._isFixed=e}get Width(){let e=0;for(let t of this.edges)e=Math.max(e,t.Width);return e}GetLeftBound(){if(!this.IsFixed){let e=Number.NEGATIVE_INFINITY;for(let t of this.edges)e=Math.max(e,t.AxisEdge.LeftBound);return e}return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let e=Number.POSITIVE_INFINITY;for(let t of this.edges)e=Math.min(e,t.AxisEdge.RightBound);return e}return this.Position()}Position(){return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var ti=class{constructor(e,t){this.tree=new Ke((e,t)=>ue(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length==0||this.HorizontalPoints.length==0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){$(e.Next.Point.x,e.Point.x)?t==ti.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,i,n,o=e.Y;if(e.Point.x<e.Next.Point.x?(i=e.Point.x,t=e.Next.Point.x,n=!0):(t=e.Point.x,i=e.Next.Point.x,n=!1),n)for(let a=this.tree.findFirst(l=>i<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new f(a.item.Point.x,o);e=ti.TrySplitHorizontalPoint(e,l,!0),ti.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=i;a=this.tree.previous(a)){let l=new f(a.item.Point.x,o);e=ti.TrySplitHorizontalPoint(e,l,!1),ti.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){ti.Low(e)+E.distanceEpsilon<t.y&&t.y+E.distanceEpsilon<ti.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,i){return i&&e.X+E.distanceEpsilon<t.x&&t.x+E.distanceEpsilon<e.Next.X||!i&&e.Next.X+E.distanceEpsilon<t.x&&t.x+E.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new zt(ue);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,ti.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var mo=class{constructor(e){this.verticesToPathOffsets=new je;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,i=null;for(let n=e.PathPoints;n!=null;n=n.Next){let o=this.verticesToPathOffsets.get(n.Point);if(i!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,n),t.delete(a))}for(let[a,l]of i)o.has(a)||t.set(a,l)}i=o}}CollapseLoopingPath(e,t,i,n,o){let a=mo.FindLinkedPointInPath(n,t.Point),l=Array.from(mo.GetPointsInBetween(a,o));mo.Before(t,i)?(this.CleanDisappearedPiece(t,i,e),this.ReplacePiece(t,i,l,e)):(this.CleanDisappearedPiece(i,t,e),this.ReplacePiece(i,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let i=e.Next;i!=t;i=i.Next)yield i.Point}ReplacePiece(e,t,i,n){let o=e;for(let a of i){let l=new Rr(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(n,o)}o.Next=t}CleanDisappearedPiece(e,t,i){for(let n of mo.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(n).delete(i)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e==t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let i=e.PathPoints;;i=i.Next)if(i.Point.equal(t))return i}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let i=this.verticesToPathOffsets.get(t.Point);i||this.verticesToPathOffsets.set(t.Point,i=new Map);let n=i.get(e);n?(this.CleanDisappearedPiece(n,t,e),n.Next=t.Next):i.set(e,t)}}};var np=class{constructor(e){this.projection=e}compare(e,t){return ue(this.projection(e),this.projection(t))}};var xy=Q(jl()),Nt=class{static RefinePaths(e,t){Nt.AdjustPaths(e);let i=Nt.CreatePathsToFirstLinkedVerticesMap(e);Nt.Refine(Array.from(i.values())),Nt.CrossVerticalAndHorizontalSegs(i.values()),Nt.ReconstructPathsFromLinkedVertices(i),t&&new mo(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=Nt.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length==0)return;let t=[],i=E.RoundPoint(e[0]);t.push(i);for(let n=1;n<e.length;n++){let o=E.RoundPoint(e[n]);i.equal(o)||(i=o,t.push(i))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,i=new Array;for(let n of e)for(let o=n;o.Next!=null;o=o.Next)$(o.Point.x,o.Next.Point.x)?i.push(o):t.push(o);new ti(t,i).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,i]of e)t.PathPoints=i}static Refine(e){Nt.RefineInDirection(1,e),Nt.RefineInDirection(2,e)}static*groupByProj(e,t){let i=new Map;for(let n of t){let o=e(n.Point),a=i.get(o);a||(a=new Array,i.set(o,a)),a.push(n)}for(let n of i.values())yield n}static RefineInDirection(e,t){let i={projectionToPerp:void 0,projectionToDirection:void 0};Nt.GetProjectionsDelegates(e,i);let n=Array.from(Nt.GetAllLinkedVertsInDirection(i.projectionToPerp,t)),o=Nt.groupByProj(i.projectionToPerp,n);for(let a of o)Nt.RefineCollinearBucket(a,i.projectionToDirection)}static GetProjectionsDelegates(e,t){e==2?(t.projectionToDirection=i=>i.x,t.projectionToPerp=i=>i.y):(t.projectionToPerp=i=>i.x,t.projectionToDirection=i=>i.y)}static*GetAllLinkedVertsInDirection(e,t){for(let i of t)for(let n=i;n.Next!=null;n=n.Next)$(e(n.Point),e(n.Next.Point))&&(yield n)}static RefineCollinearBucket(e,t){let i=new xy.SortedMap(new np(t));for(let a of e)i.has(a.Point)||i.set(a.Point,0),i.has(a.Next.Point)||i.set(a.Next.Point,0);let n=new Array(i.size),o=0;for(let a of i.keys())n[o++]=a;for(o=0;o<n.length;o++)i.set(n[o],o);for(let a of e){o=i.get(a.Point);let l=i.get(a.Next.Point);Math.abs(l-o)>1&&Nt.InsertPoints(a,n,o,l)}}static InsertPoints(e,t,i,n){i<n?e.InsertVerts(i,n,t):e.InsertVertsInReverse(n,i,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let i of e)t.set(i,Nt.CreateLinkedVertexOfEdgePath(i));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,i=new Rr(t[0]),n=i;for(let o=1;o<t.length;o++)i.Next=new Rr(t[o]),i=i.Next;return n}};var In=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I==t.I&&e.Points==t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var wn=class{constructor(e,t){this.segTree=new Wo(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new Wo(t),this.Paths=e}static RemoveStaircases(e,t){new wn(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(i=>!this.crossedOutPaths.has(i)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new In(e.pts,0),new In(e.pts,1),new In(e.pts,2),new In(e.pts,3)],i=0;for(let n=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,n,t,o))return e.canHaveStaircase=!0,n;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,n++,e.pts.length<n+5)return-1;t[i]=new In(e.pts,n+3),i++,i%=4}}static GetFlippedPoint(e,t){return $(e[t].y,e[t+1].y)?new f(e[t+4].x,e[t].y):new f(e[t].x,e[t+4].y)}Crossing(e,t,i){return wn.IsCrossing(O.mkPP(e,t),this.segTree,i)}static IsCrossing(e,t,i){for(let n of t.GetAllIntersecting(e.boundingBox))if(i.findIndex(o=>o==n)==-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,i){return this.IntersectObstacleHierarchyL(O.mkPP(e,t))||this.IntersectObstacleHierarchyL(O.mkPP(t,i))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>v.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,i,n){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return n.canHaveStaircaseAtI=!1,_.DirectionFromPointToPoint(o,a)!=_.DirectionFromPointToPoint(l,u)||_.DirectionFromPointToPoint(a,l)!=_.DirectionFromPointToPoint(u,c)||(l=wn.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(n.canHaveStaircaseAtI=!0,!this.Crossing(a,l,i))}RemoveStaircasePN(e,t){let i=e[t],n=e[t+1],o=Math.abs(i.y-n.y)<E.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,i){this.RemoveSegs(e);let n=new Array(e.length-2);bw(e,n,t+1);let o=e[t+1],a=e[t+3];return n[t+1]=i?new f(a.x,o.y):new f(o.x,a.y),mw(e,t+4,n,t+2,n.length-t-2),this.InsertNewSegs(n,t),n}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new In(e,t))}RemoveSeg(e){this.segTree.Remove(wn.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let i=new In(e,t);this.segTree.Add(wn.Rect(i),i)}static Rect(e){return V.mkPP(e.Start,e.End)}};function mw(s,e,t,i,n){for(;n-- >0;)t[i++]=s[e++]}function bw(s,e,t){let i=0;for(;t-- >0;)e[i++]=s[i++]}var He=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,i,n){this.AncestorsSets=n,this.HierarchyOfGroups=Oe(Array.from(n.keys()).filter(o=>o.IsGroup).map(o=>We(o,o.BoundingBox))),this.Obstacles=i,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=Oe(i.map(o=>We(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length==0)return;let t=e.PathPoints,i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],He.ObstacleTest),n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],He.ObstacleTest);i!=null&&n!=null&&this.PathToObstacles.set(e,[i.UserData,n.UserData])}static ObstacleTest(e,t){return v.PointRelativeToCurveLocation(e,t)!=0?1:0}Calculate(e,t){this.NudgingDirection=e,Nt.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let i=this.FindLastUnmappedEdge(e);for(let n=t;n!=null&&n!=i;n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(n.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.LastEdge;i!=null&&_.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.FirstEdge;i!=null&&_.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new dh(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let i=new Array;for(let n of e){let o=new q;for(let a of n.PathPoints)o.addPoint(a);i.push(o)}return i.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)He.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let i=e.LastEdge;i.Width=Math.max(t.targetArrowhead.width,i.Width)}if(t.sourceArrowhead!=null){let i=e.FirstEdge;i.Width=Math.max(t.sourceArrowhead.width,i.Width)}}PositionShiftedEdges(){this.Solver=new Jg(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];He.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),i=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>i&&(e.IdealPosition=i)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return He.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x==t.x||e.y==t.y)return t;let i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i<n?new f(e.x,t.y):new f(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],i=e.FirstEdge;t.push(this.ShiftedPoint(i.Source,i.LongestNudgedSegment));for(let n of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(n));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let i=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection==1?new f(i,e.y):new f(e.x,-i)}static LineSegOfLongestSeg(e,t){let i=t==2?o=>o.x:o=>o.y,n={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)He.UpdateMinMaxWithPoint(n,i,o.Source),He.UpdateMinMaxWithPoint(n,i,o.Target);return t==2?new O(n.min,-e.IdealPosition,n.max,-e.IdealPosition):new O(e.IdealPosition,n.min,e.IdealPosition,n.max)}static UpdateMinMaxWithPoint(e,t,i){let n=t(i);e.min>n&&(e.min=n),e.max<n&&(e.max=n)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let i of e.Edges){let n=i.AxisEdge;if(n!=null)for(let o of n.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let i of t)this.ConstraintTwoLongestSegs(e,i)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)He.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return $(e.SourcePoint.x,e.TargetPoint.x);default:return $(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let i of e.filter(n=>n.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,i.LongestNudgedSegment),t=i}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,He.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),i=e.GetRightBound();t>=i?(this.Solver.AddFixedVariable(e.Id,He.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,He.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!=Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),i!=Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,i))}}static SegmentPosition(e,t){return t==1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new gh(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let i=t.BoundingBox;for(let n of e.PathEdges()){let o=n.AxisEdge;o.Direction==this.NudgingDirection&&this.BoundAxisEdgeByRect(i,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=He.MapPortsToShapes(this.AncestorsSets.keys()));let t=Pw(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(i=>!i.Children.some(n=>t.has(n)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(V.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection==2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),He.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let i=null,n=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(i=a.LongestNudgedSegment,n!=null){let l;He.SetIdealPositionForSeg(n,l=t(n.start),o,t(i.Start)),o=l,n=null}}else i!=null&&(n=i,i=null);n!=null?He.SetIdealPositionForSeg(n,t(n.Start),o,t(e.End)):i!=null&&(i.IdealPosition=t(i.Start))}static SetIdealPositionForSeg(e,t,i,n){let o=Math.max(i,n),a=Math.min(i,n);a+E.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,i=_.OppositeDir(this.NudgingDirection);for(let n of e.PathEdges()){let o=n.Direction;o==this.NudgingDirection||o==i?(t==null?(n.LongestNudgedSegment=t=new ip(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):n.LongestNudgedSegment=t,n.IsFixed&&(t.IsFixed=!0)):(n.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(i=>i.clone())};return He.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){He.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),He.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let i=e.points.length-1,n=_.VectorDirectionPP(e.points[i-1],e.points[i]);if(He.ProjectionsAreClose(e.points[i-1],n,t)){e.points=e.points.slice(0,i);return}let o=e.points[i];n==2||n==8?e.points[i]=new f(t.x,o.y):e.points[i]=new f(o.x,t.y)}static ProjectionsAreClose(e,t,i){return t==2||t==8?$(e.x,i.x):$(e.y,i.y)}static ExtendPolylineToSourcePort(e,t){let i=_.VectorDirectionPP(e.points[0],e.points[1]);if(He.ProjectionsAreClose(e.points[1],i,t)){e.points=e.points.slice(1);return}let n=e.points[0];i==2||i==8?e.points[0]=new f(t.x,n.y):e.points[0]=new f(n.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],i=e[0];t.push(i);let n=e[1],o=_.VectorDirectionPP(i,n),a=1;for(;++a<e.length;){let l=_.VectorDirectionPP(n,e[a]);l==o||_.OppositeDir(l)==o||l==0||(f.closeDistEps(i,n)||t.push(i=He.Rectilinearise(i,n)),o=l),n=e[a]}return f.closeDistEps(i,n)||t.push(He.Rectilinearise(i,n)),t}static NudgePaths(e,t,i,n,o){if(e.length==0)return;let a=new He(e,t,i,n);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=q.mkFromPoints(He.BuildPolylineForPath(l))}RemoveStaircases(){wn.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let i of e)for(let n of i.Ports)t.set(n,i);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,i,n){let o=n.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield Z.mkDebugCurveTWCI(200,e+l*u,i,O.mkPP(o[u],o[u+1]))}};function Pw(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}var Cy=Q(Pt());var op=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var Ln=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new op(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:N.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,i=0,n=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;i<t||o<n;){if(i>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=n){a.push(this.ListOfPointsAndCrossings[i++]);continue}let l=this.ListOfPointsAndCrossings[i],u=e.ListOfPointsAndCrossings[o],c=N.ComparePP(l.Location,u.Location);c==0?(a.push(l),++i,++o):c==-1?(a.push(l),++i):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length==0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(i=>N.ComparePP(i.Location,e)>=0&&N.ComparePP(i.Location,t)<=0))}static ToCrossingArray(e,t){let i=0,n=e.length;for(let l=0;l<n;l++)e[l].DirectionToInside==t&&i++;if(i==0)return null;let o=new Array(i),a=0;for(let l=0;l<n;l++)e[l].DirectionToInside==t&&(o[a++]=e[l]);return o}ToString(){return Cy.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var W=class{static EdgeDirectionVE(e){return W.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return N.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let i=W.EdgeDirectionVE(e);return t==i?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let i of e.InEdges)if(N.GetDirections(e.point,i.SourcePoint)==t)return i.Source;for(let i of e.OutEdges)if(N.GetDirections(e.point,i.TargetPoint)==t)return i.Target;return null}static FindAdjacentEdge(e,t){for(let i of e.InEdges)if(N.GetDirections(i.SourcePoint,e.point)==t)return i;for(let i of e.OutEdges)if(N.GetDirections(e.point,i.TargetPoint)==t)return i;return null}static FindBendPointBetween(e,t,i){return W.IsVerticalD(i)?new f(t.x,e.y):new f(e.x,t.y)}static SegmentIntersectionPPP(e,t,i){let n=N.GetDirections(e,t);return W.IsVerticalD(n)?new f(e.x,i.y):new f(i.x,e.y)}static SegmentIntersectionSP(e,t){return W.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return W.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return W.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return W.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,i,n){return W.IntervalsAreCollinear(e,t,i,n)&&N.ComparePP(e,n)!=N.ComparePP(t,i)}static IntervalsAreCollinear(e,t,i,n){let o=W.IsVerticalPP(e,t);return W.IsVerticalPP(i,n)==o?o?N.Equal(e.x,i.x):N.Equal(e.y,i.y):!1}static IntervalsAreSame(e,t,i,n){return N.EqualPP(e,i)&&N.EqualPP(t,n)}static IntervalsIntersect(e,t,i,n){let o=W.SegmentIntersectionPPP(e,t,i);return W.PointIsOnSegmentPPP(e,t,o)&&W.PointIsOnSegmentPPP(i,n,o)?o:void 0}static SegmentIntersectionEP(e,t){return W.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,i){return N.EqualPP(e,i)||N.EqualPP(t,i)||N.GetDirections(e,i)==N.GetDirections(i,t)}static PointIsOnSegmentSP(e,t){return W.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!=0}static IsVerticalE(e){return W.IsVerticalD(N.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return W.IsVerticalD(N.GetDirections(e,t))}static IsVertical(e){return W.IsVerticalD(N.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!=0}static Slope(e,t,i){let n=t.sub(e);return n.dot(i.PerpDirectionAsPoint)/n.dot(i.DirectionAsPoint)}static SortAscending(e,t){let i=N.GetDirections(e,t);return 0==i||W.IsAscending(i)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,i){switch(i){case 1:case 4:return new f(t.x,W.GetRectangleBound(e,i));case 2:case 8:return new f(W.GetRectangleBound(e,i),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return N.Compare(e.bottom,t.top)<0&&N.Compare(t.bottom,e.top)<0&&N.Compare(e.left,t.right)<0&&N.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return N.Compare(e.y,t.top)<0&&N.Compare(t.bottom,e.y)<0&&N.Compare(e.x,t.right)<0&&N.Compare(t.left,e.x)<0}};var bo=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=_.toPoint(this.Dir),this.PerpDirection=1==e?2:1,this.PerpDirectionAsPoint=_.toPoint(this.PerpDirection),this.OppositeDirection=_.OppositeDir(e)}get IsHorizontal(){return 2==this.Dir}get IsVertical(){return 1==this.Dir}Compare(e,t){let i=this.ComparePerpCoord(e,t);return i!=0?i:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return N.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return N.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return N.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return N.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?bo.VerticalInstance:bo.HorizontalInstance}static GetInstance(e){return W.IsVerticalD(e)?bo.VerticalInstance:bo.HorizontalInstance}ToString(){return this.Dir.toString()}},st=bo;st.HorizontalInstance=new bo(2),st.VerticalInstance=new bo(1);var Rn=class extends cs{static mk(e,t){return new Rn(e,t,Rn.NormalWeight,null)}constructor(e,t,i,n){super();this.Update(e,t),this.Weight=i,this.GroupBoundaryPointAndCrossingsList=n}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Rn.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?st.VerticalInstance:st.HorizontalInstance}get IsOverlapped(){return Rn.OverlappedWeight==this.Weight}get IsReflection(){return Rn.ReflectionWeight==this.Weight}static IsVerticalSegment(e,t){return e.x==t.x}MergeGroupBoundaryCrossingList(e){e!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new Ln),this.GroupBoundaryPointAndCrossingsList.MergeFrom(e))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(e,t){this.startPoint=e,this.endPoint=t}SetInitialVisibilityVertex(e){this.LowestVisibilityVertex=e,this.HighestVisibilityVertex=e}AppendVisibilityVertex(e,t){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.SetInitialVisibilityVertex(t);else{if(N.IsPureLower(t.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.AppendHighestVisibilityVertex(t)}}AddVisibilityEdge(e,t){let i=new Lr(e,t,this.Weight);return Ie.AddEdge(i),i}AppendHighestVisibilityVertex(e){N.EqualPP(this.HighestVisibilityVertex.point,e.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,e),this.HighestVisibilityVertex=e)}LoadStartOverlapVertexIfNeeded(e){if(this.NeedStartOverlapVertex){let t=e.FindVertex(this.Start);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(e){if(this.NeedEndOverlapVertex){let t=e.FindVertex(this.End);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.End))}}OnSegmentIntersectorBegin(e){this.AppendGroupCrossingsThroughPoint(e,this.Start)||this.LoadStartOverlapVertexIfNeeded(e)}OnSegmentIntersectorEnd(e){this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||N.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(e)}static Subsume(e,t,i,n,o,a,l,u){return u.extendStart=!0,u.extendEnd=!0,e.seg==null||!W.IntervalsOverlapPPPP(e.seg.Start,e.seg.End,t,i)?!1:e.seg.Weight!=n?e.seg.Start==t&&e.seg.End==i?(e.seg.Weight=Math.min(e.seg.Weight,n),!0):!1:(u.extendStart=a.CompareScanCoord(t,e.seg.Start)==-1,u.extendEnd=a.CompareScanCoord(i,e.seg.End)==1,(u.extendStart||u.extendEnd)&&(l.Remove(e.seg),e.seg.startPoint=a.Min(e.seg.Start,t),e.seg.endPoint=a.Max(e.seg.End,i),e.seg=l.InsertUnique(e.seg).item,e.seg.MergeGroupBoundaryCrossingList(o)),!0)}IntersectsSegment(e){return W.SegmentsIntersection(this,e)!=null}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(e){return N.EqualPP(this.Start,e)||N.EqualPP(this.End,e)||N.GetDirections(this.Start,e)==N.GetDirections(e,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(e){return this.IsVertical?new f(this.Start.x,e):new f(e,this.Start.y)}AddSparseVertexCoord(e){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(e)}AddSparseEndpoint(e){return this.sparsePerpendicularCoords.has(e)?!1:(this.sparsePerpendicularCoords.add(e),!0)}CreateSparseVerticesAndEdges(e){var t;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(e,this.Start);for(let i of Array.from(this.sparsePerpendicularCoords.values()).sort(ue)){let n=this.CreatePointFromPerpCoord(i);this.AppendVisibilityVertex(e,(t=e.FindVertex(n))!=null?t:e.AddVertexP(n))}this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(e,t){return this.AppendGroupCrossingsThroughPoint(e,t.point)?(N.IsPureLower(this.HighestVisibilityVertex.point,t.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t),!0):!1}AppendGroupCrossingsThroughPoint(e,t){var n;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let i=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(t);){let o=this.GroupBoundaryPointAndCrossingsList.Pop(),a=null,l=null;N.ComparePP(o.Location,this.Start)>0&&(a=Ln.ToCrossingArray(o.Crossings,this.ScanDirection.OppositeDirection)),N.ComparePP(o.Location,this.End)<0&&(l=Ln.ToCrossingArray(o.Crossings,this.ScanDirection.Dir)),i=!0;let u=(n=e.FindVertex(o.Location))!=null?n:e.AddVertexP(o.Location);e.AddVertexP(o.Location),a!=null||l!=null?(this.AddLowCrossings(e,u,a),this.AddHighCrossings(e,u,l)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(u):this.AppendHighestVisibilityVertex(u)}return i}static GetCrossingInteriorVertex(e,t,i){var o;let n=i.GetInteriorVertexPoint(t.point);return(o=e.FindVertex(n))!=null?o:e.AddVertexP(n)}AddCrossingEdge(e,t,i,n){let o=null;this.HighestVisibilityVertex!=null&&(N.EqualPP(this.HighestVisibilityVertex.point,i.point)?o=e.FindEdgePP(t.point,i.point):this.AppendHighestVisibilityVertex(t)),o==null&&(o=this.AddVisibilityEdge(t,i));let a=n.map(u=>u.Group.InputShape),l=o.IsPassable;l==null?o.IsPassable=()=>{for(let u of a)if(u.IsTransparent)return!0;return!1}:o.IsPassable=()=>{for(let u of a)if(u.IsTransparent||l())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(t),this.HighestVisibilityVertex=i}AddLowCrossings(e,t,i){if(i!=null){let n=Rn.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,n,t,i)}}AddHighCrossings(e,t,i){if(i!=null){let n=Rn.GetCrossingInteriorVertex(e,t,i[0]);this.AddCrossingEdge(e,t,n,i)}}},le=Rn;le.NormalWeight=Lr.DefaultWeight,le.ReflectionWeight=5,le.OverlappedWeight=500;var ph=class{constructor(e,t,i,n,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?_.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,i,n,o)}ResetEntry(e,t,i,n){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=i,this.Cost=n}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var mh=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},at=class{constructor(){this.nextNeighbors=[new mh,new mh,new mh];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,i){if(t==i||!this.InitEntryDirectionsAtTarget(i))return!1;this.Target=i,this.Source=t;let n=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return n>=this.upperBoundOnCost?!1:(this.queue=new zt(ue),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(n):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|_.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|_.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!=0}static IsInDirs(e,t){return e==(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let i=this.Target.point.sub(e);if($(i.x,0)&&$(i.y,0))return this.targetCostAdjustment;let n=_.VectorDirection(i),o;return t==0?(t=15,o=this.GetNumberOfBends(t,n)):o=this.GetNumberOfBends(t,n),this.CombinedCost(at.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return _.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):at.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)==t?at.IsInDirs(t,this.EntryDirectionsToTarget)?0:at.IsInDirs(at.Left(t),this.EntryDirectionsToTarget)||at.IsInDirs(at.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(at.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,i){let n=e&t;if(n==0)return at.GetBendsForNotPureDirection(e,at.AddOneTurn[t],i)+1;let o=e&i;return o==0?at.GetBendsForNotPureDirection(e,t,at.AddOneTurn[i])+1:(n|o)==e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return at.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let i=new Array,n=!1,o=0;for(;;){o==e.entry.Direction?n=!0:(n=!1,i.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex==t)break;e.entry=a}return n&&i.push(e.entry.Vertex.point),i.reverse(),i}QueueReversedEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=t.PreviousVertex,a=at.GetLengthAndNumberOfBendsToNeighborVertex(e,o,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree==1){let l=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,n.length,n.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=at.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,n.length,n.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,i){let n={numberOfBends:0,length:0},o=at.GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n),a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,n.length,n.numberOfBends,a))}EnqueueEntry(e,t,i,n,o){let a=new ph(t,e,i,n,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n){n.length=e.Length+at.ManhattanDistance(e.Vertex.point,t.point)*i;let o=_.DirectionFromPointToPoint(e.Vertex.point,t.point);return n.numberOfBends=e.NumberOfBends,e.Direction!=0&&o!=e.Direction&&n.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,i,n,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=i,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c==this.Target){if(n==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget==0){let d=0;for(let p of this.Target.VertexEntries)n[d++]=p;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=at.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(n!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)n[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,i){for(let n of t)this.ExtendPathAlongEdge(e,n,!0,i)}ExtendPathAlongOutEdges(e,t,i){let n=t.isEmpty()?null:t.treeMinimum();for(;n!=null;n=t.next(n))this.ExtendPathAlongEdge(e,n.item,!1,i)}ExtendPathAlongEdge(e,t,i,n){if(!at.IsPassable(t))return;let o=i?t.Source:t.Target;if(o==e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!=this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=_.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!=e.Direction&&(l=this.nextNeighbors[a==n?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new ph(this.Source,null,0,0,e);for(let i of this.Source.OutEdges)!at.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Target,i.Weight);for(let i of this.Source.InEdges)!at.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Source,i.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,i){let n=_.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[_.ToIndex(n)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,i):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,i)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i){if(e.Vertex.VertexEntries!=null){let n=_.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[_.ToIndex(n)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,i),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},ri=at;ri.DefaultBendPenaltyAsAPercentageOfDistance=4,ri.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var ps=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=ri.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let i={entry:this.GetPathStage(null,e,null,t)};return ri.RestorePathV(i)}GetPathStage(e,t,i,n){let o=new ri,a={bestEntry:null,bestCost:Number.MAX_VALUE/le.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=ps.Barycenter(t),c=ps.Barycenter(n),h=ri.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,p=i!=null?this.currentPassTargetEntries:null,y=[];for(let T of t)for(let I of n)y.push([T,I]);y.sort(([T,I],[B,w])=>x(T,I)-x(B,w));for(let[T,I]of y){if(f.closeDistEps(T.point,I.point))continue;let B=A(T,u)*d,w=A(I,c)*d,M=a.bestCost;if(i!=null){for(let se=0;se<p.length;se++)p[se]=null;M=o.MultistageAdjustedCostBound(a.bestCost)}let F=o.GetPathWithCost(e,T,B,p,I,w,M);if(p!=null){ps.UpdateTargetEntriesForEachDirection(i,p,a);continue}if(F==null)continue;let z=F.Cost/x(T,I);(F.Cost<a.bestCost||$(F.Cost,a.bestCost)&&z<l)&&(a.bestCost=F.Cost,a.bestEntry=F,l=F.Cost/x(T,I))}return a.bestEntry;function x(T,I){return ri.ManhattanDistance(T.point,I.point)}function A(T,I){return ri.ManhattanDistance(T.point,I)}}static UpdateTargetEntriesForEachDirection(e,t,i){for(let n=0;n<t.length;n++){let o=t[n];o!=null&&(e[n]==null||o.Cost<e[n].Cost)&&(e[n]=o,o.Cost<i.bestCost&&(i.bestCost=o.Cost,i.bestEntry=o))}}static Barycenter(e){let t=new f(0,0);for(let i of e)t=t.add(i.point);return t.div(e.length)}};var vy=Q(Pt());var sp=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof Rr?Array.from(Ay(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new vy.StringBuilder;this.PathPoints instanceof Rr&&e.Append("L");for(let t of Ay(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*Ay(s){if(s instanceof Rr)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var ap=class extends hs{constructor(e,t,i,n){super(t);this.Slope=0;this.SlopeInverse=0;this.Obstacle=e,this.endVertex=n?t.nextOnPolyline:t.prevOnPolyline,i.IsPerpendicularPP(t.point,this.endVertex.point)||(this.Slope=W.Slope(t.point,this.endVertex.point,i),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(e){this.obstacle=e}get EndVertex(){return this.endVertex}},nr=class extends ap{constructor(e,t,i){super(e,t,i,i.IsHorizontal)}},Po=class extends ap{constructor(e,t,i){super(e,t,i,i.IsVertical)}};var ms=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=xn(this.InputShape.Ports,this.Ports),e.removedPorts=xn(this.Ports,this.InputShape.Ports),e.addedPorts.size==0&&e.removedPorts.size==0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,i,n){let o=ms.mk(e,t,n);return o.CreateInitialSides(o.PaddedPolyline.startPoint,i),o}CreateInitialSides(e,t){this.ActiveLowSide=new nr(this,e,t),this.ActiveHighSide=new Po(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new Po(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t,i){if(e!=null){if(t){let n=e.BoundingBox.clone();n.pad(i),this.PaddedPolyline=v.polyFromBox(n)}else this.PaddedPolyline=wt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,i);ms.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports)}}static mk(e,t,i){let n=new ms(null,!1,0);return n.PaddedPolyline=q.mkClosedFromPoints([E.RoundPoint(e),E.RoundPoint(t)]),n.Ordinal=i,n}IsPolylineRectangle(){if(this.PaddedPolyline.count!=4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,i=_.VectorDirectionPP(e.point,t.point);if(!_.IsPureDirection(i))return!1;do{e=t,t=e.nextOnPolyline;let n=_.DirectionFromPointToPoint(e.point,t.point);if(n!=_.RotateRight(i))return!1;i=n}while(e!=this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=E.RoundPoint(t.point),t=t.nextOnPolyline;while(t!=e.startPoint);ms.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this==this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=E.intersectionEpsilon*10;for(let i=e.startPoint.next;i!=null;i=i.next)f.close(i.prev.point,i.point,t)&&(i.next==null?e.RemoveEndPoint():(i.prev.next=i.next,i.next.prev=i.prev));return f.close(e.start,e.end,t)&&e.RemoveStartPoint(),Pe.RemoveCollinearVertices(e),e.endPoint.prev!=null&&e.endPoint.prev!=e.startPoint&&f.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)==2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!=e.startPoint&&f.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)==2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!=null&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump==e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=wt.CreatePaddedPolyline(e,E.intersectionEpsilon*10);return ms.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},Ht=ms;Ht.FirstSentinelOrdinal=1,Ht.FirstNonSentinelOrdinal=10;var Ty=Q(Pt());var lp=class{constructor(e,t,i,n){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=le.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=i;let o=O.mkPP(this.UnpaddedBorderIntersect,W.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,i)),a=v.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=E.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=n.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=n.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,st.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(n))&&(this.unpaddedToPaddedBorderWeight=le.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight==le.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(n)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?le.OverlappedWeight:le.NormalWeight}get IsCollinearWithPort(){return _.IsPureDirection(N.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return W.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return N.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!=0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=le.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=V.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,i=>i.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(i=>!i.UserData.IsGroup&&i.UserData!=this.Obstacle).map(i=>i.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=V.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!=this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,i){let n=null;for(let o of i){let a=t(o);if(!W.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(n=n!=null?n:O.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),v.intersectionOne(n,a,!1)!=null||0!=v.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=W.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return N.GetDirections(this.MaxVisibilitySegment.start,t.Location)==N.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,i,n){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,i,n);return}this.OutwardDirection==N.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,i,n)}ExtendEdgeChain(e,t,i,n,o){e.ExtendEdgeChainVRLPB(i,n,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return Ty.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var up=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=V.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=E.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,i){let n=new lp(this,e,t,i);this.PortEntrances.push(n),this.VisibilityRectangle.add(n.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||n.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!f.closeDistEps(this.Location,E.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var cp=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?le.OverlappedWeight:le.NormalWeight}get IsOutOfBounds(){return 0!=this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,i,n){let o=W.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,i,n):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,i,n),a}AddToAdjacentVertex(e,t,i,n){N.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,i,n)}ExtendEdgeChain(e,t,i,n){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,i));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,i,e);e.ExtendEdgeChainVRLPB(t,n,a[0],a[1],o)}GetSegmentAndCrossings(e,t,i){let n=_.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[n];if(o==null){let a={pacList:null};o=[i.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[n]=o}else N.GetDirections(e.point,o[0].start)==t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let i=N.GetDirections(t,this.Vertex.point),n=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(n,this.Vertex,i&5,le.NormalWeight),e.ConnectVertexToTargetVertex(n,this.Vertex,i&10,le.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var Ly=Q(Pt());var Iy=Q(Pt());var Na=class{constructor(e,t){this.BoundaryWidth=E.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return E.RoundPoint(e.add(_.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return Iy.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};Na.BoundaryWidth=E.distanceEpsilon;var ru=class extends Tt{constructor(e){super();this.site=e}get Site(){return this.site}};var bs=class extends Hr{constructor(e,t){super(t);this.Obstacle=e}};var Ps=class extends bs{constructor(e,t){super(e,t)}};var hp=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!N.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||N.GetDirections(this.CurrentSegment.End,e)==N.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&f.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(N.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new f(e,this.Coord):new f(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y == "+this.Coord:"(V) X == "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var bh=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let i=Array.from(e).sort((n,o)=>n>o?1:n<o?-1:0);for(let n of i)this.vector.push(new hp(n))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,i,n){this.CurrentSlot.AppendScanSegment(new le(e,t,i,n))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let i=0,n=this.vector.length-1;if(e<=this.vector[i].Coord)return i;if(e>=this.vector[n].Coord)return n;for(;n-i>2;){let o=i+(n-i>>1),a=this.vector[o];if(e<a.Coord){n=o;continue}if(e>a.Coord){i=o;continue}return o}for(i++;i<=n;i++){let o=this.vector[i];if(e<o.Coord)return t>0?i:i-1;if(e==o.Coord)break}return i}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let i=t.FirstSegment;i!=null;i=i.NextSegment)i.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let i=t.NextSegment;i!=null;i=i.NextSegment){if(i.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&i.Start==t.End){let n=this.GetPerpendicularCoord(i.Start);t.AddSparseEndpoint(n),i.AddSparseEndpoint(n)}t=i}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count == ")+this.vector.length}};var ii=class extends Tt{constructor(e,t,i){super();this.InitialObstacle=e,this.ReflectingObstacle=t,this.site=i}static mk(e,t,i){let n=new ii(e.ReflectingObstacle,t,i);return n.PreviousSite=e,n}IsStaircaseStep(e){return this.InitialObstacle==e}get Site(){return this.site}};var Ph=class{constructor(){this.eventTree=new as((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(i)return i;let n=e instanceof ii?0:1,o=t instanceof ii?0:1;return i=n-o,i||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var wy=Q(Pt());var iu=class{constructor(){this.pointCrossingMap=new je;this.pointList=new Array}AddIntersection(e,t,i){let n=this.pointCrossingMap.get(e);n||(n=new Array,this.pointCrossingMap.set(e,n));let o=n.length;for(let l=0;l<o;l++){let u=n[l];if(u.Group==t)return u}let a=new Na(t,i);return n.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size==0)return null;if(N.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())N.ComparePP(o,e)>=0&&N.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let i=new Ln,n=this.pointList.length;for(let o=0;o<n;o++){let a=this.pointList[o];i.Add(a,this.pointCrossingMap.get(a))}return i}toString(){return wy.String.Format("{0}",this.pointCrossingMap.size)}};var yh=class extends ii{constructor(e,t,i){super(e.ReflectingObstacle,t.Obstacle,i);this.Side=t}};var dp=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new Ke((t,i)=>this.CompareBB(t,i)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let i=this.FindFirstInRange(e,t);i!=null;i=this.FindNextInRange(i,t))this.MarkStaleSite(i.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site==e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let i=this.eventTree.findFirst(this.findFirstPred);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let i=this.eventTree.next(e);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Sh=class extends bs{constructor(e,t){super(e,t)}},Eh=class extends bs{constructor(e,t){super(e,t)}},xh=class extends bs{constructor(e,t){super(e,t)}};var Ch=class extends ii{constructor(e,t,i){super(e.ReflectingObstacle,t.obstacle,i);this.Side=t}};var Ah=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,i,n){if(W.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=i,this.GroupSideInterveningBeforeHighNeighbor=n;return}this.LowNeighbor=t,this.LowOverlapEnd=i,this.GroupSideInterveningBeforeLowNeighbor=n}};var vh=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],Ht.RoundVerticesAndSimplify(this.Polyline)}};var On=class{static MungeClosestIntersectionInfo(e,t,i){let n=t.seg1.boundingBox,o=E.RoundPoint(t.x).clone();return i?new f(On.MungeIntersect(e.x,o.x,n.left,n.right),o.y):new f(o.x,On.MungeIntersect(e.y,o.y,n.bottom,n.top))}static MungeIntersect(e,t,i,n){if(e<t){let o=Math.min(i,n);t<o&&(t=o)}else if(e>t){let o=Math.max(i,n);t>o&&(t=o)}return E.RoundDouble(t)}};var Je=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new iu;this.overlapPairs=new Vt;this.hasOverlaps=!1;this.lookupIntPair=new ee(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,i){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=i}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=Ht.FirstNonSentinelOrdinal;for(let i of this.allObstacles)i.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-Ht.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=Je.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=Je.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(pt(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let i={bIsInsideA:!1,aIsInsideB:!1};if(Je.ObstaclesIntersect(e,t,i)){this.hasOverlaps=!0;return}!i.aIsInsideB&&!i.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&i.bIsInsideA||t.IsGroup&&i.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(i=>We(i,i.VisibilityBoundingBox));return Oe(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=Je.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&tr(e,e,(t,i)=>this.EvaluateOverlappedPairForClump(t,i))}EvaluateOverlappedPairForClump(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!Je.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||this.overlapPairs.add(new ee(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=Je.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&tr(e,e,(t,i)=>this.EvaluateOverlappedPairForConvexHull(t,i))}EvaluateOverlappedPairForConvexHull(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!Je.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new ee(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=Je.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsGroup)),t=Je.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsPrimaryObstacle));e==null||t==null||tr(e,t,(i,n)=>this.EvaluateOverlappedPairForGroup(i,n))}EvaluateOverlappedPairForGroup(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1},n=Je.ObstaclesIntersect(e,t,i);if(!(!n&&!i.aIsInsideB&&!i.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(i.aIsInsideB||Je.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!n&&(t.IsGroup||i.bIsInsideA)||this.overlapPairs.add(new ee(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return v.PointRelativeToCurveLocation(e.start,t)!=0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(i=>i.Ordinal!=e.Ordinal))this.overlapPairs.add(new ee(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(i=>i.Ordinal!=e.Ordinal))this.overlapPairs.add(new ee(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=ha(Array.from(this.overlapPairs.values())),t=Pn(e);for(let i of t){if(i.length==1)continue;let n=i.map(o=>this.OrdinalToObstacle(o));for(let o of n)o.clump=n}}CreateConvexHulls(){let e=!1,t=ha(Array.from(this.overlapPairs.values())),i=Pn(t);for(let n of i){if(n.length==1)continue;e=!0;let o=n.map(this.OrdinalToObstacle),a=qi(o,u=>Array.from(u.VisibilityPolyline)),l=new vh(mr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let i=this.OrdinalToObstacle(t.x),n=this.OrdinalToObstacle(t.y);Je.ResolveGroupAndGroupOverlap(i,n)||Je.ResolveGroupAndObstacleOverlap(i,n)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?Je.ResolveGroupAndObstacleOverlap(e,t):Je.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let i=t.looseVisibilityPolyline;Je.GrowGroupAroundLoosePolyline(e,i);let n={bIsInsideA:!1,aIsInsideB:!1};for(;Je.ObstaclesIntersect(t,e,n)||!n.aIsInsideB;)i=Ht.CreateLoosePolyline(i),Je.GrowGroupAroundLoosePolyline(e,i)}static GrowGroupAroundLoosePolyline(e,t){let i=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new vh(mr.createConvexHullAsClosedPolyline(i),[e]))}static ObstaclesIntersect(e,t,i){return v.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):(i.aIsInsideB=Je.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),i.bIsInsideA=!i.aIsInsideB&&Je.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:Je.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i.aIsInsideB,i.bIsInsideA)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i,n){if(!i&&!n)return v.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=i?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=i?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(v.PointRelativeToCurveLocation(l,a)==0){let u=v.ClosestPoint(a,l);if(!f.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let i=t.VisibilityBoundingBox;for(let n of this.Root.GetNodeItemsIntersectingRectangle(i))if(n!=t&&v.ClosedCurveInteriorsIntersect(n.VisibilityPolyline,t.VisibilityPolyline)){if(n.IsInConvexHull)for(let o of n.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(n.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let i=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(n=>!i.intersects(this.shapeIdToObstacleMap.get(n).VisibilityBoundingBox)));for(let n of e)this.AncestorSets.get(t.InputShape).delete(n);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,i){let n=W.RectangleBorderIntersect(this.GraphBox,e,t);if(N.GetDirections(e,n)==0)return i.pacList=null,O.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,n);return i.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,i,n){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=n,this.Root.FirstHitNodeWithPredicate(i,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,st.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t==this.insideHitTestIgnoreObstacle1||t==this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!W.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let i=W.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),n=W.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=O.mkPP(n,i),a=v.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length==2){let l=E.RoundPoint(a[0].x),u=E.RoundPoint(a[1].x);if(!N.EqualPP(e,l)&&!N.EqualPP(e,u)&&e.compareTo(l)!=e.compareTo(u)&&!$(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!N.EqualPP(i.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!N.EqualPP(i.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=O.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let i=N.GetDirections(e,t),n=8==i?this.GraphBox.right:2==i?this.GraphBox.left:e.x,o=8==i?this.GraphBox.left:2==i?this.GraphBox.right:t.x,a=4==i?this.GraphBox.top*2:1==i?this.GraphBox.bottom:e.y,l=4==i?this.GraphBox.bottom:1==i?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=O.mkPP(new f(n,a),new f(o,l))}RecurseRestrictRayWithObstacles(e){if(!W.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let i=v.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(i);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,i);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,i=null,n=this.restrictedRayLengthSquared,o=N.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=E.RoundPoint(a.x),u=N.GetDirections(this.currentRestrictedRay.start,l);if(u==_.OppositeDir(o))continue;if(t++,0==u){n=0,i=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<n){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<E.squareOfDistanceEpsilon)continue;n=c,i=a}}if(i!=null){if(t==1){let a=E.RoundPoint(i.x);if(f.closeIntersections(a,this.currentRestrictedRay.start)||f.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=n,this.currentRestrictedRay.end=On.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,i,!W.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let i of t){let n=E.RoundPoint(i.x);if(n.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=N.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=i.seg1,u=_.VectorDirection(l.derivative(i.par1)),c=a;(u&_.RotateRight(a))!=0&&(c=_.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,e,c)}}};var fp=class{constructor(e,t){this.scanDirection=e,this.SideTree=new Ke((i,n)=>this.Compare(i,n)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)==-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return W.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle==t.Obstacle)return e==t?0:e instanceof nr?-1:1;let i=ys.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),n=ys.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=i.compareTo(n);if(o==0){let a=e instanceof nr,l=t instanceof nr;o=g0(a,l),o==0&&(o=ue(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var Da=class{constructor(e){this.lookupSegment=le.mk(new f(0,0),new f(0,1));this.ScanDirection=e,this.segmentTree=new Ke((t,i)=>this.Compare(t,i)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let i=this.segmentTree.find(this.lookupSegment);return i!=null&&N.EqualPP(i.item.End,t)?i.item:null}FindLowestIntersector(e,t){let i=this.FindLowestIntersectorNode(e,t);return i!=null?i.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let i=this.segmentTree.findLast(this.findIntersectorPred);if(N.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.Start,t)>0)return null;i=this.segmentTree.next(i)}return i}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let i=this.segmentTree.findLast(this.findIntersectorPred);if(N.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.End,e)<0)return null;i=this.segmentTree.previous(i)}return i!=null?i.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,i){this.lookupSegment.Update(e,t);let n=this.segmentTree.findFirst(this.findPointPred);if(n!=null){let o=n.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)==-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped==e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!=t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start==t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End==t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let n=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),n.Update(o.End,n.End),this.segmentTree.insert(n),n.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.ScanDirection.Compare(e.Start,t.Start);return i==0&&(i=this.ScanDirection.Compare(e.End,t.End)*-1),i}};var gp=class extends Cn{constructor(e){super(e)}SetVertexEntry(e){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[_.ToIndex(e.Direction)]=e}RemoveVertexEntries(){this.VertexEntries=null}};var yt=class{constructor(e){this.ObstacleTree=new Je;this.CurrentGroupBoundaryCrossingMap=new iu;this.LowNeighborSides=new Ah;this.HighNeighborSides=new Ah;this.ScanDirection=st.HorizontalInstance,this.eventQueue=new Ph,this.HorizontalScanSegments=new Da(st.HorizontalInstance),this.VerticalScanSegments=new Da(st.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new Ie;return e.VertexFactory=t=>new gp(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(st.HorizontalInstance);let e=Ht.FirstSentinelOrdinal,t=new f(this.ObstacleTree.GraphBox.left-yt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-yt.SentinelOffset),i=new f(this.ObstacleTree.GraphBox.left-yt.SentinelOffset,this.ObstacleTree.GraphBox.top+yt.SentinelOffset),n=Ht.CreateSentinel(t,i,this.ScanDirection,e++);this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new f(this.ObstacleTree.GraphBox.right+yt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-yt.SentinelOffset),i=new f(this.ObstacleTree.GraphBox.right+yt.SentinelOffset,this.ObstacleTree.GraphBox.top+yt.SentinelOffset),n=Ht.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(st.VerticalInstance),t=new f(this.ObstacleTree.GraphBox.left-yt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-yt.SentinelOffset),i=new f(this.ObstacleTree.GraphBox.right+yt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-yt.SentinelOffset),n=Ht.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new f(this.ObstacleTree.GraphBox.left-yt.SentinelOffset,this.ObstacleTree.GraphBox.top+yt.SentinelOffset),i=new f(this.ObstacleTree.GraphBox.right+yt.SentinelOffset,this.ObstacleTree.GraphBox.top+yt.SentinelOffset),n=Ht.CreateSentinel(t,i,this.ScanDirection,e),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,i){let n=t.Direction,o=t.Start.x,a=t.Start.y;return i.IsHorizontal?(o+=n.x/n.y*(e.y-t.Start.y),o=On.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=n.y/n.x*(e.x-t.Start.x),a=On.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new f(o,a)}GetOpenVertex(e){let t=e.startPoint,i=this.TraversePolylineForEvents(t),n=this.PointCompare(i.point,t.point);for(;;i=this.TraversePolylineForEvents(i)){let o=this.PointCompare(i.point,t.point);if(o<=0)t=i;else if(o>0&&n<=0)break;n=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new fp(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new dp(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new Ps(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return yt.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof nr?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof nr?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,i,n){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!n&&!W.PointIsInRectangleInterior(i,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(i)==null&&this.lookaheadScan.Add(new ii(e,t.Obstacle,i))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let i=V.mkPP(e.Start,e.End),n=V.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!i.intersectsOnX(n):!i.intersectsOnY(n))return;let o=V.intersect(i,n),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=yt.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!=e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,i){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!W.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(i!=null&&e.IsStaircaseStep(i.Obstacle))return this.ScanLineCrossesObstacle(e.Site,i.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,i,n){{let o=this.ScanLineIntersectSide(n.Site,t!=null?t:i),a=t!=null?o:n.Site,l=t!=null?n.Site:o;return t==null?t=this.scanLine.NextLowB(i).item:i=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,i,n)}}AddReflectionEvent(e,t,i){let n=t;n!=null?this.eventQueue.Enqueue(new Ch(e,n,i)):this.eventQueue.Enqueue(new yh(e,t,i))}AddSideToScanLine(e,t){let i=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),i}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Ph,this.HorizontalScanSegments=new Da(st.HorizontalInstance),this.VerticalScanSegments=new Da(st.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof Ps?this.ProcessEventO(e):e instanceof Sh?this.ProcessEventLB(e):e instanceof Eh?this.ProcessEventHB(e):e instanceof xh?this.ProcessEventCV(e):e instanceof Ch?this.ProcessEventLR(e):e instanceof yh?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,i){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,i,this.HighNeighborSides)}FindNeighbors(e,t,i){let n=e instanceof Ps?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,n,o.lowNborSideNode,i),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,n,o.highNborSideNode,i)}SkipToNeighbor(e,t,i,n,o){let a=null,l=null;for(;;n=this.scanLine.Next(e,n))if(n.item.Obstacle!=t.Obstacle){if(n.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(n,i,e)&&l==null&&(l=n.item);continue}if(n.item instanceof Po==W.IsAscending(e)){this.ScanLineCrossesObstacle(i,n.item.Obstacle)&&(a=n,l=null);continue}break}o.SetSides(e,n,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,i){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let n=e.item instanceof nr==W.IsAscending(i)?i:_.OppositeDir(i),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,n),!0}FindNeighborsAndProcessVertexEvent(e,t,i){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(i,e,t),this.ProcessVertexEvent(e,t,i),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let i=this.AddSideToScanLine(t.ActiveHighSide,e.Site),n=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(n,i,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!=t.ActiveLowSide.Start){let c=new Po(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,i=new nr(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(i.End,i.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(i,e.Site),t.ActiveLowSide=i,this.EnqueueLowBendVertexEvent(i))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Sh(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,i=new Po(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let n=this.AddSideToScanLine(i,e.Site);if(t.ActiveHighSide=i,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&i.Start.x==t.VisibilityBoundingBox.right&&this.SideReflectsUpward(i)){let o=this.scanLine.NextHighR(n);o.item instanceof nr&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(i.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,i,i.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,i=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(i.point,e.End)>0?this.eventQueue.Enqueue(new Eh(t,e.EndVertex)):this.eventQueue.Enqueue(new xh(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,i=this.scanLine.Find(t.ActiveLowSide),n=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)==1){let o=i;i=n,n=o}if(this.FindNeighborsAndProcessVertexEvent(i,n,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(i);o.item!=n.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,i=this.HighNeighborSides.HighNeighbor.item,n=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(i),n.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,i=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,i,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,i=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,null,i,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),i=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new f(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(i,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return N.EqualPP(e,this.MakeInBoundsLocation(e))}},ys=yt;ys.SentinelOffset=1;var or=class extends ys{constructor(){super(!1);this.horizontalVertexPoints=new Me;this.verticalVertexPoints=new Me;this.boundingBoxSteinerPoints=new Me;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let e of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(e.VisibilityBoundingBox.left),this.xCoordAccumulator.add(e.VisibilityBoundingBox.right),this.yCoordAccumulator.add(e.VisibilityBoundingBox.top),this.yCoordAccumulator.add(e.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new bh(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new bh(this.xCoordAccumulator,!1);for(let e=0;e<this.horizontalScanSegmentVector.Length;e++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(e).Coord,e);for(let e=0;e<this.verticalScanSegmentVector.Length;e++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(e).Coord,e)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(e){super.InitializeEventQueue(e),this.SetVectorsAndCoordMaps(e),this.AddAxisCoordinateEvents(e)}AddAxisCoordinateEvents(e){if(e.IsHorizontal){for(let t of this.yCoordAccumulator)this.eventQueue.Enqueue(new ru(new f(this.ObstacleTree.GraphBox.left-or.SentinelOffset,t)));return}for(let t of this.xCoordAccumulator)this.eventQueue.Enqueue(new ru(new f(t,this.ObstacleTree.GraphBox.bottom-or.SentinelOffset)))}ProcessCustomEvent(e){this.ProcessAxisCoordinate(e)||this.ProcessCustomEvent(e)}ProcessAxisCoordinate(e){return e instanceof ru?(this.CreateScanSegmentsOnAxisCoordinate(e.Site),!0):!1}InsertPerpendicularReflectionSegment(e,t){return!1}InsertParallelReflectionSegment(e,t,i,n,o,a){return!1}ProcessVertexEvent(e,t,i){let n=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;n.add(i.Site);let o=this.LowNeighborSides.LowNeighbor.item,a=this.HighNeighborSides.HighNeighbor.item,l=this.ScanDirection.Dir,u=this.ScanDirection.OppositeDirection,c=this.ScanLineIntersectSide(i.Site,o),h=this.ScanLineIntersectSide(i.Site,a);if(this.ObstacleTree.GraphBox.contains(c)){let p=W.RectangleBorderIntersect(o.Obstacle.VisibilityBoundingBox,c,l);N.IsPureLower(p,i.Site)&&this.boundingBoxSteinerPoints.add(p)}if(this.ObstacleTree.GraphBox.contains(h)){let p=W.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);N.IsPureLower(i.Site,p)&&this.boundingBoxSteinerPoints.add(p)}let d={lowCorner:void 0,highCorner:void 0};or.GetBoundingCorners(e.item.Obstacle.VisibilityBoundingBox,i instanceof Ps,this.ScanDirection.IsHorizontal,d),(N.IsPureLower(c,d.lowCorner)||o.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.lowCorner),(N.IsPureLower(d.highCorner,h)||a.Obstacle.IsInSameClump(i.Obstacle))&&n.add(d.highCorner)}static GetBoundingCorners(e,t,i,n){if(t){n.lowCorner=e.leftBottom,n.highCorner=i?e.rightBottom:e.leftTop;return}n.lowCorner=i?e.leftTop:e.rightBottom,n.highCorner=e.rightTop}CreateScanSegmentsOnAxisCoordinate(e){this.CurrentGroupBoundaryCrossingMap.Clear();let t=this.scanLine.Lowest(),i=this.scanLine.NextHighR(t),n=0,o=e,a=!1;for(;i!=null;i=this.scanLine.NextHighR(i)){if(this.SkipSide(o,i.item))continue;if(i.item.Obstacle.IsGroup){(n==0||a)&&this.HandleGroupCrossing(e,i.item);continue}if(i.item instanceof nr){if(n>0){n++;continue}o=this.CreateScanSegment(o,i.item,le.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),n=1,a=i.item.Obstacle.isOverlapped;continue}n++,!(n>0)&&(o=i.item.Obstacle.isOverlapped||i.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(o,i.item,le.OverlappedWeight):this.ScanLineIntersectSide(o,i.item),this.CurrentGroupBoundaryCrossingMap.Clear(),a=!1)}let l=this.ScanDirection.IsHorizontal?new f(this.ObstacleTree.GraphBox.right+or.SentinelOffset,o.y):new f(o.x,this.ObstacleTree.GraphBox.top+or.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(o,l,le.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o,l)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(e,t){if(!this.ScanLineCrossesObstacle(e,t.Obstacle))return;let i=t instanceof nr?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,n=this.ScanLineIntersectSide(e,t),o=this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,t.Obstacle,i);this.AddPerpendicularCoordForGroupCrossing(n);let a=o.GetInteriorVertexPoint(n);this.AddPerpendicularCoordForGroupCrossing(a)}AddPerpendicularCoordForGroupCrossing(e){let t=this.FindPerpendicularSlot(e,0);t!=-1&&this.perpendicularSegmentVector.Item(t).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(e,t){if(t.Obstacle.IsSentinel)return!0;let i=t.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?e.y==i.bottom||e.y==i.top:e.x==i.left||e.x==i.right}CreateScanSegment(e,t,i){let n=this.ScanLineIntersectSide(e,t);return e!=n&&this.parallelSegmentVector.CreateScanSegment(e,n,i,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(e,n)),n}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=or.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=aa;let e=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=st.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(i,n)=>i.compareTo(n);let e=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=st.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}SetVectorsAndCoordMaps(e){e.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(e,t){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let i=1,n={j:0};for(let o of this.parallelSegmentVector.Items())for(;!(!o.CurrentSegment.ContainsPoint(e[i])&&(!this.AddSteinerPointsToInterveningSegments(e[i],t,n,o)||!o.TraverseToSegmentContainingPoint(e[i])));){if(this.AddPointsToCurrentSegmentIntersections(t,n,o),this.GenerateIntersectionsFromVertexPointForCurrentSegment(e[i],o),o.PointIsCurrentEndAndNextStart(e[i])){o.MoveNext();continue}if(++i>=e.length)return}}AddSteinerPointsToInterveningSegments(e,t,i,n){for(;i.j<t.length&&this.currentAxisPointComparer(t[i.j],e)==-1;){if(!n.TraverseToSegmentContainingPoint(t[i.j]))return!1;this.AddPointsToCurrentSegmentIntersections(t,i,n)}return!0}AddPointsToCurrentSegmentIntersections(e,t,i){for(;t.j<e.length&&i.CurrentSegment.ContainsPoint(e[t.j]);t.j++){let n=this.FindPerpendicularSlot(e[t.j],0);this.AddSlotToSegmentIntersections(i,n)}}GenerateIntersectionsFromVertexPointForCurrentSegment(e,t){let i=this.FindPerpendicularSlot(t.CurrentSegment.Start,1),n=this.FindPerpendicularSlot(t.CurrentSegment.End,-1),o=this.FindPerpendicularSlot(e,0);i>=n||(this.AddSlotToSegmentIntersections(t,i),this.AddSlotToSegmentIntersections(t,n),o>i&&o<n&&(this.AddSlotToSegmentIntersections(t,o),this.AddBinaryDivisionSlotsToSegmentIntersections(t,i,o,n)))}FindPerpendicularSlot(e,t){return or.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,e,t)}static FindIntersectingSlot(e,t,i,n){let o=e.GetParallelCoord(i),a=t.get(o);return a!=null?a:n==0?-1:e.FindNearest(o,n)}AddSlotToSegmentIntersections(e,t){let i=this.perpendicularSegmentVector.Item(t);e.CurrentSegment.AddSparseVertexCoord(i.Coord),i.AddPerpendicularCoord(e.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(e,t,i,n){let o=0,a=this.perpendicularSegmentVector.Length-1;for(;a-o>1;){let l=o+Math.floor((a-o)/2);if(i<=l){a=l,i<a&&a<=n&&this.AddSlotToSegmentIntersections(e,a);continue}o=l,i>o&&o>=t&&this.AddSlotToSegmentIntersections(e,o)}}CreateScanSegmentTrees(){or.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),or.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(e,t){for(let i of e.Items())for(let n=i.FirstSegment;n!=null;n=n.NextSegment)n.HasVisibility()&&t.InsertUnique(n)}};var Pr=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof or}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,le.NormalWeight)}FindOrAddEdge(e,t,i){let n=N.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};Pr.GetBrackets(e,t,n,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,i),a}static GetBrackets(e,t,i,n){if(n.splitVertex=t,!Pr.FindBracketingVertices(e,t.point,i,n)){let o={bracketSource:null,bracketTarget:null};Pr.FindBracketingVertices(t,e.point,_.OppositeDir(i),o)&&(n.bracketSource=o.bracketTarget,n.splitVertex=e),n.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,i,n){for(n.bracketSource=e;n.bracketTarget=W.FindAdjacentVertex(n.bracketSource,i),n.bracketTarget!=null;){if(f.closeDistEps(n.bracketTarget.point,t))return!0;if(i!=N.GetDirections(n.bracketTarget.point,t))break;n.bracketSource=n.bracketTarget}return n.bracketTarget!=null}CreateEdge(e,t,i){let n=e,o=t;N.IsPureLower(n.point,o.point)||(n=t,o=e);let a=new Mt(n,o,i);return Ie.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&Ie.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)Ie.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return W.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,i){for(;;){let n=W.FindAdjacentVertex(e,t);if(n==null)break;let o=N.GetDirections(n.point,i);if((_.OppositeDir(t)&o)!=0)return this.VisGraph.FindEdgePP(e.point,n.point);e=n}return null}FindNearestPerpendicularOrContainingEdge(e,t,i){let n;t&N.GetDirections(e.point,i);let o=e,a=n;for(;0!=a;){let u=W.FindAdjacentVertex(o,n);if(u==null||(_.OppositeDir(n)&N.GetDirections(u.point,i))!=0)break;o=u,t&N.GetDirections(o.point,i)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,i),!(l!=null||o==e);)o=W.FindAdjacentVertex(o,_.OppositeDir(n));return l}ConnectVertexToTargetVertex(e,t,i,n){if(f.closeDistEps(e.point,t.point))return;let o=N.GetDirections(e.point,t.point);if(N.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=W.FindBendPointBetween(e.point,t.point,i),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,n),this.FindOrAddEdge(l,t,n)}AddEdgeToTargetEdge(e,t,i){let n=this.VisGraph.FindVertex(i);return n==null&&(n=this.AddVertex(i),this.SplitEdge(t,n)),this.FindOrAddEdgeVV(e,n),n}SplitEdge(e,t){return e==null?null:f.closeDistEps(e.Source.point,t.point)||f.closeDistEps(e.Target.point,t.point)?e:(e instanceof Mt||this.edgesToRestore.push(e),Ie.RemoveEdge(e),(this.IsSparseVg||e.Weight==le.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,i,n,o){let a=N.GetDirections(i.start,i.end);if(a==0)return;let l=W.GetRectangleBound(t,a),u=W.IsVerticalD(a)?E.RoundPoint(new f(e.point.x,l)):E.RoundPoint(new f(l,e.point.y));if(f.closeDistEps(u,e.point)||N.GetDirections(e.point,u)!=a)return;let c=i;N.GetDirections(u,c.end)==a&&(c=O.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,i,n,o)}ExtendEdgeChain(e,t,i,n,o,a){if(N.GetDirections(e.point,i.end)!=t)return;let u=_.RotateLeft(t),c=W.FindAdjacentVertex(e,u);if(c==null&&(u=_.OppositeDir(u),c=W.FindAdjacentVertex(e,u),c==null))return;let h=_.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,i,n,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,i,n,a,d),this.SpliceGroupBoundaryCrossings(o,e,i)}SpliceGroupBoundaryCrossings(e,t,i){if(e==null||e.Count()==0)return;e.Reset();let n=i.start,o=i.end,a=N.GetDirections(n,o);W.IsAscending(a)||(n=i.end,o=i.start,a=_.OppositeDir(a)),t=Pr.TraverseToFirstVertexAtOrAbove(t,n,_.OppositeDir(a));for(let l=t;l!=null;l=W.FindAdjacentVertex(l,a)){let u=N.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();N.ComparePP(c.Location,t.point)>0&&N.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,_.OppositeDir(a)),N.ComparePP(c.Location,t.point)>=0&&N.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,i){let n=e,o=_.OppositeDir(i);for(;;){let a=W.FindAdjacentVertex(n,i);if(a==null||N.GetDirections(a.point,t)==o)break;n=a}return n}SpliceGroupBoundaryCrossing(e,t,i){var o,a;let n=Ln.ToCrossingArray(t.Crossings,i);if(n!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=n[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=n.map(p=>p.Group.InputShape);h.IsPassable=()=>d.some(p=>p.IsTransparent)}}ExtendSpliceWorker(e,t,i,n,o,a,l){let u=W.FindAdjacentVertex(e,i);l.spliceTarget=W.FindAdjacentVertex(u,i);let c={spliceSource:e};for(;Pr.GetNextSpliceSource(c,i,t);){let h=W.FindBendPointBetween(u.point,c.spliceSource.point,_.OppositeDir(i));if(Pr.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=Pr.GetSpliceTarget(c,i,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?le.OverlappedWeight:le.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?le.OverlappedWeight:le.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?le.OverlappedWeight:le.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&N.GetDirections(h,n.end))==0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,i){let n=W.FindAdjacentVertex(e.spliceSource,i);if(n==null)for(n=e.spliceSource;;){if(n=W.FindAdjacentVertex(n,_.OppositeDir(t)),n==null)return!1;let o=W.FindAdjacentVertex(n,i);if(o!=null){n=o;break}}return e.spliceSource=n,!0}static GetSpliceTarget(e,t,i){let n=N.GetDirections(e.spliceSource.point,i),o=n,a=e.spliceSource;for(;o==n&&(e.spliceSource=a,a=W.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(f.closeDistEps(a.point,i)){a=W.FindAdjacentVertex(a,t);break}o=N.GetDirections(a.point,i)}return a}SeeIfSpliceIsStillOverlapped(e,t){let i=this.FindNextEdge(t,_.RotateLeft(e)),n=i==null?!1:le.NormalWeight==i.Weight;return n||(i=this.FindNextEdge(t,_.RotateRight(e)),n=i==null?!1:le.NormalWeight==i.Weight),!n||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(Pr.IsSkippableSpliceSourceEdgeWithNullTarget(W.FindAdjacentEdge(e,t)))return!0;let i=W.FindAdjacentEdge(e,_.OppositeDir(t));return Pr.IsSkippableSpliceSourceEdgeWithNullTarget(i)||Pr.IsReflectionEdge(i)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&$(e.Length,Na.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight==le.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return N.GetDirections(e.start,e.end)==N.GetDirections(e.end,t)}toString(){return Ly.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var Ss=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new je;this.freePointLocationsUsedByRouteEdges=new Me;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new Pr(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let i=E.RoundPoint(t.Location);if(0==v.PointRelativeToCurveLocation(i,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!=t.Curve&&0==v.PointRelativeToCurveLocation(i,t.Curve))return null;let n=new up(t,e);return this.obstaclePortMap.set(t,n),n}FindVertices(e){let t=new Array,i=this.obstaclePortMap.get(e);if(i)if(this.RouteToCenterOfObstacles)t.push(i.CenterVertex);else for(let n of i.PortEntrances){let o=this.VisGraph.FindVertex(n.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(E.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);if(this.AncestorSets.size>0&&i.oport!=null&&n.oport!=null){let l=xn(a,o),u=xn(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,i.oport),this.AddPortToGraph(e.targetPort,n.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let i=this.FindVertices(t),n=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i),n=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i)}ConnectToGraphAtPointsCollinearWithVertices(e,t,i){if(0==t)return;let n=_.OppositeDir(t);for(let o of i){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,n,le.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size==0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size==0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(V.mkPP(e.Location,e.Location),i=>i.IsGroup)).map(i=>i.InputShape))}ActivateAncestors(e,t,i){for(let n of mi(e,t)){let o=i.get(n);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=V.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let i={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(i)){for(let n of i.addedPorts)this.CreateObstaclePort(t.Obstacle,n);for(let n of i.removedPorts)this.RemoveObstaclePort(n);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),i=this.FindObstaclePort(e.targetPort);if(t==null||i==null||t.Obstacle.IsInConvexHull||i.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(i),!t.VisibilityRectangle.intersects(i.VisibilityRectangle)))return null;for(let n of t.PortEntrances)if(!!n.WantVisibilityIntersection)for(let o of i.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=n.IsVertical==o.IsVertical?Ss.GetPathPointsFromOverlappingCollinearVisibility(n,o):Ss.GetPathPointsFromIntersectingVisibility(n,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!W.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||f.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let i=W.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!i||e.HasGroupCrossingBeforePoint(i)||t.HasGroupCrossingBeforePoint(i)?null:[e.UnpaddedBorderIntersect,i,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,i=V.mkPP(E.RoundPoint(e.PortCurve.boundingBox.leftBottom),E.RoundPoint(e.PortCurve.boundingBox.rightTop)),n=E.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!N.Equal(n.y,i.top)&&!N.Equal(n.y,i.bottom)){o=!0;let l=new O(t.left,n.y,t.right,n.y);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new f(Math.min(a.xx0.x,a.xx1.x),n.y);u.x<i.left&&(u=new f(i.left,u.y));let c=new f(Math.max(a.xx0.x,a.xx1.x),n.y);c.x>i.right&&(c=new f(i.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}if(!N.Equal(n.x,i.left)&&!N.Equal(n.x,i.right)){o=!0;let l=new O(n.x,t.bottom,n.x,t.top);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new f(n.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new f(u.x,t.bottom));let c=new f(n.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new f(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}o||this.CreateEntrancesForCornerPort(i,e,n)}GetBorderIntersections(e,t,i,n){let o=v.getAllIntersections(t,i,!0);n.xx0=E.RoundPoint(o[0].x),n.xx1=E.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,i,n,o){let a=N.GetDirections(n,o);N.EqualPP(n,i)||this.CreatePortEntrance(e,t,o,a),N.EqualPP(o,i)||this.CreatePortEntrance(e,t,n,_.OppositeDir(a))}static GetDerivative(e,t){let i=e.PortCurve.closestParameter(t),n=e.PortCurve.derivative(i),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return wt.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(n=n.mul(-1)),n}CreatePortEntrance(e,t,i,n){t.CreatePortEntrance(i,n,this.ObstacleTree);let o=st.GetInstance(n),a=W.GetRectangleBound(e,n)-o.Coord(i);if(a<0&&(a=-a),a>E.intersectionEpsilon){let l=_.VectorDirection(Ss.GetDerivative(t,i)),u;n|_.OppositeDir(n),0!=(n&l)&&(u=_.OppositeDir(u)),t.CreatePortEntrance(i,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,i){let n=1;N.EqualPP(i,e.leftBottom)?n=4:N.EqualPP(i,e.leftTop)?n=8:N.EqualPP(i,e.rightTop)?n=1:N.EqualPP(i,e.rightBottom)&&(n=2),t.CreatePortEntrance(i,n,this.ObstacleTree),t.CreatePortEntrance(i,_.RotateRight(n),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let i={targetVertex:null},n=e.IsOverlapped?le.OverlappedWeight:le.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,n,i)!=null&&e.AddToAdjacentVertex(this.TransUtil,i.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return W.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,i,n){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o)}FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o){let a=W.SortAscending(e,t),l=a[0],u=a[1],c=W.IsVerticalD(i)?this.HScanSegments:this.VScanSegments,h=W.IsAscending(i)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=W.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(W.IsAscending(i)?l:u,h,d,n,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,i,n,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(i),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,i,t,n,a);if(d!=null)return d}else if(N.EqualPP(e,i))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,_.OppositeDir(t.ScanDirection.Dir));let l=N.GetDirections(i,e),u=N.GetDirections(a.segsegVertex.point,e);if(l==u){let d={bracketTarget:null,bracketSource:null};return Pr.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,_.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,_.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(i),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=W.GetEdgeEnd(c,_.OppositeDir(u)),i=W.SegmentIntersectionPPP(e,i,a.segsegVertex.point),N.EqualPP(a.segsegVertex.point,i)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(i),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,n)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,i,n,o){let l=(i.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(i.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,i.LowestVisibilityVertex,i.Weight);let u=W.SegmentsIntersection(i,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(i,o.segsegVertex,i.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),N.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return N.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,n)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,i){return N.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,i):N.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,i):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():V.mkOnPoints([E.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new cp(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=E.RoundPoint(e);let t=this.VisGraph.FindVertex(e),i=this.FindOrCreateFreePoint(e);if(t!=null)return i;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(i),i;let n=null;i.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(i.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};n=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,i.InitialWeight,l)}let a=4;if(n!=null)a=W.EdgeDirectionVE(n),this.ConnectFreePointToLateralEdge(i,_.RotateLeft(a)),this.ConnectFreePointToLateralEdge(i,_.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(i,a),a=_.RotateLeft(a);return i}CreateOutOfBoundsFreePoint(e){let t=e.Point,i=this.graphGenerator.MakeInBoundsLocation(t),n=N.GetDirections(i,t);if(e.OutOfBoundsDirectionFromGraph=n,!N.IsPureDirectionD(n)){e.AddOobEdgesFromGraphCorner(this.TransUtil,i);return}let o=this.VisGraph.FindVertex(i),a=_.OppositeDir(n);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,i,n,le.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=W.FindAdjacentVertex(o,_.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,le.NormalWeight);let u=W.FindAdjacentVertex(o,_.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,le.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let i=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),n=this.FindorCreateNearestPerpEdgePPDN(i,e.Point,t,e.InitialWeight);n!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,n,t,this.portSpliceLimitRectangle)}};var Lt=class extends ae{constructor(e,t,i,n,o){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.UseObstacleRectangles=!1;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=t,this.CornerFitRadius=i,this.BendPenaltyAsAPercentageOfDistance=ri.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new or,this.UseObstacleRectangles=o,this.PortManager=new Ss(this.GraphGenerator),this.AddShapes(e)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(e){this.PortManager.RouteToCenterOfObstacles=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=e}AddEdgeGeometryToRoute(e){f.closeDistEps(E.RoundPoint(e.sourcePort.Location),E.RoundPoint(e.targetPort.Location))?this.selfEdges.push(e):this.EdgesToRoute.push(e)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof or}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.PaddedPolyline)}AddObstacles(e){this.AddShapes(e),this.RebuildTreeAndGraph()}AddShapes(e){for(let t of e)this.AddObstacleWithoutRebuild(t)}AddObstacle(e){this.AddObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}UpdateObstacles(e){for(let t of e)this.UpdateObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}UpdateObstacle(e){this.UpdateObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}RemoveObstacles(e){for(let t of e)this.RemoveObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}RemoveObstacle(e){this.RemoveObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(e)}UpdateObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(e)),this.CreatePaddedObstacle(e)}CreatePaddedObstacle(e){let t=new Ht(e,this.UseObstacleRectangles,this.Padding);this.ShapeToObstacleMap.set(e,t),this.PortManager.CreateObstaclePorts(t)}RemoveObstacleWithoutRebuild(e){let t=this.ShapeToObstacleMap.get(e);this.ShapeToObstacleMap.delete(e),this.PortManager.RemoveObstaclePorts(t)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let e=this.ObsTree.Root!=null,t=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),e&&this.GenerateObstacleTree(),t&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return Lt.constructorC(null)}static constructorC(e){return new Lt([],Lt.DefaultPadding,Lt.DefaultCornerFitRadius,!1,!1)}static constructorI(e){return new Lt(e,Lt.DefaultPadding,Lt.DefaultCornerFitRadius,!1,!1)}static constructorINNB(e,t,i,n){return new Lt(e,t,i,n,!1)}static constructorGNANB(e,t,i,n,o){return this.constructorGNANBB(e,t,i,n,o,!1)}static constructorGNANBB(e,t,i,n,o,a){let l=new Lt(rr.GetShapes(e),i,n,o,a);if(t==null)for(let u of e.edges())l.AddEdgeGeometryToRoute(u);else for(let u of t)l.AddEdgeGeometryToRoute(u);return l}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let e=this.EdgesToRoute.map(t=>new sp(t));this.FillEdgePathsWithShortestPaths(e),this.NudgePaths(e),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let e of this.selfEdges){let t={smoothedPolyline:null};e.curve=Re.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.Padding,2*e.GetMaxArrowheadLength()),t)}}FillEdgePathsWithShortestPaths(e){this.PortManager.BeginRouteEdges();let t=new ps(this.BendPenaltyAsAPercentageOfDistance);for(let i of e)this.AddControlPointsAndGeneratePath(t,i);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(e,t){let i=this.PortManager.GetPortVisibilityIntersection(t.GeomEdge);if(i!=null){this.GeneratePathThroughVisibilityIntersection(t,i);return}this.SpliceVisibilityAndGeneratePath(e,t)}GeneratePathThroughVisibilityIntersection(e,t){e.PathPoints=t}SpliceVisibilityAndGeneratePath(e,t){this.PortManager.AddControlPointsToGraph(t.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(e,t,!1)||this.RetryPathsWithAdditionalGroupsEnabled(e,t),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(e,t,i){let n=this.PortManager.FindVertices(t.GeomEdge.sourcePort),o=this.PortManager.FindVertices(t.GeomEdge.targetPort);return Lt.GetSingleStagePath(t,e,n,o,i)}static GetSingleStagePath(e,t,i,n,o){return e.PathPoints=t.GetPath(i,n),o&&Lt.EnsureNonNullPath(e),e.PathPoints!=null&&e.PathPoints.length>0}static EnsureNonNullPath(e){e.PathPoints==null&&(N.IsPureDirection(e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location)?e.PathPoints=[e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location]:e.PathPoints=[e.GeomEdge.sourcePort.Location,new f(e.GeomEdge.sourcePort.Location.x,e.GeomEdge.targetPort.Location.y),e.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(e,t){(!this.PortManager.SetAllAncestorsActive(t.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(e,t,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(e,t,!0))}NudgePaths(e){let t=this.ObsTree.SpatialAncestorsAdjusted?Fe.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;He.NudgePaths(e,this.CornerFitRadius,this.PaddedObstacles,t,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(e){this.removeStaircases=e}FinaliseEdgeGeometries(){for(let e of this.EdgesToRoute.concat(this.selfEdges)){if(e.curve==null)continue;e.curve instanceof q&&(e.curve=Lt.FitArcsIntoCorners(this.CornerFitRadius,Array.from(e.curve))),Lt.CalculateArrowheads(e)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(e){Ft.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=Fe.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(e){this.GraphGenerator.Clear(),this.ClearShortestPaths(),e?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let e of this.EdgesToRoute)e.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(e,t){let i=Lt.GetFittedArcSegs(e,t),n=new v,o=null;for(let a of i){let l=Lt.EllipseIsAlmostLineSegment(a);o!=null?l?v.continueWithLineSegmentP(n,Lt.CornerPoint(a)):(v.continueWithLineSegmentP(n,a.start),n.addSegment(a)):l?v.addLineSegment(n,t[0],Lt.CornerPoint(a)):(v.addLineSegment(n,t[0],a.start),n.addSegment(a)),o=a}return n.segs.length>0?v.continueWithLineSegmentP(n,t[t.length-1]):v.addLineSegment(n,t[0],t[t.length-1]),n}static CornerPoint(e){return e.center.add(e.aAxis.add(e.bAxis))}static EllipseIsAlmostLineSegment(e){return e.aAxis.lengthSquared<1e-4||e.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(e,t){let i=t[1].sub(t[0]),n=i.normalize(),o=Math.min(e,i.length/2);for(let a=1;a<t.length-1;a++){i=t[a+1].sub(t[a]);let l=i.length;if(l<E.intersectionEpsilon){yield new re(0,0,new f(0,0),new f(0,0),t[a]);continue}let u=i.div(l);Math.abs(u.dot(n))>.9&&(yield new re(0,0,new f(0,0),new f(0,0),t[a]));let c=Math.min(e,i.length/2),h=u.mul(-c),d=n.mul(o);yield new re(0,Math.PI/2,h,d,t[a].sub(d.add(h))),n=u,o=c}}},Ga=Lt;Ga.DefaultPadding=1,Ga.DefaultCornerFitRadius=3;var nu=class extends ae{constructor(e,t,i){super(null);this.graph=e,this.source=t,this.length=i}get Result(){return this.result}run(){let e=new zt((n,o)=>n-o),t=new Map;for(let n of this.graph.shallowNodes()){let o=n==this.source?0:Number.POSITIVE_INFINITY;e.Enqueue(n,o),t.set(n,o)}for(;e.count>0;){let n={priority:0},o=e.DequeueAndGetPriority(n);t.set(o,n.priority);let a=t.get(o);for(let l of o.inEdges()){let u=l.source,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}for(let l of o.outEdges()){let u=l.target,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}}this.result=new Array(this.graph.shallowNodeCount);let i=0;for(let n of this.graph.shallowNodes()){let o=t.get(n);o!=null?this.result[i++]=o:this.result[i++]=Number.POSITIVE_INFINITY}}};var ou=class extends ae{get Result(){return this.result}set Result(e){this.result=e}constructor(e,t){super(null);this.graph=e,this.length=t}run(){this.result=new Array(this.graph.shallowNodeCount);let e=0;for(let t of this.graph.shallowNodes()){let i=new nu(this.graph,t,this.length);i.run(),this.Result[e++]=i.Result}}static Stress(e,t){let i=0;if(e.edgeCount==0)return i;let n=new ou(e,t);n.run();let o=n.Result,a=0;for(let u of e.edges())a+=t(u);a/=e.edgeCount;let l=0;for(let u of e.shallowNodes()){let c=0;for(let h of e.shallowNodes()){if(l!=c){let d=u.center.sub(h.center).length,p=a*o[l][c],y=p-d;i+=y*y/(p*p)}c++}l++}return i}};var pp=class extends ae{get Result(){return this.result}constructor(e,t,i){super(null);this.graph=e,this.pivotArray=t,this.length=i}run(){this.result=new Array(this.pivotArray.length);let e=Array.from(this.graph.shallowNodes()),t=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),i=e[0];this.pivotArray[0]=0;for(let n=0;;n++){let o=new nu(this.graph,i,this.length);if(o.run(),this.Result[n]=o.Result,n+1<this.pivotArray.length){let a=0;for(let l=0;l<this.Result[n].length;l++)t[l]=Math.min(t[l],this.Result[n][l]),t[l]>t[a]&&(a=l);i=e[a],this.pivotArray[n+1]=a}else break}}};var mp=class{static Rotate(e,t,i){let n=Math.sin(i*(Math.PI/180)),o=Math.cos(i*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+n*t[a];t[a]=o*t[a]-n*e[a],e[a]=l}}};var Ve=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),i=new Array(e[0].length).fill(0),n=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],i[a]+=e[o][a],n+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)i[o]/=e[0].length;n/=e.length,n/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+i[a]-n}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[0].length;i++)e[t][i]=Math.pow(e[t][i],2)}static Multiply(e,t){for(let i=0;i<e.length;i++)for(let n=0;n<e[0].length;n++)e[i][n]*=t}static MultiplyX(e,t){if(e[0].length!=t.length)return null;let i=new Array(t.length).fill(0);for(let n=0;n<e.length;n++)for(let o=0;o<e[0].length;o++)i[n]+=e[n][o]*t[o];return i}static Norm(e){let t=0;for(let i=0;i<e.length;i++)t+=Math.pow(e[i],2);return Math.sqrt(t)}static Normalize(e){let t=Ve.Norm(e);if(t<=0)return 0;for(let i=0;i<e.length;i++)e[i]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let i=0;i<e;i++)t[i]=Xl();return Ve.Normalize(t),t}static SpectralDecomposition(e,t){Ve.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,i,n){let o=e[0].length;t.u1=Ve.RandomUnitLengthVector(o),t.lambda1=0,t.u2=Ve.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-n;for(let u=0;u<i&&a<l;u++){let c=Ve.MultiplyX(e,t.u1),h=Ve.MultiplyX(e,t.u2);t.lambda1=Ve.Normalize(c),t.lambda2=Ve.Normalize(h),Ve.MakeOrthogonal(h,c),Ve.Normalize(h),a=Math.min(Ve.DotProduct(t.u1,c),Ve.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!=t.length)return 0;let i=0;for(let n=0;n<e.length;n++)i+=e[n]*t[n];return i}static MakeOrthogonal(e,t){if(e.length!=t.length)return;let i=Ve.DotProduct(e,t)/Ve.DotProduct(t,t);for(let n=0;n<e.length;n++)e[n]-=i*t[n]}static ClassicalScaling(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=e[n].slice();Ve.SquareEntries(i),Ve.DoubleCenter(i),Ve.Multiply(i,-.5),Ve.SpectralDecomposition(i,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let n=0;n<t.u1.length;n++)t.u1[n]*=t.lambda1,t.u2[n]*=t.lambda2}static DistanceScalingSubset(e,t,i,n,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]==0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!=d&&(c[h]+=n[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let p=0,y=0;for(let x=0;x<a;x++)if(d!=x){let A=Math.sqrt(Math.pow(t[u[d]]-t[x],2)+Math.pow(i[u[d]]-i[x],2));A>0&&(A=1/A),p+=n[d][x]*(t[x]+e[d][x]*(t[u[d]]-t[x])*A),y+=n[d][x]*(i[x]+e[d][x]*(i[u[d]]-i[x])*A)}t[u[d]]=p/c[d],i[u[d]]=y/c[d]}}static DistanceScaling(e,t,i,n,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!=c&&(l[u]+=n[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let p=0;p<a;p++)if(c!=p){let y=Math.sqrt(Math.pow(t[c]-t[p],2)+Math.pow(i[c]-i[p],2));y>0&&(y=1/y),h+=n[c][p]*(t[p]+e[c][p]*(t[c]-t[p])*y),d+=n[c][p]*(i[p]+e[c][p]*(i[c]-i[p])*y)}t[c]=h/l[c],i[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e[n].length).fill(0);for(let o=0;o<e[n].length;o++)e[n][o]>0&&(i[n][o]=Math.pow(e[n][o],t))}return i}static EuclideanDistanceMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e.length);for(let o=0;o<e.length;o++)i[n][o]=Math.sqrt(Math.pow(e[n]-e[o],2)+Math.pow(t[n]-t[o],2))}return i}static LandmarkClassicalScaling(e,t,i){let n=new Array(e.length);for(let l=0;l<e.length;l++){n[l]=new Array(e.length);for(let u=0;u<e.length;u++)n[l][u]=e[l][i[u]]}Ve.SquareEntries(n);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=n[l][u];o[l]/=e.length}Ve.DoubleCenter(n),Ve.Multiply(n,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};Ve.SpectralDecomposition(n,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<n.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var Ry=Q(Pt());var bp=class{constructor(e,t){this.Constrained=!1;this.Capacity=1e6;ke.AbovePP(e.point,t.point)==1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e==this.upperSite||e==this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle==e?this.cwTriangle:this.ccwTriangle}toString(){return Ry.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite==e?this.lowerSite:this.upperSite}};var Es=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let i=new Es(e);return i.Owner=t,i}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite==e)return t}return null}AddInEdge(e){this.InEdges==null&&(this.InEdges=new Array),this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let i=t.upperSite==this?t.CcwTriangle:t.CwTriangle;if(i==null){t=null;break}yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+2)}while(t!=e);if(t!=e){t=e;do{let i=t.upperSite==this?t.CwTriangle:t.CcwTriangle;if(i==null)break;yield i,t=i.TriEdges.getItem(i.TriEdges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var yp=Q(ei());var Bn=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite==e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var Th=class{has(e){return e==this.item0||e==this.item1||e==this.item2}index(e){return e==this.item0?0:e==this.item1?1:e==this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var yr=class{constructor(){this.TriEdges=new Th;this.Sites=new Th}static mkSSSD(e,t,i,n){let o=f.getTriangleOrientation(e.point,t.point,i.point),a=new yr;switch(o){case 1:a.FillCcwTriangle(e,t,i,n);break;case 0:a.FillCcwTriangle(e,i,t,n);break;default:throw new Error}return a}static mkSED(e,t,i){let n=new yr;switch(f.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=n,n.Sites.setItem(0,t.upperSite),n.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=n,n.Sites.setItem(0,t.lowerSite),n.Sites.setItem(1,t.upperSite);break;default:throw new Error}return n.TriEdges.setItem(0,t),n.Sites.setItem(2,e),n.CreateEdge(1,i),n.CreateEdge(2,i),n}static mkSSSEE(e,t,i,n,o,a){let l=yr.mkSSSD(e,t,i,a);return l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e==t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,i,n){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,i);for(let o=0;o<3;o++)this.CreateEdge(o,n)}CreateEdge(e,t){let i=this.Sites.getItem(e),n=this.Sites.getItem(e+1),o=t(i,n);this.TriEdges.setItem(e,o),this.BindEdgeToTriangle(i,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.TriEdges.getItem(t+1)}OppositeSite(e){let t=this.TriEdges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=V.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,i,n,o,a){let l=new yr;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,i),l.TriEdges.setItem(0,n),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var Pp=class{constructor(e,t,i,n,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.leftPolygon=n,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(f.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite==this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,i=(o=t.CcwTriangle)!=null?o:t.CwTriangle,n=i.TriEdges.index(t);for(let a=1;a<=2;a++){let l=i.TriEdges.getItem(a+n),u=Jt.sign(f.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(Jt.sign(f.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=i,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.TriEdges)if(t.CcwTriangle==null&&t.CwTriangle==null){let i=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,n=St.FindNodeInFrontBySite(this.front,i);n.item.Edge==t&&this.elementsToBeRemovedFromFront.push(n.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle==this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var i,n;let e=(i=this.piercedEdge.CwTriangle)!=null?i:this.piercedEdge.CcwTriangle,t=e.TriEdges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.TriEdges.getItem(o+t),l=Jt.sign(f.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(Jt.sign(f.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=St.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((n=a.CwTriangle)!=null?n:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.TriEdges)t.CwTriangle==e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(f.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite==this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!=this.b&&(t.length==0||t[t.length-1]!=e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=St.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(f.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(f.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let i of this.a.Edges){let n=i.CcwTriangle;if(n==null||f.pointToTheLeftOfLine(this.b.point,i.lowerSite.point,i.upperSite.point))continue;let o=n.TriEdges.index(i),a=n.Sites.getItem(o+2);if(f.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,i.upperSite.point)){this.piercedEdge=n.TriEdges.getItem(o+1),this.piercedTriangle=n;break}}}};var su=class{constructor(e,t,i,n){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=i,this.createEdgeDelegate=n}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let i of t.TriEdges)(i.CwTriangle==null||i.CcwTriangle==null)&&e.add(i);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new Bn(t,e))}TriangulatePolygon0(e,t,i,n){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,i,n)}TriangulatePolygon1(e,t,i,n,o,a){let l=i[e],u=e;for(let h=e+1;h<=t;h++){let d=i[h];su.LocalInCircle(d,n,o,l,a)&&(u=h,l=d)}let c=yr.mkSSSD(n,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,i,n,l,a),u<t&&this.TriangulatePolygon1(u+1,t,i,l,o,a)}static LocalInCircle(e,t,i,n,o){return o?Ih(e,t,n,i):Ih(e,t,i,n)}TraceEdgeThroughTriangles(){new Pp(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var wh=class{constructor(e){this.Edge=e}};var St=class extends ae{constructor(e,t,i,n){super(null);this.front=new Ke((e,t)=>e.x-t.x);this.triangles=new Set;if(this.listOfSites=e,this.listOfSites.length==0)return;this.p_1=t,this.p_2=i,this.createEdgeDelegate=n;let o=yr.mkSSSD(t,i,this.listOfSites[0],n);this.triangles.add(o),this.front.insert(new Bn(t,o.TriEdges.getItem(2))),this.front.insert(new Bn(this.listOfSites[0],o.TriEdges.getItem(1)))}run(){if(this.listOfSites.length!=0){for(let e=1;e<this.listOfSites.length;e++)this.ProcessSite(this.listOfSites[e]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let e=this.CreateDoubleLinkedListOfPerimeter();do{let t=this.FindConcaveEdge(e);if(t==null)return;e=this.ShortcutTwoListElements(t)}while(!0)}FindConcaveEdge(e){let t=e,i;do{if(i=t.Next,f.getTriangleOrientation(t.Start.point,t.End.point,i.End.point)==1)return t;t=i}while(i!=e);return null}static FindPivot(e){let t=e,i=e;do i=i.Next,(i.Start.point.x<t.Start.point.x||i.Start.point.x==t.Start.point.x&&i.Start.point.y<t.Start.point.y)&&(t=i);while(i!=e);return t}FindFirsePerimeterEdge(){for(let e of this.triangles)for(let t of e.TriEdges)if(t.GetOtherTriangle_T(e)==null)return t;return null}CreateDoubleLinkedListOfPerimeter(){let e=this.FindFirsePerimeterEdge(),t=e,i=null,n,o=null,a=new Array;do n=St.CreatePerimeterElementFromEdge(t),a.push(O.mkPP(n.Start.point,n.End.point)),t=St.FindNextEdgeOnPerimeter(t),o!=null?(n.Prev=o,o.Next=n):i=n,o=n;while(t!=e);return i.Prev=n,n.Next=i,i}static FindNextEdgeOnPerimeter(e){var i;let t=(i=e.CwTriangle)!=null?i:e.CcwTriangle;for(e=t.TriEdges.getItem(t.TriEdges.index(e)+2);e.CwTriangle!=null&&e.CcwTriangle!=null;)t=e.GetOtherTriangle_T(t),e=t.TriEdges.getItem(t.TriEdges.index(e)+2);return e}static CreatePerimeterElementFromEdge(e){let t=new wh(e);return e.CwTriangle!=null?(t.Start=e.upperSite,t.End=e.lowerSite):(t.End=e.upperSite,t.Start=e.lowerSite),t}RemoveP1AndP2Triangles(){let e=new Set;for(let t of this.triangles)(t.Sites.has(this.p_1)||t.Sites.has(this.p_2))&&e.add(t);for(let t of e)St.RemoveTriangleWithEdges(this.triangles,t)}static RemoveTriangleWithEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle==t?i.CwTriangle=null:i.CcwTriangle=null,i.CwTriangle==null&&i.CcwTriangle==null&&Sp(i.upperSite.Edges,i)}static RemoveTriangleButLeaveEdges(e,t){e.delete(t);for(let i of t.TriEdges)i.CwTriangle==t?i.CwTriangle=null:i.CcwTriangle=null}ProcessSite(e){this.PointEvent(e);for(let t=0;t<e.Edges.length;t++){let i=e.Edges[t];i.Constrained&&this.EdgeEvent(i)}}EdgeEvent(e){if(St.EdgeIsProcessed(e))return;new su(e,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(e){return e.CwTriangle!=null||e.CcwTriangle!=null}ShowFrontWithSite(e,t=null){let i=new Array;if(e.Edges!=null)for(let n of e.Edges)i.push(Z.mkDebugCurveTWCI(200,.8,n.Constrained?"Pink":"Brown",O.mkPP(n.upperSite.point,n.lowerSite.point)));i.push(Z.mkDebugCurveTWCI(200,1,"Brown",re.mkFullEllipseNNP(.5,.5,e.point)));for(let n of this.triangles)for(let o=0;o<3;o++){let a=n.TriEdges.getItem(o);i.push(Z.mkDebugCurveTWCI(a.Constrained?155:100,a.Constrained?.8:.4,a.Constrained?"Pink":"Navy",O.mkPP(a.upperSite.point,a.lowerSite.point)))}if(t!=null)for(let n of t)i.push(Z.mkDebugCurveTWCI(100,.5,"Red",n));for(let n of this.front)i.push(Z.mkDebugCurveTWCI(100,5.5,"Green",O.mkPP(n.Edge.upperSite.point,n.Edge.lowerSite.point)))}Show(e){St.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],e)}static ShowCdt(e,t,i,n,o,a){let l=new Array;if(i!=null)for(let u of i)l.push(Z.mkDebugCurveTWCI(200,.1,"Red",u));if(n!=null)for(let u of n)l.push(Z.mkDebugCurveTWCI(200,.1,"Blue",u));if(t!=null)for(let u of t)l.push(Z.mkDebugCurveTWCI(200,.1,"Green",O.mkPP(u.Edge.upperSite.point,u.Edge.lowerSite.point)));for(let u of e)for(let c=0;c<3;c++){let h=u.TriEdges.getItem(c);l.push(St.GetDebugCurveOfCdtEdge(h))}l=l.concat(o)}static GetDebugCurveOfCdtEdge(e){return e.CcwTriangle==null||e.CwTriangle==null?Z.mkDebugCurveTWCI(255,.5,e.Constrained?"Brown":"Black",O.mkPP(e.upperSite.point,e.lowerSite.point)):Z.mkDebugCurveTWCI(200,e.Constrained?.8:.2,e.Constrained?"Pink":"Navy",O.mkPP(e.upperSite.point,e.lowerSite.point))}PointEvent(e){let t=this.ProjectToFront(e),i={rightSite:null},n=t.item.x+E.distanceEpsilon<e.point.x?this.MiddleCase(e,t,i):this.LeftCase(e,t,i),o=this.InsertSiteIntoFront(n,e,i.rightSite);this.TriangulateEmptySpaceToTheRight(o),o=St.FindNodeInFrontBySite(this.front,n),this.TriangulateEmptySpaceToTheLeft(o)}LeftCase(e,t,i){let n=t.item;this.InsertAndLegalizeTriangle(e,n);let o=this.front.previous(t),a=o.item.LeftSite;i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,o.item),this.front.deleteNodeInternal(o);let l=this.front.remove(n);return a}MiddleCase(e,t,i){let n=t.item.LeftSite;return i.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,t.item),this.front.deleteNodeInternal(t),n}TriangulateEmptySpaceToTheLeft(e){let t=e.item.RightSite,i=this.front.previous(e);for(;i!=null;){let n=i.item,o=n.LeftSite,a=n.RightSite;if(a.point.sub(t.point).dot(o.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(i,e),i=this.front.previous(e);else{this.TryTriangulateBasinToTheLeft(e);break}}}ShortcutTwoListElements(e){var a;let t=e.Next,i=yr.mkSSSEE(e.Start,e.End,t.End,e.Edge,t.Edge,this.createEdgeDelegate);this.triangles.add(i);let n=i.TriEdges.getItem(2);this.LegalizeEdge(e.Start,i.OppositeEdge(e.Start)),i=(a=n.CcwTriangle)!=null?a:n.CwTriangle,this.LegalizeEdge(t.End,i.OppositeEdge(t.End));let o=new wh(n);return o.Start=e.Start,o.End=t.End,e.Prev.Next=o,o.Prev=e.Prev,o.Next=t.Next,t.Next.Prev=o,o}ShortcutTwoFrontElements(e,t){var l;let i=e.item,n=t.item,o=yr.mkSSSEED(i.LeftSite,i.RightSite,n.RightSite,i.Edge,n.Edge,this.createEdgeDelegate);this.triangles.add(o),this.front.deleteNodeInternal(e),this.front.remove(n);let a=o.TriEdges.getItem(2);return this.LegalizeEdge(i.LeftSite,o.OppositeEdge(i.LeftSite)),o=(l=a.CcwTriangle)!=null?l:a.CwTriangle,this.LegalizeEdge(n.RightSite,o.OppositeEdge(n.RightSite)),this.front.insert(new Bn(i.LeftSite,a))}TryTriangulateBasinToTheLeft(e){if(!St.DropsSharpEnoughToTheLeft(e.item))return;let t=new yp.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=St.FindNodeInFrontBySite(this.front,i);let n=this.front.previous(e);if(n==null)return;if(f.getTriangleOrientation(n.item.LeftSite.point,e.item.LeftSite.point,e.item.RightSite.point)==1)t.push(n.item.LeftSite),this.ShortcutTwoFrontElements(n,e);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(n.item.LeftSite);else{if(n.item.LeftSite.point.y<=n.item.RightSite.point.y)return;t.push(n.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(e){let t=e.Edge;if(e.RightSite!=t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x>=.5*i.y}InsertSiteIntoFront(e,t,i){let n=null,o=null;for(let a of t.Edges)if(o==null&&a.lowerSite==e&&(o=a),n==null&&a.lowerSite==i&&(n=a),o!=null&&n!=null)break;return this.front.insert(new Bn(e,o)),this.front.insert(new Bn(t,n))}TriangulateEmptySpaceToTheRight(e){let i=e.item.LeftSite.point,n=this.front.next(e);for(;n!=null;){let o=n.item,a=o.LeftSite,l=o.RightSite;if(a.point.sub(i).dot(l.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(e,n),n=this.front.next(e);else{this.TryTriangulateBasinToTheRight(e);break}}}TryTriangulateBasinToTheRight(e){if(!St.DropsSharpEnoughToTheRight(e.item))return;let t=new yp.Stack;for(t.push(e.item.LeftSite);;){let i=t.pop();e=St.FindNodeInFrontBySite(this.front,i);let n=this.front.next(e);if(n==null)return;if(f.getTriangleOrientation(e.item.LeftSite.point,e.item.RightSite.point,n.item.RightSite.point)==1)this.ShortcutTwoFrontElements(e,n),t.push(i);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(e.item.RightSite);else{if(n.item.LeftSite.point.y>=n.item.RightSite.point.y)return;t.push(e.item.RightSite)}}}static DropsSharpEnoughToTheRight(e){let t=e.Edge;if(e.LeftSite!=t.upperSite)return!1;let i=t.lowerSite.point.sub(t.upperSite.point);return i.x<=-.5*i.y}static FindNodeInFrontBySite(e,t){return e.findLast(i=>i.LeftSite.point.x<=t.point.x)}InsertAndLegalizeTriangle(e,t){var i;if(f.getTriangleOrientation(e.point,t.LeftSite.point,t.RightSite.point)!=2){let n=yr.mkSED(e,t.Edge,this.createEdgeDelegate);this.triangles.add(n),this.LegalizeEdge(e,n.TriEdges.getItem(0))}else{let n=t.Edge;Sp(n.upperSite.Edges,n);let o=(i=n.CcwTriangle)!=null?i:n.CwTriangle,a=o.OppositeSite(n);St.RemoveTriangleButLeaveEdges(this.triangles,o),o=yr.mkSSSD(t.LeftSite,a,e,this.createEdgeDelegate);let l=yr.mkSSSD(t.RightSite,a,e,this.createEdgeDelegate);this.triangles.add(o),this.triangles.add(l),this.LegalizeEdge(e,o.OppositeEdge(e)),this.LegalizeEdge(e,l.OppositeEdge(e))}}LegalizeEdge(e,t){t.Constrained||t.CcwTriangle==null||t.CwTriangle==null||(t.CcwTriangle.Contains(e)?this.LegalizeEdgeForOtherCwTriangle(e,t):this.LegalizeEdgeForOtherCcwTriangle(e,t))}LegalizeEdgeForOtherCwTriangle(e,t){let i=t.CwTriangle.TriEdges.index(t);if(Oy(e,t.upperSite,t.CwTriangle.Sites.getItem(i+2),t.lowerSite)){let n=By(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}LegalizeEdgeForOtherCcwTriangle(e,t){let i=t.CcwTriangle.TriEdges.index(t);if(Oy(e,t.lowerSite,t.CcwTriangle.Sites.getItem(i+2),t.upperSite)){let n=By(e,t);this.LegalizeEdge(e,n.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,n.CcwTriangle.OppositeEdge(e))}}ProjectToFront(e){return this.front.findLast(t=>t.x<=e.point.x)}};function Sp(s,e){if(s.length==0)return;let t=s.findIndex(i=>e==i);t>=0&&(t!=s.length-1&&(s[t]=s[s.length-1]),s.pop())}function Oy(s,e,t,i){return yw(s,e,t,i)&&Ih(s,e,t,i)}function yw(s,e,t,i){return f.getTriangleOrientation(e.point,s.point,t.point)==0&&f.getTriangleOrientation(t.point,s.point,i.point)==0}function Ih(s,e,t,i){let n=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=i.point.x-s.point.x,c=i.point.y-s.point.y,h=n*n+o*o,d=a*a+l*l,p=u*u+c*c;return n*(l*p-c*d)-a*(o*p-c*h)+u*(o*d-l*h)>E.tolerance}function By(s,e){let t,i;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,i=e.CwTriangle):(t=e.CwTriangle,i=e.CcwTriangle);let n=t.TriEdges.index(e),o=i.TriEdges.index(e),a=i.Sites.getItem(o+2),l=t.TriEdges.getItem(n+1),u=i.TriEdges.getItem(o+1),c=ke.GetOrCreateEdge(s,a);return t.Sites.setItem(n+1,a),t.TriEdges.setItem(n,u),t.TriEdges.setItem(n+1,c),i.Sites.setItem(o+1,s),i.TriEdges.setItem(o,l),i.TriEdges.setItem(o+1,c),u.lowerSite==a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite==s?l.CcwTriangle=i:l.CwTriangle=i,c.upperSite==s?(c.CcwTriangle=i,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=i),Sp(e.upperSite.Edges,e),c}var ke=class extends ae{constructor(e,t,i){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new je;this.cdtTree=null;this.isolatedSites=e,this.obstacles=t,this.isolatedSegments=i}static constructor_(e){let t=new ke(null,null,null);return t.isolatedSitesWithObject=e,t}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let e of this.isolatedSitesWithObject)this.AddSite(e[0],e[1]);if(this.isolatedSites!=null)for(let e of this.isolatedSites)this.AddSite(e,null);if(this.obstacles!=null)for(let e of this.obstacles)this.AddPolylineToAllInputSites(e);if(this.isolatedSegments!=null)for(let e of this.isolatedSegments)this.AddConstrainedEdge(e.A,e.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(e,t){let i;return(i=this.PointsToSites.get(e))?i.Owner=t:(i=Es.mkSO(e,t),this.PointsToSites.set(e,i)),i}AddP1AndP2(){let e=V.mkEmpty();for(let n of this.PointsToSites.keys())e.add(n);let t=Math.max(e.width/3,1),i=Math.max(e.height/3,1);this.P1=new Es(e.leftBottom.add(new f(-t,-i))),this.P2=new Es(e.rightBottom.add(new f(t,-i)))}AddPolylineToAllInputSites(e){for(let t=e.startPoint;t.next!=null;t=t.next)this.AddConstrainedEdge(t.point,t.next.point,e);e.closed&&this.AddConstrainedEdge(e.endPoint.point,e.startPoint.point,e)}AddConstrainedEdge(e,t,i){let n=ke.AbovePP(e,t),o,a;n>0?(o=this.AddSite(e,i),a=this.AddSite(t,i)):(o=this.AddSite(t,i),a=this.AddSite(e,i));let l=ke.CreateEdgeOnOrderedCouple(o,a);l.Constrained=!0}static GetOrCreateEdge(e,t){if(ke.AboveCC(e,t)==1){let i=e.EdgeBetweenUpperSiteAndLowerSite(t);return i!=null?i:ke.CreateEdgeOnOrderedCouple(e,t)}else{let i=t.EdgeBetweenUpperSiteAndLowerSite(e);return i!=null?i:ke.CreateEdgeOnOrderedCouple(t,e)}}static CreateEdgeOnOrderedCouple(e,t){return new bp(e,t)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new St(this.allInputSites,this.P1,this.P2,ke.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(ke.OnComparison)}static OnComparison(e,t){return ke.AboveCC(e,t)}static AbovePP(e,t){let i=e.y-t.y;return i>0?1:i<0?-1:(i=e.x-t.x,i>0?-1:i<0?1:0)}static AboveCC(e,t){return ke.AbovePP(e.point,t.point)}RestoreEdgeCapacities(){for(let e of this.allInputSites)for(let t of e.Edges)t.Constrained||(t.ResidualCapacity=t.Capacity)}SetInEdges(){for(let e of this.PointsToSites.values())for(let t of e.Edges)t.lowerSite.AddInEdge(t)}FindSite(e){return this.PointsToSites.get(e)}static PointIsInsideOfTriangle(e,t){for(let i=0;i<3;i++){let n=t.Sites.getItem(i).point,o=t.Sites.getItem(i+1).point;if(f.signedDoubledTriangleArea(e,n,o)<E.distanceEpsilon*-1)return!1}return!0}GetCdtTree(){return this.cdtTree==null&&(this.cdtTree=Oe(Array.from(this.GetTriangles().values()).map(e=>We(e,e.BoundingBox())))),this.cdtTree}EdgeIsCorrect(e){let t=e.upperSite,i=!1;for(let o of t.Edges)if(o==e){i=!0;break}return i?this.PointsToSites.get(t.point)==t:!1}};var xs=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,i=this.clone();return i.add_d(t.start),i.add_d(t.end),i}clone(){return new xs(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new xs(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let i=new xs(e.start,e.end);return i.add_d(t.start),i.add_d(t.end),i}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+E.distanceEpsilon?!1:!(e.end<this.start-E.distanceEpsilon)}};var au=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let i=this.heapSize;for(this._priors[e]=t,this.PutAtI(i,e);i>1&&this._priors[this._heap[i>>1]]>t;)this.SwapWithParent(i),i>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize==0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this._priors[this._heap[n]]<this._priors[this._heap[t]]&&(i=n);let o=n+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[i]]&&(i=o),i!=t)this.SwapWithParent(i);else break;t=i}}return this.heapSize--,e}IsEmpty(){return this.heapSize==0}DecreasePriority(e,t){this._priors[e]=t;let i=this._reverse_heap[e];for(;i>1&&this._priors[this._heap[i]]<this._priors[this._heap[i>>1]];){this.SwapWithParent(i);i>>=1}}};var Ep=class{constructor(e,t,i,n){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=i,this._forLayers=n,this._q=new au(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=ki([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let i of this._intervalTree.GetAllIntersecting(t)){let n=Xr.GetIdealEdge(e,i,this._nodePositions[e],this._nodePositions[i],this._nodeSizes);if(n.overlapFactor<=1)return;this._proximityEdges.push(n),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,i=this._nodePositions[e].x;return new xs(i-t,i+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,i=this._nodePositions[e].y;this._q.Enqueue(e,i-t),this._q.Enqueue(this._nodeSizes.length+e,i+t)}}};var Lh=class{constructor(e,t,i){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=i,this.q=new au(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),i=this.hedgehog.get(t);this.treeNodes.add(t),e.push(i),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let i=t.target;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let i=t.source;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var lu=class{static GetMst(e,t){if(e.length==0)return null;let i=e.map(u=>new ee(u.source,u.target)),n=i.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new gi(n+1);for(let u=0;u<e.length;u++)o.setPair(i[u],e[u]);let a=Zt(i,t);return new Lh(a,u=>o.get(u.source,u.target).weight,i[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let i=Array.from(e.PointsToSites.values()),n=new Map;for(let u=0;u<i.length;u++)n.set(i[u],u);let o=lu.GetEdges(i,n),a=Vc(Array.from(o.keys()));return new Lh(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let i=new gi(e.length);for(let n=0;n<e.length;n++){let o=e[n],a=t.get(o);for(let l of o.Edges)i.set(a,t.get(l.lowerSite),l)}return i}};var uu=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new uu;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var Xr=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let i=new uu;i.RandomizeAllPointsOnStart=!0,i.NodeSeparation=t,new Xr(i,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(Sw(this._settings,this._nodes,e),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!=1&&this._nodes.length==2){let e=this._nodes[0],t=this._nodes[1];f.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new f(.001,0)));let i=this.GetIdealDistanceBetweenTwoNodes(e,t),n=f.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(i/a)),e.center=n.add(o),t.center=n.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let i=e.center.sub(t.center),n=Math.abs(i.x),o=Math.abs(i.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return n>E.tolerance&&(u=a/n),o>E.tolerance&&(c=l/o),Math.min(u,c)*i.length}static AvgEdgeLength(e){let t=0,i=0;for(let n of e)for(let o of n.outEdges())i+=n.center.sub(o.target.center).length,t++;return t>0?i/t:1}OneIteration(e,t,i){let n=new Array;for(let h=0;h<e.length;h++)n.push([e[h],h]);let o=ke.constructor_(n);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let p=d.upperSite.point,y=d.lowerSite.point,x=a.get(d.upperSite),A=a.get(d.lowerSite),T=Xr.GetIdealEdge(x,A,p,y,t);u.push(T),T.overlapFactor>1&&l++}if(l==0||i){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l==0&&h==0||l==0&&!i)return!1}let c=lu.GetMst(u,e.length);return Xr.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,i){return new Ep(e,t,i,this._overlapForLayers).Run()}static GetIdealEdge(e,t,i,n,o){let a={overlapFactor:0},l=Xr.GetIdealEdgeLength(e,t,i,n,o,a),u=i.sub(n).length,c=V.mkSizeCenter(o[e],i),h=V.mkSizeCenter(o[t],n),d=a.overlapFactor>1?u-l:Xr.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,i,n,o,a){let l=i.sub(n),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,p=(o[e].height+o[t].height)/2;if(c>=d||h>=p)return a.overlapFactor=1,l.length;let y,x=1e-10;if(c>x)h>x?y=Math.min(d/c,p/h):y=d/c;else if(h>x)y=p/h;else return a.overlapFactor=2,Math.sqrt(d*d+p*p)/4;return y=Math.max(y,1.001),a.overlapFactor=y,y*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let i=0,n=0;return(e.right<t.left||t.right<e.left)&&(n=e.left-t.right),e.top<t.bottom?i=t.bottom-e.top:t.top<e.bottom&&(i=e.bottom-t.top),Math.sqrt(n*n+i*i)}static MoveNodePositions(e,t,i){let n=t.map(a=>a.clone()),o=new Set;o.add(i);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?Xr.MoveNode(l.source,l.target,n,t,o,l.idealDistance):Xr.MoveNode(l.target,l.source,n,t,o,l.idealDistance)}}static MoveNode(e,t,i,n,o,a){let l=i[t].sub(i[e]);l=l.mul(a/l.length+.01),n[t]=n[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function Sw(s,e,t){t.nodePositions=e.map(i=>i.center),t.nodeSizes=e.map(i=>{let n=i.boundingBox.size;return n.width+=s.NodeSeparation,n.height+=s.NodeSeparation,n})}var _a=class extends ae{constructor(e,t,i,n){super(i);this.settings=e,this.graph=t,this.length=n}run(){this.LayoutConnectedGraphWithMds(),this.SetGraphBoundingBox()}SetGraphBoundingBox(){this.graph.boundingBox=this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}static ScaleToAverageEdgeLength(e,t,i,n){let o=new Map,a=0;for(let c of e.shallowNodes())o.set(c,a),a++;let l=0,u=0;for(let c of e.edges()){let h=o.get(c.source),d=o.get(c.target);u+=Math.sqrt(Math.pow(t[h]-t[d],2)+Math.pow(i[h]-i[d],2)),l+=n(c)}if(l>0&&(u/=l),u>0)for(let c=0;c<t.length;c++)t[c]/=u,i[c]/=u}static LayoutGraphWithMds(e,t,i,n){if(i.x=new Array(e.shallowNodeCount),i.y=new Array(e.shallowNodeCount),i.x.length==0)return;if(i.x.length==1){i.x[0]=i.y[0]=0;return}let o=Math.min(t.PivotNumber,e.shallowNodeCount),a=t.GetNumberOfIterationsWithMajorization(e.shallowNodeCount),l=t.Exponent,u=new Array(o),c=new pp(e,u,n);c.run();let h=c.Result;if(Ve.LandmarkClassicalScaling(h,i,u),_a.ScaleToAverageEdgeLength(e,i.x,i.y,n),a>0){let d=new ou(e,n);d.run();let p=d.Result,y=Ve.ExponentialWeightMatrix(p,l);Ve.DistanceScalingSubset(p,i.x,i.y,y,a)}}LayoutConnectedGraphWithMds(){let e={x:[],y:[]};_a.LayoutGraphWithMds(this.graph,this.settings,e,this.length),this.settings.RotationAngle!=0&&mp.Rotate(e.x,e.y,this.settings.RotationAngle);let t=0;for(let i of this.graph.shallowNodes())i.boundingBox&&(i.center=new f(e.x[t]*this.settings.ScaleX,e.y[t]*this.settings.ScaleY)),t++;this.settings.RemoveOverlaps&&Xr.RemoveOverlaps(Array.from(this.graph.shallowNodes()),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}ScaleNodes(e,t){for(let i of e)i.center=i.center.mul(t)}static PackGraphs(e,t){if(e.length==0)return V.mkEmpty();if(e.length==1)return e[0].boundingBox;let i=e.map(a=>a.boundingBox),n=new Array;for(let a of e)n.push({g:a,lb:a.boundingBox.leftBottom.clone()});let o=new Nl(i,t.PackingAspectRatio);o.run();for(let{g:a,lb:l}of n){let u=a.boundingBox.leftBottom.sub(l);a.translate(u)}return new V({left:0,bottom:0,right:o.PackedWidth,top:o.PackedHeight})}};var Mn=class extends kl{constructor(){super(...arguments);this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this.removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=3e3;this.adjustScale=!1}get RemoveOverlaps(){return this.removeOverlaps}set RemoveOverlaps(e){this.removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get IdealEdgeLength(){return this.edgeConstraints}set IdealEdgeLength(e){this.edgeConstraints=e}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var xp=class extends ae{get scaleX(){return this.settings.ScaleX}set scaleX(e){this.settings.ScaleX=e}get scaleY(){return this.settings.ScaleY}set scaleY(e){this.settings.ScaleY=e}constructor(e,t,i,n){super(t);this.graph=e,this.length=i,this.settings=n,this.settings.ScaleX=this.settings.ScaleY=200}run(){new _a(this.settings,this.graph,this.cancelToken,this.length).run()}};var gS=Q(Fh());var pS=(n=>(n[n.OverlapsOtherLabels=0]="OverlapsOtherLabels",n[n.OverlapsNodes=1]="OverlapsNodes",n[n.OverlapsEdges=2]="OverlapsEdges",n[n.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",n))(pS||{});var mS=class{},bS=class{constructor(){this.points=new gS.LinkedList;this.coveredLength=0}AddFirst(e){if(this.points.size!=0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!=0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var Gp=class{constructor(e){this.location=e,this.boundingBox=V.rectangleOnPoint(e)}},Ha=class{constructor(e,t){this.data=t,this.boundingBox=e}},PS=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},ve=class extends ae{constructor(e,t){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=ve.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(t.length):ve.MinGranularity,this.InitializeObstacles(e,t),this.edges=t}get CollisionGranularity(){return this.granularity}set CollisionGranularity(e){this.granularity=e}static constructorG(e){return new ve(Array.from(e.deepNodes()),Array.from(e.deepEdges()).filter(t=>t.label))}static constructorGA(e,t){return new ve(Array.from(e.deepNodes()),t.filter(i=>i.label))}interpolateGranularity(e){if(e<=ve.LowerEdgeBound)return ve.MaxGranularity;if(e>=ve.UpperEdgeBound)return ve.MinGranularity;let t=(ve.UpperEdgeBound-ve.LowerEdgeBound)/(e-ve.LowerEdgeBound);return Math.ceil(ve.MinGranularity+t)}InitializeObstacles(e,t){let i=this.GetEdgeObstacles(t);this.obstacleMaps[1]=ki(e.map(n=>[n.boundingBox,new Ha(n.boundingBox,n)])),this.obstacleMaps[2]=ki(i.map(n=>[n.boundingBox,new Ha(n.boundingBox,n)]))}static CurvePoints(e,t){let i=[],n=e.end.sub(e.start).lengthSquared/(t*t);return ve.SubdivideCurveSegment(i,e,n,e.parStart,e.parEnd),i.sort(p0),i}static SubdivideCurveSegment(e,t,i,n,o){if(e.length>64)return;let a=t.value(n),l=t.value(o);if(a.sub(l).lengthSquared>i){let u=(n+o)/2;ve.SubdivideCurveSegment(e,t,i,n,u),ve.SubdivideCurveSegment(e,t,i,u,o)}else e.push([n,a])}static PlaceLabelsAtDefaultPositions(e,t){for(let i of t)i.label&&new ve([i.source,i.target],[i]).run()}GetEdgeObstacles(e){let t=[];for(let i of e){if(i.curve==null)continue;let n=ve.CurvePoints(i.curve,this.CollisionGranularity);this.edgeInfos.set(i,new PS(n));for(let o of n)t.push(new Gp(o[1]))}return t}AddLabelObstacle(e){this.labelObstacleMap==null?(this.labelObstacleMap=ki([[e.boundingBox,e]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(e.boundingBox,e)}run(){this.edges.sort((e,t)=>this.edgeInfos.get(e).edgePoints.length-this.edgeInfos.get(t).edgePoints.length);for(let e of this.edges)this.PlaceLabel(e)}PlaceLabel(e){let t=!1;for(let i of this.placementStrategy){switch(i){case 0:t=this.PlaceEdgeLabelOnCurve(e.label);break;case 1:t=this.PlaceEdgeLabelHorizontally(e.label);break;default:throw new Error("unexpected case")}if(t)break}t?this.CalculateCenterLabelInfoCenter(e.label):this.PlaceLabelAtFirstPosition(e.label)}getLabelInfo(e){let t=Re.getGeom(e.label.parent);return this.edgeInfos.get(t)}PlaceLabelAtFirstPosition(e){let t=Re.getGeom(e.label.parent),i=t.curve,n=this.edgeInfos.get(t).edgePoints,o=this.StartIndex(e,n.map(p=>p[1])),a=n[o][1],l=i.derivative(n[o][0]);l.length<E.distanceEpsilon&&(l=new f(1,1)),l=l.normalize();let u=new At(e.width,e.height),c=this.getLabelInfo(e),h=ve.GetPossibleSides(c.placementSide,l)[0],d=ve.GetLabelBounds(a,l,u,h);this.SetLabelBounds(this.getLabelInfo(e),d)}StartIndex(e,t){let i=this.getLabelInfo(e);return Math.min(t.length-1,Math.max(0,Math.floor(t.length*i.placementOffset)))}CalculateCenterLabelInfoCenter(e){let t=this.getLabelInfo(e),i=new f(0,0);for(let n of t.innerPoints)i=i.add(n);for(let n of t.outerPoints)i=i.add(n);e.center=i.div(t.innerPoints.length+t.outerPoints.length)}static geomEdge(e){return Re.getGeom(e.label.parent)}PlaceEdgeLabelHorizontally(e){let i=this.getLabelInfo(e).edgePoints,n=new At(e.width,e.height),o=-1,a=V.mkEmpty(),l=ve.geomEdge(e).curve;for(let u of ve.ExpandingSearch(this.StartIndex(e,i.map(c=>c[1])),0,i.length)){let c=i[u],h=l.derivative(c[0]).normalize();if(!$(h.lengthSquared,0)){for(let d of ve.GetPossibleSides(this.getLabelInfo(e).placementSide,h)){let p=ve.GetLabelBounds(c[1],h,n,d),y=this.ConflictIndexRL(p,e);if(y>o&&(o=y,a=p,o==Number.MAX_VALUE))break}if(o==Number.MAX_VALUE)break}}if(o>=0){this.SetLabelBounds(this.getLabelInfo(e),a);let u=new Ha(a,null);this.AddLabelObstacle(u);let c=this.getLabelInfo(e);return o==0?c.placementResult=0:o==1?c.placementResult=1:o==2?c.placementResult=2:c.placementResult=pS.OverlapsNothing,!0}return!1}static GetLabelBounds(e,t,i,n){let o=t.rotate(Math.PI/2).mul(n),a=e.add(o),l=1,u=o.x>0?a.x:a.x-i.width,c=o.y>0?a.y:a.y-i.height;if(Math.abs(o.x)<.75){let h=Math.acos(Math.abs(o.y)/l),d=l/Math.sin(h),p=l/Math.cos(h);u+=(o.x>0?-1:1)*Math.min(d,i.width/2),c+=(o.y>0?1:-1)*p}else if(Math.abs(o.y)<.75){let h=Math.acos(Math.abs(o.x)/l),d=l/Math.sin(h),p=l/Math.cos(h);u+=(o.x>0?1:-1)*p,c+=(o.y>0?-1:1)*Math.min(d,i.height/2)}return V.mkLeftBottomSize(u,c,i)}SetLabelBounds(e,t){e.innerPoints=[t.leftTop,t.rightTop],e.outerPoints=[t.leftBottom,t.rightBottom]}static GetPossibleSides(e,t){switch(t.length==0&&(e=0),e){case 1:return[-1];case 2:return[1];case 3:return $(t.x,0)?ve.GetPossibleSides(5,t):[1];case 4:return $(t.x,0)?ve.GetPossibleSides(6,t):[t.x<0?-1:1];case 5:return $(t.y,0)?ve.GetPossibleSides(3,t):[t.y<0?-1:1];case 6:return $(t.y,0)?ve.GetPossibleSides(4,t):[t.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(e,t,i){let n=e+1,o=n;for(;o>t;)yield--o;for(;n<i;)yield n++}static PointSetLength(e){let t=0,i=null;for(let n of e)i!=null&&(t+=i.sub(n.Center).length),i=n.Center;return t}PlaceEdgeLabelOnCurve(e){let t=Re.getGeom(e.label.parent),i=this.getLabelInfo(e);i.innerPoints=null;let n=i.edgePoints,o=3,a=e.height/2,l=new At(a,a),u=e.width;for(let c of ve.ExpandingSearch(this.StartIndex(e,n),0,n.length)){let h=this.GetSidesAndEdgeCurve(e,t,n,c);for(let d of h){let p=new bS,y={coveredLength:0};if(this.ProcessExpandingSearchOnSide(c,n,t.curve,d,a,o,l,y,p,u),y.coveredLength>=u)return this.CaseOfCoveredLengthGreaterThanLabelLength(e,p,y.coveredLength,u,l),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(e,t,i,n,o){let a=new Array,l=new Array,u=Array.from(t.points),c=i-n;if(c>0){let d=u[u.length-1],p=u[u.length-2],y=d.Center.sub(p.Center),x=y.length;c>x&&(d=u[0],p=u[1],y=d.Center.sub(p.Center),x=y.length);let A=y.mul((x-c)/x);d.Center=p.Center.add(A),d.Inner=p.Inner.add(A),d.Outer=p.Outer.add(A)}this.GoOverOrderedPointsAndAddLabelObstacels(u,a,l,o);let h=this.getLabelInfo(e);h.innerPoints=a,h.outerPoints=l}GoOverOrderedPointsAndAddLabelObstacels(e,t,i,n){for(let o of e){let a=o.Center;t.push(o.Inner),i.push(o.Outer);let l=new Ha(V.mkSizeCenter(new At(n.width*2,n.height*2),a),null);this.AddLabelObstacle(l)}}ProcessExpandingSearchOnSide(e,t,i,n,o,a,l,u,c,h){for(let d of ve.ExpandingSearch(e,0,t.length)){let[p,y]=t[d],x=i.derivative(p);if($(x.lengthSquared,0))continue;let A=x.rotate(Math.PI/2).normalize().mul(n),T=y.add(A.mul(o+a));if(this.Conflict(T,o,l))break;{let I=new mS;if(I.Center=T,I.Inner=y.add(A.mul(a)),I.Outer=y.add(A.mul(2*o+a)),u.coveredLength=d<=e?c.AddFirst(I):c.AddLast(I),u.coveredLength>=h)break}}}GetSidesAndEdgeCurve(e,t,i,n){let o=t.curve.derivative(i[n][0]);return ve.GetPossibleSides(this.getLabelInfo(e).placementSide,o)}Conflict(e,t,i){return this.ConflictIndex(e,t,i)!=Number.MAX_VALUE}ConflictIndexRL(e,t){let i=Re.getGeom(t.label.parent),n=i.source,o=i.target;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l of this.obstacleMaps[a].GetAllIntersecting(e))if(!(a==1&&l instanceof Ha&&l.data instanceof ze!=null&&(n.node.isDescendantOf(l.data.graph)||o.node.isDescendantOf(l.data))))return a}return Number.MAX_VALUE}ConflictIndex(e,t,i){let n=V.creatRectangleWithSize(new At(i.width*2,i.height*2),e),o=t*t;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null)for(let u of this.obstacleMaps[l].GetAllIntersecting(n))if(u instanceof Gp){if(e.sub(u.location).lengthSquared<o)return l}else return l;return Number.MAX_VALUE}}},As=ve;As.MinGranularity=5,As.MaxGranularity=50,As.LowerEdgeBound=500,As.UpperEdgeBound=3e3;function _p(s,e){t(s),cu(s,e,i,Fa,Fc);function t(o){o.layoutSettings||(o.layoutSettings=n(o))}function i(o,a){if(t(o),o.layoutSettings instanceof fr)new mu(o,o.layoutSettings,a).run();else if(o.layoutSettings instanceof Mn)new xp(o,a,()=>1,o.layoutSettings).run();else throw Error("not implemented")}function n(o){return o.shallowNodeCount<200||o.edgeCount<200?new fr:new Mn}}function Fp(s){do{if(s.layoutSettings&&s.layoutSettings.edgeRoutingSettings)return s.layoutSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=Le.getGeom(t);else break}while(!0);let e=new ma;return e.EdgeRoutingMode=0,e}function Fa(s,e,t){let i=Fp(s);i.EdgeRoutingMode==4?yS(s,e,t):i.EdgeRoutingMode==0||i.EdgeRoutingMode==1?xS(s,e,t):i.EdgeRoutingMode==2?CS(s,e,t):i.EdgeRoutingMode!=6&&new Fe(s,e).run(),ES(s),SS(s)}function cu(s,e,t,i,n,o=!0,a=1){if(s.graph.isEmpty())return;$0(a),ES(s);let l=y();p(s);let u=qw(s.graph),c=Xw(s);x(),u.forEach(A=>{A[0].edge.remove(),A[1].add()}),c.forEach(A=>{for(let T of A.graph.shallowNodes)T.parent=s.graph});let h=d(s);l.forEach(A=>A.add()),i(s,h,e),s.graph.parent==null&&(SS(s),o&&s.FlipYAndMoveLeftTopToOrigin());function d(A){let T=[];for(let I of A.deepNodes()){for(let B of I.outEdges())B.curve==null&&T.push(B);for(let B of I.selfEdges())B.curve==null&&T.push(B)}return T}function p(A){for(let T of A.shallowNodes())if(T instanceof ze){let I=T;if(cu(I,e,t,i,n),!I.graph.isEmpty()){let B=I.boundingBox;B&&!B.isEmpty()&&(T.boundaryCurve=Se.mkRectangleWithRoundedCorners(B.width,B.height,Math.min(10,B.width/10),Math.min(10,B.height/10),B.center))}}}function y(){let A=new Set,T=s.graph;if(T.parent==null)return A;for(let I of T.shallowNodes){for(let B of I.outEdges){let w=T.liftNode(B.target);(w==null||w==I)&&A.add(B)}for(let B of I.inEdges){let w=T.liftNode(B.source);(w==null||w==I)&&A.add(B)}}for(let I of A)I.remove();return A}function x(){if(c.length!=0){for(let A of c)t(A,e);n(s,c)}}}function qw(s){let e=new Array;for(let t of s.deepNodes){let i=s.liftNode(t);if(i!=null)for(let n of t.outEdges.values()){let o=n.target,a=s.liftNode(o);if(a==null||i==t&&a==o||i==a)continue;n.remove();let l=new Yn(i,a),u=new Re(l);e.push([u,n])}}return e}function Xw(s){let e=s.graph,t=f0(e),i=[],n=0;for(let o of t){let a=new De(e.id+n++);a.parent=e;let l=new ze(a);l.layoutSettings=s.layoutSettings;for(let u of o)u.parent=a,a.addNode(u);i.push(l)}return i}function yS(s,e,t,i=1,n=3){Ga.constructorGNANB(s,e,i,n,!0).run()}function SS(s){let e=Array.from(s.deepEdges()).filter(i=>i.label&&i.label.isPositioned==!1);if(e.length==0)return;As.constructorGA(s,e).run()}function ES(s){for(let e of s.deepEdges())e.label&&e.label.requirePositioning()}var bu=class{static constructorStatic(e,t){let i=new bu;i.edges=e,i.nodeBoundaries=t,i.boundingBox=V.mkEmpty();for(let n of i.nodeBoundaries)i.boundingBox=i.boundingBox.addRec(n.boundingBox);return i}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=mi(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var vS=Q(ei());var AS=Q(Fh());var vs=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,i){this.currentTriangle=e,this.start=t,this.end=i}*Triangles(){for(;this.MoveNext();)yield this.CurrentTriangle}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!=t&&f.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.TriEdges.item0;let i=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!=i&&f.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=i,this.currentTriangle.TriEdges.item1):(this.positiveSign=i,this.negativeSign=e,this.currentTriangle.TriEdges.item2)}static PointLocationForTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=f.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<E.distanceEpsilon*-1)return 0;o<E.distanceEpsilon&&(i=!0)}return i?1:2}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.TriEdges.index(this.currentPiercedEdge),t,i=this.currentTriangle.Sites.getItem(e+2),n=this.GetHyperplaneSign(i);this.negativeSign==0?n==-1||n==0?(this.negativeSign=n,t=e+1):t=e+2:this.positiveSign==0?n==1||n==0?(this.positiveSign=n,t=e+2):t=e+1:n!=this.positiveSign?(this.negativeSign=n,t=e+1):(this.positiveSign=n,t=e+2),this.currentPiercedEdge=f.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-E.distanceEpsilon?this.currentTriangle.TriEdges.getItem(t):null}GetHyperplaneSign(e){let t=f.signedDoubledTriangleArea(this.start,e.point,this.end);return t>E.distanceEpsilon?1:t<E.distanceEpsilon*-1?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var Pu=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,i,n){if(ke.PointIsInsideOfTriangle(t,i))return!0;let o=new vs(i,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.Constrained){let l=a.lowerSite.Owner;if(!n.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,i,n,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.CdtTriangle,n,i,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,i,n,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,i,n,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new AS.HashSet;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(n.has(d))continue;let p=Pu.FindPolylinePoint(d,h.point),y=O.minDistBetweenLineSegments(p.point,p.nextOnPolyline.point,t,i),x=y.dist,A=y.parab,T=y.parcd,I=O.minDistBetweenLineSegments(p.point,p.prevOnPolyline.point,t,i),B=I.dist,w=I.parab,M=I.parcd,F,z,se;if(x<B){if(se=x,se>o)continue;F=p.point.add(p.nextOnPolyline.point.sub(p.point).mul(A)),z=t.add(i.sub(t).mul(T))}else{if(se=B,se>o)continue;F=p.point.add(p.prevOnPolyline.point.sub(p.point).mul(w)),z=t.add(i.sub(t).mul(M))}a.get(d)||a.set(d,[F,z])}return a}ThreadLineSegmentThroughTriangles(e,t,i,n,o){if(ke.PointIsInsideOfTriangle(i,e))return o.push(e),!0;let a=new vs(e,t,i);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.Constrained){let u=l.lowerSite.Owner;if(!n.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=f.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<E.distanceEpsilon*-1)return 0;o<E.distanceEpsilon&&(i=!0)}return i?1:2}static FindPolylinePoint(e,t){for(let i of e.polylinePoints())if(i.point.equal(t))return i;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,i,n){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.CdtTriangle,i,n,a,o)}static closedeb(e,t){return e.Position.sub(new f(360.561,428.416)).length<.1&&t.Position.sub(new f(414.281,440.732)).length<.1}EdgeIsLegalSSPPS(e,t,i){let n=e.Position,o=e.CdtTriangle,a=t.Position;if(ke.PointIsInsideOfTriangle(a,o))return!0;let l=new vs(o,n,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.Constrained){let c=u.lowerSite.Owner;if(!i.has(c))return!1}}return!0}};var xr=class{constructor(e,t,i,n){this.metroGraphData=e,this.obstaclesToIgnoreLambda=n,this.bundlingSettings=t,this.obstacleTree=i}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?mi(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,i,n){let o={minimalDistance:i};return xr.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,i){let n={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,i,n,o)}GetMinimalDistanceToObstacles(e,t,i){let n=new Array,o={minimalDistance:i};return xr.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,i,n,o){return n.touchedObstacles=new Array,o.minimalDistance=t,xr.IntersectCircleWithTree(this.obstacleTree,e,t,i,n.touchedObstacles,o)}static IntersectCircleWithTree(e,t,i,n,o,a){if(!e.irect.contains_point_radius(t,i))return!0;if(e.UserData==null){let l=xr.IntersectCircleWithTree(e.Left,t,i,n,o,a);if(!l||(l=xr.IntersectCircleWithTree(e.Right,t,i,n,o,a),!l))return!1}else{let l=e.UserData;if(n.has(l))return!0;if(v.PointRelativeToCurveLocation(t,l)!=0)return xr.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=i&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,i,n){let o=t.sub(e).normalize();return o=new f(o.y,o.x*-1),q.mkFromPoints([e.add(o.mul(i/2)),e.sub(o.mul(i/2)),t.sub(o.mul(n/2)),t.add(o.mul(n/2))])}};var Vp=class{constructor(e,t,i,n){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=i,this.Index=n}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var kp=class{constructor(e,t,i){this.metroline=e,this.station=t,this.polyPoint=i}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var Up=class{constructor(e,t,i){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=i}debStop(){return this.SerialNumber==28&&this.Position.sub(new f(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}static less(e,t){return e.SerialNumber<t.SerialNumber}static greater(e,t){return e.SerialNumber>t.SerialNumber}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var zp=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var mt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new zt(ue);for(let n of this.metroGraphData.VirtualStations())t.Enqueue(n,-this.CalculatePotential(n,e));let i=!1;for(;!t.IsEmpty();){let n={priority:0},o=t.DequeueAndGetPriority(n);if(n.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),i=!0)}return i}TryGrowHub(e,t){let i=this.CalculateAllowedHubRadius(e);if(e.Radius>=i)return!1;let n=t?mt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=n)return!1;let a=.05*(n-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,i);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let i=t?mt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return i<=e.Radius?0:(i-e.Radius)/i}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let n of e.Neighbors){let o=n.Position.sub(e.Position).length;t=Math.min(t,o/1.05-n.Radius)}let i=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return i<t&&(t=i-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,i){let n=1;for(let o of i.Neighbors){let l=e.GetWidthSSN(o,i,t.EdgeSeparation)/2+t.EdgeSeparation;n=Math.max(n,l)}return n=Math.min(n,2*t.MaxHubRadius),n}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,i){return mt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,i.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,n){let o=mt.CalculateIdealHubRadius(e,t,i);if(i.Neighbors.length>1){let a=i.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,mt.GetMinRadiusForTwoAdjacentBundles(o,i,n,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let i=e.MaxHubRadius;for(let n of t.Neighbors)i=Math.min(i,t.Position.sub(n.Position).length/2);return i}static GetMinRadiusForTwoAdjacentBundles(e,t,i,n,o,a,l){let u=a.GetWidthSSN(t,n,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,i,n.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,i,n,o,a,l){if(o<E.distanceEpsilon||a<E.distanceEpsilon)return e;let u=f.anglePCP(i,t,n);if(u=Math.min(u,Math.PI*2-u),u<E.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),p=a/(4*c),y=2*Math.sqrt(d*d+(p*p+2*(d*(p*h))));return y=Math.min(y,2*l.MaxHubRadius),y=Math.max(y,e),y}};var Ts=class{constructor(e,t,i,n){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=i,this.cdt=n}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],i=e[1],n=this.metroGraphData.GetIjInfo(t,i);n.cachedBundleCost=this.costCalculator.BundleCost(t,i,t.Position),t.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.GetCdtTree();e.CdtTriangle=t.FirstHitNodeWithPredicate(e.Position,Ts.testPointInside).UserData,e.cachedIdealRadius=mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let i of e.Neighbors){i.IsReal||(i.cachedIdealRadius=mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,i),i.cachedRadiusCost=this.costCalculator.RadiusCost(i,i.Position));let n=this.metroGraphData.GetIjInfo(e,i);i.cachedBundleCost-=n.cachedBundleCost,n.cachedBundleCost=this.costCalculator.BundleCost(e,i,e.Position),e.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}static testPointInside(e,t){return ke.PointIsInsideOfTriangle(e,t)?1:0}};var yu=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size==0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let i=this.mainMap.get(e);if(i)return i.get(t)}has(e,t){let i=this.mainMap.get(e);return i?i.has(t):!1}set(e,t,i){let n=this.mainMap.get(e);n||(n=new Map,this.mainMap.set(e,n)),n.set(t,i)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[i,n]of t)yield[e,i,n]}*keys(){for(let[e,t]of this.mainMap)for(let[i]of t)yield[e,i]}};var Hp=class{constructor(e,t,i,n,o,a,l,u){this.cachedEnterableLooseForEnd=new je;this.bundlingSettings=n,this.regularEdges=e,o!=null?this.Cdt=o:this.Cdt=Ei.CreateConstrainedDelaunayTriangulation(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new xr(this,n,t,c=>c.getELP()),this.tightIntersections=new xr(this,n,i,c=>c.EnterableTightPolylines),this.cdtIntersections=new Pu(this,n),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],n=this.edgeInfoDictionary.get(i[0],i[1]);return n?n.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(i[0],i[1])}MoveNode(e,t){let i=e.Position;this.PointToStations.deleteP(i),this.PointToStations.set(t,e),e.Position=t;for(let n of this.MetroNodeInfosOfNode(e))n.PolyPoint.point=t;for(let n of this.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(i).length-a.sub(i).length}for(let n of e.Neighbors)this.ink+=t.sub(n.Position).length-i.sub(n.Position).length;this.SortNeighbors(e);for(let n of e.Neighbors)this.SortNeighbors(n)}GetWidthSSN(e,t,i){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(n[0],n[1]);return o?o.Width+(o.Count-1)*i:0}GetWidthAN(e,t){let i=0;for(let o of e)i+=o.Width;let n=e.length;return i+=n>0?(n-1)*t:0,i}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,i=new vS.Stack,n=new Me;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(n.has(o.point)){let l=o.next;do{let u=i.top;if(!u.equal(a))n.delete(u),i.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else i.push(a),n.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new je;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!=e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let i=new Up(this.Stations.length,t,e.point);this.PointToStations.set(e.point,i),this.Stations.push(i)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let i=new Vp(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(i),this.PointToStations.get(i.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(i.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let i=this.PointToStations.get(t.Polyline.start),n;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,i=n)n=this.PointToStations.get(o.next.point),rs(e,i,n),rs(e,n,i)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new f(360.561,428.416)).length<.1&&t.Position.sub(new f(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let i=this.edgeInfoDictionary.get(e,t);return i||(i=new zp,this.edgeInfoDictionary.set(e,t,i),i)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new yu,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let i=this.metrolines[t];this.InitMetroNodeInfos(i),this.InitNodeEnterableLoosePolylines(i,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(i,this.regularEdges[t]),i.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let i=this.PointToStations.get(t.point);i.MetroNodeInfos.push(new kp(e,i,t))}}InitNodeEnterableLoosePolylines(e,t){let i=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point);o.getELP()!=null?o.setELP(bi(o.getELP(),i)):o.setELP(new Set(i))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let i of this.LooseTree.AllHitItems_(e))v.PointRelativeToCurveLocation(e,i)==2&&t.AddEnterableLoosePolyline(i);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let i of this.TightTree.AllHitItems_(e))v.PointRelativeToCurveLocation(e,i)==2&&t.AddEnterableTightPolyline(i)}InitNodeEnterableTightPolylines(e,t){let i=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=bi(a,i):o.EnterableTightPolylines=new Set(i)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,i=e.Position;e.Neighbors.sort((n,o)=>en(t.sub(i),n.Position.sub(i),o.Position.sub(i)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,i=this.PointToStations.get(t.start),n;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,i=n){n=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(i,n);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.Cdt.GetCdtTree();for(let t of this.Stations)t.CdtTriangle=e.FirstHitNodeWithPredicate(t.Position,Ts.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let i=e.sourceAndTargetLoosePolylines();return v.PointRelativeToCurveLocation(t,i[0])==0&&v.PointRelativeToCurveLocation(t,i[1])==0}};function en(s,e,t){let i=f.crossProduct(s,t),n=s.dot(t),o=f.crossProduct(s,e),a=s.dot(e);return $(o,0)&&Su(a,0)?$(i,0)&&Su(n,0)?0:1:$(i,0)&&Su(n,0)?-1:$(o,0)||$(i,0)||o*i>0?Zn(f.crossProduct(t,e),0):-Zn(Math.sign(o),0)}function Su(s,e){return Zn(s,e)>=0}var wS=Q(ei());var tn=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,i){return(e-t)*i.InkImportance}static PathLengthsError(e,t,i,n){return(e-t)*(n.PathLengthImportance/i)}static RError(e,t,i){return e<=t?0:i.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,i){return e<=t?0:i.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let i=t.InkImportance*e.Ink;for(let n of e.Metrolines)i+=t.PathLengthImportance*n.Length/n.IdealLength;return i+=this.CostOfForces(e),i}static CostOfForces(e){let t=0;for(let i of e.VirtualStations())t=t+i.cachedRadiusCost;for(let i of e.VirtualEdges()){let n=i[0],o=i[1];t+=e.GetIjInfo(n,o).cachedBundleCost}return t}InkGain(e,t){let i=this.metroGraphData.Ink,n=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;n-=a.sub(e.Position).length,n+=a.sub(t).length}return tn.InkError(i,n,this.bundlingSettings)}PathLengthsGain(e,t){let i=0;for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline.Length,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point,u=n.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;i+=tn.PathLengthsError(o,u,n.Metroline.IdealLength,this.bundlingSettings)}return i}RadiusGain(e,t){let i=0;return i=i+e.cachedRadiusCost,i=i-this.RadiusCost(e,t),i}RadiusCost(e,t){let i;f.closeDistEps(e.Position,t)?i=e.cachedIdealRadius:i=mt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,i,n))return tn.Inf;let o=0;for(let a of n.touchedObstacles){let l=a[1].sub(t).length;o+=tn.RError(i,l,this.bundlingSettings)}return o}BundleGain(e,t){let i=e.cachedBundleCost;for(let n of e.Neighbors){let o=this.BundleCost(e,n,t);if(Su(o,tn.Inf))return-tn.Inf;i-=o}return i}BundleCost(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,i,t.Position,n,o))return tn.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=tn.BundleError(n/2,u,this.bundlingSettings)}return a}},jt=tn;jt.Inf=1e9;var TS=Q(Xn());var Wp=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new je;this.interestingPoints=new Me;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){Yw(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){$w(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new TS.Queue;for(let i of this.Polylines)t.enqueue(i);for(;t.length>0;){let i=t.dequeue();e.delete(i);let n=this.ProcessPolyline(i);n!=null&&(e.has(i)||(e.add(i),t.enqueue(i)),e.has(n)||(e.add(n),t.enqueue(n)))}}ProcessPolyline(e){let t=new Map;for(let i=e.startPoint.next;i!=null;i=i.next){this.FillDepartedPolylinePoints(i,t);for(let n of this.pathsThroughPoints.get(i.point)){let o=t.get(n.polyline);if(o){if(this.ProcessFlip(i,o))return n.polyline;t.delete(n.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let i=e.prev.point;for(let n of this.pathsThroughPoints.get(i))this.IsNeighborOnTheSamePolyline(n,e)||t.has(n.polyline)||t.set(n.polyline,n)}ProcessFlip(e,t){let i=e.polyline,n=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(i),u=this.polylineToEdgeGeom.get(n);if(l.lineWidth!=u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!ts(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(i,o,a),h=c[0],d=c[1],p=c[2];c=this.FindPointsOnPolyline(n,o,a);let y=c[0],x=c[1],A=c[2],T=this.FindRelationOnFirstPoint(h,y,p,A),I=this.FindRelationOnLastPoint(d,x,p,A);return T!=2&&I!=2||T==1||I==1?!1:(this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.Swap(h,y,d,x,p,A),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,i){let n,o;for(let a=e.startPoint;a!=null;a=a.next)if(n==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];n=a}else o==null&&a.point.equal(i)&&(o=a);else if(a.point.equal(i))return[n,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let i=e;i!=null;i=i.next)if(i==t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Prev(e,i),u=this.Prev(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,i,n)}FindRelationOnLastPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Next(e,i),u=this.Next(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,i).point.equal(this.Prev(t,n).point);)e=this.Next(e,i),t=this.Prev(t,n);return this.PolylinesIntersect(e,t,o,a,i,n)}PolylinesIntersect(e,t,i,n,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(i,o),h=this.Prev(i,o),d=this.Next(t,a),p=this.Prev(n,a);if(e.point.equal(i.point)){let y=e.point,x=en(h.point.sub(y),p.point.sub(y),u.point.sub(y)),A=en(h.point.sub(y),d.point.sub(y),u.point.sub(y));return x==A?1:2}else{let y=en(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),x=en(c.point.sub(i.point),p.point.sub(i.point),h.point.sub(i.point));return y==x?1:2}}Swap(e,t,i,n,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),i,o),u=this.GetRangeOnPolyline(this.Next(t,a),n,a);this.ChangePolylineSegment(e,i,o,u),this.ChangePolylineSegment(t,n,a,l),xo.RemoveSelfCyclesFromPolyline(e.polyline),xo.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,i,n){let o=e;for(let a of n){let l=dt.mkFromPoint(a.point);l.polyline=o.polyline,i?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}i?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,i){let n=new Array;for(let o=e;o!=t;o=this.Next(o,i))n.push(o);return n}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new Me;for(let i=e.startPoint;i!=null;i=i.next){if(i==e.startPoint){if(i.prev!=null)return!1}else if(i.prev.next!=i)return!1;if(i==e.endPoint){if(i.next!=null)return!1}else if(i.next.prev!=i)return!1;if(t.has(i.point))return!1;t.add(i.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function Yw(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function $w(s,e,t){let i=s.get(e);!i||(i.delete(t),i.size==0&&s.deleteP(e))}var xo=class{constructor(e,t){this.foundCrossings=new Me;this.crossingsThatShouldBecomeHubs=new Me;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new Ki;for(let t of this.Vertices())t.next&&e.set(new ot(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length==0)return!1;let e=new Ki,t=new Wo(null);for(let l of this.Vertices()){let u=V.mkOnPoints([l.point]);u.pad(E.intersectionEpsilon),t.Add(u,l.point)}let i=_l(this.Edges(),l=>V.mkPP(l.First,l.Second));pt(i,i,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let n=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||n||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((i,n)=>ue(ye(i,e.First),ye(n,e.First)))}InsertPointsIntoPolylines(e){let t=!1;for(let i of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(i,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let i=!1;for(let n=e.Polyline.startPoint;n.next!=null;n=n.next)this.InsertPointsOnPolypoint(n,t,e)&&(i=!0);return i}InsertPointsOnPolypoint(e,t,i){let n=new ot(e.point,e.next.point),o=e.point!=n.First,a=t.get(n);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=dt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=dt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)xo.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,i=new je;for(let n=e.startPoint;n!=null;n=n.next){let o=n.point,a=i.get(o);if(a){for(let l=a.next;l!=n.next;l=l.next)i.deleteP(l.point);a.next=n.next,n.next.prev=a,t=!0}else i.set(n.point,n)}return t}ReduceEdgeCrossings(){let e=new Wp(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=Q0(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let i=e.startPoint.next;i!=null&&i.next!=null;i=i.next)if(this.pointsToDelete.has(i.point)&&f.getTriangleOrientation(i.prev.point,i.point,i.next.point)==2){let n=i.prev,o=i.next;n.next=o,o.prev=n,i=n,t=!0}return t}IntersectTwoEdges(e,t,i,n){let o=O.IntersectPPPP(e.First,e.Second,t.First,t.Second);if(o){let a=this.FindExistingVertexOrCreateNew(n,o);(this.AddVertexToSplittingList(e,i,a)||this.AddVertexToSplittingList(t,i,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let i=e.RootNode.FirstHitNode(t);if(i!=null)return i.UserData;let n=V.mkOnPoints([t]);return n.pad(E.intersectionEpsilon),e.Add(n,t),t}AddVertexToSplittingList(e,t,i){if(!v.closeIntersectionPoints(i,e.First)&&!v.closeIntersectionPoints(i,e.Second)){let n=t.get(e);if(n||(n=new Array,t.set(e,n)),!n.find(o=>o.equal(i)))return n.push(i),!0}return!1}};var IS=Q(Fh());var Vh=class{get Count(){return this.points.length}constructor(e,t,i,n){this.BelongsToRealNode=n,this.Curve=t,this.Position=i,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e),this.ParameterSpan=this.Curve.parEnd-this.Curve.parStart}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParRight(){return this.parRight}set ParRight(e){this.parRight=e,this.RightPoint=this.Curve.value(this.parRight)}get ParLeft(){return this.parLeft}set ParLeft(e){this.parLeft=e,this.LeftPoint=this.Curve.value(this.parLeft)}get ParMid(){return(this.parRight+this.parLeft)/2}get MidPoint(){return f.middle(this.RightPoint,this.LeftPoint)}get Span(){return this.SpanBetweenTwoPoints(this.parRight,this.parLeft)}SpanBetweenTwoPoints(e,t){return e<=t?t-e:t-e+this.ParameterSpan}RotateLeftPoint(e,t){return e==0?this.LeftPoint:this.RotatePoint(e,this.parLeft,t)}RotateRigthPoint(e,t){return e==0?this.RightPoint:this.RotatePoint(e,this.parRight,t)}RotatePoint(e,t,i){let n=this.ParameterSpan*i;return t+=e*n,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,i){let n=this.ParameterSpan*i;e!=0&&(this.ParRight=this.AdjustParam(this.ParRight+e*n)),t!=0&&(this.ParLeft=this.AdjustParam(this.ParLeft+t*n))}Intersect(e){return this.IntersectNNNB(this.parRight,this.parLeft,e.parRight,e.parLeft)}IntersectNNNB(e,t,i,n){return e>t?this.IntersectNNNB(e,this.Curve.parEnd,i,n)||this.IntersectNNNB(this.Curve.parStart,t,i,n):i>n?this.IntersectNNNB(e,t,i,this.Curve.parEnd)||this.IntersectNNNB(e,t,this.Curve.parStart,n):!(Zn(t,i)||Zn(n,e))}RelativeOrderOfBasesIsPreserved(e,t,i){let n=this.ParameterSpan*i,o=this.parRight+e*n,a=this.parRight<this.parLeft?this.parLeft+t*n:this.parLeft+this.ParameterSpan+t*n;if(o>a||this.SpanBetweenTwoPoints(o,a)>this.ParameterSpan/2)return!1;if(this.Prev==null||this.SpanBetweenTwoPoints(this.Prev.ParMid,this.ParMid)>n&&this.SpanBetweenTwoPoints(this.ParMid,this.Next.ParMid)>n)return!0;let l=this.RotateLeftPoint(t,i),u=this.RotateRigthPoint(e,i),c=f.middle(l,u),h=this.MidPoint;return!(f.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=f.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||f.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=f.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var Is=class{constructor(e,t,i,n){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=i,this.HalfWidthArray=n,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let i=this.SourceBase.Curve.boundingBox.diagonal/2,n=this.TargetBase.Curve.boundingBox.diagonal/2,o=xr.Create4gon(this.SourceBase.Position,this.TargetBase.Position,i*2,n*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&v.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,i=e.sub(t).normalize(),n=i.rotate90Ccw(),o=f.middle(e,t),a=i.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(n.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>Is.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(n.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=Is.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(n.mul(Is.FeasibleWidthEpsilon),new f(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new f(0,0),n.mul(-Is.FeasibleWidthEpsilon),l,u))&&(d=2*Is.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParRight+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParRight+this.TargetBase.Span/2)}mkNameFromLRST(){return"/tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,i){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,i)}SetRLParamsIfWidthIsFeasible_(e,t,i,n){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(O.mkPP(i.add(e),n.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>v.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(O.mkPP(i.add(t),n.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>v.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParRight=a.par,this.SourceBase.ParLeft=u.par):(this.SourceBase.ParRight=u.par,this.SourceBase.ParLeft=a.par),this.TargetBase.IsParent?(this.TargetBase.ParRight=o.par,this.TargetBase.ParLeft=l.par):(this.TargetBase.ParRight=l.par,this.TargetBase.ParLeft=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(O.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParRight+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParRight+this.TargetBase.Span/2))}mkNameFromST(){return"/tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,i){let n=v.getAllIntersections(e,this.SourceBase.Curve,!0);if(n.length==0)return i.par=0,t.par=0,null;let o;if(n.length==1?o=n[0]:this.SourceBase.IsParent?o=n[0].par0<n[1].par0?n[1]:n[0]:o=n[0].par0<n[1].par0?n[0]:n[1],n=v.getAllIntersections(e,this.TargetBase.Curve,!0),n.length==0)return i.par=0,t.par=0,null;let a;return n.length==1?a=n[0]:this.TargetBase.IsParent?a=n[0].par0>n[1].par0?n[1]:n[0]:a=n[0].par0>n[1].par0?n[0]:n[1],t.par=o.par1,i.par=a.par1,O.mkPP(o.x,a.x)}RotateBy(e,t,i,n,o){let a=e!=0||t!=0,l=i!=0||n!=0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(i,n,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let i=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),n=i.length;n>=E.tolerance&&(i=i.div(n),this.TargetBase.Tangents[t]=i,this.SourceBase.Tangents[e-1-t]=i.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,i=e.Points,n=O.mkPP(e.LeftPoint,e.RightPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];i[0]=n.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],i[l]=n.value(a*o)}RotationIsLegal(e,t,i,n,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!=0||i!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||n!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!=0||n!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||i!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!=0||t!=0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(i!=0||n!=0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(i,n,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(i=>v.intersectionOne(O.mkPP(e,t),i,!1)!=null)==null}},kh=Is;kh.FeasibleWidthEpsilon=.1;var Uh=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,i,n){this.Segment=e,this.Reversed=t,this.Index=i,this.BundleBase=n}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var Te=class{constructor(e,t,i){this.fixedBundles=new IS.HashSet;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=i}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=re.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let i=new Vh(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,i);let n=new Vh(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,n),v.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!=0?(i.IsParent=!0,is(this.internalBases,e.BoundaryCurve,i),is(this.externalBases,t.BoundaryCurve,n)):v.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!=0?(n.IsParent=!0,is(this.externalBases,e.BoundaryCurve,i),is(this.internalBases,t.BoundaryCurve,n)):(is(this.externalBases,e.BoundaryCurve,i),is(this.externalBases,t.BoundaryCurve,n));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new kh(i,n,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));i.OutgoingBundleInfo=n.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,i=e[0].CurveCenter;e.sort((n,o)=>en(t.sub(i),n.OppositeBase.Position.sub(i),o.OppositeBase.Position.sub(i)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++)e[i].Prev=e[(i-1+t)%t],e[i].Next=e[(i+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=a.OrientedHubSegments[u]=new Uh(null,!1,u,a),d=l.OrientedHubSegments[c]=new Uh(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,i=e.TargetBase;t.ParLeft=t.ParRight=this.GetBaseMiddleParamInDirection(t,t.Position,i.Position),i.ParLeft=i.ParRight=this.GetBaseMiddleParamInDirection(i,i.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,i){let n=e.Curve;if(n instanceof re){let l=n;if(l.isArc())return f.angle(l.aAxis,i.sub(t))}let a=v.getAllIntersections(n,O.mkPP(t,i),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(i))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.keys())this.AdjustCurrentBundleWidthsOnCurve(this.externalBases.get(e));for(let e of this.internalBases.keys())this.AdjustCurrentBundleWidthsOnCurve(this.internalBases.get(e))}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++){let n=e[i],o=n.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(n,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){if(!e.Intersect(t))return;let i=e.ParRight,n=e.ParLeft,o=t.ParRight,a=t.ParLeft,l=t.ParameterSpan;i>n&&(i-=l),o>a&&(o-=l),o>n&&(o-=l,a-=l),i>a&&(i-=l,n-=l);let u=this.RegularCut(i,n,o,a,e.Span,t.Span),c=f.getTriangleOrientation(t.CurveCenter,t.OppositeBase.InitialMidPoint,e.OppositeBase.InitialMidPoint);c==0?(n=u,o=u):c==1?(a=u,i=u):a-i>=n-o?(n=u,o=u):(a=u,i=u),t.ParRight=t.AdjustParam(o),t.ParLeft=t.AdjustParam(a),e.ParRight=e.AdjustParam(i),e.ParLeft=e.AdjustParam(n)}RegularCut(e,t,i,n,o,a){let l=(o*n+a*e)/(o+a),u=Math.min(t,n),c=Math.max(e,i);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=Te.MaxParameterChange,t={cost:this.Cost()},i=0;for(;i++<Te.MaxIterations;){let n=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,n,t.cost),e<Te.MinParameterChange)break}}UpdateParameterChange(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let i=!1;for(let n of this.Bundles)this.fixedBundles.has(n)||(this.OptimizeBundle(n,e,t)?i=!0:this.fixedBundles.add(n));return i}OptimizeBundle(e,t,i){let n=this.CostBi(e);if(n<Te.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<Te.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(Te.Deltas[u][0],Te.Deltas[u][1],0,0,e,n,t);c>Te.CostDeltaThreshold&&c>o&&(l=u,a=Te.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,Te.Deltas[u][0],Te.Deltas[u][1],e,n,t),c>Te.CostDeltaThreshold&&c>o&&(l=Te.Deltas.length-1,a=u,o=c)}return o<Te.CostDeltaThreshold?!1:(i.cost-=o,e.RotateBy(Te.Deltas[l][0],Te.Deltas[l][1],Te.Deltas[a][0],Te.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,i,n,o,a,l){if(!o.RotationIsLegal(e,t,i,n,l))return 0;o.RotateBy(e,t,i,n,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,i*-1,n*-1,l),a-u}CostBi(e){return Te.SeparationCoeff*this.SeparationCost(e)+(Te.SqueezeCoeff*this.SqueezeCost(e)+(Te.AssymetryCoeff*this.AssymetryCost(e)+Te.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let i=0;return i=i+Te.CenterCoeff*this.CenterCostBi(e),i>t||(i=i+Te.SeparationCoeff*this.SeparationCost(e),i>t)||(i=i+Te.SqueezeCoeff*this.SqueezeCost(e),i>t)||(i=i+Te.AssymetryCoeff*this.AssymetryCost(e)),i}SqueezeCost(e){let i=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),n=Math.abs(e.SourceBase.RightPoint.sub(e.SourceBase.LeftPoint).dot(i)),o=Math.abs(e.TargetBase.RightPoint.sub(e.TargetBase.LeftPoint).dot(i)),a=Math.abs(e.TotalRequiredWidth-n)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(n-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,i=Math.min(e.InitialMidParameter,t),n=Math.max(e.InitialMidParameter,t),o=Math.min(n-i,i+(e.ParameterSpan-n));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,i=0;for(let n of e.OrientedHubSegments){let o=n.Index,a=n.Other.Index,l=e.Points[o],u=e.Tangents[o],c=n.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],p=e.Count+c.Count;i+=this.GetAssymetryCostOnData(l,u,h,d,t)/p}return i}GetAssymetryCostOnData(e,t,i,n,o){let a=e.sub(i),l=a.length;if(l<E.distanceEpsilon)return 0;let u=t.add(n).dot(a),c=f.crossProduct(a,t),h=f.crossProduct(a,n),d=c-h,p=u*u+d*d,y=c*c+h*h;return 10*p+o*y}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let i=e.Curve,n=this.IntervalsOverlapLength(e.ParRight,e.ParLeft,t.ParRight,t.ParLeft,i),o=Math.min(e.Span,t.Span);return Math.exp(n/(o*10))-1}IntervalsOverlapLength(e,t,i,n,o){let a=o.parStart,l=o.parEnd;return e<t?i<n?this.IntersectRegularIntervals(e,t,i,n):this.IntersectRegularIntervals(e,t,i,l)+this.IntersectRegularIntervals(e,t,a,n):i<n?this.IntersectRegularIntervals(e,l,i,n)+this.IntersectRegularIntervals(a,t,i,n):this.IntersectRegularIntervals(e,l,i,l)+this.IntersectRegularIntervals(a,t,a,n)}IntersectRegularIntervals(e,t,i,n){let o=Math.max(e,i),a=Math.min(t,n);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let i=Te.SeparationCoeff*this.SeparationCost(t),n=Te.AssymetryCoeff*this.AssymetryCost(t),o=Te.SqueezeCoeff*this.SqueezeCost(t),a=Te.CenterCoeff*this.CenterCostBi(t);e+=(i+n)/2+o+a}return e}},Yr=Te;Yr.Deltas=[[1,-1],[1,-1]],Yr.SeparationCoeff=1,Yr.SqueezeCoeff=1,Yr.CenterCoeff=10,Yr.AssymetryCoeff=1,Yr.MaxIterations=200,Yr.MaxParameterChange=8/360,Yr.MinParameterChange=.1/360,Yr.CostThreshold=1e-5,Yr.CostDeltaThreshold=.01;var jp=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var Wa=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let i=new ot(e.Position,t.Position),n=this.bundles.get(i).Metrolines;if(e.Position==i.First)for(let o=0;o<n.length;o++)yield n[o];else for(let o=n.length-1;o>=0;o--)yield n[o]}GetLineIndexInOrder(e,t,i){let n=new ot(e.Position,t.Position),o=e.Position!=n.First,a=this.bundles.get(n).LineIndexInOrder;return o?a.size-1-a.get(i):a.get(i)}BuildOrder(){this.bundles=new Ki;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let i=new ot(t.point,t.next.point),n=this.bundles.get(i);n||this.bundles.set(i,n=new jp),n.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((i,n)=>this.CompareLines(i,n,e.First,e.Second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let i=0;i<t.Metrolines.length;i++)t.LineIndexInOrder.set(t.Metrolines[i],i)}}CompareLines(e,t,i,n){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(i,n,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(i,n,t,o);let c=o.polyPoint,h=o.next,d=o.prev,p=a,y=c,x,A;for(;(A=u(p))!=null&&(x=d(y))!=null&&A.point.equal(x.point);){let T=new ot(A.point,p.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!A.point.equal(T.First));p=A,y=x}if(A!=null&&x!=null){let T=p.point;return-Wa.IsLeft(l(p).point.sub(T),A.point.sub(T),x.point.sub(T))}for(p=a,y=c;(A=l(p))!=null&&(x=h(y))!=null&&A.point.equal(x.point);){let T=new ot(A.point,p.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!p.point.equal(T.First));p=A,y=x}if(A!=null&&x!=null){let T=p.point;return Wa.IsLeft(u(p).point.sub(T),A.point.sub(T),x.point.sub(T))}return ue(e.Index,t.Index)}CompareOnFixedOrder(e,t,i,n){let o=this.bundles.get(e).LineIndexInOrder;return(n?-1:1)*ue(o.get(t),o.get(i))}FindStationOnLine(e,t,i,n){for(let o=i.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){n.next=a=>a.next,n.prev=a=>a.prev,n.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){n.next=a=>a.prev,n.prev=a=>a.next,n.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,i){return en(e,t,i)}};var Ne=class extends ae{constructor(e,t){super(null);this.metroGraphData=e,this.bundlingSettings=t}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new mt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new Wa(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new Yr(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let e=0;e<this.metroGraphData.Metrolines.length;e++)this.CreateCurveLine(this.metroGraphData.Metrolines[e],this.metroGraphData.Edges[e])}CreateCurveLine(e,t){let i=new v,o=Ne.FindCurveStart(this.metroGraphData,this.metroOrdering,e),a=Ne.HubSegsOfLine(this.metroGraphData,this.metroOrdering,e);for(let l of a)l!=null&&(i.addSegment(O.mkPP(o,l.start)),i.addSegment(l),o=l.end);i.addSegment(O.mkPP(o,Ne.FindCurveEnd(this.metroGraphData,this.metroOrdering,e))),t.curve=i}static FindCurveStart(e,t,i){let n=e.PointToStations.get(i.Polyline.startPoint.point),o=e.PointToStations.get(i.Polyline.startPoint.next.point),a=n.BundleBases.get(o),l=a.IsParent?t.GetLineIndexInOrder(n,o,i):t.GetLineIndexInOrder(o,n,i);return a.Points[l]}static FindCurveEnd(e,t,i){let n=e.PointToStations.get(i.Polyline.endPoint.prev.point),o=e.PointToStations.get(i.Polyline.endPoint.point),a=o.BundleBases.get(n),l=a.IsParent?t.GetLineIndexInOrder(o,n,i):t.GetLineIndexInOrder(n,o,i);return a.Points[l]}static*HubSegsOfLine(e,t,i){for(let n=i.Polyline.startPoint.next;n.next!=null;n=n.next)yield Ne.SegOnLineVertex(e,t,i,n)}static SegOnLineVertex(e,t,i,n){let o=e.PointToStations.get(n.prev.point),a=e.PointToStations.get(n.point),l=a.BundleBases.get(o),u=t.GetLineIndexInOrder(o,a,i);if(l.OrientedHubSegments[u]==null||l.OrientedHubSegments[u].Segment==null){let c=e.PointToStations.get(n.next.point),h=a.BundleBases.get(c),d=t.GetLineIndexInOrder(c,a,i);return O.mkPP(l.Points[u],h.Points[d])}return l.OrientedHubSegments[u].Segment}CreateSegmentsInsideHubs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?Ne.StandardBezier(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]):Ne.BiArc(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]);a.OrientedHubSegments[u].Segment=h,l.OrientedHubSegments[c].Segment=h}static ShowHubs(e,t,i,n,o=[]){let a=Ne.GetAllDebugCurves(t,e);i!=null&&a.push(Z.mkDebugCurveTWCI(255,1,"red",Se.CreateDiamond(5,25,i.Position))),a=a.concat(o)}static GetAllDebugCurves(e,t){return Ne.GraphNodes(t).concat(Ne.VertexDebugCurves(e,t)).concat(Ne.DebugEdges(t))}static DebugEdges(e){return e.Edges.map(t=>Z.mkDebugCurveTWCI(40,.1,"gray",t.curve))}static VertexDebugCurves(e,t){return Ne.DebugCircles(t).concat(Ne.DebugHubBases(t)).concat(Ne.DebugSegs(t)).concat(Ne.BetweenHubs(e,t))}static BetweenHubs(e,t){let i=[];for(let n of t.Metrolines){let o=Ne.GetInterestingSegs(t,e,n),a=Ne.GetMonotoneColor(n.Polyline.start,n.Polyline.end,o);for(let l of o)i.push(Z.mkDebugCurveTWCI(100,n.Width,a,O.mkPP(l[0],l[1])))}return i}static GetInterestingSegs(e,t,i){let n=new Array;if(e.Stations.length==0||e.Stations[0].BundleBases==null||e.Stations[0].BundleBases.size==0)return[];let o=Ne.FindCurveStart(e,t,i),a=Ne.HubSegsOfLine(e,t,i);for(let l of a)l!=null&&(n.push([o,l.start]),o=l.end);return n.push([o,Ne.FindCurveEnd(e,t,i)]),n}static GetMonotoneColor(e,t,i){return"green"}static DebugHubBases(e){let t=new Array;for(let i of e.Stations)for(let n of i.BundleBases.values())t.push(Z.mkDebugCurveTWCI(100,1,"red",O.mkPP(n.LeftPoint,n.RightPoint)));return t}static DebugCircles(e){return e.Stations.map(t=>Z.mkDebugCurveTWCI(100,.1,"blue",Se.mkCircle(t.Radius,t.Position)))}static DebugSegs(e){let t=new Array;for(let i of e.VirtualStations())for(let n of i.BundleBases.values())for(let o of n.OrientedHubSegments)if(o!=null)if(o.Segment==null){let a=o.Other.BundleBase,l=o.Index,u=o.Other.Index;t.push(O.mkPP(n.Points[l],a.Points[u]))}else t.push(o.Segment);return t.map(i=>Z.mkDebugCurveTWCI(100,.01,"green",i))}static GraphNodes(e){return e.Edges.map(i=>i.sourcePort.Curve).concat(e.Edges.map(i=>i.targetPort.Curve)).map(i=>Z.mkDebugCurveTWCI(40,1,"black",i))}static BiArc(e,t,i,n){let o=e.sub(i);if(o.length<E.distanceEpsilon)return null;let a=o.dot(t.sub(n)),l=-t.dot(n);if(t.dot(i.sub(e))<=0&&t.dot(n)<=0)return Ne.StandardBezier(e,t,i,n);let u=2*(l-1),c=2*a,h=o.dot(o),d;if(Math.abs(u)<E.distanceEpsilon)if(Math.abs(c)>E.distanceEpsilon)d=-h/c;else return null;else{let B=c*c-4*u*h;B<0&&(B=0),B=Math.sqrt(B),d=(-c+B)/(2*u),d<0&&(d=(-c-B)/(2*u))}let p=e.add(t.mul(d)),y=i.add(n.mul(d)),x=f.middle(p,y),A=f.getTriangleOrientation(e,p,x),T=f.getTriangleOrientation(x,y,i);if(A!=T)return Ne.StandardBezier(e,t,i,n);let I=new v;return I.addSegs([Ne.ArcOn(e,p,x),Ne.ArcOn(x,y,i)]),I}static ArcOn(e,t,i){let n={center:null};if(Math.abs(f.signedDoubledTriangleArea(e,t,i))<1e-4||!Ne.FindArcCenter(e,t,i,n))return O.mkPP(e,i);let o=n.center,a=ye(e,o);if(ye(e,t)/a<1e-4)return O.mkPP(e,i);let u=e.sub(o),c=Math.atan2(u.y,u.x),h=i.sub(o),d=Math.atan2(h.y,h.x),p=d-c;if(p<0&&(p+=2*Math.PI,d+=2*Math.PI),p<=Math.PI)return new re(c,d,new f(a,0),new f(0,a),o);for(d>2*Math.PI&&(d-=2*Math.PI),c=Math.PI-c,d=Math.PI-d,c<0&&(c+=2*Math.PI);d<c;)d+=2*Math.PI;return p=d-c,new re(c,d,new f(-a,0),new f(0,a),o)}static FindArcCenter(e,t,i,n){let o=t.sub(e).rotate90Cw(),a=t.sub(i).rotate90Cw();return n.center=f.lineLineIntersection(e,e.add(o),i,i.add(a)),n.center!=null}static StandardBezier(e,t,i,n){let o=ye(e,i)/4;return we.mkBezier([e,e.add(t.mul(o)),i.add(n.mul(o)),i])}FanBezierSegs(){let e=!0,t=5,i=0;for(;e&&i++<t;){e=!1;for(let n of this.metroGraphData.Stations)for(let o of n.BundleBases.values())e||(e=this.FanEdgesOfHubSegment(o))}}FanEdgesOfHubSegment(e){let t=!1;for(let i=0;i<e.Count-1;i++)t||(t=this.FanCouple(e,i,e.CurveCenter,e.Curve.boundingBox.diagonal/2));return t}FanCouple(e,t,i,n){let o=e.OrientedHubSegments[t],a=e.OrientedHubSegments[t+1];if(o==null||O.IntersectPPPP(o.Segment.start,o.Segment.end,a.Segment.start,a.Segment.end)||f.getTriangleOrientation(o.value(0),o.value(.5),o.value(1))!=f.getTriangleOrientation(a.value(0),a.value(.5),a.value(1)))return!1;let u=this.BaseLength(o),c=this.BaseLength(a);return Math.abs(u-c)<E.intersectionEpsilon?!1:u>c?this.AdjustLongerSeg(o,a,i,n):this.AdjustLongerSeg(a,o,i,n)}AdjustLongerSeg(e,t,i,n){let o=e.value(0).sub(t.value(0)),a=e.value(1).sub(t.value(1)),l=Math.min(o.length,a.length),u=t.value(.5),c=Math.max(o.length,a.length);return this.NicelyAligned(e.Segment,o,a,u,l,c)==0?!1:this.FitLonger(e,o,a,u,l,c,i,n)}FitLonger(e,t,i,n,o,a,l,u){let c=e.Segment,h=c.start,d=c.end,p=0,y=10,x=c.start.mul(1-Ne.SqueezeBound).add(c.B(1).mul(Ne.SqueezeBound)),A=c.end.mul(1-Ne.SqueezeBound).add(c.B(2).mul(Ne.SqueezeBound)),T=c.B(1).mul(2).sub(c.start),I=c.B(2).mul(2).sub(c.end),B={highP:T};this.PullControlPointToTheCircle(c.start,B,l,u),T=B.highP;let w=this.NicelyAligned(c,t,i,n,o,a);do{if(w==-1){let M=f.middle(c.B(1),x),F=f.middle(c.B(2),A);T=c.B(1),I=c.B(2),c=new we(h,M,F,d)}else{let M=f.middle(c.B(1),T),F=(c.B(2),I);x=c.B(1),A=c.B(2),c=new we(h,M,F,d)}if((w=this.NicelyAligned(c,t,i,n,o,a))==0)return e.Segment=c,e.Other.Segment=c,!0;if(p++>y)return!1}while(!0)}PullControlPointToTheCircle(e,t,i,n){let o=f.ProjectionToLine(e,t.highP,i),a=Math.sqrt(n*n-o.sub(i).lengthSquared),l=t.highP.sub(o),u=l.length;u>a&&(t.highP=o.add(l.mul(a/u)))}NicelyAligned(e,t,i,n,o,a){let u=e.value(.5).sub(n),c=u.length;return t.dot(u)<0||i.dot(u)<0||c<o-.001?1:c>a+.001?-1:0}BaseLength(e){return e.value(0).sub(e.value(1)).lengthSquared}},Nn=Ne;Nn.debCount=0,Nn.SqueezeBound=.2;var ni=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new jt(this.metroGraphData,this.bundlingSettings),this.cache=new Ts(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.Cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,i){return new ni(e,t).FixRoutingP(i)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=ni.MaxStep,i=Number.POSITIVE_INFINITY,n=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<ni.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=i;i=jt.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,i);let u=n;if(n=this.metroGraphData.VirtualStations().map(c=>c.Position),t<ni.MinStep||this.Converged(t,u,n))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let i=e[0],n=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(i,n),a=O.mkPP(i.Position,n.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>v.CurvesIntersect(a,u));return l.length>0?(Nn.ShowHubs(t,null,null,"/tmp/badcross.svg",[Z.mkDebugCurveTWCI(200,1,"Brown",a),Z.mkDebugCurveTWCI(200,1,"Red",Se.mkCircle(2,i.Position)),Z.mkDebugCurveTWCI(200,1,"Blue",Se.mkCircle(5,n.Position)),Z.mkDebugCurveTWCI(100,1,"Blue",Se.mkCircle(5,n.Position))].concat(l.map(u=>Z.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let i of e){let n=this.metroGraphData.PointToStations.get(i);n&&!n.IsReal&&t.add(n)}return t}}Converged(e,t,i){let n=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(i[l]).lengthSquared,n+=t[l].lengthSquared;return Math.sqrt(o/n)<ni.MinRelativeChange}UpdateMaxStep(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(ni.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let i of this.stationsForOptimizations)if(this.TryMoveStation(i)){e=!0,t.add(i);for(let n of i.Neighbors)n.IsReal||t.add(n)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length==0)return!1;let i=this.BuildStepLength(e,t);if(i<ni.MinStep&&(t=Qw(),i=this.BuildStepLength(e,t),i<ni.MinStep))return!1;let n=t.mul(i),o=e.Position.add(n);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let i of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(V.mkOnPoints([t]),n=>v.PointRelativeToCurveLocation(t,n)!=0))if(e.getELP().has(i)==!1)return!1;for(let i of e.Neighbors){let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(i,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(i.Position,t,i.CdtTriangle,n))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),i=this.BuildForceForPathLengths(e),n=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(i.add(n.add(o)));return a.length<.1?new f(0,0):a.normalize()}BuildStepLength(e,t){let i=ni.MinStep,n=this.CostGain(e,e.Position.add(t.mul(i)));if(n<.01)return 0;for(;2*i<=ni.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(i*2)));if(o<=n)break;i*=2,n=o}return i}CostGain(e,t){let n=this.costCalculator.RadiusGain(e,t);if(n<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return n+a+l+o}BuildForceForInk(e){let t=new f(0,0);for(let n of e.Neighbors){let o=n.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new f(0,0);for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.next.point,l=n.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new f(0,0),i=e.cachedIdealRadius,n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,i,n))throw Nn.ShowHubs(this.metroGraphData,null,e,"/tmp/hubs.svg",[Z.mkDebugCurveTWCI(255,1,"Brown",xr.containingPoly),Z.mkDebugCurveTWCI(100,1,"Blue",Se.mkCircle(i,e.Position))]),new Error;for(let l of n.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/i),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new f(0,0);for(let n of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,n,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,n,e.Position,n.Position,o/2,a)||Nn.ShowHubs(this.metroGraphData,null,e,"/tmp/inside_forbid.svg",[Z.mkDebugCurveTWCI(100,.2,"Blue",O.mkPP(e.Position,n.Position)),Z.mkDebugCurveTWCI(100,.2,"Red",Se.mkCircle(2,e.Position)),Z.mkDebugCurveTWCI(100,.2,"Red",Se.mkCircle(3,n.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},xi=ni;xi.MaxIterations=100,xi.MaxStep=50,xi.MinStep=1,xi.MinRelativeChange=5e-4;function Qw(){return new f(1+2*Xl(),1+2*Xl())}var Dn=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let i=new Dn(e,t);i.GlueConflictingStations(),i.UnglueEdgesFromBundleToSaveInk(!0);let n=0,o=10;for(;++n<o;){let a=i.GlueConflictingStations();if(a||(a=i.RelaxConstrainedEdges()),a||(a=n<=3&&i.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=i.GlueCollinearNeighbors(n)),a||(a=n==3&&i.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,i.RemoveDoublePathCrossings(),i.UnglueEdgesFromBundleToSaveInk(!0);i.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,i=new Set;if(pt(e,e,(o,a)=>this.TryToGlueStations(o,a,t,i)),t.size==0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let n=new Me;for(let o of i){n.add(o.Position);for(let a of o.Neighbors)a.IsReal||n.add(a.Position)}return this.metroGraphData.Initialize(!1),xi.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,n),!0}GetCirclesHierarchy(){for(let i of this.metroGraphData.VirtualStations())i.Radius=this.GetCurrentHubRadius(i);let e=this.metroGraphData.VirtualStations().map(t);return Oe(e);function t(i){let n=i.Position,o=Math.max(i.Radius,5),a=new f(o,o),l=V.mkPP(n.add(a),n.sub(a));return We(i,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,i=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let n of e.Neighbors)i=Math.min(i,e.Position.sub(n.Position).length);return i}}TryToGlueStations(e,t,i,n){if(!ts(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,n,i)||this.TryGlueOrdered(t,e,n,i)}TryGlueOrdered(e,t,i,n){return!n.has(e)&&!i.has(e)&&this.StationGluingIsAllowed(e,t,n)?(this.Map(e,t,i,n),!0):!1}Map(e,t,i,n){n.set(e,t),i.add(t)}StationGluingIsAllowed(e,t,i){for(let o of e.Neighbors){let a=Dn.Glued(o,i),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,i)<0)}ComputeCostDeltaAfterStationGluing(e,t,i){let n=e.Position.sub(t.Position).length;if(e.Radius>=n||t.Radius>=n)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=Dn.Glued(u,i);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)==0?c.Position.sub(t.Position).length:0}o+=jt.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,p=d.prev,y=d.next;h-=p.point.sub(e.Position).length+y.point.sub(e.Position).length,h+=p.point.sub(t.Position).length+y.point.sub(t.Position).length,o+=jt.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let i=this.metroGraphData.Metrolines[t].Polyline;for(let a of i)if(!this.metroGraphData.PointToStations.has(a))return;let n=!1;for(let a of i)if(e.has(this.metroGraphData.PointToStations.get(a))){n=!0;break}if(!n)return;let o=Array.from(i).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=q.mkFromPoints(Dn.GluedPolyline(o,e))}static GluedPolyline(e,t){let i,n=new wS.Stack;n.push(e[0]);let o=new Set;for(i=1;i<e.length-1;i++){let a=Dn.Glued(e[i],t);if(o.has(a)){for(;n.top!=a;)o.delete(n.pop());continue}f.closeDistEps(a.Position,n.top.Position)||(o.add(a),n.push(a))}return n.push(e[i]),Array.from(n).reverse().map(a=>a.Position)}static Glued(e,t){var i;return(i=t.get(e))!=null?i:e}UnglueEdgesFromBundleToSaveInk(e){let t=new Ki;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new ot(a.point,a.next.point);Bg(t,l,o)}}let i=new Me,n=!1;for(let o of this.metroGraphData.Metrolines){let a=bi(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,i,a)&&(n=!0)}return n&&this.metroGraphData.Initialize(!1),(e||n)&&xi.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:i),n}TrySeparateOnPolyline(e,t,i,n){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,i,n)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,i,n){return this.SeparationShortcutAllowed(e,t,n)?(i.add(e.point),i.add(e.next.point),i.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,i){let n=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(n),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=mi(l.getELP(),c.getELP()),d=Z0([i,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,n,o,a)<0)}GetInkgain(e,t,i,n,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,p=i.sub(n).length,y=n.sub(o).length,x=i.sub(o).length;a.size==u.size&&(d-=p),l.size==u.size&&(d-=y);let A=t.get(new ot(i,o));(!A||A.size==0)&&(d+=x),c+=jt.InkError(h,d,this.bundlingSettings);for(let F of u){let z=this.polylineLength.get(F),se=z-(p+y-x);c+=jt.PathLengthsError(z,se,F.IdealLength,this.bundlingSettings)}let T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(i)),I=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),B=this.metroGraphData.GetWidthAN(Array.from(xn(a,u)),this.bundlingSettings.EdgeSeparation),w=mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,i,o,n,I,B,this.bundlingSettings);w>T&&(c-=jt.RError(w,T,this.bundlingSettings)),T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let M=this.metroGraphData.GetWidthAN(Array.from(xn(l,u)),this.bundlingSettings.EdgeSeparation);return w=mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,o,n,i,M,I,this.bundlingSettings),w>T&&(c-=jt.RError(w,T,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=ye(i,n),h=ye(n,o),d=ye(i,o);a.size==u.size&&(this.ink-=c),l.size==u.size&&(this.ink-=h);let p=t.get(new ot(i,o));(!p||p.size==0)&&(this.ink+=d);for(let y of u){let x=this.polylineLength.get(y);this.polylineLength.set(y,x-(c+h-d))}for(let y of u){let x=Array.from(y.Polyline.polylinePoints()).find(A=>A.point.equal(n));this.RemovePolypoint(x),Mg(t,[i,n],y),Mg(t,[n,o],y),K0(t,[i,o],y)}}FindPolylines(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,a=t.get_(i,n),l=t.get_(n,o),u=bi(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,i=e.next;t.next=i,i.prev=t}GlueCollinearNeighbors(e){let t=new Me,i=!1;for(let n of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(n,t,e)&&(i=!0);return i&&(this.metroGraphData.Initialize(!1),xi.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),i}GlueCollinearNeighborsSPN(e,t,i){if(e.Neighbors.length<=1)return!1;let n=new yu,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],n,i);if(n.isEmpty)return!1;for(let a of n)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,i,n,o){if(f.anglePCP(t.Position,e.Position,i.Position)<this.bundlingSettings.AngleThreshold){let l=ye(t.Position,e.Position),u=ye(i.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,i)){this.AddEdgeToGlue(e,i,t,t.Position,n);return}}else if(this.EdgeGluingIsAllowedSSS(e,i,t)){this.AddEdgeToGlue(e,t,i,i.Position,n);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,i);this.EdgeGluingIsAllowedSSSP(e,t,i,h)&&this.AddEdgeToGlue(e,i,t,h,n)}}}ConstructGluingPoint(e,t,i){let n=Math.min(ye(t.Position,e.Position),ye(i.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(i.Position.sub(e.Position).normalize());return e.Position.add(o.mul(n/2))}EdgeGluingIsAllowedSSS(e,t,i){if(t.IsReal||i.IsReal||!ts(t.getELP(),i.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,i,t.Position,i.Position))return!1;let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,i);return!(Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(O.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||Pe.IntersectionsOfLineAndRectangleNodeOverPolylineLR(O.mkPP(t.Position,i.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,i,n){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(n,0,bi(t.getELP(),i.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(i,null,i.Position,n)||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,n)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,i,n){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-ye(e.Position,i.Position)-ye(e.Position,t.Position)+ye(e.Position,n)+ye(n,t.Position)+ye(n,i.Position);o+=jt.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,i).Metrolines){let p=d.Length,y=d.Length-ye(e.Position,i.Position)+ye(e.Position,n)+ye(n,i.Position);o+=jt.PathLengthsError(p,y,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let p=d.Length,y=d.Length-ye(e.Position,t.Position)+ye(e.Position,n)+ye(n,t.Position);o+=jt.PathLengthsError(p,y,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=mt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,i,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=jt.RError(h,c,this.bundlingSettings)),u>ye(e.Position,n)&&!e.IsReal&&(o-=jt.RError(u,ye(e.Position,n),this.bundlingSettings)),o}AddEdgeToGlue(e,t,i,n,o){o.has(i,e)||o.has(t,e)||o.has(e,i)||o.has(e,t)||(o.set(e,i,n),o.set(e,t,n))}GlueEdge(e){let t=e[0],i=e[1],n=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(i.Position)?this.SplitPolylinePoint(o,n):o.prev!=null&&o.prev.point.equal(i.Position)&&this.SplitPolylinePoint(o.prev,n)}SplitPolylinePoint(e,t){if(e.point==t||e.next.point==t)return;let i=dt.mkFromPoint(t);i.polyline=e.polyline,i.next=e.next,i.prev=e,i.next.prev=i,i.prev.next=i}RelaxConstrainedEdges(){let e=new Me,t=!1;for(let i of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(i[0],i[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),xi.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*n/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(ye(e.Position,c[1]),ye(t.Position,c[1])),d=ye(e.Position,t.Position);if(h/d<.1)continue;let y=ye(c[0],c[1]);(l==-1||y<l)&&(l=y,u=c[1])}if(l==-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,bi(e.getELP(),t.getELP())))return!1;i.add(u),i.add(e.Position),i.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new xo(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),xi.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var ja=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,i.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new zt;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!ja.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!ja.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof Mt}ProcessNeighbor(e,t,i){let n=t.Length,o=this._current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var qp=class extends ae{constructor(e,t,i,n,o,a,l,u,c,h){super(null);this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=e,this.regularEdges=e.filter(d=>d.source!=d.target),this.VisibilityGraph=i,this.shortestPathRouter=t,this.LoosePadding=o,this.LooseHierarchy=l,this.TightHierarchy=a,this.EdgeLooseEnterable=u,this.EdgeTightEnterable=c,this.loosePolylineOfPort=h}ThereAreOverlaps(e){return qr(e,e,v.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let e=new Hp(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.CdtProperty,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);Dn.FixRouting(e,this.bundlingSettings),new Nn(e,this.bundlingSettings).run()}FixChildParentEdges(){for(let e of this.regularEdges){let t=e.sourcePort,i=e.targetPort;if(t.Curve.boundingBox.containsRect(i.Curve.boundingBox)){let n=v.intersectionOne(t.Curve,O.mkPP(e.curve.start,e.curve.end),!1),o=e.curve;o.startPoint.point=n.x}if(i.Curve.boundingBox.containsRect(t.Curve.boundingBox)){let n=v.intersectionOne(i.Curve,O.mkPP(e.curve.start,e.curve.end),!0),o=e.curve;o.endPoint.point=n.x}}}static CreateConstrainedDelaunayTriangulation(e){let t=Array.from(e.GetAllLeaves()),i=e.irect,n=i.diagonal/4,o=i.clone();return o.pad(n),qp.GetConstrainedDelaunayTriangulation(t.concat([o.perimeter()]))}static GetConstrainedDelaunayTriangulation(e){let t=new ke(null,e,null);return t.run(),t}FixLocationsForHookAnywherePorts(e){for(let t of e){let i=t.sourcePort instanceof ut;if(i){let n=t.sourcePort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.targetPort,t))}else if(i=t.targetPort instanceof ut,i){let n=t.targetPort;n.SetLocation(this.FigureOutHookLocation(n.LoosePolyline,t.sourcePort,t))}}}FigureOutHookLocation(e,t,i){return t instanceof kt?this.FigureOutHookLocationForClusterOtherPort(e,t,i):this.FigureOutHookLocationForSimpleOtherPort(e,t,i)}FigureOutHookLocationForClusterOtherPort(e,t,i){let n=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),a=new ja(Array.from(t.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(e).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let l of n)l.IsTransparent=!1;return a[a.length-1].point}FigureOutHookLocationForSimpleOtherPort(e,t,i){let n=t.Location,o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(i),l=new fo(this.VisibilityGraph.FindVertex(n),Array.from(e).map(u=>this.VisibilityGraph.FindVertex(u)),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.CdtProperty!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let e=new Map;this.shortestPathRouter.FillCrossedCdtEdges(e);let t=this.GetPathsOnCdtEdge(e);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(t)}GetPathsOnCdtEdge(e){let t=new Map;for(let i of e.keys())for(let n of e.get(i))rs(t,n,i);return t}CalculateEdgeWidthShrinkCoeff(e){let t=0,i=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(e,i))return i;let n=!1;for(;!n||Math.abs(i-t)>.01;){let o=(t+i)/2;this.EdgeSeparationIsOkMN(e,o)?(t=o,n=!0):i=o}return t}EdgeSeparationIsOkMN(e,t){for(let i of e.keys())if(!this.EdgeSeparationIsOk(i,e.get(i),t))return!1;return!0}EdgeSeparationIsOk(e,t,i){return Array.from(t).map(o=>this.bundlingSettings.ActualEdgeWidth(o,i)).reduce((o,a)=>o+a,0)<=e.Capacity}RouteSelfEdges(){for(let e of this.edgesToRoute)if(e.source==e.target){let t={smoothedPolyline:null};e.curve=Re.RouteSelfEdge(e.source.boundaryCurve,this.LoosePadding*2,t)}}FixArrowheads(){for(let e of this.edgesToRoute)Ft.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}},Ei=qp;Ei.SuperLoosePaddingCoefficient=1.1;var Xp=class{constructor(e,t,i){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=i}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var Yp=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source==this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var Ci=class{constructor(e,t,i){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.CdtProperty=t,this.Gates=i}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let i of t.InEdges){let n=new Xp(i,this.VisibilityVerticesToSdVerts.get(i.Source),this.VisibilityVerticesToSdVerts.get(i.Target)),o=this.VisibilityVerticesToSdVerts.get(i.Source);e.InBoneEdges.push(n),o.OutBoneEdges.push(n)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new Yp(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new q,i=this.EdgesToRouteSources.get(e);t.addPoint(i.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(i.Point)?(t.addPoint(a.TargetPoint),i=a.Target):(t.addPoint(a.SourcePoint),i=a.Source);e.curve=t,e.sourcePort instanceof kt&&Ci.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof kt&&Ci.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let i=t.closestParameter(e.end);e.addPoint(t.value(i))}static ExtendPolylineStartToClusterBoundary(e,t){let i=t.closestParameter(e.start);e.PrependPoint(t.value(i))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.CdtProperty!=null&&this.CdtProperty.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let i of t)i.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let n=0;n<this.vertexArray.length;n++){let o=this.vertexArray[n];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),i=this.RouteEdgeWithGroups();for(let n of t)n.IsTransparent=!1;return i}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new zt,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e==0);if(t!=null)return t;for(let i=0;i<this.vertexArray.length;i++)this.vertexArray[i].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let i={priority:0},n=this.Queue.DequeueAndGetPriority(i);if(!(i.priority>=this.LowestCostToTarget)){for(let o=0;o<n.OutBoneEdges.length;o++){let a=n.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(n,a,e,t)}for(let o=0;o<n.InBoneEdges.length;o++){let a=n.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(n,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,i,n){n&&i.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,i,n){n&&i.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,i){let n=this.GetEdgeAdditionalCost(i,e.Cost);if(!(t.Cost<=n))if(t.Cost=n,t.PrevEdge=i,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,n);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof kt&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),n+o<this.LowestCostToTarget&&(this.LowestCostToTarget=n+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.CdtProperty!=null&&this.BundlingSettings.CapacityOverflowCoefficient!=0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity==t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let i=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*i+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*i)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.CdtProperty==null||this.BundlingSettings.CapacityOverflowCoefficient==0)return 0;let t=0;for(let i of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,i);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,i=e.Source.Triangle,n=new Set,o=e.TargetPoint;if(ke.PointIsInsideOfTriangle(o,i))return n;let a=new vs(i,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&n.add(l)}return n}static CostOfCrossingCdtEdge(e,t,i,n){let o=i.lineWidth*t.edgeWidthShrinkCoeff;n.Capacity!=n.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=n.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,i,n){return this.AdjacentToSourceOrTarget(n)?0:Ci.CostOfCrossingCdtEdge(e,t,i,n)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner==this.sourceLoosePoly||e.lowerSite.Owner==this.sourceLoosePoly||e.upperSite.Owner==this.targetLoosePoly||e.lowerSite.Owner==this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let i;if(e instanceof kt){i=e.LoosePolyline;for(let o of i){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof ut){i=e.LoosePolyline;for(let o of i)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let n=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=n[0].boundingBox.diagonal;i=n[0];for(let a=1;a<n.length;a++){let l=n[a],u=l.boundingBox.diagonal;u<o&&(o=u,i=l)}}return i}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,i){let n=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(n);t?(o.IsSourceOfRouting=!0,o.Cost=i,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.CdtProperty!=null&&(this.capacityOverlowPenaltyMultiplier=Ci.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)Ci.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.Constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,i=e.lowerSite.Owner;if(t!=i){let n=It.DistancePoint(new It(t),e.lowerSite.point),o=It.DistancePoint(new It(i),e.upperSite.point);e.Capacity=(n+o)/2}}SetVertexTriangles(){let e=Oe(Array.from(this.CdtProperty.GetTriangles()).map(i=>We(i,i.BoundingBox()))),t=Oe(this.vertexArray.map(i=>We(i,V.mkOnPoints([i.Point]))));tr(e,t,(i,n)=>this.TryToAssigenTriangleToVertex(i,n));for(let i of this.vertexArray);}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&ke.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let i of this.EdgesToRoutes.get(t))for(let n of this.CrossedCdtEdgesOfBoneEdge(i))this.AdjacentToSourceOrTarget(n)||rs(e,t,n)}}};var qa=class{constructor(e,t,i,n,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=_l(i,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new Ei(e.edges,new Ci(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(i,n)=>v.PointRelativeToCurveLocation(i,n)!=0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,i={preGraphs:e};if(this.UniteConnectedPreGraphs(i),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=qa.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let i=Pn(t),n=new Array;for(let o of i){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],n.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=n;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let i of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(i)}static GetIntersectionGraphOfPreGraphs(e){let t=qa.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?Zt(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),i=_l(t,o=>e[o].boundingBox),n=new Array;return pt(i,i,(o,a)=>n.push(new ee(o,a))),n}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,i=e[0],n=this.GetPortCurve(i.sourcePort),o=n.boundingBox;t.add(n),t.add(i.targetPort.Curve),o.addRec(i.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return bu.constructorStatic(e,t)}};var Fe=class extends ae{constructor(e,t,i=2,n=1.5,o=30*(Math.PI/180),a=null,l=null){super(l);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.portLocationsToLoosePolylines=new je;this.multiEdgesSeparation=5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this._edges=t,this.BundlingSettings=a,this.geomGraph=e,this.LoosePadding=n,this.tightPadding=i,this.coneAngle=o}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(e){this.continueOnOverlaps=e}*edges(){if(this._edges!=null)for(let e of this._edges)yield e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(e){this.multiEdgesSeparation=e}static mk2(e,t){return Fe.mk5(e,t.Padding,t.PolylinePadding,t.ConeAngle,t.BundlingSettings)}static mk4(e,t,i,n){return new Fe(e,Array.from(e.edges()),t,i,n,null)}static mk5(e,t,i,n,o){return new Fe(e,Array.from(e.edges()),t,i,n,o)}static mk6(e,t,i,n,o,a){let l=Fe.mk4(e,t,i,n),u=jr.GetShapes(o,a);return l.Initialize(u,n),l}Initialize(e,t){this.rootShapes=e.filter(i=>i.Parents==null||i.Parents.length==0),this.coneAngle=t,this.coneAngle==0&&(this.coneAngle=Math.PI/6)}run(){if(this.geomGraph.isEmpty())return;let e=rr.GetShapes(this.geomGraph,this._edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings),this.Initialize(e,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[e,t]of this.portsToShapes){let i=new Set;Fe.EdgesAttachedToPortAvoidTheNode(e)||i.add(t),this.portsToEnterableShapes.set(e,i)}for(let e of this.rootShapes)for(let t of e.Descendants())for(let i of t.Ports){let n=this.portsToEnterableShapes.get(i);Aa(n,Array.from(t.Ancestors()).filter(o=>o.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(e){return e instanceof Ut||e instanceof kt}SetLoosePolylinesForAnywherePorts(){for(let[e,t]of this.shapesToTightLooseCouples)for(let i of e.Ports){if(i instanceof ut){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}if(i instanceof kt){let o=i;o.LoosePolyline=t.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new Xi;for(let e of this.root.Children){let t=this.shapesToTightLooseCouples.get(e).LooseShape;this.BindLooseShapesUnderShape(e),this.looseRoot.AddChild(t)}}BindLooseShapesUnderShape(e){let t=this.shapesToTightLooseCouples.get(e).LooseShape;for(let i of e.Children){let n=this.shapesToTightLooseCouples.get(i).LooseShape;t.AddChild(n),this.BindLooseShapesUnderShape(i)}}CalculateShapeToBoundaries(e){if(this.ProgressStep(),e.Children.length==0)return;for(let i of e.Children)this.CalculateShapeToBoundaries(i);let t=new Jl(e,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples);t.Calculate(),this.OverlapsDetected||(this.OverlapsDetected=t.OverlapsDetected)}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(e){this._overlapsDetected=e}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*Ei.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let e=new Array;for(let t of this._edges){let i=this.EdgePassport(t),n=e.find(o=>ts(o.passport,i));n||(n={passport:i,edges:[]},e.push(n)),n.edges.push(t)}return e}RouteOnVisGraph(){if(this.ancestorSets=Fe.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let e of this.GroupEdgesByPassport()){let t=e.passport,i=this.GetObstaclesFromPassport(t),n=this.CreateInteractiveEdgeRouter(Array.from(i));this.RouteEdgesWithTheSamePassport(e,n,i)}else this.RouteBundles()}RouteEdgesWithTheSamePassport(e,t,i){let n={regularEdges:[],multiEdges:[]};if(this.RouteMultiEdgesAsBundles){this.SplitOnRegularAndMultiedges(e.edges,n);for(let o of n.regularEdges)this.RouteEdge(t,o);n.multiEdges!=null&&(this.ScaleDownLooseHierarchy(t,i),this.RouteMultiEdges(n.multiEdges,t,e.passport))}else for(let o of e.edges)this.RouteEdge(t,o)}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}RouteEdge(e,t){let i=this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(t);this.ProgressStep(),this.RouteEdgeInternal(t,e),Fe.SetTransparency(i,!1)}ScaleDownLooseHierarchy(e,t){let i=new Array;for(let n of t){let o=this.shapesToTightLooseCouples.get(n);i.push(wt.LoosePolylineWithFewCorners(o.TightPolyline,o.Distance/1.1))}e.LooseHierarchy=Fe.CreateLooseObstacleHierarachy(i),e.ClearActivePolygons(),e.AddActivePolygons(i.map(n=>new It(n)))}RouteMultiEdges(e,t,i){let n=[];for(let l of i)for(let u of l.Children)n.push(u.BoundaryCurve);let o=new Ui;o.InkImportance=1e-5,o.EdgeSeparation=this.MultiEdgesSeparation,new qa(e,t,n,o,l=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(l)).run()}SplitOnRegularAndMultiedges(e,t){let i=new Ki;for(let n of e)Fe.IsEdgeToParent(n)?t.regularEdges.push(n):Fe.RegisterInPortLocationsToEdges(n,i);t.multiEdges=null;for(let n of i.values())n.length==1||this.OverlapsDetected?ji(t.regularEdges,n):(t.multiEdges==null&&(t.multiEdges=new Array),t.multiEdges.push(n))}static RegisterInPortLocationsToEdges(e,t){let i,n=new ot(e.sourcePort.Location,e.targetPort.Location);i=t.get(n),i||(i=new Array,t.set(n,i)),i.push(e)}static IsEdgeToParent(e){return e.sourcePort instanceof ut||e.targetPort instanceof ut}CreateInteractiveEdgeRouter(e){let t=new Set(e.map(n=>this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve)),i=new Pe(this.cancelToken);return i.ObstacleCalculator=new wt(e.map(n=>n.BoundaryCurve),this.tightPadding,this.loosePadding,!1),i.VisibilityGraph=this.visGraph,i.TightHierarchy=this.CreateTightObstacleHierarachy(e),i.LooseHierarchy=Fe.CreateLooseObstacleHierarachy(Array.from(t)),i.UseSpanner=!0,i.LookForRoundedVertices=!0,i.TightPadding=this.tightPadding,i.LoosePadding=this.LoosePadding,i.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,i.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,i.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,i.AllowedShootingStraightLines=this.AllowedShootingStraightLines,i.AddActivePolygons(Array.from(t).map(n=>new It(n))),i}GetObstaclesFromPassport(e){if(e.size==0)return new Set(this.root.Children);let t=this.GetCommonAncestorsAbovePassport(e),i=this.GetAllAncestors(e),n=new Set;for(let l of e)for(let u of l.Children)i.has(u)||n.add(u);let o=mi(new Set(e),n),a=new LS.Queue;for(let l of e)t.has(l)||a.enqueue(l);for(;a.length>0;){let l=a.dequeue();for(let u of l.Parents){for(let c of u.Children)i.has(c)||n.add(c);!t.has(u)&&!o.has(u)&&(a.enqueue(u),o.add(u))}}return n}GetAllAncestors(e){if(e.size==0)return new Set;let t=new Set(e);for(let i of e)t=mi(t,this.ancestorSets.get(i));return t}GetCommonAncestorsAbovePassport(e){if(e.size==0)return new Set;let t=Array.from(e),i=this.ancestorSets.get(t[0]);for(let n=1;n<t.length;n++){let o=t[n];i=bi(i,this.ancestorSets.get(o))}return i}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let e=this.GetLooseHierarchy(),t=Ei.CreateConstrainedDelaunayTriangulation(e),i=new Ci(o=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(o),t,this.FindCdtGates(t));new Ei(this._edges,i,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),e,this.enterableLoose,this.enterableTight,o=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(o))).run()}CreateTheMapToParentLooseShapes(e,t){for(let i of e.Children){let o=this.shapesToTightLooseCouples.get(i).LooseShape.BoundaryCurve;t.set(o,e),this.CreateTheMapToParentLooseShapes(i,t)}}FindCdtGates(e){let t=new Map;this.CreateTheMapToParentLooseShapes(this.root,t);let i=new Set;for(let n of e.PointsToSites.values())for(let o of n.Edges){if(o.CwTriangle==null&&o.CcwTriangle==null)continue;let a=n.Owner,l=o.lowerSite.Owner;if(a==l)continue;let u=t.get(a);if(u){let c=t.get(l);u==c&&i.add(o)}}return i}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let e of this.edges()){let t=new Set,i=new Set;this.GetEdgeEnterablePolylines(e,t,i),this.enterableLoose.set(e,t),this.enterableTight.set(e,i)}}GetEdgeEnterablePolylines(e,t,i){let n=this.portsToShapes.get(e.sourcePort),o=this.portsToShapes.get(e.targetPort);n!=this.root&&this.GetEnterablesForShape(n,t,i),o!=this.root&&this.GetEnterablesForShape(o,t,i)}GetEnterablesForShape(e,t,i){for(let n of this.ancestorSets.get(e)){let o=this.LoosePolyOfOriginalShape(n);o&&t.add(o);let a=this.TightPolyOfOriginalShape(n);a&&i.add(a)}}GetTightHierarchy(){return Oe(Array.from(this.shapesToTightLooseCouples.values()).map(e=>We(e.TightPolyline,e.TightPolyline.boundingBox)))}GetLooseHierarchy(){let e=new Set;for(let t of this.shapesToTightLooseCouples.values())e.add(t.LooseShape.BoundaryCurve);return Oe(Array.from(e).map(t=>We(t,t.boundingBox)))}ScaleLooseShapesDown(){for(let[,e]of this.shapesToTightLooseCouples)e.LooseShape.BoundaryCurve=wt.LoosePolylineWithFewCorners(e.TightPolyline,e.Distance/Ei.SuperLoosePaddingCoefficient)}EdgePassport(e){let t=new Set,i=this.portsToShapes.get(e.sourcePort),n=this.portsToShapes.get(e.targetPort);return this.IsAncestor(i,n)?(Aa(t,n.Parents),t.add(i),t):this.IsAncestor(n,i)?(Aa(t,i.Parents),t.add(n),t):(i!=this.looseRoot&&Aa(t,i.Parents),n!=this.looseRoot&&Aa(t,n.Parents),t)}*AllPorts(){for(let e of this.edges())yield e.sourcePort,yield e.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let e of this.root.Descendants())for(let t of e.Ports)this.portsToShapes.set(t,e);for(let e of this.AllPorts())this.portsToShapes.has(e)||(this.root.Ports.add(e),this.portsToShapes.set(e,this.root))}RouteEdgeInternal(e,t){let i=new Array;e.sourcePort instanceof ut||ji(i,this.AddVisibilityEdgesFromPort(e.sourcePort)),e.targetPort instanceof ut||ji(i,this.AddVisibilityEdgesFromPort(e.targetPort));let n={smoothedPolyline:null};if(f.closeDistEps(e.sourcePort.Location,e.targetPort.Location)?e.curve=Re.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.LoosePadding*2,e.GetMaxArrowheadLength()),n):e.curve=t.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e.sourcePort,e.targetPort,!0,n),e.smoothedPolyline=n.smoothedPolyline,e.curve==null)throw new Error;for(let o of i)Ie.RemoveEdge(o);Ft.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!1)}*AddVisibilityEdgesFromPort(e){let t,i;if(e instanceof Ut||!(t=this.portsToShapes.get(e))||!(i=this.shapesToTightLooseCouples.get(t)))return;let n=i.LooseShape;for(let o of n.BoundaryCurve)this.visGraph.FindEdgePP(e.Location,o)==null&&(yield this.visGraph.AddEdgePP(e.Location,o))}MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(e){let t=this.portsToShapes.get(e.sourcePort),i=this.portsToShapes.get(e.targetPort),n=new Array;for(let o of this.GetTransparentShapes(e.sourcePort,e.targetPort,t,i))o!=null&&n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.sourcePort))n.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.targetPort))n.push(this.LooseShapeOfOriginalShape(o));return Fe.SetTransparency(n,!0),n}LooseShapeOfOriginalShape(e){return e==this.root?this.looseRoot:this.shapesToTightLooseCouples.get(e).LooseShape}LoosePolyOfOriginalShape(e){return this.LooseShapeOfOriginalShape(e).BoundaryCurve}TightPolyOfOriginalShape(e){return e==this.root?null:this.shapesToTightLooseCouples.get(e).TightPolyline}*GetTransparentShapes(e,t,i,n){for(let o of this.ancestorSets.get(i))yield o;for(let o of this.ancestorSets.get(n))yield o;Fe.EdgesAttachedToPortAvoidTheNode(e)||(yield i),Fe.EdgesAttachedToPortAvoidTheNode(t)||(yield n)}static SetTransparency(e,t){for(let i of e)i.IsTransparent=t}IsAncestor(e,t){let i;return t!=null&&(i=this.ancestorSets.get(t))!=null&&i.has(e)}static CreateLooseObstacleHierarachy(e){return Oe(e.map(t=>We(t,t.boundingBox)))}CreateTightObstacleHierarachy(e){let t=e.map(i=>this.shapesToTightLooseCouples.get(i).TightPolyline);return Oe(t.map(i=>We(i,i.boundingBox)))}CalculateVisibilityGraph(){let e=this.LineSweeperPorts!=null?Me.mk(this.LineSweeperPorts):new Me;this.ProcessHookAnyWherePorts(e),this.portRTree=ki(Array.from(e.values()).map(t=>[V.rectangleOnPoint(t),t])),this.visGraph=new Ie,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(e,t,i,n=null,o=null){let a=Array.from(t.Edges).map(l=>Z.mkDebugCurveTWCI(100,1,l.IsPassable!=null&&l.IsPassable()?"green":"black",O.mkPP(l.SourcePoint,l.TargetPoint)));if(i!=null)for(let l of i){a.push(Z.mkDebugCurveTWCI(100,.3,"brown",l));for(let u of l)a.push(Z.mkDebugCurveTWCI(100,1,"green",Se.mkCircle(1,u)))}if(n!=null)for(let l of n)a.push(Z.mkDebugCurveTWCI(100,10,"navy",l));if(o!=null)for(let l of o)a.push(Z.mkDebugCurveTWCI(100,10,"red",l))}ProcessHookAnyWherePorts(e){for(let t of this.edges())t.sourcePort instanceof ut||t.sourcePort instanceof kt||e.add(t.sourcePort.Location),t.targetPort instanceof ut||t.targetPort instanceof kt||e.add(t.targetPort.Location)}FillVisibilityGraphUnderShape(e){let t=e.Children;for(let h of t)this.FillVisibilityGraphUnderShape(h);let i=this.shapesToTightLooseCouples.get(e),n=i?i.LooseShape.BoundaryCurve:null,o=i?i.LooseShape:this.looseRoot,a=new Set(o.Children.map(h=>h.BoundaryCurve)),l=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(n),u=new Ie,c=ho.mk([],u,this.coneAngle,l,n);c.run(),u=new Ie,c=ho.mk(Array.from(a),u,this.coneAngle,l,n),c.run(),this.ProgressStep();for(let h of u.Edges)this.TryToCreateNewEdgeAndSetIsPassable(h,o);this.AddBoundaryEdgesToVisGraph(n)}get Bidirectional(){return this.bidirectional}set Bidirectional(e){this.bidirectional=e}TryToCreateNewEdgeAndSetIsPassable(e,t){let i=this.visGraph.FindEdgePP(e.SourcePoint,e.TargetPoint);i==null&&(i=this.visGraph.AddEdgePP(e.SourcePoint,e.TargetPoint),t!=null&&(i.IsPassable=()=>t.IsTransparent))}AddBoundaryEdgesToVisGraph(e){if(e==null)return;let t;for(let i=e.startPoint;t=i.nextOnPolyline,this.visGraph.AddEdgePP(i.point,t.point),t!=e.startPoint;i=t);}RemoveInsidePortsAndSplitBoundaryIfNeeded(e){let t=new Me;if(e==null){for(let o of this.portRTree.GetAllLeaves())t.add(o);return this.portRTree.Clear(),t}let i=e.boundingBox,n=this.portRTree.GetAllIntersecting(i);for(let o of n)switch(v.PointRelativeToCurveLocation(o,e)){case 2:t.add(o),this.portLocationsToLoosePolylines.set(o,e),this.portRTree.Remove(V.rectangleOnPoint(o),o);break;case 1:this.portRTree.Remove(V.rectangleOnPoint(o),o),this.portLocationsToLoosePolylines.set(o,e);let a=Fe.FindPointOnPolylineToInsertAfter(e,o);if(a!=null)gt.InsertPointIntoPolylineAfter(e,a,o);else throw new Error;break}return t}static FindPointOnPolylineToInsertAfter(e,t){for(let i=e.startPoint;;){let n=i.nextOnPolyline;if(f.closeDistEps(t,i.point)||f.closeDistEps(t,n.point))return null;let o=f.distToLineSegment(t,i.point,n.point).dist;if($(o,0))return i;if(i=n,i==e.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length==1){let e=this.rootShapes[0];if(e.BoundaryCurve==null){this.root=e;return}}this.rootWasCreated=!0,this.root=new Xi(null);for(let e of this.rootShapes)this.root.AddChild(e)}RemoveRoot(){if(this.rootWasCreated)for(let e of this.rootShapes)e.RemoveParent(this.root)}static GetAncestorSetsMap(e){let t=new Map;for(let i of e.filter(n=>!t.has(n)))t.set(i,Fe.GetAncestorSet(i,t));return t}static GetAncestorSet(e,t){let i=new Set(e.Parents);for(let n of e.Parents){let o=t.get(n);o||t.set(n,o=Fe.GetAncestorSet(n,t));for(let a of o)i.add(a)}return i}static CreatePortsIfNeeded(e){for(let t of e){if(t.sourcePort==null){let i=t;new zr(()=>i.source.boundaryCurve,()=>i.source.center,new f(0,0))}if(t.targetPort==null){let i=t;new zr(()=>i.target.boundaryCurve,()=>i.target.center,new f(0,0))}}}static ComputeLooseSplinePadding(e,t){let i=2*t;return(e-i)/8}};function xS(s,e,t){let i=s.layoutSettings?s.layoutSettings.edgeRoutingSettings:Fp(s);new Fe(s,e,i.Padding,i.PolylinePadding,i.coneAngle,i.BundlingSettings,t).run()}function CS(s,e,t){if(e)for(let i of e){if(t&&t.canceled)return;ar.RouteEdge(i,s.padding)}else for(let i of s.deepNodes()){if(t&&t.canceled)return;for(let n of i.outEdges())n.curve==null&&ar.RouteEdge(n,s.padding);for(let n of i.selfEdges())n.curve==null&&ar.RouteEdge(n,s.padding)}}var ar=class extends ae{constructor(e,t){super(null);this.edges=e,this.padding=t}run(){Fe.CreatePortsIfNeeded(this.edges);for(let e of this.edges)ar.RouteEdge(e,this.padding)}static RouteEdge(e,t){let i=e;i.sourcePort==null&&(i.sourcePort=zr.mk(()=>e.source.boundaryCurve,()=>e.source.center)),i.targetPort==null&&(i.targetPort=zr.mk(()=>e.target.boundaryCurve,()=>e.target.center)),ar.ContainmentLoop(i,t)||(i.curve=ar.GetEdgeLine(e)),Ft.trimSplineAndCalculateArrowheadsII(i,i.sourcePort.Curve,i.targetPort.Curve,e.curve,!1)}static ContainmentLoop(e,t){let i=e.sourcePort.Curve,n=e.targetPort.Curve;if(i==null||n==null)return!1;let o=i.boundingBox,a=n.boundingBox,l=o.containsRect(a),u=!l&&a.containsRect(o);return l||u?(e.curve=ar.CreateLoop(o,a,u,t),!0):!1}static CreateLoop(e,t,i,n){return i?ar.CreateLoop_(e,t,n,!1):ar.CreateLoop_(t,e,n,!0)}static CreateLoop_(e,t,i,n){let o=e.center,a=ar.FindClosestPointOnBoxBoundary(e.center,t),l=a.sub(o),c=(Math.abs(l.x)<E.distanceEpsilon?Math.min(o.y-t.bottom,t.top-o.y):Math.min(o.x-t.left,t.right-o.x))/2,h=Math.min(i,c);l.length<=E.distanceEpsilon&&(l=new f(1,0));let d=l.normalize(),p=d.rotate(Math.PI/2),y=a.add(d.mul(i)),x=y.add(p.mul(h)),A=a.add(p.mul(h)),T=o.add(p.mul(h));return(n?Ze.mkFromPoints([T,A,x,y,a,o]):Ze.mkFromPoints([o,a,y,x,A,T])).createCurve()}static FindClosestPointOnBoxBoundary(e,t){let i=e.x-t.left<t.right-e.x?t.left:t.right,n=e.y-t.bottom<t.top-e.y?t.bottom:t.top;return Math.abs(i-e.x)<Math.abs(n-e.y)?new f(i,e.y):new f(e.x,n)}static GetEdgeLine(e){let t,i;e.sourcePort==null?(t=e.source.center,i=e.source.boundaryCurve):(t=e.sourcePort.Location,i=e.sourcePort.Curve);let n,o;e.targetPort==null?(n=e.target.center,o=e.target.boundaryCurve):(n=e.targetPort.Location,o=e.targetPort.Curve);let a=O.mkPP(t,n),l=v.getAllIntersections(i,a,!1);if(l.length>0){let u=a.trim(l[0].par1,1);u instanceof O&&(a=u,l=v.getAllIntersections(o,a,!1),l.length>0&&(u=a.trim(0,l[0].par1),u instanceof O&&(a=u)))}return a}static CreateSimpleEdgeCurveWithUnderlyingPolyline(e){let t=e.source.center,i=e.target.center;if(e.source==e.target){let n=2/(3*e.source.boundaryCurve.boundingBox.width),o=e.source.boundingBox.height/4;e.underlyingPolyline=ar.CreateUnderlyingPolylineForSelfEdge(t,n,o),e.curve=e.underlyingPolyline.createCurve()}else e.underlyingPolyline=Ze.mkFromPoints([t,i]),e.curve=e.underlyingPolyline.createCurve();Ft.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(e,t,i){let n=e.add(new f(0,i)),o=e.add(new f(t,i)),a=e.add(new f(t,i*-1)),l=e.add(new f(0,i*-1)),u=Ge.mkSiteP(e),c=new Ze(u);return u=Ge.mkSiteSP(u,n),u=Ge.mkSiteSP(u,o),u=Ge.mkSiteSP(u,a),u=Ge.mkSiteSP(u,l),Ge.mkSiteSP(u,e),c}static SetStraightLineEdgesWithUnderlyingPolylines(e){Fe.CreatePortsIfNeeded(Array.from(e.edges()));for(let t of e.edges())ar.CreateSimpleEdgeCurveWithUnderlyingPolyline(t)}};var Pi=class extends ae{constructor(e,t,i,n,o,a){super(null);this.settings=e,this.OriginalGraph=t,this.Database=i,this.ProperLayeredGraph=o,this.LayerArrays=n,this.IntGraph=a}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){for(let e of this.OriginalGraph.deepNodes())for(let t of e.outEdges())t.curve||ar.RouteEdge(t,Math.max(t.source.padding,t.target.padding))}RouteFlatEdges(){}createRegularSplines(){for(let e of this.Database.RegularMultiedges()){let t=e.length,i=t==1&&!this.FanAtSourceOrTarget(e[0]);for(let n=Math.floor(t/2);n<t;n++)this.createSplineForNonSelfEdge(e[n],i);for(let n=Math.floor(t/2)-1;n>=0;n--)this.createSplineForNonSelfEdge(e[n],i)}}FanAtSourceOrTarget(e){return this.ProperLayeredGraph.OutDegreeIsMoreThanOne(e.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(e.target)}createSelfSplines(){for(let[e,t]of this.Database.Multiedges.keyValues()){let i=e;if(i.x==i.y){let n=this.Database.Anchors[i.x],o=n.leftAnchor;for(let a of t){let l=this.settings.NodeSeparation+(this.settings.MinNodeWidth+o),u=n.bottomAnchor/2,c=n.origin,h=c.add(new f(0,u)),d=c.add(new f(l,u)),p=c.add(new f(l,u*-1)),y=c.add(new f(0,u*-1)),x=Ge.mkSiteP(c),A=new Ze(x);x=Ge.mkSiteSP(x,h),x=Ge.mkSiteSP(x,d),x=Ge.mkSiteSP(x,p),x=Ge.mkSiteSP(x,y),Ge.mkSiteSP(x,c);let T=A.createCurve();if(a.curve=T,a.edge.underlyingPolyline=A,o=l,a.edge.label!=null){o+=a.edge.label.width;let I=a.edge.label.center=new f(T.value((T.parStart+T.parEnd)/2).x+a.labelWidth/2,n.y),B=new f(a.edge.label.width/2,a.edge.label.height/2),w=V.mkPP(I.add(B),I.sub(B));a.edge.label.boundingBox=w}Ft.trimSplineAndCalculateArrowheadsII(a.edge,a.edge.source.boundaryCurve,a.edge.target.boundaryCurve,T,!1)}}}}createSplineForNonSelfEdge(e,t){e.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(e,t),e.IsVirtualEdge||(e.updateEdgeLabelPosition(this.Database.Anchors),Ft.trimSplineAndCalculateArrowheadsII(e.edge,e.edge.source.boundaryCurve,e.edge.target.boundaryCurve,e.curve,!0)))}drawSplineBySmothingThePolyline(e,t){let i=new Bt(e,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),n=i.getSpline(t);e.reversed?(e.curve=n.reverse(),e.underlyingPolyline=i.Reverse().GetPolyline):(e.curve=n,e.underlyingPolyline=i.GetPolyline)}static UpdateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new f(t.x+t.rightAnchor/2,t.y),i=O.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new f(t.x-t.leftAnchor/2,t.y),i=O.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let n=Pi.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&v.getAllIntersections(e.curve,v.polyFromBox(e.labelBBox),!1).length==0){let o={curveClosestPoint:void 0,labelSideClosest:void 0};if(Pi.FindClosestPoints(o,n,i))Pi.ShiftLabel(e,o);else{let a=n.closestParameter(i.start),l=n.closestParameter(i.end);n.value(a).sub(i.start).length<n.value(l).sub(i.end).length?(o.curveClosestPoint=n.value(a),o.labelSideClosest=i.start):(o.curveClosestPoint=n.value(l),o.labelSideClosest=i.end),Pi.ShiftLabel(e,o)}}}static ShiftLabel(e,t){let i=e.lineWidth/2,n=t.curveClosestPoint.sub(t.labelSideClosest),o=n.length;o>i&&(e.label.center=e.label.center.add(n.div(o*(o-i))))}static FindClosestPoints(e,t,i){let n=v.minDistWithinIntervals(t,i,t.parStart,t.parEnd,i.parStart,i.parEnd,(t.parStart+t.parEnd)/2,(i.parStart+i.parEnd)/2);return n?(e.curveClosestPoint=n.aX,e.labelSideClosest=n.bX,!0):!1}static GetSegmentInFrontOfLabel(e,t){if(e instanceof v){let i=e;for(let n of i.segs)if((n.start.y-t)*(n.end.y-t)<=0)return n}return null}static GetNodeKind(e,t){return e==0?0:e<t.count?1:2}};var mu=class extends ae{constructor(e,t,i){super(i);this.LayersAreDoubled=!1;if(e==null)return;this.originalGraph=e,this.sugiyamaSettings=t;let n=Array.from(e.shallowNodes());this.nodeIdToIndex=new Map;let o=0;for(let l of n)this.nodeIdToIndex.set(l.id,o++);let a=[];for(let l of this.originalGraph.edges()){let u=this.nodeIdToIndex.get(l.source.id);if(u==null)continue;let c=this.nodeIdToIndex.get(l.target.id);if(c==null)continue;let h=new Kt(u,c,l);a.push(h)}this.IntGraph=new yn(a,e.shallowNodeCount),this.IntGraph.nodes=n,this.database=new bg(n.length);for(let l of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(l);this.cycleRemoval()}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount==0){this.originalGraph.boundingBox=V.mkEmpty();return}hL(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode==3&&this.runPostLayering(),dL(this.originalGraph,this.sugiyamaSettings.transform),this.originalGraph.updateBoundingBox(),this.SetMargins()}SetMargins(){this.originalGraph.boundingBox.right+=this.sugiyamaSettings.margins.right,this.originalGraph.boundingBox.top+=this.sugiyamaSettings.margins.bottom,this.originalGraph.boundingBox.left-=this.sugiyamaSettings.margins.left,this.originalGraph.boundingBox.bottom-=this.sugiyamaSettings.margins.bottom}runPostLayering(){let e=this.sugiyamaSettings.edgeRoutingSettings,t=this.constrainedOrdering!=null?0:e.EdgeRoutingMode;switch(t){case 3:this.calculateEdgeSplines();break;case 2:throw new Error("not implemented");case 0:throw new Error("not implemented");case 1:throw new Error("not implemented");case 4:case 5:throw new Error("Not implemented yet");default:throw new Error("Unexpected mode "+t)}}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let e=this.sugiyamaSettings.verticalConstraints,t=e.isEmpty?Fr.getFeedbackSet(this.IntGraph):e.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(t)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let e=this.CalculateLayerArrays();return this.UpdateNodePositionData(),e}UpdateNodePositionData(){this.TryToSatisfyMinWidhtAndMinHeight();for(let e=0;e<this.IntGraph.nodeCount&&e<this.database.Anchors.length;e++)this.IntGraph.nodes[e].center=this.database.Anchors[e].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let e=0;e<this.originalGraph.shallowNodeCount;e++)this.SnapLeftSidesOfTheNodeToGrid(e,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(e,t){let i=this.IntGraph.nodes[e],n=this.database.Anchors[e];n.leftAnchor-=t/2,n.rightAnchor-=t/2;let o=i.boundingBox.left,a=Math.floor(o/t),l=o-a*t;Math.abs(l)<.001||(Math.abs(l)<=t/2?i.center=i.center.add(new f(-l,0)):i.center=i.center.add(new f(t-l,0)),n.x=i.center.x)}TryToSatisfyMinWidhtAndMinHeight(){this.TryToSatisfyMinWidth(),this.TryToSatisfyMinHeight()}TryToSatisfyMinWidth(){if(this.sugiyamaSettings.MinimalWidth==0)return;this.GetCurrentWidth()<this.sugiyamaSettings.MinimalWidth&&this.StretchWidth()}StretchWidth(){let e=new Jt;for(let i of this.originalGraph.shallowNodes())e.AddValue(i.boundingBox.width/2),e.AddValue(this.sugiyamaSettings.MinimalWidth-i.boundingBox.width/2);let t=new Jt;for(let i of this.NodeAnchors())t.AddValue(i.x);if(t.length>E.distanceEpsilon){let i=e.length/t.length;if(i>1)for(let n of this.anchors)n.x*=i}}TryToSatisfyMinHeight(){if(this.sugiyamaSettings.MinimalHeight==0)return;this.GetCurrentHeight()<this.sugiyamaSettings.MinimalHeight&&this.StretchHeight()}GetCurrentHeight(){let e=new Jt;for(let t of this.NodeAnchors())e.AddValue(t.top),e.AddValue(t.bottom);return e.length}StretchHeight(){let e=new Jt;for(let i of this.originalGraph.shallowNodes())e.AddValue(i.boundingBox.height/2),e.AddValue(this.sugiyamaSettings.MinimalHeight-i.boundingBox.height/2);let t=new Jt;for(let i of this.NodeAnchors())t.AddValue(i.y);if(t.length>E.distanceEpsilon){let i=e.length/t.length;if(i>1)for(let n of this.anchors)n.y*=i}}*NodeAnchors(){let e=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let t=0;t<e;t++)yield this.anchors[t]}GetCurrentWidth(){let e=new Jt;for(let t of this.NodeAnchors())e.AddValue(t.left),e.AddValue(t.right);return e.length}ExtendLayeringToUngluedSameLayerVertices(e){let t=this.verticalConstraints;for(let i=0;i<e.length;i++)e[i]=e[t.nodeToRepr(i)];return e}calculateEdgeSplines(){new Pi(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(e){let t=e.GetLayers();zl.Balance(this.gluedDagSkeletonForLayering,t,this.GetNodeCountsOfGluedDag(),null),t=this.ExtendLayeringToUngluedSameLayerVertices(t);let i=new kr(t);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return i=this.YLayeringAndOrderingWithoutHorizontalConstraints(i),i;throw new Error("not implemented")}CreateProperLayeredGraph(e){let t=e.length,i=0;for(let o of this.database.SkeletonEdges()){let a=tL(e,o);a>0&&(o.LayerEdges=new Array(a));let l=0;if(a>1){let u=t+i++,c=new Vr(o.source,u,o.CrossingWeight,o.weight);o.LayerEdges[l++]=c;for(let h=0;h<a-2;h++)u++,i++,c=new Vr(u-1,u,o.CrossingWeight,o.weight),o.LayerEdges[l++]=c;c=new Vr(u,o.target,o.CrossingWeight,o.weight),o.LayerEdges[l]=c}else if(a==1){let u=new Vr(o.source,o.target,o.CrossingWeight,o.weight);o.LayerEdges[l]=u}}let n=new Array(this.originalGraph.shallowNodeCount+i).fill(0);for(let o of this.database.SkeletonEdges())if(o.LayerEdges!=null){let a=e[o.source];n[o.source]=a--;for(let l of o.LayerEdges)n[l.Target]=a--}else n[o.source]=e[o.source],n[o.target]=e[o.target];return this.properLayeredGraph=new pi(new yn(Array.from(this.database.SkeletonEdges()),e.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new kr(n)}YLayeringAndOrderingWithoutHorizontalConstraints(e){let t=this.CreateProperLayeredGraph(e.y);return ao.OrderLayers(this.properLayeredGraph,t,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),va.UpdateLayerArrays1(this.properLayeredGraph,t),t}CalculateYLayers(){let e=this.YLayeringAndOrdering(new Gg(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?e:this.InsertLayersIfNeeded(e)}InsertLayersIfNeeded(e){this.InsertVirtualEdgesIfNeeded(e);let t=this.AnalyzeNeedToInsertLayersAndHasMultiedges(e);if(t.needToInsertLayers){let i=oo.InsertLayers(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la,this.LayersAreDoubled=!0}else if(t.multipleEdges){let i=Wi.InsertPaths(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=i.layeredGraph,e=i.la}return this.RecreateIntGraphFromDataBase(),e}RecreateIntGraphFromDataBase(){let e=new Array;for(let t of this.database.Multiedges.values())e=e.concat(t);this.IntGraph.SetEdges(e,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(e){if(this.constrainedOrdering==null){for(let[t,i]of this.database.Multiedges.keyValues())if(i.length%2==0&&e.y[t.x]-1==e.y[t.y]){let n=new Re(null),o=new Kt(t.x,t.y,n);o.IsVirtualEdge=!0,i.splice(i.length/2,0,o),this.IntGraph.addEdge(o)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(e){let t=!1,i=!1;for(let n of this.IntGraph.edges)if(n.hasLabel&&e.y[n.source]!=e.y[n.target]){t=!0;break}if(t==!1&&this.constrainedOrdering==null){for(let[n,o]of this.database.Multiedges.keyValues())if(o.length>1&&(i=!0,e.y[n.x]-e.y[n.y]==1)){t=!0;break}}return{needToInsertLayers:t,multipleEdges:i}}UseBrandesXCalculations(e){return e.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(e){this.anchors=Kw(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),Jw(e,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let e=0;e<this.anchors.length;e++){let t=this.anchors[e];if(t.labelIsToTheRightOfTheSpline){let i=this.GetSuccessorAndPredecessor(e);if(!oL(t,i.predecessor,i.successor)){let n=i.predecessor.origin.sub(t.origin).length+i.successor.origin.sub(t.origin).length,o=t.right-t.leftAnchor,a=new f(o,t.y);i.predecessor.origin.sub(a).length+i.successor.origin.sub(a).length<n&&MS(t)}}}}GetSuccessorAndPredecessor(e){let t;for(let n of this.properLayeredGraph.InEdges(e))t=n.Source;let i;for(let n of this.properLayeredGraph.OutEdges(e))i=n.Target;return{predecessor:this.anchors[t],successor:this.anchors[i]}}CalculateLayerArrays(){let e=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(e),this.UseBrandesXCalculations(e)?this.CalculateXPositionsByBrandes(e):this.CalculateXLayersByGansnerNorth(e)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=e,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),e}StretchToDesiredAspectRatio(e,t){e>t?this.StretchInYDirection(e/t):e<t&&this.StretchInXDirection(t/e)}StretchInYDirection(e){let t=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let n of this.database.Anchors)n.bottomAnchor=n.bottomAnchor*e,n.topAnchor=n.topAnchor*e,n.y=t+e*(n.y-t);let i=this.originalGraph.height*e;this.originalGraph.boundingBox=new V({left:this.originalGraph.boundingBox.left,top:t+i/2,right:this.originalGraph.boundingBox.right,bottom:t-i/2})}StretchInXDirection(e){let t=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let n of this.database.Anchors)n.leftAnchor=n.leftAnchor*e,n.rightAnchor=n.rightAnchor*e,n.x=t+e*(n.x-t);let i=this.originalGraph.width*e;this.originalGraph.boundingBox=new V({left:t-i/2,top:this.originalGraph.boundingBox.top,right:t+i/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length==0)return 0;let e=new V({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let n=1;n<this.anchors.length;n++){let o=this.anchors[n];e.add(o.leftTop),e.add(o.rightBottom)}let t=e.leftTop.sub(e.rightBottom).length/2,i=new f(t*-1,t);return e.add(e.leftTop.add(i)),e.add(e.rightBottom.sub(i)),this.originalGraph.boundingBox=e,e.height!=0?e.width/e.height:0}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let e=!1;for(let t of this.database.AllIntEdges())t.LayerSpan==2&&(e=this.ShiftVertexWithNeighbors(t.LayerEdges[0].Source,t.LayerEdges[0].Target,t.LayerEdges[1].Target)||e);return e}ShiftVertexWithNeighbors(e,t,i){let n=this.database.Anchors[e],o=this.database.Anchors[i],a=this.database.Anchors[t],l=(a.y-n.y)*((o.x-n.x)/(o.y-n.y))+n.x,u=1e-4;return l>a.x+u?this.TryShiftToTheRight(l,t):l<a.x-u?this.TryShiftToTheLeft(l,t):!1}TryShiftToTheLeft(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n>0){let o=this.database.Anchors[i[n-1]],a=Math.max(o.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[t].leftAnchor),e);return a<this.database.Anchors[t].x-1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}TryShiftToTheRight(e,t){let i=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],n=this.engineLayerArrays.x[t];if(n<i.length-1){let o=this.database.Anchors[i[n+1]],a=Math.min(o.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[t].rightAnchor),e);return a>this.database.Anchors[t].x+1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}CalculateXLayersByGansnerNorth(e){this.xLayoutGraph=this.CreateXLayoutGraph(e),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let e=new Yl(this.xLayoutGraph,null).GetLayers();for(let t=0;t<this.database.Anchors.length;t++)this.anchors[t].x=e[t]}CreateXLayoutGraph(e){let t=this.properLayeredGraph.NodeCount,i=new Array;for(let o of this.properLayeredGraph.Edges){let a=new Kt(t,o.Source,null),l=new Kt(t,o.Target,null);l.weight=o.Weight,a.weight=o.Weight,a.separation=0,l.separation=0,t++,i.push(a),i.push(l)}for(let o of e.Layers)for(let a=o.length-1;a>0;a--){let l=o[a],u=o[a-1],c=new Kt(l,u,null),h=this.database.Anchors[l],d=this.database.Anchors[u],p=h.leftAnchor+(d.rightAnchor+this.sugiyamaSettings.NodeSeparation);c.separation=Math.ceil(p+.5),i.push(c)}let n=new _g(this.IntGraph,this.properLayeredGraph,e,i,t);return n.SetEdgeWeights(),n}CalculateXPositionsByBrandes(e){Jc.CalculateXCoordinates(e,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let e=new gi(this.IntGraph.nodeCount);for(let[i,n]of this.database.Multiedges.keyValues()){if(i.isDiagonal())continue;let o=this.verticalConstraints.gluedIntEdge(n[0]);o.source!=o.target&&e.set(o.source,o.target,o)}let t=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(i=>eL(i,null));for(let i of t)e.set(i.source,i.target,i);return Array.from(e.values())}static CalcAnchorsForOriginalNode(e,t,i,n,o){let a={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(t.nodes!=null){let c=t.nodes[e];lL(a,c,o)}uL(e,a,n,o);let l=o.MinNodeWidth/2;a.leftAnchor<l&&(a.leftAnchor=l),a.rightAnchor<l&&(a.rightAnchor=l);let u=o.MinNodeHeight/2;a.topAnchor<u&&(a.topAnchor=u),a.bottomAnchor<u&&(a.bottomAnchor=u),i[e]=gr.mkAnchor(a.leftAnchor,a.rightAnchor,a.topAnchor,a.bottomAnchor,t.nodes[e],o.LabelCornersPreserveCoefficient),i[e].padding=t.nodes[e].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new yn(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let e=new gi(this.IntGraph.nodeCount);for(let t of this.gluedDagSkeletonForLayering.edges)e.set(t.source,t.target,t);for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!=t.y){let n=this.verticalConstraints.gluedIntPair(t);if(n.x==n.y)continue;let o=e.get(n.x,n.y);for(let a of i)o.weight+=a.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function RS(s,e){if(e==0)return 0;let t=Math.floor(s/e),i=s-t*e;return Math.abs(i)<1e-4?0:e-i}function Zw(s,e){for(let t of s)if(t<e)return!0;return!1}function Kw(s,e,t,i,n){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new gr(n.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)mu.CalcAnchorsForOriginalNode(a,i,o,s,n);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!=a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=$p()*4,c.topAnchor=c.bottomAnchor=OS(n)/2):(c.leftAnchor=c.rightAnchor=$p()/2,c.topAnchor=c.bottomAnchor=OS(n)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=$p()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function $p(){return 1}function OS(s){return s.MinNodeHeight*1.5/8}function BS(s,e,t,i,n,o){let a=0;if(t>0){let l=sL(e.Layers[t-1],e.y,i);if(l.length){let u=n.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>aL(h,c,u,s)))}}return a}function Jw(s,e,t,i,n,o,a){let l=i.Anchors,u=t.Margins+e,c=0;for(let h of s.Layers){let d=0,p=0;for(let I of h){let B=l[I];B.bottomAnchor>d&&(d=B.bottomAnchor),B.topAnchor>p&&(p=B.topAnchor)}rL(h,d,p,t.shallowNodeCount,i.Anchors);let y=BS(i,s,c,n,o,u),x=u+d+y,A=x+p;if(iL(o)){A+=RS(A,o.GridSizeByY);for(let I of h)l[I].top=A}else if(nL(o)){let I=x-d;I+=RS(I,I);for(let B of h)l[B].bottom=I,A=Math.max(l[B].top,A)}else for(let I of h)l[I].y=x;let T=o.ActualLayerSeparation(a);u=A+T,c++}BS(i,s,c,n,o,u)}function eL(s,e){let t=new Kt(s.x,s.y,e);return t.weight=0,t.separation=1,t}function tL(s,e){return s[e.source]-s[e.target]}function rL(s,e,t,i,n){if(Zw(s,i)){for(let o of s)if(o>=i){let a=n[o];a.bottomAnchor=e,a.topAnchor=t}}}function iL(s){return s.SnapToGridByY==1}function nL(s){return s.SnapToGridByY==2}function oL(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(f.getTriangleOrientation(e.origin,s.origin,t.origin)==0)return!0;let i=s.leftAnchor,n=s.rightAnchor,o=s.x;return MS(s),f.getTriangleOrientation(e.origin,s.origin,t.origin)==1?!0:(s.x=o,s.leftAnchor=i,s.rightAnchor=n,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function MS(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function sL(s,e,t){let i=new Vt;for(let n of s)if(!(n>=t.nodeCount))for(let o of t.outEdges[n])e[o.source]==e[o.target]&&i.addNN(o.source,o.target);return Array.from(i.values())}function aL(s,e,t,i){let n=0,o=i.GetMultiedgeI(s);for(let a of o){n+=t;let l=a.edge.label;l!=null&&(l.center=new f(l.center.x,e+n+l.height/2),n+=l.height)}return n}function lL(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function uL(s,e,t,i){let n=cL(t,s,e,i);e.rightAnchor+=n}function cL(s,e,t,i){let n=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));n+=(i.NodeSeparation+i.MinNodeWidth)*o.length}return n}function hL(s,e){if(e.isIdentity())return;let t=e.inverse();for(let i of s.shallowNodes())i.transform(t);for(let i of s.edges())if(i.label!=null){let n=V.mkPP(t.multiplyPoint(new f(0,0)),t.multiplyPoint(new f(i.label.width,i.label.height)));i.label.width=n.width,i.label.height=n.height}}function dL(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes())t.transform(e);for(let t of s.edges())if(t.label!=null){let i=V.mkPP(e.multiplyPoint(new f(0,0)),e.multiplyPoint(new f(t.label.width,t.label.height)));t.label.width=i.width,t.label.height=i.height}fL(s,e)}}function fL(s,e){for(let t of s.edges())t.label!=null&&(t.label.center=e.multiplyPoint(t.label.center)),gL(e,t)}function gL(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),pL(e,s)}}function pL(s,e){if(s.underlyingPolyline!=null)for(let t=s.underlyingPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var zh=class extends zo{constructor(e,t){super();this.text=e,this.parent=t}toString(){return this.text}};var ws=(w=>(w[w.normal=0]="normal",w[w.inv=1]="inv",w[w.dot=2]="dot",w[w.invdot=3]="invdot",w[w.odot=4]="odot",w[w.invodot=5]="invodot",w[w.none=6]="none",w[w.tee=7]="tee",w[w.empty=8]="empty",w[w.invempty=9]="invempty",w[w.diamond=10]="diamond",w[w.odiamond=11]="odiamond",w[w.ediamond=12]="ediamond",w[w.crow=13]="crow",w[w.box=14]="box",w[w.obox=15]="obox",w[w.open=16]="open",w[w.halfopen=17]="halfopen",w[w.vee=18]="vee",w))(ws||{});var Co=(M=>(M[M.diamond=0]="diamond",M[M.ellipse=1]="ellipse",M[M.box=2]="box",M[M.circle=3]="circle",M[M.record=4]="record",M[M.plaintext=5]="plaintext",M[M.point=6]="point",M[M.mdiamond=7]="mdiamond",M[M.msquare=8]="msquare",M[M.polygon=9]="polygon",M[M.doublecircle=10]="doublecircle",M[M.house=11]="house",M[M.invhouse=12]="invhouse",M[M.parallelogram=13]="parallelogram",M[M.octagon=14]="octagon",M[M.tripleoctagon=15]="tripleoctagon",M[M.triangle=16]="triangle",M[M.trapezium=17]="trapezium",M[M.drawfromgeometry=18]="drawfromgeometry",M[M.hexagon=19]="hexagon",M))(Co||{});var Hh=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(Hh||{});var Eu=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(Eu||{});var Wh=(n=>(n[n.forward=0]="forward",n[n.back=1]="back",n[n.both=2]="both",n[n.none=3]="none",n))(Wh||{});var jh=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(jh||{});var C=class{static parse(e){switch(e.toLowerCase()){case"aliceblue":return C.AliceBlue;case"antiquewhite":return C.AntiqueWhite;case"aqua":C.Aqua;case"aquamarine":C.Aquamarine;case"azure":return C.Azure;case"beige":return C.Beige;case"bisque":return C.Bisque;case"black":return C.Black;case"blanchedalmond":return C.BlanchedAlmond;case"blue":return C.Blue;case"blueviolet":return C.BlueViolet;case"brown":return C.Brown;case"burlywood":return C.BurlyWood;case"cadetblue":return C.CadetBlue;case"chartreuse":return C.Chartreuse;case"chocolate":return C.Chocolate;case"coral":return C.Coral;case"cornflowerblue":return C.CornflowerBlue;case"cornsilk":return C.Cornsilk;case"crimson":return C.Crimson;case"cyan":return C.Cyan;case"darkblue":return C.DarkBlue;case"darkcyan":return C.DarkCyan;case"darkgoldenrod":return C.DarkGoldenrod;case"darkgray":return C.DarkGray;case"darkgreen":return C.DarkGreen;case"darkkhaki":return C.DarkKhaki;case"darkmagenta":return C.DarkMagenta;case"darkolivegreen":return C.DarkOliveGreen;case"darkorange":return C.DarkOrange;case"darkorchid":return C.DarkOrchid;case"darkred":return C.DarkRed;case"darksalmon":return C.DarkSalmon;case"darkseagreen":return C.DarkSeaGreen;case"darkslateblue":return C.DarkSlateBlue;case"darkslategray":return C.DarkSlateGray;case"darkturquoise":return C.DarkTurquoise;case"darkviolet":return C.DarkViolet;case"deeppink":return C.DeepPink;case"deepskyblue":return C.DeepSkyBlue;case"dimgray":return C.DimGray;case"dodgerblue":return C.DodgerBlue;case"firebrick":return C.Firebrick;case"floralwhite":return C.FloralWhite;case"forestgreen":return C.ForestGreen;case"fuchsia":return C.Fuchsia;case"gainsboro":return C.Gainsboro;case"ghostwhite":return C.GhostWhite;case"gold":return C.Gold;case"goldenrod":return C.Goldenrod;case"gray":return C.Gray;case"green":return C.Green;case"greenyellow":return C.GreenYellow;case"honeydew":return C.Honeydew;case"hotpink":return C.HotPink;case"indianred":return C.IndianRed;case"indigo":return C.Indigo;case"ivory":return C.Ivory;case"khaki":return C.Khaki;case"lavender":return C.Lavender;case"lavenderblush":return C.LavenderBlush;case"lawngreen":return C.LawnGreen;case"lemonchiffon":return C.LemonChiffon;case"lightblue":return C.LightBlue;case"lightcoral":return C.LightCoral;case"lightcyan":return C.LightCyan;case"lightgoldenrodyellow":return C.LightGoldenrodYellow;case"lightgray":return C.LightGray;case"lightgreen":return C.LightGreen;case"lightpink":return C.LightPink;case"lightsalmon":return C.LightSalmon;case"lightseagreen":return C.LightSeaGreen;case"lightskyblue":return C.LightSkyBlue;case"lightslategray":return C.LightSlateGray;case"lightsteelblue":return C.LightSteelBlue;case"lightyellow":return C.LightYellow;case"lime":return C.Lime;case"limegreen":return C.LimeGreen;case"linen":return C.Linen;case"magenta":return C.Magenta;case"maroon":return C.Maroon;case"mediumaquamarine":return C.MediumAquamarine;case"mediumblue":return C.MediumBlue;case"mediumorchid":return C.MediumOrchid;case"mediumpurple":return C.MediumPurple;case"mediumseagreen":return C.MediumSeaGreen;case"mediumslateblue":return C.MediumSlateBlue;case"mediumspringgreen":return C.MediumSpringGreen;case"mediumturquoise":return C.MediumTurquoise;case"mediumvioletred":return C.MediumVioletRed;case"midnightblue":return C.MidnightBlue;case"mintcream":return C.MintCream;case"mistyrose":return C.MistyRose;case"moccasin":return C.Moccasin;case"navajowhite":return C.NavajoWhite;case"navy":return C.Navy;case"oldlace":return C.OldLace;case"olive":return C.Olive;case"olivedrab":return C.OliveDrab;case"orange":return C.Orange;case"orangered":return C.OrangeRed;case"orchid":return C.Orchid;case"palegoldenrod":return C.PaleGoldenrod;case"palegreen":return C.PaleGreen;case"paleturquoise":return C.PaleTurquoise;case"palevioletred":return C.PaleVioletRed;case"papayawhip":return C.PapayaWhip;case"peachpuff":return C.PeachPuff;case"peru":return C.Peru;case"pink":return C.Pink;case"plum":return C.Plum;case"powderblue":return C.PowderBlue;case"purple":return C.Purple;case"red":return C.Red;case"rosybrown":return C.RosyBrown;case"royalblue":return C.RoyalBlue;case"saddlebrown":return C.SaddleBrown;case"salmon":return C.Salmon;case"sandybrown":return C.SandyBrown;case"seagreen":return C.SeaGreen;case"seashell":return C.SeaShell;case"sienna":return C.Sienna;case"silver":return C.Silver;case"skyblue":return C.SkyBlue;case"slateblue":return C.SlateBlue;case"slategray":return C.SlateGray;case"snow":return C.Snow;case"springgreen":return C.SpringGreen;case"steelblue":return C.SteelBlue;case"tan":return C.Tan;case"teal":return C.Teal;case"thistle":return C.Thistle;case"tomato":return C.Tomato;case"transparent":return C.Transparent;case"turquoise":return C.Turquoise;case"violet":return C.Violet;case"wheat":return C.Wheat;case"white":return C.White;case"whitesmoke":return C.WhiteSmoke;case"yellow":return C.Yellow;case"yellowgreen":return C.YellowGreen;default:return}}constructor(e,t,i,n){this.a=e,this.r=t,this.g=i,this.b=n}static mkRGB(e,t,i){return new C(255,e,t,i)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length==1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a==t.a&&e.r==t.r&&e.b==t.b&&e.g==t.g}toString(){return'"#'+C.Xex(this.R)+C.Xex(this.G)+C.Xex(this.B)+(this.A==255?"":C.Xex(this.A))+'"'}static get AliceBlue(){return new C(255,240,248,255)}static get AntiqueWhite(){return new C(255,250,235,215)}static get Aqua(){return new C(255,0,255,255)}static get Aquamarine(){return new C(255,127,255,212)}static get Azure(){return new C(255,240,255,255)}static get Beige(){return new C(255,245,245,220)}static get Bisque(){return new C(255,255,228,196)}static get Black(){return new C(255,0,0,0)}static get BlanchedAlmond(){return new C(255,255,235,205)}static get Blue(){return new C(255,0,0,255)}static get BlueViolet(){return new C(255,138,43,226)}static get Brown(){return new C(255,165,42,42)}static get BurlyWood(){return new C(255,222,184,135)}static get CadetBlue(){return new C(255,95,158,160)}static get Chartreuse(){return new C(255,127,255,0)}static get Chocolate(){return new C(255,210,105,30)}static get Coral(){return new C(255,255,127,80)}static get CornflowerBlue(){return new C(255,100,149,237)}static get Cornsilk(){return new C(255,255,248,220)}static get Crimson(){return new C(255,220,20,60)}static get Cyan(){return new C(255,0,255,255)}static get DarkBlue(){return new C(255,0,0,139)}static get DarkCyan(){return new C(255,0,139,139)}static get DarkGoldenrod(){return new C(255,184,134,11)}static get DarkGray(){return new C(255,169,169,169)}static get DarkGreen(){return new C(255,0,100,0)}static get DarkKhaki(){return new C(255,189,183,107)}static get DarkMagenta(){return new C(255,139,0,139)}static get DarkOliveGreen(){return new C(255,85,107,47)}static get DarkOrange(){return new C(255,255,140,0)}static get DarkOrchid(){return new C(255,153,50,204)}static get DarkRed(){return new C(255,139,0,0)}static get DarkSalmon(){return new C(255,233,150,122)}static get DarkSeaGreen(){return new C(255,143,188,139)}static get DarkSlateBlue(){return new C(255,72,61,139)}static get DarkSlateGray(){return new C(255,47,79,79)}static get DarkTurquoise(){return new C(255,0,206,209)}static get DarkViolet(){return new C(255,148,0,211)}static get DeepPink(){return new C(255,255,20,147)}static get DeepSkyBlue(){return new C(255,0,191,255)}static get DimGray(){return new C(255,105,105,105)}static get DodgerBlue(){return new C(255,30,144,255)}static get Firebrick(){return new C(255,178,34,34)}static get FloralWhite(){return new C(255,255,250,240)}static get ForestGreen(){return new C(255,34,139,34)}static get Fuchsia(){return new C(255,255,0,255)}static get Gainsboro(){return new C(255,220,220,220)}static get GhostWhite(){return new C(255,248,248,255)}static get Gold(){return new C(255,255,215,0)}static get Goldenrod(){return new C(255,218,165,32)}static get Gray(){return new C(255,128,128,128)}static get Green(){return new C(255,0,128,0)}static get GreenYellow(){return new C(255,173,255,47)}static get Honeydew(){return new C(255,240,255,240)}static get HotPink(){return new C(255,255,105,180)}static get IndianRed(){return new C(255,205,92,92)}static get Indigo(){return new C(255,75,0,130)}static get Ivory(){return new C(255,255,255,240)}static get Khaki(){return new C(255,240,230,140)}static get Lavender(){return new C(255,230,230,250)}static get LavenderBlush(){return new C(255,255,240,245)}static get LawnGreen(){return new C(255,124,252,0)}static get LemonChiffon(){return new C(255,255,250,205)}static get LightBlue(){return new C(255,173,216,230)}static get LightCoral(){return new C(255,240,128,128)}static get LightCyan(){return new C(255,224,255,255)}static get LightGoldenrodYellow(){return new C(255,250,250,210)}static get LightGray(){return new C(255,211,211,211)}static get LightGreen(){return new C(255,144,238,144)}static get LightPink(){return new C(255,255,182,193)}static get LightSalmon(){return new C(255,255,160,122)}static get LightSeaGreen(){return new C(255,32,178,170)}static get LightSkyBlue(){return new C(255,135,206,250)}static get LightSlateGray(){return new C(255,119,136,153)}static get LightSteelBlue(){return new C(255,176,196,222)}static get LightYellow(){return new C(255,255,255,224)}static get Lime(){return new C(255,0,255,0)}static get LimeGreen(){return new C(255,50,205,50)}static get Linen(){return new C(255,250,240,230)}static get Magenta(){return new C(255,255,0,255)}static get Maroon(){return new C(255,128,0,0)}static get MediumAquamarine(){return new C(255,102,205,170)}static get MediumBlue(){return new C(255,0,0,205)}static get MediumOrchid(){return new C(255,186,85,211)}static get MediumPurple(){return new C(255,147,112,219)}static get MediumSeaGreen(){return new C(255,60,179,113)}static get MediumSlateBlue(){return new C(255,123,104,238)}static get MediumSpringGreen(){return new C(255,0,250,154)}static get MediumTurquoise(){return new C(255,72,209,204)}static get MediumVioletRed(){return new C(255,199,21,133)}static get MidnightBlue(){return new C(255,25,25,112)}static get MintCream(){return new C(255,245,255,250)}static get MistyRose(){return new C(255,255,228,225)}static get Moccasin(){return new C(255,255,228,181)}static get NavajoWhite(){return new C(255,255,222,173)}static get Navy(){return new C(255,0,0,128)}static get OldLace(){return new C(255,253,245,230)}static get Olive(){return new C(255,128,128,0)}static get OliveDrab(){return new C(255,107,142,35)}static get Orange(){return new C(255,255,165,0)}static get OrangeRed(){return new C(255,255,69,0)}static get Orchid(){return new C(255,218,112,214)}static get PaleGoldenrod(){return new C(255,238,232,170)}static get PaleGreen(){return new C(255,152,251,152)}static get PaleTurquoise(){return new C(255,175,238,238)}static get PaleVioletRed(){return new C(255,219,112,147)}static get PapayaWhip(){return new C(255,255,239,213)}static get PeachPuff(){return new C(255,255,218,185)}static get Peru(){return new C(255,205,133,63)}static get Pink(){return new C(255,255,192,203)}static get Plum(){return new C(255,221,160,221)}static get PowderBlue(){return new C(255,176,224,230)}static get Purple(){return new C(255,128,0,128)}static get Red(){return new C(255,255,0,0)}static get RosyBrown(){return new C(255,188,143,143)}static get RoyalBlue(){return new C(255,65,105,225)}static get SaddleBrown(){return new C(255,139,69,19)}static get Salmon(){return new C(255,250,128,114)}static get SandyBrown(){return new C(255,244,164,96)}static get SeaGreen(){return new C(255,46,139,87)}static get SeaShell(){return new C(255,255,245,238)}static get Sienna(){return new C(255,160,82,45)}static get Silver(){return new C(255,192,192,192)}static get SkyBlue(){return new C(255,135,206,235)}static get SlateBlue(){return new C(255,106,90,205)}static get SlateGray(){return new C(255,112,128,144)}static get Snow(){return new C(255,255,250,250)}static get SpringGreen(){return new C(255,0,255,127)}static get SteelBlue(){return new C(255,70,130,180)}static get Tan(){return new C(255,210,180,140)}static get Teal(){return new C(255,0,128,128)}static get Thistle(){return new C(255,216,191,216)}static get Tomato(){return new C(255,255,99,71)}static get Transparent(){return new C(0,255,255,255)}static get Turquoise(){return new C(255,64,224,208)}static get Violet(){return new C(255,238,130,238)}static get Wheat(){return new C(255,245,222,179)}static get White(){return new C(255,255,255,255)}static get WhiteSmoke(){return new C(255,245,245,245)}static get Yellow(){return new C(255,255,255,0)}static get YellowGreen(){return new C(255,154,205,50)}};var Xa=class{constructor(e){this.color=C.parse("Black");this.labelfontcolor=C.parse("Black");this.styles=[];this.penwidth=1;this.attrCont=e,this.bind(),this.fontname=Xa.defaultLabelFontName,this.fontsize=Xa.defaultLabelFontSize}get labelText(){return this._labelText}set labelText(e){this._labelText=e}bind(){this.attrCont!=null&&this.attrCont.setAttr(Xa.attachIndex,this)}static getDrawingObj(e){return e==null?null:e.getAttr(Xa.attachIndex)}},rt=Xa;rt.attachIndex=1,rt.defaultLabelFontName="Times-Roman",rt.defaultLabelFontSize=12;var Ya=class{constructor(e){this.text=e}};var qh=class extends rt{constructor(e){super(e);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;e!=null&&(this.label=new Ya(e.id))}get labelText(){return this.label?this.label.text:null}set labelText(e){this.label!=null&&(this.label.text=e)}get Padding(){return this.padding}set Padding(e){this.padding=Math.max(0,e)}get XRadius(){return this.xRad}set XRadius(e){this.xRad=e}get YRadius(){return this.yRad}set YRadius(e){this.yRad=e}static get DefaultFillColor(){return qh.defaultFillColor}static set DefaultFillColor(e){qh.defaultFillColor=e}get ShapeEnum(){return this.shape}set ShapeEnum(e){this.shape=e}get LabelMargin(){return this.labelMargin}set LabelMargin(e){this.labelMargin=e}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(e){this.labelWidthToHeightRatio=e}get node(){return this.attrCont}},Et=qh;Et.defaultFillColor=C.LightGray;var Ai=class extends Et{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get graph(){return this.attrCont}findNode(e){let i=this.graph.findNode(e);return i==null?null:rt.getDrawingObj(i)}hasDirectedEdge(){for(let e of this.graph.edges)if(rt.getDrawingObj(e).directed)return!0;return!1}createGeometry(e=t=>t?new At(t.length*8+8,20):null){let t=new ze(this.graph);this.textMeasure=e;let i={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};t.labelSize=e(this.labelText,i);for(let n of this.graph.deepNodes)this.createNodeGeometry(n);for(let n of this.graph.edges)this.createEdgeGeometry(n);return t}createEdgeGeometry(e){let t=oi.getDrawingObj(e),i=new Re(e);if(t.directed==!1&&(i.targetArrowhead=null),e.label){let n=this.textMeasure(e.label.text,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"});i.label=new Vl(V.mkPP(new f(0,0),new f(n.width,n.height)),e.label),t.label.measuredTextSize=n}t.penwidth&&(i.lineWidth=t.penwidth)}curveByShape(e,t,i,n,o){let a;switch(n){case 0:a=Se.CreateDiamond(e,t,i);break;case 1:break;case 2:a=Se.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,i);break;case 3:a=Se.mkCircle(e/2,i);break;case 4:break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=Se.mkCircle(e/2,i);break;case 11:a=Se.createHouse(e,t,i);break;case 12:a=Se.createInvertedHouse(e,t,i);break;case 13:break;case 14:a=Se.createOctagon(e,t,i);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=Se.createHexagon(e,t,i);break}return a!=null?a:re.mkFullEllipseNNP(e/2,t/2,i)}createNodeGeometry(e){if(e instanceof De){let t=rt.getDrawingObj(e);t.createGeometry(this.textMeasure),t.labelText&&(t.measuredTextSize=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}))}else{let t=Et.getDrawingObj(e),i=new At(1,1);t.labelText&&(i=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}));let n=i.width+t.LabelMargin*2,o=i.height+t.LabelMargin*2;t.measuredTextSize=i;let a=new f(0,0),l=new _r(e);l.boundaryCurve=this.curveByShape(n,o,a,t.shape,t)}}};var oi=class extends rt{constructor(){super(...arguments);this.directed=!0}};var jS=Q(WS());function rn(s){let e=(0,jS.default)(s);if(e.keyword!=null)return C.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new C(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return C.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return C.Black}function Zh(s,e,t,i,n){let o=t.graph.nodeCollection,a,l;if(s.type=="node_id"){let h=s.id.toString();if(o.hasNode(h))a=o.getNode(h);else{t.graph.addNode(a=new _i(h));let d=new Et(a);d.labelText=h}}else{let h=[];for(let d of s.children)if(d.type==="node_stmt")for(let p of Zh(d.node_id,e,t,i,n))h.push(p);else if(d.type!=="attr_stmt")throw new Error("not implemented");for(let d of s.children)if(d.type==="attr_stmt")for(let p of h)Os(d,p);return h}if(e.type=="node_id"){let h=e.id.toString();if(o.hasNode(h))l=o.getNode(h);else{t.graph.addNode(l=new _i(h));let d=new Et(l);d.labelText=h}}else if(e.type=="subgraph"){let h=new Array;for(let d of e.children)if(d.type==="node_stmt")for(let p of Zh(s,d.node_id,t,i,n))h.push(p);else if(d.type!=="attr_stmt")throw new Error("not implemented");for(let d of e.children)if(d.type==="attr_stmt")for(let p of h)Os(d,p);return h}let u=new Yn(a,l);o.addEdge(u);let c=new oi(u);return Os(n,c),c.labelText&&(u.label=new zh(c.labelText,u),c.label=new Ya(c.labelText)),c.directed=i,[c]}function YS(s,e,t){QS(s.children,e,t)}function $S(s,e){let t=s.node_id.id.toString(),i=e.graph.findNode(t),n;return i?(n=rt.getDrawingObj(i),n||(n=new Et(i))):(i=new _i(t),e.graph.addNode(i),n=new Et(i)),Os(s,n),n}function Os(s,e){if(s.attr_list!=null)for(let t of s.attr_list)if(t.type=="attr"){let i=t.eq;switch(t.id){case"color":e.color=rn(i);break;case"pencolor":e.pencolor=rn(i);break;case"labelfontcolor":e.labelfontcolor=rn(i);break;case"fontcolor":e.fontColor=rn(i);break;case"fillcolor":e.fillColor=rn(i);break;case"style":e.styles.push(WL(i));break;case"shape":{let n=e;n.shape=jL(i);break}case"peripheries":e.peripheries=parseInt(i);break;case"headlabel":e.headlabel=i;break;case"label":if(typeof i=="string"){let n="\\n",o=0;e.labelText="";do{let a=i.indexOf(n,o);if(a>=0)e.labelText+=i.substring(o,a)+`
`,o=a+2;else{e.labelText+=i.substring(o);break}}while(!0)}else typeof i=="number"&&(e.labelText=i.toString());break;case"size":e.size=sm(i);break;case"pos":e.pos=sm(i);break;case"rankdir":e.rankdir=qL(i);break;case"fontname":e.fontname=i;break;case"fontsize":e.fontsize=parseFloat(i);break;case"width":e.width=parseFloat(i);break;case"penwidth":e.penwidth=parseFloat(i);break;case"height":e.height=parseFloat(i);break;case"margin":e.margin=parseFloat(i);break;case"len":e.len=parseFloat(i);break;case"minlen":e.minlen=parseFloat(i);break;case"rank":e.rank=XL(i);break;case"charset":e.charset=i;break;case"orientation":e.orientation=i;break;case"ratio":e.ratio=i;break;case"weight":e.weight=parseFloat(i);break;case"nodesep":e.nodesep=parseFloat(i);break;case"layersep":e.layersep=parseFloat(i);break;case"arrowsize":e.arrowsize=parseFloat(i);break;case"rotate":e.rotate=parseFloat(i);break;case"ranksep":e.ranksep=parseFloat(i);break;case"splines":e.splines=i=="true";break;case"overlap":e.overlap=i=="true";break;case"arrowtail":e.arrowtail=qS(i);break;case"taillabel":e.taillabel=i;break;case"arrowhead":e.arrowhead=qS(i);break;case"ordering":e.ordering=YL(i);break;case"URL":e.URL=i;break;case"dir":e.dir=$L(i);break;case"concentrate":e.concentrate=i=="true";break;case"compound":e.compound=i=="true";break;case"lhead":e.lhead=i;break;case"ltail":e.ltail=i;break;case"bgcolor":e.bgcolor=rn(i);break;case"center":e.center=i==!0||parseInt(i)==1;break;case"colorscheme":e.colorscheme=i;break;case"sides":e.sides=parseInt(i);break;case"distortion":e.distortion=parseFloat(i);break;case"skew":e.skew=parseFloat(i);break;case"bb":e.bb=QL(i);break;case"labelloc":e.labelloc=i;break;case"decorate":e.decorate=i=="true";break;case"tailclip":e.tailclip=i=="true";break;case"headclip":e.headclip=i=="true";break;case"constraint":e.constraint=i=="true";break;case"gradientangle":e.gradientangle=parseFloat(i);break;case"samehead":e.samehead=i;break;case"href":e.href=i;break;case"imagepath":e.imagepath=i;break;case"image":e.image=i;break;case"labeljust":e.labejust=i;break;case"layers":e.layers=i.split(",");break;case"layer":e.layer=i;break;case"f":e.f=parseFloat(i);break;case"nojustify":e.nojustify=i=="true";break;case"root":e.root=i=="true";break;case"page":e.page=sm(i);break;case"pname":e.pname=i;break;case"kind":e.kind=i;break;case"fname":e.fname=i;break;case"subkind":e.subkind=i;break;case"area":e.area=parseFloat(i);break;case"tailport":e.tailport=i;break;case"headport":e.headport=i;break;case"wt":e.wt=i;break;case"id":e.id=i;break;case"edgetooltip":e.edgetooltip=i;break;case"headtooltip":e.headtooltip=i;break;case"tailtooltip":e.tailtooltip=i;break;case"headURL":e.headURL=i;break;case"tailURL":e.tailURL=i;break;case"labelURL":e.labelURL=i;break;case"edgeurl":e.edgeurl=i;break;case"shapefile":e.shapefile=i;break;case"xlabel":e.xlabel=i;break;case"sametail":e.sametail=i;break;case"clusterrank":e.clusterRank=i;break;default:break}}else throw new Error("unexpected type "+t.type)}function QS(s,e,t){for(let i of s)switch(i.type){case"node_stmt":$S(i,e);break;case"edge_stmt":{let n=i.edge_list;for(let o=0;o<n.length-1;o++)Zh(n[o],n[o+1],e,t,i)}break;case"subgraph":if(!zL(i,e))if(i.id==null){let n=ZS(i,e,t);ZL(i,e,n)}else{let n=new De(i.id),o=new Ai(n);YS(i,o,t),n.isEmpty()||e.graph.addNode(n)}break;case"attr_stmt":HL(i,e);break;default:throw new Error("not implemented")}}function Kh(s){let e=(0,XS.default)(s);if(e==null)return null;let t=new De,i=new Ai(t);return QS(e[0].children,i,e[0].type=="digraph"),t}function zL(s,e){let t=s.children[0];if(t==null||t.type!="attr_stmt")return!1;let i=t.attr_list;if(i==null||i.length==0)return!1;let n=i[0];if(n.type!="attr"||n.id!="rank")return!1;switch(n.eq){case"min":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.minRanks.push(a.id)}return!0;case"max":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.maxRanks.push(a.id)}return!0;case"same":{let o=[];for(let a=1;a<s.children.length;a++){let l=s.children[a];o.push(l.id)}return e.graphVisData.sameRanks.push(o),!0}case"source":{for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.sourceRanks.push(a.id)}return!0}case"sink":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.sinkRanks.push(a.id)}return!0;default:throw new Error("incorrect rank")}}function HL(s,e){e.defaultNode==null&&s.target=="node"?(e.defaultNode=new Et(null),Os(s,e.defaultNode)):s.target=="graph"&&Os(s,e)}function WL(s){return Eu[s]}function jL(s){let e=s.toLowerCase();return Co[e]}function sm(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function qL(s){return fa[s]}function XL(s){return Hh[s]}function qS(s){return ws[s]}function YL(s){return jh[s]}function $L(s){return Wh[s]}function QL(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function ZS(s,e,t){let i=[];for(let n of s.children)if(n.type=="edge_stmt"){let o=n.edge_list;for(let a=0;a<o.length-1;a++)for(let l of Zh(o[a],o[a+1],e,t,n))i.push(l)}else if(n.type!="attr_stmt")if(n.type=="node_stmt")i.push($S(n,e));else if(n.type==="subgraph")if(n.id!=null){let o=new De(n.id);e.graph.addNode(o);let a=new Ai(o);YS(n,a,t),i.push(a)}else i=i.concat(ZS(n,e,t));else throw new Error("Function not implemented.");return i}function ZL(s,e,t){for(let i of s.children)if(i.type=="attr_stmt")for(let n of t)Os(i,n)}function Jh(s){let e=new De;for(let t of s.nodes){let i=String(t.id),n=e.addNode(new _i(i)),o=new Et(n),{label:a=i,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=Co[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=rn(t.color))}for(let t of s.edges){let i=e.setEdge(String(t.source),String(t.target)),n=new oi(i),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;n.arrowhead=ws[o],n.arrowtail=ws[a],n.directed=l,"weight"in t&&(n.weight=t.weight),"color"in t&&(n.color=rn(t.color))}return e}var KS="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),am={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},lm={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",mds:"Pivot MDS"},JS=["Times New Roman","Arial","Georgia","Courier New","Verdana"];function Ao(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var nn={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},KL=nn.self||nn.window||nn.global||{},JL=nn.window||nn.self||nn.global||{},e2=nn.global||nn.self||nn.window||{},t2=nn.document||{};var Lu=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var eE=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),r2=eE&&parseFloat(eE[1])||0;var tE="3.1.8";function lr(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var on={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},_ie=on.self||on.window||on.global||{},Fie=on.window||on.self||on.global||{},Vie=on.global||on.self||on.window||{},kie=on.document||{};var Uie=typeof process!="object"||String(process)!=="[object process]"||process.browser;var iE=typeof window<"u"&&typeof window.orientation<"u",rE=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),zie=rE&&parseFloat(rE[1])||0;function j(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var ed=class{constructor(e,t){j(this,"name",void 0),j(this,"workerThread",void 0),j(this,"isRunning",void 0),j(this,"result",void 0),j(this,"_resolve",void 0),j(this,"_reject",void 0),this.name=e,this.workerThread=t,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise((i,n)=>{this._resolve=i,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){lr(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){lr(this.isRunning),this.isRunning=!1,this._reject(e)}};var um=new Map;function nE(s){lr(s.source&&!s.url||!s.source&&s.url);let e=um.get(s.source||s.url);return e||(s.url&&(e=i2(s.url),um.set(s.url,e)),s.source&&(e=oE(s.source),um.set(s.source,e))),lr(e),e}function i2(s){if(!s.startsWith("http"))return s;let e=n2(s);return oE(e)}function oE(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function n2(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function cm(s,e=!0,t){let i=t||new Set;if(s){if(sE(s))i.add(s);else if(sE(s.buffer))i.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let n in s)cm(s[n],e,i)}}return t===void 0?Array.from(i):[]}function sE(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var hm=()=>{},Qa=class{static isSupported(){return typeof Worker<"u"}constructor(e){j(this,"name",void 0),j(this,"source",void 0),j(this,"url",void 0),j(this,"terminated",!1),j(this,"worker",void 0),j(this,"onMessage",void 0),j(this,"onError",void 0),j(this,"_loadableURL","");let{name:t,source:i,url:n}=e;lr(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=hm,this.onError=o=>console.log(o),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=hm,this.onError=hm,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||cm(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=nE({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}};var td=class{constructor(e){j(this,"name","unnamed"),j(this,"source",void 0),j(this,"url",void 0),j(this,"maxConcurrency",1),j(this,"maxMobileConcurrency",1),j(this,"onDebug",()=>{}),j(this,"reuseWorkers",!0),j(this,"props",{}),j(this,"jobQueue",[]),j(this,"idleQueue",[]),j(this,"count",0),j(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,o,a)=>n.done(a),i=(n,o)=>n.error(o)){let n=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new ed(t.name,e);e.onMessage=n=>t.onMessage(i,n.type,n.payload),e.onError=n=>t.onError(i,n),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new Qa({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return iE?this.maxMobileConcurrency:this.maxConcurrency}};var o2={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0},$r=class{static isSupported(){return Qa.isSupported()}static getWorkerFarm(e={}){return $r._workerFarm=$r._workerFarm||new $r({}),$r._workerFarm.setProps(e),$r._workerFarm}constructor(e){j(this,"props",void 0),j(this,"workerPools",new Map),this.props={...o2},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy()}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:n}=e,o=this.workerPools.get(t);return o||(o=new td({name:t,source:i,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};j($r,"_workerFarm",void 0);var s2="latest";function dm(s,e={}){let t=e[s.id]||{},i="".concat(s.id,"-worker.js"),n=t.workerUrl;if(!n&&s.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(n="modules/".concat(s.module,"/dist/").concat(i)),!n){let o=s.version;o==="latest"&&(o=s2);let a=o?"@".concat(o):"";n="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(i)}return lr(n),n}function fm(s,e=tE){lr(s,"no worker provided");let t=s.version;return!(!e||!t)}function gm(s,e){return $r.isSupported()?s.worker&&e?.worker:!1}async function pm(s,e,t,i,n){let o=s.id,a=dm(s,t),u=$r.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t));let c=await u.startJob("process-on-worker",a2.bind(null,n));return c.postMessage("process",{input:e,options:t}),await(await c.result).result}async function a2(s,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":let{id:n,input:o,options:a}=i;try{let l=await s(o,a);e.postMessage("done",{id:n,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:n,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function mm(s){return s&&typeof s=="object"&&s.isBuffer}function aE(s){return mm(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function rd(s){if(mm(s))return aE(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function bm(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let i=new Uint8Array(s),n=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==n[o])return!1;return!0}function Pm(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),i=new Uint8Array(t),n=0;for(let o of e)i.set(o,n),n+=o.byteLength;return i.buffer}async function ym(s){let e=[];for await(let t of s)e.push(t);return Pm(...e)}function Ru(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var Bs=class{constructor(e,t){j(this,"name",void 0),j(this,"type",void 0),j(this,"sampleSize",1),j(this,"time",void 0),j(this,"count",void 0),j(this,"samples",void 0),j(this,"lastTiming",void 0),j(this,"lastSampleTime",void 0),j(this,"lastSampleCount",void 0),j(this,"_count",0),j(this,"_time",0),j(this,"_samples",0),j(this,"_startTime",0),j(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Ru(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Ru()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var Za=class{constructor(e){j(this,"id",void 0),j(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:i}=e;return this.stats[t]||(e instanceof Bs?this.stats[t]=e:this.stats[t]=new Bs(t,i)),this.stats[t]}};var l2="",lE={};function Sm(s){for(let e in lE)if(s.startsWith(e)){let t=lE[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(l2).concat(s)),s}var id={};eI(id,{dirname:()=>c2,filename:()=>u2,join:()=>h2});function u2(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function c2(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function h2(...s){let e="/";return s=s.map((t,i)=>(i&&(t=t.replace(new RegExp("^".concat(e)),"")),i!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var d2=s=>typeof s=="boolean",Ou=s=>typeof s=="function",Ka=s=>s!==null&&typeof s=="object",Em=s=>Ka(s)&&s.constructor==={}.constructor;var uE=s=>s&&typeof s[Symbol.iterator]=="function",cE=s=>s&&typeof s[Symbol.asyncIterator]=="function";var Gn=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var vi=s=>typeof Blob<"u"&&s instanceof Blob,hE=s=>s&&typeof s=="object"&&s.isBuffer;var f2=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||Ka(s)&&Ou(s.tee)&&Ou(s.cancel)&&Ou(s.getReader);var g2=s=>Ka(s)&&Ou(s.read)&&Ou(s.pipe)&&d2(s.readable),nd=s=>f2(s)||g2(s);var p2=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,m2=/^([-\w.]+\/[-\w.+]+)/;function dE(s){let e=m2.exec(s);return e?e[1]:s}function xm(s){let e=p2.exec(s);return e?e[1]:""}var b2=/\?.*/;function Ms(s){if(Gn(s)){let e=Cm(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:dE(t)||xm(e)}}return vi(s)?{url:Cm(s.name||""),type:s.type||""}:typeof s=="string"?{url:Cm(s),type:xm(s)}:{url:"",type:""}}function fE(s){return Gn(s)?s.headers["content-length"]||-1:vi(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function Cm(s){return s.replace(b2,"")}async function od(s){if(Gn(s))return s;let e={},t=fE(s);t>=0&&(e["content-length"]=String(t));let{url:i,type:n}=Ms(s);n&&(e["content-type"]=n);let o=await y2(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:i}),a}async function gE(s){if(!s.ok){let e=await P2(s);throw new Error(e)}}async function P2(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),i=s.statusText;t.includes("application/json")&&(i+=" ".concat(await s.text())),e+=i,e=e.length>60?"".concat(e.slice(60),"..."):e}catch{}return e}async function y2(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(i=>{let n=new FileReader;n.onload=o=>{var a;return i(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},n.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),i=S2(t);return"data:base64,".concat(i)}return null}function S2(s){let e="",t=new Uint8Array(s);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function Am(s,e){if(typeof s=="string"){s=Sm(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await od(s)}var gd=Q(tl());var nl=Q(tl());function Y2(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var hd=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";j(this,"storage",void 0),j(this,"id",void 0),j(this,"config",{}),this.storage=Y2(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function TE(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function IE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function dd(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,n=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>i&&(t=Math.min(t,i/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(n,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var LE=Q(tl()),fd;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(fd||(fd={}));function wE(s){return typeof s=="string"?fd[s.toUpperCase()]||fd.WHITE:s}function RE(s,e,t){return!LE.isBrowser&&typeof s=="string"&&(e&&(e=wE(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=wE(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function OE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),i=Object.getOwnPropertyNames(t);for(let n of i)typeof s[n]=="function"&&(e.find(o=>n===o)||(s[n]=s[n].bind(s)))}function rl(s,e){if(!s)throw new Error(e||"Assertion failed")}var Qr=Q(tl());function Ds(){let s;if(Qr.isBrowser&&"performance"in Qr.window){var e,t;s=Qr.window===null||Qr.window===void 0||(e=Qr.window.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in Qr.process){var i;let n=Qr.process===null||Qr.process===void 0||(i=Qr.process.hrtime)===null||i===void 0?void 0:i.call(Qr.process);s=n[0]*1e3+n[1]/1e6}else s=Date.now();return s}var il={debug:nl.isBrowser&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},$2={enabled:!0,level:0};function ai(){}var BE={},ME={once:!0},Ar=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};j(this,"id",void 0),j(this,"VERSION",nl.VERSION),j(this,"_startTs",Ds()),j(this,"_deltaTs",Ds()),j(this,"_storage",void 0),j(this,"userData",{}),j(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new hd("__probe-".concat(this.id,"__"),$2),this.userData={},this.timeStamp("".concat(this.id," started")),OE(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ds()-this._startTs).toPrecision(10))}getDelta(){return Number((Ds()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){rl(e,t)}warn(e){return this._getLogFunction(0,e,il.warn,arguments,ME)}error(e){return this._getLogFunction(0,e,il.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,il.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,il.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),o=2;o<i;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,il.debug||il.info,arguments,ME)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||ai,i&&[i],{tag:J2(t)}):ai}image(e){let{logLevel:t,priority:i,image:n,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?nl.isBrowser?K2({image:n,message:o,scale:a}):Z2({image:n,message:o,scale:a}):ai}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||ai)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},n=NE({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||ai)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=DE(e)}_getLogFunction(e,t,i,n,o){if(this._shouldLog(e)){o=NE({logLevel:e,message:t,args:n,opts:o}),i=i||o.method,rl(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Ds();let a=o.tag||o.message;if(o.once)if(!BE[a])BE[a]=Ds();else return ai;return t=Q2(this.id,o.message,o),i.bind(console,t,...o.args)}return ai}};j(Ar,"VERSION",nl.VERSION);function DE(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return rl(Number.isFinite(e)&&e>=0),e}function NE(s){let{logLevel:e,message:t}=s;s.logLevel=DE(e);let i=s.args?Array.from(s.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let n=typeof s.message;return rl(n==="string"||n==="object"),Object.assign(s,{args:i},s.opts)}function Q2(s,e,t){if(typeof e=="string"){let i=t.time?IE(TE(t.total)):"";e=t.time?"".concat(s,": ").concat(i,"  ").concat(e):"".concat(s,": ").concat(e),e=RE(e,t.color,t.background)}return e}function Z2(s){let{image:e,message:t="",scale:i=1}=s,n=null;try{n=module.require("asciify-image")}catch{}return n?()=>n(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):ai}function K2(s){let{image:e,message:t="",scale:i=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=dd(o,t,i);console.log(...a)},o.src=e,ai}let n=e.nodeName||"";if(n.toLowerCase()==="img")return console.log(...dd(e,t,i)),ai;if(n.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...dd(o,t,i)),o.src=e.toDataURL(),ai}return ai}function J2(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var Doe=new Ar({id:"@probe.gl/log"});var Rm=new Ar({id:"loaders.gl"}),Om=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},Bm=class{constructor(){j(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var Mm={fetch:null,mimeType:void 0,nothrow:!1,log:new Bm,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},GE={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Nm(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var VE=()=>{let s=Nm();return s.globalOptions=s.globalOptions||{...Mm},s.globalOptions};function kE(s,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],eR(s,t),rR(e,s,i)}function pd(s,e){let t=VE(),i=s||t;return typeof i.fetch=="function"?i.fetch:Ka(i.fetch)?n=>Am(n,i):e!=null&&e.fetch?e?.fetch:Am}function eR(s,e){_E(s,null,Mm,GE,e);for(let t of e){let i=s&&s[t.id]||{},n=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};_E(i,t.id,n,o,e)}}function _E(s,e,t,i,n){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&Ka(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in i)Rm.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(i[l],"'"))();else if(!u){let d=tR(l,n);Rm.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function tR(s,e){let t=s.toLowerCase(),i="";for(let n of e)for(let o in n.options){if(s===o)return"Did you mean '".concat(n.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(i=i||"Did you mean '".concat(n.id,".").concat(o,"'?"))}return i}function rR(s,e,t){let n={...s.options||{}};return iR(n,t),n.log===null&&(n.log=new Om),FE(n,VE()),FE(n,e),n}function FE(s,e){for(let t in e)if(t in e){let i=e[t];Em(i)&&Em(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function iR(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function Nu(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function Dm(s){var e,t;Ao(s,"null loader"),Ao(Nu(s),"invalid loader");let i;return Array.isArray(s)&&(i=s[1],s=s[0],s={...s,options:{...s.options,...i}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var nR=()=>{let s=Nm();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function UE(){return nR()}var zE=new Ar({id:"loaders.gl"});var oR=/\.([^.]+)$/;async function jE(s,e=[],t,i){if(!qE(s))return null;let n=HE(s,e,{...t,nothrow:!0},i);if(n)return n;if(vi(s)&&(s=await s.slice(0,10).arrayBuffer(),n=HE(s,e,t,i)),!n&&!(t!=null&&t.nothrow))throw new Error(XE(s));return n}function HE(s,e=[],t,i){if(!qE(s))return null;if(e&&!Array.isArray(e))return Dm(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...UE()),aR(n);let o=sR(s,n,t,i);if(!o&&!(t!=null&&t.nothrow))throw new Error(XE(s));return o}function sR(s,e,t,i){let{url:n,type:o}=Ms(s),a=n||i?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=Gm(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||lR(e,a),u=u||(l?"matched url ".concat(a):""),l=l||Gm(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||cR(e,s),u=u||(l?"matched initial data ".concat(YE(s)):""),l=l||Gm(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;zE.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function qE(s){return!(s instanceof Response&&s.status===204)}function XE(s){let{url:e,type:t}=Ms(s),i="No valid loader found (";i+=e?"".concat(id.filename(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let n=s?YE(s):"";return i+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",i+=")",i}function aR(s){for(let e of s)Dm(e)}function lR(s,e){let t=e&&oR.exec(e),i=t&&t[1];return i?uR(s,i):null}function uR(s,e){e=e.toLowerCase();for(let t of s)for(let i of t.extensions)if(i.toLowerCase()===e)return t;return null}function Gm(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function cR(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(hR(e,t))return t}else if(ArrayBuffer.isView(e)){if(WE(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&WE(e,0,t))return t;return null}function hR(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>s.startsWith(i))}function WE(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>dR(s,e,t,n))}function dR(s,e,t,i){if(i instanceof ArrayBuffer)return bm(i,s,i.byteLength);switch(typeof i){case"function":return i(s,t);case"string":let n=_m(s,e,i.length);return i===n;default:return!1}}function YE(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?_m(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?_m(s,0,e):""}function _m(s,e,t){if(s.byteLength<e+t)return"";let i=new DataView(s),n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i.getUint8(e+o));return n}function*$E(s,e){let t=e?.chunkSize||262144,i=0,n=new TextEncoder;for(;i<s.length;){let o=Math.min(s.length-i,t),a=s.slice(i,i+o);i+=o,yield n.encode(a)}}function*QE(s,e={}){let{chunkSize:t=262144}=e,i=0;for(;i<s.byteLength;){let n=Math.min(s.byteLength-i,t),o=new ArrayBuffer(n),a=new Uint8Array(s,i,n);new Uint8Array(o).set(a),i+=n,yield o}}async function*ZE(s,e){let t=e?.chunkSize||1048576,i=0;for(;i<s.size;){let n=i+t,o=await s.slice(i,n).arrayBuffer();i=n,yield o}}function Fm(s,e){return Lu?fR(s,e):gR(s,e)}async function*fR(s,e){let t=s.getReader(),i;try{for(;;){let n=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());let{done:o,value:a}=await n;if(o)return;yield rd(a)}}catch{t.releaseLock()}}async function*gR(s,e){for await(let t of s)yield rd(t)}function KE(s,e){if(typeof s=="string")return $E(s,e);if(s instanceof ArrayBuffer)return QE(s,e);if(vi(s))return ZE(s,e);if(nd(s))return Fm(s,e);if(Gn(s))return Fm(s.body,e);throw new Error("makeIterator")}var JE="Cannot convert supplied data type";function pR(s,e,t){if(e.text&&typeof s=="string")return s;if(hE(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let i=s.buffer,n=s.byteLength||s.length;return(s.byteOffset!==0||n!==i.byteLength)&&(i=i.slice(s.byteOffset,s.byteOffset+n)),i}throw new Error(JE)}async function ex(s,e,t){let i=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||i)return pR(s,e,t);if(vi(s)&&(s=await od(s)),Gn(s)){let n=s;return await gE(n),e.binary?await n.arrayBuffer():await n.text()}if(nd(s)&&(s=KE(s,t)),uE(s)||cE(s))return ym(s);throw new Error(JE)}function tx(s,e,t=null){if(t)return t;let i={fetch:pd(e,s),...s};return Array.isArray(i.loaders)||(i.loaders=null),i}function rx(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function md(s,e,t,i){lr(!i||typeof i=="object"),e&&!Array.isArray(e)&&!Nu(e)&&(i=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:n}=Ms(s),a=rx(e,i),l=await jE(s,a,t);return l?(t=kE(t,l,a,n),i=tx({url:n,parse:md,loaders:a},t,i),await mR(l,s,t,i)):null}async function mR(s,e,t,i){if(fm(s),e=await ex(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,i,s);if(gm(s,t))return await pm(s,e,t,i,md);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,i,s);if(s.parse)return await s.parse(e,t,i,s);throw lr(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function To(s,e,t,i){!Array.isArray(e)&&!Nu(e)&&(i=void 0,t=e,e=void 0);let n=pd(t),o=s;return typeof s=="string"&&(o=await n(s)),vi(s)&&(o=await n(s)),await md(o,e,t)}var ix="3.1.8";var{_parseImageNode:bR}=globalThis,Vm=typeof Image<"u",km=typeof ImageBitmap<"u",PR=Boolean(bR),Um=Lu?!0:PR;function nx(s){switch(s){case"auto":return km||Vm||Um;case"imagebitmap":return km;case"image":return Vm;case"data":return Um;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function ox(){if(km)return"imagebitmap";if(Vm)return"image";if(Um)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function yR(s){let e=SR(s);if(!e)throw new Error("Not an image");return e}function sx(s){switch(yR(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function SR(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var ER=/^data:image\/svg\+xml/,xR=/\.svg((\?|#).*)?$/;function bd(s){return s&&(ER.test(s)||xR.test(s))}function ax(s,e){if(bd(e)){let i=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return zm(s,e)}function zm(s,e){if(bd(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function Du(s,e,t){let i=ax(s,t),n=self.URL||self.webkitURL,o=typeof i!="string"&&n.createObjectURL(i);try{return await CR(o||i,e)}finally{o&&n.revokeObjectURL(o)}}async function CR(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,n)=>{try{t.onload=()=>i(t),t.onerror=o=>n(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){n(o)}})}var AR={},lx=!0;async function Hm(s,e,t){let i;bd(t)?i=await Du(s,e,t):i=zm(s,t);let n=e&&e.imagebitmap;return await vR(i,n)}async function vR(s,e=null){if((TR(e)||!lx)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),lx=!1}return await createImageBitmap(s)}function TR(s){for(let e in s||AR)return!1;return!0}function Pd(s){let e=Gu(s);return IR(e)||RR(e)||wR(e)||LR(e)}function IR(s){let e=Gu(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function wR(s){let e=Gu(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function LR(s){let e=Gu(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function RR(s){let e=Gu(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:i,sofMarkers:n}=OR(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(n.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!i.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function OR(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Gu(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function Wm(s,e){let{mimeType:t}=Pd(s)||{},i=globalThis._parseImageNode;return Ao(i),await i(s,t)}async function jm(s,e,t){e=e||{};let n=(e.image||{}).type||"auto",{url:o}=t||{},a=BR(n),l;switch(a){case"imagebitmap":l=await Hm(s,e,o);break;case"image":l=await Du(s,e,o);break;case"data":l=await Wm(s,e);break;default:Ao(!1)}return n==="data"&&(l=sx(l)),l}function BR(s){switch(s){case"auto":case"data":return ox();default:return nx(s),s}}var MR=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],NR=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],DR={image:{type:"auto",decode:!0}},_u={id:"image",module:"images",name:"Images",version:ix,mimeTypes:NR,extensions:MR,parse:jm,tests:[s=>Boolean(Pd(new DataView(s)))],options:DR};var xe=new Ar({id:"deck"});var ux={};function qt(s){xe.level>0&&ux[s]&&ux[s].call(...arguments)}var X=new Ar({id:"luma.gl"});function xt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var GR="Invalid WebGLRenderingContext";var _R="Requires WebGL2";function Gs(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function K(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function qm(s){return K(s)?s:null}function Fn(s){return xt(Gs(s),GR),s}function et(s){return xt(K(s),_R),s}var _s=Q(Fu()),Vu={};function FR(s){_s.global.console&&_s.global.console.error&&_s.global.console.error(s)}function VR(s){_s.global.console&&_s.global.console.log&&_s.global.console.log(s)}function kR(s,e){Vu[s]=!0,e!==void 0&&FR(e)}function UR(s){let e=s.getError;s.getError=function(){let i;do i=e.apply(s),i!==0&&(Vu[i]=!0);while(i!==0);for(i in Vu)if(Vu[i])return delete Vu[i],parseInt(i,10);return 0}}var ku=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){let n=new s.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};ku.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};ku.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var Fs=function(e){let t=this;this.gl=e,UR(e);let i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let p=d.attribs[o];return p.buffer=t.currentArrayBuffer,p.size=a,p.type=l,p.normalized=u,p.stride=c,p.offset=h,p.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{VR("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};Fs.prototype.VERTEX_ARRAY_BINDING_OES=34229;Fs.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new ku(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};Fs.prototype.createVertexArrayOES=function(){let e=new ku(this);return this.vertexArrayObjects.push(e),e};Fs.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};Fs.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof ku&&e.hasBeenBound&&e.ext===this)};Fs.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){kR(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(n===o)return;(!n||o.elementArrayBuffer!==n.elementArrayBuffer)&&i.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(n?n.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=n?n.attribs[u]:null;if((!n||c.enabled!==h.enabled)&&(c.enabled?i.enableVertexAttribArray.call(t,u):i.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!n||c.buffer!==h.buffer)&&(a!==c.buffer&&(i.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&i.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};function hx(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let n=e.call(this)||[];return n.indexOf("OES_vertex_array_object")<0&&n.push("OES_vertex_array_object"),n};let t=s.getExtension;s.getExtension=function(n){let o=t.call(this,n);return o||(n!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new Fs(this)),this.__OESVertexArrayObject))}}var dx="OES_element_index",fx="WEBGL_draw_buffers",zR="EXT_disjoint_timer_query",HR="EXT_disjoint_timer_query_webgl2",WR="EXT_texture_filter_anisotropic",gx="WEBGL_debug_renderer_info",jR=35723,qR=4352,XR=36795,YR=34047,$R=37445,QR=37446,qe=s=>K(s)?void 0:0,ZR={[3074]:s=>K(s)?void 0:36064,[jR]:s=>K(s)?void 0:qR,[35977]:qe,[32937]:qe,[XR]:(s,e)=>{let t=K(s)?s.getExtension(HR):s.getExtension(zR);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[$R]:(s,e)=>{let t=s.getExtension(gx);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[QR]:(s,e)=>{let t=s.getExtension(gx);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[YR]:(s,e)=>{let t=s.luma.extensions[WR];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:qe,[35071]:qe,[37447]:qe,[36063]:(s,e)=>{if(!K(s)){let t=s.getExtension(fx);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:qe,[35374]:qe,[35377]:qe,[34852]:s=>{if(!K(s)){let e=s.getExtension(fx);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(dx)?2147483647:65535,[33001]:s=>s.getExtension(dx)?16777216:65535,[33e3]:s=>16777216,[37157]:qe,[35373]:qe,[35657]:qe,[36183]:qe,[37137]:qe,[34045]:qe,[35978]:qe,[35979]:qe,[35968]:qe,[35376]:qe,[35375]:qe,[35659]:qe,[37154]:qe,[35371]:qe,[35658]:qe,[35076]:qe,[35077]:qe,[35380]:qe};function px(s,e,t){let i=ZR[t],n=typeof i=="function"?i(s,e,t):i;return n!==void 0?n:e(t)}var KR="OES_vertex_array_object",mx="ANGLE_instanced_arrays",JR="WEBGL_draw_buffers",eO="EXT_disjoint_timer_query",tO="EXT_texture_filter_anisotropic",rO="VertexArray requires WebGL2 or OES_vertex_array_object extension";function iO(s,e){return{webgl2:K(s),ext:s.getExtension(e)}}var Xm={[KR]:{meta:{suffix:"OES"},createVertexArray:()=>{xt(!1,rO)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[mx]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){xt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[JR]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{xt(!1)}},[eO]:{meta:{suffix:"EXT"},createQuery:()=>{xt(!1)},deleteQuery:()=>{xt(!1)},beginQuery:()=>{xt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},yd={readBuffer:(s,e,t)=>{K(s)&&e(t)},getVertexAttrib:(s,e,t,i)=>{let{webgl2:n,ext:o}=iO(s,mx),a;switch(i){case 35069:a=n?void 0:!1;break;case 35070:a=!n&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,i)},getProgramParameter:(s,e,t,i)=>{if(!K(s))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,i)},getInternalformatParameter:(s,e,t,i,n)=>{if(!K(s))switch(n){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,i,n)},getTexParameter(s,e,t,i){switch(i){case 34046:let{extensions:n}=s.luma,o=n[tO];i=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,i)},getParameter:px,hint(s,e,t,i){return e(t,i)}};function bx(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(hx(s),oO(s),aO(s,Xm),sO(s,{target:e,target2:s}),e.polyfilled=!0),s}var nO=typeof global<"u"?global:window;nO.polyfillContext=bx;function oO(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function sO(s,{target:e,target2:t}){Object.keys(yd).forEach(i=>{if(typeof yd[i]=="function"){let n=s[i]?s[i].bind(s):()=>{},o=yd[i].bind(null,s,n);e[i]=o,t[i]=o}})}function aO(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&lO(s,{extension:t,target:s.luma,target2:s})}function lO(s,{extension:e,target:t,target2:i}){let n=Xm[e];xt(n);let{meta:o={}}=n,{suffix:a=""}=o,l=s.getExtension(e);for(let u of Object.keys(n)){let c=`${u}${a}`,h=null;u==="meta"||typeof s[u]=="function"||(l&&typeof l[c]=="function"?h=(...d)=>l[c](...d):typeof n[u]=="function"&&(h=n[u].bind(t))),h&&(t[u]=h,i[u]=h)}}var Sd={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Io=(s,e,t)=>e?s.enable(t):s.disable(t),Px=(s,e,t)=>s.hint(t,e),Zr=(s,e,t)=>s.pixelStorei(t,e),uO=(s,e)=>{let t=K(s)?36009:36160;return s.bindFramebuffer(t,e)},cO=(s,e)=>s.bindFramebuffer(36008,e);function Uu(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var yx={[3042]:Io,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Io,[2885]:(s,e)=>s.cullFace(e),[2929]:Io,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Io,[35723]:Px,[36006]:uO,[2886]:(s,e)=>s.frontFace(e),[33170]:Px,[2849]:(s,e)=>s.lineWidth(e),[32823]:Io,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Io,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Io,[3088]:(s,e)=>s.scissor(...e),[2960]:Io,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:Zr,[3317]:Zr,[37440]:Zr,[37441]:Zr,[37443]:Zr,[3330]:Zr,[3332]:Zr,[3331]:Zr,[36010]:cO,[3314]:Zr,[32878]:Zr,[3316]:Zr,[3315]:Zr,[32877]:Zr,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=Uu(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=Uu(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=Uu(e)?e:[e,e];let[t,i]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,i)},stencilFunc:(s,e)=>{e=Uu(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilFuncSeparate(1028,t,i,n),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=Uu(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilOpSeparate(1028,t,i,n),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function ct(s,e,t){return e[s]!==void 0?e[s]:t[s]}var Sx={blendEquation:(s,e,t)=>s.blendEquationSeparate(ct(32777,e,t),ct(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(ct(32969,e,t),ct(32968,e,t),ct(32971,e,t),ct(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(ct(32824,e,t),ct(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(ct(32938,e,t),ct(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,ct(2962,e,t),ct(2967,e,t),ct(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,ct(34816,e,t),ct(36003,e,t),ct(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,ct(2964,e,t),ct(2965,e,t),ct(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,ct(34817,e,t),ct(34818,e,t),ct(34819,e,t))},Ym={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,i,n)=>s({[32773]:new Float32Array([e,t,i,n])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,i,n)=>s({[32969]:e,[32968]:t,[32971]:i,[32970]:n}),clearColor:(s,e,t,i,n)=>s({[3106]:new Float32Array([e,t,i,n])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,i,n)=>s({[3107]:[e,t,i,n]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,i,n)=>s({[3088]:new Int32Array([e,t,i,n])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,i)=>s({[2962]:e,[2967]:t,[2963]:i,[34816]:e,[36003]:t,[36004]:i}),stencilFuncSeparate:(s,e,t,i,n)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:n}),stencilOp:(s,e,t,i)=>s({[2964]:e,[2965]:t,[2966]:i,[34817]:e,[34818]:t,[34819]:i}),stencilOpSeparate:(s,e,t,i,n)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:n}),viewport:(s,e,t,i,n)=>s({[2978]:[e,t,i,n]})},sn=(s,e)=>s.isEnabled(e),$m={[3042]:sn,[2884]:sn,[2929]:sn,[3024]:sn,[32823]:sn,[32926]:sn,[32928]:sn,[3089]:sn,[2960]:sn,[35977]:sn};function Qm(s){for(let e in s)return!1;return!0}function Ex(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&s.length===e.length){for(let n=0;n<s.length;++n)if(s[n]!==e[n])return!1;return!0}return!1}function xx(s,e){let t=s[e].bind(s);s[e]=function(...n){let o=n[0];return o in s.state.cache?s.state.enable?s.state.cache[o]:t(...n):t(...n)},Object.defineProperty(s[e],"name",{value:`${e}-from-cache`,configurable:!1})}function hO(s,e,t){let i=s[e].bind(s);s[e]=function(...o){let{valueChanged:a,oldValue:l}=t(s.state._updateCache,...o);return a&&i(...o),l},Object.defineProperty(s[e],"name",{value:`${e}-to-cache`,configurable:!1})}function dO(s){let e=s.useProgram.bind(s);s.useProgram=function(i){s.state.program!==i&&(e(i),s.state.program=i)}}var Cx=class{constructor(e,{copyState:t=!1,log:i=()=>{}}={}){this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?xd(e):Object.assign({},Sd),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){xt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];Vs(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,i,n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){xt(o!==void 0);let a=e[o],l=this.cache[o];Ex(a,l)||(t=!0,i=l,n&&!(o in n)&&(n[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:i}}};function Zm(s,e={}){let{enable:t=!0,copyState:i}=e;if(xt(i!==void 0),!s.state){let n=typeof global<"u"?global:window,{polyfillContext:o}=n;o&&o(s),s.state=new Cx(s,{copyState:i}),dO(s);for(let a in Ym){let l=Ym[a];hO(s,a,l)}xx(s,"getParameter"),xx(s,"isEnabled")}return s.state.enable=t,s}function Km(s){s.state||Zm(s,{copyState:!1}),s.state.push()}function Ed(s){xt(s.state),s.state.pop()}function Vs(s,e){if(xt(Gs(s),"setParameters requires a WebGL context"),Qm(e))return;let t={};for(let n in e){let o=Number(n),a=yx[n];a&&(typeof a=="string"?t[a]=!0:a(s,e[n],o))}let i=s.state&&s.state.cache;if(i)for(let n in t)Sx[n](s,e,i)}function xd(s,e){if(e=e||Sd,typeof e=="number"){let n=e,o=$m[n];return o?o(s,n):s.getParameter(n)}let t=Array.isArray(e)?e:Object.keys(e),i={};for(let n of t){let o=$m[n];i[n]=o?o(s,Number(n)):s.getParameter(Number(n))}return i}function Xt(s,e,t){if(Qm(e))return t(s);let{nocatch:i=!0}=e;Km(s),Vs(s,e);let n;if(i)n=t(s),Ed(s);else try{n=t(s)}finally{Ed(s)}return n}var Jm=Q(Fu());var sle=(0,Jm.isBrowser)();var an=Q(Fu()),zu="8.5.10",PO="set luma.log.level=1 (or higher) to trace rendering",Ax=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new Za({id:e})),this.stats.get(e)}},ks=new Ax;if(an.global.luma&&an.global.luma.VERSION!==zu)throw new Error(`luma.gl - multiple VERSIONs detected: ${an.global.luma.VERSION} vs ${zu}`);an.global.luma||((0,an.isBrowser)()&&X.log(1,`luma.gl ${zu} - ${PO}`)(),an.global.luma=an.global.luma||{VERSION:zu,version:zu,log:X,stats:ks,globals:{modules:{},nodeIO:{}}});var Sle=an.global.luma;var Bx=Q(Fu());function H(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function Cd(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let i=s[e];return H(i!==void 0,`Accessing undefined constant GL.${e}`),i}function li(s,e){e=Number(e);for(let t in s)if(s[t]===e)return`GL.${t}`;return String(e)}var eb={};function vr(s="id"){eb[s]=eb[s]||1;let e=eb[s]++;return`${s}-${e}`}function tb(s){return H(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function ln(s){let e=!0;for(let t in s){e=!1;break}return e}function Ad(s,e,t,i){let n=`See luma.gl ${t} Upgrade Guide at https://luma.gl/docs/upgrade-guide`,o=Object.getPrototypeOf(s);i.forEach(a=>{o.methodName||(o[a]=()=>{throw X.removed(`Calling removed method ${e}.${a}: `,n)(),new Error(a)})})}var ol="Resource subclass must define virtual methods",Gt=class{constructor(e,t={}){Fn(e);let{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||vr(this.constructor.name),this.userData=n,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return`${this.constructor.name}(${this.id})`}get handle(){return this._handle}delete({deleteChildren:e=!1}={}){let t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(i=>i.delete()),this}bind(e=this.handle){if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e,t={}){e=Cd(this.gl,e),H(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=K(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){let l=n.webgl1,u="webgl2"in n?n.webgl2:n.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(e={}){let{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},o=K(this.gl),a={},l=t||Object.keys(n);for(let u of l){let c=n[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=i?li(this.gl,u):u;a[d]=this.getParameter(u,e),i&&c.type==="GLenum"&&(a[d]=li(this.gl,a[d]))}}return a}setParameter(e,t){e=Cd(this.gl,e),H(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=K(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");n.type==="GLenum"&&(t=Cd(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return Ad(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(ol)}_deleteHandle(){throw new Error(ol)}_bindHandle(e){throw new Error(ol)}_getOptsFromHandle(){throw new Error(ol)}_getParameter(e,t){throw new Error(ol)}_setParameter(e,t){throw new Error(ol)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){let e=this.constructor.name,t=ks.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get(`${e}s Created`).incrementCount(),t.get(`${e}s Active`).incrementCount()}_removeStats(){let e=this.constructor.name;ks.get("Resource Counts").get(`${e}s Active`).decrementCount()}_trackAllocatedMemory(e,t=this.constructor.name){let i=ks.get("Memory Usage");i.get("GPU Memory").addCount(e),i.get(`${t} Memory`).addCount(e),this.byteLength=e}_trackDeallocatedMemory(e=this.constructor.name){let t=ks.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get(`${e} Memory`).subtractCount(this.byteLength),this.byteLength=0}};var yO="Failed to deduce GL constant from typed array";function Hu(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(yO)}}function wo(s,{clamped:e=!0}={}){switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function vx({data:s,width:e,height:t,bytesPerPixel:i=4,temp:n}){let o=e*i;n=n||new Uint8Array(o);for(let a=0;a<t/2;++a){let l=a*o,u=(t-a-1)*o;n.set(s.subarray(l,l+o)),s.copyWithin(l,u,u+o),s.set(n,u)}}function Tx({data:s,width:e,height:t}){let i=Math.round(e/2),n=Math.round(t/2),o=new Uint8Array(i*n*4);for(let a=0;a<n;a++)for(let l=0;l<i;l++)for(let u=0;u<4;u++)o[(a*i+l)*4+u]=s[(a*2*e+l*2)*4+u];return{data:o,width:i,height:n}}function Wu(s,e,t){let{removedProps:i={},deprecatedProps:n={},replacedProps:o={}}=t;for(let l in i)if(l in e){let c=i[l]?`${s}.${i[l]}`:"N/A";X.removed(`${s}.${l}`,c)()}for(let l in n)if(l in e){let u=n[l];X.deprecated(`${s}.${l}`,`${s}.${u}`)()}let a=null;for(let l in o)if(l in e){let u=o[l];X.deprecated(`${s}.${l}`,`${s}.${u}`)(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var SO={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},EO={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},_t=class{static getBytesPerElement(e){return wo(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return H(e.size),wo(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(...e){return new _t(...[SO,...e])}constructor(...e){e.forEach(t=>this._assign(t)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return _t.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return _t.getBytesPerVertex(this)}_assign(e={}){return e=Wu("Accessor",e,EO),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var Ix=10,wx={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},xO={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:wx},CO={removedProps:wx},oe=class extends Gt{constructor(e,t={}){super(e,t);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(e=this.accessor){return Math.round(this.byteLength/_t.getBytesPerElement(e))}getVertexCount(e=this.accessor){return Math.round(this.byteLength/_t.getBytesPerVertex(e))}initialize(e={}){return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Wu("Buffer",e,xO),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Wu("Buffer",e,CO),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new _t(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:i=0,srcOffset:n=0}=e,o=e.byteLength||e.length;H(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),n!==0||o!==void 0?(et(this.gl),this.gl.bufferSubData(this.target,i,t,n,o)):this.gl.bufferSubData(a,i,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData({sourceBuffer:e,readOffset:t=0,writeOffset:i=0,size:n}){let{gl:o}=this;return et(o),o.bindBuffer(36662,e.handle),o.bindBuffer(36663,this.handle),o.copyBufferSubData(36662,36663,t,i,n),o.bindBuffer(36662,null),o.bindBuffer(36663,null),this.debugData=null,this}getData({dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}={}){et(this.gl);let o=wo(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=i,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,n||a),c=l+u);let h=Math.min(a,u);return n=n||h,H(n<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind({target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}={}){return e===35345||e===35982?n!==void 0?this.gl.bindBufferRange(e,t,this.handle,i,n):(H(i===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind({target:e=this.target,index:t=this.accessor&&this.accessor.index}={}){return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(Ix,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e,t=0,i=e.byteLength+t){H(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,Ix),this.bytesUsed=i,this._trackAllocatedMemory(i);let o=Hu(e);return H(o),this.setAccessor(new _t(this.accessor,{type:o})),this}_setByteLength(e,t=this.usage){H(e>=0),this._trackDeallocatedMemory();let i=e;e===0&&(i=new Float32Array(0));let n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=wo(this.accessor.type||5126,{clamped:!1}),i=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(e){this.accessor.type||this.setAccessor(new _t(this.accessor,{type:Hu(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return X.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return X.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return X.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return X.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new _t(this.accessor,e),this}};var vd={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},Td={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},Id={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function Lx(s,e){let t=vd[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let i=K(s)&&t.gl2||t.gl1;return typeof i=="string"?s.getExtension(i):i}function Rx(s,e){let t=vd[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var AO=[9729,9728],Ox=Bx.global.WebGLBuffer||function(){},Tr=class extends Gt{static isSupported(e,t={}){let{format:i,linearFiltering:n}=t,o=!0;return i&&(o=o&&Lx(e,i),o=o&&(!n||Rx(e,i))),o}constructor(e,t){let{id:i=vr("texture"),handle:n,target:o}=t;super(e,{id:i,handle:n});this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return`Texture(${this.id},${this.width}x${this.height})`}initialize(e={}){let t=e.data;if(t instanceof Promise)return t.then(B=>this.initialize(Object.assign({},e,{pixels:B,data:B}))),this;let i=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:n=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=n);let{width:d,height:p,dataFormat:y,type:x,compressed:A=!1,mipmaps:T=!0}=e,{depth:I=0}=e;return{width:d,height:p,compressed:A,dataFormat:y,type:x}=this._deduceParameters({format:o,type:x,dataFormat:y,compressed:A,data:t,width:d,height:p}),this.width=d,this.height=p,this.depth=I,this.format=o,this.type=x,this.dataFormat=y,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),T&&this._isNPOT()&&(X.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),T=!1,this._updateForNPOT(u)),this.mipmaps=T,this.setImageData({data:t,width:d,height:p,depth:I,format:o,type:x,dataFormat:y,border:a,mipmaps:T,parameters:c,compressed:A}),T&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),i&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize({height:e,width:t,mipmaps:i=!1}){return t!==this.width||e!==this.height?this.initialize({width:t,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(e={}){return this._isNPOT()?(X.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Xt(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:i=null,level:n=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:p=this.height,dataFormat:y=this.dataFormat,compressed:x=!1}=e;c||(c=i),{type:h,dataFormat:y,compressed:x,width:d,height:p}=this._deduceParameters({format:o,type:h,dataFormat:y,compressed:x,data:c,width:d,height:p});let{gl:A}=this;A.bindTexture(this.target,this.handle);let T=null;({data:c,dataType:T}=this._getDataType({data:c,compressed:x}));let I;if(Xt(this.gl,u,()=>{switch(T){case"null":A.texImage2D(t,n,o,d,p,a,y,h,c);break;case"typed-array":A.texImage2D(t,n,o,d,p,a,y,h,c,l);break;case"buffer":I=et(A),I.bindBuffer(35052,c.handle||c),I.texImage2D(t,n,o,d,p,a,y,h,l),I.bindBuffer(35052,null);break;case"browser-object":K(A)?A.texImage2D(t,n,o,d,p,a,y,h,c):A.texImage2D(t,n,o,y,h,c);break;case"compressed":for(let[B,w]of c.entries())A.compressedTexImage2D(t,B,w.format,w.width,w.height,a,w.data);break;default:H(!1,"Unknown image data type")}}),c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let B=Td[this.dataFormat]||4,w=Id[this.type]||1;this._trackAllocatedMemory(this.width*this.height*B*w,"Texture")}return this.loaded=!0,this}setSubImageData({target:e=this.target,pixels:t=null,data:i=null,x:n=0,y:o=0,width:a=this.width,height:l=this.height,level:u=0,format:c=this.format,type:h=this.type,dataFormat:d=this.dataFormat,compressed:p=!1,offset:y=0,border:x=this.border,parameters:A={}}){if({type:h,dataFormat:d,compressed:p,width:a,height:l}=this._deduceParameters({format:c,type:h,dataFormat:d,compressed:p,data:i,width:a,height:l}),H(this.depth===0,"texSubImage not supported for 3D textures"),i||(i=t),i&&i.data){let T=i;i=T.data,a=T.shape[0],l=T.shape[1]}i instanceof oe&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),Xt(this.gl,A,()=>{if(p)this.gl.compressedTexSubImage2D(e,u,n,o,a,l,c,i);else if(i===null)this.gl.texSubImage2D(e,u,n,o,a,l,d,h,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(e,u,n,o,a,l,d,h,i,y);else if(i instanceof Ox){let T=et(this.gl);T.bindBuffer(35052,i),T.texSubImage2D(e,u,n,o,a,l,d,h,y),T.bindBuffer(35052,null)}else K(this.gl)?et(this.gl).texSubImage2D(e,u,n,o,a,l,d,h,i):this.gl.texSubImage2D(e,u,n,o,d,h,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(e={}){return X.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType({data:e,compressed:t=!1}){return t?{data:e,dataType:"compressed"}:e===null?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof oe?{data:e.handle,dataType:"buffer"}:e instanceof Ox?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:i}=e,{width:n,height:o,dataFormat:a,type:l,compressed:u}=e,c=vd[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:n,height:o}=this._deduceImageSize(i,n,o),{dataFormat:a,type:l,compressed:u,width:n,height:o,format:t,data:i}}_deduceImageSize(e,t,i){let n;return typeof ImageData<"u"&&e instanceof ImageData?n={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?n={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?n={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?n={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?n={width:e.videoWidth,height:e.videoHeight}:e?n={width:t,height:i}:n={width:t>=0?t:1,height:i>=0?i:1},H(n,"Could not deduced texture size"),H(t===void 0||n.width===t,"Deduced texture width does not match supplied width"),H(i===void 0||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:H(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return K(this.gl)||!this.width||!this.height?!1:!tb(this.width)||!tb(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:AO.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var vO="";function Mx(s,e){return H(typeof s=="string"),s=vO+s,new Promise((t,i)=>{try{let n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error(`Could not load image ${s}.`)),n.crossOrigin=e&&e.crossOrigin||"anonymous",n.src=s}catch(n){i(n)}})}var Ct=class extends Tr{static isSupported(e,t){return Tr.isSupported(e,t)}constructor(e,t={}){Fn(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:Mx(t.data)}));super(e,Object.assign({},t,{target:3553}));this.initialize(t),Object.seal(this)}};var rb=[34069,34070,34071,34072,34073,34074],sl=class extends Tr{constructor(e,t={}){Fn(e);super(e,Object.assign({},t,{target:34067}));this.initialize(t),Object.seal(this)}initialize(e={}){let{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)}),this}subImage({face:e,data:t,x:i=0,y:n=0,mipmapLevel:o=0}){return this._subImage({target:e,data:t,x:i,y:n,mipmapLevel:o})}async setCubeMapImageData({width:e,height:t,pixels:i,data:n,border:o=0,format:a=6408,type:l=5121}){let{gl:u}=this,c=i||n,h=await Promise.all(rb.map(d=>{let p=c[d];return Promise.all(Array.isArray(p)?p:[p])}));this.bind(),rb.forEach((d,p)=>{h[p].length>1&&this.opts.mipmaps!==!1&&X.warn(`${this.id} has mipmap and multiple LODs.`)(),h[p].forEach((y,x)=>{e&&t?u.texImage2D(d,x,a,e,t,o,a,l,y):u.texImage2D(d,x,a,a,l,y)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:i,height:n,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(p=>this.setImageDataForFace(Object.assign({},e,{face:t,data:p,pixels:p}))):this.width||this.height?h.texImage2D(t,0,u,i,n,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};sl.FACES=rb;var ju=class extends Tr{static isSupported(e){return K(e)}constructor(e,t={}){et(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1});super(e,t);this.initialize(t),Object.seal(this)}setImageData({level:e=0,dataFormat:t=6408,width:i,height:n,depth:o=1,border:a=0,format:l,type:u=5121,offset:c=0,data:h,parameters:d={}}){if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),Xt(this.gl,d,()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,e,t,i,n,o,a,l,u,h),h instanceof oe&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,e,t,i,n,o,a,l,u,c))}),h&&h.byteLength)this._trackAllocatedMemory(h.byteLength,"Texture");else{let p=Td[this.dataFormat]||4,y=Id[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*p*y,"Texture")}return this.loaded=!0,this}};var Us="EXT_color_buffer_float",ib={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Us,bpp:2},[33327]:{gl2:Us,bpp:4},[34842]:{gl2:Us,bpp:8},[33326]:{gl2:Us,bpp:4},[33328]:{gl2:Us,bpp:8},[34836]:{gl2:Us,bpp:16},[35898]:{gl2:Us,bpp:4}};function TO(s,e,t){let i=t[e];if(!i)return!1;let n=K(s)&&i.gl2||i.gl1;return typeof n=="string"?s.getExtension(n):n}var un=class extends Gt{static isSupported(e,{format:t}={format:null}){return!t||TO(e,t,ib)}static getSamplesForFormat(e,{format:t}){return e.getInternalformatParameter(36161,t,32937)}constructor(e,t={}){super(e,t);this.initialize(t),Object.seal(this)}initialize({format:e,width:t=1,height:i=1,samples:n=0}){return H(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),n!==0&&K(this.gl)?this.gl.renderbufferStorageMultisample(36161,n,e,t,i):this.gl.renderbufferStorage(36161,e,t,i),this.format=e,this.width=t,this.height=i,this.samples=n,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*ib[this.format].bpp),this}resize({width:e,height:t}){return e!==this.width||t!==this.height?this.initialize({width:e,height:t,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var IO=256,wO=1024,LO=16384,Nx=6144,Dx=6145,Gx=6146,_x=34041,Fx="clear: bad arguments";function al(s,{framebuffer:e=null,color:t=null,depth:i=null,stencil:n=null}={}){let o={};e&&(o.framebuffer=e);let a=0;t&&(a|=LO,t!==!0&&(o.clearColor=t)),i&&(a|=IO,i!==!0&&(o.clearDepth=i)),n&&(a|=wO,i!==!0&&(o.clearStencil=i)),H(a!==0,Fx),Xt(s,o,()=>{s.clear(a)})}function nb(s,{framebuffer:e=null,buffer:t=Nx,drawBuffer:i=0,value:n=[0,0,0,0]}={}){et(s),Xt(s,{framebuffer:e},()=>{switch(t){case Nx:switch(n.constructor){case Int32Array:s.clearBufferiv(t,i,n);break;case Uint32Array:s.clearBufferuiv(t,i,n);break;case Float32Array:default:s.clearBufferfv(t,i,n)}break;case Dx:s.clearBufferfv(Dx,0,[n]);break;case Gx:s.clearBufferiv(Gx,0,[n]);break;case _x:let[o,a]=n;s.clearBufferfi(_x,0,o,a);break;default:H(!1,Fx)}})}function Vx(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return H(!1),0}}function zs(s,e={}){let{sourceX:t=0,sourceY:i=0,sourceFormat:n=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=kx(s);H(h);let{gl:p,handle:y,attachments:x}=h;l=l||h.width,u=u||h.height,o===36064&&y===null&&(o=1028),H(x[o]),c=c||x[o].type,a=RO(a,c,n,l,u),c=c||Hu(a);let A=p.bindFramebuffer(36160,y);return p.readPixels(t,i,l,u,n,c,a),p.bindFramebuffer(36160,A||null),d&&h.delete(),a}function wd(s,{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}={}){let i=zs(s,{sourceAttachment:e}),{width:n,height:o}=s;for(;o>t;)({data:i,width:n,height:o}=Tx({data:i,width:n,height:o}));vx({data:i,width:n,height:o});let a=document.createElement("canvas");a.width=n,a.height=o;let l=a.getContext("2d"),u=l.createImageData(n,o);return u.data.set(i),l.putImageData(u,0,0),a.toDataURL()}function Ld(s,e,t={}){let{sourceX:i=0,sourceY:n=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:p,deleteFramebuffer:y}=kx(s);H(p);let{gl:x,handle:A}=p,T=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let I=x.bindFramebuffer(36160,A);H(e);let B=null;if(e instanceof Tr&&(B=e,h=Number.isFinite(h)?h:B.width,d=Number.isFinite(d)?d:B.height,B.bind(0),e=B.target),!T)x.copyTexImage2D(e,o,a,i,n,h,d,0);else switch(e){case 3553:case 34067:x.copyTexSubImage2D(e,o,l,u,i,n,h,d);break;case 35866:case 32879:et(x).copyTexSubImage3D(e,o,l,u,c,i,n,h,d);break;default:}return B&&B.unbind(),x.bindFramebuffer(36160,I||null),y&&p.delete(),B}function kx(s){return s instanceof ht?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:Ux(s),deleteFramebuffer:!0}}function RO(s,e,t,i,n){if(s)return s;e=e||5121;let o=wo(e,{clamped:!1}),a=Vx(t);return new o(i*n*a)}var Xe={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function OO(s){let e=new Ct(s,{format:6408,type:5126,dataFormat:6408}),t=new ht(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),i=t.getStatus();return e.delete(),t.delete(),i===36053}var ob={[Xe.WEBGL2]:[!1,!0],[Xe.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[Xe.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[Xe.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[Xe.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[Xe.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[Xe.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[Xe.FLOAT_BLEND]:["EXT_float_blend"],[Xe.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[Xe.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[Xe.TEXTURE_FLOAT]:["OES_texture_float",!0],[Xe.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[Xe.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[Xe.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[Xe.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[Xe.COLOR_ATTACHMENT_RGBA32F]:[OO,"EXT_color_buffer_float"],[Xe.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[Xe.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[Xe.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[Xe.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[Xe.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[Xe.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var BO=2;function qu(s,e){return Rd(s,e)}function Rd(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>zx(s,t))}function Od(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in ob)s.luma.caps[e]===void 0&&(s.luma.caps[e]=zx(s,e));return s.luma.caps}function zx(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=MO(s,e)),s.luma.caps[e]||X.log(BO,`Feature: ${e} not supported`)(),s.luma.caps[e]}function MO(s,e){let t=ob[e];H(t,e);let i,n=K(s)&&t[1]||t[0];if(typeof n=="function")i=n(s);else if(Array.isArray(n)){i=!0;for(let o of n)i=i&&Boolean(s.getExtension(o))}else typeof n=="string"?i=Boolean(s.getExtension(n)):typeof n=="boolean"?i=n:H(!1);return i}var Hx="Multiple render targets not supported",ht=class extends Gt{static isSupported(e,t={}){let{colorBufferFloat:i,colorBufferHalfFloat:n}=t,o=!0;return i&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new ht(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=et(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=et(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e,t={}){super(e,t);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize({width:e=1,height:t=1,attachments:i=null,color:n=!0,depth:o=!0,stencil:a=!1,check:l=!0,readBuffer:u=void 0,drawBuffers:c=void 0}){if(H(e>=0&&t>=0,"Width and height need to be integers"),this.width=e,this.height=t,i)for(let h in i){let d=i[h];(Array.isArray(d)?d[0]:d).resize({width:e,height:t})}else i=this._createDefaultAttachments(n,o,a,e,t);this.update({clearAttachments:!0,attachments:i,readBuffer:u,drawBuffers:c}),i&&l&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update({attachments:e={},readBuffer:t,drawBuffers:i,clearAttachments:n=!1,resizeAttachments:o=!0}){this.attach(e,{clearAttachments:n,resizeAttachments:o});let{gl:a}=this,l=a.bindFramebuffer(36160,this.handle);return t&&this._setReadBuffer(t),i&&this._setDrawBuffers(i),a.bindFramebuffer(36160,l||null),this}resize(e={}){let{width:t,height:i}=e;if(this.handle===null)return H(t===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&X.log(2,`Resizing framebuffer ${this.id} to ${t}x${i}`)();for(let n in this.attachments)this.attachments[n].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e,{clearAttachments:t=!1,resizeAttachments:i=!0}={}){let n={};t&&Object.keys(this.attachments).forEach(a=>{n[a]=null}),Object.assign(n,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in n){H(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=n[l],c=u;if(!c)this._unattach(l);else if(c instanceof un)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,p=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:p})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});i&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(DO(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(e={}){let{color:t,depth:i,stencil:n,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&al(this.gl,{color:t,depth:i,stencil:n}),o.forEach((l,u)=>{nb(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(e={}){return X.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(e={}){return X.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(e={}){return X.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(e={}){return X.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(e={}){return X.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(e={}){return X.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate({attachments:e=[],x:t=0,y:i=0,width:n,height:o}){let a=et(this.gl),l=a.bindFramebuffer(36008,this.handle);return t===0&&i===0&&n===void 0&&o===void 0?a.invalidateFramebuffer(36008,e):a.invalidateFramebuffer(36008,e,t,i,n,o),a.bindFramebuffer(36008,l),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return n===null&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=li(this.gl,n)),n}getAttachmentParameters(e=36064,t,i=this.constructor.ATTACHMENT_PARAMETERS||[]){let n={};for(let o of i){let a=t?li(this.gl,o):o;n[a]=this.getAttachmentParameter(e,o,t)}return n}getParameters(e=!0){let t=Object.keys(this.attachments),i={};for(let n of t){let o=Number(n),a=e?li(this.gl,o):o;i[a]=this.getAttachmentParameters(o,e)}return i}show(){return typeof window<"u"&&window.open(wd(this),"luma-debug-texture"),this}log(e=0,t=""){if(e>X.level||typeof window>"u")return this;t=t||`Framebuffer ${this.id}`;let i=wd(this,{targetMaxHeight:100});return X.image({logLevel:e,message:t,image:i},t)(),this}bind({target:e=36160}={}){return this.gl.bindFramebuffer(e,this.handle),this}unbind({target:e=36160}={}){return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,o){let a=null;return e&&(a=a||{},a[36064]=new Ct(this.gl,{id:`${this.id}-color0`,pixels:null,format:6408,type:5121,width:n,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&i?(a=a||{},a[33306]=new un(this.gl,{id:`${this.id}-depth-stencil`,format:35056,width:n,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new un(this.gl,{id:`${this.id}-depth`,format:33189,width:n,height:o}),this.ownResources.push(a[36096])):i&&H(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof un?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer({attachment:e=36064,renderbuffer:t}){let{gl:i}=this;i.framebufferRenderbuffer(36160,e,36161,t.handle),this.attachments[e]=t}_attachTexture({attachment:e=36064,texture:t,layer:i,level:n}){let{gl:o}=this;switch(o.bindTexture(t.target,t.handle),t.target){case 35866:case 32879:et(o).framebufferTextureLayer(36160,e,t.target,n,i);break;case 34067:let l=NO(i);o.framebufferTexture2D(36160,e,l,t.handle,n);break;case 3553:o.framebufferTexture2D(36160,e,3553,t.handle,n);break;default:H(!1,"Illegal texture type")}o.bindTexture(t.target,null),this.attachments[e]=t}_setReadBuffer(e){let t=qm(this.gl);t?t.readBuffer(e):H(e===36064||e===1029,Hx),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,i=et(t);if(i)i.drawBuffers(e);else{let n=t.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(e):H(e.length===1&&(e[0]===36064||e[0]===1029),Hx)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=Od(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function NO(s){return s<34069?s+34069:s}function DO(s){return(ht.STATUS||{})[s]||`Framebuffer error ${s}`}var GO=[36049,36048,33296,33298,33299,33300,33301,33302,33303];ht.ATTACHMENT_PARAMETERS=GO;function ll(s,e){H(s instanceof Ct||s instanceof sl||s instanceof ju);let t=s.constructor,{gl:i,width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(i,d)}function Ux(s,e){let{gl:t,width:i,height:n,id:o}=s;return new ht(t,Object.assign({},e,{id:`framebuffer-for-${o}`,width:i,height:n,attachments:{[36064]:s}}))}function Lo(s,e="unnamed"){let t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=s.match(t);return i?i[1]:e}function sb(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function ab(s,e,t,i){let n=s.split(/\r?\n/),o={},a={},l=i||Lo(e)||"(unnamed)",u=`${sb(t)} shader ${l}`;for(let h=0;h<n.length;h++){let d=n[h];if(d.length<=1)continue;let p=d.split(":"),y=p[0],x=parseInt(p[2],10);if(isNaN(x))throw new Error(`GLSL compilation error in ${u}: ${s}`);y!=="WARNING"?o[x]=d:a[x]=d}let c=_O(e);return{shaderName:u,errors:Wx(o,c),warnings:Wx(a,c)}}function Wx(s,e){let t="";for(let i=0;i<e.length;i++){let n=e[i];if(!(!s[i+3]&&!s[i+2]&&!s[i+1])&&(t+=`${n}
`,s[i+1])){let o=s[i+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=jx(`^^^ ${l}: ${c}

`,u)}}return t}function _O(s,e=1,t=": "){let i=s.split(/\r?\n/),n=String(i.length+e-1).length;return i.map((o,a)=>{let l=String(a+e),u=l.length;return jx(l,n-u)+t+o})}function jx(s,e){let t="";for(let i=0;i<e;++i)t+=" ";return`${t}${s}`}function ul(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}return e}var FO="Shader: GLSL source code must be a JavaScript string",cl=class extends Gt{static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return H(!1),"unknown"}}constructor(e,t){Fn(e),H(typeof t.source=="string",FO);let i=Lo(t.source,null)||t.id||vr(`unnamed ${cl.getTypeName(t.shaderType)}`);super(e,{id:i});this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize({source:e}){let t=Lo(e,null);t&&(this.id=vr(t)),this._compile(e)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return`${cl.getTypeName(this.shaderType)}:${this.id}`}getName(){return Lo(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(e=this.source){if(e.startsWith("#version ")||(e=`#version 100
${e}`),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let i=this.gl.getShaderInfoLog(this.handle),{shaderName:n,errors:o,warnings:a}=ab(i,this.source,this.shaderType,this.id);throw X.error(`GLSL compilation errors in ${n}
${o}`)(),X.warn(`GLSL compilation warnings in ${n}
${a}`)(),new Error(`GLSL compilation errors in ${n}`)}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},Xu=class extends cl{constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},Yu=class extends cl{constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var VO={[5126]:tt.bind(null,"uniform1fv",Kr,1,ur),[35664]:tt.bind(null,"uniform2fv",Kr,2,ur),[35665]:tt.bind(null,"uniform3fv",Kr,3,ur),[35666]:tt.bind(null,"uniform4fv",Kr,4,ur),[5124]:tt.bind(null,"uniform1iv",Ro,1,ur),[35667]:tt.bind(null,"uniform2iv",Ro,2,ur),[35668]:tt.bind(null,"uniform3iv",Ro,3,ur),[35669]:tt.bind(null,"uniform4iv",Ro,4,ur),[35670]:tt.bind(null,"uniform1iv",Ro,1,ur),[35671]:tt.bind(null,"uniform2iv",Ro,2,ur),[35672]:tt.bind(null,"uniform3iv",Ro,3,ur),[35673]:tt.bind(null,"uniform4iv",Ro,4,ur),[35674]:tt.bind(null,"uniformMatrix2fv",Kr,4,Vn),[35675]:tt.bind(null,"uniformMatrix3fv",Kr,9,Vn),[35676]:tt.bind(null,"uniformMatrix4fv",Kr,16,Vn),[35678]:Yt,[35680]:Yt,[5125]:tt.bind(null,"uniform1uiv",Bd,1,ur),[36294]:tt.bind(null,"uniform2uiv",Bd,2,ur),[36295]:tt.bind(null,"uniform3uiv",Bd,3,ur),[36296]:tt.bind(null,"uniform4uiv",Bd,4,ur),[35685]:tt.bind(null,"uniformMatrix2x3fv",Kr,6,Vn),[35686]:tt.bind(null,"uniformMatrix2x4fv",Kr,8,Vn),[35687]:tt.bind(null,"uniformMatrix3x2fv",Kr,6,Vn),[35688]:tt.bind(null,"uniformMatrix3x4fv",Kr,12,Vn),[35689]:tt.bind(null,"uniformMatrix4x2fv",Kr,8,Vn),[35690]:tt.bind(null,"uniformMatrix4x3fv",Kr,12,Vn),[35678]:Yt,[35680]:Yt,[35679]:Yt,[35682]:Yt,[36289]:Yt,[36292]:Yt,[36293]:Yt,[36298]:Yt,[36299]:Yt,[36300]:Yt,[36303]:Yt,[36306]:Yt,[36307]:Yt,[36308]:Yt,[36311]:Yt},kO={},UO={},zO={},qx=[0];function lb(s,e,t,i){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(qx[0]=s,s=qx);let n=s.length;if(n%e&&X.warn(`Uniform size should be multiples of ${e}`,s)(),s instanceof t)return s;let o=i[n];o||(o=new t(n),i[n]=o);for(let a=0;a<n;a++)o[a]=s[a];return o}function Kr(s,e){return lb(s,e,Float32Array,kO)}function Ro(s,e){return lb(s,e,Int32Array,UO)}function Bd(s,e){return lb(s,e,Uint32Array,zO)}function ub(s,e,t){let i=VO[t.type];if(!i)throw new Error(`Unknown GLSL uniform type ${t.type}`);return i().bind(null,s,e)}function Xx(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${s}`);return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function Yx(s,e,t){for(let i in s){let n=s[i];if((!t||Boolean(t[i]))&&!HO(n))throw e=e?`${e} `:"",console.error(`${e} Bad uniform ${i}`,n),new Error(`${e} Bad uniform ${i}`)}return!0}function HO(s){return Array.isArray(s)||ArrayBuffer.isView(s)?WO(s):isFinite(s)||s===!0||s===!1||s instanceof Tr||s instanceof un?!0:s instanceof ht?Boolean(s.texture):!1}function $x(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let i=s[e];for(let n=0,o=t.length;n<o;++n)i[n]=t[n]}else s[e]=t.slice();else s[e]=t}function WO(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Yt(){let s=null;return(e,t,i)=>{let n=s!==i;return n&&(e.uniform1i(t,i),s=i),n}}function tt(s,e,t,i){let n=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(n===null)n=new Float32Array(h),o=h,d=!0;else{H(o===h,"Uniform length cannot change.");for(let p=0;p<h;++p)if(c[p]!==n[p]){d=!0;break}}return d&&(i(a,s,l,c),n.set(c)),d}}function ur(s,e,t,i){s[e](t,i)}function Vn(s,e,t,i){s[e](t,!1,i)}var jO=5120,qO=5121,XO=5122,YO=5123,Qx=0,Md=1,$O=2,QO=3,Nd=4,ZO=5,KO=6,Rt=5126,JO=35664,eB=35665,tB=35666,$u=5124,rB=35667,iB=35668,nB=35669,Qu=5125,oB=36294,sB=36295,aB=36296,lB=35670,uB=35671,cB=35672,hB=35673,dB=35674,fB=35675,gB=35676,pB=35685,mB=35686,bB=35687,PB=35688,yB=35689,SB=35690,cb={[Rt]:[Rt,1,"float"],[JO]:[Rt,2,"vec2"],[eB]:[Rt,3,"vec3"],[tB]:[Rt,4,"vec4"],[$u]:[$u,1,"int"],[rB]:[$u,2,"ivec2"],[iB]:[$u,3,"ivec3"],[nB]:[$u,4,"ivec4"],[Qu]:[Qu,1,"uint"],[oB]:[Qu,2,"uvec2"],[sB]:[Qu,3,"uvec3"],[aB]:[Qu,4,"uvec4"],[lB]:[Rt,1,"bool"],[uB]:[Rt,2,"bvec2"],[cB]:[Rt,3,"bvec3"],[hB]:[Rt,4,"bvec4"],[dB]:[Rt,8,"mat2"],[pB]:[Rt,8,"mat2x3"],[mB]:[Rt,8,"mat2x4"],[fB]:[Rt,12,"mat3"],[bB]:[Rt,12,"mat3x2"],[PB]:[Rt,12,"mat3x4"],[gB]:[Rt,16,"mat4"],[yB]:[Rt,16,"mat4x2"],[SB]:[Rt,16,"mat4x3"]};function Zx(s){switch(s){case Qx:return Qx;case Md:return Md;case QO:return Md;case $O:return Md;case Nd:return Nd;case ZO:return Nd;case KO:return Nd;default:return H(!1),0}}function hb(s){let e=cb[s];if(!e)return null;let[t,i]=e;return{type:t,components:i}}function Dd(s,e){switch(s){case jO:case qO:case XO:case YO:s=Rt;break;default:}for(let t in cb){let[i,n,o]=cb[t];if(i===s&&n===e)return{glType:t,name:o}}return null}var Gd=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,n),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((n,o)=>n.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!K(t))return;let i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,o,a,l)}this.varyingInfos.sort((n,o)=>n.location-o.location)}_addAttribute(e,t,i,n){let{type:o,components:a}=hb(i),l={type:o,size:n*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new _t(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){let{type:o,components:a}=hb(i),l=new _t({type:o,size:n*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var Kx=4,EB=35981,xB=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],Oo=class extends Gt{constructor(e,t={}){super(e,t);this.stubRemovedMethods("Program","v6.0",xB),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(e={}){let{hash:t,vs:i,fs:n,varyings:o,bufferMode:a=EB}=e;return this.hash=t||"",this.vs=typeof i=="string"?new Xu(this.gl,{id:`${e.id}-vs`,source:i}):i,this.fs=typeof n=="string"?new Yu(this.gl,{id:`${e.id}-fs`,source:n}):n,H(this.vs instanceof Xu),H(this.fs instanceof Yu),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(et(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Gd(this),this.setProps(e)}delete(e={}){return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw({logPriority:e,drawMode:t=4,vertexCount:i,offset:n=0,start:o,end:a,isIndexed:l=!1,indexType:u=5123,instanceCount:c=0,isInstanced:h=c>0,vertexArray:d=null,transformFeedback:p,framebuffer:y,parameters:x={},uniforms:A,samplers:T}){if((A||T)&&(X.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(A||{})),X.priority>=e){let I=y?y.id:"default",B=`mode=${li(this.gl,t)} verts=${i} instances=${c} indexType=${li(this.gl,u)} isInstanced=${h} isIndexed=${l} Framebuffer=${I}`;X.log(e,B)()}return H(d),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||i===0||h&&c===0?!1:(d.bindForDraw(i,c,()=>{if(y!==void 0&&(x=Object.assign({},x,{framebuffer:y})),p){let I=Zx(t);p.begin(I)}this._bindTextures(),Xt(this.gl,x,()=>{l&&h?this.gl2.drawElementsInstanced(t,i,u,n,c):l&&K(this.gl)&&!isNaN(o)&&!isNaN(a)?this.gl2.drawRangeElements(t,o,a,i,u,n):l?this.gl.drawElements(t,i,u,n):h?this.gl2.drawArraysInstanced(t,n,i,c):this.gl.drawArrays(t,n,i)}),p&&p.end()}),!0)}setUniforms(e={}){X.priority>=2&&Yx(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let i=e[t],n=this._uniformSetters[t];if(n){let o=i,a=!1;if(o instanceof ht&&(o=o.texture),o instanceof Tr)if(a=this.uniforms[t]!==i,a){n.textureIndex===void 0&&(n.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=n;l.bind(u),o=u,this._textureUniforms[t]=l}else o=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(o)||a)&&$x(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),i={};for(let n of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new Xu({handle:n});break;case 35632:i.fs=new Yu({handle:n});break;default:}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=vr(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?`${e}-program`:"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),X.time(Kx,`linkProgram for ${this._getName()}`)(),e.linkProgram(this.handle),X.timeEnd(Kx,`linkProgram for ${this._getName()}`)(),e.debug||X.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error(`Error linking: ${e.getProgramInfoLog(this.handle)}`);if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error(`Error validating: ${e.getProgramInfoLog(this.handle)}`)}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let i=this.gl.getActiveUniform(this.handle,t),{name:n}=Xx(i.name),o=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=ub(e,o,i),i.size>1)for(let a=0;a<i.size;a++)o=e.getUniformLocation(this.handle,`${n}[${a}]`),this._uniformSetters[`${n}[${a}]`]=ub(e,o,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var Bo=class extends Gt{static isSupported(e){return K(e)}constructor(e,t={}){et(e);super(e,t);this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(e={}){return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,ln(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(e={}){return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let i=this._getVaryingIndex(e),{buffer:n,byteSize:o,byteOffset:a}=this._getBufferParams(t);return i<0?(this.unused[e]=n,X.warn(()=>`${this.id} unused varying buffer ${e}`)(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,a,o),this)}begin(e=0){return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof oe?n=e:(n=e.buffer,i=e.byteSize,t=e.byteOffset),(t!==void 0||i!==void 0)&&(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t,i=0,n){let o=t&&t.handle;return!o||n===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,i,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var _d=null;function CB(s){return(!_d||_d.byteLength<s)&&(_d=new ArrayBuffer(s)),_d}function Jx(s,e){let t=CB(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function eC({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var AB="elements must be GL.ELEMENT_ARRAY_BUFFER",cr=class extends Gt{static isSupported(e,t={}){return t.constantAttributeZero?K(e)||(0,gd.getBrowser)()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new cr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return cr.MAX_ATTRIBUTES=cr.MAX_ATTRIBUTES||e.getParameter(34921),cr.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:cr._setConstantFloatArray(e,t,i);break;case Int32Array:cr._setConstantIntArray(e,t,i);break;case Uint32Array:cr._setConstantUintArray(e,t,i);break;default:H(!1)}}constructor(e,t={}){let i=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:i}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return cr.getMaxAttributes(this.gl)}initialize(e={}){return this.setProps(e)}setProps(e){return this}setElementBuffer(e=null,t={}){return H(!e||e.target===34963,AB),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,i){if(t.target===34963)return this.setElementBuffer(t,i);let{size:n,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=i,{gl:d,gl2:p}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(H(K(d)),p.vertexAttribIPointer(e,n,o,a,l)):d.vertexAttribPointer(e,n,o,u,a,l),d.enableVertexAttribArray(e),p.vertexAttribDivisor(e,h||0)}),this}enable(e,t=!0){return!t&&e===0&&!cr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,o=i.length*e,a=!this.buffer;if(this.buffer=this.buffer||new oe(this.gl,n),a=a||this.buffer.reallocate(n),a=a||!this._compareConstantArrayValues(i,this.bufferValue),a){let l=Jx(t.constructor,o);eC({target:l,source:i,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:H(!1)}}static _setConstantIntArray(e,t,i){switch(H(K(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:H(!1)}}static _setConstantUintArray(e,t,i){switch(H(K(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:H(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,{location:t}){return H(Number.isFinite(t)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(t,e);default:return this.gl.getVertexAttrib(t,e)}})}};var vB="VertexArray: attributes must be Buffers or constants (i.e. typed array)",TB=/^(.+)__LOCATION_([0-9]+)$/,IB=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],Zu=class{constructor(e,t={}){let i=t.id||t.program&&t.program.id;this.id=i,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new cr(e),Ad(this,"VertexArray","v6.0",IB),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(e={}){return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let i=e[t];this._setAttribute(t,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(e=null,t={}){return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t,i={}){if(t.target===34963)return this.setElementBuffer(t,i);let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,o)),this}setConstant(e,t,i={}){let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new oe(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof oe&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof oe&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),n=i()}),n}_resolveLocationAndAccessor(e,t,i,n){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,X.once(3,()=>`unused value ${e} in ${this.id}`)(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=_t.resolve(u.accessor,c,i,n),{size:d,type:p}=h;return H(Number.isFinite(d)&&Number.isFinite(p)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let i=TB.exec(e),n=i?i[1]:e,o=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+o,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof oe)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof oe){let i=t[0],n=t[1];this.setBuffer(e,i,n)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let i=t;this.setConstant(e,i)}else if(t.buffer instanceof oe){let i=t;this.setBuffer(e,i.buffer,i)}else throw new Error(vB)}_setConstantAttributes(e,t){let i=Math.max(e|0,t|0),n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)n=this.values[o],ArrayBuffer.isView(n)&&this._setConstantAttribute(o,n)}_setConstantAttributeZero(e,t){if(cr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){cr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let i=this.values[t],n=this.accessors[t];if(!i)return;let{divisor:o}=n,a=o>0;if(e.isInstanced=e.isInstanced||a,i instanceof oe){let l=i;if(a){let u=l.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(e=null,t={}){return X.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function wB(s,e){let{maxElts:t=16,size:i=1}=e,n="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(n+=`,${a%i===0?" ":""}`),n+=Hs(s[a],e);let o=s.length>t?"...":"]";return`${n}${o}`}function Hs(s,e={}){let{isInteger:i=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return wB(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<1e-16)return i?"0":"0.";if(i||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let n=s.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function Fd({header:s="Uniforms",program:e,uniforms:t,undefinedOnly:i=!1}){H(e);let n=".*_.*",o=".*Matrix",a=e._uniformSetters,l={},u=Object.keys(a).sort(),c=0;for(let p of u)!p.match(n)&&!p.match(o)&&db({table:l,header:s,uniforms:t,uniformName:p,undefinedOnly:i})&&c++;for(let p of u)p.match(o)&&db({table:l,header:s,uniforms:t,uniformName:p,undefinedOnly:i})&&c++;for(let p of u)l[p]||db({table:l,header:s,uniforms:t,uniformName:p,undefinedOnly:i})&&c++;let h=0,d={};if(!i)for(let p in t){let y=t[p];l[p]||(h++,d[p]={Type:`NOT USED: ${y}`,[s]:Hs(y)})}return{table:l,count:c,unusedTable:d,unusedCount:h}}function db({table:s,header:e,uniforms:t,uniformName:i,undefinedOnly:n}){let o=t[i],a=LB(o);return!n||!a?(s[i]={[e]:a?Hs(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0):!1}function LB(s){return s!=null}function fb({vertexArray:s,header:e="Attributes"}){if(!s.configuration)return{};let t={};s.elements&&(t.ELEMENT_ARRAY_BUFFER=tC(s,s.elements,null,e));let i=s.values;for(let n in i){let o=s._getAttributeInfo(n);if(o){let a=`${n}: ${o.name}`,l=s.accessors[o.location];l&&(a=`${n}: ${RB(o.name,l)}`),t[a]=tC(s,i[n],l,e)}}return t}function tC(s,e,t,i){let{gl:n}=s;if(!e)return{[i]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof oe){let p=e,{data:y,changed:x}=p.getDebugData();h=x?"*":"",d=y,u=p.byteLength,l=u/y.BYTES_PER_ELEMENT/a;let A;return t?A=`${t.divisor>0?"I ":"P "} ${l} (x${a}=${u} bytes ${li(n,o)})`:(c=!0,A=`${u} bytes`),{[i]:`${h}${Hs(d,{size:a,isInteger:c})}`,"Format ":A}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[i]:`${Hs(d,{size:a,isInteger:c})} (constant)`,"Format ":`${a}x${o} (constant)`}}function RB(s,e){let{type:t,size:i}=e,n=Dd(t,i);return n?`${s} (${n.name})`:s}function gb(s){let e={},t=`Accessors for ${s.id}`;for(let i of s.attributeInfos)if(i){let n=rC(i);e[`in ${n}`]={[t]:JSON.stringify(i.accessor)}}for(let i of s.varyingInfos)if(i){let n=rC(i);e[`out ${n}`]={[t]:JSON.stringify(i.accessor)}}return e}function rC(s){let{type:e,size:t}=s.accessor,i=Dd(e,t);return i?`${i.name} ${s.name}`:s.name}var Ws="vs",Ku="fs";function bt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var pb={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function nC(s){let e={};for(let t in s){let i=s[t],n=BB(i);e[t]=n}return e}function BB(s){let e=iC(s);return e==="object"?s?"type"in s?Object.assign({},s,pb[s.type]):"value"in s?(e=iC(s.value),Object.assign({type:e},s,pb[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},pb[e])}function iC(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var MB="vs",NB="fs",Ju=class{constructor({name:e,vs:t,fs:i,dependencies:n=[],uniforms:o,getUniforms:a,deprecations:l=[],defines:u={},inject:c={},vertexShader:h,fragmentShader:d}){bt(typeof e=="string"),this.name=e,this.vs=t||h,this.fs=i||d,this.getModuleUniforms=a,this.dependencies=n,this.deprecations=this._parseDeprecationDefinitions(l),this.defines=u,this.injections=DB(c),o&&(this.uniforms=nC(o))}getModuleSource(e){let t;switch(e){case MB:t=this.vs||"";break;case NB:t=this.fs||"";break;default:bt(!1)}return`#define MODULE_${this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_")}
${t}// END MODULE_${this.name}

`}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),e}_defaultGetUniforms(e={}){let t={},i=this.uniforms;for(let n in i){let o=i[n];n in e&&!o.private?(o.validate&&bt(o.validate(e[n],o),`${this.name}: invalid ${n}`),t[n]=e[n]):t[n]=o.value}return t}};function DB(s){let e={vs:{},fs:{}};for(let t in s){let i=s[t],n=t.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),e[n][t]=i}return e}function oC(s){return GB(aC(s))}function GB(s){let e={},t={};return sC({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((i,n)=>t[n]-t[i]).map(i=>e[i])}function sC({modules:s,level:e,moduleMap:t,moduleDepth:i}){if(e>=5)throw new Error("Possible loop in shader dependency graph");for(let n of s)t[n.name]=n,(i[n.name]===void 0||i[n.name]<e)&&(i[n.name]=e);for(let n of s)n.dependencies&&sC({modules:n.dependencies,level:e+1,moduleMap:t,moduleDepth:i})}function aC(s,e){return s.map(t=>(t instanceof Ju||(bt(typeof t!="string",`Shader module use by name is deprecated. Import shader module '${t}' and use it directly.`),bt(t.name,"shader module has no name"),t=new Ju(t),t.dependencies=aC(t.dependencies)),t))}function mb(s={}){let e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n}var _B=7936,FB=7937,VB=7938,kB=35724,Pb={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Mo={};Object.keys(Pb).forEach(s=>{Mo[s]=s});function UB(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function lC(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||_B),i=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||FB);return{gpuVendor:zB(t,i),vendor:t,renderer:i,version:s.getParameter(VB),shadingLanguageVersion:s.getParameter(kB)}}function zB(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var bb={};function yb(s,e,t={}){let i=Pb[e];if(bt(i,e),!mb(t))return!0;if(e in bb)return bb[e];let n=i[0],o=t.behavior||"enable",a=`#extension GL_${n} : ${o}
void main(void) {}`,l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),bb[e]=u,u}function HB(s,e){let t=Pb[e];bt(t,e);let i=UB(s)&&t[1]||t[0],n=typeof i=="string"?Boolean(s.getExtension(i)):i;return bt(n===!1||n===!0),n}function ec(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>HB(s,t))}function uC(s){switch(lC(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function cC(s,e,t){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return ec(s,Mo.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),ec(s,Mo.GLSL_DERIVATIVES)&&yb(s,Mo.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),ec(s,Mo.GLSL_FRAG_DATA)&&yb(s,Mo.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),ec(s,Mo.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}var hC=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,dC=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var WB={[Ws]:hC,[Ku]:dC},tc="__LUMA_INJECT_DECLARATIONS__",fC=/void\s+main\s*\([^)]*\)\s*\{\n?/,gC=/}\n?[^{}]*$/,Sb=[];function Vd(s,e,t,i=!1){let n=e===Ws;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),Sb.length=a.length;for(let u=0,c=a.length;u<c;++u)Sb[u]=a[u].injection;let l=`${Sb.join(`
`)}
`;switch(o){case"vs:#decl":n&&(s=s.replace(tc,l));break;case"vs:#main-start":n&&(s=s.replace(fC,u=>u+l));break;case"vs:#main-end":n&&(s=s.replace(gC,u=>l+u));break;case"fs:#decl":n||(s=s.replace(tc,l));break;case"fs:#main-start":n||(s=s.replace(fC,u=>u+l));break;case"fs:#main-end":n||(s=s.replace(gC,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(tc,""),i&&(s=s.replace(/\}\s*$/,o=>o+WB[e])),s}function hl(s){let e={};return bt(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let i in t)e[i]=e[i]?`${e[i]}
${t[i]}`:t[i]}),e}function dl(s){return new RegExp(`\\b${s}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}var pC=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],jB=[...pC,[dl("attribute"),"in $1"],[dl("varying"),"out $1"]],qB=[...pC,[dl("varying"),"in $1"]],mC=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],XB=[...mC,[dl("in"),"attribute $1"],[dl("out"),"varying $1"]],YB=[...mC,[dl("in"),"varying $1"]],Eb="gl_FragColor",xb=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,$B=/void\s+main\s*\([^)]*\)\s*\{\n?/;function Cb(s,e,t){switch(e){case 300:return t?kd(s,jB):QB(s);case 100:return t?kd(s,XB):ZB(s);default:throw new Error(`unknown GLSL version ${e}`)}}function kd(s,e){for(let[t,i]of e)s=s.replace(t,i);return s}function QB(s){s=kd(s,qB);let e=s.match(xb);if(e){let t=e[1];s=s.replace(new RegExp(`\\b${Eb}\\b`,"g"),t)}else{let t="fragmentColor";s=s.replace($B,i=>`out vec4 ${t};
${i}`).replace(new RegExp(`\\b${Eb}\\b`,"g"),t)}return s}function ZB(s){s=kd(s,YB);let e=s.match(xb);if(e){let t=e[1];s=s.replace(xb,"").replace(new RegExp(`\\b${t}\\b`,"g"),Eb)}return s}var KB=`

${tc}

`,PC={[Ws]:"vertex",[Ku]:"fragment"},JB=`precision highp float;

`;function Ab(s,e){let{vs:t,fs:i}=e,n=oC(e.modules||[]);return{gl:s,vs:bC(s,Object.assign({},e,{source:t,type:Ws,modules:n})),fs:bC(s,Object.assign({},e,{source:i,type:Ku,modules:n})),getUniforms:eM(n)}}function bC(s,{id:e,source:t,type:i,modules:n,defines:o={},hookFunctions:a=[],inject:l={},transpileToGLSL100:u=!1,prologue:c=!0,log:h}){bt(typeof t=="string","shader source must be a string");let d=i===Ws,p=t.split(`
`),y=100,x="",A=t;p[0].indexOf("#version ")===0?(y=300,x=p[0],A=p.slice(1).join(`
`)):x=`#version ${y}`;let T={};n.forEach(z=>{Object.assign(T,z.getDefines())}),Object.assign(T,o);let I=c?`${x}
${rM({id:e,source:t,type:i})}
${tM({type:i})}
${uC(s)}
${cC(s,y,!d)}
${iM(T)}
${d?"":JB}
`:`${x}
`,B=oM(a),w={},M={},F={};for(let z in l){let se=typeof l[z]=="string"?{injection:l[z],order:0}:l[z],pe=z.match(/^(v|f)s:(#)?([\w-]+)$/);if(pe){let de=pe[2],Ae=pe[3];de?Ae==="decl"?M[z]=[se]:F[z]=[se]:w[z]=[se]}else F[z]=[se]}for(let z of n){h&&z.checkDeprecations(A,h),I+=z.getModuleSource(i,y);let pe=z.injections[i];for(let de in pe){let Ae=de.match(/^(v|f)s:#([\w-]+)$/);if(Ae){let ge=Ae[2]==="decl"?M:F;ge[de]=ge[de]||[],ge[de].push(pe[de])}else w[de]=w[de]||[],w[de].push(pe[de])}}return I+=KB,I=Vd(I,i,M),I+=nM(B[i],w),I+=A,I=Vd(I,i,F),I=Cb(I,u?100:y,d),I}function eM(s){return function(t){let i={};for(let n of s){let o=n.getUniforms(t,i);Object.assign(i,o)}return i}}function tM({type:s}){return`
#define SHADER_TYPE_${PC[s].toUpperCase()}
`}function rM({id:s,source:e,type:t}){return s&&typeof s=="string"&&e.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${s}_${PC[t]}

`:""}function iM(s={}){let e=0,t="";for(let i in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let n=s[i];(n||Number.isFinite(n))&&(t+=`#define ${i.toUpperCase()} ${s[i]}
`)}return e===0&&(t+=`
`),t}function nM(s,e){let t="";for(let i in s){let n=s[i];if(t+=`void ${n.signature} {
`,n.header&&(t+=`  ${n.header}`),e[i]){let o=e[i];o.sort((a,l)=>a.order-l.order);for(let a of o)t+=`  ${a.injection}
`}n.footer&&(t+=`  ${n.footer}`),t+=`}
`}return t}function oM(s){let e={vs:{},fs:{}};return s.forEach(t=>{let i;typeof t!="string"?(i=t,t=i.hook):i={},t=t.trim();let[n,o]=t.split(":"),a=t.replace(/\(.+/,"");e[n][a]=Object.assign(i,{signature:o})}),e}var sM="void main() {gl_FragColor = vec4(0);}",yC=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,aM=`#version 300 es
${yC}`;function Ud(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[i,n,o]=t;if(!e.includes(i)||!n||!o)return null;let a=o.split(";")[0];return{qualifier:i,type:n,name:a}}function rc(s={}){let{version:e=100,input:t,inputType:i,output:n}=s;if(!t)return e===300?aM:e>300?`#version ${e}
${yC}`:sM;let o=SC(t,i);return e>=300?`#version ${e} ${e===300?"es":""}
in ${i} ${t};
out vec4 ${n};
void main() {
  ${n} = ${o};
}`:`varying ${i} ${t};
void main() {
  gl_FragColor = ${o};
}`}function vb(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return bt(!1),null}}function Tb(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return bt(!1),null}}function SC(s,e){switch(e){case"float":return`vec4(${s}, 0.0, 0.0, 1.0)`;case"vec2":return`vec4(${s}, 0.0, 1.0)`;case"vec3":return`vec4(${s}, 1.0)`;case"vec4":return s;default:return bt(!1),null}}var lM=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,zd={name:"fp32",vs:lM,fs:null};function Ti(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var Rde=1/Math.PI*180,Ode=1/180*Math.PI,Ye={};Ye.EPSILON=1e-12;Ye.debug=!1;Ye.precision=4;Ye.printTypes=!1;Ye.printDegrees=!1;Ye.printRowMajor=!0;function uM(s){return Math.round(s/Ye.EPSILON)*Ye.EPSILON}function Ib(s,{precision:e=Ye.precision||4}={}){return s=uM(s),"".concat(parseFloat(s.toPrecision(e)))}function kn(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function cM(s){return s.clone?s.clone():new Array(s.length)}function hM(s,e,t){if(kn(s)){t=t||cM(s);for(let i=0;i<t.length&&i<s.length;++i)t[i]=e(s[i],i,t);return t}return e(s)}function wb(s,e,t){return hM(s,i=>Math.max(e,Math.min(t,i)))}function Hd(s,e,t){return kn(s)?s.map((i,n)=>Hd(i,e[n],t)):t*e+(1-t)*s}function js(s,e,t){let i=Ye.EPSILON;t&&(Ye.EPSILON=t);try{if(s===e)return!0;if(kn(s)&&kn(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!js(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):Number.isFinite(s)&&Number.isFinite(e)?Math.abs(s-e)<=Ye.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{Ye.EPSILON=i}}function dM(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var fl=class extends dM(Array){get ELEMENTS(){return Ti(!1),0}clone(){return new this.constructor().copy(this)}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}to(e){return e===this?this:kn(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Ye)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+Ib(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!js(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){i===void 0&&(i=t,t=e,e=this);for(let n=0;n<this.ELEMENTS;++n){let o=e[n];this[n]=o+i*(t[n]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(Array.isArray(e))return this.multiply(e);for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.scale(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}multiplyByScalar(e){return this.scale(e)}get elements(){return this}check(){if(Ye.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}};function fM(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function hr(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function Wd(s,e,t=""){if(Ye.debug&&!fM(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var EC={};function jd(s,e){EC[s]||(EC[s]=!0,console.warn("".concat(s," has been removed in version ").concat(e,", see upgrade guide for more information")))}var qd=class extends fl{get ELEMENTS(){return Ti(!1),0}copy(e){return Ti(!1),this}get x(){return this[0]}set x(e){this[0]=hr(e)}get y(){return this[1]}set y(e){this[1]=hr(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let n=this[i]-e[i];t+=n*n}return hr(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return hr(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Ti(e>=0&&e<this.ELEMENTS,"index is out of range"),hr(this[e])}setComponent(e,t){return Ti(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var No=1e-6,cn=typeof Float32Array<"u"?Float32Array:Array;var zde=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function gM(){var s=new cn(2);return cn!=Float32Array&&(s[0]=0,s[1]=0),s}function Yd(s,e,t,i){var n=e[0],o=e[1];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s}function CC(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[4]*n+t[12],s[1]=t[1]*i+t[5]*n+t[13],s}var Hde=function(){var s=gM();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function AC(s,e,t){let i=e[0],n=e[1],o=t[3]*i+t[7]*n||1;return s[0]=(t[0]*i+t[4]*n)/o,s[1]=(t[1]*i+t[5]*n)/o,s}function $d(s,e,t){let i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o||1;return s[0]=(t[0]*i+t[4]*n+t[8]*o)/a,s[1]=(t[1]*i+t[5]*n+t[9]*o)/a,s[2]=(t[2]*i+t[6]*n+t[10]*o)/a,s}function vC(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s}function pM(){var s=new cn(3);return cn!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function TC(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function mM(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function IC(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=n*u-o*l,s[1]=o*a-i*u,s[2]=i*l-n*a,s}function Qd(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,s[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,s[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,s}function wC(s,e,t){var i=e[0],n=e[1],o=e[2];return s[0]=i*t[0]+n*t[3]+o*t[6],s[1]=i*t[1]+n*t[4]+o*t[7],s[2]=i*t[2]+n*t[5]+o*t[8],s}function LC(s,e,t){var i=t[0],n=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=n*c-o*u,d=o*l-i*c,p=i*u-n*l,y=n*p-o*d,x=o*h-i*p,A=i*d-n*h,T=a*2;return h*=T,d*=T,p*=T,y*=2,x*=2,A*=2,s[0]=l+h+y,s[1]=u+d+x,s[2]=c+p+A,s}function RC(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function OC(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function BC(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function MC(s,e){var t=s[0],i=s[1],n=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+i*i+n*n),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&mM(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var jde=function(){var s=pM();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var Ob=[0,0,0],NC={},Br=class extends qd{static get ZERO(){return NC.ZERO=NC.ZERO||Object.freeze(new Br(0,0,0,0))}constructor(e=0,t=0,i=0){super(-0,-0,-0);arguments.length===1&&kn(e)?this.copy(e):(Ye.debug&&(hr(e),hr(t),hr(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Ye.debug&&(hr(e.x),hr(e.y),hr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=hr(e)}angle(e){return MC(this,e)}cross(e){return IC(this,this,e),this.check()}rotateX({radians:e,origin:t=Ob}){return RC(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Ob}){return OC(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Ob}){return BC(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Qd(this,this,e),this.check()}transformAsVector(e){return $d(this,this,e),this.check()}transformByMatrix3(e){return wC(this,this,e),this.check()}transformByMatrix2(e){return vC(this,this,e),this.check()}transformByQuaternion(e){return LC(this,this,e),this.check()}};var Zd=class extends fl{get ELEMENTS(){return Ti(!1),0}get RANK(){return Ti(!1),0}toString(){let e="[";if(Ye.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=hr(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[i+n];return t}setColumn(e,t){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)this[i+n]=t[n];return this}};function bM(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function DC(s,e){if(s===e){var t=e[1],i=e[2],n=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=i,s[9]=o,s[11]=e[14],s[12]=n,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function GC(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],p=e[10],y=e[11],x=e[12],A=e[13],T=e[14],I=e[15],B=t*l-i*a,w=t*u-n*a,M=t*c-o*a,F=i*u-n*l,z=i*c-o*l,se=n*c-o*u,pe=h*A-d*x,de=h*T-p*x,Ae=h*I-y*x,$e=d*T-p*A,ge=d*I-y*A,me=p*I-y*T,J=B*me-w*ge+M*$e+F*Ae-z*de+se*pe;return J?(J=1/J,s[0]=(l*me-u*ge+c*$e)*J,s[1]=(n*ge-i*me-o*$e)*J,s[2]=(A*se-T*z+I*F)*J,s[3]=(p*z-d*se-y*F)*J,s[4]=(u*Ae-a*me-c*de)*J,s[5]=(t*me-n*Ae+o*de)*J,s[6]=(T*M-x*se-I*w)*J,s[7]=(h*se-p*M+y*w)*J,s[8]=(a*ge-l*Ae+c*pe)*J,s[9]=(i*Ae-t*ge-o*pe)*J,s[10]=(x*z-A*M+I*B)*J,s[11]=(d*M-h*z-y*B)*J,s[12]=(l*de-a*$e-u*pe)*J,s[13]=(t*$e-i*de+n*pe)*J,s[14]=(A*w-x*F-T*B)*J,s[15]=(h*F-d*w+p*B)*J,s):null}function _C(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],p=s[11],y=s[12],x=s[13],A=s[14],T=s[15],I=e*a-t*o,B=e*l-i*o,w=e*u-n*o,M=t*l-i*a,F=t*u-n*a,z=i*u-n*l,se=c*x-h*y,pe=c*A-d*y,de=c*T-p*y,Ae=h*A-d*x,$e=h*T-p*x,ge=d*T-p*A;return I*ge-B*$e+w*Ae+M*de-F*pe+z*se}function Bb(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],p=e[9],y=e[10],x=e[11],A=e[12],T=e[13],I=e[14],B=e[15],w=t[0],M=t[1],F=t[2],z=t[3];return s[0]=w*i+M*l+F*d+z*A,s[1]=w*n+M*u+F*p+z*T,s[2]=w*o+M*c+F*y+z*I,s[3]=w*a+M*h+F*x+z*B,w=t[4],M=t[5],F=t[6],z=t[7],s[4]=w*i+M*l+F*d+z*A,s[5]=w*n+M*u+F*p+z*T,s[6]=w*o+M*c+F*y+z*I,s[7]=w*a+M*h+F*x+z*B,w=t[8],M=t[9],F=t[10],z=t[11],s[8]=w*i+M*l+F*d+z*A,s[9]=w*n+M*u+F*p+z*T,s[10]=w*o+M*c+F*y+z*I,s[11]=w*a+M*h+F*x+z*B,w=t[12],M=t[13],F=t[14],z=t[15],s[12]=w*i+M*l+F*d+z*A,s[13]=w*n+M*u+F*p+z*T,s[14]=w*o+M*c+F*y+z*I,s[15]=w*a+M*h+F*x+z*B,s}function ic(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,p,y,x,A,T,I;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],p=e[6],y=e[7],x=e[8],A=e[9],T=e[10],I=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=p,s[7]=y,s[8]=x,s[9]=A,s[10]=T,s[11]=I,s[12]=a*i+h*n+x*o+e[12],s[13]=l*i+d*n+A*o+e[13],s[14]=u*i+p*n+T*o+e[14],s[15]=c*i+y*n+I*o+e[15]),s}function nc(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function FC(s,e,t,i){var n=i[0],o=i[1],a=i[2],l=Math.hypot(n,o,a),u,c,h,d,p,y,x,A,T,I,B,w,M,F,z,se,pe,de,Ae,$e,ge,me,J,bn;return l<No?null:(l=1/l,n*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],p=e[1],y=e[2],x=e[3],A=e[4],T=e[5],I=e[6],B=e[7],w=e[8],M=e[9],F=e[10],z=e[11],se=n*n*h+c,pe=o*n*h+a*u,de=a*n*h-o*u,Ae=n*o*h-a*u,$e=o*o*h+c,ge=a*o*h+n*u,me=n*a*h+o*u,J=o*a*h-n*u,bn=a*a*h+c,s[0]=d*se+A*pe+w*de,s[1]=p*se+T*pe+M*de,s[2]=y*se+I*pe+F*de,s[3]=x*se+B*pe+z*de,s[4]=d*Ae+A*$e+w*ge,s[5]=p*Ae+T*$e+M*ge,s[6]=y*Ae+I*$e+F*ge,s[7]=x*Ae+B*$e+z*ge,s[8]=d*me+A*J+w*bn,s[9]=p*me+T*J+M*bn,s[10]=y*me+I*J+F*bn,s[11]=x*me+B*J+z*bn,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function Kd(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],p=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+p*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=p*n-u*i,s}function VC(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],p=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n-c*i,s[1]=a*n-h*i,s[2]=l*n-d*i,s[3]=u*n-p*i,s[8]=o*i+c*n,s[9]=a*i+h*n,s[10]=l*i+d*n,s[11]=u*i+p*n,s}function Jd(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],p=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+p*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=p*n-u*i,s}function kC(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,p=n*a,y=n*l,x=n*u,A=o*a,T=o*l,I=o*u;return s[0]=1-d-x,s[1]=h+I,s[2]=p-T,s[3]=0,s[4]=h-I,s[5]=1-c-x,s[6]=y+A,s[7]=0,s[8]=p+T,s[9]=y-A,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function UC(s,e,t,i,n,o,a){var l=1/(t-e),u=1/(n-i),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(n+i)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function Mb(s,e,t,i,n){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,n!=null&&n!==1/0?(a=1/(i-n),s[10]=(n+i)*a,s[14]=2*n*i*a):(s[10]=-1,s[14]=-2*i),s}function zC(s,e,t,i,n,o,a){var l=1/(e-t),u=1/(i-n),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+i)*u,s[14]=(a+o)*c,s[15]=1,s}function HC(s,e,t,i){var n,o,a,l,u,c,h,d,p,y,x=e[0],A=e[1],T=e[2],I=i[0],B=i[1],w=i[2],M=t[0],F=t[1],z=t[2];return Math.abs(x-M)<No&&Math.abs(A-F)<No&&Math.abs(T-z)<No?bM(s):(h=x-M,d=A-F,p=T-z,y=1/Math.hypot(h,d,p),h*=y,d*=y,p*=y,n=B*p-w*d,o=w*h-I*p,a=I*d-B*h,y=Math.hypot(n,o,a),y?(y=1/y,n*=y,o*=y,a*=y):(n=0,o=0,a=0),l=d*a-p*o,u=p*n-h*a,c=h*o-d*n,y=Math.hypot(l,u,c),y?(y=1/y,l*=y,u*=y,c*=y):(l=0,u=0,c=0),s[0]=n,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=p,s[11]=0,s[12]=-(n*x+o*A+a*T),s[13]=-(l*x+u*A+c*T),s[14]=-(h*x+d*A+p*T),s[15]=1,s)}function PM(){var s=new cn(4);return cn!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function jC(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function ef(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}var rfe=function(){var s=PM();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var XC=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),yM=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),SM=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),gl={},Mr=class extends Zd{static get IDENTITY(){return gl.IDENTITY=gl.IDENTITY||Object.freeze(new Mr(XC)),gl.IDENTITY}static get ZERO(){return gl.ZERO=gl.ZERO||Object.freeze(new Mr(yM)),gl.ZERO}get INDICES(){return SM}get ELEMENTS(){return 16}get RANK(){return 4}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,o,a,l,u,c,h,d,p,y,x,A,T){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=p,this[12]=y,this[13]=x,this[14]=A,this[15]=T,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c,h,d,p,y,x,A,T){return this[0]=e,this[1]=o,this[2]=c,this[3]=y,this[4]=t,this[5]=a,this[6]=h,this[7]=x,this[8]=i,this[9]=l,this[10]=d,this[11]=A,this[12]=n,this[13]=u,this[14]=p,this[15]=T,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(XC)}fromQuaternion(e){return kC(this,e),this.check()}frustum({left:e,right:t,bottom:i,top:n,near:o,far:a}){return a===1/0?Mr._computeInfinitePerspectiveOffCenter(this,e,t,i,n,o):UC(this,e,t,i,n,o,a),this.check()}static _computeInfinitePerspectiveOffCenter(e,t,i,n,o,a){let l=2*a/(i-t),u=2*a/(o-n),c=(i+t)/(i-t),h=(o+n)/(o-n),d=-1,p=-1,y=-2*a;return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=c,e[9]=h,e[10]=d,e[11]=p,e[12]=0,e[13]=0,e[14]=y,e[15]=0,e}lookAt(e,t,i){return arguments.length===1&&({eye:e,center:t,up:i}=e),t=t||[0,0,0],i=i||[0,1,0],HC(this,e,t,i),this.check()}ortho({left:e,right:t,bottom:i,top:n,near:o=.1,far:a=500}){return zC(this,e,t,i,n,o,a),this.check()}orthographic({fovy:e=45*Math.PI/180,aspect:t=1,focalDistance:i=1,near:n=.1,far:o=500}){if(e>Math.PI*2)throw Error("radians");let a=e/2,l=i*Math.tan(a),u=l*t;return new Mr().ortho({left:-u,right:u,bottom:-l,top:l,near:n,far:o})}perspective({fovy:e=void 0,fov:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:o=500}={}){if(e=e||t,e>Math.PI*2)throw Error("radians");return Mb(this,e,i,n,o),this.check()}determinant(){return _C(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e=[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=null){let i=this.getScale(t||[-0,-0,-0]),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e=[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=null){let i=this.getScale(t||[-0,-0,-0]),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*n,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*n,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return DC(this,this),this.check()}invert(){return GC(this,this),this.check()}multiplyLeft(e){return Bb(this,e,this),this.check()}multiplyRight(e){return Bb(this,this,e),this.check()}rotateX(e){return Kd(this,this,e),this.check()}rotateY(e){return VC(this,this,e),this.check()}rotateZ(e){return Jd(this,this,e),this.check()}rotateXYZ([e,t,i]){return this.rotateX(e).rotateY(t).rotateZ(i)}rotateAxis(e,t){return FC(this,this,e,t),this.check()}scale(e){return Array.isArray(e)?nc(this,this,e):nc(this,this,[e,e,e]),this.check()}translate(e){return ic(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ef(t||[-0,-0,-0,-0],e,this),Wd(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:i}=e;switch(i){case 2:t=CC(t||[-0,-0],e,this);break;case 3:t=Qd(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Wd(t,e.length),t}transformAsVector(e,t){switch(e.length){case 2:t=AC(t||[-0,-0],e,this);break;case 3:t=$d(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Wd(t,e.length),t}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}transformPoint(e,t){return jd("Matrix4.transformPoint","3.0"),this.transformAsPoint(e,t)}transformVector(e,t){return jd("Matrix4.transformVector","3.0"),this.transformAsPoint(e,t)}transformDirection(e,t){return jd("Matrix4.transformDirection","3.0"),this.transformAsVector(e,t)}};var Nb={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global},EM=Nb.global||Nb.self||Nb.window;EM.mathgl={config:Ye};var xM=new Uint8Array([0,255,255,255]),CM={pickingSelectedColor:null,pickingHighlightColor:xM,pickingActive:!1,pickingAttribute:!1};function AM(s=CM){let e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,i=>i/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var vM=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,TM=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,pl={name:"picking",vs:vM,fs:TM,getUniforms:AM};var IM=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,Db={name:"transform",vs:IM,fs:null};var qs=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new qs(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(e={}){let{vs:t="",fs:i="",defines:n={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(i),p=c.map(w=>this._getHash(w.name)).sort(),y=a.map(w=>this._getHash(w)),x=Object.keys(n).sort(),A=Object.keys(o).sort(),T=[],I=[];for(let w of x)T.push(this._getHash(w)),T.push(this._getHash(n[w]));for(let w of A)I.push(this._getHash(w)),I.push(this._getHash(o[w]));let B=`${h}/${d}D${T.join("/")}M${p.join("/")}I${I.join("/")}V${y.join("/")}H${this.stateHash}B${l}${u?"T":""}`;if(!this._programCache[B]){let w=Ab(this.gl,{vs:t,fs:i,modules:c,inject:o,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[B]=new Oo(this.gl,{hash:B,vs:w.vs,fs:w.fs,varyings:a,bufferMode:l}),this._getUniforms[B]=w.getUniforms||(M=>{}),this._useCounts[B]=0}return this._useCounts[B]++,this._programCache[B]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(e=[]){let t=new Array(this._defaultModules.length+e.length),i={},n=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[n++]=l,i[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;i[u]||(t[n++]=l,i[u]=!0)}return t.length=n,t}};var wM={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function YC(s,e,t){let i={},n=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=LM(o,t);if(o==="indices")n=a;else if(a.constant)i[l]=a.value;else{let u=a.value,c={...a};delete c.value,i[l]=[new oe(s,u),c],RM(o,c)}}if(n){let o=n.value||n;H(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:n.isIndexed===void 0?!0:n.isIndexed};i.indices=[new oe(s,{data:o,target:34963}),a]}return i}function LM(s,e){let{attributeMap:t=wM}=e||{};return t&&t[s]||s}function RM(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}H(Number.isFinite(e.size),`attribute ${s} needs size`)}var ml=2,OM=1e4,BM="Model needs drawMode and vertexCount",$C=()=>{},MM={},Nr=class{constructor(e,t={}){let{id:i=vr("model")}=t;H(Gs(e)),this.id=i,this.gl=e,this.id=t.id||vr("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||qs.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},H(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),BM)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return H(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return H(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=YC(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(e={}){if(ln(e))return this;let t={};for(let i in e){let n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(e={}){return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return al(this.program.gl,e),this}draw(e={}){this._checkProgram();let{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(n);let c;X.priority>=ml&&(c=this._logDrawCallStart(ml));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:p=h.indexType,indexOffset:y=h.indexOffset,vertexArrayInstanced:x=h.isInstanced}=this.props;x&&!this.isInstanced&&X.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:A,instanceCount:T}=this,{onBeforeRender:I=$C,onAfterRender:B=$C}=this.props;I(),this.program.setUniforms(this.uniforms);let w=this.program.draw(Object.assign(MM,e,{logPriority:c,uniforms:null,framebuffer:i,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:p,isInstanced:A,instanceCount:T,offset:d?y:0}));return B(),X.priority>=ml&&this._logDrawCallEnd(c,u,i),w}transform(e={}){let{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e,{parameters:o}=e;i&&this._setFeedbackBuffers(i),t&&(o=Object.assign({},o,{[35977]:t})),n.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{n.forEach(a=>a.vertexArray.bindBuffers())}return this}render(e={}){return X.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}H(t instanceof Oo,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Zu(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof oe&&t.delete()}}_setAnimationProps(e){this.animated&&H(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(e={}){if(ln(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new Bo(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:OM;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),X.group(ml,`>>> DRAWING MODEL ${this.id}`,{collapsed:X.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(e===void 0)return;let o=fb({vertexArray:t,header:`${this.id} attributes`,attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=Fd({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:c,count:h}=Fd({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});h>0&&X.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&X.log("UNUSED UNIFORMS",Object.keys(l))();let d=gb(this.vertexArray.configuration);X.table(e,o)(),X.table(e,a)(),X.table(e+1,d)(),n&&n.log({logLevel:ml,message:`Rendered to ${n.id}`}),X.groupEnd(ml,`>>> DRAWING MODEL ${this.id}`)()}};var tf=class{constructor(e,t={}){this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(e={}){let{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(e={}){let t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof oe?i:i.buffer:null}getData(e={}){let{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(e={}){this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&H(K(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let n in this.feedbackMap){let o=this.feedbackMap[n];n in t&&(i[o]=n)}Object.assign(i,e.feedbackBuffers);for(let n in i){let o=i[n];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;i[n]=this._createNewBuffer(n,{byteLength:l,usage:u,accessor:c})}}return i}_setupBuffers(e={}){let{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,{model:t}){let{program:i}=t;e.transformFeedback=new Bo(this.gl,{program:i,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:i})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(let n in this.feedbackMap){let o=this.feedbackMap[n];t[n]=e.feedbackBuffers[o],i[o]=e.sourceBuffers[n],H(i[o]instanceof oe)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){let i=new oe(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}};var NM="transform_uSampler_",rf="transform_uSize_",QC="transform_position";function ZC({vs:s,sourceTextureMap:e,targetTextureVarying:t,targetTexture:i}){let o=Object.keys(e).length,a=null,l={},u=s,c={};if(o>0||t){let h=u.split(`
`),d=h.slice();if(h.forEach((p,y,x)=>{if(o>0){let A=FM(p,e);if(A){let{updatedLine:T,inject:I}=A;d[y]=T,c=hl([c,I]),Object.assign(l,A.samplerTextureMap),o--}}t&&!a&&(a=_M(p,t))}),t){H(i);let p=`${rf}${t}`,y=`uniform vec2 ${p};
`,x=`     vec2 ${QC} = transform_getPos(${p});
     gl_Position = vec4(${QC}, 0, 1.);
`;c=hl([c,{"vs:#decl":y,"vs:#main-start":x}])}u=d.join(`
`)}return{vs:u,targetTextureType:a,inject:c,samplerTextureMap:l}}function KC({sourceTextureMap:s,targetTextureVarying:e,targetTexture:t}){let i={},n,o;e&&({width:n,height:o}=t,i[`${rf}${e}`]=[n,o]);for(let a in s)({width:n,height:o}=s[a]),i[`${rf}${a}`]=[n,o];return i}function DM(s){return Ud(s,["attribute","in"])}function GM(s){let e=`${NM}${s}`,t=`${rf}${s}`,i=`  uniform sampler2D ${e};
  uniform vec2 ${t};`;return{samplerName:e,sizeName:t,uniformDeclerations:i}}function _M(s,e){let t=Ud(s,["varying","out"]);return t&&t.name===e?t.type:null}function FM(s,e){let t={},i=DM(s);if(!i)return null;let{type:n,name:o}=i;if(o&&e[o]){let a=`// ${s} => Replaced by Transform with a sampler`,{samplerName:l,sizeName:u,uniformDeclerations:c}=GM(o),h=vb(n),d=`  ${n} ${o} = transform_getInput(${l}, ${u}).${h};
`;return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var VM={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},kM="transform_output",nf=class{constructor(e,t={}){this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(e={}){let t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(e={}){let{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let p=this.samplerTextureMap[d];l[d]=i[p]}this._setSourceTextureParameters();let h=KC({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,n.width,n.height]),{attributes:a,framebuffer:n,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData({packed:e=!1}={}){let{framebuffer:t}=this.bindings[this.currentIndex],i=zs(t);if(!e)return i;let n=i.constructor,o=Tb(this.targetTextureType),a=new n(i.length*o/4),l=0;for(let u=0;u<i.length;u+=4)for(let c=0;c<o;c++)a[l++]=i[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(e={}){let{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Ct)return i;let n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(e={}){let{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,o=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((i,n,o)=>{o[n]=n}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new oe(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:i})}}_updateBinding(e,t){let{sourceBuffers:i,sourceTextures:n,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new ht(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let i in t)t[i].setParameters(VM)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let i=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:i}}_createNewTexture(e){let t=ll(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(e={}){let{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=ZC({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),c=hl([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||rc({version:ul(n),input:this.targetTextureVarying,inputType:a,output:kM}),d=this.hasSourceTextures||this.targetTextureVarying?[Db].concat(e.modules||[]):e.modules;return{vs:n,fs:h,modules:d,uniforms:o,inject:c}}};var hn=class{static isSupported(e){return K(e)}constructor(e,t={}){this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(e={}){let{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)e=e||i.swap();H(e,"Nothing to swap")}getBuffer(e=null){return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(e={}){let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t){let n=i.getData(e);if(n)return n}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(e={}){"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)i.update(e)}_initialize(e={}){let{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new Nr(t,Object.assign({},e,{fs:e.fs||rc({version:ul(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=n.updateModelProps(t);return t}_buildResourceTransforms(e,t){UM(t)&&(this.bufferTransform=new tf(e,t)),zM(t)&&(this.textureTransform=new nf(e,t)),H(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=Object.assign(t,n.getDrawOptions(t));return t}};function UM(s){return!!(!ln(s.feedbackBuffers)||!ln(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function zM(s){return!!(!ln(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var JC={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ui=class{static get DRAW_MODE(){return JC}constructor(e={}){let{id:t=vr("geometry"),drawMode:i=JC.TRIANGLES,attributes:n={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(n,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let i in e){let n=e[i];n=ArrayBuffer.isView(n)?{value:n}:n,H(ArrayBuffer.isView(n.value),`${this._print(i)}: must be typed array or object with value as typed array`),(i==="POSITION"||i==="positions")&&!n.size&&(n.size=3),i==="indices"?(H(!this.indices),this.indices=n):this.attributes[i]=n}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let n in e){let o=e[n],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(i=Math.min(i,a.length/l))}return H(Number.isFinite(i)),i}};var e1="#define SMOOTH_EDGE_RADIUS 0.5",jM=`
`.concat(e1,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),qM=`
`.concat(e1,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),t1={name:"geometry",vs:jM,fs:qM};var Ce={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Ce,"IDENTITY",{get:()=>xe.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")()||0});var ci={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},hi={common:0,meters:1,pixels:2};var Gb={DRAW:"draw",MASK:"mask"};var XM=Object.keys(Ce).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Ce[s],";")).join(""),YM=Object.keys(ci).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(ci[s],";")).join(""),$M=Object.keys(hi).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(hi[s],";")).join(""),r1="".concat(XM,`
`).concat(YM,`
`).concat($M,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {
    
    if (geometry.position.w == 0.0) {
      float y = clamp(geometry.worldPosition.y, -89.9, 89.9);
      return 1.0 / cos(radians(y));
    }
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}
vec3 project_normal(vec3 vector) {
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size(position_world.z),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world.xyz -= project_uCoordinateOrigin;
  }
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);var Un=typeof Float32Array<"u"?Float32Array:Array;var Hge=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function Fb(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],p=e[10],y=e[11],x=e[12],A=e[13],T=e[14],I=e[15],B=t*l-i*a,w=t*u-n*a,M=t*c-o*a,F=i*u-n*l,z=i*c-o*l,se=n*c-o*u,pe=h*A-d*x,de=h*T-p*x,Ae=h*I-y*x,$e=d*T-p*A,ge=d*I-y*A,me=p*I-y*T,J=B*me-w*ge+M*$e+F*Ae-z*de+se*pe;return J?(J=1/J,s[0]=(l*me-u*ge+c*$e)*J,s[1]=(n*ge-i*me-o*$e)*J,s[2]=(A*se-T*z+I*F)*J,s[3]=(p*z-d*se-y*F)*J,s[4]=(u*Ae-a*me-c*de)*J,s[5]=(t*me-n*Ae+o*de)*J,s[6]=(T*M-x*se-I*w)*J,s[7]=(h*se-p*M+y*w)*J,s[8]=(a*ge-l*Ae+c*pe)*J,s[9]=(i*Ae-t*ge-o*pe)*J,s[10]=(x*z-A*M+I*B)*J,s[11]=(d*M-h*z-y*B)*J,s[12]=(l*de-a*$e-u*pe)*J,s[13]=(t*$e-i*de+n*pe)*J,s[14]=(A*w-x*F-T*B)*J,s[15]=(h*F-d*w+p*B)*J,s):null}function Xs(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],p=e[9],y=e[10],x=e[11],A=e[12],T=e[13],I=e[14],B=e[15],w=t[0],M=t[1],F=t[2],z=t[3];return s[0]=w*i+M*l+F*d+z*A,s[1]=w*n+M*u+F*p+z*T,s[2]=w*o+M*c+F*y+z*I,s[3]=w*a+M*h+F*x+z*B,w=t[4],M=t[5],F=t[6],z=t[7],s[4]=w*i+M*l+F*d+z*A,s[5]=w*n+M*u+F*p+z*T,s[6]=w*o+M*c+F*y+z*I,s[7]=w*a+M*h+F*x+z*B,w=t[8],M=t[9],F=t[10],z=t[11],s[8]=w*i+M*l+F*d+z*A,s[9]=w*n+M*u+F*p+z*T,s[10]=w*o+M*c+F*y+z*I,s[11]=w*a+M*h+F*x+z*B,w=t[12],M=t[13],F=t[14],z=t[15],s[12]=w*i+M*l+F*d+z*A,s[13]=w*n+M*u+F*p+z*T,s[14]=w*o+M*c+F*y+z*I,s[15]=w*a+M*h+F*x+z*B,s}function i1(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,p,y,x,A,T,I;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],p=e[6],y=e[7],x=e[8],A=e[9],T=e[10],I=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=p,s[7]=y,s[8]=x,s[9]=A,s[10]=T,s[11]=I,s[12]=a*i+h*n+x*o+e[12],s[13]=l*i+d*n+A*o+e[13],s[14]=u*i+p*n+T*o+e[14],s[15]=c*i+y*n+I*o+e[15]),s}function n1(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function QM(){var s=new Un(4);return Un!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function oc(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}var Wge=function(){var s=QM();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();function ZM(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}return!1}function sc(s){let e={},t;return i=>{for(let n in i)if(!ZM(i[n],e[n])){t=s(i),e=i;break}return t}}var u1=[0,0,0,0],KM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],JM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],eN=[0,0,0],tN=[0,0,0],rN=sc(nN);function Vb(s,e,t=tN){t.length<3&&(t=[t[0],t[1],0]);let i=t,n,o=!0;switch(e===Ce.LNGLAT_OFFSETS||e===Ce.METER_OFFSETS?n=t:n=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case ci.WEB_MERCATOR:(e===Ce.LNGLAT||e===Ce.CARTESIAN)&&(n=[0,0,0],o=!1);break;case ci.WEB_MERCATOR_AUTO_OFFSET:e===Ce.LNGLAT?i=n:e===Ce.CARTESIAN&&(i=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],n=s.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case ci.IDENTITY:i=s.position.map(Math.fround),i[2]=i[2]||0;break;case ci.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:i,offsetMode:o}}function iN(s,e,t){let{viewMatrixUncentered:i,projectionMatrix:n}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=u1,u=u1,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:p}=Vb(s,e,t);return p&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=oc([],u,a),o=i||o,a=Xs([],n,o),a=Xs([],a,KM)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function c1({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Ce.DEFAULT,coordinateOrigin:n,autoWrapLongitude:o=!1}={}){i===Ce.DEFAULT&&(i=s.isGeospatial?Ce.LNGLAT:Ce.CARTESIAN);let a=rN({viewport:s,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||JM,a}function nN({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){let{projectionCenter:n,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=iN(s,t,i),h=s.getDistanceScales(),d=[s.width*e,s.height*e],p=oc([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,y={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:n,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:p,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:eN,project_uScale:s.scale,project_uViewProjectionMatrix:o,project_uCameraPosition:l};if(c){let x=s.getDistanceScales(c);switch(t){case Ce.METER_OFFSETS:y.project_uCommonUnitsPerWorldUnit=x.unitsPerMeter,y.project_uCommonUnitsPerWorldUnit2=x.unitsPerMeter2;break;case Ce.LNGLAT:case Ce.LNGLAT_OFFSETS:s._pseudoMeters||(y.project_uCommonUnitsPerMeter=x.unitsPerMeter),y.project_uCommonUnitsPerWorldUnit=x.unitsPerDegree,y.project_uCommonUnitsPerWorldUnit2=x.unitsPerDegree2;break;case Ce.CARTESIAN:y.project_uCommonUnitsPerWorldUnit=[1,1,x.unitsPerMeter[2]],y.project_uCommonUnitsPerWorldUnit2=[0,0,x.unitsPerMeter2[2]];break;default:break}}return y}var oN={};function sN(s=oN){return s.viewport?c1(s):{}}var kb={name:"project",dependencies:[zd,t1],vs:r1,getUniforms:sN};var aN=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,dn={name:"project32",dependencies:[kb],vs:aN};function Ub(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Do(s,e){let t=ef([],e,s);return jC(t,t,1/t[3]),t}function zb(s,e,t){return s<e?e:s>t?t:s}function lN(s){return Math.log(s)*Math.LOG2E}var ac=Math.log2||lN;function di(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var Ii=Math.PI,h1=Ii/4,wi=Ii/180,Hb=180/Ii,lc=512,Wb=4003e4,bl=85.051129,d1=1.5;function jb(s){return ac(s)}function zn([s,e]){di(Number.isFinite(s)),di(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");let t=s*wi,i=e*wi,n=lc*(t+Ii)/(2*Ii),o=lc*(Ii+Math.log(Math.tan(h1+i*.5)))/(2*Ii);return[n,o]}function Li([s,e]){let t=s/lc*(2*Ii)-Ii,i=2*(Math.atan(Math.exp(e/lc*(2*Ii)-Ii))-h1);return[t*Hb,i*Hb]}function qb({latitude:s}){di(Number.isFinite(s));let e=Math.cos(s*wi);return jb(Wb*e)-9}function Pl({latitude:s,longitude:e,highPrecision:t=!1}){di(Number.isFinite(s)&&Number.isFinite(e));let i={},n=lc,o=Math.cos(s*wi),a=n/360,l=a/o,u=n/Wb/o;if(i.unitsPerMeter=[u,u,u],i.metersPerUnit=[1/u,1/u,1/u],i.unitsPerDegree=[a,l,u],i.degreesPerUnit=[1/a,1/l,1/u],t){let c=wi*Math.tan(s*wi)/o,h=a*c/2,d=n/Wb*c,p=d/l*u;i.unitsPerDegree2=[0,h,d],i.unitsPerMeter2=[p,0,p]}return i}function uc(s,e){let[t,i,n]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Pl({longitude:t,latitude:i,highPrecision:!0}),h=zn(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=Li(h),p=(n||0)+(l||0);return Number.isFinite(n)||Number.isFinite(l)?[d[0],d[1],p]:d}function of({height:s,pitch:e,bearing:t,altitude:i,scale:n,center:o=null}){let a=Ub();return ic(a,a,[0,0,-i]),Kd(a,a,-e*wi),Jd(a,a,t*wi),n/=s,nc(a,a,[n,n,n]),o&&ic(a,a,TC([],o)),a}function Xb({width:s,height:e,fovy:t=Ys(d1),altitude:i,pitch:n=0,nearZMultiplier:o=1,farZMultiplier:a=1}){i!==void 0&&(t=Ys(i));let l=.5*t*wi,u=cc(t),c=n*wi,h=Math.sin(l)*u/Math.sin(Math.min(Math.max(Math.PI/2-c-l,.01),Math.PI-.01)),d=Math.sin(c)*h+u;return{fov:2*l,aspect:s/e,focalDistance:u,near:o,far:d*a}}function Ys(s){return 2*Math.atan(.5/s)*Hb}function cc(s){return .5/Math.tan(.5*s*wi)}function yl(s,e){let[t,i,n=0]=s;return di(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(n)),Do(e,[t,i,n,1])}function Sl(s,e,t=0){let[i,n,o]=s;if(di(Number.isFinite(i)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(o))return Do(e,[i,n,o,1]);let a=Do(e,[i,n,0,1]),l=Do(e,[i,n,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return Yd([],a,l,h)}function hc({width:s,height:e,bounds:t,minExtent:i=0,maxZoom:n=24,padding:o=0,offset:a=[0,0]}){let[[l,u],[c,h]]=t;if(Number.isFinite(o)){let z=o;o={top:z,bottom:z,left:z,right:z}}else di(Number.isFinite(o.top)&&Number.isFinite(o.bottom)&&Number.isFinite(o.left)&&Number.isFinite(o.right));let d=zn([l,zb(h,-bl,bl)]),p=zn([c,zb(u,-bl,bl)]),y=[Math.max(Math.abs(p[0]-d[0]),i),Math.max(Math.abs(p[1]-d[1]),i)],x=[s-o.left-o.right-Math.abs(a[0])*2,e-o.top-o.bottom-Math.abs(a[1])*2];di(x[0]>0&&x[1]>0);let A=x[0]/y[0],T=x[1]/y[1],I=(o.right-o.left)/2/A,B=(o.bottom-o.top)/2/T,w=[(p[0]+d[0])/2+I,(p[1]+d[1])/2+B],M=Li(w),F=Math.min(n,ac(Math.abs(Math.min(A,T))));return di(Number.isFinite(F)),{longitude:M[0],latitude:M[1],zoom:F}}var f1=Math.PI/180;function dc(s,e=0){let{width:t,height:i,unproject:n}=s,o={targetZ:e},a=n([0,i],o),l=n([t,i],o),u,c,h=s.fovy?.5*s.fovy*f1:Math.atan(.5/s.altitude),d=(90-s.pitch)*f1;return h>d-.01?(u=g1(s,0,e),c=g1(s,t,e)):(u=n([0,0],o),c=n([t,0],o)),[a,l,c,u]}function g1(s,e,t){let{pixelUnprojectionMatrix:i}=s,n=Do(i,[e,0,1,1]),o=Do(i,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-n[2])/(o[2]-n[2]),u=Yd([],n,o,l),c=Li(u);return c[2]=t,c}var Go={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...pl};var m1=class{constructor(e){this._pool=[],this.props={overAlloc:2,poolSize:100},this.setProps(e)}setProps(e){Object.assign(this.props,e)}allocate(e,t,{size:i=1,type:n,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=n||e&&e.constructor||Float32Array,h=t*i+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d;u&&(d=u*i+o);let p=this._allocate(c,h,l,d);return e&&a?p.set(e):l||p.fill(0,0,4),this._release(e),p}release(e){this._release(e)}_allocate(e,t,i,n){let o=Math.max(Math.ceil(t*this.props.overAlloc),1);o>n&&(o=n);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return i&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:n}=i,o=t.findIndex(a=>a.byteLength>=n);o<0?t.push(i):(o>0||t.length<this.props.poolSize)&&t.splice(o,0,i),t.length>this.props.poolSize&&t.shift()}},Hn=new m1;function xl(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function P1(s){return[s[12],s[13],s[14]]}function y1(s){return{left:El(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:El(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:El(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:El(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:El(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:El(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var b1=new Br;function El(s,e,t,i){b1.set(s,e,t);let n=b1.len();return{distance:i/n,normal:new Br(-s/n,-e/n,-t/n)}}function hN(s){return s-Math.fround(s)}var fc;function sf(s,e){let{size:t=1,startIndex:i=0}=e,n=e.endIndex!==void 0?e.endIndex:s.length,o=(n-i)/t;fc=Hn.allocate(fc,o,{type:Float32Array,size:t*2});let a=i,l=0;for(;a<n;){for(let u=0;u<t;u++){let c=s[a++];fc[l+u]=c,fc[l+u+t]=hN(c)}l+=t*2}return fc.subarray(0,o*t*2)}var dN=Math.PI/180,fN=xl(),Yb=[0,0,0],gN=0,pN={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]},$s=class{constructor(e={}){let{id:t=null,x:i=0,y:n=0,width:o=1,height:a=1}=e;this.id=t||this.constructor.displayName||"viewport",this.x=i,this.y=n,this.width=o||1,this.height=a||1,this._frustumPlanes={},this._initViewMatrix(e),this._initProjectionMatrix(e),this._initPixelMatrices(),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?ci.WEB_MERCATOR:ci.WEB_MERCATOR_AUTO_OFFSET:ci.IDENTITY}equals(e){return e instanceof $s?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&js(e.projectionMatrix,this.projectionMatrix)&&js(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let i=this.projectPosition(e),n=yl(i,this.pixelProjectionMatrix),[o,a]=n,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,n[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,u=i&&i*this.distanceScales.unitsPerMeter[2],c=Sl([n,l,a],this.pixelUnprojectionMatrix,u),[h,d,p]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,p]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i]=this.projectFlat(e),n=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,n]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e),n=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,n]}projectFlat(e){if(this.isGeospatial){let t=zn(e);return t[1]=wb(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?Li(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],o[0],a[0]),Math.min(i[1],n[1],o[1],a[1]),Math.max(i[0],n[0],o[0],a[0]),Math.max(i[1],n[1],o[1],a[1])]}getDistanceScales(e=null){return e?Pl({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,y1(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}getCameraPosition(){return this.cameraPosition}getCameraDirection(){return this.cameraDirection}getCameraUp(){return this.cameraUp}_createProjectionMatrix({orthographic:e,fovyRadians:t,aspect:i,focalDistance:n,near:o,far:a}){return e?new Mr().orthographic({fovy:t,aspect:i,focalDistance:n,near:o,far:a}):new Mr().perspective({fovy:t,aspect:i,near:o,far:a})}_initViewMatrix(e){let{viewMatrix:t=fN,longitude:i=null,latitude:n=null,zoom:o=null,position:a=null,modelMatrix:l=null,focalDistance:u=1,distanceScales:c=null}=e;this.isGeospatial=Number.isFinite(n)&&Number.isFinite(i),this.zoom=o,Number.isFinite(this.zoom)||(this.zoom=this.isGeospatial?qb({latitude:n})+Math.log2(u):gN);let h=Math.pow(2,this.zoom);this.scale=h,this.distanceScales=this.isGeospatial?Pl({latitude:n,longitude:i}):c||pN,this.focalDistance=u,this.distanceScales.metersPerUnit=new Br(this.distanceScales.metersPerUnit),this.distanceScales.unitsPerMeter=new Br(this.distanceScales.unitsPerMeter),this.position=Yb,this.meterOffset=Yb,a&&(this.position=a,this.modelMatrix=l,this.meterOffset=l?l.transformVector(a):a),this.isGeospatial?(this.longitude=i,this.latitude=n,this.center=this._getCenterInWorld({longitude:i,latitude:n})):this.center=a?this.projectPosition(a):[0,0,0],this.viewMatrixUncentered=t,this.viewMatrix=new Mr().multiplyRight(this.viewMatrixUncentered).translate(new Br(this.center||Yb).negate())}_getCenterInWorld({longitude:e,latitude:t}){let{meterOffset:i,distanceScales:n}=this,o=new Br(this.projectPosition([e,t,0]));if(i){let a=new Br(i).scale(n.unitsPerMeter);o.add(a)}return o}_initProjectionMatrix(e){let{projectionMatrix:t=null,orthographic:i=!1,fovyRadians:n,fovy:o=75,near:a=.1,far:l=1e3,focalDistance:u=1}=e;this.projectionMatrix=t||this._createProjectionMatrix({orthographic:i,fovyRadians:n||o*dN,aspect:this.width/this.height,focalDistance:u,near:a,far:l})}_initPixelMatrices(){let e=xl();Xs(e,e,this.projectionMatrix),Xs(e,e,this.viewMatrix),this.viewProjectionMatrix=e,this.viewMatrixInverse=Fb([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=P1(this.viewMatrixInverse);let t=xl(),i=xl();n1(t,t,[this.width/2,-this.height/2,1]),i1(t,t,[1,-1,0]),Xs(i,t,this.viewProjectionMatrix),this.pixelProjectionMatrix=i,this.viewportMatrix=t,this.pixelUnprojectionMatrix=Fb(xl(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||xe.warn("Pixel project matrix not invertible")()}};$s.displayName="Viewport";function mN(){var s=new Un(2);return Un!=Float32Array&&(s[0]=0,s[1]=0),s}function $b(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function S1(s,e){return s[0]=-e[0],s[1]=-e[1],s}var tme=function(){var s=mN();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();var PN=512,yN=4003e4,SN=Math.PI/180;function E1(s){let e=Math.cos(s*SN);return PN/yN/e}var _o=class extends $s{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=11,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:p=0,legacyMeterSizes:y=!1}=e,{width:x,height:A,altitude:T=1.5}=e,I=Math.pow(2,n);x=x||1,A=A||1;let B,w=null;h?(T=h[5]/2,B=Ys(T)):(e.fovy?(B=e.fovy,T=cc(B)):B=Ys(T),w=Xb({width:x,height:A,pitch:o,fovy:B,nearZMultiplier:l,farZMultiplier:u}));let M=of({height:A,pitch:o,bearing:a,scale:I,altitude:T});p&&(M=new Mr().translate([512*p,0,0]).multiplyLeft(M));super({...e,width:x,height:A,viewMatrix:M,longitude:i,latitude:t,zoom:n,...w,fovy:B,focalDistance:T});this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=o,this.bearing=a,this.altitude=T,this.fovy=B,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=y,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let n=t;n<=i;n++){let o=n?new _o({...this,worldOffset:n}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e),n=(e[2]||0)*E1(e[1]);return[t,i,n]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),n=(e[2]||0)/E1(i);return[t,i,n]}addMetersToLngLat(e,t){return uc(e,t)}panByPosition(e,t){let i=Sl(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=$b([],n,S1([],i)),a=$b([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=dc(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:n}=this,{longitude:o,latitude:a,zoom:l}=hc({width:i,height:n,bounds:e,...t});return new _o({width:i,height:n,longitude:o,latitude:a,zoom:l})}};_o.displayName="WebMercatorViewport";function EN(){var s=new Un(3);return Un!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function xN(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}var x1=xN;var sme=function(){var s=EN();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();function Qb(s,e,t=!1){let i=e.projectPosition(s);if(t&&e instanceof _o){let[n,o,a=0]=s,l=e.getDistanceScales([n,o]);i[2]=a*l.unitsPerMeter[2]}return i}function AN(s){let e={...s},{coordinateSystem:t}=s,{viewport:i,coordinateOrigin:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return t===Ce.DEFAULT&&(t=i.isGeospatial?Ce.LNGLAT:Ce.CARTESIAN),o===void 0&&(e.fromCoordinateSystem=t),a===void 0&&(e.fromCoordinateOrigin=n),e.coordinateSystem=t,e}function Zb(s,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:n,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=oc([],[a,l,u,1],t)),i){case Ce.LNGLAT:return Qb([a,l,u],e,o);case Ce.LNGLAT_OFFSETS:return Qb([a+n[0],l+n[1],u+(n[2]||0)],e,o);case Ce.METER_OFFSETS:return Qb(uc(n,[a,l,u]),e,o);case Ce.CARTESIAN:default:return e.isGeospatial?[a+n[0],l+n[1],u+n[2]]:e.projectPosition([a,l,u])}}function C1(s,e){let{viewport:t,coordinateSystem:i,coordinateOrigin:n,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=AN(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=Vb(t,i,n),d=Zb(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let p=t.projectPosition(u||c);x1(d,d,p)}return d}var A1={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Cl=Symbol.for("component"),Wn=Symbol.for("asyncPropDefaults"),fn=Symbol.for("asyncPropOriginal"),Ri=Symbol.for("asyncPropResolved");function v1(s,e=()=>!0){return Array.isArray(s)?T1(s,e,[]):e(s)?[s]:[]}function T1(s,e,t){let i=-1;for(;++i<s.length;){let n=s[i];Array.isArray(n)?T1(n,e,t):e(n)&&t.push(n)}return t}function I1({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}function Kb(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let i=s[t],n=e[t];if(!(i===n||Array.isArray(i)&&Array.isArray(n)&&Kb(i,n)))return!1}return!0}function Oi(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}function af(){}var vN={onStart:af,onUpdate:af,onInterrupt:af,onEnd:af},gn=class{constructor(e){this._inProgress=!1,this._handle=null,this.timeline=e,this.settings={}}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings={...vN,...e},this._inProgress=!0,this.settings.onStart(this)}end(){this._inProgress&&(this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd(this))}cancel(){this._inProgress&&(this.settings.onInterrupt(this),this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){let{timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this.timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate(this),this.timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var Al=class{constructor(e,t){this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:i}=this.source,{size:n}=t,o=i;if(i&&i.length!==n){o=new Float32Array(n);let a=t.elementOffset||0;for(let l=0;l<n;++l)o[l]=i[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function w1(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function lf(s){return s.stride||s.size*s.bytesPerElement}function L1(s,e){e.offset&&xe.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=lf(s),i="vertexOffset"in e?e.vertexOffset:s.vertexOffset||0,n=e.elementOffset||0,o=i*t+n*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function TN(s,e){let t=L1(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var uf=class{constructor(e,t){this.gl=e,this.id=t.id,this.size=t.size;let i=t.logicalType||t.type,n=i===5130,{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0),t.defaultValue=o;let a=i;n?a=5126:!a&&t.isIndexed?a=e&&qu(e,Xe.ELEMENT_INDEX_UINT32)?5125:5123:a||(a=5126),t.logicalType=i,t.type=a;let l=w1(i||a||5126);this.shaderAttributes={},this.doublePrecision=n,n&&t.fp64===!1&&(l=Float32Array),t.bytesPerElement=l.BYTES_PER_ELEMENT,this.defaultType=l,this.value=null,this.settings=t,this.state={externalBuffer:null,bufferAccessor:t,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null,this.setData(t)}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new oe(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*lf(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Hn.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let i={},n=this.value instanceof Float64Array,o=TN(this.getAccessor(),t||{});return i[e]=new Al(this,o.high),i["".concat(e,"64Low")]=n?new Al(this,o.low):new Float32Array(this.size),i}if(t){let i=L1(this.getAccessor(),t);return{[e]:new Al(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant){let t=this.value.slice();e=[t,t]}else{let{value:t,numInstances:i,size:n}=this,o=i*n;if(t&&o&&t.length>=o){let a=new Array(n).fill(1/0),l=new Array(n).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<n;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this;ArrayBuffer.isView(e)?e={value:e}:e instanceof oe&&(e={buffer:e});let i={...this.settings,...e};if(t.bufferAccessor=i,t.bounds=null,e.constant){let n=e.value;if(n=this._normalizeValue(n,[],0),this.settings.normalized&&(n=this._normalizeConstant(n)),!(!t.constant||!this._areValuesEqual(n,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=n}else if(e.buffer){let n=e.buffer;t.externalBuffer=n,t.constant=!1,this.value=e.value;let o=e.value instanceof Float64Array;i.type=e.type||n.accessor.type,i.bytesPerElement=n.accessor.BYTES_PER_ELEMENT*(o?2:1),i.stride=lf(i)}else if(e.value){this._checkExternalBuffer(e);let n=e.value;t.externalBuffer=null,t.constant=!1,this.value=n,i.bytesPerElement=n.BYTES_PER_ELEMENT,i.stride=lf(i);let{buffer:o,byteOffset:a}=this;this.doublePrecision&&n instanceof Float64Array&&(n=sf(n,i));let l=n.byteLength+a+i.stride*2;o.byteLength<l&&o.reallocate(l),o.setAccessor(null),o.subData({data:n,offset:a}),i.type=e.type||o.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let{value:t}=this,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?sf(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate({numInstances:e,copy:t=!1}){let{state:i}=this,n=i.allocatedValue,o=Hn.allocate(n,e+1,{size:this.size,type:this.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&n&&a.subData({data:n instanceof Float64Array?sf(n,this):n,offset:l})),i.allocatedValue=o,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!e.constant&&t){let i=this.defaultType,n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&xe.warn("Attribute ".concat(this.id," is normalized"))()}}_normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:n,size:o}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e)return t[i]=n[0],t;switch(o){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let a=o;for(;--a>=0;)t[i+a]=Number.isFinite(e[a])?e[a]:n[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}};var R1=[],O1=[];function jn(s,e=0,t=1/0){let i=R1,n={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?i=s:s.length>0&&(O1.length=s.length,i=O1):i=R1,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),n.index=e-1),{iterable:i,objectInfo:n}}function cf(s){return s&&s[Symbol.asyncIterator]}function hf(s,e){let{size:t,stride:i,offset:n,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=i?i/l:t,c=n?n/l:0,h=Math.floor((s.length-c)/u);return(d,{index:p,target:y})=>{if(!o){let I=p*u+c;for(let B=0;B<t;B++)y[B]=s[I+B];return y}let x=o[p],A=o[p+1]||h,T;if(a){T=new Array(A-x);for(let I=x;I<A;I++){let B=I*u+c;y=new Array(t);for(let w=0;w<t;w++)y[w]=s[B+w];T[I-x]=y}}else if(u===t)T=s.subarray(x*t+c,A*t+c);else{T=new s.constructor((A-x)*t);let I=0;for(let B=x;B<A;B++){let w=B*u+c;for(let M=0;M<t;M++)T[I++]=s[w+M]}}return T}}var B1=[],gc=[[0,1/0]];function M1(s,e){if(s===gc||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],i=s.length,n=0;for(let o=0;o<i;o++){let a=s[o];a[1]<e[0]?(t.push(a),n=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(n,0,e),t}function Jb(s){let{source:e,target:t,start:i=0,size:n,getData:o}=s,a=s.end||t.length,l=e.length,u=a-i;if(l>u){t.set(e.subarray(0,u),i);return}if(t.set(e,i),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<n;d++)t[i+c]=h[d]||0,c++}}function N1({source:s,target:e,size:t,getData:i,sourceStartIndices:n,targetStartIndices:o}){if(!Array.isArray(o))return Jb({source:s,target:e,size:t,getData:i}),e;let a=0,l=0,u=i&&((h,d)=>i(h+l,d)),c=Math.min(n.length,o.length);for(let h=1;h<c;h++){let d=n[h]*t,p=o[h]*t;Jb({source:s.subarray(a,d),target:e,start:l,end:p,size:t,getData:u}),a=d,l=p}return l<e.length&&Jb({source:[],target:e,start:l,size:t,getData:u}),e}var wN={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function df(s,e){return s?(Number.isFinite(s)&&(s={duration:s}),s.type=s.type||"interpolation",{...wN[s.type],...e,...s}):null}function ff(s,e){return e.getBuffer()?[e.getBuffer(),{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function gf(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function pf(s){s.push(s.shift())}function pc(s,e){let{doublePrecision:t,settings:i,value:n,size:o}=s,a=t&&n instanceof Float64Array?2:1;return(i.noAlloc?n.length:e*o)*a}function mf({buffer:s,numInstances:e,attribute:t,fromLength:i,fromStartIndices:n,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=n&&c,d=pc(t,e),p=t.state.constant;if(!h&&i>=d)return;let y=p?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!p){let I=o;o=(B,w)=>t._normalizeConstant(I(B,w))}let x=p?(I,B)=>o(y,B):(I,B)=>o(y.subarray(I,I+l),B),A=s.getData({length:i}),T=new Float32Array(d);N1({source:A,target:T,sourceStartIndices:n,targetStartIndices:c,size:l,getData:x}),s.byteLength<T.byteLength+u&&s.reallocate(T.byteLength+u),s.subData({data:T,offset:u})}var Fo=class extends uf{constructor(e,t={}){super(e,t);let{transition:i=!1,noAlloc:n=!1,update:o=null,accessor:a=null,transform:l=null,startIndices:u=null}=t;Object.assign(this.settings,{transition:i,noAlloc:n,update:o||a&&this._autoUpdater,accessor:a,transform:l}),Object.assign(this.state,{lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:gc,startIndices:u}),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return df(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:i=0,endRow:n=1/0}=t;this.state.updateRanges=M1(this.state.updateRanges,[i,n])}else this.state.updateRanges=gc}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=B1}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}update(e){this.setData(e)}allocate(e){let{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate({numInstances:e,copy:t.updateRanges!==gc}),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(n,this,{data:t,startRow:c,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,p=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:p})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),ArrayBuffer.isView(e)&&(e={value:e}),n.transform||t!==this.startIndices){Oi(ArrayBuffer.isView(e.value),"invalid ".concat(n.accessor));let a=e.size&&e.size!==this.size;return i.binaryAccessor=hf(e.value,{size:e.size||this.size,stride:e.stride,offset:e.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:p,transform:y}=l,x=u.binaryAccessor||(typeof p=="function"?p:o[p]);Oi(typeof x=="function",'accessor "'.concat(p,'" is not a function'));let A=e.getVertexOffset(i),{iterable:T,objectInfo:I}=jn(t,i,n);for(let B of T){I.index++;let w=x(B,I);if(y&&(w=y.call(this,w)),d){let M=(I.index<d.length-1?d[I.index+1]:a)-d[I.index];if(w&&Array.isArray(w[0])){let F=A;for(let z of w)e._normalizeValue(z,c,F),F+=h}else w&&w.length>h?c.set(w,A):(e._normalizeValue(w,I.target,0),I1({target:c,source:I.target,start:A,count:M}));A+=M*h}else e._normalizeValue(w,c,A),A+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var bf=class{constructor({gl:e,attribute:t,timeline:i}){this.gl=e,this.type="interpolation",this.transition=new gn(i),this.attribute=t,this.attributeInTransition=new Fo(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=RN(e,t);let n={byteLength:0,usage:35050};this.buffers=[new oe(e,n),new oe(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}let{gl:i,buffers:n,attribute:o}=this;pf(n);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)mf({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=pc(o,t),this.attributeInTransition.update({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:n[0],aTo:ff(i,o)},feedbackBuffers:{vCurrent:n[1]}})}update(){let e=this.transition.update();if(e){let{time:t,settings:{duration:i,easing:n}}=this.transition,o=n(t/i);this.transform.run({uniforms:{time:o}})}return e}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete()}},LN=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function RN(s,e){let t=gf(e.size);return new hn(s,{vs:LN,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var Pf=class{constructor({gl:e,attribute:t,timeline:i}){this.gl=e,this.type="spring",this.transition=new gn(i),this.attribute=t,this.attributeInTransition=new Fo(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=BN(e),this.framebuffer=MN(e,this.texture),this.transform=ON(e,t,this.framebuffer);let n={byteLength:0,usage:35050};this.buffers=[new oe(e,n),new oe(e,n),new oe(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:i,buffers:n,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)mf({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=pc(o,t),this.attributeInTransition.update({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:ff(i,o)}})}update(){let{buffers:e,transform:t,framebuffer:i,transition:n}=this;return n.update()?(t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:n.settings.stiffness,damping:n.settings.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),pf(e),this.attributeInTransition.update({buffer:e[1],value:this.attribute.value}),zs(i)[0]>0||n.end(),!0):!1}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete();this.texture.delete(),this.texture=null,this.framebuffer.delete(),this.framebuffer=null}};function ON(s,e,t){let i=gf(e.size);return new hn(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function BN(s){return new Ct(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function MN(s,e){return new ht(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var NN={interpolation:bf,spring:Pf},yf=class{constructor(e,{id:t,timeline:i}){this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=hn.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(let n in e){let o=e[n],a=o.getTransitionSetting(t);!a||this._updateAttribute(n,o,a)}for(let n in this.transitions){let o=e[n];(!o||!o.getTransitionSetting(t))&&this._removeTransition(n)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){let n=this.transitions[e],o=!n||n.type!==i.type;if(o){if(!this.isSupported){xe.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}n&&this._removeTransition(e);let a=NN[i.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(xe.error("unsupported transition type '".concat(i.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}};var D1="attributeManager.invalidate",DN="attributeManager.updateStart",GN="attributeManager.updateEnd",_N="attribute.updateStart",FN="attribute.allocate",VN="attribute.updateEnd",Sf=class{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.accessors={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new yf(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(e=!0){return this.needsRedraw=!0,this}add(e,t){this._add(e,t)}addInstanced(e,t){this._add(e,t,{instanced:1})}remove(e){for(let t=0;t<e.length;t++){let i=e[t];this.attributes[i]!==void 0&&(this.attributes[i].delete(),delete this.attributes[i])}}invalidate(e,t){let i=this._invalidateTrigger(e,t);qt(D1,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);qt(D1,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:o={},buffers:a={},context:l={}}={}){let u=!1;qt(DN,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=i,h.numInstances=t,o[c]&&xe.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(a[d],e.startIndices)||!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw|=h.needsRedraw()}u&&qt(GN,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!i.hasAttribute(o)&&(n[o]=a)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let i={};for(let n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}getAccessors(){return this.updateTriggers}_add(e,t,i={}){t&&xe.warn("AttributeManager.add({updaters}) - updater map no longer supported")();for(let n in e){let o=e[n];this.attributes[n]=this._createAttribute(n,o,i)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){let n={...t,id:e,isIndexed:t.isIndexed||t.elements||!1,constant:t.constant||!1,size:t.elements&&1||t.size||1,value:t.value||null,divisor:t.instanced||i.instanced?1:t.divisor||0};return new Fo(this.gl,n)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(n=>{e[n]||(e[n]=[]),e[n].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:n}=this,o=n[e];return o&&o.forEach(a=>{let l=i[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:i}=e;if(qt(_N,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&qt(FN,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,qt(VN,t,i))}};var Ef=class extends gn{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:o}}=this,a=o(e/n);this._value=Hd(t,i,a)}};var G1=1e-5;function _1(s,e,t,i,n){let o=e-s,l=(t-e)*n,u=-o*i;return l+u+o+e}function kN(s,e,t,i,n){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=_1(s[a],e[a],t[a],i,n);return o}return _1(s,e,t,i,n)}function F1(s,e){if(Array.isArray(s)){let t=0;for(let i=0;i<s.length;i++){let n=s[i]-e[i];t+=n*n}return Math.sqrt(t)}return Math.abs(s-e)}var xf=class extends gn{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=kN(o,a,t,i,n),u=F1(l,t),c=F1(l,a);u<G1&&c<G1&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var UN={interpolation:Ef,spring:xf},Cf=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(n=df(n),!n)return;let a=UN[n.type];if(!a){xe.error("unsupported transition type '".concat(n.type,"'"))();return}let l=new a(this.timeline);l.start({...n,fromValue:t,toValue:i}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function k1(s){let e=tP(s);for(let t in e){let i=e[t],{validate:n}=i;if(n&&!n(s[t],i))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function U1(s,e){let t=z1({newProps:s,oldProps:e,propTypes:tP(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=HN(s,e),n=!1;return i||(n=WN(s,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:n,extensionsChanged:jN(s,e),transitionsChanged:zN(s,e)}}function zN(s,e){if(!s.transitions)return null;let t={},i=tP(s);for(let n in s.transitions){let o=i[n],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&eP(s[n],e[n],o)&&(t[n]=!0)}return t}function z1({newProps:s,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:n="props"}){if(e===s)return null;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(n," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(n,".").concat(o," added");let a=eP(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(n,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=eP(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}}return null}function eP(s,e,t){let i=t&&t.equal;return i&&!i(s,e,t)||!i&&(i=s&&e&&s.equals,i&&!i.call(s,e))?"changed deeply":!i&&e!==s?"changed shallowly":null}function HN(s,e){if(e===null)return"oldProps is null, initial diff";let t=null,{dataComparator:i,_dataDiff:n}=s;return i?i(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&n&&(t=n(s.data,e.data)||t),t}function WN(s,e){if(e===null)return"oldProps is null, initial diff";if("all"in s.updateTriggers&&V1(s,e,"all"))return{all:!0};let t={},i=!1;for(let n in s.updateTriggers)n!=="all"&&V1(s,e,n)&&(t[n]=!0,i=t);return i}function jN(s,e){if(e===null)return!0;let t=e.extensions,{extensions:i}=s;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let n=0;n<i.length;n++)if(!i[n].equals(t[n]))return!0;return!1}function V1(s,e,t){let i=s.updateTriggers[t];i=i??{};let n=e.updateTriggers[t];return n=n??{},z1({oldProps:n,newProps:i,triggerName:t})}function tP(s){let e=s[Cl],t=e&&e.constructor;return t?t._propTypes:{}}var qN="count(): argument not an object",XN="count(): argument not a container";function H1(s){if(!$N(s))throw new Error(qN);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(YN(s))return Object.keys(s).length;throw new Error(XN)}function YN(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function $N(s){return s!==null&&typeof s=="object"}function W1(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){let i=t.modules.findIndex(n=>n.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let i={...s.inject};for(let n in e.inject)i[n]=(i[n]||"")+e.inject[n];t.inject=i}return t}var QN={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},rP={};function j1(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Ct)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={[10241]:e.data.length>1?9985:9729});let n=new Ct(t,{...e,parameters:{...QN,...i,...s.props.textureParameters}});return rP[n.id]=!0,n}function q1(s){!s||!(s instanceof Ct)||rP[s.id]&&(s.delete(),delete rP[s.id])}var ZN={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||bc(s)&&(s.length===3||s.length===4)},equal(s,e,t){return iP(s,e)}},accessor:{validate(s,e){let t=Af(s);return t==="function"||t===Af(e.value)},equal(s,e,t){return typeof e=="function"?!0:iP(s,e)}},array:{validate(s,e){return e.optional&&!s||bc(s)},equal(s,e,t){return t.compare?iP(s,e):s===e}},object:{equal(s,e,t){return t.compare?Kb(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:i}=t.props;return i&&s?i(s):s}},image:{transform:(s,e,t)=>j1(t,s),release:s=>{q1(s)}}};function iP(s,e){if(s===e)return!0;if(!bc(s)||!bc(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}function X1(s){let e={},t={},i={};for(let[n,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)i[n]=Array.isArray(a)?a:[a];else{let l=KN(n,o);e[n]=l,t[n]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function KN(s,e){switch(Af(e)){case"object":return mc(s,e);case"array":return mc(s,{type:"array",value:e,compare:!1});case"boolean":return mc(s,{type:"boolean",value:e});case"number":return mc(s,{type:"number",value:e});case"function":return mc(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function mc(s,e){return"type"in e?{name:s,...ZN[e.type],...e}:"value"in e?{name:s,type:Af(e.value),...e}:{name:s,type:"object",value:e}}function bc(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function Af(s){return bc(s)?"array":s===null?"null":typeof s}function Y1(s,e){let t=$1(s.constructor),i=Object.create(t);i[Cl]=s,i[fn]={},i[Ri]={};for(let n=0;n<e.length;++n){let o=e[n];for(let a in o)i[a]=o[a]}return Object.freeze(i),i}function $1(s){let e=vf(s,"_mergedDefaultProps");return e||(JN(s),s._mergedDefaultProps)}function JN(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),i=$1(t),n=vf(s,"defaultProps")||{},o=X1(n),a=eD(o.defaultProps,i,s),l={...t._propTypes,...o.propTypes};rD(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};tD(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function eD(s,e,t){let i=Object.create(null);Object.assign(i,e,s);let n=nD(t);return delete s.id,Object.defineProperties(i,{id:{writable:!0,value:n}}),i}function tD(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(i){let n="".concat(this.id,": ").concat(t);for(let o of e[t])Q1(this,o)||(this[o]=i);xe.deprecated(n,e[t].join("/"))()}})}function rD(s,e){let t={},i={};for(let n in e){let o=e[n],{name:a,value:l}=o;o.async&&(t[a]=l,i[a]=iD(a))}s[Wn]=t,s[fn]={},Object.defineProperties(s,i)}function iD(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||cf(e)?this[fn][s]=e:this[Ri][s]=e},get(){if(this[Ri]){if(s in this[Ri])return this[Ri][s]||this[Wn][s];if(s in this[fn]){let e=this[Cl]&&this[Cl].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[Wn][s]}}return this[Wn][s]}}}function Q1(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function vf(s,e){return Q1(s,e)&&s[e]}function nD(s){let e=vf(s,"layerName")||vf(s,"componentName");return e||xe.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var oD=Object.freeze({}),vl=class{constructor(e){j(this,"component",void 0),j(this,"onAsyncPropUpdated",void 0),j(this,"asyncProps",void 0),j(this,"oldProps",void 0),j(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||oD}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[Ri]||{},i=e[fn]||e,n=e[Wn]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in i){let a=i[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return t}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(cf(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let n=i.pendingLoadCount;t.then(o=>{o=this._postProcessValue(i,o),this._setAsyncPropValue(e,o,n),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let n=i.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,n)}this._onResolve(e,o)}_postProcessValue(e,t){let i=e.type;return i&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let n=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var sD=0,Tl=class{constructor(...e){j(this,"id",void 0),j(this,"props",void 0),j(this,"count",void 0),j(this,"lifecycle",void 0),j(this,"parent",void 0),j(this,"context",void 0),j(this,"state",void 0),j(this,"internalState",void 0),this.props=Y1(this,e),this.id=this.props.id,this.count=sD++,this.lifecycle=A1.NO_STATE,this.parent=null,this.context=null,this.state=null,this.internalState=null,Object.seal(this)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}clone(e){let{props:t}=this,i={};for(let n in t[Wn])n in t[Ri]?i[n]=t[Ri][n]:n in t[fn]&&(i[n]=t[fn][n]);return new this.constructor({...t,...i,...e})}_initState(){this.internalState=new vl(this)}};j(Tl,"componentName","Component");j(Tl,"defaultProps",{});var Tf=class extends vl{constructor({attributeManager:e,layer:t}){super(t);j(this,"attributeManager",void 0),j(this,"needsRedraw",void 0),j(this,"subLayers",void 0),j(this,"usesPickingColorCache",void 0),this.attributeManager=e,this.needsRedraw=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let i=this.component.props.fetch;return i?i(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let i=this.component.props.onDataLoad;e==="data"&&i&&i(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var aD="layer.changeFlag",lD="layer.initialize",uD="layer.update",cD="layer.finalize",hD="layer.matched",Z1=2**24-1,dD=Object.freeze([]),fD=sc(({oldViewport:s,viewport:e})=>s.equals(e)),pn=new Uint8ClampedArray(0),gD={data:{type:"data",value:dD,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:i,loadOptions:n,signal:o})=>{let{resourceManager:a}=t.context;if(n=n||t.getLoadOptions(),i=i||t.props.loaders,o){var l;n={...n,fetch:{...(l=n)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!n&&(a.add({resourceId:s,data:To(s,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>t.internalState.reloadAsyncProp(e,c),consumerId:t.id,requestId:e}):To(s,i,n)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:Gb.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Ce.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},Ir=class extends Tl{toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}raiseError(e,t){var i,n;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((i=(n=this.props).onError)!==null&&i!==void 0&&i.call(n,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(e=!0){this.internalState&&(this.internalState.needsRedraw=e)}setNeedsUpdate(){this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams())}hasUniformTransition(){return this.internalState.uniformTransitions.active}get isLoaded(){return this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||(this.state.model?[this.state.model]:[]))}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}project(e){let{viewport:t}=this.context,i=Zb(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,o,a]=yl(i,t.pixelProjectionMatrix);return e.length===2?[n,o]:[n,o,a]}unproject(e){let{viewport:t}=this.context;return t.unproject(e)}projectPosition(e,t){return C1(e,{viewport:this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Ce.DEFAULT||e===Ce.LNGLAT||e===Ce.CARTESIAN}onHover(e,t){return this.props.onHover?this.props.onHover(e,t):!1}onClick(e,t){return this.props.onClick?this.props.onClick(e,t):!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Oi(e instanceof Uint8Array);let[t,i,n]=e;return t+i*256+n*65536-1}initializeState(){throw new Error("Layer ".concat(this," has not defined initializeState"))}getShaders(e){for(let t of this.props.extensions)e=W1(e,t.getShaders.call(this,t));return e}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:i,instancePositions:n}=t.attributes;return(e=i||n)===null||e===void 0?void 0:e.getBounds()}shouldUpdateState({oldProps:e,props:t,context:i,changeFlags:n}){return n.propsOrDataChanged}updateState({oldProps:e,props:t,context:i,changeFlags:n}){let o=this.getAttributeManager();if(n.dataChanged&&o){let{dataChanged:u}=n;if(Array.isArray(u))for(let c of u)o.invalidateAll(c);else o.invalidateAll()}let a=Number.isInteger(e.highlightedObjectIndex)||e.pickable,l=Number.isInteger(t.highlightedObjectIndex)||t.pickable;if(a!==l&&o){let{pickingColors:u,instancePickingColors:c}=o.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,o.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(){for(let t of this.getModels())t.delete();let e=this.getAttributeManager();e&&e.finalize(),this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState.uniformTransitions.clear(),this.internalState.finalize()}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t}){let{index:i}=e;return i>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[i]),e}activateViewport(e){let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!fD({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all",t=""){let i=this.getAttributeManager();!i||(e==="all"?i.invalidateAll():i.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(e){let t=this.getAttributeManager();if(!t)return;let i=this.getNumInstances(e),n=this.getStartIndices(e);t.update({data:e.data,numInstances:i,startIndices:n,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this,ignoreUnknownAttributes:!0});let o=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let n in t)Object.defineProperty(i,n,{value:t[n]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(pn.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>Z1&&xe.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),pn=Hn.allocate(pn,t,{size:3,copy:!0,maxCount:Math.max(t,Z1)});let n=Math.floor(pn.length/3),o=[];for(let a=i;a<n;a++)this.encodePickingColor(a,o),pn[a*3+0]=o[0],pn[a*3+1]=o[1],pn[a*3+2]=o[2]}e.value=pn.subarray(0,t*3)}_setModelAttributes(e,t){let i=this.getAttributeManager(),n=e.userData.excludeAttributes||{},o=i.getShaderAttributes(t,n);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i,o=n.getVertexOffset(e),a=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;this.internalState.usesPickingColorCache&&i.value.buffer!==pn.buffer&&(i.value=pn.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0})}getNumInstances(e){return e=e||this.props,e.numInstances!==void 0?e.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:H1(e.data)}getStartIndices(e){return e=e||this.props,e.startIndices!==void 0?e.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}_initialize(){qt(lD,this),this._initState(),this.initializeState(this.context);for(let e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:!0,propsChanged:!0,viewportChanged:!0,extensionsChanged:!0}),this._updateState()}_update(){let e=this.needsUpdate();qt(uD,this,e),e&&this._updateState()}_updateState(){let e=this.props,t=this.context.viewport,i=this._updateUniformTransition();this.internalState.propsInTransition=i,this.context.viewport=this.internalState.viewport||t,this.props=i;try{let n=this._getUpdateParams(),o=this.getModels();if(this.context.gl)this.updateState(n);else try{this.updateState(n)}catch{}for(let l of this.props.extensions)l.updateState.call(this,n,l);let a=this.getModels()[0]!==o[0];this._updateModules(n,a),this.isComposite?this._renderLayers(n):(this.setNeedsRedraw(),this._updateAttributes(this.props),this.state.model&&this.state.model.setInstanceCount(this.getNumInstances()))}finally{this.context.viewport=t,this.props=e,this.clearChangeFlags(),this.internalState.needsUpdate=!1,this.internalState.resetOldProps()}}_finalize(){qt(cD,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();let n=this.props;this.props=this.internalState.propsInTransition||n;let{opacity:o}=this.props;t.opacity=Math.pow(o,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:a}=this.props,l=a&&a(t)||[0,0];Vs(this.context.gl,{polygonOffset:l}),Xt(this.context.gl,i,()=>{let u={moduleParameters:e,uniforms:t,parameters:i,context:this.context};for(let c of this.props.extensions)c.draw.call(this,u,c);this.draw(u)})}finally{this.props=n}}getChangeFlags(){return this.internalState.changeFlags}setChangeFlags(e){let{changeFlags:t}=this.internalState;for(let n in e)if(e[n]){let o=!1;switch(n){case"dataChanged":Array.isArray(t[n])&&(t[n]=Array.isArray(e[n])?t[n].concat(e[n]):e[n],o=!0);default:t[n]||(t[n]=e[n],o=!0)}o&&qt(aD,this,n,e)}let i=t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged;t.propsOrDataChanged=i,t.somethingChanged=i||e.viewportChanged||e.stateChanged}clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}diffProps(e,t){let i=U1(e,t);if(i.updateTriggersChanged)for(let n in i.updateTriggersChanged)i.updateTriggersChanged[n]&&this.invalidateAttribute(n);if(i.transitionsChanged)for(let n in i.transitionsChanged)this.internalState.uniformTransitions.add(n,t[n],e[n],e.transitions[n]);return this.setChangeFlags(i)}validateProps(){k1(this.props)}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_updateModules({props:e,oldProps:t},i){let{autoHighlight:n,highlightedObjectIndex:o,highlightColor:a}=e;if(i||t.autoHighlight!==n||t.highlightedObjectIndex!==o||t.highlightColor!==a){let l={};n||(l.pickingSelectedColor=null),Array.isArray(a)&&(l.pickingHighlightColor=a),Number.isInteger(o)&&(l.pickingSelectedColor=o>=0?this.encodePickingColor(o):null),this.setModuleParameters(l)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let i=this.getAttributeManager(),n=i&&i.getNeedsRedraw(e);return t=t||n,t}_getAttributeManager(){return new Sf(this.context.gl,{id:this.props.id,stats:this.context.stats,timeline:this.context.timeline})}_initState(){Oi(!this.internalState&&!this.state),Oi(isFinite(this.props.coordinateSystem));let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Tf({attributeManager:e,layer:this}),this.clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(xe.deprecated("layer.state.attributeManager","layer.getAttributeManager()"),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Cf(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props)}_transferState(e){qt(hD,this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this.diffProps(this.props,this.internalState.getOldProps()))}_onAsyncPropUpdated(){this.diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};Ir.layerName="Layer";Ir.defaultProps=gD;var pD="compositeLayer.renderLayers",mn=class extends Ir{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}renderLayers(){return null}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){let{opacity:t,pickable:i,visible:n,parameters:o,getPolygonOffset:a,highlightedObjectIndex:l,autoHighlight:u,highlightColor:c,coordinateSystem:h,coordinateOrigin:d,wrapLongitude:p,positionFormat:y,modelMatrix:x,extensions:A,fetch:T,operation:I,_subLayerProps:B}=this.props,w={opacity:t,pickable:i,visible:n,parameters:o,getPolygonOffset:a,highlightedObjectIndex:l,autoHighlight:u,highlightColor:c,coordinateSystem:h,coordinateOrigin:d,wrapLongitude:p,positionFormat:y,modelMatrix:x,extensions:A,fetch:T,operation:I},M=B&&B[e.id],F=M&&M.updateTriggers,z=e.id||"sublayer";if(M){let se=this.constructor._propTypes,pe=e.type?e.type._propTypes:{};for(let de in M){let Ae=pe[de]||se[de];Ae&&Ae.type==="accessor"&&(M[de]=this.getSubLayerAccessor(M[de]))}}Object.assign(w,e,M),w.id="".concat(this.props.id,"-").concat(z),w.updateTriggers={all:this.props.updateTriggers.all,...e.updateTriggers,...F};for(let se of A){let pe=se.getSubLayerProps.call(this,se);pe&&Object.assign(w,pe,{updateTriggers:Object.assign(w.updateTriggers,pe.updateTriggers)})}return w}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_renderLayers(){let{subLayers:e}=this.internalState,t=!e||this.needsUpdate();t&&(e=this.renderLayers(),e=v1(e,Boolean),this.internalState.subLayers=e),qt(pD,this,t,e);for(let i of e)i.parent=this}};mn.layerName="CompositeLayer";var Pc=class{constructor(e={}){let{attributes:t={}}=e;this.typedArrayManager=Hn,this.indexStarts=null,this.vertexStarts=null,this.vertexCount=0,this.instanceCount=0,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e),Object.seal(this)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:n,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=i,this.normalize=u,o&&(Oi(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(i.positions=o)),this.geometryBuffer=i.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}normalizeGeometry(e){return e}updateGeometryAttributes(e,t,i){throw new Error("Not implemented")}getGeometrySize(e){throw new Error("Not implemented")}getGeometryFromBuffer(e){let t=e.value||e;return Oi(ArrayBuffer.isView(t)),hf(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices})}_allocate(e,t){let{attributes:i,buffers:n,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in n)a.release(i[l]),i[l]=null;else{let u=o[l];u.copy=t,i[l]=a.allocate(i[l],e,u)}}_forEachGeometry(e,t,i){let{data:n,getGeometry:o}=this,{iterable:a,objectInfo:l}=jn(n,t,i);for(let u of a){l.index++;let c=o(u,l);e(c,l.index)}}_rebuildGeometry(e){if(!this.data||!this.getGeometry)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!a)this._forEachGeometry((d,p)=>{d=this.normalizeGeometry(d),c[p]=d,i[p+1]=i[p]+this.getGeometrySize(d)},l,u),n=i[i.length-1];else if(a.buffer instanceof oe){let d=a.stride||this.positionSize*4;i=o.startIndices,n=i[o.length]||a.buffer.byteLength/d}else{let d=a.value||a,p=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;i=o.startIndices,n=i[o.length]||d.length/p}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;let h={};this._forEachGeometry((d,p)=>{d=c[p]||d,h.vertexStart=i[p],h.indexStart=t[p];let y=p<i.length-1?i[p+1]:n;h.geometrySize=y-i[p],h.geometryIndex=p,this.updateGeometryAttributes(d,h)},l,u),this.vertexCount=t[t.length-1]}};var K1=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var J1=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var mD=1024,bD=4,eA=()=>{},PD={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function yD(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function SD(s,e,t,i){return t===e.width&&i===e.height?e:(s.canvas.height=i,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,i),s.canvas)}function yc(s){return s&&(s.id||s.url)}function ED(s,e,t,i){let n=e.width,o=e.height,a=ll(e,{width:t,height:i});return Ld(e,a,{targetY:0,width:n,height:o}),e.delete(),a}function tA(s,e,t){for(let i=0;i<e.length;i++){let{icon:n,xOffset:o}=e[i],a=yc(n);s[a]={...n,x:o,y:t}}}function xD({icons:s,buffer:e,mapping:t={},xOffset:i=0,yOffset:n=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=yc(c);if(!t[h]){let{height:d,width:p}=c;i+p+e>a&&(tA(t,l,n),i=0,n=o+n+e,o=0,l=[]),l.push({icon:c,xOffset:i}),i=i+p+e,o=Math.max(o,d)}}return l.length>0&&tA(t,l,n),{mapping:t,rowHeight:o,xOffset:i,yOffset:n,canvasWidth:a,canvasHeight:yD(o+n+e)}}function CD(s,e,t){if(!s||!e)return null;t=t||{};let i={},{iterable:n,objectInfo:o}=jn(s);for(let a of n){o.index++;let l=e(a,o),u=yc(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!i[u]&&(!t[u]||l.url!==t[u].url)&&(i[u]={...l,source:a,sourceIndex:o.index})}return i}var If=class{constructor(e,{onUpdate:t=eA,onError:i=eA}){this.gl=e,this.onUpdate=t,this.onError=i,this._loadOptions=null,this._getIcon=null,this._texture=null,this._externalTexture=null,this._mapping={},this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=bD,this._canvasWidth=mD,this._canvasHeight=0,this._canvas=null}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?yc(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n,data:o,getIcon:a}){e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),a&&(this._getIcon=a),n&&(this._mapping=n),i&&this._updateIconAtlas(i),this._autoPacking&&(o||a)&&typeof document<"u"&&(this._canvas=this._canvas||document.createElement("canvas"),this._updateAutoPacking(o))}get isLoaded(){return this._pendingCount===0}_updateIconAtlas(e){var t;(t=this._texture)===null||t===void 0||t.delete(),this._texture=null,this._externalTexture=e,this.onUpdate()}_updateAutoPacking(e){let t=Object.values(CD(e,this._getIcon,this._mapping)||{});if(t.length>0){let{mapping:i,xOffset:n,yOffset:o,rowHeight:a,canvasHeight:l}=xD({icons:t,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=i,this._xOffset=n,this._yOffset=o,this._canvasHeight=l,this._texture||(this._texture=new Ct(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:PD})),this._texture.height!==this._canvasHeight&&(this._texture=ED(this.gl,this._texture,this._canvasWidth,this._canvasHeight)),this.onUpdate(),this._loadIcons(t)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let i of e)this._pendingCount++,To(i.url,_u,this._loadOptions).then(n=>{let o=yc(i),{x:a,y:l,width:u,height:c}=this._mapping[o],h=SD(t,n,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(n=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:n})}).finally(()=>{this._pendingCount--})}};var rA=[0,0,0,255],AD={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:rA},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},qn=class extends Ir{getShaders(){return super.getShaders({vs:K1,fs:J1,modules:[dn,Go]})}initializeState(){this.state={iconManager:new If(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:rA},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState({oldProps:e,props:t,changeFlags:i}){super.updateState({props:t,oldProps:e,changeFlags:i});let n=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:l,getIcon:u}=t,{iconManager:c}=this.state;c.setProps({loadOptions:t.loadOptions});let h=!1;if(o||this.internalState.isAsyncPropLoading("iconAtlas")?(e.iconAtlas!==t.iconAtlas&&c.setProps({iconAtlas:o,autoPacking:!1}),e.iconMapping!==t.iconMapping&&(c.setProps({iconMapping:a}),h=!0)):c.setProps({autoPacking:!0}),(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getIcon))&&c.setProps({data:l,getIcon:u}),h&&(n.invalidate("instanceOffsets"),n.invalidate("instanceIconFrames"),n.invalidate("instanceColorModes")),i.extensionsChanged){var p;let{gl:y}=this.context;(p=this.state.model)===null||p===void 0||p.delete(),this.state.model=this._getModel(y),n.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(){super.finalizeState(),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:hi[o],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new Nr(e,{...this.getShaders(),id:this.props.id,geometry:new ui({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){let{onIconError:t}=this.getCurrentLayer().props;t?t(e):xe.error(e.error)()}getInstanceOffset(e){let t=this.state.iconManager.getIconMapping(e);return[t.width/2-t.anchorX||0,t.height/2-t.anchorY||0]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let t=this.state.iconManager.getIconMapping(e);return[t.x||0,t.y||0,t.width||0,t.height||0]}};qn.layerName="IconLayer";qn.defaultProps=AD;function Qs(s,e){let t=e.length,i=s.length;if(i>0){let n=!0;for(let o=0;o<t;o++)if(s[i-t+o]!==e[o]){n=!1;break}if(n)return!1}for(let n=0;n<t;n++)s[i+n]=e[n];return!0}function wf(s,e){let t=e.length;for(let i=0;i<t;i++)s[i]=e[i]}function Sc(s,e,t,i,n=[]){let o=i+e*t;for(let a=0;a<t;a++)n[a]=s[o+a];return n}function nP(s,e,t,i,n=[]){let o,a;if(t&8)o=(i[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(i[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(i[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(i[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)n[l]=(a&1)===l?i[a]:o*(e[l]-s[l])+s[l];return n}function Lf(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function Ec(s,e={}){let{size:t=2,broken:i=!1,gridResolution:n=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e,u=(l-a)/t,c=[],h=[c],d=Sc(s,0,t,a),p,y,x=ID(d,n,o,[]),A=[];Qs(c,d);for(let T=1;T<u;T++){for(p=Sc(s,T,t,a,p),y=Lf(p,x);y;){nP(d,p,y,x,A);let I=Lf(A,x);I&&(nP(d,A,I,x,A),y=I),Qs(c,A),wf(d,A),wD(x,n,y),i&&c.length>t&&(c=[],h.push(c),Qs(c,d)),y=Lf(p,x)}Qs(c,p),wf(d,p)}return i?h:h[0]}function ID(s,e,t,i){let n=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return i[0]=n,i[1]=o,i[2]=n+e,i[3]=o+e,i}function wD(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function oP(s,e={}){let{size:t=2,startIndex:i=0,endIndex:n=s.length,normalize:o=!0}=e,a=s.slice(i,n);RD(a,t,0,n-i);let l=Ec(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)OD(u,t);return l}function RD(s,e,t,i){let n=s[0],o;for(let a=t;a<i;a+=e){o=s[a];let l=o-n;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=n=o}}function OD(s,e){let t,i=s.length/e;for(let o=0;o<i&&(t=s[o*e],(t+180)%360===0);o++);let n=-Math.round(t/360)*360;if(n!==0)for(let o=0;o<i;o++)s[o*e]+=n}function nA(s,e,t,i){let n=s;if(Array.isArray(s[0])){let o=s.length*e;n=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)n[a*e+l]=s[a][l]||0}return t?Ec(n,{size:e,gridResolution:t}):i?oP(n,{size:e}):n}var MD=1,ND=2,sP=4,Rf=class extends Pc{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):()=>null}normalizeGeometry(e){return this.normalize?nA(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}get(e){return this.attributes[e]}getGeometrySize(e){if(Array.isArray(e[0])){let i=0;for(let n of e)i+=this.getGeometrySize(n);return i}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&Array.isArray(e[0]))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let{segmentTypes:i}=this.attributes,n=this.isClosed(e),{vertexStart:o,geometrySize:a}=t;i.fill(0,o,o+a),n?(i[o]=sP,i[o+a-2]=sP):(i[o]+=MD,i[o+a-2]+=ND),i[o+a-1]=sP}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i)return;let{vertexStart:n,geometrySize:o}=t,a=new Array(3);for(let l=n,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),i[l*3]=a[0],i[l*3+1]=a[1],i[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);let o=t*n;return i[0]=e[o],i[1]=e[o+1],i[2]=n===3&&e[o+2]||0,i}isClosed(e){if(!this.normalize)return this.opts.loop;let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}};var oA=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  vec2 dir = isEnd ? dirA : dirB;
  vec2 perp = isEnd ? perpA : perpB;
  float L = isEnd ? lenA : lenB;
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var sA=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var aA=[0,0,0,255],DD={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:aA},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},aP={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},Vo=class extends Ir{getShaders(){return super.getShaders({vs:oA,fs:sA,modules:[dn,Go]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:aP,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:aP,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:aP,defaultValue:aA},instancePickingColors:{size:3,type:5121,accessor:(i,{index:n,target:o})=>this.encodePickingColor(i&&i.__source?i.__source.index:n,o)}}),this.setState({pathTesselator:new Rf({fp64:this.use64bitPositions()})}),this.props.getDashArray&&!this.props.extensions.length&&xe.removed("getDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:i}){super.updateState({props:t,oldProps:e,changeFlags:i});let n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),n.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:n,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:hi[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Nr(e,{...this.getShaders(),id:this.props.id,geometry:new ui({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};Vo.layerName="PathLayer";Vo.defaultProps=DD;var lA=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var uA=192/256,cA=[],GD={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},Il=class extends qn{getShaders(){return{...super.getShaders(),fs:lA}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:i,target:n})=>this.encodePickingColor(i,n)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map(o=>o/255),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&xe.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:uA,outlineBuffer:n?Math.max(i,uA*(1-n)):-1,gamma:i,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).map(t=>super.getInstanceOffset(t)):cA}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).map(t=>super.getInstanceIconFrame(t)):cA}};Il.layerName="MultiIconLayer";Il.defaultProps=GD;var EA=Q(fA());var VD=32,kD=[];function UD(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function gA({characterSet:s,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:n,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a,h=0;for(let p of s)if(!o[p]){let y=e(p,h++);c+y+i*2>n&&(c=0,u++),o[p]={x:c+i,y:l+u*(t+i*2)+i,width:y,height:t},c+=y+i*2}let d=t+i*2;return{mapping:o,xOffset:c,yOffset:l+u*d,canvasHeight:UD(l+(u+1)*d)}}function pA(s,e,t,i){let n=0;for(let o=e;o<t;o++){let a=s[o],l=null,u=i&&i[a];u&&(l=u.width),n+=l}return n}function mA(s,e,t,i,n,o){let a=e,l=0;for(let u=e;u<t;u++){let c=pA(s,u,u+1,n);l+c>i&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function zD(s,e,t,i,n,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=pA(s,l,u,n);c+d>i&&(a<l&&(o.push(l),a=l,c=0),d>i&&(d=mA(s,l,u,i,n,o),a=o[o.length-1])),l=u,c+=d}return c}function HD(s,e,t,i,n=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?mA(s,n,o,t,i,a):zD(s,n,o,t,i,a),a}function WD(s,e,t,i,n,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=i[c];h?(l||(l=h.height),n[u]=a+h.width/2,a+=h.width):(xe.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),n[u]=a,a+=VD)}o[0]=a,o[1]=l}function uP(s,e,t,i,n){s=Array.from(s);let o=s.length,a=new Array(o),l=new Array(o),u=new Array(o),c=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,h=[0,0],d=[],p=0,y=0,x=0;for(let A=0;A<=o;A++){let T=s[A];if((T===`
`||A===o)&&(x=A),x>y){let I=c?HD(s,t,i,n,y,x):kD;for(let B=0;B<=I.length;B++){let w=B===0?y:I[B-1],M=B<I.length?I[B]:x;WD(s,w,M,n,a,d);for(let F=w;F<M;F++)l[F]=p+d[1]/2,u[F]=d[0];p=p+d[1]*e,h[0]=Math.max(h[0],d[0])}y=x}T===`
`&&(a[y]=0,l[y]=0,u[y]=0,y++)}return h[1]=p,{x:a,y:l,rowWidth:u,size:h}}function bA({value:s,length:e,stride:t,offset:i,startIndices:n,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=i?i/a:0,c=n[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),p=s;if(l>1||u>0){p=new s.constructor(c);for(let y=0;y<c;y++)p[y]=s[y*l+u]}for(let y=0;y<e;y++){let x=n[y],A=n[y+1]||c,T=p.subarray(x,A);d[y]=String.fromCodePoint.apply(null,T),h&&T.forEach(h.add,h)}if(h)for(let y of h)o.add(String.fromCodePoint(y));return{texts:d,characterCount:c}}var Cc=class{constructor(e=5){this.limit=e,this.clear()}clear(){this._cache={},this._order=[]}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(this._deleteCache(e),this._deleteOrder(e))}_deleteCache(e){delete this._cache[e]}_deleteOrder(e){let t=this._order.findIndex(i=>i===e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function jD(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var cP=jD(),hP="Monaco, monospace",dP="normal",fP=64,gP=4,pP=.25,mP=12,PA=1024,qD=.9,yA=1.2,xA=3,Of=new Cc(xA),XD=["fontFamily","fontWeight","characterSet","fontSize","sdf","buffer","cutoff","radius"];function YD(s,e){let t=Of.get(s);if(!t)return e;let i=[],n=t.mapping,o=Object.keys(n);o=new Set(o);let a=e;return a instanceof Array&&(a=new Set(a)),a.forEach(l=>{o.has(l)||i.push(l)}),i}function $D(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function SA(s,e,t,i){s.font="".concat(i," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="baseline",s.textAlign="left"}function CA(s){xe.assert(Number.isFinite(s)&&s>=xA,"Invalid cache limit"),Of=new Cc(s)}var Bf=class{constructor(){this.props={fontFamily:hP,fontWeight:dP,characterSet:cP,fontSize:fP,buffer:gP,sdf:!1,cutoff:pP,radius:mP},this._key=null,this._atlas=null}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return yA}setProps(e={}){XD.forEach(a=>{a in e&&(this.props[a]=e[a])});let t=this._key;this._key=this._getKey();let i=YD(this._key,this.props.characterSet),n=Of.get(this._key);if(n&&i.length===0){this._key!==t&&(this._atlas=n);return}let o=this._generateFontAtlas(this._key,i,n);this._atlas=o,Of.set(this._key,o)}_generateFontAtlas(e,t,i){let{fontFamily:n,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=i&&i.data;d||(d=document.createElement("canvas"),d.width=PA);let p=d.getContext("2d");SA(p,n,a,o);let{mapping:y,canvasHeight:x,xOffset:A,yOffset:T}=gA({getFontWidth:I=>p.measureText(I).width,fontHeight:a*yA,buffer:l,characterSet:t,maxCanvasWidth:PA,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(d.height!==x){let I=p.getImageData(0,0,d.width,d.height);d.height=x,p.putImageData(I,0,0)}if(SA(p,n,a,o),u){let I=new EA.default(a,l,c,h,n,o),B=p.getImageData(0,0,I.size,I.size);for(let w of t)$D(I.draw(w),B),p.putImageData(B,y[w].x-l,y[w].y+l)}else for(let I of t)p.fillText(I,y[I].x,y[I].y+a*qD);return{xOffset:A,yOffset:T,mapping:y,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}};var AA=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var vA=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var QD={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},Ll=class extends Ir{getShaders(){return super.getShaders({vs:AA,fs:vA,modules:[dn,Go]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState({props:e,oldProps:t,changeFlags:i}){if(super.updateState({props:e,oldProps:t,changeFlags:i}),i.extensionsChanged){var n;let{gl:o}=this.context;(n=this.state.model)===null||n===void 0||n.delete(),this.state.model=this._getModel(o),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:hi[n],sizeScale:i,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new Nr(e,{...this.getShaders(),id:this.props.id,geometry:new ui({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};Ll.layerName="TextBackgroundLayer";Ll.defaultProps=QD;var TA={fontSize:fP,buffer:gP,sdf:!1,radius:mP,cutoff:pP,smoothing:.1},IA={start:1,middle:0,end:-1},wA={top:1,center:0,bottom:-1},bP=[0,0,0,255],ZD=1,KD=["fontSize","buffer","sdf","radius","cutoff"],JD={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:bP},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:cP},fontFamily:hP,fontWeight:dP,lineHeight:ZD,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:bP},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:bP},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},ko=class extends mn{initializeState(){this.state={styleVersion:0,fontAtlasManager:new Bf}}updateState({props:e,oldProps:t,changeFlags:i}){let n=i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getText),o=this.state.characterSet;n&&this._updateText();let a=o!==this.state.characterSet||this._fontChanged(t,e);a&&this._updateFontAtlas(t,e),(a||e.lineHeight!==t.lineHeight||e.wordBreak!==t.wordBreak||e.maxWidth!==t.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(e,t){let{fontSettings:i,fontFamily:n,fontWeight:o}=t,{fontAtlasManager:a,characterSet:l}=this.state;a.setProps({...TA,...i,characterSet:l,fontFamily:n,fontWeight:o})}_fontChanged(e,t){if(e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight)return!0;if(e.fontSettings===t.fontSettings)return!1;let i=e.fontSettings||{},n=t.fontSettings||{};return KD.some(o=>i[o]!==n[o])}_updateText(){let{data:e,characterSet:t}=this.props,i=e.attributes&&e.attributes.getText,{getText:n}=this.props,{startIndices:o}=e,a,l=t==="auto"&&new Set;if(i&&o){let{texts:u,characterCount:c}=bA({...ArrayBuffer.isView(i)?{value:i}:i,length:e.length,startIndices:o,characterSet:l});a=c,n=(h,{index:d})=>u[d]}else{let{iterable:u,objectInfo:c}=jn(e);o=[0],a=0;for(let h of u){c.index++;let d=Array.from(n(h,c)||"");l&&d.forEach(l.add,l),a+=d.length,o.push(a)}}this.setState({getText:n,startIndices:o,numInstances:a,characterSet:l||t})}getBoundingRect(e,t){let i=this.state.fontAtlasManager.mapping,{getText:n}=this.state,{wordBreak:o,maxWidth:a,lineHeight:l,getTextAnchor:u,getAlignmentBaseline:c}=this.props,h=n(e,t)||"",{size:[d,p]}=uP(h,l,o,a,i),y=IA[typeof u=="function"?u(e,t):u],x=wA[typeof c=="function"?c(e,t):c];return[(y-1)*d/2,(x-1)*p/2,d,p]}getIconOffsets(e,t){let i=this.state.fontAtlasManager.mapping,{getText:n}=this.state,{wordBreak:o,maxWidth:a,lineHeight:l,getTextAnchor:u,getAlignmentBaseline:c}=this.props,h=n(e,t)||"",{x:d,y:p,rowWidth:y,size:[x,A]}=uP(h,l,o,a,i),T=IA[typeof u=="function"?u(e,t):u],I=wA[typeof c=="function"?c(e,t):c],B=d.length,w=new Array(B*2),M=0;for(let F=0;F<B;F++){let z=(1-T)*(x-y[F])/2;w[M++]=(T-1)*x/2+z+d[F],w[M++]=(I-1)*A/2+p[F]}return w}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:p,getAngle:y,getPixelOffset:x,getBackgroundColor:A,getBorderColor:T,getBorderWidth:I,backgroundPadding:B,background:w,billboard:M,fontSettings:F,outlineWidth:z,outlineColor:se,sizeScale:pe,sizeUnits:de,sizeMinPixels:Ae,sizeMaxPixels:$e,transitions:ge,updateTriggers:me}=this.props,J=this.getSubLayerClass("characters",Il),bn=this.getSubLayerClass("background",Ll);return[w&&new bn({getFillColor:A,getLineColor:T,getLineWidth:I,padding:B,getPosition:h,getSize:p,getAngle:y,getPixelOffset:x,billboard:M,sizeScale:pe/this.state.fontAtlasManager.props.fontSize,sizeUnits:de,sizeMinPixels:Ae,sizeMaxPixels:$e,transitions:ge&&{getPosition:ge.getPosition,getAngle:ge.getAngle,getSize:ge.getSize,getFillColor:ge.getBackgroundColor,getLineColor:ge.getBorderColor,getLineWidth:ge.getBorderWidth,getPixelOffset:ge.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:me.getPosition,getAngle:me.getAngle,getSize:me.getSize,getFillColor:me.getBackgroundColor,getLineColor:me.getBorderColor,getLineWidth:me.getBorderWidth,getPixelOffset:me.getPixelOffset,getBoundingRect:{getText:me.getText,getTextAnchor:me.getTextAnchor,getAlignmentBaseline:me.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect.bind(this)}),new J({sdf:F.sdf,smoothing:Number.isFinite(F.smoothing)?F.smoothing:TA.smoothing,outlineWidth:z,outlineColor:se,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:p,getAngle:y,getPixelOffset:x,billboard:M,sizeScale:pe*n,sizeUnits:de,sizeMinPixels:Ae*n,sizeMaxPixels:$e*n,transitions:ge&&{getPosition:ge.getPosition,getAngle:ge.getAngle,getColor:ge.getColor,getSize:ge.getSize,getPixelOffset:ge.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:me.getText,getPosition:me.getPosition,getAngle:me.getAngle,getColor:me.getColor,getSize:me.getSize,getPixelOffset:me.getPixelOffset,getIconOffsets:{getText:me.getText,getTextAnchor:me.getTextAnchor,getAlignmentBaseline:me.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets.bind(this),getIcon:i})]}static set fontAtlasCacheLimit(e){CA(e)}};ko.layerName="TextLayer";ko.defaultProps=JD;var Rl={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var eG={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColor:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},tG=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceDepths;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  applyHighlight(int(instanceDepths.r));
}
`,rG=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Zs=class extends Ir{getShaders(){return super.getShaders({vs:tG,fs:rG,modules:[dn,pl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:Rl.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:Rl.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:Rl.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:Rl.UNSIGNED_BYTE,accessor:"getShape"}})}updateState(e){var a;super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=!1;if(n.extensionsChanged){let{gl:l}=this.context;(a=this.state.model)==null||a.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),o=!0}if((o||t.getDepth!==i.getDepth)&&t.getDepth&&this.state.model.setAttributes({instanceDepths:t.getDepth}),o||t.highlightColor!==i.highlightColor){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=t.highlightColor[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:i,cornerRadius:n,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:i,cornerRadius:n,lineWidthUnits:hi[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new Nr(e,{...this.getShaders(),id:this.props.id,geometry:new ui({drawMode:Rl.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};Zs.defaultProps=eG,Zs.layerName="GeometryLayer";function Ac(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!Ac(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!e.hasOwnProperty(n)||!Ac(s[n],e[n]))return!1;return!0}return!1}function LA(s){if(s instanceof ze){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}var Mf=class extends mn{renderLayers(){return[new Zs(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:0,cornerRadius:iG(this.props.data[0]),getLineColor:RA,getFillColor:nG}),new ko(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof ze)||t.labelSize),getPosition:e=>LA(e),getText:e=>Et.getDrawingObj(e.node).labelText,getColor:RA,getSize:this.props.getTextSize,sizeMaxPixels:48,sizeUnits:"common",characterSet:"auto"})]}};Mf.defaultProps={...ko.defaultProps,...Zs.defaultProps,getDepth:null,getTextSize:{type:"accessor",value:16}};function iG(s){return s?Et.getDrawingObj(s.node).xRad:0}function RA(s){let e=rt.getDrawingObj(s.node);if(e){let t=e.color;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function nG(s){let e=rt.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}var oG="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",PP=4,OA=To(oG,_u,{imagebitmap:{resizeWidth:256*PP,resizeHeight:128*PP}}),BA=sG({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},PP);function sG(s,e){for(let t in s){let i=s[t];i.x*=e,i.y*=e,i.width*=e,i.height*=e,i.anchorX&&(i.anchorX*=e),i.anchorY&&(i.anchorY*=e)}return s}var Nf=class extends mn{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let t=[];for(let i of e.props.data){let n=i;n.sourceArrowhead&&t.push({edge:i,type:"triangle-n",tip:n.sourceArrowhead.tipPosition,end:n.curve.start}),n.targetArrowhead&&t.push({edge:i,type:"triangle-n",tip:n.targetArrowhead.tipPosition,end:n.curve.end})}this.setState({arrows:t})}}renderLayers(){let e=this.props;return[new Vo(e,this.getSubLayerProps({id:"path"}),{getPath:t=>Array.from(Dc(t.curve,.01)).map(i=>[i.x,i.y]),getColor:MA,widthUnits:"pixels"}),new qn(this.getSubLayerProps({id:"arrow"}),{data:this.state.arrows,iconAtlas:OA,iconMapping:BA,getPosition:t=>[t.tip.x,t.tip.y],getColor:t=>MA(t.edge),getIcon:t=>t.type,getSize:t=>aG(t.tip,t.end),getAngle:t=>lG(t.tip,t.end),sizeUnits:"common"})]}};Nf.defaultProps={...Vo.defaultProps};function MA(s){let e=rt.getDrawingObj(s.edge);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function aG(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}function lG(s,e){let t=s.x-e.x,i=s.y-e.y;return-Math.atan2(i,t)/Math.PI*180}function Df(s,e,t=!1){let i=!1,n=t,o=ze.getGeom(s.graph);function a(l){if(!l)return;for(let h of l.subgraphs())a(h);let u=uG(s,l,e),c=cG(l.layoutSettings,u);n=n||c.layoutChanged,i=i||c.routingChanged,l.layoutSettings=u}if(a(o),n||i)for(let l of o.deepEdges())l.requireRouting();return n?_p(o,null):i&&Fa(o,Array.from(o.deepEdges()),null),o}function uG(s,e,t){let i=!1;for(let o of e.edges())if(o.sourceArrowhead!=null||o.targetArrowhead!=null){i=!0;break}let n;switch(t.layoutType){case"Sugiyama LR":{let o=n=new fr;o.layerDirection=1;break}case"Sugiyama RL":{let o=n=new fr;o.layerDirection=3;break}case"Sugiyama TB":{let o=n=new fr;o.layerDirection=0;break}case"Sugiyama BT":{let o=n=new fr;o.layerDirection=2;break}case"MDS":n=new Mn;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.nodeCollection.edgeCount>4e3;if(i&&!o){let a=n=new fr;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else n=new Mn}}return t.edgeRoutingMode==null?n instanceof fr?n.edgeRoutingSettings.EdgeRoutingMode=3:n.edgeRoutingSettings.EdgeRoutingMode=0:n.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,n}function cG(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.edgeRoutingSettings.EdgeRoutingMode!==e.edgeRoutingSettings.EdgeRoutingMode,i=t&&e.edgeRoutingSettings.EdgeRoutingMode===3,n=s instanceof fr&&e instanceof fr&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||i||n,routingChanged:t}}var Ks=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:i,fontStyle:n,fontWeight:o}=this.opts;this.ctx.font=`${n} ${o} ${i}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:i,lineHeight:n}=this.opts,o=i*1.2,a=i*(n-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new At(l,u.length*o+(u.length-1)*a)}};var zye=new Uint8Array(4);var Vf=Q(Pt()),Ff=class{bind(){this.entity&&this.entity.setAttr(Ff.attachIndex,this)}constructor(e,t){this.entity=e,this.svgData=t,this.bind()}static getGeom(e){return e.getAttr(Ff.attachIndex)}},yP=Ff;yP.attachIndex=2;var Tc=class{constructor(e,t=!1){this._textMeasurer=new Ks;this.transformRequired=t,this.container=e}clearContainer(){for(;this.container.childNodes.length>0;)this.container.removeChild(this.container.firstChild)}setGraph(e){if(this.clearContainer(),this.graph=e,this.svg=vc(this.graph,"svg"),this.svg.setAttribute("style","border: 1px solid black"),this.geomGraph=ze.getGeom(this.graph),!this.geomGraph)return null;this.geomGraph.updateBoundingBox(),this.open();for(let t of this.graph.deepNodes)this.drawNode(t);for(let t of this.graph.deepEdges())this.drawEdge(t);this.close(),this.container.appendChild(this.svg)}drawEdge(e){let t=vc(e,"g"),i=document.createElementNS(_f,"path");t.appendChild(i),i.setAttribute("fill","none");let n=oi.getDrawingObj(e);this.setStroke(i,n);let o=Re.getGeom(e);i.setAttribute("d",NA(o.curve));for(let a of this.AddArrows(e))t.appendChild(a);this.DrawEdgeLabel(e),this.svg.appendChild(t)}DrawEdgeLabel(e){let t=oi.getDrawingObj(e),n=Re.getGeom(e).label;!n||this.drawLabelAtXY(t,n.boundingBox)}*AddArrows(e){let t=Re.getGeom(e),i=t.curve,n=this.AddArrowhead(e,t.sourceArrowhead,i.start);n&&(yield n),n=this.AddArrowhead(e,t.targetArrowhead,i.end),n&&(yield n)}AddArrowhead(e,t,i){if(!t)return;let n=vc(e,"polygon"),o=oi.getDrawingObj(e);this.setStroke(n,o);let a=bG(i,t.tipPosition);return n.setAttribute("points",GA(a)),n}setStroke(e,t){e.setAttribute("stroke",Gf(t.color)),e.setAttribute("stroke-opacity",(t.color.A/255).toString()),e.setAttribute("stroke-width",t.penwidth.toString())}drawNode(e){let i=Le.getGeom(e).boundaryCurve;!i||this.drawNodeOnCurve(i,e)}drawNodeOnCurve(e,t){var o;let i=rt.getDrawingObj(t),n=vc(t,"path");if(i.styles.find(a=>a==5)){let a=(o=i.fillColor)!=null?o:i.color;n.setAttribute("fill",Gf(a))}else n.setAttribute("fill","none");n.setAttribute("d",NA(e)),n.setAttribute("stroke",Gf(i.color)),this.svg.appendChild(n),this.drawLabel(t,i)}drawLabel(e,t){if(!!t&&!(!t.labelText||t.labelText.length==0))if(t instanceof Et)this.writeLabelText(e,t.measuredTextSize);else throw new Error("not implemented")}writeLabelText(e,t){let i=_r.getGeom(e),n=rt.getDrawingObj(e),a=e instanceof De?V.creatRectangleWithSize(t,new f(i.center.x,i.boundingBox.bottom+t.height/2+n.LabelMargin)):V.creatRectangleWithSize(t,i.center);this.drawLabelAtXY(n,a)}drawLabelAtXY(e,t){let i=e.fontsize,n=vc(e.attrCont,"text");n.setAttribute("text-anchor","middle"),n.setAttribute("x",t.center.x.toString()),n.setAttribute("fill",Gf(e.fontColor)),n.setAttribute("font-family",e.fontname),n.setAttribute("font-size",i.toString()+"px"),this.createTspans(e.labelText,n,i,t),this.svg.appendChild(n)}createTspans(e,t,i,n){let o=`
`,a=e.split(o);if(a.length==1){let l=document.createElementNS(_f,"tspan");t.appendChild(l),l.textContent=e,l.setAttribute("text-anchor","middle"),l.setAttribute("x",n.center.x.toString()),l.setAttribute("alignment-baseline","middle"),l.setAttribute("y",n.center.y.toString())}else{let l=n.bottom+1;for(let u=0;u<a.length;u++){let c=document.createElementNS(_f,"tspan");t.appendChild(c),c.textContent=a[u],c.setAttribute("text-anchor","middle"),c.setAttribute("x",n.center.x.toString()),c.setAttribute("alignment-baseline","hanging"),c.setAttribute("y",l.toString()),l+=1.3*i}}}close(){if(this.transformRequired)throw new Error("not implemented")}open(){if(this.svg.setAttribute("width",this.geomGraph.width),this.svg.setAttribute("height",this.geomGraph.height),this.transformRequired)throw new Error("not implemented")}};Tc.arrowAngle=25;var _f="http://www.w3.org/2000/svg";function NA(s){return Vf.String.Join(" ",Array.from(hG(s)))}function*hG(s){if(yield"M",yield Js(s.start),s instanceof v)for(let t of s.segs)yield pG(t);else if(s instanceof O)yield"L",yield Js(s.end);else if(s instanceof we)yield DA(s);else if(s instanceof q){let o=s;for(let a of o.skip(1))yield"L",yield Js(a.point);o.closed&&(yield"L",yield Js(o.start))}else if(s instanceof re){let a=s;dG(a)?(yield this.ellipseToString(new re(0,Math.PI,a.aAxis,a.bAxis,a.center)),yield this.ellipseToString(new re(Math.PI,Math.PI*2,a.aAxis,a.bAxis,a.center))):yield this.ellipseToString(a)}}function dG(s){return s.parEnd==Math.PI*2&&s.parStart==0}function Js(s){return Ic(s.x)+" "+Ic(s.y)}function Ic(s){return Math.abs(s)<1e-11?"0":s.toString()}function DA(s){return"C"+GA([s.B(1),s.B(2),s.B(3)])}function fG(s){let e=Math.abs(s.parEnd-s.parStart)>=Math.PI?"1":"0",t=s.orientedCounterclockwise()?"1":"0";return Vf.String.Join(" ","A",gG(s),Ic(f.angle(new f(1,0),s.aAxis)/(Math.PI/180)),e,t,Js(s.end))}function gG(s){return Ic(s.aAxis.length)+","+Ic(s.bAxis.length)}function GA(s){return Vf.String.Join(" ",s.map(e=>Js(e)))}function pG(s){if(s instanceof O)return mG(s);if(s instanceof we)return DA(s);if(s instanceof re)return fG(s);throw new Error("NotImplementedException")}function mG(s){return"L "+Js(s.end)}function Gf(s){return s?"rgba("+s.R+","+s.G+","+s.B+","+s.A/255+")":"Black"}function bG(s,e){let t=e.sub(s),i=t;t=t.normalize();let n=new f(-t.y,t.x),o=i.length*Math.tan(Tc.arrowAngle*.5*(Math.PI/180));return n=n.mul(o),[s.add(n),e,s.sub(n)]}function vc(s,e){let t=document.createElementNS(_f,e);return new yP(s,t),t}var kf=class{constructor(e=document.body){this._layoutOptions={};this._textMeasurer=new Ks,this._svgCreator=new Tc(e)}get graph(){return this._graph}setGraph(e,t=this._layoutOptions){if(this._graph===e)this.setOptions(t);else{this._graph=e,this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{});let i=Ai.getDrawingObj(e)||new Ai(e);i.createGeometry(this._textMeasurer.measure),Df(i,this._layoutOptions,!0),this._update()}}setOptions(e){let t=this._layoutOptions.label,i=e.label,n=!Ac(t,i);if(this._layoutOptions=e,!this._graph)return;let o=Ai.getDrawingObj(this._graph);n&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=n;Df(o,this._layoutOptions,a),this._update()}_update(){if(!!this._graph)return this._svgCreator.setGraph(this._graph)}};var PG=document.getElementById("viewer"),yG="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/cairo.gv",ea=new kf(PG),_A=CG();_A.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+_A.value;UA(s).then(e=>(ea.setGraph(e,Ol()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)};var FA=xG();FA.onchange=()=>{ea.setOptions(Ol())};var VA=EG();VA.onchange=()=>{ea.setOptions(Ol())};var kA=SG();kA.onchange=()=>{ea.setOptions(Ol())};o0("drop-target",async s=>{AG(s).then(e=>(ea.setGraph(e,Ol()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)});(async()=>{let s=await UA(yG);ea.setOptions(Ol()),ea.setGraph(s),document.getElementById("graph-name").innerText=s.id})();function SG(){let s=document.getElementById("fonts");for(let e of JS){let t=document.createElement("option");t.value=e,t.innerText=e,t.style.fontFamily=e,s.appendChild(t)}return s}function EG(){let s=document.getElementById("layouts");for(let e in lm){let t=document.createElement("option");t.value=e,t.innerText=lm[e],s.appendChild(t)}return s}function xG(){let s=document.getElementById("routings");for(let e in am){let t=document.createElement("option");t.value=e,t.innerText=am[e],s.appendChild(t)}return s}function CG(){let s=document.getElementById("gv");for(let e of KS){let t=document.createElement("option");t.value=`${e}.gv`,t.innerText=e,s.appendChild(t)}return s}function Ol(){let s={label:{fontFamily:kA.value}};switch(VA.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;default:break}switch(FA.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}async function UA(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),i;if(e.endsWith(".json")){let n=await t.json();i=Jh(n)}else{let n=await t.text();i=Kh(n)}return i.id=e,i}async function AG(s){let e=await s.text(),t;return s.name.endsWith(".json")?t=Jh(JSON.parse(e)):t=Kh(e),t.id=s.name,t}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)
   
   Copyright (c) .NET Foundation and Contributors
   
   All rights reserved.
   
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:
   
   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.
   
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   NOTE: The `murmur3` algorithm is public domain.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
