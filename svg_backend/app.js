(()=>{var UI=Object.create;var Ep=Object.defineProperty;var zI=Object.getOwnPropertyDescriptor;var WI=Object.getOwnPropertyNames;var HI=Object.getPrototypeOf,jI=Object.prototype.hasOwnProperty;var qI=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var de=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),XI=(s,e)=>{for(var t in e)Ep(s,t,{get:e[t],enumerable:!0})},YI=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of WI(e))!jI.call(s,i)&&i!==t&&Ep(s,i,{get:()=>e[i],enumerable:!(n=zI(e,i))||n.enumerable});return s};var ne=(s,e,t)=>(t=s!=null?UI(HI(s)):{},YI(e||!s||!s.__esModule?Ep(t,"default",{value:s,enumerable:!0}):t,s));var Sy=de((oF,yy)=>{"use strict";function $I(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function ls(s,e,t,n){this.message=s,this.expected=e,this.found=t,this.location=n,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,ls)}$I(ls,Error);ls.buildMessage=function(s,e){var t={literal:function(c){return'"'+i(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function n(c){return c.charCodeAt(0).toString(16).toUpperCase()}function i(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+n(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+n(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+n(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+n(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,f;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,f=1;d<h.length;d++)h[d-1]!==h[d]&&(h[f]=h[d],f++);h.length=f}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+i(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function QI(s,e){e=e!==void 0?e:{};var t={},n={start:ry},i=ry,o="strict",a=Ee("strict",!0),l="graph",u=Ee("graph",!0),c="digraph",h=Ee("digraph",!0),d="{",f=Ee("{",!1),y="}",S=Ee("}",!1),C=function(m,x,O,L){L===null&&(L=[]);var _={type:x.toLowerCase(),children:L};return m&&(_.strict=!0),O&&(_.id=O),_},T=";",I=Ee(";",!1),B=function(m,x){return x},w=function(m,x){return[m].concat(x)},M="=",F=Ee("=",!1),U=function(m,x){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:m,eq:x}]}},te="node",re=Ee("node",!0),J="edge",Pe=Ee("edge",!0),Ce=function(m,x){return{type:"attr_stmt",target:m,attr_list:x}},he="[",pe=Ee("[",!1),ie="]",Fr=Ee("]",!1),Ea=function(m,x){return(m||[]).concat(x||[])},uh=function(m,x){return x},ch=",",hh=Ee(",",!1),Xg=function(m,x,O){return[{type:"attr",id:m,eq:x}].concat(O||[])},Yg=function(m,x,O){var L=[m];return L=L.concat(x.map(function(_){return _.id})),{type:"edge_stmt",edge_list:L,attr_list:O||[]}},dh="->",$g=Ee("->",!1),jn="--",Qg=Ee("--",!1),Zg=function(m,x,O){return[{type:"edgeRHS",edgeop:m,id:x}].concat(O||[])},Kg=function(m,x){return{type:"node_stmt",node_id:m,attr_list:x||[]}},Jg=function(m,x){return x?{type:"node_id",id:m,port:x}:{type:"node_id",id:m}},ep=Xn("port"),eu=":",tu=Ee(":",!1),tp=function(m,x){return x},rp=function(m,x){return{type:"port",id:m,compass_pt:x||null}},np=function(m){return{type:"port",compass_pt:m||null}},ip="subgraph",ru=Ee("subgraph",!0),fh=function(m){return m?{type:"subgraph",id:m}:{type:"subgraph"}},nu=function(m,x){return m=m||{type:"subgraph"},m.children=x||[],m},gh="n",op=Ee("n",!1),ph="ne",iu=Ee("ne",!1),mh="e",xa=Ee("e",!1),bh="se",sp=Ee("se",!1),ho="s",ap=Ee("s",!1),Ph="sw",yh=Ee("sw",!1),Sh="w",lp=Ee("w",!1),Eh="nw",xh=Ee("nw",!1),up=Xn("UNICODE_STRING"),Ch=function(m,x){return m+x.join("")},cp=function(m,x){return m+x},hp="$",dp=Ee("$",!1),Ah="_",vh=Ee("_",!1),Ca=Xn("NUMBER"),Th="-",Ih=Ee("-",!1),ou=".",su=Ee(".",!1),Li=/^[0-9]/,Oi=Xr([["0","9"]],!1,!1),wh=function(m){return parseFloat(J0())},Lh=function(m){return{type:"id",value:m.slice(1,m.length-1),html:!0}},qr="<",fo=Ee("<",!1),au=">",Ri=Ee(">",!1),Aa=function(m){return"<"+m.join("")+">"},Er=pI(),Bi=function(m){return m},Oh=function(m){return m.join("")},as='"',lu=Ee('"',!1),Mi=function(m){return m.join("")},D=function(){return J0()},q="\\",Y=Ee("\\",!1),Q=function(m){return m[1]==='"'?'"':m[0]+m[1]},Ae=function(){return""},Ue=/^[\n\r\u2028\u2029]/,ze=Xr([`
`,"\r","\u2028","\u2029"],!1,!1),Rt=Xn("end of line"),go=`
`,Ni=Ee(`
`,!1),uu=`\r
`,Rh=Ee(`\r
`,!1),NT="\r",DT=Ee("\r",!1),GT="\u2028",_T=Ee("\u2028",!1),FT="\u2029",VT=Ee("\u2029",!1),kT=/^[^"\\\0-\x1F\x7F]/,UT=Xr(['"',"\\",["\0",""],"\x7F"],!0,!1),H0='\\"',zT=Ee('\\"',!1),WT=function(){return'"'},HT=function(){return"\\"},jT=Xn("COMMENT"),qT=Xn("BLOCK_COMMENT"),j0="/*",XT=Ee("/*",!1),va="*/",fp=Ee("*/",!1),q0=function(m){return m},YT=function(m){return m.join("")},$T=Xn("C_COMMENT"),X0="//",QT=Ee("//",!1),Ta=/^[\n]/,Ia=Xr([`
`],!1,!1),Y0=function(m){return m.join("")},ZT=Xn("MACRO_COMMENT"),KT="#",JT=Ee("#",!1),eI=Xn("WHITESPACE"),$0=/^[\n\r]/,Q0=Xr([`
`,"\r"],!1,!1),Z0=/^[ \t]/,K0=Xr([" ","	"],!1,!1),tI=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,rI=Xr([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),nI=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,iI=Xr([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),oI=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,sI=Xr(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),aI=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,lI=Xr(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),uI=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,cI=Xr([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),hI=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,dI=Xr([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),fI=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,gI=Xr([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),P=0,le=0,Bh=[{line:1,column:1}],qn=0,gp=[],G=0,Mh;if("startRule"in e){if(!(e.startRule in n))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');i=n[e.startRule]}function J0(){return s.substring(le,P)}function J_(){return cu(le,P)}function eF(m,x){throw x=x!==void 0?x:cu(le,P),ty([Xn(m)],s.substring(le,P),x)}function tF(m,x){throw x=x!==void 0?x:cu(le,P),bI(m,x)}function Ee(m,x){return{type:"literal",text:m,ignoreCase:x}}function Xr(m,x,O){return{type:"class",parts:m,inverted:x,ignoreCase:O}}function pI(){return{type:"any"}}function mI(){return{type:"end"}}function Xn(m){return{type:"other",description:m}}function ey(m){var x=Bh[m],O;if(x)return x;for(O=m-1;!Bh[O];)O--;for(x=Bh[O],x={line:x.line,column:x.column};O<m;)s.charCodeAt(O)===10?(x.line++,x.column=1):x.column++,O++;return Bh[m]=x,x}function cu(m,x){var O=ey(m),L=ey(x);return{start:{offset:m,line:O.line,column:O.column},end:{offset:x,line:L.line,column:L.column}}}function z(m){P<qn||(P>qn&&(qn=P,gp=[]),gp.push(m))}function bI(m,x){return new ls(m,null,null,x)}function ty(m,x,O){return new ls(ls.buildMessage(m,x),m,x,O)}function ry(){var m,x;if(m=[],x=ny(),x!==t)for(;x!==t;)m.push(x),x=ny();else m=t;return m}function ny(){var m,x,O,L,_,W,ee,ct,ht,$n,Yr,Sp,by;return m=P,x=Qe(),x!==t?(s.substr(P,6).toLowerCase()===o?(O=s.substr(P,6),P+=6):(O=t,G===0&&z(a)),O===t&&(O=null),O!==t?(L=Qe(),L!==t?(s.substr(P,5).toLowerCase()===l?(_=s.substr(P,5),P+=5):(_=t,G===0&&z(u)),_===t&&(s.substr(P,7).toLowerCase()===c?(_=s.substr(P,7),P+=7):(_=t,G===0&&z(h))),_!==t?(W=Qe(),W!==t?(ee=Yn(),ee===t&&(ee=null),ee!==t?(ct=Qe(),ct!==t?(s.charCodeAt(P)===123?(ht=d,P++):(ht=t,G===0&&z(f)),ht!==t?($n=iy(),$n===t&&($n=null),$n!==t?(Yr=Qe(),Yr!==t?(s.charCodeAt(P)===125?(Sp=y,P++):(Sp=t,G===0&&z(S)),Sp!==t?(by=Qe(),by!==t?(le=m,x=C(O,_,ee,$n),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function iy(){var m,x,O,L,_,W,ee,ct,ht,$n,Yr;if(m=P,x=Qe(),x!==t)if(O=pp(),O!==t)if(L=Qe(),L!==t)if(s.charCodeAt(P)===59?(_=T,P++):(_=t,G===0&&z(I)),_===t&&(_=null),_!==t){for(W=[],ee=P,ct=Qe(),ct!==t?(ht=pp(),ht!==t?($n=Qe(),$n!==t?(s.charCodeAt(P)===59?(Yr=T,P++):(Yr=t,G===0&&z(I)),Yr===t&&(Yr=null),Yr!==t?(le=ee,ct=B(O,ht),ee=ct):(P=ee,ee=t)):(P=ee,ee=t)):(P=ee,ee=t)):(P=ee,ee=t);ee!==t;)W.push(ee),ee=P,ct=Qe(),ct!==t?(ht=pp(),ht!==t?($n=Qe(),$n!==t?(s.charCodeAt(P)===59?(Yr=T,P++):(Yr=t,G===0&&z(I)),Yr===t&&(Yr=null),Yr!==t?(le=ee,ct=B(O,ht),ee=ct):(P=ee,ee=t)):(P=ee,ee=t)):(P=ee,ee=t)):(P=ee,ee=t);W!==t?(le=m,x=w(O,W),m=x):(P=m,m=t)}else P=m,m=t;else P=m,m=t;else P=m,m=t;else P=m,m=t;return m}function pp(){var m,x,O,L,_,W;return m=P,x=Yn(),x!==t?(O=Qe(),O!==t?(s.charCodeAt(P)===61?(L=M,P++):(L=t,G===0&&z(F)),L!==t?(_=Qe(),_!==t?(W=Yn(),W!==t?(le=m,x=U(x,W),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m===t&&(m=PI(),m===t&&(m=yI(),m===t&&(m=bp(),m===t&&(m=SI(),m===t&&(m=P,x=Yn(),x!==t?(s.charCodeAt(P)===61?(O=M,P++):(O=t,G===0&&z(F)),O!==t?(L=Yn(),L!==t?(x=[x,O,L],m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)))))),m}function PI(){var m,x,O;return m=P,s.substr(P,5).toLowerCase()===l?(x=s.substr(P,5),P+=5):(x=t,G===0&&z(u)),x===t&&(s.substr(P,4).toLowerCase()===te?(x=s.substr(P,4),P+=4):(x=t,G===0&&z(re)),x===t&&(s.substr(P,4).toLowerCase()===J?(x=s.substr(P,4),P+=4):(x=t,G===0&&z(Pe)))),x!==t?(O=Nh(),O!==t?(le=m,x=Ce(x,O),m=x):(P=m,m=t)):(P=m,m=t),m}function Nh(){var m,x,O,L,_,W,ee,ct,ht;return m=P,x=Qe(),x!==t?(s.charCodeAt(P)===91?(O=he,P++):(O=t,G===0&&z(pe)),O!==t?(L=Qe(),L!==t?(_=oy(),_===t&&(_=null),_!==t?(W=Qe(),W!==t?(s.charCodeAt(P)===93?(ee=ie,P++):(ee=t,G===0&&z(Fr)),ee!==t?(ct=Qe(),ct!==t?(ht=Nh(),ht===t&&(ht=null),ht!==t?(le=m,x=Ea(_,ht),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function oy(){var m,x,O,L,_,W,ee,ct;return m=P,x=Qe(),x!==t?(O=Yn(),O!==t?(L=P,_=Qe(),_!==t?(s.charCodeAt(P)===61?(W=M,P++):(W=t,G===0&&z(F)),W!==t?(ee=Qe(),ee!==t?(ct=Yn(),ct!==t?(le=L,_=uh(O,ct),L=_):(P=L,L=t)):(P=L,L=t)):(P=L,L=t)):(P=L,L=t),L===t&&(L=null),L!==t?(_=Qe(),_!==t?(s.charCodeAt(P)===44?(W=ch,P++):(W=t,G===0&&z(hh)),W===t&&(s.charCodeAt(P)===59?(W=T,P++):(W=t,G===0&&z(I))),W===t&&(W=null),W!==t?(ee=oy(),ee===t&&(ee=null),ee!==t?(le=m,x=Xg(O,L,ee),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function yI(){var m,x,O,L;return m=P,x=bp(),x===t&&(x=mp()),x!==t?(O=sy(),O!==t?(L=Nh(),L===t&&(L=null),L!==t?(le=m,x=Yg(x,O,L),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function sy(){var m,x,O,L,_,W,ee;return m=P,x=Qe(),x!==t?(s.substr(P,2)===dh?(O=dh,P+=2):(O=t,G===0&&z($g)),O===t&&(s.substr(P,2)===jn?(O=jn,P+=2):(O=t,G===0&&z(Qg))),O!==t?(L=Qe(),L!==t?(_=bp(),_===t&&(_=mp()),_!==t?(W=Qe(),W!==t?(ee=sy(),ee===t&&(ee=null),ee!==t?(le=m,x=Zg(O,_,ee),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function SI(){var m,x,O;return m=P,x=mp(),x!==t?(O=Nh(),O===t&&(O=null),O!==t?(le=m,x=Kg(x,O),m=x):(P=m,m=t)):(P=m,m=t),m}function mp(){var m,x,O;return m=P,x=Yn(),x!==t?(O=EI(),O===t&&(O=null),O!==t?(le=m,x=Jg(x,O),m=x):(P=m,m=t)):(P=m,m=t),m}function EI(){var m,x,O,L,_,W;return G++,m=P,s.charCodeAt(P)===58?(x=eu,P++):(x=t,G===0&&z(tu)),x!==t?(O=Yn(),O!==t?(L=P,s.charCodeAt(P)===58?(_=eu,P++):(_=t,G===0&&z(tu)),_!==t?(W=ay(),W!==t?(le=L,_=tp(O,W),L=_):(P=L,L=t)):(P=L,L=t),L===t&&(L=null),L!==t?(le=m,x=rp(O,L),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m===t&&(m=P,s.charCodeAt(P)===58?(x=eu,P++):(x=t,G===0&&z(tu)),x!==t?(O=ay(),O!==t?(le=m,x=np(O),m=x):(P=m,m=t)):(P=m,m=t)),G--,m===t&&(x=t,G===0&&z(ep)),m}function bp(){var m,x,O,L,_,W;return m=P,x=P,s.substr(P,8).toLowerCase()===ip?(O=s.substr(P,8),P+=8):(O=t,G===0&&z(ru)),O!==t?(L=Qe(),L!==t?(_=Yn(),_===t&&(_=null),_!==t?(W=Qe(),W!==t?(le=x,O=fh(_),x=O):(P=x,x=t)):(P=x,x=t)):(P=x,x=t)):(P=x,x=t),x===t&&(x=null),x!==t?(s.charCodeAt(P)===123?(O=d,P++):(O=t,G===0&&z(f)),O!==t?(L=iy(),L===t&&(L=null),L!==t?(_=Qe(),_!==t?(s.charCodeAt(P)===125?(W=y,P++):(W=t,G===0&&z(S)),W!==t?(le=m,x=nu(x,L),m=x):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t)):(P=m,m=t),m}function ay(){var m;return s.charCodeAt(P)===110?(m=gh,P++):(m=t,G===0&&z(op)),m===t&&(s.substr(P,2)===ph?(m=ph,P+=2):(m=t,G===0&&z(iu)),m===t&&(s.charCodeAt(P)===101?(m=mh,P++):(m=t,G===0&&z(xa)),m===t&&(s.substr(P,2)===bh?(m=bh,P+=2):(m=t,G===0&&z(sp)),m===t&&(s.charCodeAt(P)===115?(m=ho,P++):(m=t,G===0&&z(ap)),m===t&&(s.substr(P,2)===Ph?(m=Ph,P+=2):(m=t,G===0&&z(yh)),m===t&&(s.charCodeAt(P)===119?(m=Sh,P++):(m=t,G===0&&z(lp)),m===t&&(s.substr(P,2)===Eh?(m=Eh,P+=2):(m=t,G===0&&z(xh))))))))),m}function Yn(){var m;return m=ly(),m===t&&(m=xI(),m===t&&(m=hy(),m===t&&(m=AI(),m===t&&(m=CI())))),m}function ly(){var m,x,O,L;if(G++,m=P,x=uy(),x!==t){for(O=[],L=cy();L!==t;)O.push(L),L=cy();O!==t?(le=m,x=Ch(x,O),m=x):(P=m,m=t)}else P=m,m=t;return G--,m===t&&(x=t,G===0&&z(up)),m}function xI(){var m,x,O;return m=P,x=hy(),x!==t?(O=ly(),O!==t?(le=m,x=cp(x,O),m=x):(P=m,m=t)):(P=m,m=t),m}function uy(){var m;return m=MI(),m===t&&(s.charCodeAt(P)===36?(m=hp,P++):(m=t,G===0&&z(dp)),m===t&&(s.charCodeAt(P)===95?(m=Ah,P++):(m=t,G===0&&z(vh)))),m}function cy(){var m;return m=uy(),m===t&&(m=kI()),m}function hy(){var m,x,O,L,_,W,ee,ct,ht;if(G++,m=P,x=P,s.charCodeAt(P)===45?(O=Th,P++):(O=t,G===0&&z(Ih)),O===t&&(O=null),O!==t){if(L=P,s.charCodeAt(P)===46?(_=ou,P++):(_=t,G===0&&z(su)),_!==t){if(W=[],Li.test(s.charAt(P))?(ee=s.charAt(P),P++):(ee=t,G===0&&z(Oi)),ee!==t)for(;ee!==t;)W.push(ee),Li.test(s.charAt(P))?(ee=s.charAt(P),P++):(ee=t,G===0&&z(Oi));else W=t;W!==t?(_=[_,W],L=_):(P=L,L=t)}else P=L,L=t;if(L===t){if(L=P,_=[],Li.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Oi)),W!==t)for(;W!==t;)_.push(W),Li.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Oi));else _=t;if(_!==t){if(W=P,s.charCodeAt(P)===46?(ee=ou,P++):(ee=t,G===0&&z(su)),ee!==t){for(ct=[],Li.test(s.charAt(P))?(ht=s.charAt(P),P++):(ht=t,G===0&&z(Oi));ht!==t;)ct.push(ht),Li.test(s.charAt(P))?(ht=s.charAt(P),P++):(ht=t,G===0&&z(Oi));ct!==t?(ee=[ee,ct],W=ee):(P=W,W=t)}else P=W,W=t;W===t&&(W=null),W!==t?(_=[_,W],L=_):(P=L,L=t)}else P=L,L=t}L!==t?(O=[O,L],x=O):(P=x,x=t)}else P=x,x=t;return x!==t&&(le=m,x=wh(x)),m=x,G--,m===t&&(x=t,G===0&&z(Ca)),m}function CI(){var m,x;return m=P,x=Pp(),x!==t&&(le=m,x=Lh(x)),m=x,m}function Pp(){var m,x,O,L;if(m=P,s.charCodeAt(P)===60?(x=qr,P++):(x=t,G===0&&z(fo)),x!==t){for(O=[],L=dy(),L===t&&(L=Pp());L!==t;)O.push(L),L=dy(),L===t&&(L=Pp());O!==t?(s.charCodeAt(P)===62?(L=au,P++):(L=t,G===0&&z(Ri)),L!==t?(le=m,x=Aa(O),m=x):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return m}function dy(){var m,x,O,L,_;if(m=P,x=[],O=P,L=P,G++,s.charCodeAt(P)===62?(_=au,P++):(_=t,G===0&&z(Ri)),_===t&&(s.charCodeAt(P)===60?(_=qr,P++):(_=t,G===0&&z(fo))),G--,_===t?L=void 0:(P=L,L=t),L!==t?(s.length>P?(_=s.charAt(P),P++):(_=t,G===0&&z(Er)),_!==t?(le=O,L=Bi(_),O=L):(P=O,O=t)):(P=O,O=t),O!==t)for(;O!==t;)x.push(O),O=P,L=P,G++,s.charCodeAt(P)===62?(_=au,P++):(_=t,G===0&&z(Ri)),_===t&&(s.charCodeAt(P)===60?(_=qr,P++):(_=t,G===0&&z(fo))),G--,_===t?L=void 0:(P=L,L=t),L!==t?(s.length>P?(_=s.charAt(P),P++):(_=t,G===0&&z(Er)),_!==t?(le=O,L=Bi(_),O=L):(P=O,O=t)):(P=O,O=t);else x=t;return x!==t&&(le=m,x=Oh(x)),m=x,m}function AI(){var m,x,O,L;if(m=P,s.charCodeAt(P)===34?(x=as,P++):(x=t,G===0&&z(lu)),x!==t){for(O=[],L=fy();L!==t;)O.push(L),L=fy();O!==t?(s.charCodeAt(P)===34?(L=as,P++):(L=t,G===0&&z(lu)),L!==t?(le=m,x=Mi(O),m=x):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return m}function fy(){var m,x,O;return m=vI(),m===t&&(m=P,x=P,G++,s.charCodeAt(P)===34?(O=as,P++):(O=t,G===0&&z(lu)),O===t&&(O=II()),G--,O===t?x=void 0:(P=x,x=t),x!==t?(O=LI(),O!==t?(le=m,x=D(),m=x):(P=m,m=t)):(P=m,m=t),m===t&&(m=TI())),m}function vI(){var m,x,O,L;return m=P,x=P,s.charCodeAt(P)===92?(O=q,P++):(O=t,G===0&&z(Y)),O!==t?(s.length>P?(L=s.charAt(P),P++):(L=t,G===0&&z(Er)),L!==t?(O=[O,L],x=O):(P=x,x=t)):(P=x,x=t),x!==t&&(le=m,x=Q(x)),m=x,m}function TI(){var m,x,O;return m=P,s.charCodeAt(P)===92?(x=q,P++):(x=t,G===0&&z(Y)),x!==t?(O=wI(),O!==t?(le=m,x=Ae(),m=x):(P=m,m=t)):(P=m,m=t),m}function II(){var m;return Ue.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(ze)),m}function wI(){var m,x;return G++,s.charCodeAt(P)===10?(m=go,P++):(m=t,G===0&&z(Ni)),m===t&&(s.substr(P,2)===uu?(m=uu,P+=2):(m=t,G===0&&z(Rh)),m===t&&(s.charCodeAt(P)===13?(m=NT,P++):(m=t,G===0&&z(DT)),m===t&&(s.charCodeAt(P)===8232?(m=GT,P++):(m=t,G===0&&z(_T)),m===t&&(s.charCodeAt(P)===8233?(m=FT,P++):(m=t,G===0&&z(VT)))))),G--,m===t&&(x=t,G===0&&z(Rt)),m}function LI(){var m;return s.length>P?(m=s.charAt(P),P++):(m=t,G===0&&z(Er)),m}function rF(){var m,x,O;if(m=P,x=[],O=gy(),O!==t)for(;O!==t;)x.push(O),O=gy();else x=t;return x!==t&&(le=m,x=Mi(x)),m=x,m}function gy(){var m,x,O;return kT.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(UT)),m===t&&(m=P,s.substr(P,2)===H0?(x=H0,P+=2):(x=t,G===0&&z(zT)),x!==t&&(le=m,x=WT()),m=x,m===t&&(m=P,s.charCodeAt(P)===92?(x=q,P++):(x=t,G===0&&z(Y)),x!==t?(O=yp(),O!==t?(le=m,x=Ae(),m=x):(P=m,m=t)):(P=m,m=t),m===t&&(m=P,s.charCodeAt(P)===92?(x=q,P++):(x=t,G===0&&z(Y)),x!==t&&(le=m,x=HT()),m=x))),m}function py(){var m,x;return G++,m=OI(),m===t&&(m=RI(),m===t&&(m=BI())),G--,m===t&&(x=t,G===0&&z(jT)),m}function OI(){var m,x,O,L,_,W;if(G++,m=P,s.substr(P,2)===j0?(x=j0,P+=2):(x=t,G===0&&z(XT)),x!==t){for(O=[],L=P,_=P,G++,s.substr(P,2)===va?(W=va,P+=2):(W=t,G===0&&z(fp)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=q0(W),L=_):(P=L,L=t)):(P=L,L=t);L!==t;)O.push(L),L=P,_=P,G++,s.substr(P,2)===va?(W=va,P+=2):(W=t,G===0&&z(fp)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=q0(W),L=_):(P=L,L=t)):(P=L,L=t);O!==t?(s.substr(P,2)===va?(L=va,P+=2):(L=t,G===0&&z(fp)),L!==t?(le=m,x=YT(O),m=x):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return G--,m===t&&(x=t,G===0&&z(qT)),m}function RI(){var m,x,O,L,_,W;if(G++,m=P,s.substr(P,2)===X0?(x=X0,P+=2):(x=t,G===0&&z(QT)),x!==t){for(O=[],L=P,_=P,G++,Ta.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Ia)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=Bi(W),L=_):(P=L,L=t)):(P=L,L=t);L!==t;)O.push(L),L=P,_=P,G++,Ta.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Ia)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=Bi(W),L=_):(P=L,L=t)):(P=L,L=t);O!==t?(Ta.test(s.charAt(P))?(L=s.charAt(P),P++):(L=t,G===0&&z(Ia)),L===t&&(L=null),L!==t?(le=m,x=Y0(O),m=x):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return G--,m===t&&(x=t,G===0&&z($T)),m}function BI(){var m,x,O,L,_,W;if(G++,m=P,s.charCodeAt(P)===35?(x=KT,P++):(x=t,G===0&&z(JT)),x!==t){for(O=[],L=P,_=P,G++,Ta.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Ia)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=Bi(W),L=_):(P=L,L=t)):(P=L,L=t);L!==t;)O.push(L),L=P,_=P,G++,Ta.test(s.charAt(P))?(W=s.charAt(P),P++):(W=t,G===0&&z(Ia)),G--,W===t?_=void 0:(P=_,_=t),_!==t?(s.length>P?(W=s.charAt(P),P++):(W=t,G===0&&z(Er)),W!==t?(le=L,_=Bi(W),L=_):(P=L,L=t)):(P=L,L=t);O!==t?(Ta.test(s.charAt(P))?(L=s.charAt(P),P++):(L=t,G===0&&z(Ia)),L===t&&(L=null),L!==t?(le=m,x=Y0(O),m=x):(P=m,m=t)):(P=m,m=t)}else P=m,m=t;return G--,m===t&&(x=t,G===0&&z(ZT)),m}function Qe(){var m,x;for(G++,m=[],x=my(),x===t&&(x=py());x!==t;)m.push(x),x=my(),x===t&&(x=py());return G--,m===t&&(x=t,G===0&&z(eI)),m}function yp(){var m,x;if(m=[],$0.test(s.charAt(P))?(x=s.charAt(P),P++):(x=t,G===0&&z(Q0)),x!==t)for(;x!==t;)m.push(x),$0.test(s.charAt(P))?(x=s.charAt(P),P++):(x=t,G===0&&z(Q0));else m=t;return m}function my(){var m,x;if(m=[],Z0.test(s.charAt(P))?(x=s.charAt(P),P++):(x=t,G===0&&z(K0)),x===t&&(x=yp()),x!==t)for(;x!==t;)m.push(x),Z0.test(s.charAt(P))?(x=s.charAt(P),P++):(x=t,G===0&&z(K0)),x===t&&(x=yp());else m=t;return m}function MI(){var m;return m=FI(),m===t&&(m=NI(),m===t&&(m=_I(),m===t&&(m=DI(),m===t&&(m=GI(),m===t&&(m=VI()))))),m}function NI(){var m;return tI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(rI)),m}function DI(){var m;return nI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(iI)),m}function GI(){var m;return oI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(sI)),m}function _I(){var m;return aI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(lI)),m}function FI(){var m;return uI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(cI)),m}function VI(){var m;return hI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(dI)),m}function kI(){var m;return fI.test(s.charAt(P))?(m=s.charAt(P),P++):(m=t,G===0&&z(gI)),m}if(Mh=i(),Mh!==t&&P===s.length)return Mh;throw Mh!==t&&P<s.length&&z(mI()),ty(gp,qn<s.length?s.charAt(qn):null,qn<s.length?cu(qn,qn+1):cu(qn,qn))}yy.exports={SyntaxError:ls,parse:QI}});var xy=de((sF,Ey)=>{var ZI=Sy();Ey.exports=ZI.parse});var xp=de(Dh=>{"use strict";Object.defineProperty(Dh,"__esModule",{value:!0});var Cy=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,n=!1){if(n&&this.isDuplicate(e))return!1;let i=new hu(e),o=this._head;if(o)for(;;){if(o.value===t)return i.next=o.next,i.prev=o,o.next=i,i.next?i.next.prev=i:this._tail=i,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let n=new hu(e);return this._tail?(this._tail.next=n,n.prev=this._tail,this._tail=n):this._head=this._tail=n,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let n=new hu(e);return this._head?(n.next=this._head,this._head.prev=n,this._head=n):this._head=this._tail=n,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),n=[],i=Math.min(e,this.length);for(let o=0;o<i;o++){let a=t.next();n.push(a.value)}return n}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Dh.LinkedList=Cy;var hu=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Dh.LinkedListItem=hu});var po=de(Cp=>{"use strict";Object.defineProperty(Cp,"__esModule",{value:!0});var KI=xp(),Ay=class extends KI.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};Cp.Queue=Ay});var fn=de(Op=>{"use strict";Object.defineProperty(Op,"__esModule",{value:!0});var sw=xp(),Ly=class extends sw.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};Op.Stack=Ly});var Tt=de(So=>{"use strict";var Wh=So&&So.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var n=Array(s),i=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,i++)n[i]=o[a];return n};Object.defineProperty(So,"__esModule",{value:!0});So.StringBuilder=So.String=void 0;var Ma=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{var i=t[0];if(Array.isArray(i)||i instanceof Array){for(var o=s.Empty,a=0,l=0;l<i.length;l++){var u=i[l];l<i.length-1?o+=u+e:o+=u}return o}else if(typeof i=="object"){var c=s.Empty,h=i,d=Object.keys(i);return d.forEach(function(y){c+=h[y]+e}),c=c.slice(0,c.length-e.length),c}var f=t;return s.join.apply(s,Wh([e],f))}catch(y){return console.log(y),s.Empty}},s.Format=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(i){return console.log(i),s.Empty}},s.format=function(e,t,n,i){return i===void 0&&(i=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return i?u=n[0][a]:u=n[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var n=t.replace(/,/g,".");if(isNaN(parseFloat(n))||n.length<=3)break;var i=n.split(/[^0-9]+/g),o=i;i.length>1&&(o=[s.join.apply(s,Wh([""],i.splice(0,i.length-1))),i[i.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var n=parseFloat(e),i=n.toString(16);return t?i.toLocaleUpperCase():i},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var n=t[t.length-1],i=t[t.length-2],o=t[t.length-3];return n=n.split("T")[0],n=n.split(" ")[0],n+"."+i+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var n=t[t.length-1].split(" "),i=s.Empty;n.length>1&&(i=n[n.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(i)&&i.length>1?u+="T"+i:u+="T00:00:00",u},s.formatNumber=function(e,t){var n=t.length,i=e.toString();if(n<=i.length)return i;var o=n-i.length;return o+=1,new Array(o).join("0")+i},s.join=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var i=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];i+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){i+=e,o=l-1;break}}return i},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();So.String=Ma;var dw=function(){function s(e){this.Values=[],Ma.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.Values.push(Ma.Format.apply(Ma,Wh([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.Values.push(`\r
`+Ma.Format.apply(Ma,Wh([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();So.StringBuilder=dw});var Eo=de(Fe=>{"use strict";Object.defineProperty(Fe,"__esModule",{value:!0});Fe.isPrimitive=Fe.isPropertyKey=Fe.isString=Fe.isBoolean=Fe.isNumber=Fe.isIterator=Fe.isAsyncIterable=Fe.isIterable=Fe.isDefined=Fe.isMissing=Fe.isInstance=Fe.isObject=Fe.isFunctionOrUndefined=Fe.isFunction=void 0;function Uy(s){return typeof s=="function"}Fe.isFunction=Uy;function Hh(s){return typeof s=="function"||s===void 0}Fe.isFunctionOrUndefined=Hh;function zy(s){return typeof s=="object"&&s!==null||typeof s=="function"}Fe.isObject=zy;function pw(s,e){return!Wy(s)&&s instanceof e}Fe.isInstance=pw;function Wy(s){return s==null}Fe.isMissing=Wy;function mw(s){return s!=null}Fe.isDefined=mw;function bw(s){return s!=null&&Symbol.iterator in Object(s)}Fe.isIterable=bw;function Pw(s){return s!=null&&Symbol.asyncIterator in Object(s)}Fe.isAsyncIterable=Pw;function yw(s){return zy(s)&&Uy(s.next)&&Hh(s.throw)&&Hh(s.return)&&Hh(s[Symbol.iterator])}Fe.isIterator=yw;function Sw(s){return typeof s=="number"}Fe.isNumber=Sw;function Ew(s){return typeof s=="boolean"}Fe.isBoolean=Ew;function xw(s){return typeof s=="string"}Fe.isString=xw;function Cw(s){return typeof s=="string"||typeof s=="symbol"||typeof s=="number"}Fe.isPropertyKey=Cw;function Aw(s){return typeof s!="function"&&(typeof s!="object"||s===null)}Fe.isPrimitive=Aw});var _p=de(jh=>{"use strict";Object.defineProperty(jh,"__esModule",{value:!0});jh.binarySearch=void 0;function vw(s,e,t){if(s.length===0)return-1;let n=0,i=s.length-1;for(;n<=i;){let o=n+(i-n>>1),a=s[o];switch(Math.sign(t.compare(a,e))){case-1:n=o+1;break;case 0:return o;case 1:i=o-1;break}}return~n}jh.binarySearch=vw});var Hy=de(Fa=>{"use strict";Object.defineProperty(Fa,"__esModule",{value:!0});Fa.deprecateProperty=Fa.deprecate=void 0;function Tw(){try{return qI("util").deprecate}catch{}}function Iw(){let s=typeof process=="object"&&typeof process.emitWarning=="function"?function e(t,n="Warning",i=e){process.emitWarning(t,n,i)}:typeof Error.captureStackTrace=="function"?function e(t,n="Warning",i=e){typeof t=="string"&&(t=new Error(t),t.name=n),Error.captureStackTrace(t,i),console.warn(t)}:function(t,n="Warning"){typeof t=="string"?console.warn(`${n}:`,t):console.warn(t)};return(e,t)=>{let n=!1;function i(...o){return n||(n=!0,s(t,"DeprecationWarning",e)),new.target?Reflect.construct(e,o,new.target):e.apply(this,o)}return Object.setPrototypeOf(i,e),e.prototype&&(i.prototype=e.prototype),i}}var ww=Tw()||Iw();function qh(s,e){return ww(s,e)}Fa.deprecate=qh;function Lw(s,e,t){let n=Object.getOwnPropertyDescriptor(s,e);if(n&&n.configurable){let i=!1;n.get&&(n.get=qh(n.get,t),i=!0),n.set&&(n.set=qh(n.set,t),i=!0),typeof n.value=="function"&&(n.value=qh(n.value,t),i=!0),i&&Object.defineProperty(s,e,n)}return s}Fa.deprecateProperty=Lw});var ps=de(qe=>{"use strict";Object.defineProperty(qe,"__esModule",{value:!0});qe.KeyedMultiCollection=qe.ReadonlyKeyedMultiCollection=qe.KeyedCollection=qe.ReadonlyKeyedCollection=qe.IndexedCollection=qe.FixedSizeIndexedCollection=qe.ReadonlyIndexedCollection=qe.Collection=qe.ReadonlyCollection=void 0;var Xh=Eo(),Mt=Hy(),ur;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has");function e(n){return Xh.isIterable(n)&&s.size in n&&s.has in n}s.isReadonlyCollection=e,s.name="ReadonlyCollection";function t(n){return Xh.isIterable(n)&&s.size in n&&s.has in n}s.hasInstance=t})(ur=qe.ReadonlyCollection||(qe.ReadonlyCollection={}));var fs;(function(s){s.size=ur.size,s.has=ur.has,s.isReadonlyCollection=ur.isReadonlyCollection,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.clear=Symbol.for("@esfx/collection-core!Collection.clear");function e(n){return s.hasInstance(n)}s.isCollection=e,s.name="Collection";function t(n){return ur.hasInstance(n)&&s.add in n&&s.delete in n&&s.clear in n}s.hasInstance=t})(fs=qe.Collection||(qe.Collection={}));var ti;(function(s){s.size=ur.size,s.has=ur.has,s.isReadonlyCollection=ur.isReadonlyCollection,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt");function e(n){return s.hasInstance(n)}s.isReadonlyIndexedCollection=e,s.name="ReadonlyIndexedCollection";function t(n){return ur.hasInstance(n)&&s.indexOf in n&&s.getAt in n}s.hasInstance=t})(ti=qe.ReadonlyIndexedCollection||(qe.ReadonlyIndexedCollection={}));var gs;(function(s){s.size=ur.size,s.has=ur.has,s.isReadonlyCollection=ur.isReadonlyCollection,s.indexOf=ti.indexOf,s.getAt=ti.getAt,s.isReadonlyIndexedCollection=ti.isReadonlyIndexedCollection,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt");function e(n){return s.hasInstance(n)}s.isFixedSizeIndexedCollection=e,s.name="FixedSizeIndexedCollection";function t(n){return ti.hasInstance(n)&&s.setAt in n}s.hasInstance=t})(gs=qe.FixedSizeIndexedCollection||(qe.FixedSizeIndexedCollection={}));var Va;(function(s){s.size=ur.size,s.has=ur.has,s.isReadonlyCollection=ur.isReadonlyCollection,s.indexOf=ti.indexOf,s.getAt=ti.getAt,s.isReadonlyIndexedCollection=ti.isReadonlyIndexedCollection,s.setAt=gs.setAt,s.isFixedSizeIndexedCollection=gs.isFixedSizeIndexedCollection,s.add=fs.add,s.delete=fs.delete,s.clear=fs.clear,s.isCollection=fs.isCollection,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt");function e(n){return s.hasInstance(n)}s.isIndexedCollection=e,s.name="IndexedCollection";function t(n){return gs.hasInstance(n)&&s.insertAt in n&&s.removeAt in n}s.hasInstance=t})(Va=qe.IndexedCollection||(qe.IndexedCollection={}));var _i;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values");function e(n){return s.hasInstance(n)}s.isReadonlyKeyedCollection=e,s.name="ReadonlyKeyedCollection";function t(n){return Xh.isIterable(n)&&s.size in n&&s.has in n&&s.get in n&&s.keys in n&&s.values in n}s.hasInstance=t})(_i=qe.ReadonlyKeyedCollection||(qe.ReadonlyKeyedCollection={}));var Fp;(function(s){s.size=_i.size,s.has=_i.has,s.get=_i.get,s.keys=_i.keys,s.values=_i.values,s.isReadonlyKeyedCollection=_i.isReadonlyKeyedCollection,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear");function e(n){return s.hasInstance(n)}s.isKeyedCollection=e,s.name="KeyedCollection";function t(n){return _i.hasInstance(n)&&s.set in n&&s.delete in n&&s.clear in n}s.hasInstance=t})(Fp=qe.KeyedCollection||(qe.KeyedCollection={}));var ei;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values");function e(n){return s.hasInstance(n)}s.isReadonlyKeyedMultiCollection=e,s.name="ReadonlyKeyedMultiCollection";function t(n){return Xh.isIterable(n)&&s.size in n&&s.has in n&&s.hasValue in n&&s.get in n&&s.keys in n&&s.values in n}s.hasInstance=t})(ei=qe.ReadonlyKeyedMultiCollection||(qe.ReadonlyKeyedMultiCollection={}));var Vp;(function(s){s.size=ei.size,s.has=ei.has,s.hasValue=ei.hasValue,s.get=ei.get,s.keys=ei.keys,s.values=ei.values,s.isReadonlyKeyedMultiCollection=ei.isReadonlyKeyedMultiCollection,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear");function e(n){return s.hasInstance(n)}s.isKeyedMultiCollection=e,s.name="KeyedMultiCollection";function t(n){return ei.hasInstance(n)&&s.add in n&&s.delete in n&&s.deleteValue in n&&s.clear in n}s.hasInstance=t})(Vp=qe.KeyedMultiCollection||(qe.KeyedMultiCollection={}));Mt.deprecateProperty(ur,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Mt.deprecateProperty(fs,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Mt.deprecateProperty(fs,"isCollection","Use 'Collection.hasInstance' instead.");Mt.deprecateProperty(ti,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Mt.deprecateProperty(ti,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Mt.deprecateProperty(gs,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Mt.deprecateProperty(gs,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Mt.deprecateProperty(gs,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");Mt.deprecateProperty(Va,"isReadonlyCollection","Use 'ReadonlyCollection.hasInstance' instead.");Mt.deprecateProperty(Va,"isReadonlyIndexedCollection","Use 'ReadonlyIndexedCollection.hasInstance' instead.");Mt.deprecateProperty(Va,"isFixedSizeIndexedCollection","Use 'FixedSizeIndexedCollection.hasInstance' instead.");Mt.deprecateProperty(Va,"isCollection","Use 'Collection.hasInstance' instead.");Mt.deprecateProperty(Va,"isIndexedCollection","Use 'IndexedCollection.hasInstance' instead.");Mt.deprecateProperty(_i,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");Mt.deprecateProperty(Fp,"isReadonlyKeyedCollection","Use 'ReadonlyKeyedCollection.hasInstance' instead.");Mt.deprecateProperty(Fp,"isKeyedCollection","Use 'KeyedCollection.hasInstance' instead.");Mt.deprecateProperty(ei,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");Mt.deprecateProperty(Vp,"isReadonlyKeyedMultiCollection","Use 'ReadonlyKeyedMultiCollection.hasInstance' instead.");Mt.deprecateProperty(Vp,"isKeyedMultiCollection","Use 'KeyedMultiCollection.hasInstance' instead.")});var Yy=de(xo=>{"use strict";Object.defineProperty(xo,"__esModule",{value:!0});xo.hash=xo.defaultSeed=xo.createSeed=void 0;function Xy(){return Math.random()*4294967295>>>0}xo.createSeed=Xy;xo.defaultSeed=Xy();var jy=3432918353,qy=461845907,Ow=3864292196;function Rw(s,e){let t=new DataView(s),n=e>>>0,i=0,o;for(;i<t.byteLength-4;)o=t.getUint32(i,!0),o*=jy,o=o<<15|o>>>17,o*=qy,n^=o,n=n<<13|n>>>19,n=n*5+Ow,i+=4;if(i<t.byteLength){switch(o=0,t.byteLength-i){case 3:o|=t.getUint8(i+2)<<16;case 2:o|=t.getUint8(i+1)<<8;case 1:o|=t.getUint8(i+0)<<0}o*=jy,o=o<<15|o>>>17,o*=qy,n^=o}return n^=t.byteLength,n^=n>>>16,n*=2246822507,n^=n>>>13,n*=3266489909,n^=n>>>16,n}xo.hash=Rw});var nS=de(ka=>{"use strict";Object.defineProperty(ka,"__esModule",{value:!0});ka.hashUnknown=void 0;var Ua=Yy(),ms,Yh,xu,bs,Ps,ys,Qy=2**31-1,Bw=~Qy,Mw=2**32-1,Nw=0,kp=new DataView(new ArrayBuffer(8)),Zy=Ua.createSeed(),Ky=Ua.createSeed(),Jy=Ua.createSeed(),eS=Ua.createSeed(),tS=Ua.createSeed(),Up=Zy,zp=Ky,Wp=tS,Hp=Jy,jp=eS;function Dw(s){return s?1:0}function Gw(s){return Number.isInteger(s)&&s>=Bw&&s<=Qy}function _w(s){return Number.isInteger(s)&&s>=Nw&&s<=Mw}function Fw(s){return s>>0}function Vw(s){return kp.setFloat64(0,s),kp.getInt32(0,!0)^kp.getInt32(4,!0)}function kw(s){return Gw(s)?s:_w(s)?Fw(s):Vw(s)}function Uw(s,e){let t=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);return Ua.hash(t,e)}function $h(s,e,t){if(!Buffer.isEncoding(e))throw new RangeError(`Invalid encoding: ${e}`);return Uw(Buffer.from(s,e),t)}function qp(s,e){return(s<<7|s>>>25)^e}function zw(){let s=BigInt(0),e=BigInt(4294967295),t=BigInt(32);function n(i){if(i===s)return 0;let o=i<s?-1:i>s?1:0;for(i<s&&(i=-i);i!==s;)o=qp(o,Number(i&e)),i=i>>t;return o}return n}function Ww(){function s(e){return $h(e.toString(),"ascii",Wp)}return s}var Hw=typeof BigInt=="function"?zw():Ww();function jw(s){return $h(s,"utf8",zp)}function qw(s,e){let t=Ps&&Ps.get(s);return t===void 0&&(t=$h(e,"utf8",jp),Ps||(Ps=new Map),Ps.set(s,t)),t}var Xw="description"in Symbol.prototype?s=>s.description:s=>{let e=s.toString();return e.startsWith("Symbol(")&&e.endsWith(")")?e.slice(7,-1):e};function Yw(s){let e=ys&&ys.get(s);if(e===void 0){xu||(xu={next:1}),e=qp(Hp,xu.next++);let t=Xw(s);t&&(e=$h(t,"utf8",e)),ys||(ys=new Map),ys.set(s,e)}return e}function $w(s){let e=Symbol.keyFor(s);return e!==void 0?qw(s,e):Yw(s)}function Qw(s){let e;return s===null?e=Yh||(Yh={next:1}):(e=ms&&ms.get(s),e||(ms||(ms=new WeakMap),ms.set(s,e={next:1}))),e}function $y(s){let e=bs&&bs.get(s);return e===void 0&&(bs||(bs=new WeakMap),e=Qw(Object.getPrototypeOf(s)).next++,e=qp(Up,e),bs.set(s,e)),e}function rS(s){switch(typeof s){case"boolean":return Dw(s);case"number":return kw(s);case"bigint":return Hw(s);case"string":return jw(s);case"symbol":return $w(s);case"function":return $y(s);case"object":if(s!==null)return $y(s);case"undefined":default:return 0}}ka.hashUnknown=rS;(function(s){function e(){return{weakPrototypeCounters:ms,nullPrototypeCounter:Yh,localSymbolCounter:xu,weakObjectHashes:bs,globalSymbolHashes:Ps,localSymbolHashes:ys,objectSeed:Up,stringSeed:zp,bigIntSeed:Wp,localSymbolSeed:Hp,globalSymbolSeed:jp}}s.getState=e;function t(n){({weakPrototypeCounters:ms,nullPrototypeCounter:Yh,localSymbolCounter:xu,weakObjectHashes:bs,globalSymbolHashes:Ps,localSymbolHashes:ys,objectSeed:Up=Zy,stringSeed:zp=Ky,bigIntSeed:Wp=tS,localSymbolSeed:Hp=Jy,globalSymbolSeed:jp=eS}=n)}s.setState=t})(rS=ka.hashUnknown||(ka.hashUnknown={}))});var Ss=de(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.rawHash=ue.tupleStructuralComparer=ue.tupleComparer=ue.structuralComparer=ue.defaultComparer=ue.Comparer=ue.combineHashes=ue.tupleStructuralEqualer=ue.tupleEqualer=ue.structuralEqualer=ue.defaultEqualer=ue.Equaler=ue.StructuralComparable=ue.StructuralEquatable=ue.Comparable=ue.Equatable=void 0;var iS=nS(),Co;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let n;return t!=null&&s.equals in(n=Object(t))&&s.hash in n}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Co=ue.Equatable||(ue.Equatable={}));(function(s){let e=Qh("Use 'Equatable.hasInstance' instead.");function t(n){return e(),s.hasInstance(n)}s.isEquatable=t})(Co=ue.Equatable||(ue.Equatable={}));var za;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(za=ue.Comparable||(ue.Comparable={}));(function(s){let e=Qh("Use 'Comparable.hasInstance' instead.");function t(n){return e(),s.hasInstance(n)}s.isComparable=t})(za=ue.Comparable||(ue.Comparable={}));var Ao;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let n;return t!=null&&s.structuralEquals in(n=Object(t))&&s.structuralHash in n}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Ao=ue.StructuralEquatable||(ue.StructuralEquatable={}));(function(s){let e=Qh("Use 'StructuralEquatable.hasInstance' instead.");function t(n){return e(),s.hasInstance(n)}s.isStructuralEquatable=t})(Ao=ue.StructuralEquatable||(ue.StructuralEquatable={}));var Wa;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Wa=ue.StructuralComparable||(ue.StructuralComparable={}));(function(s){let e=Qh("Use 'StructuralComparable.hasInstance' instead.");function t(n){return e(),s.hasInstance(n)}s.isStructuralComparable=t})(Wa=ue.StructuralComparable||(ue.StructuralComparable={}));var Ha;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>Co.hasInstance(o)?o[Co.equals](a):Co.hasInstance(a)?a[Co.equals](o):Object.is(o,a),o=>Co.hasInstance(o)?o[Co.hash]():iS.hashUnknown(o)),s.structuralEqualer=t((o,a)=>Ao.hasInstance(o)?o[Ao.structuralEquals](a,s.structuralEqualer):Ao.hasInstance(a)?a[Ao.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>Ao.hasInstance(o)?o[Ao.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=n(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(!Array.isArray(o)&&o!==null&&o!==void 0||!Array.isArray(a)&&a!==null&&a!==void 0)throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=n(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function n(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=n;function i(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(Ha=ue.Equaler||(ue.Equaler={}));ue.defaultEqualer=Ha.defaultEqualer;ue.structuralEqualer=Ha.structuralEqualer;ue.tupleEqualer=Ha.tupleEqualer;ue.tupleStructuralEqualer=Ha.tupleEqualer;ue.combineHashes=Ha.combineHashes;var Cu;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((i,o)=>za.hasInstance(i)?i[za.compareTo](o):za.hasInstance(o)?-o[za.compareTo](i):i<o?-1:i>o?1:0),s.structuralComparer=t((i,o)=>Wa.hasInstance(i)?i[Wa.structuralCompareTo](o,s.structuralComparer):Wa.hasInstance(o)?-o[Wa.structuralCompareTo](i,s.structuralComparer):s.defaultComparer.compare(i,o)),s.tupleComparer=t((i,o)=>{if(!Array.isArray(i)&&i!==null&&i!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(i.length,o.length))return a;for(let l=0;l<i.length;l++)if(a=s.defaultComparer.compare(i[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((i,o)=>{if(!Array.isArray(i)&&i!==null&&i!==void 0||!Array.isArray(o)&&o!==null&&o!==void 0)throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(i.length,o.length))return a;for(let l=0;l<i.length;l++)if(a=s.structuralComparer.compare(i[l],o[l]))return a;return 0});function t(i){return Object.setPrototypeOf({compare:i},e)}s.create=t;function n(i){return typeof i=="object"&&i!==null&&typeof i.compare=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(Cu=ue.Comparer||(ue.Comparer={}));ue.defaultComparer=Cu.defaultComparer;ue.structuralComparer=Cu.structuralComparer;ue.tupleComparer=Cu.tupleComparer;ue.tupleStructuralComparer=Cu.tupleStructuralComparer;function Zw(s){return iS.hashUnknown(s)}ue.rawHash=Zw;function Qh(s){let e=!1;return()=>{e||(e=!0,typeof process=="object"&&process.emitWarning?process.emitWarning(s,"Deprecation"):typeof console=="object"&&console.warn(`Deprecation: ${s}`))}}});var Au=de(Kh=>{"use strict";Object.defineProperty(Kh,"__esModule",{value:!0});Kh.SortedMap=void 0;var Kw=Eo(),Zh=_p(),vo=ps(),oS=Ss(),Xp=class{constructor(...e){this._keys=[],this._values=[];let t,n;if(e.length>0){let i=e[0];Kw.isIterable(i)||i===void 0?(t=i,e.length>1&&(n=e[1])):n=i}if(n===void 0&&(n=oS.Comparer.defaultComparer),this._comparer=typeof n=="function"?oS.Comparer.create(n):n,t)for(let[i,o]of t)this.set(i,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return Zh.binarySearch(this._keys,e,this._comparer)>=0}get(e){let t=Zh.binarySearch(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let n=Zh.binarySearch(this._keys,e,this._comparer);return n>=0?this._values[n]=t:(this._keys.splice(~n,0,e),this._values.splice(~n,0,t)),this}delete(e){let t=Zh.binarySearch(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[n,i]of this)e.call(t,i,n,this)}get[vo.KeyedCollection.size](){return this.size}[vo.KeyedCollection.has](e){return this.has(e)}[vo.KeyedCollection.get](e){return this.get(e)}[vo.KeyedCollection.set](e,t){this.set(e,t)}[vo.KeyedCollection.delete](e){return this.delete(e)}[vo.KeyedCollection.clear](){this.clear()}[vo.KeyedCollection.keys](){return this.keys()}[vo.KeyedCollection.values](){return this.values()}};Kh.SortedMap=Xp;Object.defineProperty(Xp,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedMap"})});var dE=de((iZ,Dd)=>{var qS,XS,YS,$S,QS,ZS,KS,JS,eE,Md,zm,tE,rE,nE,ol,iE,oE,sE,aE,lE,uE,cE,hE,Nd;(function(s){var e=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(n){s(t(e,t(n)))}):typeof Dd=="object"&&typeof Dd.exports=="object"?s(t(e,t(Dd.exports))):s(t(e));function t(n,i){return n!==e&&(typeof Object.create=="function"?Object.defineProperty(n,"__esModule",{value:!0}):n.__esModule=!0),function(o,a){return n[o]=i?i(o,a):a}}})(function(s){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(n[o]=i[o])};qS=function(n,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");e(n,i);function o(){this.constructor=n}n.prototype=i===null?Object.create(i):(o.prototype=i.prototype,new o)},XS=Object.assign||function(n){for(var i,o=1,a=arguments.length;o<a;o++){i=arguments[o];for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&(n[l]=i[l])}return n},YS=function(n,i){var o={};for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&i.indexOf(a)<0&&(o[a]=n[a]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(n);l<a.length;l++)i.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(n,a[l])&&(o[a[l]]=n[a[l]]);return o},$S=function(n,i,o,a){var l=arguments.length,u=l<3?i:a===null?a=Object.getOwnPropertyDescriptor(i,o):a,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(n,i,o,a);else for(var h=n.length-1;h>=0;h--)(c=n[h])&&(u=(l<3?c(u):l>3?c(i,o,u):c(i,o))||u);return l>3&&u&&Object.defineProperty(i,o,u),u},QS=function(n,i){return function(o,a){i(o,a,n)}},ZS=function(n,i){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(n,i)},KS=function(n,i,o,a){function l(u){return u instanceof o?u:new o(function(c){c(u)})}return new(o||(o=Promise))(function(u,c){function h(y){try{f(a.next(y))}catch(S){c(S)}}function d(y){try{f(a.throw(y))}catch(S){c(S)}}function f(y){y.done?u(y.value):l(y.value).then(h,d)}f((a=a.apply(n,i||[])).next())})},JS=function(n,i){var o={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},a,l,u,c;return c={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function h(f){return function(y){return d([f,y])}}function d(f){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,l&&(u=f[0]&2?l.return:f[0]?l.throw||((u=l.return)&&u.call(l),0):l.next)&&!(u=u.call(l,f[1])).done)return u;switch(l=0,u&&(f=[f[0]&2,u.value]),f[0]){case 0:case 1:u=f;break;case 4:return o.label++,{value:f[1],done:!1};case 5:o.label++,l=f[1],f=[0];continue;case 7:f=o.ops.pop(),o.trys.pop();continue;default:if(u=o.trys,!(u=u.length>0&&u[u.length-1])&&(f[0]===6||f[0]===2)){o=0;continue}if(f[0]===3&&(!u||f[1]>u[0]&&f[1]<u[3])){o.label=f[1];break}if(f[0]===6&&o.label<u[1]){o.label=u[1],u=f;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(f);break}u[2]&&o.ops.pop(),o.trys.pop();continue}f=i.call(n,o)}catch(y){f=[6,y],l=0}finally{a=u=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},eE=function(n,i){for(var o in n)o!=="default"&&!Object.prototype.hasOwnProperty.call(i,o)&&Nd(i,n,o)},Nd=Object.create?function(n,i,o,a){a===void 0&&(a=o),Object.defineProperty(n,a,{enumerable:!0,get:function(){return i[o]}})}:function(n,i,o,a){a===void 0&&(a=o),n[a]=i[o]},Md=function(n){var i=typeof Symbol=="function"&&Symbol.iterator,o=i&&n[i],a=0;if(o)return o.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&a>=n.length&&(n=void 0),{value:n&&n[a++],done:!n}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")},zm=function(n,i){var o=typeof Symbol=="function"&&n[Symbol.iterator];if(!o)return n;var a=o.call(n),l,u=[],c;try{for(;(i===void 0||i-- >0)&&!(l=a.next()).done;)u.push(l.value)}catch(h){c={error:h}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(c)throw c.error}}return u},tE=function(){for(var n=[],i=0;i<arguments.length;i++)n=n.concat(zm(arguments[i]));return n},rE=function(){for(var n=0,i=0,o=arguments.length;i<o;i++)n+=arguments[i].length;for(var a=Array(n),l=0,i=0;i<o;i++)for(var u=arguments[i],c=0,h=u.length;c<h;c++,l++)a[l]=u[c];return a},nE=function(n,i,o){if(o||arguments.length===2)for(var a=0,l=i.length,u;a<l;a++)(u||!(a in i))&&(u||(u=Array.prototype.slice.call(i,0,a)),u[a]=i[a]);return n.concat(u||Array.prototype.slice.call(i))},ol=function(n){return this instanceof ol?(this.v=n,this):new ol(n)},iE=function(n,i,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=o.apply(n,i||[]),l,u=[];return l={},c("next"),c("throw"),c("return"),l[Symbol.asyncIterator]=function(){return this},l;function c(C){a[C]&&(l[C]=function(T){return new Promise(function(I,B){u.push([C,T,I,B])>1||h(C,T)})})}function h(C,T){try{d(a[C](T))}catch(I){S(u[0][3],I)}}function d(C){C.value instanceof ol?Promise.resolve(C.value.v).then(f,y):S(u[0][2],C)}function f(C){h("next",C)}function y(C){h("throw",C)}function S(C,T){C(T),u.shift(),u.length&&h(u[0][0],u[0][1])}},oE=function(n){var i,o;return i={},a("next"),a("throw",function(l){throw l}),a("return"),i[Symbol.iterator]=function(){return this},i;function a(l,u){i[l]=n[l]?function(c){return(o=!o)?{value:ol(n[l](c)),done:l==="return"}:u?u(c):c}:u}},sE=function(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n[Symbol.asyncIterator],o;return i?i.call(n):(n=typeof Md=="function"?Md(n):n[Symbol.iterator](),o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o);function a(u){o[u]=n[u]&&function(c){return new Promise(function(h,d){c=n[u](c),l(h,d,c.done,c.value)})}}function l(u,c,h,d){Promise.resolve(d).then(function(f){u({value:f,done:h})},c)}},aE=function(n,i){return Object.defineProperty?Object.defineProperty(n,"raw",{value:i}):n.raw=i,n};var t=Object.create?function(n,i){Object.defineProperty(n,"default",{enumerable:!0,value:i})}:function(n,i){n.default=i};lE=function(n){if(n&&n.__esModule)return n;var i={};if(n!=null)for(var o in n)o!=="default"&&Object.prototype.hasOwnProperty.call(n,o)&&Nd(i,n,o);return t(i,n),i},uE=function(n){return n&&n.__esModule?n:{default:n}},cE=function(n,i,o,a){if(o==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof i=="function"?n!==i||!a:!i.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?a:o==="a"?a.call(n):a?a.value:i.get(n)},hE=function(n,i,o,a,l){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!l)throw new TypeError("Private accessor was defined without a setter");if(typeof i=="function"?n!==i||!l:!i.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?l.call(n,o):l?l.value=o:i.set(n,o),o},s("__extends",qS),s("__assign",XS),s("__rest",YS),s("__decorate",$S),s("__param",QS),s("__metadata",ZS),s("__awaiter",KS),s("__generator",JS),s("__exportStar",eE),s("__createBinding",Nd),s("__values",Md),s("__read",zm),s("__spread",tE),s("__spreadArrays",rE),s("__spreadArray",nE),s("__await",ol),s("__asyncGenerator",iE),s("__asyncDelegator",oE),s("__asyncValues",sE),s("__makeTemplateObject",aE),s("__importStar",lE),s("__importDefault",uE),s("__classPrivateFieldGet",cE),s("__classPrivateFieldSet",hE)})});var gE=de(Gd=>{"use strict";Object.defineProperty(Gd,"__esModule",{value:!0});Gd.SortedSet=void 0;var Wm=_p(),p2=Eo(),Hu=ps(),fE=Ss(),Hm=class{constructor(...e){this._values=[];let t,n;if(e.length>0){let i=e[0];p2.isIterable(i)||i===void 0?(t=i,e.length>1&&(n=e[1])):n=i}if(n===void 0&&(n=fE.Comparer.defaultComparer),this._comparer=typeof n=="function"?fE.Comparer.create(n):n,t)for(let i of t)this.add(i)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return Wm.binarySearch(this._values,e,this._comparer)>=0}add(e){let t=Wm.binarySearch(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=Wm.binarySearch(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){for(let n of this)e.call(t,n,n,this)}get[Hu.Collection.size](){return this.size}[Hu.Collection.has](e){return this.has(e)}[Hu.Collection.add](e){this.add(e)}[Hu.Collection.delete](e){return this.delete(e)}[Hu.Collection.clear](){this.clear()}};Gd.SortedSet=Hm;Object.defineProperty(Hm,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"SortedSet"})});var PE=de(Vo=>{"use strict";Object.defineProperty(Vo,"__esModule",{value:!0});Vo.expandPrime=Vo.getPrime=Vo.isPrime=void 0;var m2=2**31-1,jm=2146435069,b2=101,pE=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function mE(s){if(s&1){let e=Math.sqrt(s)|0;for(let t=3;t<=e;t+=2)if(!(s%t))return!1;return!0}return s===2}Vo.isPrime=mE;function bE(s){if(s<0)throw new RangeError;for(let e=0;e<pE.length;e++){let t=pE[e];if(t>=s)return t}for(let e=s|1;e<m2;e+=2)if(mE(e)&&(e-1)%b2)return e;return s}Vo.getPrime=bE;function P2(s){let e=2*s;return e>jm&&jm>s?jm:bE(e)}Vo.expandPrime=P2});var $m=de(we=>{"use strict";Object.defineProperty(we,"__esModule",{value:!0});we.forEachEntry=we.iterateEntries=we.selectEntryEntry=we.selectEntryValue=we.selectEntryKey=we.trimExcessEntries=we.ensureCapacity=we.clearEntries=we.deleteEntry=we.insertEntry=we.findEntryValue=we.findEntryIndex=we.resizeHashData=we.initializeHashData=we.createHashData=we.createHashEntry=void 0;var ju=PE(),qm=2**31-1;function Xm(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}we.createHashEntry=Xm;function y2(s,e){let t=Xm(),n={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:s,head:t,tail:t};return qu(n,e),n}we.createHashData=y2;function qu(s,e){let t=ju.getPrime(e);return s.freeList=-1,s.buckets=new Int32Array(t),s.entries=new Array(t),t}we.initializeHashData=qu;function Ym(s,e){let t=s.size,n=new Int32Array(e),i=s.entries?s.entries.slice():[];i.length=e;for(let o=0;o<t;o++){let a=i[o];if(a&&a.hashCode>=0){let l=a.hashCode%e;a.next=n[l]-1,n[l]=o+1}}s.buckets=n,s.entries=i}we.resizeHashData=Ym;function yE(s,e){let t=-1,{buckets:n,entries:i,equaler:o}=s;if(n&&i){let a=o.hash(e)&qm;for(t=n[a%n.length]-1;t>>>0<i.length&&!(i[t].hashCode===a&&o.equals(i[t].key,e));)t=i[t].next}return t}we.findEntryIndex=yE;function S2(s,e){let t=yE(s,e);return t>=0?s.entries[t].value:void 0}we.findEntryValue=S2;function E2(s,e,t){if(s.buckets||qu(s,0),!s.buckets||!s.entries)throw new Error;let n=s.equaler.hash(e)&qm,i=n%s.buckets.length,o=s.buckets[i]-1;for(;o>>>0<s.entries.length;){let h=s.entries[o];if(h.hashCode===n&&s.equaler.equals(h.key,e)){h.value=t;return}o=h.next}let a=!1,l;if(s.freeSize>0)l=s.freeList,a=!0,s.freeSize--;else{let h=s.size;if(h===s.entries.length){if(Ym(s,ju.expandPrime(s.size)),!s.buckets||!s.entries)throw new Error;i=n%s.buckets.length}l=h,s.size=h+1}let u=s.entries[l]||(s.entries[l]=Xm());a&&(s.freeList=u.next),u.hashCode=n,u.next=s.buckets[i]-1,u.key=e,u.value=t,u.skipNextEntry=!1;let c=s.tail;c.nextEntry=u,u.prevEntry=c,s.tail=u,s.buckets[i]=l+1}we.insertEntry=E2;function x2(s,e){if(s.buckets&&s.entries){let t=s.equaler.hash(e)&qm,n=t%s.buckets.length,i=-1,o;for(let a=s.buckets[n]-1;a>=0;a=o.next){if(o=s.entries[a],o.hashCode===t&&s.equaler.equals(o.key,e)){i<0?s.buckets[n]=o.next+1:s.entries[i].next=o.next;let l=o.prevEntry;return l.nextEntry=o.nextEntry,l.nextEntry&&(l.nextEntry.prevEntry=l),s.tail===o&&(s.tail=l),o.hashCode=-1,o.next=s.freeList,o.key=void 0,o.value=void 0,o.prevEntry=void 0,o.nextEntry=l,o.skipNextEntry=!0,s.freeList=a,s.freeSize++,!0}i=a}}return!1}we.deleteEntry=x2;function C2(s){if(s.size>0){s.buckets&&s.buckets.fill(0),s.entries&&s.entries.fill(void 0);let t=s.head.nextEntry;for(;t;){let n=t.nextEntry;t.prevEntry=void 0,t.nextEntry=s.head,t.skipNextEntry=!0,t=n}s.head.nextEntry=void 0,s.tail=s.head,s.size=0,s.freeList=-1,s.freeSize=0}}we.clearEntries=C2;function A2(s,e){if(e<0)throw new RangeError;let t=s.entries?s.entries.length:0;if(t>=e)return t;if(!s.buckets)return qu(s,e);let n=ju.getPrime(e);return Ym(s,ju.getPrime(e)),n}we.ensureCapacity=A2;function v2(s,e=s.size-s.freeSize){if(e<s.size)throw new RangeError;if(!s.buckets||!s.entries)return;let t=ju.getPrime(e),n=s.entries;if(t>=(n?n.length:0))return;let i=s.size;if(qu(s,t),!s.buckets||!s.entries)throw new Error;let o=0;for(let a=0;a<i;a++){let l=n[a].hashCode;if(l>=0){let u=l%t;s.entries[o]=n[a],s.entries[o].next=s.buckets[u]-1,s.buckets[u]=o+1,o++}}s.size=o,s.freeSize=0}we.trimExcessEntries=v2;function T2(s){return s.key}we.selectEntryKey=T2;function I2(s){return s.value}we.selectEntryValue=I2;function w2(s){return[s.key,s.value]}we.selectEntryEntry=w2;function*L2(s,e){let t=s;for(;t;){let n=t.skipNextEntry;t=t.nextEntry,!n&&t&&(yield e(t))}}we.iterateEntries=L2;function O2(s,e,t,n){let i=e;for(;i;){let o=i.skipNextEntry;i=i.nextEntry,!o&&i&&t.call(n,i.value,i.key,s)}}we.forEachEntry=O2});var Zm=de(_d=>{"use strict";Object.defineProperty(_d,"__esModule",{value:!0});_d.HashMap=void 0;var ko=ps(),R2=Ss(),B2=Eo(),Or=$m(),Qm=class{constructor(...e){let t,n,i;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(i=e[1])):B2.isIterable(o)||o===void 0?(n=o,e.length>1&&(i=e[1])):i=o}if(t===void 0&&(t=0),i===void 0&&(i=R2.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=Or.createHashData(i,t),n)for(let[o,a]of n)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return Or.findEntryIndex(this._hashData,e)>=0}get(e){return Or.findEntryValue(this._hashData,e)}set(e,t){return Or.insertEntry(this._hashData,e,t),this}delete(e){return Or.deleteEntry(this._hashData,e)}clear(){Or.clearEntries(this._hashData)}ensureCapacity(e){return Or.ensureCapacity(this._hashData,e)}trimExcess(e){Or.trimExcessEntries(this._hashData,e)}keys(){return Or.iterateEntries(this._hashData.head,Or.selectEntryKey)}values(){return Or.iterateEntries(this._hashData.head,Or.selectEntryValue)}entries(){return Or.iterateEntries(this._hashData.head,Or.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){Or.forEachEntry(this,this._hashData.head,e,t)}get[ko.ReadonlyKeyedCollection.size](){return this.size}[ko.ReadonlyKeyedCollection.has](e){return this.has(e)}[ko.ReadonlyKeyedCollection.get](e){return this.get(e)}[ko.ReadonlyKeyedCollection.keys](){return this.keys()}[ko.ReadonlyKeyedCollection.values](){return this.values()}[ko.KeyedCollection.set](e,t){this.set(e,t)}[ko.KeyedCollection.delete](e){return this.delete(e)}[ko.KeyedCollection.clear](){this.clear()}};_d.HashMap=Qm;Object.defineProperty(Qm,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashMap"})});var Jm=de(Fd=>{"use strict";Object.defineProperty(Fd,"__esModule",{value:!0});Fd.HashSet=void 0;var Xu=ps(),M2=Ss(),N2=Eo(),Rr=$m(),Km=class{constructor(...e){let t,n,i;if(e.length>0){let o=e[0];typeof o=="number"?(t=o,e.length>1&&(i=e[1])):N2.isIterable(o)?(n=o,e.length>1&&(i=e[1])):i=o}if(t===void 0&&(t=0),i===void 0&&(i=M2.Equaler.defaultEqualer),t<0)throw new RangeError;if(this._hashData=Rr.createHashData(i,t),n)for(let o of n)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return Rr.findEntryIndex(this._hashData,e)>=0}add(e){return Rr.insertEntry(this._hashData,e,e),this}tryAdd(e){let t=this.size;return Rr.insertEntry(this._hashData,e,e),this.size>t}delete(e){return Rr.deleteEntry(this._hashData,e)}clear(){Rr.clearEntries(this._hashData)}ensureCapacity(e){return Rr.ensureCapacity(this._hashData,e)}trimExcess(e){Rr.trimExcessEntries(this._hashData,e)}keys(){return Rr.iterateEntries(this._hashData.head,Rr.selectEntryKey)}values(){return Rr.iterateEntries(this._hashData.head,Rr.selectEntryValue)}entries(){return Rr.iterateEntries(this._hashData.head,Rr.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){Rr.forEachEntry(this,this._hashData.head,e,t)}get[Xu.Collection.size](){return this.size}[Xu.Collection.has](e){return this.has(e)}[Xu.Collection.add](e){this.add(e)}[Xu.Collection.delete](e){return this.delete(e)}[Xu.Collection.clear](){this.clear()}};Fd.HashSet=Km;Object.defineProperty(Km,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"HashSet"})});var EE=de(Vd=>{"use strict";Object.defineProperty(Vd,"__esModule",{value:!0});Vd.MultiMap=void 0;var js=Eo(),SE=Ss(),di=ps(),D2=Zm(),G2=Jm(),eb=class{constructor(...e){this._size=0;let t,n,i;F2(e)?[t,i={}]=e:(t=0,_2(e)?[n,i={}]=e:i={});let{keyEqualer:o=SE.Equaler.defaultEqualer,valueEqualer:a=SE.Equaler.defaultEqualer}=i;if(this._map=new D2.HashMap(t,o),this._keyEqualer=o,this._valueEqualer=a,n)for(let[l,u]of n)this.add(l,u)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let n=this._map.get(e);return n?n.has(t):!1}get(e){return this._map.get(e)}add(e,t){let n=this._map.get(e);n||(n=new G2.HashSet(this._valueEqualer),this._map.set(e,n));let i=n.size;return n.add(t),this._size+=n.size-i,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let n=this._map.get(e);if(n){let i=n.size;if(n.delete(t))return this._size+=n.size-i,n.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let n of t)yield[e,n]}[Symbol.iterator](){return this.entries()}forEach(e,t){for(let[n,i]of this._map)for(let o of i)e.call(t,o,n,this)}get[di.ReadonlyKeyedMultiCollection.size](){return this.size}[di.ReadonlyKeyedMultiCollection.has](e){return this.has(e)}[di.ReadonlyKeyedMultiCollection.hasValue](e,t){return this.hasValue(e,t)}[di.ReadonlyKeyedMultiCollection.get](e){return this.get(e)}[di.ReadonlyKeyedMultiCollection.keys](){return this.keys()}[di.ReadonlyKeyedMultiCollection.values](){return this.values()}[di.KeyedMultiCollection.add](e,t){this.add(e,t)}[di.KeyedMultiCollection.delete](e){return this.delete(e)}[di.KeyedMultiCollection.deleteValue](e,t){return this.deleteValue(e,t)}[di.KeyedMultiCollection.clear](){this.clear()}};Vd.MultiMap=eb;Object.defineProperty(eb,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"MultiMap"});function _2(s){return(s.length<1||!js.isDefined(s[0])||js.isIterable(s[0]))&&(s.length<2||!js.isDefined(s[1])||js.isObject(s[1]))}function F2(s){return(s.length<1||js.isNumber(s[0]))&&(s.length<2||!js.isDefined(s[1])||js.isObject(s[1]))}});var TE=de(al=>{"use strict";var CE,AE,vE;Object.defineProperty(al,"__esModule",{value:!0});al.LinkedList=al.LinkedListNode=void 0;var ce=Eo(),Yu=ps(),xE=Ss(),kd=Symbol("LinkedListNode.list"),pr=Symbol("LinkedListNode.previous"),Jt=Symbol("LinkedListNode.next"),Wt=class{constructor(e){this[CE]=void 0,this[AE]=void 0,this[vE]=void 0,this.value=e}get list(){return this[kd]}get previous(){if(this[pr]&&this.list&&this!==this.list.first)return this[pr]}get next(){if(this[Jt]&&this.list&&this[Jt]!==this.list.first)return this[Jt]}detachSelf(){return this.list?this.list.deleteNode(this):!1}};al.LinkedListNode=Wt;CE=kd,AE=pr,vE=Jt;Object.defineProperty(Wt.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedListNode"});var sl=class{constructor(...e){this._size=0,this._head=void 0;let t,n;if(e.length>0&&(ce.isIterable(e[0])||ce.isMissing(e[0])?(t=e[0],e.length>1&&(n=e[1])):n=e[0]),ce.isMissing(n)&&(n=xE.Equaler.defaultEqualer),this._equaler=typeof n=="function"?xE.Equaler.create(n):n,t)for(let i of t)this.push(i)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return this._head[pr]}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(!ce.isMissing(t)&&!ce.isInstance(t,Wt))throw new TypeError("LinkedListNode expected: fromNode");if(!ce.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let n=t||this.first;n;n=n.next)if(this._equaler.equals(n.value,e))return n}lastNodeOf(e,t){if(!ce.isMissing(t)&&!ce.isInstance(t,Wt))throw new TypeError("LinkedListNode expected: fromNode");if(!ce.isMissing(t)&&t.list!==this)throw new TypeError("Wrong list.");for(let n=t||this.last;n;n=n.previous)if(this._equaler.equals(n.value,e))return n}find(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;){n=i,i=n.next;let o=n.value;if(e.call(t,o,n,this))return o}}findLast(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.last;for(;i!==void 0;){n=i,i=n.previous;let o=n.value;if(e.call(t,o,n,this))return o}}findNode(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)if(n=i,i=n.next,e.call(t,n.value,n,this))return n}findLastNode(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.last;for(;i!==void 0;)if(n=i,i=n.previous,e.call(t,n.value,n,this))return n}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(!ce.isMissing(e)&&!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: node");if(!ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new Wt(t),0)}insertNodeBefore(e,t){if(!ce.isMissing(e)&&!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: node");if(!ce.isInstance(t,Wt))throw new TypeError("LinkedListNode expected: newNode");if(!ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ce.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(!ce.isMissing(e)&&!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: node");if(!ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");return this._insertNode(e||void 0,new Wt(t),1)}insertNodeAfter(e,t){if(!ce.isMissing(e)&&!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: node");if(!ce.isInstance(t,Wt))throw new TypeError("LinkedListNode expected: newNode");if(!ce.isMissing(e)&&e.list!==this)throw new Error("Wrong list.");if(!ce.isMissing(t.list))throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new Wt(e),1)}pushNode(e){if(!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: newNode");if(!ce.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new Wt(e),0)}unshiftNode(e){if(!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: newNode");if(!ce.isMissing(e.list))throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(!ce.isMissing(e)&&!ce.isInstance(e,Wt))throw new TypeError("LinkedListNode expected: node");if(!ce.isMissing(e)&&!ce.isMissing(e.list)&&e.list!==this)throw new TypeError("Wrong list.");return ce.isMissing(e)||ce.isMissing(e.list)?!1:this._deleteNode(e)}deleteAll(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: predicate");let n=0,i=this.first;for(;i;){let o=i.next;e.call(t,i.value,i,this)&&i.list===this&&(this._deleteNode(i),++n),i=o}return n}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)n=i,i=n.next,e.call(t,n.value,n,this)}map(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");[].map;let n=new sl,i,o=this.first;for(;o!==void 0;){i=o,o=i.next;let a=e.call(t,i.value,i,this);n.push(a)}return n}filter(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n=new sl(this.equaler),i,o=this.first;for(;o!==void 0;){i=o,o=i.next;let a=i.value;e.call(t,a,i,this)&&n.push(a)}return n}reduce(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n=arguments.length>1,i=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;n?i=e(i,l,o,this):(i=l,n=!0)}return i}reduceRight(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n=arguments.length>1,i=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;n?i=e(i,l,o,this):(i=l,n=!0),a=o.previous}return i}some(e,t){if(!ce.isMissing(e)&&!ce.isFunction(e))throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)if(n=i,i=n.next,!e||e.call(t,n.value,n,this))return!0;return!1}every(e,t){if(!ce.isFunction(e))throw new TypeError("Function expected: callback");let n=!1,i,o=this.first;for(;o!==void 0;){if(i=o,o=i.next,!e.call(t,i.value,i,this))return!1;n=!0}return n}_deleteNode(e){return e[Jt]===e?this._head=void 0:(e[Jt][pr]=e[pr],e[pr][Jt]=e[Jt],this._head===e&&(this._head=e[Jt])),e[kd]=void 0,e[Jt]=void 0,e[pr]=void 0,this._size--,!0}_insertNode(e,t,n){if(t[kd]=this,this._head===void 0)t[Jt]=t,t[pr]=t,this._head=t;else switch(n){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),t[Jt]=e,t[pr]=e[pr],e[pr][Jt]=t,e[pr]=t;break;case 1:e===void 0&&(e=this._head[pr]),t[pr]=e,t[Jt]=e[Jt],e[Jt][pr]=t,e[Jt]=t;break}return this._size++,t}get[Yu.ReadonlyCollection.size](){return this.size}[Yu.ReadonlyCollection.has](e){return this.has(e)}[Yu.Collection.add](e){this.push(e)}[Yu.Collection.delete](e){return!!this.delete(e)}[Yu.Collection.clear](){this.clear()}};al.LinkedList=sl;Object.defineProperty(sl.prototype,Symbol.toStringTag,{enumerable:!1,configurable:!0,writable:!0,value:"LinkedList"})});var Ud=de(Uo=>{"use strict";Object.defineProperty(Uo,"__esModule",{value:!0});var ll=dE();ll.__exportStar(Au(),Uo);ll.__exportStar(gE(),Uo);ll.__exportStar(Zm(),Uo);ll.__exportStar(Jm(),Uo);ll.__exportStar(EE(),Uo);ll.__exportStar(TE(),Uo)});var KE=de((Yie,ZE)=>{ZE.exports={rgb2hsl:tc,rgb2hsv:Qd,rgb2hwb:rc,rgb2cmyk:nc,rgb2keyword:ic,rgb2xyz:bb,rgb2lab:Pb,rgb2lch:cL,hsl2rgb:Zd,hsl2hsv:hL,hsl2hwb:dL,hsl2cmyk:fL,hsl2keyword:gL,hsv2rgb:Kd,hsv2hsl:pL,hsv2hwb:mL,hsv2cmyk:bL,hsv2keyword:PL,hwb2rgb:oc,hwb2hsl:yL,hwb2hsv:SL,hwb2cmyk:EL,hwb2keyword:xL,cmyk2rgb:sc,cmyk2hsl:CL,cmyk2hsv:AL,cmyk2hwb:vL,cmyk2keyword:TL,keyword2rgb:Zs,keyword2hsl:OL,keyword2hsv:RL,keyword2hwb:BL,keyword2cmyk:ML,keyword2lab:NL,keyword2xyz:DL,xyz2rgb:XE,xyz2lab:YE,xyz2lch:IL,lab2xyz:yb,lab2rgb:$E,lab2lch:Sb,lch2lab:Eb,lch2xyz:wL,lch2rgb:LL};function tc(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255,i=Math.min(e,t,n),o=Math.max(e,t,n),a=o-i,l,u,c;return o==i?l=0:e==o?l=(t-n)/a:t==o?l=2+(n-e)/a:n==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(i+o)/2,o==i?u=0:c<=.5?u=a/(o+i):u=a/(2-o-i),[l,u*100,c*100]}function Qd(s){var e=s[0],t=s[1],n=s[2],i=Math.min(e,t,n),o=Math.max(e,t,n),a=o-i,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==i?l=0:e==o?l=(t-n)/a:t==o?l=2+(n-e)/a:n==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function rc(s){var e=s[0],t=s[1],o=s[2],n=tc(s)[0],i=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[n,i*100,o*100]}function nc(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255,i,o,a,l;return l=Math.min(1-e,1-t,1-n),i=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-n-l)/(1-l)||0,[i*100,o*100,a*100,l*100]}function ic(s){return QE[JSON.stringify(s)]}function bb(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92;var i=e*.4124+t*.3576+n*.1805,o=e*.2126+t*.7152+n*.0722,a=e*.0193+t*.1192+n*.9505;return[i*100,o*100,a*100]}function Pb(s){var e=bb(s),t=e[0],n=e[1],i=e[2],o,a,l;return t/=95.047,n/=100,i/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,o=116*n-16,a=500*(t-n),l=200*(n-i),[o,a,l]}function cL(s){return Sb(Pb(s))}function Zd(s){var e=s[0]/360,t=s[1]/100,n=s[2]/100,i,o,a,l,u;if(t==0)return u=n*255,[u,u,u];n<.5?o=n*(1+t):o=n+t-n*t,i=2*n-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=i+(o-i)*6*a:2*a<1?u=o:3*a<2?u=i+(o-i)*(2/3-a)*6:u=i,l[c]=u*255;return l}function hL(s){var e=s[0],t=s[1]/100,n=s[2]/100,i,o;return n===0?[0,0,0]:(n*=2,t*=n<=1?n:2-n,o=(n+t)/2,i=2*t/(n+t),[e,i*100,o*100])}function dL(s){return rc(Zd(s))}function fL(s){return nc(Zd(s))}function gL(s){return ic(Zd(s))}function Kd(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,n=Math.floor(e)%6,i=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*i),l=255*u*(1-t*(1-i)),u=255*u;switch(n){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function pL(s){var e=s[0],t=s[1]/100,n=s[2]/100,i,o;return o=(2-t)*n,i=t*n,i/=o<=1?o:2-o,i=i||0,o/=2,[e,i*100,o*100]}function mL(s){return rc(Kd(s))}function bL(s){return nc(Kd(s))}function PL(s){return ic(Kd(s))}function oc(s){var e=s[0]/360,t=s[1]/100,n=s[2]/100,i=t+n,o,a,l,u;switch(i>1&&(t/=i,n/=i),o=Math.floor(6*e),a=1-n,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function yL(s){return tc(oc(s))}function SL(s){return Qd(oc(s))}function EL(s){return nc(oc(s))}function xL(s){return ic(oc(s))}function sc(s){var e=s[0]/100,t=s[1]/100,n=s[2]/100,i=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-i)+i),a=1-Math.min(1,t*(1-i)+i),l=1-Math.min(1,n*(1-i)+i),[o*255,a*255,l*255]}function CL(s){return tc(sc(s))}function AL(s){return Qd(sc(s))}function vL(s){return rc(sc(s))}function TL(s){return ic(sc(s))}function XE(s){var e=s[0]/100,t=s[1]/100,n=s[2]/100,i,o,a;return i=e*3.2406+t*-1.5372+n*-.4986,o=e*-.9689+t*1.8758+n*.0415,a=e*.0557+t*-.204+n*1.057,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:i=i*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,i=Math.min(Math.max(0,i),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[i*255,o*255,a*255]}function YE(s){var e=s[0],t=s[1],n=s[2],i,o,a;return e/=95.047,t/=100,n/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=116*t-16,o=500*(e-t),a=200*(t-n),[i,o,a]}function IL(s){return Sb(YE(s))}function yb(s){var e=s[0],t=s[1],n=s[2],i,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),i=i/95.047<=.008856?i=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-n/200-16/116)/7.787:108.883*Math.pow(l-n/200,3),[i,o,a]}function Sb(s){var e=s[0],t=s[1],n=s[2],i,o,a;return i=Math.atan2(n,t),o=i*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+n*n),[e,a,o]}function $E(s){return XE(yb(s))}function Eb(s){var e=s[0],t=s[1],n=s[2],i,o,a;return a=n/360*2*Math.PI,i=t*Math.cos(a),o=t*Math.sin(a),[e,i,o]}function wL(s){return yb(Eb(s))}function LL(s){return $E(Eb(s))}function Zs(s){return mb[s]}function OL(s){return tc(Zs(s))}function RL(s){return Qd(Zs(s))}function BL(s){return rc(Zs(s))}function ML(s){return nc(Zs(s))}function NL(s){return Pb(Zs(s))}function DL(s){return bb(Zs(s))}var mb={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},QE={};for(pb in mb)QE[JSON.stringify(mb[pb])]=pb;var pb});var tx=de(($ie,ex)=>{var xb=KE(),Ks=function(){return new ac};for(pl in xb)Ks[pl+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),xb[s](e)}}(pl),Cb=/(\w+)2(\w+)/.exec(pl),Jd=Cb[1],JE=Cb[2],Ks[Jd]=Ks[Jd]||{},Ks[Jd][JE]=Ks[pl]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=xb[s](e);if(typeof t=="string"||t===void 0)return t;for(var n=0;n<t.length;n++)t[n]=Math.round(t[n]);return t}}(pl);var Cb,Jd,JE,pl,ac=function(){this.convs={}};ac.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};ac.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};ac.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,n=this.convs[t];e=Ks[t][s](n),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){ac.prototype[s]=function(e){return this.routeSpace(s,arguments)}});ex.exports=Ks});var nx=de((Qie,rx)=>{var Ab=tx();rx.exports=function(s){var e,t,n,i;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=Ab[a],n=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&n.push(1),i=n[l]===void 0?1:n[l],n=n.slice(0,l),t[a]=function(){return n}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=Ab.rgb,n=a.split(l===3?/(.)/:/(..)/),n=n.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),i=1,t.rgb=function(){return n},n[0]||(n[0]=0),n[1]||(n[1]=0),n[2]||(n[2]=0)}else t=Ab.keyword,t.keyword=function(){return s},n=s,i=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(n)}catch{}try{u.hsl=t.hsl(n)}catch{}try{u.hsv=t.hsv(n)}catch{}try{u.cmyk=t.cmyk(n)}catch{}try{u.keyword=t.keyword(n)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(i)),u.hsl&&(u.hsla=u.hsl.concat(i)),u.hsv&&(u.hsva=u.hsv.concat(i)),u.cmyk&&(u.cmyka=u.cmyk.concat(i)),u}});var ta=de((Wse,hc)=>{function pO(s){return s&&s.__esModule?s:{default:s}}hc.exports=pO,hc.exports.__esModule=!0,hc.exports.default=hc.exports});var dc=de((Hse,eo)=>{function Hb(s){return eo.exports=Hb=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},eo.exports.__esModule=!0,eo.exports.default=eo.exports,Hb(s)}eo.exports=Hb,eo.exports.__esModule=!0,eo.exports.default=eo.exports});var uf=de(qb=>{"use strict";var mO=ta();Object.defineProperty(qb,"__esModule",{value:!0});qb.default=bO;var jb=mO(dc());function bO(s){if(typeof window<"u"&&(0,jb.default)(window.process)==="object"&&window.process.type==="renderer"||typeof process<"u"&&(0,jb.default)(process.versions)==="object"&&Boolean(process.versions.electron))return!0;var e=(typeof navigator>"u"?"undefined":(0,jb.default)(navigator))==="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}});var hf=de(cf=>{"use strict";var vx=ta();Object.defineProperty(cf,"__esModule",{value:!0});cf.default=Tx;cf.isBrowserMainThread=SO;var PO=vx(dc()),yO=vx(uf());function Tx(){var s=(typeof process>"u"?"undefined":(0,PO.default)(process))==="object"&&String(process)==="[object process]"&&!process.browser;return!s||(0,yO.default)()}function SO(){return Tx()&&typeof document<"u"}});var Xb=de(zr=>{"use strict";var EO=ta();Object.defineProperty(zr,"__esModule",{value:!0});zr.window=zr.self=zr.process=zr.global=zr.document=zr.console=void 0;var xO=EO(dc()),jo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:(typeof process>"u"?"undefined":(0,xO.default)(process))==="object"&&process},CO=globalThis;zr.global=CO;var AO=jo.self||jo.window||jo.global;zr.self=AO;var vO=jo.window||jo.self||jo.global;zr.window=vO;var TO=jo.document||{};zr.document=TO;var IO=jo.process||{};zr.process=IO;var wO=console;zr.console=wO});var Ix=de(yn=>{"use strict";var LO=ta();Object.defineProperty(yn,"__esModule",{value:!0});yn.VERSION=void 0;Object.defineProperty(yn,"console",{enumerable:!0,get:function(){return yl.console}});Object.defineProperty(yn,"document",{enumerable:!0,get:function(){return yl.document}});Object.defineProperty(yn,"global",{enumerable:!0,get:function(){return yl.global}});yn.isBrowser=void 0;Object.defineProperty(yn,"process",{enumerable:!0,get:function(){return yl.process}});Object.defineProperty(yn,"self",{enumerable:!0,get:function(){return yl.self}});Object.defineProperty(yn,"window",{enumerable:!0,get:function(){return yl.window}});var OO=LO(hf()),yl=Xb(),RO=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";yn.VERSION=RO;var BO=(0,OO.default)();yn.isBrowser=BO});var Lx=de(ff=>{"use strict";var wx=ta();Object.defineProperty(ff,"__esModule",{value:!0});ff.default=GO;ff.isMobile=DO;var MO=wx(hf()),NO=wx(uf()),df=globalThis;function DO(){return typeof df.orientation<"u"}function GO(s){if(!s&&!(0,MO.default)())return"Node";if((0,NO.default)(s))return"Electron";var e=typeof navigator<"u"?navigator:{},t=s||e.userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";var n=t.indexOf("MSIE ")!==-1,i=t.indexOf("Trident/")!==-1;return n||i?"IE":df.chrome?"Chrome":df.safari?"Safari":df.mozInnerScreenX?"Firefox":"Unknown"}});var Ox=de(Yb=>{"use strict";Object.defineProperty(Yb,"__esModule",{value:!0});Yb.default=_O;function _O(s,e){if(!s)throw new Error(e||"Assertion failed")}});var El=de(Mr=>{"use strict";var Rx=ta(),FO=dc();Object.defineProperty(Mr,"__esModule",{value:!0});Object.defineProperty(Mr,"VERSION",{enumerable:!0,get:function(){return VO.VERSION}});Object.defineProperty(Mr,"assert",{enumerable:!0,get:function(){return UO.default}});Object.defineProperty(Mr,"console",{enumerable:!0,get:function(){return Sl.console}});Object.defineProperty(Mr,"document",{enumerable:!0,get:function(){return Sl.document}});Object.defineProperty(Mr,"getBrowser",{enumerable:!0,get:function(){return Mx.default}});Object.defineProperty(Mr,"global",{enumerable:!0,get:function(){return Sl.global}});Object.defineProperty(Mr,"isBrowser",{enumerable:!0,get:function(){return Bx.default}});Object.defineProperty(Mr,"isBrowserMainThread",{enumerable:!0,get:function(){return Bx.isBrowserMainThread}});Object.defineProperty(Mr,"isElectron",{enumerable:!0,get:function(){return kO.default}});Object.defineProperty(Mr,"isMobile",{enumerable:!0,get:function(){return Mx.isMobile}});Object.defineProperty(Mr,"process",{enumerable:!0,get:function(){return Sl.process}});Object.defineProperty(Mr,"self",{enumerable:!0,get:function(){return Sl.self}});Object.defineProperty(Mr,"window",{enumerable:!0,get:function(){return Sl.window}});var VO=Ix(),Sl=Xb(),Bx=Dx(hf()),Mx=Dx(Lx()),kO=Rx(uf()),UO=Rx(Ox());function Nx(s){if(typeof WeakMap!="function")return null;var e=new WeakMap,t=new WeakMap;return(Nx=function(i){return i?t:e})(s)}function Dx(s,e){if(!e&&s&&s.__esModule)return s;if(s===null||FO(s)!=="object"&&typeof s!="function")return{default:s};var t=Nx(e);if(t&&t.has(s))return t.get(s);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in s)if(o!=="default"&&Object.prototype.hasOwnProperty.call(s,o)){var a=i?Object.getOwnPropertyDescriptor(s,o):null;a&&(a.get||a.set)?Object.defineProperty(n,o,a):n[o]=s[o]}return n.default=s,t&&t.set(s,n),n}});var bc=de((sue,SC)=>{SC.exports=El()});var Cv=de((lSe,I0)=>{"use strict";I0.exports=th;I0.exports.default=th;var Yl=1e20;function th(s,e,t,n,i,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=n||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function RG(s,e,t,n,i,o,a){o.fill(Yl,0,e*t),a.fill(0,0,e*t);for(var l=(e-n)/2,u=0;u<i;u++)for(var c=0;c<n;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*n+c)+3]/255;if(d===1)o[h]=0,a[h]=Yl;else if(d===0)o[h]=Yl,a[h]=0;else{var f=Math.max(0,.5-d),y=Math.max(0,d-.5);o[h]=f*f,a[h]=y*y}}}function BG(s,e,t,n,i,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(n[l])-Math.sqrt(i[l]);s[l]=Math.round(255-255*(u/o+a))}}th.prototype._draw=function(s,e){var t=this.ctx.measureText(s),n=t.width,i=2*this.buffer,o,a,l,u,c,h,d,f;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),f=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+i,l=u+i,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,f=this.middle,this.ctx.textBaseline="middle");var y;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,f),y=this.ctx.getImageData(d,h,a,u));var S=new Uint8ClampedArray(o*l);return RG(y,o,l,a,u,this.gridOuter,this.gridInner),Ev(this.gridOuter,o,l,this.f,this.v,this.z),Ev(this.gridInner,o,l,this.f,this.v,this.z),BG(S,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:S,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:n}}};th.prototype.draw=function(s){return this._draw(s,!1).data};th.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function Ev(s,e,t,n,i,o){for(var a=0;a<e;a++)xv(s,a,e,t,n,i,o);for(var l=0;l<t;l++)xv(s,l*e,1,e,n,i,o)}function xv(s,e,t,n,i,o,a){var l,u,c,h;for(o[0]=0,a[0]=-Yl,a[1]=Yl,l=0;l<n;l++)i[l]=s[e+l*t];for(l=1,u=0,c=0;l<n;l++){do h=o[u],c=(i[l]-i[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=Yl}for(l=0,u=0;l<n;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=i[h]+(l-h)*(l-h)}}});var jv=de((kEe,Fg)=>{Fg.exports=Hv;Fg.exports.addWheelListener=Hv;Fg.exports.removeWheelListener=o_;function Hv(s,e,t){s.addEventListener("wheel",e,t)}function o_(s,e,t){s.removeEventListener("wheel",e,t)}});var Zv=de((UEe,Qv)=>{var s_=4,a_=.001,l_=1e-7,u_=10,ih=11,Vg=1/(ih-1),c_=typeof Float32Array=="function";function qv(s,e){return 1-3*e+3*s}function Xv(s,e){return 3*e-6*s}function Yv(s){return 3*s}function kg(s,e,t){return((qv(e,t)*s+Xv(e,t))*s+Yv(e))*s}function $v(s,e,t){return 3*qv(e,t)*s*s+2*Xv(e,t)*s+Yv(e)}function h_(s,e,t,n,i){var o,a,l=0;do a=e+(t-e)/2,o=kg(a,n,i)-s,o>0?t=a:e=a;while(Math.abs(o)>l_&&++l<u_);return a}function d_(s,e,t,n){for(var i=0;i<s_;++i){var o=$v(e,t,n);if(o===0)return e;var a=kg(e,t,n)-s;e-=a/o}return e}function f_(s){return s}Qv.exports=function(e,t,n,i){if(!(0<=e&&e<=1&&0<=n&&n<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===t&&n===i)return f_;for(var o=c_?new Float32Array(ih):new Array(ih),a=0;a<ih;++a)o[a]=kg(a*Vg,e,n);function l(u){for(var c=0,h=1,d=ih-1;h!==d&&o[h]<=u;++h)c+=Vg;--h;var f=(u-o[h])/(o[h+1]-o[h]),y=c+f*Vg,S=$v(y,e,n);return S>=a_?d_(u,y,e,n):S===0?y:h_(u,c,c+Vg,e,n)}return function(c){return c===0?0:c===1?1:kg(l(c),t,i)}}});var tT=de((zEe,Ug)=>{var oh=Zv(),Kv={ease:oh(.25,.1,.25,1),easeIn:oh(.42,0,1,1),easeOut:oh(0,0,.58,1),easeInOut:oh(.42,0,.58,1),linear:oh(0,0,1,1)};Ug.exports=g_;Ug.exports.makeAggregateRaf=eT;Ug.exports.sharedScheduler=eT();function g_(s,e,t){var n=Object.create(null),i=Object.create(null);t=t||{};var o=typeof t.easing=="function"?t.easing:Kv[t.easing];o||(t.easing&&console.warn("Unknown easing function in amator: "+t.easing),o=Kv.ease);var a=typeof t.step=="function"?t.step:Jv,l=typeof t.done=="function"?t.done:Jv,u=p_(t.scheduler),c=Object.keys(e);c.forEach(function(I){n[I]=s[I],i[I]=e[I]-s[I]});var h=typeof t.duration=="number"?t.duration:400,d=Math.max(1,h*.06),f,y=0;return f=u.next(C),{cancel:S};function S(){u.cancel(f),f=0}function C(){var I=o(y/d);y+=1,T(I),y<=d?(f=u.next(C),a(s)):(f=0,setTimeout(function(){l(s)},0))}function T(I){c.forEach(function(B){s[B]=i[B]*I+n[B]})}}function Jv(){}function p_(s){if(!s){var e=typeof window<"u"&&window.requestAnimationFrame;return e?m_():b_()}if(typeof s.next!="function")throw new Error("Scheduler is supposed to have next(cb) function");if(typeof s.cancel!="function")throw new Error("Scheduler is supposed to have cancel(handle) function");return s}function m_(){return{next:window.requestAnimationFrame.bind(window),cancel:window.cancelAnimationFrame.bind(window)}}function b_(){return{next:function(s){return setTimeout(s,1e3/60)},cancel:function(s){return clearTimeout(s)}}}function eT(){var s=new Set,e=new Set,t=0;return{next:i,cancel:i,clearAll:n};function n(){s.clear(),e.clear(),cancelAnimationFrame(t),t=0}function i(u){e.add(u),o()}function o(){t||(t=requestAnimationFrame(a))}function a(){t=0;var u=e;e=s,s=u,s.forEach(function(c){c()}),s.clear()}function l(u){e.delete(u)}}});var nT=de((WEe,rT)=>{rT.exports=function(e){y_(e);var t=P_(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e};function P_(s){var e=Object.create(null);return{on:function(t,n,i){if(typeof n!="function")throw new Error("callback is expected to be a function");var o=e[t];return o||(o=e[t]=[]),o.push({callback:n,ctx:i}),s},off:function(t,n){var i=typeof t>"u";if(i)return e=Object.create(null),s;if(e[t]){var o=typeof n!="function";if(o)delete e[t];else for(var a=e[t],l=0;l<a.length;++l)a[l].callback===n&&a.splice(l,1)}return s},fire:function(t){var n=e[t];if(!n)return s;var i;arguments.length>1&&(i=Array.prototype.splice.call(arguments,1));for(var o=0;o<n.length;++o){var a=n[o];a.callback.apply(a.ctx,i)}return s}}}function y_(s){if(!s)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],t=0;t<e.length;++t)if(s.hasOwnProperty(e[t]))throw new Error("Subject cannot be eventified, since it already has property '"+e[t]+"'")}});var oT=de((HEe,iT)=>{iT.exports=S_;function S_(s,e,t){typeof t!="object"&&(t={});var n=typeof t.minVelocity=="number"?t.minVelocity:5,i=typeof t.amplitude=="number"?t.amplitude:.25,o=typeof t.cancelAnimationFrame=="function"?t.cancelAnimationFrame:E_(),a=typeof t.requestAnimationFrame=="function"?t.requestAnimationFrame:x_(),l,u,c=342,h,d,f,y,S,C,T,I;return{start:w,stop:F,cancel:B};function B(){o(h),o(I)}function w(){l=s(),y=T=d=S=0,u=new Date,o(h),o(I),h=a(M)}function M(){var te=Date.now(),re=te-u;u=te;var J=s(),Pe=J.x-l.x,Ce=J.y-l.y;l=J;var he=1e3/(1+re);d=.8*Pe*he+.2*d,S=.8*Ce*he+.2*S,h=a(M)}function F(){o(h),o(I);var te=s();f=te.x,C=te.y,u=Date.now(),(d<-n||d>n)&&(y=i*d,f+=y),(S<-n||S>n)&&(T=i*S,C+=T),I=a(U)}function U(){var te=Date.now()-u,re=!1,J=0,Pe=0;y&&(J=-y*Math.exp(-te/c),J>.5||J<-.5?re=!0:J=y=0),T&&(Pe=-T*Math.exp(-te/c),Pe>.5||Pe<-.5?re=!0:Pe=T=0),re&&(e(f+J,C+Pe),I=a(U))}}function E_(){return typeof cancelAnimationFrame=="function"?cancelAnimationFrame:clearTimeout}function x_(){return typeof requestAnimationFrame=="function"?requestAnimationFrame:function(s){return setTimeout(s,16)}}});var uT=de((jEe,lT)=>{lT.exports=C_;function C_(s){if(s)return{capture:aT,release:aT};var e,t,n,i=!1;return{capture:o,release:a};function o(l){i=!0,t=window.document.onselectstart,n=window.document.ondragstart,window.document.onselectstart=sT,e=l,e.ondragstart=sT}function a(){!i||(i=!1,window.document.onselectstart=t,e&&(e.ondragstart=n))}}function sT(s){return s.stopPropagation(),!1}function aT(){}});var hT=de((qEe,cT)=>{cT.exports=A_;function A_(){this.x=0,this.y=0,this.scale=1}});var fT=de((XEe,F0)=>{F0.exports=v_;F0.exports.canAttach=dT;function v_(s,e){if(!dT(s))throw new Error("svg element is required for svg.panzoom to work");var t=s.ownerSVGElement;if(!t)throw new Error("Do not apply panzoom to the root <svg> element. Use its child instead (e.g. <g></g>). As of March 2016 only FireFox supported transform on the root element");e.disableKeyboardInteraction||t.setAttribute("tabindex",0);var n={getBBox:o,getScreenCTM:a,getOwner:i,applyTransform:u,initTransform:l};return n;function i(){return t}function o(){var c=s.getBBox();return{left:c.x,top:c.y,width:c.width,height:c.height}}function a(){var c=t.getCTM();return c||t.getScreenCTM()}function l(c){var h=s.getCTM();h===null&&(h=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix()),c.x=h.e,c.y=h.f,c.scale=h.a,t.removeAttributeNS(null,"viewBox")}function u(c){s.setAttribute("transform","matrix("+c.scale+" 0 0 "+c.scale+" "+c.x+" "+c.y+")")}}function dT(s){return s&&s.ownerSVGElement&&s.getCTM}});var pT=de((YEe,V0)=>{V0.exports=T_;V0.exports.canAttach=gT;function T_(s,e){var t=gT(s);if(!t)throw new Error("panzoom requires DOM element to be attached to the DOM tree");var n=s.parentElement;s.scrollTop=0,e.disableKeyboardInteraction||n.setAttribute("tabindex",0);var i={getBBox:a,getOwner:o,applyTransform:l};return i;function o(){return n}function a(){return{left:0,top:0,width:s.clientWidth,height:s.clientHeight}}function l(u){s.style.transformOrigin="0 0 0",s.style.transform="matrix("+u.scale+", 0, 0, "+u.scale+", "+u.x+", "+u.y+")"}}function gT(s){return s&&s.parentElement&&s.style}});var AT=de(($Ee,CT)=>{"use strict";var mT=jv(),k0=tT(),I_=nT(),w_=oT(),ET=uT(),L_=ET(),O_=ET(!0),R_=hT(),bT=fT(),PT=pT(),B_=1,M_=1.75,N_=300;CT.exports=xT;function xT(s,e){e=e||{};var t=e.controller;if(t||(bT.canAttach(s)?t=bT(s,e):PT.canAttach(s)&&(t=PT(s,e))),!t)throw new Error("Cannot create panzoom for the current type of dom element");var n=t.getOwner(),i={x:0,y:0},o=!1,a=new R_;t.initTransform&&t.initTransform(a);var l=typeof e.filterKey=="function"?e.filterKey:Kl,u=typeof e.pinchSpeed=="number"?e.pinchSpeed:1,c=e.bounds,h=typeof e.maxZoom=="number"?e.maxZoom:Number.POSITIVE_INFINITY,d=typeof e.minZoom=="number"?e.minZoom:0,f=typeof e.boundsPadding=="number"?e.boundsPadding:.05,y=typeof e.zoomDoubleClickSpeed=="number"?e.zoomDoubleClickSpeed:M_,S=e.beforeWheel||Kl,C=e.beforeMouseDown||Kl,T=typeof e.zoomSpeed=="number"?e.zoomSpeed:B_,I=yT(e.transformOrigin),B=e.enableTextSelection?O_:L_;D_(c),e.autocenter&&Qg();var w,M=0,F,U=!1,te=!1,re,J,Pe,Ce;"smoothScroll"in e&&!e.smoothScroll?Ce=G_():Ce=w_(ip,ap,e.smoothScroll);var he,pe,ie,Fr=!1;yh();var Ea={dispose:Ph,moveBy:ho,moveTo:ru,smoothMoveTo:sp,centerOn:bh,zoomTo:Aa,zoomAbs:xa,smoothZoom:fo,smoothZoomAbs:au,showRectangle:$g,pause:Xg,resume:Yg,isPaused:dh,getTransform:Zg,getMinZoom:Kg,setMinZoom:Jg,getMaxZoom:ep,setMaxZoom:eu,getTransformOrigin:tu,setTransformOrigin:tp,getZoomSpeed:rp,setZoomSpeed:np};I_(Ea);var uh=typeof e.initialX=="number"?e.initialX:a.x,ch=typeof e.initialY=="number"?e.initialY:a.y,hh=typeof e.initialZoom=="number"?e.initialZoom:a.scale;return(uh!=a.x||ch!=a.y||hh!=a.scale)&&xa(uh,ch,hh),Ea;function Xg(){Sh(),Fr=!0}function Yg(){Fr&&(yh(),Fr=!1)}function dh(){return Fr}function $g(D){var q=n.getBoundingClientRect(),Y=jn(q.width,q.height),Q=D.right-D.left,Ae=D.bottom-D.top;if(!Number.isFinite(Q)||!Number.isFinite(Ae))throw new Error("Invalid rectangle");var Ue=Y.x/Q,ze=Y.y/Ae,Rt=Math.min(Ue,ze);a.x=-(D.left+Q/2)*Rt+Y.x/2,a.y=-(D.top+Ae/2)*Rt+Y.y/2,a.scale=Rt}function jn(D,q){if(t.getScreenCTM){var Y=t.getScreenCTM(),Q=Y.a,Ae=Y.d,Ue=Y.e,ze=Y.f;i.x=D*Q-Ue,i.y=q*Ae-ze}else i.x=D,i.y=q;return i}function Qg(){var D,q,Y=0,Q=0,Ae=gh();if(Ae)Y=Ae.left,Q=Ae.top,D=Ae.right-Ae.left,q=Ae.bottom-Ae.top;else{var Ue=n.getBoundingClientRect();D=Ue.width,q=Ue.height}var ze=t.getBBox();if(!(ze.width===0||ze.height===0)){var Rt=q/ze.height,go=D/ze.width,Ni=Math.min(go,Rt);a.x=-(ze.left+ze.width/2)*Ni+D/2+Y,a.y=-(ze.top+ze.height/2)*Ni+q/2+Q,a.scale=Ni}}function Zg(){return a}function Kg(){return d}function Jg(D){d=D}function ep(){return h}function eu(D){h=D}function tu(){return I}function tp(D){I=yT(D)}function rp(){return T}function np(D){if(!Number.isFinite(D))throw new Error("Zoom speed should be a number");T=D}function ip(){return{x:a.x,y:a.y}}function ru(D,q){a.x=D,a.y=q,nu(),Mi("pan"),iu()}function fh(D,q){ru(a.x+D,a.y+q)}function nu(){var D=gh();if(!!D){var q=!1,Y=op(),Q=D.left-Y.right;return Q>0&&(a.x+=Q,q=!0),Q=D.right-Y.left,Q<0&&(a.x+=Q,q=!0),Q=D.top-Y.bottom,Q>0&&(a.y+=Q,q=!0),Q=D.bottom-Y.top,Q<0&&(a.y+=Q,q=!0),q}}function gh(){if(!!c){if(typeof c=="boolean"){var D=n.getBoundingClientRect(),q=D.width,Y=D.height;return{left:q*f,top:Y*f,right:q*(1-f),bottom:Y*(1-f)}}return c}}function op(){var D=t.getBBox(),q=ph(D.left,D.top);return{left:q.x,top:q.y,right:D.width*a.scale+q.x,bottom:D.height*a.scale+q.y}}function ph(D,q){return{x:D*a.scale+a.x,y:q*a.scale+a.y}}function iu(){o=!0,w=window.requestAnimationFrame(lp)}function mh(D,q,Y){if(U0(D)||U0(q)||U0(Y))throw new Error("zoom requires valid numbers");var Q=a.scale*Y;if(Q<d){if(a.scale===d)return;Y=d/a.scale}if(Q>h){if(a.scale===h)return;Y=h/a.scale}var Ae=jn(D,q);if(a.x=Ae.x-Y*(Ae.x-a.x),a.y=Ae.y-Y*(Ae.y-a.y),c&&f===1&&d===1)a.scale*=Y,nu();else{var Ue=nu();Ue||(a.scale*=Y)}Mi("zoom"),iu()}function xa(D,q,Y){var Q=Y/a.scale;mh(D,q,Q)}function bh(D){var q=D.ownerSVGElement;if(!q)throw new Error("ui element is required to be within the scene");var Y=D.getBoundingClientRect(),Q=Y.left+Y.width/2,Ae=Y.top+Y.height/2,Ue=q.getBoundingClientRect(),ze=Ue.width/2-Q,Rt=Ue.height/2-Ae;ho(ze,Rt,!0)}function sp(D,q){ho(D-a.x,q-a.y,!0)}function ho(D,q,Y){if(!Y)return fh(D,q);he&&he.cancel();var Q={x:0,y:0},Ae={x:D,y:q},Ue=0,ze=0;he=k0(Q,Ae,{step:function(Rt){fh(Rt.x-Ue,Rt.y-ze),Ue=Rt.x,ze=Rt.y}})}function ap(D,q){Er(),ru(D,q)}function Ph(){Sh()}function yh(){n.addEventListener("mousedown",ou,{passive:!1}),n.addEventListener("dblclick",Ih,{passive:!1}),n.addEventListener("touchstart",Ch,{passive:!1}),n.addEventListener("keydown",xh,{passive:!1}),mT.addWheelListener(n,Lh,{passive:!1}),iu()}function Sh(){mT.removeWheelListener(n,Lh),n.removeEventListener("mousedown",ou),n.removeEventListener("keydown",xh),n.removeEventListener("dblclick",Ih),n.removeEventListener("touchstart",Ch),w&&(window.cancelAnimationFrame(w),w=0),Ce.cancel(),Oi(),wh(),B.release(),as()}function lp(){o&&Eh()}function Eh(){o=!1,t.applyTransform(a),Mi("transform"),w=0}function xh(D){var q=0,Y=0,Q=0;if(D.keyCode===38?Y=1:D.keyCode===40?Y=-1:D.keyCode===37?q=1:D.keyCode===39?q=-1:D.keyCode===189||D.keyCode===109?Q=1:(D.keyCode===187||D.keyCode===107)&&(Q=-1),!l(D,q,Y,Q)){if(q||Y){D.preventDefault(),D.stopPropagation();var Ae=n.getBoundingClientRect(),Ue=Math.min(Ae.width,Ae.height),ze=.05,Rt=Ue*ze*q,go=Ue*ze*Y;ho(Rt,go)}if(Q){var Ni=Bi(Q*100),Ue=I?Ri():up();Aa(Ue.x,Ue.y,Ni)}}}function up(){var D=n.getBoundingClientRect();return{x:D.width/2,y:D.height/2}}function Ch(D){if(cp(D),D.touches.length===1)return dp(D,D.touches[0]);D.touches.length===2&&(Pe=Th(D.touches[0],D.touches[1]),ie=!0,Ah())}function cp(D){e.onTouch&&!e.onTouch(D)||(D.stopPropagation(),D.preventDefault())}function hp(D){e.onDoubleClick&&!e.onDoubleClick(D)||(D.preventDefault(),D.stopPropagation())}function dp(D){var q=D.touches[0],Y=qr(q);F=Y;var Q=jn(Y.x,Y.y);re=Q.x,J=Q.y,Ce.cancel(),Ah()}function Ah(){U||(U=!0,document.addEventListener("touchmove",vh),document.addEventListener("touchend",Ca),document.addEventListener("touchcancel",Ca))}function vh(D){if(D.touches.length===1){D.stopPropagation();var q=D.touches[0],Y=qr(q),Q=jn(Y.x,Y.y),Ae=Q.x-re,Ue=Q.y-J;Ae!==0&&Ue!==0&&Oh(),re=Q.x,J=Q.y,ho(Ae,Ue)}else if(D.touches.length===2){ie=!0;var ze=D.touches[0],Rt=D.touches[1],go=Th(ze,Rt),Ni=1+(go/Pe-1)*u,uu=qr(ze),Rh=qr(Rt);if(re=(uu.x+Rh.x)/2,J=(uu.y+Rh.y)/2,I){var Y=Ri();re=Y.x,J=Y.y}Aa(re,J,Ni),Pe=go,D.stopPropagation(),D.preventDefault()}}function Ca(D){if(D.touches.length>0){var q=qr(D.touches[0]),Y=jn(q.x,q.y);re=Y.x,J=Y.y}else{var Q=new Date;if(Q-M<N_)if(I){var q=Ri();fo(q.x,q.y,y)}else fo(F.x,F.y,y);M=Q,as(),wh()}}function Th(D,q){var Y=D.clientX-q.clientX,Q=D.clientY-q.clientY;return Math.sqrt(Y*Y+Q*Q)}function Ih(D){hp(D);var q=qr(D);I&&(q=Ri()),fo(q.x,q.y,y)}function ou(D){if(!C(D)){if(U)return D.stopPropagation(),!1;var q=D.button===1&&window.event!==null||D.button===0;if(!!q){Ce.cancel();var Y=qr(D),Q=jn(Y.x,Y.y);return re=Q.x,J=Q.y,document.addEventListener("mousemove",su),document.addEventListener("mouseup",Li),B.capture(D.target||D.srcElement),!1}}}function su(D){if(!U){Oh();var q=qr(D),Y=jn(q.x,q.y),Q=Y.x-re,Ae=Y.y-J;re=Y.x,J=Y.y,ho(Q,Ae)}}function Li(){B.release(),as(),Oi()}function Oi(){document.removeEventListener("mousemove",su),document.removeEventListener("mouseup",Li),te=!1}function wh(){document.removeEventListener("touchmove",vh),document.removeEventListener("touchend",Ca),document.removeEventListener("touchcancel",Ca),te=!1,ie=!1,U=!1}function Lh(D){if(!S(D)){Ce.cancel();var q=D.deltaY;D.deltaMode>0&&(q*=100);var Y=Bi(q);if(Y!==1){var Q=I?Ri():qr(D);Aa(Q.x,Q.y,Y),D.preventDefault()}}}function qr(D){var q,Y,Q=n.getBoundingClientRect();return q=D.clientX-Q.left,Y=D.clientY-Q.top,{x:q,y:Y}}function fo(D,q,Y){var Q=a.scale,Ae={scale:Q},Ue={scale:Y*Q};Ce.cancel(),Er(),pe=k0(Ae,Ue,{step:function(ze){xa(D,q,ze.scale)},done:lu})}function au(D,q,Y){var Q=a.scale,Ae={scale:Q},Ue={scale:Y};Ce.cancel(),Er(),pe=k0(Ae,Ue,{step:function(ze){xa(D,q,ze.scale)}})}function Ri(){var D=n.getBoundingClientRect();return{x:D.width*I.x,y:D.height*I.y}}function Aa(D,q,Y){return Ce.cancel(),Er(),mh(D,q,Y)}function Er(){pe&&(pe.cancel(),pe=null)}function Bi(D){var q=Math.sign(D),Y=Math.min(.25,Math.abs(T*D/128));return 1-q*Y}function Oh(){te||(Mi("panstart"),te=!0,Ce.start())}function as(){te&&(ie||Ce.stop(),Mi("panend"))}function lu(){Mi("zoomend")}function Mi(D){Ea.fire(D,Ea)}}function yT(s){if(!!s){if(typeof s=="object")return(!Zl(s.x)||!Zl(s.y))&&ST(s),s;ST()}}function ST(s){throw console.error(s),new Error(["Cannot parse transform origin.","Some good examples:",'  "center center" can be achieved with {x: 0.5, y: 0.5}','  "top center" can be achieved with {x: 0.5, y: 0}','  "bottom right" can be achieved with {x: 1, y: 1}'].join(`
`))}function Kl(){}function D_(s){var e=typeof s;if(!(e==="undefined"||e==="boolean")){var t=Zl(s.left)&&Zl(s.top)&&Zl(s.bottom)&&Zl(s.right);if(!t)throw new Error("Bounds object is not valid. It can be: undefined, boolean (true|false) or an object {left, top, right, bottom}")}}function Zl(s){return Number.isFinite(s)}function U0(s){return Number.isNaN?Number.isNaN(s):s!==s}function G_(){return{start:Kl,stop:Kl,cancel:Kl}}function __(){if(typeof document>"u")return;var s=document.getElementsByTagName("script");if(!s)return;for(var e,t=0;t<s.length;++t){var n=s[t];if(n.src&&n.src.match(/\bpanzoom(\.min)?\.js/)){e=n;break}}if(!e)return;var i=e.getAttribute("query");if(!i)return;var o=e.getAttribute("name")||"pz",a=Date.now();l();function l(){var h=document.querySelector(i);if(!h){var d=Date.now(),f=d-a;if(f<2e3){setTimeout(l,100);return}console.error("Cannot find the panzoom element",o);return}var y=u(e);console.log(y),window[o]=xT(h,y)}function u(h){for(var d=h.attributes,f={},y=0;y<d.length;++y){var S=d[y],C=c(S);C&&(f[C.name]=C.value)}return f}function c(h){if(!!h.name){var d=h.name[0]==="p"&&h.name[1]==="z"&&h.name[2]==="-";if(!!d){var f=h.name.substr(3),y=JSON.parse(h.value);return{name:f,value:y}}}}}__()});function Py(s,e){let t=document.getElementById(s);t.ondragover=n=>{n.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=n=>{n.preventDefault(),t.classList.remove("active");let i=n.dataTransfer.items[0];i.kind==="file"&&e(i.getAsFile())},t.onclick=()=>{let n=document.createElement("input");n.type="file",n.onchange=()=>n.files.length&&e(n.files[0]),n.click()}}var sx=ne(xy());var vy=ne(po());var us=class{constructor(){this.attrs=[];this._parent=null}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t==e)return!0;return!1}};var mo=class extends us{constructor(e,t){super();this.source=e,this.target=t,e!=t?(e.outEdges.add(this),t.inEdges.add(this)):e.selfEdges.add(this)}add(){this.source!=this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!=this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!=this.target.parent}EdgeToAncestor(){return this.source instanceof We&&this.target.isDescendantOf(this.source)?1:this.target instanceof We&&this.source.isDescendantOf(this.target)?2:0}};var vt=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var bo=class extends us{constructor(e){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=e}get id(){return this._id}set id(e){this._id=e}toString(){return this.id}*_edges(){for(let e of this.inEdges)yield e;for(let e of this.outEdges)yield e;for(let e of this.selfEdges)yield e}addInEdge(e){vt.assert(e!=null),vt.assert(e.target==this),this.inEdges.add(e)}addOutEdge(e){this.outEdges.add(e)}addSelfEdge(e){this.selfEdges.add(e)}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isUnderCollapsedGraph(){return this.parent!=null&&this.parent.isCollapsed}};var Ap=class{constructor(){this.nodeMap=new Map}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof We&&(yield e)}find(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}*nodesDeep(){for(let e of this.nodes_())if(yield e,e instanceof We)for(let t of e.nodeCollection.nodesDeep())yield t}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}hasNode(e){if(this.nodeMap.has(e))return!0;for(let t of this.nodeMap)if(t[1]instanceof We&&t[1].nodeCollection.hasNode(e))return!0;return!1}getNode(e){let t=this.nodeMap.get(e);if(t!=null)return t;for(let n of this.nodeMap)if(n[1]instanceof We&&(t=n[1].nodeCollection.getNode(e),t!=null))return t}get nodeShallowCount(){return this.nodeMap.size}get nodeDeepCount(){let e=this.nodeMap.size;for(let t of this.nodeMap.values())t instanceof We&&(e+=t.nodeCollection.nodeDeepCount);return e}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.getNode(e.id)==null&&this.nodeMap.set(e.id,e)}addEdge(e){this.addNode(e.source),this.addNode(e.target),e.source!=e.target?(e.source.outEdges.add(e),e.target.inEdges.add(e)):e.source.selfEdges.add(e)}removeNode(e){for(let t of e.outEdges)t.target.inEdges.delete(t);for(let t of e.inEdges)t.source.outEdges.delete(t);this.nodeMap.delete(e.id);for(let t of this.nodeMap.values())t instanceof We&&t.nodeCollection.nodeMap.delete(e.id)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!=e||t.source==t.target||!this.nodeMap.has(t.target.id))return!1;for(let t of e.inEdges)return!(t.target!=e||t.source==t.target||!this.nodeMap.has(t.source.id));for(let t of e.selfEdges)if(t.target!=t.source||t.source==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap)if(!this.nodeIsConsistent(e[1]))return!1;return!0}};var We=class extends bo{constructor(e="__graph__"){super(e);this.isCollapsed=!1;this.nodeCollection=new Ap}*graphs(){for(let e of this.nodeCollection.graphs)yield e}noEmptySubgraphs(){for(let e of this.subgraphs())if(e.shallowNodeCount==0)return!1;return!0}hasSubgraphs(){for(let e of this.shallowNodes)if(e instanceof We)return!0;return!1}*subgraphs(){for(let e of this.deepNodes)e instanceof We&&(yield e)}isEmpty(){return this.shallowNodeCount==0}setEdge(e,t){let n=this.nodeCollection.find(e);if(n==null)return;let i=this.nodeCollection.find(t);if(i==null)return;let o=new mo(n,i);return this.addEdge(o),o}get shallowNodes(){return this.nodeCollection.nodesShallow}get deepNodes(){return this.nodeCollection.nodesDeep()}findNode(e){return this.nodeCollection.find(e)}get edges(){return this.nodeCollection.edges}*deepEdges(){for(let e of this.deepNodes){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}isConsistent(){return this.nodeCollection.isConsistent()}nodeIsConsistent(e){return this.nodeCollection.nodeIsConsistent(e)}removeNode(e){this.nodeCollection.removeNode(e)}addNode(e){return e.parent=this,this.nodeCollection.addNode(e),e}addEdge(e){this.nodeCollection.addEdge(e)}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){return this.nodeCollection.nodeDeepCount}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(e){for(;e!=null&&e.parent!=this;)e=e.parent;return e}deepEdgesCount(){let e=0;for(let t of this.deepNodes)e+=t.outDegree+t.selfDegree;return e}};function*Ty(s){let e=new Set,t=new vy.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(i(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of n(l))i(u,t,e)}yield a}function*n(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function i(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function vp(s,e){e.parent&&e.parent.nodeCollection.nodeMap.delete(e.id),s.nodeCollection.nodeMap.set(e.id,e),e.parent=s}var Tp=class{static solve(e,t,n,i,o,a){let l=e*o-i*t;if(!(Math.abs(l)<Tp.eps))return{x:(n*o-a*t)/l,y:(e*a-i*n)/l}}},Tn=Tp;Tn.eps=1e-8;var Po=class{static RoundPoint(e){return new p(Po.RoundDouble(e.x),Po.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*Po.mult)/Po.mult}},E=Po;E.distanceEpsilonPrecision=6,E.mult=Math.pow(10,6),E.defaultLeafBoxesOffset=.5,E.lineSegmentThreshold=.05,E.intersectionEpsilon=1e-4,E.distanceEpsilon=Math.pow(10,-Po.distanceEpsilonPrecision),E.squareOfDistanceEpsilon=Math.pow(10,-Po.distanceEpsilonPrecision*2),E.tolerance=1e-8;function Iy(s,e){return(s?1:0)-(e?1:0)}function ye(s,e){let t=s-e;return t<0?-1:t==0?0:1}function wa(s,e){let t=ye(s.y,e.y);return t||ye(s.x,e.x)}function wy(s,e){let t=ye(s.x,e.x);return t||ye(s.y,e.y)}function K(s,e){let t=s-e;return-E.distanceEpsilon<=t&&t<=E.distanceEpsilon}function Gh(s,e){return du(s,e)>0}function du(s,e){let t=s-e;return t<=-E.distanceEpsilon?-1:t>=E.distanceEpsilon?1:0}function Ie(s,e){return s.sub(e).length}var p=class{static ProjectionToLine(e,t,n){let i=t.sub(e),o=i.length;if(o<E.distanceEpsilon)return e;i=i.div(o);let a=n.sub(e).dot(i);return e.add(i.mul(a))}static RayIntersectsRayInteriors(e,t,n,i){let o=p.lineLineIntersection(e,e.add(t),n,n.add(i));if(!!o&&o.sub(e).dot(t.div(t.l1))>E.distanceEpsilon&&o.sub(n).dot(i.div(i.l1))>E.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,n,i){let o=p.lineLineIntersection(e,t,n,n.add(i));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(n).dot(i)<0)&&a.dot(a)>E.squareOfDistanceEpsilon&&l.dot(l)>=E.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,n){return p.signedDoubledTriangleArea(e,t,n)>=0}static PointToTheLeftOfLine(e,t,n){return p.signedDoubledTriangleArea(e,t,n)>0}static PointIsInsideCone(e,t,n,i){return p.PointToTheRightOfLineOrOnLine(e,t,n)&&p.PointToTheLeftOfLineOrOnLine(e,t,i)}static PointToTheRightOfLineOrOnLine(e,t,n){return p.signedDoubledTriangleArea(t,n,e)<=0}static PointToTheRightOfLine(e,t,n){return p.signedDoubledTriangleArea(t,n,e)<0}static closeIntersections(e,t){return p.close(e,t,E.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=ye(this.x,e.x);return t!=0?t:ye(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,n){return e.sub(t).length<=n}static closeSquare(e,t,n){let i=t.sub(e);return i.dot(i)<=n}static closeDistEps(e,t,n=E.distanceEpsilon){return e.sub(t).length<=n}normalize(){let e=this.length;return new p(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new p(this.x*e,this.y*t)}add(e){return new p(this.x+e.x,this.y+e.y)}sub(e){return new p(this.x-e.x,this.y-e.y)}mul(e){return new p(this.x*e,this.y*e)}div(e){return new p(this.x/e,this.y/e)}equal(e){return e.x==this.x&&e.y==this.y}neg(){return new p(-this.x,-this.y)}static lineLineIntersection(e,t,n,i){let o=t.sub(e),a=n.sub(i),l=n.sub(e),u=Tn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!=null)return e.add(o.mul(u.x))}static segSegIntersection(e,t,n,i){let o=t.sub(e),a=n.sub(i),l=n.sub(e),u=E.tolerance,c=Tn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!=null&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,n){let i=e.length,o=t.length;return i<n||o<n?!0:(e=e.div(i),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<n)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new p(-this.y,this.x)}rotate90Cw(){return new p(this.y,-this.x)}clone(){return new p(this.x,this.y)}rotate(e){let t=Math.cos(e),n=Math.sin(e);return new p(t*this.x-n*this.y,n*this.x+t*this.y)}static mkPoint(e,t,n,i){return t.mul(e).add(i.mul(n))}static convSum(e,t,n){return t.add(n.sub(t).mul(e))}static anglePCP(e,t,n){return p.angle(e.sub(t),n.sub(t))}static angle(e,t){let n=e.x,i=e.y,o=t.x,a=t.y,l=n*a-i*o,u=n*o+i*a;if(Math.abs(u)<E.tolerance)return Math.abs(l)<E.tolerance?0:l<-E.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<E.tolerance)return u<-E.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-E.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,n){return(t.x-e.x)*(n.y-e.y)-(n.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,n){let i=p.signedDoubledTriangleArea(e,t,n);return i>E.distanceEpsilon?1:i<-E.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,n){let i=p.signedDoubledTriangleArea(e,t,n);return i>E.intersectionEpsilon?1:i<-E.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a=i.dot(o),l=i.dot(i);return a<=0+E.tolerance?t:l<=a+E.tolerance?n:t.add(i.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,n){return p.signedDoubledTriangleArea(e,t,n)>=0}static pointToTheLeftOfLine(e,t,n){return p.signedDoubledTriangleArea(e,t,n)>0}static pointToTheRightOfLineOrOnLine(e,t,n){return p.signedDoubledTriangleArea(t,n,e)<=0}static pointToTheRightOfLine(e,t,n){return p.signedDoubledTriangleArea(t,n,e)<0}static canProject(e,t,n){let i=n.sub(t);return!(e.sub(t).dot(i)<0||e.sub(n).dot(i)>0)}static distToLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a,l;if((a=i.dot(o))<=E.tolerance)return{par:0,dist:o.length};if((l=i.dot(i))<=a+E.tolerance)return{par:1,dist:e.sub(n).length};let u=a/l;return{par:u,dist:t.add(i.mul(u)).length}}};var yt=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new yt;return t.point=e,t}};var xe=class{contains(e){let t=e.sub(this.corner),n=E.distanceEpsilon,i=t.dot(this.bRot);if(i>this.abRot+n||i<-n)return!1;let o=t.dot(this.aRot);return o<=this.baRot+n&&o>=-n}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let n=new xe,i=e.corner,o={minx:i.x,maxx:i.x,miny:i.y,maxy:i.y};return xe.pumpMinMax(o,e.aPlusCorner),xe.pumpMinMax(o,e.otherCorner),xe.pumpMinMax(o,e.bPlusCorner),xe.pumpMinMax(o,t.corner),xe.pumpMinMax(o,t.aPlusCorner),xe.pumpMinMax(o,t.otherCorner),xe.pumpMinMax(o,t.bPlusCorner),n.corner=new p(o.minx,o.miny),n.a=new p(0,o.maxy-o.miny),n.b=new p(o.maxx-o.minx,0),n.aPlusCorner=n.a.add(n.corner),n.otherCorner=n.b.add(n.aPlusCorner),n.bPlusCorner=n.b.add(n.corner),n.aRot=new p(-n.a.y,n.a.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new p(-n.b.y,n.b.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.a.dot(n.bRot),n.baRot=n.b.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=n.a.sub(n.b).length<E.distanceEpsilon,n}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(xe.separByA(e,t)||xe.separByA(t,e)||xe.separByB(e,t)||xe.separByB(t,e))==!1?!1:!(e.isSeg&&t.isSeg)||!p.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:xe.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let n=e.corner,i=e.otherCorner,o=t.corner,a=t.otherCorner,l=i.sub(n),u=0,c=l.dot(l),h=o.sub(n).dot(l),d=a.sub(n).dot(l);if(h>d){let f=h;h=d,d=f}return!(d<u-E.distanceEpsilon||h>c+E.distanceEpsilon)}static separByB(e,t){let n=E.distanceEpsilon,i=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(i>e.abRot+n){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+n)return!1;return!0}else if(i<-n){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-n)return!1;return!0}return!1}static separByA(e,t){let n=E.distanceEpsilon,i=t.corner.sub(e.corner),o=p.dot(i,e.aRot);return o>e.baRot+n?(i=t.aPlusCorner.sub(e.corner),!(p.dot(i,e.aRot)<=e.baRot+n||(i=t.bPlusCorner.sub(e.corner),p.dot(i,e.aRot)<=e.baRot+n)||(i=t.otherCorner.sub(e.corner),p.dot(i,e.aRot)<=e.baRot+n))):o<-n?(i=t.aPlusCorner.sub(e.corner),!(p.dot(i,e.aRot)>=-n||(i=t.bPlusCorner.sub(e.corner),p.dot(i,e.aRot)>=-n)||(i=t.otherCorner.sub(e.corner),p.dot(i,e.aRot)>=-n))):!1}static parallelogramByCornerSideSide(e,t,n){let i=new xe;return i.corner=e,i.a=t,i.b=n,i.aRot=new p(-t.y,t.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new p(-n.y,n.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.bRot.dot(t),i.baRot=n.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=t.sub(n).length<E.distanceEpsilon,i.aPlusCorner=t.add(e),i.otherCorner=n.add(i.aPlusCorner),i.bPlusCorner=n.add(e),i}static getParallelogramOfAGroup(e){let t=0,n=0,i=0,o=0,a=!0;for(let l of e){let u=JI(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=n=h,i=o=d):(h<t?t=h:h>n&&(n=h),d<i?i=d:d>o&&(o=d))}}return xe.parallelogramByCornerSideSide(new p(t,i),new p(0,o-i),new p(n-t,0))}};function*JI(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var R=class{constructor(e,t,n,i){this.parStart=0;this.parEnd=1;this.start=new p(e,t),this.end=new p(n,i)}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let n=this.value(e),i=this.value(t);return p.close(n,i,E.distanceEpsilon)?null:R.mkPP(n,i)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:xe.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new p(-e.y,e.x)}static mkPP(e,t){return new R(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,n){return new R(e.x,e.y,t,n)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new p(0,0)}thirdDerivative(e){return new p(0,0)}reverse(){return R.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return R.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<E.tolerance)return 0;let n=e/t;return n>1?1:n<0?0:n}transform(e){return R.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,n){let i=this.closestParameter(e);return i<t&&(i=t),i>n&&(i=n),i}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return k.mkPP(this.start,this.end)}clone(){return R.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a=i.dot(o);if(a<=0+E.tolerance)return 0;let l=i.dot(i);return l<=a+E.tolerance?1:a/l}closestParameter(e){return R.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,n,i){let o=p.lineLineIntersection(e,t,n,i);if(o!=null&&R.xIsBetweenPoints(e,t,o)&&R.xIsBetweenPoints(n,i,o))return o}static xIsBetweenPoints(e,t,n){return e.sub(n).dot(t.sub(n))<=E.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,n,i){let o=t.sub(e),a=i.sub(n),l=e.sub(n),u=p.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),f=o.dot(l),y=a.dot(l),S,C,T=Math.abs(u),I=T,B=T;T<E.tolerance?(S=0,I=1,C=y,B=d):(S=p.crossProduct(a,l),C=p.crossProduct(o,l),u<0&&(S=-S,C=-C),S<0?(S=0,C=y,B=d):S>I&&(S=I=1,C=y+h,B=d)),C<0?(C=0,-f<0?S=0:-f>c?S=I:(S=-f,I=c)):C>B&&(C=B=1,-f+h<0?S=0:-f+h>c?S=I:(S=-f+h,I=c));let w=Math.abs(S)<E.tolerance?0:S/I,M=Math.abs(C)<E.tolerance?0:C/B;return{parab:w,parcd:M,dist:l.add(o.mul(w).sub(a.mul(M))).length}}};function ew(s,e,t,n,i){return{parallelogram:t,seg:n,leafBoxesOffset:i,node:{low:s,high:e,chord:null}}}var nt=class{static distToSegm(e,t,n){let i=n.sub(t);if(i.length<E.intersectionEpsilon)return e.sub(t.add(n).div(2)).length;let o=new p(-i.y,i.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,n){let i=n.derivative(e),o=n.derivative(t),a=new p(-o.y,o.x),l=n.value(e),u=n.value(t),h=u.sub(l).dot(a),d=i.dot(a),f=Math.abs(h)<E.distanceEpsilon;if(!f&&Math.abs(d)<E.distanceEpsilon)return;let y=f?0:h/d;return i=i.mul(y),xe.parallelogramByCornerSideSide(l,i,u.sub(l).sub(i))}static createParallelogramNodeForCurveSeg(e,t,n,i){if(e==n.parStart&&t==n.parEnd&&p.close(n.start,n.end,E.distanceEpsilon))return nt.createNodeWithSegmentSplit(e,t,n,i);let a=n.value(e),l=n.value(t),u=l.sub(a),c=n.value((e+t)/2);if(nt.distToSegm(c,a,l)<=E.intersectionEpsilon&&u.dot(u)<E.lineSegmentThreshold*E.lineSegmentThreshold&&t-e<E.lineSegmentThreshold){let h=R.mkPP(a,l),d=h.pNodeOverICurve();d.seg=n;let f=d.node;return f.low=e,f.high=t,f.chord=h,d}if(nt.WithinEpsilon(n,e,t,i)){let h=nt.createParallelogramOnSubSeg(e,t,n);if(h!=null)return ew(e,t,h,n,i)}return nt.createNodeWithSegmentSplit(e,t,n,i)}static WithinEpsilon(e,t,n,i){let a=(n-t)/3,l=e.value(t),u=e.value(n);return nt.distToSegm(e.value(t+a),l,u)>i?!1:nt.distToSegm(e.value(t+a*(3-1)),l,u)<=i}static createParallelogramNodeForCurveSegDefaultOffset(e){return nt.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,E.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,n,i){let o={parallelogram:null,seg:n,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(nt.createParallelogramNodeForCurveSeg(e,.5*(e+t),n,i)),a.children.push(nt.createParallelogramNodeForCurveSeg(.5*(e+t),t,n,i)),o.parallelogram=xe.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var Qn=class{constructor(e,t,n,i,o){this.par0=e,this.par1=t,this.x=n,this.seg0=i,this.seg1=o}};var cs=class{static closestPoint(e,t,n,i,o){let u=n,c=0,h=0,d,f=!1;do{let y=e.value(u),S=e.derivative(u),C=e.secondDerivative(u),T=S.dot(S)+y.sub(t).dot(C);if(Math.abs(T)<E.tolerance)return u;d=y.sub(t).dot(S.div(T)),u-=d,u>o+E.tolerance?(u=o,h++):u<i-E.tolerance&&(u=i,h++),c++}while(Math.abs(d)>E.tolerance&&!(f=c>=5||h>=5));return f&&e.value(n).sub(t).length<E.distanceEpsilon&&(u=n),u}};var fe=class{offsetCurve(e,t){let n=t.sub(this.center),i=p.angle(this.aAxis,n);if(this.aAxis.mul(Math.cos(i)).add(this.bAxis.mul(Math.sin(i))).length<n.length){let a=this.aAxis.length,l=this.bAxis.length;return fe.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return fe.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,n){return new fe(0,Math.PI*2,e,t,n)}constructor(e,t,n,i,o){this.parStart=e,this.parEnd=t,this.aAxis=n,this.bAxis=i,this.center=o,this.pNode=null,this.setBoundingBox()}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new fe(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(p.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return p.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return p.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return p.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=nt.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(K(this.parStart,0)&&K(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=k.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,n,i,o,a){return new fe(e,t,n,i,new p(o,a))}static mkFullEllipsePPP(e,t,n){return new fe(0,Math.PI*2,e,t,n)}static mkFullEllipseNNP(e,t,n){return new fe(0,Math.PI*2,new p(e,0),new p(0,t),n)}static mkCircle(e,t){return fe.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new fe(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let n=this.parStart,i=this.parEnd,o=e+.001,a=e-.001;for(;i-n>E.distanceEpsilon;){let l=.5*(i+n),u=this.lengthPartial(this.parStart,l);if(u>o)i=l;else if(u<a)n=l;else return l}return(i+n)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),n=e.multiplyPoint(this.bAxis).sub(e.offset());return new fe(this.parStart,this.parEnd,t,n,e.multiplyPoint(this.center))}return this}closestParameterWithinBounds(e,t,n){let o=(n-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),f=d.dot(d);f<l&&(l=f,a=h)}a==0&&n==Math.PI*2&&(t=-Math.PI);let u=cs.closestPoint(this,e,a,t,n);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return v.lengthWithInterpolationAndThreshold(this.trim(e,t),E.lineSegmentThreshold/100)}get length(){return v.lengthWithInterpolation(this)}clone(){return new fe(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,n=8,i=(this.parEnd-this.parStart)/(n+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=n;c++){let h=this.parStart+c*i,d=e.sub(this.value(h)),f=d.dot(d);f<a&&(a=f,o=h)}let l=!1;o==0&&this.parEnd==Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=cs.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return p.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return k.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<E.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<E.tolerance&&p.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var Ip=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,n,i,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=n,this.bMin=o,this.aMax=i,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,n,i){return e*i-n*t}solve(){let e=0,t=10,n=0,i=100,o=!1;if(this.initValues(),this.curveA instanceof R&&this.curveB instanceof R){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<E.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<E.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<E.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+E.distanceEpsilon||u<this.aMin-E.distanceEpsilon||c>this.bMax+E.distanceEpsilon||c<this.bMin-E.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),n++,o=e>=t||n>=i||a.s==0&&a.t==0&&h}while((Math.abs(a.s)>=E.tolerance||Math.abs(a.t)>=E.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<E.distanceEpsilon*E.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!=0&&e.t!=0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let n=1;this.ti+e.t>this.bMax?n=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(n=(this.bMin-this.ti)/e.t);let i=Math.min(t,n);e.s*=i,e.t*=i}else e.s==0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,n=e.start,i=e.end,o=t.start,a=t.end,l=i.sub(n),u=l.length,c=0,h,d,f;if(u>E.distanceEpsilon){l=l.div(u),h=l.dot(i.sub(n)),d=l.dot(o.sub(n)),f=l.dot(a.sub(n));let y=!1;if(d>f){y=!0;let S=d;d=f,f=S}if(f<c)this.aSolution=0,this.bSolution=y?0:1;else if(d>h)this.aSolution=1,this.bSolution=y?1:0;else{let S=Math.min(h,f);this.aSolution=S/(h-c),this.bSolution=(S-d)/(f-d),y&&(this.bSolution=1-this.bSolution)}}else{let y=a.sub(o),S=y.length;if(S>E.distanceEpsilon)if(y=y.div(S),c=0,h=y.dot(a.sub(o)),d=y.dot(n.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let C=Math.min(h,d);this.bSolution=C/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Ne=class{constructor(e,t,n,i){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=n,this.b[3]=i,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=nt.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,n=t*e;return this.l.mul(n).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Ne.adjustParamTo01(e),t=Ne.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-E.tolerance)return new Ne(this.b[3],this.b[3],this.b[3],this.b[3]);let n=new Array(3),i=new Array(2),o=this.casteljau(e,n,i),a=new Ne(o,i[1],n[2],this.b[3]),l=a.casteljau((t-e)/(1-e),n,i);return new Ne(a.b[0],n[0],i[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,n){let i=1-e;for(let o=0;o<3;o++)t[o]=p.mkPoint(i,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)n[o]=p.mkPoint(i,t[o],e,t[o+1]);return p.mkPoint(i,n[0],e,n[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return p.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Ne(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.pBoxNode=null}scaleFromOrigin(e,t){return new Ne(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Ne.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,n,i){let o=i.sub(e).length,a=t.sub(e).length+n.sub(t).length+i.sub(n).length;if(a-o>E.lineSegmentThreshold){let l=p.middle(e,t),u=p.middle(t,n),c=p.middle(n,i),h=p.middle(l,u),d=p.middle(c,u),f=p.middle(h,d);return Ne.lengthOnControlPolygon(e,l,h,f)+Ne.lengthOnControlPolygon(f,d,c,i)}return(a+o)/2}get boundingBox(){let e=k.mkPP(this.b[0],this.b[1]);return e.add(this.b[2]),e.add(this.b[3]),e}transform(e){return new Ne(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,n){let i=(n-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*i+t)),c=u.dot(u);c<a&&(a=c,o=l*i+t)}return cs.closestPoint(this,e,o,t,n)}clone(){return new Ne(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Ne(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),n=this.Yp(e),i=t*t+n*n;return Math.sqrt(i*i*i)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let n=0,i=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<i&&(i=l,n=o*.125)}return cs.closestPoint(this,e,n,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),n=this.Yp(e),i=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+n*n),c=t*i+n*o;return 3*(c*c/u+u*(i*i+t*a+o*o+n*l))}Gp(e){let t=this.Xp(e),n=this.Yp(e),i=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+n*n)*(t*i+n*o)}getParameterAtLength(e){let t=0,n=1;for(;n-t>E.tolerance;){let i=(n+t)/2,o=this.evaluateError(e,i);if(o>0)n=i;else if(o<0)t=i;else return i}return(t+n)/2}evaluateError(e,t){let n=1-t,i=p.mkPoint(n,this.b[0],t,this.b[1]),o=p.mkPoint(n,this.b[1],t,this.b[2]),a=p.mkPoint(n,this.b[2],t,this.b[3]),l=p.mkPoint(n,i,t,o),u=p.mkPoint(n,o,t,a),c=p.mkPoint(n,l,t,u),h=Ne.lengthOnControlPolygon(this.b[0],i,l,c);return h>e+E.distanceEpsilon?1:h<e-E.distanceEpsilon?-1:0}};function tw(s){return s.seg.value(s.par)}function rw(s){return s.seg.derivative(s.par)}function nw(s){return s.seg.secondDerivative(s.par)}function iw(s){return s.seg.thirdDerivative(s.par)}var v=class{static CurvesIntersect(e,t){return e==t||v.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let n={start:e,end:t};this.adjustStartEndEndParametersToDomain(n);let i=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(i.segIndex<o.segIndex){let a=this.segs[i.segIndex],l=a.lengthPartial(i.par,a.parEnd);for(let u=i.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new v;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=v.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let n=new v;for(let i of this.segs)n.addSegment(i.scaleFromOrigin(e,t));return n}trim(e,t){let n={start:e,end:t};this.adjustStartEndEndParametersToDomain(n);let i=this.getSegIndexParam(n.start),o=this.getSegIndexParam(n.end);if(i.segIndex==o.segIndex)return this.segs[i.segIndex].trim(i.par,o.par);let a=new v;i.par<this.segs[i.segIndex].parEnd&&(a=a.addSegment(this.segs[i.segIndex].trim(i.par,this.segs[i.segIndex].parEnd)));for(let l=i.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let n=new v;return n.addSegment(this.trim(e,this.parEnd)),n.addSegment(this.trim(this.parStart,t)),n}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(!(e instanceof v))this.segs.push(e),this.parEnd_+=v.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=v.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let n of this.segs){let i=n.pNodeOverICurve();e.push(i.parallelogram),t.push(i)}return this.pBNode={parallelogram:xe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:E.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,n){let i=v.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return n&&i!=null&&(i=v.liftIntersectionToCurves(e,t,i)),i}static getAllIntersections(e,t,n){return e instanceof R?v.getAllIntersectionsOfLineAndICurve(e,t,n):v.getAllIntersectionsInternal(e,t,n)}static getAllIntersectionsInternal(e,t,n){let i=[];if(v.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),i),n)for(let o=0;o<i.length;o++)i[o]=v.liftIntersectionToCurves(e,t,i[o]);return i}static getAllIntersectionsOfLineAndICurve(e,t,n){return t instanceof $?v.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof v?v.getAllIntersectionsOfLineAndCurve(e,t,n):t instanceof fe&&t.isArc()?v.getAllIntersectionsOfLineAndArc(e,t):v.getAllIntersectionsInternal(e,t,n)}static getAllIntersectionsOfLineAndCurve(e,t,n){let i=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(xe.intersect(o.parallelogram,a.parallelogram)==!1)return i;let l=0;for(let u of t.segs){let c=v.getAllIntersections(e,u,!1);if(n){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)v.alreadyInside(i,h)||i.push(h)}return i}static closeIntersections(e,t){return p.close(e.x,t.x,E.intersectionEpsilon)}static closeIntersectionPoints(e,t){return p.close(e,t,E.intersectionEpsilon)}static alreadyInside(e,t){for(let n=0;n<e.length;n++){let i=e[n];if(v.closeIntersections(i,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let n=e.end.sub(e.start),i=[],o=n.length;if(o<E.distanceEpsilon){let d=e.start.sub(t.center);if(K(d.length,t.aAxis.length)){let f=p.angle(t.aAxis,d);t.parStart-E.tolerance<=f&&(f=Math.max(f,t.parStart),f<=t.parEnd+E.tolerance&&(f=Math.min(t.parEnd,f),i.push(new Qn(0,f,e.start,e,t))))}return i}let a=n.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-E.distanceEpsilon)return i;if(n=a.rotate90Cw(),K(c,h))v.tryToAddPointToLineCircleCrossing(e,t,i,u,o,n);else{let d=Math.sqrt(c*c-l*l),f=n.mul(d);v.tryToAddPointToLineCircleCrossing(e,t,i,u.add(f),o,n),v.tryToAddPointToLineCircleCrossing(e,t,i,u.sub(f),o,n)}return i}static tryToAddPointToLineCircleCrossing(e,t,n,i,o,a){let u=i.sub(e.start).dot(a);if(u<-E.distanceEpsilon||(u=Math.max(u,0),u>o+E.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=p.angle(t.aAxis,i.sub(t.center));t.parStart-E.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+E.tolerance&&(c=Math.min(t.parEnd,c),n.push(new Qn(u,c,i,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let n=[],i=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=v.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a!=null&&(v.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),v.oldIntersection(n,a.x)||n.push(new Qn(a.aSol,i+a.bSol,a.x,e,t))),i++}if(t.closed){let a=v.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a!=null&&(v.adjustSolution(e.start,e.end,o.point,t.start,a),v.oldIntersection(n,a.x)||n.push(new Qn(a.aSol,i+a.bSol,a.x,e,t)))}return n}static adjustSolution(e,t,n,i,o){v.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):v.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),v.closeIntersectionPoints(o.x,n)?(o.x=n,o.bSol=Math.floor(o.bSol)):v.closeIntersectionPoints(o.x,i)&&(o.x=i,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!xe.intersect(e.parallelogram,t.parallelogram))return null;let n=e.node,i=t.node,o=n.hasOwnProperty("children"),a=i.hasOwnProperty("children");if(o&&a)for(let l of n.children)for(let u of i.children){let c=v.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of i.children){let u=v.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of n.children){let u=v.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return v.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,n){if(!xe.intersect(e.parallelogram,t.parallelogram))return;let i=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(i&&o)for(let a of e.node.children)for(let l of t.node.children)v.curveCurveXWithParallelogramNodes(a,l,n);else if(o)for(let a of t.node.children)v.curveCurveXWithParallelogramNodes(e,a,n);else if(i)for(let a of e.node.children)v.curveCurveXWithParallelogramNodes(a,t,n);else n=v.crossOverLeaves(e,t,n)}static crossOverIntervalsOne(e,t){let n=e.node,i=t.node,o=(n.high-n.low)/2,a=(i.high-i.low)/2;for(let l=1;l<2;l++){let u=l*o+n.low;for(let c=1;c<2;c++){let h=c*a+i.low,d;if(n.chord==null&&i.chord==null?d=v.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,i.low,i.high,u,h):n.chord!=null&&i.chord==null?d=v.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,i.low,i.high,.5*l,h):n.chord==null?(d=v.crossWithinIntervalsWithGuess(e.seg,i.chord,n.low,n.high,0,1,u,.5*c),d!=null&&(d.bSol=i.low+d.bSol*(i.high-i.low))):(d=v.crossWithinIntervalsWithGuess(n.chord,i.chord,0,1,0,1,.5*l,.5*c),d!=null&&(d.aSol=n.low+d.aSol*(n.high-n.low),d.bSol=i.low+d.bSol*(i.high-i.low))),d!=null)return v.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return v.goDeeperOne(e,t)}static crossOverLeaves(e,t,n){let i=e.node,o=t.node,a=!1,l=(i.high-i.low)/2+i.low,u=(o.high-o.low)/2+o.low,c;return i.chord==null&&o.chord==null?c=v.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,o.low,o.high,l,u):i.chord!=null&&o.chord==null?(c=v.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,o.low,o.high,.5,u),c!=null&&(c.aSol=i.low+c.aSol*(i.high-i.low))):i.chord==null?(c=v.crossWithinIntervalsWithGuess(e.seg,o.chord,i.low,i.high,0,1,l,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=v.crossWithinIntervalsWithGuess(i.chord,o.chord,0,1,0,1,.5,.5),c!=null&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=i.low+c.aSol*(i.high-i.low))),c!=null&&(v.addIntersection(e,t,n,c),a=!0),a||v.goDeeper(n,e,t),n}static addIntersection(e,t,n,i){let o=e.node;v.closeIntersectionPoints(i.x,e.seg.value(o.low))?(i.x=e.seg.value(o.low),i.aSol=o.low):v.closeIntersectionPoints(i.x,e.seg.value(o.high))&&(i.x=e.seg.value(o.high),i.aSol=o.high);let a=t.node;if(v.closeIntersectionPoints(i.x,t.seg.value(a.low))?(i.x=t.seg.value(a.low),i.bSol=a.low):v.closeIntersectionPoints(i.x,t.seg.value(a.high))&&(i.x=t.seg.value(a.high),i.bSol=a.high),!v.oldIntersection(n,i.x)){let u=new Qn(i.aSol,i.bSol,i.x,e.seg,t.seg);n.push(u)}}static oldIntersection(e,t){for(let n of e)if(t.sub(n.x).length<E.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,n,i,o){let a=e.node,l=t.node;return v.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),n=a.low):v.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),n=a.high),v.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),i=l.low):v.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),i=l.high),new Qn(n,i,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,n,i,o,a,l){let u=this.liftParameterToCurve(e,n-a.parStart,a),c=this.liftParameterToCurve(t,i-l.parStart,l);return new Qn(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,n;if(e.seg0 instanceof v){let a=e.seg0.getSegParam(e.par0);t=a.seg,n=a.par}else n=e.par0,t=e.seg0;let i,o;if(e.seg1 instanceof v){let a=e.seg1.getSegParam(e.par1);o=a.par,i=a.seg}else o=e.par1,i=e.seg1;return new Qn(n,o,e.x,t,i)}static liftIntersectionToCurves(e,t,n){return v.liftIntersectionToCurves_(e,t,n.par0,n.par1,n.x,n.seg0,n.seg1)}static liftParameterToCurve(e,t,n){if(e==n)return t;if(!e.hasOwnProperty("segs"))return;let i=e,o=0;for(let a of i.segs){if(a==n)return t+o;o+=v.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let n=e.node,i=t.node;if(e.leafBoxesOffset>E.distanceEpsilon&&t.leafBoxesOffset>E.distanceEpsilon){let l=nt.createParallelogramNodeForCurveSeg(n.low,n.high,e.seg,e.leafBoxesOffset/2),u=nt.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>E.distanceEpsilon){let l=nt.createParallelogramNodeForCurveSeg(n.low,n.high,e.seg,e.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>E.distanceEpsilon){let l=nt.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);return v.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(n.low),a=e.seg.value(n.high);if(!p.closeDistEps(o,a)){let l=t.seg.value(i.low),u=t.seg.value(i.high);if(!p.closeDistEps(l,u)){let c=e.seg instanceof R?e.seg:R.mkPP(o,a),h=t.seg instanceof R?t.seg:R.mkPP(l,u),d=v.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d!=null)return v.adjustParameters(e,c,t,h,d),v.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,n){let i=t.node,o=n.node;if(t.leafBoxesOffset>E.distanceEpsilon&&n.leafBoxesOffset>E.distanceEpsilon){let a=nt.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2),l=nt.createParallelogramNodeForCurveSeg(o.low,o.high,n.seg,n.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(a,l,e)}else if(t.leafBoxesOffset>E.distanceEpsilon){let a=nt.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(a,n,e)}else if(n.leafBoxesOffset>E.distanceEpsilon){let a=nt.createParallelogramNodeForCurveSeg(o.low,o.high,n.seg,n.leafBoxesOffset/2);v.curveCurveXWithParallelogramNodes(t,a,e)}else{let a=t.seg.value(i.low),l=t.seg.value(i.high);if(!p.closeDistEps(a,l)){let u=n.seg.value(o.low),c=n.seg.value(o.high);if(!p.closeDistEps(u,c)){let h=t.seg instanceof R?t.seg:R.mkPP(a,l),d=n.seg instanceof R?n.seg:R.mkPP(u,c),f=v.crossWithinIntervalsWithGuess(h,d,0,1,0,1,.5,.5);f!=null&&(v.adjustParameters(t,h,n,d,f),v.addIntersection(t,n,e,f))}}}}static adjustParameters(e,t,n,i,o){if(t!=e.seg&&!(e.seg instanceof $))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(i!=n.seg&&!(n.seg instanceof $))o.bSol=n.seg.closestParameter(o.x);else{let a=n.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let i of this.segs){let o=t+i.parEnd-i.parStart;if(e>=t&&e<=o)return{par:e-t+i.parStart,seg:i};t=o}let n=this.segs[this.segs.length-1];return{seg:n,par:n.parEnd}}getSegIndexParam(e){let t=0,n=this.segs.length;for(let o=0;o<n;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let i=this.segs[n-1];return{segIndex:n-1,par:i.parEnd}}value(e){return tw(this.getSegParam(e))}derivative(e){return rw(this.getSegParam(e))}secondDerivative(e){return nw(this.getSegParam(e))}thirdDerivative(e){return iw(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,n,i,o,a,l,u){if(e instanceof R&&t instanceof R){let d=v.crossTwoLineSegs(e.start,e.end,t.start,t.end,n,i,o,a);if(d!=null)return d}let c=v.minDistWithinIntervals(e,t,n,i,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=E.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:p.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,n,i,o,a,l,u){let c=t.sub(e),h=n.sub(i),d=n.sub(e),f=Tn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(f==null)return;let y=f.x,S=f.y,C=e.add(c.mul(y));if(!(y<o-E.tolerance)&&(y=Math.max(y,o),!(y>a+E.tolerance)&&(y=Math.min(y,a),!(S<l-E.tolerance)&&(S=Math.max(S,l),!(S>u+E.tolerance)))))return S=Math.min(S,u),{aSol:y,bSol:S,x:C}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let n=2*t.boundingBox.diagonal,i=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new p(Math.cos(a*i),Math.sin(a*i)),u=R.mkPP(e,e.add(l.mul(n))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(v.AllIntersectionsAreGood(c,t)){for(let d of c)if(p.closeDistEps(d.x,e))return 1;if(c.length%2==1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let n=t.hasOwnProperty("segs"),i=null;if(n||t instanceof $&&(i=t.toCurve()),i){for(let o of e)if(!v.RealCut(v.DropIntersectionToSegs(o),i,!1))return!1}return!0}static RealCut(e,t,n){let i=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=i.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(p.closeDistEps(u,o.end)){let f=null;for(let C=0;C<t.segs.length-1;C++)if(t.segs[C]==o){f=t.segs[C+1];break}if(f==null)return!1;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parEnd))*y.dot(f.derivative(f.parStart))<E.tolerance)}if(p.closeDistEps(u,o.start)){let f=null;for(let C=t.segs.length-1;C>0;C--)if(t.segs[C]==o){f=t.segs[C-1];break}if(f==null)return!1;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parStart))*y.dot(f.derivative(f.parEnd))<E.tolerance)}let d=c.dot(h);return n?d>E.distanceEpsilon:Math.abs(d)>E.distanceEpsilon}static realCutWithClosedCurve(e,t,n){let i=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=i.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(p.closeDistEps(u,o.end)){let f=null;for(let C=0;C<t.segs.length;C++)if(t.segs[C]==o){f=t.segs[(C+1)%t.segs.length];break}if(f==null)throw new Error;let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parEnd))*y.dot(f.derivative(f.parStart))<E.tolerance)}if(p.closeDistEps(u,o.start)){let f=null;for(let C=0;C<t.segs.length;C++)if(t.segs[C]==o){f=t.segs[C>0?C-1:t.segs.length-1];break}let y=c.rotate(Math.PI/2);return!(y.dot(o.derivative(o.parStart))*y.dot(f.derivative(f.parEnd))<E.tolerance)}let d=c.dot(h);return n?d>E.distanceEpsilon:Math.abs(d)>E.distanceEpsilon}static minDistWithinIntervals(e,t,n,i,o,a,l,u){let c=new Ip(e,t,n,i,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.segs.length==0)return k.mkEmpty();let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return e}clone(){let e=new v;for(let t of this.segs)e.addSegment(t.clone());return e}getParameterAtLength(e){let t=0;for(let n of this.segs){let i=n.length;if(i>=e)return t+n.getParameterAtLength(e);e-=i,t+=n.parEnd-n.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new v;for(let n of this.segs)t.addSegment(n.transform(e));return t}closestParameterWithinBounds(e,t,n){let i=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>n)break;let u=v.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(n-a)),f=l.closestParameterWithinBounds(e,h,d),y=e.sub(l.value(f)),S=y.dot(y);S<o&&(i=a+f-l.parStart,o=S)}a+=u}return i}closestParameter(e){let t=0,n=Number.MAX_VALUE,i=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);u<n&&(t=i+a-o.parStart,n=u),i+=v.paramSpan(o)}return t}static addLineSegment(e,t,n){return e.addSegment(R.mkPP(t,n))}static addLineSegmentCNNP(e,t,n,i){return v.addLineSegment(e,new p(t,n),i)}static addLineSegmentCNNNN(e,t,n,i,o){v.addLineSegment(e,new p(t,n),new p(i,o))}static continueWithLineSegmentNN(e,t,n){v.addLineSegment(e,e.end,new p(t,n))}static continueWithLineSegmentP(e,t){v.addLineSegment(e,e.end,t)}static closeCurve(e){return v.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<E.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=v.paramSpan(t),Math.abs(e)<E.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<E.tolerance)return this.start==this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<E.tolerance)return t;e-=v.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let n=v.getAllIntersections(e,t,!0);if(n.length==0)return v.NonIntersectingCurveIsInsideOther(e,t);if(n.length==1)return e.start.equal(n[0].x)?v.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:v.PointRelativeToCurveLocation(e.start,t)==2;for(let i of v.PointsBetweenIntersections(e,n))if(v.PointRelativeToCurveLocation(i,t)==0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let n=t[t.length-1].par0,i=t[0].par0,o=e.parEnd-n+(i-e.parStart),a=n+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let n=e.parStart;n<e.parEnd;n+=.5){let i=v.PointRelativeToCurveLocation(e.value(n),t);if(i!=1)return i==2}return v.PointRelativeToCurveLocation(e.end,t)!=0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let n=v.getAllIntersections(e,t,!0);if(n.length==0)return v.NonIntersectingCurveIsInsideOther(e,t)||v.NonIntersectingCurveIsInsideOther(t,e);if(n.length==1)return e.start.equal(n[0].x)?v.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2||!t.start.equal(n[0].x)?v.PointRelativeToCurveLocation(t.start,e)==2:v.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)==2:v.PointRelativeToCurveLocation(e.start,t)==2;for(let i of v.PointsBetweenIntersections(e,n))if(v.PointRelativeToCurveLocation(i,t)==2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,n,i,o){let a=p.mkPoint(e,n.point,1-e,i.point),l=p.mkPoint(t,o.point,1-t,i.point),u=i.point.mul(2/3);return new Ne(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,n,i){let o=n.mul(i);return new Ne(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let n=t.next;if(n!=null)return{b:t,c:n}}static trimEdgeSplineWithNodeBoundaries(e,t,n,i){let o=n.parStart,a=n.parEnd;e!=null&&(o=v.findNewStart(n,o,e,i)),t!=null&&(a=v.findNewEnd(n,t,i,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?n.trim(l,u):n}static findNewEnd(e,t,n,i){let o=v.getAllIntersections(e,t,!0);if(o.length==0)return i=e.parEnd,i;if(n){i=e.parEnd;for(let a of o)a.par0<i&&(i=a.par0)}else{i=e.parStart;for(let a of o)a.par0>i&&(i=a.par0)}return i}static findNewStart(e,t,n,i){let o=v.getAllIntersections(e,n,!0);if(o.length==0){t=e.parStart;return}if(i){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof fe)return v.refineEllipse(e);if(e instanceof $)return e;if(e instanceof v&&v.allSegsAreLines(e)){let t=new $;for(let n of e.segs)t.addPoint(n.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof R))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),n=Math.PI/4,i=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(i*i+o*o),l=[];for(let c=0;c<4;c++){let h=n+c*Math.PI/2,d=e.value(h),f=e.derivative(h).normalize().mul(a),y=R.mkPP(d.sub(f),d.add(f));for(let S of v.getAllIntersections(t,y,!0))l.push(S)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new $;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new $;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};function ow(s,e,t,n,i,o){if(i instanceof R)return!0;for(let a of[1/3,.5,2/3]){let l=s*a+t*(1-a);if(p.closeSquare(i.value(l),p.mkPoint(a,e,1-a,n),o)==!1)return!1}return!0}function wp(s,e,t,n,i,o){let a=[];if(ow(s,e,t,n,i,o))a.push(e),a.push(n);else{let l=.5*(s+t),u=i.value(l);a=wp(s,e,l,u,i,o);let c=wp(l,u,t,n,i,o).slice(1);a=a.concat(c)}return a}function _h(s,e){return wp(s.parStart,s.start,s.parEnd,s.end,s,e)}var $=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new p(e,t))}isClockwise(){return p.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new yt;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=yt.mkFromPoint(e);t.polyline=this,this.startPoint!=null?p.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let n=t.sub(e).div(2);return xe.parallelogramByCornerSideSide(e,n,n)}static mkFromPoints(e){let t=new $;for(let n of e)t.addPoint(n);return t}static mkClosedFromPoints(e){let t=$.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],n=this.startPoint,i=0;for(;n.next!=null;){let o=$.parallelogramOfLineSeg(n.point,n.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:i,high:i+1,chord:R.mkPP(n.point,n.next.point)}}),n=n.next,i++}if(this.isClosed_){let o=$.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:i,high:i+1,chord:R.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:xe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=k.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return p.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new p(0,0)}thirdDerivative(e){return new p(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new $;t.addPoint(e.start);for(let n of e.segs)t.addPoint(n.end);return t.closed=e.start==e.end,t}trim(e,t){let n=this.toCurve();return n=n.trim(e,t),$.polylineFromCurve(n)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t==this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new $;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t==this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new $;for(let n of this.polylinePoints())t.addPoint(e.multiplyPoint(n.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,n){throw new Error("Method not implemented.")}closestParameter(e){let t=0,n=Number.MAX_VALUE,i=0,o=this.startPoint;for(;o.next!=null;){let a=R.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<n&&(n=c,t=l+i),o=o.next,i++}if(this.closed){let a=R.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<n&&(t=l+i)}return t}clone(){let e=new $;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t==this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new v;v.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)v.continueWithLineSegmentP(e,t.point);return this.closed&&v.continueWithLineSegmentP(e,this.startPoint.point),e}};var Bt=class{pad(e){this.width+=e*2}constructor(e,t){this.width=e,this.height=t}},k=class{static mkSizeCenter(e,t){let n=e.width/2,i=e.height/2;return new k({left:t.x-n,right:t.x+n,bottom:t.y-i,top:t.y+i})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return k.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=k.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),n=Math.min(this.right,e.right),i=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new k({left:t,bottom:i,right:n,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=e.sub(this.center);this.leftTop=this.leftTop.add(t),this.rightBottom=this.rightBottom.add(t)}intersectsOnY(e){return!(e.bottom_>this.top_+E.distanceEpsilon||e.top_<this.bottom_-E.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+E.distanceEpsilon||e.right<this.left_-E.distanceEpsilon)}static mkEmpty(){return new k({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e}get right(){return this.right_}set right(e){this.right_=e}get top(){return this.top_}set top(e){this.top_=e}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e}get leftBottom(){return new p(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new p(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new p(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new p(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}static mkPP(e,t){let n=new k({left:e.x,right:e.x,top:e.y,bottom:e.y});return n.add(t),n}static rectangleOnPoint(e){return new k({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,n){let i=e+n.width,o=t+n.height;return new k({left:e,right:i,top:o,bottom:t})}static getRectangleOnCoords(e,t,n,i){let o=new k({left:e,bottom:t,right:e,top:t});return o.add(new p(n,i)),o}static mkOnPoints(e){let t=k.mkEmpty();for(let n of e)t.add(n);return t}static rectangleOnRectangles(e){let t=k.mkEmpty();for(let n of e)t.addRecSelf(n);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,n=(this.left_+this.right_)/2;this.left_=n-t,this.right_=n+t}isEmpty(){return this.width<0}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,n=(this.top_+this.bottom_)/2;this.top_=n+t,this.bottom=n-t}static rectangleOfTwo(e,t){let n=new k({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return n.addRecSelf(t),n}containsWithPadding(e,t){return this.left_-t-E.distanceEpsilon<=e.x&&e.x<=this.right_+t+E.distanceEpsilon&&this.bottom_-t-E.distanceEpsilon<=e.y&&e.y<=this.top_+t+E.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addWithCheck(e){let t;(t=e.x<this.left_)?this.left_=e.x:(t=this.right_<e.x)&&(this.right_=e.x);let n;return(n=e.y>this.top_)?this.top_=e.y:(n=this.bottom_>e.y)&&(this.bottom=e.y),t||n}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let n=e.clone();return n.center=e.center.add(t),n}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?k.mkPP(new p(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new p(Math.min(e.right,t.right),Math.min(e.top,t.top))):k.mkEmpty()}perimeter(){let e=new $;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return k.mkPP(this.leftTop,this.rightBottom)}get size(){return new Bt(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let n=e.width/2,i=t.x-n,o=t.x+n,a=e.height/2,l=t.y-a,u=t.y+a;return new k({left:i,right:o,top:u,bottom:l})}addPointWithSize(e,t){let n=e.width/2,i=e.height/2;this.add(new p(t.x-n,t.y-i)),this.add(new p(t.x+n,t.y-i)),this.add(new p(t.x-n,t.y+i)),this.add(new p(t.x+n,t.y+i))}};var Fh=class{bind(){this.entity&&this.entity.setAttr(Fh.attachIndex,this)}constructor(e){this.entity=e,this.bind()}static getGeom(e){return e.getAttr(Fh.attachIndex)}},De=Fh;De.attachIndex=0;var pt=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,n){this.elements[e][t]=n}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return K(this.elements[0][0],1)&&K(this.elements[0][1],0)&&K(this.elements[0][2],0)&&K(this.elements[1][0],0)&&K(this.elements[1][1],1)&&K(this.elements[1][2],0)}offset(){return new p(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new pt(1,0,0,0,1,0)}constructor(e,t,n,i,o,a){this.elements=[[e,t,n],[i,o,a]]}static rotation(e){let t=Math.cos(e),n=Math.sin(e);return new pt(t,-n,0,n,t,0)}static scaleAroundCenterTransformation(e,t,n){let i=1-e,o=1-t;return new pt(e,0,i*n.x,0,t,o*n.y)}multiplyPoint(e){return new p(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new pt(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,n=-this.getElem(0,1)/e,i=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-n*this.getElem(1,2),l=-i*this.getElem(0,2)-o*this.getElem(1,2);return new pt(t,n,a,i,o,l)}};function Vh(s){return s.parEnd-s.parStart}var xr=class{static get DifferenceEpsilon(){return xr.differenceEpsilon}static EqualPP(e,t){return xr.Equal(e.x,t.x)&&xr.Equal(e.y,t.y)}static Equal(e,t){return xr.Compare(e,t)==0}static Compare(e,t){let n=0;return e+xr.DifferenceEpsilon<t?n=-1:t+xr.DifferenceEpsilon<e&&(n=1),n}static ComparePP(e,t){let n=xr.Compare(e.x,t.x);return n==0&&(n=xr.Compare(e.y,t.y)),n}static LessOrEqual(e,t){let n=xr.Compare(e,t);return n<0||n==0}static Less(e,t){return xr.Compare(e,t)<0}static GetDirections(e,t){return V.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return V.IsPureDirection(xr.GetDirections(e,t))}static IsPureDirectionD(e){return V.IsPureDirection(e)}static IsPureLower(e,t){let n=xr.GetDirections(e,t);return 2==n||1==n}static GetPureDirectionVV(e,t){return xr.GetDirections(e.point,t.point)}},N=xr;N.differenceEpsilon=E.distanceEpsilon/2;var V=class{constructor(e){this.Dir=e}get Right(){return new V(V.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>N.DifferenceEpsilon?t=2:e.x<-N.DifferenceEpsilon&&(t=8),e.y>N.DifferenceEpsilon?t=t|1:e.y<-N.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let n=0,i=t.x-e.x,o=t.y-e.y;return i>N.DifferenceEpsilon?n=2:-i>N.DifferenceEpsilon&&(n=8),o>N.DifferenceEpsilon?n|=1:-o>N.DifferenceEpsilon&&(n|=4),n}static DirectionFromPointToPoint(e,t){return V.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return V.IsPureDirection(V.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e==t||e==V.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)==2&&e++,(this.Dir&1)==1&&t++,(this.Dir&8)==8&&e--,(this.Dir&4)==4&&t--,new p(e,t)}static toPoint(e){return new V(e).ToPoint()}static negate(e){return new V(V.OppositeDir(e.Dir))}};var Zn=class{static createHexagon(e,t,n){let i=t/2,o=e/2,a=n.x,l=n.y;return $.mkClosedFromPoints([new p(o*-1+a,i*-1+l),new p(o+a,i*-1+l),new p(o+(i+a),0+l),new p(o+a,i+l),new p(o*-1+a,i+l),new p((o-i)*-1+a,0+l)])}static createOctagon(e,t,n){let i=e/2,o=t/2,a=new Array(8);a[0]=new p(i+Zn.octagonPad*i,o-o*Zn.octagonPad),a[3]=new p(a[0].x*-1,a[0].y),a[4]=new p(a[3].x,a[3].y*-1),a[7]=new p(a[0].x,a[0].y*-1),a[1]=new p(i-i*Zn.octagonPad,o+o*Zn.octagonPad),a[2]=new p(a[1].x*-1,a[1].y),a[6]=new p(a[1].x,a[1].y*-1),a[5]=new p(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(n);return $.mkClosedFromPoints(a)}static createInvertedHouse(e,t,n){let i=Zn.createHouse(e,t,n);return Zn.rotateCurveAroundCenterByDegree(i,n,180)}static createHouse(e,t,n){let i=e/2,o=t/2,a=n.x,l=n.y,u=new v;return v.addLineSegmentCNNNN(u,a-i,l-o,a+i,l-o),v.continueWithLineSegmentNN(u,a+i,l+o),v.continueWithLineSegmentNN(u,a,l+2*o),v.continueWithLineSegmentNN(u,a-i,l+o),v.closeCurve(u)}static CreateDiamond(e,t,n){let i=e,o=t,a=n.x,l=n.y,u=new v,c=[new p(a,l-o),new p(a+i,l),new p(a,l+o),new p(a-i,l)];return u.addSegs([R.mkPP(c[0],c[1]),R.mkPP(c[1],c[2]),R.mkPP(c[2],c[3]),R.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,n){return Zn.rotateCurveAroundCenterByRadian(e,t,n*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,n){let i=Math.cos(n),o=Math.sin(n),a=new pt(1,0,t.x,0,1,t.y).multiply(new pt(i,-o,0,o,i,0)).multiply(new pt(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return fe.mkCircle(e,t)}static createRectangle(e,t,n){let i=e/2,o=t/2,a=n.x,l=n.y,u=new v,c=[new p(a-i,l-o),new p(a+i,l-o),new p(a+i,l+o),new p(a-i,l+o)];return u.addSegs([R.mkPP(c[0],c[1]),R.mkPP(c[1],c[2]),R.mkPP(c[2],c[3]),R.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof v))return;let t=e.segs;if(t.length!=8&&t.length!=4)return;let n=t.length==8,i,o;for(let a=0;a<4;a++){let l=n?2*a+1:a;if(a==0){if(!(t[l]instanceof fe))return;let u=t[l];i=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof fe))return;let u=t[l];if(i!=u.aAxis.length||o!=u.bAxis.length)return}}return{radX:i,radY:o}}static mkRectangleWithRoundedCorners(e,t,n,i,o=new p(0,0)){if(n==0||i==0)return Zn.createRectangle(e,t,o);let a=new v,l=e/2;n>l/2&&(n=l/2);let u=t/2;i>u/2&&(i=u/2);let c=o.x,h=o.y,d=l-n,f=u-i,y=h+u,S=h-u,C=c-l,T=c+l,I=new p(n,0),B=new p(0,i);return d>0&&a.addSegment(R.mkPP(new p(c-d,S),new p(c+d,S))),a.addSegment(fe.mkEllipse(1.5*Math.PI,2*Math.PI,I,B,c+d,h-f)),f>0&&a.addSegment(R.mkPP(new p(T,h-f),new p(T,h+f))),a.addSegment(fe.mkEllipse(0,.5*Math.PI,I,B,c+d,h+f)),d>0&&a.addSegment(R.mkPP(new p(c+d,y),new p(c-d,y))),a.addSegment(fe.mkEllipse(.5*Math.PI,Math.PI,I,B,c-d,h+f)),f>0&&a.addSegment(R.mkPP(new p(C,h+f),new p(C,h-f))),a.addSegment(fe.mkEllipse(Math.PI,1.5*Math.PI,I,B,c-d,h-f)),a}},ve=Zn;ve.octagonPad=1/4;var La=class extends De{constructor(){super(...arguments);this.padding=1}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(e){(e!=null&&e.boundingBox.height<La.minHeight||e.boundingBox.width<La.minWidth)&&(e=ve.mkCircle(La.minWidth,e.boundingBox.center)),this._boundaryCurve=e}get id(){return this.node.id}toString(){return this.id}static mkNode(e,t){let n=new La(t);return n.boundaryCurve=e,n}get center(){return this.boundaryCurve.boundingBox.center}set center(e){let t=e.sub(this.center);this.boundaryCurve.translate(t)}fitBoundaryCurveToTarget(e){if(this.boundaryCurve!=null){let t=ve.isRoundedRect(this.boundaryCurve);if(t==null){let n=e.width/this.boundaryCurve.boundingBox.width,i=e.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(n,i),this.boundaryCurve.translate(e.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=ve.mkRectangleWithRoundedCorners(e.width,e.height,t.radX,t.radY,e.center)}}*inEdges(){for(let e of this.node.inEdges)yield De.getGeom(e)}*outEdges(){for(let e of this.node.outEdges)yield De.getGeom(e)}*selfEdges(){for(let e of this.node.selfEdges)yield De.getGeom(e)}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(e){!this.boundaryCurve||(Math.abs(e.width-this.width)<1e-4&&Math.abs(e.height-this.height)<1e-4?this.center=e.center:this.fitBoundaryCurveToTarget(e))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(e,t=!0){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e))}underCollapsedCluster(){return this.node!=null&&this.node.isUnderCollapsedGraph()}},$r=La;$r.minHeight=2,$r.minWidth=3;var He=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new He;return t.point=e,t}static mkSiteSP(e,t){let n=new He;return n.point=t,n.prev=e,e.next=n,n}static mkSiteSPS(e,t,n){let i=new He;return i.prev=e,i.point=t,i.next=n,e.next=i,n.prev=i,i}get turn(){return this.next==null||this.prev==null?0:p.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new He;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var it=class{static mkFromPoints(e){let t=null,n=null;for(let i of e)if(n==null)n=He.mkSiteP(i),t=new it(n);else{let o=He.mkSiteP(i);o.prev=n,n.next=o,n=o}return t}clone(){let e=this.headSite,t=null,n,i=null;for(;e!=null;)n=e.clone(),n.prev=t,t!=null?t.next=n:i=n,e=e.next,t=n;return new it(i)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield R.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new v,t=this.headSite,n;do{let i=v.findCorner(t);if(i==null)break;let o=it.createBezierSegOnSite(i.b);e.segs.length==0?p.closeDistEps(t.point,o.start)||v.addLineSegment(e,t.point,o.start):p.closeDistEps(e.end,o.start)||v.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=i.b}while(!0);return e.segs.length==0?p.closeDistEps(t.point,t.next.point)?e.segs.push(new Ne(t.point,t.point.add(new p(5,5)),t.point.add(new p(-5,5)),n.point)):v.addLineSegment(e,t.point,t.next.point):p.closeDistEps(e.end,t.next.point)||v.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,n=e.nextBezierCoefficient,i=e.prev,o=e.next,a=i.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(n).add(e.point.mul(1-n)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Ne.mkBezier([a,u,c,l])}};var dn=class{constructor(){this.length=dn.defaultArrowheadLength;this.width=0}clone(){let e=new dn;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=dn.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let n=dn.findTrimEndForArrowheadAtTarget(e);if(n==null||t>n-E.intersectionEpsilon||v.closeIntersectionPoints(e.curve.value(t),e.curve.value(n)))return!1;let i=e.curve.trim(t,n);return i==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=i,!0)}static getIntersectionsWithArrowheadCircle(e,t,n){let i=fe.mkFullEllipseNNP(t,t,n);return v.getAllIntersections(i,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=E.distanceEpsilon*E.distanceEpsilon,n=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=E.distanceEpsilon)return n;let i=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u==0)return;l=dn.getIntersectionsWithArrowheadCircle(i,o,i.end),n=l.length!=0?Math.max(...l.map(c=>c.par1)):i.parEnd,a=e.curve.value(n),o/=2}while(a.sub(i.start).lengthSquared<t||l.length==0);return n}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=E.distanceEpsilon)return e.curve.parStart;let t=E.distanceEpsilon*E.distanceEpsilon,n=e.sourceArrowhead.length,i,o=e.curve,a,l=10,u;for(;--l>0;){if(a=dn.getIntersectionsWithArrowheadCircle(o,n,o.start),a.length==0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),i=a.filter(c=>c.par1==u)[0].x,i.sub(o.end).lengthSquared>=t)return u;n/=2}}static trimSplineAndCalculateArrowheads(e,t,n){return dn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,n)}static trimSplineAndCalculateArrowheadsII(e,t,n,i,o){if(e.curve=v.trimEdgeSplineWithNodeBoundaries(t,n,i,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<E.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<E.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>E.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>E.intersectionEpsilon)&&!a&&(a=dn.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!=0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=i.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=i.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,n=e.target.center,i=n.sub(t),o=i.length,a;o<.001?(a=new p(1,0),n=t.add(a.rotate(Math.PI/2))):a=i.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=v.createBezierSegN(t,n,a,u);if(dn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}dn.createEdgeCurveWithNoTrimming(e,t,n)}static createEdgeCurveWithNoTrimming(e,t,n){let i=n.sub(t).normalize(),o=t,a=n,l=e.targetArrowhead;l!=null&&(l.tipPosition=n,a=n.sub(i.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(i.mul(u.length))),e.curve=R.mkPP(o,a)}},Xt=dn;Xt.defaultArrowheadLength=5;var Ge=class extends De{constructor(e){super(e);this.targetArrowhead=new Xt;this.lineWidth=1}requireRouting(){this.curve=null,this.underlyingPolyline=null}get sourcePort(){return this._sourcePort}set sourcePort(e){this._sourcePort=e}get targetPort(){return this._targetPort}set targetPort(e){this._targetPort=e}Translate(e){if(!(e.x==0&&e.y==0)){if(this.curve!=null&&this.curve.translate(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;t!=null;t=t.next,n=n.next)t.point=n.point.add(e);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(e)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(e))}}GetMaxArrowheadLength(){let e=0;return this.sourceArrowhead!=null&&(e=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>e?this.targetArrowhead.length:e}transform(e){if(this.curve!=null){if(this.curve=this.curve.transform(e),this.underlyingPolyline!=null)for(let t=this.underlyingPolyline.headSite,n=this.underlyingPolyline.headSite;t!=null;t=t.next,n=n.next)t.point=e.multiplyPoint(t.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=e.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=e.multiplyPoint(this.targetArrowhead.tipPosition)),this.label!=null&&(this.label.center=e.multiplyPoint(this.label.center))}}get labelBBox(){return this.label.boundingBox}get edge(){return this.entity}get source(){return De.getGeom(this.edge.source)}get boundingBox(){let e=k.mkEmpty();if(this.underlyingPolyline!=null)for(let n of this.underlyingPolyline)e.add(n);this.curve!=null&&e.addRecSelf(this.curve.boundingBox),this.sourceArrowhead!=null&&e.add(this.sourceArrowhead.tipPosition),this.targetArrowhead!=null&&e.add(this.targetArrowhead.tipPosition),this.edge.label&&e.addRecSelf(this.label.boundingBox);let t=this.lineWidth;return e.left-=t,e.top+=t,e.right+=t,e.bottom-=t,e}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return De.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(e,t,n){let i=e.boundingBox.width,o=e.boundingBox.height,a=e.boundingBox.center,l=new p(a.x-i/4,a.y),u=new p(a.x-i/4,a.y-o/2-t),c=new p(a.x+i/4,a.y-o/2-t),h=new p(a.x+i/4,a.y);return n.smoothedPolyline=it.mkFromPoints([l,u,c,h]),n.smoothedPolyline.createCurve()}underCollapsedCluster(){return this.source.underCollapsedCluster()||this.target.underCollapsedCluster()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var me=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var Lp=class{},Oa=Lp;Oa.GoldenRatio=(1+Math.sqrt(5))/2,Oa.GoldenRatioRemainder=2-Lp.GoldenRatio;var yo=class extends me{constructor(e,t){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=e,this.desiredAspectRatio=t}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(e,t,n){let i=yo.GetGoldenSectionStep(e,t),o=Math.max(n/10,(t-e)/yo.MaxSteps);t+=o,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length==1?this.PackLimit(e):this.rectangles.length==2?(this.PackLimit(e),this.PackLimit(t)):this.rectangles.length>2&&yo.GoldenSectionSearch(l=>this.PackLimit(l),e,i,t,o);let a=this.bestPacking.getRects();for(let l=0;l<this.rectangles.length;l++)this.rectangles[l]=a[l]}PackLimit(e){let t=this.cachedCosts.get(e);if(t==null){let n=this.createPacking(this.rectangles,e);n.run(),this.cachedCosts.set(e,t=Math.abs(n.PackedAspectRatio-this.desiredAspectRatio)),t<this.bestPackingCost&&(this.bestPackingCost=t,this.bestPacking=n)}return t}static GoldenSectionSearch(e,t,n,i,o){if(Math.abs(t-i)<o)return e(t)<e(i)?t:i;let a=yo.GetGoldenSectionStep(n,i),l=e(n),u=e(a),c=()=>yo.GoldenSectionSearch(e,a,n,t,o),h=()=>yo.GoldenSectionSearch(e,n,a,i,o);if(u<l)return h();if(u>l)return c();let d=h(),f=c();return e(f)<e(d)?f:d}static GetGoldenSectionStep(e,t){return e<t?e+Oa.GoldenRatioRemainder*(t-e):e-Oa.GoldenRatioRemainder*(e-t)}},kh=yo;kh.MaxSteps=1e3;var Oy=ne(fn());var Rp=class extends me{get PackedWidth(){return this.packedWidth}set PackedWidth(e){this.packedWidth=e}get PackedHeight(){return this.packedHeight}set PackedHeight(e){this.packedHeight=e}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let e=[];for(let[t,n]of this.rectsToCenters)t.center=n,e.push(t);return e}};var Ra=class extends Rp{constructor(e,t,n=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=n?e:Ra.SortRectangles(e),this.wrapWidth=t}static SortRectangles(e){return e.sort((t,n)=>n.height-t.height),e}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let e=new Oy.Stack,t=!1,n=0,i=0,o=0,a=this.rectanglesByDescendingHeight;for(let l=0;t||l<a.length;){let u=a[l],c=e.length>0?e.top:null;if(c==null||c.right+u.width<=this.wrapWidth&&n+u.height<=c.top){let d=new p(c?c.right:0,n).add(new p(u.width/2,u.height/2));u.center=d,this.rectsToCenters.set(u,d),i=Math.max(i,u.right),o=Math.max(o,u.top),e.push(u),t=!1}else n=c.top,e.pop(),t=!0;t||l++}this.PackedWidth=i,this.PackedHeight=o}};var fu=class extends kh{constructor(e,t){super(Ra.SortRectangles(e),t);this.createPacking=(n,i)=>new Ra(n,i,!0)}run(){let e=Number.MAX_VALUE,t=0,n=0;for(let i of this.rectangles){let o=i.width;n+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,n,e)}};var gu=ne(fn());function aw(s,e,t,n,i,o){for(let l=0;l<s.length;l++){if(l==e||l==t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;n.length*2<i.length?(n.push(s[l]),o.box0=u):i.length*2<n.length?(i.push(s[l]),o.box1=h):c<d?(n.push(s[l]),o.box0=u):d<c?(i.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(n.push(s[l]),o.box0=u):(i.push(s[l]),o.box1=h)}}function _e(s){if(s.length==0)return null;if(s.length==1)return s[0];let e={b0:s[0].irect,seed0:1},t=lw(s,e),n=[],i=[];n.push(s[e.seed0]),i.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};aw(s,e.seed0,t,n,i,o);let a=By(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=_e(n),a.Right=_e(i),a}function Ry(s,e){return s.add_rect(e).area}function lw(s,e){let t=Ry(e.b0,s[e.seed0].irect);for(let i=2;i<s.length;i++){let o=Ry(e.b0,s[i].irect);o>t&&(e.seed0=i,t=o)}let n;for(let i=0;i<s.length;i++)if(i!=e.seed0){n=i;break}t=s[e.seed0].irect.add_rect(s[n].irect).area;for(let i=0;i<s.length;i++){if(i==e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[i].irect).area;o>t&&(n=i,t=o)}return n}function mu(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(n=>Ke(n,e(n)));return _e(t)}function By(s){let e=new bu;return e.Count=s,e}function Ke(s,e){let t=new bu;return t.UserData=s,t.irect=e,t.Count=1,t}function Bp(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)==0?s.Left!=null?Bp(s.Left,e,t)==0&&Bp(s.Right,e,t)==0?0:1:0:1:0}var bu=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent==this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent==this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this==this.Parent.Left}FirstHitNodePF(e,t){var n;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)==1?this:null:this:(n=this.Left.FirstHitNodePF(e,t))!=null?n:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var n;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)==1?this:null:(n=this.Left.FirstHitNodeWithPredicate(e,t))!=null?n:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t){let n=new gu.Stack;for(n.push(this);n.size>0;){let i=n.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?(t==null||t(i.UserData))&&(yield i.UserData):(n.push(i.left),n.push(i.right)))}}*AllHitItems_(e){let t=new gu.Stack;for(t.push(this);t.size>0;){let n=t.pop();n.irect.contains_point(e)&&(n.IsLeaf?yield n.UserData:(t.push(n.left),t.push(n.right)))}}VisitTree(e,t){Bp(this,e,t)}Clone(){let e=By(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new gu.Stack;for(t.push(this);t.size>0;){let n=t.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?yield n:(t.push(n.left),t.push(n.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new gu.Stack;for(t.push(this);t.size>0;){let n=t.pop();(n.IsLeaf||!e)&&(yield n),n.IsLeaf||(t.push(n.left),t.push(n.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function Kn(s){return new hs(_e(s.map(([e,t])=>Ke(t,e))))}function uw(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function My(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function cw(s,e){let t=new Array;for(let i of s.GetAllLeafNodes())i!=e&&t.push(i);let n=_e(t);s.Count=n.Count,s.Left=n.Left,s.Right=n.Right,s.irect=n.Left.irect.add_rect(n.Right.irect)}function hw(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!Ny(e))return e;return null}function Ny(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function Mp(s,e,t,n){return s.irect.intersects_rect(e)?s.IsLeaf?n(s.UserData)?--t.bound!=0:!0:Mp(s.Left,e,t,n)&&Mp(s.Right,e,t,n):!0}var hs=class{Clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,n){return Mp(this._rootNode,e,{bound:t},n)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(Ke(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=_e(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=_e(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=Ke(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let n,i;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{n=t.Left.irect.add_rect(e.irect);let o=n.area-t.Left.irect.area;i=t.Right.irect.add_rect(e.irect);let a=i.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=n):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=i):n.area<i.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=n):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=i)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count==0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count==0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count==0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count==0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(n.UserData==t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let n;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))i.UserData==t&&(n=i);if(n!=null)return this.RootNode.Count==1?this.RootNode=null:this.RemoveLeaf(n),n.UserData}RemoveLeaf(e){let t=hw(e);if(t!=null)cw(t,e),My(t);else{let n=e.Parent;n==null?this._rootNode=new bu:(uw(n,e.IsLeftChild?n.Right:n.Left),My(n))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!Ny(t))return t;return null}};function Uh(s,e){let t=new Array;for(let o of e)t.push({g:o,lb:o.boundingBox.leftBottom.clone()});let n=e.map(o=>o.boundingBox),i=new fu(n,1.5);i.run();for(let{g:o,lb:a}of t){let l=o.boundingBox.leftBottom.sub(a);o.translate(l)}s.boundingBox=new k({left:0,bottom:0,right:i.PackedWidth,top:i.PackedHeight}),s.addLabelToGraphBB(s.boundingBox)}var je=class extends $r{constructor(e){super(e);this.MinimalWidth=0;this.MinimalHeight=0;this.Margins=10}static getGeom(e){return e.getAttr(0)}*intersectedObjects(e,t=!0){this._rtree==null&&(this._rtree=this.buildRTree());let n=this._rtree.GetAllIntersecting(e),i=e.perimeter();for(let o of n)if(o instanceof $r&&(yield o),!t&&o instanceof Ge){let a=o.curve;(v.intersectionOne(a,i,!1)!=null||v.PointRelativeToCurveLocation(a.start,i)==2)&&(yield o)}}buildRTree(){let e=Array.from(this.deepNodes()).concat(Array.from(this.deepEdges())).map(t=>[t.boundingBox,t]);return Kn(e)}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(e){this.layoutSettings=e;for(let t of this.deepNodes()){let n=t;n.layoutSettings=e}}get layoutSettings(){return this._layoutSettings}set layoutSettings(e){this._layoutSettings=e}translate(e){if(e.x==0&&e.y==0)return;let t=new pt(1,0,e.x,0,1,e.y);this.transform(t)}get labelSize(){return this._labelSize}set labelSize(e){this._labelSize=e}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}transform(e,t=!0){if(!e.isIdentity()){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e));for(let n of this.shallowNodes())n.transform(e,t);for(let n of this.edges())n.transform(e);t&&this.updateBoundingBox()}}*deepNodes(){for(let e of this.graph.deepNodes)yield De.getGeom(e)}setEdge(e,t){let n=this.graph.setEdge(e,t);return new Ge(n)}pumpTheBoxToTheGraphWithMargins(e){let t={b:k.mkEmpty()};return this.pumpTheBoxToTheGraph(t),t.b.pad(Math.max(this.Margins,e)),this.MinimalWidth>0&&(t.b.width=Math.max(t.b.width,this.MinimalWidth)),this.MinimalHeight>0&&(t.b.height=Math.max(t.b.height,this.MinimalHeight)),this._boundingBox=t.b,t.b}get center(){return this.boundingBox?this.boundingBox.center:new p(0,0)}set center(e){let t=e.sub(this.center),n=new pt(1,0,t.x,0,1,t.y);this.transform(n)}pumpTheBoxToTheGraph(e){for(let t of this.edges())if(!t.underCollapsedCluster()){if(t.curve!=null){let n=t.curve.boundingBox;n.pad(t.lineWidth),e.b.addRecSelf(n)}t.label!=null&&e.b.addRecSelf(t.label.boundingBox)}for(let t of this.shallowNodes())t.underCollapsedCluster()||!t.boundingBox||e.b.addRecSelf(t.boundingBox)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}*shallowNodes(){for(let e of this.graph.shallowNodes)yield De.getGeom(e)}*edges(){for(let e of this.graph.edges)yield De.getGeom(e)}*deepEdges(){for(let e of this.graph.deepEdges())yield De.getGeom(e)}static mk(e,t=new Bt(0,0)){let n=new je(new We(e));return n.labelSize=t,n}*subgraphs(){for(let e of this.graph.subgraphs())yield De.getGeom(e)}static mkWithGraphAndLabel(e,t){let n=new je(e);return n.labelSize=t,n}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(e){let t=this.graph.liftNode(e.node);return t?De.getGeom(t):null}findNode(e){let t=this.graph.findNode(e);return t?De.getGeom(t):null}addNode(e){return this.graph.addNode(e.node),e}updateBoundingBox(){if(this.graph.isEmpty())return;let e=k.mkEmpty(),t=0;for(let n of this.graph.edges){let i=De.getGeom(n);i.curve!=null&&(e.addRecSelf(i.boundingBox),t=Math.max(t,i.lineWidth))}for(let n of this.shallowNodes())n.boundingBox&&(e.addRecSelf(n.boundingBox),t=Math.max(t,n.padding));this.addLabelToGraphBB(e),e.pad(Math.max(t,this.Margins)),this.boundingBox=e}addLabelToGraphBB(e){this.labelSize&&(e.top+=this.labelSize.height+2,e.width<this.labelSize.width&&(e.width=this.labelSize.width))}FlipYAndMoveLeftTopToOrigin(){let e=new pt(1,0,-this.left,0,-1,this.top);this.transform(e,!1);for(let n of this.deepNodes())if(n instanceof je&&!n.graph.isEmpty()){let o=n.boundingBox;n.boundingBox=k.mkSizeCenter(new Bt(o.width,o.height),e.multiplyPoint(o.center))}let t=this.boundingBox;this.boundingBox=k.mkSizeCenter(new Bt(t.width,t.height),e.multiplyPoint(t.center))}};var Pu=class extends De{constructor(e,t){super(t);this.boundingBox=k.mkPP(new p(0,0),new p(e.width,e.height))}get label(){return this.entity}get width(){return this.boundingBox.width}set width(e){this.boundingBox.width=e}get height(){return this.boundingBox.height}set height(e){this.boundingBox.height=e}get center(){return this.boundingBox.center}set center(e){this.boundingBox.center=e}get isPositioned(){let e=this.center;return e.x!=-77||e.y!=-77}requirePositioning(){this.boundingBox.center=new p(-77,-77)}};var Dy=ne(po());function Ba(s){let e=new Vt;return e.SetEdges(s,Vt.vertexCount(s)),e}function zh(s){let e=new Vt;return e.SetEdges(s,Vt.vertexCount(s)),e}function sr(s,e){let t=new Vt;return t.SetEdges(s,e),t}var Vt=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let n=e.indexOf(t,0);n>-1&&e.splice(n,1)}removeEdge(e){Vt.deleteFromArray(this.edges,e),e.source!=e.target?(Vt.deleteFromArray(this.outEdges[e.source],e),Vt.deleteFromArray(this.inEdges[e.target],e)):Vt.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let n of e)n.source>=t&&(t=n.source),n.target>=t&&(t=n.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let n=new Array(this.nodeCount).fill(0),i=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!=a.target?(n[a.source]++,i[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(n[a]),n[a]=0,this.inEdges[a]=new Array(i[a]),i[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!=u?(this.outEdges[l][n[l]++]=a,this.inEdges[u][i[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!=e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length==0)return;let e=new Set,t=new Dy.Queue,n=this.edges[0].source;for(Vt.enqueue(e,t,n),yield n;t.length>0;){n=t.dequeue();for(let i of this.outEdges[n]){let o=i.target;e.has(o)||(Vt.enqueue(e,t,o),yield o)}for(let i of this.inEdges[n]){let o=i.source;e.has(o)||(Vt.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,n){t.enqueue(n),e.add(n)}};var ae=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x==this.y}};var Gy=ne(fn());var In=class{set(e,t,n){this.arrayOfMaps[e].set(t,n)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield new ae(e,n[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield[new ae(e,n[0]),n[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield n[1]}}};var _y=class{constructor(e,t){this.v=e,this.i=t}},Qr=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,n,i){t[n]=1,e.push(new _y(n,i))}static getFeedbackSet(e){let t=new In(e.nodeCount);if(e==null||e.nodeCount==0)return[];let n=new Array(e.nodeCount).fill(0);for(let i=0;i<e.nodeCount;i++){if(n[i]==2)continue;let o=new Gy.Stack,a=0;for(Qr.push(o,n,i,a);o.size>0;){let l=o.pop();i=l.v,n[i]=2,a=l.i;let u=e.outEdges[i];for(;a<u.length;a++){let c=u[a];if(c.source==c.target)continue;let h=n[c.target];h==1?t.set(c.source,c.target,c):h==0&&(Qr.push(o,n,i,a+1),i=c.target,n[c.target]=2,u=e.outEdges[i],a=-1)}}}return Array.from(t.values())}};var Fy=ne(Tt()),Zr=class{constructor(e,t,n,i=1){this.Source=e,this.Target=t,this.CrossingWeight=n,this.Weight=i}toString(){return Fy.String.Format("{0}->{1}",this.Source,this.Target)}};var ds=class{static FindClosestPoints(e,t){let n=v.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(n)return{curveClosestPoint:n.aX,labelSideClosest:n.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof v){for(let n of e.segs)if((n.start.y-t)*(n.end.y-t)<=0)return n}return null}static ShiftLabel(e,t,n){let i=e.lineWidth/2,o=t.sub(n),a=o.length;a>i&&(e.label.center=e.label.center.add(o.div(a*(a-i))))}static updateLabel(e,t){let n=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new p(t.x+t.rightAnchor/2,t.y),n=R.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new p(t.x-t.leftAnchor/2,t.y),n=R.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let i=ds.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(i!=null&&v.getAllIntersections(e.curve,v.polyFromBox(e.labelBBox),!1).length==0){let o=ds.FindClosestPoints(i,n);if(o)ds.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=i.closestParameter(n.start),c=i.closestParameter(n.end);i.value(u).sub(n.start).length<i.value(c).sub(n.end).length?(a=i.value(u),l=n.start):(a=i.value(c),l=n.end),ds.ShiftLabel(e,a,l)}}}},ar=class{constructor(e,t,n,i=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=n,this.weight=i,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.underlyingPolyline}set underlyingPolyline(e){this.edge.underlyingPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source==this.target}reversedClone(){let e=new ar(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let n=0;n<t;n++){let i=this.LayerEdges[t-1-n];e.LayerEdges[n]=new Zr(i.Target,i.Source,i.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e==this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,n=this.LayerEdges[t];ds.updateLabel(this.edge,e[n.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var Yt=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let n=this.arrayOfSets[e];return n!=null&&n.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new Yt;for(let n of e)t.add(n);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let n of t.values())yield new ae(e,n)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let n=this.arrayOfSets[e];n==null&&(this.arrayOfSets[e]=n=new Set),n.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var ky=ne(po());function*Di(s){let e=new Array(s.nodeCount).fill(!1),t=new ky.Queue;for(let n=0;n<s.nodeCount;n++)if(!e[n]){let i=new Array;for(Vy(n,t,e);t.length>0;){let o=t.dequeue();i.push(o);for(let a of fw(s,o))Vy(a,t,e)}yield i}}function*fw(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function Vy(s,e,t){t[s]==!1&&(e.enqueue(s),t[s]=!0)}var Np=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new Yt;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size==0&&this.minLayerOfGeomGraph.size==0&&this.sameLayerConstraints.length==0&&this.upDownConstraints.length==0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=sr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=Qr.getFeedbackSetWithConstraints(e,null);for(let n of t)this.gluedUpDownIntConstraints.remove(n)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new ae(this.maxRepresentative,t))}if(this.minRepresentative!=-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!=this.minRepresentative&&this.gluedUpDownIntConstraints.add(new ae(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new Yt}gluedIntPairNN(e){return new ae(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new ae(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new ae(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),n=this.nodeToRepr(e.target),i=new ar(t,n,e.edge);return i.separation=e.separation,i.weight=0,i}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Di(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return sr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!=-1&&this.maxLayerInt.filter(t=>t!=this.maxRepresentative).map(t=>new ae(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!=-1&&this.minLayerInt.filter(t=>t!=this.minRepresentative).map(t=>new ae(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new ae(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let n of e)this.sameLayerDictionaryOfRepresentatives.set(n,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let n of e)this.sameLayerDictionaryOfRepresentatives.set(n,t=this.minRepresentative);else for(let n of e)t==-1&&(t=n),this.sameLayerDictionaryOfRepresentatives.set(n,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative==t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative==t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!=-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(Qr.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let n of this.unglueEdge(t))yield n}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let n of this.intGraph.outEdges[t])this.nodeToRepr(n.target)==e.target&&(yield n)}createGluedGraph(){let e=new Yt;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),sr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function gw(s,e){return[s,e]}var Dp=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length==0&&this.upDownVerticalConstraints.length==0&&this.leftRightConstraints.length==0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length==0&&!this.nodeToBlockRoot.has(t)){let n=new Array,i=t;for(let o=e.outEdges[i];o.length>0;o=e.outEdges[i])i=o[0].y,n.push(i),this.nodeToBlockRoot.set(i,t);n.length>0&&this.BlockRootToBlock.set(t,n)}}BasicGraphFromLeftRightIntNeibs(){return Ba(Array.from(this.LeftRightIntNeibs.values()).map(e=>new ae(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=Yt.mk(this.leftRightConstraints.map(t=>gw(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ae(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!=t.x));let e=Qr.getFeedbackSet(Ba(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new ae(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=Yt.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1).map(t=>new ae(t[0],t[1]))),this.VerticalInts=Yt.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!=-1&&t[1]!=-1&&e[t[0]]>e[t[1]]).map(t=>new ae(t[0],t[1])))}};var Na=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(Na||{});var Da=class{constructor(){this.capacityOverflowCoefficient=Da.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=Da.DefaultPathLengthImportance;this.inkImportance=Da.DefaultInkImportance;this.edgeSeparation=Da.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOriginalSpline=!1;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},Jn=Da;Jn.DefaultCapacityOverflowCoefficientMultiplier=1e3,Jn.DefaultPathLengthImportance=500,Jn.DefaultInkImportance=.01,Jn.DefaultEdgeSeparation=.5;var _a=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=3;this.polylinePadding=1.5;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e==1&&this.BundlingSettings==null&&this.BundlingSettings==null&&(this.BundlingSettings=new Jn),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var yu=class{constructor(){this.edgeRoutingSettings=new _a;this.minimalWidth=0;this.minimalHeight=0;this.nodeSeparation=10;this.packingAspectRatio=1.5}get MinimalWidth(){return this.minimalWidth}set MinimalWidth(e){this.minimalWidth=Math.max(e,0)}get MinimalHeight(){return this.minimalHeight}set MinimalHeight(e){this.minimalHeight=Math.max(e,0)}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}},Cr=class extends yu{constructor(){super();this.margins={left:0,top:0,bottom:0,right:0};this.sameRanks=new Array;this.verticalConstraints=new Np;this.horizontalConstraints=new Dp;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=pt.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.edgeRoutingSettings.EdgeRoutingMode=3}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=pt.rotation(e);for(let n=0;n<2;n++)for(let i=0;i<3;i++)if(!K(t.elements[n][i],this.transform.elements[n][i]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=pt.getIdentity();break;case 1:this.transform=pt.rotation(Math.PI/2);break;case 3:this.transform=pt.rotation(-Math.PI/2);break;case 2:this.transform=pt.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var lr=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>E.distanceEpsilon?1:e<-E.distanceEpsilon?-1:0}};var Gi=class extends Vt{constructor(e,t){super();this.SetEdges(e,t)}};var Gp=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new In(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let n=new ae(t.source,t.target),i=new ae(t.target,t.source),o=this.Multiedges.get(n.x,n.y);for(let a of o)a.reverse();if(this.Multiedges.has(i.x,i.y)){let a=this.Multiedges.get(i.x,i.y);for(let l of o)a.push(l)}else this.Multiedges.set(i.x,i.y,o);this.Multiedges.delete(n.x,n.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!=e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new ae(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function Su(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var Kr=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length==0&&t++;if(t==0)return this;let n=new Array(this.y.length);for(let a=0;a<n.length;a++)n[a]=this.y[a]-e[this.y[a]];let i=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(i[a-e[a]]=Array.from(this.layers[a]));let o=new Kr(n);return o.layers=i,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)Su(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let n of e)this.verticesToX[n]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let n=0;n<this.y.length;n++)e[n]=t-this.y[n];return new Kr(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let n of this.y)n+1>e&&(e=n+1);let t=new Array(e).fill(0);for(let n of this.y)t[n]++;this.layers=new Array(e);for(let n=0;n<e;n++)this.layers[n]=new Array(t[n]),t[n]=0;for(let n=0;n<this.y.length;n++){let i=this.y[n];this.layers[i][t[i]++]=n}}};var Eu=class extends me{constructor(e,t,n,i){super(i);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=n,this.dag=e,this.layering=t,this.Init()}static Balance(e,t,n,i){new Eu(e,t,n,i).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(e){this.jumpers.delete(e);let t=this.possibleJumperFeasibleIntervals.get(e),n=this.CalcJumpInfo(t.x,t.y,e);if(n==null)return;this.layering[e]=n.layerToJumpTo;let i=this.nodeCount[e];this.vertsCounts[n.jumperLayer]-=i,this.vertsCounts[n.layerToJumpTo]+=i,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(n.jumperLayer,e)}IsJumper(e){return this.possibleJumperFeasibleIntervals.has(e)}UpdateRegionsForPossibleJumpersAndInsertJumpers(e,t){let n=new Set;for(let o of this.dag.pred(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),n.add(o));for(let o of this.dag.succ(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),n.add(o));let i=new Array;for(let o of this.possibleJumperFeasibleIntervals)n.has(o[0])||o[1].x>e&&o[1].y<e&&i.push(o[0]);for(let o of i)this.CalculateRegionAndInsertJumper(o)}InitJumpers(){let e=new Array(this.dag.nodeCount).fill(0);for(let t of this.dag.edges)e[t.source]-=t.weight,e[t.target]+=t.weight;this.possibleJumperFeasibleIntervals=new Map;for(let t=0;t<this.dag.nodeCount;t++)e[t]==0&&this.CalculateRegionAndInsertJumper(t)}CalculateRegionAndInsertJumper(e){let t=new ae(this.Up(e),this.Down(e));this.possibleJumperFeasibleIntervals.set(e,t),this.InsertJumper(t.x,t.y,e)}InsertJumper(e,t,n){this.CalcJumpInfo(e,t,n)!=null&&this.jumpers.add(n)}CalcJumpInfo(e,t,n){let i=this.layering[n],o=-1,a=this.vertsCounts[i]-2*this.nodeCount[n];for(let l=e-1;l>i;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);for(let l=i-1;l>t;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);if(o!=-1)return{jumperLayer:i,layerToJumpTo:o}}Up(e){let t=Number.MAX_SAFE_INTEGER;for(let n of this.dag.inEdges[e]){let i=this.layering[n.source]-n.separation+1;i<t&&(t=i)}return t==Number.MAX_SAFE_INTEGER&&(t=this.layering[e]+1),t}Down(e){let t=Number.NEGATIVE_INFINITY;for(let n of this.dag.outEdges[e]){let i=this.layering[n.target]+n.separation-1;i>t&&(t=i)}return t==Number.NEGATIVE_INFINITY&&(t=this.layering[e]-1),t}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let e of this.layering)this.vertsCounts[e]+=this.nodeCount[e]}ChooseJumper(){for(let e of this.jumpers)return e;throw new Error("there are no jumpers to choose")}};var wn=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let n of t.LayerEdges){let i=Math.max(n.Source,n.Target)+1;i>this.totalNumberOfNodes&&(this.totalNumberOfNodes=i)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let n=1;n<t.LayerEdges.length;n++){let i=t.LayerEdges[n];this.firstVirtualNode=Math.min(this.firstVirtualNode,i.Source)}this.firstVirtualNode==Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let n of t.LayerEdges)n.Target!=t.target&&(this.virtualNodesToInEdges[n.Target-this.firstVirtualNode]=n),n.Source!=t.source&&(this.virtualNodesToOutEdges[n.Source-this.firstVirtualNode]=n)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield wn.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!=t.target&&t.LayerEdges!=null&&(yield wn.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new wn(new Gi(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var sS=ne(Au()),To=class{constructor(e,t,n,i){this.la=t,this.database=n,this.layeredGraph=e,this.intGraph=i}static InsertLayers(e,t,n,i){let o=new To(e,t,n,i);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let n=0,i=t[0];if(n=i.LayerSpan*2,n>0){for(let o of i.LayerEdges)o.Target!=i.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(n-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let n=this.la.x[t],i=this.la.y[t],o=this.la.Layers[i];o[n]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],n=0;for(let i of this.la.Layers[e]){let o=this.virtNodesToIntEdges[i];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[i],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!=o){let c=u.LayerEdges[a].Source;t[n]=c,this.Nla.x[c]=n++}else t[n]=i,this.Nla.x[i]=n++}else t[n]=i,this.Nla.x[i]=n++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let n=this.NLayering[t];n%2==1&&(this.Nla.Layers[n][e[n]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!=e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!=e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,n=!0;for(let i of e)if(n&&(n=!1,t=i.LayerSpan*2),t>0){i.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=ri.GetSource(a,i,o);this.totalNodes=a.currentVV;let u=ri.GetTarget(this.totalNodes,i,o,t);i.LayerEdges[o]=new Zr(l,u,i.CrossingWeight)}To.RegisterDontStepOnVertex(this.database,i)}}this.nLayeredGraph=new wn(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new sS.SortedMap,n=this.Nla.Layers[e];for(let o of n){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let i=0;for(let o of t.values())if(typeof o=="number")n[i++]=o;else for(let a of o)n[i++]=a;for(let o=0;o<n.length;o++)this.Nla.x[n[o]]=o}}InitNewLayering(){this.Nla=new Kr(new Array(this.totalNodes));for(let n=0;n<this.layeredGraph.NodeCount;n++)this.NLayering[n]=this.la.y[n]*2;for(let[n,i]of this.database.Multiedges.keyValues())if(n.x!=n.y&&this.la.y[n.x]!=this.la.y[n.y]){let o=this.la.y[n.x]*2;for(let a of i){let l=o-1;for(let u of a.LayerEdges)u.Target!=a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let n of this.NLayering)t[n]++;for(let n=0;n<t.length;n++)e[n]=new Array(t[n]);this.Nla=new Kr(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let n=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(n.Source)}}};var ri=class{constructor(e,t,n,i){this.virtNodesToIntEdges=new Map;this.la=t,this.database=n,this.layeredGraph=e,this.intGraph=i}get NLayering(){return this.Nla.y}static InsertPaths(e,t,n,i){let o=new ri(e,t,n,i);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],n=0;for(let i of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(i);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[i],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!=o){let c=u.LayerEdges[a].Source;t[n]=c,this.Nla.x[c]=n++}else t[n]=i,this.Nla.x[i]=n++}else t[n]=i,this.Nla.x[i]=n++}}}EdgeIsFlat(e){return this.la.y[e.source]==this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let n of t.LayerEdges)n.Target!=t.target&&this.virtNodesToIntEdges.set(n.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,n]of this.database.Multiedges.keyValues())if(t.x!=t.y){let i=!0,o=0;for(let a of n){if(i)i=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o==1)a.LayerEdges[0]=new Zr(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=ri.GetSource(u,a,l);e=u.currentVV;let h=ri.GetTarget(e,a,l,o);a.LayerEdges[l]=new Zr(c,h,a.CrossingWeight)}To.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new wn(this.intGraph)}static GetTarget(e,t,n,i){return n<i-1?e:t.target}static GetSource(e,t,n){return n==0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new Kr(new Array(this.NLayeredGraph.NodeCount));for(let n=0;n<this.layeredGraph.NodeCount;n++)this.NLayering[n]=this.la.y[n];for(let[n,i]of this.database.Multiedges.keyValues())if(n.x!=n.y&&this.la.y[n.x]!=this.la.y[n.y]){let o=0,a=!0;for(let l of i){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let n of this.NLayering)t[n]++;for(let n=0;n<t.length;n++)e[n]=new Array(t[n]);this.Nla=new Kr(this.NLayering),this.Nla.Layers=e}};var aS=BigInt("6364136223846793005"),Yp=(BigInt(1)<<BigInt(32))-BigInt(1),Fi=(BigInt(1)<<BigInt(64))-BigInt(1),vu=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&Fi,this._random_b(),this._state=this._state+BigInt(e)&Fi,this._random_b()}_random_b(){let e=this._state;this._state=e*aS+this._inc&Fi;let t=(e>>BigInt(18)^e)>>BigInt(27),n=e>>BigInt(59),i=n^BigInt(31);return(t>>n|t<<i)&Yp}_advance(e){e&=Fi;let t=BigInt(1),n=aS,i=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*n&Fi,i=i*n+o&Fi),o=(n+BigInt(1))*o&Fi,n=n*n&Fi,e>>=BigInt(1);this._state=t*this._state+i&Fi}randint(e){if(e>Yp)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),n=(Yp^t)%t;for(;;){let i=this._random_b();if(i>=n)return Number(i%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var Es;function Io(s){return Es==null&&(Es=new vu(0,0)),Es.randint(s)}function lS(s){Es=new vu(s,0)}function Tu(){return Es==null&&(Es=new vu(0,0)),Es.random()}var Jh=class{constructor(e,t,n){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=n}LayerGroupDisbalance(e,t,n){return t==1?this.LayerGroupDisbalanceWithOrigSeparators(e,n):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let n=0;for(let i=0;i<e.length;){let o=this.CurrentOrigGroupDelta(i,e,t);i=o.i,n+=o.ret}return n}CurrentOrigGroupDelta(e,t,n){let i=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)i++;return e=o+1,{ret:Math.abs(n-i),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let n=0;for(let i=0;i<e.length;){let o=this.CurrentVirtGroupDelta(i,e,t);n+=o.ret,i=o.i}return n}CurrentVirtGroupDelta(e,t,n){let i=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)i++;return e=o+1,{ret:Math.abs(n-i),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings==0}};var fS=ne(Au()),gS=ne(fn());var $p=class{constructor(e){this.x=e}Compare(e,t){let n=this.x[e.Source]-this.x[t.Source];return n!=0?n:this.x[e.Target]-this.x[t.Target]}};var Qp=class{constructor(e){this.x=e}Compare(e,t){let n=this.x[e.Target]-this.x[t.Target];return n!=0?n:this.x[e.Source]-this.x[t.Source]}};var dt=class{constructor(e,t){wa(e,t)<0?(this.first=e,this.second=t):(this.first=t,this.second=e)}get First(){return this.first}get Second(){return this.second}get Length(){return Ie(this.first,this.second)}CompareTo(e){let t=wa(this.first,e.first);return t!=0?t:wa(this.second,e.second)}static equal(e,t){return e.first.equal(t.first)&&e.second.equal(t.second)}toString(){return this.first+(" "+this.second)}};var Ve=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new Ve;for(let n of e)t.add(n);return t}addxy(e,t){let n=this.mapOfSets.get(e);n==null&&this.mapOfSets.set(e,n=new Set),n.has(t)||this.size_++,n.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let n=this.mapOfSets.get(e);return n!=null&&n.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let n of this)e(n,n,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new p(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function Vi(s,e){let t=new Set;for(let n of s)e.has(n)||t.add(n);return t}function uS(s,e){let t=new Ve;for(let n of s)e.has(n)||t.add(n);return t}function Ln(s,e){let t=new Set(s);for(let n of e)t.add(n);return t}function ni(s,e){for(let t of e)s.push(t)}function On(s,e){let t=new Set;if(s.size<e.size)for(let n of s)e.has(n)&&t.add(n);else for(let n of e)s.has(n)&&t.add(n);return t}function cS(s){if(s.length==0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=On(e,s[t]);return e}function ja(s,e){for(let t of e)s.add(t)}function xs(s,e){if(s.size!=e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function ii(s,e){let t=[];for(let n of s)for(let i of e(n))t.push(i);return t}function Cs(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function As(s,e,t){let n=s.get(e);n||(n=new Array,s.set(e,n)),n.push(t)}function Zp(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function hS(s,e,t){Zp(s,new dt(e[0],e[1]),t)}function Jw(s,e,t){let n=s.get(e);n&&n.delete(t)}function Kp(s,e,t){Jw(s,new dt(e[0],e[1]),t)}function ed(){return Io(2)==0}function e2(s,e,t){let n=t.Layers[s+1],i=t.Layers[s];return i.length<=n.length?r2(i,e,t):t2(n,i,e,t)}function t2(s,e,t,n){let i=pS(e,t),o=new Qp(n.x);i.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of i){let h=a+n.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!=0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function r2(s,e,t){let n=pS(s,e),i=new $p(t.x);n.sort((u,c)=>i.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of n){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!=0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function pS(s,e){return ii(s,t=>Array.from(e.InEdges(t)))}function dS(s,e){let t=0;for(let n=0;n<e.Layers.length-1;n++)t+=e2(n,s,e);return t}var wo=class extends me{constructor(e,t,n,i,o,a,l){super(l);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=l,this.tryReverse=t,this.startOfVirtNodes=i,this.layerArrays=n,this.layering=n.y,this.nOfLayers=n.Layers.length,this.layers=n.Layers,this.properLayeredGraph=e,this.hasCrossWeights=o,this.SugSettings=a}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return Io(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(e,t,n,i,o){let a=!1;for(let u of e.Edges)if(u.CrossingWeight!=1){a=!0;break}new wo(e,!0,t,n,a,i,o).run()}run(){if(this.Calculate(),this.tryReverse){let e=this.layerArrays.ReversedClone(),t=new wo(this.properLayeredGraph.ReversedClone(),!1,e,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(t.run(),t.measure<this.measure){for(let n=0;n<this.nOfLayers;n++)Su(e.Layers[n],this.layerArrays.Layers[this.nOfLayers-1-n]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=wo.CloneLayers(this.layers,this.layerArraysCopy);let e=0;this.measure=new Jh(this.layerArraysCopy,dS(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let t=0;t<this.MaxOfIterations&&e<this.NoGainStepsBound&&!this.measure.IsPerfect();t++){let n=t%2==0;this.LayerByLayerSweep(n),this.AdjacentExchange();let i=new Jh(this.layerArrays.Layers,dS(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);this.measure<i?(this.Restore(),e++):(i<this.measure||ed())&&(e=0,this.layerArraysCopy=wo.CloneLayers(this.layers,this.layerArraysCopy),this.measure=i)}}static CloneLayers(e,t){if(t==null){t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=e[n].map(i=>i)}else for(let n=0;n<e.length;n++)Su(e[n],t[n]);return t}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(e){if(e)for(let t=1;t<this.nOfLayers;t++)this.SweepLayer(t,!0);else for(let t=this.nOfLayers-2;t>=0;t--)this.SweepLayer(t,!1)}SweepLayer(e,t){let n=this.layers[e],i=new Array(n.length);for(let a=0;a<i.length;a++)i[a]=this.WMedian(n[a],t);this.Sort(e,i);let o=this.layerArrays.Layers[e];for(let a=0;a<o.length;a++)this.layerArrays.x[o[a]]=a}Sort(e,t){let n=new fS.SortedMap,i=this.layers[e],o=0;for(let l of t){let u=i[o++];if(l!=-1)if(!n.has(l))n.set(l,u);else{let c=n.get(l);if(typeof c!="number"){let h=c;if(ed())h.push(u);else{let d=Io(h.length),f=h[d];h[d]=u,h.push(f)}}else{let h=c,d=new Array;n.set(l,d),ed()?(d.push(h),d.push(u)):(d.push(u),d.push(h))}}}let a=n.values();for(o=0;o<i.length;)if(t[o]!=-1){let l=a.next().value;if(typeof l=="number")i[o++]=l;else{let u=l;for(let c of u){for(;t[o]==-1;)o++;i[o++]=c}}}else o++}WMedian(e,t){let n,i;if(t?(n=this.properLayeredGraph.OutEdges(e),i=this.properLayeredGraph.OutEdgesCount(e)):(n=this.properLayeredGraph.InEdges(e),i=this.properLayeredGraph.InEdgesCount(e)),i==0)return-1;let o=new Array(i),a=0;if(t)for(let h of n)o[a++]=this.X[h.Target];else for(let h of n)o[a++]=this.X[h.Source];o.sort((h,d)=>h-d);let l=Math.floor(i/2);if(i%2==1)return o[l];if(i==2)return .5*(o[0]+o[1]);let u=o[l-1]-o[0],c=o[i-1]-o[l];return Math.floor((o[l-1]*u+o[l]*c)/(u+c))}Init(){let e=new Array(this.nOfLayers).fill(0),t=new gS.Stack;for(let i=0;i<this.properLayeredGraph.NodeCount;i++)this.properLayeredGraph.InEdgesCount(i)==0&&t.push(i);let n=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;t.size>0;){let i=t.pop(),o=this.layerArrays.y[i];this.layerArrays.Layers[o][e[o]]=i,this.layerArrays.x[i]=e[o],e[o]++;for(let a of this.properLayeredGraph.Succ(i))n[a]||(n[a]=!0,t.push(a))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let e=0,t=!0;for(;t&&e++<this.MaxNumberOfAdjacentExchanges;){t=!1;for(let n=0;n<this.layers.length;n++)t=this.AdjExchangeLayer(n)||t;for(let n=this.layers.length-2;n>=0;n--)t=this.AdjExchangeLayer(n)||t}}AllocArrays(){let e=this.properLayeredGraph.NodeCount;this.predecessors=new Array(e),this.successors=new Array(e),this.pOrder=new Array(e),this.sOrder=new Array(e),this.hasCrossWeights&&(this.outCrossingCount=new Array(e),this.inCrossingCount=new Array(e));for(let t=0;t<e;t++){let n=this.properLayeredGraph.InEdgesCount(t);if(this.predecessors[t]=new Array(n),this.hasCrossWeights){let i=this.inCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.InEdges(t))i.set(o.Source,o.CrossingWeight)}if(this.pOrder[t]=new Map,n=this.properLayeredGraph.OutEdgesCount(t),this.successors[t]=new Array(n),this.sOrder[t]=new Map,this.hasCrossWeights){let i=this.outCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.OutEdges(t))i.set(o.Target,o.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let e=0;e<this.properLayeredGraph.NodeCount;e++)this.pOrder[e]=new Map,this.sOrder[e]=new Map;for(let e of this.layers)this.InitPsArraysForLayer(e)}CalcPair(e,t){let n=this.successors[e],i=this.successors[t],o=this.predecessors[e],a=this.predecessors[t];if(this.hasCrossWeights){let l=this.outCrossingCount[e],u=this.outCrossingCount[t],c=this.inCrossingCount[e],h=this.inCrossingCount[t];return{cuv:this.CountOnArraysUV(n,i,l,u)+this.CountOnArraysUV(o,a,c,h),cvu:this.CountOnArraysUV(i,n,u,l)+this.CountOnArraysUV(a,o,h,c)}}else return{cuv:this.CountOnArrays(n,i)+this.CountOnArrays(o,a),cvu:this.CountOnArrays(i,n)+this.CountOnArrays(a,o)}}InitPsArraysForLayer(e){for(let t of e){for(let n of this.properLayeredGraph.Pred(t)){let i=this.sOrder[n],o=i.size;this.successors[n][o]=t,i.set(t,o)}for(let n of this.properLayeredGraph.Succ(t)){let i=this.pOrder[n],o=i.size;this.predecessors[n][o]=t,i.set(t,o)}}}CountOnArrays(e,t){let n=0,i=t.length-1,o=-1,a=0;for(let l of e){let u=this.X[l];for(;o<i&&this.X[t[o+1]]<u;o++)a++;n+=a}return n}CountOnArraysUV(e,t,n,i){let o=0,a=t.length-1,l=-1,u=0;for(let c of e){let h=this.X[c],d;for(;l<a&&this.X[d=t[l+1]]<h;l++)u+=i.get(d);o+=u*n.get(c)}return o}AdjExchangeLayer(e){let t=this.layers[e];return this.ExchangeWithGainWithNoDisturbance(t)?!0:(this.DisturbLayer(t),this.ExchangeWithGainWithNoDisturbance(t))}Swap(e,t){let n=this.X[e],i=this.X[t],o=this.layering[e],a=this.layers[o];a[n]=t,a[i]=e,this.X[e]=i,this.X[t]=n,this.UpdateSsContainingUv(e,t),this.UpdatePsContainingUv(e,t)}UpdatePsContainingUv(e,t){if(this.successors[e].length<=this.successors[t].length)for(let n of this.successors[e]){let i=this.pOrder[n];if(i.has(t)){let o=i.get(t),a=this.predecessors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}else for(let n of this.successors[t]){let i=this.pOrder[n];if(i.has(e)){let o=i.get(t),a=this.predecessors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}}UpdateSsContainingUv(e,t){if(this.predecessors[e].length<=this.predecessors[t].length)for(let n of this.predecessors[e]){let i=this.sOrder[n];if(i.has(t)){let o=i.get(t),a=this.successors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}else for(let n of this.predecessors[t]){let i=this.sOrder[n];if(i.has(e)){let o=i.get(t),a=this.successors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}}DisturbLayer(e){for(let t=0;t<e.length-1;t++)this.AdjacentSwapToTheRight(e,t)}ExchangeWithGainWithNoDisturbance(e){let t=!1,n;do n=this.ExchangeWithGain(e),t=t||n;while(n);return t}ExchangeWithGain(e){for(let t=0;t<e.length-1;t++)if(this.SwapWithGain(e[t],e[t+1]))return this.SwapToTheLeft(e,t),this.SwapToTheRight(e,t+1),!0;return!1}SwapToTheLeft(e,t){for(let n=t-1;n>=0;n--)this.AdjacentSwapToTheRight(e,n)}SwapToTheRight(e,t){for(let n=t;n<e.length-1;n++)this.AdjacentSwapToTheRight(e,n)}AdjacentSwapToTheRight(e,t){let n=e[t],i=e[t+1],o=this.SwapGain(n,i);(o>0||o==0&&ed())&&this.Swap(n,i)}SwapGain(e,t){let n=this.CalcPair(e,t);return n.cuv-n.cvu}UvAreOfSameKind(e,t){return e<this.startOfVirtNodes&&t<this.startOfVirtNodes||e>=this.startOfVirtNodes&&t>=this.startOfVirtNodes}NeighborsForbidTheSwap(e,t){return this.UpperNeighborsForbidTheSwap(e,t)||this.LowerNeighborsForbidTheSwap(e,t)}LowerNeighborsForbidTheSwap(e,t){let n,i;return(n=this.properLayeredGraph.OutEdgesCount(e))==0||(i=this.properLayeredGraph.OutEdgesCount(t))==0?!1:this.X[this.successors[e][n>>1]]<this.X[this.successors[t][i>>1]]}UpperNeighborsForbidTheSwap(e,t){let n=this.properLayeredGraph.InEdgesCount(e),i=this.properLayeredGraph.InEdgesCount(t);return n==0||i==0?!1:this.X[this.predecessors[e][n>>1]]<this.X[this.predecessors[t][i>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(e,t,n){let i=this.GetKindDelegate(n),o=0;for(let l=t-1;l>=0&&!i(e[l]);l--)o++;let a=0;for(let l=t+1;l<e.length&&!i(e[l]);l++)a++;return o-a}IsOriginal(e){return e<this.startOfVirtNodes}IsVirtual(e){return e>=this.startOfVirtNodes}GetKindDelegate(e){return this.IsVirtual(e)?this.IsVirtual:this.IsOriginal}SwapWithGain(e,t){return this.SwapGain(e,t)>0?(this.Swap(e,t),!0):!1}};var Je=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,n){let i=this.mapOfMaps.get(e);i==null&&this.mapOfMaps.set(e,i=new Map),i.has(t)||this.size_++,i.set(t,n)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let n=this.mapOfMaps.get(e);return n!=null?(n.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let n=this.mapOfMaps.get(e);return n!=null&&n.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let n=this.mapOfMaps.get(e);if(n!=null)return n.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new p(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new p(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var qa=class{constructor(e,t,n){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=n}static UpdateLayerArrays0(e,t,n){new qa(e,t,n).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let n=qa.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,n)}static BuildInitialNodePositions(e,t){let n=new Map;for(let i=0;i<t.Layers.length;i++){let o=0,a=0;for(;o<t.Layers[i].length;){for(;o<t.Layers[i].length&&e.IsVirtualNode(t.Layers[i][o]);)o++;for(let l=a;l<o;l++)n.set(t.Layers[i][l],new p(i,a));o<t.Layers[i].length&&n.set(t.Layers[i][o],new p(i,o)),o++,a=o}}return n}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new Je;for(let t of this.layerArrays.Layers)for(let n of t){let i=this.nodePositions.get(n);e.hasxy(i.x,i.y)||e.setxy(i.x,i.y,[]),e.getxy(i.x,i.y).push(n)}return e}BuildOrdering(e){let t=new Je,n=new Map;for(let i of this.layerArrays.Layers)for(let o of i){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),n),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let n=0;n<e.length;n++)t.set(e[n],n)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,n)=>{let i=this.firstSucc(t),o=this.firstSucc(n),a=this.firstPred(t),l=this.firstPred(n),u=this.nodePositions.get(i),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(i)){if(!h.equal(d))return h.compareTo(d);let f=e.get(i),y=e.get(o);return ye(f,y)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?ye(t,n):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let n=0,i=0;for(;n<t.length;){for(;n<t.length&&this.nodePositions.get(t[i]).equal(this.nodePositions.get(t[n]));)n++;let o=e.get(this.nodePositions.get(t[i]));for(let a=i;a<n;a++)t[a]=o[a-i];i=n}}this.layerArrays.UpdateXFromLayers()}};var bS=ne(Tt());var mS=ne(fn());var vs=class{static getOrder(e,t){let n=sr(t.map(([i,o])=>new ae(i,o)),e);return vs.getOrderOnGraph(n)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),n=new mS.Stack,i=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,n.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(i.push(l),n.length>0){let c=n.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return i.reverse()}};var Jp=class{GetLayers(){let e=vs.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),n=this.graph.nodeCount;for(;n-- >0;){let i=e[n];for(let o of this.graph.inEdges[i]){let a=o.source,l=t[i]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(n2(t,e))return!1;return!0}constructor(e){this.graph=e}};function n2(s,e){let t=e.findIndex(i=>i==s.source),n=e.findIndex(i=>i==s.target);return t==-1||n==-1||t>=n}var em=class{constructor(e){this.inTree=!1;this.cut=em.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},Vr=em;Vr.infinity=Number.MAX_SAFE_INTEGER;var Lo=ne(fn());function i2(s){let e=new Array;for(let t of s.edges)e.push(new Vr(t));return sr(e,s.nodeCount)}var td=class{constructor(e,t,n,i,o){this.v=e,this.outEnum=t,this.i=n,this.inEnum=i,this.j=o}},Iu=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=i2(e),this.networkCancelToken=t;for(let n=0;n<this.graph.nodeCount;n++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let n of this.treeVertices)this.layers[n]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let n=t.source,i=t.target;return this.lim(n)>this.lim(i)?this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?0:1:this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut==Vr.infinity&&t!=this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new Lo.Stack;for(let n of this.leaves)e.push(n);let t=new Lo.Stack;for(;e.length>0;){for(;e.length>0;){let i=e.pop(),o=this.parent(i);if(o==null)continue;let a=0;for(let u of this.incidentEdges(i))if(u.inTree==!1){let c=this.edgeSourceTargetVal(u,o);c!=0&&(a+=c*u.weight)}else if(u==o)a+=u.weight;else{let c=o.source==u.target||o.target==u.source?1:-1;a+=this.edgeContribution(u,i)*c}o.cut=a;let l=o.source==i?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let n=e;e=t,t=n}}edgeContribution(e,t){let n=e.cut-e.weight;for(let i of this.incidentEdges(t))if(i.inTree==!1){let o=this.edgeSourceTargetVal(i,e);o==-1?n+=i.weight:o==1&&(n-=i.weight)}return n}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let n=new Lo.Stack,i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(n.push(new td(t,i,o,a,l)),this.vertices[t].low=e;n.length>0;){let u=n.pop();t=u.v,i=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<i.length;){let h=i[o];!h.inTree||this.vertices[h.target].low>0||(n.push(new td(t,i,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){n.push(new td(t,i,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)==this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,n=this.vertices[e].lim;this.leaves=[];for(let i=0;i<this.nodeCount;i++)t<=this.vertices[i].lim&&this.vertices[i].lim<=n?this.setLow(i,0):this.low(i)==this.lim(i)&&this.leaves.push(i);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=Vr.infinity;for(let n of this.treeVertices){for(let i of this.graph.outEdges[n]){if(this.vertexInTree(i.source)&&this.vertexInTree(i.target))continue;let o=this.slack(i);if(o<t&&(e=i,t=o,o==1))return i}for(let i of this.graph.inEdges[n]){if(this.vertexInTree(i.source)&&this.vertexInTree(i.target))continue;let o=this.slack(i);if(o<t&&(e=i,t=o,o==1))return i}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new Lo.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let n of this.graph.outEdges[t])this.vertexInTree(n.target)||this.layers[n.source]-this.layers[n.target]==n.separation&&(e.push(n.target),this.addVertexToTree(n.target),this.treeVertices.push(n.target),n.inTree=!0);for(let n of this.graph.inEdges[t])this.vertexInTree(n.source)||this.layers[n.source]-this.layers[n.target]==n.separation&&(e.push(n.source),this.addVertexToTree(n.source),this.treeVertices.push(n.source),n.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,n=0;for(let a of this.graph.edges)a.inTree&&a.cut<n&&(n=a.cut,e=a);if(e==null)return null;let i=!1,o=Vr.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree==!1&&this.edgeSourceTargetVal(a,e)==-1&&(l<o||l==o&&(i=Io(2)==1))){if(o=l,t=a,o==0&&!i)break;i=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let n=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,n),this.updateLimLowLeavesAndParentsUnderNode(n),this.updateCuts(e),this.updateLayersUnderNode(n)}updateLayersUnderNode(e){let t=new Lo.Stack;t.push(e);for(let n=0;n<this.nodeCount;n++)this.low(e)<=this.lim(n)&&this.lim(n)<=this.lim(e)&&n!=e&&(this.layers[n]=Vr.infinity);for(;t.length>0;){let n=t.pop();for(let i of this.graph.outEdges[n])i.inTree&&this.layers[i.target]==Vr.infinity&&(this.layers[i.target]=this.layers[n]-i.separation,t.push(i.target));for(let i of this.graph.inEdges[n])i.inTree&&this.layers[i.source]==Vr.infinity&&(this.layers[i.source]=this.layers[n]+i.separation,t.push(i.source))}}updateCuts(e){let t=new Lo.Stack,n=new Lo.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!=Vr.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree==!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c==a)l+=c.weight;else{let h=a.source==c.target||a.target==c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source==o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&n.push(u)}let i=t;t=n,n=i}}createPathForCutUpdates(e,t,n){let i=t.target;for(;i!=n;){let o=this.parent(i);o.cut=Vr.infinity,i=o.source==i?o.target:o.source}t.cut=Vr.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,n;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),n=this.lim(e.target)):(t=this.lim(e.target),n=this.lim(e.source));let i=e.source;for(;!(this.low(i)<=t&&n<=this.lim(i));){let o=this.parent(i);o.cut=Vr.infinity,i=o.source==i?o.target:o.source}return i}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let n of this.graph.edges)t+=this.edgeSourceTargetVal(n,e)*n.weight;e.cut!=t&&console.log(bS.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new Jp(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length==0&&this.graph.nodeCount==0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var tm=class{GetLayers(){return new Iu(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let n of e){let i=n[0],o=n[1];for(let a of this.graph.outEdges[i]){let l=new ar(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new Gi(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var Ar=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new p(this.left,this.top)}get leftBottom(){return new p(this.left,this.bottom)}get rightBottom(){return new p(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new p(this.right,this.top)}static mkAnchor(e,t,n,i,o,a){let l=new Ar(a);return l.la=e,l.ra=t,l.ta=n,l.ba=i,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new p(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=Ar.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t==0?e:Ar.curveIsConvex(e)?Ar.padConvexCurve(e,t):Ar.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,n,i,o){let a=Ar.getPaddedCorner(t,n,i,o);e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b)}static padConvexCurve(e,t){let n=new $;Ar.padCorner(n,e.endPoint.prev,e.endPoint,e.startPoint,t),Ar.padCorner(n,e.endPoint,e.startPoint,e.startPoint.next,t);for(let i=e.startPoint;i.next.next!=null;i=i.next)Ar.padCorner(n,i,i.next,i.next.next,t);return n.closed=!0,n}static getPaddedCorner(e,t,n,i){let o=e.point,a=t.point,l=n.point,u=p.getTriangleOrientation(o,a,l)==1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<E.intersectionEpsilon)return{a:a.add(h.mul(i)),b:null,numberOfPoints:1};let f=d.normalize().mul(i),y=f.rotate(Math.PI/2),S=(i-f.dot(h))/y.dot(h);return{a:f.add(y.mul(S)).add(a),b:f.sub(y.mul(S)).add(a),numberOfPoints:2}}static*orientations(e){yield p.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield p.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield p.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let n of Ar.orientations(e))if(n!=2){if(t==2)t=n;else if(n!=t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():v.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new $;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return $.mkClosedFromPoints([new p(e,this.top),this.rightTop,this.rightBottom,new p(e,this.bottom),new p(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return $.mkClosedFromPoints([new p(e,this.top),new p(this.right,this.y),new p(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var Xa=class{constructor(e,t,n,i,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=n,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new Yt,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=i,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,n,i,o){new Xa(e,t,n,i,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let n=new Array(t);t=0;for(let o of this.graph.InEdges(e))n[t++]=o.Source;n.sort((o,a)=>this.CompareByX(o,a));let i=Math.floor(t/2);i*2==t?this.upperMedians[e]=new ae(n[i-1],n[i]):this.upperMedians[e]=n[i]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let n=new Array(t);t=0;for(let o of this.graph.OutEdges(e))n[t++]=o.Target;n.sort((o,a)=>this.CompareByX(o,a));let i=Math.floor(t/2);i*2==t?this.lowMedians[e]=new ae(n[i-1],n[i]):this.lowMedians[e]=n[i]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),n=new Array(4),i=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,n[a]=l.b;let u=n[a]-t[a];u<i&&(e=a,i=u)}for(let a=0;a<4;a++){let l;if(Xa.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=n[e]-n[a],this.x=this.xCoords[a],l!=0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e==0||e==2}AssignmentBounds(e,t){if(this.nOfVertices==0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let n=1;n<this.nOfVertices;n++){let i=this.x[n];i<t.a?t.a=i:i>t.b&&(t.b=i)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let i=t;this.LR?(yield i.x,yield i.y):(yield i.y,yield i.x)}else{let i=t;i>=0&&(yield i)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,n=this.UpperOf(0,this.h-1),i=this.NextLower(n);for(;this.IsBelow(e,n);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,i)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],n=null,i=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(i,o)&&n==null;i=this.NextRight(i))n=this.InnerEdgeByTarget(t[i]);if(n!=null){let a=this.Pos(this.Source(n));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,i);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(n));for(;this.IsNotRightFrom(i,o);){let u=this.AlignmentToTheRightOfInner(t,i,a);if(i=this.NextRight(i),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,n,u,l,c),n=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(n)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(n)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,n,i,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(n)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,i)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,n){if(this.NumberOfInEdges(e[t])==1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(n,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let i=0;i<this.nOfVertices;i++)if(i==this.root[i]){let o=i;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new ar(i,this.root[a.neighbor],null)),o=this.align[o]}while(o!=i)}let t=sr(e,this.nOfVertices),n=vs.getOrderOnGraph(t);for(let i of n)if(i==this.root[i]){let o=0,a=!0,l=i;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!=i);this.x[i]=o}for(let i of n)if(i==this.root[i]&&t.inEdges[i].length==0){let o=i,a=this.RightMost(-Xa.infinity,Xa.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!=i);l!=a&&(this.x[i]=a)}for(let i=0;i<this.nOfVertices;i++)i!=this.root[i]&&(this.x[i]=this.x[this.root[i]])}TryToGetRightNeighbor(e,t){let n=this.NextRight(this.Pos(e)),i=this.la.Layers[this.la.y[e]];return n>=0&&n<i.length?(t.neighbor=i[n],!0):!1}TryToGetLeftNeighbor(e,t){let n=this.NextLeft(this.Pos(e)),i=this.la.Layers[this.la.y[e]];return n>=0&&n<i.length?(t.neighbor=i[n],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let n=this.la.Layers[t],i=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,n.length-1);for(let a=this.LeftMost(0,n.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=n[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(i,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],i=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let n;if(this.Pos(e)>this.Pos(t)){let i=e;e=t,t=i,n=-1}else n=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*n}},rd=Xa;rd.infinity=1e7;var rm=class extends Vt{constructor(e,t,n,i,o){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(i,o),this.virtualVerticesStart=e.nodeCount,this.virtualVerticesEnd=t.NodeCount-1,this.layeredGraph=t,this.layerArrays=n}EdgeWeightMultiplier(e){let t=e.source,n=e.target;if(t<this.layeredGraph.NodeCount&&this.layerArrays.y[t]==this.layerArrays.y[n]&&this.layerArrays.x[t]==this.layerArrays.x[n]+1)return 0;let i=0,o=-1,a=-1;for(let u of this.outEdges[t])a==-1?a=u.target:o=u.target;return a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&i++,o>=this.virtualVerticesStart&&o<=this.virtualVerticesEnd&&i++,i==0?this.weightMultiplierOfOriginalOriginal:i==1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let e of this.edges)e.weight=e.weight*this.EdgeWeightMultiplier(e)}};var Oo=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new Oo(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length==0)return null;if(e.length==1)return e[0];let t=e[0].parallelogram,n=1,i=xe.parallelogramOfTwo(t,e[n].parallelogram).area;for(let h=2;h<e.length;h++){let d=xe.parallelogramOfTwo(t,e[h].parallelogram).area;d>i&&(n=h,i=d)}let o;for(let h=0;h<e.length;h++)if(h!=n){o=h;break}i=xe.parallelogramOfTwo(e[n].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h==n)continue;let d=xe.parallelogramOfTwo(e[n].parallelogram,e[h].parallelogram).area;d>i&&(o=h,i=d)}let a=new Array,l=new Array;a.push(e[n]),l.push(e[o]);let u=e[n].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h==n||h==o)continue;let d=xe.parallelogramOfTwo(u,e[h].parallelogram),f=d.area-u.area,y=xe.parallelogramOfTwo(c,e[h].parallelogram),S=y.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=y):f<S?(a.push(e[h]),u=d):(l.push(e[h]),c=y)}return{parallelogram:xe.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var Ts=class{static mkDebugCurveTWCILD(e,t,n,i,o,a,l=!1){let u=new Ts;return u.transparency=e,u.width=t,u.color=n,u.icurve=i,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,n,i){return Ts.mkDebugCurveTWCILD(e,t,n,i,null,null)}static mkDebugCurveWCI(e,t,n){return Ts.mkDebugCurveTWCI(255,e,t,n)}static mkDebugCurveCI(e,t){return Ts.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return Ts.mkDebugCurveCI("Black",e)}},oe=Ts;oe.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var vr=class{constructor(e,t,n,i,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=n,this.bottomSite=n.next,this.currentTopSite=n,this.currentBottomSite=n.next,this.layerArrays=i,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,n,i,o,a,l,u){new vr(e,t,n,o,a,l,i,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,n){if(e.equal(t))return t;let i=p.ClosestPointAtLineSegment(t,e,n),o=t.sub(i),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return Io(2)==0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=vr.absCotan(e),n,i=!1;for(let o of this.bottomCorners()){let a=vr.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,n=o,i=!0)}return i?K(t,vr.absCotan(e))?!1:(this.currentBottomSite=He.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,n,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=vr.absCotan(e),n,i=!1;for(let o of this.topCorners()){let a=vr.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,n=o,i=!0)}return i?K(t,vr.absCotan(e))?!1:(this.currentTopSite=He.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,n,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,n=this.currentBottomSite.point.x;for(let i of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,n))for(let o of this.NodeCorners(i))o.y>this.currentBottomSite.point.y&&vr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,n=this.currentTopSite.point.x;for(let i of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,n))for(let o of this.NodeCorners(i))o.y<this.currentTopSite.point.y&&vr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,n=this.currentTopSite.point.x;for(let i of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,n))for(let o of this.NodeCorners(i))o.y>this.currentBottomSite.point.y&&vr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,n=this.currentBottomSite.point.x;for(let i of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,n))for(let o of this.NodeCorners(i))o.y<this.currentTopSite.point.y&&vr.PossibleCorner(t,n,o)&&(yield o)}static PossibleCorner(e,t,n){return n.x>e&&n.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,n,i,o){let a=0,l=0;n==2&&(a=Number.MAX_VALUE),n==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>i&&(d.topAnchor>l+E.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+E.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,n,i,o){let a=0,l=0;n==2&&(a=Number.MAX_VALUE),n==0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=i)break;d.left<o&&(d.topAnchor>l+E.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+E.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var kt=class{constructor(e,t,n,i,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=n,this.settings=i,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let n of e)t.push(n.pNodeOverICurve());return this.thinEastHierarchy=Oo.Calculate(this.thinRightNodes),Oo.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let n of e)t.push(n.pNodeOverICurve());return this.thinWestHierarchy=Oo.Calculate(this.thinWestNodes),Oo.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let n of this.edgePath){let i=null;for(let o of this.EastBoundaryNodesOfANode(n,Rn.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(i==null||i.origin.x>a.origin.x)&&(i=a),e.push(a.polygonalBoundary)}i!=null&&this.thinRightNodes.push(R.mkLinePXY(i.origin,this.originalGraph.right,i.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let n of this.edgePath.nodes()){let i=-1;for(let o of this.LeftBoundaryNodesOfANode(n,Rn.GetNodeKind(t,this.edgePath)))(i==-1||this.layerArrays.x[o]>this.layerArrays.x[i])&&(i=o),e.push(this.anchors[o].polygonalBoundary);if(i!=-1){let o=this.anchors[i];this.thinWestNodes.push(R.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,n){let i=0,o=0;n==2?i=Number.MAX_VALUE:n==0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>i&&(i=c.bottomAnchor),yield u):c.bottomAnchor>i&&(this.NodeUCanBeCrossedByNodeV(u,a)||(i=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,n){let i=0,o=0;n==0?o=Number.MAX_VALUE:n==2&&(i=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+E.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,i=Math.max(i,c.bottomAnchor),yield u):c.bottomAnchor>i+E.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),i=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)==this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let n=this.OutcomingEdge(e),i=this.OutcomingEdge(t);if(this.Intersect(n,i))return!0;e=n.Target,t=i.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}IntersectAbove(e,t){do{let n=this.IncomingEdge(e),i=this.IncomingEdge(t);if(this.Intersect(n,i))return!0;e=n.Source,t=i.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e==t}Intersect(e,t){let n=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],i=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return n>0&&i<0||n<0&&i>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new it(this.headSite)}LineSegIntersectBound(e,t){let n=R.mkPP(e,t);return kt.CurveIntersectsHierarchy(n,this.westHierarchy)||kt.CurveIntersectsHierarchy(n,this.thinWestHierarchy)||kt.CurveIntersectsHierarchy(n,this.eastHierarchy)||kt.CurveIntersectsHierarchy(n,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return kt.SegIntersectsBound(e,t,this.westHierarchy)||kt.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return kt.SegIntersectsBound(e,t,this.eastHierarchy)||kt.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn==1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn==0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,n){return kt.CurveIntersectsHierarchy(R.mkPP(e.point,t.point),n)}static CurveIntersectsHierarchy(e,t){if(t==null||!xe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let n=t.node;return kt.CurveIntersectsHierarchy(e,n.children[0])||kt.CurveIntersectsHierarchy(e,n.children[1])}return v.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return p.getTriangleOrientation(e.prev.point,e.point,e.next.point)==2}Reverse(){let e=new kt(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,n=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=n,n!=null&&(n.prev=e.headSite),n=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,n;for(let i=0;i<this.edgePath.count;i++)n=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(i),this.EdgePathNode(i+1)),t=n;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,n){vr.Refine(t,n,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=He.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=He.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),n=this.anchors[e],i=this.anchors[t];if(K(n.x,i.x))return;let o={ax:n.x,bx:i.x,sign:0};if(!this.FindLegalPositions(n,i,o))return;let a=(n.y-i.y)/(n.bottom-i.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new p(o.ax,n.y);let c=this.headSite.next,h=c.point.y;c.point=new p(this.MiddlePos(o.ax,o.bx,n,i,h),h),c.next.point=new p(o.bx,i.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),n=this.anchors[e],i=this.anchors[t];if(K(n.x,i.x))return;let o={ax:n.x,bx:i.x,sign:0};if(!this.FindPositions(n,i,o))return;let a=(n.y-i.y)/(n.bottom-i.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new p(o.ax,n.y),this.headSite.next.point=new p(o.bx,i.y)}FindLegalPositions(e,t,n){return this.FindPositions(e,t,n)?this.PositionsAreLegal(n.ax,n.bx,n.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,n){let i,o;if(n.ax<n.bx?(n.sign=1,o=Math.max(n.ax,t.left),i=Math.min(e.right,n.bx)):(n.sign=-1,o=Math.max(e.left,n.bx),i=Math.min(t.right,n.ax)),o<=i)n.bx=.5*(o+i),n.ax=.5*(o+i);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;n.sign==1?(n.ax=e.right-.1*e.rightAnchor,n.bx=t.left):(n.ax=e.left+.1*e.leftAnchor,n.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let n=R.mkPP(e.origin,t.origin);return e.x<t.x&&v.CurvesIntersect(n,R.mkPP(e.rightBottom,e.rightTop))||v.CurvesIntersect(n,R.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&v.CurvesIntersect(n,R.mkPP(e.leftBottom,e.leftTop))||v.CurvesIntersect(n,R.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count==2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count==1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,n,i,o,a){if(!K(e,t)&&(e-t)*n>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,i,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new p(e,i.bottom),new p(t,o.top)):!1}MiddleAnchorLegal(e,t,n){let i=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-n.x;return!(o>0&&this.anchors[i[o-1]].right>a+n.left||o<i.length-1&&this.anchors[i[o+1]].left<a+n.right)}MiddlePos(e,t,n,i,o){let a=n.y-o,l=o-i.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let n=t.turn;if(e==0)n>0?e=1:n<0&&(e=-1);else if(e*n<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e==this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new v,t=this.headSite,n=v.findCorner(t);return n!=null?(this.createFilletCurve(e,{a:t,b:n.b,c:n.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(R.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)kt.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!p.closeDistEps(t,e.start)){let n=new v;n.addSegs([R.mkPP(t,e.start),e]),e=n}return t=this.TailSite.point,p.closeDistEps(t,e.end)||e.addSegment(R.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,n,i){let o=.5,a;do a=v.createBezierSeg(o,o,e,t,n),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=v.createBezierSeg(o,o,e,t,n);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}i.segs.length>0&&!p.closeDistEps(i.end,a.start)&&i.addSegment(R.mkPP(i.end,a.start)),i.addSegment(a)}BezierSegIntersectsBoundary(e){return p.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(xe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let n=t.node;return this.BezierSegIntersectsTree(e,n.children[0])||this.BezierSegIntersectsTree(e,n.children[1])}else return kt.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let n of v.getAllIntersections(e,t,!1))if(t instanceof v){let i=t;if(v.realCutWithClosedCurve(n,i,!1))return!0}else return!0;return!1}};var nm=ne(po()),oi=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new oi(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new nm.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let n of t.Children)e.enqueue(n)}}*Ancestors(){let e=new nm.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let n of t.Parents)e.enqueue(n)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}};var Is=class{};var Jr=class extends Is{constructor(e,t){super();this.curve=this.curve,this.location=t.clone()}get Location(){return this.location}set Location(e){this.location=e}Translate(e){this.location=this.location.add(e)}get Curve(){return this.curve}set Curve(e){this.curve=e}};var en=class extends Jr{static mk(e,t){return new en(e,t,new p(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(e){this.centerDelegate=e}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(e){this.curveDelegate=e}get LocationOffset(){return this.locationOffset}set LocationOffset(e){this.locationOffset=e}constructor(e,t,n){super(null,t().add(n));this.LocationOffset=n,this.CurveDelegate=e,this.CenterDelegate=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var wu=class{constructor(e,t,n,i,o){this.color=e,t!==void 0&&(this.item=t),n!==void 0&&(this.parent=n),i!==void 0&&(this.left=i),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var ot=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new wu(1)}clear(){this.root=this.nil=new wu(1)}toNull(e){return e!=this.nil?e:null}isEmpty(){return this.root==this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let n;for(;t!=this.nil&&(n=this.comparer(e,t.item))!=0;)t=n<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t==this.nil)return null;let n=null;for(;t!=this.nil;)t=e(t.item)?(n=t).left:t.right;return n}findLast(e,t=this.root){if(t==this.nil)return null;let n=null;for(;t!=this.nil;)t=e(t.item)?(n=t).right:t.left;return n}treeMinimum(e=this.root){for(;e.left!=this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!=this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!=this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!=this.nil&&e==t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!=this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!=this.nil&&e==t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!=this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!=this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent==this.nil?this.root=t:e==e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!=this.root&&e.color==1;)if(e==e.parent.left){let t=e.parent.right;t.color==0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color==1&&t.right.color==1?(t.color=0,e=e.parent):(t.right.color==1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color==0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color==1&&t.left.color==1?(t.color=0,e=e.parent):(t.left.color==1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left==this.nil||e.right==this.nil)t=e;else for(t=e.right;t.left!=this.nil;)t=t.left;let n=t.left!=this.nil?t.left:t.right;return n.parent=t.parent,t.parent==this.nil?this.root=n:t==t.parent.left?t.parent.left=n:t.parent.right=n,t!=e&&(e.item=t.item),t.color==1&&this.deleteFixup(n),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,n=this.root,i=0;for(;n!=this.nil;)t=n,i=this.comparer(e,n.item),n=i<0?n.left:n.right;let o=new wu(1,e,t,this.nil,this.nil);return t==this.nil?this.root=o:i<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!=this.root&&e.parent.color==0;)if(e.parent==e.parent.parent.left){let t=e.parent.parent.right;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color==0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let n of this.allNodes())e+=n.toString(),t!=this.count-1&&(e+=`
`),t++;return e+"}"}};var ws=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let n=t>>1,i,o;for(;t>1&&this.Less(i=this.A[t],o=this.A[n]);)this.A[n]=i,this.A[t]=o,t=n,n=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,n=2,i=!1;for(;n<this.heapSize&&!i;){i=!0;let o=this.A[n],a=this.A[n+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[n]=e,i=!1,t=n,n=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[n+1]=e,i=!1,t=n+1,n=t<<1)}if(n==this.heapSize){let o=this.A[n];this.compare(o,e)<0&&(this.A[t]=o,this.A[n]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Nt=class{};var tn=class extends Nt{get Site(){return this.Vertex.point}constructor(e){super();this.Vertex=e}get Polyline(){return this.Vertex.polyline}};var im=class extends tn{constructor(e){super(e)}};var om=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(p.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),n=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(n))}};var sm=class extends Nt{constructor(e){super();this.site=e}get Site(){return this.site}};var Lu=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new ws((n,i)=>this.Compare(n,i)),this.ObstacleSideComparer=new om(this),this.LeftObstacleSideTree=new ot((n,i)=>this.ObstacleSideComparer.Compare(n,i)),this.RightObstacleSideTree=new ot((n,i)=>this.ObstacleSideComparer.Compare(n,i))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+E.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>E.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(n=>p.pointToTheRightOfLineOrOnLine(e,n.Start,n.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(n=>!p.pointToTheRightOfLineOrOnLine(e,n.Start,n.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new sm(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new im(t))}GetLowestPoint(e){let t=e.startPoint,n=e.startPoint.next;for(;n!=null;n=n.next)this.Less(n.point,t.point)&&(t=n);return t}Compare(e,t){let n=e.Site,i=t.Site;return this.ComparePoints(n,i)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let n=this.SweepDirection.dot(e),i=this.SweepDirection.dot(t);return n<i?-1:n>i?1:(n=this.directionPerp.dot(e),i=this.directionPerp.dot(t),n<i?-1:n>i?1:0)}};var yS=ne(Tt()),Ro=class{constructor(e,t,n=1){this.LengthMultiplier=1;(Ro.closeuv(e,t)||Ro.closeuv(t,e))&&console.log(e),this.Source=e,this.Target=t,this.Weight=n}static closeuv(e,t){return p.closeDistEps(e.point,Ro.u,.1)&&p.closeDistEps(t.point,Ro.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return yS.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new Ro(this.Target,this.Source)}Clone(){return new Ro(this.Source,this.Target)}},kr=Ro;kr.u=new p(545.833,840.458),kr.v=new p(606.1667261889578,786.2917261889578),kr.DefaultWeight=1;var Ut=class extends kr{static constructorVV(e,t){return new Ut(e,t,0)}constructor(e,t,n=0){super(e,t,n)}};var ki=class{constructor(e){this._inEdges=new Array;this._outEdges=new ot((t,n)=>this.Compare(t,n)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t==-1)return;let n=this._inEdges.length-1;t!=n&&(this._inEdges[t]=this._inEdges[n]),this._inEdges.pop()}static FindFirst(e,t){return ki.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,n){if(e==t.nil)return null;let i=null;for(;e!=t.nil;)e=e.item.TargetPoint.compareTo(n)>=0?(i=e).left:e.right;return i}get(e){let t=ki.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target==e||(t=ki.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target==this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var Me=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new ki(e);this.pointToVertexMap=new Je}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source==e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!=e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let n=t.startPoint;;n=n.next){let i=p.getTriangleOrientation(n.point,n.next.point,n.next.next.point);if(i!=2){yield i==0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let n=this.VertexFactory(e);return this.pointToVertexMap.set(e,n),n}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let n;if(n=e.get(t))return n;if(e==t)throw new Error("Self-edges are not allowed");let i=new kr(e,t);return e.OutEdges.insert(i),t.InEdges.push(i),i}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,n){let i=this.FindVertex(e),o=null;if(i!=null&&(o=this.FindVertex(t),o!=null)){let l=i.get(o);if(l)return l}i==null?(i=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=n(i,o);return i.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(n,i)=>new kr(n,i))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let n=this.FindVertex(e);if(n==null)return null;let i=this.FindVertex(t);return i==null?null:n.get(i)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var Ls=class{constructor(){this.Removed=!1}};var Bn=class extends Ls{get Start(){return this.start}get End(){return this.EndVertex.point}constructor(e,t,n){super();this.start=e,this.EndVertex=t,this.ConeSide=n}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Ou=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var nd=class extends Nt{get ConeToClose(){return this.coneToClose}get Site(){return this.site}constructor(e,t){super();this.site=e,this.coneToClose=t}toString(){return"ConeClosureEvent "+this.site}};var rn=class extends Ls{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var si=class extends Ls{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var Ya=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let n=e instanceof Bn,i=t instanceof Bn;return n?i?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):i?this.CompareConeSideAndObstacleSide(e,t):Ya.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(p.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=p.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t==1?-1:t==0?1:e instanceof rn?-1:1}CompareConeSideAndObstacleSide(e,t){let n=p.getTriangleOrientation(this.x,t.start,t.End);return n==1?-1:n==0||e instanceof rn?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),n=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(n))}CompareBrokenSides(e,t){return e.EndVertex==t.EndVertex?Ya.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):p.getTriangleOrientation(this.x,t.start,t.EndVertex.point)==1?-1:1}};var Os=class extends Nt{get EndVertex(){return this.endVertex}constructor(e,t,n){super();this.coneLeftSide=e,this.intersectionPoint=t,this.endVertex=n}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var Rs=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var Bs=class extends Rs{Init(e){this.StartVertex=e}constructor(e){super();this.Init(e)}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var Ui=class extends Bs{constructor(e){super(e);this.end=e.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var ai=class extends tn{constructor(e){super(e)}};var id=class extends Nt{get EndVertex(){return this.endVertex}set EndVertex(e){this.endVertex=e}constructor(e,t,n){super();this.coneRightSide=e,this.intersectionPoint=t,this.endVertex=n}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var zi=class extends Bs{constructor(e){super(e);this.end=e.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var li=class extends tn{constructor(e){super(e)}};var Et=class extends Lu{constructor(e,t,n,i,o,a,l){super(e,t);this.visibilityGraph=o,this.ConeRightSideDirection=n,this.ConeLeftSideDirection=i,this.coneSideComparer=new Ya(this),this.leftConeSides=new ot((u,c)=>this.coneSideComparer.Compare(u,c)),this.rightConeSides=new ot((u,c)=>this.coneSideComparer.Compare(u,c)),this.Ports=a,this.BorderPolyline=l,this.PortEdgesCreator=(u,c)=>new Ut(u,c,0)}static Sweep(e,t,n,i,o,a){new Et(e,t,t.rotate(-n/2),t.rotate(n/2),i,o,a).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let e of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(e.SourcePoint,e.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count==0)return;let e=this.BorderPolyline.startPoint,t=this.leftConeSides.count;do{let n=this.leftConeSides.treeMinimum().item.Cone;e=this.FindPolylineSideIntersectingConeRightSide(e,n),e=this.GetPolylinePointInsideOfConeAndRemoveCones(e,n),t--}while(this.leftConeSides.count>0&&t>0)}GetPolylinePointInsideOfConeAndRemoveCones(e,t){let n=e.nextOnPolyline,i=Et.FindInsidePoint(e.point,n.point,t);return p.closeDistEps(i,e.point)?(this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)):p.closeDistEps(i,n.point)?(this.AddEdgeAndRemoveCone(t,n.point),this.AddEdgesAndRemoveRemainingConesByPoint(n.point),e=n):(e=Et.InsertPointIntoPolylineAfter(this.BorderPolyline,e,i),this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)),e}static FindInsidePoint(e,t,n){return Et.FindInsidePointBool(e,t,n.Apex,n.Apex.add(n.LeftSideDirection),n.Apex.add(n.RightSideDirection))}static FindInsidePointBool(e,t,n,i,o){if(p.closeDistEps(e,t)||p.PointIsInsideCone(e,n,i,o))return e;if(p.PointIsInsideCone(t,n,i,o))return t;let a=p.middle(e,t);return p.pointToTheLeftOfLine(a,n,i)?Et.FindInsidePointBool(a,t,n,i,o):Et.FindInsidePointBool(e,a,n,i,o)}AddEdgesAndRemoveRemainingConesByPoint(e){let t=new Array;for(let n of this.leftConeSides)if(p.PointToTheRightOfLineOrOnLine(e,n.Start,n.Start.add(n.Direction)))t.push(n.Cone);else break;for(let n of t)this.AddEdgeAndRemoveCone(n,e)}FindPolylineSideIntersectingConeRightSide(e,t){let n=e,i=t.Apex,o=t.Apex.add(this.ConeRightSideDirection),a=Et.GetSign(e,i,o);for(;;){let l=e.nextOnPolyline,u=Et.GetSign(l,i,o);if(u-a>0)return e;if(e=l,a=u,e==n)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(e,t,n){let i=p.signedDoubledTriangleArea(t,n,e.point);return i<0?1:i>0?-1:0}AddEdgeAndRemoveCone(e,t){this.Ports!=null&&this.Ports.has(e.Apex)?this.CreatePortEdge(e,t):this.visibilityGraph.AddEdgePP(e.Apex,t),this.RemoveCone(e)}CreatePortEdge(e,t){this.portEdgesGraph==null&&(this.portEdgesGraph=new Me);let n=this.portEdgesGraph.FindVertex(e.Apex),i=n!=null?Array.from(n.InEdges).concat(Array.from(n.OutEdges.allNodes())):null;if(i)for(let o of i){let a=(o.Target==n?o.Source:o.Target).point;Me.RemoveEdge(o),this.portEdgesGraph.AddEdgePP(a,t)}this.portEdgesGraph.AddEdgePP(e.Apex,t)}static InsertPointIntoPolylineAfter(e,t,n){let i;return t.next!=null?(i=yt.mkFromPoint(n),i.prev=t,i.next=t.next,t.next.prev=i,t.next=i):(i=yt.mkFromPoint(n),i.prev=t,t.next=i,e.endPoint=i),i.polyline=e,e.setInitIsRequired(),i}ProcessEvent(e){e instanceof tn?this.ProcessVertexEvent(e):e instanceof id?this.ProcessRightIntersectionEvent(e):e instanceof Os?this.ProcessLeftIntersectionEvent(e):(e instanceof nd?e.ConeToClose.Removed||this.RemoveCone(e.ConeToClose):this.ProcessPortObstacleEvent(e),this.Z=this.GetZS(e))}ProcessPortObstacleEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.CreateConeOnVertex(e)}ProcessLeftIntersectionEvent(e){if(e.coneLeftSide.Removed==!1)if(Math.abs(e.EndVertex.point.sub(e.Site).dot(this.SweepDirection))<E.distanceEpsilon)this.RemoveCone(e.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(e.coneLeftSide),this.Z=this.GetZP(e.Site);let t=new Bn(e.Site,e.EndVertex,e.coneLeftSide);this.InsertToTree(this.leftConeSides,t),e.coneLeftSide.Cone.LeftSide=t,this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForLeftSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForLeftSide(e){if(e.Cone.RightSide instanceof si){let t=e.Cone.RightSide;p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.EndVertex.point)==0&&this.CreateConeClosureEvent(e,t)}}CreateConeClosureEvent(e,t){let n=p.RayIntersectsRayInteriors(e.start,e.Direction,t.Start,t.Direction);if(n){let i=new nd(n,e.Cone);this.EnqueueEvent(i)}}ProcessRightIntersectionEvent(e){if(e.coneRightSide.Removed==!1){this.RemoveSegFromRightTree(e.coneRightSide),this.Z=this.GetZP(e.Site);let t=new Bn(e.Site,e.EndVertex,e.coneRightSide);this.InsertToTree(this.rightConeSides,t),e.coneRightSide.Cone.RightSide=t,this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForRightSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForRightSide(e){if(e.Cone.LeftSide instanceof rn){let n=e.Cone.LeftSide;p.getTriangleOrientation(n.Start,n.Start.add(n.Direction),e.EndVertex.point)==1&&this.CreateConeClosureEvent(e,n)}}RemoveConesClosedBySegment(e,t){this.CloseConesCoveredBySegment(e,t,this.GetZP(e)>this.GetZP(t)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(e,t,n){let i=n.findFirst(l=>p.getTriangleOrientation(l.Start,l.Start.add(l.Direction),e)==1);if(i==null||!p.IntervalIntersectsRay(e,t,i.item.Start,i.item.Direction))return;let a=new Array;do a.push(i.item.Cone),i=n.next(i);while(i!=null&&p.IntervalIntersectsRay(e,t,i.item.Start,i.item.Direction)!=null);for(let l of a)this.RemoveCone(l)}ProcessVertexEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.AddConeAndEnqueueEvents(e)}static Diamond(e){return ve.CreateDiamond(2,2,e)}AddConeAndEnqueueEvents(e){if(e instanceof ai){let n=e.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(e,n)}else if(e instanceof li){let i=e.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(e,i)}else this.CloseConesAddConeAtLeftVertex(e,e.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(e,e.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(e,t){let n=e.Vertex.nextOnPolyline.point;this.directionPerp.dot(e.Site.sub(n))>E.distanceEpsilon&&this.RemoveConesClosedBySegment(n,e.Vertex.point),this.directionPerp.dot(t.point.sub(e.Site))>E.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,t.point);let i=e.Site,o=i.add(this.ConeLeftSideDirection),a=i.add(this.ConeRightSideDirection),l=t.point;this.GetZP(i.sub(n))>E.distanceEpsilon&&this.RemoveRightSide(new zi(e.Vertex.nextOnPolyline)),this.GetZP(i.sub(t.point))>E.distanceEpsilon&&this.RemoveLeftSide(new Ui(t)),this.GetZP(l)+E.distanceEpsilon<this.GetZS(e)&&this.CreateConeOnVertex(e),p.PointToTheRightOfLineOrOnLine(l,i,o)?p.PointToTheLeftOfLineOrOnLine(l,i,a)?this.CaseToTheLeftOfLineOrOnLineConeRp(e,t):(this.GetZP(l.sub(i))>E.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,t),this.InsertRightSide(new zi(e.Vertex))),this.EnqueueRightVertexEvent(new li(t))):(this.CreateConeOnVertex(e),p.PointToTheLeftOfLineOrOnLine(l.add(this.DirectionPerp),l,i)&&this.EnqueueRightVertexEvent(new li(t)))}CaseToTheLeftOfLineOrOnLineConeRp(e,t){this.EnqueueRightVertexEvent(new li(t));let n=new Ou(e.Vertex.point,this),i=new Bn(n.Apex,t,new rn(n));n.LeftSide=i,n.RightSide=new si(n);let o=this.InsertToTree(this.rightConeSides,n.RightSide);this.LookForIntersectionWithConeRightSide(o);let a=this.InsertToTree(this.leftConeSides,n.LeftSide);this.FixConeLeftSideIntersections(i,a),this.GetZP(t.point.sub(e.Site))>E.distanceEpsilon&&this.InsertRightSide(new zi(e.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(e,t){let n=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(e);if(n!=null&&n.item instanceof si!=null){let o=p.IntervalIntersectsRay(e,t.point,n.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,t.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n.item,o,t))}}CreateRightIntersectionEvent(e,t,n){return new id(e,t,n)}GetLastNodeToTheLeftOfPointInRightSegmentTree(e){return this.rightConeSides.findLast(t=>Et.PointIsToTheRightOfSegment(e,t))}LookForIntersectionOfObstacleSideAndLeftConeSide(e,t){let n=this.GetFirstNodeToTheRightOfPoint(e);if(n==null||!(n.item instanceof rn))return;let i=n.item,o=p.IntervalIntersectsRay(e,t.point,i.Start,this.ConeLeftSideDirection);o&&this.EnqueueEvent(new Os(i,o,t))}GetFirstNodeToTheRightOfPoint(e){return this.leftConeSides.findFirst(t=>Et.PointIsToTheLeftOfSegment(e,t))}static PointIsToTheLeftOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==1}static PointIsToTheRightOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)==0}FixConeLeftSideIntersections(e,t){do t=this.leftConeSides.next(t);while(t!=null&&p.PointToTheRightOfLineOrOnLine(e.Start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null&&t.item instanceof rn){let n=t.item,i=p.IntervalIntersectsRay(e.start,e.End,n.Start,n.Direction);i&&this.EnqueueEvent(new Os(n,i,e.EndVertex))}}InsertToTree(e,t){return this.coneSideComparer.SetOperand(t),e.insert(t)}CloseConesAddConeAtLeftVertex(e,t){let n=e.Vertex.prevOnPolyline.point;e.Site.sub(n).dot(this.directionPerp)<-E.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,n),t.point.sub(e.Site).dot(this.directionPerp)<-E.distanceEpsilon&&this.RemoveConesClosedBySegment(t.point,e.Site);let i=e.Site,o=i.add(this.ConeLeftSideDirection),a=i.add(this.ConeRightSideDirection),l=t.point;this.GetZP(i.sub(n))>E.distanceEpsilon&&this.RemoveLeftSide(new Ui(e.Vertex.prevOnPolyline));let u=this.GetZP(l)-this.Z;u<-E.distanceEpsilon&&this.RemoveRightSide(new zi(t));let c=l.sub(e.Site);if(u<-E.distanceEpsilon||K(u,0)&&this.GetZP(c)>0&&c.dot(this.directionPerp)>-E.distanceEpsilon)this.CreateConeOnVertex(e);else if(!p.PointToTheLeftOfLineOrOnLine(l,i,a))this.CreateConeOnVertex(e),this.EnqueueEvent(new ai(t));else if(p.PointToTheLeftOfLineOrOnLine(l,i,o))this.EnqueueEvent(new ai(t)),this.GetZP(c)>E.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,t),this.InsertLeftSide(new Ui(e.Vertex)));else{this.EnqueueEvent(new ai(t));let h=new Ou(e.Vertex.point,this),d=new Bn(e.Vertex.point,t,new si(h));h.RightSide=d,h.LeftSide=new rn(h),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,h.LeftSide));let f=this.InsertToTree(this.rightConeSides,d);this.FixConeRightSideIntersections(d,f),this.GetZP(c)>E.distanceEpsilon&&this.InsertLeftSide(new Ui(e.Vertex))}}RemoveCone(e){e.Removed=!0,this.RemoveSegFromLeftTree(e.LeftSide),this.RemoveSegFromRightTree(e.RightSide)}RemoveSegFromRightTree(e){this.coneSideComparer.SetOperand(e);let t=this.rightConeSides.remove(e);if(e.Removed=!0,t==null){let n=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),t=this.rightConeSides.remove(e),this.Z=n}}RemoveSegFromLeftTree(e){if(e.Removed=!0,this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e)==null){let n=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e),this.Z=n}}FixConeRightSideIntersections(e,t){do t=this.rightConeSides.previous(t);while(t!=null&&p.PointToTheLeftOfLineOrOnLine(e.start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null){let n;if(t.item instanceof si){let i=t.item;(n=p.IntervalIntersectsRay(e.start,e.End,i.Start,i.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(i,n,e.EndVertex))}}}CreateConeOnVertex(e){let t=new Ou(e.Site,this);t.LeftSide=new rn(t),t.RightSide=new si(t);let n=this.InsertToTree(this.leftConeSides,t.LeftSide),i=this.InsertToTree(this.rightConeSides,t.RightSide);this.LookForIntersectionWithConeRightSide(i),this.LookForIntersectionWithConeLeftSide(n)}LookForIntersectionWithConeLeftSide(e){if(e.item instanceof rn){let n=e.item,i=this.FindFirstObstacleSideToTheLeftOfPoint(n.Start);i!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(n,i)}else{let n=e.item;e=this.leftConeSides.next(e),e!=null&&e.item instanceof rn&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(e.item,n)}}LookForIntersectionWithConeRightSide(e){if(e.item instanceof si){let n=e.item,i=this.FindFirstObstacleSideToToTheRightOfPoint(n.Start);i!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(n,i)}else{let n=e.item;e=this.rightConeSides.previous(e),e!=null&&e.item instanceof si&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(e.item,n)}}TryIntersectionOfConeRightSideAndObstacleConeSide(e,t){let n=p.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,n,t.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(e,t){let n=p.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,n,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(e,t){let n=p.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(new Os(e,n,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(e,t){let n=p.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(new Os(e,n,t.EndVertex))}Show(e,t){let n=Array.from(this.Obstacles).map(i=>oe.mkDebugCurveTWCI(200,.5,"Blue",i));for(let i of this.rightConeSides)n.push(oe.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(i))),i instanceof Bn&&n.push(oe.mkDebugCurveCI("brown",Et.Diamond(i.start))),n.push(oe.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(i.Cone.LeftSide))),i.Cone.LeftSide instanceof Bn&&n.push(oe.mkDebugCurveCI("green",Et.Diamond(i.Cone.LeftSide.start)));n=n.concat(Array.from(this.visibilityGraph.Edges).map(i=>oe.mkDebugCurveWCI(2,"Black",R.mkPP(i.SourcePoint,i.TargetPoint)))),n=n.concat(e.map(i=>oe.mkDebugCurveCI("Red",i)))}ExtendSegmentToZ(e){let t=e.Direction.dot(this.SweepDirection),n=(this.Z+40-e.Start.dot(this.SweepDirection))/t;return R.mkPP(e.Start,e.Start.add(e.Direction.mul(n)))}GoOverConesSeeingVertexEvent(e){let t=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e);if(t==null)return;let i=t.item.Cone,o=i.LeftSide;if(Et.VertexIsToTheLeftOfSegment(e,o))return;let a=[i];if(this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),t==null){let l=this.Z;this.Z=Math.max(this.GetZP(o.Start),this.PreviousZ),this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),this.Z=l}if(!(t==null&&(t=this.GetRbNodeEmergency(t,o),t==null))){for(t=this.leftConeSides.next(t);t!=null&&!Et.VertexIsToTheLeftOfSegment(e,t.item);)a.push(t.item.Cone),t=this.leftConeSides.next(t);for(let l of a)this.AddEdgeAndRemoveCone(l,e.Site)}}GetRbNodeEmergency(e,t){for(let n=this.leftConeSides.treeMinimum();n!=null;n=this.leftConeSides.next(n))if(n.item==t){e=n;break}return e}static VertexIsToTheLeftOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==1}static VertexIsToTheRightOfSegment(e,t){return p.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)==0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e){return this.rightConeSides.findFirst(t=>!Et.VertexIsToTheRightOfSegment(e,t))}EnqueueRightVertexEvent(e){this.GetZP(e.Site.sub(e.Vertex.prevOnPolyline.point))>E.tolerance||this.EnqueueEvent(e)}invariant(){for(let e of this.leftConeSides)if(e.Removed)return!1;for(let e of this.rightConeSides)if(e.Removed)return!1;return!0}};var Bo=class extends me{constructor(e,t){super(null);this.coneAngle=Math.PI/6;this.ports=new Ve;this._obstacles=Array.from(Me.OrientHolesClockwise(e)),this._visibilityGraph=t}static mk(e,t,n,i,o){let a=new Bo(e,t);return a.Ports=i,a.BorderPolyline=o,a.ConeAngle=n,a}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Ports(){return this.ports}set Ports(e){this.ports=e}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(e){this.borderPolyline=e}get Bidirectional(){return this._bidirectional}set Bidirectional(e){this._bidirectional=e}static GetTotalSteps(e){return Math.floor((2*Math.PI-e/2)/e)+1}run(){let e=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let t;for(let n=0;(t=this.coneAngle*n)<=e;n++)super.ProgressStep(),this.AddDirection(new p(Math.cos(t),Math.sin(t)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let e=Math.PI/this.coneAngle;for(let t=0;t<e;t++){let n=t*this.coneAngle,i=new Me;this.AddDirection(new p(Math.cos(n),Math.sin(n)),this.BorderPolyline,i);let o=new Me;this.AddDirection(new p(Math.cos(n)*-1,Math.sin(n)*-1),this.BorderPolyline,o),this.AddIntersectionOfBothDirectionSweepsToTheResult(i,o)}}AddIntersectionOfBothDirectionSweepsToTheResult(e,t){for(let n of e.Edges)t.FindEdgePP(n.SourcePoint,n.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(n.SourcePoint,n.TargetPoint)}AddDirection(e,t,n){Et.Sweep(this._obstacles,e,this.coneAngle,n,this.Ports,t)}};var mt=class extends Is{constructor(e){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=e,this.location=this.curve().start}mk(e,t){let n=new mt(e);return n.HookSize=t,n}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(e){this.location=e}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(e){this.adjustmentAngle=e}get HookSize(){return this.hookSize}set HookSize(e){this.hookSize=e}};var $t=class extends en{get LoosePolyline(){return this.loosePolyline}set LoosePolyline(e){this.loosePolyline=e}constructor(e,t,n=new p(0,0)){super(e,t,n)}static mk(e,t){return new $t(e,t)}};var Qt=class extends Is{get Location(){return this.curve.value(this.parameter)}set Location(e){throw new Error("Method should not be called.")}static mk(e,t){let n=new Qt;return n.curve=e,n.parameter=t,n}get Parameter(){return this.parameter}set Parameter(e){this.parameter=e}get Curve(){return this.curve}set Curve(e){this.curve=e}};var $a=class extends oi{get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(e){if(e)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}constructor(e){super(null);this.curveDelegate=e}};var nn=class{static GetShapes(e,t){let n=new Map;for(let i of e)nn.ProcessAncestorDescendantCouple(i.target,i.source,n),nn.InsertEdgePortsToShapes(n,i);for(let i of t)nn.ProcessAncestorDescendantCouple(i.source,i.target,n),nn.InsertEdgePortsToShapes(n,i);return nn.BindShapes(n),Array.from(n.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,n]of e){if(!(t instanceof je))continue;let i=t;for(let o of am(i)){let a=e.get(o);a&&n.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,n){let i=od(t);do{for(let o of am(i))nn.CreateShapeIfNeeeded(o,n);if(i==e)break;i=od(i)}while(!0);nn.CreateShapeIfNeeeded(i,n)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new $a(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,n){let i=new Set;for(let o of e)if(nn.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,i,n))return!1;for(let o of t)if(nn.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,i,n))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,n,i){let o=od(t);for(;;){for(let a of am(o))if(n.add(a),n.size>i)return!0;if(o==e)break;o=od(o)}return n.add(o),n.size>i}};function od(s){let e=s.node.parent;return De.getGeom(e)}function*am(s){for(let e of s.graph.shallowNodes)yield De.getGeom(e)}var Tr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new p(0,Number.MAX_SAFE_INTEGER);let t=-1,n=0;for(let i of e)i.y<this.pivot.y?(this.pivot=i,t=n):i.y==this.pivot.y&&i.x>this.pivot.x&&(this.pivot=i,t=n),n++;if(n>=1){this.hullPoints=new Array(n-1),n=0;for(let i of e)n!=t?this.hullPoints[n++]={point:i,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new Tr(e);for(let n of t.Calculate())yield n}*Calculate(){if(this.pivot.y!=Number.MAX_SAFE_INTEGER){if(this.hullPoints.length==0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return p.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)==1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=p.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t==1?!0:t==0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+E.distanceEpsilon&&e.x<this.pivot.x-E.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(o2(this.pivot))}static createConvexHullAsClosedPolyline(e){return $.mkClosedFromPoints(Array.from(Tr.CalculateConvexHull(e)))}};function o2(s){return(e,t)=>{if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;switch(p.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let n=e.point.x-s.x,i=t.point.x-s.x;if(n>E.distanceEpsilon&&i<E.distanceEpsilon*-1)return-1;if(n<E.distanceEpsilon*-1&&i>E.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function cr(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(cr(s,e.Left,t),cr(s,e.Right,t)):e.Left!=null?(cr(s.Left,e.Left,t),cr(s.Left,e.Right,t),cr(s.Right,e.Left,t),cr(s.Right,e.Right,t)):(cr(s.Left,e,t),cr(s.Right,e,t)))}function xt(s,e,t){!s.irect.intersects_rect(e.irect)||(s==e?a2(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(xt(s,e.Left,t),xt(s,e.Right,t)):e.Left!=null?(xt(s.Left,e.Left,t),xt(s.Left,e.Right,t),xt(s.Right,e.Left,t),xt(s.Right,e.Right,t)):(xt(s.Left,e,t),xt(s.Right,e,t)))}function on(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s==e)return s2(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(on(s,e.Left,t)||on(s,e.Right,t))return!0}else if(e.Left!=null){if(on(s.Left,e.Left,t)||on(s.Left,e.Right,t)||on(s.Right,e.Left,t)||on(s.Right,e.Right,t))return!0}else if(on(s.Left,e,t)||on(s.Right,e,t))return!0;return!1}function s2(s,e){return s.Left==null?!1:on(s.Left,s.Left,e)||on(s.Left,s.Right,e)||on(s.Right,s.Right,e)}function a2(s,e){s.Left!=null&&(xt(s.Left,s.Left,e),xt(s.Left,s.Right,e),xt(s.Right,s.Right,e))}var Qa=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,n=e+Math.floor((t-e)/2),i=this.f(n);if(i>=this.f(0)&&i>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(n=e+Math.floor((t-e)/2),this.BehaviourAtIndex(n)){case 1:e=n;break;case 0:t=n;break;case 2:return n}return e==t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e==0){let o=this.f(1);return o==t?2:o>t?0:1}if(e==this.length-1){let o=this.f(this.length-2);return o==t?2:o>t?1:0}let n=t-this.f(e-1),i=this.f(e+1)-t;return n*i<=0?2:n>0?0:1}FindMaximum(){let e=0,t=this.length-1,n=e+Math.floor((t-e)/2),i=this.f(n);if(i<=this.f(0)&&i<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(n=e+Math.floor((t-e)/2),this.BehaviourAtIndex(n)){case 1:t=n;break;case 0:e=n;break;case 2:return n}return e==t||this.f(e)>this.f(t)?e:t}};var lm=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),n=(this.f(this.length-1)-e)/(this.length-1);return i=>Math.min(this.f(i),e+n*i)}GetAdjustedSequenceForMaximum(){let e=this.f(0),n=(this.f(this.length-1)-e)/(this.length-1);return i=>Math.max(this.f(i),e+n*i)}FindMinimum(){return this.f(0)==this.f(this.length-1)?new Qa(this.f,this.length).FindMinimum():new Qa(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)==this.f(this.length-1)?new Qa(this.f,this.length).FindMaximum():new Qa(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var Ms=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,n){let i=this.P.pnt(e);return this.upperBranchOnP?p.pointToTheLeftOfLineOrOnLine(n,i,t):p.pointToTheRightOfLineOrOnLine(n,i,t)}LeftFromLineOnQ(e,t,n){let i=this.Q.pnt(e);return this.lowerBranchOnQ?p.pointToTheLeftOfLineOrOnLine(n,i,t):p.pointToTheRightOfLineOrOnLine(n,i,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,n,i){for(;t!=e||i!=n;){let o=t!=e?this.MedianOnP(e,t):e,a=i!=n?this.MedianOnQ(n,i):n,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!=e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(n,i)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?n=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?i=a:h=!1:i!=n?this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:h=!1:h=!1,!c&&!h&&(e=o,t=o,n=a,i=a)}return[e,i]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=p.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.add(t.qClosest).rotate(Math.PI/2)}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2==e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2==e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1==e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1==e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=p.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),p.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:p.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=p.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),p.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:p.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,n,i){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(i-n)+1;return a>2||o==2&&a==2}ShrinkChunks(e){let t=e.p1==e.p2?e.p1:this.P.Median(e.p1,e.p2),n=e.q1==e.q2?e.q1:this.Q.Median(e.q2,e.q1),i=this.P.pp(t).point,o=this.Q.pp(n).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,n,i,o,a),!this.InternalCut(e,t,n,a.a1,a.a2,a.b1,a.b2)&&!Ms.OneOfChunksContainsOnlyOneVertex(e,t,n,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:n},a)){if(e.p2==this.P.Next(e.p1)&&e.q1==this.Q.Next(e.q2)){let l=R.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab==0?e.p2=e.p1:l.parab==1?e.p1=e.p2:l.parcd==0?e.q2=e.q1:l.parcd==1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=n:a.a2>=Math.PI/2?e.p2=t:e.q2=n:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=n:e.q2=n}}InternalCut(e,t,n,i,o,a,l){let u=!1;if(i>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(n).point,d=this.P.pp(this.P.Next(t)).point,f=p.getTriangleOrientation(c,h,this.Q.pp(0).point),y=p.getTriangleOrientation(c,h,d);f==y?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(n).point,d=this.Q.pp(this.Q.Next(n)).point,f=p.getTriangleOrientation(c,h,this.P.pp(0).point),y=p.getTriangleOrientation(c,h,d);f==y?e.q2=this.Q.Next(n):e.q1=this.Q.Prev(n),u=!0}return u}GetAnglesAtTheMedian(e,t,n,i,o){o.a1=p.anglePCP(i,n,this.P.pnt(this.P.Prev(e))),o.a2=p.anglePCP(this.P.pnt(this.P.Next(e)),n,i),o.b1=p.anglePCP(this.Q.pnt(this.Q.Next(t)),i,n),o.b2=p.anglePCP(n,i,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,n){let i=e.p2==this.P.Next(e.p1),o=e.q1==this.Q.Next(e.q2);return i&&!o?(this.ProcessShortSide(e,t.mp,t.mq,n.a1,n.b1,n.a2,n.b2),!0):o&&!i?(this.SwapEverything(e,t,n),this.ProcessShortSide(e,t.mp,t.mq,n.a1,n.b1,n.a2,n.b2),this.SwapEverything(e,t,n),!0):!1}SwapEverything(e,t,n){this.SwapPq();let i=e.p2;e.p2=e.q1,e.q1=i,i=e.q2,e.q2=e.p1,e.p1=i,i=t.mq,t.mq=t.mp,t.mp=i,i=n.a2,n.a2=n.b1,n.b1=i,i=n.b2,n.b2=n.a1,n.a1=i}ProcessShortSide(e,t,n,i,o,a,l){t==e.p2?this.ProcessSide(e,n,i,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=n:o>=Math.PI/2?e.q1=n:a<l&&(p.canProject(this.Q.pnt(n),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=n:e.p1=e.p2):i+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,n,i,o){let a=this.Q.pnt(t);n<=Math.PI?n+i>=Math.PI?n>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:n<o&&(p.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,i>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,n,i,o){return e.p1==e.p2?(o>=Math.PI/2?e.q1=n:e.q2=n,!0):e.q1==e.q2?(i>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),n=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,n,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,n,e.q2)}CalculateRightTangents(){let e;this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),n=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,n,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,n,e.q2)}};var Dt=class{static mkFromPoints(e){return new Dt($.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,n,i){let o=i.rotate(Math.PI/2);this.polyline.startPoint.point.sub(n).dot(o)<0&&(o=o.mul(-1)),e==t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!=t);return e}static TestPolygonDist(e,t){let n=Number.MAX_SAFE_INTEGER;for(let i=0;i<e.count;i++)for(let o=0;o<t.count;o++){let a=R.minDistBetweenLineSegments(e.pnt(i),e.pnt(i+1),t.pnt(o),t.pnt(o+1));n=Math.min(n,a.dist)}return n}static Distance(e,t){let i=new Ms(e,t).FindClosestPoints();return{p:i.pClosest,q:i.qClosest,dist:i.pClosest.sub(i.qClosest).length}}static DistanceOnly(e,t){return Dt.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let n=t.startPoint;n.next!=null&&n.next.next!=null;n=n.next)if(p.getTriangleOrientation(n.point,n.next.point,n.next.next.point)==2)return!1;return!0}static DistancePoint(e,t){let n=Number.MAX_VALUE;for(let i=0;i<e.count;i++){let o=p.distToLineSegment(t,e.points[i].point,e.points[(i+1)%e.count].point).dist;n=Math.min(n,o)}return n}GetTangentPoints(e,t){let n=new lm(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=n.FindMaximum(),e.rightTangentPoint=n.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return n=>{let i=p.anglePCP(t,e,this.pnt(n));return i<Math.PI?i:i-2*Math.PI}}};var Se=class{ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(R.mkPP(e,t))}static PadCorner(e,t,n,i,o){let a=Se.GetPaddedCorner(t,n,i,o);return a.numberOfPoints==-1?!1:(e.addPoint(a.a),a.numberOfPoints==2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return p.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t){return Se.CreatePaddedPolyline(v.polylineAroundClosedCurve(e),t)}static LoosePolylineWithFewCorners(e,t){return t<E.distanceEpsilon?e:Se.CreateLoosePolylineOnBisectors(e,t)}static CreateLoosePolylineOnBisectors(e,t){return $.mkClosedFromPoints(Tr.CalculateConvexHull(Se.BisectorPoints(e,t)))}static CreateRectNodeOfPolyline(e){return Ke(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=Se.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(Se.LoosePolylineWithFewCorners(e,t))}this.RootOfLooseHierarchy=Se.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=Se.CreateTightObstacles_(this.Obstacles,this.TightPadding,this.TightObstacles),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size==0}constructor(e,t,n,i){this.Obstacles=e,this.TightPadding=t,this.LoosePadding=n,this.IgnoreTightPadding=i}ObstaclesIntersectICurve(e){let t=e.boundingBox;return Se.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,n){if(!n.irect.intersects(t))return!1;if(n.UserData!=null){let i=n.UserData;return v.intersectionOne(i,e,!1)!=null||Se.PointIsInside(i.start,e)}return Se.CurveIntersectsRectangleNode(e,t,n.Left)||Se.CurveIntersectsRectangleNode(e,t,n.Right)}static PointIsInside(e,t){return v.PointRelativeToCurveLocation(e,t)==2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(i=>v.polylineAroundClosedCurve(i)),t=Se.CalculateHierarchy(e),n=Se.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,n.size==0){for(let i of e){let o=Se.FindMaxPaddingForTightPolyline(t,i,this.TightPadding);this.TightObstacles.add(Se.LoosePolylineWithFewCorners(i,o))}this.RootOfTightHierarchy=Se.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let i of e)this.TightObstacles.add(Se.CreatePaddedPolyline(i,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=Se.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;Se.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=Se.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(n)),this.OverlapsDetected=!0}}static CreateTightObstacles_(e,t,n){if(e.length==0)return null;for(let i of e)Se.CalculateTightPolyline(n,t,i);return Se.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(n)}static CalculateTightPolyline(e,t,n){let i=Se.PaddedPolylineBoundaryOfNode(n,t);e.add(i)}static CalculateHierarchy(e){let t=e.map(n=>Se.CreateRectNodeOfPolyline(n));return _e(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=Se.CalculateHierarchy(Array.from(e)),n;for(;(n=Se.GetOverlappedPairSet(t)).size>0;)t=Se.ReplaceTightObstaclesWithConvexHulls(e,Array.from(n));return t}static MapToInt(e){let t=new Map;for(let n=0;n<e.length;n++)t.set(e[n],n);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let n=new Set;for(let u of t)n.add(u[0]),n.add(u[1]);let i=Array.from(n),o=Se.MapToInt(i),a=zh(Array.from(t).map(u=>new ae(o.get(u[0]),o.get(u[1])))),l=Di(a);for(let u of l){let c=u.map(f=>i[f]),h=ii(c,f=>Array.from(f)),d=Tr.createConvexHullAsClosedPolyline(h);for(let f of c)e.delete(f);e.add(d)}return Se.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return v.PointRelativeToCurveLocation(e.start,t)!=0||v.PointRelativeToCurveLocation(t.start,e)!=0}static PolylinesIntersect(e,t){return v.CurvesIntersect(e,t)||Se.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return xt(e,e,(n,i)=>{Se.PolylinesIntersect(n,i)&&t.add([n,i])}),t}static BisectorPoints(e,t){let n=new Array;for(let i=e.startPoint;i!=null;i=i.next){let o={skip:!1},a=Se.GetStickingVertexOnBisector(i,t,o);o.skip||n.push(a)}return n}static GetStickingVertexOnBisector(e,t,n){let i=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(i).normalize().add(o.sub(a).normalize()),u=l.length;return u<E.tolerance?n.skip=!0:(n.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,n){let i=n,o=new Dt(t),a=t.boundingBox.clone();a.pad(2*n);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!=t)){let u=Dt.Distance(o,new Dt(l)).dist;i=Math.min(i,u/Se.LooseDistCoefficient)}return i}static GetPaddedCorner(e,t,n,i){let o=e.point,a=t.point,l=n.point;if(p.getTriangleOrientation(o,a,l)==1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(Se.CornerIsNotTooSharp(o,a,l)){u=u.mul(i);let S=l.sub(a).normalize().mul(i).rotate(Math.PI/2),C=p.lineLineIntersection(o.add(u),a.add(u),a.add(S),l.add(S));return{a:C,b:C,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<E.intersectionEpsilon){let S=a.add(u.mul(i));return{a:S,b:S,numberOfPoints:1}}let h=c.normalize().mul(i),d=h.rotate(Math.PI/2),f=(i-h.dot(u))/d.dot(u),y=d.mul(f);return{a:h.add(y).add(a),b:h.sub(y).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,n){let i=e.sub(t).rotate(Math.PI/4).add(t);return p.getTriangleOrientation(t,i,n)==1}static CreatePaddedPolyline(e,t){let n=new $;if(!Se.PadCorner(n,e.endPoint.prev,e.endPoint,e.startPoint,t))return Se.CreatePaddedPolyline($.mkClosedFromPoints(Array.from(Tr.CalculateConvexHull(e))),t);if(!Se.PadCorner(n,e.endPoint,e.startPoint,e.startPoint.next,t))return Se.CreatePaddedPolyline($.mkClosedFromPoints(Array.from(Tr.CalculateConvexHull(e))),t);for(let i=e.startPoint;i.next.next!=null;i=i.next)if(!Se.PadCorner(n,i,i.next,i.next.next,t))return Se.CreatePaddedPolyline($.mkClosedFromPoints(Array.from(Tr.CalculateConvexHull(e))),t);return n.closed=!0,n}},Gt=Se;Gt.LooseDistCoefficient=2.1;var Ru=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,n){let i=new Ru;return i.TightPolyline=e,i.LooseShape=t,i.Distance=n,i}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Bu=class{constructor(e,t,n,i){this.MainShape=e,this.TightPadding=t,this.LoosePadding=n,this.ShapesToTightLooseCouples=i}Calculate(){this.MainShape.Children.length!=0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=_e(this.MainShape.Children.map(t=>Ke(t,t.BoundingBox)));cr(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Bu.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return v.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)==2}CreateTigthLooseCouples(){let e=new Array;for(let t of this.tightHierarchy.GetAllLeaves()){let n=Gt.FindMaxPaddingForTightPolyline(this.tightHierarchy,t,this.LoosePadding),i=Gt.LoosePolylineWithFewCorners(t,n);e.push(Ru.mk(t,new oi(i),n))}this.coupleHierarchy=_e(e.map(t=>Ke(t,t.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=Gt.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=Gt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),n=ii(this.LoosePolylinesUnderShape(e),o=>Array.from(o)).filter(o=>v.PointRelativeToCurveLocation(o,t)==0);if(n.length<=0)return t;let i=Array.from(t).concat(n);return $.mkClosedFromPoints(Tr.CalculateConvexHull(i))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var SS=ne(Tt());var um=class{constructor(e,t,n){this.indexToA=e,this.priority=t,this.v=n}};var Zt=class{constructor(e=ye){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let n=++this.heapSize,i=new um(n,t,e);for(this.cache.set(e,i),this.A[n]=i;n>1&&this.compare(this.A[n>>1].priority,t)>0;)this.SwapWithParent(n),n>>=1}IsEmpty(){return this.heapSize==0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize==0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let n=t,i=t<<1;i<=this.heapSize&&this.compare(this.A[i].priority,this.A[t].priority)<0&&(n=i);let o=i+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[n].priority)<0&&(n=o),n!=t)this.SwapWithParent(n);else break;t=n}this.heapSize--}DecreasePriority(e,t){let n=this.cache.get(e);if(!n)return;n.priority=t;let i=n.indexToA;for(;i>1&&this.compare(this.A[i].priority,this.A[i>>1].priority)<0;){this.SwapWithParent(i);i>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count==0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new SS.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var Mo=class{constructor(e,t,n){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=n,this._visGraph.ClearPrevEdgesTable();for(let i of n.Vertices())i.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new Zt(ye);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source==this.source||this.targets.has(e.Target)||!Mo.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target==this.source||!Mo.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof Ut}ProcessNeighbor(e,t,n){let i=t.Length,o=this.current.Distance+i;o>=this.upperBound||(this.targets.has(n)&&(this.upperBound=o,this.closestTarget=n),n!=this.source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.Enqueue(n,o)):o<n.Distance&&(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.DecreasePriority(n,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!=this.source);return e.push(this.source),e.reverse()}};var Za=class{constructor(e,t,n){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=n,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new Zt(ye);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let n={priority:0},i=t.DequeueAndGetPriority(n);if(n.priority>=this._target.Distance)break;for(let o of i.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,i,o,a)}for(let o of i.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,i,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source==this._source||e.Target==this._target||!Za.IsForbidden(e)}PassableInEdge(e){return e.Source==this._target||e.Target==this._source||!Za.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof Ut}ProcessNeighborN(e,t,n,i,o){let a=n.Length+o,l=t.Distance+a;i!=this._source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=l,this._visGraph.SetPreviousEdge(i,n),i!=this._target&&e.Enqueue(i,this.H(i))):i!=this._source&&l<i.Distance&&(i.Distance=l,this._visGraph.SetPreviousEdge(i,n),i!=this._target&&e.DecreasePriority(i,this.H(i)))}ProcessNeighbor(e,t,n,i){let o=n.Length,a=t.Distance+o;i!=this._source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=a,this._visGraph.SetPreviousEdge(i,n),i!=this._target&&e.Enqueue(i,this.H(i))):i!=this._source&&a<i.Distance&&(i.Distance=a,this._visGraph.SetPreviousEdge(i,n),i!=this._target&&e.DecreasePriority(i,this.H(i)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,n=this._target;do t.push(n),e&&this._visGraph.ShrinkLengthOfPrevEdge(n,this.LengthMultiplier),n=this._visGraph.PreviosVertex(n);while(n!=this._source);return t.push(this._source),t.reverse()}};var ES=ne(Tt()),sd=class{toString(){return ES.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var xS=ne(Tt()),ad=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return xS.String.Format("{0},{1}",this.Start,this.End)}};var ld=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(p.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,n){return p.closeDistEps(e,p.ClosestPointAtLineSegment(e,t,n))}static IntersectDiagonalWithRay(e,t,n){let i=t.sub(e),o=n.Start,a=n.End,l=Tn.solve(a.x-o.x,i.x*-1,e.x-o.x,a.y-o.y,i.y*-1,e.y-o.y);return e.add(i.mul(l.y))}};var Wi=class{constructor(e){this.pivot=e}IComparer(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let n=e.Start.point.sub(this.pivot),i=t.Start.point.sub(this.pivot);return Wi.CompareVectorsByAngleToXAxis(n,i)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Wi.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Wi.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let n=e.x*t.y-e.y*t.x;if(n>E.tolerance)return-1;if(n<-E.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let i=Math.abs(e.x)-Math.abs(t.x);return i<0?-1:i>0?1:(i=Math.abs(e.y)-Math.abs(t.y),i<0?-1:i>0?1:0)}};var ui=class extends me{constructor(e,t,n){super(null);this.activeDiagonalComparer=new ld;this.polygons=e,this.visibilityGraph=n,this.addedPolygons=t}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let e of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(e);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(e){this.currentPolygon=e,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new ot(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let e=1;e<this.tangents.length;e++){let t=this.tangents[e];t.Diagonal!=null?(t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsHigh&&this.RemoveDiagonalFromActiveNodes(t.Diagonal)):t.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=t.End.point,this.InsertActiveDiagonal(new sd(t,t.Comp)),t.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t))}}AddVisibleEdge(e){Me.AddEdgeVV(CS(this.visibilityGraph,e.start),CS(this.visibilityGraph,e.End))}InitActiveDiagonals(){if(this.tangents.length==0)return;let e=this.tangents[0],t=e.start.point,n=e.End.point;for(let i of this.diagonals)if(ui.RayIntersectDiagonal(t,n,i)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=ld.IntersectDiagonalWithRay(t,n,i),this.InsertActiveDiagonal(i)),e.Diagonal.RbNode==this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(e),e.IsLow==!1){let o=e.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(e){let t=this.activeDiagonalTree.deleteSubTree(e.RbNode);t!=null&&t.item!=null&&(t.item.RbNode=t),e.LeftTangent.Diagonal=null,e.RightTangent.Diagonal=null}InsertActiveDiagonal(e){e.RbNode=this.activeDiagonalTree.insert(e),ui.MarkDiagonalAsActiveInTangents(e)}static MarkDiagonalAsActiveInTangents(e){e.LeftTangent.Diagonal=e,e.RightTangent.Diagonal=e}static RayIntersectDiagonal(e,t,n){let i=n.Start,o=n.End;return p.getTriangleOrientation(e,i,o)==1&&p.getTriangleOrientation(e,t,i)!=1&&p.getTriangleOrientation(e,t,o)!=0}static TangentComparison(e,t){return Wi.CompareVectorsByAngleToXAxis(e.End.point.sub(e.start.point),t.End.point.sub(t.start.point))}*AllObstacles(){for(let e of this.addedPolygons)yield e;for(let e of this.polygons)yield e}OrganizeTangents(){for(let e of this.AllObstacles())e!=this.currentPolygon&&this.ProcessPolygonQ(e);this.tangents.sort(ui.TangentComparison)}ProcessPolygonQ(e){let t=new Ms(this.currentPolygon,e);this.useLeftPTangents?t.CalculateLeftTangents():t.CalculateRightTangents();let n=this.useLeftPTangents?t.leftPLeftQ:t.rightPLeftQ,i=new ad(this.currentPolygon.pp(n[0]),e.pp(n[1]));i.IsLow=!0,i.SeparatingPolygons=!this.useLeftPTangents,n=this.useLeftPTangents?t.leftPRightQ:t.rightPRightQ;let o=new ad(this.currentPolygon.pp(n[0]),e.pp(n[1]));o.IsLow=!1,o.SeparatingPolygons=this.useLeftPTangents,i.Comp=o,o.Comp=i,this.tangents.push(i),this.tangents.push(o),this.diagonals.push(new sd(i,o))}};function CS(s,e){return s.FindVertex(e.point)}var Mu=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(p.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),n=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*n.y-n.x*t.y)<E.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,n){let i=Tn.solve(t.x-e.x,-n.x,this.Pivot.x-e.x,t.y-e.y,-n.y,this.Pivot.y-e.y);if(!(-E.tolerance<=i.x&&i.x<=1+E.tolerance))throw new Error;if(!i)throw new Error;return this.Pivot.add(n.mul(i.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let n=new Mu;return n.pivot=e,n.pointOnTheRay=t,n}};var AS=ne(Tt()),Ns=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!=this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!=this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return AS.String.Format("Stem({0},{1})",this.Start,this.End)}};var Mn=class{constructor(e,t,n,i){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=n,this.qPolylinePoint=yt.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=i;let o=new Wi(this.q);this.heapForSorting=new ws(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,n,i){let o=t.FindVertex(n);if(o!=null)return o;let a=new Mn(e,t,n,i);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!=0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let n=!1;for(let i of t.Sides()){let o=i;if(o.point.y<this.q.y){if(i.nextOnPolyline.point.y>=this.q.y){let a=p.getTriangleOrientation(this.q,o.point,i.nextOnPolyline.point);if(a==1||a==2){n=!0,yield new Ns(t.Start,i),yield new Ns(i.nextOnPolyline,t.End),this.RegisterActiveSide(i);break}}}else{if(o.point.y>this.q.y)break;if(i.point.x>=this.q.x){n=!0,yield new Ns(i,t.End),i!=t.Start&&(yield new Ns(t.Start,e.prev(o))),this.RegisterActiveSide(i);break}}}n||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new p(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=Mn.GetIncomingSide(e),n=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let i;if(i=this.sideNodes.get(t)){if(i==this.activeSidesTree.treeMinimum()&&this.AddEdge(e),n!=null)i.item=n,this.sideNodes.set(n,i);else{let o=this.activeSidesTree.deleteSubTree(i);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(n!=null){let o;(o=this.sideNodes.get(n))||(o=this.activeSidesTree.insert(n),this.sideNodes.set(n,o),o==this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind==0||this.visibilityKind==1&&Mn.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,n)=>new Ut(t,n))}static LineTouchesPolygon(e,t){let n=t.polyline.prev(t).point,i=t.polyline.next(t).point,o=t.point;return p.signedDoubledTriangleArea(e,o,n)*p.signedDoubledTriangleArea(e,o,i)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e==t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Mu,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new ot(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,n=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))n=!1;let i=e.next(t);if(n)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,i);i=e.next(i));this.visibleBoundaries.set(e,new Ns(t,i))}HoleSideIsVisibleFromQ(e,t){return p.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-E.squareOfDistanceEpsilon}};var ud=class{constructor(e,t){this.next=null;this.prev=null;this.PolylinePoint=e,this.OriginalPosition=t}get PolylinePoint(){return this.polylinePoint}set PolylinePoint(e){this.polylinePoint=e}get OriginalPosition(){return this.originalPosition}set OriginalPosition(e){this.originalPosition=e}get Next(){return this.next}set Next(e){this.next=e}get Prev(){return this.prev}set Prev(e){this.prev=e}};var Te=class extends me{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=k.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}get Obstacles(){return this.obstacles_}set Obstacles(e){this.obstacles_=e}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(e){this.enteringAngleBound_=e}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(e){this._sourceTightPolyline=e}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(e){this.targetTightPolyline=e}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(e){this.targetLoosePolyline=e}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(e){this.visibilityGraph=e}get SourcePort(){return this.sourcePort}set SourcePort(e){if(this.sourcePort=e,this.sourcePort!=null)if(this.SourceTightPolyline=Te.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Jr)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let t=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(t.Curve,t.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(e){this.targetPort=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=e)}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(e){this.startPointOfRouting_=e}ExtendVisibilityGraphToLocation(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Me);let t=null;if(!this.activeRectangle.contains(e)){this.activeRectangle.isEmpty?this.activeRectangle=k.mkPP(this.SourcePort.Location,e):this.activeRectangle.add(e),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null||t.length==0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new ui(t,this.activePolygons,this.VisibilityGraph).run(),ni(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(e){this.targetVV=Mn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,e,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=Mn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(e,t,n){let i=e.value(t),o=e.leftDerivative(t).normalize().add(e.rightDerivative(t).normalize()).normalize();p.getTriangleOrientation(Te.PointInsideOfConvexCurve(e),i,i.add(o))==1&&(o=o.mul(-1)),o=o.rotate(Math.PI/2);let a=n.boundingBox.diagonal,l=R.mkPP(i,i.add(o.mul(a))),u=v.intersectionOne(l,n,!1).x,c=o.mul(u.sub(i).length/2);for(;;){l=R.mkPP(i,u.add(c));let h=!1;for(let d of Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(l,this.ObstacleCalculator.RootOfLooseHierarchy))if(d.seg1!=n){c=c.div(1.5),h=!0;break}if(!h)break}return l.end}static PointInsideOfConvexCurve(e){return e.value(0).add(e.value(1.5)).div(2)}*GetActivePolylines(){for(let e of this.activePolygons)yield e.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let e=this.activeRectangle,t=new Array,n;do{n=!1;for(let i of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(i)||(e.addRec(i.boundingBox),t.push(new Dt(i)),this.alreadyAddedOrExcludedPolylines.add(i),n=!0);n&&(this.activeRectangle=e)}while(n);return t}RelaxPolyline(){let e=Te.CreateRelaxedPolylinePoints(this._polyline);for(e=e.Next;e.Next!=null;e=e.Next)this.RelaxPolylinePoint(e)}static CreateRelaxedPolylinePoints(e){let t=e.startPoint,n=new ud(t,t.point),i=n;for(;t.next!=null;){t=t.next;let o=new ud(t,t.point);o.Prev=i,i.Next=o,i=o}return n}RelaxPolylinePoint(e){if(!(e.PolylinePoint.prev.prev==null&&this.SourcePort instanceof Qt&&e.PolylinePoint.polyline!=this.SourceLoosePolyline)&&!(e.PolylinePoint.next.next==null&&this.TargetPort instanceof Qt&&e.PolylinePoint.polyline!=this.TargetLoosePolyline))for(let t=this.OffsetForPolylineRelaxing;t>E.distanceEpsilon&&!this.RelaxWithGivenOffset(t,e);)t/=2}RelaxWithGivenOffset(e,t){return Te.SetRelaxedPointLocation(e,t),this.StickingSegmentDoesNotIntersectTightObstacles(t)?!0:(Te.PullCloserRelaxedPoint(t.Prev),!1)}static PullCloserRelaxedPoint(e){e.PolylinePoint.point=e.OriginalPosition.mul(.2).add(e.PolylinePoint.point.mul(.8))}StickingSegmentDoesNotIntersectTightObstacles(e){return!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Prev.PolylinePoint.point)&&(e.Next==null||!this.PolylineSegmentIntersectsTightHierarchy(e.PolylinePoint.point,e.Next.PolylinePoint.point))}PolylineSegmentIntersectsTightHierarchy(e,t){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,n){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(R.mkPP(e,t),n)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t){if(!e.boundingBox.intersects(t.irect))return!1;if(t.UserData!=null){for(let n of v.getAllIntersections(e,t.UserData,!1))if(n.seg1!=this.SourceTightPolyline&&n.seg1!=this.TargetTightPolyline||(n.seg1==this.SourceTightPolyline&&this.SourcePort)instanceof Qt||(n.seg1==this.TargetTightPolyline&&this.TargetPort)instanceof Qt)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,t){let n=new Array;return Te.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,n),n}static IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,n){if(t!=null&&!!e.boundingBox.intersects(t.irect)){if(t.UserData!=null){ni(n,v.getAllIntersections(e,t.UserData,!0));return}Te.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Left,n),Te.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Right,n)}}LineCanBeAcceptedForRouting(e){let t=this.SourcePort instanceof Jr,n=this.TargetPort instanceof Jr;if(!t&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.end,this.SourcePort)||!n&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.start,this.TargetPort))return!1;let i=Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy);for(let o of i)if(o.seg1!=this.SourceTightPolyline&&o.seg1!=this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(e,t){let n=t.Curve,i=Gt.CurveIsClockwise(n,Te.PointInsideOfConvexCurve(n)),o=t.Location,a=this.GetPointOnTheRightBoundaryPortConeSide(o,n,i,t.Parameter),l=this.GetPointOnTheLeftBoundaryPortConeSide(o,n,i,t.Parameter);return p.getTriangleOrientation(o,a,e)!=0&&p.getTriangleOrientation(o,e,l)!=0}GetPointOnTheRightBoundaryPortConeSide(e,t,n,i){let o=n?t.rightDerivative(i):t.leftDerivative(i).neg();return e.add(o.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(e,t,n,i){let o=n?t.leftDerivative(i).neg():t.rightDerivative(i);return e.add(o.rotate(-this.EnteringAngleBound))}static SetRelaxedPointLocation(e,t){let n=p.getTriangleOrientation(t.Next.OriginalPosition,t.OriginalPosition,t.Prev.OriginalPosition)==1,i=t.Next.OriginalPosition.sub(t.Prev.OriginalPosition).normalize().mul(e).rotate(Math.PI/2);n||(i=i.neg()),t.PolylinePoint.point=t.OriginalPosition.add(i)}SmoothCorners(e){let t=e.headSite,n={b:null,c:null};for(;n=v.findCorner(t);)t=this.SmoothOneCorner(t,n.c,n.b)}SmoothOneCorner(e,t,n){let a=.5,l,u,c;e.prev==null?(c=2,u=1):t.next==null?(c=1,u=2):u=1,c=1;do l=v.createBezierSeg(a*c,a*u,e,n,t),n.previouisBezierCoefficient=a*c,n.nextBezierCoefficient=a*u,a/=1.5;while(this.ObstacleCalculator.ObstaclesIntersectICurve(l)&&a>.01);return a*=1.5,a<.5&&a>.01&&(a=.5*(a+a*1.5),l=v.createBezierSeg(a*c,a*u,e,n,t),this.ObstacleCalculator.ObstaclesIntersectICurve(l)||(n.previouisBezierCoefficient=a*c,n.nextBezierCoefficient=a*u)),n}TryToRemoveInflectionsAndCollinearSegments(e){let t=!0,n={s:null};for(;t;)for(t=!1,n.s=e.headSite;n.s!=null&&n.s.next!=null;n.s=n.s.next)n.s.turn*n.s.next.turn<0&&(t=this.TryToRemoveInflectionEdge(n)||t)}TryToRemoveInflectionEdge(e){if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.point)){let t=e.s.prev,n=e.s.next;return t.next=n,n.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.next.point)){let t=e.s.prev,n=e.s.next.next;return t.next=n,n.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.point,e.s.next.next.point)){let t=e.s.next.next;return e.s.next=t,t.prev=e.s,!0}return!1}GetShortestPolyline(e,t){this.CleanTheGraphForShortestPath();let i=new Za(this.visibilityGraph,e,t).GetPath(this.UseEdgeLengthMultiplier);if(i==null)return null;let o=new $;for(let a of i)o.addPoint(a.point);return Te.RemoveCollinearVertices(o)}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}static RemoveCollinearVertices(e){for(let t=e.startPoint.next;t.next!=null;t=t.next)p.getTriangleOrientation(t.prev.point,t.point,t.next.point)==2&&(t.prev.next=t.next,t.next.prev=t.prev);return e}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(e){this.ObstacleCalculator.RootOfTightHierarchy=e}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(e){this.ObstacleCalculator.RootOfLooseHierarchy=e}CalculateObstacles(){this.ObstacleCalculator=new Gt(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}RouteEdgeToLocation(e){this.TargetPort=new Jr(null,e),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let t=new Ge(null),n=R.mkPP(this.SourcePort.Location,e);return this.LineCanBeAcceptedForRouting(n)?(this._polyline=new $,this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),t.smoothedPolyline=it.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):this.SourcePort instanceof Qt&&(n=R.mkPP(this.StartPointOfEdgeRouting,e),Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(n,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new $,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),t.smoothedPolyline=it.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):(this.ExtendVisibilityGraphToLocation(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this.SourcePort instanceof Qt&&this._polyline.PrependPoint(this.SourcePort.Location),t.smoothedPolyline=it.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t)}RouteEdgeToPort(e,t,n,i){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),R.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=e,this.TargetTightPolyline=Te.GetFirstHitPolyline(e.Location,this.ObstacleCalculator.RootOfTightHierarchy),e instanceof Qt?this.RouteEdgeToBoundaryPort(t,n,i):this.RouteEdgeToFloatingPortOfNode(t,n,i))}SmoothedPolylineFromTwoPoints(e,t){return this._polyline=new $,this._polyline.addPoint(e),this._polyline.addPoint(t),it.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(e,t,n){return this.sourcePort instanceof Jr?this.RouteFromFloatingPortToFloatingPort(e,t,n):this.RouteFromBoundaryPortToFloatingPort(e,t,n)}RouteFromBoundaryPortToFloatingPort(e,t,n){let i=this.SourcePort.Location,o=this.targetPort.Location,a=R.mkPP(i,o);if(this.LineCanBeAcceptedForRouting(a))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a;if(!this.targetIsInsideOfSourceTightPolyline){let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(a=R.mkPP(u,o),this.LineAvoidsTightHierarchyLP(a,e))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let l=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=l,this.RelaxPolyline(),this._polyline.PrependPoint(i),this.SmoothCornersAndReturnCurve(t,n)}SmoothCornersAndReturnCurve(e,t){return t.smoothedPolyline=it.mkFromPoints(this._polyline),e&&this.SmoothCorners(t.smoothedPolyline),t.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(e,t,n){let i=this.TargetPort.Location,o=R.mkPP(this.StartPointOfEdgeRouting,i);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(o,this.SourceTightPolyline,this.targetTightPolyline)?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),n.smoothedPolyline=it.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(t,n)))}TryShortcutPolyline(){if(this.UseInnerPolylingShortcutting)for(;this.ShortcutPolylineOneTime(););this.UsePolylineEndShortcutting&&this.TryShortCutThePolylineEnds()}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let e=this._polyline.endPoint,t=e.prev;if(t==null)return;let n=t.prev;if(n==null)return;let i=p.middle(t.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,i,this._sourceTightPolyline,this.targetTightPolyline)){let o=yt.mkFromPoint(i);o.next=e,o.prev=n,e.prev=o,n.next=o}}TryShortcutPolylineStart(){let e=this._polyline.startPoint,t=e.next;if(t==null)return;let n=t.next;if(n==null)return;let i=p.middle(t.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,i,this._sourceTightPolyline,this.targetTightPolyline)){let o=yt.mkFromPoint(i);o.prev=e,o.next=n,e.next=o,n.prev=o}}ShortcutPolylineOneTime(){let e=!1;for(let t=this._polyline.startPoint;t.next!=null&&t.next.next!=null;t=t.next)e=e||this.TryShortcutPolyPoint(t);return e}TryShortcutPolyPoint(e){return this.LineAvoidsTightHierarchyLPP(R.mkPP(e.point,e.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(e.next=e.next.next,e.next.prev=e,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Me);let t=null,n=this.targetPort.Location;if(!this.activeRectangle.contains(n)){this.activeRectangle.isEmpty?this.activeRectangle=k.mkPP(this.SourcePort.Location,n):this.activeRectangle.add(n),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,e),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new ui(t,this.activePolygons,this.VisibilityGraph).run(),ni(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,e),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(e,t){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(e,t):this.targetVV=Mn.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(t),this.VisibilityGraph,e,1)}AddTransientVisibilityEdgesForPort(e,t){let n=this.GetVertex(e);if(n!=null)return n;if(n=this.visibilityGraph.AddVertexP(e),t!=null)for(let i of t)this.visibilityGraph.AddEdgeF(e,i,(o,a)=>new Ut(o,a));else n=Mn.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,e,1);return n}GetVertex(e){let t=this.visibilityGraph.FindVertex(e);return t==null&&this.LookForRoundedVertices&&(t=this.visibilityGraph.FindVertex(E.RoundPoint(e))),t}*GetActivePolylinesWithException(e){for(let t of this.activePolygons)t.Polyline!=e&&(yield t.Polyline)}RouteEdgeToBoundaryPort(e,t,n){return this.TargetLoosePolyline=e,this.sourcePort instanceof Jr?this.RouteFromFloatingPortToBoundaryPort(t,n):this.RouteFromBoundaryPortToBoundaryPort(t,n)}RouteFromBoundaryPortToBoundaryPort(e,t){let n=this.SourcePort.Location,i,o=this.targetPort.Location,a=R.mkPP(n,o);if(this.LineCanBeAcceptedForRouting(a))this._polyline=new $,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),i=it.mkFromPoints(this._polyline).createCurve();else{let l=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(a=R.mkPP(n,l),this.InsideOfTheAllowedConeOfBoundaryPort(l,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(a,this._sourceTightPolyline))this._polyline=new $,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(a=R.mkPP(this.StartPointOfEdgeRouting,o),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(a))this._polyline=new $,this._polyline.addPoint(n),this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),i=this.SmoothCornersAndReturnCurve(e,t);else{let u;if(u=R.IntersectPPPP(n,this.StartPointOfEdgeRouting,o,l))this._polyline=new $,this._polyline.addPoint(n),this._polyline.addPoint(u),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(p.closeDistEps(this.StartPointOfEdgeRouting,l))this._polyline=new $,this._polyline.addPoint(n),this._polyline.addPoint(l),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(this.LineAvoidsTightHierarchy(R.mkPP(this.StartPointOfEdgeRouting,l)))this._polyline=new $,this._polyline.addPoint(n),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(l),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else{this.ExtendVisibilityGraphToTargetBoundaryPort(l),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let c={tmpTargetTight:null},h=this.HideSourceTargetTightsIfNeeded(c);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(h,c.tmpTargetTight),this.RelaxPolyline(),this._polyline.PrependPoint(n),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t)}}}return i}RecoverSourceTargetTights(e,t){this.SourceTightPolyline=e,this.TargetTightPolyline=t}HideSourceTargetTightsIfNeeded(e){let t=this.SourceTightPolyline;return e.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,t}LineAvoidsTightHierarchy(e){return Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy).length==0}RouteFromFloatingPortToBoundaryPort(e,t){let n=this.targetPort.Location,i;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(i=R.mkPP(this.SourcePort.Location,n),this.LineCanBeAcceptedForRouting(i)))return t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(i.start,i.end),i;let o=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(i=R.mkPP(this.SourcePort.Location,o),this.LineAvoidsTightHierarchyLP(i,this._sourceTightPolyline))return this._polyline=$.mkFromPoints([i.start,i.end,n]),t.smoothedPolyline=it.mkFromPoints(this._polyline),t.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(o),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.RelaxPolyline(),this._polyline.addPoint(n);let a={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(e,a)}LineAvoidsTightHierarchyLP(e,t){let n=!0;for(let i of Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(i.seg1!=t){n=!1;break}return n}LineAvoidsTightHierarchyLPP(e,t,n){let i=!0;for(let o of Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(!(o.seg1==t||o.seg1==n)){i=!1;break}return i}LineAvoidsTightHierarchyPPPP(e,t,n,i){return this.LineAvoidsTightHierarchyLPP(R.mkPP(e,t),n,i)}ExtendVisibilityGraphToTargetBoundaryPort(e){let t=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new Me),!this.activeRectangle.contains(e)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(e)):(this.activeRectangle.add(e),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new ui(t,this.activePolygons,this.VisibilityGraph).run(),ni(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(e){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:Te.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(e,t){let n=Te.GetFirstHitRectangleNode(e,t);return n?n.UserData:null}static GetFirstHitRectangleNode(e,t){return t==null?null:t.FirstHitNodePF(e,(n,i)=>v.PointRelativeToCurveLocation(n,i)!=0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(e,t){this.SourceLoosePolyline=t,this.sourcePort=e,this.sourcePort!=null&&(this.SourceTightPolyline=Te.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof Jr?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new Me,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let t of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(t);let e;this.UseSpanner?e=new Bo(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):e=new ui(new Array,this.activePolygons,this.visibilityGraph),e.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e,t,n,i){let o=e instanceof Jr&&t instanceof Qt||e instanceof mt;if(o){let l=e;e=t,t=l}this.sourcePort=e,this.targetPort=t,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let a=this.GetEdgeGeomByRouting(n,i);return a==null?null:(this.targetVV=null,this.sourceVV=null,o&&(a=a.reverse()),a)}GetEdgeGeomByRouting(e,t){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||v.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)==2;let n;if(this.sourcePort instanceof Qt){let i=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?i.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(i.Curve,i.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let o={smoothedPolyline:null};this.targetPort instanceof Qt?n=this.RouteFromBoundaryPortToBoundaryPort(e,o):n=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,e,o)}else this.targetPort instanceof Jr?(this.ExtendVisibilityGraphFromFloatingSourcePort(),n=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,e,t)):(vt.assert(this.targetPort instanceof mt),n=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,e,t,this.targetPort));return n}RouteFromFloatingPortToAnywherePort(e,t,n,i){return i.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(e))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.RelaxPolyline(),this.FixLastPolylinePointForAnywherePort(i),i.HookSize>0&&this.BuildHook(i),this.SmoothCornersAndReturnCurve(t,n))):(n.smoothedPolyline=null,null)}BuildHook(e){let t=e.Curve,n=fe.mkFullEllipseNNP(e.HookSize,e.HookSize,this._polyline.end),i=v.getAllIntersections(t,n,!0);p.getTriangleOrientation(i[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&i.reverse();let o=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),a=t.derivative(i[0].par0).normalize(),l=a.dot(o);if(Math.abs(l)<.2)this.ExtendPolyline(a,i[0],o,e);else{let u=t.derivative(i[1].par0).normalize();u.dot(o)<l?this.ExtendPolyline(u,i[1],o,e):this.ExtendPolyline(a,i[0],o,e)}}ExtendPolyline(e,t,n,i){let o=e.rotate(Math.PI/2);o.dot(n)<0&&(o=o.neg());let a=t.x.add(o.mul(i.HookSize)),l;!(l=p.lineLineIntersection(a,a.add(e),this._polyline.end,this._polyline.end.add(n)))||(this._polyline.addPoint(l),this._polyline.addPoint(a),this._polyline.addPoint(t.x))}FixLastPolylinePointForAnywherePort(e){for(;;){let t=this.GetLastPointInsideOfCurveOnPolyline(e.Curve);t.next.next=null,this._polyline.endPoint=t.next;let n=t.next.point.sub(t.point);n=n.normalize().mul(e.Curve.boundingBox.diagonal);let i=n.rotate(e.AdjustmentAngle*-1),o=n.rotate(e.AdjustmentAngle),a=v.intersectionOne(e.Curve,R.mkPP(t.point,t.point.add(i)),!0),l=v.intersectionOne(e.Curve,R.mkPP(t.point,t.point.add(o)),!0);if(a==null||l==null)return;let u=Te.GetTrimmedCurveForHookingUpAnywhere(e.Curve,t,a,l),c=u.value(u.closestParameter(t.point));if(!this.LineAvoidsTightHierarchyLPP(R.mkPP(t.point,c),this.SourceTightPolyline,null)){let h=v.intersectionOne(e.Curve,R.mkPP(t.point,t.next.point),!1);if(h==null)return;this._polyline.endPoint.point=h.x;break}if(this._polyline.endPoint.point=c,t.prev==null||!this.TryShortcutPolyPoint(t.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(e,t,n,i){let o=p.getTriangleOrientation(i.x,n.x,t.point)==0,a=n.par0,l=i.par0,u,c,h;return o?a<l?e.trim(a,l):(c=e.trim(a,e.parEnd),u=e.trim(e.parStart,l),h=new v,h.addSegs([c,u])):l<a?e.trim(l,a):(c=e.trim(l,e.parEnd),u=e.trim(e.parStart,a),h=new v,h.addSegs([c,u]))}GetLastPointInsideOfCurveOnPolyline(e){for(let t=this._polyline.endPoint.prev;t!=null;t=t.prev)if(t.prev==null||v.PointRelativeToCurveLocation(t.point,e)==2)return t;throw new Error}GetShortestPolylineToMulitpleTargets(e,t){this.CleanTheGraphForShortestPath();let i=new Mo(e,t,this.VisibilityGraph).GetPath();if(i==null)return null;let o=new $;for(let a of i)o.addPoint(a.point);return Te.RemoveCollinearVertices(o)}Targets(e){return Array.from(e).map(t=>this.visibilityGraph.FindVertex(t))}ExtendVisibilityGraphFromFloatingSourcePort(){let e=this.sourcePort;this.StartPointOfEdgeRouting=e.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=Mn.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(t=>t!=this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let e=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=Te.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=Te.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),e=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=Te.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=Te.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=k.mkPP(new p(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new p(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let e of this.ObstacleCalculator.LooseObstacles)yield new Dt(e)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(e){ni(this.activePolygons,e)}ClearActivePolygons(){this.activePolygons=[]}};var zE=ne(po());var ci=class{constructor(){this.size_=0;this.mapOfMaps=new Je}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let n=e.first,i=e.second,o=this.mapOfMaps.get(n);o==null&&this.mapOfMaps.set(n,o=new Je),o.has(i)||this.size_++,o.set(i,t)}delete(e){let t=e.first,n=e.second,i=this.mapOfMaps.get(t);i!=null&&i.deleteP(n)&&this.size_--}has(e){let t=this.mapOfMaps.get(e.first);return t!=null&&t.has(e.second)}get_(e,t){return this.get(new dt(e,t))}get(e){let t=this.mapOfMaps.get(e.first);if(t!=null)return t.get(e.second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new dt(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[n,i]of t)yield[new dt(e,n),i]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var hr=class{static GetShapes(e,t=Array.from(e.edges())){let n=new Map;vS(e,n);for(let i of t){let o=n.get(i.source);o&&i.sourcePort!=null&&o.Ports.add(i.sourcePort),o=n.get(i.target),o&&i.targetPort!=null&&o.Ports.add(i.targetPort)}return Array.from(n.values())}static CreateShapeWithCenterPort(e){let t=new $a(()=>e.boundaryCurve),n=en.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(n);for(let i of e.inEdges())hr.FixPortAtTarget(n,i);for(let i of e.outEdges())hr.FixPortAtSource(n,i);for(let i of e.selfEdges())hr.FixPortAtSource(n,i),hr.FixPortAtTarget(n,i);return t}static CreateShapeWithClusterBoundaryPort(e){vt.assert(e instanceof je);let t=new $a(()=>e.boundaryCurve),n=$t.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(n);let i;for(let o of e.inEdges())o.EdgeToAncestor()==2?(i==null&&(i=new mt(()=>e.boundaryCurve)),o.targetPort=i):hr.FixPortAtTarget(n,o);for(let o of e.outEdges())o.EdgeToAncestor()==1?(i==null&&(i=new mt(()=>e.boundaryCurve)),o.sourcePort=i):hr.FixPortAtSource(n,o);for(let o of e.selfEdges())hr.FixPortAtSource(n,o),hr.FixPortAtTarget(n,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function vS(s,e){for(let t of s.shallowNodes())if(t instanceof je){let n=hr.CreateShapeWithClusterBoundaryPort(t);e.set(t,n);let i=t;if(!i.graph.isCollapsed){vS(i,e);for(let o of i.shallowNodes())n.AddChild(e.get(o))}}else e.set(t,hr.CreateShapeWithCenterPort(t))}var cm=ne(fn()),wS=ne(Tt());var TS=ne(Tt());var No=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,n,i){let o=new No(e);return o.Left=e,o.Right=t,o.Gap=n,o.IsEquality=i,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return TS.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t==0&&(t=this.Right.CompareTo(e.Right)),t==0&&(t=ye(this.Gap,e.Gap)),t}};var IS=ne(Tt()),Ds=class{static constructorDCVV(e,t,n,i){let o=new Ds(t);return o.Set(e,t,n,i),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,n,i){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=n,this.VariableDoneEval=i,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval==this.ConstraintToEval.Right}toString(){return IS.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var LS=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Ka=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return wS.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new cm.Stack;let t=new No(e);this.dfDvDummyParentNode=new Ds(t);let n=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(n);;){let i=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!i.ChildrenHaveBeenPushed){i.ChildrenHaveBeenPushed=!0;for(let a of i.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!=i.VariableDoneEval){let l=this.GetDfDvNode(i,a,a.Right,i.VariableToEval);a.Right.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of i.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!=i.VariableDoneEval){let l=this.GetDfDvNode(i,a,a.Left,i.VariableToEval);a.Left.ActiveConstraintCount==1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(i),i==n)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,n,i){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,n,i):Ds.constructorDCVV(e,t,n,i);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable==e.VariableToEval){for(;e.Parent!=this.dfDvDummyParentNode;)this.constraintPath.push(new LS(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let n=new Array;this.GetConnectedVariables(n,e.Right,e.Left);let i=e.Violation,o=n.length;for(let a=0;a<o;a++)n[a].OffsetInBlock=n[a].OffsetInBlock+i;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let n=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,i=this.Variables.length;for(let o=0;o<i;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<n&&(t=a,n=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Ka(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length==1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,n=e.OffsetInBlock/e.Scale,i=t*e.Weight;this.sumAd=this.sumAd+i*e.DesiredPos,this.sumAb=this.sumAb+i*n,this.sumA2=this.sumA2+i*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let n=0;n<t;n++){let i=this.Variables[n];i.ActualPos=(e+i.OffsetInBlock)/i.Scale}}GetConnectedVariables(e,t,n){this.RecurseGetConnectedVariables(e,t,n)}RecurseGetConnectedVariables(e,t,n){this.allConstraints.DfDvStack=new cm.Stack;let i=new No(t);for(this.dfDvDummyParentNode=new Ds(i),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,i,t,n)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!=o.VariableDoneEval&&(l.Right.ActiveConstraintCount==1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!=o.VariableDoneEval&&(l.Left.ActiveConstraintCount==1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,n){this.GetConnectedVariables(e.Variables,t,n);let i=e.Variables.length;for(let a=0;a<i;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block==e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length==0){for(let a=0;a<i;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var hm=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var dm=ne(fn()),fm=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new dm.Stack;this.DfDvRecycleStack=new dm.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var Nu=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new cd}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new Nu;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},cd=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new cd;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var OS=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},RS=class{constructor(e,t){this.Value=e,this.Column=t}},Ir=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!=0&&(this.newMatrixRow.push(new RS(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new OS(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let n of this.matrixQ[t.Ordinal])n.Column==t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(n.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let n=0;n<t.length;n++)t[n].Column==e?t[n].Value=1:t[n].Value=t[n].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[n].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;Ir.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=Ir.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!=0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=Ir.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t==0)return!1;let n=e/t;Ir.VectorCopy(this.vectorPrevY,this.vectorCurY),Ir.VectorScaledVectorSubtract(this.vectorPrevY,n,this.gradientVector,this.vectorCurY);for(let i=0;i<this.vectorCurY.length;i++)this.vectorQpscVars[i].Variable.DesiredPos=this.vectorCurY[i];return!0}PostProject(){for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;Ir.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=Ir.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!=0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let n=Ir.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=n==0?1:e/n,t>1?t=1:t<0&&(t=0)}return Ir.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let n=this.previousFunctionValue-e,i=0;if(n!=0){let o=this.previousFunctionValue!=0?this.previousFunctionValue:e;i=Math.abs(n/o)}(Math.abs(n)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(i)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return Ir.VectorVectorMultiply(this.gradientVector,e)/2+Ir.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let n=0;for(let i=0;i<e.length;i++)n=n+e[i]*t[i];return n}MatrixVectorMultiply(e,t){let n=0;for(let i of this.matrixQ){let o=0;for(let a of i)o=o+a.Value*e[a.Column];t[n++]=o}}static VectorVectorAdd(e,t,n){for(let i=0;i<e.length;i++)n[i]=e[i]+t[i]}static VectorVectorSubtract(e,t,n){for(let i=0;i<e.length;i++)n[i]=e[i]-t[i]}static VectorScaledVectorSubtract(e,t,n,i){for(let o=0;o<e.length;o++)i[o]=e[o]-t*n[o]}static VectorCopy(e,t){for(let n=0;n<t.length;n++)e[n]=t[n]}};var Ja=class{get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Ja;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var BS=ne(Tt());var MS=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},gm=class{constructor(e,t,n,i,o){this.ActiveConstraintCount=0;if(i<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=n*i;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=n*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=n,this.Weight=i,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new MS(e,t))}toString(){return BS.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return ye(this.Ordinal,e.Ordinal)}};var dd=class{get IsFull(){return this.numConstraints==dd.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(dd.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let n=this.numConstraints-1;n>=0;n--){let i=this.constraints[n];if(i.Left.Block==e||i.Right.Block==e||i.IsActive||i.IsUnsatisfiable)n<this.numConstraints-1&&(this.constraints[n]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints==0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let n=0;n<this.numConstraints;n++){let i=this.constraints[n],o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale);o>e&&(e=o,t=i)}return t}Insert(e,t){let n=0,i=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<i?(o=i,n=a,i=u):u<o&&(o=u)}this.IsFull?(this.constraints[n]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=i))}},hd=dd;hd.MaxConstraints=20;var pm=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},mm=class{constructor(){this.allBlocks=new hm;this.allConstraints=new fm;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new hd;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new Nu;this.solverSolution=new Ja}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,n){return this.AddVariableANNN(e,t,n,1)}AddVariableANNN(e,t,n,i){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new gm(this.nextVariableOrdinal++,e,t,n,i),a=new Ka(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new pm(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return ii(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let n=t.Constraints.length;for(let i=0;i<n;i++){let o=t.Constraints[i];if(e==o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,n){return this.AddConstraintVVNB(e,t,n,!0)}AddConstraintVVNB(e,t,n,i){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e==t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=No.constructorVVNB(e,t,n,i);return this.loadedVariablesAndConstraintLists.set(e,new pm(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,i&&this.equalityConstraints.push(l),l}AddConstraint(e,t,n){return this.AddConstraintVVNB(e,t,n,!1)}SetConstraintUpdate(e,t){t!=e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,n){if(n<=0||Number.isNaN(n)||!Number.isFinite(n))throw new Error("relationshipWeight");if(e==t)throw new Error;e.AddNeighbor(t,n),t.AddNeighbor(e,n),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.log2(this.numberOfVariables)+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.log2(this.numberOfConstraints)+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Ja,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints==0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length==0)return;let e=this.IsQpsc;for(let[t,n]of this.updatedConstraints){let i=t;if(i.UpdateGap(n),!e&&!i.IsEquality){this.SplitOnConstraintIfActive(i);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),n=t.Constraints,i=0,o=0,a=0;n!=null&&(i=n.length,o=t.NumberOfLeftConstraints,a=i-o);let l=this.emptyConstraintList;o!=0&&(l=new Array(o));let u=this.emptyConstraintList;a!=0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<i;d++){let f=n[d];e==f.Left?l[c++]=f:u[h++]=f}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){let e;if(!this.RunProject(e))return;if(!this.SplitBlocks())break}}RunProject(e){return this.solverSolution.OuterProjectIterations++,e=this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let n=this.allBlocks.item(t),i=n.Variables.length;for(let o=0;o<i;o++){let a=n.Variables[o];this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue+a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue=this.solverSolution.GoalFunctionValue-2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new Ir(this.solverParams,this.numberOfVariables);for(let i of this.allBlocks.Vector)for(let o of i.Variables)e.AddVariable(o);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1,n=!1;for(;!(!e.PreProject()&&!t&&!n||(t=this.SplitBlocks(),!this.RunProject(n))||!e.PostProject()&&!t&&!n););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){let e;return this.RunProject(e)}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let n of t.Variables){n.Reinitialize();let i=new Ka(n,this.allConstraints);this.allBlocks.Add(i)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block==e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints==0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,n={maxViolation:0},i=this.GetMaxViolatedConstraint(n,e);if(!i)return!1;for(;i;){if(i.Left.Block==i.Right.Block?(i.Left.Block.Expand(i),i.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=i.Left.Block):this.lastModifiedBlock=this.MergeBlocks(i),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};i=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,n=e.Right.Block,i=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);n.Variables.length>t.Variables.length&&(t=e.Right.Block,n=e.Left.Block,i=i*-1);let o=n.Variables.length;for(let a=0;a<o;a++){let l=n.Variables[a];l.OffsetInBlock=l.OffsetInBlock+i,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(n),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let i=0;i<t;i++){let a=this.allBlocks.item(i).Split(this.IsQpsc);a!=null&&e.push(a)}let n=e.length;for(let i=0;i<n;i++){let o=e[i];this.allBlocks.Add(o)}return e.length!=0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let n=this.SearchViolationCache(e.maxViolation);return n!=null?n:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let n=this.lastModifiedBlock.Variables.length;for(let o=0;o<n;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Gh(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!=this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);Gh(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let i=this.violationCache.FindIfGreater(e);return i!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=i),t}SearchAllConstraints(e,t){let n=null;this.violationCache.Clear();for(let i of this.allConstraints.Vector){if(i.IsActive)break;if(i.IsUnsatisfiable)continue;let o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale),a=null,l=0;Gh(o,e)&&(e>this.violationCache.LowViolation&&(a=n,l=e),e=o,n=i),t&&(a==null&&i!=n&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=i,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return n}};var gd=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,n){this.variables.set(e,this.solver.AddVariableANN(e,t,n))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,n,i){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,n,i)}AddLeftRightSeparationConstraintNNN(e,t,n){this.AddLeftRightSeparationConstraintNNNB(e,t,n,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,n){let i=this.GetVariable(e);if(i==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(i,o,n)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let n;do{this.solution=null;let i=null;if(e!=null&&(i=e,i==null))throw new Error("parameters");this.solution=this.solver.SolvePar(i),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,n=this.AdjustConstraintsForMovedFixedVars()}while(n&&this.solution.ExecutionLimitExceeded==!1);return this.solution.ExecutionLimitExceeded==!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,n]of this.fixedVars.entries())gd.Close(n,this.GetVariableResolvedPosition(t))||e.add(t);return e.size==0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let n of e){t=n;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let n={successInAdjusting:!1},i=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,n);if(!n.successInAdjusting||i.length==0)return!1;for(let o of i)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let n=this.variables.get(e).Block.Variables,i=new lr,o=new lr,a=1;for(let l of n)!this.fixedVars.has(l.UserData)||(i.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,i.length/o.length)));return a==1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(n,a),n.map(l=>l.UserData)}FixActiveConstraints(e,t){let n=!1;for(let i of e)for(let o of i.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(n=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return n}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new mm,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,gd.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},fd=gd;fd.FixedVarWeight=1e9;var bm=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var Pm=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new fd;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let n=this.Var(t);n.LowBound=Math.max(e,n.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let n=this.Var(e);n.UpperBound=Math.min(t,n.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!=Number.NEGATIVE_INFINITY&&this.constraints.add(new ae(this.GetBoundId(t.LowBound),e)),t.UpperBound!=Number.POSITIVE_INFINITY&&this.constraints.add(new ae(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!=Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!=Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=sr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=Qr.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new ae(e,t))}AddVariableNNNN(e,t,n,i){this.idealPositions.set(e,n),this.AddVariableNNBN(e,t,!1,i)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,n,i){let o=new bm;o.Position=t,o.IsFixed=n,o.Width=i,this.varList.push(o)}};var NS=ne(po());var ym=class extends kr{constructor(e,t){super(e,t);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=V.DirectionFromPointToPoint(e.point,t.point)}AddRightNeighbor(e){this.RightNeighbors.add(e)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(e){this.setOfLongestSegs.add(e)}BoundFromRight(e){e=Math.max(e,this.LeftBound),this.RightBound=Math.min(e,this.RightBound)}BoundFromLeft(e){e=Math.min(e,this.RightBound),this.LeftBound=Math.max(e,this.LeftBound)}};var Ur=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,n){for(t--;e<t;t--)this.SetNewNext(n[t])}InsertVertsInReverse(e,t,n){for(e++;e<t;e++)this.SetNewNext(n[e])}SetNewNext(e){let t=new Ur(e),n=this.Next;this.Next=t,t.Next=n}};var el=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return K(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return el.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?V.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var dr=class{constructor(e){this.pathVisibilityGraph=new Me;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(i(),e.Width),n=t.next();for(n.done||e.SetFirstEdge(n.value);(n=t.next()).done==!1;)e.AddEdge(n.value);function*i(){if(e.PathPoints instanceof Ur)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let n=e.next(),i=n.value;for(;!(n=e.next()).done;)yield this.CreatePathEdge(i,n.value,t),i=n.value}CreatePathEdge(e,t,n){switch(V.DirectionFromPointToPoint(e,t)){case 2:case 1:return new el(this.GetAxisEdge(e,t),n);case 4:case 8:{let o=new el(this.GetAxisEdge(t,e),n);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(n,i)=>new ym(n,i))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of dr.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(dr.CompareTwoPathEdges);let n=0;for(let i of t)i.Index=n++}static CompareTwoPathEdges(e,t){if(e==t)return 0;let n=dr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return n!=0?n:-dr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,V.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,n,i){for(;;){if(e=dr.GetNextPathEdgeInDirection(e,n,i),e==null||(t=dr.GetNextPathEdgeInDirection(t,n,i),t==null))return 0;if(e.AxisEdge==t.AxisEdge){i=dr.FindContinuedDirection(n,i,e.AxisEdge),n=e.AxisEdge;let c=dr.GetExistingOrder(e,t);if(c==dr.NotOrdered)continue;return i==n.Direction?c:-c}let o=i==n.Direction?n.Target:n.Source,a=dr.OtherVertex(e.AxisEdge,o),l=dr.OtherVertex(t.AxisEdge,o),u=dr.ProjectionForCompare(n,i!=n.Direction);return ye(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,n){return e.Direction==t?n.Source==e.Target?n.Direction:V.OppositeDir(n.Direction):n.Source==e.Source?n.Direction:V.OppositeDir(n.Direction)}static OtherVertex(e,t){return e.Source==t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction==1?t?n=>-n.x:n=>n.x:t?n=>n.y:n=>-n.y}static GetNextPathEdgeInDirection(e,t,n){return t.Direction==n?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let n=e.Index;if(n==-1)return dr.NotOrdered;let i=t.Index;return ye(n,i)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,n){for(let i of n.Vertices()){let o=i.InEdgesLength();t.set(i,o),o==0&&e.enqueue(i)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new NS.Queue,n=new Map;for(dr.InitQueueOfSources(t,n,e);t.length>0;){let i=t.dequeue();for(let o of i.OutEdges){let a=n.get(o.Target);n.set(o.Target,a-1),a==1&&t.enqueue(o.Target),yield o}}}},pd=dr;pd.NotOrdered=Number.MAX_VALUE;var Sm=class extends Nt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var md=class extends Nt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var Em=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size==0}};var Do=class extends Lu{constructor(e,t,n,i,o){super(t,new V(e).ToPoint());this.DirectionPerp=new V(e).Right.ToPoint(),this.PathOrders=i,this.xProjection=e==1?a=>a.x:a=>-a.y,this.edgeContainersTree=new ot((a,l)=>this.CompareAA(a,l)),this.SweepPole=V.VectorDirection(this.SweepDirection),this.AxisEdges=o,this.AxisEdgesToObstaclesTheyOriginatedFrom=n}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(e){e instanceof tn?this.ProcessVertexEvent(e):(this.Z=this.GetZP(e.Site),e instanceof md?this.ProcessLowEdgeEvent(e):this.ProcessHighEdgeEvent(e))}ProcessHighEdgeEvent(e){let t=e.AxisEdge;this.RemoveEdge(t),this.ConstraintEdgeWithObstaclesAtZ(t,t.Target.point)}ProcessLowEdgeEvent(e){let t=e.AxisEdge,n=this.GetOrCreateAxisEdgesContainer(t);n.item.AddEdge(t);let i=this.edgeContainersTree.previous(n);if(i!=null)for(let a of i.item.edges)for(let l of n.item.edges)this.TryToAddRightNeighbor(a,l);let o=this.edgeContainersTree.next(n);if(o!=null)for(let a of n.item.Edges)for(let l of o.item.edges)this.TryToAddRightNeighbor(a,l);this.ConstraintEdgeWithObstaclesAtZ(t,t.Source.point)}TryToAddRightNeighbor(e,t){this.ProjectionsOfEdgesOverlap(e,t)&&e.AddRightNeighbor(t)}ProjectionsOfEdgesOverlap(e,t){return this.SweepPole==1?!(e.TargetPoint.y<t.SourcePoint.y-E.distanceEpsilon||t.TargetPoint.y<e.SourcePoint.y-E.distanceEpsilon):!(e.TargetPoint.x<t.SourcePoint.x-E.distanceEpsilon||t.TargetPoint.x<e.SourcePoint.x-E.distanceEpsilon)}GetObstacleBoundaries(e){return this.Obstacles.map(t=>oe.mkDebugCurveWCI(1,e,t))}ConstraintEdgeWithObstaclesAtZ(e,t){this.ConstraintEdgeWithObstaclesAtZFromLeft(e,t),this.ConstraintEdgeWithObstaclesAtZFromRight(e,t)}ConstraintEdgeWithObstaclesAtZFromRight(e,t){let n=this.GetActiveSideFromRight(t);if(n==null||this.NotRestricting(e,n.item.Polyline))return;let i=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);e.BoundFromRight(i.dot(this.DirectionPerp))}GetActiveSideFromRight(e){return this.LeftObstacleSideTree.findFirst(t=>Do.PointToTheLeftOfLineOrOnLineLocal(e,t.Start,t.End))}ConstraintEdgeWithObstaclesAtZFromLeft(e,t){let n=this.GetActiveSideFromLeft(t);if(n==null||this.NotRestricting(e,n.item.Polyline))return;let i=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);e.BoundFromLeft(i.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(e,t,n){return p.signedDoubledTriangleArea(e,t,n)>-Do.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(e,t,n){return p.signedDoubledTriangleArea(t,n,e)<Do.AreaComparisonEpsilon}GetActiveSideFromLeft(e){return this.RightObstacleSideTree.findLast(t=>Do.PointToTheRightOfLineOrOnLineLocal(e,t.Start,t.End))}static EdgeMidPoint(e){return p.middle(e.SourcePoint,e.TargetPoint)}GetOrCreateAxisEdgesContainer(e){let t=e.Source.point,n=this.GetAxisEdgesContainerNode(t);return n!=null?n:this.edgeContainersTree.insert(new Em(t))}GetAxisEdgesContainerNode(e){let t=this.xProjection(e),n=this.edgeContainersTree.findFirst(i=>this.xProjection(i.Source)>=t-E.distanceEpsilon/2);return n!=null&&this.xProjection(n.item.Source)<=t+E.distanceEpsilon/2?n:null}ProcessVertexEvent(e){this.Z=this.GetZS(e),e instanceof ai?this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline):e instanceof li?this.ProcessRightVertex(e,e.Vertex.prevOnPolyline):(this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline),this.ProcessRightVertex(e,e.Vertex.prevOnPolyline))}ProcessRightVertex(e,t){let n=e.Site;this.ProcessPrevSegmentForRightVertex(e,n);let i=t.point.sub(e.Site),o=i.dot(this.DirectionPerp),a=i.dot(this.SweepDirection);a<=E.distanceEpsilon?o>0&&a>=0?this.EnqueueEvent(new li(t)):this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex):(this.InsertRightSide(new zi(e.Vertex)),this.EnqueueEvent(new li(t)),this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex))}RestrictEdgeContainerToTheRightOfEvent(e){let t=e.point,n=this.xProjection(t),i=this.edgeContainersTree.findFirst(o=>n<=this.xProjection(o.Source));if(i!=null)for(let o of i.item.Edges)this.NotRestricting(o,e.polyline)||o.BoundFromLeft(this.DirectionPerp.dot(t))}NotRestricting(e,t){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(e)==t}ProcessPrevSegmentForRightVertex(e,t){let n=e.Vertex.nextOnPolyline.point;t.sub(n).dot(this.SweepDirection)>E.distanceEpsilon&&this.RemoveRightSide(new zi(e.Vertex.nextOnPolyline))}RemoveEdge(e){let t=this.GetAxisEdgesContainerNode(e.Source.point);t.item.RemoveAxis(e),t.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(t)}ProcessLeftVertex(e,t){let n=e.Site;this.ProcessPrevSegmentForLeftVertex(e,n);let i=t.point.sub(e.Site),o=i.dot(this.DirectionPerp),a=i.dot(this.SweepDirection);a<=E.distanceEpsilon?o<0&&a>=0&&this.EnqueueEvent(new ai(t)):(this.InsertLeftSide(new Ui(e.Vertex)),this.EnqueueEvent(new ai(t))),this.RestrictEdgeFromTheLeftOfEvent(e.Vertex)}RestrictEdgeFromTheLeftOfEvent(e){let t=e.point,n=this.GetContainerNodeToTheLeftOfEvent(t);if(n!=null)for(let i of n.item.Edges)this.NotRestricting(i,e.polyline)||i.BoundFromRight(t.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(e){let t=this.xProjection(e);return this.edgeContainersTree.findLast(n=>this.xProjection(n.Source)<=t)}ProcessPrevSegmentForLeftVertex(e,t){let n=e.Vertex.prevOnPolyline.point;t.sub(n).dot(this.SweepDirection)>E.distanceEpsilon&&this.RemoveLeftSide(new Ui(e.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let e of this.AxisEdges)this.EnqueueEventsForEdge(e)}EnqueueEventsForEdge(e){this.EdgeIsParallelToSweepDir(e)&&(this.EnqueueEvent(Do.EdgeLowPointEvent(e,e.Source.point)),this.EnqueueEvent(Do.EdgeHighPointEvent(e,e.Target.point)))}EdgeIsParallelToSweepDir(e){return e.Direction==this.SweepPole||e.Direction==V.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(e,t){return new Sm(e,t)}static EdgeLowPointEvent(e,t){return new md(e,t)}CompareAA(e,t){return ye(e.Source.dot(this.DirectionPerp),t.Source.dot(this.DirectionPerp))}},bd=Do;bd.AreaComparisonEpsilon=E.intersectionEpsilon;var xm=class extends Rs{constructor(e){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=e}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(e){if(this.Edges.length==0){let t=V.VectorDirectionPP(e.Source,e.Target);switch(t){case 4:t=1;break;case 8:t=2;break}this.CompassDirection=t,this.start=e.Source,this.end=e.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(e.Source),this.TryPointForStartAndEndNorth(e.Target);break;case 2:this.TryPointForStartAndEndEast(e.Source),this.TryPointForStartAndEndEast(e.Target);break}this.Edges.push(e)}TryPointForStartAndEndNorth(e){e.y<this.start.y?this.start=e:e.y>this.end.y&&(this.end=e)}TryPointForStartAndEndEast(e){e.x<this.start.x?this.start=e:e.x>this.end.x&&(this.end=e)}get IsFixed(){return this._isFixed}set IsFixed(e){this._isFixed=e}get Width(){let e=0;for(let t of this.edges)e=Math.max(e,t.Width);return e}GetLeftBound(){if(!this.IsFixed){let e=Number.NEGATIVE_INFINITY;for(let t of this.edges)e=Math.max(e,t.AxisEdge.LeftBound);return e}return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let e=Number.POSITIVE_INFINITY;for(let t of this.edges)e=Math.min(e,t.AxisEdge.RightBound);return e}return this.Position()}Position(){return this.CompassDirection==1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var gn=class{constructor(e,t){this.tree=new ot((e,t)=>ye(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length==0||this.HorizontalPoints.length==0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){K(e.Next.Point.x,e.Point.x)?t==gn.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,n,i,o=e.Y;if(e.Point.x<e.Next.Point.x?(n=e.Point.x,t=e.Next.Point.x,i=!0):(t=e.Point.x,n=e.Next.Point.x,i=!1),i)for(let a=this.tree.findFirst(l=>n<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new p(a.item.Point.x,o);e=gn.TrySplitHorizontalPoint(e,l,!0),gn.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=n;a=this.tree.previous(a)){let l=new p(a.item.Point.x,o);e=gn.TrySplitHorizontalPoint(e,l,!1),gn.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){gn.Low(e)+E.distanceEpsilon<t.y&&t.y+E.distanceEpsilon<gn.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,n){return n&&e.X+E.distanceEpsilon<t.x&&t.x+E.distanceEpsilon<e.Next.X||!n&&e.Next.X+E.distanceEpsilon<t.x&&t.x+E.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new Zt(ye);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,gn.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var Go=class{constructor(e){this.verticesToPathOffsets=new Je;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,n=null;for(let i=e.PathPoints;i!=null;i=i.Next){let o=this.verticesToPathOffsets.get(i.Point);if(n!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,i),t.delete(a))}for(let[a,l]of n)o.has(a)||t.set(a,l)}n=o}}CollapseLoopingPath(e,t,n,i,o){let a=Go.FindLinkedPointInPath(i,t.Point),l=Array.from(Go.GetPointsInBetween(a,o));Go.Before(t,n)?(this.CleanDisappearedPiece(t,n,e),this.ReplacePiece(t,n,l,e)):(this.CleanDisappearedPiece(n,t,e),this.ReplacePiece(n,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let n=e.Next;n!=t;n=n.Next)yield n.Point}ReplacePiece(e,t,n,i){let o=e;for(let a of n){let l=new Ur(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(i,o)}o.Next=t}CleanDisappearedPiece(e,t,n){for(let i of Go.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(i).delete(n)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e==t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let n=e.PathPoints;;n=n.Next)if(n.Point.equal(t))return n}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let n=this.verticesToPathOffsets.get(t.Point);n||this.verticesToPathOffsets.set(t.Point,n=new Map);let i=n.get(e);i?(this.CleanDisappearedPiece(i,t,e),i.Next=t.Next):n.set(e,t)}}};var Cm=class{constructor(e){this.projection=e}compare(e,t){return ye(this.projection(e),this.projection(t))}};var DS=ne(Au()),zt=class{static RefinePaths(e,t){zt.AdjustPaths(e);let n=zt.CreatePathsToFirstLinkedVerticesMap(e);zt.Refine(Array.from(n.values())),zt.CrossVerticalAndHorizontalSegs(n.values()),zt.ReconstructPathsFromLinkedVertices(n),t&&new Go(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=zt.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length==0)return;let t=[],n=E.RoundPoint(e[0]);t.push(n);for(let i=1;i<e.length;i++){let o=E.RoundPoint(e[i]);n.equal(o)||(n=o,t.push(n))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,n=new Array;for(let i of e)for(let o=i;o.Next!=null;o=o.Next)K(o.Point.x,o.Next.Point.x)?n.push(o):t.push(o);new gn(t,n).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,n]of e)t.PathPoints=n}static Refine(e){zt.RefineInDirection(1,e),zt.RefineInDirection(2,e)}static*groupByProj(e,t){let n=new Map;for(let i of t){let o=e(i.Point),a=n.get(o);a||(a=new Array,n.set(o,a)),a.push(i)}for(let i of n.values())yield i}static RefineInDirection(e,t){let n={projectionToPerp:void 0,projectionToDirection:void 0};zt.GetProjectionsDelegates(e,n);let i=Array.from(zt.GetAllLinkedVertsInDirection(n.projectionToPerp,t)),o=zt.groupByProj(n.projectionToPerp,i);for(let a of o)zt.RefineCollinearBucket(a,n.projectionToDirection)}static GetProjectionsDelegates(e,t){e==2?(t.projectionToDirection=n=>n.x,t.projectionToPerp=n=>n.y):(t.projectionToPerp=n=>n.x,t.projectionToDirection=n=>n.y)}static*GetAllLinkedVertsInDirection(e,t){for(let n of t)for(let i=n;i.Next!=null;i=i.Next)K(e(i.Point),e(i.Next.Point))&&(yield i)}static RefineCollinearBucket(e,t){let n=new DS.SortedMap(new Cm(t));for(let a of e)n.has(a.Point)||n.set(a.Point,0),n.has(a.Next.Point)||n.set(a.Next.Point,0);let i=new Array(n.size),o=0;for(let a of n.keys())i[o++]=a;for(o=0;o<i.length;o++)n.set(i[o],o);for(let a of e){o=n.get(a.Point);let l=n.get(a.Next.Point);Math.abs(l-o)>1&&zt.InsertPoints(a,i,o,l)}}static InsertPoints(e,t,n,i){n<i?e.InsertVerts(n,i,t):e.InsertVertsInReverse(i,n,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let n of e)t.set(n,zt.CreateLinkedVertexOfEdgePath(n));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,n=new Ur(t[0]),i=n;for(let o=1;o<t.length;o++)n.Next=new Ur(t[o]),n=n.Next;return i}};var Hi=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I==t.I&&e.Points==t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var ji=class{constructor(e,t){this.segTree=new hs(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new hs(t),this.Paths=e}static RemoveStaircases(e,t){new ji(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(n=>!this.crossedOutPaths.has(n)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new Hi(e.pts,0),new Hi(e.pts,1),new Hi(e.pts,2),new Hi(e.pts,3)],n=0;for(let i=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,i,t,o))return e.canHaveStaircase=!0,i;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,i++,e.pts.length<i+5)return-1;t[n]=new Hi(e.pts,i+3),n++,n%=4}}static GetFlippedPoint(e,t){return K(e[t].y,e[t+1].y)?new p(e[t+4].x,e[t].y):new p(e[t].x,e[t+4].y)}Crossing(e,t,n){return ji.IsCrossing(R.mkPP(e,t),this.segTree,n)}static IsCrossing(e,t,n){for(let i of t.GetAllIntersecting(e.boundingBox))if(n.findIndex(o=>o==i)==-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,n){return this.IntersectObstacleHierarchyL(R.mkPP(e,t))||this.IntersectObstacleHierarchyL(R.mkPP(t,n))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>v.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,n,i){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return i.canHaveStaircaseAtI=!1,V.DirectionFromPointToPoint(o,a)!=V.DirectionFromPointToPoint(l,u)||V.DirectionFromPointToPoint(a,l)!=V.DirectionFromPointToPoint(u,c)||(l=ji.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(i.canHaveStaircaseAtI=!0,!this.Crossing(a,l,n))}RemoveStaircasePN(e,t){let n=e[t],i=e[t+1],o=Math.abs(n.y-i.y)<E.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,n){this.RemoveSegs(e);let i=new Array(e.length-2);c2(e,i,t+1);let o=e[t+1],a=e[t+3];return i[t+1]=n?new p(a.x,o.y):new p(o.x,a.y),u2(e,t+4,i,t+2,i.length-t-2),this.InsertNewSegs(i,t),i}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new Hi(e,t))}RemoveSeg(e){this.segTree.Remove(ji.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let n=new Hi(e,t);this.segTree.Add(ji.Rect(n),n)}static Rect(e){return k.mkPP(e.Start,e.End)}};function u2(s,e,t,n,i){for(;i-- >0;)t[n++]=s[e++]}function c2(s,e,t){let n=0;for(;t-- >0;)e[n++]=s[n++]}var Ze=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,n,i){this.AncestorsSets=i,this.HierarchyOfGroups=_e(Array.from(i.keys()).filter(o=>o.IsGroup).map(o=>Ke(o,o.BoundingBox))),this.Obstacles=n,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=_e(n.map(o=>Ke(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length==0)return;let t=e.PathPoints,n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],Ze.ObstacleTest),i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],Ze.ObstacleTest);n!=null&&i!=null&&this.PathToObstacles.set(e,[n.UserData,i.UserData])}static ObstacleTest(e,t){return v.PointRelativeToCurveLocation(e,t)!=0?1:0}Calculate(e,t){this.NudgingDirection=e,zt.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let n=this.FindLastUnmappedEdge(e);for(let i=t;i!=null&&i!=n;i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(i.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!=this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let n=e.LastEdge;n!=null&&V.DirectionsAreParallel(n.Direction,this.NudgingDirection);n=n.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(n.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let n=e.FirstEdge;n!=null&&V.DirectionsAreParallel(n.Direction,this.NudgingDirection);n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(n.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new pd(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let n=new Array;for(let i of e){let o=new $;for(let a of i.PathPoints)o.addPoint(a);n.push(o)}return n.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)Ze.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let n=e.LastEdge;n.Width=Math.max(t.targetArrowhead.width,n.Width)}if(t.sourceArrowhead!=null){let n=e.FirstEdge;n.Width=Math.max(t.sourceArrowhead.width,n.Width)}}PositionShiftedEdges(){this.Solver=new Pm(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];Ze.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),n=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>n&&(e.IdealPosition=n)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return Ze.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x==t.x||e.y==t.y)return t;let n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return n<i?new p(e.x,t.y):new p(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],n=e.FirstEdge;t.push(this.ShiftedPoint(n.Source,n.LongestNudgedSegment));for(let i of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(i));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let n=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection==1?new p(n,e.y):new p(e.x,-n)}static LineSegOfLongestSeg(e,t){let n=t==2?o=>o.x:o=>o.y,i={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)Ze.UpdateMinMaxWithPoint(i,n,o.Source),Ze.UpdateMinMaxWithPoint(i,n,o.Target);return t==2?new R(i.min,-e.IdealPosition,i.max,-e.IdealPosition):new R(e.IdealPosition,i.min,e.IdealPosition,i.max)}static UpdateMinMaxWithPoint(e,t,n){let i=t(n);e.min>i&&(e.min=i),e.max<i&&(e.max=i)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let n of e.Edges){let i=n.AxisEdge;if(i!=null)for(let o of i.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let n of t)this.ConstraintTwoLongestSegs(e,n)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)Ze.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return K(e.SourcePoint.x,e.TargetPoint.x);default:return K(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let n of e.filter(i=>i.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,n.LongestNudgedSegment),t=n}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,Ze.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),n=e.GetRightBound();t>=n?(this.Solver.AddFixedVariable(e.Id,Ze.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,Ze.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!=Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),n!=Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,n))}}static SegmentPosition(e,t){return t==1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new bd(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let n=t.BoundingBox;for(let i of e.PathEdges()){let o=i.AxisEdge;o.Direction==this.NudgingDirection&&this.BoundAxisEdgeByRect(n,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=Ze.MapPortsToShapes(this.AncestorsSets.keys()));let t=h2(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(n=>!n.Children.some(i=>t.has(i)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(k.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction==this.NudgingDirection&&(this.NudgingDirection==1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection==2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),Ze.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let n=null,i=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(n=a.LongestNudgedSegment,i!=null){let l;Ze.SetIdealPositionForSeg(i,l=t(i.start),o,t(n.Start)),o=l,i=null}}else n!=null&&(i=n,n=null);i!=null?Ze.SetIdealPositionForSeg(i,t(i.Start),o,t(e.End)):n!=null&&(n.IdealPosition=t(n.Start))}static SetIdealPositionForSeg(e,t,n,i){let o=Math.max(n,i),a=Math.min(n,i);a+E.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,n=V.OppositeDir(this.NudgingDirection);for(let i of e.PathEdges()){let o=i.Direction;o==this.NudgingDirection||o==n?(t==null?(i.LongestNudgedSegment=t=new xm(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):i.LongestNudgedSegment=t,i.IsFixed&&(t.IsFixed=!0)):(i.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(n=>n.clone())};return Ze.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){Ze.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),Ze.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let n=e.points.length-1,i=V.VectorDirectionPP(e.points[n-1],e.points[n]);if(Ze.ProjectionsAreClose(e.points[n-1],i,t)){e.points=e.points.slice(0,n);return}let o=e.points[n];i==2||i==8?e.points[n]=new p(t.x,o.y):e.points[n]=new p(o.x,t.y)}static ProjectionsAreClose(e,t,n){return t==2||t==8?K(e.x,n.x):K(e.y,n.y)}static ExtendPolylineToSourcePort(e,t){let n=V.VectorDirectionPP(e.points[0],e.points[1]);if(Ze.ProjectionsAreClose(e.points[1],n,t)){e.points=e.points.slice(1);return}let i=e.points[0];n==2||n==8?e.points[0]=new p(t.x,i.y):e.points[0]=new p(i.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],n=e[0];t.push(n);let i=e[1],o=V.VectorDirectionPP(n,i),a=1;for(;++a<e.length;){let l=V.VectorDirectionPP(i,e[a]);l==o||V.OppositeDir(l)==o||l==0||(p.closeDistEps(n,i)||t.push(n=Ze.Rectilinearise(n,i)),o=l),i=e[a]}return p.closeDistEps(n,i)||t.push(Ze.Rectilinearise(n,i)),t}static NudgePaths(e,t,n,i,o){if(e.length==0)return;let a=new Ze(e,t,n,i);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=$.mkFromPoints(Ze.BuildPolylineForPath(l))}RemoveStaircases(){ji.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let n of e)for(let i of n.Ports)t.set(i,n);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,n,i){let o=i.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield oe.mkDebugCurveTWCI(200,e+l*u,n,R.mkPP(o[u],o[u+1]))}};function h2(s,e){let t=new Set;if(s.size<e.size)for(let n of s)e.has(n)&&t.add(n);else for(let n of e)s.has(n)&&t.add(n);return t}var GS=ne(Tt());var Am=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var qi=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new Am(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:N.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,n=0,i=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;n<t||o<i;){if(n>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=i){a.push(this.ListOfPointsAndCrossings[n++]);continue}let l=this.ListOfPointsAndCrossings[n],u=e.ListOfPointsAndCrossings[o],c=N.ComparePP(l.Location,u.Location);c==0?(a.push(l),++n,++o):c==-1?(a.push(l),++n):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length==0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(n=>N.ComparePP(n.Location,e)>=0&&N.ComparePP(n.Location,t)<=0))}static ToCrossingArray(e,t){let n=0,i=e.length;for(let l=0;l<i;l++)e[l].DirectionToInside==t&&n++;if(n==0)return null;let o=new Array(n),a=0;for(let l=0;l<i;l++)e[l].DirectionToInside==t&&(o[a++]=e[l]);return o}ToString(){return GS.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var j=class{static EdgeDirectionVE(e){return j.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return N.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let n=j.EdgeDirectionVE(e);return t==n?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let n of e.InEdges)if(N.GetDirections(e.point,n.SourcePoint)==t)return n.Source;for(let n of e.OutEdges)if(N.GetDirections(e.point,n.TargetPoint)==t)return n.Target;return null}static FindAdjacentEdge(e,t){for(let n of e.InEdges)if(N.GetDirections(n.SourcePoint,e.point)==t)return n;for(let n of e.OutEdges)if(N.GetDirections(e.point,n.TargetPoint)==t)return n;return null}static FindBendPointBetween(e,t,n){return j.IsVerticalD(n)?new p(t.x,e.y):new p(e.x,t.y)}static SegmentIntersectionPPP(e,t,n){let i=N.GetDirections(e,t);return j.IsVerticalD(i)?new p(e.x,n.y):new p(n.x,e.y)}static SegmentIntersectionSP(e,t){return j.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return j.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return j.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return j.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,n,i){return j.IntervalsAreCollinear(e,t,n,i)&&N.ComparePP(e,i)!=N.ComparePP(t,n)}static IntervalsAreCollinear(e,t,n,i){let o=j.IsVerticalPP(e,t);return j.IsVerticalPP(n,i)==o?o?N.Equal(e.x,n.x):N.Equal(e.y,n.y):!1}static IntervalsAreSame(e,t,n,i){return N.EqualPP(e,n)&&N.EqualPP(t,i)}static IntervalsIntersect(e,t,n,i){let o=j.SegmentIntersectionPPP(e,t,n);return j.PointIsOnSegmentPPP(e,t,o)&&j.PointIsOnSegmentPPP(n,i,o)?o:void 0}static SegmentIntersectionEP(e,t){return j.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,n){return N.EqualPP(e,n)||N.EqualPP(t,n)||N.GetDirections(e,n)==N.GetDirections(n,t)}static PointIsOnSegmentSP(e,t){return j.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!=0}static IsVerticalE(e){return j.IsVerticalD(N.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return j.IsVerticalD(N.GetDirections(e,t))}static IsVertical(e){return j.IsVerticalD(N.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!=0}static Slope(e,t,n){let i=t.sub(e);return i.dot(n.PerpDirectionAsPoint)/i.dot(n.DirectionAsPoint)}static SortAscending(e,t){let n=N.GetDirections(e,t);return 0==n||j.IsAscending(n)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,n){switch(n){case 1:case 4:return new p(t.x,j.GetRectangleBound(e,n));case 2:case 8:return new p(j.GetRectangleBound(e,n),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return N.Compare(e.bottom,t.top)<0&&N.Compare(t.bottom,e.top)<0&&N.Compare(e.left,t.right)<0&&N.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return N.Compare(e.y,t.top)<0&&N.Compare(t.bottom,e.y)<0&&N.Compare(e.x,t.right)<0&&N.Compare(t.left,e.x)<0}};var _o=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=V.toPoint(this.Dir),this.PerpDirection=1==e?2:1,this.PerpDirectionAsPoint=V.toPoint(this.PerpDirection),this.OppositeDirection=V.OppositeDir(e)}get IsHorizontal(){return 2==this.Dir}get IsVertical(){return 1==this.Dir}Compare(e,t){let n=this.ComparePerpCoord(e,t);return n!=0?n:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return N.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return N.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return N.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return N.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?_o.VerticalInstance:_o.HorizontalInstance}static GetInstance(e){return j.IsVerticalD(e)?_o.VerticalInstance:_o.HorizontalInstance}ToString(){return this.Dir.toString()}},ft=_o;ft.HorizontalInstance=new _o(2),ft.VerticalInstance=new _o(1);var Xi=class extends Rs{static mk(e,t){return new Xi(e,t,Xi.NormalWeight,null)}constructor(e,t,n,i){super();this.Update(e,t),this.Weight=n,this.GroupBoundaryPointAndCrossingsList=i}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Xi.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?ft.VerticalInstance:ft.HorizontalInstance}get IsOverlapped(){return Xi.OverlappedWeight==this.Weight}get IsReflection(){return Xi.ReflectionWeight==this.Weight}static IsVerticalSegment(e,t){return e.x==t.x}MergeGroupBoundaryCrossingList(e){e!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new qi),this.GroupBoundaryPointAndCrossingsList.MergeFrom(e))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(e,t){this.startPoint=e,this.endPoint=t}SetInitialVisibilityVertex(e){this.LowestVisibilityVertex=e,this.HighestVisibilityVertex=e}AppendVisibilityVertex(e,t){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.SetInitialVisibilityVertex(t);else{if(N.IsPureLower(t.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.AppendHighestVisibilityVertex(t)}}AddVisibilityEdge(e,t){let n=new kr(e,t,this.Weight);return Me.AddEdge(n),n}AppendHighestVisibilityVertex(e){N.EqualPP(this.HighestVisibilityVertex.point,e.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,e),this.HighestVisibilityVertex=e)}LoadStartOverlapVertexIfNeeded(e){if(this.NeedStartOverlapVertex){let t=e.FindVertex(this.Start);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(e){if(this.NeedEndOverlapVertex){let t=e.FindVertex(this.End);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.End))}}OnSegmentIntersectorBegin(e){this.AppendGroupCrossingsThroughPoint(e,this.Start)||this.LoadStartOverlapVertexIfNeeded(e)}OnSegmentIntersectorEnd(e){this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||N.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(e)}static Subsume(e,t,n,i,o,a,l,u){return u.extendStart=!0,u.extendEnd=!0,e.seg==null||!j.IntervalsOverlapPPPP(e.seg.Start,e.seg.End,t,n)?!1:e.seg.Weight!=i?e.seg.Start==t&&e.seg.End==n?(e.seg.Weight=Math.min(e.seg.Weight,i),!0):!1:(u.extendStart=a.CompareScanCoord(t,e.seg.Start)==-1,u.extendEnd=a.CompareScanCoord(n,e.seg.End)==1,(u.extendStart||u.extendEnd)&&(l.Remove(e.seg),e.seg.startPoint=a.Min(e.seg.Start,t),e.seg.endPoint=a.Max(e.seg.End,n),e.seg=l.InsertUnique(e.seg).item,e.seg.MergeGroupBoundaryCrossingList(o)),!0)}IntersectsSegment(e){return j.SegmentsIntersection(this,e)!=null}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(e){return N.EqualPP(this.Start,e)||N.EqualPP(this.End,e)||N.GetDirections(this.Start,e)==N.GetDirections(e,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(e){return this.IsVertical?new p(this.Start.x,e):new p(e,this.Start.y)}AddSparseVertexCoord(e){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(e)}AddSparseEndpoint(e){return this.sparsePerpendicularCoords.has(e)?!1:(this.sparsePerpendicularCoords.add(e),!0)}CreateSparseVerticesAndEdges(e){var t;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(e,this.Start);for(let n of Array.from(this.sparsePerpendicularCoords.values()).sort(ye)){let i=this.CreatePointFromPerpCoord(n);this.AppendVisibilityVertex(e,(t=e.FindVertex(i))!=null?t:e.AddVertexP(i))}this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(e,t){return this.AppendGroupCrossingsThroughPoint(e,t.point)?(N.IsPureLower(this.HighestVisibilityVertex.point,t.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t),!0):!1}AppendGroupCrossingsThroughPoint(e,t){var i;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let n=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(t);){let o=this.GroupBoundaryPointAndCrossingsList.Pop(),a=null,l=null;N.ComparePP(o.Location,this.Start)>0&&(a=qi.ToCrossingArray(o.Crossings,this.ScanDirection.OppositeDirection)),N.ComparePP(o.Location,this.End)<0&&(l=qi.ToCrossingArray(o.Crossings,this.ScanDirection.Dir)),n=!0;let u=(i=e.FindVertex(o.Location))!=null?i:e.AddVertexP(o.Location);e.AddVertexP(o.Location),a!=null||l!=null?(this.AddLowCrossings(e,u,a),this.AddHighCrossings(e,u,l)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(u):this.AppendHighestVisibilityVertex(u)}return n}static GetCrossingInteriorVertex(e,t,n){var o;let i=n.GetInteriorVertexPoint(t.point);return(o=e.FindVertex(i))!=null?o:e.AddVertexP(i)}AddCrossingEdge(e,t,n,i){let o=null;this.HighestVisibilityVertex!=null&&(N.EqualPP(this.HighestVisibilityVertex.point,n.point)?o=e.FindEdgePP(t.point,n.point):this.AppendHighestVisibilityVertex(t)),o==null&&(o=this.AddVisibilityEdge(t,n));let a=i.map(u=>u.Group.InputShape),l=o.IsPassable;l==null?o.IsPassable=()=>{for(let u of a)if(u.IsTransparent)return!0;return!1}:o.IsPassable=()=>{for(let u of a)if(u.IsTransparent||l())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(t),this.HighestVisibilityVertex=n}AddLowCrossings(e,t,n){if(n!=null){let i=Xi.GetCrossingInteriorVertex(e,t,n[0]);this.AddCrossingEdge(e,i,t,n)}}AddHighCrossings(e,t,n){if(n!=null){let i=Xi.GetCrossingInteriorVertex(e,t,n[0]);this.AddCrossingEdge(e,t,i,n)}}},be=Xi;be.NormalWeight=kr.DefaultWeight,be.ReflectionWeight=5,be.OverlappedWeight=500;var Pd=class{constructor(e,t,n,i,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?V.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,n,i,o)}ResetEntry(e,t,n,i){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=n,this.Cost=i}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var yd=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},gt=class{constructor(){this.nextNeighbors=[new yd,new yd,new yd];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,n){if(t==n||!this.InitEntryDirectionsAtTarget(n))return!1;this.Target=n,this.Source=t;let i=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return i>=this.upperBoundOnCost?!1:(this.queue=new Zt(ye),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(i):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|V.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|V.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!=0}static IsInDirs(e,t){return e==(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let n=this.Target.point.sub(e);if(K(n.x,0)&&K(n.y,0))return this.targetCostAdjustment;let i=V.VectorDirection(n),o;return t==0?(t=15,o=this.GetNumberOfBends(t,i)):o=this.GetNumberOfBends(t,i),this.CombinedCost(gt.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return V.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):gt.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)==t?gt.IsInDirs(t,this.EntryDirectionsToTarget)?0:gt.IsInDirs(gt.Left(t),this.EntryDirectionsToTarget)||gt.IsInDirs(gt.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(gt.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,n){let i=e&t;if(i==0)return gt.GetBendsForNotPureDirection(e,gt.AddOneTurn[t],n)+1;let o=e&n;return o==0?gt.GetBendsForNotPureDirection(e,t,gt.AddOneTurn[n])+1:(i|o)==e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return gt.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let n=new Array,i=!1,o=0;for(;;){o==e.entry.Direction?i=!0:(i=!1,n.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex==t)break;e.entry=a}return i&&n.push(e.entry.Vertex.point),n.reverse(),n}QueueReversedEntryToNeighborVertexIfNeeded(e,t,n){let i={numberOfBends:0,length:0},o=t.PreviousVertex,a=gt.GetLengthAndNumberOfBendsToNeighborVertex(e,o,n,i);if(this.CombinedCost(i.length,i.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree==1){let l=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,i.length,i.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,n){let i={numberOfBends:0,length:0},o=gt.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,n,i);if(this.CombinedCost(i.length,i.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,i.length,i.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,n){let i={numberOfBends:0,length:0},o=gt.GetLengthAndNumberOfBendsToNeighborVertex(e,t,n,i),a=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,i.length,i.numberOfBends,a))}EnqueueEntry(e,t,n,i,o){let a=new Pd(t,e,n,i,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,n,i){i.length=e.Length+gt.ManhattanDistance(e.Vertex.point,t.point)*n;let o=V.DirectionFromPointToPoint(e.Vertex.point,t.point);return i.numberOfBends=e.NumberOfBends,e.Direction!=0&&o!=e.Direction&&i.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,n,i,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=n,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c==this.Target){if(i==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget==0){let d=0;for(let f of this.Target.VertexEntries)i[d++]=f;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=gt.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(i!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)i[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,n){for(let i of t)this.ExtendPathAlongEdge(e,i,!0,n)}ExtendPathAlongOutEdges(e,t,n){let i=t.isEmpty()?null:t.treeMinimum();for(;i!=null;i=t.next(i))this.ExtendPathAlongEdge(e,i.item,!1,n)}ExtendPathAlongEdge(e,t,n,i){if(!gt.IsPassable(t))return;let o=n?t.Source:t.Target;if(o==e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!=this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=V.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!=e.Direction&&(l=this.nextNeighbors[a==i?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new Pd(this.Source,null,0,0,e);for(let n of this.Source.OutEdges)!gt.IsPassable(n)||this.ExtendPathToNeighborVertex(t,n.Target,n.Weight);for(let n of this.Source.InEdges)!gt.IsPassable(n)||this.ExtendPathToNeighborVertex(t,n.Source,n.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,n){let i=V.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[V.ToIndex(i)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,n)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,n):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,n)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,n){if(e.Vertex.VertexEntries!=null){let i=V.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[V.ToIndex(i)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,n),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},pn=gt;pn.DefaultBendPenaltyAsAPercentageOfDistance=4,pn.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var Gs=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=pn.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let n={entry:this.GetPathStage(null,e,null,t)};return pn.RestorePathV(n)}GetPathStage(e,t,n,i){let o=new pn,a={bestEntry:null,bestCost:Number.MAX_VALUE/be.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=Gs.Barycenter(t),c=Gs.Barycenter(i),h=pn.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,f=n!=null?this.currentPassTargetEntries:null,y=[];for(let T of t)for(let I of i)y.push([T,I]);y.sort(([T,I],[B,w])=>S(T,I)-S(B,w));for(let[T,I]of y){if(p.closeDistEps(T.point,I.point))continue;let B=C(T,u)*d,w=C(I,c)*d,M=a.bestCost;if(n!=null){for(let te=0;te<f.length;te++)f[te]=null;M=o.MultistageAdjustedCostBound(a.bestCost)}let F=o.GetPathWithCost(e,T,B,f,I,w,M);if(f!=null){Gs.UpdateTargetEntriesForEachDirection(n,f,a);continue}if(F==null)continue;let U=F.Cost/S(T,I);(F.Cost<a.bestCost||K(F.Cost,a.bestCost)&&U<l)&&(a.bestCost=F.Cost,a.bestEntry=F,l=F.Cost/S(T,I))}return a.bestEntry;function S(T,I){return pn.ManhattanDistance(T.point,I.point)}function C(T,I){return pn.ManhattanDistance(T.point,I)}}static UpdateTargetEntriesForEachDirection(e,t,n){for(let i=0;i<t.length;i++){let o=t[i];o!=null&&(e[i]==null||o.Cost<e[i].Cost)&&(e[i]=o,o.Cost<n.bestCost&&(n.bestCost=o.Cost,n.bestEntry=o))}}static Barycenter(e){let t=new p(0,0);for(let n of e)t=t.add(n.point);return t.div(e.length)}};var FS=ne(Tt());var vm=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof Ur?Array.from(_S(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new FS.StringBuilder;this.PathPoints instanceof Ur&&e.Append("L");for(let t of _S(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*_S(s){if(s instanceof Ur)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var Tm=class extends Bs{constructor(e,t,n,i){super(t);this.Slope=0;this.SlopeInverse=0;this.Obstacle=e,this.endVertex=i?t.nextOnPolyline:t.prevOnPolyline,n.IsPerpendicularPP(t.point,this.endVertex.point)||(this.Slope=j.Slope(t.point,this.endVertex.point,n),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(e){this.obstacle=e}get EndVertex(){return this.endVertex}},fr=class extends Tm{constructor(e,t,n){super(e,t,n,n.IsHorizontal)}},Fo=class extends Tm{constructor(e,t,n){super(e,t,n,n.IsVertical)}};var _s=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=Vi(this.InputShape.Ports,this.Ports),e.removedPorts=Vi(this.Ports,this.InputShape.Ports),e.addedPorts.size==0&&e.removedPorts.size==0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,n,i){let o=_s.mk(e,t,i);return o.CreateInitialSides(o.PaddedPolyline.startPoint,n),o}CreateInitialSides(e,t){this.ActiveLowSide=new fr(this,e,t),this.ActiveHighSide=new Fo(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new Fo(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t,n){if(e!=null){if(t){let i=e.BoundingBox.clone();i.pad(n),this.PaddedPolyline=v.polyFromBox(i)}else this.PaddedPolyline=Gt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,n);_s.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports)}}static mk(e,t,n){let i=new _s(null,!1,0);return i.PaddedPolyline=$.mkClosedFromPoints([E.RoundPoint(e),E.RoundPoint(t)]),i.Ordinal=n,i}IsPolylineRectangle(){if(this.PaddedPolyline.count!=4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,n=V.VectorDirectionPP(e.point,t.point);if(!V.IsPureDirection(n))return!1;do{e=t,t=e.nextOnPolyline;let i=V.DirectionFromPointToPoint(e.point,t.point);if(i!=V.RotateRight(n))return!1;n=i}while(e!=this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=E.RoundPoint(t.point),t=t.nextOnPolyline;while(t!=e.startPoint);_s.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this==this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=E.intersectionEpsilon*10;for(let n=e.startPoint.next;n!=null;n=n.next)p.close(n.prev.point,n.point,t)&&(n.next==null?e.RemoveEndPoint():(n.prev.next=n.next,n.next.prev=n.prev));return p.close(e.start,e.end,t)&&e.RemoveStartPoint(),Te.RemoveCollinearVertices(e),e.endPoint.prev!=null&&e.endPoint.prev!=e.startPoint&&p.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)==2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!=e.startPoint&&p.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)==2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!=null&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump==e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=Gt.CreatePaddedPolyline(e,E.intersectionEpsilon*10);return _s.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},Kt=_s;Kt.FirstSentinelOrdinal=1,Kt.FirstNonSentinelOrdinal=10;var VS=ne(Tt());var Im=class{constructor(e,t,n,i){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=be.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=n;let o=R.mkPP(this.UnpaddedBorderIntersect,j.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,n)),a=v.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=E.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=i.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=i.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,ft.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(i))&&(this.unpaddedToPaddedBorderWeight=be.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight==be.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(i)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?be.OverlappedWeight:be.NormalWeight}get IsCollinearWithPort(){return V.IsPureDirection(N.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return j.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return N.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!=0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=be.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=k.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,n=>n.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(n=>!n.UserData.IsGroup&&n.UserData!=this.Obstacle).map(n=>n.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=k.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!=this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,n){let i=null;for(let o of n){let a=t(o);if(!j.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(i=i!=null?i:R.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),v.intersectionOne(i,a,!1)!=null||0!=v.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=j.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return N.GetDirections(this.MaxVisibilitySegment.start,t.Location)==N.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,n,i){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,n,i);return}this.OutwardDirection==N.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,n,i)}ExtendEdgeChain(e,t,n,i,o){e.ExtendEdgeChainVRLPB(n,i,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return VS.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var wm=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=k.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=E.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,n){let i=new Im(this,e,t,n);this.PortEntrances.push(i),this.VisibilityRectangle.add(i.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||i.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!p.closeDistEps(this.Location,E.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var Lm=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?be.OverlappedWeight:be.NormalWeight}get IsOutOfBounds(){return 0!=this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,n,i){let o=j.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,n,i):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,n,i),a}AddToAdjacentVertex(e,t,n,i){N.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,n,i)}ExtendEdgeChain(e,t,n,i){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,n));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,n,e);e.ExtendEdgeChainVRLPB(t,i,a[0],a[1],o)}GetSegmentAndCrossings(e,t,n){let i=V.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[i];if(o==null){let a={pacList:null};o=[n.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[i]=o}else N.GetDirections(e.point,o[0].start)==t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let n=N.GetDirections(t,this.Vertex.point),i=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(i,this.Vertex,n&5,be.NormalWeight),e.ConnectVertexToTargetVertex(i,this.Vertex,n&10,be.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var zS=ne(Tt());var kS=ne(Tt());var tl=class{constructor(e,t){this.BoundaryWidth=E.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return E.RoundPoint(e.add(V.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return kS.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};tl.BoundaryWidth=E.distanceEpsilon;var Du=class extends Nt{constructor(e){super();this.site=e}get Site(){return this.site}};var Fs=class extends tn{constructor(e,t){super(t);this.Obstacle=e}};var Vs=class extends Fs{constructor(e,t){super(e,t)}};var Om=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!N.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||N.GetDirections(this.CurrentSegment.End,e)==N.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&p.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(N.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new p(e,this.Coord):new p(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y == "+this.Coord:"(V) X == "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var Sd=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let n=Array.from(e).sort((i,o)=>i>o?1:i<o?-1:0);for(let i of n)this.vector.push(new Om(i))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,n,i){this.CurrentSlot.AppendScanSegment(new be(e,t,n,i))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let n=0,i=this.vector.length-1;if(e<=this.vector[n].Coord)return n;if(e>=this.vector[i].Coord)return i;for(;i-n>2;){let o=n+(i-n>>1),a=this.vector[o];if(e<a.Coord){i=o;continue}if(e>a.Coord){n=o;continue}return o}for(n++;n<=i;n++){let o=this.vector[n];if(e<o.Coord)return t>0?n:n-1;if(e==o.Coord)break}return n}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let n=t.FirstSegment;n!=null;n=n.NextSegment)n.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let n=t.NextSegment;n!=null;n=n.NextSegment){if(n.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&n.Start==t.End){let i=this.GetPerpendicularCoord(n.Start);t.AddSparseEndpoint(i),n.AddSparseEndpoint(i)}t=n}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count == ")+this.vector.length}};var mn=class extends Nt{constructor(e,t,n){super();this.InitialObstacle=e,this.ReflectingObstacle=t,this.site=n}static mk(e,t,n){let i=new mn(e.ReflectingObstacle,t,n);return i.PreviousSite=e,i}IsStaircaseStep(e){return this.InitialObstacle==e}get Site(){return this.site}};var Ed=class{constructor(){this.eventTree=new ws((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let n=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(n)return n;let i=e instanceof mn?0:1,o=t instanceof mn?0:1;return n=i-o,n||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var US=ne(Tt());var Gu=class{constructor(){this.pointCrossingMap=new Je;this.pointList=new Array}AddIntersection(e,t,n){let i=this.pointCrossingMap.get(e);i||(i=new Array,this.pointCrossingMap.set(e,i));let o=i.length;for(let l=0;l<o;l++){let u=i[l];if(u.Group==t)return u}let a=new tl(t,n);return i.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size==0)return null;if(N.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())N.ComparePP(o,e)>=0&&N.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let n=new qi,i=this.pointList.length;for(let o=0;o<i;o++){let a=this.pointList[o];n.Add(a,this.pointCrossingMap.get(a))}return n}toString(){return US.String.Format("{0}",this.pointCrossingMap.size)}};var xd=class extends mn{constructor(e,t,n){super(e.ReflectingObstacle,t.Obstacle,n);this.Side=t}};var Rm=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new ot((t,n)=>this.CompareBB(t,n)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let n=this.FindFirstInRange(e,t);n!=null;n=this.FindNextInRange(n,t))this.MarkStaleSite(n.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site==e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let n=this.eventTree.findFirst(this.findFirstPred);return n!=null&&this.Compare(n.item.Site,t)<=0?n:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let n=this.eventTree.next(e);return n!=null&&this.Compare(n.item.Site,t)<=0?n:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Cd=class extends Fs{constructor(e,t){super(e,t)}},Ad=class extends Fs{constructor(e,t){super(e,t)}},vd=class extends Fs{constructor(e,t){super(e,t)}};var Td=class extends mn{constructor(e,t,n){super(e.ReflectingObstacle,t.obstacle,n);this.Side=t}};var Id=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,n,i){if(j.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=n,this.GroupSideInterveningBeforeHighNeighbor=i;return}this.LowNeighbor=t,this.LowOverlapEnd=n,this.GroupSideInterveningBeforeLowNeighbor=i}};var wd=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],Kt.RoundVerticesAndSimplify(this.Polyline)}};var Yi=class{static MungeClosestIntersectionInfo(e,t,n){let i=t.seg1.boundingBox,o=E.RoundPoint(t.x).clone();return n?new p(Yi.MungeIntersect(e.x,o.x,i.left,i.right),o.y):new p(o.x,Yi.MungeIntersect(e.y,o.y,i.bottom,i.top))}static MungeIntersect(e,t,n,i){if(e<t){let o=Math.min(n,i);t<o&&(t=o)}else if(e>t){let o=Math.max(n,i);t>o&&(t=o)}return E.RoundDouble(t)}};var st=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new Gu;this.overlapPairs=new Yt;this.hasOverlaps=!1;this.lookupIntPair=new ae(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,n){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=n}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=Kt.FirstNonSentinelOrdinal;for(let n of this.allObstacles)n.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-Kt.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=st.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=st.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(xt(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let n={bIsInsideA:!1,aIsInsideB:!1};if(st.ObstaclesIntersect(e,t,n)){this.hasOverlaps=!0;return}!n.aIsInsideB&&!n.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&n.bIsInsideA||t.IsGroup&&n.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(n=>Ke(n,n.VisibilityBoundingBox));return _e(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=st.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&cr(e,e,(t,n)=>this.EvaluateOverlappedPairForClump(t,n))}EvaluateOverlappedPairForClump(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1};!st.ObstaclesIntersect(e,t,n)&&!n.aIsInsideB&&!n.bIsInsideA||this.overlapPairs.add(new ae(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=st.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&cr(e,e,(t,n)=>this.EvaluateOverlappedPairForConvexHull(t,n))}EvaluateOverlappedPairForConvexHull(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1};!st.ObstaclesIntersect(e,t,n)&&!n.aIsInsideB&&!n.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new ae(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=st.CalculateHierarchy(this.GetAllObstacles().filter(n=>n.IsGroup)),t=st.CalculateHierarchy(this.GetAllObstacles().filter(n=>n.IsPrimaryObstacle));e==null||t==null||cr(e,t,(n,i)=>this.EvaluateOverlappedPairForGroup(n,i))}EvaluateOverlappedPairForGroup(e,t){if(e==t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1},i=st.ObstaclesIntersect(e,t,n);if(!(!i&&!n.aIsInsideB&&!n.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(n.aIsInsideB||st.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!i&&(t.IsGroup||n.bIsInsideA)||this.overlapPairs.add(new ae(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return v.PointRelativeToCurveLocation(e.start,t)!=0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(n=>n.Ordinal!=e.Ordinal))this.overlapPairs.add(new ae(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(n=>n.Ordinal!=e.Ordinal))this.overlapPairs.add(new ae(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=Ba(Array.from(this.overlapPairs.values())),t=Di(e);for(let n of t){if(n.length==1)continue;let i=n.map(o=>this.OrdinalToObstacle(o));for(let o of i)o.clump=i}}CreateConvexHulls(){let e=!1,t=Ba(Array.from(this.overlapPairs.values())),n=Di(t);for(let i of n){if(i.length==1)continue;e=!0;let o=i.map(this.OrdinalToObstacle),a=ii(o,u=>Array.from(u.VisibilityPolyline)),l=new wd(Tr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let n=this.OrdinalToObstacle(t.x),i=this.OrdinalToObstacle(t.y);st.ResolveGroupAndGroupOverlap(n,i)||st.ResolveGroupAndObstacleOverlap(n,i)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?st.ResolveGroupAndObstacleOverlap(e,t):st.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let n=t.looseVisibilityPolyline;st.GrowGroupAroundLoosePolyline(e,n);let i={bIsInsideA:!1,aIsInsideB:!1};for(;st.ObstaclesIntersect(t,e,i)||!i.aIsInsideB;)n=Kt.CreateLoosePolyline(n),st.GrowGroupAroundLoosePolyline(e,n)}static GrowGroupAroundLoosePolyline(e,t){let n=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new wd(Tr.createConvexHullAsClosedPolyline(n),[e]))}static ObstaclesIntersect(e,t,n){return v.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(n.aIsInsideB=!1,n.bIsInsideA=!1,!0):(n.aIsInsideB=st.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),n.bIsInsideA=!n.aIsInsideB&&st.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:st.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,n.aIsInsideB,n.bIsInsideA)?(n.aIsInsideB=!1,n.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,n,i){if(!n&&!i)return v.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=n?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=n?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(v.PointRelativeToCurveLocation(l,a)==0){let u=v.ClosestPoint(a,l);if(!p.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let n=t.VisibilityBoundingBox;for(let i of this.Root.GetNodeItemsIntersectingRectangle(n))if(i!=t&&v.ClosedCurveInteriorsIntersect(i.VisibilityPolyline,t.VisibilityPolyline)){if(i.IsInConvexHull)for(let o of i.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(i.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let n=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(i=>!n.intersects(this.shapeIdToObstacleMap.get(i).VisibilityBoundingBox)));for(let i of e)this.AncestorSets.get(t.InputShape).delete(i);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,n){let i=j.RectangleBorderIntersect(this.GraphBox,e,t);if(N.GetDirections(e,i)==0)return n.pacList=null,R.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,i);return n.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,n,i){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=i,this.Root.FirstHitNodeWithPredicate(n,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,ft.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t==this.insideHitTestIgnoreObstacle1||t==this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!j.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let n=j.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),i=j.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=R.mkPP(i,n),a=v.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length==2){let l=E.RoundPoint(a[0].x),u=E.RoundPoint(a[1].x);if(!N.EqualPP(e,l)&&!N.EqualPP(e,u)&&e.compareTo(l)!=e.compareTo(u)&&!K(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let n=this.RestrictSegmentPrivate(e,t);return!N.EqualPP(n.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let n=this.RestrictSegmentPrivate(e,t);return!N.EqualPP(n.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=R.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let n=N.GetDirections(e,t),i=8==n?this.GraphBox.right:2==n?this.GraphBox.left:e.x,o=8==n?this.GraphBox.left:2==n?this.GraphBox.right:t.x,a=4==n?this.GraphBox.top*2:1==n?this.GraphBox.bottom:e.y,l=4==n?this.GraphBox.bottom:1==n?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=R.mkPP(new p(i,a),new p(o,l))}RecurseRestrictRayWithObstacles(e){if(!j.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let n=v.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(n);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,n);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,n=null,i=this.restrictedRayLengthSquared,o=N.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=E.RoundPoint(a.x),u=N.GetDirections(this.currentRestrictedRay.start,l);if(u==V.OppositeDir(o))continue;if(t++,0==u){i=0,n=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<i){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<E.squareOfDistanceEpsilon)continue;i=c,n=a}}if(n!=null){if(t==1){let a=E.RoundPoint(n.x);if(p.closeIntersections(a,this.currentRestrictedRay.start)||p.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=i,this.currentRestrictedRay.end=Yi.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,n,!j.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let n of t){let i=E.RoundPoint(n.x);if(i.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=N.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=n.seg1,u=V.VectorDirection(l.derivative(n.par1)),c=a;(u&V.RotateRight(a))!=0&&(c=V.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(i,e,c)}}};var Bm=class{constructor(e,t){this.scanDirection=e,this.SideTree=new ot((n,i)=>this.Compare(n,i)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)==-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return j.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle==t.Obstacle)return e==t?0:e instanceof fr?-1:1;let n=ks.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),i=ks.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=n.compareTo(i);if(o==0){let a=e instanceof fr,l=t instanceof fr;o=Iy(a,l),o==0&&(o=ye(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var rl=class{constructor(e){this.lookupSegment=be.mk(new p(0,0),new p(0,1));this.ScanDirection=e,this.segmentTree=new ot((t,n)=>this.Compare(t,n)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let n=this.segmentTree.find(this.lookupSegment);return n!=null&&N.EqualPP(n.item.End,t)?n.item:null}FindLowestIntersector(e,t){let n=this.FindLowestIntersectorNode(e,t);return n!=null?n.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let n=this.segmentTree.findLast(this.findIntersectorPred);if(N.EqualPP(e,t))n!=null&&this.ScanDirection.Compare(n.item.End,e)<0&&(n=null);else for(this.lookupSegment.Update(e,t);n!=null&&!n.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(n.item.Start,t)>0)return null;n=this.segmentTree.next(n)}return n}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let n=this.segmentTree.findLast(this.findIntersectorPred);if(N.EqualPP(e,t))n!=null&&this.ScanDirection.Compare(n.item.End,e)<0&&(n=null);else for(this.lookupSegment.Update(e,t);n!=null&&!n.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(n.item.End,e)<0)return null;n=this.segmentTree.previous(n)}return n!=null?n.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,n){this.lookupSegment.Update(e,t);let i=this.segmentTree.findFirst(this.findPointPred);if(i!=null){let o=i.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)==-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped==e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!=t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start==t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End==t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let i=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),i.Update(o.End,i.End),this.segmentTree.insert(i),i.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e==t)return 0;if(e==null)return-1;if(t==null)return 1;let n=this.ScanDirection.Compare(e.Start,t.Start);return n==0&&(n=this.ScanDirection.Compare(e.End,t.End)*-1),n}};var Mm=class extends ki{constructor(e){super(e)}SetVertexEntry(e){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[V.ToIndex(e.Direction)]=e}RemoveVertexEntries(){this.VertexEntries=null}};var It=class{constructor(e){this.ObstacleTree=new st;this.CurrentGroupBoundaryCrossingMap=new Gu;this.LowNeighborSides=new Id;this.HighNeighborSides=new Id;this.ScanDirection=ft.HorizontalInstance,this.eventQueue=new Ed,this.HorizontalScanSegments=new rl(ft.HorizontalInstance),this.VerticalScanSegments=new rl(ft.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new Me;return e.VertexFactory=t=>new Mm(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(ft.HorizontalInstance);let e=Kt.FirstSentinelOrdinal,t=new p(this.ObstacleTree.GraphBox.left-It.SentinelOffset,this.ObstacleTree.GraphBox.bottom-It.SentinelOffset),n=new p(this.ObstacleTree.GraphBox.left-It.SentinelOffset,this.ObstacleTree.GraphBox.top+It.SentinelOffset),i=Kt.CreateSentinel(t,n,this.ScanDirection,e++);this.scanLine.Insert(i.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new p(this.ObstacleTree.GraphBox.right+It.SentinelOffset,this.ObstacleTree.GraphBox.bottom-It.SentinelOffset),n=new p(this.ObstacleTree.GraphBox.right+It.SentinelOffset,this.ObstacleTree.GraphBox.top+It.SentinelOffset),i=Kt.CreateSentinel(t,n,this.ScanDirection,e++),this.scanLine.Insert(i.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(ft.VerticalInstance),t=new p(this.ObstacleTree.GraphBox.left-It.SentinelOffset,this.ObstacleTree.GraphBox.bottom-It.SentinelOffset),n=new p(this.ObstacleTree.GraphBox.right+It.SentinelOffset,this.ObstacleTree.GraphBox.bottom-It.SentinelOffset),i=Kt.CreateSentinel(t,n,this.ScanDirection,e++),this.scanLine.Insert(i.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new p(this.ObstacleTree.GraphBox.left-It.SentinelOffset,this.ObstacleTree.GraphBox.top+It.SentinelOffset),n=new p(this.ObstacleTree.GraphBox.right+It.SentinelOffset,this.ObstacleTree.GraphBox.top+It.SentinelOffset),i=Kt.CreateSentinel(t,n,this.ScanDirection,e),this.scanLine.Insert(i.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,n){let i=t.Direction,o=t.Start.x,a=t.Start.y;return n.IsHorizontal?(o+=i.x/i.y*(e.y-t.Start.y),o=Yi.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=i.y/i.x*(e.x-t.Start.x),a=Yi.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new p(o,a)}GetOpenVertex(e){let t=e.startPoint,n=this.TraversePolylineForEvents(t),i=this.PointCompare(n.point,t.point);for(;;n=this.TraversePolylineForEvents(n)){let o=this.PointCompare(n.point,t.point);if(o<=0)t=n;else if(o>0&&i<=0)break;i=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new Bm(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new Rm(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new Vs(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return It.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof fr?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof fr?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,n,i){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!i&&!j.PointIsInRectangleInterior(n,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(n)==null&&this.lookaheadScan.Add(new mn(e,t.Obstacle,n))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let n=k.mkPP(e.Start,e.End),i=k.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!n.intersectsOnX(i):!n.intersectsOnY(i))return;let o=k.intersect(n,i),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=It.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!=e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,n){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!j.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(n!=null&&e.IsStaircaseStep(n.Obstacle))return this.ScanLineCrossesObstacle(e.Site,n.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,n,i){{let o=this.ScanLineIntersectSide(i.Site,t!=null?t:n),a=t!=null?o:i.Site,l=t!=null?i.Site:o;return t==null?t=this.scanLine.NextLowB(n).item:n=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,n,i)}}AddReflectionEvent(e,t,n){let i=t;i!=null?this.eventQueue.Enqueue(new Td(e,i,n)):this.eventQueue.Enqueue(new xd(e,t,n))}AddSideToScanLine(e,t){let n=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),n}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Ed,this.HorizontalScanSegments=new rl(ft.HorizontalInstance),this.VerticalScanSegments=new rl(ft.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof Vs?this.ProcessEventO(e):e instanceof Cd?this.ProcessEventLB(e):e instanceof Ad?this.ProcessEventHB(e):e instanceof vd?this.ProcessEventCV(e):e instanceof Td?this.ProcessEventLR(e):e instanceof xd?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,n){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,n,this.HighNeighborSides)}FindNeighbors(e,t,n){let i=e instanceof Vs?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,i,o.lowNborSideNode,n),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,i,o.highNborSideNode,n)}SkipToNeighbor(e,t,n,i,o){let a=null,l=null;for(;;i=this.scanLine.Next(e,i))if(i.item.Obstacle!=t.Obstacle){if(i.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(i,n,e)&&l==null&&(l=i.item);continue}if(i.item instanceof Fo==j.IsAscending(e)){this.ScanLineCrossesObstacle(n,i.item.Obstacle)&&(a=i,l=null);continue}break}o.SetSides(e,i,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,n){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let i=e.item instanceof fr==j.IsAscending(n)?n:V.OppositeDir(n),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,i),!0}FindNeighborsAndProcessVertexEvent(e,t,n){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(n,e,t),this.ProcessVertexEvent(e,t,n),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let n=this.AddSideToScanLine(t.ActiveHighSide,e.Site),i=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(i,n,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!=t.ActiveLowSide.Start){let c=new Fo(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,n=new fr(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(n.End,n.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(n,e.Site),t.ActiveLowSide=n,this.EnqueueLowBendVertexEvent(n))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Cd(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,n=new Fo(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let i=this.AddSideToScanLine(n,e.Site);if(t.ActiveHighSide=n,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&n.Start.x==t.VisibilityBoundingBox.right&&this.SideReflectsUpward(n)){let o=this.scanLine.NextHighR(i);o.item instanceof fr&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(n.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,n,n.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,n=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(n.point,e.End)>0?this.eventQueue.Enqueue(new Ad(t,e.EndVertex)):this.eventQueue.Enqueue(new vd(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,n=this.scanLine.Find(t.ActiveLowSide),i=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)==1){let o=n;n=i,i=o}if(this.FindNeighborsAndProcessVertexEvent(n,i,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(n);o.item!=i.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,n=this.HighNeighborSides.HighNeighbor.item,i=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(n),i.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,n=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,n)&&this.AddParallelReflectionSegment(t,n,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,n=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,n)&&this.AddParallelReflectionSegment(t,null,n,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),n=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new p(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(n,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return N.EqualPP(e,this.MakeInBoundsLocation(e))}},ks=It;ks.SentinelOffset=1;var gr=class extends ks{constructor(){super(!1);this.horizontalVertexPoints=new Ve;this.verticalVertexPoints=new Ve;this.boundingBoxSteinerPoints=new Ve;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let e of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(e.VisibilityBoundingBox.left),this.xCoordAccumulator.add(e.VisibilityBoundingBox.right),this.yCoordAccumulator.add(e.VisibilityBoundingBox.top),this.yCoordAccumulator.add(e.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new Sd(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new Sd(this.xCoordAccumulator,!1);for(let e=0;e<this.horizontalScanSegmentVector.Length;e++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(e).Coord,e);for(let e=0;e<this.verticalScanSegmentVector.Length;e++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(e).Coord,e)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(e){super.InitializeEventQueue(e),this.SetVectorsAndCoordMaps(e),this.AddAxisCoordinateEvents(e)}AddAxisCoordinateEvents(e){if(e.IsHorizontal){for(let t of this.yCoordAccumulator)this.eventQueue.Enqueue(new Du(new p(this.ObstacleTree.GraphBox.left-gr.SentinelOffset,t)));return}for(let t of this.xCoordAccumulator)this.eventQueue.Enqueue(new Du(new p(t,this.ObstacleTree.GraphBox.bottom-gr.SentinelOffset)))}ProcessCustomEvent(e){this.ProcessAxisCoordinate(e)||this.ProcessCustomEvent(e)}ProcessAxisCoordinate(e){return e instanceof Du?(this.CreateScanSegmentsOnAxisCoordinate(e.Site),!0):!1}InsertPerpendicularReflectionSegment(e,t){return!1}InsertParallelReflectionSegment(e,t,n,i,o,a){return!1}ProcessVertexEvent(e,t,n){let i=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;i.add(n.Site);let o=this.LowNeighborSides.LowNeighbor.item,a=this.HighNeighborSides.HighNeighbor.item,l=this.ScanDirection.Dir,u=this.ScanDirection.OppositeDirection,c=this.ScanLineIntersectSide(n.Site,o),h=this.ScanLineIntersectSide(n.Site,a);if(this.ObstacleTree.GraphBox.contains(c)){let f=j.RectangleBorderIntersect(o.Obstacle.VisibilityBoundingBox,c,l);N.IsPureLower(f,n.Site)&&this.boundingBoxSteinerPoints.add(f)}if(this.ObstacleTree.GraphBox.contains(h)){let f=j.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);N.IsPureLower(n.Site,f)&&this.boundingBoxSteinerPoints.add(f)}let d={lowCorner:void 0,highCorner:void 0};gr.GetBoundingCorners(e.item.Obstacle.VisibilityBoundingBox,n instanceof Vs,this.ScanDirection.IsHorizontal,d),(N.IsPureLower(c,d.lowCorner)||o.Obstacle.IsInSameClump(n.Obstacle))&&i.add(d.lowCorner),(N.IsPureLower(d.highCorner,h)||a.Obstacle.IsInSameClump(n.Obstacle))&&i.add(d.highCorner)}static GetBoundingCorners(e,t,n,i){if(t){i.lowCorner=e.leftBottom,i.highCorner=n?e.rightBottom:e.leftTop;return}i.lowCorner=n?e.leftTop:e.rightBottom,i.highCorner=e.rightTop}CreateScanSegmentsOnAxisCoordinate(e){this.CurrentGroupBoundaryCrossingMap.Clear();let t=this.scanLine.Lowest(),n=this.scanLine.NextHighR(t),i=0,o=e,a=!1;for(;n!=null;n=this.scanLine.NextHighR(n)){if(this.SkipSide(o,n.item))continue;if(n.item.Obstacle.IsGroup){(i==0||a)&&this.HandleGroupCrossing(e,n.item);continue}if(n.item instanceof fr){if(i>0){i++;continue}o=this.CreateScanSegment(o,n.item,be.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),i=1,a=n.item.Obstacle.isOverlapped;continue}i++,!(i>0)&&(o=n.item.Obstacle.isOverlapped||n.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(o,n.item,be.OverlappedWeight):this.ScanLineIntersectSide(o,n.item),this.CurrentGroupBoundaryCrossingMap.Clear(),a=!1)}let l=this.ScanDirection.IsHorizontal?new p(this.ObstacleTree.GraphBox.right+gr.SentinelOffset,o.y):new p(o.x,this.ObstacleTree.GraphBox.top+gr.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(o,l,be.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o,l)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(e,t){if(!this.ScanLineCrossesObstacle(e,t.Obstacle))return;let n=t instanceof fr?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,i=this.ScanLineIntersectSide(e,t),o=this.CurrentGroupBoundaryCrossingMap.AddIntersection(i,t.Obstacle,n);this.AddPerpendicularCoordForGroupCrossing(i);let a=o.GetInteriorVertexPoint(i);this.AddPerpendicularCoordForGroupCrossing(a)}AddPerpendicularCoordForGroupCrossing(e){let t=this.FindPerpendicularSlot(e,0);t!=-1&&this.perpendicularSegmentVector.Item(t).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(e,t){if(t.Obstacle.IsSentinel)return!0;let n=t.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?e.y==n.bottom||e.y==n.top:e.x==n.left||e.x==n.right}CreateScanSegment(e,t,n){let i=this.ScanLineIntersectSide(e,t);return e!=i&&this.parallelSegmentVector.CreateScanSegment(e,i,n,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(e,i)),i}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=gr.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=wa;let e=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=ft.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(n,i)=>n.compareTo(i);let e=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=ft.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}SetVectorsAndCoordMaps(e){e.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(e,t){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let n=1,i={j:0};for(let o of this.parallelSegmentVector.Items())for(;!(!o.CurrentSegment.ContainsPoint(e[n])&&(!this.AddSteinerPointsToInterveningSegments(e[n],t,i,o)||!o.TraverseToSegmentContainingPoint(e[n])));){if(this.AddPointsToCurrentSegmentIntersections(t,i,o),this.GenerateIntersectionsFromVertexPointForCurrentSegment(e[n],o),o.PointIsCurrentEndAndNextStart(e[n])){o.MoveNext();continue}if(++n>=e.length)return}}AddSteinerPointsToInterveningSegments(e,t,n,i){for(;n.j<t.length&&this.currentAxisPointComparer(t[n.j],e)==-1;){if(!i.TraverseToSegmentContainingPoint(t[n.j]))return!1;this.AddPointsToCurrentSegmentIntersections(t,n,i)}return!0}AddPointsToCurrentSegmentIntersections(e,t,n){for(;t.j<e.length&&n.CurrentSegment.ContainsPoint(e[t.j]);t.j++){let i=this.FindPerpendicularSlot(e[t.j],0);this.AddSlotToSegmentIntersections(n,i)}}GenerateIntersectionsFromVertexPointForCurrentSegment(e,t){let n=this.FindPerpendicularSlot(t.CurrentSegment.Start,1),i=this.FindPerpendicularSlot(t.CurrentSegment.End,-1),o=this.FindPerpendicularSlot(e,0);n>=i||(this.AddSlotToSegmentIntersections(t,n),this.AddSlotToSegmentIntersections(t,i),o>n&&o<i&&(this.AddSlotToSegmentIntersections(t,o),this.AddBinaryDivisionSlotsToSegmentIntersections(t,n,o,i)))}FindPerpendicularSlot(e,t){return gr.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,e,t)}static FindIntersectingSlot(e,t,n,i){let o=e.GetParallelCoord(n),a=t.get(o);return a!=null?a:i==0?-1:e.FindNearest(o,i)}AddSlotToSegmentIntersections(e,t){let n=this.perpendicularSegmentVector.Item(t);e.CurrentSegment.AddSparseVertexCoord(n.Coord),n.AddPerpendicularCoord(e.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(e,t,n,i){let o=0,a=this.perpendicularSegmentVector.Length-1;for(;a-o>1;){let l=o+Math.floor((a-o)/2);if(n<=l){a=l,n<a&&a<=i&&this.AddSlotToSegmentIntersections(e,a);continue}o=l,n>o&&o>=t&&this.AddSlotToSegmentIntersections(e,o)}}CreateScanSegmentTrees(){gr.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),gr.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(e,t){for(let n of e.Items())for(let i=n.FirstSegment;i!=null;i=i.NextSegment)i.HasVisibility()&&t.InsertUnique(i)}};var wr=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof gr}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,be.NormalWeight)}FindOrAddEdge(e,t,n){let i=N.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};wr.GetBrackets(e,t,i,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,n),a}static GetBrackets(e,t,n,i){if(i.splitVertex=t,!wr.FindBracketingVertices(e,t.point,n,i)){let o={bracketSource:null,bracketTarget:null};wr.FindBracketingVertices(t,e.point,V.OppositeDir(n),o)&&(i.bracketSource=o.bracketTarget,i.splitVertex=e),i.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,n,i){for(i.bracketSource=e;i.bracketTarget=j.FindAdjacentVertex(i.bracketSource,n),i.bracketTarget!=null;){if(p.closeDistEps(i.bracketTarget.point,t))return!0;if(n!=N.GetDirections(i.bracketTarget.point,t))break;i.bracketSource=i.bracketTarget}return i.bracketTarget!=null}CreateEdge(e,t,n){let i=e,o=t;N.IsPureLower(i.point,o.point)||(i=t,o=e);let a=new Ut(i,o,n);return Me.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&Me.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)Me.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return j.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,n){for(;;){let i=j.FindAdjacentVertex(e,t);if(i==null)break;let o=N.GetDirections(i.point,n);if((V.OppositeDir(t)&o)!=0)return this.VisGraph.FindEdgePP(e.point,i.point);e=i}return null}FindNearestPerpendicularOrContainingEdge(e,t,n){let i;t&N.GetDirections(e.point,n);let o=e,a=i;for(;0!=a;){let u=j.FindAdjacentVertex(o,i);if(u==null||(V.OppositeDir(i)&N.GetDirections(u.point,n))!=0)break;o=u,t&N.GetDirections(o.point,n)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,n),!(l!=null||o==e);)o=j.FindAdjacentVertex(o,V.OppositeDir(i));return l}ConnectVertexToTargetVertex(e,t,n,i){if(p.closeDistEps(e.point,t.point))return;let o=N.GetDirections(e.point,t.point);if(N.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=j.FindBendPointBetween(e.point,t.point,n),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,i),this.FindOrAddEdge(l,t,i)}AddEdgeToTargetEdge(e,t,n){let i=this.VisGraph.FindVertex(n);return i==null&&(i=this.AddVertex(n),this.SplitEdge(t,i)),this.FindOrAddEdgeVV(e,i),i}SplitEdge(e,t){return e==null?null:p.closeDistEps(e.Source.point,t.point)||p.closeDistEps(e.Target.point,t.point)?e:(e instanceof Ut||this.edgesToRestore.push(e),Me.RemoveEdge(e),(this.IsSparseVg||e.Weight==be.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,n,i,o){let a=N.GetDirections(n.start,n.end);if(a==0)return;let l=j.GetRectangleBound(t,a),u=j.IsVerticalD(a)?E.RoundPoint(new p(e.point.x,l)):E.RoundPoint(new p(l,e.point.y));if(p.closeDistEps(u,e.point)||N.GetDirections(e.point,u)!=a)return;let c=n;N.GetDirections(u,c.end)==a&&(c=R.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,n,i,o)}ExtendEdgeChain(e,t,n,i,o,a){if(N.GetDirections(e.point,n.end)!=t)return;let u=V.RotateLeft(t),c=j.FindAdjacentVertex(e,u);if(c==null&&(u=V.OppositeDir(u),c=j.FindAdjacentVertex(e,u),c==null))return;let h=V.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,n,i,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,n,i,a,d),this.SpliceGroupBoundaryCrossings(o,e,n)}SpliceGroupBoundaryCrossings(e,t,n){if(e==null||e.Count()==0)return;e.Reset();let i=n.start,o=n.end,a=N.GetDirections(i,o);j.IsAscending(a)||(i=n.end,o=n.start,a=V.OppositeDir(a)),t=wr.TraverseToFirstVertexAtOrAbove(t,i,V.OppositeDir(a));for(let l=t;l!=null;l=j.FindAdjacentVertex(l,a)){let u=N.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();N.ComparePP(c.Location,t.point)>0&&N.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,V.OppositeDir(a)),N.ComparePP(c.Location,t.point)>=0&&N.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,n){let i=e,o=V.OppositeDir(n);for(;;){let a=j.FindAdjacentVertex(i,n);if(a==null||N.GetDirections(a.point,t)==o)break;i=a}return i}SpliceGroupBoundaryCrossing(e,t,n){var o,a;let i=qi.ToCrossingArray(t.Crossings,n);if(i!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=i[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=i.map(f=>f.Group.InputShape);h.IsPassable=()=>d.some(f=>f.IsTransparent)}}ExtendSpliceWorker(e,t,n,i,o,a,l){let u=j.FindAdjacentVertex(e,n);l.spliceTarget=j.FindAdjacentVertex(u,n);let c={spliceSource:e};for(;wr.GetNextSpliceSource(c,n,t);){let h=j.FindBendPointBetween(u.point,c.spliceSource.point,V.OppositeDir(n));if(wr.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=wr.GetSpliceTarget(c,n,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?be.OverlappedWeight:be.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?be.OverlappedWeight:be.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?be.OverlappedWeight:be.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&N.GetDirections(h,i.end))==0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,n){let i=j.FindAdjacentVertex(e.spliceSource,n);if(i==null)for(i=e.spliceSource;;){if(i=j.FindAdjacentVertex(i,V.OppositeDir(t)),i==null)return!1;let o=j.FindAdjacentVertex(i,n);if(o!=null){i=o;break}}return e.spliceSource=i,!0}static GetSpliceTarget(e,t,n){let i=N.GetDirections(e.spliceSource.point,n),o=i,a=e.spliceSource;for(;o==i&&(e.spliceSource=a,a=j.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(p.closeDistEps(a.point,n)){a=j.FindAdjacentVertex(a,t);break}o=N.GetDirections(a.point,n)}return a}SeeIfSpliceIsStillOverlapped(e,t){let n=this.FindNextEdge(t,V.RotateLeft(e)),i=n==null?!1:be.NormalWeight==n.Weight;return i||(n=this.FindNextEdge(t,V.RotateRight(e)),i=n==null?!1:be.NormalWeight==n.Weight),!i||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(wr.IsSkippableSpliceSourceEdgeWithNullTarget(j.FindAdjacentEdge(e,t)))return!0;let n=j.FindAdjacentEdge(e,V.OppositeDir(t));return wr.IsSkippableSpliceSourceEdgeWithNullTarget(n)||wr.IsReflectionEdge(n)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&K(e.Length,tl.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight==be.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return N.GetDirections(e.start,e.end)==N.GetDirections(e.end,t)}toString(){return zS.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var Us=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new Je;this.freePointLocationsUsedByRouteEdges=new Ve;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new wr(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let n=E.RoundPoint(t.Location);if(0==v.PointRelativeToCurveLocation(n,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!=t.Curve&&0==v.PointRelativeToCurveLocation(n,t.Curve))return null;let i=new wm(t,e);return this.obstaclePortMap.set(t,i),i}FindVertices(e){let t=new Array,n=this.obstaclePortMap.get(e);if(n)if(this.RouteToCenterOfObstacles)t.push(n.CenterVertex);else for(let i of n.PortEntrances){let o=this.VisGraph.FindVertex(i.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(E.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let n={oport:null},i={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);if(this.AncestorSets.size>0&&n.oport!=null&&i.oport!=null){let l=Vi(a,o),u=Vi(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,n.oport),this.AddPortToGraph(e.targetPort,i.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let n=this.FindVertices(t),i=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,i,n),i=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,i,n)}ConnectToGraphAtPointsCollinearWithVertices(e,t,n){if(0==t)return;let i=V.OppositeDir(t);for(let o of n){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,i,be.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size==0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let n={oport:null},i={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size==0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(k.mkPP(e.Location,e.Location),n=>n.IsGroup)).map(n=>n.InputShape))}ActivateAncestors(e,t,n){for(let i of Ln(e,t)){let o=n.get(i);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=k.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let n={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(n)){for(let i of n.addedPorts)this.CreateObstaclePort(t.Obstacle,i);for(let i of n.removedPorts)this.RemoveObstaclePort(i);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),n=this.FindObstaclePort(e.targetPort);if(t==null||n==null||t.Obstacle.IsInConvexHull||n.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(n),!t.VisibilityRectangle.intersects(n.VisibilityRectangle)))return null;for(let i of t.PortEntrances)if(!!i.WantVisibilityIntersection)for(let o of n.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=i.IsVertical==o.IsVertical?Us.GetPathPointsFromOverlappingCollinearVisibility(i,o):Us.GetPathPointsFromIntersectingVisibility(i,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!j.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||p.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let n=j.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!n||e.HasGroupCrossingBeforePoint(n)||t.HasGroupCrossingBeforePoint(n)?null:[e.UnpaddedBorderIntersect,n,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,n=k.mkPP(E.RoundPoint(e.PortCurve.boundingBox.leftBottom),E.RoundPoint(e.PortCurve.boundingBox.rightTop)),i=E.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!N.Equal(i.y,n.top)&&!N.Equal(i.y,n.bottom)){o=!0;let l=new R(t.left,i.y,t.right,i.y);this.GetBorderIntersections(i,l,e.PortCurve,a);let u=new p(Math.min(a.xx0.x,a.xx1.x),i.y);u.x<n.left&&(u=new p(n.left,u.y));let c=new p(Math.max(a.xx0.x,a.xx1.x),i.y);c.x>n.right&&(c=new p(n.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(n,e,i,u,c)}if(!N.Equal(i.x,n.left)&&!N.Equal(i.x,n.right)){o=!0;let l=new R(i.x,t.bottom,i.x,t.top);this.GetBorderIntersections(i,l,e.PortCurve,a);let u=new p(i.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new p(u.x,t.bottom));let c=new p(i.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new p(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(n,e,i,u,c)}o||this.CreateEntrancesForCornerPort(n,e,i)}GetBorderIntersections(e,t,n,i){let o=v.getAllIntersections(t,n,!0);i.xx0=E.RoundPoint(o[0].x),i.xx1=E.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,n,i,o){let a=N.GetDirections(i,o);N.EqualPP(i,n)||this.CreatePortEntrance(e,t,o,a),N.EqualPP(o,n)||this.CreatePortEntrance(e,t,i,V.OppositeDir(a))}static GetDerivative(e,t){let n=e.PortCurve.closestParameter(t),i=e.PortCurve.derivative(n),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return Gt.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(i=i.mul(-1)),i}CreatePortEntrance(e,t,n,i){t.CreatePortEntrance(n,i,this.ObstacleTree);let o=ft.GetInstance(i),a=j.GetRectangleBound(e,i)-o.Coord(n);if(a<0&&(a=-a),a>E.intersectionEpsilon){let l=V.VectorDirection(Us.GetDerivative(t,n)),u;i|V.OppositeDir(i),0!=(i&l)&&(u=V.OppositeDir(u)),t.CreatePortEntrance(n,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,n){let i=1;N.EqualPP(n,e.leftBottom)?i=4:N.EqualPP(n,e.leftTop)?i=8:N.EqualPP(n,e.rightTop)?i=1:N.EqualPP(n,e.rightBottom)&&(i=2),t.CreatePortEntrance(n,i,this.ObstacleTree),t.CreatePortEntrance(n,V.RotateRight(i),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let n={targetVertex:null},i=e.IsOverlapped?be.OverlappedWeight:be.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,i,n)!=null&&e.AddToAdjacentVertex(this.TransUtil,n.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return j.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,n,i){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,n,i,o)}FindorCreateNearestPerpEdgePPDNT(e,t,n,i,o){let a=j.SortAscending(e,t),l=a[0],u=a[1],c=j.IsVerticalD(n)?this.HScanSegments:this.VScanSegments,h=j.IsAscending(n)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=j.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(j.IsAscending(n)?l:u,h,d,i,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,n,i,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(n),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,n,t,i,a);if(d!=null)return d}else if(N.EqualPP(e,n))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,V.OppositeDir(t.ScanDirection.Dir));let l=N.GetDirections(n,e),u=N.GetDirections(a.segsegVertex.point,e);if(l==u){let d={bracketTarget:null,bracketSource:null};return wr.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,V.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,V.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(n),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=j.GetEdgeEnd(c,V.OppositeDir(u)),n=j.SegmentIntersectionPPP(e,n,a.segsegVertex.point),N.EqualPP(a.segsegVertex.point,n)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(n),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,i)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,n,i,o){let l=(n.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(n.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,n.LowestVisibilityVertex,n.Weight);let u=j.SegmentsIntersection(n,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(n,o.segsegVertex,n.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),N.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return N.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,i)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,n){return N.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,n):N.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,n):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():k.mkOnPoints([E.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new Lm(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=E.RoundPoint(e);let t=this.VisGraph.FindVertex(e),n=this.FindOrCreateFreePoint(e);if(t!=null)return n;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(n),n;let i=null;n.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(n.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};i=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,n.InitialWeight,l)}let a=4;if(i!=null)a=j.EdgeDirectionVE(i),this.ConnectFreePointToLateralEdge(n,V.RotateLeft(a)),this.ConnectFreePointToLateralEdge(n,V.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(n,a),a=V.RotateLeft(a);return n}CreateOutOfBoundsFreePoint(e){let t=e.Point,n=this.graphGenerator.MakeInBoundsLocation(t),i=N.GetDirections(n,t);if(e.OutOfBoundsDirectionFromGraph=i,!N.IsPureDirectionD(i)){e.AddOobEdgesFromGraphCorner(this.TransUtil,n);return}let o=this.VisGraph.FindVertex(n),a=V.OppositeDir(i);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,n,i,be.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=j.FindAdjacentVertex(o,V.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,be.NormalWeight);let u=j.FindAdjacentVertex(o,V.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,be.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let n=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),i=this.FindorCreateNearestPerpEdgePPDN(n,e.Point,t,e.InitialWeight);i!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,i,t,this.portSpliceLimitRectangle)}};var _t=class extends me{constructor(e,t,n,i,o){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.UseObstacleRectangles=!1;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=t,this.CornerFitRadius=n,this.BendPenaltyAsAPercentageOfDistance=pn.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new gr,this.UseObstacleRectangles=o,this.PortManager=new Us(this.GraphGenerator),this.AddShapes(e)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(e){this.PortManager.RouteToCenterOfObstacles=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=e}AddEdgeGeometryToRoute(e){p.closeDistEps(E.RoundPoint(e.sourcePort.Location),E.RoundPoint(e.targetPort.Location))?this.selfEdges.push(e):this.EdgesToRoute.push(e)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof gr}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.PaddedPolyline)}AddObstacles(e){this.AddShapes(e),this.RebuildTreeAndGraph()}AddShapes(e){for(let t of e)this.AddObstacleWithoutRebuild(t)}AddObstacle(e){this.AddObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}UpdateObstacles(e){for(let t of e)this.UpdateObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}UpdateObstacle(e){this.UpdateObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}RemoveObstacles(e){for(let t of e)this.RemoveObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}RemoveObstacle(e){this.RemoveObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(e)}UpdateObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(e)),this.CreatePaddedObstacle(e)}CreatePaddedObstacle(e){let t=new Kt(e,this.UseObstacleRectangles,this.Padding);this.ShapeToObstacleMap.set(e,t),this.PortManager.CreateObstaclePorts(t)}RemoveObstacleWithoutRebuild(e){let t=this.ShapeToObstacleMap.get(e);this.ShapeToObstacleMap.delete(e),this.PortManager.RemoveObstaclePorts(t)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let e=this.ObsTree.Root!=null,t=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),e&&this.GenerateObstacleTree(),t&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return _t.constructorC(null)}static constructorC(e){return new _t([],_t.DefaultPadding,_t.DefaultCornerFitRadius,!1,!1)}static constructorI(e){return new _t(e,_t.DefaultPadding,_t.DefaultCornerFitRadius,!1,!1)}static constructorINNB(e,t,n,i){return new _t(e,t,n,i,!1)}static constructorGNANB(e,t,n,i,o){return this.constructorGNANBB(e,t,n,i,o,!1)}static constructorGNANBB(e,t,n,i,o,a){let l=new _t(hr.GetShapes(e),n,i,o,a);if(t==null)for(let u of e.edges())l.AddEdgeGeometryToRoute(u);else for(let u of t)l.AddEdgeGeometryToRoute(u);return l}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let e=this.EdgesToRoute.map(t=>new vm(t));this.FillEdgePathsWithShortestPaths(e),this.NudgePaths(e),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let e of this.selfEdges){let t={smoothedPolyline:null};e.curve=Ge.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.Padding,2*e.GetMaxArrowheadLength()),t)}}FillEdgePathsWithShortestPaths(e){this.PortManager.BeginRouteEdges();let t=new Gs(this.BendPenaltyAsAPercentageOfDistance);for(let n of e)this.AddControlPointsAndGeneratePath(t,n);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(e,t){let n=this.PortManager.GetPortVisibilityIntersection(t.GeomEdge);if(n!=null){this.GeneratePathThroughVisibilityIntersection(t,n);return}this.SpliceVisibilityAndGeneratePath(e,t)}GeneratePathThroughVisibilityIntersection(e,t){e.PathPoints=t}SpliceVisibilityAndGeneratePath(e,t){this.PortManager.AddControlPointsToGraph(t.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(e,t,!1)||this.RetryPathsWithAdditionalGroupsEnabled(e,t),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(e,t,n){let i=this.PortManager.FindVertices(t.GeomEdge.sourcePort),o=this.PortManager.FindVertices(t.GeomEdge.targetPort);return _t.GetSingleStagePath(t,e,i,o,n)}static GetSingleStagePath(e,t,n,i,o){return e.PathPoints=t.GetPath(n,i),o&&_t.EnsureNonNullPath(e),e.PathPoints!=null&&e.PathPoints.length>0}static EnsureNonNullPath(e){e.PathPoints==null&&(N.IsPureDirection(e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location)?e.PathPoints=[e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location]:e.PathPoints=[e.GeomEdge.sourcePort.Location,new p(e.GeomEdge.sourcePort.Location.x,e.GeomEdge.targetPort.Location.y),e.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(e,t){(!this.PortManager.SetAllAncestorsActive(t.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(e,t,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(e,t,!0))}NudgePaths(e){let t=this.ObsTree.SpatialAncestorsAdjusted?Xe.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;Ze.NudgePaths(e,this.CornerFitRadius,this.PaddedObstacles,t,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(e){this.removeStaircases=e}FinaliseEdgeGeometries(){for(let e of this.EdgesToRoute.concat(this.selfEdges)){if(e.curve==null)continue;e.curve instanceof $&&(e.curve=_t.FitArcsIntoCorners(this.CornerFitRadius,Array.from(e.curve))),_t.CalculateArrowheads(e)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(e){Xt.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=Xe.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(e){this.GraphGenerator.Clear(),this.ClearShortestPaths(),e?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let e of this.EdgesToRoute)e.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length==0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(e,t){let n=_t.GetFittedArcSegs(e,t),i=new v,o=null;for(let a of n){let l=_t.EllipseIsAlmostLineSegment(a);o!=null?l?v.continueWithLineSegmentP(i,_t.CornerPoint(a)):(v.continueWithLineSegmentP(i,a.start),i.addSegment(a)):l?v.addLineSegment(i,t[0],_t.CornerPoint(a)):(v.addLineSegment(i,t[0],a.start),i.addSegment(a)),o=a}return i.segs.length>0?v.continueWithLineSegmentP(i,t[t.length-1]):v.addLineSegment(i,t[0],t[t.length-1]),i}static CornerPoint(e){return e.center.add(e.aAxis.add(e.bAxis))}static EllipseIsAlmostLineSegment(e){return e.aAxis.lengthSquared<1e-4||e.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(e,t){let n=t[1].sub(t[0]),i=n.normalize(),o=Math.min(e,n.length/2);for(let a=1;a<t.length-1;a++){n=t[a+1].sub(t[a]);let l=n.length;if(l<E.intersectionEpsilon){yield new fe(0,0,new p(0,0),new p(0,0),t[a]);continue}let u=n.div(l);Math.abs(u.dot(i))>.9&&(yield new fe(0,0,new p(0,0),new p(0,0),t[a]));let c=Math.min(e,n.length/2),h=u.mul(-c),d=i.mul(o);yield new fe(0,Math.PI/2,h,d,t[a].sub(d.add(h))),i=u,o=c}}},nl=_t;nl.DefaultPadding=1,nl.DefaultCornerFitRadius=3;var _u=class extends me{constructor(e,t,n){super(null);this.graph=e,this.source=t,this.length=n}get Result(){return this.result}run(){let e=new Zt((i,o)=>i-o),t=new Map;for(let i of this.graph.shallowNodes()){let o=i==this.source?0:Number.POSITIVE_INFINITY;e.Enqueue(i,o),t.set(i,o)}for(;e.count>0;){let i={priority:0},o=e.DequeueAndGetPriority(i);t.set(o,i.priority);let a=t.get(o);for(let l of o.inEdges()){let u=l.source,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}for(let l of o.outEdges()){let u=l.target,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}}this.result=new Array(this.graph.shallowNodeCount);let n=0;for(let i of this.graph.shallowNodes()){let o=t.get(i);o!=null?this.result[n++]=o:this.result[n++]=Number.POSITIVE_INFINITY}}};var Fu=class extends me{get Result(){return this.result}set Result(e){this.result=e}constructor(e,t){super(null);this.graph=e,this.length=t}run(){this.result=new Array(this.graph.shallowNodeCount);let e=0;for(let t of this.graph.shallowNodes()){let n=new _u(this.graph,t,this.length);n.run(),this.Result[e++]=n.Result}}static Stress(e,t){let n=0;if(e.edgeCount==0)return n;let i=new Fu(e,t);i.run();let o=i.Result,a=0;for(let u of e.edges())a+=t(u);a/=e.edgeCount;let l=0;for(let u of e.shallowNodes()){let c=0;for(let h of e.shallowNodes()){if(l!=c){let d=u.center.sub(h.center).length,f=a*o[l][c],y=f-d;n+=y*y/(f*f)}c++}l++}return n}};var Nm=class extends me{get Result(){return this.result}constructor(e,t,n){super(null);this.graph=e,this.pivotArray=t,this.length=n}run(){this.result=new Array(this.pivotArray.length);let e=Array.from(this.graph.shallowNodes()),t=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),n=e[0];this.pivotArray[0]=0;for(let i=0;;i++){let o=new _u(this.graph,n,this.length);if(o.run(),this.Result[i]=o.Result,i+1<this.pivotArray.length){let a=0;for(let l=0;l<this.Result[i].length;l++)t[l]=Math.min(t[l],this.Result[i][l]),t[l]>t[a]&&(a=l);n=e[a],this.pivotArray[i+1]=a}else break}}};var Dm=class{static Rotate(e,t,n){let i=Math.sin(n*(Math.PI/180)),o=Math.cos(n*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+i*t[a];t[a]=o*t[a]-i*e[a],e[a]=l}}};var Ye=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),n=new Array(e[0].length).fill(0),i=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],n[a]+=e[o][a],i+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)n[o]/=e[0].length;i/=e.length,i/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+n[a]-i}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let n=0;n<e[0].length;n++)e[t][n]=Math.pow(e[t][n],2)}static Multiply(e,t){for(let n=0;n<e.length;n++)for(let i=0;i<e[0].length;i++)e[n][i]*=t}static MultiplyX(e,t){if(e[0].length!=t.length)return null;let n=new Array(t.length).fill(0);for(let i=0;i<e.length;i++)for(let o=0;o<e[0].length;o++)n[i]+=e[i][o]*t[o];return n}static Norm(e){let t=0;for(let n=0;n<e.length;n++)t+=Math.pow(e[n],2);return Math.sqrt(t)}static Normalize(e){let t=Ye.Norm(e);if(t<=0)return 0;for(let n=0;n<e.length;n++)e[n]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let n=0;n<e;n++)t[n]=Tu();return Ye.Normalize(t),t}static SpectralDecomposition(e,t){Ye.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,n,i){let o=e[0].length;t.u1=Ye.RandomUnitLengthVector(o),t.lambda1=0,t.u2=Ye.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-i;for(let u=0;u<n&&a<l;u++){let c=Ye.MultiplyX(e,t.u1),h=Ye.MultiplyX(e,t.u2);t.lambda1=Ye.Normalize(c),t.lambda2=Ye.Normalize(h),Ye.MakeOrthogonal(h,c),Ye.Normalize(h),a=Math.min(Ye.DotProduct(t.u1,c),Ye.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!=t.length)return 0;let n=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i];return n}static MakeOrthogonal(e,t){if(e.length!=t.length)return;let n=Ye.DotProduct(e,t)/Ye.DotProduct(t,t);for(let i=0;i<e.length;i++)e[i]-=n*t[i]}static ClassicalScaling(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=e[i].slice();Ye.SquareEntries(n),Ye.DoubleCenter(n),Ye.Multiply(n,-.5),Ye.SpectralDecomposition(n,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let i=0;i<t.u1.length;i++)t.u1[i]*=t.lambda1,t.u2[i]*=t.lambda2}static DistanceScalingSubset(e,t,n,i,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]==0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!=d&&(c[h]+=i[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let f=0,y=0;for(let S=0;S<a;S++)if(d!=S){let C=Math.sqrt(Math.pow(t[u[d]]-t[S],2)+Math.pow(n[u[d]]-n[S],2));C>0&&(C=1/C),f+=i[d][S]*(t[S]+e[d][S]*(t[u[d]]-t[S])*C),y+=i[d][S]*(n[S]+e[d][S]*(n[u[d]]-n[S])*C)}t[u[d]]=f/c[d],n[u[d]]=y/c[d]}}static DistanceScaling(e,t,n,i,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!=c&&(l[u]+=i[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let f=0;f<a;f++)if(c!=f){let y=Math.sqrt(Math.pow(t[c]-t[f],2)+Math.pow(n[c]-n[f],2));y>0&&(y=1/y),h+=i[c][f]*(t[f]+e[c][f]*(t[c]-t[f])*y),d+=i[c][f]*(n[f]+e[c][f]*(n[c]-n[f])*y)}t[c]=h/l[c],n[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++){n[i]=new Array(e[i].length).fill(0);for(let o=0;o<e[i].length;o++)e[i][o]>0&&(n[i][o]=Math.pow(e[i][o],t))}return n}static EuclideanDistanceMatrix(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++){n[i]=new Array(e.length);for(let o=0;o<e.length;o++)n[i][o]=Math.sqrt(Math.pow(e[i]-e[o],2)+Math.pow(t[i]-t[o],2))}return n}static LandmarkClassicalScaling(e,t,n){let i=new Array(e.length);for(let l=0;l<e.length;l++){i[l]=new Array(e.length);for(let u=0;u<e.length;u++)i[l][u]=e[l][n[u]]}Ye.SquareEntries(i);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=i[l][u];o[l]/=e.length}Ye.DoubleCenter(i),Ye.Multiply(i,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};Ye.SpectralDecomposition(i,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<i.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var WS=ne(Tt());var Gm=class{constructor(e,t){this.Constrained=!1;this.Capacity=1e6;$e.AbovePP(e.point,t.point)==1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e==this.upperSite||e==this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle==e?this.cwTriangle:this.ccwTriangle}toString(){return WS.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite==e?this.lowerSite:this.upperSite}};var zs=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let n=new zs(e);return n.Owner=t,n}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite==e)return t}return null}AddInEdge(e){this.InEdges==null&&(this.InEdges=new Array),this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let n=t.upperSite==this?t.CcwTriangle:t.CwTriangle;if(n==null){t=null;break}yield n,t=n.TriEdges.getItem(n.TriEdges.index(t)+2)}while(t!=e);if(t!=e){t=e;do{let n=t.upperSite==this?t.CwTriangle:t.CcwTriangle;if(n==null)break;yield n,t=n.TriEdges.getItem(n.TriEdges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var Fm=ne(fn());var $i=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite==e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var Ld=class{has(e){return e==this.item0||e==this.item1||e==this.item2}index(e){return e==this.item0?0:e==this.item1?1:e==this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var Lr=class{constructor(){this.TriEdges=new Ld;this.Sites=new Ld}static mkSSSD(e,t,n,i){let o=p.getTriangleOrientation(e.point,t.point,n.point),a=new Lr;switch(o){case 1:a.FillCcwTriangle(e,t,n,i);break;case 0:a.FillCcwTriangle(e,n,t,i);break;default:throw new Error}return a}static mkSED(e,t,n){let i=new Lr;switch(p.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=i,i.Sites.setItem(0,t.upperSite),i.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=i,i.Sites.setItem(0,t.lowerSite),i.Sites.setItem(1,t.upperSite);break;default:throw new Error}return i.TriEdges.setItem(0,t),i.Sites.setItem(2,e),i.CreateEdge(1,n),i.CreateEdge(2,n),i}static mkSSSEE(e,t,n,i,o,a){let l=Lr.mkSSSD(e,t,n,a);return l.TriEdges.setItem(0,i),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,i),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e==t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,n,i){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,n);for(let o=0;o<3;o++)this.CreateEdge(o,i)}CreateEdge(e,t){let n=this.Sites.getItem(e),i=this.Sites.getItem(e+1),o=t(n,i);this.TriEdges.setItem(e,o),this.BindEdgeToTriangle(n,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.TriEdges.getItem(t+1)}OppositeSite(e){let t=this.TriEdges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=k.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,n,i,o,a){let l=new Lr;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,n),l.TriEdges.setItem(0,i),l.TriEdges.setItem(1,o),l.BindEdgeToTriangle(e,i),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var _m=class{constructor(e,t,n,i,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=n,this.leftPolygon=i,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(p.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite==this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,n=(o=t.CcwTriangle)!=null?o:t.CwTriangle,i=n.TriEdges.index(t);for(let a=1;a<=2;a++){let l=n.TriEdges.getItem(a+i),u=lr.sign(p.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(lr.sign(p.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=n,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.TriEdges)if(t.CcwTriangle==null&&t.CwTriangle==null){let n=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,i=wt.FindNodeInFrontBySite(this.front,n);i.item.Edge==t&&this.elementsToBeRemovedFromFront.push(i.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle==this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var n,i;let e=(n=this.piercedEdge.CwTriangle)!=null?n:this.piercedEdge.CcwTriangle,t=e.TriEdges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.TriEdges.getItem(o+t),l=lr.sign(p.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(lr.sign(p.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=wt.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((i=a.CwTriangle)!=null?i:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.TriEdges)t.CwTriangle==e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(p.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite==this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!=this.b&&(t.length==0||t[t.length-1]!=e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=wt.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(p.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(p.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let n of this.a.Edges){let i=n.CcwTriangle;if(i==null||p.pointToTheLeftOfLine(this.b.point,n.lowerSite.point,n.upperSite.point))continue;let o=i.TriEdges.index(n),a=i.Sites.getItem(o+2);if(p.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,n.upperSite.point)){this.piercedEdge=i.TriEdges.getItem(o+1),this.piercedTriangle=i;break}}}};var Vu=class{constructor(e,t,n,i){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=n,this.createEdgeDelegate=i}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let n of t.TriEdges)(n.CwTriangle==null||n.CcwTriangle==null)&&e.add(n);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new $i(t,e))}TriangulatePolygon0(e,t,n,i){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,n,i)}TriangulatePolygon1(e,t,n,i,o,a){let l=n[e],u=e;for(let h=e+1;h<=t;h++){let d=n[h];Vu.LocalInCircle(d,i,o,l,a)&&(u=h,l=d)}let c=Lr.mkSSSD(i,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,n,i,l,a),u<t&&this.TriangulatePolygon1(u+1,t,n,l,o,a)}static LocalInCircle(e,t,n,i,o){return o?Od(e,t,i,n):Od(e,t,n,i)}TraceEdgeThroughTriangles(){new _m(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var Rd=class{constructor(e){this.Edge=e}};var wt=class extends me{constructor(e,t,n,i){super(null);this.front=new ot((e,t)=>e.x-t.x);this.triangles=new Set;if(this.listOfSites=e,this.listOfSites.length==0)return;this.p_1=t,this.p_2=n,this.createEdgeDelegate=i;let o=Lr.mkSSSD(t,n,this.listOfSites[0],i);this.triangles.add(o),this.front.insert(new $i(t,o.TriEdges.getItem(2))),this.front.insert(new $i(this.listOfSites[0],o.TriEdges.getItem(1)))}run(){if(this.listOfSites.length!=0){for(let e=1;e<this.listOfSites.length;e++)this.ProcessSite(this.listOfSites[e]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let e=this.CreateDoubleLinkedListOfPerimeter();do{let t=this.FindConcaveEdge(e);if(t==null)return;e=this.ShortcutTwoListElements(t)}while(!0)}FindConcaveEdge(e){let t=e,n;do{if(n=t.Next,p.getTriangleOrientation(t.Start.point,t.End.point,n.End.point)==1)return t;t=n}while(n!=e);return null}static FindPivot(e){let t=e,n=e;do n=n.Next,(n.Start.point.x<t.Start.point.x||n.Start.point.x==t.Start.point.x&&n.Start.point.y<t.Start.point.y)&&(t=n);while(n!=e);return t}FindFirsePerimeterEdge(){for(let e of this.triangles)for(let t of e.TriEdges)if(t.GetOtherTriangle_T(e)==null)return t;return null}CreateDoubleLinkedListOfPerimeter(){let e=this.FindFirsePerimeterEdge(),t=e,n=null,i,o=null,a=new Array;do i=wt.CreatePerimeterElementFromEdge(t),a.push(R.mkPP(i.Start.point,i.End.point)),t=wt.FindNextEdgeOnPerimeter(t),o!=null?(i.Prev=o,o.Next=i):n=i,o=i;while(t!=e);return n.Prev=i,i.Next=n,n}static FindNextEdgeOnPerimeter(e){var n;let t=(n=e.CwTriangle)!=null?n:e.CcwTriangle;for(e=t.TriEdges.getItem(t.TriEdges.index(e)+2);e.CwTriangle!=null&&e.CcwTriangle!=null;)t=e.GetOtherTriangle_T(t),e=t.TriEdges.getItem(t.TriEdges.index(e)+2);return e}static CreatePerimeterElementFromEdge(e){let t=new Rd(e);return e.CwTriangle!=null?(t.Start=e.upperSite,t.End=e.lowerSite):(t.End=e.upperSite,t.Start=e.lowerSite),t}RemoveP1AndP2Triangles(){let e=new Set;for(let t of this.triangles)(t.Sites.has(this.p_1)||t.Sites.has(this.p_2))&&e.add(t);for(let t of e)wt.RemoveTriangleWithEdges(this.triangles,t)}static RemoveTriangleWithEdges(e,t){e.delete(t);for(let n of t.TriEdges)n.CwTriangle==t?n.CwTriangle=null:n.CcwTriangle=null,n.CwTriangle==null&&n.CcwTriangle==null&&Vm(n.upperSite.Edges,n)}static RemoveTriangleButLeaveEdges(e,t){e.delete(t);for(let n of t.TriEdges)n.CwTriangle==t?n.CwTriangle=null:n.CcwTriangle=null}ProcessSite(e){this.PointEvent(e);for(let t=0;t<e.Edges.length;t++){let n=e.Edges[t];n.Constrained&&this.EdgeEvent(n)}}EdgeEvent(e){if(wt.EdgeIsProcessed(e))return;new Vu(e,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(e){return e.CwTriangle!=null||e.CcwTriangle!=null}ShowFrontWithSite(e,t=null){let n=new Array;if(e.Edges!=null)for(let i of e.Edges)n.push(oe.mkDebugCurveTWCI(200,.8,i.Constrained?"Pink":"Brown",R.mkPP(i.upperSite.point,i.lowerSite.point)));n.push(oe.mkDebugCurveTWCI(200,1,"Brown",fe.mkFullEllipseNNP(.5,.5,e.point)));for(let i of this.triangles)for(let o=0;o<3;o++){let a=i.TriEdges.getItem(o);n.push(oe.mkDebugCurveTWCI(a.Constrained?155:100,a.Constrained?.8:.4,a.Constrained?"Pink":"Navy",R.mkPP(a.upperSite.point,a.lowerSite.point)))}if(t!=null)for(let i of t)n.push(oe.mkDebugCurveTWCI(100,.5,"Red",i));for(let i of this.front)n.push(oe.mkDebugCurveTWCI(100,5.5,"Green",R.mkPP(i.Edge.upperSite.point,i.Edge.lowerSite.point)))}Show(e){wt.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],e)}static ShowCdt(e,t,n,i,o,a){let l=new Array;if(n!=null)for(let u of n)l.push(oe.mkDebugCurveTWCI(200,.1,"Red",u));if(i!=null)for(let u of i)l.push(oe.mkDebugCurveTWCI(200,.1,"Blue",u));if(t!=null)for(let u of t)l.push(oe.mkDebugCurveTWCI(200,.1,"Green",R.mkPP(u.Edge.upperSite.point,u.Edge.lowerSite.point)));for(let u of e)for(let c=0;c<3;c++){let h=u.TriEdges.getItem(c);l.push(wt.GetDebugCurveOfCdtEdge(h))}l=l.concat(o)}static GetDebugCurveOfCdtEdge(e){return e.CcwTriangle==null||e.CwTriangle==null?oe.mkDebugCurveTWCI(255,.5,e.Constrained?"Brown":"Black",R.mkPP(e.upperSite.point,e.lowerSite.point)):oe.mkDebugCurveTWCI(200,e.Constrained?.8:.2,e.Constrained?"Pink":"Navy",R.mkPP(e.upperSite.point,e.lowerSite.point))}PointEvent(e){let t=this.ProjectToFront(e),n={rightSite:null},i=t.item.x+E.distanceEpsilon<e.point.x?this.MiddleCase(e,t,n):this.LeftCase(e,t,n),o=this.InsertSiteIntoFront(i,e,n.rightSite);this.TriangulateEmptySpaceToTheRight(o),o=wt.FindNodeInFrontBySite(this.front,i),this.TriangulateEmptySpaceToTheLeft(o)}LeftCase(e,t,n){let i=t.item;this.InsertAndLegalizeTriangle(e,i);let o=this.front.previous(t),a=o.item.LeftSite;n.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,o.item),this.front.deleteNodeInternal(o);let l=this.front.remove(i);return a}MiddleCase(e,t,n){let i=t.item.LeftSite;return n.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,t.item),this.front.deleteNodeInternal(t),i}TriangulateEmptySpaceToTheLeft(e){let t=e.item.RightSite,n=this.front.previous(e);for(;n!=null;){let i=n.item,o=i.LeftSite,a=i.RightSite;if(a.point.sub(t.point).dot(o.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(n,e),n=this.front.previous(e);else{this.TryTriangulateBasinToTheLeft(e);break}}}ShortcutTwoListElements(e){var a;let t=e.Next,n=Lr.mkSSSEE(e.Start,e.End,t.End,e.Edge,t.Edge,this.createEdgeDelegate);this.triangles.add(n);let i=n.TriEdges.getItem(2);this.LegalizeEdge(e.Start,n.OppositeEdge(e.Start)),n=(a=i.CcwTriangle)!=null?a:i.CwTriangle,this.LegalizeEdge(t.End,n.OppositeEdge(t.End));let o=new Rd(i);return o.Start=e.Start,o.End=t.End,e.Prev.Next=o,o.Prev=e.Prev,o.Next=t.Next,t.Next.Prev=o,o}ShortcutTwoFrontElements(e,t){var l;let n=e.item,i=t.item,o=Lr.mkSSSEED(n.LeftSite,n.RightSite,i.RightSite,n.Edge,i.Edge,this.createEdgeDelegate);this.triangles.add(o),this.front.deleteNodeInternal(e),this.front.remove(i);let a=o.TriEdges.getItem(2);return this.LegalizeEdge(n.LeftSite,o.OppositeEdge(n.LeftSite)),o=(l=a.CcwTriangle)!=null?l:a.CwTriangle,this.LegalizeEdge(i.RightSite,o.OppositeEdge(i.RightSite)),this.front.insert(new $i(n.LeftSite,a))}TryTriangulateBasinToTheLeft(e){if(!wt.DropsSharpEnoughToTheLeft(e.item))return;let t=new Fm.Stack;for(t.push(e.item.LeftSite);;){let n=t.pop();e=wt.FindNodeInFrontBySite(this.front,n);let i=this.front.previous(e);if(i==null)return;if(p.getTriangleOrientation(i.item.LeftSite.point,e.item.LeftSite.point,e.item.RightSite.point)==1)t.push(i.item.LeftSite),this.ShortcutTwoFrontElements(i,e);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(i.item.LeftSite);else{if(i.item.LeftSite.point.y<=i.item.RightSite.point.y)return;t.push(i.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(e){let t=e.Edge;if(e.RightSite!=t.upperSite)return!1;let n=t.lowerSite.point.sub(t.upperSite.point);return n.x>=.5*n.y}InsertSiteIntoFront(e,t,n){let i=null,o=null;for(let a of t.Edges)if(o==null&&a.lowerSite==e&&(o=a),i==null&&a.lowerSite==n&&(i=a),o!=null&&i!=null)break;return this.front.insert(new $i(e,o)),this.front.insert(new $i(t,i))}TriangulateEmptySpaceToTheRight(e){let n=e.item.LeftSite.point,i=this.front.next(e);for(;i!=null;){let o=i.item,a=o.LeftSite,l=o.RightSite;if(a.point.sub(n).dot(l.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(e,i),i=this.front.next(e);else{this.TryTriangulateBasinToTheRight(e);break}}}TryTriangulateBasinToTheRight(e){if(!wt.DropsSharpEnoughToTheRight(e.item))return;let t=new Fm.Stack;for(t.push(e.item.LeftSite);;){let n=t.pop();e=wt.FindNodeInFrontBySite(this.front,n);let i=this.front.next(e);if(i==null)return;if(p.getTriangleOrientation(e.item.LeftSite.point,e.item.RightSite.point,i.item.RightSite.point)==1)this.ShortcutTwoFrontElements(e,i),t.push(n);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(e.item.RightSite);else{if(i.item.LeftSite.point.y>=i.item.RightSite.point.y)return;t.push(e.item.RightSite)}}}static DropsSharpEnoughToTheRight(e){let t=e.Edge;if(e.LeftSite!=t.upperSite)return!1;let n=t.lowerSite.point.sub(t.upperSite.point);return n.x<=-.5*n.y}static FindNodeInFrontBySite(e,t){return e.findLast(n=>n.LeftSite.point.x<=t.point.x)}InsertAndLegalizeTriangle(e,t){var n;if(p.getTriangleOrientation(e.point,t.LeftSite.point,t.RightSite.point)!=2){let i=Lr.mkSED(e,t.Edge,this.createEdgeDelegate);this.triangles.add(i),this.LegalizeEdge(e,i.TriEdges.getItem(0))}else{let i=t.Edge;Vm(i.upperSite.Edges,i);let o=(n=i.CcwTriangle)!=null?n:i.CwTriangle,a=o.OppositeSite(i);wt.RemoveTriangleButLeaveEdges(this.triangles,o),o=Lr.mkSSSD(t.LeftSite,a,e,this.createEdgeDelegate);let l=Lr.mkSSSD(t.RightSite,a,e,this.createEdgeDelegate);this.triangles.add(o),this.triangles.add(l),this.LegalizeEdge(e,o.OppositeEdge(e)),this.LegalizeEdge(e,l.OppositeEdge(e))}}LegalizeEdge(e,t){t.Constrained||t.CcwTriangle==null||t.CwTriangle==null||(t.CcwTriangle.Contains(e)?this.LegalizeEdgeForOtherCwTriangle(e,t):this.LegalizeEdgeForOtherCcwTriangle(e,t))}LegalizeEdgeForOtherCwTriangle(e,t){let n=t.CwTriangle.TriEdges.index(t);if(HS(e,t.upperSite,t.CwTriangle.Sites.getItem(n+2),t.lowerSite)){let i=jS(e,t);this.LegalizeEdge(e,i.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,i.CcwTriangle.OppositeEdge(e))}}LegalizeEdgeForOtherCcwTriangle(e,t){let n=t.CcwTriangle.TriEdges.index(t);if(HS(e,t.lowerSite,t.CcwTriangle.Sites.getItem(n+2),t.upperSite)){let i=jS(e,t);this.LegalizeEdge(e,i.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,i.CcwTriangle.OppositeEdge(e))}}ProjectToFront(e){return this.front.findLast(t=>t.x<=e.point.x)}};function Vm(s,e){if(s.length==0)return;let t=s.findIndex(n=>e==n);t>=0&&(t!=s.length-1&&(s[t]=s[s.length-1]),s.pop())}function HS(s,e,t,n){return d2(s,e,t,n)&&Od(s,e,t,n)}function d2(s,e,t,n){return p.getTriangleOrientation(e.point,s.point,t.point)==0&&p.getTriangleOrientation(t.point,s.point,n.point)==0}function Od(s,e,t,n){let i=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=n.point.x-s.point.x,c=n.point.y-s.point.y,h=i*i+o*o,d=a*a+l*l,f=u*u+c*c;return i*(l*f-c*d)-a*(o*f-c*h)+u*(o*d-l*h)>E.tolerance}function jS(s,e){let t,n;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,n=e.CwTriangle):(t=e.CwTriangle,n=e.CcwTriangle);let i=t.TriEdges.index(e),o=n.TriEdges.index(e),a=n.Sites.getItem(o+2),l=t.TriEdges.getItem(i+1),u=n.TriEdges.getItem(o+1),c=$e.GetOrCreateEdge(s,a);return t.Sites.setItem(i+1,a),t.TriEdges.setItem(i,u),t.TriEdges.setItem(i+1,c),n.Sites.setItem(o+1,s),n.TriEdges.setItem(o,l),n.TriEdges.setItem(o+1,c),u.lowerSite==a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite==s?l.CcwTriangle=n:l.CwTriangle=n,c.upperSite==s?(c.CcwTriangle=n,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=n),Vm(e.upperSite.Edges,e),c}var $e=class extends me{constructor(e,t,n){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new Je;this.cdtTree=null;this.isolatedSites=e,this.obstacles=t,this.isolatedSegments=n}static constructor_(e){let t=new $e(null,null,null);return t.isolatedSitesWithObject=e,t}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let e of this.isolatedSitesWithObject)this.AddSite(e[0],e[1]);if(this.isolatedSites!=null)for(let e of this.isolatedSites)this.AddSite(e,null);if(this.obstacles!=null)for(let e of this.obstacles)this.AddPolylineToAllInputSites(e);if(this.isolatedSegments!=null)for(let e of this.isolatedSegments)this.AddConstrainedEdge(e.A,e.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(e,t){let n;return(n=this.PointsToSites.get(e))?n.Owner=t:(n=zs.mkSO(e,t),this.PointsToSites.set(e,n)),n}AddP1AndP2(){let e=k.mkEmpty();for(let i of this.PointsToSites.keys())e.add(i);let t=Math.max(e.width/3,1),n=Math.max(e.height/3,1);this.P1=new zs(e.leftBottom.add(new p(-t,-n))),this.P2=new zs(e.rightBottom.add(new p(t,-n)))}AddPolylineToAllInputSites(e){for(let t=e.startPoint;t.next!=null;t=t.next)this.AddConstrainedEdge(t.point,t.next.point,e);e.closed&&this.AddConstrainedEdge(e.endPoint.point,e.startPoint.point,e)}AddConstrainedEdge(e,t,n){let i=$e.AbovePP(e,t),o,a;i>0?(o=this.AddSite(e,n),a=this.AddSite(t,n)):(o=this.AddSite(t,n),a=this.AddSite(e,n));let l=$e.CreateEdgeOnOrderedCouple(o,a);l.Constrained=!0}static GetOrCreateEdge(e,t){if($e.AboveCC(e,t)==1){let n=e.EdgeBetweenUpperSiteAndLowerSite(t);return n!=null?n:$e.CreateEdgeOnOrderedCouple(e,t)}else{let n=t.EdgeBetweenUpperSiteAndLowerSite(e);return n!=null?n:$e.CreateEdgeOnOrderedCouple(t,e)}}static CreateEdgeOnOrderedCouple(e,t){return new Gm(e,t)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new wt(this.allInputSites,this.P1,this.P2,$e.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort($e.OnComparison)}static OnComparison(e,t){return $e.AboveCC(e,t)}static AbovePP(e,t){let n=e.y-t.y;return n>0?1:n<0?-1:(n=e.x-t.x,n>0?-1:n<0?1:0)}static AboveCC(e,t){return $e.AbovePP(e.point,t.point)}RestoreEdgeCapacities(){for(let e of this.allInputSites)for(let t of e.Edges)t.Constrained||(t.ResidualCapacity=t.Capacity)}SetInEdges(){for(let e of this.PointsToSites.values())for(let t of e.Edges)t.lowerSite.AddInEdge(t)}FindSite(e){return this.PointsToSites.get(e)}static PointIsInsideOfTriangle(e,t){for(let n=0;n<3;n++){let i=t.Sites.getItem(n).point,o=t.Sites.getItem(n+1).point;if(p.signedDoubledTriangleArea(e,i,o)<E.distanceEpsilon*-1)return!1}return!0}GetCdtTree(){return this.cdtTree==null&&(this.cdtTree=_e(Array.from(this.GetTriangles().values()).map(e=>Ke(e,e.BoundingBox())))),this.cdtTree}EdgeIsCorrect(e){let t=e.upperSite,n=!1;for(let o of t.Edges)if(o==e){n=!0;break}return n?this.PointsToSites.get(t.point)==t:!1}};var Ws=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,n=this.clone();return n.add_d(t.start),n.add_d(t.end),n}clone(){return new Ws(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new Ws(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let n=new Ws(e.start,e.end);return n.add_d(t.start),n.add_d(t.end),n}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+E.distanceEpsilon?!1:!(e.end<this.start-E.distanceEpsilon)}};var ku=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let n=this.heapSize;for(this._priors[e]=t,this.PutAtI(n,e);n>1&&this._priors[this._heap[n>>1]]>t;)this.SwapWithParent(n),n>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize==0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let n=t,i=t<<1;i<=this.heapSize&&this._priors[this._heap[i]]<this._priors[this._heap[t]]&&(n=i);let o=i+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[n]]&&(n=o),n!=t)this.SwapWithParent(n);else break;t=n}}return this.heapSize--,e}IsEmpty(){return this.heapSize==0}DecreasePriority(e,t){this._priors[e]=t;let n=this._reverse_heap[e];for(;n>1&&this._priors[this._heap[n]]<this._priors[this._heap[n>>1]];){this.SwapWithParent(n);n>>=1}}};var km=class{constructor(e,t,n,i){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=n,this._forLayers=i,this._q=new ku(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=Kn([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let n of this._intervalTree.GetAllIntersecting(t)){let i=sn.GetIdealEdge(e,n,this._nodePositions[e],this._nodePositions[n],this._nodeSizes);if(i.overlapFactor<=1)return;this._proximityEdges.push(i),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,n=this._nodePositions[e].x;return new Ws(n-t,n+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,n=this._nodePositions[e].y;this._q.Enqueue(e,n-t),this._q.Enqueue(this._nodeSizes.length+e,n+t)}}};var Bd=class{constructor(e,t,n){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=n,this.q=new ku(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),n=this.hedgehog.get(t);this.treeNodes.add(t),e.push(n),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let n=t.target;if(this.NodeIsInTree(n))continue;let i=this.hedgehog.get(n);if(i){let o=this.weight(i),a=this.weight(t);a<o&&(this.q.DecreasePriority(n,a),this.hedgehog.set(n,t))}else this.q.Enqueue(n,this.weight(t)),this.hedgehog.set(n,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let n=t.source;if(this.NodeIsInTree(n))continue;let i=this.hedgehog.get(n);if(i){let o=this.weight(i),a=this.weight(t);a<o&&(this.q.DecreasePriority(n,a),this.hedgehog.set(n,t))}else this.q.Enqueue(n,this.weight(t)),this.hedgehog.set(n,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var Uu=class{static GetMst(e,t){if(e.length==0)return null;let n=e.map(u=>new ae(u.source,u.target)),i=n.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new In(i+1);for(let u=0;u<e.length;u++)o.setPair(n[u],e[u]);let a=sr(n,t);return new Bd(a,u=>o.get(u.source,u.target).weight,n[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let n=Array.from(e.PointsToSites.values()),i=new Map;for(let u=0;u<n.length;u++)i.set(n[u],u);let o=Uu.GetEdges(n,i),a=zh(Array.from(o.keys()));return new Bd(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let n=new In(e.length);for(let i=0;i<e.length;i++){let o=e[i],a=t.get(o);for(let l of o.Edges)n.set(a,t.get(l.lowerSite),l)}return n}};var zu=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new zu;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var sn=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let n=new zu;n.RandomizeAllPointsOnStart=!0,n.NodeSeparation=t,new sn(n,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(f2(this._settings,this._nodes,e),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!=1&&this._nodes.length==2){let e=this._nodes[0],t=this._nodes[1];p.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new p(.001,0)));let n=this.GetIdealDistanceBetweenTwoNodes(e,t),i=p.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(n/a)),e.center=i.add(o),t.center=i.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let n=e.center.sub(t.center),i=Math.abs(n.x),o=Math.abs(n.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return i>E.tolerance&&(u=a/i),o>E.tolerance&&(c=l/o),Math.min(u,c)*n.length}static AvgEdgeLength(e){let t=0,n=0;for(let i of e)for(let o of i.outEdges())n+=i.center.sub(o.target.center).length,t++;return t>0?n/t:1}OneIteration(e,t,n){let i=new Array;for(let h=0;h<e.length;h++)i.push([e[h],h]);let o=$e.constructor_(i);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let f=d.upperSite.point,y=d.lowerSite.point,S=a.get(d.upperSite),C=a.get(d.lowerSite),T=sn.GetIdealEdge(S,C,f,y,t);u.push(T),T.overlapFactor>1&&l++}if(l==0||n){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l==0&&h==0||l==0&&!n)return!1}let c=Uu.GetMst(u,e.length);return sn.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,n){return new km(e,t,n,this._overlapForLayers).Run()}static GetIdealEdge(e,t,n,i,o){let a={overlapFactor:0},l=sn.GetIdealEdgeLength(e,t,n,i,o,a),u=n.sub(i).length,c=k.mkSizeCenter(o[e],n),h=k.mkSizeCenter(o[t],i),d=a.overlapFactor>1?u-l:sn.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,n,i,o,a){let l=n.sub(i),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,f=(o[e].height+o[t].height)/2;if(c>=d||h>=f)return a.overlapFactor=1,l.length;let y,S=1e-10;if(c>S)h>S?y=Math.min(d/c,f/h):y=d/c;else if(h>S)y=f/h;else return a.overlapFactor=2,Math.sqrt(d*d+f*f)/4;return y=Math.max(y,1.001),a.overlapFactor=y,y*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let n=0,i=0;return(e.right<t.left||t.right<e.left)&&(i=e.left-t.right),e.top<t.bottom?n=t.bottom-e.top:t.top<e.bottom&&(n=e.bottom-t.top),Math.sqrt(i*i+n*n)}static MoveNodePositions(e,t,n){let i=t.map(a=>a.clone()),o=new Set;o.add(n);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?sn.MoveNode(l.source,l.target,i,t,o,l.idealDistance):sn.MoveNode(l.target,l.source,i,t,o,l.idealDistance)}}static MoveNode(e,t,n,i,o,a){let l=n[t].sub(n[e]);l=l.mul(a/l.length+.01),i[t]=i[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function f2(s,e,t){t.nodePositions=e.map(n=>n.center),t.nodeSizes=e.map(n=>{let i=n.boundingBox.size;return i.width+=s.NodeSeparation,i.height+=s.NodeSeparation,i})}var il=class extends me{constructor(e,t,n,i){super(n);this.settings=e,this.graph=t,this.length=i}run(){this.LayoutConnectedGraphWithMds(),this.SetGraphBoundingBox()}SetGraphBoundingBox(){this.graph.boundingBox=this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}static ScaleToAverageEdgeLength(e,t,n,i){let o=new Map,a=0;for(let c of e.shallowNodes())o.set(c,a),a++;let l=0,u=0;for(let c of e.edges()){let h=o.get(c.source),d=o.get(c.target);u+=Math.sqrt(Math.pow(t[h]-t[d],2)+Math.pow(n[h]-n[d],2)),l+=i(c)}if(l>0&&(u/=l),u>0)for(let c=0;c<t.length;c++)t[c]/=u,n[c]/=u}static LayoutGraphWithMds(e,t,n,i){if(n.x=new Array(e.shallowNodeCount),n.y=new Array(e.shallowNodeCount),n.x.length==0)return;if(n.x.length==1){n.x[0]=n.y[0]=0;return}let o=Math.min(t.PivotNumber,e.shallowNodeCount),a=t.GetNumberOfIterationsWithMajorization(e.shallowNodeCount),l=t.Exponent,u=new Array(o),c=new Nm(e,u,i);c.run();let h=c.Result;if(Ye.LandmarkClassicalScaling(h,n,u),il.ScaleToAverageEdgeLength(e,n.x,n.y,i),a>0){let d=new Fu(e,i);d.run();let f=d.Result,y=Ye.ExponentialWeightMatrix(f,l);Ye.DistanceScalingSubset(f,n.x,n.y,y,a)}}LayoutConnectedGraphWithMds(){let e={x:[],y:[]};il.LayoutGraphWithMds(this.graph,this.settings,e,this.length),this.settings.RotationAngle!=0&&Dm.Rotate(e.x,e.y,this.settings.RotationAngle);let t=0;for(let n of this.graph.shallowNodes())n.boundingBox&&(n.center=new p(e.x[t]*this.settings.ScaleX,e.y[t]*this.settings.ScaleY)),t++;this.settings.RemoveOverlaps&&sn.RemoveOverlaps(Array.from(this.graph.shallowNodes()),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins(this.settings.NodeSeparation/2)}ScaleNodes(e,t){for(let n of e)n.center=n.center.mul(t)}static PackGraphs(e,t){if(e.length==0)return k.mkEmpty();if(e.length==1)return e[0].boundingBox;let n=e.map(a=>a.boundingBox),i=new Array;for(let a of e)i.push({g:a,lb:a.boundingBox.leftBottom.clone()});let o=new fu(n,t.PackingAspectRatio);o.run();for(let{g:a,lb:l}of i){let u=a.boundingBox.leftBottom.sub(l);a.translate(u)}return new k({left:0,bottom:0,right:o.PackedWidth,top:o.PackedHeight})}};var hi=class extends yu{constructor(){super(...arguments);this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this.removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=3e3;this.adjustScale=!1}get RemoveOverlaps(){return this.removeOverlaps}set RemoveOverlaps(e){this.removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get IdealEdgeLength(){return this.edgeConstraints}set IdealEdgeLength(e){this.edgeConstraints=e}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var Um=class extends me{get scaleX(){return this.settings.ScaleX}set scaleX(e){this.settings.ScaleX=e}get scaleY(){return this.settings.ScaleY}set scaleY(e){this.settings.ScaleY=e}constructor(e,t,n,i){super(t);this.graph=e,this.length=n,this.settings=i,this.settings.ScaleX=this.settings.ScaleY=200}run(){new il(this.settings,this.graph,this.cancelToken,this.length).run()}};var IE=ne(Ud());var wE=(i=>(i[i.OverlapsOtherLabels=0]="OverlapsOtherLabels",i[i.OverlapsNodes=1]="OverlapsNodes",i[i.OverlapsEdges=2]="OverlapsEdges",i[i.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",i))(wE||{});var LE=class{},OE=class{constructor(){this.points=new IE.LinkedList;this.coveredLength=0}AddFirst(e){if(this.points.size!=0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!=0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var tb=class{constructor(e){this.location=e,this.boundingBox=k.rectangleOnPoint(e)}},ul=class{constructor(e,t){this.data=t,this.boundingBox=e}},RE=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},Re=class extends me{constructor(e,t){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=Re.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(t.length):Re.MinGranularity,this.InitializeObstacles(e,t),this.edges=t}get CollisionGranularity(){return this.granularity}set CollisionGranularity(e){this.granularity=e}static constructorG(e){return new Re(Array.from(e.deepNodes()),Array.from(e.deepEdges()).filter(t=>t.label))}static constructorGA(e,t){return new Re(Array.from(e.deepNodes()),t.filter(n=>n.label))}interpolateGranularity(e){if(e<=Re.LowerEdgeBound)return Re.MaxGranularity;if(e>=Re.UpperEdgeBound)return Re.MinGranularity;let t=(Re.UpperEdgeBound-Re.LowerEdgeBound)/(e-Re.LowerEdgeBound);return Math.ceil(Re.MinGranularity+t)}InitializeObstacles(e,t){let n=this.GetEdgeObstacles(t);this.obstacleMaps[1]=Kn(e.map(i=>[i.boundingBox,new ul(i.boundingBox,i)])),this.obstacleMaps[2]=Kn(n.map(i=>[i.boundingBox,new ul(i.boundingBox,i)]))}static CurvePoints(e,t){let n=[],i=e.end.sub(e.start).lengthSquared/(t*t);return Re.SubdivideCurveSegment(n,e,i,e.parStart,e.parEnd),n.sort(wy),n}static SubdivideCurveSegment(e,t,n,i,o){if(e.length>64)return;let a=t.value(i),l=t.value(o);if(a.sub(l).lengthSquared>n){let u=(i+o)/2;Re.SubdivideCurveSegment(e,t,n,i,u),Re.SubdivideCurveSegment(e,t,n,u,o)}else e.push([i,a])}static PlaceLabelsAtDefaultPositions(e,t){for(let n of t)n.label&&new Re([n.source,n.target],[n]).run()}GetEdgeObstacles(e){let t=[];for(let n of e){if(n.curve==null)continue;let i=Re.CurvePoints(n.curve,this.CollisionGranularity);this.edgeInfos.set(n,new RE(i));for(let o of i)t.push(new tb(o[1]))}return t}AddLabelObstacle(e){this.labelObstacleMap==null?(this.labelObstacleMap=Kn([[e.boundingBox,e]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(e.boundingBox,e)}run(){this.edges.sort((e,t)=>this.edgeInfos.get(e).edgePoints.length-this.edgeInfos.get(t).edgePoints.length);for(let e of this.edges)this.PlaceLabel(e)}PlaceLabel(e){let t=!1;for(let n of this.placementStrategy){switch(n){case 0:t=this.PlaceEdgeLabelOnCurve(e.label);break;case 1:t=this.PlaceEdgeLabelHorizontally(e.label);break;default:throw new Error("unexpected case")}if(t)break}t?this.CalculateCenterLabelInfoCenter(e.label):this.PlaceLabelAtFirstPosition(e.label)}getLabelInfo(e){let t=Ge.getGeom(e.label.parent);return this.edgeInfos.get(t)}PlaceLabelAtFirstPosition(e){let t=Ge.getGeom(e.label.parent),n=t.curve,i=this.edgeInfos.get(t).edgePoints,o=this.StartIndex(e,i.map(f=>f[1])),a=i[o][1],l=n.derivative(i[o][0]);l.length<E.distanceEpsilon&&(l=new p(1,1)),l=l.normalize();let u=new Bt(e.width,e.height),c=this.getLabelInfo(e),h=Re.GetPossibleSides(c.placementSide,l)[0],d=Re.GetLabelBounds(a,l,u,h);this.SetLabelBounds(this.getLabelInfo(e),d)}StartIndex(e,t){let n=this.getLabelInfo(e);return Math.min(t.length-1,Math.max(0,Math.floor(t.length*n.placementOffset)))}CalculateCenterLabelInfoCenter(e){let t=this.getLabelInfo(e),n=new p(0,0);for(let i of t.innerPoints)n=n.add(i);for(let i of t.outerPoints)n=n.add(i);e.center=n.div(t.innerPoints.length+t.outerPoints.length)}static geomEdge(e){return Ge.getGeom(e.label.parent)}PlaceEdgeLabelHorizontally(e){let n=this.getLabelInfo(e).edgePoints,i=new Bt(e.width,e.height),o=-1,a=k.mkEmpty(),l=Re.geomEdge(e).curve;for(let u of Re.ExpandingSearch(this.StartIndex(e,n.map(c=>c[1])),0,n.length)){let c=n[u],h=l.derivative(c[0]).normalize();if(!K(h.lengthSquared,0)){for(let d of Re.GetPossibleSides(this.getLabelInfo(e).placementSide,h)){let f=Re.GetLabelBounds(c[1],h,i,d),y=this.ConflictIndexRL(f,e);if(y>o&&(o=y,a=f,o==Number.MAX_VALUE))break}if(o==Number.MAX_VALUE)break}}if(o>=0){this.SetLabelBounds(this.getLabelInfo(e),a);let u=new ul(a,null);this.AddLabelObstacle(u);let c=this.getLabelInfo(e);return o==0?c.placementResult=0:o==1?c.placementResult=1:o==2?c.placementResult=2:c.placementResult=wE.OverlapsNothing,!0}return!1}static GetLabelBounds(e,t,n,i){let o=t.rotate(Math.PI/2).mul(i),a=e.add(o),l=1,u=o.x>0?a.x:a.x-n.width,c=o.y>0?a.y:a.y-n.height;if(Math.abs(o.x)<.75){let h=Math.acos(Math.abs(o.y)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?-1:1)*Math.min(d,n.width/2),c+=(o.y>0?1:-1)*f}else if(Math.abs(o.y)<.75){let h=Math.acos(Math.abs(o.x)/l),d=l/Math.sin(h),f=l/Math.cos(h);u+=(o.x>0?1:-1)*f,c+=(o.y>0?-1:1)*Math.min(d,n.height/2)}return k.mkLeftBottomSize(u,c,n)}SetLabelBounds(e,t){e.innerPoints=[t.leftTop,t.rightTop],e.outerPoints=[t.leftBottom,t.rightBottom]}static GetPossibleSides(e,t){switch(t.length==0&&(e=0),e){case 1:return[-1];case 2:return[1];case 3:return K(t.x,0)?Re.GetPossibleSides(5,t):[1];case 4:return K(t.x,0)?Re.GetPossibleSides(6,t):[t.x<0?-1:1];case 5:return K(t.y,0)?Re.GetPossibleSides(3,t):[t.y<0?-1:1];case 6:return K(t.y,0)?Re.GetPossibleSides(4,t):[t.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(e,t,n){let i=e+1,o=i;for(;o>t;)yield--o;for(;i<n;)yield i++}static PointSetLength(e){let t=0,n=null;for(let i of e)n!=null&&(t+=n.sub(i.Center).length),n=i.Center;return t}PlaceEdgeLabelOnCurve(e){let t=Ge.getGeom(e.label.parent),n=this.getLabelInfo(e);n.innerPoints=null;let i=n.edgePoints,o=3,a=e.height/2,l=new Bt(a,a),u=e.width;for(let c of Re.ExpandingSearch(this.StartIndex(e,i),0,i.length)){let h=this.GetSidesAndEdgeCurve(e,t,i,c);for(let d of h){let f=new OE,y={coveredLength:0};if(this.ProcessExpandingSearchOnSide(c,i,t.curve,d,a,o,l,y,f,u),y.coveredLength>=u)return this.CaseOfCoveredLengthGreaterThanLabelLength(e,f,y.coveredLength,u,l),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(e,t,n,i,o){let a=new Array,l=new Array,u=Array.from(t.points),c=n-i;if(c>0){let d=u[u.length-1],f=u[u.length-2],y=d.Center.sub(f.Center),S=y.length;c>S&&(d=u[0],f=u[1],y=d.Center.sub(f.Center),S=y.length);let C=y.mul((S-c)/S);d.Center=f.Center.add(C),d.Inner=f.Inner.add(C),d.Outer=f.Outer.add(C)}this.GoOverOrderedPointsAndAddLabelObstacels(u,a,l,o);let h=this.getLabelInfo(e);h.innerPoints=a,h.outerPoints=l}GoOverOrderedPointsAndAddLabelObstacels(e,t,n,i){for(let o of e){let a=o.Center;t.push(o.Inner),n.push(o.Outer);let l=new ul(k.mkSizeCenter(new Bt(i.width*2,i.height*2),a),null);this.AddLabelObstacle(l)}}ProcessExpandingSearchOnSide(e,t,n,i,o,a,l,u,c,h){for(let d of Re.ExpandingSearch(e,0,t.length)){let[f,y]=t[d],S=n.derivative(f);if(K(S.lengthSquared,0))continue;let C=S.rotate(Math.PI/2).normalize().mul(i),T=y.add(C.mul(o+a));if(this.Conflict(T,o,l))break;{let I=new LE;if(I.Center=T,I.Inner=y.add(C.mul(a)),I.Outer=y.add(C.mul(2*o+a)),u.coveredLength=d<=e?c.AddFirst(I):c.AddLast(I),u.coveredLength>=h)break}}}GetSidesAndEdgeCurve(e,t,n,i){let o=t.curve.derivative(n[i][0]);return Re.GetPossibleSides(this.getLabelInfo(e).placementSide,o)}Conflict(e,t,n){return this.ConflictIndex(e,t,n)!=Number.MAX_VALUE}ConflictIndexRL(e,t){let n=Ge.getGeom(t.label.parent),i=n.source,o=n.target;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l of this.obstacleMaps[a].GetAllIntersecting(e))if(!(a==1&&l instanceof ul&&l.data instanceof je!=null&&(i.node.isDescendantOf(l.data.graph)||o.node.isDescendantOf(l.data))))return a}return Number.MAX_VALUE}ConflictIndex(e,t,n){let i=k.creatRectangleWithSize(new Bt(n.width*2,n.height*2),e),o=t*t;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null)for(let u of this.obstacleMaps[l].GetAllIntersecting(i))if(u instanceof tb){if(e.sub(u.location).lengthSquared<o)return l}else return l;return Number.MAX_VALUE}}},qs=Re;qs.MinGranularity=5,qs.MaxGranularity=50,qs.LowerEdgeBound=500,qs.UpperEdgeBound=3e3;function rb(s,e){t(s),Wu(s,e,n,Hs,Uh);function t(o){o.layoutSettings||(o.layoutSettings=i(o))}function n(o,a){if(t(o),o.layoutSettings instanceof Cr)new $u(o,o.layoutSettings,a).run();else if(o.layoutSettings instanceof hi)new Um(o,a,()=>1,o.layoutSettings).run();else throw Error("not implemented")}function i(o){if(o.graph.shallowNodeCount>2e3||o.graph.nodeCollection.edgeCount>4e3)return new hi;let l=!1;for(let u of o.edges())if(u.sourceArrowhead!=null||u.targetArrowhead!=null){l=!0;break}return l?new Cr:new hi}}function nb(s){do{if(s.layoutSettings&&s.layoutSettings.edgeRoutingSettings)return s.layoutSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=De.getGeom(t);else break}while(!0);let e=new _a;return e.EdgeRoutingMode=0,e}function Hs(s,e,t){let n=nb(s);n.EdgeRoutingMode==4?BE(s,e,t):n.EdgeRoutingMode==0||n.EdgeRoutingMode==1?NE(s,e,t):n.EdgeRoutingMode==2?DE(s,e,t):n.EdgeRoutingMode!=6&&new Xe(s,e).run(),ME(s)}function Wu(s,e,t,n,i,o=!0,a=1){if(s.graph.isEmpty())return;lS(a),U2(s);let l=f();d(s);let u=V2(s.graph),c=k2(s);if(y(),u.forEach(S=>{S[0].edge.remove(),S[1].add()}),c.forEach(S=>{for(let C of S.graph.shallowNodes)C.parent=s.graph}),l.forEach(S=>S.add()),s.graph.parent==null){let S=h(s);n(s,S,e),ME(s),o&&s.FlipYAndMoveLeftTopToOrigin()}function h(S){let C=[];for(let T of S.deepNodes()){for(let I of T.outEdges())I.curve==null&&C.push(I);for(let I of T.selfEdges())I.curve==null&&C.push(I)}return C}function d(S){for(let C of S.shallowNodes())if(C instanceof je){let T=C;if(Wu(T,e,t,n,i),!T.graph.isEmpty()){let I=T.boundingBox;I&&!I.isEmpty()&&(C.boundaryCurve=ve.mkRectangleWithRoundedCorners(I.width,I.height,Math.min(10,I.width/10),Math.min(10,I.height/10),I.center))}}}function f(){let S=new Set,C=s.graph;if(C.parent==null)return S;for(let T of C.shallowNodes){for(let I of T.outEdges){let B=C.liftNode(I.target);(B==null||B==T)&&S.add(I)}for(let I of T.inEdges){let B=C.liftNode(I.source);(B==null||B==T)&&S.add(I)}}for(let T of S)T.remove();return S}function y(){if(c.length!=0){for(let S of c)t(S,e);i(s,c)}}}function V2(s){let e=new Array;for(let t of s.deepNodes){let n=s.liftNode(t);if(n!=null)for(let i of t.outEdges.values()){let o=i.target,a=s.liftNode(o);if(a==null||n==t&&a==o||n==a)continue;i.remove();let l=new mo(n,a),u=new Ge(l);e.push([u,i])}}return e}function k2(s){let e=s.graph,t=Ty(e),n=[],i=0;for(let o of t){let a=new We(e.id+i++);a.parent=e;let l=new je(a);l.layoutSettings=s.layoutSettings;for(let u of o)u.parent=a,a.addNode(u);n.push(l)}return n}function BE(s,e,t,n=1,i=3){nl.constructorGNANB(s,e,n,i,!0).run()}function ME(s){let e=Array.from(s.deepEdges()).filter(n=>n.label&&n.label.isPositioned==!1);if(e.length==0)return;qs.constructorGA(s,e).run()}function U2(s){for(let e of s.deepEdges())e.label&&e.label.requirePositioning()}var Qu=class{static constructorStatic(e,t){let n=new Qu;n.edges=e,n.nodeBoundaries=t,n.boundingBox=k.mkEmpty();for(let i of n.nodeBoundaries)n.boundingBox=n.boundingBox.addRec(i.boundingBox);return n}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=Ln(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var _E=ne(fn());var GE=ne(Ud());var Xs=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,n){this.currentTriangle=e,this.start=t,this.end=n}*Triangles(){for(;this.MoveNext();)yield this.CurrentTriangle}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!=t&&p.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.TriEdges.item0;let n=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!=n&&p.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=n,this.currentTriangle.TriEdges.item1):(this.positiveSign=n,this.negativeSign=e,this.currentTriangle.TriEdges.item2)}static PointLocationForTriangle(e,t){let n=!1;for(let i=0;i<3;i++){let o=p.signedDoubledTriangleArea(e,t.Sites.getItem(i).point,t.Sites.getItem(i+1).point);if(o<E.distanceEpsilon*-1)return 0;o<E.distanceEpsilon&&(n=!0)}return n?1:2}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.TriEdges.index(this.currentPiercedEdge),t,n=this.currentTriangle.Sites.getItem(e+2),i=this.GetHyperplaneSign(n);this.negativeSign==0?i==-1||i==0?(this.negativeSign=i,t=e+1):t=e+2:this.positiveSign==0?i==1||i==0?(this.positiveSign=i,t=e+2):t=e+1:i!=this.positiveSign?(this.negativeSign=i,t=e+1):(this.positiveSign=i,t=e+2),this.currentPiercedEdge=p.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-E.distanceEpsilon?this.currentTriangle.TriEdges.getItem(t):null}GetHyperplaneSign(e){let t=p.signedDoubledTriangleArea(this.start,e.point,this.end);return t>E.distanceEpsilon?1:t<E.distanceEpsilon*-1?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var Zu=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,n,i){if($e.PointIsInsideOfTriangle(t,n))return!0;let o=new Xs(n,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.Constrained){let l=a.lowerSite.Owner;if(!i.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,n,i,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.CdtTriangle,i,n,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,n,i,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,n,i,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new GE.HashSet;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(i.has(d))continue;let f=Zu.FindPolylinePoint(d,h.point),y=R.minDistBetweenLineSegments(f.point,f.nextOnPolyline.point,t,n),S=y.dist,C=y.parab,T=y.parcd,I=R.minDistBetweenLineSegments(f.point,f.prevOnPolyline.point,t,n),B=I.dist,w=I.parab,M=I.parcd,F,U,te;if(S<B){if(te=S,te>o)continue;F=f.point.add(f.nextOnPolyline.point.sub(f.point).mul(C)),U=t.add(n.sub(t).mul(T))}else{if(te=B,te>o)continue;F=f.point.add(f.prevOnPolyline.point.sub(f.point).mul(w)),U=t.add(n.sub(t).mul(M))}a.get(d)||a.set(d,[F,U])}return a}ThreadLineSegmentThroughTriangles(e,t,n,i,o){if($e.PointIsInsideOfTriangle(n,e))return o.push(e),!0;let a=new Xs(e,t,n);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.Constrained){let u=l.lowerSite.Owner;if(!i.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let n=!1;for(let i=0;i<3;i++){let o=p.signedDoubledTriangleArea(e,t.Sites.getItem(i).point,t.Sites.getItem(i+1).point);if(o<E.distanceEpsilon*-1)return 0;o<E.distanceEpsilon&&(n=!0)}return n?1:2}static FindPolylinePoint(e,t){for(let n of e.polylinePoints())if(n.point.equal(t))return n;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,n,i){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.CdtTriangle,n,i,a,o)}static closedeb(e,t){return e.Position.sub(new p(360.561,428.416)).length<.1&&t.Position.sub(new p(414.281,440.732)).length<.1}EdgeIsLegalSSPPS(e,t,n){let i=e.Position,o=e.CdtTriangle,a=t.Position;if($e.PointIsInsideOfTriangle(a,o))return!0;let l=new Xs(o,i,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.Constrained){let c=u.lowerSite.Owner;if(!n.has(c))return!1}}return!0}};var Br=class{constructor(e,t,n,i){this.metroGraphData=e,this.obstaclesToIgnoreLambda=i,this.bundlingSettings=t,this.obstacleTree=n}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?Ln(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,n,i){let o={minimalDistance:n};return Br.IntersectCircleWithTree(this.obstacleTree,t,n,this.obstaclesToIgnoreLambda(e),i.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,n){let i={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,n,i,o)}GetMinimalDistanceToObstacles(e,t,n){let i=new Array,o={minimalDistance:n};return Br.IntersectCircleWithTree(this.obstacleTree,t,n,this.obstaclesToIgnoreLambda(e),i,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,n,i,o){return i.touchedObstacles=new Array,o.minimalDistance=t,Br.IntersectCircleWithTree(this.obstacleTree,e,t,n,i.touchedObstacles,o)}static IntersectCircleWithTree(e,t,n,i,o,a){if(!e.irect.contains_point_radius(t,n))return!0;if(e.UserData==null){let l=Br.IntersectCircleWithTree(e.Left,t,n,i,o,a);if(!l||(l=Br.IntersectCircleWithTree(e.Right,t,n,i,o,a),!l))return!1}else{let l=e.UserData;if(i.has(l))return!0;if(v.PointRelativeToCurveLocation(t,l)!=0)return Br.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=n&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,n,i){let o=t.sub(e).normalize();return o=new p(o.y,o.x*-1),$.mkFromPoints([e.add(o.mul(n/2)),e.sub(o.mul(n/2)),t.sub(o.mul(i/2)),t.add(o.mul(i/2))])}};var ib=class{constructor(e,t,n,i){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=n,this.Index=i}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var ob=class{constructor(e,t,n){this.metroline=e,this.station=t,this.polyPoint=n}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var sb=class{constructor(e,t,n){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=n}debStop(){return this.SerialNumber==28&&this.Position.sub(new p(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}static less(e,t){return e.SerialNumber<t.SerialNumber}static greater(e,t){return e.SerialNumber>t.SerialNumber}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var ab=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Ct=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Ct.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new Zt(ye);for(let i of this.metroGraphData.VirtualStations())t.Enqueue(i,-this.CalculatePotential(i,e));let n=!1;for(;!t.IsEmpty();){let i={priority:0},o=t.DequeueAndGetPriority(i);if(i.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),n=!0)}return n}TryGrowHub(e,t){let n=this.CalculateAllowedHubRadius(e);if(e.Radius>=n)return!1;let i=t?Ct.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=i)return!1;let a=.05*(i-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,n);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let n=t?Ct.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return n<=e.Radius?0:(n-e.Radius)/n}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let i of e.Neighbors){let o=i.Position.sub(e.Position).length;t=Math.min(t,o/1.05-i.Radius)}let n=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return n<t&&(t=n-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,n){let i=1;for(let o of n.Neighbors){let l=e.GetWidthSSN(o,n,t.EdgeSeparation)/2+t.EdgeSeparation;i=Math.max(i,l)}return i=Math.min(i,2*t.MaxHubRadius),i}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,n){return Ct.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,n,n.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,n,i){let o=Ct.CalculateIdealHubRadius(e,t,n);if(n.Neighbors.length>1){let a=n.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Ct.GetMinRadiusForTwoAdjacentBundles(o,n,i,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let n=e.MaxHubRadius;for(let i of t.Neighbors)n=Math.min(n,t.Position.sub(i.Position).length/2);return n}static GetMinRadiusForTwoAdjacentBundles(e,t,n,i,o,a,l){let u=a.GetWidthSSN(t,i,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Ct.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,n,i.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,n,i,o,a,l){if(o<E.distanceEpsilon||a<E.distanceEpsilon)return e;let u=p.anglePCP(n,t,i);if(u=Math.min(u,Math.PI*2-u),u<E.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),f=a/(4*c),y=2*Math.sqrt(d*d+(f*f+2*(d*(f*h))));return y=Math.min(y,2*l.MaxHubRadius),y=Math.max(y,e),y}};var Ys=class{constructor(e,t,n,i){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=n,this.cdt=i}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Ct.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],n=e[1],i=this.metroGraphData.GetIjInfo(t,n);i.cachedBundleCost=this.costCalculator.BundleCost(t,n,t.Position),t.cachedBundleCost+=i.cachedBundleCost,n.cachedBundleCost+=i.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.GetCdtTree();e.CdtTriangle=t.FirstHitNodeWithPredicate(e.Position,Ys.testPointInside).UserData,e.cachedIdealRadius=Ct.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let n of e.Neighbors){n.IsReal||(n.cachedIdealRadius=Ct.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,n),n.cachedRadiusCost=this.costCalculator.RadiusCost(n,n.Position));let i=this.metroGraphData.GetIjInfo(e,n);n.cachedBundleCost-=i.cachedBundleCost,i.cachedBundleCost=this.costCalculator.BundleCost(e,n,e.Position),e.cachedBundleCost+=i.cachedBundleCost,n.cachedBundleCost+=i.cachedBundleCost}}static testPointInside(e,t){return $e.PointIsInsideOfTriangle(e,t)?1:0}};var Ku=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size==0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let n=this.mainMap.get(e);if(n)return n.get(t)}has(e,t){let n=this.mainMap.get(e);return n?n.has(t):!1}set(e,t,n){let i=this.mainMap.get(e);i||(i=new Map,this.mainMap.set(e,i)),i.set(t,n)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[n,i]of t)yield[e,n,i]}*keys(){for(let[e,t]of this.mainMap)for(let[n]of t)yield[e,n]}};var lb=class{constructor(e,t,n,i,o,a,l,u){this.cachedEnterableLooseForEnd=new Je;this.bundlingSettings=i,this.regularEdges=e,o!=null?this.Cdt=o:this.Cdt=Nn.CreateConstrainedDelaunayTriangulation(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new Br(this,i,t,c=>c.getELP()),this.tightIntersections=new Br(this,i,n,c=>c.EnterableTightPolylines),this.cdtIntersections=new Zu(this,i),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],i=this.edgeInfoDictionary.get(n[0],n[1]);return i?i.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(n[0],n[1])}MoveNode(e,t){let n=e.Position;this.PointToStations.deleteP(n),this.PointToStations.set(t,e),e.Position=t;for(let i of this.MetroNodeInfosOfNode(e))i.PolyPoint.point=t;for(let i of this.MetroNodeInfosOfNode(e)){let o=i.Metroline,a=i.PolyPoint.prev.point,l=i.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(n).length-a.sub(n).length}for(let i of e.Neighbors)this.ink+=t.sub(i.Position).length-n.sub(i.Position).length;this.SortNeighbors(e);for(let i of e.Neighbors)this.SortNeighbors(i)}GetWidthSSN(e,t,n){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(i[0],i[1]);return o?o.Width+(o.Count-1)*n:0}GetWidthAN(e,t){let n=0;for(let o of e)n+=o.Width;let i=e.length;return n+=i>0?(i-1)*t:0,n}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,n=new _E.Stack,i=new Ve;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(i.has(o.point)){let l=o.next;do{let u=n.top;if(!u.equal(a))i.delete(u),n.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else n.push(a),i.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new Je;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!=e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let n=new sb(this.Stations.length,t,e.point);this.PointToStations.set(e.point,n),this.Stations.push(n)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let n=new ib(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(n),this.PointToStations.get(n.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(n.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let n=this.PointToStations.get(t.Polyline.start),i;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,n=i)i=this.PointToStations.get(o.next.point),Cs(e,n,i),Cs(e,i,n)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new p(360.561,428.416)).length<.1&&t.Position.sub(new p(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let n=this.edgeInfoDictionary.get(e,t);return n||(n=new ab,this.edgeInfoDictionary.set(e,t,n),n)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new Ku,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let n=this.metrolines[t];this.InitMetroNodeInfos(n),this.InitNodeEnterableLoosePolylines(n,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(n,this.regularEdges[t]),n.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let n=this.PointToStations.get(t.point);n.MetroNodeInfos.push(new ob(e,n,t))}}InitNodeEnterableLoosePolylines(e,t){let n=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let i=e.Polyline.startPoint.next;i!=null&&i.next!=null;i=i.next){let o=this.PointToStations.get(i.point);o.getELP()!=null?o.setELP(On(o.getELP(),n)):o.setELP(new Set(n))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let n of this.LooseTree.AllHitItems_(e))v.PointRelativeToCurveLocation(e,n)==2&&t.AddEnterableLoosePolyline(n);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let n of this.TightTree.AllHitItems_(e))v.PointRelativeToCurveLocation(e,n)==2&&t.AddEnterableTightPolyline(n)}InitNodeEnterableTightPolylines(e,t){let n=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let i=e.Polyline.startPoint.next;i!=null&&i.next!=null;i=i.next){let o=this.PointToStations.get(i.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=On(a,n):o.EnterableTightPolylines=new Set(n)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,n=e.Position;e.Neighbors.sort((i,o)=>fi(t.sub(n),i.Position.sub(n),o.Position.sub(n)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,n=this.PointToStations.get(t.start),i;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,n=i){i=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(n,i);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.Cdt.GetCdtTree();for(let t of this.Stations)t.CdtTriangle=e.FirstHitNodeWithPredicate(t.Position,Ys.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let n=e.sourceAndTargetLoosePolylines();return v.PointRelativeToCurveLocation(t,n[0])==0&&v.PointRelativeToCurveLocation(t,n[1])==0}};function fi(s,e,t){let n=p.crossProduct(s,t),i=s.dot(t),o=p.crossProduct(s,e),a=s.dot(e);return K(o,0)&&Ju(a,0)?K(n,0)&&Ju(i,0)?0:1:K(n,0)&&Ju(i,0)?-1:K(o,0)||K(n,0)||o*n>0?du(p.crossProduct(t,e),0):-du(Math.sign(o),0)}function Ju(s,e){return du(s,e)>=0}var UE=ne(fn());var gi=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,n){return(e-t)*n.InkImportance}static PathLengthsError(e,t,n,i){return(e-t)*(i.PathLengthImportance/n)}static RError(e,t,n){return e<=t?0:n.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,n){return e<=t?0:n.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let n=t.InkImportance*e.Ink;for(let i of e.Metrolines)n+=t.PathLengthImportance*i.Length/i.IdealLength;return n+=this.CostOfForces(e),n}static CostOfForces(e){let t=0;for(let n of e.VirtualStations())t=t+n.cachedRadiusCost;for(let n of e.VirtualEdges()){let i=n[0],o=n[1];t+=e.GetIjInfo(i,o).cachedBundleCost}return t}InkGain(e,t){let n=this.metroGraphData.Ink,i=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;i-=a.sub(e.Position).length,i+=a.sub(t).length}return gi.InkError(n,i,this.bundlingSettings)}PathLengthsGain(e,t){let n=0;for(let i of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=i.Metroline.Length,a=i.PolyPoint.prev.point,l=i.PolyPoint.next.point,u=i.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;n+=gi.PathLengthsError(o,u,i.Metroline.IdealLength,this.bundlingSettings)}return n}RadiusGain(e,t){let n=0;return n=n+e.cachedRadiusCost,n=n-this.RadiusCost(e,t),n}RadiusCost(e,t){let n;p.closeDistEps(e.Position,t)?n=e.cachedIdealRadius:n=Ct.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let i={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,n,i))return gi.Inf;let o=0;for(let a of i.touchedObstacles){let l=a[1].sub(t).length;o+=gi.RError(n,l,this.bundlingSettings)}return o}BundleGain(e,t){let n=e.cachedBundleCost;for(let i of e.Neighbors){let o=this.BundleCost(e,i,t);if(Ju(o,gi.Inf))return-gi.Inf;n-=o}return n}BundleCost(e,t,n){let i=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,n,t.Position,i,o))return gi.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=gi.BundleError(i/2,u,this.bundlingSettings)}return a}},er=gi;er.Inf=1e9;var FE=ne(po());var ub=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new Je;this.interestingPoints=new Ve;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){z2(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){W2(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new FE.Queue;for(let n of this.Polylines)t.enqueue(n);for(;t.length>0;){let n=t.dequeue();e.delete(n);let i=this.ProcessPolyline(n);i!=null&&(e.has(n)||(e.add(n),t.enqueue(n)),e.has(i)||(e.add(i),t.enqueue(i)))}}ProcessPolyline(e){let t=new Map;for(let n=e.startPoint.next;n!=null;n=n.next){this.FillDepartedPolylinePoints(n,t);for(let i of this.pathsThroughPoints.get(n.point)){let o=t.get(i.polyline);if(o){if(this.ProcessFlip(n,o))return i.polyline;t.delete(i.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let n=e.prev.point;for(let i of this.pathsThroughPoints.get(n))this.IsNeighborOnTheSamePolyline(i,e)||t.has(i.polyline)||t.set(i.polyline,i)}ProcessFlip(e,t){let n=e.polyline,i=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(n),u=this.polylineToEdgeGeom.get(i);if(l.lineWidth!=u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!xs(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(n,o,a),h=c[0],d=c[1],f=c[2];c=this.FindPointsOnPolyline(i,o,a);let y=c[0],S=c[1],C=c[2],T=this.FindRelationOnFirstPoint(h,y,f,C),I=this.FindRelationOnLastPoint(d,S,f,C);return T!=2&&I!=2||T==1||I==1?!1:(this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.Swap(h,y,d,S,f,C),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,n){let i,o;for(let a=e.startPoint;a!=null;a=a.next)if(i==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];i=a}else o==null&&a.point.equal(n)&&(o=a);else if(a.point.equal(n))return[i,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let n=e;n!=null;n=n.next)if(n==t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,n,i){let o=e,a=t;for(;;){let l=this.Prev(e,n),u=this.Prev(t,i);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,n,i)}FindRelationOnLastPoint(e,t,n,i){let o=e,a=t;for(;;){let l=this.Next(e,n),u=this.Next(t,i);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,n).point.equal(this.Prev(t,i).point);)e=this.Next(e,n),t=this.Prev(t,i);return this.PolylinesIntersect(e,t,o,a,n,i)}PolylinesIntersect(e,t,n,i,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(n,o),h=this.Prev(n,o),d=this.Next(t,a),f=this.Prev(i,a);if(e.point.equal(n.point)){let y=e.point,S=fi(h.point.sub(y),f.point.sub(y),u.point.sub(y)),C=fi(h.point.sub(y),d.point.sub(y),u.point.sub(y));return S==C?1:2}else{let y=fi(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),S=fi(c.point.sub(n.point),f.point.sub(n.point),h.point.sub(n.point));return y==S?1:2}}Swap(e,t,n,i,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),n,o),u=this.GetRangeOnPolyline(this.Next(t,a),i,a);this.ChangePolylineSegment(e,n,o,u),this.ChangePolylineSegment(t,i,a,l),zo.RemoveSelfCyclesFromPolyline(e.polyline),zo.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,n,i){let o=e;for(let a of i){let l=yt.mkFromPoint(a.point);l.polyline=o.polyline,n?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}n?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,n){let i=new Array;for(let o=e;o!=t;o=this.Next(o,n))i.push(o);return i}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new Ve;for(let n=e.startPoint;n!=null;n=n.next){if(n==e.startPoint){if(n.prev!=null)return!1}else if(n.prev.next!=n)return!1;if(n==e.endPoint){if(n.next!=null)return!1}else if(n.next.prev!=n)return!1;if(t.has(n.point))return!1;t.add(n.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function z2(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function W2(s,e,t){let n=s.get(e);!n||(n.delete(t),n.size==0&&s.deleteP(e))}var zo=class{constructor(e,t){this.foundCrossings=new Ve;this.crossingsThatShouldBecomeHubs=new Ve;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new ci;for(let t of this.Vertices())t.next&&e.set(new dt(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length==0)return!1;let e=new ci,t=new hs(null);for(let l of this.Vertices()){let u=k.mkOnPoints([l.point]);u.pad(E.intersectionEpsilon),t.Add(u,l.point)}let n=mu(this.Edges(),l=>k.mkPP(l.First,l.Second));xt(n,n,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let i=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||i||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((n,i)=>ye(Ie(n,e.First),Ie(i,e.First)))}InsertPointsIntoPolylines(e){let t=!1;for(let n of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(n,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let n=!1;for(let i=e.Polyline.startPoint;i.next!=null;i=i.next)this.InsertPointsOnPolypoint(i,t,e)&&(n=!0);return n}InsertPointsOnPolypoint(e,t,n){let i=new dt(e.point,e.next.point),o=e.point!=i.First,a=t.get(i);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(n,a[c]))continue;let h=yt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(n,a[c]))continue;let h=yt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)zo.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,n=new Je;for(let i=e.startPoint;i!=null;i=i.next){let o=i.point,a=n.get(o);if(a){for(let l=a.next;l!=i.next;l=l.next)n.deleteP(l.point);a.next=i.next,i.next.prev=a,t=!0}else n.set(i.point,i)}return t}ReduceEdgeCrossings(){let e=new ub(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=uS(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let n=e.startPoint.next;n!=null&&n.next!=null;n=n.next)if(this.pointsToDelete.has(n.point)&&p.getTriangleOrientation(n.prev.point,n.point,n.next.point)==2){let i=n.prev,o=n.next;i.next=o,o.prev=i,n=i,t=!0}return t}IntersectTwoEdges(e,t,n,i){let o=R.IntersectPPPP(e.First,e.Second,t.First,t.Second);if(o){let a=this.FindExistingVertexOrCreateNew(i,o);(this.AddVertexToSplittingList(e,n,a)||this.AddVertexToSplittingList(t,n,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let n=e.RootNode.FirstHitNode(t);if(n!=null)return n.UserData;let i=k.mkOnPoints([t]);return i.pad(E.intersectionEpsilon),e.Add(i,t),t}AddVertexToSplittingList(e,t,n){if(!v.closeIntersectionPoints(n,e.First)&&!v.closeIntersectionPoints(n,e.Second)){let i=t.get(e);if(i||(i=new Array,t.set(e,i)),!i.find(o=>o.equal(n)))return i.push(n),!0}return!1}};var kE=ne(Ud());var zd=class{isCorrectlyOrienected(){return p.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!=1}get Count(){return this.points.length}constructor(e,t,n,i){this.BelongsToRealNode=i,this.Curve=t,this.Position=n,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return p.middle(this.StartPoint,this.EndPoint)}get ParameterSpan(){return Vh(this.Curve)}get Span(){return this.SpanBetweenTwoPoints(this.parStart,this.parEnd)}SpanBetweenTwoPoints(e,t){return e<=t?t-e:t-e+this.ParameterSpan}RotateLeftPoint(e,t){return e==0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e==0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,n){let i=this.ParameterSpan*n;return t+=e*i,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,n){let i=this.ParameterSpan*n;e!=0&&(this.ParStart=this.AdjustParam(this.ParStart+e*i)),t!=0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*i))}RelativeOrderOfBasesIsPreserved(e,t,n){let i=this.ParameterSpan*n,o=this.parStart+e*i,a=this.parStart<this.parEnd?this.parEnd+t*i:this.parEnd+this.ParameterSpan+t*i;if(o>a||this.SpanBetweenTwoPoints(o,a)>this.ParameterSpan/2)return!1;if(this.Prev==null||this.SpanBetweenTwoPoints(this.Prev.ParMid,this.ParMid)>i&&this.SpanBetweenTwoPoints(this.ParMid,this.Next.ParMid)>i)return!0;let l=this.RotateLeftPoint(t,n),u=this.RotateRigthPoint(e,n),c=p.middle(l,u),h=this.MidPoint;return!(p.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=p.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||p.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=p.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var $s=class{constructor(e,t,n,i){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=n,this.HalfWidthArray=i,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let n=this.SourceBase.Curve.boundingBox.diagonal/2,i=this.TargetBase.Curve.boundingBox.diagonal/2,o=Br.Create4gon(this.SourceBase.Position,this.TargetBase.Position,n*2,i*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&v.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,n=e.sub(t).normalize(),i=n.rotate90Ccw(),o=p.middle(e,t),a=n.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(i.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>$s.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(i.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=$s.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(i.mul($s.FeasibleWidthEpsilon),new p(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new p(0,0),i.mul(-$s.FeasibleWidthEpsilon),l,u))&&(d=2*$s.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"/tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,n){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,n)}SetRLParamsIfWidthIsFeasible_(e,t,n,i){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(R.mkPP(n.add(e),i.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>v.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(R.mkPP(n.add(t),i.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>v.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),vt.assert(this.SourceBase.isCorrectlyOrienected()&&this.TargetBase.isCorrectlyOrienected()),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(R.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"/tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,n){let i=v.getAllIntersections(e,this.SourceBase.Curve,!0);if(i.length==0)return n.par=0,t.par=0,null;let o;if(i.length==1?o=i[0]:this.SourceBase.IsParent?o=i[0].par0<i[1].par0?i[1]:i[0]:o=i[0].par0<i[1].par0?i[0]:i[1],i=v.getAllIntersections(e,this.TargetBase.Curve,!0),i.length==0)return n.par=0,t.par=0,null;let a;return i.length==1?a=i[0]:this.TargetBase.IsParent?a=i[0].par0>i[1].par0?i[1]:i[0]:a=i[0].par0>i[1].par0?i[0]:i[1],t.par=o.par1,n.par=a.par1,R.mkPP(o.x,a.x)}RotateBy(e,t,n,i,o){let a=e!=0||t!=0,l=n!=0||i!=0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(n,i,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let n=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),i=n.length;i>=E.tolerance?(n=n.div(i),this.TargetBase.Tangents[t]=n,this.SourceBase.Tangents[e-1-t]=n.neg()):vt.assert(!1)}}UpdatePointsOnBundleBase(e){let t=e.length,n=e.Points,i=R.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];n[0]=i.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],n[l]=i.value(a*o)}RotationIsLegal(e,t,n,i,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!=0||n!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||i!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!=0||i!=0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!=0||n!=0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!=0||t!=0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(n!=0||i!=0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(n,i,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(n=>v.intersectionOne(R.mkPP(e,t),n,!1)!=null)==null}},Wd=$s;Wd.FeasibleWidthEpsilon=.1;var Hd=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,n,i){this.Segment=e,this.Reversed=t,this.Index=n,this.BundleBase=i}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var Be=class{constructor(e,t,n){this.fixedBundles=new kE.HashSet;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=n}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=fe.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let n=new zd(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,n);let i=new zd(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,i),v.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!=0?(n.IsParent=!0,As(this.internalBases,e.BoundaryCurve,n),As(this.externalBases,t.BoundaryCurve,i)):v.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!=0?(i.IsParent=!0,As(this.externalBases,e.BoundaryCurve,n),As(this.internalBases,t.BoundaryCurve,i)):(As(this.externalBases,e.BoundaryCurve,n),As(this.externalBases,t.BoundaryCurve,i));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new Wd(n,i,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));n.OutgoingBundleInfo=i.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,n=e[0].CurveCenter;e.sort((i,o)=>fi(t.sub(n),i.OppositeBase.Position.sub(n),o.OppositeBase.Position.sub(n)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let n=0;n<t;n++)e[n].Prev=e[(n-1+t)%t],e[n].Next=e[(n+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let n=this.metroGraphData.PointToStations.get(t.prev.point),i=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=i.BundleBases.get(n),l=i.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(n,i,e),c=this.metroOrdering.GetLineIndexInOrder(o,i,e),h=a.OrientedHubSegments[u]=new Hd(null,!1,u,a),d=l.OrientedHubSegments[c]=new Hd(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,n=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,n.Position),n.ParEnd=n.ParStart=this.GetBaseMiddleParamInDirection(n,n.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,n){let i=e.Curve;if(i instanceof fe){let l=i;if(l.isArc())return p.angle(l.aAxis,n.sub(t))}let a=v.getAllIntersections(i,R.mkPP(t,n),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(n))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let n=0;n<t;n++){let i=e[n],o=i.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(i,o),vt.assert(i.isCorrectlyOrienected()&&o.isCorrectlyOrienected())}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let n=VE(e,t);if(n==null||K(n.start,n.end))return;let i=n.rbaseMiddle,o=n.lbaseMiddle;if(i<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(n.end*a+n.start*l)/(l+a);e.ParStart=e.AdjustParam(u+E.distanceEpsilon),t.ParEnd=t.AdjustParam(u-E.distanceEpsilon),vt.assert(VE(e,t)==null)}RegularCut(e,t,n,i,o,a){let l=(o*i+a*e)/(o+a),u=Math.min(t,i),c=Math.max(e,n);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=Be.MaxParameterChange,t={cost:this.Cost()},n=0;for(;n++<Be.MaxIterations;){let i=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,i,t.cost),e<Be.MinParameterChange)break}}UpdateParameterChange(e,t,n){return n+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let n=!1;for(let i of this.Bundles)this.fixedBundles.has(i)||(this.OptimizeBundle(i,e,t)?n=!0:this.fixedBundles.add(i));return n}OptimizeBundle(e,t,n){let i=this.CostBi(e);if(i<Be.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<Be.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(Be.Deltas[u][0],Be.Deltas[u][1],0,0,e,i,t);c>Be.CostDeltaThreshold&&c>o&&(l=u,a=Be.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,Be.Deltas[u][0],Be.Deltas[u][1],e,i,t),c>Be.CostDeltaThreshold&&c>o&&(l=Be.Deltas.length-1,a=u,o=c)}return o<Be.CostDeltaThreshold?!1:(n.cost-=o,e.RotateBy(Be.Deltas[l][0],Be.Deltas[l][1],Be.Deltas[a][0],Be.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,n,i,o,a,l){if(!o.RotationIsLegal(e,t,n,i,l))return 0;o.RotateBy(e,t,n,i,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,n*-1,i*-1,l),a-u}CostBi(e){return Be.SeparationCoeff*this.SeparationCost(e)+(Be.SqueezeCoeff*this.SqueezeCost(e)+(Be.AssymetryCoeff*this.AssymetryCost(e)+Be.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let n=0;return n=n+Be.CenterCoeff*this.CenterCostBi(e),n>t||(n=n+Be.SeparationCoeff*this.SeparationCost(e),n>t)||(n=n+Be.SqueezeCoeff*this.SqueezeCost(e),n>t)||(n=n+Be.AssymetryCoeff*this.AssymetryCost(e)),n}SqueezeCost(e){let n=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),i=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(n)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(n)),a=Math.abs(e.TotalRequiredWidth-i)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(i-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,n=Math.min(e.InitialMidParameter,t),i=Math.max(e.InitialMidParameter,t),o=Math.min(i-n,n+(e.ParameterSpan-i));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,n=0;for(let i of e.OrientedHubSegments){let o=i.Index,a=i.Other.Index,l=e.Points[o],u=e.Tangents[o],c=i.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],f=e.Count+c.Count;n+=this.GetAssymetryCostOnData(l,u,h,d,t)/f}return n}GetAssymetryCostOnData(e,t,n,i,o){let a=e.sub(n),l=a.length;if(l<E.distanceEpsilon)return 0;let u=t.add(i).dot(a),c=p.crossProduct(a,t),h=p.crossProduct(a,i),d=c-h,f=u*u+d*d,y=c*c+h*h;return 10*f+o*y}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let n=e.Curve,i=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,n),o=Math.min(e.Span,t.Span);return Math.exp(i/(o*10))-1}IntervalsOverlapLength(e,t,n,i,o){let a=o.parStart,l=o.parEnd;return e<t?n<i?this.IntersectRegularIntervals(e,t,n,i):this.IntersectRegularIntervals(e,t,n,l)+this.IntersectRegularIntervals(e,t,a,i):n<i?this.IntersectRegularIntervals(e,l,n,i)+this.IntersectRegularIntervals(a,t,n,i):this.IntersectRegularIntervals(e,l,n,l)+this.IntersectRegularIntervals(a,t,a,i)}IntersectRegularIntervals(e,t,n,i){let o=Math.max(e,n),a=Math.min(t,i);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let n=Be.SeparationCoeff*this.SeparationCost(t),i=Be.AssymetryCoeff*this.AssymetryCost(t),o=Be.SqueezeCoeff*this.SqueezeCost(t),a=Be.CenterCoeff*this.CenterCostBi(t);e+=(n+i)/2+o+a}return e}},an=Be;an.Deltas=[[1,-1],[1,-1]],an.SeparationCoeff=1,an.SqueezeCoeff=1,an.CenterCoeff=10,an.AssymetryCoeff=1,an.MaxIterations=200,an.MaxParameterChange=8/360,an.MinParameterChange=.1/360,an.CostThreshold=1e-5,an.CostDeltaThreshold=.01;function VE(s,e){let t=s.ParEnd,n=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-s.ParameterSpan,i=e.ParEnd,o=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-e.ParameterSpan;vt.assert(n<t),vt.assert(o<i),vt.assert(n<=s.Curve.parEnd),vt.assert(t<=s.Curve.parEnd),vt.assert(o<=s.Curve.parEnd),vt.assert(i<=s.Curve.parEnd);let a=Math.min(t,i),l=Math.max(n,o);return l<=a?{start:l,end:a,rbaseMiddle:(n+t)/2,lbaseMiddle:(o+i)/2}:null}var cb=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var cl=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let n=new dt(e.Position,t.Position),i=this.bundles.get(n).Metrolines;if(e.Position==n.First)for(let o=0;o<i.length;o++)yield i[o];else for(let o=i.length-1;o>=0;o--)yield i[o]}GetLineIndexInOrder(e,t,n){let i=new dt(e.Position,t.Position),o=e.Position!=i.First,a=this.bundles.get(i).LineIndexInOrder;return o?a.size-1-a.get(n):a.get(n)}BuildOrder(){this.bundles=new ci;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let n=new dt(t.point,t.next.point),i=this.bundles.get(n);i||this.bundles.set(n,i=new cb),i.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((n,i)=>this.CompareLines(n,i,e.First,e.Second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let n=0;n<t.Metrolines.length;n++)t.LineIndexInOrder.set(t.Metrolines[n],n)}}CompareLines(e,t,n,i){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(n,i,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(n,i,t,o);let c=o.polyPoint,h=o.next,d=o.prev,f=a,y=c,S,C;for(;(C=u(f))!=null&&(S=d(y))!=null&&C.point.equal(S.point);){let T=new dt(C.point,f.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!C.point.equal(T.First));f=C,y=S}if(C!=null&&S!=null){let T=f.point;return-cl.IsLeft(l(f).point.sub(T),C.point.sub(T),S.point.sub(T))}for(f=a,y=c;(C=l(f))!=null&&(S=h(y))!=null&&C.point.equal(S.point);){let T=new dt(C.point,f.point);if(this.bundles.get(T).orderFixed)return this.CompareOnFixedOrder(T,e,t,!f.point.equal(T.First));f=C,y=S}if(C!=null&&S!=null){let T=f.point;return cl.IsLeft(u(f).point.sub(T),C.point.sub(T),S.point.sub(T))}return ye(e.Index,t.Index)}CompareOnFixedOrder(e,t,n,i){let o=this.bundles.get(e).LineIndexInOrder;return(i?-1:1)*ye(o.get(t),o.get(n))}FindStationOnLine(e,t,n,i){for(let o=n.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){i.next=a=>a.next,i.prev=a=>a.prev,i.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){i.next=a=>a.prev,i.prev=a=>a.next,i.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,n){return fi(e,t,n)}};var ke=class extends me{constructor(e,t){super(null);this.metroGraphData=e,this.bundlingSettings=t}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Ct(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new cl(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new an(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let e=0;e<this.metroGraphData.Metrolines.length;e++)this.CreateCurveLine(this.metroGraphData.Metrolines[e],this.metroGraphData.Edges[e])}CreateCurveLine(e,t){let n=new v,o=ke.FindCurveStart(this.metroGraphData,this.metroOrdering,e),a=ke.HubSegsOfLine(this.metroGraphData,this.metroOrdering,e);for(let l of a)l!=null&&(n.addSegment(R.mkPP(o,l.start)),n.addSegment(l),o=l.end);n.addSegment(R.mkPP(o,ke.FindCurveEnd(this.metroGraphData,this.metroOrdering,e))),t.curve=n}static FindCurveStart(e,t,n){let i=e.PointToStations.get(n.Polyline.startPoint.point),o=e.PointToStations.get(n.Polyline.startPoint.next.point),a=i.BundleBases.get(o),l=a.IsParent?t.GetLineIndexInOrder(i,o,n):t.GetLineIndexInOrder(o,i,n);return a.Points[l]}static FindCurveEnd(e,t,n){let i=e.PointToStations.get(n.Polyline.endPoint.prev.point),o=e.PointToStations.get(n.Polyline.endPoint.point),a=o.BundleBases.get(i),l=a.IsParent?t.GetLineIndexInOrder(o,i,n):t.GetLineIndexInOrder(i,o,n);return a.Points[l]}static*HubSegsOfLine(e,t,n){for(let i=n.Polyline.startPoint.next;i.next!=null;i=i.next)yield ke.SegOnLineVertex(e,t,n,i)}static SegOnLineVertex(e,t,n,i){let o=e.PointToStations.get(i.prev.point),a=e.PointToStations.get(i.point),l=a.BundleBases.get(o),u=t.GetLineIndexInOrder(o,a,n);if(l.OrientedHubSegments[u]==null||l.OrientedHubSegments[u].Segment==null){let c=e.PointToStations.get(i.next.point),h=a.BundleBases.get(c),d=t.GetLineIndexInOrder(c,a,n);return R.mkPP(l.Points[u],h.Points[d])}return l.OrientedHubSegments[u].Segment}CreateSegmentsInsideHubs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let n=this.metroGraphData.PointToStations.get(t.prev.point),i=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=i.BundleBases.get(n),l=i.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(n,i,e),c=this.metroOrdering.GetLineIndexInOrder(o,i,e),h=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?ke.StandardBezier(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]):ke.BiArc(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]);a.OrientedHubSegments[u].Segment=h,l.OrientedHubSegments[c].Segment=h}static ShowHubs(e,t,n,i,o=[]){let a=ke.GetAllDebugCurves(t,e);n!=null&&a.push(oe.mkDebugCurveTWCI(255,1,"red",ve.CreateDiamond(5,25,n.Position))),a=a.concat(o)}static GetAllDebugCurves(e,t){return ke.GraphNodes(t).concat(ke.VertexDebugCurves(e,t)).concat(ke.DebugEdges(t))}static DebugEdges(e){return e.Edges.map(t=>oe.mkDebugCurveTWCI(40,.1,"gray",t.curve))}static VertexDebugCurves(e,t){return ke.DebugCircles(t).concat(ke.DebugHubBases(t)).concat(ke.DebugSegs(t)).concat(ke.BetweenHubs(e,t))}static BetweenHubs(e,t){let n=[];for(let i of t.Metrolines){let o=ke.GetInterestingSegs(t,e,i),a=ke.GetMonotoneColor(i.Polyline.start,i.Polyline.end,o);for(let l of o)n.push(oe.mkDebugCurveTWCI(100,i.Width,a,R.mkPP(l[0],l[1])))}return n}static GetInterestingSegs(e,t,n){let i=new Array;if(e.Stations.length==0||e.Stations[0].BundleBases==null||e.Stations[0].BundleBases.size==0)return[];let o=ke.FindCurveStart(e,t,n),a=ke.HubSegsOfLine(e,t,n);for(let l of a)l!=null&&(i.push([o,l.start]),o=l.end);return i.push([o,ke.FindCurveEnd(e,t,n)]),i}static GetMonotoneColor(e,t,n){return"green"}static DebugHubBases(e){let t=new Array;for(let n of e.Stations)for(let i of n.BundleBases.values())t.push(oe.mkDebugCurveTWCI(100,1,"red",R.mkPP(i.EndPoint,i.StartPoint)));return t}static DebugCircles(e){return e.Stations.map(t=>oe.mkDebugCurveTWCI(100,.1,"blue",ve.mkCircle(t.Radius,t.Position)))}static DebugSegs(e){let t=new Array;for(let n of e.VirtualStations())for(let i of n.BundleBases.values())for(let o of i.OrientedHubSegments)if(o!=null)if(o.Segment==null){let a=o.Other.BundleBase,l=o.Index,u=o.Other.Index;t.push(R.mkPP(i.Points[l],a.Points[u]))}else t.push(o.Segment);return t.map(n=>oe.mkDebugCurveTWCI(100,.01,"green",n))}static GraphNodes(e){return e.Edges.map(n=>n.sourcePort.Curve).concat(e.Edges.map(n=>n.targetPort.Curve)).map(n=>oe.mkDebugCurveTWCI(40,1,"black",n))}static BiArc(e,t,n,i){let o=e.sub(n);if(o.length<E.distanceEpsilon)return null;let a=o.dot(t.sub(i)),l=-t.dot(i);if(t.dot(n.sub(e))<=0&&t.dot(i)<=0)return ke.StandardBezier(e,t,n,i);let u=2*(l-1),c=2*a,h=o.dot(o),d;if(Math.abs(u)<E.distanceEpsilon)if(Math.abs(c)>E.distanceEpsilon)d=-h/c;else return null;else{let B=c*c-4*u*h;B<0&&(B=0),B=Math.sqrt(B),d=(-c+B)/(2*u),d<0&&(d=(-c-B)/(2*u))}let f=e.add(t.mul(d)),y=n.add(i.mul(d)),S=p.middle(f,y),C=p.getTriangleOrientation(e,f,S),T=p.getTriangleOrientation(S,y,n);if(C!=T)return ke.StandardBezier(e,t,n,i);let I=new v;return I.addSegs([ke.ArcOn(e,f,S),ke.ArcOn(S,y,n)]),I}static ArcOn(e,t,n){let i={center:null};if(Math.abs(p.signedDoubledTriangleArea(e,t,n))<1e-4||!ke.FindArcCenter(e,t,n,i))return R.mkPP(e,n);let o=i.center,a=Ie(e,o);if(Ie(e,t)/a<1e-4)return R.mkPP(e,n);let u=e.sub(o),c=Math.atan2(u.y,u.x),h=n.sub(o),d=Math.atan2(h.y,h.x),f=d-c;if(f<0&&(f+=2*Math.PI,d+=2*Math.PI),f<=Math.PI)return new fe(c,d,new p(a,0),new p(0,a),o);for(d>2*Math.PI&&(d-=2*Math.PI),c=Math.PI-c,d=Math.PI-d,c<0&&(c+=2*Math.PI);d<c;)d+=2*Math.PI;return f=d-c,new fe(c,d,new p(-a,0),new p(0,a),o)}static FindArcCenter(e,t,n,i){let o=t.sub(e).rotate90Cw(),a=t.sub(n).rotate90Cw();return i.center=p.lineLineIntersection(e,e.add(o),n,n.add(a)),i.center!=null}static StandardBezier(e,t,n,i){let o=Ie(e,n)/4;return Ne.mkBezier([e,e.add(t.mul(o)),n.add(i.mul(o)),n])}FanBezierSegs(){let e=!0,t=5,n=0;for(;e&&n++<t;){e=!1;for(let i of this.metroGraphData.Stations)for(let o of i.BundleBases.values())e||(e=this.FanEdgesOfHubSegment(o))}}FanEdgesOfHubSegment(e){let t=!1;for(let n=0;n<e.Count-1;n++)t||(t=this.FanCouple(e,n,e.CurveCenter,e.Curve.boundingBox.diagonal/2));return t}FanCouple(e,t,n,i){let o=e.OrientedHubSegments[t],a=e.OrientedHubSegments[t+1];if(o==null||R.IntersectPPPP(o.Segment.start,o.Segment.end,a.Segment.start,a.Segment.end)||p.getTriangleOrientation(o.value(0),o.value(.5),o.value(1))!=p.getTriangleOrientation(a.value(0),a.value(.5),a.value(1)))return!1;let u=this.BaseLength(o),c=this.BaseLength(a);return Math.abs(u-c)<E.intersectionEpsilon?!1:u>c?this.AdjustLongerSeg(o,a,n,i):this.AdjustLongerSeg(a,o,n,i)}AdjustLongerSeg(e,t,n,i){let o=e.value(0).sub(t.value(0)),a=e.value(1).sub(t.value(1)),l=Math.min(o.length,a.length),u=t.value(.5),c=Math.max(o.length,a.length);return this.NicelyAligned(e.Segment,o,a,u,l,c)==0?!1:this.FitLonger(e,o,a,u,l,c,n,i)}FitLonger(e,t,n,i,o,a,l,u){let c=e.Segment,h=c.start,d=c.end,f=0,y=10,S=c.start.mul(1-ke.SqueezeBound).add(c.B(1).mul(ke.SqueezeBound)),C=c.end.mul(1-ke.SqueezeBound).add(c.B(2).mul(ke.SqueezeBound)),T=c.B(1).mul(2).sub(c.start),I=c.B(2).mul(2).sub(c.end),B={highP:T};this.PullControlPointToTheCircle(c.start,B,l,u),T=B.highP;let w=this.NicelyAligned(c,t,n,i,o,a);do{if(w==-1){let M=p.middle(c.B(1),S),F=p.middle(c.B(2),C);T=c.B(1),I=c.B(2),c=new Ne(h,M,F,d)}else{let M=p.middle(c.B(1),T),F=(c.B(2),I);S=c.B(1),C=c.B(2),c=new Ne(h,M,F,d)}if((w=this.NicelyAligned(c,t,n,i,o,a))==0)return e.Segment=c,e.Other.Segment=c,!0;if(f++>y)return!1}while(!0)}PullControlPointToTheCircle(e,t,n,i){let o=p.ProjectionToLine(e,t.highP,n),a=Math.sqrt(i*i-o.sub(n).lengthSquared),l=t.highP.sub(o),u=l.length;u>a&&(t.highP=o.add(l.mul(a/u)))}NicelyAligned(e,t,n,i,o,a){let u=e.value(.5).sub(i),c=u.length;return t.dot(u)<0||n.dot(u)<0||c<o-.001?1:c>a+.001?-1:0}BaseLength(e){return e.value(0).sub(e.value(1)).lengthSquared}},Qi=ke;Qi.debCount=0,Qi.SqueezeBound=.2;var bn=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new er(this.metroGraphData,this.bundlingSettings),this.cache=new Ys(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.Cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,n){return new bn(e,t).FixRoutingP(n)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=bn.MaxStep,n=Number.POSITIVE_INFINITY,i=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<bn.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=n;n=er.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,n);let u=i;if(i=this.metroGraphData.VirtualStations().map(c=>c.Position),t<bn.MinStep||this.Converged(t,u,i))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let n=e[0],i=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(n,i),a=R.mkPP(n.Position,i.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>v.CurvesIntersect(a,u));return l.length>0?(Qi.ShowHubs(t,null,null,"/tmp/badcross.svg",[oe.mkDebugCurveTWCI(200,1,"Brown",a),oe.mkDebugCurveTWCI(200,1,"Red",ve.mkCircle(2,n.Position)),oe.mkDebugCurveTWCI(200,1,"Blue",ve.mkCircle(5,i.Position)),oe.mkDebugCurveTWCI(100,1,"Blue",ve.mkCircle(5,i.Position))].concat(l.map(u=>oe.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let n of e){let i=this.metroGraphData.PointToStations.get(n);i&&!i.IsReal&&t.add(i)}return t}}Converged(e,t,n){let i=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(n[l]).lengthSquared,i+=t[l].lengthSquared;return Math.sqrt(o/i)<bn.MinRelativeChange}UpdateMaxStep(e,t,n){return n+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(bn.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let n of this.stationsForOptimizations)if(this.TryMoveStation(n)){e=!0,t.add(n);for(let i of n.Neighbors)i.IsReal||t.add(i)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length==0)return!1;let n=this.BuildStepLength(e,t);if(n<bn.MinStep&&(t=H2(),n=this.BuildStepLength(e,t),n<bn.MinStep))return!1;let i=t.mul(n),o=e.Position.add(i);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let n of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(k.mkOnPoints([t]),i=>v.PointRelativeToCurveLocation(t,i)!=0))if(e.getELP().has(n)==!1)return!1;for(let n of e.Neighbors){let i=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(n,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(n.Position,t,n.CdtTriangle,i))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),n=this.BuildForceForPathLengths(e),i=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(n.add(i.add(o)));return a.length<.1?new p(0,0):a.normalize()}BuildStepLength(e,t){let n=bn.MinStep,i=this.CostGain(e,e.Position.add(t.mul(n)));if(i<.01)return 0;for(;2*n<=bn.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(n*2)));if(o<=i)break;n*=2,i=o}return n}CostGain(e,t){let i=this.costCalculator.RadiusGain(e,t);if(i<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return i+a+l+o}BuildForceForInk(e){let t=new p(0,0);for(let i of e.Neighbors){let o=i.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new p(0,0);for(let i of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=i.Metroline,a=i.PolyPoint.next.point,l=i.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new p(0,0),n=e.cachedIdealRadius,i={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,n,i))throw Qi.ShowHubs(this.metroGraphData,null,e,"/tmp/hubs.svg",[oe.mkDebugCurveTWCI(255,1,"Brown",Br.containingPoly),oe.mkDebugCurveTWCI(100,1,"Blue",ve.mkCircle(n,e.Position))]),new Error;for(let l of i.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/n),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new p(0,0);for(let i of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,i,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,i,e.Position,i.Position,o/2,a)||Qi.ShowHubs(this.metroGraphData,null,e,"/tmp/inside_forbid.svg",[oe.mkDebugCurveTWCI(100,.2,"Blue",R.mkPP(e.Position,i.Position)),oe.mkDebugCurveTWCI(100,.2,"Red",ve.mkCircle(2,e.Position)),oe.mkDebugCurveTWCI(100,.2,"Red",ve.mkCircle(3,i.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},Dn=bn;Dn.MaxIterations=100,Dn.MaxStep=50,Dn.MinStep=1,Dn.MinRelativeChange=5e-4;function H2(){return new p(1+2*Tu(),1+2*Tu())}var Zi=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let n=new Zi(e,t);n.GlueConflictingStations(),n.UnglueEdgesFromBundleToSaveInk(!0);let i=0,o=10;for(;++i<o;){let a=n.GlueConflictingStations();if(a||(a=n.RelaxConstrainedEdges()),a||(a=i<=3&&n.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=n.GlueCollinearNeighbors(i)),a||(a=i==3&&n.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,n.RemoveDoublePathCrossings(),n.UnglueEdgesFromBundleToSaveInk(!0);n.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,n=new Set;if(xt(e,e,(o,a)=>this.TryToGlueStations(o,a,t,n)),t.size==0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let i=new Ve;for(let o of n){i.add(o.Position);for(let a of o.Neighbors)a.IsReal||i.add(a.Position)}return this.metroGraphData.Initialize(!1),Dn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,i),!0}GetCirclesHierarchy(){for(let n of this.metroGraphData.VirtualStations())n.Radius=this.GetCurrentHubRadius(n);let e=this.metroGraphData.VirtualStations().map(t);return _e(e);function t(n){let i=n.Position,o=Math.max(n.Radius,5),a=new p(o,o),l=k.mkPP(i.add(a),i.sub(a));return Ke(n,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,n=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let i of e.Neighbors)n=Math.min(n,e.Position.sub(i.Position).length);return n}}TryToGlueStations(e,t,n,i){if(!xs(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,i,n)||this.TryGlueOrdered(t,e,i,n)}TryGlueOrdered(e,t,n,i){return!i.has(e)&&!n.has(e)&&this.StationGluingIsAllowed(e,t,i)?(this.Map(e,t,n,i),!0):!1}Map(e,t,n,i){i.set(e,t),n.add(t)}StationGluingIsAllowed(e,t,n){for(let o of e.Neighbors){let a=Zi.Glued(o,n),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,n)<0)}ComputeCostDeltaAfterStationGluing(e,t,n){let i=e.Position.sub(t.Position).length;if(e.Radius>=i||t.Radius>=i)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=Zi.Glued(u,n);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)==0?c.Position.sub(t.Position).length:0}o+=er.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,f=d.prev,y=d.next;h-=f.point.sub(e.Position).length+y.point.sub(e.Position).length,h+=f.point.sub(t.Position).length+y.point.sub(t.Position).length,o+=er.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let n=this.metroGraphData.Metrolines[t].Polyline;for(let a of n)if(!this.metroGraphData.PointToStations.has(a))return;let i=!1;for(let a of n)if(e.has(this.metroGraphData.PointToStations.get(a))){i=!0;break}if(!i)return;let o=Array.from(n).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=$.mkFromPoints(Zi.GluedPolyline(o,e))}static GluedPolyline(e,t){let n,i=new UE.Stack;i.push(e[0]);let o=new Set;for(n=1;n<e.length-1;n++){let a=Zi.Glued(e[n],t);if(o.has(a)){for(;i.top!=a;)o.delete(i.pop());continue}p.closeDistEps(a.Position,i.top.Position)||(o.add(a),i.push(a))}return i.push(e[n]),Array.from(i).reverse().map(a=>a.Position)}static Glued(e,t){var n;return(n=t.get(e))!=null?n:e}UnglueEdgesFromBundleToSaveInk(e){let t=new ci;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new dt(a.point,a.next.point);Zp(t,l,o)}}let n=new Ve,i=!1;for(let o of this.metroGraphData.Metrolines){let a=On(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,n,a)&&(i=!0)}return i&&this.metroGraphData.Initialize(!1),(e||i)&&Dn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:n),i}TrySeparateOnPolyline(e,t,n,i){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,n,i)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,n,i){return this.SeparationShortcutAllowed(e,t,i)?(n.add(e.point),n.add(e.next.point),n.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,n){let i=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(i),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=Ln(l.getELP(),c.getELP()),d=cS([n,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,i,o,a)<0)}GetInkgain(e,t,n,i,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,f=n.sub(i).length,y=i.sub(o).length,S=n.sub(o).length;a.size==u.size&&(d-=f),l.size==u.size&&(d-=y);let C=t.get(new dt(n,o));(!C||C.size==0)&&(d+=S),c+=er.InkError(h,d,this.bundlingSettings);for(let F of u){let U=this.polylineLength.get(F),te=U-(f+y-S);c+=er.PathLengthsError(U,te,F.IdealLength,this.bundlingSettings)}let T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(n)),I=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),B=this.metroGraphData.GetWidthAN(Array.from(Vi(a,u)),this.bundlingSettings.EdgeSeparation),w=Ct.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,n,o,i,I,B,this.bundlingSettings);w>T&&(c-=er.RError(w,T,this.bundlingSettings)),T=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let M=this.metroGraphData.GetWidthAN(Array.from(Vi(l,u)),this.bundlingSettings.EdgeSeparation);return w=Ct.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(T,o,i,n,M,I,this.bundlingSettings),w>T&&(c-=er.RError(w,T,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let n=e.point,i=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=Ie(n,i),h=Ie(i,o),d=Ie(n,o);a.size==u.size&&(this.ink-=c),l.size==u.size&&(this.ink-=h);let f=t.get(new dt(n,o));(!f||f.size==0)&&(this.ink+=d);for(let y of u){let S=this.polylineLength.get(y);this.polylineLength.set(y,S-(c+h-d))}for(let y of u){let S=Array.from(y.Polyline.polylinePoints()).find(C=>C.point.equal(i));this.RemovePolypoint(S),Kp(t,[n,i],y),Kp(t,[i,o],y),hS(t,[n,o],y)}}FindPolylines(e,t){let n=e.point,i=e.next.point,o=e.next.next.point,a=t.get_(n,i),l=t.get_(i,o),u=On(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,n=e.next;t.next=n,n.prev=t}GlueCollinearNeighbors(e){let t=new Ve,n=!1;for(let i of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(i,t,e)&&(n=!0);return n&&(this.metroGraphData.Initialize(!1),Dn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),n}GlueCollinearNeighborsSPN(e,t,n){if(e.Neighbors.length<=1)return!1;let i=new Ku,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],i,n);if(i.isEmpty)return!1;for(let a of i)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,n,i,o){if(p.anglePCP(t.Position,e.Position,n.Position)<this.bundlingSettings.AngleThreshold){let l=Ie(t.Position,e.Position),u=Ie(n.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,n)){this.AddEdgeToGlue(e,n,t,t.Position,i);return}}else if(this.EdgeGluingIsAllowedSSS(e,n,t)){this.AddEdgeToGlue(e,t,n,n.Position,i);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,n);this.EdgeGluingIsAllowedSSSP(e,t,n,h)&&this.AddEdgeToGlue(e,n,t,h,i)}}}ConstructGluingPoint(e,t,n){let i=Math.min(Ie(t.Position,e.Position),Ie(n.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(n.Position.sub(e.Position).normalize());return e.Position.add(o.mul(i/2))}EdgeGluingIsAllowedSSS(e,t,n){if(t.IsReal||n.IsReal||!xs(t.getELP(),n.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,n,t.Position,n.Position))return!1;let i=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,n);return!(Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(R.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!i.has(u.seg1))||Te.IntersectionsOfLineAndRectangleNodeOverPolylineLR(R.mkPP(t.Position,n.Position),this.metroGraphData.LooseTree).find(u=>!i.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,n,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,n,i){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(i,0,On(t.getELP(),n.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,i)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,i)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(n,null,n.Position,i)||this.ComputeCostDeltaAfterEdgeGluing(e,t,n,i)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,n,i){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-Ie(e.Position,n.Position)-Ie(e.Position,t.Position)+Ie(e.Position,i)+Ie(i,t.Position)+Ie(i,n.Position);o+=er.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,n).Metrolines){let f=d.Length,y=d.Length-Ie(e.Position,n.Position)+Ie(e.Position,i)+Ie(i,n.Position);o+=er.PathLengthsError(f,y,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let f=d.Length,y=d.Length-Ie(e.Position,t.Position)+Ie(e.Position,i)+Ie(i,t.Position);o+=er.PathLengthsError(f,y,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Ct.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,n,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=er.RError(h,c,this.bundlingSettings)),u>Ie(e.Position,i)&&!e.IsReal&&(o-=er.RError(u,Ie(e.Position,i),this.bundlingSettings)),o}AddEdgeToGlue(e,t,n,i,o){o.has(n,e)||o.has(t,e)||o.has(e,n)||o.has(e,t)||(o.set(e,n,i),o.set(e,t,i))}GlueEdge(e){let t=e[0],n=e[1],i=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(n.Position)?this.SplitPolylinePoint(o,i):o.prev!=null&&o.prev.point.equal(n.Position)&&this.SplitPolylinePoint(o.prev,i)}SplitPolylinePoint(e,t){if(e.point==t||e.next.point==t)return;let n=yt.mkFromPoint(t);n.polyline=e.polyline,n.next=e.next,n.prev=e,n.next.prev=n,n.prev.next=n}RelaxConstrainedEdges(){let e=new Ve,t=!1;for(let n of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(n[0],n[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),Dn.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,n){let i=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*i/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(Ie(e.Position,c[1]),Ie(t.Position,c[1])),d=Ie(e.Position,t.Position);if(h/d<.1)continue;let y=Ie(c[0],c[1]);(l==-1||y<l)&&(l=y,u=c[1])}if(l==-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,On(e.getELP(),t.getELP())))return!1;n.add(u),n.add(e.Position),n.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new zo(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),Dn.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var hl=class{constructor(e,t,n){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=n,n.ClearPrevEdgesTable();for(let i of n.Vertices())i.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new Zt;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!hl.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!hl.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof Ut}ProcessNeighbor(e,t,n){let i=t.Length,o=this._current.Distance+i;o>=this.upperBound||(this.targets.has(n)&&(this.upperBound=o,this.closestTarget=n),this._visGraph.PreviosVertex(n)==null?(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.Enqueue(n,o)):o<n.Distance&&(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.DecreasePriority(n,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var hb=class extends me{constructor(e,t,n,i,o,a,l,u,c,h){super(null);this.bundlingSettings=i,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=e,this.regularEdges=e.filter(d=>d.source!=d.target),this.VisibilityGraph=n,this.shortestPathRouter=t,this.LoosePadding=o,this.LooseHierarchy=l,this.TightHierarchy=a,this.EdgeLooseEnterable=u,this.EdgeTightEnterable=c,this.loosePolylineOfPort=h}ThereAreOverlaps(e){return on(e,e,v.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let e=new lb(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.CdtProperty,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);Zi.FixRouting(e,this.bundlingSettings),new Qi(e,this.bundlingSettings).run()}FixChildParentEdges(){for(let e of this.regularEdges){let t=e.sourcePort,n=e.targetPort;if(t.Curve.boundingBox.containsRect(n.Curve.boundingBox)){let i=v.intersectionOne(t.Curve,R.mkPP(e.curve.start,e.curve.end),!1),o=e.curve;o.startPoint.point=i.x}if(n.Curve.boundingBox.containsRect(t.Curve.boundingBox)){let i=v.intersectionOne(n.Curve,R.mkPP(e.curve.start,e.curve.end),!0),o=e.curve;o.endPoint.point=i.x}}}static CreateConstrainedDelaunayTriangulation(e){let t=Array.from(e.GetAllLeaves()),n=e.irect,i=n.diagonal/4,o=n.clone();return o.pad(i),hb.GetConstrainedDelaunayTriangulation(t.concat([o.perimeter()]))}static GetConstrainedDelaunayTriangulation(e){let t=new $e(null,e,null);return t.run(),t}FixLocationsForHookAnywherePorts(e){for(let t of e){let n=t.sourcePort instanceof mt;if(n){let i=t.sourcePort;i.SetLocation(this.FigureOutHookLocation(i.LoosePolyline,t.targetPort,t))}else if(n=t.targetPort instanceof mt,n){let i=t.targetPort;i.SetLocation(this.FigureOutHookLocation(i.LoosePolyline,t.sourcePort,t))}}}FigureOutHookLocation(e,t,n){return t instanceof $t?this.FigureOutHookLocationForClusterOtherPort(e,t,n):this.FigureOutHookLocationForSimpleOtherPort(e,t,n)}FigureOutHookLocationForClusterOtherPort(e,t,n){let i=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),a=new hl(Array.from(t.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(e).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let l of i)l.IsTransparent=!1;return a[a.length-1].point}FigureOutHookLocationForSimpleOtherPort(e,t,n){let i=t.Location,o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),l=new Mo(this.VisibilityGraph.FindVertex(i),Array.from(e).map(u=>this.VisibilityGraph.FindVertex(u)),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.CdtProperty!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let e=new Map;this.shortestPathRouter.FillCrossedCdtEdges(e);let t=this.GetPathsOnCdtEdge(e);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(t)}GetPathsOnCdtEdge(e){let t=new Map;for(let n of e.keys())for(let i of e.get(n))Cs(t,i,n);return t}CalculateEdgeWidthShrinkCoeff(e){let t=0,n=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(e,n))return n;let i=!1;for(;!i||Math.abs(n-t)>.01;){let o=(t+n)/2;this.EdgeSeparationIsOkMN(e,o)?(t=o,i=!0):n=o}return t}EdgeSeparationIsOkMN(e,t){for(let n of e.keys())if(!this.EdgeSeparationIsOk(n,e.get(n),t))return!1;return!0}EdgeSeparationIsOk(e,t,n){return Array.from(t).map(o=>this.bundlingSettings.ActualEdgeWidth(o,n)).reduce((o,a)=>o+a,0)<=e.Capacity}RouteSelfEdges(){for(let e of this.edgesToRoute)if(e.source==e.target){let t={smoothedPolyline:null};e.curve=Ge.RouteSelfEdge(e.source.boundaryCurve,this.LoosePadding*2,t)}}FixArrowheads(){for(let e of this.edgesToRoute)Xt.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}},Nn=hb;Nn.SuperLoosePaddingCoefficient=1.1;var db=class{constructor(e,t,n){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=n}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var fb=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source==this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var Gn=class{constructor(e,t,n){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.CdtProperty=t,this.Gates=n}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let n of t.InEdges){let i=new db(n,this.VisibilityVerticesToSdVerts.get(n.Source),this.VisibilityVerticesToSdVerts.get(n.Target)),o=this.VisibilityVerticesToSdVerts.get(n.Source);e.InBoneEdges.push(i),o.OutBoneEdges.push(i)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new fb(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new $,n=this.EdgesToRouteSources.get(e);t.addPoint(n.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(n.Point)?(t.addPoint(a.TargetPoint),n=a.Target):(t.addPoint(a.SourcePoint),n=a.Source);e.curve=t,e.sourcePort instanceof $t&&Gn.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof $t&&Gn.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let n=t.closestParameter(e.end);e.addPoint(t.value(n))}static ExtendPolylineStartToClusterBoundary(e,t){let n=t.closestParameter(e.start);e.PrependPoint(t.value(n))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.CdtProperty!=null&&this.CdtProperty.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let n of t)n.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let i=0;i<this.vertexArray.length;i++){let o=this.vertexArray[i];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),n=this.RouteEdgeWithGroups();for(let i of t)i.IsTransparent=!1;return n}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new Zt,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e==0);if(t!=null)return t;for(let n=0;n<this.vertexArray.length;n++)this.vertexArray[n].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let n={priority:0},i=this.Queue.DequeueAndGetPriority(n);if(!(n.priority>=this.LowestCostToTarget)){for(let o=0;o<i.OutBoneEdges.length;o++){let a=i.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(i,a,e,t)}for(let o=0;o<i.InBoneEdges.length;o++){let a=i.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(i,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,n,i){i&&n.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,n,i){i&&n.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,n){let i=this.GetEdgeAdditionalCost(n,e.Cost);if(!(t.Cost<=i))if(t.Cost=i,t.PrevEdge=n,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,i);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof $t&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),i+o<this.LowestCostToTarget&&(this.LowestCostToTarget=i+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.CdtProperty!=null&&this.BundlingSettings.CapacityOverflowCoefficient!=0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity==t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let n=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*n+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*n)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.CdtProperty==null||this.BundlingSettings.CapacityOverflowCoefficient==0)return 0;let t=0;for(let n of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,n);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,n=e.Source.Triangle,i=new Set,o=e.TargetPoint;if($e.PointIsInsideOfTriangle(o,n))return i;let a=new Xs(n,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&i.add(l)}return i}static CostOfCrossingCdtEdge(e,t,n,i){let o=n.lineWidth*t.edgeWidthShrinkCoeff;i.Capacity!=i.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=i.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,n,i){return this.AdjacentToSourceOrTarget(i)?0:Gn.CostOfCrossingCdtEdge(e,t,n,i)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner==this.sourceLoosePoly||e.lowerSite.Owner==this.sourceLoosePoly||e.upperSite.Owner==this.targetLoosePoly||e.lowerSite.Owner==this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let n;if(e instanceof $t){n=e.LoosePolyline;for(let o of n){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof mt){n=e.LoosePolyline;for(let o of n)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let i=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=i[0].boundingBox.diagonal;n=i[0];for(let a=1;a<i.length;a++){let l=i[a],u=l.boundingBox.diagonal;u<o&&(o=u,n=l)}}return n}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,n){let i=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(i);t?(o.IsSourceOfRouting=!0,o.Cost=n,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.CdtProperty!=null&&(this.capacityOverlowPenaltyMultiplier=Gn.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)Gn.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.Constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,n=e.lowerSite.Owner;if(t!=n){let i=Dt.DistancePoint(new Dt(t),e.lowerSite.point),o=Dt.DistancePoint(new Dt(n),e.upperSite.point);e.Capacity=(i+o)/2}}SetVertexTriangles(){let e=_e(Array.from(this.CdtProperty.GetTriangles()).map(n=>Ke(n,n.BoundingBox()))),t=_e(this.vertexArray.map(n=>Ke(n,k.mkOnPoints([n.Point]))));cr(e,t,(n,i)=>this.TryToAssigenTriangleToVertex(n,i));for(let n of this.vertexArray);}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&$e.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let n of this.EdgesToRoutes.get(t))for(let i of this.CrossedCdtEdgesOfBoneEdge(n))this.AdjacentToSourceOrTarget(i)||Cs(e,t,i)}}};var dl=class{constructor(e,t,n,i,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=i,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=mu(n,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new Nn(e.edges,new Gn(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(n,i)=>v.PointRelativeToCurveLocation(n,i)!=0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,n={preGraphs:e};if(this.UniteConnectedPreGraphs(n),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=dl.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let n=Di(t),i=new Array;for(let o of n){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],i.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=i;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let n of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(n)}static GetIntersectionGraphOfPreGraphs(e){let t=dl.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?sr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),n=mu(t,o=>e[o].boundingBox),i=new Array;return xt(n,n,(o,a)=>i.push(new ae(o,a))),i}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,n=e[0],i=this.GetPortCurve(n.sourcePort),o=i.boundingBox;t.add(i),t.add(n.targetPort.Curve),o.addRec(n.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return Qu.constructorStatic(e,t)}};var Xe=class extends me{constructor(e,t,n=2,i=1.5,o=30*(Math.PI/180),a=null,l=null){super(l);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.portLocationsToLoosePolylines=new Je;this.multiEdgesSeparation=5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this._edges=t,this.BundlingSettings=a,this.geomGraph=e,this.LoosePadding=i,this.tightPadding=n,this.coneAngle=o}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(e){this.continueOnOverlaps=e}*edges(){if(this._edges!=null)for(let e of this._edges)yield e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(e){this.multiEdgesSeparation=e}static mk2(e,t){return Xe.mk5(e,t.Padding,t.PolylinePadding,t.ConeAngle,t.BundlingSettings)}static mk4(e,t,n,i){return new Xe(e,Array.from(e.edges()),t,n,i,null)}static mk5(e,t,n,i,o){return new Xe(e,Array.from(e.edges()),t,n,i,o)}static mk6(e,t,n,i,o,a){let l=Xe.mk4(e,t,n,i),u=nn.GetShapes(o,a);return l.Initialize(u,i),l}Initialize(e,t){this.rootShapes=e.filter(n=>n.Parents==null||n.Parents.length==0),this.coneAngle=t,this.coneAngle==0&&(this.coneAngle=Math.PI/6)}run(){if(this.geomGraph.isEmpty())return;let e=hr.GetShapes(this.geomGraph,this._edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.edgeRoutingSettings.BundlingSettings),this.Initialize(e,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[e,t]of this.portsToShapes){let n=new Set;Xe.EdgesAttachedToPortAvoidTheNode(e)||n.add(t),this.portsToEnterableShapes.set(e,n)}for(let e of this.rootShapes)for(let t of e.Descendants())for(let n of t.Ports){let i=this.portsToEnterableShapes.get(n);ja(i,Array.from(t.Ancestors()).filter(o=>o.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(e){return e instanceof Qt||e instanceof $t}SetLoosePolylinesForAnywherePorts(){for(let[e,t]of this.shapesToTightLooseCouples)for(let n of e.Ports){if(n instanceof mt){let o=n;o.LoosePolyline=t.LooseShape.BoundaryCurve}if(n instanceof $t){let o=n;o.LoosePolyline=t.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new oi;for(let e of this.root.Children){let t=this.shapesToTightLooseCouples.get(e).LooseShape;this.BindLooseShapesUnderShape(e),this.looseRoot.AddChild(t)}}BindLooseShapesUnderShape(e){let t=this.shapesToTightLooseCouples.get(e).LooseShape;for(let n of e.Children){let i=this.shapesToTightLooseCouples.get(n).LooseShape;t.AddChild(i),this.BindLooseShapesUnderShape(n)}}CalculateShapeToBoundaries(e){if(this.ProgressStep(),e.Children.length==0)return;for(let n of e.Children)this.CalculateShapeToBoundaries(n);let t=new Bu(e,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples);t.Calculate(),this.OverlapsDetected||(this.OverlapsDetected=t.OverlapsDetected)}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(e){this._overlapsDetected=e}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*Nn.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let e=new Array;for(let t of this._edges){let n=this.EdgePassport(t),i=e.find(o=>xs(o.passport,n));i||(i={passport:n,edges:[]},e.push(i)),i.edges.push(t)}return e}RouteOnVisGraph(){if(this.ancestorSets=Xe.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let e of this.GroupEdgesByPassport()){let t=e.passport,n=this.GetObstaclesFromPassport(t),i=this.CreateInteractiveEdgeRouter(Array.from(n));this.RouteEdgesWithTheSamePassport(e,i,n)}else this.RouteBundles()}RouteEdgesWithTheSamePassport(e,t,n){let i={regularEdges:[],multiEdges:[]};if(this.RouteMultiEdgesAsBundles){this.SplitOnRegularAndMultiedges(e.edges,i);for(let o of i.regularEdges)this.RouteEdge(t,o);i.multiEdges!=null&&(this.ScaleDownLooseHierarchy(t,n),this.RouteMultiEdges(i.multiEdges,t,e.passport))}else for(let o of e.edges)this.RouteEdge(t,o)}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}RouteEdge(e,t){let n=this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(t);this.ProgressStep(),this.RouteEdgeInternal(t,e),Xe.SetTransparency(n,!1)}ScaleDownLooseHierarchy(e,t){let n=new Array;for(let i of t){let o=this.shapesToTightLooseCouples.get(i);n.push(Gt.LoosePolylineWithFewCorners(o.TightPolyline,o.Distance/1.1))}e.LooseHierarchy=Xe.CreateLooseObstacleHierarachy(n),e.ClearActivePolygons(),e.AddActivePolygons(n.map(i=>new Dt(i)))}RouteMultiEdges(e,t,n){let i=[];for(let l of n)for(let u of l.Children)i.push(u.BoundaryCurve);let o=new Jn;o.InkImportance=1e-5,o.EdgeSeparation=this.MultiEdgesSeparation,new dl(e,t,i,o,l=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(l)).run()}SplitOnRegularAndMultiedges(e,t){let n=new ci;for(let i of e)Xe.IsEdgeToParent(i)?t.regularEdges.push(i):Xe.RegisterInPortLocationsToEdges(i,n);t.multiEdges=null;for(let i of n.values())i.length==1||this.OverlapsDetected?ni(t.regularEdges,i):(t.multiEdges==null&&(t.multiEdges=new Array),t.multiEdges.push(i))}static RegisterInPortLocationsToEdges(e,t){let n,i=new dt(e.sourcePort.Location,e.targetPort.Location);n=t.get(i),n||(n=new Array,t.set(i,n)),n.push(e)}static IsEdgeToParent(e){return e.sourcePort instanceof mt||e.targetPort instanceof mt}CreateInteractiveEdgeRouter(e){let t=new Set(e.map(i=>this.shapesToTightLooseCouples.get(i).LooseShape.BoundaryCurve)),n=new Te(this.cancelToken);return n.ObstacleCalculator=new Gt(e.map(i=>i.BoundaryCurve),this.tightPadding,this.loosePadding,!1),n.VisibilityGraph=this.visGraph,n.TightHierarchy=this.CreateTightObstacleHierarachy(e),n.LooseHierarchy=Xe.CreateLooseObstacleHierarachy(Array.from(t)),n.UseSpanner=!0,n.LookForRoundedVertices=!0,n.TightPadding=this.tightPadding,n.LoosePadding=this.LoosePadding,n.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,n.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,n.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,n.AllowedShootingStraightLines=this.AllowedShootingStraightLines,n.AddActivePolygons(Array.from(t).map(i=>new Dt(i))),n}GetObstaclesFromPassport(e){if(e.size==0)return new Set(this.root.Children);let t=this.GetCommonAncestorsAbovePassport(e),n=this.GetAllAncestors(e),i=new Set;for(let l of e)for(let u of l.Children)n.has(u)||i.add(u);let o=Ln(new Set(e),i),a=new zE.Queue;for(let l of e)t.has(l)||a.enqueue(l);for(;a.length>0;){let l=a.dequeue();for(let u of l.Parents){for(let c of u.Children)n.has(c)||i.add(c);!t.has(u)&&!o.has(u)&&(a.enqueue(u),o.add(u))}}return i}GetAllAncestors(e){if(e.size==0)return new Set;let t=new Set(e);for(let n of e)t=Ln(t,this.ancestorSets.get(n));return t}GetCommonAncestorsAbovePassport(e){if(e.size==0)return new Set;let t=Array.from(e),n=this.ancestorSets.get(t[0]);for(let i=1;i<t.length;i++){let o=t[i];n=On(n,this.ancestorSets.get(o))}return n}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let e=this.GetLooseHierarchy(),t=Nn.CreateConstrainedDelaunayTriangulation(e),n=new Gn(o=>this.MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(o),t,this.FindCdtGates(t));new Nn(this._edges,n,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),e,this.enterableLoose,this.enterableTight,o=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(o))).run()}CreateTheMapToParentLooseShapes(e,t){for(let n of e.Children){let o=this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve;t.set(o,e),this.CreateTheMapToParentLooseShapes(n,t)}}FindCdtGates(e){let t=new Map;this.CreateTheMapToParentLooseShapes(this.root,t);let n=new Set;for(let i of e.PointsToSites.values())for(let o of i.Edges){if(o.CwTriangle==null&&o.CcwTriangle==null)continue;let a=i.Owner,l=o.lowerSite.Owner;if(a==l)continue;let u=t.get(a);if(u){let c=t.get(l);u==c&&n.add(o)}}return n}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let e of this.edges()){let t=new Set,n=new Set;this.GetEdgeEnterablePolylines(e,t,n),this.enterableLoose.set(e,t),this.enterableTight.set(e,n)}}GetEdgeEnterablePolylines(e,t,n){let i=this.portsToShapes.get(e.sourcePort),o=this.portsToShapes.get(e.targetPort);i!=this.root&&this.GetEnterablesForShape(i,t,n),o!=this.root&&this.GetEnterablesForShape(o,t,n)}GetEnterablesForShape(e,t,n){for(let i of this.ancestorSets.get(e)){let o=this.LoosePolyOfOriginalShape(i);o&&t.add(o);let a=this.TightPolyOfOriginalShape(i);a&&n.add(a)}}GetTightHierarchy(){return _e(Array.from(this.shapesToTightLooseCouples.values()).map(e=>Ke(e.TightPolyline,e.TightPolyline.boundingBox)))}GetLooseHierarchy(){let e=new Set;for(let t of this.shapesToTightLooseCouples.values())e.add(t.LooseShape.BoundaryCurve);return _e(Array.from(e).map(t=>Ke(t,t.boundingBox)))}ScaleLooseShapesDown(){for(let[,e]of this.shapesToTightLooseCouples)e.LooseShape.BoundaryCurve=Gt.LoosePolylineWithFewCorners(e.TightPolyline,e.Distance/Nn.SuperLoosePaddingCoefficient)}EdgePassport(e){let t=new Set,n=this.portsToShapes.get(e.sourcePort),i=this.portsToShapes.get(e.targetPort);return this.IsAncestor(n,i)?(ja(t,i.Parents),t.add(n),t):this.IsAncestor(i,n)?(ja(t,n.Parents),t.add(i),t):(n!=this.looseRoot&&ja(t,n.Parents),i!=this.looseRoot&&ja(t,i.Parents),t)}*AllPorts(){for(let e of this.edges())yield e.sourcePort,yield e.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let e of this.root.Descendants())for(let t of e.Ports)this.portsToShapes.set(t,e);for(let e of this.AllPorts())this.portsToShapes.has(e)||(this.root.Ports.add(e),this.portsToShapes.set(e,this.root))}RouteEdgeInternal(e,t){let n=new Array;e.sourcePort instanceof mt||ni(n,this.AddVisibilityEdgesFromPort(e.sourcePort)),e.targetPort instanceof mt||ni(n,this.AddVisibilityEdgesFromPort(e.targetPort));let i={smoothedPolyline:null};if(p.closeDistEps(e.sourcePort.Location,e.targetPort.Location)?e.curve=Ge.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.LoosePadding*2,e.GetMaxArrowheadLength()),i):e.curve=t.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e.sourcePort,e.targetPort,!0,i),e.smoothedPolyline=i.smoothedPolyline,e.curve==null)throw new Error;for(let o of n)Me.RemoveEdge(o);Xt.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!1)}*AddVisibilityEdgesFromPort(e){let t,n;if(e instanceof Qt||!(t=this.portsToShapes.get(e))||!(n=this.shapesToTightLooseCouples.get(t)))return;let i=n.LooseShape;for(let o of i.BoundaryCurve)this.visGraph.FindEdgePP(e.Location,o)==null&&(yield this.visGraph.AddEdgePP(e.Location,o))}MakeTransparentShapesOfEdgeGeometryAndGetTheShapes(e){let t=this.portsToShapes.get(e.sourcePort),n=this.portsToShapes.get(e.targetPort),i=new Array;for(let o of this.GetTransparentShapes(e.sourcePort,e.targetPort,t,n))o!=null&&i.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.sourcePort))i.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.targetPort))i.push(this.LooseShapeOfOriginalShape(o));return Xe.SetTransparency(i,!0),i}LooseShapeOfOriginalShape(e){return e==this.root?this.looseRoot:this.shapesToTightLooseCouples.get(e).LooseShape}LoosePolyOfOriginalShape(e){return this.LooseShapeOfOriginalShape(e).BoundaryCurve}TightPolyOfOriginalShape(e){return e==this.root?null:this.shapesToTightLooseCouples.get(e).TightPolyline}*GetTransparentShapes(e,t,n,i){for(let o of this.ancestorSets.get(n))yield o;for(let o of this.ancestorSets.get(i))yield o;Xe.EdgesAttachedToPortAvoidTheNode(e)||(yield n),Xe.EdgesAttachedToPortAvoidTheNode(t)||(yield i)}static SetTransparency(e,t){for(let n of e)n.IsTransparent=t}IsAncestor(e,t){let n;return t!=null&&(n=this.ancestorSets.get(t))!=null&&n.has(e)}static CreateLooseObstacleHierarachy(e){return _e(e.map(t=>Ke(t,t.boundingBox)))}CreateTightObstacleHierarachy(e){let t=e.map(n=>this.shapesToTightLooseCouples.get(n).TightPolyline);return _e(t.map(n=>Ke(n,n.boundingBox)))}CalculateVisibilityGraph(){let e=this.LineSweeperPorts!=null?Ve.mk(this.LineSweeperPorts):new Ve;this.ProcessHookAnyWherePorts(e),this.portRTree=Kn(Array.from(e.values()).map(t=>[k.rectangleOnPoint(t),t])),this.visGraph=new Me,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(e,t,n,i=null,o=null){let a=Array.from(t.Edges).map(l=>oe.mkDebugCurveTWCI(100,1,l.IsPassable!=null&&l.IsPassable()?"green":"black",R.mkPP(l.SourcePoint,l.TargetPoint)));if(n!=null)for(let l of n){a.push(oe.mkDebugCurveTWCI(100,.3,"brown",l));for(let u of l)a.push(oe.mkDebugCurveTWCI(100,1,"green",ve.mkCircle(1,u)))}if(i!=null)for(let l of i)a.push(oe.mkDebugCurveTWCI(100,10,"navy",l));if(o!=null)for(let l of o)a.push(oe.mkDebugCurveTWCI(100,10,"red",l))}ProcessHookAnyWherePorts(e){for(let t of this.edges())t.sourcePort instanceof mt||t.sourcePort instanceof $t||e.add(t.sourcePort.Location),t.targetPort instanceof mt||t.targetPort instanceof $t||e.add(t.targetPort.Location)}FillVisibilityGraphUnderShape(e){let t=e.Children;for(let h of t)this.FillVisibilityGraphUnderShape(h);let n=this.shapesToTightLooseCouples.get(e),i=n?n.LooseShape.BoundaryCurve:null,o=n?n.LooseShape:this.looseRoot,a=new Set(o.Children.map(h=>h.BoundaryCurve)),l=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(i),u=new Me,c=Bo.mk([],u,this.coneAngle,l,i);c.run(),u=new Me,c=Bo.mk(Array.from(a),u,this.coneAngle,l,i),c.run(),this.ProgressStep();for(let h of u.Edges)this.TryToCreateNewEdgeAndSetIsPassable(h,o);this.AddBoundaryEdgesToVisGraph(i)}get Bidirectional(){return this.bidirectional}set Bidirectional(e){this.bidirectional=e}TryToCreateNewEdgeAndSetIsPassable(e,t){let n=this.visGraph.FindEdgePP(e.SourcePoint,e.TargetPoint);n==null&&(n=this.visGraph.AddEdgePP(e.SourcePoint,e.TargetPoint),t!=null&&(n.IsPassable=()=>t.IsTransparent))}AddBoundaryEdgesToVisGraph(e){if(e==null)return;let t;for(let n=e.startPoint;t=n.nextOnPolyline,this.visGraph.AddEdgePP(n.point,t.point),t!=e.startPoint;n=t);}RemoveInsidePortsAndSplitBoundaryIfNeeded(e){let t=new Ve;if(e==null){for(let o of this.portRTree.GetAllLeaves())t.add(o);return this.portRTree.Clear(),t}let n=e.boundingBox,i=this.portRTree.GetAllIntersecting(n);for(let o of i)switch(v.PointRelativeToCurveLocation(o,e)){case 2:t.add(o),this.portLocationsToLoosePolylines.set(o,e),this.portRTree.Remove(k.rectangleOnPoint(o),o);break;case 1:this.portRTree.Remove(k.rectangleOnPoint(o),o),this.portLocationsToLoosePolylines.set(o,e);let a=Xe.FindPointOnPolylineToInsertAfter(e,o);if(a!=null)Et.InsertPointIntoPolylineAfter(e,a,o);else throw new Error;break}return t}static FindPointOnPolylineToInsertAfter(e,t){for(let n=e.startPoint;;){let i=n.nextOnPolyline;if(p.closeDistEps(t,n.point)||p.closeDistEps(t,i.point))return null;let o=p.distToLineSegment(t,n.point,i.point).dist;if(K(o,0))return n;if(n=i,n==e.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length==1){let e=this.rootShapes[0];if(e.BoundaryCurve==null){this.root=e;return}}this.rootWasCreated=!0,this.root=new oi(null);for(let e of this.rootShapes)this.root.AddChild(e)}RemoveRoot(){if(this.rootWasCreated)for(let e of this.rootShapes)e.RemoveParent(this.root)}static GetAncestorSetsMap(e){let t=new Map;for(let n of e.filter(i=>!t.has(i)))t.set(n,Xe.GetAncestorSet(n,t));return t}static GetAncestorSet(e,t){let n=new Set(e.Parents);for(let i of e.Parents){let o=t.get(i);o||t.set(i,o=Xe.GetAncestorSet(i,t));for(let a of o)n.add(a)}return n}static CreatePortsIfNeeded(e){for(let t of e){if(t.sourcePort==null){let n=t;new en(()=>n.source.boundaryCurve,()=>n.source.center,new p(0,0))}if(t.targetPort==null){let n=t;new en(()=>n.target.boundaryCurve,()=>n.target.center,new p(0,0))}}}static ComputeLooseSplinePadding(e,t){let n=2*t;return(e-n)/8}};function NE(s,e,t){let n=s.layoutSettings?s.layoutSettings.edgeRoutingSettings:nb(s);new Xe(s,e,n.Padding,n.PolylinePadding,n.coneAngle,n.BundlingSettings,t).run()}function DE(s,e,t){if(e)for(let n of e){if(t&&t.canceled)return;mr.RouteEdge(n,s.padding)}else for(let n of s.deepNodes()){if(t&&t.canceled)return;for(let i of n.outEdges())i.curve==null&&mr.RouteEdge(i,s.padding);for(let i of n.selfEdges())i.curve==null&&mr.RouteEdge(i,s.padding)}}var mr=class extends me{constructor(e,t){super(null);this.edges=e,this.padding=t}run(){Xe.CreatePortsIfNeeded(this.edges);for(let e of this.edges)mr.RouteEdge(e,this.padding)}static RouteEdge(e,t){let n=e;n.sourcePort==null&&(n.sourcePort=en.mk(()=>e.source.boundaryCurve,()=>e.source.center)),n.targetPort==null&&(n.targetPort=en.mk(()=>e.target.boundaryCurve,()=>e.target.center)),mr.ContainmentLoop(n,t)||(n.curve=mr.GetEdgeLine(e)),Xt.trimSplineAndCalculateArrowheadsII(n,n.sourcePort.Curve,n.targetPort.Curve,e.curve,!1)}static ContainmentLoop(e,t){let n=e.sourcePort.Curve,i=e.targetPort.Curve;if(n==null||i==null)return!1;let o=n.boundingBox,a=i.boundingBox,l=o.containsRect(a),u=!l&&a.containsRect(o);return l||u?(e.curve=mr.CreateLoop(o,a,u,t),!0):!1}static CreateLoop(e,t,n,i){return n?mr.CreateLoop_(e,t,i,!1):mr.CreateLoop_(t,e,i,!0)}static CreateLoop_(e,t,n,i){let o=e.center,a=mr.FindClosestPointOnBoxBoundary(e.center,t),l=a.sub(o),c=(Math.abs(l.x)<E.distanceEpsilon?Math.min(o.y-t.bottom,t.top-o.y):Math.min(o.x-t.left,t.right-o.x))/2,h=Math.min(n,c);l.length<=E.distanceEpsilon&&(l=new p(1,0));let d=l.normalize(),f=d.rotate(Math.PI/2),y=a.add(d.mul(n)),S=y.add(f.mul(h)),C=a.add(f.mul(h)),T=o.add(f.mul(h));return(i?it.mkFromPoints([T,C,S,y,a,o]):it.mkFromPoints([o,a,y,S,C,T])).createCurve()}static FindClosestPointOnBoxBoundary(e,t){let n=e.x-t.left<t.right-e.x?t.left:t.right,i=e.y-t.bottom<t.top-e.y?t.bottom:t.top;return Math.abs(n-e.x)<Math.abs(i-e.y)?new p(n,e.y):new p(e.x,i)}static GetEdgeLine(e){let t,n;e.sourcePort==null?(t=e.source.center,n=e.source.boundaryCurve):(t=e.sourcePort.Location,n=e.sourcePort.Curve);let i,o;e.targetPort==null?(i=e.target.center,o=e.target.boundaryCurve):(i=e.targetPort.Location,o=e.targetPort.Curve);let a=R.mkPP(t,i),l=v.getAllIntersections(n,a,!1);if(l.length>0){let u=a.trim(l[0].par1,1);u instanceof R&&(a=u,l=v.getAllIntersections(o,a,!1),l.length>0&&(u=a.trim(0,l[0].par1),u instanceof R&&(a=u)))}return a}static CreateSimpleEdgeCurveWithUnderlyingPolyline(e){let t=e.source.center,n=e.target.center;if(e.source==e.target){let i=2/(3*e.source.boundaryCurve.boundingBox.width),o=e.source.boundingBox.height/4;e.underlyingPolyline=mr.CreateUnderlyingPolylineForSelfEdge(t,i,o),e.curve=e.underlyingPolyline.createCurve()}else e.underlyingPolyline=it.mkFromPoints([t,n]),e.curve=e.underlyingPolyline.createCurve();Xt.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(e,t,n){let i=e.add(new p(0,n)),o=e.add(new p(t,n)),a=e.add(new p(t,n*-1)),l=e.add(new p(0,n*-1)),u=He.mkSiteP(e),c=new it(u);return u=He.mkSiteSP(u,i),u=He.mkSiteSP(u,o),u=He.mkSiteSP(u,a),u=He.mkSiteSP(u,l),He.mkSiteSP(u,e),c}static SetStraightLineEdgesWithUnderlyingPolylines(e){Xe.CreatePortsIfNeeded(Array.from(e.edges()));for(let t of e.edges())mr.CreateSimpleEdgeCurveWithUnderlyingPolyline(t)}};var Rn=class extends me{constructor(e,t,n,i,o,a){super(null);this.settings=e,this.OriginalGraph=t,this.Database=n,this.ProperLayeredGraph=o,this.LayerArrays=i,this.IntGraph=a}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){for(let e of this.OriginalGraph.deepNodes())for(let t of e.outEdges())t.curve||mr.RouteEdge(t,Math.max(t.source.padding,t.target.padding))}RouteFlatEdges(){}createRegularSplines(){for(let e of this.Database.RegularMultiedges()){let t=e.length,n=t==1&&!this.FanAtSourceOrTarget(e[0]);for(let i=Math.floor(t/2);i<t;i++)this.createSplineForNonSelfEdge(e[i],n);for(let i=Math.floor(t/2)-1;i>=0;i--)this.createSplineForNonSelfEdge(e[i],n)}}FanAtSourceOrTarget(e){return this.ProperLayeredGraph.OutDegreeIsMoreThanOne(e.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(e.target)}createSelfSplines(){for(let[e,t]of this.Database.Multiedges.keyValues()){let n=e;if(n.x==n.y){let i=this.Database.Anchors[n.x],o=i.leftAnchor;for(let a of t){let l=this.settings.NodeSeparation+(this.settings.MinNodeWidth+o),u=i.bottomAnchor/2,c=i.origin,h=c.add(new p(0,u)),d=c.add(new p(l,u)),f=c.add(new p(l,u*-1)),y=c.add(new p(0,u*-1)),S=He.mkSiteP(c),C=new it(S);S=He.mkSiteSP(S,h),S=He.mkSiteSP(S,d),S=He.mkSiteSP(S,f),S=He.mkSiteSP(S,y),He.mkSiteSP(S,c);let T=C.createCurve();if(a.curve=T,a.edge.underlyingPolyline=C,o=l,a.edge.label!=null){o+=a.edge.label.width;let I=T.value((T.parStart+T.parEnd)/2),B=new p(I.x+a.labelWidth/2,i.y),w=new p(a.edge.label.width/2,a.edge.label.height/2),M=k.mkPP(B.add(w),B.sub(w));a.edge.label.boundingBox=M}Xt.trimSplineAndCalculateArrowheadsII(a.edge,a.edge.source.boundaryCurve,a.edge.target.boundaryCurve,T,!1)}}}}createSplineForNonSelfEdge(e,t){e.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(e,t),e.IsVirtualEdge||(e.updateEdgeLabelPosition(this.Database.Anchors),Xt.trimSplineAndCalculateArrowheadsII(e.edge,e.edge.source.boundaryCurve,e.edge.target.boundaryCurve,e.curve,!0)))}drawSplineBySmothingThePolyline(e,t){let n=new kt(e,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),i=n.getSpline(t);e.reversed?(e.curve=i.reverse(),e.underlyingPolyline=n.Reverse().GetPolyline):(e.curve=i,e.underlyingPolyline=n.GetPolyline)}static UpdateLabel(e,t){let n=null;t.labelIsToTheRightOfTheSpline?(e.label.center=new p(t.x+t.rightAnchor/2,t.y),n=R.mkPP(e.labelBBox.leftTop,e.labelBBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.center=new p(t.x-t.leftAnchor/2,t.y),n=R.mkPP(e.labelBBox.rightTop,e.labelBBox.rightBottom));let i=Rn.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(i!=null&&v.getAllIntersections(e.curve,v.polyFromBox(e.labelBBox),!1).length==0){let o={curveClosestPoint:void 0,labelSideClosest:void 0};if(Rn.FindClosestPoints(o,i,n))Rn.ShiftLabel(e,o);else{let a=i.closestParameter(n.start),l=i.closestParameter(n.end);i.value(a).sub(n.start).length<i.value(l).sub(n.end).length?(o.curveClosestPoint=i.value(a),o.labelSideClosest=n.start):(o.curveClosestPoint=i.value(l),o.labelSideClosest=n.end),Rn.ShiftLabel(e,o)}}}static ShiftLabel(e,t){let n=e.lineWidth/2,i=t.curveClosestPoint.sub(t.labelSideClosest),o=i.length;o>n&&(e.label.center=e.label.center.add(i.div(o*(o-n))))}static FindClosestPoints(e,t,n){let i=v.minDistWithinIntervals(t,n,t.parStart,t.parEnd,n.parStart,n.parEnd,(t.parStart+t.parEnd)/2,(n.parStart+n.parEnd)/2);return i?(e.curveClosestPoint=i.aX,e.labelSideClosest=i.bX,!0):!1}static GetSegmentInFrontOfLabel(e,t){if(e instanceof v){let n=e;for(let i of n.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static GetNodeKind(e,t){return e==0?0:e<t.count?1:2}};var $u=class extends me{constructor(e,t,n){super(n);this.LayersAreDoubled=!1;if(e==null)return;this.originalGraph=e,this.sugiyamaSettings=t;let i=Array.from(e.shallowNodes());this.nodeIdToIndex=new Map;let o=0;for(let l of i)this.nodeIdToIndex.set(l.id,o++);let a=[];for(let l of this.originalGraph.edges()){let u=this.nodeIdToIndex.get(l.source.id);if(u==null)continue;let c=this.nodeIdToIndex.get(l.target.id);if(c==null)continue;let h=new ar(u,c,l);a.push(h)}this.IntGraph=new Gi(a,e.shallowNodeCount),this.IntGraph.nodes=i,this.database=new Gp(i.length);for(let l of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(l);this.cycleRemoval()}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount==0){this.originalGraph.boundingBox=k.mkEmpty();return}oL(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode==3&&this.runPostLayering(),sL(this.originalGraph,this.sugiyamaSettings.transform),this.originalGraph.updateBoundingBox(),this.SetMargins()}SetMargins(){this.originalGraph.boundingBox.right+=this.sugiyamaSettings.margins.right,this.originalGraph.boundingBox.top+=this.sugiyamaSettings.margins.bottom,this.originalGraph.boundingBox.left-=this.sugiyamaSettings.margins.left,this.originalGraph.boundingBox.bottom-=this.sugiyamaSettings.margins.bottom}runPostLayering(){let e=this.sugiyamaSettings.edgeRoutingSettings;(this.constrainedOrdering!=null?0:e.EdgeRoutingMode)==3?this.calculateEdgeSplines():Hs(this.originalGraph,Array.from(this.originalGraph.deepEdges()),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let e=this.sugiyamaSettings.verticalConstraints,t=e.isEmpty?Qr.getFeedbackSet(this.IntGraph):e.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(t)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let e=this.CalculateLayerArrays();return this.UpdateNodePositionData(),e}UpdateNodePositionData(){this.TryToSatisfyMinWidhtAndMinHeight();for(let e=0;e<this.IntGraph.nodeCount&&e<this.database.Anchors.length;e++)this.IntGraph.nodes[e].center=this.database.Anchors[e].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let e=0;e<this.originalGraph.shallowNodeCount;e++)this.SnapLeftSidesOfTheNodeToGrid(e,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(e,t){let n=this.IntGraph.nodes[e],i=this.database.Anchors[e];i.leftAnchor-=t/2,i.rightAnchor-=t/2;let o=n.boundingBox.left,a=Math.floor(o/t),l=o-a*t;Math.abs(l)<.001||(Math.abs(l)<=t/2?n.center=n.center.add(new p(-l,0)):n.center=n.center.add(new p(t-l,0)),i.x=n.center.x)}TryToSatisfyMinWidhtAndMinHeight(){this.TryToSatisfyMinWidth(),this.TryToSatisfyMinHeight()}TryToSatisfyMinWidth(){if(this.sugiyamaSettings.MinimalWidth==0)return;this.GetCurrentWidth()<this.sugiyamaSettings.MinimalWidth&&this.StretchWidth()}StretchWidth(){let e=new lr;for(let n of this.originalGraph.shallowNodes())e.AddValue(n.boundingBox.width/2),e.AddValue(this.sugiyamaSettings.MinimalWidth-n.boundingBox.width/2);let t=new lr;for(let n of this.NodeAnchors())t.AddValue(n.x);if(t.length>E.distanceEpsilon){let n=e.length/t.length;if(n>1)for(let i of this.anchors)i.x*=n}}TryToSatisfyMinHeight(){if(this.sugiyamaSettings.MinimalHeight==0)return;this.GetCurrentHeight()<this.sugiyamaSettings.MinimalHeight&&this.StretchHeight()}GetCurrentHeight(){let e=new lr;for(let t of this.NodeAnchors())e.AddValue(t.top),e.AddValue(t.bottom);return e.length}StretchHeight(){let e=new lr;for(let n of this.originalGraph.shallowNodes())e.AddValue(n.boundingBox.height/2),e.AddValue(this.sugiyamaSettings.MinimalHeight-n.boundingBox.height/2);let t=new lr;for(let n of this.NodeAnchors())t.AddValue(n.y);if(t.length>E.distanceEpsilon){let n=e.length/t.length;if(n>1)for(let i of this.anchors)i.y*=n}}*NodeAnchors(){let e=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let t=0;t<e;t++)yield this.anchors[t]}GetCurrentWidth(){let e=new lr;for(let t of this.NodeAnchors())e.AddValue(t.left),e.AddValue(t.right);return e.length}ExtendLayeringToUngluedSameLayerVertices(e){let t=this.verticalConstraints;for(let n=0;n<e.length;n++)e[n]=e[t.nodeToRepr(n)];return e}calculateEdgeSplines(){new Rn(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(e){let t=e.GetLayers();Eu.Balance(this.gluedDagSkeletonForLayering,t,this.GetNodeCountsOfGluedDag(),null),t=this.ExtendLayeringToUngluedSameLayerVertices(t);let n=new Kr(t);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return n=this.YLayeringAndOrderingWithoutHorizontalConstraints(n),n;throw new Error("not implemented")}CreateProperLayeredGraph(e){let t=e.length,n=0;for(let o of this.database.SkeletonEdges()){let a=$2(e,o);a>0&&(o.LayerEdges=new Array(a));let l=0;if(a>1){let u=t+n++,c=new Zr(o.source,u,o.CrossingWeight,o.weight);o.LayerEdges[l++]=c;for(let h=0;h<a-2;h++)u++,n++,c=new Zr(u-1,u,o.CrossingWeight,o.weight),o.LayerEdges[l++]=c;c=new Zr(u,o.target,o.CrossingWeight,o.weight),o.LayerEdges[l]=c}else if(a==1){let u=new Zr(o.source,o.target,o.CrossingWeight,o.weight);o.LayerEdges[l]=u}}let i=new Array(this.originalGraph.shallowNodeCount+n).fill(0);for(let o of this.database.SkeletonEdges())if(o.LayerEdges!=null){let a=e[o.source];i[o.source]=a--;for(let l of o.LayerEdges)i[l.Target]=a--}else i[o.source]=e[o.source],i[o.target]=e[o.target];return this.properLayeredGraph=new wn(new Gi(Array.from(this.database.SkeletonEdges()),e.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new Kr(i)}YLayeringAndOrderingWithoutHorizontalConstraints(e){let t=this.CreateProperLayeredGraph(e.y);return wo.OrderLayers(this.properLayeredGraph,t,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),qa.UpdateLayerArrays1(this.properLayeredGraph,t),t}CalculateYLayers(){let e=this.YLayeringAndOrdering(new tm(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?e:this.InsertLayersIfNeeded(e)}InsertLayersIfNeeded(e){this.InsertVirtualEdgesIfNeeded(e);let t=this.AnalyzeNeedToInsertLayersAndHasMultiedges(e);if(t.needToInsertLayers){let n=To.InsertLayers(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,e=n.la,this.LayersAreDoubled=!0}else if(t.multipleEdges){let n=ri.InsertPaths(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,e=n.la}return this.RecreateIntGraphFromDataBase(),e}RecreateIntGraphFromDataBase(){let e=new Array;for(let t of this.database.Multiedges.values())e=e.concat(t);this.IntGraph.SetEdges(e,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(e){if(this.constrainedOrdering==null){for(let[t,n]of this.database.Multiedges.keyValues())if(n.length%2==0&&e.y[t.x]-1==e.y[t.y]){let i=new Ge(null),o=new ar(t.x,t.y,i);o.IsVirtualEdge=!0,n.splice(n.length/2,0,o),this.IntGraph.addEdge(o)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(e){let t=!1,n=!1;for(let i of this.IntGraph.edges)if(i.hasLabel&&e.y[i.source]!=e.y[i.target]){t=!0;break}if(t==!1&&this.constrainedOrdering==null){for(let[i,o]of this.database.Multiedges.keyValues())if(o.length>1&&(n=!0,e.y[i.x]-e.y[i.y]==1)){t=!0;break}}return{needToInsertLayers:t,multipleEdges:n}}UseBrandesXCalculations(e){return e.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(e){this.anchors=q2(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),X2(e,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let e=0;e<this.anchors.length;e++){let t=this.anchors[e];if(t.labelIsToTheRightOfTheSpline){let n=this.GetSuccessorAndPredecessor(e);if(!J2(t,n.predecessor,n.successor)){let i=n.predecessor.origin.sub(t.origin).length+n.successor.origin.sub(t.origin).length,o=t.right-t.leftAnchor,a=new p(o,t.y);n.predecessor.origin.sub(a).length+n.successor.origin.sub(a).length<i&&qE(t)}}}}GetSuccessorAndPredecessor(e){let t;for(let i of this.properLayeredGraph.InEdges(e))t=i.Source;let n;for(let i of this.properLayeredGraph.OutEdges(e))n=i.Target;return{predecessor:this.anchors[t],successor:this.anchors[n]}}CalculateLayerArrays(){let e=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(e),this.UseBrandesXCalculations(e)?this.CalculateXPositionsByBrandes(e):this.CalculateXLayersByGansnerNorth(e)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=e,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),e}StretchToDesiredAspectRatio(e,t){e>t?this.StretchInYDirection(e/t):e<t&&this.StretchInXDirection(t/e)}StretchInYDirection(e){let t=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let i of this.database.Anchors)i.bottomAnchor=i.bottomAnchor*e,i.topAnchor=i.topAnchor*e,i.y=t+e*(i.y-t);let n=this.originalGraph.height*e;this.originalGraph.boundingBox=new k({left:this.originalGraph.boundingBox.left,top:t+n/2,right:this.originalGraph.boundingBox.right,bottom:t-n/2})}StretchInXDirection(e){let t=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let i of this.database.Anchors)i.leftAnchor=i.leftAnchor*e,i.rightAnchor=i.rightAnchor*e,i.x=t+e*(i.x-t);let n=this.originalGraph.width*e;this.originalGraph.boundingBox=new k({left:t-n/2,top:this.originalGraph.boundingBox.top,right:t+n/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length==0)return 0;let e=new k({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let i=1;i<this.anchors.length;i++){let o=this.anchors[i];e.add(o.leftTop),e.add(o.rightBottom)}let t=e.leftTop.sub(e.rightBottom).length/2,n=new p(t*-1,t);return e.add(e.leftTop.add(n)),e.add(e.rightBottom.sub(n)),this.originalGraph.boundingBox=e,e.height!=0?e.width/e.height:0}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let e=!1;for(let t of this.database.AllIntEdges())t.LayerSpan==2&&(e=this.ShiftVertexWithNeighbors(t.LayerEdges[0].Source,t.LayerEdges[0].Target,t.LayerEdges[1].Target)||e);return e}ShiftVertexWithNeighbors(e,t,n){let i=this.database.Anchors[e],o=this.database.Anchors[n],a=this.database.Anchors[t],l=(a.y-i.y)*((o.x-i.x)/(o.y-i.y))+i.x,u=1e-4;return l>a.x+u?this.TryShiftToTheRight(l,t):l<a.x-u?this.TryShiftToTheLeft(l,t):!1}TryShiftToTheLeft(e,t){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],i=this.engineLayerArrays.x[t];if(i>0){let o=this.database.Anchors[n[i-1]],a=Math.max(o.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[t].leftAnchor),e);return a<this.database.Anchors[t].x-1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}TryShiftToTheRight(e,t){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],i=this.engineLayerArrays.x[t];if(i<n.length-1){let o=this.database.Anchors[n[i+1]],a=Math.min(o.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[t].rightAnchor),e);return a>this.database.Anchors[t].x+1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}CalculateXLayersByGansnerNorth(e){this.xLayoutGraph=this.CreateXLayoutGraph(e),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let e=new Iu(this.xLayoutGraph,null).GetLayers();for(let t=0;t<this.database.Anchors.length;t++)this.anchors[t].x=e[t]}CreateXLayoutGraph(e){let t=this.properLayeredGraph.NodeCount,n=new Array;for(let o of this.properLayeredGraph.Edges){let a=new ar(t,o.Source,null),l=new ar(t,o.Target,null);l.weight=o.Weight,a.weight=o.Weight,a.separation=0,l.separation=0,t++,n.push(a),n.push(l)}for(let o of e.Layers)for(let a=o.length-1;a>0;a--){let l=o[a],u=o[a-1],c=new ar(l,u,null),h=this.database.Anchors[l],d=this.database.Anchors[u],f=h.leftAnchor+(d.rightAnchor+this.sugiyamaSettings.NodeSeparation);c.separation=Math.ceil(f+.5),n.push(c)}let i=new rm(this.IntGraph,this.properLayeredGraph,e,n,t);return i.SetEdgeWeights(),i}CalculateXPositionsByBrandes(e){rd.CalculateXCoordinates(e,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let e=new In(this.IntGraph.nodeCount);for(let[n,i]of this.database.Multiedges.keyValues()){if(n.isDiagonal())continue;let o=this.verticalConstraints.gluedIntEdge(i[0]);o.source!=o.target&&e.set(o.source,o.target,o)}let t=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(n=>Y2(n,null));for(let n of t)e.set(n.source,n.target,n);return Array.from(e.values())}static CalcAnchorsForOriginalNode(e,t,n,i,o){let a={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(t.nodes!=null){let c=t.nodes[e];rL(a,c,o)}nL(e,a,i,o);let l=o.MinNodeWidth/2;a.leftAnchor<l&&(a.leftAnchor=l),a.rightAnchor<l&&(a.rightAnchor=l);let u=o.MinNodeHeight/2;a.topAnchor<u&&(a.topAnchor=u),a.bottomAnchor<u&&(a.bottomAnchor=u),n[e]=Ar.mkAnchor(a.leftAnchor,a.rightAnchor,a.topAnchor,a.bottomAnchor,t.nodes[e],o.LabelCornersPreserveCoefficient),n[e].padding=t.nodes[e].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new Gi(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let e=new In(this.IntGraph.nodeCount);for(let t of this.gluedDagSkeletonForLayering.edges)e.set(t.source,t.target,t);for(let[t,n]of this.database.Multiedges.keyValues())if(t.x!=t.y){let i=this.verticalConstraints.gluedIntPair(t);if(i.x==i.y)continue;let o=e.get(i.x,i.y);for(let a of n)o.weight+=a.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function WE(s,e){if(e==0)return 0;let t=Math.floor(s/e),n=s-t*e;return Math.abs(n)<1e-4?0:e-n}function j2(s,e){for(let t of s)if(t<e)return!0;return!1}function q2(s,e,t,n,i){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new Ar(i.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)$u.CalcAnchorsForOriginalNode(a,n,o,s,i);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!=a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=gb()*4,c.topAnchor=c.bottomAnchor=HE(i)/2):(c.leftAnchor=c.rightAnchor=gb()/2,c.topAnchor=c.bottomAnchor=HE(i)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=gb()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function gb(){return 1}function HE(s){return s.MinNodeHeight*1.5/8}function jE(s,e,t,n,i,o){let a=0;if(t>0){let l=eL(e.Layers[t-1],e.y,n);if(l.length){let u=i.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>tL(h,c,u,s)))}}return a}function X2(s,e,t,n,i,o,a){let l=n.Anchors,u=t.Margins+e,c=0;for(let h of s.Layers){let d=0,f=0;for(let I of h){let B=l[I];B.bottomAnchor>d&&(d=B.bottomAnchor),B.topAnchor>f&&(f=B.topAnchor)}Q2(h,d,f,t.shallowNodeCount,n.Anchors);let y=jE(n,s,c,i,o,u),S=u+d+y,C=S+f;if(Z2(o)){C+=WE(C,o.GridSizeByY);for(let I of h)l[I].top=C}else if(K2(o)){let I=S-d;I+=WE(I,I);for(let B of h)l[B].bottom=I,C=Math.max(l[B].top,C)}else for(let I of h)l[I].y=S;let T=o.ActualLayerSeparation(a);u=C+T,c++}jE(n,s,c,i,o,u)}function Y2(s,e){let t=new ar(s.x,s.y,e);return t.weight=0,t.separation=1,t}function $2(s,e){return s[e.source]-s[e.target]}function Q2(s,e,t,n,i){if(j2(s,n)){for(let o of s)if(o>=n){let a=i[o];a.bottomAnchor=e,a.topAnchor=t}}}function Z2(s){return s.SnapToGridByY==1}function K2(s){return s.SnapToGridByY==2}function J2(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(p.getTriangleOrientation(e.origin,s.origin,t.origin)==0)return!0;let n=s.leftAnchor,i=s.rightAnchor,o=s.x;return qE(s),p.getTriangleOrientation(e.origin,s.origin,t.origin)==1?!0:(s.x=o,s.leftAnchor=n,s.rightAnchor=i,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function qE(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function eL(s,e,t){let n=new Yt;for(let i of s)if(!(i>=t.nodeCount))for(let o of t.outEdges[i])e[o.source]==e[o.target]&&n.addNN(o.source,o.target);return Array.from(n.values())}function tL(s,e,t,n){let i=0,o=n.GetMultiedgeI(s);for(let a of o){i+=t;let l=a.edge.label;l!=null&&(l.center=new p(l.center.x,e+i+l.height/2),i+=l.height)}return i}function rL(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function nL(s,e,t,n){let i=iL(t,s,e,n);e.rightAnchor+=i}function iL(s,e,t,n){let i=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));i+=(n.NodeSeparation+n.MinNodeWidth)*o.length}return i}function oL(s,e){if(e.isIdentity())return;let t=e.inverse();for(let n of s.shallowNodes())n.transform(t);for(let n of s.edges())if(n.label!=null){let i=k.mkPP(t.multiplyPoint(new p(0,0)),t.multiplyPoint(new p(n.label.width,n.label.height)));n.label.width=i.width,n.label.height=i.height}}function sL(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes())t.transform(e);for(let t of s.edges())if(t.label!=null){let n=k.mkPP(e.multiplyPoint(new p(0,0)),e.multiplyPoint(new p(t.label.width,t.label.height)));t.label.width=n.width,t.label.height=n.height}aL(s,e)}}function aL(s,e){for(let t of s.edges())t.label!=null&&(t.label.center=e.multiplyPoint(t.label.center)),lL(e,t)}function lL(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),uL(e,s)}}function uL(s,e){if(s.underlyingPolyline!=null)for(let t=s.underlyingPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var jd=class extends us{constructor(e,t){super();this.text=e,this.parent=t}toString(){return this.text}};var Qs=(w=>(w[w.normal=0]="normal",w[w.inv=1]="inv",w[w.dot=2]="dot",w[w.invdot=3]="invdot",w[w.odot=4]="odot",w[w.invodot=5]="invodot",w[w.none=6]="none",w[w.tee=7]="tee",w[w.empty=8]="empty",w[w.invempty=9]="invempty",w[w.diamond=10]="diamond",w[w.odiamond=11]="odiamond",w[w.ediamond=12]="ediamond",w[w.crow=13]="crow",w[w.box=14]="box",w[w.obox=15]="obox",w[w.open=16]="open",w[w.halfopen=17]="halfopen",w[w.vee=18]="vee",w))(Qs||{});var Ki=(M=>(M[M.diamond=0]="diamond",M[M.ellipse=1]="ellipse",M[M.box=2]="box",M[M.circle=3]="circle",M[M.record=4]="record",M[M.plaintext=5]="plaintext",M[M.point=6]="point",M[M.mdiamond=7]="mdiamond",M[M.msquare=8]="msquare",M[M.polygon=9]="polygon",M[M.doublecircle=10]="doublecircle",M[M.house=11]="house",M[M.invhouse=12]="invhouse",M[M.parallelogram=13]="parallelogram",M[M.octagon=14]="octagon",M[M.tripleoctagon=15]="tripleoctagon",M[M.triangle=16]="triangle",M[M.trapezium=17]="trapezium",M[M.drawfromgeometry=18]="drawfromgeometry",M[M.hexagon=19]="hexagon",M))(Ki||{});var qd=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(qd||{});var ec=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(ec||{});var Xd=(i=>(i[i.forward=0]="forward",i[i.back=1]="back",i[i.both=2]="both",i[i.none=3]="none",i))(Xd||{});var Yd=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(Yd||{});var A=class{static parse(e){switch(e.toLowerCase()){case"aliceblue":return A.AliceBlue;case"antiquewhite":return A.AntiqueWhite;case"aqua":A.Aqua;case"aquamarine":A.Aquamarine;case"azure":return A.Azure;case"beige":return A.Beige;case"bisque":return A.Bisque;case"black":return A.Black;case"blanchedalmond":return A.BlanchedAlmond;case"blue":return A.Blue;case"blueviolet":return A.BlueViolet;case"brown":return A.Brown;case"burlywood":return A.BurlyWood;case"cadetblue":return A.CadetBlue;case"chartreuse":return A.Chartreuse;case"chocolate":return A.Chocolate;case"coral":return A.Coral;case"cornflowerblue":return A.CornflowerBlue;case"cornsilk":return A.Cornsilk;case"crimson":return A.Crimson;case"cyan":return A.Cyan;case"darkblue":return A.DarkBlue;case"darkcyan":return A.DarkCyan;case"darkgoldenrod":return A.DarkGoldenrod;case"darkgray":return A.DarkGray;case"darkgreen":return A.DarkGreen;case"darkkhaki":return A.DarkKhaki;case"darkmagenta":return A.DarkMagenta;case"darkolivegreen":return A.DarkOliveGreen;case"darkorange":return A.DarkOrange;case"darkorchid":return A.DarkOrchid;case"darkred":return A.DarkRed;case"darksalmon":return A.DarkSalmon;case"darkseagreen":return A.DarkSeaGreen;case"darkslateblue":return A.DarkSlateBlue;case"darkslategray":return A.DarkSlateGray;case"darkturquoise":return A.DarkTurquoise;case"darkviolet":return A.DarkViolet;case"deeppink":return A.DeepPink;case"deepskyblue":return A.DeepSkyBlue;case"dimgray":return A.DimGray;case"dodgerblue":return A.DodgerBlue;case"firebrick":return A.Firebrick;case"floralwhite":return A.FloralWhite;case"forestgreen":return A.ForestGreen;case"fuchsia":return A.Fuchsia;case"gainsboro":return A.Gainsboro;case"ghostwhite":return A.GhostWhite;case"gold":return A.Gold;case"goldenrod":return A.Goldenrod;case"gray":return A.Gray;case"green":return A.Green;case"greenyellow":return A.GreenYellow;case"honeydew":return A.Honeydew;case"hotpink":return A.HotPink;case"indianred":return A.IndianRed;case"indigo":return A.Indigo;case"ivory":return A.Ivory;case"khaki":return A.Khaki;case"lavender":return A.Lavender;case"lavenderblush":return A.LavenderBlush;case"lawngreen":return A.LawnGreen;case"lemonchiffon":return A.LemonChiffon;case"lightblue":return A.LightBlue;case"lightcoral":return A.LightCoral;case"lightcyan":return A.LightCyan;case"lightgoldenrodyellow":return A.LightGoldenrodYellow;case"lightgray":case"lightgrey":return A.LightGray;case"lightgreen":return A.LightGreen;case"lightpink":return A.LightPink;case"lightsalmon":return A.LightSalmon;case"lightseagreen":return A.LightSeaGreen;case"lightskyblue":return A.LightSkyBlue;case"lightslategray":return A.LightSlateGray;case"lightsteelblue":return A.LightSteelBlue;case"lightyellow":return A.LightYellow;case"lime":return A.Lime;case"limegreen":return A.LimeGreen;case"linen":return A.Linen;case"magenta":return A.Magenta;case"maroon":return A.Maroon;case"mediumaquamarine":return A.MediumAquamarine;case"mediumblue":return A.MediumBlue;case"mediumorchid":return A.MediumOrchid;case"mediumpurple":return A.MediumPurple;case"mediumseagreen":return A.MediumSeaGreen;case"mediumslateblue":return A.MediumSlateBlue;case"mediumspringgreen":return A.MediumSpringGreen;case"mediumturquoise":return A.MediumTurquoise;case"mediumvioletred":return A.MediumVioletRed;case"midnightblue":return A.MidnightBlue;case"mintcream":return A.MintCream;case"mistyrose":return A.MistyRose;case"moccasin":return A.Moccasin;case"navajowhite":return A.NavajoWhite;case"navy":return A.Navy;case"oldlace":return A.OldLace;case"olive":return A.Olive;case"olivedrab":return A.OliveDrab;case"orange":return A.Orange;case"orangered":return A.OrangeRed;case"orchid":return A.Orchid;case"palegoldenrod":return A.PaleGoldenrod;case"palegreen":return A.PaleGreen;case"paleturquoise":return A.PaleTurquoise;case"palevioletred":return A.PaleVioletRed;case"papayawhip":return A.PapayaWhip;case"peachpuff":return A.PeachPuff;case"peru":return A.Peru;case"pink":return A.Pink;case"plum":return A.Plum;case"powderblue":return A.PowderBlue;case"purple":return A.Purple;case"red":return A.Red;case"rosybrown":return A.RosyBrown;case"royalblue":return A.RoyalBlue;case"saddlebrown":return A.SaddleBrown;case"salmon":return A.Salmon;case"sandybrown":return A.SandyBrown;case"seagreen":return A.SeaGreen;case"seashell":return A.SeaShell;case"sienna":return A.Sienna;case"silver":return A.Silver;case"skyblue":return A.SkyBlue;case"slateblue":return A.SlateBlue;case"slategray":return A.SlateGray;case"snow":return A.Snow;case"springgreen":return A.SpringGreen;case"steelblue":return A.SteelBlue;case"tan":return A.Tan;case"teal":return A.Teal;case"thistle":return A.Thistle;case"tomato":return A.Tomato;case"transparent":return A.Transparent;case"turquoise":return A.Turquoise;case"violet":return A.Violet;case"wheat":return A.Wheat;case"white":return A.White;case"whitesmoke":return A.WhiteSmoke;case"yellow":return A.Yellow;case"yellowgreen":return A.YellowGreen;default:return}}constructor(e,t,n,i){this.a=e,this.r=t,this.g=n,this.b=i}static mkRGB(e,t,n){return new A(255,e,t,n)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length==1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a==t.a&&e.r==t.r&&e.b==t.b&&e.g==t.g}toString(){return'"#'+A.Xex(this.R)+A.Xex(this.G)+A.Xex(this.B)+(this.A==255?"":A.Xex(this.A))+'"'}static get AliceBlue(){return new A(255,240,248,255)}static get AntiqueWhite(){return new A(255,250,235,215)}static get Aqua(){return new A(255,0,255,255)}static get Aquamarine(){return new A(255,127,255,212)}static get Azure(){return new A(255,240,255,255)}static get Beige(){return new A(255,245,245,220)}static get Bisque(){return new A(255,255,228,196)}static get Black(){return new A(255,0,0,0)}static get BlanchedAlmond(){return new A(255,255,235,205)}static get Blue(){return new A(255,0,0,255)}static get BlueViolet(){return new A(255,138,43,226)}static get Brown(){return new A(255,165,42,42)}static get BurlyWood(){return new A(255,222,184,135)}static get CadetBlue(){return new A(255,95,158,160)}static get Chartreuse(){return new A(255,127,255,0)}static get Chocolate(){return new A(255,210,105,30)}static get Coral(){return new A(255,255,127,80)}static get CornflowerBlue(){return new A(255,100,149,237)}static get Cornsilk(){return new A(255,255,248,220)}static get Crimson(){return new A(255,220,20,60)}static get Cyan(){return new A(255,0,255,255)}static get DarkBlue(){return new A(255,0,0,139)}static get DarkCyan(){return new A(255,0,139,139)}static get DarkGoldenrod(){return new A(255,184,134,11)}static get DarkGray(){return new A(255,169,169,169)}static get DarkGreen(){return new A(255,0,100,0)}static get DarkKhaki(){return new A(255,189,183,107)}static get DarkMagenta(){return new A(255,139,0,139)}static get DarkOliveGreen(){return new A(255,85,107,47)}static get DarkOrange(){return new A(255,255,140,0)}static get DarkOrchid(){return new A(255,153,50,204)}static get DarkRed(){return new A(255,139,0,0)}static get DarkSalmon(){return new A(255,233,150,122)}static get DarkSeaGreen(){return new A(255,143,188,139)}static get DarkSlateBlue(){return new A(255,72,61,139)}static get DarkSlateGray(){return new A(255,47,79,79)}static get DarkTurquoise(){return new A(255,0,206,209)}static get DarkViolet(){return new A(255,148,0,211)}static get DeepPink(){return new A(255,255,20,147)}static get DeepSkyBlue(){return new A(255,0,191,255)}static get DimGray(){return new A(255,105,105,105)}static get DodgerBlue(){return new A(255,30,144,255)}static get Firebrick(){return new A(255,178,34,34)}static get FloralWhite(){return new A(255,255,250,240)}static get ForestGreen(){return new A(255,34,139,34)}static get Fuchsia(){return new A(255,255,0,255)}static get Gainsboro(){return new A(255,220,220,220)}static get GhostWhite(){return new A(255,248,248,255)}static get Gold(){return new A(255,255,215,0)}static get Goldenrod(){return new A(255,218,165,32)}static get Gray(){return new A(255,128,128,128)}static get Green(){return new A(255,0,128,0)}static get GreenYellow(){return new A(255,173,255,47)}static get Honeydew(){return new A(255,240,255,240)}static get HotPink(){return new A(255,255,105,180)}static get IndianRed(){return new A(255,205,92,92)}static get Indigo(){return new A(255,75,0,130)}static get Ivory(){return new A(255,255,255,240)}static get Khaki(){return new A(255,240,230,140)}static get Lavender(){return new A(255,230,230,250)}static get LavenderBlush(){return new A(255,255,240,245)}static get LawnGreen(){return new A(255,124,252,0)}static get LemonChiffon(){return new A(255,255,250,205)}static get LightBlue(){return new A(255,173,216,230)}static get LightCoral(){return new A(255,240,128,128)}static get LightCyan(){return new A(255,224,255,255)}static get LightGoldenrodYellow(){return new A(255,250,250,210)}static get LightGray(){return new A(255,211,211,211)}static get LightGreen(){return new A(255,144,238,144)}static get LightPink(){return new A(255,255,182,193)}static get LightSalmon(){return new A(255,255,160,122)}static get LightSeaGreen(){return new A(255,32,178,170)}static get LightSkyBlue(){return new A(255,135,206,250)}static get LightSlateGray(){return new A(255,119,136,153)}static get LightSteelBlue(){return new A(255,176,196,222)}static get LightYellow(){return new A(255,255,255,224)}static get Lime(){return new A(255,0,255,0)}static get LimeGreen(){return new A(255,50,205,50)}static get Linen(){return new A(255,250,240,230)}static get Magenta(){return new A(255,255,0,255)}static get Maroon(){return new A(255,128,0,0)}static get MediumAquamarine(){return new A(255,102,205,170)}static get MediumBlue(){return new A(255,0,0,205)}static get MediumOrchid(){return new A(255,186,85,211)}static get MediumPurple(){return new A(255,147,112,219)}static get MediumSeaGreen(){return new A(255,60,179,113)}static get MediumSlateBlue(){return new A(255,123,104,238)}static get MediumSpringGreen(){return new A(255,0,250,154)}static get MediumTurquoise(){return new A(255,72,209,204)}static get MediumVioletRed(){return new A(255,199,21,133)}static get MidnightBlue(){return new A(255,25,25,112)}static get MintCream(){return new A(255,245,255,250)}static get MistyRose(){return new A(255,255,228,225)}static get Moccasin(){return new A(255,255,228,181)}static get NavajoWhite(){return new A(255,255,222,173)}static get Navy(){return new A(255,0,0,128)}static get OldLace(){return new A(255,253,245,230)}static get Olive(){return new A(255,128,128,0)}static get OliveDrab(){return new A(255,107,142,35)}static get Orange(){return new A(255,255,165,0)}static get OrangeRed(){return new A(255,255,69,0)}static get Orchid(){return new A(255,218,112,214)}static get PaleGoldenrod(){return new A(255,238,232,170)}static get PaleGreen(){return new A(255,152,251,152)}static get PaleTurquoise(){return new A(255,175,238,238)}static get PaleVioletRed(){return new A(255,219,112,147)}static get PapayaWhip(){return new A(255,255,239,213)}static get PeachPuff(){return new A(255,255,218,185)}static get Peru(){return new A(255,205,133,63)}static get Pink(){return new A(255,255,192,203)}static get Plum(){return new A(255,221,160,221)}static get PowderBlue(){return new A(255,176,224,230)}static get Purple(){return new A(255,128,0,128)}static get Red(){return new A(255,255,0,0)}static get RosyBrown(){return new A(255,188,143,143)}static get RoyalBlue(){return new A(255,65,105,225)}static get SaddleBrown(){return new A(255,139,69,19)}static get Salmon(){return new A(255,250,128,114)}static get SandyBrown(){return new A(255,244,164,96)}static get SeaGreen(){return new A(255,46,139,87)}static get SeaShell(){return new A(255,255,245,238)}static get Sienna(){return new A(255,160,82,45)}static get Silver(){return new A(255,192,192,192)}static get SkyBlue(){return new A(255,135,206,235)}static get SlateBlue(){return new A(255,106,90,205)}static get SlateGray(){return new A(255,112,128,144)}static get Snow(){return new A(255,255,250,250)}static get SpringGreen(){return new A(255,0,255,127)}static get SteelBlue(){return new A(255,70,130,180)}static get Tan(){return new A(255,210,180,140)}static get Teal(){return new A(255,0,128,128)}static get Thistle(){return new A(255,216,191,216)}static get Tomato(){return new A(255,255,99,71)}static get Transparent(){return new A(0,255,255,255)}static get Turquoise(){return new A(255,64,224,208)}static get Violet(){return new A(255,238,130,238)}static get Wheat(){return new A(255,245,222,179)}static get White(){return new A(255,255,255,255)}static get WhiteSmoke(){return new A(255,245,245,245)}static get Yellow(){return new A(255,255,255,0)}static get YellowGreen(){return new A(255,154,205,50)}};var fl=class{constructor(e){this.labelfontcolor=A.parse("Black");this.styles=[];this.penwidth=1;this.attrCont=e,this.bind(),this.fontname=fl.defaultLabelFontName,this.fontsize=fl.defaultLabelFontSize}get labelText(){return this._labelText}set labelText(e){this._labelText=e}bind(){this.attrCont!=null&&this.attrCont.setAttr(fl.attachIndex,this)}static getDrawingObj(e){return e==null?null:e.getAttr(fl.attachIndex)}},ut=fl;ut.attachIndex=1,ut.defaultLabelFontName="Times-Roman",ut.defaultLabelFontSize=12;var gl=class{constructor(e){this.text=e}};var $d=class extends ut{constructor(e){super(e);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;e!=null&&(this.label=new gl(e.id))}get labelText(){return this.label?this.label.text:null}set labelText(e){this.label!=null&&(this.label.text=e)}get Padding(){return this.padding}set Padding(e){this.padding=Math.max(0,e)}get XRadius(){return this.xRad}set XRadius(e){this.xRad=e}get YRadius(){return this.yRad}set YRadius(e){this.yRad=e}static get DefaultFillColor(){return $d.defaultFillColor}static set DefaultFillColor(e){$d.defaultFillColor=e}get ShapeEnum(){return this.shape}set ShapeEnum(e){this.shape=e}get LabelMargin(){return this.labelMargin}set LabelMargin(e){this.labelMargin=e}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(e){this.labelWidthToHeightRatio=e}get node(){return this.attrCont}},Ht=$d;Ht.defaultFillColor=A.LightGray;var _n=class extends Ht{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get graph(){return this.attrCont}findNode(e){let n=this.graph.findNode(e);return n==null?null:ut.getDrawingObj(n)}hasDirectedEdge(){for(let e of this.graph.edges)if(ut.getDrawingObj(e).directed)return!0;return!1}createGeometry(e=t=>t?new Bt(t.length*8+8,20):null){let t=new je(this.graph);this.textMeasure=e;let n={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};t.labelSize=e(this.labelText,n);for(let i of this.graph.deepNodes)this.createNodeGeometry(i);for(let i of this.graph.deepEdges())this.createEdgeGeometry(i);return t}createEdgeGeometry(e){let t=Pn.getDrawingObj(e),n=new Ge(e);if(t.directed==!1&&(n.targetArrowhead=null),e.label){let i=this.textMeasure(e.label.text,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"});n.label=new Pu(k.mkPP(new p(0,0),new p(i.width,i.height)),e.label),t.label.measuredTextSize=i}t.penwidth&&(n.lineWidth=t.penwidth)}curveByShape(e,t,n,i,o){let a;switch(i){case 0:a=ve.CreateDiamond(e,t,n);break;case 1:break;case 4:case 2:a=ve.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,n);break;case 3:a=ve.mkCircle(Math.sqrt(e*e+t*t),n);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=ve.mkCircle(Math.sqrt(e*e+t*t)+2*o.penwidth,n);break;case 11:a=ve.createHouse(e,t,n);break;case 12:a=ve.createInvertedHouse(e,t,n);break;case 13:break;case 14:a=ve.createOctagon(e,t,n);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=ve.createHexagon(e,t,n);break}return a!=null?a:ve.mkRectangleWithRoundedCorners(e,t,o.XRadius,o.YRadius,n)}createNodeGeometry(e){if(e instanceof We){let t=ut.getDrawingObj(e);new je(e),t.labelText&&(t.measuredTextSize=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}))}else{let t=Ht.getDrawingObj(e),n=new Bt(1,1);t.labelText&&(n=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}));let i=n.width+t.LabelMargin*2,o=n.height+t.LabelMargin*2;t.measuredTextSize=n;let a=new p(0,0),l=new $r(e);l.boundaryCurve=this.curveByShape(i,o,a,t.shape,t)}}};var Pn=class extends ut{constructor(){super(...arguments);this.directed=!0}};var ix=ne(nx());function pi(s){let e=(0,ix.default)(s);if(e.keyword!=null)return A.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new A(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return A.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return A.Black}function Wo(s,e){if(s.attr_list!=null)for(let t of s.attr_list)if(t.type=="attr"){let n=t.eq;switch(t.id){case"color":e.color=pi(n);break;case"pencolor":e.pencolor=pi(n);break;case"labelfontcolor":e.labelfontcolor=pi(n);break;case"fontcolor":e.fontColor=pi(n);break;case"fillcolor":e.fillColor=pi(n);break;case"style":e.styles.push(_L(n));break;case"shape":{let i=e;i.shape=FL(n);break}case"peripheries":e.peripheries=parseInt(n);break;case"headlabel":e.headlabel=n;break;case"label":if(typeof n=="string"){let i="\\n",o=0;e.labelText="";do{let a=n.indexOf(i,o);if(a>=0)e.labelText+=n.substring(o,a)+`
`,o=a+2;else{e.labelText+=n.substring(o);break}}while(!0)}else typeof n=="number"&&(e.labelText=n.toString());break;case"size":e.size=vb(n);break;case"pos":e.pos=vb(n);break;case"rankdir":e.rankdir=VL(n);break;case"fontname":e.fontname=n;break;case"fontsize":e.fontsize=parseFloat(n);break;case"width":e.width=parseFloat(n);break;case"penwidth":e.penwidth=parseFloat(n);break;case"height":e.height=parseFloat(n);break;case"margin":e.margin=parseFloat(n);break;case"len":e.len=parseFloat(n);break;case"minlen":e.minlen=parseFloat(n);break;case"rank":e.rank=kL(n);break;case"charset":e.charset=n;break;case"orientation":e.orientation=n;break;case"ratio":e.ratio=n;break;case"weight":e.weight=parseFloat(n);break;case"nodesep":e.nodesep=parseFloat(n);break;case"layersep":e.layersep=parseFloat(n);break;case"arrowsize":e.arrowsize=parseFloat(n);break;case"rotate":e.rotate=parseFloat(n);break;case"ranksep":e.ranksep=parseFloat(n);break;case"splines":e.splines=n=="true";break;case"overlap":e.overlap=n=="true";break;case"arrowtail":e.arrowtail=ox(n);break;case"taillabel":e.taillabel=n;break;case"arrowhead":e.arrowhead=ox(n);break;case"ordering":e.ordering=UL(n);break;case"URL":e.URL=n;break;case"dir":e.dir=zL(n);break;case"concentrate":e.concentrate=n=="true";break;case"compound":e.compound=n=="true";break;case"lhead":e.lhead=n;break;case"ltail":e.ltail=n;break;case"bgcolor":e.bgcolor=pi(n);break;case"center":e.center=n==!0||parseInt(n)==1;break;case"colorscheme":e.colorscheme=n;break;case"sides":e.sides=parseInt(n);break;case"distortion":e.distortion=parseFloat(n);break;case"skew":e.skew=parseFloat(n);break;case"bb":e.bb=WL(n);break;case"labelloc":e.labelloc=n;break;case"decorate":e.decorate=n=="true";break;case"tailclip":e.tailclip=n=="true";break;case"headclip":e.headclip=n=="true";break;case"constraint":e.constraint=n=="true";break;case"gradientangle":e.gradientangle=parseFloat(n);break;case"samehead":e.samehead=n;break;case"href":e.href=n;break;case"imagepath":e.imagepath=n;break;case"image":e.image=n;break;case"labeljust":e.labejust=n;break;case"layers":e.layers=n.split(",");break;case"layer":e.layer=n;break;case"f":e.f=parseFloat(n);break;case"nojustify":e.nojustify=n=="true";break;case"root":e.root=n=="true";break;case"page":e.page=vb(n);break;case"pname":e.pname=n;break;case"kind":e.kind=n;break;case"fname":e.fname=n;break;case"subkind":e.subkind=n;break;case"area":e.area=parseFloat(n);break;case"tailport":e.tailport=n;break;case"headport":e.headport=n;break;case"wt":e.wt=n;break;case"id":e.id=n;break;case"edgetooltip":e.edgetooltip=n;break;case"headtooltip":e.headtooltip=n;break;case"tailtooltip":e.tailtooltip=n;break;case"headURL":e.headURL=n;break;case"tailURL":e.tailURL=n;break;case"labelURL":e.labelURL=n;break;case"edgeurl":e.edgeurl=n;break;case"shapefile":e.shapefile=n;break;case"xlabel":e.xlabel=n;break;case"sametail":e.sametail=n;break;case"clusterrank":e.clusterRank=n;break;default:break}}else throw new Error("unexpected type "+t.type)}var ax=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,n,i,o){let a=n.graph.nodeCollection,l,u;if(e.type=="node_id"){let d=e.id.toString();a.hasNode(d)?l=a.getNode(d):l=this.newNode(d,n).node}else{let d=[];for(let f of e.children)if(f.type==="node_stmt")for(let y of this.parseEdge(f.node_id,t,n,i,o))d.push(y);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of e.children)if(f.type==="attr_stmt")for(let y of d)Wo(f,y);return d}if(t.type=="node_id"){let d=t.id.toString();a.hasNode(d)?u=a.getNode(d):u=this.newNode(d,n).node}else if(t.type=="subgraph"){let d=new Array;for(let f of t.children)if(f.type==="node_stmt")for(let y of this.parseEdge(e,f.node_id,n,i,o))d.push(y);else if(f.type!=="attr_stmt")throw new Error("not implemented");for(let f of t.children)if(f.type==="attr_stmt")for(let y of d)Wo(f,y);return d}let c=new mo(l,u);a.addEdge(c);let h=new Pn(c);return Wo(o,h),h.labelText&&(c.label=new jd(h.labelText,c),h.label=new gl(h.labelText)),h.directed=i,[h]}newNode(e,t){let n=new bo(e);this.nodeMap.set(e,n),t.graph.addNode(n);let i=new Ht(n);return i.labelText=e,this.defaultNodeAttr&&Wo(this.defaultNodeAttr,i),i}parseNode(e,t){let n=e.node_id.id.toString(),i=this.findNode(n),o;return i?(o=ut.getDrawingObj(i),o||(o=new Ht(i)),i.parent&&i.parent!=t.graph&&e.attr_list.length==0&&vp(t.graph,i)):(o=this.newNode(n,t),this.defaultNodeAttr&&Wo(this.defaultNodeAttr,o)),Wo(e,o),o}findNode(e){return this.nodeMap.get(e)}parse(){return this.ast==null?null:(this.graph=new We,this.drawingGraph=new _n(this.graph),this.parseUnderGraph(this.ast[0].children,this.drawingGraph,this.ast[0].type=="digraph"),jL(this.graph),this.graph)}parseGraphAttr(e,t){e.target=="node"?this.defaultNodeAttr=e:e.target=="graph"&&Wo(e,t)}getEntitiesSubg(e,t,n){let i=[];for(let o of e.children)if(o.type=="edge_stmt"){let a=o.edge_list;for(let l=0;l<a.length-1;l++)for(let u of this.parseEdge(a[l],a[l+1],t,n,o))i.push(u)}else if(o.type!="attr_stmt")if(o.type=="node_stmt")i.push(this.parseNode(o,t));else if(o.type==="subgraph")if(o.id!=null){let a=new We(o.id);t.graph.addNode(a);let l=new _n(a);this.parseUnderGraph(o.children,l,n),i.push(l)}else i=i.concat(this.getEntitiesSubg(o,t,n));else throw new Error("Function not implemented.");return i}parseUnderGraph(e,t,n){for(let i of e)switch(i.type){case"node_stmt":this.parseNode(i,t);break;case"edge_stmt":{let o=i.edge_list;for(let a=0;a<o.length-1;a++)this.parseEdge(o[a],o[a+1],t,n,i)}break;case"subgraph":if(!GL(i,t))if(i.id==null){let o=this.getEntitiesSubg(i,t,n);HL(i,t,o)}else{let o=new We(i.id),a=new _n(o);this.parseUnderGraph(i.children,a,n),o.isEmpty()||t.graph.addNode(o)}break;case"attr_stmt":this.parseGraphAttr(i,t);break;default:throw new Error("not implemented")}}};function ef(s){return new ax((0,sx.default)(s)).parse()}function GL(s,e){let t=s.children[0];if(t==null||t.type!="attr_stmt")return!1;let n=t.attr_list;if(n==null||n.length==0)return!1;let i=n[0];if(i.type!="attr"||i.id!="rank")return!1;switch(i.eq){case"min":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.minRanks.push(a.id)}return!0;case"max":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.maxRanks.push(a.id)}return!0;case"same":{let o=[];for(let a=1;a<s.children.length;a++){let l=s.children[a];o.push(l.id)}return e.graphVisData.sameRanks.push(o),!0}case"source":{for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.sourceRanks.push(a.id)}return!0}case"sink":for(let o=1;o<s.children.length;o++){let a=s.children[o];e.graphVisData.sinkRanks.push(a.id)}return!0;default:throw new Error("incorrect rank")}}function _L(s){return ec[s]}function FL(s){let e=s.toLowerCase();return Ki[e]}function vb(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function VL(s){return Na[s]}function kL(s){return qd[s]}function ox(s){return Qs[s]}function UL(s){return Yd[s]}function zL(s){return Xd[s]}function WL(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function HL(s,e,t){for(let n of s.children)if(n.type=="attr_stmt")for(let i of t)Wo(n,i)}function jL(s){let e=[];for(let t of s.subgraphs())t.isEmpty()&&e.push(t);for(let t of e){let n=t.parent;n&&n.removeNode(t)}}function tf(s){let e=new We;for(let t of s.nodes){let n=String(t.id),i=e.addNode(new bo(n)),o=new Ht(i),{label:a=n,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=Ki[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=pi(t.color))}for(let t of s.edges){let n=e.setEdge(String(t.source),String(t.target)),i=new Pn(n),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;i.arrowhead=Qs[o],i.arrowtail=Qs[a],i.directed=l,"weight"in t&&(i.weight=t.weight),"color"in t&&(i.color=pi(t.color))}return e}var lx="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),Tb={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},Ib={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",mds:"Pivot MDS"},ux=["Times New Roman","Arial","Georgia","Courier New","Verdana"];function Ho(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var mi={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},qL=mi.self||mi.window||mi.global||{},XL=mi.window||mi.self||mi.global||{},YL=mi.global||mi.self||mi.window||{},$L=mi.document||{};var lc=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var cx=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),QL=cx&&parseFloat(cx[1])||0;var hx="3.1.8";function br(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var bi={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},moe=bi.self||bi.window||bi.global||{},boe=bi.window||bi.self||bi.global||{},Poe=bi.global||bi.self||bi.window||{},yoe=bi.document||{};var Soe=typeof process!="object"||String(process)!=="[object process]"||process.browser;var fx=typeof window<"u"&&typeof window.orientation<"u",dx=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),Eoe=dx&&parseFloat(dx[1])||0;function X(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var rf=class{constructor(e,t){X(this,"name",void 0),X(this,"workerThread",void 0),X(this,"isRunning",void 0),X(this,"result",void 0),X(this,"_resolve",void 0),X(this,"_reject",void 0),this.name=e,this.workerThread=t,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise((n,i)=>{this._resolve=n,this._reject=i})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){br(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){br(this.isRunning),this.isRunning=!1,this._reject(e)}};var wb=new Map;function gx(s){br(s.source&&!s.url||!s.source&&s.url);let e=wb.get(s.source||s.url);return e||(s.url&&(e=ZL(s.url),wb.set(s.url,e)),s.source&&(e=px(s.source),wb.set(s.source,e))),br(e),e}function ZL(s){if(!s.startsWith("http"))return s;let e=KL(s);return px(e)}function px(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function KL(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function Lb(s,e=!0,t){let n=t||new Set;if(s){if(mx(s))n.add(s);else if(mx(s.buffer))n.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let i in s)Lb(s[i],e,n)}}return t===void 0?Array.from(n):[]}function mx(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var Ob=()=>{},ml=class{static isSupported(){return typeof Worker<"u"}constructor(e){X(this,"name",void 0),X(this,"source",void 0),X(this,"url",void 0),X(this,"terminated",!1),X(this,"worker",void 0),X(this,"onMessage",void 0),X(this,"onError",void 0),X(this,"_loadableURL","");let{name:t,source:n,url:i}=e;br(n||i),this.name=t,this.source=n,this.url=i,this.onMessage=Ob,this.onError=o=>console.log(o),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=Ob,this.onError=Ob,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||Lb(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=gx({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}};var nf=class{constructor(e){X(this,"name","unnamed"),X(this,"source",void 0),X(this,"url",void 0),X(this,"maxConcurrency",1),X(this,"maxMobileConcurrency",1),X(this,"onDebug",()=>{}),X(this,"reuseWorkers",!0),X(this,"props",{}),X(this,"jobQueue",[]),X(this,"idleQueue",[]),X(this,"count",0),X(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(i,o,a)=>i.done(a),n=(i,o)=>i.error(o)){let i=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:n,onStart:o}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let n=new rf(t.name,e);e.onMessage=i=>t.onMessage(n,i.type,i.payload),e.onError=i=>t.onError(n,i),t.onStart(n);try{await n.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new ml({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return fx?this.maxMobileConcurrency:this.maxConcurrency}};var JL={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0},ln=class{static isSupported(){return ml.isSupported()}static getWorkerFarm(e={}){return ln._workerFarm=ln._workerFarm||new ln({}),ln._workerFarm.setProps(e),ln._workerFarm}constructor(e){X(this,"props",void 0),X(this,"workerPools",new Map),this.props={...JL},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy()}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:n,url:i}=e,o=this.workerPools.get(t);return o||(o=new nf({name:t,source:n,url:i}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};X(ln,"_workerFarm",void 0);var eO="latest";function Rb(s,e={}){let t=e[s.id]||{},n="".concat(s.id,"-worker.js"),i=t.workerUrl;if(!i&&s.id==="compression"&&(i=e.workerUrl),e._workerType==="test"&&(i="modules/".concat(s.module,"/dist/").concat(n)),!i){let o=s.version;o==="latest"&&(o=eO);let a=o?"@".concat(o):"";i="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(n)}return br(i),i}function Bb(s,e=hx){br(s,"no worker provided");let t=s.version;return!(!e||!t)}function Mb(s,e){return ln.isSupported()?s.worker&&e?.worker:!1}async function Nb(s,e,t,n,i){let o=s.id,a=Rb(s,t),u=ln.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t));let c=await u.startJob("process-on-worker",tO.bind(null,i));return c.postMessage("process",{input:e,options:t}),await(await c.result).result}async function tO(s,e,t,n){switch(t){case"done":e.done(n);break;case"error":e.error(new Error(n.error));break;case"process":let{id:i,input:o,options:a}=n;try{let l=await s(o,a);e.postMessage("done",{id:i,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:i,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function Db(s){return s&&typeof s=="object"&&s.isBuffer}function bx(s){return Db(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function of(s){if(Db(s))return bx(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function Gb(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let n=new Uint8Array(s),i=new Uint8Array(e);for(let o=0;o<n.length;++o)if(n[o]!==i[o])return!1;return!0}function _b(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),n=new Uint8Array(t),i=0;for(let o of e)n.set(o,i),i+=o.byteLength;return n.buffer}async function Fb(s){let e=[];for await(let t of s)e.push(t);return _b(...e)}function uc(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var Js=class{constructor(e,t){X(this,"name",void 0),X(this,"type",void 0),X(this,"sampleSize",1),X(this,"time",void 0),X(this,"count",void 0),X(this,"samples",void 0),X(this,"lastTiming",void 0),X(this,"lastSampleTime",void 0),X(this,"lastSampleCount",void 0),X(this,"_count",0),X(this,"_time",0),X(this,"_samples",0),X(this,"_startTime",0),X(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=uc(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(uc()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var bl=class{constructor(e){X(this,"id",void 0),X(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:n}=e;return this.stats[t]||(e instanceof Js?this.stats[t]=e:this.stats[t]=new Js(t,n)),this.stats[t]}};var rO="",Px={};function Vb(s){for(let e in Px)if(s.startsWith(e)){let t=Px[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(rO).concat(s)),s}var sf={};XI(sf,{dirname:()=>iO,filename:()=>nO,join:()=>oO});function nO(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function iO(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function oO(...s){let e="/";return s=s.map((t,n)=>(n&&(t=t.replace(new RegExp("^".concat(e)),"")),n!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var sO=s=>typeof s=="boolean",cc=s=>typeof s=="function",Pl=s=>s!==null&&typeof s=="object",kb=s=>Pl(s)&&s.constructor==={}.constructor;var yx=s=>s&&typeof s[Symbol.iterator]=="function",Sx=s=>s&&typeof s[Symbol.asyncIterator]=="function";var Ji=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var Fn=s=>typeof Blob<"u"&&s instanceof Blob,Ex=s=>s&&typeof s=="object"&&s.isBuffer;var aO=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||Pl(s)&&cc(s.tee)&&cc(s.cancel)&&cc(s.getReader);var lO=s=>Pl(s)&&cc(s.read)&&cc(s.pipe)&&sO(s.readable),af=s=>aO(s)||lO(s);var uO=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,cO=/^([-\w.]+\/[-\w.+]+)/;function xx(s){let e=cO.exec(s);return e?e[1]:s}function Ub(s){let e=uO.exec(s);return e?e[1]:""}var hO=/\?.*/;function ea(s){if(Ji(s)){let e=zb(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:xx(t)||Ub(e)}}return Fn(s)?{url:zb(s.name||""),type:s.type||""}:typeof s=="string"?{url:zb(s),type:Ub(s)}:{url:"",type:""}}function Cx(s){return Ji(s)?s.headers["content-length"]||-1:Fn(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function zb(s){return s.replace(hO,"")}async function lf(s){if(Ji(s))return s;let e={},t=Cx(s);t>=0&&(e["content-length"]=String(t));let{url:n,type:i}=ea(s);i&&(e["content-type"]=i);let o=await fO(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:n}),a}async function Ax(s){if(!s.ok){let e=await dO(s);throw new Error(e)}}async function dO(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),n=s.statusText;t.includes("application/json")&&(n+=" ".concat(await s.text())),e+=n,e=e.length>60?"".concat(e.slice(60),"..."):e}catch{}return e}async function fO(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(n=>{let i=new FileReader;i.onload=o=>{var a;return n(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},i.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),n=gO(t);return"data:base64,".concat(n)}return null}function gO(s){let e="",t=new Uint8Array(s);for(let n=0;n<t.byteLength;n++)e+=String.fromCharCode(t[n]);return btoa(e)}async function Wb(s,e){if(typeof s=="string"){s=Vb(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await lf(s)}var bf=ne(El());var Al=ne(El());function zO(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var gf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";X(this,"storage",void 0),X(this,"id",void 0),X(this,"config",{}),this.storage=zO(n),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function Gx(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function _x(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function pf(s,e,t){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,i=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>n&&(t=Math.min(t,n/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(i,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var Vx=ne(El()),mf;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(mf||(mf={}));function Fx(s){return typeof s=="string"?mf[s.toUpperCase()]||mf.WHITE:s}function kx(s,e,t){return!Vx.isBrowser&&typeof s=="string"&&(e&&(e=Fx(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=Fx(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function Ux(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),n=Object.getOwnPropertyNames(t);for(let i of n)typeof s[i]=="function"&&(e.find(o=>i===o)||(s[i]=s[i].bind(s)))}function xl(s,e){if(!s)throw new Error(e||"Assertion failed")}var un=ne(El());function ra(){let s;if(un.isBrowser&&"performance"in un.window){var e,t;s=un.window===null||un.window===void 0||(e=un.window.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in un.process){var n;let i=un.process===null||un.process===void 0||(n=un.process.hrtime)===null||n===void 0?void 0:n.call(un.process);s=i[0]*1e3+i[1]/1e6}else s=Date.now();return s}var Cl={debug:Al.isBrowser&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},WO={enabled:!0,level:0};function Sn(){}var zx={},Wx={once:!0},Nr=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};X(this,"id",void 0),X(this,"VERSION",Al.VERSION),X(this,"_startTs",ra()),X(this,"_deltaTs",ra()),X(this,"_storage",void 0),X(this,"userData",{}),X(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new gf("__probe-".concat(this.id,"__"),WO),this.userData={},this.timeStamp("".concat(this.id," started")),Ux(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((ra()-this._startTs).toPrecision(10))}getDelta(){return Number((ra()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){xl(e,t)}warn(e){return this._getLogFunction(0,e,Cl.warn,arguments,Wx)}error(e){return this._getLogFunction(0,e,Cl.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,Cl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Cl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];return this._getLogFunction(e,t,Cl.debug||Cl.info,arguments,Wx)}table(e,t,n){return t?this._getLogFunction(e,t,console.table||Sn,n&&[n],{tag:XO(t)}):Sn}image(e){let{logLevel:t,priority:n,image:i,message:o="",scale:a=1}=e;return this._shouldLog(t||n)?Al.isBrowser?qO({image:i,message:o,scale:a}):jO({image:i,message:o,scale:a}):Sn}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Sn)}group(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},i=Hx({logLevel:e,message:t,opts:n}),{collapsed:o}=n;return i.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},n,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Sn)}withGroup(e,t,n){this.group(e,t)();try{n()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=jx(e)}_getLogFunction(e,t,n,i,o){if(this._shouldLog(e)){o=Hx({logLevel:e,message:t,args:i,opts:o}),n=n||o.method,xl(n),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=ra();let a=o.tag||o.message;if(o.once)if(!zx[a])zx[a]=ra();else return Sn;return t=HO(this.id,o.message,o),n.bind(console,t,...o.args)}return Sn}};X(Nr,"VERSION",Al.VERSION);function jx(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return xl(Number.isFinite(e)&&e>=0),e}function Hx(s){let{logLevel:e,message:t}=s;s.logLevel=jx(e);let n=s.args?Array.from(s.args):[];for(;n.length&&n.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&n.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let i=typeof s.message;return xl(i==="string"||i==="object"),Object.assign(s,{args:n},s.opts)}function HO(s,e,t){if(typeof e=="string"){let n=t.time?_x(Gx(t.total)):"";e=t.time?"".concat(s,": ").concat(n,"  ").concat(e):"".concat(s,": ").concat(e),e=kx(e,t.color,t.background)}return e}function jO(s){let{image:e,message:t="",scale:n=1}=s,i=null;try{i=module.require("asciify-image")}catch{}return i?()=>i(e,{fit:"box",width:"".concat(Math.round(80*n),"%")}).then(o=>console.log(o)):Sn}function qO(s){let{image:e,message:t="",scale:n=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=pf(o,t,n);console.log(...a)},o.src=e,Sn}let i=e.nodeName||"";if(i.toLowerCase()==="img")return console.log(...pf(e,t,n)),Sn;if(i.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...pf(o,t,n)),o.src=e.toDataURL(),Sn}return Sn}function XO(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var gae=new Nr({id:"@probe.gl/log"});var $b=new Nr({id:"loaders.gl"}),Qb=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},Zb=class{constructor(){X(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var Kb={fetch:null,mimeType:void 0,nothrow:!1,log:new Zb,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},qx={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Jb(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var $x=()=>{let s=Jb();return s.globalOptions=s.globalOptions||{...Kb},s.globalOptions};function Qx(s,e,t,n){return t=t||[],t=Array.isArray(t)?t:[t],YO(s,t),QO(e,s,n)}function Pf(s,e){let t=$x(),n=s||t;return typeof n.fetch=="function"?n.fetch:Pl(n.fetch)?i=>Wb(i,n):e!=null&&e.fetch?e?.fetch:Wb}function YO(s,e){Xx(s,null,Kb,qx,e);for(let t of e){let n=s&&s[t.id]||{},i=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Xx(n,t.id,i,o,e)}}function Xx(s,e,t,n,i){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&Pl(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in n)$b.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(n[l],"'"))();else if(!u){let d=$O(l,i);$b.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function $O(s,e){let t=s.toLowerCase(),n="";for(let i of e)for(let o in i.options){if(s===o)return"Did you mean '".concat(i.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(n=n||"Did you mean '".concat(i.id,".").concat(o,"'?"))}return n}function QO(s,e,t){let i={...s.options||{}};return ZO(i,t),i.log===null&&(i.log=new Qb),Yx(i,$x()),Yx(i,e),i}function Yx(s,e){for(let t in e)if(t in e){let n=e[t];kb(n)&&kb(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function ZO(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function fc(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function eP(s){var e,t;Ho(s,"null loader"),Ho(fc(s),"invalid loader");let n;return Array.isArray(s)&&(n=s[1],s=s[0],s={...s,options:{...s.options,...n}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var KO=()=>{let s=Jb();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function Zx(){return KO()}var Kx=new Nr({id:"loaders.gl"});var JO=/\.([^.]+)$/;async function tC(s,e=[],t,n){if(!rC(s))return null;let i=Jx(s,e,{...t,nothrow:!0},n);if(i)return i;if(Fn(s)&&(s=await s.slice(0,10).arrayBuffer(),i=Jx(s,e,t,n)),!i&&!(t!=null&&t.nothrow))throw new Error(nC(s));return i}function Jx(s,e=[],t,n){if(!rC(s))return null;if(e&&!Array.isArray(e))return eP(e);let i=[];e&&(i=i.concat(e)),t!=null&&t.ignoreRegisteredLoaders||i.push(...Zx()),tR(i);let o=eR(s,i,t,n);if(!o&&!(t!=null&&t.nothrow))throw new Error(nC(s));return o}function eR(s,e,t,n){let{url:i,type:o}=ea(s),a=i||n?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=tP(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||rR(e,a),u=u||(l?"matched url ".concat(a):""),l=l||tP(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||iR(e,s),u=u||(l?"matched initial data ".concat(iC(s)):""),l=l||tP(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;Kx.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function rC(s){return!(s instanceof Response&&s.status===204)}function nC(s){let{url:e,type:t}=ea(s),n="No valid loader found (";n+=e?"".concat(sf.filename(e),", "):"no url provided, ",n+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let i=s?iC(s):"";return n+=i?' first bytes: "'.concat(i,'"'):"first bytes: not available",n+=")",n}function tR(s){for(let e of s)eP(e)}function rR(s,e){let t=e&&JO.exec(e),n=t&&t[1];return n?nR(s,n):null}function nR(s,e){e=e.toLowerCase();for(let t of s)for(let n of t.extensions)if(n.toLowerCase()===e)return t;return null}function tP(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function iR(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(oR(e,t))return t}else if(ArrayBuffer.isView(e)){if(eC(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&eC(e,0,t))return t;return null}function oR(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(n=>s.startsWith(n))}function eC(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(i=>sR(s,e,t,i))}function sR(s,e,t,n){if(n instanceof ArrayBuffer)return Gb(n,s,n.byteLength);switch(typeof n){case"function":return n(s,t);case"string":let i=rP(s,e,n.length);return n===i;default:return!1}}function iC(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?rP(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?rP(s,0,e):""}function rP(s,e,t){if(s.byteLength<e+t)return"";let n=new DataView(s),i="";for(let o=0;o<t;o++)i+=String.fromCharCode(n.getUint8(e+o));return i}function*oC(s,e){let t=e?.chunkSize||262144,n=0,i=new TextEncoder;for(;n<s.length;){let o=Math.min(s.length-n,t),a=s.slice(n,n+o);n+=o,yield i.encode(a)}}function*sC(s,e={}){let{chunkSize:t=262144}=e,n=0;for(;n<s.byteLength;){let i=Math.min(s.byteLength-n,t),o=new ArrayBuffer(i),a=new Uint8Array(s,n,i);new Uint8Array(o).set(a),n+=i,yield o}}async function*aC(s,e){let t=e?.chunkSize||1048576,n=0;for(;n<s.size;){let i=n+t,o=await s.slice(n,i).arrayBuffer();n=i,yield o}}function nP(s,e){return lc?aR(s,e):lR(s,e)}async function*aR(s,e){let t=s.getReader(),n;try{for(;;){let i=n||t.read();e!=null&&e._streamReadAhead&&(n=t.read());let{done:o,value:a}=await i;if(o)return;yield of(a)}}catch{t.releaseLock()}}async function*lR(s,e){for await(let t of s)yield of(t)}function lC(s,e){if(typeof s=="string")return oC(s,e);if(s instanceof ArrayBuffer)return sC(s,e);if(Fn(s))return aC(s,e);if(af(s))return nP(s,e);if(Ji(s))return nP(s.body,e);throw new Error("makeIterator")}var uC="Cannot convert supplied data type";function uR(s,e,t){if(e.text&&typeof s=="string")return s;if(Ex(s)&&(s=s.buffer),s instanceof ArrayBuffer){let n=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let n=s.buffer,i=s.byteLength||s.length;return(s.byteOffset!==0||i!==n.byteLength)&&(n=n.slice(s.byteOffset,s.byteOffset+i)),n}throw new Error(uC)}async function cC(s,e,t){let n=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||n)return uR(s,e,t);if(Fn(s)&&(s=await lf(s)),Ji(s)){let i=s;return await Ax(i),e.binary?await i.arrayBuffer():await i.text()}if(af(s)&&(s=lC(s,t)),yx(s)||Sx(s))return Fb(s);throw new Error(uC)}function hC(s,e,t=null){if(t)return t;let n={fetch:Pf(e,s),...s};return Array.isArray(n.loaders)||(n.loaders=null),n}function dC(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let n=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...n]:n}return t&&t.length?t:null}async function yf(s,e,t,n){br(!n||typeof n=="object"),e&&!Array.isArray(e)&&!fc(e)&&(n=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:i}=ea(s),a=dC(e,n),l=await tC(s,a,t);return l?(t=Qx(t,l,a,i),n=hC({url:i,parse:yf,loaders:a},t,n),await cR(l,s,t,n)):null}async function cR(s,e,t,n){if(Bb(s),e=await cC(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,n,s);if(Mb(s,t))return await Nb(s,e,t,n,yf);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,n,s);if(s.parse)return await s.parse(e,t,n,s);throw br(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function qo(s,e,t,n){!Array.isArray(e)&&!fc(e)&&(n=void 0,t=e,e=void 0);let i=Pf(t),o=s;return typeof s=="string"&&(o=await i(s)),Fn(s)&&(o=await i(s)),await yf(o,e,t)}var fC="3.1.8";var{_parseImageNode:hR}=globalThis,iP=typeof Image<"u",oP=typeof ImageBitmap<"u",dR=Boolean(hR),sP=lc?!0:dR;function gC(s){switch(s){case"auto":return oP||iP||sP;case"imagebitmap":return oP;case"image":return iP;case"data":return sP;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function pC(){if(oP)return"imagebitmap";if(iP)return"image";if(sP)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function fR(s){let e=gR(s);if(!e)throw new Error("Not an image");return e}function mC(s){switch(fR(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function gR(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var pR=/^data:image\/svg\+xml/,mR=/\.svg((\?|#).*)?$/;function Sf(s){return s&&(pR.test(s)||mR.test(s))}function bC(s,e){if(Sf(e)){let n=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(n=unescape(encodeURIComponent(n)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(n))}return aP(s,e)}function aP(s,e){if(Sf(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function gc(s,e,t){let n=bC(s,t),i=self.URL||self.webkitURL,o=typeof n!="string"&&i.createObjectURL(n);try{return await bR(o||n,e)}finally{o&&i.revokeObjectURL(o)}}async function bR(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((n,i)=>{try{t.onload=()=>n(t),t.onerror=o=>i(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){i(o)}})}var PR={},PC=!0;async function lP(s,e,t){let n;Sf(t)?n=await gc(s,e,t):n=aP(s,t);let i=e&&e.imagebitmap;return await yR(n,i)}async function yR(s,e=null){if((SR(e)||!PC)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),PC=!1}return await createImageBitmap(s)}function SR(s){for(let e in s||PR)return!1;return!0}function Ef(s){let e=pc(s);return ER(e)||AR(e)||xR(e)||CR(e)}function ER(s){let e=pc(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function xR(s){let e=pc(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function CR(s){let e=pc(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function AR(s){let e=pc(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:n,sofMarkers:i}=vR(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(i.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!n.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function vR(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function pc(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function uP(s,e){let{mimeType:t}=Ef(s)||{},n=globalThis._parseImageNode;return Ho(n),await n(s,t)}async function cP(s,e,t){e=e||{};let i=(e.image||{}).type||"auto",{url:o}=t||{},a=TR(i),l;switch(a){case"imagebitmap":l=await lP(s,e,o);break;case"image":l=await gc(s,e,o);break;case"data":l=await uP(s,e);break;default:Ho(!1)}return i==="data"&&(l=mC(l)),l}function TR(s){switch(s){case"auto":case"data":return pC();default:return gC(s),s}}var IR=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],wR=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],LR={image:{type:"auto",decode:!0}},mc={id:"image",module:"images",name:"Images",version:fC,mimeTypes:wR,extensions:IR,parse:cP,tests:[s=>Boolean(Ef(new DataView(s)))],options:LR};var Le=new Nr({id:"deck"});var yC={};function tr(s){Le.level>0&&yC[s]&&yC[s].call(...arguments)}var Z=new Nr({id:"luma.gl"});function Lt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var OR="Invalid WebGLRenderingContext";var RR="Requires WebGL2";function na(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function se(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function hP(s){return se(s)?s:null}function to(s){return Lt(na(s),OR),s}function at(s){return Lt(se(s),RR),s}var ia=ne(bc()),Pc={};function BR(s){ia.global.console&&ia.global.console.error&&ia.global.console.error(s)}function MR(s){ia.global.console&&ia.global.console.log&&ia.global.console.log(s)}function NR(s,e){Pc[s]=!0,e!==void 0&&BR(e)}function DR(s){let e=s.getError;s.getError=function(){let n;do n=e.apply(s),n!==0&&(Pc[n]=!0);while(n!==0);for(n in Pc)if(Pc[n])return delete Pc[n],parseInt(n,10);return 0}}var yc=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let n=0;n<this.attribs.length;n++){let i=new s.VertexAttrib(t);this.attribs[n]=i}this.maxAttrib=0};yc.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};yc.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var oa=function(e){let t=this;this.gl=e,DR(e);let n=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:n.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return n.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let f=d.attribs[o];return f.buffer=t.currentArrayBuffer,f.size=a,f.type=l,f.normalized=u,f.stride=c,f.offset=h,f.recache(),n.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{MR("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};oa.prototype.VERTEX_ARRAY_BINDING_OES=34229;oa.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let n=0;n<this.vertexArrayObjects.length;++n)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new yc(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};oa.prototype.createVertexArrayOES=function(){let e=new yc(this);return this.vertexArrayObjects.push(e),e};oa.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};oa.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof yc&&e.hasBeenBound&&e.ext===this)};oa.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){NR(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let n=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(i===o)return;(!i||o.elementArrayBuffer!==i.elementArrayBuffer)&&n.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(i?i.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=i?i.attribs[u]:null;if((!i||c.enabled!==h.enabled)&&(c.enabled?n.enableVertexAttribArray.call(t,u):n.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!i||c.buffer!==h.buffer)&&(a!==c.buffer&&(n.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&n.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&n.bindBuffer.call(t,34962,this.currentArrayBuffer)};function EC(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let i=e.call(this)||[];return i.indexOf("OES_vertex_array_object")<0&&i.push("OES_vertex_array_object"),i};let t=s.getExtension;s.getExtension=function(i){let o=t.call(this,i);return o||(i!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new oa(this)),this.__OESVertexArrayObject))}}var xC="OES_element_index",CC="WEBGL_draw_buffers",GR="EXT_disjoint_timer_query",_R="EXT_disjoint_timer_query_webgl2",FR="EXT_texture_filter_anisotropic",AC="WEBGL_debug_renderer_info",VR=35723,kR=4352,UR=36795,zR=34047,WR=37445,HR=37446,et=s=>se(s)?void 0:0,jR={[3074]:s=>se(s)?void 0:36064,[VR]:s=>se(s)?void 0:kR,[35977]:et,[32937]:et,[UR]:(s,e)=>{let t=se(s)?s.getExtension(_R):s.getExtension(GR);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[WR]:(s,e)=>{let t=s.getExtension(AC);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[HR]:(s,e)=>{let t=s.getExtension(AC);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[zR]:(s,e)=>{let t=s.luma.extensions[FR];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:et,[35071]:et,[37447]:et,[36063]:(s,e)=>{if(!se(s)){let t=s.getExtension(CC);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:et,[35374]:et,[35377]:et,[34852]:s=>{if(!se(s)){let e=s.getExtension(CC);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(xC)?2147483647:65535,[33001]:s=>s.getExtension(xC)?16777216:65535,[33e3]:s=>16777216,[37157]:et,[35373]:et,[35657]:et,[36183]:et,[37137]:et,[34045]:et,[35978]:et,[35979]:et,[35968]:et,[35376]:et,[35375]:et,[35659]:et,[37154]:et,[35371]:et,[35658]:et,[35076]:et,[35077]:et,[35380]:et};function vC(s,e,t){let n=jR[t],i=typeof n=="function"?n(s,e,t):n;return i!==void 0?i:e(t)}var qR="OES_vertex_array_object",TC="ANGLE_instanced_arrays",XR="WEBGL_draw_buffers",YR="EXT_disjoint_timer_query",$R="EXT_texture_filter_anisotropic",QR="VertexArray requires WebGL2 or OES_vertex_array_object extension";function ZR(s,e){return{webgl2:se(s),ext:s.getExtension(e)}}var dP={[qR]:{meta:{suffix:"OES"},createVertexArray:()=>{Lt(!1,QR)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[TC]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){Lt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[XR]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Lt(!1)}},[YR]:{meta:{suffix:"EXT"},createQuery:()=>{Lt(!1)},deleteQuery:()=>{Lt(!1)},beginQuery:()=>{Lt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},xf={readBuffer:(s,e,t)=>{se(s)&&e(t)},getVertexAttrib:(s,e,t,n)=>{let{webgl2:i,ext:o}=ZR(s,TC),a;switch(n){case 35069:a=i?void 0:!1;break;case 35070:a=!i&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,n)},getProgramParameter:(s,e,t,n)=>{if(!se(s))switch(n){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,n)},getInternalformatParameter:(s,e,t,n,i)=>{if(!se(s))switch(i){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,n,i)},getTexParameter(s,e,t,n){switch(n){case 34046:let{extensions:i}=s.luma,o=i[$R];n=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,n)},getParameter:vC,hint(s,e,t,n){return e(t,n)}};function IC(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(EC(s),JR(s),tB(s,dP),eB(s,{target:e,target2:s}),e.polyfilled=!0),s}var KR=typeof global<"u"?global:window;KR.polyfillContext=IC;function JR(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function eB(s,{target:e,target2:t}){Object.keys(xf).forEach(n=>{if(typeof xf[n]=="function"){let i=s[n]?s[n].bind(s):()=>{},o=xf[n].bind(null,s,i);e[n]=o,t[n]=o}})}function tB(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&rB(s,{extension:t,target:s.luma,target2:s})}function rB(s,{extension:e,target:t,target2:n}){let i=dP[e];Lt(i);let{meta:o={}}=i,{suffix:a=""}=o,l=s.getExtension(e);for(let u of Object.keys(i)){let c=`${u}${a}`,h=null;u==="meta"||typeof s[u]=="function"||(l&&typeof l[c]=="function"?h=(...d)=>l[c](...d):typeof i[u]=="function"&&(h=i[u].bind(t))),h&&(t[u]=h,n[u]=h)}}var Cf={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Xo=(s,e,t)=>e?s.enable(t):s.disable(t),wC=(s,e,t)=>s.hint(t,e),cn=(s,e,t)=>s.pixelStorei(t,e),nB=(s,e)=>{let t=se(s)?36009:36160;return s.bindFramebuffer(t,e)},iB=(s,e)=>s.bindFramebuffer(36008,e);function Sc(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var LC={[3042]:Xo,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Xo,[2885]:(s,e)=>s.cullFace(e),[2929]:Xo,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Xo,[35723]:wC,[36006]:nB,[2886]:(s,e)=>s.frontFace(e),[33170]:wC,[2849]:(s,e)=>s.lineWidth(e),[32823]:Xo,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Xo,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Xo,[3088]:(s,e)=>s.scissor(...e),[2960]:Xo,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:cn,[3317]:cn,[37440]:cn,[37441]:cn,[37443]:cn,[3330]:cn,[3332]:cn,[3331]:cn,[36010]:iB,[3314]:cn,[32878]:cn,[3316]:cn,[3315]:cn,[32877]:cn,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=Sc(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=Sc(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=Sc(e)?e:[e,e];let[t,n]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,n)},stencilFunc:(s,e)=>{e=Sc(e)&&e.length===3?[...e,...e]:e;let[t,n,i,o,a,l]=e;s.stencilFuncSeparate(1028,t,n,i),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=Sc(e)&&e.length===3?[...e,...e]:e;let[t,n,i,o,a,l]=e;s.stencilOpSeparate(1028,t,n,i),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function bt(s,e,t){return e[s]!==void 0?e[s]:t[s]}var OC={blendEquation:(s,e,t)=>s.blendEquationSeparate(bt(32777,e,t),bt(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(bt(32969,e,t),bt(32968,e,t),bt(32971,e,t),bt(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(bt(32824,e,t),bt(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(bt(32938,e,t),bt(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,bt(2962,e,t),bt(2967,e,t),bt(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,bt(34816,e,t),bt(36003,e,t),bt(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,bt(2964,e,t),bt(2965,e,t),bt(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,bt(34817,e,t),bt(34818,e,t),bt(34819,e,t))},fP={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,n,i)=>s({[32773]:new Float32Array([e,t,n,i])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,n,i)=>s({[32969]:e,[32968]:t,[32971]:n,[32970]:i}),clearColor:(s,e,t,n,i)=>s({[3106]:new Float32Array([e,t,n,i])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,n,i)=>s({[3107]:[e,t,n,i]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,n,i)=>s({[3088]:new Int32Array([e,t,n,i])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,n)=>s({[2962]:e,[2967]:t,[2963]:n,[34816]:e,[36003]:t,[36004]:n}),stencilFuncSeparate:(s,e,t,n,i)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:n,[e===1028?2963:36004]:i}),stencilOp:(s,e,t,n)=>s({[2964]:e,[2965]:t,[2966]:n,[34817]:e,[34818]:t,[34819]:n}),stencilOpSeparate:(s,e,t,n,i)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:n,[e===1028?2966:34819]:i}),viewport:(s,e,t,n,i)=>s({[2978]:[e,t,n,i]})},Pi=(s,e)=>s.isEnabled(e),gP={[3042]:Pi,[2884]:Pi,[2929]:Pi,[3024]:Pi,[32823]:Pi,[32926]:Pi,[32928]:Pi,[3089]:Pi,[2960]:Pi,[35977]:Pi};function pP(s){for(let e in s)return!1;return!0}function RC(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),n=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&n&&s.length===e.length){for(let i=0;i<s.length;++i)if(s[i]!==e[i])return!1;return!0}return!1}function BC(s,e){let t=s[e].bind(s);s[e]=function(...i){let o=i[0];return o in s.state.cache?s.state.enable?s.state.cache[o]:t(...i):t(...i)},Object.defineProperty(s[e],"name",{value:`${e}-from-cache`,configurable:!1})}function oB(s,e,t){let n=s[e].bind(s);s[e]=function(...o){let{valueChanged:a,oldValue:l}=t(s.state._updateCache,...o);return a&&n(...o),l},Object.defineProperty(s[e],"name",{value:`${e}-to-cache`,configurable:!1})}function sB(s){let e=s.useProgram.bind(s);s.useProgram=function(n){s.state.program!==n&&(e(n),s.state.program=n)}}var MC=class{constructor(e,{copyState:t=!1,log:n=()=>{}}={}){this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?vf(e):Object.assign({},Cf),this.log=n,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){Lt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];sa(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,n,i=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){Lt(o!==void 0);let a=e[o],l=this.cache[o];RC(a,l)||(t=!0,n=l,i&&!(o in i)&&(i[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:n}}};function mP(s,e={}){let{enable:t=!0,copyState:n}=e;if(Lt(n!==void 0),!s.state){let i=typeof global<"u"?global:window,{polyfillContext:o}=i;o&&o(s),s.state=new MC(s,{copyState:n}),sB(s);for(let a in fP){let l=fP[a];oB(s,a,l)}BC(s,"getParameter"),BC(s,"isEnabled")}return s.state.enable=t,s}function bP(s){s.state||mP(s,{copyState:!1}),s.state.push()}function Af(s){Lt(s.state),s.state.pop()}function sa(s,e){if(Lt(na(s),"setParameters requires a WebGL context"),pP(e))return;let t={};for(let i in e){let o=Number(i),a=LC[i];a&&(typeof a=="string"?t[a]=!0:a(s,e[i],o))}let n=s.state&&s.state.cache;if(n)for(let i in t)OC[i](s,e,n)}function vf(s,e){if(e=e||Cf,typeof e=="number"){let i=e,o=gP[i];return o?o(s,i):s.getParameter(i)}let t=Array.isArray(e)?e:Object.keys(e),n={};for(let i of t){let o=gP[i];n[i]=o?o(s,Number(i)):s.getParameter(Number(i))}return n}function rr(s,e,t){if(pP(e))return t(s);let{nocatch:n=!0}=e;bP(s),sa(s,e);let i;if(n)i=t(s),Af(s);else try{i=t(s)}finally{Af(s)}return i}var PP=ne(bc());var Vue=(0,PP.isBrowser)();var yi=ne(bc()),Ec="8.5.10",dB="set luma.log.level=1 (or higher) to trace rendering",NC=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new bl({id:e})),this.stats.get(e)}},aa=new NC;if(yi.global.luma&&yi.global.luma.VERSION!==Ec)throw new Error(`luma.gl - multiple VERSIONs detected: ${yi.global.luma.VERSION} vs ${Ec}`);yi.global.luma||((0,yi.isBrowser)()&&Z.log(1,`luma.gl ${Ec} - ${dB}`)(),yi.global.luma=yi.global.luma||{VERSION:Ec,version:Ec,log:Z,stats:aa,globals:{modules:{},nodeIO:{}}});var Jue=yi.global.luma;var zC=ne(bc());function H(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function Tf(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let n=s[e];return H(n!==void 0,`Accessing undefined constant GL.${e}`),n}function En(s,e){e=Number(e);for(let t in s)if(s[t]===e)return`GL.${t}`;return String(e)}var yP={};function Dr(s="id"){yP[s]=yP[s]||1;let e=yP[s]++;return`${s}-${e}`}function SP(s){return H(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function Si(s){let e=!0;for(let t in s){e=!1;break}return e}function If(s,e,t,n){let i=`See luma.gl ${t} Upgrade Guide at https://luma.gl/docs/upgrade-guide`,o=Object.getPrototypeOf(s);n.forEach(a=>{o.methodName||(o[a]=()=>{throw Z.removed(`Calling removed method ${e}.${a}: `,i)(),new Error(a)})})}var vl="Resource subclass must define virtual methods",jt=class{constructor(e,t={}){to(e);let{id:n,userData:i={}}=t;this.gl=e,this.gl2=e,this.id=n||Dr(this.constructor.name),this.userData=i,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return`${this.constructor.name}(${this.id})`}get handle(){return this._handle}delete({deleteChildren:e=!1}={}){let t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(n=>n.delete()),this}bind(e=this.handle){if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e,t={}){e=Tf(this.gl,e),H(e);let i=(this.constructor.PARAMETERS||{})[e];if(i){let o=se(this.gl);if(!((!("webgl2"in i)||o)&&(!("extension"in i)||this.gl.getExtension(i.extension)))){let l=i.webgl1,u="webgl2"in i?i.webgl2:i.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(e={}){let{parameters:t,keys:n}=e,i=this.constructor.PARAMETERS||{},o=se(this.gl),a={},l=t||Object.keys(i);for(let u of l){let c=i[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=n?En(this.gl,u):u;a[d]=this.getParameter(u,e),n&&c.type==="GLenum"&&(a[d]=En(this.gl,a[d]))}}return a}setParameter(e,t){e=Tf(this.gl,e),H(e);let i=(this.constructor.PARAMETERS||{})[e];if(i){let o=se(this.gl);if(!((!("webgl2"in i)||o)&&(!("extension"in i)||this.gl.getExtension(i.extension))))throw new Error("Parameter not available on this platform");i.type==="GLenum"&&(t=Tf(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,n){return If(this,e,t,n)}initialize(e){}_createHandle(){throw new Error(vl)}_deleteHandle(){throw new Error(vl)}_bindHandle(e){throw new Error(vl)}_getOptsFromHandle(){throw new Error(vl)}_getParameter(e,t){throw new Error(vl)}_setParameter(e,t){throw new Error(vl)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){let e=this.constructor.name,t=aa.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get(`${e}s Created`).incrementCount(),t.get(`${e}s Active`).incrementCount()}_removeStats(){let e=this.constructor.name;aa.get("Resource Counts").get(`${e}s Active`).decrementCount()}_trackAllocatedMemory(e,t=this.constructor.name){let n=aa.get("Memory Usage");n.get("GPU Memory").addCount(e),n.get(`${t} Memory`).addCount(e),this.byteLength=e}_trackDeallocatedMemory(e=this.constructor.name){let t=aa.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get(`${e} Memory`).subtractCount(this.byteLength),this.byteLength=0}};var fB="Failed to deduce GL constant from typed array";function xc(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(fB)}}function Yo(s,{clamped:e=!0}={}){switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function DC({data:s,width:e,height:t,bytesPerPixel:n=4,temp:i}){let o=e*n;i=i||new Uint8Array(o);for(let a=0;a<t/2;++a){let l=a*o,u=(t-a-1)*o;i.set(s.subarray(l,l+o)),s.copyWithin(l,u,u+o),s.set(i,u)}}function GC({data:s,width:e,height:t}){let n=Math.round(e/2),i=Math.round(t/2),o=new Uint8Array(n*i*4);for(let a=0;a<i;a++)for(let l=0;l<n;l++)for(let u=0;u<4;u++)o[(a*n+l)*4+u]=s[(a*2*e+l*2)*4+u];return{data:o,width:n,height:i}}function Cc(s,e,t){let{removedProps:n={},deprecatedProps:i={},replacedProps:o={}}=t;for(let l in n)if(l in e){let c=n[l]?`${s}.${n[l]}`:"N/A";Z.removed(`${s}.${l}`,c)()}for(let l in i)if(l in e){let u=i[l];Z.deprecated(`${s}.${l}`,`${s}.${u}`)()}let a=null;for(let l in o)if(l in e){let u=o[l];Z.deprecated(`${s}.${l}`,`${s}.${u}`)(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var gB={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},pB={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},qt=class{static getBytesPerElement(e){return Yo(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return H(e.size),Yo(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(...e){return new qt(...[gB,...e])}constructor(...e){e.forEach(t=>this._assign(t)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return qt.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return qt.getBytesPerVertex(this)}_assign(e={}){return e=Cc("Accessor",e,pB),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var _C=10,FC={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},mB={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:FC},bB={removedProps:FC},ge=class extends jt{constructor(e,t={}){super(e,t);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(e=this.accessor){return Math.round(this.byteLength/qt.getBytesPerElement(e))}getVertexCount(e=this.accessor){return Math.round(this.byteLength/qt.getBytesPerVertex(e))}initialize(e={}){return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Cc("Buffer",e,mB),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Cc("Buffer",e,bB),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new qt(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:n=0,srcOffset:i=0}=e,o=e.byteLength||e.length;H(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),i!==0||o!==void 0?(at(this.gl),this.gl.bufferSubData(this.target,n,t,i,o)):this.gl.bufferSubData(a,n,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData({sourceBuffer:e,readOffset:t=0,writeOffset:n=0,size:i}){let{gl:o}=this;return at(o),o.bindBuffer(36662,e.handle),o.bindBuffer(36663,this.handle),o.copyBufferSubData(36662,36663,t,n,i),o.bindBuffer(36662,null),o.bindBuffer(36663,null),this.debugData=null,this}getData({dstData:e=null,srcByteOffset:t=0,dstOffset:n=0,length:i=0}={}){at(this.gl);let o=Yo(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=n,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,i||a),c=l+u);let h=Math.min(a,u);return i=i||h,H(i<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,n,i),this.gl.bindBuffer(36662,null),e}bind({target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:n=0,size:i}={}){return e===35345||e===35982?i!==void 0?this.gl.bindBufferRange(e,t,this.handle,n,i):(H(n===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind({target:e=this.target,index:t=this.accessor&&this.accessor.index}={}){return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(_C,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e,t=0,n=e.byteLength+t){H(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let i=this._getTarget();this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,this.usage),this.gl.bufferSubData(i,t,e),this.gl.bindBuffer(i,null),this.debugData=e.slice(0,_C),this.bytesUsed=n,this._trackAllocatedMemory(n);let o=xc(e);return H(o),this.setAccessor(new qt(this.accessor,{type:o})),this}_setByteLength(e,t=this.usage){H(e>=0),this._trackDeallocatedMemory();let n=e;e===0&&(n=new Float32Array(0));let i=this._getTarget();return this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,t),this.gl.bindBuffer(i,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=Yo(this.accessor.type||5126,{clamped:!1}),n=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-n}_inferType(e){this.accessor.type||this.setAccessor(new qt(this.accessor,{type:xc(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return Z.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return Z.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return Z.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return Z.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new qt(this.accessor,e),this}};var wf={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},Lf={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},Of={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function VC(s,e){let t=wf[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let n=se(s)&&t.gl2||t.gl1;return typeof n=="string"?s.getExtension(n):n}function kC(s,e){let t=wf[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var PB=[9729,9728],UC=zC.global.WebGLBuffer||function(){},Gr=class extends jt{static isSupported(e,t={}){let{format:n,linearFiltering:i}=t,o=!0;return n&&(o=o&&VC(e,n),o=o&&(!i||kC(e,n))),o}constructor(e,t){let{id:n=Dr("texture"),handle:i,target:o}=t;super(e,{id:n,handle:i});this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return`Texture(${this.id},${this.width}x${this.height})`}initialize(e={}){let t=e.data;if(t instanceof Promise)return t.then(B=>this.initialize(Object.assign({},e,{pixels:B,data:B}))),this;let n=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(n&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:i=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=i);let{width:d,height:f,dataFormat:y,type:S,compressed:C=!1,mipmaps:T=!0}=e,{depth:I=0}=e;return{width:d,height:f,compressed:C,dataFormat:y,type:S}=this._deduceParameters({format:o,type:S,dataFormat:y,compressed:C,data:t,width:d,height:f}),this.width=d,this.height=f,this.depth=I,this.format=o,this.type=S,this.dataFormat=y,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),T&&this._isNPOT()&&(Z.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),T=!1,this._updateForNPOT(u)),this.mipmaps=T,this.setImageData({data:t,width:d,height:f,depth:I,format:o,type:S,dataFormat:y,border:a,mipmaps:T,parameters:c,compressed:C}),T&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),n&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:n}=this._video;if(n===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize({height:e,width:t,mipmaps:n=!1}){return t!==this.width||e!==this.height?this.initialize({width:t,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(e={}){return this._isNPOT()?(Z.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),rr(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:n=null,level:i=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:f=this.height,dataFormat:y=this.dataFormat,compressed:S=!1}=e;c||(c=n),{type:h,dataFormat:y,compressed:S,width:d,height:f}=this._deduceParameters({format:o,type:h,dataFormat:y,compressed:S,data:c,width:d,height:f});let{gl:C}=this;C.bindTexture(this.target,this.handle);let T=null;({data:c,dataType:T}=this._getDataType({data:c,compressed:S}));let I;if(rr(this.gl,u,()=>{switch(T){case"null":C.texImage2D(t,i,o,d,f,a,y,h,c);break;case"typed-array":C.texImage2D(t,i,o,d,f,a,y,h,c,l);break;case"buffer":I=at(C),I.bindBuffer(35052,c.handle||c),I.texImage2D(t,i,o,d,f,a,y,h,l),I.bindBuffer(35052,null);break;case"browser-object":se(C)?C.texImage2D(t,i,o,d,f,a,y,h,c):C.texImage2D(t,i,o,y,h,c);break;case"compressed":for(let[B,w]of c.entries())C.compressedTexImage2D(t,B,w.format,w.width,w.height,a,w.data);break;default:H(!1,"Unknown image data type")}}),c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let B=Lf[this.dataFormat]||4,w=Of[this.type]||1;this._trackAllocatedMemory(this.width*this.height*B*w,"Texture")}return this.loaded=!0,this}setSubImageData({target:e=this.target,pixels:t=null,data:n=null,x:i=0,y:o=0,width:a=this.width,height:l=this.height,level:u=0,format:c=this.format,type:h=this.type,dataFormat:d=this.dataFormat,compressed:f=!1,offset:y=0,border:S=this.border,parameters:C={}}){if({type:h,dataFormat:d,compressed:f,width:a,height:l}=this._deduceParameters({format:c,type:h,dataFormat:d,compressed:f,data:n,width:a,height:l}),H(this.depth===0,"texSubImage not supported for 3D textures"),n||(n=t),n&&n.data){let T=n;n=T.data,a=T.shape[0],l=T.shape[1]}n instanceof ge&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),rr(this.gl,C,()=>{if(f)this.gl.compressedTexSubImage2D(e,u,i,o,a,l,c,n);else if(n===null)this.gl.texSubImage2D(e,u,i,o,a,l,d,h,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(e,u,i,o,a,l,d,h,n,y);else if(n instanceof UC){let T=at(this.gl);T.bindBuffer(35052,n),T.texSubImage2D(e,u,i,o,a,l,d,h,y),T.bindBuffer(35052,null)}else se(this.gl)?at(this.gl).texSubImage2D(e,u,i,o,a,l,d,h,n):this.gl.texSubImage2D(e,u,i,o,d,h,n)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(e={}){return Z.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(e=this.textureUnit){let{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType({data:e,compressed:t=!1}){return t?{data:e,dataType:"compressed"}:e===null?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof ge?{data:e.handle,dataType:"buffer"}:e instanceof UC?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:n}=e,{width:i,height:o,dataFormat:a,type:l,compressed:u}=e,c=wf[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:i,height:o}=this._deduceImageSize(n,i,o),{dataFormat:a,type:l,compressed:u,width:i,height:o,format:t,data:n}}_deduceImageSize(e,t,n){let i;return typeof ImageData<"u"&&e instanceof ImageData?i={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?i={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?i={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?i={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?i={width:e.videoWidth,height:e.videoHeight}:e?i={width:t,height:n}:i={width:t>=0?t:1,height:n>=0?n:1},H(i,"Could not deduced texture size"),H(t===void 0||i.width===t,"Deduced texture width does not match supplied width"),H(n===void 0||i.height===n,"Deduced texture height does not match supplied height"),i}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:H(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return se(this.gl)||!this.width||!this.height?!1:!SP(this.width)||!SP(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:PB.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var yB="";function WC(s,e){return H(typeof s=="string"),s=yB+s,new Promise((t,n)=>{try{let i=new Image;i.onload=()=>t(i),i.onerror=()=>n(new Error(`Could not load image ${s}.`)),i.crossOrigin=e&&e.crossOrigin||"anonymous",i.src=s}catch(i){n(i)}})}var Ot=class extends Gr{static isSupported(e,t){return Gr.isSupported(e,t)}constructor(e,t={}){to(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:WC(t.data)}));super(e,Object.assign({},t,{target:3553}));this.initialize(t),Object.seal(this)}};var EP=[34069,34070,34071,34072,34073,34074],Tl=class extends Gr{constructor(e,t={}){to(e);super(e,Object.assign({},t,{target:34067}));this.initialize(t),Object.seal(this)}initialize(e={}){let{mipmaps:t=!0,parameters:n={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(n)}),this}subImage({face:e,data:t,x:n=0,y:i=0,mipmapLevel:o=0}){return this._subImage({target:e,data:t,x:n,y:i,mipmapLevel:o})}async setCubeMapImageData({width:e,height:t,pixels:n,data:i,border:o=0,format:a=6408,type:l=5121}){let{gl:u}=this,c=n||i,h=await Promise.all(EP.map(d=>{let f=c[d];return Promise.all(Array.isArray(f)?f:[f])}));this.bind(),EP.forEach((d,f)=>{h[f].length>1&&this.opts.mipmaps!==!1&&Z.warn(`${this.id} has mipmap and multiple LODs.`)(),h[f].forEach((y,S)=>{e&&t?u.texImage2D(d,S,a,e,t,o,a,l,y):u.texImage2D(d,S,a,a,l,y)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:n,height:i,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(f=>this.setImageDataForFace(Object.assign({},e,{face:t,data:f,pixels:f}))):this.width||this.height?h.texImage2D(t,0,u,n,i,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};Tl.FACES=EP;var Ac=class extends Gr{static isSupported(e){return se(e)}constructor(e,t={}){at(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1});super(e,t);this.initialize(t),Object.seal(this)}setImageData({level:e=0,dataFormat:t=6408,width:n,height:i,depth:o=1,border:a=0,format:l,type:u=5121,offset:c=0,data:h,parameters:d={}}){if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),rr(this.gl,d,()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,e,t,n,i,o,a,l,u,h),h instanceof ge&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,e,t,n,i,o,a,l,u,c))}),h&&h.byteLength)this._trackAllocatedMemory(h.byteLength,"Texture");else{let f=Lf[this.dataFormat]||4,y=Of[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*f*y,"Texture")}return this.loaded=!0,this}};var la="EXT_color_buffer_float",xP={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:la,bpp:2},[33327]:{gl2:la,bpp:4},[34842]:{gl2:la,bpp:8},[33326]:{gl2:la,bpp:4},[33328]:{gl2:la,bpp:8},[34836]:{gl2:la,bpp:16},[35898]:{gl2:la,bpp:4}};function SB(s,e,t){let n=t[e];if(!n)return!1;let i=se(s)&&n.gl2||n.gl1;return typeof i=="string"?s.getExtension(i):i}var Ei=class extends jt{static isSupported(e,{format:t}={format:null}){return!t||SB(e,t,xP)}static getSamplesForFormat(e,{format:t}){return e.getInternalformatParameter(36161,t,32937)}constructor(e,t={}){super(e,t);this.initialize(t),Object.seal(this)}initialize({format:e,width:t=1,height:n=1,samples:i=0}){return H(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),i!==0&&se(this.gl)?this.gl.renderbufferStorageMultisample(36161,i,e,t,n):this.gl.renderbufferStorage(36161,e,t,n),this.format=e,this.width=t,this.height=n,this.samples=i,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*xP[this.format].bpp),this}resize({width:e,height:t}){return e!==this.width||t!==this.height?this.initialize({width:e,height:t,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var EB=256,xB=1024,CB=16384,HC=6144,jC=6145,qC=6146,XC=34041,YC="clear: bad arguments";function Il(s,{framebuffer:e=null,color:t=null,depth:n=null,stencil:i=null}={}){let o={};e&&(o.framebuffer=e);let a=0;t&&(a|=CB,t!==!0&&(o.clearColor=t)),n&&(a|=EB,n!==!0&&(o.clearDepth=n)),i&&(a|=xB,n!==!0&&(o.clearStencil=n)),H(a!==0,YC),rr(s,o,()=>{s.clear(a)})}function CP(s,{framebuffer:e=null,buffer:t=HC,drawBuffer:n=0,value:i=[0,0,0,0]}={}){at(s),rr(s,{framebuffer:e},()=>{switch(t){case HC:switch(i.constructor){case Int32Array:s.clearBufferiv(t,n,i);break;case Uint32Array:s.clearBufferuiv(t,n,i);break;case Float32Array:default:s.clearBufferfv(t,n,i)}break;case jC:s.clearBufferfv(jC,0,[i]);break;case qC:s.clearBufferiv(qC,0,[i]);break;case XC:let[o,a]=i;s.clearBufferfi(XC,0,o,a);break;default:H(!1,YC)}})}function $C(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return H(!1),0}}function ua(s,e={}){let{sourceX:t=0,sourceY:n=0,sourceFormat:i=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=QC(s);H(h);let{gl:f,handle:y,attachments:S}=h;l=l||h.width,u=u||h.height,o===36064&&y===null&&(o=1028),H(S[o]),c=c||S[o].type,a=AB(a,c,i,l,u),c=c||xc(a);let C=f.bindFramebuffer(36160,y);return f.readPixels(t,n,l,u,i,c,a),f.bindFramebuffer(36160,C||null),d&&h.delete(),a}function Rf(s,{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}={}){let n=ua(s,{sourceAttachment:e}),{width:i,height:o}=s;for(;o>t;)({data:n,width:i,height:o}=GC({data:n,width:i,height:o}));DC({data:n,width:i,height:o});let a=document.createElement("canvas");a.width=i,a.height=o;let l=a.getContext("2d"),u=l.createImageData(i,o);return u.data.set(n),l.putImageData(u,0,0),a.toDataURL()}function Bf(s,e,t={}){let{sourceX:n=0,sourceY:i=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:f,deleteFramebuffer:y}=QC(s);H(f);let{gl:S,handle:C}=f,T=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let I=S.bindFramebuffer(36160,C);H(e);let B=null;if(e instanceof Gr&&(B=e,h=Number.isFinite(h)?h:B.width,d=Number.isFinite(d)?d:B.height,B.bind(0),e=B.target),!T)S.copyTexImage2D(e,o,a,n,i,h,d,0);else switch(e){case 3553:case 34067:S.copyTexSubImage2D(e,o,l,u,n,i,h,d);break;case 35866:case 32879:at(S).copyTexSubImage3D(e,o,l,u,c,n,i,h,d);break;default:}return B&&B.unbind(),S.bindFramebuffer(36160,I||null),y&&f.delete(),B}function QC(s){return s instanceof Pt?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:ZC(s),deleteFramebuffer:!0}}function AB(s,e,t,n,i){if(s)return s;e=e||5121;let o=Yo(e,{clamped:!1}),a=$C(t);return new o(n*i*a)}var tt={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function vB(s){let e=new Ot(s,{format:6408,type:5126,dataFormat:6408}),t=new Pt(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),n=t.getStatus();return e.delete(),t.delete(),n===36053}var AP={[tt.WEBGL2]:[!1,!0],[tt.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[tt.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[tt.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[tt.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[tt.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[tt.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[tt.FLOAT_BLEND]:["EXT_float_blend"],[tt.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[tt.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[tt.TEXTURE_FLOAT]:["OES_texture_float",!0],[tt.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[tt.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[tt.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[tt.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[tt.COLOR_ATTACHMENT_RGBA32F]:[vB,"EXT_color_buffer_float"],[tt.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[tt.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[tt.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[tt.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[tt.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[tt.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var TB=2;function vc(s,e){return Mf(s,e)}function Mf(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>KC(s,t))}function Nf(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in AP)s.luma.caps[e]===void 0&&(s.luma.caps[e]=KC(s,e));return s.luma.caps}function KC(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=IB(s,e)),s.luma.caps[e]||Z.log(TB,`Feature: ${e} not supported`)(),s.luma.caps[e]}function IB(s,e){let t=AP[e];H(t,e);let n,i=se(s)&&t[1]||t[0];if(typeof i=="function")n=i(s);else if(Array.isArray(i)){n=!0;for(let o of i)n=n&&Boolean(s.getExtension(o))}else typeof i=="string"?n=Boolean(s.getExtension(i)):typeof i=="boolean"?n=i:H(!1);return n}var JC="Multiple render targets not supported",Pt=class extends jt{static isSupported(e,t={}){let{colorBufferFloat:n,colorBufferHalfFloat:i}=t,o=!0;return n&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),i&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new Pt(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=at(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=at(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e,t={}){super(e,t);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize({width:e=1,height:t=1,attachments:n=null,color:i=!0,depth:o=!0,stencil:a=!1,check:l=!0,readBuffer:u=void 0,drawBuffers:c=void 0}){if(H(e>=0&&t>=0,"Width and height need to be integers"),this.width=e,this.height=t,n)for(let h in n){let d=n[h];(Array.isArray(d)?d[0]:d).resize({width:e,height:t})}else n=this._createDefaultAttachments(i,o,a,e,t);this.update({clearAttachments:!0,attachments:n,readBuffer:u,drawBuffers:c}),n&&l&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update({attachments:e={},readBuffer:t,drawBuffers:n,clearAttachments:i=!1,resizeAttachments:o=!0}){this.attach(e,{clearAttachments:i,resizeAttachments:o});let{gl:a}=this,l=a.bindFramebuffer(36160,this.handle);return t&&this._setReadBuffer(t),n&&this._setDrawBuffers(n),a.bindFramebuffer(36160,l||null),this}resize(e={}){let{width:t,height:n}=e;if(this.handle===null)return H(t===void 0&&n===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),n===void 0&&(n=this.gl.drawingBufferHeight),t!==this.width&&n!==this.height&&Z.log(2,`Resizing framebuffer ${this.id} to ${t}x${n}`)();for(let i in this.attachments)this.attachments[i].resize({width:t,height:n});return this.width=t,this.height=n,this}attach(e,{clearAttachments:t=!1,resizeAttachments:n=!0}={}){let i={};t&&Object.keys(this.attachments).forEach(a=>{i[a]=null}),Object.assign(i,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in i){H(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=i[l],c=u;if(!c)this._unattach(l);else if(c instanceof Ei)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,f=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:f})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});n&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(LB(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),n=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),n}clear(e={}){let{color:t,depth:n,stencil:i,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||n||i)&&Il(this.gl,{color:t,depth:n,stencil:i}),o.forEach((l,u)=>{CP(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(e={}){return Z.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(e={}){return Z.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(e={}){return Z.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(e={}){return Z.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(e={}){return Z.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(e={}){return Z.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate({attachments:e=[],x:t=0,y:n=0,width:i,height:o}){let a=at(this.gl),l=a.bindFramebuffer(36008,this.handle);return t===0&&n===0&&i===void 0&&o===void 0?a.invalidateFramebuffer(36008,e):a.invalidateFramebuffer(36008,e,t,n,i,o),a.bindFramebuffer(36008,l),this}getAttachmentParameter(e,t,n){let i=this._getAttachmentParameterFallback(t);return i===null&&(this.gl.bindFramebuffer(36160,this.handle),i=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),n&&i>1e3&&(i=En(this.gl,i)),i}getAttachmentParameters(e=36064,t,n=this.constructor.ATTACHMENT_PARAMETERS||[]){let i={};for(let o of n){let a=t?En(this.gl,o):o;i[a]=this.getAttachmentParameter(e,o,t)}return i}getParameters(e=!0){let t=Object.keys(this.attachments),n={};for(let i of t){let o=Number(i),a=e?En(this.gl,o):o;n[a]=this.getAttachmentParameters(o,e)}return n}show(){return typeof window<"u"&&window.open(Rf(this),"luma-debug-texture"),this}log(e=0,t=""){if(e>Z.level||typeof window>"u")return this;t=t||`Framebuffer ${this.id}`;let n=Rf(this,{targetMaxHeight:100});return Z.image({logLevel:e,message:t,image:n},t)(),this}bind({target:e=36160}={}){return this.gl.bindFramebuffer(e,this.handle),this}unbind({target:e=36160}={}){return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,n,i,o){let a=null;return e&&(a=a||{},a[36064]=new Ot(this.gl,{id:`${this.id}-color0`,pixels:null,format:6408,type:5121,width:i,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&n?(a=a||{},a[33306]=new Ei(this.gl,{id:`${this.id}-depth-stencil`,format:35056,width:i,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new Ei(this.gl,{id:`${this.id}-depth`,format:33189,width:i,height:o}),this.ownResources.push(a[36096])):n&&H(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof Ei?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer({attachment:e=36064,renderbuffer:t}){let{gl:n}=this;n.framebufferRenderbuffer(36160,e,36161,t.handle),this.attachments[e]=t}_attachTexture({attachment:e=36064,texture:t,layer:n,level:i}){let{gl:o}=this;switch(o.bindTexture(t.target,t.handle),t.target){case 35866:case 32879:at(o).framebufferTextureLayer(36160,e,t.target,i,n);break;case 34067:let l=wB(n);o.framebufferTexture2D(36160,e,l,t.handle,i);break;case 3553:o.framebufferTexture2D(36160,e,3553,t.handle,i);break;default:H(!1,"Illegal texture type")}o.bindTexture(t.target,null),this.attachments[e]=t}_setReadBuffer(e){let t=hP(this.gl);t?t.readBuffer(e):H(e===36064||e===1029,JC),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,n=at(t);if(n)n.drawBuffers(e);else{let i=t.getExtension("WEBGL_draw_buffers");i?i.drawBuffersWEBGL(e):H(e.length===1&&(e[0]===36064||e[0]===1029),JC)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=Nf(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function wB(s){return s<34069?s+34069:s}function LB(s){return(Pt.STATUS||{})[s]||`Framebuffer error ${s}`}var OB=[36049,36048,33296,33298,33299,33300,33301,33302,33303];Pt.ATTACHMENT_PARAMETERS=OB;function wl(s,e){H(s instanceof Ot||s instanceof Tl||s instanceof Ac);let t=s.constructor,{gl:n,width:i,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:i,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(n,d)}function ZC(s,e){let{gl:t,width:n,height:i,id:o}=s;return new Pt(t,Object.assign({},e,{id:`framebuffer-for-${o}`,width:n,height:i,attachments:{[36064]:s}}))}function $o(s,e="unnamed"){let t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,n=s.match(t);return n?n[1]:e}function vP(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function TP(s,e,t,n){let i=s.split(/\r?\n/),o={},a={},l=n||$o(e)||"(unnamed)",u=`${vP(t)} shader ${l}`;for(let h=0;h<i.length;h++){let d=i[h];if(d.length<=1)continue;let f=d.split(":"),y=f[0],S=parseInt(f[2],10);if(isNaN(S))throw new Error(`GLSL compilation error in ${u}: ${s}`);y!=="WARNING"?o[S]=d:a[S]=d}let c=RB(e);return{shaderName:u,errors:e1(o,c),warnings:e1(a,c)}}function e1(s,e){let t="";for(let n=0;n<e.length;n++){let i=e[n];if(!(!s[n+3]&&!s[n+2]&&!s[n+1])&&(t+=`${i}
`,s[n+1])){let o=s[n+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=t1(`^^^ ${l}: ${c}

`,u)}}return t}function RB(s,e=1,t=": "){let n=s.split(/\r?\n/),i=String(n.length+e-1).length;return n.map((o,a)=>{let l=String(a+e),u=l.length;return t1(l,i-u)+t+o})}function t1(s,e){let t="";for(let n=0;n<e;++n)t+=" ";return`${t}${s}`}function Ll(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let n=parseInt(t[1],10);Number.isFinite(n)&&(e=n)}return e}var BB="Shader: GLSL source code must be a JavaScript string",Ol=class extends jt{static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return H(!1),"unknown"}}constructor(e,t){to(e),H(typeof t.source=="string",BB);let n=$o(t.source,null)||t.id||Dr(`unnamed ${Ol.getTypeName(t.shaderType)}`);super(e,{id:n});this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize({source:e}){let t=$o(e,null);t&&(this.id=Dr(t)),this._compile(e)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return`${Ol.getTypeName(this.shaderType)}:${this.id}`}getName(){return $o(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(e=this.source){if(e.startsWith("#version ")||(e=`#version 100
${e}`),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let n=this.gl.getShaderInfoLog(this.handle),{shaderName:i,errors:o,warnings:a}=TP(n,this.source,this.shaderType,this.id);throw Z.error(`GLSL compilation errors in ${i}
${o}`)(),Z.warn(`GLSL compilation warnings in ${i}
${a}`)(),new Error(`GLSL compilation errors in ${i}`)}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},Tc=class extends Ol{constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},Ic=class extends Ol{constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var MB={[5126]:lt.bind(null,"uniform1fv",hn,1,Pr),[35664]:lt.bind(null,"uniform2fv",hn,2,Pr),[35665]:lt.bind(null,"uniform3fv",hn,3,Pr),[35666]:lt.bind(null,"uniform4fv",hn,4,Pr),[5124]:lt.bind(null,"uniform1iv",Qo,1,Pr),[35667]:lt.bind(null,"uniform2iv",Qo,2,Pr),[35668]:lt.bind(null,"uniform3iv",Qo,3,Pr),[35669]:lt.bind(null,"uniform4iv",Qo,4,Pr),[35670]:lt.bind(null,"uniform1iv",Qo,1,Pr),[35671]:lt.bind(null,"uniform2iv",Qo,2,Pr),[35672]:lt.bind(null,"uniform3iv",Qo,3,Pr),[35673]:lt.bind(null,"uniform4iv",Qo,4,Pr),[35674]:lt.bind(null,"uniformMatrix2fv",hn,4,ro),[35675]:lt.bind(null,"uniformMatrix3fv",hn,9,ro),[35676]:lt.bind(null,"uniformMatrix4fv",hn,16,ro),[35678]:nr,[35680]:nr,[5125]:lt.bind(null,"uniform1uiv",Df,1,Pr),[36294]:lt.bind(null,"uniform2uiv",Df,2,Pr),[36295]:lt.bind(null,"uniform3uiv",Df,3,Pr),[36296]:lt.bind(null,"uniform4uiv",Df,4,Pr),[35685]:lt.bind(null,"uniformMatrix2x3fv",hn,6,ro),[35686]:lt.bind(null,"uniformMatrix2x4fv",hn,8,ro),[35687]:lt.bind(null,"uniformMatrix3x2fv",hn,6,ro),[35688]:lt.bind(null,"uniformMatrix3x4fv",hn,12,ro),[35689]:lt.bind(null,"uniformMatrix4x2fv",hn,8,ro),[35690]:lt.bind(null,"uniformMatrix4x3fv",hn,12,ro),[35678]:nr,[35680]:nr,[35679]:nr,[35682]:nr,[36289]:nr,[36292]:nr,[36293]:nr,[36298]:nr,[36299]:nr,[36300]:nr,[36303]:nr,[36306]:nr,[36307]:nr,[36308]:nr,[36311]:nr},NB={},DB={},GB={},r1=[0];function IP(s,e,t,n){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(r1[0]=s,s=r1);let i=s.length;if(i%e&&Z.warn(`Uniform size should be multiples of ${e}`,s)(),s instanceof t)return s;let o=n[i];o||(o=new t(i),n[i]=o);for(let a=0;a<i;a++)o[a]=s[a];return o}function hn(s,e){return IP(s,e,Float32Array,NB)}function Qo(s,e){return IP(s,e,Int32Array,DB)}function Df(s,e){return IP(s,e,Uint32Array,GB)}function wP(s,e,t){let n=MB[t.type];if(!n)throw new Error(`Unknown GLSL uniform type ${t.type}`);return n().bind(null,s,e)}function n1(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${s}`);return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function i1(s,e,t){for(let n in s){let i=s[n];if((!t||Boolean(t[n]))&&!_B(i))throw e=e?`${e} `:"",console.error(`${e} Bad uniform ${n}`,i),new Error(`${e} Bad uniform ${n}`)}return!0}function _B(s){return Array.isArray(s)||ArrayBuffer.isView(s)?FB(s):isFinite(s)||s===!0||s===!1||s instanceof Gr||s instanceof Ei?!0:s instanceof Pt?Boolean(s.texture):!1}function o1(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let n=s[e];for(let i=0,o=t.length;i<o;++i)n[i]=t[i]}else s[e]=t.slice();else s[e]=t}function FB(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function nr(){let s=null;return(e,t,n)=>{let i=s!==n;return i&&(e.uniform1i(t,n),s=n),i}}function lt(s,e,t,n){let i=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(i===null)i=new Float32Array(h),o=h,d=!0;else{H(o===h,"Uniform length cannot change.");for(let f=0;f<h;++f)if(c[f]!==i[f]){d=!0;break}}return d&&(n(a,s,l,c),i.set(c)),d}}function Pr(s,e,t,n){s[e](t,n)}function ro(s,e,t,n){s[e](t,!1,n)}var VB=5120,kB=5121,UB=5122,zB=5123,s1=0,Gf=1,WB=2,HB=3,_f=4,jB=5,qB=6,Ft=5126,XB=35664,YB=35665,$B=35666,wc=5124,QB=35667,ZB=35668,KB=35669,Lc=5125,JB=36294,eM=36295,tM=36296,rM=35670,nM=35671,iM=35672,oM=35673,sM=35674,aM=35675,lM=35676,uM=35685,cM=35686,hM=35687,dM=35688,fM=35689,gM=35690,LP={[Ft]:[Ft,1,"float"],[XB]:[Ft,2,"vec2"],[YB]:[Ft,3,"vec3"],[$B]:[Ft,4,"vec4"],[wc]:[wc,1,"int"],[QB]:[wc,2,"ivec2"],[ZB]:[wc,3,"ivec3"],[KB]:[wc,4,"ivec4"],[Lc]:[Lc,1,"uint"],[JB]:[Lc,2,"uvec2"],[eM]:[Lc,3,"uvec3"],[tM]:[Lc,4,"uvec4"],[rM]:[Ft,1,"bool"],[nM]:[Ft,2,"bvec2"],[iM]:[Ft,3,"bvec3"],[oM]:[Ft,4,"bvec4"],[sM]:[Ft,8,"mat2"],[uM]:[Ft,8,"mat2x3"],[cM]:[Ft,8,"mat2x4"],[aM]:[Ft,12,"mat3"],[hM]:[Ft,12,"mat3x2"],[dM]:[Ft,12,"mat3x4"],[lM]:[Ft,16,"mat4"],[fM]:[Ft,16,"mat4x2"],[gM]:[Ft,16,"mat4x3"]};function a1(s){switch(s){case s1:return s1;case Gf:return Gf;case HB:return Gf;case WB:return Gf;case _f:return _f;case jB:return _f;case qB:return _f;default:return H(!1),0}}function OP(s){let e=LP[s];if(!e)return null;let[t,n]=e;return{type:t,components:n}}function Ff(s,e){switch(s){case VB:case kB:case UB:case zB:s=Ft;break;default:}for(let t in LP){let[n,i,o]=LP[t];if(n===s&&i===e)return{glType:t,name:o}}return null}var Vf=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,n=t.getProgramParameter(e.handle,35721);for(let i=0;i<n;i++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,i),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((i,o)=>i.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!se(t))return;let n=t.getProgramParameter(e.handle,35971);for(let i=0;i<n;i++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,i);this._addVarying(i,o,a,l)}this.varyingInfos.sort((i,o)=>i.location-o.location)}_addAttribute(e,t,n,i){let{type:o,components:a}=OP(n),l={type:o,size:i*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new qt(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,n){/instance/i.test(t)&&(n.divisor=1)}_addVarying(e,t,n,i){let{type:o,components:a}=OP(n),l=new qt({type:o,size:i*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var l1=4,pM=35981,mM=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],Zo=class extends jt{constructor(e,t={}){super(e,t);this.stubRemovedMethods("Program","v6.0",mM),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(e={}){let{hash:t,vs:n,fs:i,varyings:o,bufferMode:a=pM}=e;return this.hash=t||"",this.vs=typeof n=="string"?new Tc(this.gl,{id:`${e.id}-vs`,source:n}):n,this.fs=typeof i=="string"?new Ic(this.gl,{id:`${e.id}-fs`,source:i}):i,H(this.vs instanceof Tc),H(this.fs instanceof Ic),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(at(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Vf(this),this.setProps(e)}delete(e={}){return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw({logPriority:e,drawMode:t=4,vertexCount:n,offset:i=0,start:o,end:a,isIndexed:l=!1,indexType:u=5123,instanceCount:c=0,isInstanced:h=c>0,vertexArray:d=null,transformFeedback:f,framebuffer:y,parameters:S={},uniforms:C,samplers:T}){if((C||T)&&(Z.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(C||{})),Z.priority>=e){let I=y?y.id:"default",B=`mode=${En(this.gl,t)} verts=${n} instances=${c} indexType=${En(this.gl,u)} isInstanced=${h} isIndexed=${l} Framebuffer=${I}`;Z.log(e,B)()}return H(d),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||n===0||h&&c===0?!1:(d.bindForDraw(n,c,()=>{if(y!==void 0&&(S=Object.assign({},S,{framebuffer:y})),f){let I=a1(t);f.begin(I)}this._bindTextures(),rr(this.gl,S,()=>{l&&h?this.gl2.drawElementsInstanced(t,n,u,i,c):l&&se(this.gl)&&!isNaN(o)&&!isNaN(a)?this.gl2.drawRangeElements(t,o,a,n,u,i):l?this.gl.drawElements(t,n,u,i):h?this.gl2.drawArraysInstanced(t,i,n,c):this.gl.drawArrays(t,i,n)}),f&&f.end()}),!0)}setUniforms(e={}){Z.priority>=2&&i1(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let n=e[t],i=this._uniformSetters[t];if(i){let o=n,a=!1;if(o instanceof Pt&&(o=o.texture),o instanceof Gr)if(a=this.uniforms[t]!==n,a){i.textureIndex===void 0&&(i.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=i;l.bind(u),o=u,this._textureUniforms[t]=l}else o=i.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(i(o)||a)&&o1(this.uniforms,t,n)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let n=this._textureUniforms[t];n.update(),e=e&&n.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),n={};for(let i of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:n.vs=new Tc({handle:i});break;case 35632:n.fs=new Ic({handle:i});break;default:}return n}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=Dr(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?`${e}-program`:"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),Z.time(l1,`linkProgram for ${this._getName()}`)(),e.linkProgram(this.handle),Z.timeEnd(l1,`linkProgram for ${this._getName()}`)(),e.debug||Z.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error(`Error linking: ${e.getProgramInfoLog(this.handle)}`);if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error(`Error validating: ${e.getProgramInfoLog(this.handle)}`)}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let n=this.gl.getActiveUniform(this.handle,t),{name:i}=n1(n.name),o=e.getUniformLocation(this.handle,i);if(this._uniformSetters[i]=wP(e,o,n),n.size>1)for(let a=0;a<n.size;a++)o=e.getUniformLocation(this.handle,`${i}[${a}]`),this._uniformSetters[`${i}[${a}]`]=wP(e,o,n)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var Ko=class extends jt{static isSupported(e){return se(e)}constructor(e,t={}){at(e);super(e,t);this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(e={}){return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Si(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(e={}){return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let n=this._getVaryingIndex(e),{buffer:i,byteSize:o,byteOffset:a}=this._getBufferParams(t);return n<0?(this.unused[e]=i,Z.warn(()=>`${this.id} unused varying buffer ${e}`)(),this):(this.buffers[n]=t,this.bindOnUse||this._bindBuffer(n,i,a,o),this)}begin(e=0){return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,n,i;return e instanceof ge?i=e:(i=e.buffer,n=e.byteSize,t=e.byteOffset),(t!==void 0||n!==void 0)&&(t=t||0,n=n||i.byteLength-t),{buffer:i,byteOffset:t,byteSize:n}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:n,byteOffset:i}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,i,n)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t,n=0,i){let o=t&&t.handle;return!o||i===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,n,i),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var kf=null;function bM(s){return(!kf||kf.byteLength<s)&&(kf=new ArrayBuffer(s)),kf}function u1(s,e){let t=bM(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function c1({target:s,source:e,start:t=0,count:n=1}){let i=e.length,o=n*i,a=0;for(let l=t;a<i;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var PM="elements must be GL.ELEMENT_ARRAY_BUFFER",yr=class extends jt{static isSupported(e,t={}){return t.constantAttributeZero?se(e)||(0,bf.getBrowser)()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new yr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return yr.MAX_ATTRIBUTES=yr.MAX_ATTRIBUTES||e.getParameter(34921),yr.MAX_ATTRIBUTES}static setConstant(e,t,n){switch(n.constructor){case Float32Array:yr._setConstantFloatArray(e,t,n);break;case Int32Array:yr._setConstantIntArray(e,t,n);break;case Uint32Array:yr._setConstantUintArray(e,t,n);break;default:H(!1)}}constructor(e,t={}){let n=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:n}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return yr.getMaxAttributes(this.gl)}initialize(e={}){return this.setProps(e)}setProps(e){return this}setElementBuffer(e=null,t={}){return H(!e||e.target===34963,PM),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,n){if(t.target===34963)return this.setElementBuffer(t,n);let{size:i,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=n,{gl:d,gl2:f}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(H(se(d)),f.vertexAttribIPointer(e,i,o,a,l)):d.vertexAttribPointer(e,i,o,u,a,l),d.enableVertexAttribArray(e),f.vertexAttribDivisor(e,h||0)}),this}enable(e,t=!0){return!t&&e===0&&!yr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let n=this._normalizeConstantArrayValue(t),i=n.byteLength*e,o=n.length*e,a=!this.buffer;if(this.buffer=this.buffer||new ge(this.gl,i),a=a||this.buffer.reallocate(i),a=a||!this._compareConstantArrayValues(n,this.bufferValue),a){let l=u1(t.constructor,o);c1({target:l,source:n,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}static _setConstantFloatArray(e,t,n){switch(n.length){case 1:e.vertexAttrib1fv(t,n);break;case 2:e.vertexAttrib2fv(t,n);break;case 3:e.vertexAttrib3fv(t,n);break;case 4:e.vertexAttrib4fv(t,n);break;default:H(!1)}}static _setConstantIntArray(e,t,n){switch(H(se(e)),n.length){case 1:e.vertexAttribI1iv(t,n);break;case 2:e.vertexAttribI2iv(t,n);break;case 3:e.vertexAttribI3iv(t,n);break;case 4:e.vertexAttribI4iv(t,n);break;default:H(!1)}}static _setConstantUintArray(e,t,n){switch(H(se(e)),n.length){case 1:e.vertexAttribI1uiv(t,n);break;case 2:e.vertexAttribI2uiv(t,n);break;case 3:e.vertexAttribI3uiv(t,n);break;case 4:e.vertexAttribI4uiv(t,n);break;default:H(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,{location:t}){return H(Number.isFinite(t)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(t,e);default:return this.gl.getVertexAttrib(t,e)}})}};var yM="VertexArray: attributes must be Buffers or constants (i.e. typed array)",SM=/^(.+)__LOCATION_([0-9]+)$/,EM=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],Oc=class{constructor(e,t={}){let n=t.id||t.program&&t.program.id;this.id=n,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new yr(e),If(this,"VertexArray","v6.0",EM),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(e={}){return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let n=e[t];this._setAttribute(t,n)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(e=null,t={}){return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t,n={}){if(t.target===34963)return this.setElementBuffer(t,n);let{location:i,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,n);return i>=0&&(this.values[i]=t,this.accessors[i]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(i,t,o)),this}setConstant(e,t,n={}){let{location:i,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},n));return i>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[i]=t,this.accessors[i]=o,this.clearDrawParams(),this.vertexArrayObject.enable(i,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new ge(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof ge&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof ge&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,n){let i;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),i=n()}),i}_resolveLocationAndAccessor(e,t,n,i){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,Z.once(3,()=>`unused value ${e} in ${this.id}`)(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=qt.resolve(u.accessor,c,n,i),{size:d,type:f}=h;return H(Number.isFinite(d)&&Number.isFinite(f)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let n=SM.exec(e),i=n?n[1]:e,o=n?Number(n[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(i)+o,name:i}:{location:-1}}_setAttribute(e,t){if(t instanceof ge)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof ge){let n=t[0],i=t[1];this.setBuffer(e,n,i)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let n=t;this.setConstant(e,n)}else if(t.buffer instanceof ge){let n=t;this.setBuffer(e,n.buffer,n)}else throw new Error(yM)}_setConstantAttributes(e,t){let n=Math.max(e|0,t|0),i=this.values[0];ArrayBuffer.isView(i)&&this._setConstantAttributeZero(i,n);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)i=this.values[o],ArrayBuffer.isView(i)&&this._setConstantAttribute(o,i)}_setConstantAttributeZero(e,t){if(yr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let n=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,n,this.accessors[0])}_setConstantAttribute(e,t){yr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let n=this.values[t],i=this.accessors[t];if(!n)return;let{divisor:o}=i,a=o>0;if(e.isInstanced=e.isInstanced||a,n instanceof ge){let l=n;if(a){let u=l.getVertexCount(i);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(i);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(e=null,t={}){return Z.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function xM(s,e){let{maxElts:t=16,size:n=1}=e,i="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(i+=`,${a%n===0?" ":""}`),i+=ca(s[a],e);let o=s.length>t?"...":"]";return`${i}${o}`}function ca(s,e={}){let{isInteger:n=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return xM(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<1e-16)return n?"0":"0.";if(n||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let i=s.toPrecision(2);return i.indexOf(".0")===i.length-2?i.slice(0,-1):i}function Uf({header:s="Uniforms",program:e,uniforms:t,undefinedOnly:n=!1}){H(e);let i=".*_.*",o=".*Matrix",a=e._uniformSetters,l={},u=Object.keys(a).sort(),c=0;for(let f of u)!f.match(i)&&!f.match(o)&&RP({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:n})&&c++;for(let f of u)f.match(o)&&RP({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:n})&&c++;for(let f of u)l[f]||RP({table:l,header:s,uniforms:t,uniformName:f,undefinedOnly:n})&&c++;let h=0,d={};if(!n)for(let f in t){let y=t[f];l[f]||(h++,d[f]={Type:`NOT USED: ${y}`,[s]:ca(y)})}return{table:l,count:c,unusedTable:d,unusedCount:h}}function RP({table:s,header:e,uniforms:t,uniformName:n,undefinedOnly:i}){let o=t[n],a=CM(o);return!i||!a?(s[n]={[e]:a?ca(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0):!1}function CM(s){return s!=null}function BP({vertexArray:s,header:e="Attributes"}){if(!s.configuration)return{};let t={};s.elements&&(t.ELEMENT_ARRAY_BUFFER=h1(s,s.elements,null,e));let n=s.values;for(let i in n){let o=s._getAttributeInfo(i);if(o){let a=`${i}: ${o.name}`,l=s.accessors[o.location];l&&(a=`${i}: ${AM(o.name,l)}`),t[a]=h1(s,n[i],l,e)}}return t}function h1(s,e,t,n){let{gl:i}=s;if(!e)return{[n]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof ge){let f=e,{data:y,changed:S}=f.getDebugData();h=S?"*":"",d=y,u=f.byteLength,l=u/y.BYTES_PER_ELEMENT/a;let C;return t?C=`${t.divisor>0?"I ":"P "} ${l} (x${a}=${u} bytes ${En(i,o)})`:(c=!0,C=`${u} bytes`),{[n]:`${h}${ca(d,{size:a,isInteger:c})}`,"Format ":C}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[n]:`${ca(d,{size:a,isInteger:c})} (constant)`,"Format ":`${a}x${o} (constant)`}}function AM(s,e){let{type:t,size:n}=e,i=Ff(t,n);return i?`${s} (${i.name})`:s}function MP(s){let e={},t=`Accessors for ${s.id}`;for(let n of s.attributeInfos)if(n){let i=d1(n);e[`in ${i}`]={[t]:JSON.stringify(n.accessor)}}for(let n of s.varyingInfos)if(n){let i=d1(n);e[`out ${i}`]={[t]:JSON.stringify(n.accessor)}}return e}function d1(s){let{type:e,size:t}=s.accessor,n=Ff(e,t);return n?`${n.name} ${s.name}`:s.name}var ha="vs",Rc="fs";function At(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var NP={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function g1(s){let e={};for(let t in s){let n=s[t],i=TM(n);e[t]=i}return e}function TM(s){let e=f1(s);return e==="object"?s?"type"in s?Object.assign({},s,NP[s.type]):"value"in s?(e=f1(s.value),Object.assign({type:e},s,NP[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},NP[e])}function f1(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var IM="vs",wM="fs",Bc=class{constructor({name:e,vs:t,fs:n,dependencies:i=[],uniforms:o,getUniforms:a,deprecations:l=[],defines:u={},inject:c={},vertexShader:h,fragmentShader:d}){At(typeof e=="string"),this.name=e,this.vs=t||h,this.fs=n||d,this.getModuleUniforms=a,this.dependencies=i,this.deprecations=this._parseDeprecationDefinitions(l),this.defines=u,this.injections=LM(c),o&&(this.uniforms=g1(o))}getModuleSource(e){let t;switch(e){case IM:t=this.vs||"";break;case wM:t=this.fs||"";break;default:At(!1)}return`#define MODULE_${this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_")}
${t}// END MODULE_${this.name}

`}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(n=>{n.regex.test(e)&&(n.deprecated?t.deprecated(n.old,n.new)():t.removed(n.old,n.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),e}_defaultGetUniforms(e={}){let t={},n=this.uniforms;for(let i in n){let o=n[i];i in e&&!o.private?(o.validate&&At(o.validate(e[i],o),`${this.name}: invalid ${i}`),t[i]=e[i]):t[i]=o.value}return t}};function LM(s){let e={vs:{},fs:{}};for(let t in s){let n=s[t],i=t.slice(0,2);typeof n=="string"&&(n={order:0,injection:n}),e[i][t]=n}return e}function p1(s){return OM(b1(s))}function OM(s){let e={},t={};return m1({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((n,i)=>t[i]-t[n]).map(n=>e[n])}function m1({modules:s,level:e,moduleMap:t,moduleDepth:n}){if(e>=5)throw new Error("Possible loop in shader dependency graph");for(let i of s)t[i.name]=i,(n[i.name]===void 0||n[i.name]<e)&&(n[i.name]=e);for(let i of s)i.dependencies&&m1({modules:i.dependencies,level:e+1,moduleMap:t,moduleDepth:n})}function b1(s,e){return s.map(t=>(t instanceof Bc||(At(typeof t!="string",`Shader module use by name is deprecated. Import shader module '${t}' and use it directly.`),At(t.name,"shader module has no name"),t=new Bc(t),t.dependencies=b1(t.dependencies)),t))}function DP(s={}){let e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",n=t.indexOf("MSIE ")!==-1,i=t.indexOf("Trident/")!==-1;return n||i}var RM=7936,BM=7937,MM=7938,NM=35724,_P={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Jo={};Object.keys(_P).forEach(s=>{Jo[s]=s});function DM(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function P1(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||RM),n=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||BM);return{gpuVendor:GM(t,n),vendor:t,renderer:n,version:s.getParameter(MM),shadingLanguageVersion:s.getParameter(NM)}}function GM(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var GP={};function FP(s,e,t={}){let n=_P[e];if(At(n,e),!DP(t))return!0;if(e in GP)return GP[e];let i=n[0],o=t.behavior||"enable",a=`#extension GL_${i} : ${o}
void main(void) {}`,l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),GP[e]=u,u}function _M(s,e){let t=_P[e];At(t,e);let n=DM(s)&&t[1]||t[0],i=typeof n=="string"?Boolean(s.getExtension(n)):n;return At(i===!1||i===!0),i}function Mc(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>_M(s,t))}function y1(s){switch(P1(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function S1(s,e,t){let n=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Mc(s,Jo.GLSL_FRAG_DEPTH)&&(n+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Mc(s,Jo.GLSL_DERIVATIVES)&&FP(s,Jo.GLSL_DERIVATIVES)&&(n+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Mc(s,Jo.GLSL_FRAG_DATA)&&FP(s,Jo.GLSL_FRAG_DATA,{behavior:"require"})&&(n+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Mc(s,Jo.GLSL_TEXTURE_LOD)&&(n+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),n}var E1=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,x1=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var FM={[ha]:E1,[Rc]:x1},Nc="__LUMA_INJECT_DECLARATIONS__",C1=/void\s+main\s*\([^)]*\)\s*\{\n?/,A1=/}\n?[^{}]*$/,VP=[];function zf(s,e,t,n=!1){let i=e===ha;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),VP.length=a.length;for(let u=0,c=a.length;u<c;++u)VP[u]=a[u].injection;let l=`${VP.join(`
`)}
`;switch(o){case"vs:#decl":i&&(s=s.replace(Nc,l));break;case"vs:#main-start":i&&(s=s.replace(C1,u=>u+l));break;case"vs:#main-end":i&&(s=s.replace(A1,u=>l+u));break;case"fs:#decl":i||(s=s.replace(Nc,l));break;case"fs:#main-start":i||(s=s.replace(C1,u=>u+l));break;case"fs:#main-end":i||(s=s.replace(A1,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(Nc,""),n&&(s=s.replace(/\}\s*$/,o=>o+FM[e])),s}function Rl(s){let e={};return At(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let n in t)e[n]=e[n]?`${e[n]}
${t[n]}`:t[n]}),e}function Bl(s){return new RegExp(`\\b${s}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}var v1=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],VM=[...v1,[Bl("attribute"),"in $1"],[Bl("varying"),"out $1"]],kM=[...v1,[Bl("varying"),"in $1"]],T1=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],UM=[...T1,[Bl("in"),"attribute $1"],[Bl("out"),"varying $1"]],zM=[...T1,[Bl("in"),"varying $1"]],kP="gl_FragColor",UP=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,WM=/void\s+main\s*\([^)]*\)\s*\{\n?/;function zP(s,e,t){switch(e){case 300:return t?Wf(s,VM):HM(s);case 100:return t?Wf(s,UM):jM(s);default:throw new Error(`unknown GLSL version ${e}`)}}function Wf(s,e){for(let[t,n]of e)s=s.replace(t,n);return s}function HM(s){s=Wf(s,kM);let e=s.match(UP);if(e){let t=e[1];s=s.replace(new RegExp(`\\b${kP}\\b`,"g"),t)}else{let t="fragmentColor";s=s.replace(WM,n=>`out vec4 ${t};
${n}`).replace(new RegExp(`\\b${kP}\\b`,"g"),t)}return s}function jM(s){s=Wf(s,zM);let e=s.match(UP);if(e){let t=e[1];s=s.replace(UP,"").replace(new RegExp(`\\b${t}\\b`,"g"),kP)}return s}var qM=`

${Nc}

`,w1={[ha]:"vertex",[Rc]:"fragment"},XM=`precision highp float;

`;function WP(s,e){let{vs:t,fs:n}=e,i=p1(e.modules||[]);return{gl:s,vs:I1(s,Object.assign({},e,{source:t,type:ha,modules:i})),fs:I1(s,Object.assign({},e,{source:n,type:Rc,modules:i})),getUniforms:YM(i)}}function I1(s,{id:e,source:t,type:n,modules:i,defines:o={},hookFunctions:a=[],inject:l={},transpileToGLSL100:u=!1,prologue:c=!0,log:h}){At(typeof t=="string","shader source must be a string");let d=n===ha,f=t.split(`
`),y=100,S="",C=t;f[0].indexOf("#version ")===0?(y=300,S=f[0],C=f.slice(1).join(`
`)):S=`#version ${y}`;let T={};i.forEach(U=>{Object.assign(T,U.getDefines())}),Object.assign(T,o);let I=c?`${S}
${QM({id:e,source:t,type:n})}
${$M({type:n})}
${y1(s)}
${S1(s,y,!d)}
${ZM(T)}
${d?"":XM}
`:`${S}
`,B=JM(a),w={},M={},F={};for(let U in l){let te=typeof l[U]=="string"?{injection:l[U],order:0}:l[U],re=U.match(/^(v|f)s:(#)?([\w-]+)$/);if(re){let J=re[2],Pe=re[3];J?Pe==="decl"?M[U]=[te]:F[U]=[te]:w[U]=[te]}else F[U]=[te]}for(let U of i){h&&U.checkDeprecations(C,h),I+=U.getModuleSource(n,y);let re=U.injections[n];for(let J in re){let Pe=J.match(/^(v|f)s:#([\w-]+)$/);if(Pe){let he=Pe[2]==="decl"?M:F;he[J]=he[J]||[],he[J].push(re[J])}else w[J]=w[J]||[],w[J].push(re[J])}}return I+=qM,I=zf(I,n,M),I+=KM(B[n],w),I+=C,I=zf(I,n,F),I=zP(I,u?100:y,d),I}function YM(s){return function(t){let n={};for(let i of s){let o=i.getUniforms(t,n);Object.assign(n,o)}return n}}function $M({type:s}){return`
#define SHADER_TYPE_${w1[s].toUpperCase()}
`}function QM({id:s,source:e,type:t}){return s&&typeof s=="string"&&e.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${s}_${w1[t]}

`:""}function ZM(s={}){let e=0,t="";for(let n in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let i=s[n];(i||Number.isFinite(i))&&(t+=`#define ${n.toUpperCase()} ${s[n]}
`)}return e===0&&(t+=`
`),t}function KM(s,e){let t="";for(let n in s){let i=s[n];if(t+=`void ${i.signature} {
`,i.header&&(t+=`  ${i.header}`),e[n]){let o=e[n];o.sort((a,l)=>a.order-l.order);for(let a of o)t+=`  ${a.injection}
`}i.footer&&(t+=`  ${i.footer}`),t+=`}
`}return t}function JM(s){let e={vs:{},fs:{}};return s.forEach(t=>{let n;typeof t!="string"?(n=t,t=n.hook):n={},t=t.trim();let[i,o]=t.split(":"),a=t.replace(/\(.+/,"");e[i][a]=Object.assign(n,{signature:o})}),e}var eN="void main() {gl_FragColor = vec4(0);}",L1=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,tN=`#version 300 es
${L1}`;function Hf(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[n,i,o]=t;if(!e.includes(n)||!i||!o)return null;let a=o.split(";")[0];return{qualifier:n,type:i,name:a}}function Dc(s={}){let{version:e=100,input:t,inputType:n,output:i}=s;if(!t)return e===300?tN:e>300?`#version ${e}
${L1}`:eN;let o=O1(t,n);return e>=300?`#version ${e} ${e===300?"es":""}
in ${n} ${t};
out vec4 ${i};
void main() {
  ${i} = ${o};
}`:`varying ${n} ${t};
void main() {
  gl_FragColor = ${o};
}`}function HP(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return At(!1),null}}function jP(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return At(!1),null}}function O1(s,e){switch(e){case"float":return`vec4(${s}, 0.0, 0.0, 1.0)`;case"vec2":return`vec4(${s}, 0.0, 1.0)`;case"vec3":return`vec4(${s}, 1.0)`;case"vec4":return s;default:return At(!1),null}}var rN=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,jf={name:"fp32",vs:rN,fs:null};function Vn(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var uge=1/Math.PI*180,cge=1/180*Math.PI,rt={};rt.EPSILON=1e-12;rt.debug=!1;rt.precision=4;rt.printTypes=!1;rt.printDegrees=!1;rt.printRowMajor=!0;function nN(s){return Math.round(s/rt.EPSILON)*rt.EPSILON}function qP(s,{precision:e=rt.precision||4}={}){return s=nN(s),"".concat(parseFloat(s.toPrecision(e)))}function no(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function iN(s){return s.clone?s.clone():new Array(s.length)}function oN(s,e,t){if(no(s)){t=t||iN(s);for(let n=0;n<t.length&&n<s.length;++n)t[n]=e(s[n],n,t);return t}return e(s)}function XP(s,e,t){return oN(s,n=>Math.max(e,Math.min(t,n)))}function qf(s,e,t){return no(s)?s.map((n,i)=>qf(n,e[i],t)):t*e+(1-t)*s}function da(s,e,t){let n=rt.EPSILON;t&&(rt.EPSILON=t);try{if(s===e)return!0;if(no(s)&&no(e)){if(s.length!==e.length)return!1;for(let i=0;i<s.length;++i)if(!da(s[i],e[i]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):Number.isFinite(s)&&Number.isFinite(e)?Math.abs(s-e)<=rt.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{rt.EPSILON=n}}function sN(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var Ml=class extends sN(Array){get ELEMENTS(){return Vn(!1),0}clone(){return new this.constructor().copy(this)}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}fromArray(e,t=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}to(e){return e===this?this:no(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toArray(e=[],t=0){for(let n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(rt)}formatString(e){let t="";for(let n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+qP(this[n],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!da(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,n){n===void 0&&(n=t,t=e,e=this);for(let i=0;i<this.ELEMENTS;++i){let o=e[i];this[i]=o+n*(t[i]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}add(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]+=t[n];return this.check()}subtract(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]-=t[n];return this.check()}scale(e){if(Array.isArray(e))return this.multiply(e);for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.scale(1/e)}clampScalar(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}multiplyByScalar(e){return this.scale(e)}get elements(){return this}check(){if(rt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}};function aN(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Sr(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function Xf(s,e,t=""){if(rt.debug&&!aN(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var R1={};function Yf(s,e){R1[s]||(R1[s]=!0,console.warn("".concat(s," has been removed in version ").concat(e,", see upgrade guide for more information")))}var $f=class extends Ml{get ELEMENTS(){return Vn(!1),0}copy(e){return Vn(!1),this}get x(){return this[0]}set x(e){this[0]=Sr(e)}get y(){return this[1]}set y(e){this[1]=Sr(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let n=0;n<this.ELEMENTS;++n){let i=this[n]-e[n];t+=i*i}return Sr(t)}dot(e){let t=0;for(let n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return Sr(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]*=t[n];return this.check()}divide(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]/=t[n];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Vn(e>=0&&e<this.ELEMENTS,"index is out of range"),Sr(this[e])}setComponent(e,t){return Vn(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var es=1e-6,xi=typeof Float32Array<"u"?Float32Array:Array;var Ege=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function lN(){var s=new xi(2);return xi!=Float32Array&&(s[0]=0,s[1]=0),s}function Zf(s,e,t,n){var i=e[0],o=e[1];return s[0]=i+n*(t[0]-i),s[1]=o+n*(t[1]-o),s}function M1(s,e,t){var n=e[0],i=e[1];return s[0]=t[0]*n+t[4]*i+t[12],s[1]=t[1]*n+t[5]*i+t[13],s}var xge=function(){var s=lN();return function(e,t,n,i,o,a){var l,u;for(t||(t=2),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function N1(s,e,t){let n=e[0],i=e[1],o=t[3]*n+t[7]*i||1;return s[0]=(t[0]*n+t[4]*i)/o,s[1]=(t[1]*n+t[5]*i)/o,s}function Kf(s,e,t){let n=e[0],i=e[1],o=e[2],a=t[3]*n+t[7]*i+t[11]*o||1;return s[0]=(t[0]*n+t[4]*i+t[8]*o)/a,s[1]=(t[1]*n+t[5]*i+t[9]*o)/a,s[2]=(t[2]*n+t[6]*i+t[10]*o)/a,s}function D1(s,e,t){let n=e[0],i=e[1];return s[0]=t[0]*n+t[2]*i,s[1]=t[1]*n+t[3]*i,s[2]=e[2],s}function uN(){var s=new xi(3);return xi!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function G1(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function cN(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function _1(s,e,t){var n=e[0],i=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=i*u-o*l,s[1]=o*a-n*u,s[2]=n*l-i*a,s}function Jf(s,e,t){var n=e[0],i=e[1],o=e[2],a=t[3]*n+t[7]*i+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*n+t[4]*i+t[8]*o+t[12])/a,s[1]=(t[1]*n+t[5]*i+t[9]*o+t[13])/a,s[2]=(t[2]*n+t[6]*i+t[10]*o+t[14])/a,s}function F1(s,e,t){var n=e[0],i=e[1],o=e[2];return s[0]=n*t[0]+i*t[3]+o*t[6],s[1]=n*t[1]+i*t[4]+o*t[7],s[2]=n*t[2]+i*t[5]+o*t[8],s}function V1(s,e,t){var n=t[0],i=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=i*c-o*u,d=o*l-n*c,f=n*u-i*l,y=i*f-o*d,S=o*h-n*f,C=n*d-i*h,T=a*2;return h*=T,d*=T,f*=T,y*=2,S*=2,C*=2,s[0]=l+h+y,s[1]=u+d+S,s[2]=c+f+C,s}function k1(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[0],o[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),o[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function U1(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),o[1]=i[1],o[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function z1(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),o[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),o[2]=i[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function W1(s,e){var t=s[0],n=s[1],i=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+n*n+i*i),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&cN(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var Age=function(){var s=uN();return function(e,t,n,i,o,a){var l,u;for(t||(t=3),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var QP=[0,0,0],H1={},Wr=class extends $f{static get ZERO(){return H1.ZERO=H1.ZERO||Object.freeze(new Wr(0,0,0,0))}constructor(e=0,t=0,n=0){super(-0,-0,-0);arguments.length===1&&no(e)?this.copy(e):(rt.debug&&(Sr(e),Sr(t),Sr(n)),this[0]=e,this[1]=t,this[2]=n)}set(e,t,n){return this[0]=e,this[1]=t,this[2]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return rt.debug&&(Sr(e.x),Sr(e.y),Sr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Sr(e)}angle(e){return W1(this,e)}cross(e){return _1(this,this,e),this.check()}rotateX({radians:e,origin:t=QP}){return k1(this,this,t,e),this.check()}rotateY({radians:e,origin:t=QP}){return U1(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=QP}){return z1(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Jf(this,this,e),this.check()}transformAsVector(e){return Kf(this,this,e),this.check()}transformByMatrix3(e){return F1(this,this,e),this.check()}transformByMatrix2(e){return D1(this,this,e),this.check()}transformByQuaternion(e){return V1(this,this,e),this.check()}};var eg=class extends Ml{get ELEMENTS(){return Vn(!1),0}get RANK(){return Vn(!1),0}toString(){let e="[";if(rt.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let n=0;n<this.RANK;++n)e+=" ".concat(this[n*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,n){return this[t*this.RANK+e]=Sr(n),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let n=e*this.RANK;for(let i=0;i<this.RANK;++i)t[i]=this[n+i];return t}setColumn(e,t){let n=e*this.RANK;for(let i=0;i<this.RANK;++i)this[n+i]=t[i];return this}};function hN(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function j1(s,e){if(s===e){var t=e[1],n=e[2],i=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=n,s[9]=o,s[11]=e[14],s[12]=i,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function q1(s,e){var t=e[0],n=e[1],i=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],y=e[11],S=e[12],C=e[13],T=e[14],I=e[15],B=t*l-n*a,w=t*u-i*a,M=t*c-o*a,F=n*u-i*l,U=n*c-o*l,te=i*c-o*u,re=h*C-d*S,J=h*T-f*S,Pe=h*I-y*S,Ce=d*T-f*C,he=d*I-y*C,pe=f*I-y*T,ie=B*pe-w*he+M*Ce+F*Pe-U*J+te*re;return ie?(ie=1/ie,s[0]=(l*pe-u*he+c*Ce)*ie,s[1]=(i*he-n*pe-o*Ce)*ie,s[2]=(C*te-T*U+I*F)*ie,s[3]=(f*U-d*te-y*F)*ie,s[4]=(u*Pe-a*pe-c*J)*ie,s[5]=(t*pe-i*Pe+o*J)*ie,s[6]=(T*M-S*te-I*w)*ie,s[7]=(h*te-f*M+y*w)*ie,s[8]=(a*he-l*Pe+c*re)*ie,s[9]=(n*Pe-t*he-o*re)*ie,s[10]=(S*U-C*M+I*B)*ie,s[11]=(d*M-h*U-y*B)*ie,s[12]=(l*J-a*Ce-u*re)*ie,s[13]=(t*Ce-n*J+i*re)*ie,s[14]=(C*w-S*F-T*B)*ie,s[15]=(h*F-d*w+f*B)*ie,s):null}function X1(s){var e=s[0],t=s[1],n=s[2],i=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],f=s[11],y=s[12],S=s[13],C=s[14],T=s[15],I=e*a-t*o,B=e*l-n*o,w=e*u-i*o,M=t*l-n*a,F=t*u-i*a,U=n*u-i*l,te=c*S-h*y,re=c*C-d*y,J=c*T-f*y,Pe=h*C-d*S,Ce=h*T-f*S,he=d*T-f*C;return I*he-B*Ce+w*Pe+M*J-F*re+U*te}function ZP(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],y=e[10],S=e[11],C=e[12],T=e[13],I=e[14],B=e[15],w=t[0],M=t[1],F=t[2],U=t[3];return s[0]=w*n+M*l+F*d+U*C,s[1]=w*i+M*u+F*f+U*T,s[2]=w*o+M*c+F*y+U*I,s[3]=w*a+M*h+F*S+U*B,w=t[4],M=t[5],F=t[6],U=t[7],s[4]=w*n+M*l+F*d+U*C,s[5]=w*i+M*u+F*f+U*T,s[6]=w*o+M*c+F*y+U*I,s[7]=w*a+M*h+F*S+U*B,w=t[8],M=t[9],F=t[10],U=t[11],s[8]=w*n+M*l+F*d+U*C,s[9]=w*i+M*u+F*f+U*T,s[10]=w*o+M*c+F*y+U*I,s[11]=w*a+M*h+F*S+U*B,w=t[12],M=t[13],F=t[14],U=t[15],s[12]=w*n+M*l+F*d+U*C,s[13]=w*i+M*u+F*f+U*T,s[14]=w*o+M*c+F*y+U*I,s[15]=w*a+M*h+F*S+U*B,s}function Gc(s,e,t){var n=t[0],i=t[1],o=t[2],a,l,u,c,h,d,f,y,S,C,T,I;return e===s?(s[12]=e[0]*n+e[4]*i+e[8]*o+e[12],s[13]=e[1]*n+e[5]*i+e[9]*o+e[13],s[14]=e[2]*n+e[6]*i+e[10]*o+e[14],s[15]=e[3]*n+e[7]*i+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],y=e[7],S=e[8],C=e[9],T=e[10],I=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=y,s[8]=S,s[9]=C,s[10]=T,s[11]=I,s[12]=a*n+h*i+S*o+e[12],s[13]=l*n+d*i+C*o+e[13],s[14]=u*n+f*i+T*o+e[14],s[15]=c*n+y*i+I*o+e[15]),s}function _c(s,e,t){var n=t[0],i=t[1],o=t[2];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=e[3]*n,s[4]=e[4]*i,s[5]=e[5]*i,s[6]=e[6]*i,s[7]=e[7]*i,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function Y1(s,e,t,n){var i=n[0],o=n[1],a=n[2],l=Math.hypot(i,o,a),u,c,h,d,f,y,S,C,T,I,B,w,M,F,U,te,re,J,Pe,Ce,he,pe,ie,Fr;return l<es?null:(l=1/l,i*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],f=e[1],y=e[2],S=e[3],C=e[4],T=e[5],I=e[6],B=e[7],w=e[8],M=e[9],F=e[10],U=e[11],te=i*i*h+c,re=o*i*h+a*u,J=a*i*h-o*u,Pe=i*o*h-a*u,Ce=o*o*h+c,he=a*o*h+i*u,pe=i*a*h+o*u,ie=o*a*h-i*u,Fr=a*a*h+c,s[0]=d*te+C*re+w*J,s[1]=f*te+T*re+M*J,s[2]=y*te+I*re+F*J,s[3]=S*te+B*re+U*J,s[4]=d*Pe+C*Ce+w*he,s[5]=f*Pe+T*Ce+M*he,s[6]=y*Pe+I*Ce+F*he,s[7]=S*Pe+B*Ce+U*he,s[8]=d*pe+C*ie+w*Fr,s[9]=f*pe+T*ie+M*Fr,s[10]=y*pe+I*ie+F*Fr,s[11]=S*pe+B*ie+U*Fr,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function tg(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*i+c*n,s[5]=a*i+h*n,s[6]=l*i+d*n,s[7]=u*i+f*n,s[8]=c*i-o*n,s[9]=h*i-a*n,s[10]=d*i-l*n,s[11]=f*i-u*n,s}function $1(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*i-c*n,s[1]=a*i-h*n,s[2]=l*i-d*n,s[3]=u*i-f*n,s[8]=o*n+c*i,s[9]=a*n+h*i,s[10]=l*n+d*i,s[11]=u*n+f*i,s}function rg(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*i+c*n,s[1]=a*i+h*n,s[2]=l*i+d*n,s[3]=u*i+f*n,s[4]=c*i-o*n,s[5]=h*i-a*n,s[6]=d*i-l*n,s[7]=f*i-u*n,s}function Q1(s,e){var t=e[0],n=e[1],i=e[2],o=e[3],a=t+t,l=n+n,u=i+i,c=t*a,h=n*a,d=n*l,f=i*a,y=i*l,S=i*u,C=o*a,T=o*l,I=o*u;return s[0]=1-d-S,s[1]=h+I,s[2]=f-T,s[3]=0,s[4]=h-I,s[5]=1-c-S,s[6]=y+C,s[7]=0,s[8]=f+T,s[9]=y-C,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Z1(s,e,t,n,i,o,a){var l=1/(t-e),u=1/(i-n),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(i+n)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function KP(s,e,t,n,i){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,i!=null&&i!==1/0?(a=1/(n-i),s[10]=(i+n)*a,s[14]=2*i*n*a):(s[10]=-1,s[14]=-2*n),s}function K1(s,e,t,n,i,o,a){var l=1/(e-t),u=1/(n-i),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(i+n)*u,s[14]=(a+o)*c,s[15]=1,s}function J1(s,e,t,n){var i,o,a,l,u,c,h,d,f,y,S=e[0],C=e[1],T=e[2],I=n[0],B=n[1],w=n[2],M=t[0],F=t[1],U=t[2];return Math.abs(S-M)<es&&Math.abs(C-F)<es&&Math.abs(T-U)<es?hN(s):(h=S-M,d=C-F,f=T-U,y=1/Math.hypot(h,d,f),h*=y,d*=y,f*=y,i=B*f-w*d,o=w*h-I*f,a=I*d-B*h,y=Math.hypot(i,o,a),y?(y=1/y,i*=y,o*=y,a*=y):(i=0,o=0,a=0),l=d*a-f*o,u=f*i-h*a,c=h*o-d*i,y=Math.hypot(l,u,c),y?(y=1/y,l*=y,u*=y,c*=y):(l=0,u=0,c=0),s[0]=i,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=f,s[11]=0,s[12]=-(i*S+o*C+a*T),s[13]=-(l*S+u*C+c*T),s[14]=-(h*S+d*C+f*T),s[15]=1,s)}function dN(){var s=new xi(4);return xi!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function tA(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function ng(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3];return s[0]=t[0]*n+t[4]*i+t[8]*o+t[12]*a,s[1]=t[1]*n+t[5]*i+t[9]*o+t[13]*a,s[2]=t[2]*n+t[6]*i+t[10]*o+t[14]*a,s[3]=t[3]*n+t[7]*i+t[11]*o+t[15]*a,s}var Dge=function(){var s=dN();return function(e,t,n,i,o,a){var l,u;for(t||(t=4),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var nA=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),fN=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),gN=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),Nl={},Hr=class extends eg{static get IDENTITY(){return Nl.IDENTITY=Nl.IDENTITY||Object.freeze(new Hr(nA)),Nl.IDENTITY}static get ZERO(){return Nl.ZERO=Nl.ZERO||Object.freeze(new Hr(fN)),Nl.ZERO}get INDICES(){return gN}get ELEMENTS(){return 16}get RANK(){return 4}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,n,i,o,a,l,u,c,h,d,f,y,S,C,T){return this[0]=e,this[1]=t,this[2]=n,this[3]=i,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=f,this[12]=y,this[13]=S,this[14]=C,this[15]=T,this.check()}setRowMajor(e,t,n,i,o,a,l,u,c,h,d,f,y,S,C,T){return this[0]=e,this[1]=o,this[2]=c,this[3]=y,this[4]=t,this[5]=a,this[6]=h,this[7]=S,this[8]=n,this[9]=l,this[10]=d,this[11]=C,this[12]=i,this[13]=u,this[14]=f,this[15]=T,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(nA)}fromQuaternion(e){return Q1(this,e),this.check()}frustum({left:e,right:t,bottom:n,top:i,near:o,far:a}){return a===1/0?Hr._computeInfinitePerspectiveOffCenter(this,e,t,n,i,o):Z1(this,e,t,n,i,o,a),this.check()}static _computeInfinitePerspectiveOffCenter(e,t,n,i,o,a){let l=2*a/(n-t),u=2*a/(o-i),c=(n+t)/(n-t),h=(o+i)/(o-i),d=-1,f=-1,y=-2*a;return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=c,e[9]=h,e[10]=d,e[11]=f,e[12]=0,e[13]=0,e[14]=y,e[15]=0,e}lookAt(e,t,n){return arguments.length===1&&({eye:e,center:t,up:n}=e),t=t||[0,0,0],n=n||[0,1,0],J1(this,e,t,n),this.check()}ortho({left:e,right:t,bottom:n,top:i,near:o=.1,far:a=500}){return K1(this,e,t,n,i,o,a),this.check()}orthographic({fovy:e=45*Math.PI/180,aspect:t=1,focalDistance:n=1,near:i=.1,far:o=500}){if(e>Math.PI*2)throw Error("radians");let a=e/2,l=n*Math.tan(a),u=l*t;return new Hr().ortho({left:-u,right:u,bottom:-l,top:l,near:i,far:o})}perspective({fovy:e=void 0,fov:t=45*Math.PI/180,aspect:n=1,near:i=.1,far:o=500}={}){if(e=e||t,e>Math.PI*2)throw Error("radians");return KP(this,e,n,i,o),this.check()}determinant(){return X1(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e=[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=null){let n=this.getScale(t||[-0,-0,-0]),i=1/n[0],o=1/n[1],a=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*i,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*i,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e=[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=null){let n=this.getScale(t||[-0,-0,-0]),i=1/n[0],o=1/n[1],a=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*i,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*i,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return j1(this,this),this.check()}invert(){return q1(this,this),this.check()}multiplyLeft(e){return ZP(this,e,this),this.check()}multiplyRight(e){return ZP(this,this,e),this.check()}rotateX(e){return tg(this,this,e),this.check()}rotateY(e){return $1(this,this,e),this.check()}rotateZ(e){return rg(this,this,e),this.check()}rotateXYZ([e,t,n]){return this.rotateX(e).rotateY(t).rotateZ(n)}rotateAxis(e,t){return Y1(this,this,e,t),this.check()}scale(e){return Array.isArray(e)?_c(this,this,e):_c(this,this,[e,e,e]),this.check()}translate(e){return Gc(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ng(t||[-0,-0,-0,-0],e,this),Xf(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:n}=e;switch(n){case 2:t=M1(t||[-0,-0],e,this);break;case 3:t=Jf(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Xf(t,e.length),t}transformAsVector(e,t){switch(e.length){case 2:t=N1(t||[-0,-0],e,this);break;case 3:t=Kf(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Xf(t,e.length),t}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,n){return this.identity().translate([e,t,n])}transformPoint(e,t){return Yf("Matrix4.transformPoint","3.0"),this.transformAsPoint(e,t)}transformVector(e,t){return Yf("Matrix4.transformVector","3.0"),this.transformAsPoint(e,t)}transformDirection(e,t){return Yf("Matrix4.transformDirection","3.0"),this.transformAsVector(e,t)}};var JP={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global},pN=JP.global||JP.self||JP.window;pN.mathgl={config:rt};var mN=new Uint8Array([0,255,255,255]),bN={pickingSelectedColor:null,pickingHighlightColor:mN,pickingActive:!1,pickingAttribute:!1};function PN(s=bN){let e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,n=>n/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var yN=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,SN=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,Dl={name:"picking",vs:yN,fs:SN,getUniforms:PN};var EN=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,e0={name:"transform",vs:EN,fs:null};var fa=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new fa(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(n=>n.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(e={}){let{vs:t="",fs:n="",defines:i={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(n),f=c.map(w=>this._getHash(w.name)).sort(),y=a.map(w=>this._getHash(w)),S=Object.keys(i).sort(),C=Object.keys(o).sort(),T=[],I=[];for(let w of S)T.push(this._getHash(w)),T.push(this._getHash(i[w]));for(let w of C)I.push(this._getHash(w)),I.push(this._getHash(o[w]));let B=`${h}/${d}D${T.join("/")}M${f.join("/")}I${I.join("/")}V${y.join("/")}H${this.stateHash}B${l}${u?"T":""}`;if(!this._programCache[B]){let w=WP(this.gl,{vs:t,fs:n,modules:c,inject:o,defines:i,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[B]=new Zo(this.gl,{hash:B,vs:w.vs,fs:w.fs,varyings:a,bufferMode:l}),this._getUniforms[B]=w.getUniforms||(M=>{}),this._useCounts[B]=0}return this._useCounts[B]++,this._programCache[B]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(e=[]){let t=new Array(this._defaultModules.length+e.length),n={},i=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[i++]=l,n[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;n[u]||(t[i++]=l,n[u]=!0)}return t.length=i,t}};var xN={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function iA(s,e,t){let n={},i=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=CN(o,t);if(o==="indices")i=a;else if(a.constant)n[l]=a.value;else{let u=a.value,c={...a};delete c.value,n[l]=[new ge(s,u),c],AN(o,c)}}if(i){let o=i.value||i;H(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:i.isIndexed===void 0?!0:i.isIndexed};n.indices=[new ge(s,{data:o,target:34963}),a]}return n}function CN(s,e){let{attributeMap:t=xN}=e||{};return t&&t[s]||s}function AN(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}H(Number.isFinite(e.size),`attribute ${s} needs size`)}var Gl=2,vN=1e4,TN="Model needs drawMode and vertexCount",oA=()=>{},IN={},jr=class{constructor(e,t={}){let{id:n=Dr("model")}=t;H(na(e)),this.id=n,this.gl=e,this.id=t.id||Dr("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||fa.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},H(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),TN)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return H(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return H(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=iA(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(e={}){if(Si(e))return this;let t={};for(let n in e){let i=e[n];t[n]=i.getValue?i.getValue():i}return this.vertexArray.setAttributes(t),this}setUniforms(e={}){return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return Il(this.program.gl,e),this}draw(e={}){this._checkProgram();let{moduleSettings:t=null,framebuffer:n,uniforms:i={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(i);let c;Z.priority>=Gl&&(c=this._logDrawCallStart(Gl));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:f=h.indexType,indexOffset:y=h.indexOffset,vertexArrayInstanced:S=h.isInstanced}=this.props;S&&!this.isInstanced&&Z.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:C,instanceCount:T}=this,{onBeforeRender:I=oA,onAfterRender:B=oA}=this.props;I(),this.program.setUniforms(this.uniforms);let w=this.program.draw(Object.assign(IN,e,{logPriority:c,uniforms:null,framebuffer:n,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:f,isInstanced:C,instanceCount:T,offset:d?y:0}));return B(),Z.priority>=Gl&&this._logDrawCallEnd(c,u,n),w}transform(e={}){let{discard:t=!0,feedbackBuffers:n,unbindModels:i=[]}=e,{parameters:o}=e;n&&this._setFeedbackBuffers(n),t&&(o=Object.assign({},o,{[35977]:t})),i.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{i.forEach(a=>a.vertexArray.bindBuffers())}return this}render(e={}){return Z.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:n,fs:i,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:n,fs:i,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}H(t instanceof Zo,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Oc(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof ge&&t.delete()}}_setAnimationProps(e){this.animated&&H(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(e={}){if(Si(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new Ko(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:vN;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),Z.group(Gl,`>>> DRAWING MODEL ${this.id}`,{collapsed:Z.level<=2})(),e}_logDrawCallEnd(e,t,n,i){if(e===void 0)return;let o=BP({vertexArray:t,header:`${this.id} attributes`,attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=Uf({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,n)}),{table:c,count:h}=Uf({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,n),undefinedOnly:!0});h>0&&Z.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&Z.log("UNUSED UNIFORMS",Object.keys(l))();let d=MP(this.vertexArray.configuration);Z.table(e,o)(),Z.table(e,a)(),Z.table(e+1,d)(),i&&i.log({logLevel:Gl,message:`Rendered to ${i.id}`}),Z.groupEnd(Gl,`>>> DRAWING MODEL ${this.id}`)()}};var ig=class{constructor(e,t={}){this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(e={}){let{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(e={}){let t=this.bindings[this.currentIndex],{sourceBuffers:n,transformFeedback:i}=t;return{attributes:Object.assign({},n,e.attributes),transformFeedback:i}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],n=e?t[e]:null;return n?n instanceof ge?n:n.buffer:null}getData(e={}){let{varyingName:t}=e,n=this.getBuffer(t);return n?n.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(e={}){this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&H(se(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,n={};if(this.bindings[this.currentIndex]&&Object.assign(n,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let i in this.feedbackMap){let o=this.feedbackMap[i];i in t&&(n[o]=i)}Object.assign(n,e.feedbackBuffers);for(let i in n){let o=n[i];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;n[i]=this._createNewBuffer(i,{byteLength:l,usage:u,accessor:c})}}return n}_setupBuffers(e={}){let{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let n=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:n})}_setupTransformFeedback(e,{model:t}){let{program:n}=t;e.transformFeedback=new Ko(this.gl,{program:n,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:n}=this._swapBuffers(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceBuffers:t,feedbackBuffers:n})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),n=Object.assign({},e.feedbackBuffers);for(let i in this.feedbackMap){let o=this.feedbackMap[i];t[i]=e.feedbackBuffers[o],n[o]=e.sourceBuffers[i],H(n[o]instanceof ge)}return{sourceBuffers:t,feedbackBuffers:n}}_createNewBuffer(e,t){let n=new ge(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=n,n}_getNextIndex(){return(this.currentIndex+1)%2}};var wN="transform_uSampler_",og="transform_uSize_",sA="transform_position";function aA({vs:s,sourceTextureMap:e,targetTextureVarying:t,targetTexture:n}){let o=Object.keys(e).length,a=null,l={},u=s,c={};if(o>0||t){let h=u.split(`
`),d=h.slice();if(h.forEach((f,y,S)=>{if(o>0){let C=BN(f,e);if(C){let{updatedLine:T,inject:I}=C;d[y]=T,c=Rl([c,I]),Object.assign(l,C.samplerTextureMap),o--}}t&&!a&&(a=RN(f,t))}),t){H(n);let f=`${og}${t}`,y=`uniform vec2 ${f};
`,S=`     vec2 ${sA} = transform_getPos(${f});
     gl_Position = vec4(${sA}, 0, 1.);
`;c=Rl([c,{"vs:#decl":y,"vs:#main-start":S}])}u=d.join(`
`)}return{vs:u,targetTextureType:a,inject:c,samplerTextureMap:l}}function lA({sourceTextureMap:s,targetTextureVarying:e,targetTexture:t}){let n={},i,o;e&&({width:i,height:o}=t,n[`${og}${e}`]=[i,o]);for(let a in s)({width:i,height:o}=s[a]),n[`${og}${a}`]=[i,o];return n}function LN(s){return Hf(s,["attribute","in"])}function ON(s){let e=`${wN}${s}`,t=`${og}${s}`,n=`  uniform sampler2D ${e};
  uniform vec2 ${t};`;return{samplerName:e,sizeName:t,uniformDeclerations:n}}function RN(s,e){let t=Hf(s,["varying","out"]);return t&&t.name===e?t.type:null}function BN(s,e){let t={},n=LN(s);if(!n)return null;let{type:i,name:o}=n;if(o&&e[o]){let a=`// ${s} => Replaced by Transform with a sampler`,{samplerName:l,sizeName:u,uniformDeclerations:c}=ON(o),h=HP(i),d=`  ${i} ${o} = transform_getInput(${l}, ${u}).${h};
`;return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var MN={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},NN="transform_output",sg=class{constructor(e,t={}){this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(e={}){let t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(e={}){let{sourceBuffers:t,sourceTextures:n,framebuffer:i,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let f=this.samplerTextureMap[d];l[d]=n[f]}this._setSourceTextureParameters();let h=lA({sourceTextureMap:n,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,i.width,i.height]),{attributes:a,framebuffer:i,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(e={}){this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData({packed:e=!1}={}){let{framebuffer:t}=this.bindings[this.currentIndex],n=ua(t);if(!e)return n;let i=n.constructor,o=jP(this.targetTextureType),a=new i(n.length*o/4),l=0;for(let u=0;u<n.length;u+=4)for(let c=0;c<o;c++)a[l++]=n[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(e={}){let{_targetTextureVarying:t,_swapTexture:n}=e;this._swapTexture=n,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:n}=e;if(n instanceof Ot)return n;let i=t[n];return i?(this._targetRefTexName=n,this._createNewTexture(i)):null}_setupTextures(e={}){let{sourceBuffers:t,_sourceTextures:n={},_targetTexture:i}=e,o=this._createTargetTexture({sourceTextures:n,textureOrReference:i});this.hasSourceTextures=this.hasSourceTextures||n&&Object.keys(n).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:n,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((n,i,o)=>{o[i]=i}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new ge(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:n}=this._swapTextures(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceTextures:t,targetTexture:n})}}_updateBinding(e,t){let{sourceBuffers:n,sourceTextures:i,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,i),Object.assign(e.sourceBuffers,n),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new Pt(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let n in t)t[n].setParameters(MN)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let n=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:n}}_createNewTexture(e){let t=wl(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(e={}){let{sourceTextures:t,targetTexture:n}=this.bindings[this.currentIndex],{vs:i,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=aA({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:n}),c=Rl([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||Dc({version:Ll(i),input:this.targetTextureVarying,inputType:a,output:NN}),d=this.hasSourceTextures||this.targetTextureVarying?[e0].concat(e.modules||[]):e.modules;return{vs:i,fs:h,modules:d,uniforms:o,inject:c}}};var Ci=class{static isSupported(e){return se(e)}constructor(e,t={}){this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:n}=this;e&&e.delete(),t&&t.delete(),n&&n.delete()}run(e={}){let{clearRenderTarget:t=!0}=e,n=this._updateDrawOptions(e);t&&n.framebuffer&&n.framebuffer.clear({color:!0}),this.model.transform(n)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t)e=e||n.swap();H(e,"Nothing to swap")}getBuffer(e=null){return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(e={}){let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t){let i=n.getData(e);if(i)return i}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(e={}){"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t)n.update(e)}_initialize(e={}){let{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new jr(t,Object.assign({},e,{fs:e.fs||Dc({version:Ll(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of n)t=i.updateModelProps(t);return t}_buildResourceTransforms(e,t){DN(t)&&(this.bufferTransform=new ig(e,t)),GN(t)&&(this.textureTransform=new sg(e,t)),H(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of n)t=Object.assign(t,i.getDrawOptions(t));return t}};function DN(s){return!!(!Si(s.feedbackBuffers)||!Si(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function GN(s){return!!(!Si(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var uA={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},xn=class{static get DRAW_MODE(){return uA}constructor(e={}){let{id:t=Dr("geometry"),drawMode:n=uA.TRIANGLES,attributes:i={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=n|0,this.attributes={},this.userData={},this._setAttributes(i,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let n in e){let i=e[n];i=ArrayBuffer.isView(i)?{value:i}:i,H(ArrayBuffer.isView(i.value),`${this._print(n)}: must be typed array or object with value as typed array`),(n==="POSITION"||n==="positions")&&!i.size&&(i.size=3),n==="indices"?(H(!this.indices),this.indices=i):this.attributes[n]=i}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let n=1/0;for(let i in e){let o=e[i],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(n=Math.min(n,a.length/l))}return H(Number.isFinite(n)),n}};var cA="#define SMOOTH_EDGE_RADIUS 0.5",VN=`
`.concat(cA,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),kN=`
`.concat(cA,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),hA={name:"geometry",vs:VN,fs:kN};var Oe={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Oe,"IDENTITY",{get:()=>Le.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")()||0});var Cn={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},An={common:0,meters:1,pixels:2};var t0={DRAW:"draw",MASK:"mask"};var UN=Object.keys(Oe).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Oe[s],";")).join(""),zN=Object.keys(Cn).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(Cn[s],";")).join(""),WN=Object.keys(An).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(An[s],";")).join(""),dA="".concat(UN,`
`).concat(zN,`
`).concat(WN,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {
    
    if (geometry.position.w == 0.0) {
      float y = clamp(geometry.worldPosition.y, -89.9, 89.9);
      return 1.0 / cos(radians(y));
    }
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}
vec3 project_normal(vec3 vector) {
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size(position_world.z),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world.xyz -= project_uCoordinateOrigin;
  }
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);var io=typeof Float32Array<"u"?Float32Array:Array;var xme=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function n0(s,e){var t=e[0],n=e[1],i=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],y=e[11],S=e[12],C=e[13],T=e[14],I=e[15],B=t*l-n*a,w=t*u-i*a,M=t*c-o*a,F=n*u-i*l,U=n*c-o*l,te=i*c-o*u,re=h*C-d*S,J=h*T-f*S,Pe=h*I-y*S,Ce=d*T-f*C,he=d*I-y*C,pe=f*I-y*T,ie=B*pe-w*he+M*Ce+F*Pe-U*J+te*re;return ie?(ie=1/ie,s[0]=(l*pe-u*he+c*Ce)*ie,s[1]=(i*he-n*pe-o*Ce)*ie,s[2]=(C*te-T*U+I*F)*ie,s[3]=(f*U-d*te-y*F)*ie,s[4]=(u*Pe-a*pe-c*J)*ie,s[5]=(t*pe-i*Pe+o*J)*ie,s[6]=(T*M-S*te-I*w)*ie,s[7]=(h*te-f*M+y*w)*ie,s[8]=(a*he-l*Pe+c*re)*ie,s[9]=(n*Pe-t*he-o*re)*ie,s[10]=(S*U-C*M+I*B)*ie,s[11]=(d*M-h*U-y*B)*ie,s[12]=(l*J-a*Ce-u*re)*ie,s[13]=(t*Ce-n*J+i*re)*ie,s[14]=(C*w-S*F-T*B)*ie,s[15]=(h*F-d*w+f*B)*ie,s):null}function ga(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],y=e[10],S=e[11],C=e[12],T=e[13],I=e[14],B=e[15],w=t[0],M=t[1],F=t[2],U=t[3];return s[0]=w*n+M*l+F*d+U*C,s[1]=w*i+M*u+F*f+U*T,s[2]=w*o+M*c+F*y+U*I,s[3]=w*a+M*h+F*S+U*B,w=t[4],M=t[5],F=t[6],U=t[7],s[4]=w*n+M*l+F*d+U*C,s[5]=w*i+M*u+F*f+U*T,s[6]=w*o+M*c+F*y+U*I,s[7]=w*a+M*h+F*S+U*B,w=t[8],M=t[9],F=t[10],U=t[11],s[8]=w*n+M*l+F*d+U*C,s[9]=w*i+M*u+F*f+U*T,s[10]=w*o+M*c+F*y+U*I,s[11]=w*a+M*h+F*S+U*B,w=t[12],M=t[13],F=t[14],U=t[15],s[12]=w*n+M*l+F*d+U*C,s[13]=w*i+M*u+F*f+U*T,s[14]=w*o+M*c+F*y+U*I,s[15]=w*a+M*h+F*S+U*B,s}function fA(s,e,t){var n=t[0],i=t[1],o=t[2],a,l,u,c,h,d,f,y,S,C,T,I;return e===s?(s[12]=e[0]*n+e[4]*i+e[8]*o+e[12],s[13]=e[1]*n+e[5]*i+e[9]*o+e[13],s[14]=e[2]*n+e[6]*i+e[10]*o+e[14],s[15]=e[3]*n+e[7]*i+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],y=e[7],S=e[8],C=e[9],T=e[10],I=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=y,s[8]=S,s[9]=C,s[10]=T,s[11]=I,s[12]=a*n+h*i+S*o+e[12],s[13]=l*n+d*i+C*o+e[13],s[14]=u*n+f*i+T*o+e[14],s[15]=c*n+y*i+I*o+e[15]),s}function gA(s,e,t){var n=t[0],i=t[1],o=t[2];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=e[3]*n,s[4]=e[4]*i,s[5]=e[5]*i,s[6]=e[6]*i,s[7]=e[7]*i,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function HN(){var s=new io(4);return io!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Fc(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3];return s[0]=t[0]*n+t[4]*i+t[8]*o+t[12]*a,s[1]=t[1]*n+t[5]*i+t[9]*o+t[13]*a,s[2]=t[2]*n+t[6]*i+t[10]*o+t[14]*a,s[3]=t[3]*n+t[7]*i+t[11]*o+t[15]*a,s}var Cme=function(){var s=HN();return function(e,t,n,i,o,a){var l,u;for(t||(t=4),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();function jN(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}return!1}function Vc(s){let e={},t;return n=>{for(let i in n)if(!jN(n[i],e[i])){t=s(n),e=n;break}return t}}var yA=[0,0,0,0],qN=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],XN=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],YN=[0,0,0],$N=[0,0,0],QN=Vc(KN);function i0(s,e,t=$N){t.length<3&&(t=[t[0],t[1],0]);let n=t,i,o=!0;switch(e===Oe.LNGLAT_OFFSETS||e===Oe.METER_OFFSETS?i=t:i=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case Cn.WEB_MERCATOR:(e===Oe.LNGLAT||e===Oe.CARTESIAN)&&(i=[0,0,0],o=!1);break;case Cn.WEB_MERCATOR_AUTO_OFFSET:e===Oe.LNGLAT?n=i:e===Oe.CARTESIAN&&(n=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],i=s.unprojectPosition(n),n[0]-=t[0],n[1]-=t[1],n[2]-=t[2]);break;case Cn.IDENTITY:n=s.position.map(Math.fround),n[2]=n[2]||0;break;case Cn.GLOBE:o=!1,i=null;break;default:o=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:n,offsetMode:o}}function ZN(s,e,t){let{viewMatrixUncentered:n,projectionMatrix:i}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=yA,u=yA,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:f}=i0(s,e,t);return f&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=Fc([],u,a),o=n||o,a=ga([],i,o),a=ga([],a,qN)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function SA({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:n=Oe.DEFAULT,coordinateOrigin:i,autoWrapLongitude:o=!1}={}){n===Oe.DEFAULT&&(n=s.isGeospatial?Oe.LNGLAT:Oe.CARTESIAN);let a=QN({viewport:s,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:i});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||XN,a}function KN({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:n}){let{projectionCenter:i,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=ZN(s,t,n),h=s.getDistanceScales(),d=[s.width*e,s.height*e],f=Fc([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,y={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:i,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:YN,project_uScale:s.scale,project_uViewProjectionMatrix:o,project_uCameraPosition:l};if(c){let S=s.getDistanceScales(c);switch(t){case Oe.METER_OFFSETS:y.project_uCommonUnitsPerWorldUnit=S.unitsPerMeter,y.project_uCommonUnitsPerWorldUnit2=S.unitsPerMeter2;break;case Oe.LNGLAT:case Oe.LNGLAT_OFFSETS:s._pseudoMeters||(y.project_uCommonUnitsPerMeter=S.unitsPerMeter),y.project_uCommonUnitsPerWorldUnit=S.unitsPerDegree,y.project_uCommonUnitsPerWorldUnit2=S.unitsPerDegree2;break;case Oe.CARTESIAN:y.project_uCommonUnitsPerWorldUnit=[1,1,S.unitsPerMeter[2]],y.project_uCommonUnitsPerWorldUnit2=[0,0,S.unitsPerMeter2[2]];break;default:break}}return y}var JN={};function eD(s=JN){return s.viewport?SA(s):{}}var o0={name:"project",dependencies:[jf,hA],vs:dA,getUniforms:eD};var tD=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Ai={name:"project32",dependencies:[o0],vs:tD};function s0(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ts(s,e){let t=ng([],e,s);return tA(t,t,1/t[3]),t}function a0(s,e,t){return s<e?e:s>t?t:s}function rD(s){return Math.log(s)*Math.LOG2E}var kc=Math.log2||rD;function vn(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var kn=Math.PI,EA=kn/4,Un=kn/180,l0=180/kn,Uc=512,u0=4003e4,_l=85.051129,xA=1.5;function c0(s){return kc(s)}function oo([s,e]){vn(Number.isFinite(s)),vn(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");let t=s*Un,n=e*Un,i=Uc*(t+kn)/(2*kn),o=Uc*(kn+Math.log(Math.tan(EA+n*.5)))/(2*kn);return[i,o]}function zn([s,e]){let t=s/Uc*(2*kn)-kn,n=2*(Math.atan(Math.exp(e/Uc*(2*kn)-kn))-EA);return[t*l0,n*l0]}function h0({latitude:s}){vn(Number.isFinite(s));let e=Math.cos(s*Un);return c0(u0*e)-9}function Fl({latitude:s,longitude:e,highPrecision:t=!1}){vn(Number.isFinite(s)&&Number.isFinite(e));let n={},i=Uc,o=Math.cos(s*Un),a=i/360,l=a/o,u=i/u0/o;if(n.unitsPerMeter=[u,u,u],n.metersPerUnit=[1/u,1/u,1/u],n.unitsPerDegree=[a,l,u],n.degreesPerUnit=[1/a,1/l,1/u],t){let c=Un*Math.tan(s*Un)/o,h=a*c/2,d=i/u0*c,f=d/l*u;n.unitsPerDegree2=[0,h,d],n.unitsPerMeter2=[f,0,f]}return n}function zc(s,e){let[t,n,i]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Fl({longitude:t,latitude:n,highPrecision:!0}),h=oo(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=zn(h),f=(i||0)+(l||0);return Number.isFinite(i)||Number.isFinite(l)?[d[0],d[1],f]:d}function ag({height:s,pitch:e,bearing:t,altitude:n,scale:i,center:o=null}){let a=s0();return Gc(a,a,[0,0,-n]),tg(a,a,-e*Un),rg(a,a,t*Un),i/=s,_c(a,a,[i,i,i]),o&&Gc(a,a,G1([],o)),a}function d0({width:s,height:e,fovy:t=pa(xA),altitude:n,pitch:i=0,nearZMultiplier:o=1,farZMultiplier:a=1}){n!==void 0&&(t=pa(n));let l=.5*t*Un,u=Wc(t),c=i*Un,h=Math.sin(l)*u/Math.sin(Math.min(Math.max(Math.PI/2-c-l,.01),Math.PI-.01)),d=Math.sin(c)*h+u;return{fov:2*l,aspect:s/e,focalDistance:u,near:o,far:d*a}}function pa(s){return 2*Math.atan(.5/s)*l0}function Wc(s){return .5/Math.tan(.5*s*Un)}function Vl(s,e){let[t,n,i=0]=s;return vn(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(i)),ts(e,[t,n,i,1])}function kl(s,e,t=0){let[n,i,o]=s;if(vn(Number.isFinite(n)&&Number.isFinite(i),"invalid pixel coordinate"),Number.isFinite(o))return ts(e,[n,i,o,1]);let a=ts(e,[n,i,0,1]),l=ts(e,[n,i,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return Zf([],a,l,h)}function Hc({width:s,height:e,bounds:t,minExtent:n=0,maxZoom:i=24,padding:o=0,offset:a=[0,0]}){let[[l,u],[c,h]]=t;if(Number.isFinite(o)){let U=o;o={top:U,bottom:U,left:U,right:U}}else vn(Number.isFinite(o.top)&&Number.isFinite(o.bottom)&&Number.isFinite(o.left)&&Number.isFinite(o.right));let d=oo([l,a0(h,-_l,_l)]),f=oo([c,a0(u,-_l,_l)]),y=[Math.max(Math.abs(f[0]-d[0]),n),Math.max(Math.abs(f[1]-d[1]),n)],S=[s-o.left-o.right-Math.abs(a[0])*2,e-o.top-o.bottom-Math.abs(a[1])*2];vn(S[0]>0&&S[1]>0);let C=S[0]/y[0],T=S[1]/y[1],I=(o.right-o.left)/2/C,B=(o.bottom-o.top)/2/T,w=[(f[0]+d[0])/2+I,(f[1]+d[1])/2+B],M=zn(w),F=Math.min(i,kc(Math.abs(Math.min(C,T))));return vn(Number.isFinite(F)),{longitude:M[0],latitude:M[1],zoom:F}}var CA=Math.PI/180;function jc(s,e=0){let{width:t,height:n,unproject:i}=s,o={targetZ:e},a=i([0,n],o),l=i([t,n],o),u,c,h=s.fovy?.5*s.fovy*CA:Math.atan(.5/s.altitude),d=(90-s.pitch)*CA;return h>d-.01?(u=AA(s,0,e),c=AA(s,t,e)):(u=i([0,0],o),c=i([t,0],o)),[a,l,c,u]}function AA(s,e,t){let{pixelUnprojectionMatrix:n}=s,i=ts(n,[e,0,1,1]),o=ts(n,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-i[2])/(o[2]-i[2]),u=Zf([],i,o,l),c=zn(u);return c[2]=t,c}var rs={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...Dl};var TA=class{constructor(e){this._pool=[],this.props={overAlloc:2,poolSize:100},this.setProps(e)}setProps(e){Object.assign(this.props,e)}allocate(e,t,{size:n=1,type:i,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=i||e&&e.constructor||Float32Array,h=t*n+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d;u&&(d=u*n+o);let f=this._allocate(c,h,l,d);return e&&a?f.set(e):l||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,n,i){let o=Math.max(Math.ceil(t*this.props.overAlloc),1);o>i&&(o=i);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return n&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:n}=e,{byteLength:i}=n,o=t.findIndex(a=>a.byteLength>=i);o<0?t.push(n):(o>0||t.length<this.props.poolSize)&&t.splice(o,0,n),t.length>this.props.poolSize&&t.shift()}},so=new TA;function zl(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function wA(s){return[s[12],s[13],s[14]]}function LA(s){return{left:Ul(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:Ul(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:Ul(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:Ul(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:Ul(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:Ul(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var IA=new Wr;function Ul(s,e,t,n){IA.set(s,e,t);let i=IA.len();return{distance:n/i,normal:new Wr(-s/i,-e/i,-t/i)}}function oD(s){return s-Math.fround(s)}var qc;function lg(s,e){let{size:t=1,startIndex:n=0}=e,i=e.endIndex!==void 0?e.endIndex:s.length,o=(i-n)/t;qc=so.allocate(qc,o,{type:Float32Array,size:t*2});let a=n,l=0;for(;a<i;){for(let u=0;u<t;u++){let c=s[a++];qc[l+u]=c,qc[l+u+t]=oD(c)}l+=t*2}return qc.subarray(0,o*t*2)}var sD=Math.PI/180,aD=zl(),f0=[0,0,0],lD=0,uD={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]},ma=class{constructor(e={}){let{id:t=null,x:n=0,y:i=0,width:o=1,height:a=1}=e;this.id=t||this.constructor.displayName||"viewport",this.x=n,this.y=i,this.width=o||1,this.height=a||1,this._frustumPlanes={},this._initViewMatrix(e),this._initProjectionMatrix(e),this._initPixelMatrices(),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Cn.WEB_MERCATOR:Cn.WEB_MERCATOR_AUTO_OFFSET:Cn.IDENTITY}equals(e){return e instanceof ma?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&da(e.projectionMatrix,this.projectionMatrix)&&da(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let n=this.projectPosition(e),i=Vl(n,this.pixelProjectionMatrix),[o,a]=i,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,i[2]]}unproject(e,{topLeft:t=!0,targetZ:n}={}){let[i,o,a]=e,l=t?o:this.height-o,u=n&&n*this.distanceScales.unitsPerMeter[2],c=kl([i,l,a],this.pixelUnprojectionMatrix,u),[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(n)?[h,d,n]:[h,d]}projectPosition(e){let[t,n]=this.projectFlat(e),i=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,n,i]}unprojectPosition(e){let[t,n]=this.unprojectFlat(e),i=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,n,i]}projectFlat(e){if(this.isGeospatial){let t=oo(e);return t[1]=XP(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?zn(e):e}getBounds(e={}){let t={targetZ:e.z||0},n=this.unproject([0,0],t),i=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(n[0],i[0],o[0],a[0]),Math.min(n[1],i[1],o[1],a[1]),Math.max(n[0],i[0],o[0],a[0]),Math.max(n[1],i[1],o[1],a[1])]}getDistanceScales(e=null){return e?Fl({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:n=1,height:i=1}){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+i}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,LA(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}getCameraPosition(){return this.cameraPosition}getCameraDirection(){return this.cameraDirection}getCameraUp(){return this.cameraUp}_createProjectionMatrix({orthographic:e,fovyRadians:t,aspect:n,focalDistance:i,near:o,far:a}){return e?new Hr().orthographic({fovy:t,aspect:n,focalDistance:i,near:o,far:a}):new Hr().perspective({fovy:t,aspect:n,near:o,far:a})}_initViewMatrix(e){let{viewMatrix:t=aD,longitude:n=null,latitude:i=null,zoom:o=null,position:a=null,modelMatrix:l=null,focalDistance:u=1,distanceScales:c=null}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(n),this.zoom=o,Number.isFinite(this.zoom)||(this.zoom=this.isGeospatial?h0({latitude:i})+Math.log2(u):lD);let h=Math.pow(2,this.zoom);this.scale=h,this.distanceScales=this.isGeospatial?Fl({latitude:i,longitude:n}):c||uD,this.focalDistance=u,this.distanceScales.metersPerUnit=new Wr(this.distanceScales.metersPerUnit),this.distanceScales.unitsPerMeter=new Wr(this.distanceScales.unitsPerMeter),this.position=f0,this.meterOffset=f0,a&&(this.position=a,this.modelMatrix=l,this.meterOffset=l?l.transformVector(a):a),this.isGeospatial?(this.longitude=n,this.latitude=i,this.center=this._getCenterInWorld({longitude:n,latitude:i})):this.center=a?this.projectPosition(a):[0,0,0],this.viewMatrixUncentered=t,this.viewMatrix=new Hr().multiplyRight(this.viewMatrixUncentered).translate(new Wr(this.center||f0).negate())}_getCenterInWorld({longitude:e,latitude:t}){let{meterOffset:n,distanceScales:i}=this,o=new Wr(this.projectPosition([e,t,0]));if(n){let a=new Wr(n).scale(i.unitsPerMeter);o.add(a)}return o}_initProjectionMatrix(e){let{projectionMatrix:t=null,orthographic:n=!1,fovyRadians:i,fovy:o=75,near:a=.1,far:l=1e3,focalDistance:u=1}=e;this.projectionMatrix=t||this._createProjectionMatrix({orthographic:n,fovyRadians:i||o*sD,aspect:this.width/this.height,focalDistance:u,near:a,far:l})}_initPixelMatrices(){let e=zl();ga(e,e,this.projectionMatrix),ga(e,e,this.viewMatrix),this.viewProjectionMatrix=e,this.viewMatrixInverse=n0([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=wA(this.viewMatrixInverse);let t=zl(),n=zl();gA(t,t,[this.width/2,-this.height/2,1]),fA(t,t,[1,-1,0]),ga(n,t,this.viewProjectionMatrix),this.pixelProjectionMatrix=n,this.viewportMatrix=t,this.pixelUnprojectionMatrix=n0(zl(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Le.warn("Pixel project matrix not invertible")()}};ma.displayName="Viewport";function cD(){var s=new io(2);return io!=Float32Array&&(s[0]=0,s[1]=0),s}function g0(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function OA(s,e){return s[0]=-e[0],s[1]=-e[1],s}var Nbe=function(){var s=cD();return function(e,t,n,i,o,a){var l,u;for(t||(t=2),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();var dD=512,fD=4003e4,gD=Math.PI/180;function RA(s){let e=Math.cos(s*gD);return dD/fD/e}var ns=class extends ma{constructor(e={}){let{latitude:t=0,longitude:n=0,zoom:i=11,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,legacyMeterSizes:y=!1}=e,{width:S,height:C,altitude:T=1.5}=e,I=Math.pow(2,i);S=S||1,C=C||1;let B,w=null;h?(T=h[5]/2,B=pa(T)):(e.fovy?(B=e.fovy,T=Wc(B)):B=pa(T),w=d0({width:S,height:C,pitch:o,fovy:B,nearZMultiplier:l,farZMultiplier:u}));let M=ag({height:C,pitch:o,bearing:a,scale:I,altitude:T});f&&(M=new Hr().translate([512*f,0,0]).multiplyLeft(M));super({...e,width:S,height:C,viewMatrix:M,longitude:n,latitude:t,zoom:i,...w,fovy:B,focalDistance:T});this.latitude=t,this.longitude=n,this.zoom=i,this.pitch=o,this.bearing=a,this.altitude=T,this.fovy=B,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=y,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),n=Math.ceil((e[2]-180)/360);for(let i=t;i<=n;i++){let o=i?new ns({...this,worldOffset:i}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,n]=this.projectFlat(e),i=(e[2]||0)*RA(e[1]);return[t,n,i]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,n]=this.unprojectFlat(e),i=(e[2]||0)/RA(n);return[t,n,i]}addMetersToLngLat(e,t){return zc(e,t)}panByPosition(e,t){let n=kl(t,this.pixelUnprojectionMatrix),i=this.projectFlat(e),o=g0([],i,OA([],n)),a=g0([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=jc(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:n,height:i}=this,{longitude:o,latitude:a,zoom:l}=Hc({width:n,height:i,bounds:e,...t});return new ns({width:n,height:i,longitude:o,latitude:a,zoom:l})}};ns.displayName="WebMercatorViewport";function pD(){var s=new io(3);return io!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function mD(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}var BA=mD;var Vbe=function(){var s=pD();return function(e,t,n,i,o,a){var l,u;for(t||(t=3),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();function p0(s,e,t=!1){let n=e.projectPosition(s);if(t&&e instanceof ns){let[i,o,a=0]=s,l=e.getDistanceScales([i,o]);n[2]=a*l.unitsPerMeter[2]}return n}function PD(s){let e={...s},{coordinateSystem:t}=s,{viewport:n,coordinateOrigin:i,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return t===Oe.DEFAULT&&(t=n.isGeospatial?Oe.LNGLAT:Oe.CARTESIAN),o===void 0&&(e.fromCoordinateSystem=t),a===void 0&&(e.fromCoordinateOrigin=i),e.coordinateSystem=t,e}function m0(s,{viewport:e,modelMatrix:t,coordinateSystem:n,coordinateOrigin:i,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=Fc([],[a,l,u,1],t)),n){case Oe.LNGLAT:return p0([a,l,u],e,o);case Oe.LNGLAT_OFFSETS:return p0([a+i[0],l+i[1],u+(i[2]||0)],e,o);case Oe.METER_OFFSETS:return p0(zc(i,[a,l,u]),e,o);case Oe.CARTESIAN:default:return e.isGeospatial?[a+i[0],l+i[1],u+i[2]]:e.projectPosition([a,l,u])}}function MA(s,e){let{viewport:t,coordinateSystem:n,coordinateOrigin:i,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=PD(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=i0(t,n,i),d=m0(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let f=t.projectPosition(u||c);BA(d,d,f)}return d}var NA={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Wl=Symbol.for("component"),ao=Symbol.for("asyncPropDefaults"),vi=Symbol.for("asyncPropOriginal"),Wn=Symbol.for("asyncPropResolved");function DA(s,e=()=>!0){return Array.isArray(s)?GA(s,e,[]):e(s)?[s]:[]}function GA(s,e,t){let n=-1;for(;++n<s.length;){let i=s[n];Array.isArray(i)?GA(i,e,t):e(i)&&t.push(i)}return t}function _A({target:s,source:e,start:t=0,count:n=1}){let i=e.length,o=n*i,a=0;for(let l=t;a<i;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}function b0(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let n=s[t],i=e[t];if(!(n===i||Array.isArray(n)&&Array.isArray(i)&&b0(n,i)))return!1}return!0}function Hn(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}function ug(){}var yD={onStart:ug,onUpdate:ug,onInterrupt:ug,onEnd:ug},Ti=class{constructor(e){this._inProgress=!1,this._handle=null,this.timeline=e,this.settings={}}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings={...yD,...e},this._inProgress=!0,this.settings.onStart(this)}end(){this._inProgress&&(this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd(this))}cancel(){this._inProgress&&(this.settings.onInterrupt(this),this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){let{timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this.timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate(this),this.timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var Hl=class{constructor(e,t){this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:n}=this.source,{size:i}=t,o=n;if(n&&n.length!==i){o=new Float32Array(i);let a=t.elementOffset||0;for(let l=0;l<i;++l)o[l]=n[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function FA(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function cg(s){return s.stride||s.size*s.bytesPerElement}function VA(s,e){e.offset&&Le.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=cg(s),n="vertexOffset"in e?e.vertexOffset:s.vertexOffset||0,i=e.elementOffset||0,o=n*t+i*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function SD(s,e){let t=VA(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var hg=class{constructor(e,t){this.gl=e,this.id=t.id,this.size=t.size;let n=t.logicalType||t.type,i=n===5130,{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0),t.defaultValue=o;let a=n;i?a=5126:!a&&t.isIndexed?a=e&&vc(e,tt.ELEMENT_INDEX_UINT32)?5125:5123:a||(a=5126),t.logicalType=n,t.type=a;let l=FA(n||a||5126);this.shaderAttributes={},this.doublePrecision=i,i&&t.fp64===!1&&(l=Float32Array),t.bytesPerElement=l.BYTES_PER_ELEMENT,this.defaultType=l,this.value=null,this.settings=t,this.state={externalBuffer:null,bufferAccessor:t,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null,this.setData(t)}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new ge(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*cg(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),so.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let n={},i=this.value instanceof Float64Array,o=SD(this.getAccessor(),t||{});return n[e]=new Hl(this,o.high),n["".concat(e,"64Low")]=i?new Hl(this,o.low):new Float32Array(this.size),n}if(t){let n=VA(this.getAccessor(),t);return{[e]:new Hl(this,n)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant){let t=this.value.slice();e=[t,t]}else{let{value:t,numInstances:n,size:i}=this,o=n*i;if(t&&o&&t.length>=o){let a=new Array(i).fill(1/0),l=new Array(i).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<i;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this;ArrayBuffer.isView(e)?e={value:e}:e instanceof ge&&(e={buffer:e});let n={...this.settings,...e};if(t.bufferAccessor=n,t.bounds=null,e.constant){let i=e.value;if(i=this._normalizeValue(i,[],0),this.settings.normalized&&(i=this._normalizeConstant(i)),!(!t.constant||!this._areValuesEqual(i,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=i}else if(e.buffer){let i=e.buffer;t.externalBuffer=i,t.constant=!1,this.value=e.value;let o=e.value instanceof Float64Array;n.type=e.type||i.accessor.type,n.bytesPerElement=i.accessor.BYTES_PER_ELEMENT*(o?2:1),n.stride=cg(n)}else if(e.value){this._checkExternalBuffer(e);let i=e.value;t.externalBuffer=null,t.constant=!1,this.value=i,n.bytesPerElement=i.BYTES_PER_ELEMENT,n.stride=cg(n);let{buffer:o,byteOffset:a}=this;this.doublePrecision&&i instanceof Float64Array&&(i=lg(i,n));let l=i.byteLength+a+n.stride*2;o.byteLength<l&&o.reallocate(l),o.setAccessor(null),o.subData({data:i,offset:a}),n.type=e.type||o.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let{value:t}=this,{startOffset:n=0,endOffset:i}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?lg(t,{size:this.size,startIndex:n,endIndex:i}):t.subarray(n,i),offset:n*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate({numInstances:e,copy:t=!1}){let{state:n}=this,i=n.allocatedValue,o=so.allocate(i,e+1,{size:this.size,type:this.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&i&&a.subData({data:i instanceof Float64Array?lg(i,this):i,offset:l})),n.allocatedValue=o,n.constant=!1,n.externalBuffer=null,n.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!e.constant&&t){let n=this.defaultType,i=!1;if(this.doublePrecision&&(i=t.BYTES_PER_ELEMENT<4),i)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof n)&&this.settings.normalized&&!("normalized"in e)&&Le.warn("Attribute ".concat(this.id," is normalized"))()}}_normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,n){let{defaultValue:i,size:o}=this.settings;if(Number.isFinite(e))return t[n]=e,t;if(!e)return t[n]=i[0],t;switch(o){case 4:t[n+3]=Number.isFinite(e[3])?e[3]:i[3];case 3:t[n+2]=Number.isFinite(e[2])?e[2]:i[2];case 2:t[n+1]=Number.isFinite(e[1])?e[1]:i[1];case 1:t[n+0]=Number.isFinite(e[0])?e[0]:i[0];break;default:let a=o;for(;--a>=0;)t[n+a]=Number.isFinite(e[a])?e[a]:i[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:n}=this;for(let i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0}};var kA=[],UA=[];function lo(s,e=0,t=1/0){let n=kA,i={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?n=s:s.length>0&&(UA.length=s.length,n=UA):n=kA,(e>0||Number.isFinite(t))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,t),i.index=e-1),{iterable:n,objectInfo:i}}function dg(s){return s&&s[Symbol.asyncIterator]}function fg(s,e){let{size:t,stride:n,offset:i,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=n?n/l:t,c=i?i/l:0,h=Math.floor((s.length-c)/u);return(d,{index:f,target:y})=>{if(!o){let I=f*u+c;for(let B=0;B<t;B++)y[B]=s[I+B];return y}let S=o[f],C=o[f+1]||h,T;if(a){T=new Array(C-S);for(let I=S;I<C;I++){let B=I*u+c;y=new Array(t);for(let w=0;w<t;w++)y[w]=s[B+w];T[I-S]=y}}else if(u===t)T=s.subarray(S*t+c,C*t+c);else{T=new s.constructor((C-S)*t);let I=0;for(let B=S;B<C;B++){let w=B*u+c;for(let M=0;M<t;M++)T[I++]=s[w+M]}}return T}}var zA=[],Xc=[[0,1/0]];function WA(s,e){if(s===Xc||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],n=s.length,i=0;for(let o=0;o<n;o++){let a=s[o];a[1]<e[0]?(t.push(a),i=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(i,0,e),t}function P0(s){let{source:e,target:t,start:n=0,size:i,getData:o}=s,a=s.end||t.length,l=e.length,u=a-n;if(l>u){t.set(e.subarray(0,u),n);return}if(t.set(e,n),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<i;d++)t[n+c]=h[d]||0,c++}}function HA({source:s,target:e,size:t,getData:n,sourceStartIndices:i,targetStartIndices:o}){if(!Array.isArray(o))return P0({source:s,target:e,size:t,getData:n}),e;let a=0,l=0,u=n&&((h,d)=>n(h+l,d)),c=Math.min(i.length,o.length);for(let h=1;h<c;h++){let d=i[h]*t,f=o[h]*t;P0({source:s.subarray(a,d),target:e,start:l,end:f,size:t,getData:u}),a=d,l=f}return l<e.length&&P0({source:[],target:e,start:l,size:t,getData:u}),e}var xD={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function gg(s,e){return s?(Number.isFinite(s)&&(s={duration:s}),s.type=s.type||"interpolation",{...xD[s.type],...e,...s}):null}function pg(s,e){return e.getBuffer()?[e.getBuffer(),{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function mg(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function bg(s){s.push(s.shift())}function Yc(s,e){let{doublePrecision:t,settings:n,value:i,size:o}=s,a=t&&i instanceof Float64Array?2:1;return(n.noAlloc?i.length:e*o)*a}function Pg({buffer:s,numInstances:e,attribute:t,fromLength:n,fromStartIndices:i,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=i&&c,d=Yc(t,e),f=t.state.constant;if(!h&&n>=d)return;let y=f?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!f){let I=o;o=(B,w)=>t._normalizeConstant(I(B,w))}let S=f?(I,B)=>o(y,B):(I,B)=>o(y.subarray(I,I+l),B),C=s.getData({length:n}),T=new Float32Array(d);HA({source:C,target:T,sourceStartIndices:i,targetStartIndices:c,size:l,getData:S}),s.byteLength<T.byteLength+u&&s.reallocate(T.byteLength+u),s.subData({data:T,offset:u})}var is=class extends hg{constructor(e,t={}){super(e,t);let{transition:n=!1,noAlloc:i=!1,update:o=null,accessor:a=null,transform:l=null,startIndices:u=null}=t;Object.assign(this.settings,{transition:n,noAlloc:i,update:o||a&&this._autoUpdater,accessor:a,transform:l}),Object.assign(this.state,{lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:Xc,startIndices:u}),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,n=this.settings.transition,i=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return gg(i,n)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:n=0,endRow:i=1/0}=t;this.state.updateRanges=WA(this.state.updateRanges,[n,i])}else this.state.updateRanges=Xc}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=zA}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}update(e){this.setData(e)}allocate(e){let{state:t,settings:n}=this;return n.noAlloc?!1:n.update?(super.allocate({numInstances:e,copy:t.updateRanges!==Xc}),!0):!1}updateBuffer({numInstances:e,data:t,props:n,context:i}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(i,this,{data:t,startRow:c,endRow:h,props:n,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:f})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:n,settings:i}=this;if(!e)return n.binaryValue=null,n.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(n.binaryValue===e)return this.clearNeedsUpdate(),!0;if(n.binaryValue=e,this.setNeedsRedraw(),ArrayBuffer.isView(e)&&(e={value:e}),i.transform||t!==this.startIndices){Hn(ArrayBuffer.isView(e.value),"invalid ".concat(i.accessor));let a=e.size&&e.size!==this.size;return n.binaryAccessor=fg(e.value,{size:e.size||this.size,stride:e.stride,offset:e.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let n in e)Object.assign(t,super.getShaderAttributes(n,e[n]));return t}_autoUpdater(e,{data:t,startRow:n,endRow:i,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:f,transform:y}=l,S=u.binaryAccessor||(typeof f=="function"?f:o[f]);Hn(typeof S=="function",'accessor "'.concat(f,'" is not a function'));let C=e.getVertexOffset(n),{iterable:T,objectInfo:I}=lo(t,n,i);for(let B of T){I.index++;let w=S(B,I);if(y&&(w=y.call(this,w)),d){let M=(I.index<d.length-1?d[I.index+1]:a)-d[I.index];if(w&&Array.isArray(w[0])){let F=C;for(let U of w)e._normalizeValue(U,c,F),F+=h}else w&&w.length>h?c.set(w,C):(e._normalizeValue(w,I.target,0),_A({target:c,source:I.target,start:C,count:M}));C+=M*h}else e._normalizeValue(w,c,C),C+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let n=!0;switch(t){case 4:n=n&&Number.isFinite(e[3]);case 3:n=n&&Number.isFinite(e[2]);case 2:n=n&&Number.isFinite(e[1]);case 1:n=n&&Number.isFinite(e[0]);break;default:n=!1}if(!n)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var yg=class{constructor({gl:e,attribute:t,timeline:n}){this.gl=e,this.type="interpolation",this.transition=new Ti(n),this.attribute=t,this.attributeInTransition=new is(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=AD(e,t);let i={byteLength:0,usage:35050};this.buffers=[new ge(e,i),new ge(e,i)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}let{gl:n,buffers:i,attribute:o}=this;bg(i);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of i)Pg({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=Yc(o,t),this.attributeInTransition.update({buffer:i[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:i[0],aTo:pg(n,o)},feedbackBuffers:{vCurrent:i[1]}})}update(){let e=this.transition.update();if(e){let{time:t,settings:{duration:n,easing:i}}=this.transition,o=i(t/n);this.transform.run({uniforms:{time:o}})}return e}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete()}},CD=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function AD(s,e){let t=mg(e.size);return new Ci(s,{vs:CD,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var Sg=class{constructor({gl:e,attribute:t,timeline:n}){this.gl=e,this.type="spring",this.transition=new Ti(n),this.attribute=t,this.attributeInTransition=new is(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=TD(e),this.framebuffer=ID(e,this.texture),this.transform=vD(e,t,this.framebuffer);let i={byteLength:0,usage:35050};this.buffers=[new ge(e,i),new ge(e,i),new ge(e,i)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:n,buffers:i,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of i)Pg({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=Yc(o,t),this.attributeInTransition.update({buffer:i[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:pg(n,o)}})}update(){let{buffers:e,transform:t,framebuffer:n,transition:i}=this;return i.update()?(t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:n,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:i.settings.stiffness,damping:i.settings.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),bg(e),this.attributeInTransition.update({buffer:e[1],value:this.attribute.value}),ua(n)[0]>0||i.end(),!0):!1}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete();this.texture.delete(),this.texture=null,this.framebuffer.delete(),this.framebuffer=null}};function vD(s,e,t){let n=mg(e.size);return new Ci(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:n},varyings:["vNext"]})}function TD(s){return new Ot(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function ID(s,e){return new Pt(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var wD={interpolation:yg,spring:Sg},Eg=class{constructor(e,{id:t,timeline:n}){this.id=t,this.gl=e,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=Ci.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:n}){this.numInstances=n||1;for(let i in e){let o=e[i],a=o.getTransitionSetting(t);!a||this._updateAttribute(i,o,a)}for(let i in this.transitions){let o=e[i];(!o||!o.getTransitionSetting(t))&&this._removeTransition(i)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let n=this.transitions[t];n.inProgress&&(e[t]=n.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,n){let i=this.transitions[e],o=!i||i.type!==n.type;if(o){if(!this.isSupported){Le.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}i&&this._removeTransition(e);let a=wD[n.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(Le.error("unsupported transition type '".concat(n.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(n,this.numInstances))}};var jA="attributeManager.invalidate",LD="attributeManager.updateStart",OD="attributeManager.updateEnd",RD="attribute.updateStart",BD="attribute.allocate",MD="attribute.updateEnd",xg=class{constructor(e,{id:t="attribute-manager",stats:n,timeline:i}={}){this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.accessors={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new Eg(e,{id:"".concat(t,"-transitions"),timeline:i}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(e=!0){return this.needsRedraw=!0,this}add(e,t){this._add(e,t)}addInstanced(e,t){this._add(e,t,{instanced:1})}remove(e){for(let t=0;t<e.length;t++){let n=e[t];this.attributes[n]!==void 0&&(this.attributes[n].delete(),delete this.attributes[n])}}invalidate(e,t){let n=this._invalidateTrigger(e,t);tr(jA,this,e,n)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);tr(jA,this,"all")}update({data:e,numInstances:t,startIndices:n=null,transitions:i,props:o={},buffers:a={},context:l={}}={}){let u=!1;tr(LD,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=n,h.numInstances=t,o[c]&&Le.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(a[d],e.startIndices)||!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw|=h.needsRedraw()}u&&tr(OD,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:i})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:n}=this,i={...n.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!n.hasAttribute(o)&&(i[o]=a)}return i}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let n={};for(let i in e)t[i]||Object.assign(n,e[i].getShaderAttributes());return n}getAccessors(){return this.updateTriggers}_add(e,t,n={}){t&&Le.warn("AttributeManager.add({updaters}) - updater map no longer supported")();for(let i in e){let o=e[i];this.attributes[i]=this._createAttribute(i,o,n)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,n){let i={...t,id:e,isIndexed:t.isIndexed||t.elements||!1,constant:t.constant||!1,size:t.elements&&1||t.size||1,value:t.value||null,divisor:t.instanced||n.instanced?1:t.divisor||0};return new is(this.gl,i)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(i=>{e[i]||(e[i]=[]),e[i].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:n,updateTriggers:i}=this,o=i[e];return o&&o.forEach(a=>{let l=n[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:n}=e;if(tr(RD,t),t.constant){t.setConstantValue(t.value);return}t.allocate(n)&&tr(BD,t,n),t.updateBuffer(e)&&(this.needsRedraw=!0,tr(MD,t,n))}};var Cg=class extends Ti{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:n,duration:i,easing:o}}=this,a=o(e/i);this._value=qf(t,n,a)}};var qA=1e-5;function XA(s,e,t,n,i){let o=e-s,l=(t-e)*i,u=-o*n;return l+u+o+e}function ND(s,e,t,n,i){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=XA(s[a],e[a],t[a],n,i);return o}return XA(s,e,t,n,i)}function YA(s,e){if(Array.isArray(s)){let t=0;for(let n=0;n<s.length;n++){let i=s[n]-e[n];t+=i*i}return Math.sqrt(t)}return Math.abs(s-e)}var Ag=class extends Ti{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:n,stiffness:i}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=ND(o,a,t,n,i),u=YA(l,t),c=YA(l,a);u<qA&&c<qA&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var DD={interpolation:Cg,spring:Ag},vg=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,n,i){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(i=gg(i),!i)return;let a=DD[i.type];if(!a){Le.error("unsupported transition type '".concat(i.type,"'"))();return}let l=new a(this.timeline);l.start({...i,fromValue:t,toValue:n}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,n]of this.transitions)n.update(),e[t]=n.value,n.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function QA(s){let e=S0(s);for(let t in e){let n=e[t],{validate:i}=n;if(i&&!i(s[t],n))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function ZA(s,e){let t=KA({newProps:s,oldProps:e,propTypes:S0(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=_D(s,e),i=!1;return n||(i=FD(s,e)),{dataChanged:n,propsChanged:t,updateTriggersChanged:i,extensionsChanged:VD(s,e),transitionsChanged:GD(s,e)}}function GD(s,e){if(!s.transitions)return null;let t={},n=S0(s);for(let i in s.transitions){let o=n[i],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&y0(s[i],e[i],o)&&(t[i]=!0)}return t}function KA({newProps:s,oldProps:e,ignoreProps:t={},propTypes:n={},triggerName:i="props"}){if(e===s)return null;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(i," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(i,".").concat(o," added");let a=y0(s[o],e[o],n[o]);if(a)return"".concat(i,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(i,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=y0(s[o],e[o],n[o]);if(a)return"".concat(i,".").concat(o," ").concat(a)}}return null}function y0(s,e,t){let n=t&&t.equal;return n&&!n(s,e,t)||!n&&(n=s&&e&&s.equals,n&&!n.call(s,e))?"changed deeply":!n&&e!==s?"changed shallowly":null}function _D(s,e){if(e===null)return"oldProps is null, initial diff";let t=null,{dataComparator:n,_dataDiff:i}=s;return n?n(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&i&&(t=i(s.data,e.data)||t),t}function FD(s,e){if(e===null)return"oldProps is null, initial diff";if("all"in s.updateTriggers&&$A(s,e,"all"))return{all:!0};let t={},n=!1;for(let i in s.updateTriggers)i!=="all"&&$A(s,e,i)&&(t[i]=!0,n=t);return n}function VD(s,e){if(e===null)return!0;let t=e.extensions,{extensions:n}=s;if(n===t)return!1;if(!t||!n||n.length!==t.length)return!0;for(let i=0;i<n.length;i++)if(!n[i].equals(t[i]))return!0;return!1}function $A(s,e,t){let n=s.updateTriggers[t];n=n??{};let i=e.updateTriggers[t];return i=i??{},KA({oldProps:i,newProps:n,triggerName:t})}function S0(s){let e=s[Wl],t=e&&e.constructor;return t?t._propTypes:{}}var kD="count(): argument not an object",UD="count(): argument not a container";function JA(s){if(!WD(s))throw new Error(kD);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(zD(s))return Object.keys(s).length;throw new Error(UD)}function zD(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function WD(s){return s!==null&&typeof s=="object"}function ev(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(n=>n.name==="project64"))){let n=t.modules.findIndex(i=>i.name==="project32");n>=0&&t.modules.splice(n,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let n={...s.inject};for(let i in e.inject)n[i]=(n[i]||"")+e.inject[i];t.inject=n}return t}var HD={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},E0={};function tv(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Ot)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let n=null;e.compressed&&(n={[10241]:e.data.length>1?9985:9729});let i=new Ot(t,{...e,parameters:{...HD,...n,...s.props.textureParameters}});return E0[i.id]=!0,i}function rv(s){!s||!(s instanceof Ot)||E0[s.id]&&(s.delete(),delete E0[s.id])}var jD={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||Qc(s)&&(s.length===3||s.length===4)},equal(s,e,t){return x0(s,e)}},accessor:{validate(s,e){let t=Tg(s);return t==="function"||t===Tg(e.value)},equal(s,e,t){return typeof e=="function"?!0:x0(s,e)}},array:{validate(s,e){return e.optional&&!s||Qc(s)},equal(s,e,t){return t.compare?x0(s,e):s===e}},object:{equal(s,e,t){return t.compare?b0(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:n}=t.props;return n&&s?n(s):s}},image:{transform:(s,e,t)=>tv(t,s),release:s=>{rv(s)}}};function x0(s,e){if(s===e)return!0;if(!Qc(s)||!Qc(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}function nv(s){let e={},t={},n={};for(let[i,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)n[i]=Array.isArray(a)?a:[a];else{let l=qD(i,o);e[i]=l,t[i]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:n}}function qD(s,e){switch(Tg(e)){case"object":return $c(s,e);case"array":return $c(s,{type:"array",value:e,compare:!1});case"boolean":return $c(s,{type:"boolean",value:e});case"number":return $c(s,{type:"number",value:e});case"function":return $c(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function $c(s,e){return"type"in e?{name:s,...jD[e.type],...e}:"value"in e?{name:s,type:Tg(e.value),...e}:{name:s,type:"object",value:e}}function Qc(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function Tg(s){return Qc(s)?"array":s===null?"null":typeof s}function iv(s,e){let t=ov(s.constructor),n=Object.create(t);n[Wl]=s,n[vi]={},n[Wn]={};for(let i=0;i<e.length;++i){let o=e[i];for(let a in o)n[a]=o[a]}return Object.freeze(n),n}function ov(s){let e=Ig(s,"_mergedDefaultProps");return e||(XD(s),s._mergedDefaultProps)}function XD(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),n=ov(t),i=Ig(s,"defaultProps")||{},o=nv(i),a=YD(o.defaultProps,n,s),l={...t._propTypes,...o.propTypes};QD(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};$D(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function YD(s,e,t){let n=Object.create(null);Object.assign(n,e,s);let i=KD(t);return delete s.id,Object.defineProperties(n,{id:{writable:!0,value:i}}),n}function $D(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(n){let i="".concat(this.id,": ").concat(t);for(let o of e[t])sv(this,o)||(this[o]=n);Le.deprecated(i,e[t].join("/"))()}})}function QD(s,e){let t={},n={};for(let i in e){let o=e[i],{name:a,value:l}=o;o.async&&(t[a]=l,n[a]=ZD(a))}s[ao]=t,s[vi]={},Object.defineProperties(s,n)}function ZD(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||dg(e)?this[vi][s]=e:this[Wn][s]=e},get(){if(this[Wn]){if(s in this[Wn])return this[Wn][s]||this[ao][s];if(s in this[vi]){let e=this[Wl]&&this[Wl].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[ao][s]}}return this[ao][s]}}}function sv(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Ig(s,e){return sv(s,e)&&s[e]}function KD(s){let e=Ig(s,"layerName")||Ig(s,"componentName");return e||Le.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var JD=Object.freeze({}),jl=class{constructor(e){X(this,"component",void 0),X(this,"onAsyncPropUpdated",void 0),X(this,"asyncProps",void 0),X(this,"oldProps",void 0),X(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||JD}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[Wn]||{},n=e[vi]||e,i=e[ao]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,i[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in n){let a=n[o];this._createAsyncPropData(o,i[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return t}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(dg(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let n=this.asyncProps[e];return t===n.resolvedValue||t===n.lastValue?!1:(n.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let n=this.asyncProps[e];n&&(t=this._postProcessValue(n,t),n.resolvedValue=t,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(e,t,n){let i=this.asyncProps[e];i&&n>=i.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),i.resolvedValue=t,i.resolvedLoadCount=n,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let n=this.asyncProps[e];if(n){n.pendingLoadCount++;let i=n.pendingLoadCount;t.then(o=>{o=this._postProcessValue(n,o),this._setAsyncPropValue(e,o,i),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let n=this.asyncProps[e];if(!n)return;n.pendingLoadCount++;let i=n.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,i)}this._onResolve(e,o)}_postProcessValue(e,t){let n=e.type;return n&&(n.release&&n.release(e.resolvedValue,n,this.component),n.transform)?n.transform(t,n,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let i=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:i&&i[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var eG=0,ql=class{constructor(...e){X(this,"id",void 0),X(this,"props",void 0),X(this,"count",void 0),X(this,"lifecycle",void 0),X(this,"parent",void 0),X(this,"context",void 0),X(this,"state",void 0),X(this,"internalState",void 0),this.props=iv(this,e),this.id=this.props.id,this.count=eG++,this.lifecycle=NA.NO_STATE,this.parent=null,this.context=null,this.state=null,this.internalState=null,Object.seal(this)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}clone(e){let{props:t}=this,n={};for(let i in t[ao])i in t[Wn]?n[i]=t[Wn][i]:i in t[vi]&&(n[i]=t[vi][i]);return new this.constructor({...t,...n,...e})}_initState(){this.internalState=new jl(this)}};X(ql,"componentName","Component");X(ql,"defaultProps",{});var wg=class extends jl{constructor({attributeManager:e,layer:t}){super(t);X(this,"attributeManager",void 0),X(this,"needsRedraw",void 0),X(this,"subLayers",void 0),X(this,"usesPickingColorCache",void 0),this.attributeManager=e,this.needsRedraw=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let n=this.component.props.fetch;return n?n(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let n=this.component.props.onDataLoad;e==="data"&&n&&n(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var tG="layer.changeFlag",rG="layer.initialize",nG="layer.update",iG="layer.finalize",oG="layer.matched",av=2**24-1,sG=Object.freeze([]),aG=Vc(({oldViewport:s,viewport:e})=>s.equals(e)),Ii=new Uint8ClampedArray(0),lG={data:{type:"data",value:sG,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:n,loadOptions:i,signal:o})=>{let{resourceManager:a}=t.context;if(i=i||t.getLoadOptions(),n=n||t.props.loaders,o){var l;i={...i,fetch:{...(l=i)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!i&&(a.add({resourceId:s,data:qo(s,n),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>t.internalState.reloadAsyncProp(e,c),consumerId:t.id,requestId:e}):qo(s,n,i)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:t0.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Oe.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},_r=class extends ql{toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}raiseError(e,t){var n,i;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((n=(i=this.props).onError)!==null&&n!==void 0&&n.call(i,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(e=!0){this.internalState&&(this.internalState.needsRedraw=e)}setNeedsUpdate(){this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams())}hasUniformTransition(){return this.internalState.uniformTransitions.active}get isLoaded(){return this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||(this.state.model?[this.state.model]:[]))}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}project(e){let{viewport:t}=this.context,n=m0(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,o,a]=Vl(n,t.pixelProjectionMatrix);return e.length===2?[i,o]:[i,o,a]}unproject(e){let{viewport:t}=this.context;return t.unproject(e)}projectPosition(e,t){return MA(e,{viewport:this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Oe.DEFAULT||e===Oe.LNGLAT||e===Oe.CARTESIAN}onHover(e,t){return this.props.onHover?this.props.onHover(e,t):!1}onClick(e,t){return this.props.onClick?this.props.onClick(e,t):!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Hn(e instanceof Uint8Array);let[t,n,i]=e;return t+n*256+i*65536-1}initializeState(){throw new Error("Layer ".concat(this," has not defined initializeState"))}getShaders(e){for(let t of this.props.extensions)e=ev(e,t.getShaders.call(this,t));return e}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:n,instancePositions:i}=t.attributes;return(e=n||i)===null||e===void 0?void 0:e.getBounds()}shouldUpdateState({oldProps:e,props:t,context:n,changeFlags:i}){return i.propsOrDataChanged}updateState({oldProps:e,props:t,context:n,changeFlags:i}){let o=this.getAttributeManager();if(i.dataChanged&&o){let{dataChanged:u}=i;if(Array.isArray(u))for(let c of u)o.invalidateAll(c);else o.invalidateAll()}let a=Number.isInteger(e.highlightedObjectIndex)||e.pickable,l=Number.isInteger(t.highlightedObjectIndex)||t.pickable;if(a!==l&&o){let{pickingColors:u,instancePickingColors:c}=o.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,o.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(){for(let t of this.getModels())t.delete();let e=this.getAttributeManager();e&&e.finalize(),this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState.uniformTransitions.clear(),this.internalState.finalize()}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t}){let{index:n}=e;return n>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[n]),e}activateViewport(e){let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!aG({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all",t=""){let n=this.getAttributeManager();!n||(e==="all"?n.invalidateAll():n.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(e){let t=this.getAttributeManager();if(!t)return;let n=this.getNumInstances(e),i=this.getStartIndices(e);t.update({data:e.data,numInstances:n,startIndices:i,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this,ignoreUnknownAttributes:!0});let o=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),n=Object.create(this.props);for(let i in t)Object.defineProperty(n,i,{value:t[i]});return n}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let n=Math.floor(Ii.length/3);if(this.internalState.usesPickingColorCache=!0,n<t){t>av&&Le.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Ii=so.allocate(Ii,t,{size:3,copy:!0,maxCount:Math.max(t,av)});let i=Math.floor(Ii.length/3),o=[];for(let a=n;a<i;a++)this.encodePickingColor(a,o),Ii[a*3+0]=o[0],Ii[a*3+1]=o[1],Ii[a*3+2]=o[2]}e.value=Ii.subarray(0,t*3)}_setModelAttributes(e,t){let n=this.getAttributeManager(),i=e.userData.excludeAttributes||{},o=n.getShaderAttributes(t,i);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:n}=this.getAttributeManager().attributes,i=t||n,o=i.getVertexOffset(e),a=i.getVertexOffset(e+1);i.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,n=e||t;this.internalState.usesPickingColorCache&&n.value.buffer!==Ii.buffer&&(n.value=Ii.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0})}getNumInstances(e){return e=e||this.props,e.numInstances!==void 0?e.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:JA(e.data)}getStartIndices(e){return e=e||this.props,e.startIndices!==void 0?e.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}_initialize(){tr(rG,this),this._initState(),this.initializeState(this.context);for(let e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:!0,propsChanged:!0,viewportChanged:!0,extensionsChanged:!0}),this._updateState()}_update(){let e=this.needsUpdate();tr(nG,this,e),e&&this._updateState()}_updateState(){let e=this.props,t=this.context.viewport,n=this._updateUniformTransition();this.internalState.propsInTransition=n,this.context.viewport=this.internalState.viewport||t,this.props=n;try{let i=this._getUpdateParams(),o=this.getModels();if(this.context.gl)this.updateState(i);else try{this.updateState(i)}catch{}for(let l of this.props.extensions)l.updateState.call(this,i,l);let a=this.getModels()[0]!==o[0];this._updateModules(i,a),this.isComposite?this._renderLayers(i):(this.setNeedsRedraw(),this._updateAttributes(this.props),this.state.model&&this.state.model.setInstanceCount(this.getNumInstances()))}finally{this.context.viewport=t,this.props=e,this.clearChangeFlags(),this.internalState.needsUpdate=!1,this.internalState.resetOldProps()}}_finalize(){tr(iG,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}drawLayer({moduleParameters:e=null,uniforms:t={},parameters:n={}}){this._updateAttributeTransition();let i=this.props;this.props=this.internalState.propsInTransition||i;let{opacity:o}=this.props;t.opacity=Math.pow(o,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:a}=this.props,l=a&&a(t)||[0,0];sa(this.context.gl,{polygonOffset:l}),rr(this.context.gl,n,()=>{let u={moduleParameters:e,uniforms:t,parameters:n,context:this.context};for(let c of this.props.extensions)c.draw.call(this,u,c);this.draw(u)})}finally{this.props=i}}getChangeFlags(){return this.internalState.changeFlags}setChangeFlags(e){let{changeFlags:t}=this.internalState;for(let i in e)if(e[i]){let o=!1;switch(i){case"dataChanged":Array.isArray(t[i])&&(t[i]=Array.isArray(e[i])?t[i].concat(e[i]):e[i],o=!0);default:t[i]||(t[i]=e[i],o=!0)}o&&tr(tG,this,i,e)}let n=t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged;t.propsOrDataChanged=n,t.somethingChanged=n||e.viewportChanged||e.stateChanged}clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}diffProps(e,t){let n=ZA(e,t);if(n.updateTriggersChanged)for(let i in n.updateTriggersChanged)n.updateTriggersChanged[i]&&this.invalidateAttribute(i);if(n.transitionsChanged)for(let i in n.transitionsChanged)this.internalState.uniformTransitions.add(i,t[i],e[i],e.transitions[i]);return this.setChangeFlags(n)}validateProps(){QA(this.props)}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:n}=this.props;e.picked&&typeof n=="function"&&(t.pickingHighlightColor=n(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_updateModules({props:e,oldProps:t},n){let{autoHighlight:i,highlightedObjectIndex:o,highlightColor:a}=e;if(n||t.autoHighlight!==i||t.highlightedObjectIndex!==o||t.highlightColor!==a){let l={};i||(l.pickingSelectedColor=null),Array.isArray(a)&&(l.pickingHighlightColor=a),Number.isInteger(o)&&(l.pickingSelectedColor=o>=0?this.encodePickingColor(o):null),this.setModuleParameters(l)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let n=this.getAttributeManager(),i=n&&n.getNeedsRedraw(e);return t=t||i,t}_getAttributeManager(){return new xg(this.context.gl,{id:this.props.id,stats:this.context.stats,timeline:this.context.timeline})}_initState(){Hn(!this.internalState&&!this.state),Hn(isFinite(this.props.coordinateSystem));let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new wg({attributeManager:e,layer:this}),this.clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Le.deprecated("layer.state.attributeManager","layer.getAttributeManager()"),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new vg(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props)}_transferState(e){tr(oG,this,this===e);let{state:t,internalState:n}=e;this!==e&&(this.internalState=n,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this.diffProps(this.props,this.internalState.getOldProps()))}_onAsyncPropUpdated(){this.diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};_r.layerName="Layer";_r.defaultProps=lG;var uG="compositeLayer.renderLayers",wi=class extends _r{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}renderLayers(){return null}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:n}=this.props;return n&&n[e]&&n[e].type||t}getSubLayerRow(e,t,n){return e.__source={parent:this,object:t,index:n},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={data:this.props.data,target:[]};return(n,i)=>n&&n.__source?(t.index=n.__source.index,e(n.__source.object,t)):e(n,i)}return e}getSubLayerProps(e={}){let{opacity:t,pickable:n,visible:i,parameters:o,getPolygonOffset:a,highlightedObjectIndex:l,autoHighlight:u,highlightColor:c,coordinateSystem:h,coordinateOrigin:d,wrapLongitude:f,positionFormat:y,modelMatrix:S,extensions:C,fetch:T,operation:I,_subLayerProps:B}=this.props,w={opacity:t,pickable:n,visible:i,parameters:o,getPolygonOffset:a,highlightedObjectIndex:l,autoHighlight:u,highlightColor:c,coordinateSystem:h,coordinateOrigin:d,wrapLongitude:f,positionFormat:y,modelMatrix:S,extensions:C,fetch:T,operation:I},M=B&&B[e.id],F=M&&M.updateTriggers,U=e.id||"sublayer";if(M){let te=this.constructor._propTypes,re=e.type?e.type._propTypes:{};for(let J in M){let Pe=re[J]||te[J];Pe&&Pe.type==="accessor"&&(M[J]=this.getSubLayerAccessor(M[J]))}}Object.assign(w,e,M),w.id="".concat(this.props.id,"-").concat(U),w.updateTriggers={all:this.props.updateTriggers.all,...e.updateTriggers,...F};for(let te of C){let re=te.getSubLayerProps.call(this,te);re&&Object.assign(w,re,{updateTriggers:Object.assign(w.updateTriggers,re.updateTriggers)})}return w}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_renderLayers(){let{subLayers:e}=this.internalState,t=!e||this.needsUpdate();t&&(e=this.renderLayers(),e=DA(e,Boolean),this.internalState.subLayers=e),tr(uG,this,t,e);for(let n of e)n.parent=this}};wi.layerName="CompositeLayer";var Zc=class{constructor(e={}){let{attributes:t={}}=e;this.typedArrayManager=so,this.indexStarts=null,this.vertexStarts=null,this.vertexCount=0,this.instanceCount=0,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e),Object.seal(this)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:n={},getGeometry:i,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=i,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=n,this.normalize=u,o&&(Hn(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(n.positions=o)),this.geometryBuffer=n.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}normalizeGeometry(e){return e}updateGeometryAttributes(e,t,n){throw new Error("Not implemented")}getGeometrySize(e){throw new Error("Not implemented")}getGeometryFromBuffer(e){let t=e.value||e;return Hn(ArrayBuffer.isView(t)),fg(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices})}_allocate(e,t){let{attributes:n,buffers:i,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in i)a.release(n[l]),n[l]=null;else{let u=o[l];u.copy=t,n[l]=a.allocate(n[l],e,u)}}_forEachGeometry(e,t,n){let{data:i,getGeometry:o}=this,{iterable:a,objectInfo:l}=lo(i,t,n);for(let u of a){l.index++;let c=o(u,l);e(c,l.index)}}_rebuildGeometry(e){if(!this.data||!this.getGeometry)return;let{indexStarts:t,vertexStarts:n,instanceCount:i}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],n=[0]),this.normalize||!a)this._forEachGeometry((d,f)=>{d=this.normalizeGeometry(d),c[f]=d,n[f+1]=n[f]+this.getGeometrySize(d)},l,u),i=n[n.length-1];else if(a.buffer instanceof ge){let d=a.stride||this.positionSize*4;n=o.startIndices,i=n[o.length]||a.buffer.byteLength/d}else{let d=a.value||a,f=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;n=o.startIndices,i=n[o.length]||d.length/f}this._allocate(i,Boolean(e)),this.indexStarts=t,this.vertexStarts=n,this.instanceCount=i;let h={};this._forEachGeometry((d,f)=>{d=c[f]||d,h.vertexStart=n[f],h.indexStart=t[f];let y=f<n.length-1?n[f+1]:i;h.geometrySize=y-n[f],h.geometryIndex=f,this.updateGeometryAttributes(d,h)},l,u),this.vertexCount=t[t.length-1]}};var lv=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var uv=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var cG=1024,hG=4,cv=()=>{},dG={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function fG(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function gG(s,e,t,n){return t===e.width&&n===e.height?e:(s.canvas.height=n,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,n),s.canvas)}function Kc(s){return s&&(s.id||s.url)}function pG(s,e,t,n){let i=e.width,o=e.height,a=wl(e,{width:t,height:n});return Bf(e,a,{targetY:0,width:i,height:o}),e.delete(),a}function hv(s,e,t){for(let n=0;n<e.length;n++){let{icon:i,xOffset:o}=e[n],a=Kc(i);s[a]={...i,x:o,y:t}}}function mG({icons:s,buffer:e,mapping:t={},xOffset:n=0,yOffset:i=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=Kc(c);if(!t[h]){let{height:d,width:f}=c;n+f+e>a&&(hv(t,l,i),n=0,i=o+i+e,o=0,l=[]),l.push({icon:c,xOffset:n}),n=n+f+e,o=Math.max(o,d)}}return l.length>0&&hv(t,l,i),{mapping:t,rowHeight:o,xOffset:n,yOffset:i,canvasWidth:a,canvasHeight:fG(o+i+e)}}function bG(s,e,t){if(!s||!e)return null;t=t||{};let n={},{iterable:i,objectInfo:o}=lo(s);for(let a of i){o.index++;let l=e(a,o),u=Kc(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!n[u]&&(!t[u]||l.url!==t[u].url)&&(n[u]={...l,source:a,sourceIndex:o.index})}return n}var Lg=class{constructor(e,{onUpdate:t=cv,onError:n=cv}){this.gl=e,this.onUpdate=t,this.onError=n,this._loadOptions=null,this._getIcon=null,this._texture=null,this._externalTexture=null,this._mapping={},this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=hG,this._canvasWidth=cG,this._canvasHeight=0,this._canvas=null}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?Kc(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:n,iconMapping:i,data:o,getIcon:a}){e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),a&&(this._getIcon=a),i&&(this._mapping=i),n&&this._updateIconAtlas(n),this._autoPacking&&(o||a)&&typeof document<"u"&&(this._canvas=this._canvas||document.createElement("canvas"),this._updateAutoPacking(o))}get isLoaded(){return this._pendingCount===0}_updateIconAtlas(e){var t;(t=this._texture)===null||t===void 0||t.delete(),this._texture=null,this._externalTexture=e,this.onUpdate()}_updateAutoPacking(e){let t=Object.values(bG(e,this._getIcon,this._mapping)||{});if(t.length>0){let{mapping:n,xOffset:i,yOffset:o,rowHeight:a,canvasHeight:l}=mG({icons:t,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=n,this._xOffset=i,this._yOffset=o,this._canvasHeight=l,this._texture||(this._texture=new Ot(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:dG})),this._texture.height!==this._canvasHeight&&(this._texture=pG(this.gl,this._texture,this._canvasWidth,this._canvasHeight)),this.onUpdate(),this._loadIcons(t)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let n of e)this._pendingCount++,qo(n.url,mc,this._loadOptions).then(i=>{let o=Kc(n),{x:a,y:l,width:u,height:c}=this._mapping[o],h=gG(t,i,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(i=>{this.onError({url:n.url,source:n.source,sourceIndex:n.sourceIndex,loadOptions:this._loadOptions,error:i})}).finally(()=>{this._pendingCount--})}};var dv=[0,0,0,255],PG={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:dv},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},uo=class extends _r{getShaders(){return super.getShaders({vs:lv,fs:uv,modules:[Ai,rs]})}initializeState(){this.state={iconManager:new Lg(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:dv},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState({oldProps:e,props:t,changeFlags:n}){super.updateState({props:t,oldProps:e,changeFlags:n});let i=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:l,getIcon:u}=t,{iconManager:c}=this.state;c.setProps({loadOptions:t.loadOptions});let h=!1;if(o||this.internalState.isAsyncPropLoading("iconAtlas")?(e.iconAtlas!==t.iconAtlas&&c.setProps({iconAtlas:o,autoPacking:!1}),e.iconMapping!==t.iconMapping&&(c.setProps({iconMapping:a}),h=!0)):c.setProps({autoPacking:!0}),(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&c.setProps({data:l,getIcon:u}),h&&(i.invalidate("instanceOffsets"),i.invalidate("instanceIconFrames"),i.invalidate("instanceColorModes")),n.extensionsChanged){var f;let{gl:y}=this.context;(f=this.state.model)===null||f===void 0||f.delete(),this.state.model=this._getModel(y),i.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(){super.finalizeState(),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:An[o],sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new jr(e,{...this.getShaders(),id:this.props.id,geometry:new xn({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){let{onIconError:t}=this.getCurrentLayer().props;t?t(e):Le.error(e.error)()}getInstanceOffset(e){let t=this.state.iconManager.getIconMapping(e);return[t.width/2-t.anchorX||0,t.height/2-t.anchorY||0]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let t=this.state.iconManager.getIconMapping(e);return[t.x||0,t.y||0,t.width||0,t.height||0]}};uo.layerName="IconLayer";uo.defaultProps=PG;function ba(s,e){let t=e.length,n=s.length;if(n>0){let i=!0;for(let o=0;o<t;o++)if(s[n-t+o]!==e[o]){i=!1;break}if(i)return!1}for(let i=0;i<t;i++)s[n+i]=e[i];return!0}function Og(s,e){let t=e.length;for(let n=0;n<t;n++)s[n]=e[n]}function Jc(s,e,t,n,i=[]){let o=n+e*t;for(let a=0;a<t;a++)i[a]=s[o+a];return i}function C0(s,e,t,n,i=[]){let o,a;if(t&8)o=(n[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(n[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(n[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(n[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)i[l]=(a&1)===l?n[a]:o*(e[l]-s[l])+s[l];return i}function Rg(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function eh(s,e={}){let{size:t=2,broken:n=!1,gridResolution:i=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e,u=(l-a)/t,c=[],h=[c],d=Jc(s,0,t,a),f,y,S=EG(d,i,o,[]),C=[];ba(c,d);for(let T=1;T<u;T++){for(f=Jc(s,T,t,a,f),y=Rg(f,S);y;){C0(d,f,y,S,C);let I=Rg(C,S);I&&(C0(d,C,I,S,C),y=I),ba(c,C),Og(d,C),xG(S,i,y),n&&c.length>t&&(c=[],h.push(c),ba(c,d)),y=Rg(f,S)}ba(c,f),Og(d,f)}return n?h:h[0]}function EG(s,e,t,n){let i=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return n[0]=i,n[1]=o,n[2]=i+e,n[3]=o+e,n}function xG(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function A0(s,e={}){let{size:t=2,startIndex:n=0,endIndex:i=s.length,normalize:o=!0}=e,a=s.slice(n,i);AG(a,t,0,i-n);let l=eh(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)vG(u,t);return l}function AG(s,e,t,n){let i=s[0],o;for(let a=t;a<n;a+=e){o=s[a];let l=o-i;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=i=o}}function vG(s,e){let t,n=s.length/e;for(let o=0;o<n&&(t=s[o*e],(t+180)%360===0);o++);let i=-Math.round(t/360)*360;if(i!==0)for(let o=0;o<n;o++)s[o*e]+=i}function gv(s,e,t,n){let i=s;if(Array.isArray(s[0])){let o=s.length*e;i=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)i[a*e+l]=s[a][l]||0}return t?eh(i,{size:e,gridResolution:t}):n?A0(i,{size:e}):i}var IG=1,wG=2,v0=4,Bg=class extends Zc{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):()=>null}normalizeGeometry(e){return this.normalize?gv(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}get(e){return this.attributes[e]}getGeometrySize(e){if(Array.isArray(e[0])){let n=0;for(let i of e)n+=this.getGeometrySize(i);return n}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&Array.isArray(e[0]))for(let n of e){let i=this.getGeometrySize(n);t.geometrySize=i,this.updateGeometryAttributes(n,t),t.vertexStart+=i}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let{segmentTypes:n}=this.attributes,i=this.isClosed(e),{vertexStart:o,geometrySize:a}=t;n.fill(0,o,o+a),i?(n[o]=v0,n[o+a-2]=v0):(n[o]+=IG,n[o+a-2]+=wG),n[o+a-1]=v0}_updatePositions(e,t){let{positions:n}=this.attributes;if(!n)return;let{vertexStart:i,geometrySize:o}=t,a=new Array(3);for(let l=i,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),n[l*3]=a[0],n[l*3+1]=a[1],n[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,n=[]){let{positionSize:i}=this;t*i>=e.length&&(t+=1-e.length/i);let o=t*i;return n[0]=e[o],n[1]=e[o+1],n[2]=i===3&&e[o+2]||0,n}isClosed(e){if(!this.normalize)return this.opts.loop;let{positionSize:t}=this,n=e.length-t;return e[0]===e[n]&&e[1]===e[n+1]&&(t===2||e[2]===e[n+2])}};var pv=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  vec2 dir = isEnd ? dirA : dirB;
  vec2 perp = isEnd ? perpA : perpB;
  float L = isEnd ? lenA : lenB;
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var mv=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var bv=[0,0,0,255],LG={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:bv},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},T0={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},os=class extends _r{getShaders(){return super.getShaders({vs:pv,fs:mv,modules:[Ai,rs]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:T0,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:T0,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:T0,defaultValue:bv},instancePickingColors:{size:3,type:5121,accessor:(n,{index:i,target:o})=>this.encodePickingColor(n&&n.__source?n.__source.index:i,o)}}),this.setState({pathTesselator:new Bg({fp64:this.use64bitPositions()})}),this.props.getDashArray&&!this.props.extensions.length&&Le.removed("getDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:n}){super.updateState({props:t,oldProps:e,changeFlags:n});let i=this.getAttributeManager();if(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:n.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),n.dataChanged||i.invalidateAll()}if(n.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),i.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:n}=t,{data:i}=this.props;return i[0]&&i[0].__source&&(t.object=i.find(o=>o.__source.index===n)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let n=0;n<t.length;n++)t[n].__source.index===e&&this._disablePickingIndex(n);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:n,billboard:i,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(n),billboard:i,widthUnits:An[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],n=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new jr(e,{...this.getShaders(),id:this.props.id,geometry:new xn({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(n),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};os.layerName="PathLayer";os.defaultProps=LG;var Pv=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var yv=192/256,Sv=[],OG={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},Xl=class extends uo{getShaders(){return{...super.getShaders(),fs:Pv}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:n,target:i})=>this.encodePickingColor(n,i)}})}updateState(e){super.updateState(e);let{props:t,oldProps:n}=e,{outlineColor:i}=t;i!==n.outlineColor&&(i=i.map(o=>o/255),i[3]=Number.isFinite(i[3])?i[3]:1,this.setState({outlineColor:i})),!t.sdf&&t.outlineWidth&&Le.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:n,outlineWidth:i}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:yv,outlineBuffer:i?Math.max(n,yv*(1-i)):-1,gamma:n,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).map(t=>super.getInstanceOffset(t)):Sv}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).map(t=>super.getInstanceIconFrame(t)):Sv}};Xl.layerName="MultiIconLayer";Xl.defaultProps=OG;var Rv=ne(Cv());var MG=32,NG=[];function DG(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function Av({characterSet:s,getFontWidth:e,fontHeight:t,buffer:n,maxCanvasWidth:i,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a,h=0;for(let f of s)if(!o[f]){let y=e(f,h++);c+y+n*2>i&&(c=0,u++),o[f]={x:c+n,y:l+u*(t+n*2)+n,width:y,height:t},c+=y+n*2}let d=t+n*2;return{mapping:o,xOffset:c,yOffset:l+u*d,canvasHeight:DG(l+(u+1)*d)}}function vv(s,e,t,n){let i=0;for(let o=e;o<t;o++){let a=s[o],l=null,u=n&&n[a];u&&(l=u.width),i+=l}return i}function Tv(s,e,t,n,i,o){let a=e,l=0;for(let u=e;u<t;u++){let c=vv(s,u,u+1,i);l+c>n&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function GG(s,e,t,n,i,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=vv(s,l,u,i);c+d>n&&(a<l&&(o.push(l),a=l,c=0),d>n&&(d=Tv(s,l,u,n,i,o),a=o[o.length-1])),l=u,c+=d}return c}function _G(s,e,t,n,i=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?Tv(s,i,o,t,n,a):GG(s,i,o,t,n,a),a}function FG(s,e,t,n,i,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=n[c];h?(l||(l=h.height),i[u]=a+h.width/2,a+=h.width):(Le.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),i[u]=a,a+=MG)}o[0]=a,o[1]=l}function w0(s,e,t,n,i){s=Array.from(s);let o=s.length,a=new Array(o),l=new Array(o),u=new Array(o),c=(t==="break-word"||t==="break-all")&&isFinite(n)&&n>0,h=[0,0],d=[],f=0,y=0,S=0;for(let C=0;C<=o;C++){let T=s[C];if((T===`
`||C===o)&&(S=C),S>y){let I=c?_G(s,t,n,i,y,S):NG;for(let B=0;B<=I.length;B++){let w=B===0?y:I[B-1],M=B<I.length?I[B]:S;FG(s,w,M,i,a,d);for(let F=w;F<M;F++)l[F]=f+d[1]/2,u[F]=d[0];f=f+d[1]*e,h[0]=Math.max(h[0],d[0])}y=S}T===`
`&&(a[y]=0,l[y]=0,u[y]=0,y++)}return h[1]=f,{x:a,y:l,rowWidth:u,size:h}}function Iv({value:s,length:e,stride:t,offset:n,startIndices:i,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=n?n/a:0,c=i[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),f=s;if(l>1||u>0){f=new s.constructor(c);for(let y=0;y<c;y++)f[y]=s[y*l+u]}for(let y=0;y<e;y++){let S=i[y],C=i[y+1]||c,T=f.subarray(S,C);d[y]=String.fromCodePoint.apply(null,T),h&&T.forEach(h.add,h)}if(h)for(let y of h)o.add(String.fromCodePoint(y));return{texts:d,characterCount:c}}var rh=class{constructor(e=5){this.limit=e,this.clear()}clear(){this._cache={},this._order=[]}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(this._deleteCache(e),this._deleteOrder(e))}_deleteCache(e){delete this._cache[e]}_deleteOrder(e){let t=this._order.findIndex(n=>n===e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function VG(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var L0=VG(),O0="Monaco, monospace",R0="normal",B0=64,M0=4,N0=.25,D0=12,wv=1024,kG=.9,Lv=1.2,Bv=3,Mg=new rh(Bv),UG=["fontFamily","fontWeight","characterSet","fontSize","sdf","buffer","cutoff","radius"];function zG(s,e){let t=Mg.get(s);if(!t)return e;let n=[],i=t.mapping,o=Object.keys(i);o=new Set(o);let a=e;return a instanceof Array&&(a=new Set(a)),a.forEach(l=>{o.has(l)||n.push(l)}),n}function WG(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function Ov(s,e,t,n){s.font="".concat(n," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="baseline",s.textAlign="left"}function Mv(s){Le.assert(Number.isFinite(s)&&s>=Bv,"Invalid cache limit"),Mg=new rh(s)}var Ng=class{constructor(){this.props={fontFamily:O0,fontWeight:R0,characterSet:L0,fontSize:B0,buffer:M0,sdf:!1,cutoff:N0,radius:D0},this._key=null,this._atlas=null}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return Lv}setProps(e={}){UG.forEach(a=>{a in e&&(this.props[a]=e[a])});let t=this._key;this._key=this._getKey();let n=zG(this._key,this.props.characterSet),i=Mg.get(this._key);if(i&&n.length===0){this._key!==t&&(this._atlas=i);return}let o=this._generateFontAtlas(this._key,n,i);this._atlas=o,Mg.set(this._key,o)}_generateFontAtlas(e,t,n){let{fontFamily:i,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=n&&n.data;d||(d=document.createElement("canvas"),d.width=wv);let f=d.getContext("2d");Ov(f,i,a,o);let{mapping:y,canvasHeight:S,xOffset:C,yOffset:T}=Av({getFontWidth:I=>f.measureText(I).width,fontHeight:a*Lv,buffer:l,characterSet:t,maxCanvasWidth:wv,...n&&{mapping:n.mapping,xOffset:n.xOffset,yOffset:n.yOffset}});if(d.height!==S){let I=f.getImageData(0,0,d.width,d.height);d.height=S,f.putImageData(I,0,0)}if(Ov(f,i,a,o),u){let I=new Rv.default(a,l,c,h,i,o),B=f.getImageData(0,0,I.size,I.size);for(let w of t)WG(I.draw(w),B),f.putImageData(B,y[w].x-l,y[w].y+l)}else for(let I of t)f.fillText(I,y[I].x,y[I].y+a*kG);return{xOffset:C,yOffset:T,mapping:y,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:n,buffer:i,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(n," ").concat(i," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(n," ").concat(i)}};var Nv=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var Dv=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var HG={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},$l=class extends _r{getShaders(){return super.getShaders({vs:Nv,fs:Dv,modules:[Ai,rs]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState({props:e,oldProps:t,changeFlags:n}){if(super.updateState({props:e,oldProps:t,changeFlags:n}),n.extensionsChanged){var i;let{gl:o}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(o),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:n,sizeUnits:i,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:An[i],sizeScale:n,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new jr(e,{...this.getShaders(),id:this.props.id,geometry:new xn({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};$l.layerName="TextBackgroundLayer";$l.defaultProps=HG;var Gv={fontSize:B0,buffer:M0,sdf:!1,radius:D0,cutoff:N0,smoothing:.1},_v={start:1,middle:0,end:-1},Fv={top:1,center:0,bottom:-1},G0=[0,0,0,255],jG=1,qG=["fontSize","buffer","sdf","radius","cutoff"],XG={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:G0},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:L0},fontFamily:O0,fontWeight:R0,lineHeight:jG,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:G0},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:G0},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},ss=class extends wi{initializeState(){this.state={styleVersion:0,fontAtlasManager:new Ng}}updateState({props:e,oldProps:t,changeFlags:n}){let i=n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText),o=this.state.characterSet;i&&this._updateText();let a=o!==this.state.characterSet||this._fontChanged(t,e);a&&this._updateFontAtlas(t,e),(a||e.lineHeight!==t.lineHeight||e.wordBreak!==t.wordBreak||e.maxWidth!==t.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(e,t){let{fontSettings:n,fontFamily:i,fontWeight:o}=t,{fontAtlasManager:a,characterSet:l}=this.state;a.setProps({...Gv,...n,characterSet:l,fontFamily:i,fontWeight:o})}_fontChanged(e,t){if(e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight)return!0;if(e.fontSettings===t.fontSettings)return!1;let n=e.fontSettings||{},i=t.fontSettings||{};return qG.some(o=>n[o]!==i[o])}_updateText(){let{data:e,characterSet:t}=this.props,n=e.attributes&&e.attributes.getText,{getText:i}=this.props,{startIndices:o}=e,a,l=t==="auto"&&new Set;if(n&&o){let{texts:u,characterCount:c}=Iv({...ArrayBuffer.isView(n)?{value:n}:n,length:e.length,startIndices:o,characterSet:l});a=c,i=(h,{index:d})=>u[d]}else{let{iterable:u,objectInfo:c}=lo(e);o=[0],a=0;for(let h of u){c.index++;let d=Array.from(i(h,c)||"");l&&d.forEach(l.add,l),a+=d.length,o.push(a)}}this.setState({getText:i,startIndices:o,numInstances:a,characterSet:l||t})}getBoundingRect(e,t){let n=this.state.fontAtlasManager.mapping,{getText:i}=this.state,{wordBreak:o,maxWidth:a,lineHeight:l,getTextAnchor:u,getAlignmentBaseline:c}=this.props,h=i(e,t)||"",{size:[d,f]}=w0(h,l,o,a,n),y=_v[typeof u=="function"?u(e,t):u],S=Fv[typeof c=="function"?c(e,t):c];return[(y-1)*d/2,(S-1)*f/2,d,f]}getIconOffsets(e,t){let n=this.state.fontAtlasManager.mapping,{getText:i}=this.state,{wordBreak:o,maxWidth:a,lineHeight:l,getTextAnchor:u,getAlignmentBaseline:c}=this.props,h=i(e,t)||"",{x:d,y:f,rowWidth:y,size:[S,C]}=w0(h,l,o,a,n),T=_v[typeof u=="function"?u(e,t):u],I=Fv[typeof c=="function"?c(e,t):c],B=d.length,w=new Array(B*2),M=0;for(let F=0;F<B;F++){let U=(1-T)*(S-y[F])/2;w[M++]=(T-1)*S/2+U+d[F],w[M++]=(I-1)*C/2+f[F]}return w}renderLayers(){let{startIndices:e,numInstances:t,getText:n,fontAtlasManager:{scale:i,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:f,getAngle:y,getPixelOffset:S,getBackgroundColor:C,getBorderColor:T,getBorderWidth:I,backgroundPadding:B,background:w,billboard:M,fontSettings:F,outlineWidth:U,outlineColor:te,sizeScale:re,sizeUnits:J,sizeMinPixels:Pe,sizeMaxPixels:Ce,transitions:he,updateTriggers:pe}=this.props,ie=this.getSubLayerClass("characters",Xl),Fr=this.getSubLayerClass("background",$l);return[w&&new Fr({getFillColor:C,getLineColor:T,getLineWidth:I,padding:B,getPosition:h,getSize:f,getAngle:y,getPixelOffset:S,billboard:M,sizeScale:re/this.state.fontAtlasManager.props.fontSize,sizeUnits:J,sizeMinPixels:Pe,sizeMaxPixels:Ce,transitions:he&&{getPosition:he.getPosition,getAngle:he.getAngle,getSize:he.getSize,getFillColor:he.getBackgroundColor,getLineColor:he.getBorderColor,getLineWidth:he.getBorderWidth,getPixelOffset:he.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:pe.getPosition,getAngle:pe.getAngle,getSize:pe.getSize,getFillColor:pe.getBackgroundColor,getLineColor:pe.getBorderColor,getLineWidth:pe.getBorderWidth,getPixelOffset:pe.getPixelOffset,getBoundingRect:{getText:pe.getText,getTextAnchor:pe.getTextAnchor,getAlignmentBaseline:pe.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect.bind(this)}),new ie({sdf:F.sdf,smoothing:Number.isFinite(F.smoothing)?F.smoothing:Gv.smoothing,outlineWidth:U,outlineColor:te,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:f,getAngle:y,getPixelOffset:S,billboard:M,sizeScale:re*i,sizeUnits:J,sizeMinPixels:Pe*i,sizeMaxPixels:Ce*i,transitions:he&&{getPosition:he.getPosition,getAngle:he.getAngle,getColor:he.getColor,getSize:he.getSize,getPixelOffset:he.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:pe.getText,getPosition:pe.getPosition,getAngle:pe.getAngle,getColor:pe.getColor,getSize:pe.getSize,getPixelOffset:pe.getPixelOffset,getIconOffsets:{getText:pe.getText,getTextAnchor:pe.getTextAnchor,getAlignmentBaseline:pe.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets.bind(this),getIcon:n})]}static set fontAtlasCacheLimit(e){Mv(e)}};ss.layerName="TextLayer";ss.defaultProps=XG;var Ql={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var YG={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColor:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},$G=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceDepths;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  applyHighlight(int(instanceDepths.r));
}
`,QG=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Pa=class extends _r{getShaders(){return super.getShaders({vs:$G,fs:QG,modules:[Ai,Dl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:Ql.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:Ql.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:Ql.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:Ql.UNSIGNED_BYTE,accessor:"getShape"}})}updateState(e){var a;super.updateState(e);let{props:t,oldProps:n,changeFlags:i}=e,o=!1;if(i.extensionsChanged){let{gl:l}=this.context;(a=this.state.model)==null||a.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),o=!0}if((o||t.getDepth!==n.getDepth)&&t.getDepth&&this.state.model.setAttributes({instanceDepths:t.getDepth}),o||t.highlightColor!==n.highlightColor){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=t.highlightColor[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:n,cornerRadius:i,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:n,cornerRadius:i,lineWidthUnits:An[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new jr(e,{...this.getShaders(),id:this.props.id,geometry:new xn({drawMode:Ql.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};Pa.defaultProps=YG,Pa.layerName="GeometryLayer";function nh(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!nh(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(let i of t)if(!e.hasOwnProperty(i)||!nh(s[i],e[i]))return!1;return!0}return!1}function Vv(s){if(s instanceof je){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}var Dg=class extends wi{renderLayers(){return[new Pa(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:0,cornerRadius:ZG(this.props.data[0]),getLineColor:kv,getFillColor:KG}),new ss(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof je)||t.labelSize),getPosition:e=>Vv(e),getText:e=>Ht.getDrawingObj(e.node).labelText,getColor:kv,getSize:this.props.getTextSize,sizeMaxPixels:48,sizeUnits:"common",characterSet:"auto"})]}};Dg.defaultProps={...ss.defaultProps,...Pa.defaultProps,getDepth:null,getTextSize:{type:"accessor",value:16}};function ZG(s){return s?Ht.getDrawingObj(s.node).xRad:0}function kv(s){let e=ut.getDrawingObj(s.node);if(e){let t=e.color;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function KG(s){let e=ut.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}var JG="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",_0=4,Uv=qo(JG,mc,{imagebitmap:{resizeWidth:256*_0,resizeHeight:128*_0}}),zv=e_({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},_0);function e_(s,e){for(let t in s){let n=s[t];n.x*=e,n.y*=e,n.width*=e,n.height*=e,n.anchorX&&(n.anchorX*=e),n.anchorY&&(n.anchorY*=e)}return s}var Gg=class extends wi{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let t=[];for(let n of e.props.data){let i=n;i.sourceArrowhead&&t.push({edge:n,type:"triangle-n",tip:i.sourceArrowhead.tipPosition,end:i.curve.start}),i.targetArrowhead&&t.push({edge:n,type:"triangle-n",tip:i.targetArrowhead.tipPosition,end:i.curve.end})}this.setState({arrows:t})}}renderLayers(){let e=this.props;return[new os(e,this.getSubLayerProps({id:"path"}),{getPath:t=>Array.from(_h(t.curve,.01)).map(n=>[n.x,n.y]),getColor:Wv,widthUnits:"pixels"}),new uo(this.getSubLayerProps({id:"arrow"}),{data:this.state.arrows,iconAtlas:Uv,iconMapping:zv,getPosition:t=>[t.tip.x,t.tip.y],getColor:t=>Wv(t.edge),getIcon:t=>t.type,getSize:t=>t_(t.tip,t.end),getAngle:t=>r_(t.tip,t.end),sizeUnits:"common"})]}};Gg.defaultProps={...os.defaultProps};function Wv(s){let e=ut.getDrawingObj(s.edge);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function t_(s,e){let t=s.x-e.x,n=s.y-e.y;return Math.sqrt(t*t+n*n)}function r_(s,e){let t=s.x-e.x,n=s.y-e.y;return-Math.atan2(n,t)/Math.PI*180}function _g(s,e,t=!1){let n=!1,i=t,o=je.getGeom(s.graph);function a(l){if(!l)return;for(let h of l.subgraphs())a(h);let u=n_(s,l,e),c=i_(l.layoutSettings,u);i=i||c.layoutChanged,n=n||c.routingChanged,l.layoutSettings=u}if(a(o),i||n)for(let l of o.deepEdges())l.requireRouting();return i?rb(o,null):n&&Hs(o,Array.from(o.deepEdges()),null),o}function n_(s,e,t){let n=!1;for(let o of e.edges())if(o.sourceArrowhead!=null||o.targetArrowhead!=null){n=!0;break}let i;switch(t.layoutType){case"Sugiyama LR":{let o=i=new Cr;o.layerDirection=1;break}case"Sugiyama RL":{let o=i=new Cr;o.layerDirection=3;break}case"Sugiyama TB":{let o=i=new Cr;o.layerDirection=0;break}case"Sugiyama BT":{let o=i=new Cr;o.layerDirection=2;break}case"MDS":i=new hi;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.nodeCollection.edgeCount>4e3;if(n&&!o){let a=i=new Cr;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else i=new hi}}return t.edgeRoutingMode==null?i instanceof Cr?i.edgeRoutingSettings.EdgeRoutingMode=3:i.edgeRoutingSettings.EdgeRoutingMode=0:i.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,i}function i_(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.edgeRoutingSettings.EdgeRoutingMode!==e.edgeRoutingSettings.EdgeRoutingMode,n=t&&e.edgeRoutingSettings.EdgeRoutingMode===3,i=s instanceof Cr&&e instanceof Cr&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||n||i,routingChanged:t}}var ya=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:n,fontStyle:i,fontWeight:o}=this.opts;this.ctx.font=`${i} ${o} ${n}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:n,lineHeight:i}=this.opts,o=n*1.2,a=n*(i-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new Bt(l,u.length*o+(u.length-1)*a)}};var EEe=new Uint8Array(4);var jg=ne(Tt()),TT=ne(AT()),Hg=class{bind(){this.entity&&this.entity.setAttr(Hg.attachIndex,this)}constructor(e,t){this.entity=e,this.svgData=t,this.bind()}static getGeom(e){return e.getAttr(Hg.attachIndex)}},z0=Hg;z0.attachIndex=2;var ah=class{constructor(e,t=!1){this._textMeasurer=new ya;this.transformRequired=t,this.container=e}getSvgString(){return this.svg==null?null:new XMLSerializer().serializeToString(this.svg)}clearContainer(){for(;this.container.childNodes.length>0;)this.container.removeChild(this.container.firstChild)}setGraph(e){if(this.clearContainer(),this.graph=e,this.svg=sh(this.graph,"svg"),this.svg.setAttribute("style","border: 1px solid black"),this.geomGraph=je.getGeom(this.graph),!this.geomGraph)return null;this.geomGraph.updateBoundingBox(),this.open();for(let t of this.graph.deepNodes)this.drawNode(t);for(let t of this.graph.deepEdges())this.drawEdge(t);this.close(),this.container.appendChild(this.svg),(0,TT.default)(this.svg)}drawEdge(e){let t=sh(e,"g"),n=document.createElementNS(Wg,"path");t.appendChild(n),n.setAttribute("fill","none");let i=Pn.getDrawingObj(e);this.setStroke(n,i);let o=Ge.getGeom(e);n.setAttribute("d",vT(o.curve));for(let a of this.AddArrows(e))t.appendChild(a);this.DrawEdgeLabel(e),this.svg.appendChild(t)}DrawEdgeLabel(e){let t=Pn.getDrawingObj(e),i=Ge.getGeom(e).label;!i||this.drawLabelAtXY(t,i.boundingBox)}*AddArrows(e){let t=Ge.getGeom(e),n=t.curve,i=this.AddArrowhead(e,t.sourceArrowhead,n.start);i&&(yield i),i=this.AddArrowhead(e,t.targetArrowhead,n.end),i&&(yield i)}AddArrowhead(e,t,n){if(!t)return;let i=sh(e,"polygon"),o=Pn.getDrawingObj(e);this.setStroke(i,o);let a=W_(n,t.tipPosition);return i.setAttribute("points",wT(a)),i}setStroke(e,t){let n=zg(t.color);e.setAttribute("stroke",n),e.setAttribute("stroke-opacity",(t.color?t.color.A/255:1).toString()),e.setAttribute("stroke-width",t.penwidth.toString())}drawNode(e){let n=De.getGeom(e).boundaryCurve;!n||this.drawNodeOnCurve(n,e)}drawNodeOnCurve(e,t){let n=ut.getDrawingObj(t);if(n.shape!=5&&(this.makePathOnCurve(t,n,e),n.shape==10)){let i=e,o=i.aAxis.length-2*n.penwidth;i=ve.mkCircle(o,i.center),this.makePathOnCurve(t,n,i)}this.drawLabel(t,n)}makePathOnCurve(e,t,n){var o,a;let i=sh(e,"path");if(t.styles.find(l=>l==5)){let l=(a=(o=t.fillColor)!=null?o:t.color)!=null?a:Ht.defaultFillColor;i.setAttribute("fill",zg(l))}else i.setAttribute("fill","none");i.setAttribute("d",vT(n)),i.setAttribute("stroke",zg(t.color)),i.setAttribute("stroke-width",t.penwidth.toString()),this.svg.appendChild(i)}drawLabel(e,t){if(!!t&&!(!t.labelText||t.labelText.length==0))if(t instanceof Ht)this.writeLabelText(e,t.measuredTextSize);else throw new Error("not implemented")}writeLabelText(e,t){let n=$r.getGeom(e),i=ut.getDrawingObj(e),a=e instanceof We?k.creatRectangleWithSize(t,new p(n.center.x,n.boundingBox.bottom+t.height/2+i.LabelMargin)):k.creatRectangleWithSize(t,n.center);this.drawLabelAtXY(i,a)}drawLabelAtXY(e,t){let n=e.fontsize,i=sh(e.attrCont,"text");i.setAttribute("text-anchor","middle"),i.setAttribute("x",t.center.x.toString()),i.setAttribute("fill",zg(e.fontColor)),i.setAttribute("font-family",e.fontname),i.setAttribute("font-size",n.toString()+"px"),this.createTspans(e.labelText,i,n,t),this.svg.appendChild(i)}createTspans(e,t,n,i){let o=`
`,a=e.split(o);if(a.length==1){let l=document.createElementNS(Wg,"tspan");t.appendChild(l),l.textContent=e,l.setAttribute("text-anchor","middle"),l.setAttribute("x",i.center.x.toString()),l.setAttribute("alignment-baseline","middle"),l.setAttribute("y",i.center.y.toString())}else{let l=i.bottom+1;for(let u=0;u<a.length;u++){let c=document.createElementNS(Wg,"tspan");t.appendChild(c),c.textContent=a[u],c.setAttribute("text-anchor","middle"),c.setAttribute("x",i.center.x.toString()),c.setAttribute("alignment-baseline","hanging"),c.setAttribute("y",l.toString()),l+=1.21*n}}}close(){if(this.transformRequired)throw new Error("not implemented")}open(){if(this.svg.setAttribute("width",this.geomGraph.width),this.svg.setAttribute("height",this.geomGraph.height),this.transformRequired)throw new Error("not implemented")}};ah.arrowAngle=25;var Wg="http://www.w3.org/2000/svg";function vT(s){return jg.String.Join(" ",Array.from(F_(s)))}function*F_(s){if(yield"M",yield Sa(s.start),s instanceof v)for(let t of s.segs)yield U_(t);else if(s instanceof R)yield"L",yield Sa(s.end);else if(s instanceof Ne)yield IT(s);else if(s instanceof $){let o=s;for(let a of o.skip(1))yield"L",yield Sa(a.point);o.closed&&(yield"L",yield Sa(o.start))}else if(s instanceof fe){let a=s;V_(a)?(yield W0(new fe(0,Math.PI,a.aAxis,a.bAxis,a.center)),yield W0(new fe(Math.PI,Math.PI*2,a.aAxis,a.bAxis,a.center))):this.ellipseToString(a)}}function V_(s){return s.parEnd==Math.PI*2&&s.parStart==0}function Sa(s){return lh(s.x)+" "+lh(s.y)}function lh(s){return Math.abs(s)<1e-11?"0":s.toString()}function IT(s){return"C"+wT([s.B(1),s.B(2),s.B(3)])}function W0(s){let e=Math.abs(s.parEnd-s.parStart)>=Math.PI?"1":"0",t=s.orientedCounterclockwise()?"1":"0";return jg.String.Join(" ","A",k_(s),lh(p.angle(new p(1,0),s.aAxis)/(Math.PI/180)),e,t,Sa(s.end))}function k_(s){return lh(s.aAxis.length)+","+lh(s.bAxis.length)}function wT(s){return jg.String.Join(" ",s.map(e=>Sa(e)))}function U_(s){if(s instanceof R)return z_(s);if(s instanceof Ne)return IT(s);if(s instanceof fe)return W0(s);throw new Error("NotImplementedException")}function z_(s){return"L "+Sa(s.end)}function zg(s){return s?"rgba("+s.R+","+s.G+","+s.B+","+s.A/255+")":"Black"}function W_(s,e){let t=e.sub(s),n=t;t=t.normalize();let i=new p(-t.y,t.x),o=n.length*Math.tan(ah.arrowAngle*.5*(Math.PI/180));return i=i.mul(o),[s.add(i),e,s.sub(i)]}function sh(s,e){let t=document.createElementNS(Wg,e);return new z0(s,t),t}var qg=class{constructor(e=document.body){this._layoutOptions={};this._textMeasurer=new ya,this._svgCreator=new ah(e)}getSvgString(){return this._svgCreator.getSvgString()}get graph(){return this._graph}setGraph(e,t=this._layoutOptions){if(this._graph===e)this.setOptions(t);else{this._graph=e,this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{});let n=_n.getDrawingObj(e)||new _n(e);n.createGeometry(this._textMeasurer.measure),_g(n,this._layoutOptions,!0),this._update()}}setOptions(e){let t=this._layoutOptions.label,n=e.label,i=!nh(t,n);if(this._layoutOptions=e,!this._graph)return;let o=_n.getDrawingObj(this._graph);i&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=i;_g(o,this._layoutOptions,a),this._update()}_update(){if(!!this._graph)return this._svgCreator.setGraph(this._graph)}getSvg(){return this._svgCreator?this._svgCreator.svg:null}};var H_=document.getElementById("viewer"),j_="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/abstract.gv",co=new qg(H_),LT=Z_();LT.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+LT.value;MT(s).then(e=>(co.setGraph(e,Jl()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)};var OT=Q_();OT.onchange=()=>{co.setOptions(Jl())};var RT=$_();RT.onchange=()=>{co.setOptions(Jl())};var BT=Y_();BT.onchange=()=>{co.setOptions(Jl())};var q_=document.getElementById("save-svg");q_.onclick=()=>{let s=co.getSvgString();X_(co.graph.id+".svg",s)};function X_(s,e){let t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download",s),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}Py("drop-target",async s=>{K_(s).then(e=>(co.setGraph(e,Jl()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)});(async()=>{let s=await MT(j_);co.setOptions(Jl()),co.setGraph(s),document.getElementById("graph-name").innerText=s.id})();function Y_(){let s=document.getElementById("fonts");for(let e of ux){let t=document.createElement("option");t.value=e,t.innerText=e,t.style.fontFamily=e,s.appendChild(t)}return s}function $_(){let s=document.getElementById("layouts");for(let e in Ib){let t=document.createElement("option");t.value=e,t.innerText=Ib[e],s.appendChild(t)}return s}function Q_(){let s=document.getElementById("routings");for(let e in Tb){let t=document.createElement("option");t.value=e,t.innerText=Tb[e],s.appendChild(t)}return s}function Z_(){let s=document.getElementById("gv");for(let e of lx){let t=document.createElement("option");t.value=`${e}.gv`,t.innerText=e,s.appendChild(t)}return s}function Jl(){let s={label:{fontFamily:BT.value}};switch(RT.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;default:break}switch(OT.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}async function MT(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),n;if(e.endsWith(".json")){let i=await t.json();n=tf(i)}else{let i=await t.text();n=ef(i)}return n.id=e,n}async function K_(s){let e=await s.text(),t;return s.name.endsWith(".json")?t=tf(JSON.parse(e)):t=ef(e),t.id=s.name,t}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)
   
   Copyright (c) .NET Foundation and Contributors
   
   All rights reserved.
   
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:
   
   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.
   
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   NOTE: The `murmur3` algorithm is public domain.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
