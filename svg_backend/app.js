(()=>{var LT=Object.create;var ym=Object.defineProperty;var OT=Object.getOwnPropertyDescriptor;var RT=Object.getOwnPropertyNames;var BT=Object.getPrototypeOf,NT=Object.prototype.hasOwnProperty;var kt=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),GT=(s,e)=>{for(var t in e)ym(s,t,{get:e[t],enumerable:!0})},MT=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of RT(e))!NT.call(s,i)&&i!==t&&ym(s,i,{get:()=>e[i],enumerable:!(n=OT(e,i))||n.enumerable});return s};var Ae=(s,e,t)=>(t=s!=null?LT(BT(s)):{},MT(e||!s||!s.__esModule?ym(t,"default",{value:s,enumerable:!0}):t,s));var xm=kt(Xh=>{"use strict";Object.defineProperty(Xh,"__esModule",{value:!0});var l0=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,n=!1){if(n&&this.isDuplicate(e))return!1;let i=new Gu(e),o=this._head;if(o)for(;;){if(o.value===t)return i.next=o.next,i.prev=o,o.next=i,i.next?i.next.prev=i:this._tail=i,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let n=new Gu(e);return this._tail?(this._tail.next=n,n.prev=this._tail,this._tail=n):this._head=this._tail=n,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let n=new Gu(e);return this._head?(n.next=this._head,this._head.prev=n,this._head=n):this._head=this._tail=n,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),n=[],i=Math.min(e,this.length);for(let o=0;o<i;o++){let a=t.next();n.push(a.value)}return n}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Xh.LinkedList=l0;var Gu=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Xh.LinkedListItem=Gu});var Qn=kt(Am=>{"use strict";Object.defineProperty(Am,"__esModule",{value:!0});var jT=xm(),u0=class extends jT.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};Am.Queue=u0});var Ln=kt(Lm=>{"use strict";Object.defineProperty(Lm,"__esModule",{value:!0});var qT=xm(),h0=class extends qT.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};Lm.Stack=h0});var Ut=kt(Ho=>{"use strict";var Zh=Ho&&Ho.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var n=Array(s),i=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,i++)n[i]=o[a];return n};Object.defineProperty(Ho,"__esModule",{value:!0});Ho.StringBuilder=Ho.String=void 0;var ll=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{var i=t[0];if(Array.isArray(i)||i instanceof Array){for(var o=s.Empty,a=0,l=0;l<i.length;l++){var u=i[l];l<i.length-1?o+=u+e:o+=u}return o}else if(typeof i=="object"){var c=s.Empty,h=i,d=Object.keys(i);return d.forEach(function(P){c+=h[P]+e}),c=c.slice(0,c.length-e.length),c}var m=t;return s.join.apply(s,Zh([e],m))}catch(P){return console.log(P),s.Empty}},s.Format=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(i){return console.log(i),s.Empty}},s.format=function(e,t,n,i){return i===void 0&&(i=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return i?u=n[0][a]:u=n[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var n=t.replace(/,/g,".");if(isNaN(parseFloat(n))||n.length<=3)break;var i=n.split(/[^0-9]+/g),o=i;i.length>1&&(o=[s.join.apply(s,Zh([""],i.splice(0,i.length-1))),i[i.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var n=parseFloat(e),i=n.toString(16);return t?i.toLocaleUpperCase():i},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var n=t[t.length-1],i=t[t.length-2],o=t[t.length-3];return n=n.split("T")[0],n=n.split(" ")[0],n+"."+i+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var n=t[t.length-1].split(" "),i=s.Empty;n.length>1&&(i=n[n.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(i)&&i.length>1?u+="T"+i:u+="T00:00:00",u},s.formatNumber=function(e,t){var n=t.length,i=e.toString();if(n<=i.length)return i;var o=n-i.length;return o+=1,new Array(o).join("0")+i},s.join=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var i=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];i+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){i+=e,o=l-1;break}}return i},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();Ho.String=ll;var eI=function(){function s(e){this.Values=[],ll.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.Values.push(ll.Format.apply(ll,Zh([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.Values.push(`\r
`+ll.Format.apply(ll,Zh([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();Ho.StringBuilder=eI});var kA=kt((A0e,ZP)=>{"use strict";ZP.exports=nh;ZP.exports.default=nh;var au=1e20;function nh(s,e,t,n,i,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=n||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function CN(s,e,t,n,i,o,a){o.fill(au,0,e*t),a.fill(0,0,e*t);for(var l=(e-n)/2,u=0;u<i;u++)for(var c=0;c<n;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*n+c)+3]/255;if(d===1)o[h]=0,a[h]=au;else if(d===0)o[h]=au,a[h]=0;else{var m=Math.max(0,.5-d),P=Math.max(0,d-.5);o[h]=m*m,a[h]=P*P}}}function xN(s,e,t,n,i,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(n[l])-Math.sqrt(i[l]);s[l]=Math.round(255-255*(u/o+a))}}nh.prototype._draw=function(s,e){var t=this.ctx.measureText(s),n=t.width,i=2*this.buffer,o,a,l,u,c,h,d,m;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),m=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+i,l=u+i,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,m=this.middle,this.ctx.textBaseline="middle");var P;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,m),P=this.ctx.getImageData(d,h,a,u));var S=new Uint8ClampedArray(o*l);return CN(P,o,l,a,u,this.gridOuter,this.gridInner),_A(this.gridOuter,o,l,this.f,this.v,this.z),_A(this.gridInner,o,l,this.f,this.v,this.z),xN(S,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:S,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:n}}};nh.prototype.draw=function(s){return this._draw(s,!1).data};nh.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function _A(s,e,t,n,i,o){for(var a=0;a<e;a++)VA(s,a,e,t,n,i,o);for(var l=0;l<t;l++)VA(s,l*e,1,e,n,i,o)}function VA(s,e,t,n,i,o,a){var l,u,c,h;for(o[0]=0,a[0]=-au,a[1]=au,l=0;l<n;l++)i[l]=s[e+l*t];for(l=1,u=0,c=0;l<n;l++){do h=o[u],c=(i[l]-i[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=au}for(l=0,u=0;l<n;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=i[h]+(l-h)*(l-h)}}});var hv=kt((fAe,cv)=>{"use strict";function oG(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function Ha(s,e,t,n){this.message=s,this.expected=e,this.found=t,this.location=n,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Ha)}oG(Ha,Error);Ha.buildMessage=function(s,e){var t={literal:function(c){return'"'+i(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function n(c){return c.charCodeAt(0).toString(16).toUpperCase()}function i(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+n(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+n(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+n(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+n(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,m;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,m=1;d<h.length;d++)h[d-1]!==h[d]&&(h[m]=h[d],m++);h.length=m}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+i(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function sG(s,e){e=e!==void 0?e:{};var t={},n={start:Hy},i=Hy,o="strict",a=Ie("strict",!0),l="graph",u=Ie("graph",!0),c="digraph",h=Ie("digraph",!0),d="{",m=Ie("{",!1),P="}",S=Ie("}",!1),v=function(p,E,N,B){B===null&&(B=[]);var W={type:E.toLowerCase(),children:B};return p&&(W.strict=!0),N&&(W.id=N),W},I=";",L=Ie(";",!1),D=function(p,E){return E},w=function(p,E){return[p].concat(E)},M="=",K=Ie("=",!1),X=function(p,E){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:p,eq:E}]}},se="node",Te=Ie("node",!0),pe="edge",G=Ie("edge",!0),O=function(p,E){return{type:"attr_stmt",target:p,attr_list:E}},V="[",U=Ie("[",!1),Z="]",te=Ie("]",!1),le=function(p,E){return(p||[]).concat(E||[])},ge=function(p,E){return E},Ne=",",Pt=Ie(",",!1),Zt=function(p,E,N){return[{type:"attr",id:p,eq:E}].concat(N||[])},Vr=function(p,E,N){var B=[p];return B=B.concat(E.map(function(W){return W.id})),{type:"edge_stmt",edge_list:B,attr_list:N||[]}},Ms="->",Ah=Ie("->",!1),Eu="--",vh=Ie("--",!1),kg=function(p,E,N){return[{type:"edgeRHS",edgeop:p,id:E}].concat(N||[])},Ug=function(p,E){return{type:"node_stmt",node_id:p,attr_list:E||[]}},Wg=function(p,E){return E?{type:"node_id",id:p,port:E}:{type:"node_id",id:p}},zg=yi("port"),Yn=":",Cu=Ie(":",!1),Hg=function(p,E){return E},jg=function(p,E){return{type:"port",id:p,compass_pt:E||null}},qg=function(p){return{type:"port",compass_pt:p||null}},Xg="subgraph",Yg=Ie("subgraph",!0),Kg=function(p){return p?{type:"subgraph",id:p}:{type:"subgraph"}},Qg=function(p,E){return p=p||{type:"subgraph"},p.children=E||[],p},Jg="n",Zg=Ie("n",!1),Th="ne",xu=Ie("ne",!1),Ih="e",Au=Ie("e",!1),vu="se",$g=Ie("se",!1),em="s",Tu=Ie("s",!1),Iu="sw",Ka=Ie("sw",!1),tm="w",rm=Ie("w",!1),no="nw",nm=Ie("nw",!1),im=yi("UNICODE_STRING"),wh=function(p,E){return p+E.join("")},Lh=function(p,E){return p+E},om="$",sm=Ie("$",!1),Oh="_",am=Ie("_",!1),Rh=yi("NUMBER"),lm="-",um=Ie("-",!1),Bh=".",wu=Ie(".",!1),io=/^[0-9]/,In=fn([["0","9"]],!1,!1),Nh=function(p){return parseFloat(Uy())},Qa=function(p){return{type:"id",value:p.slice(1,p.length-1),html:!0}},Ja="<",Za=Ie("<",!1),$a=">",el=Ie(">",!1),Gh=function(p){return"<"+p.join("")+">"},hn=nT(),oo=function(p){return p},Mh=function(p){return p.join("")},dn='"',_o=Ie('"',!1),Dh=function(p){return p.join("")},Ds=function(){return Uy()},so="\\",ao=Ie("\\",!1),Fh=function(p){return p[1]==='"'?'"':p[0]+p[1]},Lu=function(){return""},Ou=/^[\n\r\u2028\u2029]/,cm=fn([`
`,"\r","\u2028","\u2029"],!1,!1),Vo=yi("end of line"),_=`
`,J=Ie(`
`,!1),$=`\r
`,ne=Ie(`\r
`,!1),Me="\r",Ze=Ie("\r",!1),$e="\u2028",qt=Ie("\u2028",!1),ko="\u2029",lo=Ie("\u2029",!1),_h=/^[^"\\\0-\x1F\x7F]/,Vh=fn(['"',"\\",["\0",""],"\x7F"],!0,!1),By='\\"',O1=Ie('\\"',!1),R1=function(){return'"'},B1=function(){return"\\"},N1=yi("COMMENT"),G1=yi("BLOCK_COMMENT"),Ny="/*",M1=Ie("/*",!1),tl="*/",hm=Ie("*/",!1),Gy=function(p){return p},D1=function(p){return p.join("")},F1=yi("C_COMMENT"),My="//",_1=Ie("//",!1),rl=/^[\n]/,nl=fn([`
`],!1,!1),Dy=function(p){return p.join("")},V1=yi("MACRO_COMMENT"),k1="#",U1=Ie("#",!1),W1=yi("WHITESPACE"),Fy=/^[\n\r]/,_y=fn([`
`,"\r"],!1,!1),Vy=/^[ \t]/,ky=fn([" ","	"],!1,!1),z1=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,H1=fn([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),j1=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,q1=fn([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),X1=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,Y1=fn(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),K1=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,Q1=fn(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),J1=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,Z1=fn([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),$1=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,eT=fn([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),tT=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,rT=fn([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),y=0,Se=0,kh=[{line:1,column:1}],Pi=0,dm=[],k=0,Uh;if("startRule"in e){if(!(e.startRule in n))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');i=n[e.startRule]}function Uy(){return s.substring(Se,y)}function JM(){return Ru(Se,y)}function ZM(p,E){throw E=E!==void 0?E:Ru(Se,y),zy([yi(p)],s.substring(Se,y),E)}function $M(p,E){throw E=E!==void 0?E:Ru(Se,y),oT(p,E)}function Ie(p,E){return{type:"literal",text:p,ignoreCase:E}}function fn(p,E,N){return{type:"class",parts:p,inverted:E,ignoreCase:N}}function nT(){return{type:"any"}}function iT(){return{type:"end"}}function yi(p){return{type:"other",description:p}}function Wy(p){var E=kh[p],N;if(E)return E;for(N=p-1;!kh[N];)N--;for(E=kh[N],E={line:E.line,column:E.column};N<p;)s.charCodeAt(N)===10?(E.line++,E.column=1):E.column++,N++;return kh[p]=E,E}function Ru(p,E){var N=Wy(p),B=Wy(E);return{start:{offset:p,line:N.line,column:N.column},end:{offset:E,line:B.line,column:B.column}}}function j(p){y<Pi||(y>Pi&&(Pi=y,dm=[]),dm.push(p))}function oT(p,E){return new Ha(p,null,null,E)}function zy(p,E,N){return new Ha(Ha.buildMessage(p,E),p,E,N)}function Hy(){var p,E;if(p=[],E=jy(),E!==t)for(;E!==t;)p.push(E),E=jy();else p=t;return p}function jy(){var p,E,N,B,W,q,ue,yt,St,Ei,gn,Pm,o0;return p=y,E=nt(),E!==t?(s.substr(y,6).toLowerCase()===o?(N=s.substr(y,6),y+=6):(N=t,k===0&&j(a)),N===t&&(N=null),N!==t?(B=nt(),B!==t?(s.substr(y,5).toLowerCase()===l?(W=s.substr(y,5),y+=5):(W=t,k===0&&j(u)),W===t&&(s.substr(y,7).toLowerCase()===c?(W=s.substr(y,7),y+=7):(W=t,k===0&&j(h))),W!==t?(q=nt(),q!==t?(ue=Si(),ue===t&&(ue=null),ue!==t?(yt=nt(),yt!==t?(s.charCodeAt(y)===123?(St=d,y++):(St=t,k===0&&j(m)),St!==t?(Ei=qy(),Ei===t&&(Ei=null),Ei!==t?(gn=nt(),gn!==t?(s.charCodeAt(y)===125?(Pm=P,y++):(Pm=t,k===0&&j(S)),Pm!==t?(o0=nt(),o0!==t?(Se=p,E=v(N,W,ue,Ei),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function qy(){var p,E,N,B,W,q,ue,yt,St,Ei,gn;if(p=y,E=nt(),E!==t)if(N=fm(),N!==t)if(B=nt(),B!==t)if(s.charCodeAt(y)===59?(W=I,y++):(W=t,k===0&&j(L)),W===t&&(W=null),W!==t){for(q=[],ue=y,yt=nt(),yt!==t?(St=fm(),St!==t?(Ei=nt(),Ei!==t?(s.charCodeAt(y)===59?(gn=I,y++):(gn=t,k===0&&j(L)),gn===t&&(gn=null),gn!==t?(Se=ue,yt=D(N,St),ue=yt):(y=ue,ue=t)):(y=ue,ue=t)):(y=ue,ue=t)):(y=ue,ue=t);ue!==t;)q.push(ue),ue=y,yt=nt(),yt!==t?(St=fm(),St!==t?(Ei=nt(),Ei!==t?(s.charCodeAt(y)===59?(gn=I,y++):(gn=t,k===0&&j(L)),gn===t&&(gn=null),gn!==t?(Se=ue,yt=D(N,St),ue=yt):(y=ue,ue=t)):(y=ue,ue=t)):(y=ue,ue=t)):(y=ue,ue=t);q!==t?(Se=p,E=w(N,q),p=E):(y=p,p=t)}else y=p,p=t;else y=p,p=t;else y=p,p=t;else y=p,p=t;return p}function fm(){var p,E,N,B,W,q;return p=y,E=Si(),E!==t?(N=nt(),N!==t?(s.charCodeAt(y)===61?(B=M,y++):(B=t,k===0&&j(K)),B!==t?(W=nt(),W!==t?(q=Si(),q!==t?(Se=p,E=X(E,q),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p===t&&(p=sT(),p===t&&(p=aT(),p===t&&(p=mm(),p===t&&(p=lT(),p===t&&(p=y,E=Si(),E!==t?(s.charCodeAt(y)===61?(N=M,y++):(N=t,k===0&&j(K)),N!==t?(B=Si(),B!==t?(E=[E,N,B],p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)))))),p}function sT(){var p,E,N;return p=y,s.substr(y,5).toLowerCase()===l?(E=s.substr(y,5),y+=5):(E=t,k===0&&j(u)),E===t&&(s.substr(y,4).toLowerCase()===se?(E=s.substr(y,4),y+=4):(E=t,k===0&&j(Te)),E===t&&(s.substr(y,4).toLowerCase()===pe?(E=s.substr(y,4),y+=4):(E=t,k===0&&j(G)))),E!==t?(N=Wh(),N!==t?(Se=p,E=O(E,N),p=E):(y=p,p=t)):(y=p,p=t),p}function Wh(){var p,E,N,B,W,q,ue,yt,St;return p=y,E=nt(),E!==t?(s.charCodeAt(y)===91?(N=V,y++):(N=t,k===0&&j(U)),N!==t?(B=nt(),B!==t?(W=Xy(),W===t&&(W=null),W!==t?(q=nt(),q!==t?(s.charCodeAt(y)===93?(ue=Z,y++):(ue=t,k===0&&j(te)),ue!==t?(yt=nt(),yt!==t?(St=Wh(),St===t&&(St=null),St!==t?(Se=p,E=le(W,St),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function Xy(){var p,E,N,B,W,q,ue,yt;return p=y,E=nt(),E!==t?(N=Si(),N!==t?(B=y,W=nt(),W!==t?(s.charCodeAt(y)===61?(q=M,y++):(q=t,k===0&&j(K)),q!==t?(ue=nt(),ue!==t?(yt=Si(),yt!==t?(Se=B,W=ge(N,yt),B=W):(y=B,B=t)):(y=B,B=t)):(y=B,B=t)):(y=B,B=t),B===t&&(B=null),B!==t?(W=nt(),W!==t?(s.charCodeAt(y)===44?(q=Ne,y++):(q=t,k===0&&j(Pt)),q===t&&(s.charCodeAt(y)===59?(q=I,y++):(q=t,k===0&&j(L))),q===t&&(q=null),q!==t?(ue=Xy(),ue===t&&(ue=null),ue!==t?(Se=p,E=Zt(N,B,ue),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function aT(){var p,E,N,B;return p=y,E=mm(),E===t&&(E=gm()),E!==t?(N=Yy(),N!==t?(B=Wh(),B===t&&(B=null),B!==t?(Se=p,E=Vr(E,N,B),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function Yy(){var p,E,N,B,W,q,ue;return p=y,E=nt(),E!==t?(s.substr(y,2)===Ms?(N=Ms,y+=2):(N=t,k===0&&j(Ah)),N===t&&(s.substr(y,2)===Eu?(N=Eu,y+=2):(N=t,k===0&&j(vh))),N!==t?(B=nt(),B!==t?(W=mm(),W===t&&(W=gm()),W!==t?(q=nt(),q!==t?(ue=Yy(),ue===t&&(ue=null),ue!==t?(Se=p,E=kg(N,W,ue),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function lT(){var p,E,N;return p=y,E=gm(),E!==t?(N=Wh(),N===t&&(N=null),N!==t?(Se=p,E=Ug(E,N),p=E):(y=p,p=t)):(y=p,p=t),p}function gm(){var p,E,N;return p=y,E=Si(),E!==t?(N=uT(),N===t&&(N=null),N!==t?(Se=p,E=Wg(E,N),p=E):(y=p,p=t)):(y=p,p=t),p}function uT(){var p,E,N,B,W,q;return k++,p=y,s.charCodeAt(y)===58?(E=Yn,y++):(E=t,k===0&&j(Cu)),E!==t?(N=Si(),N!==t?(B=y,s.charCodeAt(y)===58?(W=Yn,y++):(W=t,k===0&&j(Cu)),W!==t?(q=Ky(),q!==t?(Se=B,W=Hg(N,q),B=W):(y=B,B=t)):(y=B,B=t),B===t&&(B=null),B!==t?(Se=p,E=jg(N,B),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p===t&&(p=y,s.charCodeAt(y)===58?(E=Yn,y++):(E=t,k===0&&j(Cu)),E!==t?(N=Ky(),N!==t?(Se=p,E=qg(N),p=E):(y=p,p=t)):(y=p,p=t)),k--,p===t&&(E=t,k===0&&j(zg)),p}function mm(){var p,E,N,B,W,q;return p=y,E=y,s.substr(y,8).toLowerCase()===Xg?(N=s.substr(y,8),y+=8):(N=t,k===0&&j(Yg)),N!==t?(B=nt(),B!==t?(W=Si(),W===t&&(W=null),W!==t?(q=nt(),q!==t?(Se=E,N=Kg(W),E=N):(y=E,E=t)):(y=E,E=t)):(y=E,E=t)):(y=E,E=t),E===t&&(E=null),E!==t?(s.charCodeAt(y)===123?(N=d,y++):(N=t,k===0&&j(m)),N!==t?(B=qy(),B===t&&(B=null),B!==t?(W=nt(),W!==t?(s.charCodeAt(y)===125?(q=P,y++):(q=t,k===0&&j(S)),q!==t?(Se=p,E=Qg(E,B),p=E):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t)):(y=p,p=t),p}function Ky(){var p;return s.charCodeAt(y)===110?(p=Jg,y++):(p=t,k===0&&j(Zg)),p===t&&(s.substr(y,2)===Th?(p=Th,y+=2):(p=t,k===0&&j(xu)),p===t&&(s.charCodeAt(y)===101?(p=Ih,y++):(p=t,k===0&&j(Au)),p===t&&(s.substr(y,2)===vu?(p=vu,y+=2):(p=t,k===0&&j($g)),p===t&&(s.charCodeAt(y)===115?(p=em,y++):(p=t,k===0&&j(Tu)),p===t&&(s.substr(y,2)===Iu?(p=Iu,y+=2):(p=t,k===0&&j(Ka)),p===t&&(s.charCodeAt(y)===119?(p=tm,y++):(p=t,k===0&&j(rm)),p===t&&(s.substr(y,2)===no?(p=no,y+=2):(p=t,k===0&&j(nm))))))))),p}function Si(){var p;return p=Qy(),p===t&&(p=cT(),p===t&&(p=$y(),p===t&&(p=dT(),p===t&&(p=hT())))),p}function Qy(){var p,E,N,B;if(k++,p=y,E=Jy(),E!==t){for(N=[],B=Zy();B!==t;)N.push(B),B=Zy();N!==t?(Se=p,E=wh(E,N),p=E):(y=p,p=t)}else y=p,p=t;return k--,p===t&&(E=t,k===0&&j(im)),p}function cT(){var p,E,N;return p=y,E=$y(),E!==t?(N=Qy(),N!==t?(Se=p,E=Lh(E,N),p=E):(y=p,p=t)):(y=p,p=t),p}function Jy(){var p;return p=ET(),p===t&&(s.charCodeAt(y)===36?(p=om,y++):(p=t,k===0&&j(sm)),p===t&&(s.charCodeAt(y)===95?(p=Oh,y++):(p=t,k===0&&j(am)))),p}function Zy(){var p;return p=Jy(),p===t&&(p=wT()),p}function $y(){var p,E,N,B,W,q,ue,yt,St;if(k++,p=y,E=y,s.charCodeAt(y)===45?(N=lm,y++):(N=t,k===0&&j(um)),N===t&&(N=null),N!==t){if(B=y,s.charCodeAt(y)===46?(W=Bh,y++):(W=t,k===0&&j(wu)),W!==t){if(q=[],io.test(s.charAt(y))?(ue=s.charAt(y),y++):(ue=t,k===0&&j(In)),ue!==t)for(;ue!==t;)q.push(ue),io.test(s.charAt(y))?(ue=s.charAt(y),y++):(ue=t,k===0&&j(In));else q=t;q!==t?(W=[W,q],B=W):(y=B,B=t)}else y=B,B=t;if(B===t){if(B=y,W=[],io.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(In)),q!==t)for(;q!==t;)W.push(q),io.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(In));else W=t;if(W!==t){if(q=y,s.charCodeAt(y)===46?(ue=Bh,y++):(ue=t,k===0&&j(wu)),ue!==t){for(yt=[],io.test(s.charAt(y))?(St=s.charAt(y),y++):(St=t,k===0&&j(In));St!==t;)yt.push(St),io.test(s.charAt(y))?(St=s.charAt(y),y++):(St=t,k===0&&j(In));yt!==t?(ue=[ue,yt],q=ue):(y=q,q=t)}else y=q,q=t;q===t&&(q=null),q!==t?(W=[W,q],B=W):(y=B,B=t)}else y=B,B=t}B!==t?(N=[N,B],E=N):(y=E,E=t)}else y=E,E=t;return E!==t&&(Se=p,E=Nh(E)),p=E,k--,p===t&&(E=t,k===0&&j(Rh)),p}function hT(){var p,E;return p=y,E=pm(),E!==t&&(Se=p,E=Qa(E)),p=E,p}function pm(){var p,E,N,B;if(p=y,s.charCodeAt(y)===60?(E=Ja,y++):(E=t,k===0&&j(Za)),E!==t){for(N=[],B=e0(),B===t&&(B=pm());B!==t;)N.push(B),B=e0(),B===t&&(B=pm());N!==t?(s.charCodeAt(y)===62?(B=$a,y++):(B=t,k===0&&j(el)),B!==t?(Se=p,E=Gh(N),p=E):(y=p,p=t)):(y=p,p=t)}else y=p,p=t;return p}function e0(){var p,E,N,B,W;if(p=y,E=[],N=y,B=y,k++,s.charCodeAt(y)===62?(W=$a,y++):(W=t,k===0&&j(el)),W===t&&(s.charCodeAt(y)===60?(W=Ja,y++):(W=t,k===0&&j(Za))),k--,W===t?B=void 0:(y=B,B=t),B!==t?(s.length>y?(W=s.charAt(y),y++):(W=t,k===0&&j(hn)),W!==t?(Se=N,B=oo(W),N=B):(y=N,N=t)):(y=N,N=t),N!==t)for(;N!==t;)E.push(N),N=y,B=y,k++,s.charCodeAt(y)===62?(W=$a,y++):(W=t,k===0&&j(el)),W===t&&(s.charCodeAt(y)===60?(W=Ja,y++):(W=t,k===0&&j(Za))),k--,W===t?B=void 0:(y=B,B=t),B!==t?(s.length>y?(W=s.charAt(y),y++):(W=t,k===0&&j(hn)),W!==t?(Se=N,B=oo(W),N=B):(y=N,N=t)):(y=N,N=t);else E=t;return E!==t&&(Se=p,E=Mh(E)),p=E,p}function dT(){var p,E,N,B;if(p=y,s.charCodeAt(y)===34?(E=dn,y++):(E=t,k===0&&j(_o)),E!==t){for(N=[],B=t0();B!==t;)N.push(B),B=t0();N!==t?(s.charCodeAt(y)===34?(B=dn,y++):(B=t,k===0&&j(_o)),B!==t?(Se=p,E=Dh(N),p=E):(y=p,p=t)):(y=p,p=t)}else y=p,p=t;return p}function t0(){var p,E,N;return p=fT(),p===t&&(p=y,E=y,k++,s.charCodeAt(y)===34?(N=dn,y++):(N=t,k===0&&j(_o)),N===t&&(N=mT()),k--,N===t?E=void 0:(y=E,E=t),E!==t?(N=bT(),N!==t?(Se=p,E=Ds(),p=E):(y=p,p=t)):(y=p,p=t),p===t&&(p=gT())),p}function fT(){var p,E,N,B;return p=y,E=y,s.charCodeAt(y)===92?(N=so,y++):(N=t,k===0&&j(ao)),N!==t?(s.length>y?(B=s.charAt(y),y++):(B=t,k===0&&j(hn)),B!==t?(N=[N,B],E=N):(y=E,E=t)):(y=E,E=t),E!==t&&(Se=p,E=Fh(E)),p=E,p}function gT(){var p,E,N;return p=y,s.charCodeAt(y)===92?(E=so,y++):(E=t,k===0&&j(ao)),E!==t?(N=pT(),N!==t?(Se=p,E=Lu(),p=E):(y=p,p=t)):(y=p,p=t),p}function mT(){var p;return Ou.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(cm)),p}function pT(){var p,E;return k++,s.charCodeAt(y)===10?(p=_,y++):(p=t,k===0&&j(J)),p===t&&(s.substr(y,2)===$?(p=$,y+=2):(p=t,k===0&&j(ne)),p===t&&(s.charCodeAt(y)===13?(p=Me,y++):(p=t,k===0&&j(Ze)),p===t&&(s.charCodeAt(y)===8232?(p=$e,y++):(p=t,k===0&&j(qt)),p===t&&(s.charCodeAt(y)===8233?(p=ko,y++):(p=t,k===0&&j(lo)))))),k--,p===t&&(E=t,k===0&&j(Vo)),p}function bT(){var p;return s.length>y?(p=s.charAt(y),y++):(p=t,k===0&&j(hn)),p}function eD(){var p,E,N;if(p=y,E=[],N=r0(),N!==t)for(;N!==t;)E.push(N),N=r0();else E=t;return E!==t&&(Se=p,E=Dh(E)),p=E,p}function r0(){var p,E,N;return _h.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(Vh)),p===t&&(p=y,s.substr(y,2)===By?(E=By,y+=2):(E=t,k===0&&j(O1)),E!==t&&(Se=p,E=R1()),p=E,p===t&&(p=y,s.charCodeAt(y)===92?(E=so,y++):(E=t,k===0&&j(ao)),E!==t?(N=bm(),N!==t?(Se=p,E=Lu(),p=E):(y=p,p=t)):(y=p,p=t),p===t&&(p=y,s.charCodeAt(y)===92?(E=so,y++):(E=t,k===0&&j(ao)),E!==t&&(Se=p,E=B1()),p=E))),p}function n0(){var p,E;return k++,p=PT(),p===t&&(p=yT(),p===t&&(p=ST())),k--,p===t&&(E=t,k===0&&j(N1)),p}function PT(){var p,E,N,B,W,q;if(k++,p=y,s.substr(y,2)===Ny?(E=Ny,y+=2):(E=t,k===0&&j(M1)),E!==t){for(N=[],B=y,W=y,k++,s.substr(y,2)===tl?(q=tl,y+=2):(q=t,k===0&&j(hm)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=Gy(q),B=W):(y=B,B=t)):(y=B,B=t);B!==t;)N.push(B),B=y,W=y,k++,s.substr(y,2)===tl?(q=tl,y+=2):(q=t,k===0&&j(hm)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=Gy(q),B=W):(y=B,B=t)):(y=B,B=t);N!==t?(s.substr(y,2)===tl?(B=tl,y+=2):(B=t,k===0&&j(hm)),B!==t?(Se=p,E=D1(N),p=E):(y=p,p=t)):(y=p,p=t)}else y=p,p=t;return k--,p===t&&(E=t,k===0&&j(G1)),p}function yT(){var p,E,N,B,W,q;if(k++,p=y,s.substr(y,2)===My?(E=My,y+=2):(E=t,k===0&&j(_1)),E!==t){for(N=[],B=y,W=y,k++,rl.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(nl)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=oo(q),B=W):(y=B,B=t)):(y=B,B=t);B!==t;)N.push(B),B=y,W=y,k++,rl.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(nl)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=oo(q),B=W):(y=B,B=t)):(y=B,B=t);N!==t?(rl.test(s.charAt(y))?(B=s.charAt(y),y++):(B=t,k===0&&j(nl)),B===t&&(B=null),B!==t?(Se=p,E=Dy(N),p=E):(y=p,p=t)):(y=p,p=t)}else y=p,p=t;return k--,p===t&&(E=t,k===0&&j(F1)),p}function ST(){var p,E,N,B,W,q;if(k++,p=y,s.charCodeAt(y)===35?(E=k1,y++):(E=t,k===0&&j(U1)),E!==t){for(N=[],B=y,W=y,k++,rl.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(nl)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=oo(q),B=W):(y=B,B=t)):(y=B,B=t);B!==t;)N.push(B),B=y,W=y,k++,rl.test(s.charAt(y))?(q=s.charAt(y),y++):(q=t,k===0&&j(nl)),k--,q===t?W=void 0:(y=W,W=t),W!==t?(s.length>y?(q=s.charAt(y),y++):(q=t,k===0&&j(hn)),q!==t?(Se=B,W=oo(q),B=W):(y=B,B=t)):(y=B,B=t);N!==t?(rl.test(s.charAt(y))?(B=s.charAt(y),y++):(B=t,k===0&&j(nl)),B===t&&(B=null),B!==t?(Se=p,E=Dy(N),p=E):(y=p,p=t)):(y=p,p=t)}else y=p,p=t;return k--,p===t&&(E=t,k===0&&j(V1)),p}function nt(){var p,E;for(k++,p=[],E=i0(),E===t&&(E=n0());E!==t;)p.push(E),E=i0(),E===t&&(E=n0());return k--,p===t&&(E=t,k===0&&j(W1)),p}function bm(){var p,E;if(p=[],Fy.test(s.charAt(y))?(E=s.charAt(y),y++):(E=t,k===0&&j(_y)),E!==t)for(;E!==t;)p.push(E),Fy.test(s.charAt(y))?(E=s.charAt(y),y++):(E=t,k===0&&j(_y));else p=t;return p}function i0(){var p,E;if(p=[],Vy.test(s.charAt(y))?(E=s.charAt(y),y++):(E=t,k===0&&j(ky)),E===t&&(E=bm()),E!==t)for(;E!==t;)p.push(E),Vy.test(s.charAt(y))?(E=s.charAt(y),y++):(E=t,k===0&&j(ky)),E===t&&(E=bm());else p=t;return p}function ET(){var p;return p=TT(),p===t&&(p=CT(),p===t&&(p=vT(),p===t&&(p=xT(),p===t&&(p=AT(),p===t&&(p=IT()))))),p}function CT(){var p;return z1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(H1)),p}function xT(){var p;return j1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(q1)),p}function AT(){var p;return X1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(Y1)),p}function vT(){var p;return K1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(Q1)),p}function TT(){var p;return J1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(Z1)),p}function IT(){var p;return $1.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(eT)),p}function wT(){var p;return tT.test(s.charAt(y))?(p=s.charAt(y),y++):(p=t,k===0&&j(rT)),p}if(Uh=i(),Uh!==t&&y===s.length)return Uh;throw Uh!==t&&y<s.length&&j(iT()),zy(dm,Pi<s.length?s.charAt(Pi):null,Pi<s.length?Ru(Pi,Pi+1):Ru(Pi,Pi))}cv.exports={SyntaxError:Ha,parse:sG}});var fv=kt((gAe,dv)=>{var aG=hv();dv.exports=aG.parse});var yv=kt((mAe,Pv)=>{Pv.exports={rgb2hsl:lh,rgb2hsv:wg,rgb2hwb:uh,rgb2cmyk:ch,rgb2keyword:hh,rgb2xyz:cy,rgb2lab:hy,rgb2lch:lG,hsl2rgb:Lg,hsl2hsv:uG,hsl2hwb:cG,hsl2cmyk:hG,hsl2keyword:dG,hsv2rgb:Og,hsv2hsl:fG,hsv2hwb:gG,hsv2cmyk:mG,hsv2keyword:pG,hwb2rgb:dh,hwb2hsl:bG,hwb2hsv:PG,hwb2cmyk:yG,hwb2keyword:SG,cmyk2rgb:fh,cmyk2hsl:EG,cmyk2hsv:CG,cmyk2hwb:xG,cmyk2keyword:AG,keyword2rgb:ja,keyword2hsl:wG,keyword2hsv:LG,keyword2hwb:OG,keyword2cmyk:RG,keyword2lab:BG,keyword2xyz:NG,xyz2rgb:gv,xyz2lab:mv,xyz2lch:vG,lab2xyz:dy,lab2rgb:pv,lab2lch:fy,lch2lab:gy,lch2xyz:TG,lch2rgb:IG};function lh(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255,i=Math.min(e,t,n),o=Math.max(e,t,n),a=o-i,l,u,c;return o==i?l=0:e==o?l=(t-n)/a:t==o?l=2+(n-e)/a:n==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(i+o)/2,o==i?u=0:c<=.5?u=a/(o+i):u=a/(2-o-i),[l,u*100,c*100]}function wg(s){var e=s[0],t=s[1],n=s[2],i=Math.min(e,t,n),o=Math.max(e,t,n),a=o-i,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==i?l=0:e==o?l=(t-n)/a:t==o?l=2+(n-e)/a:n==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function uh(s){var e=s[0],t=s[1],o=s[2],n=lh(s)[0],i=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[n,i*100,o*100]}function ch(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255,i,o,a,l;return l=Math.min(1-e,1-t,1-n),i=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-n-l)/(1-l)||0,[i*100,o*100,a*100,l*100]}function hh(s){return bv[JSON.stringify(s)]}function cy(s){var e=s[0]/255,t=s[1]/255,n=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92;var i=e*.4124+t*.3576+n*.1805,o=e*.2126+t*.7152+n*.0722,a=e*.0193+t*.1192+n*.9505;return[i*100,o*100,a*100]}function hy(s){var e=cy(s),t=e[0],n=e[1],i=e[2],o,a,l;return t/=95.047,n/=100,i/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,o=116*n-16,a=500*(t-n),l=200*(n-i),[o,a,l]}function lG(s){return fy(hy(s))}function Lg(s){var e=s[0]/360,t=s[1]/100,n=s[2]/100,i,o,a,l,u;if(t==0)return u=n*255,[u,u,u];n<.5?o=n*(1+t):o=n+t-n*t,i=2*n-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=i+(o-i)*6*a:2*a<1?u=o:3*a<2?u=i+(o-i)*(2/3-a)*6:u=i,l[c]=u*255;return l}function uG(s){var e=s[0],t=s[1]/100,n=s[2]/100,i,o;return n===0?[0,0,0]:(n*=2,t*=n<=1?n:2-n,o=(n+t)/2,i=2*t/(n+t),[e,i*100,o*100])}function cG(s){return uh(Lg(s))}function hG(s){return ch(Lg(s))}function dG(s){return hh(Lg(s))}function Og(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,n=Math.floor(e)%6,i=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*i),l=255*u*(1-t*(1-i)),u=255*u;switch(n){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function fG(s){var e=s[0],t=s[1]/100,n=s[2]/100,i,o;return o=(2-t)*n,i=t*n,i/=o<=1?o:2-o,i=i||0,o/=2,[e,i*100,o*100]}function gG(s){return uh(Og(s))}function mG(s){return ch(Og(s))}function pG(s){return hh(Og(s))}function dh(s){var e=s[0]/360,t=s[1]/100,n=s[2]/100,i=t+n,o,a,l,u;switch(i>1&&(t/=i,n/=i),o=Math.floor(6*e),a=1-n,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function bG(s){return lh(dh(s))}function PG(s){return wg(dh(s))}function yG(s){return ch(dh(s))}function SG(s){return hh(dh(s))}function fh(s){var e=s[0]/100,t=s[1]/100,n=s[2]/100,i=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-i)+i),a=1-Math.min(1,t*(1-i)+i),l=1-Math.min(1,n*(1-i)+i),[o*255,a*255,l*255]}function EG(s){return lh(fh(s))}function CG(s){return wg(fh(s))}function xG(s){return uh(fh(s))}function AG(s){return hh(fh(s))}function gv(s){var e=s[0]/100,t=s[1]/100,n=s[2]/100,i,o,a;return i=e*3.2406+t*-1.5372+n*-.4986,o=e*-.9689+t*1.8758+n*.0415,a=e*.0557+t*-.204+n*1.057,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:i=i*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,i=Math.min(Math.max(0,i),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[i*255,o*255,a*255]}function mv(s){var e=s[0],t=s[1],n=s[2],i,o,a;return e/=95.047,t/=100,n/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=116*t-16,o=500*(e-t),a=200*(t-n),[i,o,a]}function vG(s){return fy(mv(s))}function dy(s){var e=s[0],t=s[1],n=s[2],i,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),i=i/95.047<=.008856?i=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-n/200-16/116)/7.787:108.883*Math.pow(l-n/200,3),[i,o,a]}function fy(s){var e=s[0],t=s[1],n=s[2],i,o,a;return i=Math.atan2(n,t),o=i*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+n*n),[e,a,o]}function pv(s){return gv(dy(s))}function gy(s){var e=s[0],t=s[1],n=s[2],i,o,a;return a=n/360*2*Math.PI,i=t*Math.cos(a),o=t*Math.sin(a),[e,i,o]}function TG(s){return dy(gy(s))}function IG(s){return pv(gy(s))}function ja(s){return uy[s]}function wG(s){return lh(ja(s))}function LG(s){return wg(ja(s))}function OG(s){return uh(ja(s))}function RG(s){return ch(ja(s))}function BG(s){return hy(ja(s))}function NG(s){return cy(ja(s))}var uy={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},bv={};for(ly in uy)bv[JSON.stringify(uy[ly])]=ly;var ly});var Cv=kt((pAe,Ev)=>{var my=yv(),qa=function(){return new gh};for(mu in my)qa[mu+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),my[s](e)}}(mu),py=/(\w+)2(\w+)/.exec(mu),Rg=py[1],Sv=py[2],qa[Rg]=qa[Rg]||{},qa[Rg][Sv]=qa[mu]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=my[s](e);if(typeof t=="string"||t===void 0)return t;for(var n=0;n<t.length;n++)t[n]=Math.round(t[n]);return t}}(mu);var py,Rg,Sv,mu,gh=function(){this.convs={}};gh.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};gh.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};gh.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,n=this.convs[t];e=qa[t][s](n),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){gh.prototype[s]=function(e){return this.routeSpace(s,arguments)}});Ev.exports=qa});var Av=kt((bAe,xv)=>{var by=Cv();xv.exports=function(s){var e,t,n,i;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=by[a],n=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&n.push(1),i=n[l]===void 0?1:n[l],n=n.slice(0,l),t[a]=function(){return n}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=by.rgb,n=a.split(l===3?/(.)/:/(..)/),n=n.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),i=1,t.rgb=function(){return n},n[0]||(n[0]=0),n[1]||(n[1]=0),n[2]||(n[2]=0)}else t=by.keyword,t.keyword=function(){return s},n=s,i=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(n)}catch{}try{u.hsl=t.hsl(n)}catch{}try{u.hsv=t.hsv(n)}catch{}try{u.cmyk=t.cmyk(n)}catch{}try{u.keyword=t.keyword(n)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(i)),u.hsl&&(u.hsla=u.hsl.concat(i)),u.hsv&&(u.hsva=u.hsv.concat(i)),u.cmyk&&(u.cmyka=u.cmyk.concat(i)),u}});var Vv=kt((Bve,Gg)=>{Gg.exports=_v;Gg.exports.addWheelListener=_v;Gg.exports.removeWheelListener=hM;function _v(s,e,t){s.addEventListener("wheel",e,t)}function hM(s,e,t){s.removeEventListener("wheel",e,t)}});var jv=kt((Nve,Hv)=>{var dM=4,fM=.001,gM=1e-7,mM=10,Eh=11,Mg=1/(Eh-1),pM=typeof Float32Array=="function";function kv(s,e){return 1-3*e+3*s}function Uv(s,e){return 3*e-6*s}function Wv(s){return 3*s}function Dg(s,e,t){return((kv(e,t)*s+Uv(e,t))*s+Wv(e))*s}function zv(s,e,t){return 3*kv(e,t)*s*s+2*Uv(e,t)*s+Wv(e)}function bM(s,e,t,n,i){var o,a,l=0;do a=e+(t-e)/2,o=Dg(a,n,i)-s,o>0?t=a:e=a;while(Math.abs(o)>gM&&++l<mM);return a}function PM(s,e,t,n){for(var i=0;i<dM;++i){var o=zv(e,t,n);if(o===0)return e;var a=Dg(e,t,n)-s;e-=a/o}return e}function yM(s){return s}Hv.exports=function(e,t,n,i){if(!(0<=e&&e<=1&&0<=n&&n<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===t&&n===i)return yM;for(var o=pM?new Float32Array(Eh):new Array(Eh),a=0;a<Eh;++a)o[a]=Dg(a*Mg,e,n);function l(u){for(var c=0,h=1,d=Eh-1;h!==d&&o[h]<=u;++h)c+=Mg;--h;var m=(u-o[h])/(o[h+1]-o[h]),P=c+m*Mg,S=zv(P,e,n);return S>=fM?PM(u,P,e,n):S===0?P:bM(u,c,c+Mg,e,n)}return function(c){return c===0?0:c===1?1:Dg(l(c),t,i)}}});var Kv=kt((Gve,Fg)=>{var Ch=jv(),qv={ease:Ch(.25,.1,.25,1),easeIn:Ch(.42,0,1,1),easeOut:Ch(0,0,.58,1),easeInOut:Ch(.42,0,.58,1),linear:Ch(0,0,1,1)};Fg.exports=SM;Fg.exports.makeAggregateRaf=Yv;Fg.exports.sharedScheduler=Yv();function SM(s,e,t){var n=Object.create(null),i=Object.create(null);t=t||{};var o=typeof t.easing=="function"?t.easing:qv[t.easing];o||(t.easing&&console.warn("Unknown easing function in amator: "+t.easing),o=qv.ease);var a=typeof t.step=="function"?t.step:Xv,l=typeof t.done=="function"?t.done:Xv,u=EM(t.scheduler),c=Object.keys(e);c.forEach(function(L){n[L]=s[L],i[L]=e[L]-s[L]});var h=typeof t.duration=="number"?t.duration:400,d=Math.max(1,h*.06),m,P=0;return m=u.next(v),{cancel:S};function S(){u.cancel(m),m=0}function v(){var L=o(P/d);P+=1,I(L),P<=d?(m=u.next(v),a(s)):(m=0,setTimeout(function(){l(s)},0))}function I(L){c.forEach(function(D){s[D]=i[D]*L+n[D]})}}function Xv(){}function EM(s){if(!s){var e=typeof window<"u"&&window.requestAnimationFrame;return e?CM():xM()}if(typeof s.next!="function")throw new Error("Scheduler is supposed to have next(cb) function");if(typeof s.cancel!="function")throw new Error("Scheduler is supposed to have cancel(handle) function");return s}function CM(){return{next:window.requestAnimationFrame.bind(window),cancel:window.cancelAnimationFrame.bind(window)}}function xM(){return{next:function(s){return setTimeout(s,1e3/60)},cancel:function(s){return clearTimeout(s)}}}function Yv(){var s=new Set,e=new Set,t=0;return{next:i,cancel:i,clearAll:n};function n(){s.clear(),e.clear(),cancelAnimationFrame(t),t=0}function i(u){e.add(u),o()}function o(){t||(t=requestAnimationFrame(a))}function a(){t=0;var u=e;e=s,s=u,s.forEach(function(c){c()}),s.clear()}function l(u){e.delete(u)}}});var Jv=kt((Mve,Qv)=>{Qv.exports=function(e){vM(e);var t=AM(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e};function AM(s){var e=Object.create(null);return{on:function(t,n,i){if(typeof n!="function")throw new Error("callback is expected to be a function");var o=e[t];return o||(o=e[t]=[]),o.push({callback:n,ctx:i}),s},off:function(t,n){var i=typeof t>"u";if(i)return e=Object.create(null),s;if(e[t]){var o=typeof n!="function";if(o)delete e[t];else for(var a=e[t],l=0;l<a.length;++l)a[l].callback===n&&a.splice(l,1)}return s},fire:function(t){var n=e[t];if(!n)return s;var i;arguments.length>1&&(i=Array.prototype.splice.call(arguments,1));for(var o=0;o<n.length;++o){var a=n[o];a.callback.apply(a.ctx,i)}return s}}}function vM(s){if(!s)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],t=0;t<e.length;++t)if(s.hasOwnProperty(e[t]))throw new Error("Subject cannot be eventified, since it already has property '"+e[t]+"'")}});var $v=kt((Dve,Zv)=>{Zv.exports=TM;function TM(s,e,t){typeof t!="object"&&(t={});var n=typeof t.minVelocity=="number"?t.minVelocity:5,i=typeof t.amplitude=="number"?t.amplitude:.25,o=typeof t.cancelAnimationFrame=="function"?t.cancelAnimationFrame:IM(),a=typeof t.requestAnimationFrame=="function"?t.requestAnimationFrame:wM(),l,u,c=342,h,d,m,P,S,v,I,L;return{start:w,stop:K,cancel:D};function D(){o(h),o(L)}function w(){l=s(),P=I=d=S=0,u=new Date,o(h),o(L),h=a(M)}function M(){var se=Date.now(),Te=se-u;u=se;var pe=s(),G=pe.x-l.x,O=pe.y-l.y;l=pe;var V=1e3/(1+Te);d=.8*G*V+.2*d,S=.8*O*V+.2*S,h=a(M)}function K(){o(h),o(L);var se=s();m=se.x,v=se.y,u=Date.now(),(d<-n||d>n)&&(P=i*d,m+=P),(S<-n||S>n)&&(I=i*S,v+=I),L=a(X)}function X(){var se=Date.now()-u,Te=!1,pe=0,G=0;P&&(pe=-P*Math.exp(-se/c),pe>.5||pe<-.5?Te=!0:pe=P=0),I&&(G=-I*Math.exp(-se/c),G>.5||G<-.5?Te=!0:G=I=0),Te&&(e(m+pe,v+G),L=a(X))}}function IM(){return typeof cancelAnimationFrame=="function"?cancelAnimationFrame:clearTimeout}function wM(){return typeof requestAnimationFrame=="function"?requestAnimationFrame:function(s){return setTimeout(s,16)}}});var n1=kt((Fve,r1)=>{r1.exports=LM;function LM(s){if(s)return{capture:t1,release:t1};var e,t,n,i=!1;return{capture:o,release:a};function o(l){i=!0,t=window.document.onselectstart,n=window.document.ondragstart,window.document.onselectstart=e1,e=l,e.ondragstart=e1}function a(){!i||(i=!1,window.document.onselectstart=t,e&&(e.ondragstart=n))}}function e1(s){return s.stopPropagation(),!1}function t1(){}});var o1=kt((_ve,i1)=>{i1.exports=OM;function OM(){this.x=0,this.y=0,this.scale=1}});var a1=kt((Vve,Iy)=>{Iy.exports=RM;Iy.exports.canAttach=s1;function RM(s,e){if(!s1(s))throw new Error("svg element is required for svg.panzoom to work");var t=s.ownerSVGElement;if(!t)throw new Error("Do not apply panzoom to the root <svg> element. Use its child instead (e.g. <g></g>). As of March 2016 only FireFox supported transform on the root element");e.disableKeyboardInteraction||t.setAttribute("tabindex",0);var n={getBBox:o,getScreenCTM:a,getOwner:i,applyTransform:u,initTransform:l};return n;function i(){return t}function o(){var c=s.getBBox();return{left:c.x,top:c.y,width:c.width,height:c.height}}function a(){var c=t.getCTM();return c||t.getScreenCTM()}function l(c){var h=s.getCTM();h===null&&(h=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix()),c.x=h.e,c.y=h.f,c.scale=h.a,t.removeAttributeNS(null,"viewBox")}function u(c){s.setAttribute("transform","matrix("+c.scale+" 0 0 "+c.scale+" "+c.x+" "+c.y+")")}}function s1(s){return s&&s.ownerSVGElement&&s.getCTM}});var u1=kt((kve,wy)=>{wy.exports=BM;wy.exports.canAttach=l1;function BM(s,e){var t=l1(s);if(!t)throw new Error("panzoom requires DOM element to be attached to the DOM tree");var n=s.parentElement;s.scrollTop=0,e.disableKeyboardInteraction||n.setAttribute("tabindex",0);var i={getBBox:a,getOwner:o,applyTransform:l};return i;function o(){return n}function a(){return{left:0,top:0,width:s.clientWidth,height:s.clientHeight}}function l(u){s.style.transformOrigin="0 0 0",s.style.transform="matrix("+u.scale+", 0, 0, "+u.scale+", "+u.x+", "+u.y+")"}}function l1(s){return s&&s.parentElement&&s.style}});var S1=kt((Uve,y1)=>{"use strict";var c1=Vv(),Ly=Kv(),NM=Jv(),GM=$v(),b1=n1(),MM=b1(),DM=b1(!0),FM=o1(),h1=a1(),d1=u1(),_M=1,VM=1.75,f1=300,g1=200;y1.exports=P1;function P1(s,e){e=e||{};var t=e.controller;if(t||(h1.canAttach(s)?t=h1(s,e):d1.canAttach(s)&&(t=d1(s,e))),!t)throw new Error("Cannot create panzoom for the current type of dom element");var n=t.getOwner(),i={x:0,y:0},o=!1,a=new FM;t.initTransform&&t.initTransform(a);var l=typeof e.filterKey=="function"?e.filterKey:yu,u=typeof e.pinchSpeed=="number"?e.pinchSpeed:1,c=e.bounds,h=typeof e.maxZoom=="number"?e.maxZoom:Number.POSITIVE_INFINITY,d=typeof e.minZoom=="number"?e.minZoom:0,m=typeof e.boundsPadding=="number"?e.boundsPadding:.05,P=typeof e.zoomDoubleClickSpeed=="number"?e.zoomDoubleClickSpeed:VM,S=e.beforeWheel||yu,v=e.beforeMouseDown||yu,I=typeof e.zoomSpeed=="number"?e.zoomSpeed:_M,L=m1(e.transformOrigin),D=e.enableTextSelection?DM:MM;kM(c),e.autocenter&&Cu();var w,M=0,K=0,X=0,se=null,Te=new Date,pe,G=!1,O=!1,V,U,Z,te,le,ge;"smoothScroll"in e&&!e.smoothScroll?ge=UM():ge=GM(Th,nm,e.smoothScroll);var Ne,Pt,Zt,Vr=!1;wh();var Ms={dispose:im,moveBy:no,moveTo:xu,smoothMoveTo:rm,centerOn:tm,zoomTo:so,zoomAbs:Ka,smoothZoom:_o,smoothZoomAbs:Dh,showRectangle:zg,pause:kg,resume:Ug,isPaused:Wg,getTransform:Hg,getMinZoom:jg,setMinZoom:qg,getMaxZoom:Xg,setMaxZoom:Yg,getTransformOrigin:Kg,setTransformOrigin:Qg,getZoomSpeed:Jg,setZoomSpeed:Zg};NM(Ms);var Ah=typeof e.initialX=="number"?e.initialX:a.x,Eu=typeof e.initialY=="number"?e.initialY:a.y,vh=typeof e.initialZoom=="number"?e.initialZoom:a.scale;return(Ah!=a.x||Eu!=a.y||vh!=a.scale)&&Ka(Ah,Eu,vh),Ms;function kg(){Lh(),Vr=!0}function Ug(){Vr&&(wh(),Vr=!1)}function Wg(){return Vr}function zg(_){var J=n.getBoundingClientRect(),$=Yn(J.width,J.height),ne=_.right-_.left,Me=_.bottom-_.top;if(!Number.isFinite(ne)||!Number.isFinite(Me))throw new Error("Invalid rectangle");var Ze=$.x/ne,$e=$.y/Me,qt=Math.min(Ze,$e);a.x=-(_.left+ne/2)*qt+$.x/2,a.y=-(_.top+Me/2)*qt+$.y/2,a.scale=qt}function Yn(_,J){if(t.getScreenCTM){var $=t.getScreenCTM(),ne=$.a,Me=$.d,Ze=$.e,$e=$.f;i.x=_*ne-Ze,i.y=J*Me-$e}else i.x=_,i.y=J;return i}function Cu(){var _,J,$=0,ne=0,Me=vu();if(Me)$=Me.left,ne=Me.top,_=Me.right-Me.left,J=Me.bottom-Me.top;else{var Ze=n.getBoundingClientRect();_=Ze.width,J=Ze.height}var $e=t.getBBox();if(!($e.width===0||$e.height===0)){var qt=J/$e.height,ko=_/$e.width,lo=Math.min(ko,qt);a.x=-($e.left+$e.width/2)*lo+_/2+$,a.y=-($e.top+$e.height/2)*lo+J/2+ne,a.scale=lo}}function Hg(){return a}function jg(){return d}function qg(_){d=_}function Xg(){return h}function Yg(_){h=_}function Kg(){return L}function Qg(_){L=m1(_)}function Jg(){return I}function Zg(_){if(!Number.isFinite(_))throw new Error("Zoom speed should be a number");I=_}function Th(){return{x:a.x,y:a.y}}function xu(_,J){a.x=_,a.y=J,Au(),Vo("pan"),Tu()}function Ih(_,J){xu(a.x+_,a.y+J)}function Au(){var _=vu();if(!!_){var J=!1,$=$g(),ne=_.left-$.right;return ne>0&&(a.x+=ne,J=!0),ne=_.right-$.left,ne<0&&(a.x+=ne,J=!0),ne=_.top-$.bottom,ne>0&&(a.y+=ne,J=!0),ne=_.bottom-$.top,ne<0&&(a.y+=ne,J=!0),J}}function vu(){if(!!c){if(typeof c=="boolean"){var _=n.getBoundingClientRect(),J=_.width,$=_.height;return{left:J*m,top:$*m,right:J*(1-m),bottom:$*(1-m)}}return c}}function $g(){var _=t.getBBox(),J=em(_.left,_.top);return{left:J.x,top:J.y,right:_.width*a.scale+J.x,bottom:_.height*a.scale+J.y}}function em(_,J){return{x:_*a.scale+a.x,y:J*a.scale+a.y}}function Tu(){o=!0,w=window.requestAnimationFrame(om)}function Iu(_,J,$){if(Oy(_)||Oy(J)||Oy($))throw new Error("zoom requires valid numbers");var ne=a.scale*$;if(ne<d){if(a.scale===d)return;$=d/a.scale}if(ne>h){if(a.scale===h)return;$=h/a.scale}var Me=Yn(_,J);if(a.x=Me.x-$*(Me.x-a.x),a.y=Me.y-$*(Me.y-a.y),c&&m===1&&d===1)a.scale*=$,Au();else{var Ze=Au();Ze||(a.scale*=$)}Vo("zoom"),Tu()}function Ka(_,J,$){var ne=$/a.scale;Iu(_,J,ne)}function tm(_){var J=_.ownerSVGElement;if(!J)throw new Error("ui element is required to be within the scene");var $=_.getBoundingClientRect(),ne=$.left+$.width/2,Me=$.top+$.height/2,Ze=J.getBoundingClientRect(),$e=Ze.width/2-ne,qt=Ze.height/2-Me;no($e,qt,!0)}function rm(_,J){no(_-a.x,J-a.y,!0)}function no(_,J,$){if(!$)return Ih(_,J);Ne&&Ne.cancel();var ne={x:0,y:0},Me={x:_,y:J},Ze=0,$e=0;Ne=Ly(ne,Me,{step:function(qt){Ih(qt.x-Ze,qt.y-$e),Ze=qt.x,$e=qt.y}})}function nm(_,J){ao(),xu(_,J)}function im(){Lh()}function wh(){n.addEventListener("mousedown",$a,{passive:!1}),n.addEventListener("dblclick",Za,{passive:!1}),n.addEventListener("touchstart",Rh,{passive:!1}),n.addEventListener("keydown",Oh,{passive:!1}),c1.addWheelListener(n,Mh,{passive:!1}),Tu()}function Lh(){c1.removeWheelListener(n,Mh),n.removeEventListener("mousedown",$a),n.removeEventListener("keydown",Oh),n.removeEventListener("dblclick",Za),n.removeEventListener("touchstart",Rh),w&&(window.cancelAnimationFrame(w),w=0),ge.cancel(),hn(),oo(),D.release(),Ou()}function om(){o&&sm()}function sm(){o=!1,t.applyTransform(a),Vo("transform"),w=0}function Oh(_){var J=0,$=0,ne=0;if(_.keyCode===38?$=1:_.keyCode===40?$=-1:_.keyCode===37?J=1:_.keyCode===39?J=-1:_.keyCode===189||_.keyCode===109?ne=1:(_.keyCode===187||_.keyCode===107)&&(ne=-1),!l(_,J,$,ne)){if(J||$){_.preventDefault(),_.stopPropagation();var Me=n.getBoundingClientRect(),Ze=Math.min(Me.width,Me.height),$e=.05,qt=Ze*$e*J,ko=Ze*$e*$;no(qt,ko)}if(ne){var lo=Fh(ne*100),Ze=L?Ds():am();so(Ze.x,Ze.y,lo)}}}function am(){var _=n.getBoundingClientRect();return{x:_.width/2,y:_.height/2}}function Rh(_){if(lm(_),In(),_.touches.length===1)return Bh(_,_.touches[0]);_.touches.length===2&&(le=Ja(_.touches[0],_.touches[1]),Zt=!0,wu())}function lm(_){e.onTouch&&!e.onTouch(_)||(_.stopPropagation(),_.preventDefault())}function um(_){In(),!(e.onDoubleClick&&!e.onDoubleClick(_))&&(_.preventDefault(),_.stopPropagation())}function Bh(_){K=new Date;var J=_.touches[0],$=dn(J);pe=$;var ne=Yn($.x,$.y);V=ne.x,U=ne.y,Z=V,te=U,ge.cancel(),wu()}function wu(){G||(G=!0,document.addEventListener("touchmove",io),document.addEventListener("touchend",Qa),document.addEventListener("touchcancel",Qa))}function io(_){if(_.touches.length===1){_.stopPropagation();var J=_.touches[0],$=dn(J),ne=Yn($.x,$.y),Me=ne.x-V,Ze=ne.y-U;Me!==0&&Ze!==0&&Lu(),V=ne.x,U=ne.y,no(Me,Ze)}else if(_.touches.length===2){Zt=!0;var $e=_.touches[0],qt=_.touches[1],ko=Ja($e,qt),lo=1+(ko/le-1)*u,_h=dn($e),Vh=dn(qt);if(V=(_h.x+Vh.x)/2,U=(_h.y+Vh.y)/2,L){var $=Ds();V=$.x,U=$.y}so(V,U,lo),le=ko,_.stopPropagation(),_.preventDefault()}}function In(){X&&(clearTimeout(X),X=0)}function Nh(_){if(!!e.onClick){In();var J=V-Z,$=U-te,ne=Math.sqrt(J*J+$*$);ne>5||(X=setTimeout(function(){X=0,e.onClick(_)},f1))}}function Qa(_){if(In(),_.touches.length>0){var J=dn(_.touches[0]),$=Yn(J.x,J.y);V=$.x,U=$.y}else{var ne=new Date;if(ne-M<f1)if(L){var J=Ds();_o(J.x,J.y,P)}else _o(pe.x,pe.y,P);else ne-K<g1&&Nh(_);M=ne,Ou(),oo()}}function Ja(_,J){var $=_.clientX-J.clientX,ne=_.clientY-J.clientY;return Math.sqrt($*$+ne*ne)}function Za(_){um(_);var J=dn(_);L&&(J=Ds()),_o(J.x,J.y,P)}function $a(_){if(In(),!v(_)){if(se=_,Te=new Date,G)return _.stopPropagation(),!1;var J=_.button===1&&window.event!==null||_.button===0;if(!!J){ge.cancel();var $=dn(_),ne=Yn($.x,$.y);return Z=V=ne.x,te=U=ne.y,document.addEventListener("mousemove",el),document.addEventListener("mouseup",Gh),D.capture(_.target||_.srcElement),!1}}}function el(_){if(!G){Lu();var J=dn(_),$=Yn(J.x,J.y),ne=$.x-V,Me=$.y-U;V=$.x,U=$.y,no(ne,Me)}}function Gh(){var _=new Date;_-Te<g1&&Nh(se),D.release(),Ou(),hn()}function hn(){document.removeEventListener("mousemove",el),document.removeEventListener("mouseup",Gh),O=!1}function oo(){document.removeEventListener("touchmove",io),document.removeEventListener("touchend",Qa),document.removeEventListener("touchcancel",Qa),O=!1,Zt=!1,G=!1}function Mh(_){if(!S(_)){ge.cancel();var J=_.deltaY;_.deltaMode>0&&(J*=100);var $=Fh(J);if($!==1){var ne=L?Ds():dn(_);so(ne.x,ne.y,$),_.preventDefault()}}}function dn(_){var J,$,ne=n.getBoundingClientRect();return J=_.clientX-ne.left,$=_.clientY-ne.top,{x:J,y:$}}function _o(_,J,$){var ne=a.scale,Me={scale:ne},Ze={scale:$*ne};ge.cancel(),ao(),Pt=Ly(Me,Ze,{step:function($e){Ka(_,J,$e.scale)},done:cm})}function Dh(_,J,$){var ne=a.scale,Me={scale:ne},Ze={scale:$};ge.cancel(),ao(),Pt=Ly(Me,Ze,{step:function($e){Ka(_,J,$e.scale)}})}function Ds(){var _=n.getBoundingClientRect();return{x:_.width*L.x,y:_.height*L.y}}function so(_,J,$){return ge.cancel(),ao(),Iu(_,J,$)}function ao(){Pt&&(Pt.cancel(),Pt=null)}function Fh(_){var J=Math.sign(_),$=Math.min(.25,Math.abs(I*_/128));return 1-J*$}function Lu(){O||(Vo("panstart"),O=!0,ge.start())}function Ou(){O&&(Zt||ge.stop(),Vo("panend"))}function cm(){Vo("zoomend")}function Vo(_){Ms.fire(_,Ms)}}function m1(s){if(!!s){if(typeof s=="object")return(!Pu(s.x)||!Pu(s.y))&&p1(s),s;p1()}}function p1(s){throw console.error(s),new Error(["Cannot parse transform origin.","Some good examples:",'  "center center" can be achieved with {x: 0.5, y: 0.5}','  "top center" can be achieved with {x: 0.5, y: 0}','  "bottom right" can be achieved with {x: 1, y: 1}'].join(`
`))}function yu(){}function kM(s){var e=typeof s;if(!(e==="undefined"||e==="boolean")){var t=Pu(s.left)&&Pu(s.top)&&Pu(s.bottom)&&Pu(s.right);if(!t)throw new Error("Bounds object is not valid. It can be: undefined, boolean (true|false) or an object {left, top, right, bottom}")}}function Pu(s){return Number.isFinite(s)}function Oy(s){return Number.isNaN?Number.isNaN(s):s!==s}function UM(){return{start:yu,stop:yu,cancel:yu}}function WM(){if(typeof document>"u")return;var s=document.getElementsByTagName("script");if(!s)return;for(var e,t=0;t<s.length;++t){var n=s[t];if(n.src&&n.src.match(/\bpanzoom(\.min)?\.js/)){e=n;break}}if(!e)return;var i=e.getAttribute("query");if(!i)return;var o=e.getAttribute("name")||"pz",a=Date.now();l();function l(){var h=document.querySelector(i);if(!h){var d=Date.now(),m=d-a;if(m<2e3){setTimeout(l,100);return}console.error("Cannot find the panzoom element",o);return}var P=u(e);console.log(P),window[o]=P1(h,P)}function u(h){for(var d=h.attributes,m={},P=0;P<d.length;++P){var S=d[P],v=c(S);v&&(m[v.name]=v.value)}return m}function c(h){if(!!h.name){var d=h.name[0]==="p"&&h.name[1]==="z"&&h.name[2]==="-";if(!!d){var m=h.name.substr(3),P=JSON.parse(h.value);return{name:m,value:P}}}}}WM()});function s0(s,e){let t=document.getElementById(s);t.ondragover=n=>{n.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=n=>{n.preventDefault(),t.classList.remove("active");let i=n.dataTransfer.items[0];i.kind==="file"&&e(i.getAsFile())},t.onclick=()=>{let n=document.createElement("input");n.type="file",n.onchange=()=>n.files.length&&e(n.files[0]),n.click()}}var Ci=class{bind(e){this.entity&&this.entity.setAttr(e,this)}constructor(e,t){this.entity=e,this.bind(t)}};var ae=class{};ae.GeomObjectIndex=0,ae.DrawingObjectIndex=1,ae.AlgorithmDataIndex=2,ae.ViewerIndex=3;var Bu=class{constructor(){this.actions=new Set}forEach(e){this.actions.forEach(t=>t(e,null))}subscribe(e){this.actions.add(e)}unsubscribe(e){this.actions.delete(e)}raise(e,t){this.actions.forEach(n=>n(e,t))}},ce=class extends Ci{constructor(e){super(e,ae.GeomObjectIndex)}static getGeom(e){return e.getAttr(ae.GeomObjectIndex)}get parent(){let e=this.entity.parent;return e?ce.getGeom(e):null}rebind(e){this.entity=e,this.bind(ae.GeomObjectIndex)}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}};var Sm=class{static solve(e,t,n,i,o,a){let l=e*o-i*t;if(!(Math.abs(l)<Sm.eps))return{x:(n*o-a*t)/l,y:(e*a-i*n)/l}}},Kn=Sm;Kn.eps=1e-8;var Uo=class{static RoundPoint(e){return new f(Uo.RoundDouble(e.x),Uo.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*Uo.mult)/Uo.mult}},C=Uo;C.distanceEpsilonPrecision=6,C.mult=Math.pow(10,6),C.defaultLeafBoxesOffset=.5,C.lineSegmentThreshold=.05,C.intersectionEpsilon=1e-4,C.distanceEpsilon=Math.pow(10,-Uo.distanceEpsilonPrecision),C.squareOfDistanceEpsilon=Math.pow(10,-Uo.distanceEpsilonPrecision*2),C.tolerance=1e-8;function a0(s,e){return(s?1:0)-(e?1:0)}function Le(s,e){let t=s-e;return t<0?-1:t===0?0:1}function il(s,e){let t=Le(s.y,e.y);return t||Le(s.x,e.x)}function ie(s,e){let t=s-e;return-C.distanceEpsilon<=t&&t<=C.distanceEpsilon}function zh(s,e){return Nu(s,e)>0}function Nu(s,e){let t=s-e;return t<=-C.distanceEpsilon?-1:t>=C.distanceEpsilon?1:0}function _e(s,e){return s.sub(e).length}var f=class{toJSON(){return{x:this.x,y:this.y}}static fromJSON(e){return new f(e.x,e.y)}static ProjectionToLine(e,t,n){let i=t.sub(e),o=i.length;if(o<C.distanceEpsilon)return e;i=i.div(o);let a=n.sub(e).dot(i);return e.add(i.mul(a))}static RayIntersectsRayInteriors(e,t,n,i){let o=f.lineLineIntersection(e,e.add(t),n,n.add(i));if(!!o&&o.sub(e).dot(t.div(t.l1))>C.distanceEpsilon&&o.sub(n).dot(i.div(i.l1))>C.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,n,i){let o=f.lineLineIntersection(e,t,n,n.add(i));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(n).dot(i)<0)&&a.dot(a)>C.squareOfDistanceEpsilon&&l.dot(l)>=C.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,n){return f.signedDoubledTriangleArea(e,t,n)>=0}static PointToTheLeftOfLine(e,t,n){return f.signedDoubledTriangleArea(e,t,n)>0}static PointIsInsideCone(e,t,n,i){return f.PointToTheRightOfLineOrOnLine(e,t,n)&&f.PointToTheLeftOfLineOrOnLine(e,t,i)}static PointToTheRightOfLineOrOnLine(e,t,n){return f.signedDoubledTriangleArea(t,n,e)<=0}static PointToTheRightOfLine(e,t,n){return f.signedDoubledTriangleArea(t,n,e)<0}static closeIntersections(e,t){return f.close(e,t,C.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=Le(this.x,e.x);return t!==0?t:Le(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,n){return e.sub(t).length<=n}static closeSquare(e,t,n){let i=t.sub(e);return i.dot(i)<=n}static closeDistEps(e,t,n=C.distanceEpsilon){return e.sub(t).length<=n}normalize(){let e=this.length;return new f(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new f(this.x*e,this.y*t)}add(e){return new f(this.x+e.x,this.y+e.y)}sub(e){return new f(this.x-e.x,this.y-e.y)}mul(e){return new f(this.x*e,this.y*e)}div(e){return new f(this.x/e,this.y/e)}equal(e){return e.x===this.x&&e.y===this.y}neg(){return new f(-this.x,-this.y)}static lineLineIntersection(e,t,n,i){let o=t.sub(e),a=n.sub(i),l=n.sub(e),u=Kn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!==void 0)return e.add(o.mul(u.x))}static segSegIntersection(e,t,n,i){let o=t.sub(e),a=n.sub(i),l=n.sub(e),u=C.tolerance,c=Kn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!==void 0&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,n){let i=e.length,o=t.length;return i<n||o<n?!0:(e=e.div(i),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<n)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new f(-this.y,this.x)}rotate90Cw(){return new f(this.y,-this.x)}clone(){return new f(this.x,this.y)}rotate(e){let t=Math.cos(e),n=Math.sin(e);return new f(t*this.x-n*this.y,n*this.x+t*this.y)}static mkPoint(e,t,n,i){return t.mul(e).add(i.mul(n))}static convSum(e,t,n){return t.add(n.sub(t).mul(e))}static anglePCP(e,t,n){return f.angle(e.sub(t),n.sub(t))}static angle(e,t){let n=e.x,i=e.y,o=t.x,a=t.y,l=n*a-i*o,u=n*o+i*a;if(Math.abs(u)<C.tolerance)return Math.abs(l)<C.tolerance?0:l<-C.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<C.tolerance)return u<-C.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-C.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,n){return(t.x-e.x)*(n.y-e.y)-(n.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,n){let i=f.signedDoubledTriangleArea(e,t,n);return i>C.distanceEpsilon?1:i<-C.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,n){let i=f.signedDoubledTriangleArea(e,t,n);return i>C.intersectionEpsilon?1:i<-C.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a=i.dot(o),l=i.dot(i);return a<=0+C.tolerance?t:l<=a+C.tolerance?n:t.add(i.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,n){return f.signedDoubledTriangleArea(e,t,n)>=0}static pointToTheLeftOfLine(e,t,n){return f.signedDoubledTriangleArea(e,t,n)>0}static pointToTheRightOfLineOrOnLine(e,t,n){return f.signedDoubledTriangleArea(t,n,e)<=0}static pointToTheRightOfLine(e,t,n){return f.signedDoubledTriangleArea(t,n,e)<0}static canProject(e,t,n){let i=n.sub(t);return!(e.sub(t).dot(i)<0||e.sub(n).dot(i)>0)}static distToLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a,l;if((a=i.dot(o))<=C.tolerance)return{par:0,dist:o.length};if((l=i.dot(i))<=a+C.tolerance)return{par:1,dist:e.sub(n).length};let u=a/l;return{par:u,dist:t.add(i.mul(u)).length}}};var Lt=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new Lt;return t.point=e,t}};var Oe=class{contains(e){let t=e.sub(this.corner),n=C.distanceEpsilon,i=t.dot(this.bRot);if(i>this.abRot+n||i<-n)return!1;let o=t.dot(this.aRot);return o<=this.baRot+n&&o>=-n}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let n=new Oe,i=e.corner,o={minx:i.x,maxx:i.x,miny:i.y,maxy:i.y};return Oe.pumpMinMax(o,e.aPlusCorner),Oe.pumpMinMax(o,e.otherCorner),Oe.pumpMinMax(o,e.bPlusCorner),Oe.pumpMinMax(o,t.corner),Oe.pumpMinMax(o,t.aPlusCorner),Oe.pumpMinMax(o,t.otherCorner),Oe.pumpMinMax(o,t.bPlusCorner),n.corner=new f(o.minx,o.miny),n.a=new f(0,o.maxy-o.miny),n.b=new f(o.maxx-o.minx,0),n.aPlusCorner=n.a.add(n.corner),n.otherCorner=n.b.add(n.aPlusCorner),n.bPlusCorner=n.b.add(n.corner),n.aRot=new f(-n.a.y,n.a.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new f(-n.b.y,n.b.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.a.dot(n.bRot),n.baRot=n.b.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=n.a.sub(n.b).length<C.distanceEpsilon,n}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(Oe.separByA(e,t)||Oe.separByA(t,e)||Oe.separByB(e,t)||Oe.separByB(t,e))===!1?!1:!(e.isSeg&&t.isSeg)||!f.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:Oe.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let n=e.corner,i=e.otherCorner,o=t.corner,a=t.otherCorner,l=i.sub(n),u=0,c=l.dot(l),h=o.sub(n).dot(l),d=a.sub(n).dot(l);if(h>d){let m=h;h=d,d=m}return!(d<u-C.distanceEpsilon||h>c+C.distanceEpsilon)}static separByB(e,t){let n=C.distanceEpsilon,i=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(i>e.abRot+n){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+n)return!1;return!0}else if(i<-n){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-n)return!1;return!0}return!1}static separByA(e,t){let n=C.distanceEpsilon,i=t.corner.sub(e.corner),o=f.dot(i,e.aRot);return o>e.baRot+n?(i=t.aPlusCorner.sub(e.corner),!(f.dot(i,e.aRot)<=e.baRot+n||(i=t.bPlusCorner.sub(e.corner),f.dot(i,e.aRot)<=e.baRot+n)||(i=t.otherCorner.sub(e.corner),f.dot(i,e.aRot)<=e.baRot+n))):o<-n?(i=t.aPlusCorner.sub(e.corner),!(f.dot(i,e.aRot)>=-n||(i=t.bPlusCorner.sub(e.corner),f.dot(i,e.aRot)>=-n)||(i=t.otherCorner.sub(e.corner),f.dot(i,e.aRot)>=-n))):!1}static parallelogramByCornerSideSide(e,t,n){let i=new Oe;return i.corner=e,i.a=t,i.b=n,i.aRot=new f(-t.y,t.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new f(-n.y,n.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.bRot.dot(t),i.baRot=n.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=t.sub(n).length<C.distanceEpsilon,i.aPlusCorner=t.add(e),i.otherCorner=n.add(i.aPlusCorner),i.bPlusCorner=n.add(e),i}static getParallelogramOfAGroup(e){let t=0,n=0,i=0,o=0,a=!0;for(let l of e){let u=DT(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=n=h,i=o=d):(h<t?t=h:h>n&&(n=h),d<i?i=d:d>o&&(o=d))}}return Oe.parallelogramByCornerSideSide(new f(t,i),new f(0,o-i),new f(n-t,0))}};function*DT(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var R=class{constructor(e,t,n,i){this.parStart=0;this.parEnd=1;this.start=new f(e,t),this.end=new f(n,i)}static fromJSON(e){return R.mkPP(f.fromJSON(e.start),f.fromJSON(e.end))}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let n=this.value(e),i=this.value(t);return f.close(n,i,C.distanceEpsilon)?null:R.mkPP(n,i)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:Oe.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new f(-e.y,e.x)}static mkPP(e,t){return new R(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,n){return new R(e.x,e.y,t,n)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new f(0,0)}thirdDerivative(e){return new f(0,0)}reverse(){return R.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return R.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<C.tolerance)return 0;let n=e/t;return n>1?1:n<0?0:n}transform(e){return R.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,n){let i=this.closestParameter(e);return i<t&&(i=t),i>n&&(i=n),i}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return z.mkPP(this.start,this.end)}clone(){return R.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,n){let i=n.sub(t),o=e.sub(t),a=i.dot(o);if(a<=0+C.tolerance)return 0;let l=i.dot(i);return l<=a+C.tolerance?1:a/l}closestParameter(e){return R.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,n,i){let o=f.lineLineIntersection(e,t,n,i);if(o!=null&&R.xIsBetweenPoints(e,t,o)&&R.xIsBetweenPoints(n,i,o))return o}static xIsBetweenPoints(e,t,n){return e.sub(n).dot(t.sub(n))<=C.distanceEpsilon}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,n,i){let o=t.sub(e),a=i.sub(n),l=e.sub(n),u=f.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),m=o.dot(l),P=a.dot(l),S,v,I=Math.abs(u),L=I,D=I;I<C.tolerance?(S=0,L=1,v=P,D=d):(S=f.crossProduct(a,l),v=f.crossProduct(o,l),u<0&&(S=-S,v=-v),S<0?(S=0,v=P,D=d):S>L&&(S=L=1,v=P+h,D=d)),v<0?(v=0,-m<0?S=0:-m>c?S=L:(S=-m,L=c)):v>D&&(v=D=1,-m+h<0?S=0:-m+h>c?S=L:(S=-m+h,L=c));let w=Math.abs(S)<C.tolerance?0:S/L,M=Math.abs(v)<C.tolerance?0:v/D;return{parab:w,parcd:M,dist:l.add(o.mul(w).sub(a.mul(M))).length}}};function FT(s,e,t,n,i){return{parallelogram:t,seg:n,leafBoxesOffset:i,node:{low:s,high:e,chord:null}}}var ht=class{static distToSegm(e,t,n){let i=n.sub(t);if(i.length<C.intersectionEpsilon)return e.sub(t.add(n).div(2)).length;let o=new f(-i.y,i.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,n){let i=n.derivative(e),o=n.derivative(t),a=new f(-o.y,o.x),l=n.value(e),u=n.value(t),h=u.sub(l).dot(a),d=i.dot(a),m=Math.abs(h)<C.distanceEpsilon;if(!m&&Math.abs(d)<C.distanceEpsilon)return;let P=m?0:h/d;return i=i.mul(P),Oe.parallelogramByCornerSideSide(l,i,u.sub(l).sub(i))}static createParallelogramNodeForCurveSeg(e,t,n,i){if(e===n.parStart&&t===n.parEnd&&f.close(n.start,n.end,C.distanceEpsilon))return ht.createNodeWithSegmentSplit(e,t,n,i);let a=n.value(e),l=n.value(t),u=l.sub(a),c=n.value((e+t)/2);if(ht.distToSegm(c,a,l)<=C.intersectionEpsilon&&u.dot(u)<C.lineSegmentThreshold*C.lineSegmentThreshold&&t-e<C.lineSegmentThreshold){let h=R.mkPP(a,l),d=h.pNodeOverICurve();d.seg=n;let m=d.node;return m.low=e,m.high=t,m.chord=h,d}if(ht.WithinEpsilon(n,e,t,i)){let h=ht.createParallelogramOnSubSeg(e,t,n);if(h!==void 0)return FT(e,t,h,n,i)}return ht.createNodeWithSegmentSplit(e,t,n,i)}static WithinEpsilon(e,t,n,i){let a=(n-t)/3,l=e.value(t),u=e.value(n);return ht.distToSegm(e.value(t+a),l,u)>i?!1:ht.distToSegm(e.value(t+a*(3-1)),l,u)<=i}static createParallelogramNodeForCurveSegDefaultOffset(e){return ht.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,C.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,n,i){let o={parallelogram:null,seg:n,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(ht.createParallelogramNodeForCurveSeg(e,.5*(e+t),n,i)),a.children.push(ht.createParallelogramNodeForCurveSeg(.5*(e+t),t,n,i)),o.parallelogram=Oe.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var xi=class{constructor(e,t,n,i,o){this.par0=e,this.par1=t,this.x=n,this.seg0=i,this.seg1=o}};var Fs=class{static closestPoint(e,t,n,i,o){let u=n,c=0,h=0,d,m=!1;do{let P=e.value(u),S=e.derivative(u),v=e.secondDerivative(u),I=S.dot(S)+P.sub(t).dot(v);if(Math.abs(I)<C.tolerance)return u;d=P.sub(t).dot(S.div(I)),u-=d,u>o+C.tolerance?(u=o,h++):u<i-C.tolerance&&(u=i,h++),c++}while(Math.abs(d)>C.tolerance&&!(m=c>=5||h>=5));return m&&e.value(n).sub(t).length<C.distanceEpsilon&&(u=n),u}};var he=class{isFullEllipse(){return this.parEnd===Math.PI*2&&this.parStart===0}static fromJSON(e){return new he(e.parStart,e.parEnd,f.fromJSON(e.axis0),f.fromJSON(e.axis1),f.fromJSON(e.center))}toJSON(){return{parStart:this.parStart,parEnd:this.parEnd,axis0:this.aAxis.toJSON(),axis1:this.bAxis.toJSON(),center:this.center.toJSON()}}offsetCurve(e,t){let n=t.sub(this.center),i=f.angle(this.aAxis,n);if(this.aAxis.mul(Math.cos(i)).add(this.bAxis.mul(Math.sin(i))).length<n.length){let a=this.aAxis.length,l=this.bAxis.length;return he.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return he.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,n){return new he(0,Math.PI*2,e,t,n)}constructor(e,t,n,i,o){for(this.parStart=e,this.parEnd=t,this.aAxis=n,this.bAxis=i,this.center=o,this.pNode=null,this.setBoundingBox();this.parStart<0;)this.parStart+=Math.PI*2,this.parEnd+=Math.PI*2}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new he(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(f.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return f.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return f.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return f.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=ht.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(ie(this.parStart,0)&&ie(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=z.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,n,i,o,a){return new he(e,t,n,i,new f(o,a))}static mkFullEllipsePPP(e,t,n){return new he(0,Math.PI*2,e,t,n)}static mkFullEllipseNNP(e,t,n){return new he(0,Math.PI*2,new f(e,0),new f(0,t),n)}static mkCircle(e,t){return he.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new he(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let n=this.parStart,i=this.parEnd,o=e+.001,a=e-.001;for(;i-n>C.distanceEpsilon;){let l=.5*(i+n),u=this.lengthPartial(this.parStart,l);if(u>o)i=l;else if(u<a)n=l;else return l}return(i+n)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),n=e.multiplyPoint(this.bAxis).sub(e.offset());return new he(this.parStart,this.parEnd,t,n,e.multiplyPoint(this.center))}return this.clone()}closestParameterWithinBounds(e,t,n){let o=(n-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),m=d.dot(d);m<l&&(l=m,a=h)}a===0&&n===Math.PI*2&&(t=-Math.PI);let u=Fs.closestPoint(this,e,a,t,n);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return x.lengthWithInterpolationAndThreshold(this.trim(e,t),C.lineSegmentThreshold/100)}get length(){return(this.aAxis.length+this.bAxis.length)*Math.abs(this.parEnd-this.parStart)/2}clone(){return new he(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,n=8,i=(this.parEnd-this.parStart)/(n+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=n;c++){let h=this.parStart+c*i,d=e.sub(this.value(h)),m=d.dot(d);m<a&&(a=m,o=h)}let l=!1;o===0&&this.parEnd===Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=Fs.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return f.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return z.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<C.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<C.tolerance&&f.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var Em=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,n,i,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=n,this.bMin=o,this.aMax=i,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,n,i){return e*i-n*t}solve(){let e=0,t=10,n=0,i=100,o=!1;if(this.initValues(),this.curveA instanceof R&&this.curveB instanceof R){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<C.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<C.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<C.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+C.distanceEpsilon||u<this.aMin-C.distanceEpsilon||c>this.bMax+C.distanceEpsilon||c<this.bMin-C.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),n++,o=e>=t||n>=i||a.s===0&&a.t===0&&h}while((Math.abs(a.s)>=C.tolerance||Math.abs(a.t)>=C.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<C.distanceEpsilon*C.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!==0&&e.t!==0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let n=1;this.ti+e.t>this.bMax?n=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(n=(this.bMin-this.ti)/e.t);let i=Math.min(t,n);e.s*=i,e.t*=i}else e.s===0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,n=e.start,i=e.end,o=t.start,a=t.end,l=i.sub(n),u=l.length,c=0,h,d,m;if(u>C.distanceEpsilon){l=l.div(u),h=l.dot(i.sub(n)),d=l.dot(o.sub(n)),m=l.dot(a.sub(n));let P=!1;if(d>m){P=!0;let S=d;d=m,m=S}if(m<c)this.aSolution=0,this.bSolution=P?0:1;else if(d>h)this.aSolution=1,this.bSolution=P?1:0;else{let S=Math.min(h,m);this.aSolution=S/(h-c),this.bSolution=(S-d)/(m-d),P&&(this.bSolution=1-this.bSolution)}}else{let P=a.sub(o),S=P.length;if(S>C.distanceEpsilon)if(P=P.div(S),c=0,h=P.dot(a.sub(o)),d=P.dot(n.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let v=Math.min(h,d);this.bSolution=v/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Re=class{constructor(e,t,n,i){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=n,this.b[3]=i,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}toJSON(){return{b:this.b.map(e=>e.toJSON())}}static fromJSON(e){return Re.mkBezier(e.b.map(f.fromJSON))}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=ht.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,n=t*e;return this.l.mul(n).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Re.adjustParamTo01(e),t=Re.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-C.tolerance)return new Re(this.b[3],this.b[3],this.b[3],this.b[3]);let n=new Array(3),i=new Array(2),o=this.casteljau(e,n,i),a=new Re(o,i[1],n[2],this.b[3]),l=a.casteljau((t-e)/(1-e),n,i);return new Re(a.b[0],n[0],i[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,n){let i=1-e;for(let o=0;o<3;o++)t[o]=f.mkPoint(i,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)n[o]=f.mkPoint(i,t[o],e,t[o+1]);return f.mkPoint(i,n[0],e,n[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return f.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Re(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.bbox&&(this.bbox=z.translate(this.bbox,e)),this.pBoxNode=null}scaleFromOrigin(e,t){return new Re(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Re.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,n,i){let o=i.sub(e).length,a=t.sub(e).length+n.sub(t).length+i.sub(n).length;if(a-o>C.lineSegmentThreshold){let l=f.middle(e,t),u=f.middle(t,n),c=f.middle(n,i),h=f.middle(l,u),d=f.middle(c,u),m=f.middle(h,d);return Re.lengthOnControlPolygon(e,l,h,m)+Re.lengthOnControlPolygon(m,d,c,i)}return(a+o)/2}get boundingBox(){return this.bbox?this.bbox:this.bbox=z.mkOnPoints(this.b)}transform(e){return new Re(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,n){let i=(n-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*i+t)),c=u.dot(u);c<a&&(a=c,o=l*i+t)}return Fs.closestPoint(this,e,o,t,n)}clone(){return new Re(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Re(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),n=this.Yp(e),i=t*t+n*n;return Math.sqrt(i*i*i)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let n=0,i=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<i&&(i=l,n=o*.125)}return Fs.closestPoint(this,e,n,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),n=this.Yp(e),i=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+n*n),c=t*i+n*o;return 3*(c*c/u+u*(i*i+t*a+o*o+n*l))}Gp(e){let t=this.Xp(e),n=this.Yp(e),i=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+n*n)*(t*i+n*o)}getParameterAtLength(e){let t=0,n=1;for(;n-t>C.tolerance;){let i=(n+t)/2,o=this.evaluateError(e,i);if(o>0)n=i;else if(o<0)t=i;else return i}return(t+n)/2}evaluateError(e,t){let n=1-t,i=f.mkPoint(n,this.b[0],t,this.b[1]),o=f.mkPoint(n,this.b[1],t,this.b[2]),a=f.mkPoint(n,this.b[2],t,this.b[3]),l=f.mkPoint(n,i,t,o),u=f.mkPoint(n,o,t,a),c=f.mkPoint(n,l,t,u),h=Re.lengthOnControlPolygon(this.b[0],i,l,c);return h>e+C.distanceEpsilon?1:h<e-C.distanceEpsilon?-1:0}};function _T(s){return s.seg.value(s.par)}function VT(s){return s.seg.derivative(s.par)}function kT(s){return s.seg.secondDerivative(s.par)}function UT(s){return s.seg.thirdDerivative(s.par)}function WT(s){if(s instanceof he)return{tag:"ellipse",segData:s.toJSON()};if(s instanceof R)return{tag:"lineSegment",segData:s.toJSON()};if(s instanceof Re)return{tag:"bezier",segData:s.toJSON()};throw new Error("not implemented")}var x=class{static fromJSON(e){let t=new x;for(let n of e.segs)switch(n.tag){case"bezier":t.addSegment(Re.fromJSON(n.segData));break;case"ellipse":t.addSegment(he.fromJSON(n.segData));break;case"lineSegment":t.addSegment(R.fromJSON(n.segData));break;default:throw new Error("not implemented")}return t}toJSON(){return{segs:this.segs.map(e=>WT(e))}}static CurvesIntersect(e,t){return e===t||x.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let n={start:e,end:t};this.adjustStartEndEndParametersToDomain(n);let i=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(i.segIndex<o.segIndex){let a=this.segs[i.segIndex],l=a.lengthPartial(i.par,a.parEnd);for(let u=i.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new x;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=x.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let n=new x;for(let i of this.segs)n.addSegment(i.scaleFromOrigin(e,t));return n}trim(e,t){let n={start:e,end:t};this.adjustStartEndEndParametersToDomain(n);let i=this.getSegIndexParam(n.start),o=this.getSegIndexParam(n.end);if(i.segIndex===o.segIndex)return this.segs[i.segIndex].trim(i.par,o.par);let a=new x;i.par<this.segs[i.segIndex].parEnd&&(a=a.addSegment(this.segs[i.segIndex].trim(i.par,this.segs[i.segIndex].parEnd)));for(let l=i.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.boundingBox_&&(this.boundingBox_=z.translate(this.boundingBox_,e)),this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let n=new x;return n.addSegment(this.trim(e,this.parEnd)),n.addSegment(this.trim(this.parStart,t)),n}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(this.boundingBox_=null,!(e instanceof x))this.segs.push(e),this.parEnd_+=x.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=x.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let n of this.segs){let i=n.pNodeOverICurve();e.push(i.parallelogram),t.push(i)}return this.pBNode={parallelogram:Oe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:C.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,n){let i=x.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return n&&i!=null&&(i=x.liftIntersectionToCurves(e,t,i)),i}static getAllIntersections(e,t,n){return e instanceof R?x.getAllIntersectionsOfLineAndICurve(e,t,n):x.getAllIntersectionsInternal(e,t,n)}static getAllIntersectionsInternal(e,t,n){let i=[];if(x.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),i),n)for(let o=0;o<i.length;o++)i[o]=x.liftIntersectionToCurves(e,t,i[o]);return i}static getAllIntersectionsOfLineAndICurve(e,t,n){return t instanceof ee?x.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof x?x.getAllIntersectionsOfLineAndCurve(e,t,n):t instanceof he&&t.isArc()?x.getAllIntersectionsOfLineAndArc(e,t):x.getAllIntersectionsInternal(e,t,n)}static getAllIntersectionsOfLineAndCurve(e,t,n){let i=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(Oe.intersect(o.parallelogram,a.parallelogram)===!1)return i;let l=0;for(let u of t.segs){let c=x.getAllIntersections(e,u,!1);if(n){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)x.alreadyInside(i,h)||i.push(h)}return i}static closeIntersections(e,t){return f.close(e.x,t.x,C.intersectionEpsilon)}static closeIntersectionPoints(e,t){return f.close(e,t,C.intersectionEpsilon)}static alreadyInside(e,t){for(let n=0;n<e.length;n++){let i=e[n];if(x.closeIntersections(i,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let n=e.end.sub(e.start),i=[],o=n.length;if(o<C.distanceEpsilon){let d=e.start.sub(t.center);if(ie(d.length,t.aAxis.length)){let m=f.angle(t.aAxis,d);t.parStart-C.tolerance<=m&&(m=Math.max(m,t.parStart),m<=t.parEnd+C.tolerance&&(m=Math.min(t.parEnd,m),i.push(new xi(0,m,e.start,e,t))))}return i}let a=n.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-C.distanceEpsilon)return i;if(n=a.rotate90Cw(),ie(c,h))x.tryToAddPointToLineCircleCrossing(e,t,i,u,o,n);else{let d=Math.sqrt(c*c-l*l),m=n.mul(d);x.tryToAddPointToLineCircleCrossing(e,t,i,u.add(m),o,n),x.tryToAddPointToLineCircleCrossing(e,t,i,u.sub(m),o,n)}return i}static tryToAddPointToLineCircleCrossing(e,t,n,i,o,a){let u=i.sub(e.start).dot(a);if(u<-C.distanceEpsilon||(u=Math.max(u,0),u>o+C.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=f.angle(t.aAxis,i.sub(t.center));t.parStart-C.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+C.tolerance&&(c=Math.min(t.parEnd,c),n.push(new xi(u,c,i,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let n=[],i=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=x.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a&&(x.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),x.oldIntersection(n,a.x)||n.push(new xi(a.aSol,i+a.bSol,a.x,e,t))),i++}if(t.closed){let a=x.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a&&(x.adjustSolution(e.start,e.end,o.point,t.start,a),x.oldIntersection(n,a.x)||n.push(new xi(a.aSol,i+a.bSol,a.x,e,t)))}return n}static adjustSolution(e,t,n,i,o){x.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):x.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),x.closeIntersectionPoints(o.x,n)?(o.x=n,o.bSol=Math.floor(o.bSol)):x.closeIntersectionPoints(o.x,i)&&(o.x=i,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!Oe.intersect(e.parallelogram,t.parallelogram))return null;let n=e.node,i=t.node,o=n.hasOwnProperty("children"),a=i.hasOwnProperty("children");if(o&&a)for(let l of n.children)for(let u of i.children){let c=x.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of i.children){let u=x.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of n.children){let u=x.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return x.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,n){if(!Oe.intersect(e.parallelogram,t.parallelogram))return;let i=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(i&&o)for(let a of e.node.children)for(let l of t.node.children)x.curveCurveXWithParallelogramNodes(a,l,n);else if(o)for(let a of t.node.children)x.curveCurveXWithParallelogramNodes(e,a,n);else if(i)for(let a of e.node.children)x.curveCurveXWithParallelogramNodes(a,t,n);else n=x.crossOverLeaves(e,t,n)}static crossOverIntervalsOne(e,t){let n=e.node,i=t.node,o=(n.high-n.low)/2,a=(i.high-i.low)/2;for(let l=1;l<2;l++){let u=l*o+n.low;for(let c=1;c<2;c++){let h=c*a+i.low,d;if(n.chord==null&&i.chord==null?d=x.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,i.low,i.high,u,h):n.chord!=null&&i.chord==null?d=x.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,i.low,i.high,.5*l,h):n.chord==null?(d=x.crossWithinIntervalsWithGuess(e.seg,i.chord,n.low,n.high,0,1,u,.5*c),d&&(d.bSol=i.low+d.bSol*(i.high-i.low))):(d=x.crossWithinIntervalsWithGuess(n.chord,i.chord,0,1,0,1,.5*l,.5*c),d&&(d.aSol=n.low+d.aSol*(n.high-n.low),d.bSol=i.low+d.bSol*(i.high-i.low))),d)return x.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return x.goDeeperOne(e,t)}static crossOverLeaves(e,t,n){let i=e.node,o=t.node,a=!1,l=(i.high-i.low)/2+i.low,u=(o.high-o.low)/2+o.low,c;return i.chord==null&&o.chord==null?c=x.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,o.low,o.high,l,u):i.chord!=null&&o.chord==null?(c=x.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,o.low,o.high,.5,u),c&&(c.aSol=i.low+c.aSol*(i.high-i.low))):i.chord==null?(c=x.crossWithinIntervalsWithGuess(e.seg,o.chord,i.low,i.high,0,1,l,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=x.crossWithinIntervalsWithGuess(i.chord,o.chord,0,1,0,1,.5,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=i.low+c.aSol*(i.high-i.low))),c&&(x.addIntersection(e,t,n,c),a=!0),a||x.goDeeper(n,e,t),n}static addIntersection(e,t,n,i){let o=e.node;x.closeIntersectionPoints(i.x,e.seg.value(o.low))?(i.x=e.seg.value(o.low),i.aSol=o.low):x.closeIntersectionPoints(i.x,e.seg.value(o.high))&&(i.x=e.seg.value(o.high),i.aSol=o.high);let a=t.node;if(x.closeIntersectionPoints(i.x,t.seg.value(a.low))?(i.x=t.seg.value(a.low),i.bSol=a.low):x.closeIntersectionPoints(i.x,t.seg.value(a.high))&&(i.x=t.seg.value(a.high),i.bSol=a.high),!x.oldIntersection(n,i.x)){let u=new xi(i.aSol,i.bSol,i.x,e.seg,t.seg);n.push(u)}}static oldIntersection(e,t){for(let n of e)if(t.sub(n.x).length<C.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,n,i,o){let a=e.node,l=t.node;return x.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),n=a.low):x.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),n=a.high),x.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),i=l.low):x.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),i=l.high),new xi(n,i,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,n,i,o,a,l){let u=e instanceof x?x.liftParameterToCurve(e,n-a.parStart,a):n,c=t instanceof x?x.liftParameterToCurve(t,i-l.parStart,l):i;return new xi(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,n;if(e.seg0 instanceof x){let a=e.seg0.getSegParam(e.par0);t=a.seg,n=a.par}else n=e.par0,t=e.seg0;let i,o;if(e.seg1 instanceof x){let a=e.seg1.getSegParam(e.par1);o=a.par,i=a.seg}else o=e.par1,i=e.seg1;return new xi(n,o,e.x,t,i)}static liftIntersectionToCurves(e,t,n){return x.liftIntersectionToCurves_(e,t,n.par0,n.par1,n.x,n.seg0,n.seg1)}static liftParameterToCurve(e,t,n){if(e===n)return t;if(!e.hasOwnProperty("segs"))return;let i=e,o=0;for(let a of i.segs){if(a===n)return t+o;o+=x.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let n=e.node,i=t.node;if(e.leafBoxesOffset>C.distanceEpsilon&&t.leafBoxesOffset>C.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(n.low,n.high,e.seg,e.leafBoxesOffset/2),u=ht.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);return x.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>C.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(n.low,n.high,e.seg,e.leafBoxesOffset/2);return x.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>C.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);return x.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(n.low),a=e.seg.value(n.high);if(!f.closeDistEps(o,a)){let l=t.seg.value(i.low),u=t.seg.value(i.high);if(!f.closeDistEps(l,u)){let c=e.seg instanceof R?e.seg:R.mkPP(o,a),h=t.seg instanceof R?t.seg:R.mkPP(l,u),d=x.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d)return x.adjustParameters(e,c,t,h,d),x.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,n){let i=t.node,o=n.node,a=t.leafBoxesOffset>C.distanceEpsilon,l=n.leafBoxesOffset>C.distanceEpsilon;if(a&&l){let u=ht.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2),c=ht.createParallelogramNodeForCurveSeg(o.low,o.high,n.seg,n.leafBoxesOffset/2);x.curveCurveXWithParallelogramNodes(u,c,e)}else if(a){let u=ht.createParallelogramNodeForCurveSeg(i.low,i.high,t.seg,t.leafBoxesOffset/2);x.curveCurveXWithParallelogramNodes(u,n,e)}else if(l){let u=ht.createParallelogramNodeForCurveSeg(o.low,o.high,n.seg,n.leafBoxesOffset/2);x.curveCurveXWithParallelogramNodes(t,u,e)}else{let u=t.seg.value(i.low),c=t.seg.value(i.high);if(!f.closeDistEps(u,c)){let h=n.seg.value(o.low),d=n.seg.value(o.high);if(!f.closeDistEps(h,d)){let m=t.seg instanceof R?t.seg:R.mkPP(u,c),P=n.seg instanceof R?n.seg:R.mkPP(h,d),S=x.crossWithinIntervalsWithGuess(m,P,0,1,0,1,.5,.5);S&&(x.adjustParameters(t,m,n,P,S),x.addIntersection(t,n,e,S))}}}}static adjustParameters(e,t,n,i,o){if(t!==e.seg&&!(e.seg instanceof ee))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(i!==n.seg&&!(n.seg instanceof ee))o.bSol=n.seg.closestParameter(o.x);else{let a=n.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let i of this.segs){let o=t+i.parEnd-i.parStart;if(e>=t&&e<=o)return{par:e-t+i.parStart,seg:i};t=o}let n=this.segs[this.segs.length-1];return{seg:n,par:n.parEnd}}getSegIndexParam(e){let t=0,n=this.segs.length;for(let o=0;o<n;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let i=this.segs[n-1];return{segIndex:n-1,par:i.parEnd}}value(e){return _T(this.getSegParam(e))}derivative(e){return VT(this.getSegParam(e))}secondDerivative(e){return kT(this.getSegParam(e))}thirdDerivative(e){return UT(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,n,i,o,a,l,u){if(e instanceof R&&t instanceof R){let d=x.crossTwoLineSegs(e.start,e.end,t.start,t.end,n,i,o,a);if(d!==void 0)return d}let c=x.minDistWithinIntervals(e,t,n,i,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=C.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:f.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,n,i,o,a,l,u){let c=t.sub(e),h=n.sub(i),d=n.sub(e),m=Kn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(m==null)return;let P=m.x,S=m.y,v=e.add(c.mul(P));if(!(P<o-C.tolerance)&&(P=Math.max(P,o),!(P>a+C.tolerance)&&(P=Math.min(P,a),!(S<l-C.tolerance)&&(S=Math.max(S,l),!(S>u+C.tolerance)))))return S=Math.min(S,u),{aSol:P,bSol:S,x:v}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let n=2*t.boundingBox.diagonal,i=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new f(Math.cos(a*i),Math.sin(a*i)),u=R.mkPP(e,e.add(l.mul(n))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(x.AllIntersectionsAreGood(c,t)){for(let d of c)if(f.closeDistEps(d.x,e))return 1;if(c.length%2===1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let n=t.hasOwnProperty("segs"),i=null;if(n||t instanceof ee&&(i=t.toCurve()),i){for(let o of e)if(!x.RealCut(x.DropIntersectionToSegs(o),i,!1))return!1}return!0}static RealCut(e,t,n){let i=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=i.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(f.closeDistEps(u,o.end)){let m=null;for(let v=0;v<t.segs.length-1;v++)if(t.segs[v]===o){m=t.segs[v+1];break}if(m==null)return!1;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parEnd))*P.dot(m.derivative(m.parStart))<C.tolerance)}if(f.closeDistEps(u,o.start)){let m=null;for(let v=t.segs.length-1;v>0;v--)if(t.segs[v]===o){m=t.segs[v-1];break}if(m==null)return!1;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parStart))*P.dot(m.derivative(m.parEnd))<C.tolerance)}let d=c.dot(h);return n?d>C.distanceEpsilon:Math.abs(d)>C.distanceEpsilon}static realCutWithClosedCurve(e,t,n){let i=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=i.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(f.closeDistEps(u,o.end)){let m=null;for(let v=0;v<t.segs.length;v++)if(t.segs[v]===o){m=t.segs[(v+1)%t.segs.length];break}if(m==null)throw new Error;let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parEnd))*P.dot(m.derivative(m.parStart))<C.tolerance)}if(f.closeDistEps(u,o.start)){let m=null;for(let v=0;v<t.segs.length;v++)if(t.segs[v]===o){m=t.segs[v>0?v-1:t.segs.length-1];break}let P=c.rotate(Math.PI/2);return!(P.dot(o.derivative(o.parStart))*P.dot(m.derivative(m.parEnd))<C.tolerance)}let d=c.dot(h);return n?d>C.distanceEpsilon:Math.abs(d)>C.distanceEpsilon}static minDistWithinIntervals(e,t,n,i,o,a,l,u){let c=new Em(e,t,n,i,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.boundingBox_)return this.boundingBox_;if(this.segs.length===0)this.boundingBox_=z.mkEmpty();else{let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return this.boundingBox_=e}}clone(){let e=new x;for(let t of this.segs)e.addSegment(t.clone());return this.boundingBox_!=null&&(e.boundingBox_=this.boundingBox_.clone()),e}getParameterAtLength(e){let t=0;for(let n of this.segs){let i=n.length;if(i>=e)return t+n.getParameterAtLength(e);e-=i,t+=n.parEnd-n.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new x;for(let n of this.segs)t.addSegment(n.transform(e));return this.boundingBox_&&(t.boundingBox_=this.boundingBox_.transform(e)),t}closestParameterWithinBounds(e,t,n){let i=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>n)break;let u=x.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(n-a)),m=l.closestParameterWithinBounds(e,h,d),P=e.sub(l.value(m)),S=P.dot(P);S<o&&(i=a+m-l.parStart,o=S)}a+=u}return i}closestParameter(e){let t=0,n=Number.MAX_VALUE,i=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);if(u<n){if(t=i+a-o.parStart,u===0)break;n=u}i+=x.paramSpan(o)}return t}static addLineSegment(e,t,n){return e.addSegment(R.mkPP(t,n))}static addLineSegmentCNNP(e,t,n,i){return x.addLineSegment(e,new f(t,n),i)}static addLineSegmentCNNNN(e,t,n,i,o){x.addLineSegment(e,new f(t,n),new f(i,o))}static continueWithLineSegmentNN(e,t,n){x.addLineSegment(e,e.end,new f(t,n))}static continueWithLineSegmentP(e,t){x.addLineSegment(e,e.end,t)}static closeCurve(e){return x.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<C.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=x.paramSpan(t),Math.abs(e)<C.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<C.tolerance)return this.start===this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<C.tolerance)return t;e-=x.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let n=x.getAllIntersections(e,t,!0);if(n.length===0)return x.NonIntersectingCurveIsInsideOther(e,t);if(n.length===1)return e.start.equal(n[0].x)?x.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:x.PointRelativeToCurveLocation(e.start,t)===2;for(let i of x.PointsBetweenIntersections(e,n))if(x.PointRelativeToCurveLocation(i,t)===0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0<u.par0?-1:l.par0>u.par0?1:0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let n=t[t.length-1].par0,i=t[0].par0,o=e.parEnd-n+(i-e.parStart),a=n+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let n=e.parStart;n<e.parEnd;n+=.5){let i=x.PointRelativeToCurveLocation(e.value(n),t);if(i!==1)return i===2}return x.PointRelativeToCurveLocation(e.end,t)!==0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let n=x.getAllIntersections(e,t,!0);if(n.length===0)return x.NonIntersectingCurveIsInsideOther(e,t)||x.NonIntersectingCurveIsInsideOther(t,e);if(n.length===1)return e.start.equal(n[0].x)?x.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)===2||!t.start.equal(n[0].x)?x.PointRelativeToCurveLocation(t.start,e)===2:x.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)===2:x.PointRelativeToCurveLocation(e.start,t)===2;for(let i of x.PointsBetweenIntersections(e,n))if(x.PointRelativeToCurveLocation(i,t)===2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,n,i,o){let a=f.mkPoint(e,n.point,1-e,i.point),l=f.mkPoint(t,o.point,1-t,i.point),u=i.point.mul(2/3);return new Re(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,n,i){let o=n.mul(i);return new Re(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let n=t.next;if(n!=null)return{b:t,c:n}}static trimEdgeSplineWithNodeBoundaries(e,t,n,i){let o=n.parStart,a=n.parEnd;e!=null&&(o=x.findNewStart(n,o,e,i)),t!=null&&(a=x.findNewEnd(n,t,i,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?n.trim(l,u):n}static findNewEnd(e,t,n,i){let o=x.getAllIntersections(e,t,!0);if(o.length===0)return i=e.parEnd,i;if(n){i=e.parEnd;for(let a of o)a.par0<i&&(i=a.par0)}else{i=e.parStart;for(let a of o)a.par0>i&&(i=a.par0)}return i}static findNewStart(e,t,n,i){let o=x.getAllIntersections(e,n,!0);if(o.length===0){t=e.parStart;return}if(i){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof he)return x.refineEllipse(e);if(e instanceof ee)return e;if(e instanceof x&&x.allSegsAreLines(e)){let t=new ee;for(let n of e.segs)t.addPoint(n.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof R))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),n=Math.PI/4,i=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(i*i+o*o),l=[];for(let c=0;c<4;c++){let h=n+c*Math.PI/2,d=e.value(h),m=e.derivative(h).normalize().mul(a),P=R.mkPP(d.sub(m),d.add(m));for(let S of x.getAllIntersections(t,P,!0))l.push(S)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new ee;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new ee;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};function zT(s,e,t,n,i,o){if(i instanceof R)return!0;for(let a of[1/3,.5,2/3]){let l=s*a+t*(1-a);if(f.closeSquare(i.value(l),f.mkPoint(a,e,1-a,n),o*o)===!1)return!1}return!0}function Cm(s,e,t,n,i,o){let a=[];if(zT(s,e,t,n,i,o))a.push(e),a.push(n);else{let l=.5*(s+t),u=i.value(l);a=Cm(s,e,l,u,i,o);let c=Cm(l,u,t,n,i,o).slice(1);a=a.concat(c)}return a}function Hh(s,e){return Cm(s.parStart,s.start,s.parEnd,s.end,s,e)}var ee=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}toJSON(){return{points:Array.from(this).map(e=>e.toJSON())}}static fromJSON(e){return ee.mkFromPoints(e.points.map(t=>f.fromJSON(t)))}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new f(e,t))}isClockwise(){return f.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new Lt;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=Lt.mkFromPoint(e);t.polyline=this,this.startPoint!=null?f.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let n=t.sub(e).div(2);return Oe.parallelogramByCornerSideSide(e,n,n)}static mkFromPoints(e){let t=new ee;for(let n of e)t.addPoint(n);return t}static mkClosedFromPoints(e){let t=ee.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],n=this.startPoint,i=0;for(;n.next!=null;){let o=ee.parallelogramOfLineSeg(n.point,n.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:i,high:i+1,chord:R.mkPP(n.point,n.next.point)}}),n=n.next,i++}if(this.isClosed_){let o=ee.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:i,high:i+1,chord:R.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:Oe.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=z.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return f.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new f(0,0)}thirdDerivative(e){return new f(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new ee;t.addPoint(e.start);for(let n of e.segs)t.addPoint(n.end);return t.closed=e.start===e.end,t}trim(e,t){let n=this.toCurve();return n=n.trim(e,t),ee.polylineFromCurve(n)}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t===this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new ee;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t===this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new ee;for(let n of this.polylinePoints())t.addPoint(e.multiplyPoint(n.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,n){throw new Error("Method not implemented.")}closestParameter(e){let t=0,n=Number.MAX_VALUE,i=0,o=this.startPoint;for(;o.next!=null;){let a=R.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<n&&(n=c,t=l+i),o=o.next,i++}if(this.closed){let a=R.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<n&&(t=l+i)}return t}clone(){let e=new ee;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t===this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new x;x.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)x.continueWithLineSegmentP(e,t.point);return this.closed&&x.continueWithLineSegmentP(e,this.startPoint.point),e}RemoveCollinearVertices(){for(let e=this.startPoint.next;e.next!=null;e=e.next)f.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2&&(e.prev.next=e.next,e.next.prev=e.prev);return this.setInitIsRequired(),this}};var vt=class{pad(e){this.width+=e*2}constructor(e,t=e){this.width=e,this.height=t}},z=class{transform(e){return z.mkPP(e.multiplyPoint(this.leftTop),e.multiplyPoint(this.rightBottom))}translate(e){return z.mkSizeCenter(this.size,this.center.add(e))}equal(e){return this.left_===e.left&&this.right_===e.right&&this.top_===e.top&&this.bottom_===e.bottom}equalEps(e){return ie(this.left_,e.left)&&ie(this.right_,e.right)&&ie(this.top_,e.top)&&ie(this.bottom_,e.bottom)}static mkSizeCenter(e,t){let n=e.width/2,i=e.height/2;return new z({left:t.x-n,right:t.x+n,bottom:t.y-i,top:t.y+i})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return z.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=z.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),n=Math.min(this.right,e.right),i=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new z({left:t,bottom:i,right:n,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=this.leftTop.add(this.rightBottom).mul(.5),n=e.sub(t);this.leftTop=this.leftTop.add(n),this.rightBottom=this.rightBottom.add(n)}intersectsOnY(e){return!(e.bottom_>this.top_+C.distanceEpsilon||e.top_<this.bottom_-C.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+C.distanceEpsilon||e.right<this.left_-C.distanceEpsilon)}static mkEmpty(){return new z({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e,this.onUpdated()}get right(){return this.right_}set right(e){this.right_=e,this.onUpdated()}get top(){return this.top_}set top(e){this.top_=e,this.onUpdated()}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e,this.onUpdated()}get leftBottom(){return new f(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new f(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new f(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new f(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}onUpdated(){}static mkPP(e,t){let n=new z({left:e.x,right:e.x,top:e.y,bottom:e.y});return n.add(t),n}static rectangleOnPoint(e){return new z({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,n){let i=e+n.width,o=t+n.height;return new z({left:e,right:i,top:o,bottom:t})}static getRectangleOnCoords(e,t,n,i){let o=new z({left:e,bottom:t,right:e,top:t});return o.add(new f(n,i)),o}static mkOnPoints(e){let t=z.mkEmpty();for(let n of e)t.add(n);return t}static mkOnRectangles(e){let t=z.mkEmpty();for(let n of e)t.addRecSelf(n);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,n=(this.left_+this.right_)/2;this.left_=n-t,this.right_=n+t}isEmpty(){return this.right<this.left}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,n=(this.top_+this.bottom_)/2;this.top_=n+t,this.bottom=n-t}static rectangleOfTwo(e,t){let n=new z({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return n.addRecSelf(t),n}containsWithPadding(e,t){return this.left_-t-C.distanceEpsilon<=e.x&&e.x<=this.right_+t+C.distanceEpsilon&&this.bottom_-t-C.distanceEpsilon<=e.y&&e.y<=this.top_+t+C.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let n=e.clone();return n.center=e.center.add(t),n}static transform(e,t){return z.mkPP(t.multiplyPoint(e.leftTop),t.multiplyPoint(e.rightBottom))}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}containsRectWithPadding(e,t){return this.containsWithPadding(e.leftTop,t)&&this.containsWithPadding(e.rightBottom,t)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?z.mkPP(new f(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new f(Math.min(e.right,t.right),Math.min(e.top,t.top))):z.mkEmpty()}perimeter(){let e=new ee;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return new z({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get size(){return new vt(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let n=e.width/2,i=t.x-n,o=t.x+n,a=e.height/2,l=t.y-a,u=t.y+a;return new z({left:i,right:o,top:u,bottom:l})}addPointWithSize(e,t){let n=e.width/2,i=e.height/2;this.add(new f(t.x-n,t.y-i)),this.add(new f(t.x+n,t.y-i)),this.add(new f(t.x-n,t.y+i)),this.add(new f(t.x+n,t.y+i))}};var Be=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new Be;return t.point=e,t}static mkSiteSP(e,t){let n=new Be;return n.point=t,n.prev=e,e.next=n,n}static mkSiteSPS(e,t,n){let i=new Be;return i.prev=e,i.point=t,i.next=n,e.next=i,n.prev=i,i}get turn(){return this.next==null||this.prev==null?0:f.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new Be;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var Ue=class{static mkFromPoints(e){let t=null,n=null;for(let i of e)if(n==null)n=Be.mkSiteP(i),t=new Ue(n);else{let o=Be.mkSiteP(i);o.prev=n,n.next=o,n=o}return t}clone(){let e=this.headSite,t=null,n,i=null;for(;e!=null;)n=e.clone(),n.prev=t,t!=null?t.next=n:i=n,e=e.next,t=n;return new Ue(i)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*getSegments(){let e=this.headSite,t=e.next;for(;t!=null;)yield R.mkPP(e.point,t.point),e=t,t=t.next}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new x,t=this.headSite,n;do{let i=x.findCorner(t);if(i==null)break;let o=Ue.createBezierSegOnSite(i.b);e.segs.length===0?f.closeDistEps(t.point,o.start)||x.addLineSegment(e,t.point,o.start):f.closeDistEps(e.end,o.start)||x.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=i.b}while(!0);return e.segs.length===0?f.closeDistEps(t.point,t.next.point)?e.segs.push(new Re(t.point,t.point.add(new f(5,5)),t.point.add(new f(-5,5)),n.point)):x.addLineSegment(e,t.point,t.next.point):f.closeDistEps(e.end,t.next.point)||x.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,n=e.nextBezierCoefficient,i=e.prev,o=e.next,a=i.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(n).add(e.point.mul(1-n)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Re.mkBezier([a,u,c,l])}};var ot=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,n){this.elements[e][t]=n}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return ie(this.elements[0][0],1)&&ie(this.elements[0][1],0)&&ie(this.elements[0][2],0)&&ie(this.elements[1][0],0)&&ie(this.elements[1][1],1)&&ie(this.elements[1][2],0)}offset(){return new f(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new ot(1,0,0,0,1,0)}constructor(e,t,n,i,o,a){this.elements=[[e,t,n],[i,o,a]]}static rotation(e){let t=Math.cos(e),n=Math.sin(e);return new ot(t,-n,0,n,t,0)}static scaleAroundCenterTransformation(e,t,n){let i=1-e,o=1-t;return new ot(e,0,i*n.x,0,t,o*n.y)}multiplyPoint(e){return new f(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new ot(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,n=-this.getElem(0,1)/e,i=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-n*this.getElem(1,2),l=-i*this.getElem(0,2)-o*this.getElem(1,2);return new ot(t,n,a,i,o,l)}};var Ai=class{static mkEllipse(e,t,n){return he.mkFullEllipseNNP(e,t,n)}static createParallelogram(e,t,n){let i=t/2,o=e/2,a=n.x,l=n.y,u=80*Math.PI/180,c=i/Math.tan(u);return ee.mkClosedFromPoints([new f(-o-c+a,-i+l),new f(o+a,-i+l),new f(o+a+c,i+l),new f(-o+a,i+l)])}static createHexagon(e,t,n){let i=t/2,o=e/2,a=n.x,l=n.y;return ee.mkClosedFromPoints([new f(-o+a,-i+l),new f(o+a,-i+l),new f(o+(i+a),0+l),new f(o+a,i+l),new f(-o+a,i+l),new f(-(o-i)+a,0+l)])}static createOctagon(e,t,n){let i=e/2,o=t/2,a=new Array(8);a[0]=new f(i+Ai.octagonPad*i,o-o*Ai.octagonPad),a[3]=new f(a[0].x*-1,a[0].y),a[4]=new f(a[3].x,a[3].y*-1),a[7]=new f(a[0].x,a[0].y*-1),a[1]=new f(i-i*Ai.octagonPad,o+o*Ai.octagonPad),a[2]=new f(a[1].x*-1,a[1].y),a[6]=new f(a[1].x,a[1].y*-1),a[5]=new f(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(n);return ee.mkClosedFromPoints(a)}static createInvertedHouse(e,t,n){let i=Ai.createHouse(e,t,n);return Ai.rotateCurveAroundCenterByDegree(i,n,180)}static createHouse(e,t,n){let i=e/2,o=t/2,a=n.x,l=n.y,u=new x;return x.addLineSegmentCNNNN(u,a-i,l-o,a+i,l-o),x.continueWithLineSegmentNN(u,a+i,l+o),x.continueWithLineSegmentNN(u,a,l+2*o),x.continueWithLineSegmentNN(u,a-i,l+o),x.closeCurve(u)}static mkDiamond(e,t,n){let i=e,o=t,a=n.x,l=n.y,u=new x,c=[new f(a,l-o),new f(a+i,l),new f(a,l+o),new f(a-i,l)];return u.addSegs([R.mkPP(c[0],c[1]),R.mkPP(c[1],c[2]),R.mkPP(c[2],c[3]),R.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,n){return Ai.rotateCurveAroundCenterByRadian(e,t,n*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,n){let i=Math.cos(n),o=Math.sin(n),a=new ot(1,0,t.x,0,1,t.y).multiply(new ot(i,-o,0,o,i,0)).multiply(new ot(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return he.mkCircle(e,t)}static createRectangle(e,t,n){let i=e/2,o=t/2,a=n.x,l=n.y,u=new x,c=[new f(a-i,l-o),new f(a+i,l-o),new f(a+i,l+o),new f(a-i,l+o)];return u.addSegs([R.mkPP(c[0],c[1]),R.mkPP(c[1],c[2]),R.mkPP(c[2],c[3]),R.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof x))return;let t=e.segs;if(t.length!==8&&t.length!==4)return;let n=t.length===8,i,o;for(let a=0;a<4;a++){let l=n?2*a+1:a;if(a===0){if(!(t[l]instanceof he))return;let u=t[l];i=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof he))return;let u=t[l];if(i!==u.aAxis.length||o!==u.bAxis.length)return}}return{radX:i,radY:o}}static mkRectangleWithRoundedCorners(e,t,n,i,o=new f(0,0)){if(n===0||i===0)return Ai.createRectangle(e,t,o);let a=new x,l=e/2;n>l/2&&(n=l/2);let u=t/2;i>u/2&&(i=u/2);let c=o.x,h=o.y,d=l-n,m=u-i,P=h+u,S=h-u,v=c-l,I=c+l,L=new f(n,0),D=new f(0,i);return d>0&&a.addSegment(R.mkPP(new f(c-d,S),new f(c+d,S))),a.addSegment(he.mkEllipse(1.5*Math.PI,2*Math.PI,L,D,c+d,h-m)),m>0&&a.addSegment(R.mkPP(new f(I,h-m),new f(I,h+m))),a.addSegment(he.mkEllipse(0,.5*Math.PI,L,D,c+d,h+m)),d>0&&a.addSegment(R.mkPP(new f(c+d,P),new f(c-d,P))),a.addSegment(he.mkEllipse(.5*Math.PI,Math.PI,L,D,c-d,h+m)),m>0&&a.addSegment(R.mkPP(new f(v,h+m),new f(v,h-m))),a.addSegment(he.mkEllipse(Math.PI,1.5*Math.PI,L,D,c-d,h-m)),a}},Ce=Ai;Ce.octagonPad=1/4;function wn(s){return s.parEnd-s.parStart}function jh(s){switch(s.type){case"ellipse":return he.fromJSON(s.data);case"curve":return x.fromJSON(s.data);case"lineSegment":return R.fromJSON(s.data);case"bezier":return Re.fromJSON(s.data);case"polyline":return ee.fromJSON(s.data)}}function HT(s){if(s instanceof he)return"ellipse";if(s instanceof x)return"curve";if(s instanceof R)return"lineSegment";if(s instanceof Re)return"bezier";if(s instanceof ee)return"polyline";throw new Error("not implemented")}function qh(s){return{type:HT(s),data:s.toJSON()}}var kr=class{static get DifferenceEpsilon(){return kr.differenceEpsilon}static EqualPP(e,t){return kr.Equal(e.x,t.x)&&kr.Equal(e.y,t.y)}static Equal(e,t){return kr.Compare(e,t)===0}static Compare(e,t){let n=0;return e+kr.DifferenceEpsilon<t?n=-1:t+kr.DifferenceEpsilon<e&&(n=1),n}static ComparePP(e,t){let n=kr.Compare(e.x,t.x);return n===0&&(n=kr.Compare(e.y,t.y)),n}static LessOrEqual(e,t){let n=kr.Compare(e,t);return n<0||n===0}static Less(e,t){return kr.Compare(e,t)<0}static GetDirections(e,t){return H.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return H.IsPureDirection(kr.GetDirections(e,t))}static IsPureDirectionD(e){return H.IsPureDirection(e)}static IsPureLower(e,t){let n=kr.GetDirections(e,t);return 2===n||1===n}static GetPureDirectionVV(e,t){return kr.GetDirections(e.point,t.point)}},F=kr;F.differenceEpsilon=C.distanceEpsilon/2;var H=class{constructor(e){this.Dir=e}get Right(){return new H(H.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>F.DifferenceEpsilon?t=2:e.x<-F.DifferenceEpsilon&&(t=8),e.y>F.DifferenceEpsilon?t=t|1:e.y<-F.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let n=0,i=t.x-e.x,o=t.y-e.y;return i>F.DifferenceEpsilon?n=2:-i>F.DifferenceEpsilon&&(n=8),o>F.DifferenceEpsilon?n|=1:-o>F.DifferenceEpsilon&&(n|=4),n}static DirectionFromPointToPoint(e,t){return H.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return H.IsPureDirection(H.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e===t||e===H.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)===2&&e++,(this.Dir&1)===1&&t++,(this.Dir&8)===8&&e--,(this.Dir&4)===4&&t--,new f(e,t)}static toPoint(e){return new H(e).ToPoint()}static negate(e){return new H(H.OppositeDir(e.Dir))}};var Ur=class extends ce{constructor(e,t){super(e);this._isPositioned=!1;t&&(this.boundingBox=z.mkPP(new f(0,0),new f(t.width,t.height)))}clone(){let e=new Ur(null,null);return e.isPositioned=this.isPositioned,e._boundingBox=this._boundingBox.clone(),e.attachmentSegmentEnd=this.attachmentSegmentEnd,e.attachmentSegmentStart=this.attachmentSegmentStart,e}get isPositioned(){return this._isPositioned}set isPositioned(e){this._isPositioned=e}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}setBoundingBox(e){this.isPositioned=!0,this._boundingBox=e}get width(){return this.boundingBox.width}set width(e){this.boundingBox.width=e}get height(){return this.boundingBox.height}set height(e){this.boundingBox.height=e}get center(){return this.boundingBox.center}set center(e){this.boundingBox.center=e}translate(e){this.isPositioned&&(this.center=this.center.add(e))}transform(e){this.isPositioned&&(this.center=e.multiplyPoint(this.center))}positionCenter(e){this.boundingBox.center=e,this.isPositioned=!0}};var be=class extends ce{constructor(e){super(e);this.lineWidth=1}static getGeom(e){return ce.getGeom(e)}clone(){let e=new be(null);return this.smoothedPolyline&&(e.smoothedPolyline=this.smoothedPolyline.clone()),e.curve=this.curve.clone(),this.sourceArrowhead!=null&&(e.sourceArrowhead=this.sourceArrowhead.clone()),this.targetArrowhead!=null&&(e.targetArrowhead=this.targetArrowhead.clone()),e}get label(){return this.edge!=null&&this.edge.label!=null?ce.getGeom(this.edge.label):null}set label(e){this.edge.label.setAttr(ae.GeomObjectIndex,e)}RaiseLayoutChangeEvent(e){this.edge.raiseEvents(e)}requireRouting(){this.curve=null,this.smoothedPolyline=null}translate(e){if(!(e.x===0&&e.y===0)){if(this.curve!=null&&this.curve.translate(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;t!=null;t=t.next,n=n.next)t.point=n.point.add(e);if(this.sourceArrowhead!=null&&this.sourceArrowhead.tipPosition&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(e)),this.targetArrowhead!=null&&this.targetArrowhead.tipPosition&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(e)),this.edge.label){let t=Ur.getGeom(this.edge.label);t&&t.translate(e)}}}GetMaxArrowheadLength(){let e=0;return this.sourceArrowhead!=null&&(e=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>e?this.targetArrowhead.length:e}transform(e){if(this.curve!=null){if(this.curve=this.curve.transform(e),this.smoothedPolyline!=null)for(let t=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;t!=null;t=t.next,n=n.next)t.point=e.multiplyPoint(t.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=e.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=e.multiplyPoint(this.targetArrowhead.tipPosition))}}get edge(){return this.entity}get source(){return ce.getGeom(this.edge.source)}*sourceArrowheadPoints(e){if(this.sourceArrowhead==null)return;yield this.sourceArrowhead.tipPosition;let t=this.sourceArrowhead.tipPosition.sub(this.curve.start);t=t.rotate90Cw().mul(Math.tan(e*.5*(Math.PI/180))),yield t.add(this.curve.start),yield this.curve.start.sub(t)}*targetArrowheadPoints(e){if(this.targetArrowhead==null)return;yield this.targetArrowhead.tipPosition;let t=this.targetArrowhead.tipPosition.sub(this.curve.end);t=t.rotate90Cw().mul(Math.tan(e*.5*(Math.PI/180))),yield t.add(this.curve.end),yield this.curve.end.sub(t)}get boundingBox(){let e=z.mkEmpty();if(this.smoothedPolyline!=null)for(let n of this.smoothedPolyline)e.add(n);this.curve!=null&&e.addRecSelf(this.curve.boundingBox);for(let n of this.sourceArrowheadPoints(25))e.add(n);for(let n of this.targetArrowheadPoints(25))e.add(n);this.label&&e.addRecSelf(this.label.boundingBox);let t=this.lineWidth;return e.left-=t,e.top+=t,e.right+=t,e.bottom-=t,e}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return ce.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(e,t,n){let i=e.boundingBox.width,o=e.boundingBox.height,a=e.boundingBox.center,l=new f(a.x-i/4,a.y),u=new f(a.x-i/4,a.y-o/2-t),c=new f(a.x+i/4,a.y-o/2-t),h=new f(a.x+i/4,a.y);return n.smoothedPolyline=Ue.mkFromPoints([l,u,c,h]),n.smoothedPolyline.createCurve()}underCollapsedGraph(){return this.source.underCollapsedGraph()||this.target.underCollapsedGraph()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};var Tm=Ae(Qn());var Ee=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var Wo=class{constructor(){this.attrs=[];this._parent=null}addEvent(e){this.events.push(e)}removeEvent(e){let t=this.events.indexOf(e);t>=0&&(this.events=this.events.splice(t,1))}raiseEvents(e){this.events.forEach(t=>t(e))}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t===e)return!0;return!1}};var et=class extends Wo{constructor(e,t){super();this.source=e,this.target=t,e!==t?(e.outEdges.add(this),t.inEdges.add(this)):e.selfEdges.add(this)}add(){this.source!==this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!==this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!==this.target.parent}EdgeToAncestor(){return this.source instanceof de&&this.target.isDescendantOf(this.source)?1:this.target instanceof de&&this.source.isDescendantOf(this.target)?2:0}};var tt=class extends Wo{constructor(e){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=e}removeOutEdge(e){this.outEdges.delete(e)}removeInEdge(e){this.inEdges.delete(e)}get id(){return this._id}set id(e){this._id=e}toString(){return this.id}*_edges(){for(let e of this.inEdges)yield e;for(let e of this.outEdges)yield e;for(let e of this.selfEdges)yield e}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}};var vm=class{constructor(){this.nodeMap=new Map}remove(e){this.nodeMap.delete(e.id)}get size(){return this.nodeMap.size}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof de&&(yield e)}findShallow(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}get nodeShallowCount(){return this.nodeMap.size}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.nodeMap.set(e.id,e)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!==e||t.source===t.target)return!1;for(let t of e.inEdges)if(t.target!==e||t.source===t.target)return!1;for(let t of e.selfEdges)if(t.target!==t.source||t.source!==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap.values())if(!this.nodeIsConsistent(e))return!1;return!0}};var de=class extends tt{constructor(e="__graph__"){super(e);this.nodeCollection=new vm}remove(e){this.nodeCollection.remove(e)}removeSubgraph(){let e=this.parent;e&&e.removeNode(this);for(let t of this.outGoingEdges())t.attachedAtSource?t.node.removeOutEdge(t.edge):t.node.removeInEdge(t.edge)}*outGoingEdges(){for(let e of this.outEdges){let t=e.target;this.isAncestor(t)||(yield{edge:e,node:t,attachedAtSource:!1})}for(let e of this.inEdges){let t=e.source;this.isAncestor(t)||(yield{edge:e,node:t,attachedAtSource:!0})}for(let e of this.nodesBreadthFirst){for(let t of e.outEdges){let n=t.target;n!==this&&(this.isAncestor(n)||(yield{edge:t,node:n,attachedAtSource:!1}))}for(let t of e.inEdges){let n=t.source;n!==this&&(this.isAncestor(n)||(yield{edge:t,node:n,attachedAtSource:!0}))}}}isAncestor(e){for(let t of e.getAncestors())if(t===this)return!0;return!1}*getClusteredConnectedComponents(){let e=new Set,t=new Tm.Queue;for(let n of this.nodesBreadthFirst){if(e.has(n))continue;e.add(n),t.enqueue(n);let i=new Set;do{let o=t.dequeue();o.parent===this&&i.add(o);for(let a of this.reachableFrom(o))e.has(a)||(e.add(a),t.enqueue(a))}while(t.length>0);yield Array.from(i)}}*reachableFrom(e){for(let t of e.outEdges)yield t.target;for(let t of e.inEdges)yield t.source;e instanceof de&&(yield*e.shallowNodes),e.parent!=this&&(yield e.parent)}hasSomeAttrOnIndex(e){for(let t of this.nodesBreadthFirst)if(t.getAttr(e))return!0;for(let t of this.deepEdges)if(t.getAttr(e))return!0;return!1}*graphs(){for(let e of this.nodeCollection.graphs)yield e}noEmptySubgraphs(){for(let e of this.subgraphsBreadthFirst())if(e.shallowNodeCount===0)return!1;return!0}hasSubgraphs(){for(let e of this.shallowNodes)if(e instanceof de)return!0;return!1}*subgraphsBreadthFirst(){for(let e of this.nodesBreadthFirst)e instanceof de&&(yield e)}isEmpty(){return this.shallowNodeCount===0}setEdge(e,t){let n=this.nodeCollection.findShallow(e);if(n==null)return;let i=this.nodeCollection.findShallow(t);if(i!=null)return new et(n,i)}get shallowNodes(){return this.nodeCollection.nodesShallow}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let e of this.nodeCollection.nodesShallow)yield e,e instanceof de&&(yield*e.nodesBreadthFirst)}findNodeRecursive(e){let t=this.nodeCollection.findShallow(e);if(t)return t;for(let n of this.shallowNodes)if(n instanceof de){let i=n.findNodeRecursive(e);if(i)return i}return null}findNode(e){return this.nodeCollection.findShallow(e)}get shallowEdges(){return this.nodeCollection.edges}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let e of this.nodesBreadthFirst){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t;for(let t of e.inEdges)this.isAncestor(t.source)||(yield t)}}isConsistent(){return this.parent?this.parent.isConsistent():this.eachNodeIdIsUnique()&&this.nodeCollection.isConsistent()}nodeIsConsistent(e){return this.nodeCollection.nodeIsConsistent(e)}removeNode(e){for(let t of e.outEdges)t.target.inEdges.delete(t);for(let t of e.inEdges)t.source.outEdges.delete(t);this.nodeCollection.remove(e);for(let t of this.subgraphsBreadthFirst())t.removeNode(e)}addNode(e){return Ee.assert(this.findNodeRecursive(e.id)==null),e.parent=this,this.nodeCollection.addNode(e),e}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){let e=this.nodeCollection.size;for(let t of this.shallowNodes)t instanceof de&&(e+=t.nodeCountDeep);return e}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(e){for(;e!=null&&e.parent!==this;)e=e.parent;return e}deepEdgesCount(){let e=0;for(let t of this.nodesBreadthFirst)e+=t.outDegree+t.selfDegree;return e}eachNodeIdIsUnique(){let e=new Set;for(let t of this.nodesBreadthFirst){if(e.has(t.id))return!1;e.add(t.id)}return!0}*allElements(){for(let e of this.allSuccessorsWidthFirst()){yield e;for(let t of e.selfEdges)yield t;for(let t of e.outEdges)yield t;for(let t of e.inEdges)this.isAncestor(t.source)||(yield t)}yield*this.edges}*allSuccessorsWidthFirst(){for(let e of this.shallowNodes)yield e;for(let e of this.shallowNodes)e instanceof de&&(yield*e.allSuccessorsWidthFirst())}*allSuccessorsDepthFirst(){for(let e of this.shallowNodes)e instanceof de&&(yield*e.allSuccessorsDepthFirst()),yield e}};function*c0(s){let e=new Set,t=new Tm.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(i(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of n(l))i(u,t,e)}yield a}function*n(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function i(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function Im(s,e){e.parent&&e.parent.remove(e),s.addNode(e)}var _s=class extends ce{constructor(){super(...arguments);this.padding=1}clone(){let e=new _s(null);return this.boundaryCurve&&(e.boundaryCurve=this.boundaryCurve.clone()),e}translate(e){e.x===0&&e.y===0||this.boundaryCurve.translate(e)}toJSON(){return{boundaryCurve:this.boundaryCurve,padding:this.padding}}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(e){e!=null&&e.boundingBox&&(e.boundingBox.height<_s.minHeight||e.boundingBox.width<_s.minWidth)&&(e=Ce.mkCircle(_s.minWidth,e.boundingBox.center)),this._boundaryCurve=e}get id(){return this.node.id}toString(){return this.id}static mkNode(e,t){let n=new _s(t);return n.boundaryCurve=e,n}get center(){return this.boundaryCurve.boundingBox.center}set center(e){let t=e.sub(this.center);this.boundaryCurve.translate(t)}fitBoundaryCurveToTarget(e){if(this.boundaryCurve!=null){let t=Ce.isRoundedRect(this.boundaryCurve);if(t==null){let n=e.width/this.boundaryCurve.boundingBox.width,i=e.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(n,i),this.boundaryCurve.translate(e.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=Ce.mkRectangleWithRoundedCorners(e.width,e.height,t.radX,t.radY,e.center)}}static getGeom(e){return e.getAttr(ae.GeomObjectIndex)}*inEdges(){for(let e of this.node.inEdges)yield ce.getGeom(e)}*outEdges(){for(let e of this.node.outEdges)yield ce.getGeom(e)}*selfEdges(){for(let e of this.node.selfEdges)yield ce.getGeom(e)}get boundingBoxWithPadding(){let e=this.boundingBox.clone();return e.pad(this.padding),e}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(e){!this.boundaryCurve||(Math.abs(e.width-this.width)<1e-4&&Math.abs(e.height-this.height)<1e-4?this.center=e.center:this.fitBoundaryCurveToTarget(e))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(e){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(e))}underCollapsedGraph(){let e=this.node.parent;if(e==null)return!1;let t=ce.getGeom(e);return t==null?!1:t.isCollapsed?!0:t.underCollapsedGraph()}*getAncestors(){for(let e of this.node.getAncestors())yield ce.getGeom(e)}},Ge=_s;Ge.minHeight=2,Ge.minWidth=3;var Pe=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var wm=class{},ol=wm;ol.GoldenRatio=(1+Math.sqrt(5))/2,ol.GoldenRatioRemainder=2-wm.GoldenRatio;var zo=class extends Pe{constructor(e,t){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=e,this.desiredAspectRatio=t}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(e,t,n){let i=zo.GetGoldenSectionStep(e,t),o=Math.max(n/10,(t-e)/zo.MaxSteps);t+=o,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length===1?this.PackLimit(e):this.rectangles.length===2?(this.PackLimit(e),this.PackLimit(t)):this.rectangles.length>2&&zo.GoldenSectionSearch(l=>this.PackLimit(l),e,i,t,o);let a=this.bestPacking.getRects();for(let l=0;l<this.rectangles.length;l++)this.rectangles[l]=a[l]}PackLimit(e){let t=this.cachedCosts.get(e);if(t==null){let n=this.createPacking(this.rectangles,e);n.run(),this.cachedCosts.set(e,t=Math.abs(n.PackedAspectRatio-this.desiredAspectRatio)),t<this.bestPackingCost&&(this.bestPackingCost=t,this.bestPacking=n)}return t}static GoldenSectionSearch(e,t,n,i,o){if(Math.abs(t-i)<o)return e(t)<e(i)?t:i;let a=zo.GetGoldenSectionStep(n,i),l=e(n),u=e(a),c=()=>zo.GoldenSectionSearch(e,a,n,t,o),h=()=>zo.GoldenSectionSearch(e,n,a,i,o);if(u<l)return h();if(u>l)return c();let d=h(),m=c();return e(m)<e(d)?m:d}static GetGoldenSectionStep(e,t){return e<t?e+ol.GoldenRatioRemainder*(t-e):e-ol.GoldenRatioRemainder*(e-t)}},Yh=zo;Yh.MaxSteps=1e3;var d0=Ae(Ln());var Om=class extends Pe{get PackedWidth(){return this.packedWidth}set PackedWidth(e){this.packedWidth=e}get PackedHeight(){return this.packedHeight}set PackedHeight(e){this.packedHeight=e}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let e=[];for(let[t,n]of this.rectsToCenters)t.center=n,e.push(t);return e}};var sl=class extends Om{constructor(e,t,n=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=n?e:sl.SortRectangles(e),this.wrapWidth=t}static SortRectangles(e){return e.sort((t,n)=>n.height-t.height),e}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let e=new d0.Stack,t=!1,n=0,i=0,o=0,a=this.rectanglesByDescendingHeight;for(let l=0;t||l<a.length;){let u=a[l],c=e.length>0?e.top:null;if(c==null||c.right+u.width<=this.wrapWidth&&n+u.height<=c.top){let d=new f(c?c.right:0,n).add(new f(u.width/2,u.height/2));u.center=d,this.rectsToCenters.set(u,d),i=Math.max(i,u.right),o=Math.max(o,u.top),e.push(u),t=!1}else n=c.top,e.pop(),t=!0;t||l++}this.PackedWidth=i,this.PackedHeight=o}};var Mu=class extends Yh{constructor(e,t){super(sl.SortRectangles(e),t);this.createPacking=(n,i)=>new sl(n,i,!0)}run(){let e=Number.MAX_VALUE,t=0,n=0;for(let i of this.rectangles){let o=i.width;n+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,n,e)}};var Du=Ae(Ln());function XT(s,e,t,n,i,o){for(let l=0;l<s.length;l++){if(l===e||l===t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;n.length*2<i.length?(n.push(s[l]),o.box0=u):i.length*2<n.length?(i.push(s[l]),o.box1=h):c<d?(n.push(s[l]),o.box0=u):d<c?(i.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(n.push(s[l]),o.box0=u):(i.push(s[l]),o.box1=h)}}function Ke(s){if(s.length===0)return null;if(s.length===1)return s[0];let e={b0:s[0].irect,seed0:1},t=YT(s,e),n=[],i=[];n.push(s[e.seed0]),i.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};XT(s,e.seed0,t,n,i,o);let a=g0(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=Ke(n),a.Right=Ke(i),a}function f0(s,e){return s.add_rect(e).area}function YT(s,e){let t=f0(e.b0,s[e.seed0].irect);for(let i=2;i<s.length;i++){let o=f0(e.b0,s[i].irect);o>t&&(e.seed0=i,t=o)}let n;for(let i=0;i<s.length;i++)if(i!==e.seed0){n=i;break}t=s[e.seed0].irect.add_rect(s[n].irect).area;for(let i=0;i<s.length;i++){if(i===e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[i].irect).area;o>t&&(n=i,t=o)}return n}function Vs(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(n=>st(n,e(n)));return Ke(t)}function g0(s){let e=new _u;return e.Count=s,e}function st(s,e){let t=new _u;return t.UserData=s,t.irect=e,t.Count=1,t}function Rm(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)===0?s.Left!=null?Rm(s.Left,e,t)===0&&Rm(s.Right,e,t)===0?0:1:0:1:0}var _u=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent===this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent===this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this===this.Parent.Left}FirstHitNodePF(e,t){var n;return this.irect.contains_point(e)?this.IsLeaf?t!=null?t(e,this.UserData)===1?this:null:this:(n=this.Left.FirstHitNodePF(e,t))!=null?n:this.Right.FirstHitNodePF(e,t):null}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var n;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)===1?this:null:(n=this.Left.FirstHitNodeWithPredicate(e,t))!=null?n:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitByRectWithPredicate(e,t){var n;return this.irect.intersects_rect(e)?this.IsLeaf?t(this.UserData)===1?this:null:(n=this.Left.FirstHitByRectWithPredicate(e,t))!=null?n:this.Right.FirstHitByRectWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t=null){let n=new Du.Stack;for(n.push(this);n.size>0;){let i=n.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?(t==null||t(i.UserData))&&(yield i.UserData):(n.push(i.left),n.push(i.right)))}}*AllHitItems_(e){let t=new Du.Stack;for(t.push(this);t.size>0;){let n=t.pop();n.irect.contains_point(e)&&(n.IsLeaf?yield n.UserData:(t.push(n.left),t.push(n.right)))}}VisitTree(e,t){Rm(this,e,t)}Clone(){let e=g0(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new Du.Stack;for(t.push(this);t.size>0;){let n=t.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?yield n:(t.push(n.left),t.push(n.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new Du.Stack;for(t.push(this);t.size>0;){let n=t.pop();(n.IsLeaf||!e)&&(yield n),n.IsLeaf||(t.push(n.left),t.push(n.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};function vi(s){return new Ti(Ke(s.map(([e,t])=>st(t,e))))}function KT(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function m0(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function QT(s,e){let t=new Array;for(let i of s.GetAllLeafNodes())i!==e&&t.push(i);let n=Ke(t);s.Count=n.Count,s.Left=n.Left,s.Right=n.Right,s.irect=n.Left.irect.add_rect(n.Right.irect)}function JT(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!p0(e))return e;return null}function p0(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function Bm(s,e,t,n){return s.irect.intersects_rect(e)?s.IsLeaf?n(s.UserData)?--t.bound!==0:!0:Bm(s.Left,e,t,n)&&Bm(s.Right,e,t,n):!0}var Ti=class{clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,n){return Bm(this._rootNode,e,{bound:t},n)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(st(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=Ke(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=Ke(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=st(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let n,i;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{n=t.Left.irect.add_rect(e.irect);let o=n.area-t.Left.irect.area;i=t.Right.irect.add_rect(e.irect);let a=i.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=n):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=i):n.area<i.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=n):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=i)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count===0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count===0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count===0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count===0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(n.UserData===t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let n;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))i.UserData===t&&(n=i);if(n!=null)return this.RootNode.Count===1?this.RootNode=null:this.RemoveLeaf(n),n.UserData}RemoveLeaf(e){let t=JT(e);if(t!=null)QT(t,e),m0(t);else{let n=e.Parent;n==null?this._rootNode=new _u:(KT(n,e.IsLeftChild?n.Right:n.Left),m0(n))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!p0(t))return t;return null}};var Nm=class extends z{constructor(e){super(e);this.radX=e.radX,this.radY=e.radY,this.roundedRect_=Ce.mkRectangleWithRoundedCorners(this.width,this.height,e.radX,e.radY,this.center)}onUpdated(){this.isEmpty||(this.roundedRect_=Ce.mkRectangleWithRoundedCorners(this.width,this.height,this.radX,this.radY,this.center))}isOk(){return this.isEmpty()?!0:this.roundedRect_.boundingBox.equalEps(this)}setRect(e){this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.isEmpty()||(this.roundedRect_=Ce.mkRectangleWithRoundedCorners(e.width,e.height,this.radX,this.radY,this.center))}};var at=class{constructor(e,t){il(e,t)<0?(this._first=e,this._second=t):(this._first=t,this._second=e)}get first(){return this._first}get second(){return this._second}get Length(){return _e(this._first,this._second)}CompareTo(e){let t=il(this._first,e._first);return t!==0?t:il(this._second,e._second)}static equal(e,t){return e._first.equal(t._first)&&e._second.equal(t._second)}toString(){return this._first+(" "+this._second)}};function Kh(s,e){let t=e.map(o=>[o,o.boundingBox]),n=t.map(o=>o[1]),i=new Mu(n,1.5);i.run();for(let[o,a]of t){let l=a.leftBottom.sub(o.boundingBox.leftBottom);o.translate(l)}s.boundingBox=new z({left:0,bottom:0,right:i.PackedWidth,top:i.PackedHeight})}var re=class extends Ge{constructor(e){super(e);this.margins={left:10,top:10,bottom:10,right:10};this.radX=10;this.radY=10;this.rrect=new Nm({left:0,right:-1,top:20,bottom:0,radX:this.radX,radY:this.radY})}isAncestor(e){return this.graph.isAncestor(e.node)}deepTranslate(e){for(let t of this.nodesBreadthFirst){t instanceof re?t.boundingBox=t.boundingBox.translate(e):t.translate(e);for(let n of t.selfEdges())n.translate(e);for(let n of t.outEdges())this.graph.isAncestor(n.target.node)&&n.translate(e)}this.boundingBox=this.boundingBox.translate(e)}clone(){let e=new re(null);return e.boundingBox=this.boundingBox.clone(),e.layoutSettings=this.layoutSettings,e.margins=this.margins,e.radX=this.radX,e.radY=this.radY,e}calculateBoundsFromChildren(){let e=z.mkEmpty();for(let t of this.shallowNodes)e.addRecSelf(t.boundingBoxWithPadding);return e.padEverywhere(this.margins),e}*allSuccessorsWidthFirst(){for(let e of this.graph.allSuccessorsWidthFirst())yield Ge.getGeom(e)}static getGeom(e){return ce.getGeom(e)}edgeCurveOrArrowheadsIntersectRect(e,t){for(let o of e.sourceArrowheadPoints(25))if(t.contains(o))return!0;for(let o of e.targetArrowheadPoints(25))if(t.contains(o))return!0;let n=e.curve,i=t.perimeter();return x.intersectionOne(n,i,!1)!=null||x.PointRelativeToCurveLocation(n.start,i)===2}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(e){this.layoutSettings=e;for(let t of this.nodesBreadthFirst){let n=t;n.layoutSettings=e}}get layoutSettings(){return this._layoutSettings}set layoutSettings(e){this._layoutSettings=e}get labelSize(){return this._labelSize}set labelSize(e){this._labelSize=e}get boundingBox(){return this.rrect?this.rrect.clone():null}set boundingBox(e){e?this.rrect.setRect(e):this.rrect.roundedRect_=null}transform(e){if(!e.isIdentity()){for(let t of this.shallowNodes)t.transform(e);for(let t of this.shallowEdges)t.transform(e),t.label&&t.label.transform(e);this.boundingBox=this.rrect==null||this.rrect.isEmpty()?this.pumpTheBoxToTheGraphWithMargins():this.boundingBox.transform(e)}}translate(e){e.x===0&&e.y===0||this.deepTranslate(e)}get nodesBreadthFirst(){return this.nodesBreadthFirstIter()}*nodesBreadthFirstIter(){for(let e of this.graph.nodesBreadthFirst)yield ce.getGeom(e)}setEdge(e,t){let n=this.graph.setEdge(e,t);return new be(n)}getPumpedGraphWithMarginsBox(){let e={b:z.mkEmpty()};return Qh(this,e),e.b.padEverywhere(this.margins),e.b}pumpTheBoxToTheGraphWithMargins(){return this.boundingBox=this.getPumpedGraphWithMarginsBox()}get center(){return this.boundingBox||this.boundingBox.isEmpty?this.boundingBox.center:new f(0,0)}set center(e){let t=e.sub(this.center),n=new ot(1,0,t.x,0,1,t.y);this.transform(n)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}get boundaryCurve(){return this.rrect.roundedRect_}set boundaryCurve(e){throw new Error}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.graph.shallowNodes)yield ce.getGeom(e)}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let e of this.graph.deepEdges)yield ce.getGeom(e)}get shallowEdges(){return this.shallowEdgesIt()}*shallowEdgesIt(){for(let e of this.graph.shallowEdges)yield ce.getGeom(e)}static mk(e,t=new vt(0,0)){let n=new re(new de(e));return n.labelSize=t,n}get Clusters(){return this.subgraphs()}*subgraphs(){for(let e of this.graph.subgraphsBreadthFirst())yield ce.getGeom(e)}static mkWithGraphAndLabel(e,t){let n=new re(e);return n.labelSize=t,n}get deepNodeCount(){let e=0;for(let t of this.graph.nodesBreadthFirst)e++;return e}get subgraphsDepthFirst(){return this.getSubgraphsDepthFirst()}*getSubgraphsDepthFirst(){for(let e of this.graph.allSuccessorsDepthFirst())e instanceof de&&(yield re.getGeom(e))}get uniformMargins(){return Math.max(this.margins.left,this.margins.right,this.margins.right,this.margins.bottom)}set uniformMargins(e){this.margins.left=this.margins.right=this.margins.right=this.margins.bottom=e}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(e){let t=this.graph.liftNode(e.node);return t?ce.getGeom(t):null}findNode(e){let t=this.graph.findNode(e);return t?ce.getGeom(t):null}addNode(e){return this.graph.addNode(e.node),e}addLabelToGraphBB(e){this.labelSize&&(e.top+=this.labelSize.height+2,e.width<this.labelSize.width&&(e.width=this.labelSize.width))}};function Qh(s,e){for(let n of s.shallowEdges){if(!t(n))continue;let i=n.curve.boundingBox;e.b.addRecSelf(i),n.edge.label!=null&&e.b.addRecSelf(ce.getGeom(n.edge.label).boundingBox)}for(let n of s.shallowNodes)"shallowEdges"in n&&Qh(n,e),!(n.underCollapsedGraph()||!n.boundingBox)&&e.b.addRecSelf(n.boundingBox);s instanceof re&&s.addLabelToGraphBB(e.b);function t(n){if(n.curve==null||n.underCollapsedGraph())return!1;if(s instanceof re){let i=s.entity;return i.isAncestor(n.source.entity)&&i.isAncestor(n.target.entity)}else return!0}}function*Gm(s,e,t){if(!s)return;let n=z.mkSizeCenter(new vt(e*2),t);for(let o of s.RootNode.AllHitItems(n,null))"edge"in o?i(t,o.pp._first,o.pp._second)<e&&(yield ce.getGeom(o.edge)):yield ce.getGeom(o);function i(o,a,l){let u=l.sub(a),c=u.length;if(c<1/10)return o.sub(f.middle(a,l)).length;let h=u.rotate90Cw();return Math.abs(o.sub(a).dot(h))/c}}function Mm(s,e){if(s==null)return null;let t=Array.from(s.nodesBreadthFirst).map(o=>[Ge.getGeom(o).boundingBox,o]),n=[];for(let o of s.deepEdges){let a=o.getAttr(ae.GeomObjectIndex);a.label&&n.push([a.label.boundingBox,o.label]);let l=Hh(a.curve,e/2);a.sourceArrowhead&&n.push([z.mkPP(a.sourceArrowhead.tipPosition,a.curve.start),{edge:o,pp:new at(a.sourceArrowhead.tipPosition,a.curve.start)}]);for(let u=0;u<l.length-1;u++)n.push([z.mkPP(l[u],l[u+1]),{edge:o,pp:new at(l[u],l[u+1])}]);a.targetArrowhead&&n.push([z.mkPP(a.curve.end,a.targetArrowhead.tipPosition),{edge:o,pp:new at(a.curve.end,a.targetArrowhead.tipPosition)}])}let i=t.concat(n);return vi(i)}var ye=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x===this.y}};var mn=class{isEmpty(){if(this.arrayOfMaps.length===0)return!0;for(let e of this.arrayOfMaps)if(e.size>0)return!1;return!0}set(e,t,n){this.arrayOfMaps[e].set(t,n)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){e<0||e>=this.arrayOfMaps.length||this.arrayOfMaps[e].delete(t)}has(e,t){return e<0||e>=this.arrayOfMaps.length?!1:this.arrayOfMaps[e].has(t)}get(e,t){return e<0||e>=this.arrayOfMaps.length?null:this.arrayOfMaps[e].get(t)}getI(e){return this.get(e.x,e.y)}constructor(e){this.arrayOfMaps=new Array(e);for(let t=0;t<e;t++)this.arrayOfMaps[t]=new Map}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield new ye(e,n[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield[new ye(e,n[0]),n[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];for(let n of t)yield n[1]}}};var er=class extends Wo{toString(){return"label of "+(this.parent?this.parent.toString():"null")}constructor(e){super();this.parent=e}};var b0=Ae(Qn());function al(s){let e=new tr;return e.SetEdges(s,tr.vertexCount(s)),e}function Jh(s){let e=new tr;return e.SetEdges(s,tr.vertexCount(s)),e}function rr(s,e){let t=new tr;return t.SetEdges(s,e),t}var tr=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let n=e.indexOf(t,0);n>-1&&e.splice(n,1)}removeEdge(e){tr.deleteFromArray(this.edges,e),e.source!==e.target?(tr.deleteFromArray(this.outEdges[e.source],e),tr.deleteFromArray(this.inEdges[e.target],e)):tr.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let n of e)n.source>=t&&(t=n.source),n.target>=t&&(t=n.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let n=new Array(this.nodeCount).fill(0),i=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!==a.target?(n[a.source]++,i[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(n[a]),n[a]=0,this.inEdges[a]=new Array(i[a]),i[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!==u?(this.outEdges[l][n[l]++]=a,this.inEdges[u][i[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!==e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length===0)return;let e=new Set,t=new b0.Queue,n=this.edges[0].source;for(tr.enqueue(e,t,n),yield n;t.length>0;){n=t.dequeue();for(let i of this.outEdges[n]){let o=i.target;e.has(o)||(tr.enqueue(e,t,o),yield o)}for(let i of this.inEdges[n]){let o=i.source;e.has(o)||(tr.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,n){t.enqueue(n),e.add(n)}};var P0=Ae(Ln());var y0=class{constructor(e,t){this.v=e,this.i=t}},pn=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,n,i){t[n]=1,e.push(new y0(n,i))}static getFeedbackSet(e){let t=new mn(e.nodeCount);if(e==null||e.nodeCount===0)return[];let n=new Array(e.nodeCount).fill(0);for(let i=0;i<e.nodeCount;i++){if(n[i]===2)continue;let o=new P0.Stack,a=0;for(pn.push(o,n,i,a);o.size>0;){let l=o.pop();i=l.v,n[i]=2,a=l.i;let u=e.outEdges[i];for(;a<u.length;a++){let c=u[a];if(c.source===c.target)continue;let h=n[c.target];h===1?t.set(c.source,c.target,c):h===0&&(pn.push(o,n,i,a+1),i=c.target,n[c.target]=2,u=e.outEdges[i],a=-1)}}}return Array.from(t.values())}};var S0=Ae(Ut()),bn=class{constructor(e,t,n,i=1){this.Source=e,this.Target=t,this.CrossingWeight=n,this.Weight=i}toString(){return S0.String.Format("{0}->{1}",this.Source,this.Target)}};var ks=class{static FindClosestPoints(e,t){let n=x.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(n)return{curveClosestPoint:n.aX,labelSideClosest:n.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof x){for(let n of e.segs)if((n.start.y-t)*(n.end.y-t)<=0)return n}return null}static ShiftLabel(e,t,n){let i=e.lineWidth/2,o=t.sub(n),a=o.length;a>i&&e.label.positionCenter(e.label.center.add(o.div(a*(a-i))))}static updateLabel(e,t){let n=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new f(t.x+t.rightAnchor/2,t.y)),n=R.mkPP(e.label.boundingBox.leftTop,e.label.boundingBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new f(t.x-t.leftAnchor/2,t.y)),n=R.mkPP(e.label.boundingBox.rightTop,e.label.boundingBox.rightBottom));let i=ks.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(i!=null&&x.getAllIntersections(e.curve,x.polyFromBox(e.label.boundingBox),!1).length===0){let o=ks.FindClosestPoints(i,n);if(o)ks.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=i.closestParameter(n.start),c=i.closestParameter(n.end);i.value(u).sub(n.start).length<i.value(c).sub(n.end).length?(a=i.value(u),l=n.start):(a=i.value(c),l=n.end),ks.ShiftLabel(e,a,l)}}}},Ir=class{constructor(e,t,n,i=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=n,this.weight=i,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.smoothedPolyline}set underlyingPolyline(e){this.edge.smoothedPolyline=e}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source===this.target}reversedClone(){let e=new Ir(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let n=0;n<t;n++){let i=this.LayerEdges[t-1-n];e.LayerEdges[n]=new bn(i.Target,i.Source,i.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e===this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,n=this.LayerEdges[t];ks.updateLabel(this.edge,e[n.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var mr=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let n=this.arrayOfSets[e];return n!==void 0&&n.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new mr;for(let n of e)t.add(n);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let n of t.values())yield new ye(e,n)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let n=this.arrayOfSets[e];n==null&&(this.arrayOfSets[e]=n=new Set),n.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var C0=Ae(Qn());function*Jn(s){let e=new Array(s.nodeCount).fill(!1),t=new C0.Queue;for(let n=0;n<s.nodeCount;n++)if(!e[n]){let i=new Array;for(E0(n,t,e);t.length>0;){let o=t.dequeue();i.push(o);for(let a of tI(s,o))E0(a,t,e)}yield i}}function*tI(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function E0(s,e,t){t[s]===!1&&(e.enqueue(s),t[s]=!0)}var Dm=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new mr;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size===0&&this.minLayerOfGeomGraph.size===0&&this.sameLayerConstraints.length===0&&this.upDownConstraints.length===0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=rr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=pn.getFeedbackSetWithConstraints(e,null);for(let n of t)this.gluedUpDownIntConstraints.remove(n)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new ye(this.maxRepresentative,t))}if(this.minRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.minRepresentative&&this.gluedUpDownIntConstraints.add(new ye(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new mr}gluedIntPairNN(e){return new ye(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new ye(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new ye(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),n=this.nodeToRepr(e.target),i=new Ir(t,n,e.edge);return i.separation=e.separation,i.weight=0,i}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Jn(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return rr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!==-1&&this.maxLayerInt.filter(t=>t!==this.maxRepresentative).map(t=>new ye(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!==-1&&this.minLayerInt.filter(t=>t!==this.minRepresentative).map(t=>new ye(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new ye(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let n of e)this.sameLayerDictionaryOfRepresentatives.set(n,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let n of e)this.sameLayerDictionaryOfRepresentatives.set(n,t=this.minRepresentative);else for(let n of e)t===-1&&(t=n),this.sameLayerDictionaryOfRepresentatives.set(n,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative===t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative===t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!==-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(pn.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let n of this.unglueEdge(t))yield n}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let n of this.intGraph.outEdges[t])this.nodeToRepr(n.target)===e.target&&(yield n)}createGluedGraph(){let e=new mr;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),rr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function rI(s,e){return[s,e]}var Fm=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length===0&&this.upDownVerticalConstraints.length===0&&this.leftRightConstraints.length===0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length===0&&!this.nodeToBlockRoot.has(t)){let n=new Array,i=t;for(let o=e.outEdges[i];o.length>0;o=e.outEdges[i])i=o[0].y,n.push(i),this.nodeToBlockRoot.set(i,t);n.length>0&&this.BlockRootToBlock.set(t,n)}}BasicGraphFromLeftRightIntNeibs(){return al(Array.from(this.LeftRightIntNeibs.values()).map(e=>new ye(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=mr.mk(this.leftRightConstraints.map(t=>rI(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new ye(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!==t.x));let e=pn.getFeedbackSet(al(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new ye(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=mr.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new ye(t[0],t[1]))),this.VerticalInts=mr.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1&&e[t[0]]>e[t[1]]).map(t=>new ye(t[0],t[1])))}};var ul=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(ul||{});var Zn=class{constructor(){this.capacityOverflowCoefficient=Zn.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=Zn.DefaultPathLengthImportance;this.inkImportance=Zn.DefaultInkImportance;this.edgeSeparation=Zn.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.useCubicBezierSegmentsInsideOfHubs=!1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}toJSON(){let e={};return this.capacityOverflowCoefficient!=Zn.DefaultCapacityOverflowCoefficientMultiplier&&(e.capacityOverflowCoefficient=this.capacityOverflowCoefficient),this.RotateBundles&&(e.RotateBundles=this.RotateBundles),this.MaxHubRadius!=50&&(e.MaxHubRadius=this.MaxHubRadius),this.MinHubRadius!=.1&&(e.MinHubRadius=this.MinHubRadius),this.CreateUnderlyingPolyline&&(e.CreateUnderlyingPolyline=this.CreateUnderlyingPolyline),this.pathLengthImportance!=Zn.DefaultPathLengthImportance&&(e.pathLengthImportance=this.pathLengthImportance),this.inkImportance!=Zn.DefaultInkImportance&&(e.inkImportance=this.inkImportance),this.edgeSeparation!=Zn.DefaultEdgeSeparation&&(e.edgeSeparation=this.edgeSeparation),this._edgeWidthShrinkCoeff!=1&&(e._edgeWidthShrinkCoeff=this._edgeWidthShrinkCoeff),this.useCubicBezierSegmentsInsideOfHubs&&(e.useCubicBezierSegmentsInsideOfHubs=this.useCubicBezierSegmentsInsideOfHubs),this.angleThreshold!=Math.PI/180*45&&(e.angleThreshold=this.angleThreshold),this.hubRepulsionImportance!=100&&(e.hubRepulsionImportance=this.hubRepulsionImportance),this.bundleRepulsionImportance!=100&&(e.bundleRepulsionImportance=this.bundleRepulsionImportance),this.minimalRatioOfGoodCdtEdges!=.9&&(e.minimalRatioOfGoodCdtEdges=this.minimalRatioOfGoodCdtEdges),this.highestQuality||(e.highestQuality=this.highestQuality),this.KeepOverlaps&&(e.KeepOverlaps=this.KeepOverlaps),this.StopAfterShortestPaths&&(e.StopAfterShortestPaths=this.StopAfterShortestPaths),e}static createFromJSON(e){let t=new Zn;return e.capacityOverflowCoefficient&&(t.capacityOverflowCoefficient=e.capacityOverflowCoefficient),e.RotateBundles&&(t.RotateBundles=e.RotateBundles),e.MaxHubRadius&&(t.MaxHubRadius=e.MaxHubRadius),e.MinHubRadius&&(t.MinHubRadius=e.MinHubRadius),e.CreateUnderlyingPolyline&&(t.CreateUnderlyingPolyline=e.CreateUnderlyingPolyline),e.pathLengthImportance&&(t.pathLengthImportance=e.pathLengthImportance),e.inkImportance&&(t.inkImportance=e.inkImportance),e.edgeSeparation&&(t.edgeSeparation=e.edgeSeparation),e._edgeWidthShrinkCoeff&&(t._edgeWidthShrinkCoeff=e._edgeWidthShrinkCoeff),e.useCubicBezierSegmentsInsideOfHubs&&(t.useCubicBezierSegmentsInsideOfHubs=e.useCubicBezierSegmentsInsideOfHubs),e.angleThreshold&&(t.angleThreshold=e.angleThreshold),e.hubRepulsionImportance&&(t.hubRepulsionImportance=e.hubRepulsionImportance),e.bundleRepulsionImportance&&(t.bundleRepulsionImportance=e.bundleRepulsionImportance),e.minimalRatioOfGoodCdtEdges&&(t.minimalRatioOfGoodCdtEdges=e.minimalRatioOfGoodCdtEdges),e.highestQuality&&(t.HighestQuality=e.highestQuality),e.KeepOverlaps&&(t.KeepOverlaps=e.KeepOverlaps),e.StopAfterShortestPaths&&(t.StopAfterShortestPaths=e.StopAfterShortestPaths),t}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},$n=Zn;$n.DefaultCapacityOverflowCoefficientMultiplier=1e3,$n.DefaultPathLengthImportance=500,$n.DefaultInkImportance=.01,$n.DefaultEdgeSeparation=.5;var uo=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=2;this.polylinePadding=1;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}toJSON(){let e={};return this.EdgeRoutingMode!=0&&(e.edgeRoutingMode=0),this.ConeAngle!=30*(Math.PI/180)&&(e.coneAngle=this.ConeAngle),this.padding!=3&&(e.padding=this.padding),this.polylinePadding!=1.5&&(e.polylinePadding=this.polylinePadding),this.bundlingSettings&&(e.bundlingSettingsJSON=this.bundlingSettings.toJSON()),e}static fromJSON(e){let t=new uo;return e.edgeRoutingMode&&(e.edgeRoutingMode=t.edgeRoutingMode),e.coneAngle&&(t.coneAngle=e.coneAngle),e.padding&&(t.padding=e.padding),e.polylinePadding&&(t.polylinePadding=e.polylinePadding),e.bundlingSettingsJSON&&(t.bundlingSettings=$n.createFromJSON(e.bundlingSettingsJSON)),e.routingToParentConeAngle&&(t.routingToParentConeAngle=e.routingToParentConeAngle),e.simpleSelfLoopsForParentEdgesThreshold&&(t.simpleSelfLoopsForParentEdgesThreshold=e.simpleSelfLoopsForParentEdgesThreshold),e.incrementalRoutingThreshold&&(t.incrementalRoutingThreshold=e.incrementalRoutingThreshold),e.routeMultiEdgesAsBundles&&(t.routeMultiEdgesAsBundles=e.routeMultiEdgesAsBundles),e.KeepOriginalSpline&&(t.KeepOriginalSpline=e.KeepOriginalSpline),t}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e===1&&this.bundlingSettings==null&&this.bundlingSettings==null&&(this.bundlingSettings=new $n),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var Ii=class{constructor(){this.edgeRoutingSettings=new uo;this.nodeSeparation=10;this.packingAspectRatio=1.5}static fromJSON(e){let t=new Ii;return e.nodeSeparation!=10&&(t.nodeSeparation=e.nodeSeparation),e.packingAspectRatio&&(t.packingAspectRatio=e.packingAspectRatio),e.edgeRoutingSettings&&(t.edgeRoutingSettings=uo.fromJSON(e.edgeRoutingSettings)),t}toJSON(){let e=!1,t={};return this.nodeSeparation!=10&&(t.nodeSeparation=this.nodeSeparation,e=!0),this.packingAspectRatio!=1.5&&(t.packingAspectRatio=this.packingAspectRatio,e=!0),(t.edgeRoutingSettings=this.edgeRoutingSettings.toJSON())&&(e=!0),e?t:void 0}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}};var Ot=class{constructor(){this.commonSettings=new Ii;this.verticalConstraints=new Dm;this.horizontalConstraints=new Fm;this.NoGainAdjacentSwapStepsBound=5;this.RepetitionCoefficientForOrdering=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=ot.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.commonSettings.edgeRoutingSettings.EdgeRoutingMode=3}get NodeSeparation(){return this.commonSettings.NodeSeparation}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}toJSON(){let e={};return this.sameRanks&&(e.sameRanks=this.sameRanks),this.verticalConstraints&&(e.verticalConstraints=this.verticalConstraints),this.horizontalConstraints&&(e.horizontalConstraints=this.horizontalConstraints),this.NoGainAdjacentSwapStepsBound!=5&&(e.horizontalConstraints=this.horizontalConstraints),this.RepetitionCoefficientForOrdering!=1&&(e.RepetitionCoefficientForOrdering=this.RepetitionCoefficientForOrdering),this.AspectRatio&&(e.AspectRatio=this.AspectRatio),this.MaxNumberOfPassesInOrdering!=24&&(e.MaxNumberOfPassesInOrdering=this.MaxNumberOfPassesInOrdering),this.BrandesThreshold!=600&&(e.BrandesThreshold=this.BrandesThreshold),this.LabelCornersPreserveCoefficient!=.1&&(e.LabelCornersPreserveCoefficient=this.LabelCornersPreserveCoefficient),this.MinNodeHeight!=72*.5/4&&(e.MinNodeHeight=this.MinNodeHeight),this.MinNodeWidth!=72*.75/4&&(e.MinNodeWidth=this.MinNodeWidth),this.SnapToGridByY!=0&&(e.SnapToGridByY=this.SnapToGridByY),this.yLayerSep!=10*3&&(e.yLayerSep=this.yLayerSep),this.transform&&(e.transform=this.transform.elements),this.GridSizeByY&&(e.GridSizeByY=this.GridSizeByY),this.GridSizeByX&&(e.GridSizeByX=this.GridSizeByX),e.commonLayoutSettings=this.commonSettings.toJSON(),e}static fromJSON(e){let t=new Ot;return e.sameRanks&&(t.sameRanks=e.sameRanks),e.verticalConstraints&&(t.verticalConstraints=e.verticalConstraints),e.horizontalConstraints&&(t.horizontalConstraints=e.horizontalConstraints),e.NoGainAdjacentSwapStepsBound&&(t.horizontalConstraints=e.horizontalConstraints),e.RepetitionCoefficientForOrdering&&(t.RepetitionCoefficientForOrdering=e.RepetitionCoefficientForOrdering),e.AspectRatio&&(t.AspectRatio=e.AspectRatio),e.MaxNumberOfPassesInOrdering&&(t.MaxNumberOfPassesInOrdering=e.MaxNumberOfPassesInOrdering),e.BrandesThreshold&&(t.BrandesThreshold=e.BrandesThreshold),e.LabelCornersPreserveCoefficient&&(t.LabelCornersPreserveCoefficient=e.LabelCornersPreserveCoefficient),e.MinNodeHeight&&(t.MinNodeHeight=e.MinNodeHeight),e.MinNodeWidth&&(t.MinNodeWidth=t.MinNodeWidth),e.SnapToGridByY&&(t.SnapToGridByY=e.SnapToGridByY),e.yLayerSep&&(t.yLayerSep=e.yLayerSep),e.transform&&(t.transform=new ot(e.transform[0][0],e.transform[0][1],e.transform[0][2],e.transform[1][0],e.transform[1][1],e.transform[1][2])),e.GridSizeByY&&(t.GridSizeByY=e.GridSizeByY),e.GridSizeByX&&(t.GridSizeByX=e.GridSizeByX),e.commonLayoutSettings&&(t.commonSettings=Ii.fromJSON(e.commonLayoutSettings)),t}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=ot.rotation(e);for(let n=0;n<2;n++)for(let i=0;i<3;i++)if(!ie(t.elements[n][i],this.transform.elements[n][i]))return!1;return!0}get layerDirection(){return this.transformIsRotation(0)?0:this.transformIsRotation(Math.PI/2)?1:this.transformIsRotation(-Math.PI/2)?3:this.transformIsRotation(Math.PI)?2:4}set layerDirection(e){switch(e){case 0:this.transform=ot.getIdentity();break;case 1:this.transform=ot.rotation(Math.PI/2);break;case 3:this.transform=ot.rotation(-Math.PI/2);break;case 2:this.transform=ot.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var On=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>C.distanceEpsilon?1:e<-C.distanceEpsilon?-1:0}};var co=class extends tr{constructor(e,t){super();this.SetEdges(e,t)}};var _m=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new mn(e)}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let n=new ye(t.source,t.target),i=new ye(t.target,t.source),o=this.Multiedges.get(n.x,n.y);for(let a of o)a.reverse();if(this.Multiedges.has(i.x,i.y)){let a=this.Multiedges.get(i.x,i.y);for(let l of o)a.push(l)}else this.Multiedges.set(i.x,i.y,o);this.Multiedges.delete(n.x,n.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new ye(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function Vu(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var Pn=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length===0&&t++;if(t===0)return this;let n=new Array(this.y.length);for(let a=0;a<n.length;a++)n[a]=this.y[a]-e[this.y[a]];let i=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(i[a-e[a]]=Array.from(this.layers[a]));let o=new Pn(n);return o.layers=i,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)Vu(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let n of e)this.verticesToX[n]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let n=0;n<this.y.length;n++)e[n]=t-this.y[n];return new Pn(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let n of this.y)n+1>e&&(e=n+1);let t=new Array(e).fill(0);for(let n of this.y)t[n]++;this.layers=new Array(e);for(let n=0;n<e;n++)this.layers[n]=new Array(t[n]),t[n]=0;for(let n=0;n<this.y.length;n++){let i=this.y[n];this.layers[i][t[i]++]=n}}};var ku=class extends Pe{constructor(e,t,n,i){super(i);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=n,this.dag=e,this.layering=t,this.Init()}static Balance(e,t,n,i){new ku(e,t,n,i).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(e){this.jumpers.delete(e);let t=this.possibleJumperFeasibleIntervals.get(e),n=this.CalcJumpInfo(t.x,t.y,e);if(n==null)return;this.layering[e]=n.layerToJumpTo;let i=this.nodeCount[e];this.vertsCounts[n.jumperLayer]-=i,this.vertsCounts[n.layerToJumpTo]+=i,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(n.jumperLayer,e)}IsJumper(e){return this.possibleJumperFeasibleIntervals.has(e)}UpdateRegionsForPossibleJumpersAndInsertJumpers(e,t){let n=new Set;for(let o of this.dag.pred(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),n.add(o));for(let o of this.dag.succ(t))this.IsJumper(o)&&(this.CalculateRegionAndInsertJumper(o),n.add(o));let i=new Array;for(let o of this.possibleJumperFeasibleIntervals)n.has(o[0])||o[1].x>e&&o[1].y<e&&i.push(o[0]);for(let o of i)this.CalculateRegionAndInsertJumper(o)}InitJumpers(){let e=new Array(this.dag.nodeCount).fill(0);for(let t of this.dag.edges)e[t.source]-=t.weight,e[t.target]+=t.weight;this.possibleJumperFeasibleIntervals=new Map;for(let t=0;t<this.dag.nodeCount;t++)e[t]===0&&this.CalculateRegionAndInsertJumper(t)}CalculateRegionAndInsertJumper(e){let t=new ye(this.Up(e),this.Down(e));this.possibleJumperFeasibleIntervals.set(e,t),this.InsertJumper(t.x,t.y,e)}InsertJumper(e,t,n){this.CalcJumpInfo(e,t,n)!=null&&this.jumpers.add(n)}CalcJumpInfo(e,t,n){let i=this.layering[n],o=-1,a=this.vertsCounts[i]-2*this.nodeCount[n];for(let l=e-1;l>i;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);for(let l=i-1;l>t;l--)this.vertsCounts[l]<a&&(a=this.vertsCounts[l],o=l);if(o!==-1)return{jumperLayer:i,layerToJumpTo:o}}Up(e){let t=Number.MAX_SAFE_INTEGER;for(let n of this.dag.inEdges[e]){let i=this.layering[n.source]-n.separation+1;i<t&&(t=i)}return t===Number.MAX_SAFE_INTEGER&&(t=this.layering[e]+1),t}Down(e){let t=Number.NEGATIVE_INFINITY;for(let n of this.dag.outEdges[e]){let i=this.layering[n.target]+n.separation-1;i>t&&(t=i)}return t===Number.NEGATIVE_INFINITY&&(t=this.layering[e]-1),t}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let e of this.layering)this.vertsCounts[e]+=this.nodeCount[e]}ChooseJumper(){for(let e of this.jumpers)return e;throw new Error("there are no jumpers to choose")}};var ei=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let n of t.LayerEdges){let i=Math.max(n.Source,n.Target)+1;i>this.totalNumberOfNodes&&(this.totalNumberOfNodes=i)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let n=1;n<t.LayerEdges.length;n++){let i=t.LayerEdges[n];this.firstVirtualNode=Math.min(this.firstVirtualNode,i.Source)}this.firstVirtualNode===Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let n of t.LayerEdges)n.Target!==t.target&&(this.virtualNodesToInEdges[n.Target-this.firstVirtualNode]=n),n.Source!==t.source&&(this.virtualNodesToOutEdges[n.Source-this.firstVirtualNode]=n)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield ei.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield ei.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new ei(new co(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var cl;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has"),s.name="ReadonlyContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t}s.hasInstance=e})(cl||(cl={}));var Uu;(function(s){s.has=cl.has,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.name="Container";function e(t){return cl.hasInstance(t)&&s.add in t&&s.delete in t}s.hasInstance=e})(Uu||(Uu={}));var Wr;(function(s){s.has=cl.has,s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.name="ReadonlyCollection";function e(t){return cl.hasInstance(t)&&(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t}s.hasInstance=e})(Wr||(Wr={}));var Rt;(function(s){s.size=Wr.size,s.has=Wr.has,s.add=Uu.add,s.delete=Uu.delete,s.clear=Symbol.for("@esfx/collection-core!Collection.clear"),s.name="Collection";function e(t){return Wr.hasInstance(t)&&Uu.hasInstance(t)&&s.clear in t}s.hasInstance=e})(Rt||(Rt={}));var Us;(function(s){s.size=Wr.size,s.has=Wr.has,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt"),s.name="ReadonlyIndexedCollection";function e(t){return Wr.hasInstance(t)&&s.indexOf in t&&s.getAt in t}s.hasInstance=e})(Us||(Us={}));var $h;(function(s){s.size=Wr.size,s.has=Wr.has,s.indexOf=Us.indexOf,s.getAt=Us.getAt,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt"),s.name="FixedSizeIndexedCollection";function e(t){return Us.hasInstance(t)&&s.setAt in t}s.hasInstance=e})($h||($h={}));var x0;(function(s){s.size=Wr.size,s.has=Wr.has,s.indexOf=Us.indexOf,s.getAt=Us.getAt,s.setAt=$h.setAt,s.add=Rt.add,s.delete=Rt.delete,s.clear=Rt.clear,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt"),s.name="IndexedCollection";function e(t){return $h.hasInstance(t)&&s.insertAt in t&&s.removeAt in t}s.hasInstance=e})(x0||(x0={}));var qo;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.get"),s.name="ReadonlyKeyedContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t&&s.get in t}s.hasInstance=e})(qo||(qo={}));var Wu;(function(s){s.has=qo.has,s.get=qo.get,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.name="KeyedContainer";function e(t){return qo.hasInstance(t)&&s.set in t&&s.delete in t}s.hasInstance=e})(Wu||(Wu={}));var sn;(function(s){s.has=qo.has,s.get=qo.get,s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values"),s.name="ReadonlyKeyedCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&qo.hasInstance(t)&&s.size in t&&s.keys in t&&s.values in t}s.hasInstance=e})(sn||(sn={}));var zr;(function(s){s.size=sn.size,s.has=sn.has,s.get=sn.get,s.keys=sn.keys,s.values=sn.values,s.set=Wu.set,s.delete=Wu.delete,s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear"),s.name="KeyedCollection";function e(t){return sn.hasInstance(t)&&Wu.hasInstance(t)&&s.clear in t}s.hasInstance=e})(zr||(zr={}));var wr;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values"),s.name="ReadonlyKeyedMultiCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t&&s.has in t&&s.hasValue in t&&s.get in t&&s.keys in t&&s.values in t}s.hasInstance=e})(wr||(wr={}));var Ws;(function(s){s.size=wr.size,s.has=wr.has,s.hasValue=wr.hasValue,s.get=wr.get,s.keys=wr.keys,s.values=wr.values,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear"),s.name="KeyedMultiCollection";function e(t){return wr.hasInstance(t)&&s.add in t&&s.delete in t&&s.deleteValue in t&&s.clear in t}s.hasInstance=e})(Ws||(Ws={}));function A0(s,e,t,n){if(e%4)throw new TypeError("Pointer not aligned");let i=new Uint32Array(s),o,a,l,u,c,h,d;if(a=e+t,e>>=2,t>=16){l=a-16>>2,u=(n+2654435761|0)+2246822519|0,c=n+2246822519|0,h=n+0|0,d=n+2654435761|0;do u=u+i[e++]*2246822519|0|0,u=(u<<13|u>>>19)*2654435761|0,c=c+i[e++]*2246822519|0|0,c=(c<<13|c>>>19)*2654435761|0,h=h+i[e++]*2246822519|0|0,h=(h<<13|h>>>19)*2654435761|0,d=d+i[e++]*2246822519|0|0,d=(d<<13|d>>>19)*2654435761|0;while(e<=l);o=(u<<1|u>>>31)+(c<<7|c>>>25)|(h<<12|h>>>20)|(d<<18|d>>>14)}else o=n+374761393|0;for(o=o+t|0,l=a-4>>2;e<=l;)o=o+i[e++]*3266489917|0|0,o=(o<<17|o>>>15)*668265263|0;if(e=e<<2,e<a){let m=new Uint8Array(i.buffer);do o=o+m[e++]*374761393|0|0,o=(o<<11|o>>>21)*2654435761|0;while(e<a)}return o=(o^o>>>15)*2246822519|0,o=(o^o>>>13)*3266489917|0,o=o^o>>>16,o>>>0}var iI=typeof WebAssembly<"u"&&typeof WebAssembly.Module=="function"&&typeof WebAssembly.Instance=="function",oI=new Uint8Array([0,97,115,109,1,0,0,0,1,8,1,96,3,127,127,126,1,126,3,2,1,0,5,3,1,0,1,7,15,2,3,109,101,109,2,0,5,120,120,104,54,52,0,0,10,130,6,1,255,5,2,3,126,1,127,32,0,32,1,106,33,6,32,1,65,32,79,4,126,32,6,65,32,107,33,6,32,2,66,214,235,130,238,234,253,137,245,224,0,124,33,3,32,2,66,177,169,172,193,173,184,212,166,61,125,33,4,32,2,66,249,234,208,208,231,201,161,228,225,0,124,33,5,3,64,32,3,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,3,32,4,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,2,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,5,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,6,32,0,65,8,106,34,0,79,13,0,11,32,2,66,12,137,32,5,66,18,137,124,32,4,66,7,137,124,32,3,66,1,137,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,2,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,33,2,32,0,32,1,65,31,113,106,33,1,3,64,32,1,32,0,65,8,106,79,4,64,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,32,2,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,33,2,32,0,65,8,106,33,0,12,1,11,11,32,0,65,4,106,32,1,77,4,64,32,2,32,0,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,2,32,0,65,4,106,33,0,11,3,64,32,0,32,1,73,4,64,32,2,32,0,49,0,0,66,197,207,217,178,241,229,186,234,39,126,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,0,65,1,106,33,0,12,1,11,11,32,2,32,2,66,33,136,133,66,207,214,211,190,210,199,171,217,66,126,34,2,66,29,136,32,2,133,66,249,243,221,241,153,246,153,171,22,126,34,2,66,32,136,32,2,133,11]),zs=iI?new WebAssembly.Instance(new WebAssembly.Module(oI)).exports:void 0;var Hs=zs===null||zs===void 0?void 0:zs.mem,Vm=zs===null||zs===void 0?void 0:zs.xxh64;var lI=typeof TextEncoder=="function",v0=(s,e)=>(v0=uI())(s,e),km=(s,e)=>v0(s,e);function uI(){function s(){let t=new TextEncoder;function n(i,o){let{written:a=0}=t.encodeInto(i,o);return a}return n}function e(){function t(n,i){let o=n.length,a=0;for(let l=0;l<o;l++){let u=n.charCodeAt(l);if((u&55296)!==0&&(u&4294910976)===0&&l<o-1){let c=n.charCodeAt(l+1);(c&64512)===56320&&(u=((u&1023)<<10)+(c&1023)+65536,l++)}if((u&4294967168)===0)i[a++]=u;else if((u&4294965248)===0)i[a++]=u>>6|192,i[a++]=u&63|128;else if((u&268431360)===0)i[a++]=u>>12|224,i[a++]=u>>6&63|128,i[a++]=u&63|128;else if((u&4292870144)===0)i[a++]=u>>18|240,i[a++]=u>>12&63|128,i[a++]=u>>6&63|128,i[a++]=u&63|128;else throw new RangeError("Unsupported charCode.")}return a}return t}return lI?s():e()}var Um=typeof BigInt=="function"&&typeof BigInt(0)=="bigint",T0=typeof BigUint64Array=="function",hI=typeof Hs=="object"&&typeof Vm=="function",Wm=new ArrayBuffer(8),dI=new Float64Array(Wm),ho=new Uint32Array(Wm),dl=()=>(dl=fI())(),I0=s=>(I0=gI())(s),w0=s=>(w0=mI())(s),L0=s=>(L0=dl())(s),O0=s=>(O0=pI())(s),R0=s=>(R0=bI())(s),B0=s=>I0(s),N0=s=>w0(s),G0=s=>L0(s),M0=s=>O0(s),zm=s=>R0(s);function fI(){function s(){let t=new BigUint64Array(ho.buffer),n=new Uint8Array(Hs.buffer);function i(c){Hs.buffer.byteLength<c&&(Hs.grow(Math.ceil((c-Hs.buffer.byteLength)/65536)),n=new Uint8Array(Hs.buffer))}function o(c){t[0]=c;let h=ho[0],d=ho[1];return(h<<7|h>>>25)^d}function a(){return ho[0]=ed(),ho[1]=ed(),t[0]}function l(c,h){i(c.length*3);let d=km(c,n);return o(Vm(0,d,h))}function u(){let c=a();function h(d){return l(d,c)}return h}return u}function e(){let t=new Uint8Array(65536);function n(a){t.byteLength<a&&(t=new Uint8Array(a+(65536-a%65536)))}function i(a,l){n(a.length*3);let u=km(a,t);return A0(t.buffer,0,u,l)>>0}function o(){let a=ed();function l(u){return i(u,a)}return l}return o}return Um&&T0&&hI?s():e()}function gI(){function s(t){dI[0]=t;let n=ho[0],i=ho[1];return(n<<7|n>>>25)^i|0}function e(t){return t>>0===t?t|0:s(t)}return e}function mI(){function s(){let n=new BigUint64Array(Wm),i=BigInt(0),o=BigInt(1),a=BigInt(2),l=BigInt(2)**BigInt(31)-BigInt(1),u=~l,c=BigInt(64);function h(d){if(d===i)return 0;if(d>=u&&d<=l)return Number(d);d=d<i?~d*a+o:d*a;let m=0;for(;d;)n[0]=d,m=(m<<7|m>>>25)^ho[0],m=(m<<7|m>>>25)^ho[1],d=d>>c;return m|0}return h}function e(){let n=BigInt(0),i=BigInt(1),o=BigInt(2),a=BigInt(2)**BigInt(31)-BigInt(1),l=~a,u=BigInt(32),c=BigInt("0xFFFFFFFF");function h(d){if(d===n)return 0;if(d>=l&&d<=a)return Number(d);d=d<n?~d*o+i:d*o;let m=0;for(;d!==n;)m=(m<<7|m>>>25)^Number(d&c),d>>=u,m=(m<<7|m>>>25)^Number(d&c),d>>=u;return m|0}return h}function t(){let n=dl();function i(o){return n(o.toString())}return i}return Um&&T0?s():Um?e():t()}function pI(){let s="description"in Symbol.prototype?P=>P.description:P=>{let S=P.toString();return S.length>=8&&S.slice(0,7)==="Symbol("&&S.slice(-1)===")"?S.slice(7,-1):S},e=dl(),t,n;try{new WeakMap().set(Symbol.iterator,null),t=new WeakMap,n=new WeakMap}catch{t=new Map,n=new Map}for(let P of Object.getOwnPropertyNames(Symbol))if(typeof P=="string"){let S=Symbol[P];typeof S=="symbol"&&n.set(S,`Symbol.${P}`)}let i=dl(),o;try{new WeakMap().set(Symbol.for("@esfx/equatable!~globalSymbolTest"),null),o=new WeakMap}catch{o=new Map}let a=dl(),l,u=1;try{new WeakMap().set(Symbol(),null),l=new WeakMap}catch{l=new Map}function c(P,S){let v=o.get(P);return v===void 0&&(v=i(S),o.set(P,v)),v}function h(P,S){let v=t.get(P);return v===void 0&&(v=e(S),t.set(P,v)),v}function d(P){let S=l.get(P);return S===void 0&&(S=a(`${u++}#${s(P)}`),l.set(P,S)),S}function m(P){let S=n.get(P);if(S!==void 0)return h(P,S);let v=Symbol.keyFor(P);return v!==void 0?c(P,v):d(P)}return m}function bI(){let s=new WeakMap,e=ed(),t=1;function n(o){return o=~o+(o<<15),o=o^o>>12,o=o+(o<<2),o=o^o>>4,o=o*2057,o=o^o>>16,o>>>0}function i(o){let a=s.get(o);return a===void 0&&(a=n(t++^e)^e,s.set(o,a)),a}return i}function ed(){return Math.floor(Math.random()*4294967295)>>>0}var td=typeof globalThis=="object"?globalThis:typeof global=="object"?global:typeof self=="object"?self:void 0,Hm=Symbol.for("@esfx/equatable!~hashUnknown"),rd;td&&typeof td[Hm]=="function"?rd=td[Hm]:(rd=function(e){switch(typeof e){case"boolean":return e?1:0;case"number":return B0(e);case"bigint":return N0(e);case"string":return G0(e);case"symbol":return M0(e);case"function":return zm(e);case"object":return e===null?0:zm(e);case"undefined":return 0;default:throw new TypeError(`Unsupported type: ${typeof e}`)}},Object.defineProperty(td,Hm,{value:rd}));function D0(s){return rd(s)}var Xo;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let n;return t!=null&&s.equals in(n=Object(t))&&s.hash in n}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Xo||(Xo={}));var fl;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(fl||(fl={}));var Yo;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let n;return t!=null&&s.structuralEquals in(n=Object(t))&&s.structuralHash in n}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Yo||(Yo={}));var gl;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(gl||(gl={}));var pr;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>Xo.hasInstance(o)?o[Xo.equals](a):Xo.hasInstance(a)?a[Xo.equals](o):Object.is(o,a),o=>Xo.hasInstance(o)?o[Xo.hash]():yI(o)),s.structuralEqualer=t((o,a)=>Yo.hasInstance(o)?o[Yo.structuralEquals](a,s.structuralEqualer):Yo.hasInstance(a)?a[Yo.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>Yo.hasInstance(o)?o[Yo.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=n(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=n(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function n(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=n;function i(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(pr||(pr={}));var O3=pr.defaultEqualer,R3=pr.structuralEqualer,B3=pr.tupleEqualer,N3=pr.tupleEqualer,G3=pr.combineHashes,Rn;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((i,o)=>fl.hasInstance(i)?i[fl.compareTo](o):fl.hasInstance(o)?-o[fl.compareTo](i):i<o?-1:i>o?1:0),s.structuralComparer=t((i,o)=>gl.hasInstance(i)?i[gl.structuralCompareTo](o,s.structuralComparer):gl.hasInstance(o)?-o[gl.structuralCompareTo](i,s.structuralComparer):s.defaultComparer.compare(i,o)),s.tupleComparer=t((i,o)=>{if(i!=null&&!Array.isArray(i)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(i.length,o.length))return a;for(let l=0;l<i.length;l++)if(a=s.defaultComparer.compare(i[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((i,o)=>{if(i!=null&&!Array.isArray(i)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(i.length,o.length))return a;for(let l=0;l<i.length;l++)if(a=s.structuralComparer.compare(i[l],o[l]))return a;return 0});function t(i){return Object.setPrototypeOf({compare:i},e)}s.create=t;function n(i){return typeof i=="object"&&i!==null&&typeof i.compare=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(Rn||(Rn={}));var M3=Rn.defaultComparer,D3=Rn.structuralComparer,F3=Rn.tupleComparer,_3=Rn.tupleStructuralComparer;function yI(s){return D0(s)}var F0,nd=function(){var s={exports:{}};return function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=i}(s,s.exports,null),s.exports}(),wi=class{constructor(...e){this._keys=[],this._values=[];let t,n;if(e.length>0){let i=e[0];i===void 0||i!=null&&Symbol.iterator in Object(i)?(t=i,e.length>1&&(n=e[1])):n=i}if(n??(n=Rn.defaultComparer),this._comparer=typeof n=="function"?Rn.create(n):n,t)for(let[i,o]of t)this.set(i,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return(0,nd.binarySearch)(this._keys,e,this._comparer)>=0}get(e){let t=(0,nd.binarySearch)(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let n=(0,nd.binarySearch)(this._keys,e,this._comparer);return n>=0?this._values[n]=t:(this._keys.splice(~n,0,e),this._values.splice(~n,0,t)),this}delete(e){let t=(0,nd.binarySearch)(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[n,i]of this)e.call(t,i,n,this)}get[zr.size](){return this.size}[zr.has](e){return this.has(e)}[zr.get](e){return this.get(e)}[zr.set](e,t){this.set(e,t)}[zr.delete](e){return this.delete(e)}[zr.clear](){this.clear()}[zr.keys](){return this.keys()}[zr.values](){return this.values()}};F0=wi;Object.defineProperty(F0.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedMap"});var Ko=class{constructor(e,t,n,i){this.la=t,this.database=n,this.layeredGraph=e,this.intGraph=i}static InsertLayers(e,t,n,i){let o=new Ko(e,t,n,i);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let n=0,i=t[0];if(n=i.LayerSpan*2,n>0){for(let o of i.LayerEdges)o.Target!==i.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(n-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let n=this.la.x[t],i=this.la.y[t],o=this.la.Layers[i];o[n]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],n=0;for(let i of this.la.Layers[e]){let o=this.virtNodesToIntEdges[i];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[i],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!==o){let c=u.LayerEdges[a].Source;t[n]=c,this.Nla.x[c]=n++}else t[n]=i,this.Nla.x[i]=n++}else t[n]=i,this.Nla.x[i]=n++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let n=this.NLayering[t];n%2===1&&(this.Nla.Layers[n][e[n]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!==e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!==e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,n=!0;for(let i of e)if(n&&(n=!1,t=i.LayerSpan*2),t>0){i.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=Li.GetSource(a,i,o);this.totalNodes=a.currentVV;let u=Li.GetTarget(this.totalNodes,i,o,t);i.LayerEdges[o]=new bn(l,u,i.CrossingWeight)}Ko.RegisterDontStepOnVertex(this.database,i)}}this.nLayeredGraph=new ei(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new wi,n=this.Nla.Layers[e];for(let o of n){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let i=0;for(let o of t.values())if(typeof o=="number")n[i++]=o;else for(let a of o)n[i++]=a;for(let o=0;o<n.length;o++)this.Nla.x[n[o]]=o}}InitNewLayering(){this.Nla=new Pn(new Array(this.totalNodes));for(let n=0;n<this.layeredGraph.NodeCount;n++)this.NLayering[n]=this.la.y[n]*2;for(let[n,i]of this.database.Multiedges.keyValues())if(n.x!==n.y&&this.la.y[n.x]!==this.la.y[n.y]){let o=this.la.y[n.x]*2;for(let a of i){let l=o-1;for(let u of a.LayerEdges)u.Target!==a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let n of this.NLayering)t[n]++;for(let n=0;n<t.length;n++)e[n]=new Array(t[n]);this.Nla=new Pn(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let n=t.LayerEdges[t.LayerEdges.length/2];e.MultipleMiddles.add(n.Source)}}};var Li=class{constructor(e,t,n,i){this.virtNodesToIntEdges=new Map;this.la=t,this.database=n,this.layeredGraph=e,this.intGraph=i}get NLayering(){return this.Nla.y}static InsertPaths(e,t,n,i){let o=new Li(e,t,n,i);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],n=0;for(let i of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(i);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[i],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!==o){let c=u.LayerEdges[a].Source;t[n]=c,this.Nla.x[c]=n++}else t[n]=i,this.Nla.x[i]=n++}else t[n]=i,this.Nla.x[i]=n++}}}EdgeIsFlat(e){return this.la.y[e.source]===this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let n of t.LayerEdges)n.Target!==t.target&&this.virtNodesToIntEdges.set(n.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,n]of this.database.Multiedges.keyValues())if(t.x!==t.y){let i=!0,o=0;for(let a of n){if(i)i=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o===1)a.LayerEdges[0]=new bn(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=Li.GetSource(u,a,l);e=u.currentVV;let h=Li.GetTarget(e,a,l,o);a.LayerEdges[l]=new bn(c,h,a.CrossingWeight)}Ko.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new ei(this.intGraph)}static GetTarget(e,t,n,i){return n<i-1?e:t.target}static GetSource(e,t,n){return n===0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new Pn(new Array(this.NLayeredGraph.NodeCount));for(let n=0;n<this.layeredGraph.NodeCount;n++)this.NLayering[n]=this.la.y[n];for(let[n,i]of this.database.Multiedges.keyValues())if(n.x!==n.y&&this.la.y[n.x]!==this.la.y[n.y]){let o=0,a=!0;for(let l of i){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let n of this.NLayering)t[n]++;for(let n=0;n<t.length;n++)e[n]=new Array(t[n]);this.Nla=new Pn(this.NLayering),this.Nla.Layers=e}};var _0=BigInt("6364136223846793005"),jm=(BigInt(1)<<BigInt(32))-BigInt(1),fo=(BigInt(1)<<BigInt(64))-BigInt(1),js=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&fo,this._random_b(),this._state=this._state+BigInt(e)&fo,this._random_b()}_random_b(){let e=this._state;this._state=e*_0+this._inc&fo;let t=(e>>BigInt(18)^e)>>BigInt(27),n=e>>BigInt(59),i=n^BigInt(31);return(t>>n|t<<i)&jm}_advance(e){e&=fo;let t=BigInt(1),n=_0,i=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*n&fo,i=i*n+o&fo),o=(n+BigInt(1))*o&fo,n=n*n&fo,e>>=BigInt(1);this._state=t*this._state+i&fo}randint(e){if(e>jm)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),n=(jm^t)%t;for(;;){let i=this._random_b();if(i>=n)return Number(i%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var qs;function Qo(s){return qs==null&&(qs=new js(0,0)),qs.randint(s)}function pl(s){qs=new js(s,0)}function Oi(){return qs==null&&(qs=new js(0,0)),qs.random()}var Xs=class{constructor(e,t,n){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=n}LayerGroupDisbalance(e,t,n){return t===1?this.LayerGroupDisbalanceWithOrigSeparators(e,n):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let n=0;for(let i=0;i<e.length;){let o=this.CurrentOrigGroupDelta(i,e,t);i=o.i,n+=o.ret}return n}CurrentOrigGroupDelta(e,t,n){let i=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)i++;return e=o+1,{ret:Math.abs(n-i),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let n=0;for(let i=0;i<e.length;){let o=this.CurrentVirtGroupDelta(i,e,t);n+=o.ret,i=o.i}return n}CurrentVirtGroupDelta(e,t,n){let i=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)i++;return e=o+1,{ret:Math.abs(n-i),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings===0}};var z0=Ae(Ln());var qm=class{constructor(e){this.x=e}Compare(e,t){let n=this.x[e.Source]-this.x[t.Source];return n!==0?n:this.x[e.Target]-this.x[t.Target]}};var Xm=class{constructor(e){this.x=e}Compare(e,t){let n=this.x[e.Target]-this.x[t.Target];return n!==0?n:this.x[e.Source]-this.x[t.Source]}};var We=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new We;for(let n of e)t.add(n);return t}addxy(e,t){let n=this.mapOfSets.get(e);n==null&&this.mapOfSets.set(e,n=new Set),n.has(t)||this.size_++,n.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let n=this.mapOfSets.get(e);return n!=null&&n.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let n of this)e(n,n,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new f(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function go(s,e){let t=new Set;for(let n of s)e.has(n)||t.add(n);return t}function V0(s,e){let t=new We;for(let n of s)e.has(n)||t.add(n);return t}function ti(s,e){let t=new Set(s);for(let n of e)t.add(n);return t}function Ri(s,e){for(let t of e)s.push(t)}function ri(s,e){let t=new Set;if(s.size<e.size)for(let n of s)e.has(n)&&t.add(n);else for(let n of e)s.has(n)&&t.add(n);return t}function k0(s){if(s.length===0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=ri(e,s[t]);return e}function Jo(s,e){for(let t of e)s.add(t)}function Ys(s,e){if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function Bi(s,e){let t=[];for(let n of s)for(let i of e(n))t.push(i);return t}function Ks(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function Qs(s,e,t){let n=s.get(e);n||(n=new Array,s.set(e,n)),n.push(t)}function Ym(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function U0(s,e,t){Ym(s,new at(e[0],e[1]),t)}function SI(s,e,t){let n=s.get(e);n&&n.delete(t)}function Km(s,e,t){SI(s,new at(e[0],e[1]),t)}function id(){return Qo(2)===0}function EI(s,e,t){let n=t.Layers[s+1],i=t.Layers[s];return i.length<=n.length?xI(i,e,t):CI(n,i,e,t)}function CI(s,e,t,n){let i=H0(e,t),o=new Xm(n.x);i.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of i){let h=a+n.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!==0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function xI(s,e,t){let n=H0(s,e),i=new qm(t.x);n.sort((u,c)=>i.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of n){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!==0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function H0(s,e){return Bi(s,t=>e.InEdges(t))}function W0(s,e){let t=0;for(let n=0;n<e.Layers.length-1;n++)t+=EI(n,s,e);return t}var Zo=class extends Pe{constructor(e,t,n,i,o,a,l){super(l);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=l,this.tryReverse=t,this.startOfVirtNodes=i,this.layerArrays=n,this.layering=n.y,this.nOfLayers=n.Layers.length,this.layers=n.Layers,this.properLayeredGraph=e,this.hasCrossWeights=o,this.SugSettings=a}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.RepetitionCoefficientForOrdering}get SeedOfRandom(){return Qo(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.RepetitionCoefficientForOrdering}static OrderLayers(e,t,n,i,o){let a=!1;for(let u of e.Edges)if(u.CrossingWeight!==1){a=!0;break}new Zo(e,!0,t,n,a,i,o).run()}run(){if(this.Calculate(),this.tryReverse){let e=this.layerArrays.ReversedClone(),t=new Zo(this.properLayeredGraph.ReversedClone(),!1,e,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(t.run(),Xs.less(t.measure,this.measure)){for(let n=0;n<this.nOfLayers;n++)Vu(e.Layers[n],this.layerArrays.Layers[this.nOfLayers-1-n]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=Zo.CloneLayers(this.layers,this.layerArraysCopy);let e=0;this.measure=new Xs(this.layerArraysCopy,W0(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let t=0;t<this.MaxOfIterations&&e<this.NoGainStepsBound&&!this.measure.IsPerfect();t++){let n=t%2===0;this.LayerByLayerSweep(n),this.AdjacentExchange();let i=new Xs(this.layerArrays.Layers,W0(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);Xs.less(this.measure,i)?(this.Restore(),e++):(Xs.less(i,this.measure)||id())&&(e=0,this.layerArraysCopy=Zo.CloneLayers(this.layers,this.layerArraysCopy),this.measure=i)}}static CloneLayers(e,t){if(t==null){t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=e[n].map(i=>i)}else for(let n=0;n<e.length;n++)Vu(e[n],t[n]);return t}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(e){if(e)for(let t=1;t<this.nOfLayers;t++)this.SweepLayer(t,!0);else for(let t=this.nOfLayers-2;t>=0;t--)this.SweepLayer(t,!1)}SweepLayer(e,t){let n=this.layers[e],i=new Array(n.length);for(let a=0;a<i.length;a++)i[a]=this.WMedian(n[a],t);this.Sort(e,i);let o=this.layerArrays.Layers[e];for(let a=0;a<o.length;a++)this.layerArrays.x[o[a]]=a}Sort(e,t){let n=new wi,i=this.layers[e],o=0;for(let l of t){let u=i[o++];if(l!==-1)if(!n.has(l))n.set(l,u);else{let c=n.get(l);if(typeof c!="number"){let h=c;if(id())h.push(u);else{let d=Qo(h.length),m=h[d];h[d]=u,h.push(m)}}else{let h=c,d=new Array;n.set(l,d),id()?(d.push(h),d.push(u)):(d.push(u),d.push(h))}}}let a=n.values();for(o=0;o<i.length;)if(t[o]!==-1){let l=a.next().value;if(typeof l=="number")i[o++]=l;else{let u=l;for(let c of u){for(;t[o]===-1;)o++;i[o++]=c}}}else o++}WMedian(e,t){let n,i;if(t?(n=this.properLayeredGraph.OutEdges(e),i=this.properLayeredGraph.OutEdgesCount(e)):(n=this.properLayeredGraph.InEdges(e),i=this.properLayeredGraph.InEdgesCount(e)),i===0)return-1;let o=new Array(i),a=0;if(t)for(let h of n)o[a++]=this.X[h.Target];else for(let h of n)o[a++]=this.X[h.Source];o.sort((h,d)=>h-d);let l=Math.floor(i/2);if(i%2===1)return o[l];if(i===2)return .5*(o[0]+o[1]);let u=o[l-1]-o[0],c=o[i-1]-o[l];return Math.floor((o[l-1]*u+o[l]*c)/(u+c))}Init(){let e=new Array(this.nOfLayers).fill(0),t=new z0.Stack;for(let i=0;i<this.properLayeredGraph.NodeCount;i++)this.properLayeredGraph.InEdgesCount(i)===0&&t.push(i);let n=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;t.size>0;){let i=t.pop(),o=this.layerArrays.y[i];this.layerArrays.Layers[o][e[o]]=i,this.layerArrays.x[i]=e[o],e[o]++;for(let a of this.properLayeredGraph.Succ(i))n[a]||(n[a]=!0,t.push(a))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let e=0,t=!0;for(;t&&e++<this.MaxNumberOfAdjacentExchanges;){t=!1;for(let n=0;n<this.layers.length;n++)t=this.AdjExchangeLayer(n)||t;for(let n=this.layers.length-2;n>=0;n--)t=this.AdjExchangeLayer(n)||t}}AllocArrays(){let e=this.properLayeredGraph.NodeCount;this.predecessors=new Array(e),this.successors=new Array(e),this.pOrder=new Array(e),this.sOrder=new Array(e),this.hasCrossWeights&&(this.outCrossingCount=new Array(e),this.inCrossingCount=new Array(e));for(let t=0;t<e;t++){let n=this.properLayeredGraph.InEdgesCount(t);if(this.predecessors[t]=new Array(n),this.hasCrossWeights){let i=this.inCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.InEdges(t))i.set(o.Source,o.CrossingWeight)}if(this.pOrder[t]=new Map,n=this.properLayeredGraph.OutEdgesCount(t),this.successors[t]=new Array(n),this.sOrder[t]=new Map,this.hasCrossWeights){let i=this.outCrossingCount[t]=new Map;for(let o of this.properLayeredGraph.OutEdges(t))i.set(o.Target,o.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let e=0;e<this.properLayeredGraph.NodeCount;e++)this.pOrder[e]=new Map,this.sOrder[e]=new Map;for(let e of this.layers)this.InitPsArraysForLayer(e)}CalcPair(e,t){let n=this.successors[e],i=this.successors[t],o=this.predecessors[e],a=this.predecessors[t];if(this.hasCrossWeights){let l=this.outCrossingCount[e],u=this.outCrossingCount[t],c=this.inCrossingCount[e],h=this.inCrossingCount[t];return{cuv:this.CountOnArraysUV(n,i,l,u)+this.CountOnArraysUV(o,a,c,h),cvu:this.CountOnArraysUV(i,n,u,l)+this.CountOnArraysUV(a,o,h,c)}}else return{cuv:this.CountOnArrays(n,i)+this.CountOnArrays(o,a),cvu:this.CountOnArrays(i,n)+this.CountOnArrays(a,o)}}InitPsArraysForLayer(e){for(let t of e){for(let n of this.properLayeredGraph.Pred(t)){let i=this.sOrder[n],o=i.size;this.successors[n][o]=t,i.set(t,o)}for(let n of this.properLayeredGraph.Succ(t)){let i=this.pOrder[n],o=i.size;this.predecessors[n][o]=t,i.set(t,o)}}}CountOnArrays(e,t){let n=0,i=t.length-1,o=-1,a=0;for(let l of e){let u=this.X[l];for(;o<i&&this.X[t[o+1]]<u;o++)a++;n+=a}return n}CountOnArraysUV(e,t,n,i){let o=0,a=t.length-1,l=-1,u=0;for(let c of e){let h=this.X[c],d;for(;l<a&&this.X[d=t[l+1]]<h;l++)u+=i.get(d);o+=u*n.get(c)}return o}AdjExchangeLayer(e){let t=this.layers[e];return this.ExchangeWithGainWithNoDisturbance(t)?!0:(this.DisturbLayer(t),this.ExchangeWithGainWithNoDisturbance(t))}Swap(e,t){let n=this.X[e],i=this.X[t],o=this.layering[e],a=this.layers[o];a[n]=t,a[i]=e,this.X[e]=i,this.X[t]=n,this.UpdateSsContainingUv(e,t),this.UpdatePsContainingUv(e,t)}UpdatePsContainingUv(e,t){if(this.successors[e].length<=this.successors[t].length)for(let n of this.successors[e]){let i=this.pOrder[n];if(i.has(t)){let o=i.get(t),a=this.predecessors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}else for(let n of this.successors[t]){let i=this.pOrder[n];if(i.has(e)){let o=i.get(t),a=this.predecessors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}}UpdateSsContainingUv(e,t){if(this.predecessors[e].length<=this.predecessors[t].length)for(let n of this.predecessors[e]){let i=this.sOrder[n];if(i.has(t)){let o=i.get(t),a=this.successors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}else for(let n of this.predecessors[t]){let i=this.sOrder[n];if(i.has(e)){let o=i.get(t),a=this.successors[n];a[o-1]=t,a[o]=e,i.set(t,o-1),i.set(e,o)}}}DisturbLayer(e){for(let t=0;t<e.length-1;t++)this.AdjacentSwapToTheRight(e,t)}ExchangeWithGainWithNoDisturbance(e){let t=!1,n;do n=this.ExchangeWithGain(e),t=t||n;while(n);return t}ExchangeWithGain(e){for(let t=0;t<e.length-1;t++)if(this.SwapWithGain(e[t],e[t+1]))return this.SwapToTheLeft(e,t),this.SwapToTheRight(e,t+1),!0;return!1}SwapToTheLeft(e,t){for(let n=t-1;n>=0;n--)this.AdjacentSwapToTheRight(e,n)}SwapToTheRight(e,t){for(let n=t;n<e.length-1;n++)this.AdjacentSwapToTheRight(e,n)}AdjacentSwapToTheRight(e,t){let n=e[t],i=e[t+1],o=this.SwapGain(n,i);(o>0||o===0&&id())&&this.Swap(n,i)}SwapGain(e,t){let n=this.CalcPair(e,t);return n.cuv-n.cvu}UvAreOfSameKind(e,t){return e<this.startOfVirtNodes&&t<this.startOfVirtNodes||e>=this.startOfVirtNodes&&t>=this.startOfVirtNodes}NeighborsForbidTheSwap(e,t){return this.UpperNeighborsForbidTheSwap(e,t)||this.LowerNeighborsForbidTheSwap(e,t)}LowerNeighborsForbidTheSwap(e,t){let n,i;return(n=this.properLayeredGraph.OutEdgesCount(e))===0||(i=this.properLayeredGraph.OutEdgesCount(t))===0?!1:this.X[this.successors[e][n>>1]]<this.X[this.successors[t][i>>1]]}UpperNeighborsForbidTheSwap(e,t){let n=this.properLayeredGraph.InEdgesCount(e),i=this.properLayeredGraph.InEdgesCount(t);return n===0||i===0?!1:this.X[this.predecessors[e][n>>1]]<this.X[this.predecessors[t][i>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(e,t,n){let i=this.GetKindDelegate(n),o=0;for(let l=t-1;l>=0&&!i(e[l]);l--)o++;let a=0;for(let l=t+1;l<e.length&&!i(e[l]);l++)a++;return o-a}IsOriginal(e){return e<this.startOfVirtNodes}IsVirtual(e){return e>=this.startOfVirtNodes}GetKindDelegate(e){return this.IsVirtual(e)?this.IsVirtual:this.IsOriginal}SwapWithGain(e,t){return this.SwapGain(e,t)>0?(this.Swap(e,t),!0):!1}};var pt=class{constructor(){this.size_=0;this.mapOfMaps=new Map}deleteP(e){return this.delete(e.x,e.y)}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}setxy(e,t,n){let i=this.mapOfMaps.get(e);i==null&&this.mapOfMaps.set(e,i=new Map),i.has(t)||this.size_++,i.set(t,n)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){let n=this.mapOfMaps.get(e);return n!=null?(n.delete(t)&&this.size_--,!0):!1}hasxy(e,t){let n=this.mapOfMaps.get(e);return n!=null&&n.has(t)}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){let n=this.mapOfMaps.get(e);if(n!=null)return n.get(t)}get(e){return this.getxy(e.x,e.y)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new f(e[0],t[0])}*[Symbol.iterator](){for(let e of this.mapOfMaps)for(let t of e[1])yield[new f(e[0],t[0]),t[1]]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var bl=class{constructor(e,t,n){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=n}static UpdateLayerArrays0(e,t,n){new bl(e,t,n).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let n=bl.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,n)}static BuildInitialNodePositions(e,t){let n=new Map;for(let i=0;i<t.Layers.length;i++){let o=0,a=0;for(;o<t.Layers[i].length;){for(;o<t.Layers[i].length&&e.IsVirtualNode(t.Layers[i][o]);)o++;for(let l=a;l<o;l++)n.set(t.Layers[i][l],new f(i,a));o<t.Layers[i].length&&n.set(t.Layers[i][o],new f(i,o)),o++,a=o}}return n}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new pt;for(let t of this.layerArrays.Layers)for(let n of t){let i=this.nodePositions.get(n);e.hasxy(i.x,i.y)||e.setxy(i.x,i.y,[]),e.getxy(i.x,i.y).push(n)}return e}BuildOrdering(e){let t=new pt,n=new Map;for(let i of this.layerArrays.Layers)for(let o of i){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),n),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let n=0;n<e.length;n++)t.set(e[n],n)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,n)=>{let i=this.firstSucc(t),o=this.firstSucc(n),a=this.firstPred(t),l=this.firstPred(n),u=this.nodePositions.get(i),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(i)){if(!h.equal(d))return h.compareTo(d);let m=e.get(i),P=e.get(o);return Le(m,P)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?Le(t,n):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let n=0,i=0;for(;n<t.length;){for(;n<t.length&&this.nodePositions.get(t[i]).equal(this.nodePositions.get(t[n]));)n++;let o=e.get(this.nodePositions.get(t[i]));for(let a=i;a<n;a++)t[a]=o[a-i];i=n}}this.layerArrays.UpdateXFromLayers()}};var q0=Ae(Ut());var j0=Ae(Ln());var Js=class{static getOrder(e,t){let n=rr(t.map(([i,o])=>new ye(i,o)),e);return Js.getOrderOnGraph(n)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),n=new j0.Stack,i=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,n.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(i.push(l),n.length>0){let c=n.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return i.reverse()}};var Qm=class{GetLayers(){let e=Js.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),n=this.graph.nodeCount;for(;n-- >0;){let i=e[n];for(let o of this.graph.inEdges[i]){let a=o.source,l=t[i]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(AI(t,e))return!1;return!0}constructor(e){this.graph=e}};function AI(s,e){let t=e.findIndex(i=>i===s.source),n=e.findIndex(i=>i===s.target);return t===-1||n===-1||t>=n}var Jm=class{constructor(e){this.inTree=!1;this.cut=Jm.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},an=Jm;an.infinity=Number.MAX_SAFE_INTEGER;var $o=Ae(Ln());function vI(s){let e=new Array;for(let t of s.edges)e.push(new an(t));return rr(e,s.nodeCount)}var od=class{constructor(e,t,n,i,o){this.v=e,this.outEnum=t,this.i=n,this.inEnum=i,this.j=o}},Hu=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=vI(e),this.networkCancelToken=t;for(let n=0;n<this.graph.nodeCount;n++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let n of this.treeVertices)this.layers[n]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let n=t.source,i=t.target;return this.lim(n)>this.lim(i)?this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?0:1:this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut===an.infinity&&t!==this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new $o.Stack;for(let n of this.leaves)e.push(n);let t=new $o.Stack;for(;e.length>0;){for(;e.length>0;){let i=e.pop(),o=this.parent(i);if(o==null)continue;let a=0;for(let u of this.incidentEdges(i))if(u.inTree===!1){let c=this.edgeSourceTargetVal(u,o);c!==0&&(a+=c*u.weight)}else if(u===o)a+=u.weight;else{let c=o.source===u.target||o.target===u.source?1:-1;a+=this.edgeContribution(u,i)*c}o.cut=a;let l=o.source===i?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let n=e;e=t,t=n}}edgeContribution(e,t){let n=e.cut-e.weight;for(let i of this.incidentEdges(t))if(i.inTree===!1){let o=this.edgeSourceTargetVal(i,e);o===-1?n+=i.weight:o===1&&(n-=i.weight)}return n}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let n=new $o.Stack,i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(n.push(new od(t,i,o,a,l)),this.vertices[t].low=e;n.length>0;){let u=n.pop();t=u.v,i=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<i.length;){let h=i[o];!h.inTree||this.vertices[h.target].low>0||(n.push(new od(t,i,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){n.push(new od(t,i,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),i=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)===this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,n=this.vertices[e].lim;this.leaves=[];for(let i=0;i<this.nodeCount;i++)t<=this.vertices[i].lim&&this.vertices[i].lim<=n?this.setLow(i,0):this.low(i)===this.lim(i)&&this.leaves.push(i);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=an.infinity;for(let n of this.treeVertices){for(let i of this.graph.outEdges[n]){if(this.vertexInTree(i.source)&&this.vertexInTree(i.target))continue;let o=this.slack(i);if(o<t&&(e=i,t=o,o===1))return i}for(let i of this.graph.inEdges[n]){if(this.vertexInTree(i.source)&&this.vertexInTree(i.target))continue;let o=this.slack(i);if(o<t&&(e=i,t=o,o===1))return i}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new $o.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let n of this.graph.outEdges[t])this.vertexInTree(n.target)||this.layers[n.source]-this.layers[n.target]===n.separation&&(e.push(n.target),this.addVertexToTree(n.target),this.treeVertices.push(n.target),n.inTree=!0);for(let n of this.graph.inEdges[t])this.vertexInTree(n.source)||this.layers[n.source]-this.layers[n.target]===n.separation&&(e.push(n.source),this.addVertexToTree(n.source),this.treeVertices.push(n.source),n.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,n=0;for(let a of this.graph.edges)a.inTree&&a.cut<n&&(n=a.cut,e=a);if(e==null)return null;let i=!1,o=an.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree===!1&&this.edgeSourceTargetVal(a,e)===-1&&(l<o||l===o&&(i=Qo(2)===1))){if(o=l,t=a,o===0&&!i)break;i=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let n=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,n),this.updateLimLowLeavesAndParentsUnderNode(n),this.updateCuts(e),this.updateLayersUnderNode(n)}updateLayersUnderNode(e){let t=new $o.Stack;t.push(e);for(let n=0;n<this.nodeCount;n++)this.low(e)<=this.lim(n)&&this.lim(n)<=this.lim(e)&&n!==e&&(this.layers[n]=an.infinity);for(;t.length>0;){let n=t.pop();for(let i of this.graph.outEdges[n])i.inTree&&this.layers[i.target]===an.infinity&&(this.layers[i.target]=this.layers[n]-i.separation,t.push(i.target));for(let i of this.graph.inEdges[n])i.inTree&&this.layers[i.source]===an.infinity&&(this.layers[i.source]=this.layers[n]+i.separation,t.push(i.source))}}updateCuts(e){let t=new $o.Stack,n=new $o.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!==an.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree===!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c===a)l+=c.weight;else{let h=a.source===c.target||a.target===c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source===o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&n.push(u)}let i=t;t=n,n=i}}createPathForCutUpdates(e,t,n){let i=t.target;for(;i!==n;){let o=this.parent(i);o.cut=an.infinity,i=o.source===i?o.target:o.source}t.cut=an.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,n;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),n=this.lim(e.target)):(t=this.lim(e.target),n=this.lim(e.source));let i=e.source;for(;!(this.low(i)<=t&&n<=this.lim(i));){let o=this.parent(i);o.cut=an.infinity,i=o.source===i?o.target:o.source}return i}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let n of this.graph.edges)t+=this.edgeSourceTargetVal(n,e)*n.weight;e.cut!==t&&console.log(q0.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new Qm(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length===0&&this.graph.nodeCount===0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var Zm=class{GetLayers(){return new Hu(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let n of e){let i=n[0],o=n[1];for(let a of this.graph.outEdges[i]){let l=new Ir(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new co(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var Hr=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new f(this.left,this.top)}get leftBottom(){return new f(this.left,this.bottom)}get rightBottom(){return new f(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new f(this.right,this.top)}static mkAnchor(e,t,n,i,o,a){let l=new Hr(a);return l.la=e,l.ra=t,l.ta=n,l.ba=i,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new f(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=Hr.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t===0?e:Hr.curveIsConvex(e)?Hr.padConvexCurve(e,t):Hr.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,n,i,o){let a=Hr.getPaddedCorner(t,n,i,o);e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b)}static padConvexCurve(e,t){let n=new ee;Hr.padCorner(n,e.endPoint.prev,e.endPoint,e.startPoint,t),Hr.padCorner(n,e.endPoint,e.startPoint,e.startPoint.next,t);for(let i=e.startPoint;i.next.next!=null;i=i.next)Hr.padCorner(n,i,i.next,i.next.next,t);return n.closed=!0,n}static getPaddedCorner(e,t,n,i){let o=e.point,a=t.point,l=n.point,u=f.getTriangleOrientation(o,a,l)===1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<C.intersectionEpsilon)return{a:a.add(h.mul(i)),b:null,numberOfPoints:1};let m=d.normalize().mul(i),P=m.rotate(Math.PI/2),S=(i-m.dot(h))/P.dot(h);return{a:m.add(P.mul(S)).add(a),b:m.sub(P.mul(S)).add(a),numberOfPoints:2}}static*orientations(e){yield f.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield f.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield f.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let n of Hr.orientations(e))if(n!==2){if(t===2)t=n;else if(n!==t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():x.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new ee;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ee.mkClosedFromPoints([new f(e,this.top),this.rightTop,this.rightBottom,new f(e,this.bottom),new f(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ee.mkClosedFromPoints([new f(e,this.top),new f(this.right,this.y),new f(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var Pl=class{constructor(e,t,n,i,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=n,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new mr,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=i,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,n,i,o){new Pl(e,t,n,i,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let n=new Array(t);t=0;for(let o of this.graph.InEdges(e))n[t++]=o.Source;n.sort((o,a)=>this.CompareByX(o,a));let i=Math.floor(t/2);i*2===t?this.upperMedians[e]=new ye(n[i-1],n[i]):this.upperMedians[e]=n[i]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let n=new Array(t);t=0;for(let o of this.graph.OutEdges(e))n[t++]=o.Target;n.sort((o,a)=>this.CompareByX(o,a));let i=Math.floor(t/2);i*2===t?this.lowMedians[e]=new ye(n[i-1],n[i]):this.lowMedians[e]=n[i]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),n=new Array(4),i=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,n[a]=l.b;let u=n[a]-t[a];u<i&&(e=a,i=u)}for(let a=0;a<4;a++){let l;if(Pl.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=n[e]-n[a],this.x=this.xCoords[a],l!==0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e===0||e===2}AssignmentBounds(e,t){if(this.nOfVertices===0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let n=1;n<this.nOfVertices;n++){let i=this.x[n];i<t.a?t.a=i:i>t.b&&(t.b=i)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let i=t;this.LR?(yield i.x,yield i.y):(yield i.y,yield i.x)}else{let i=t;i>=0&&(yield i)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,n=this.UpperOf(0,this.h-1),i=this.NextLower(n);for(;this.IsBelow(e,n);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,i)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],n=null,i=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(i,o)&&n==null;i=this.NextRight(i))n=this.InnerEdgeByTarget(t[i]);if(n!=null){let a=this.Pos(this.Source(n));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,i);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(n));for(;this.IsNotRightFrom(i,o);){let u=this.AlignmentToTheRightOfInner(t,i,a);if(i=this.NextRight(i),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,n,u,l,c),n=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(n)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(n)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,n,i,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(n)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,i)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,n){if(this.NumberOfInEdges(e[t])===1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(n,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let i=0;i<this.nOfVertices;i++)if(i===this.root[i]){let o=i;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Ir(i,this.root[a.neighbor],null)),o=this.align[o]}while(o!==i)}let t=rr(e,this.nOfVertices),n=Js.getOrderOnGraph(t);for(let i of n)if(i===this.root[i]){let o=0,a=!0,l=i;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!==i);this.x[i]=o}for(let i of n)if(i===this.root[i]&&t.inEdges[i].length===0){let o=i,a=this.RightMost(-Pl.infinity,Pl.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!==i);l!==a&&(this.x[i]=a)}for(let i=0;i<this.nOfVertices;i++)i!==this.root[i]&&(this.x[i]=this.x[this.root[i]])}TryToGetRightNeighbor(e,t){let n=this.NextRight(this.Pos(e)),i=this.la.Layers[this.la.y[e]];return n>=0&&n<i.length?(t.neighbor=i[n],!0):!1}TryToGetLeftNeighbor(e,t){let n=this.NextLeft(this.Pos(e)),i=this.la.Layers[this.la.y[e]];return n>=0&&n<i.length?(t.neighbor=i[n],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let n=this.la.Layers[t],i=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,n.length-1);for(let a=this.LeftMost(0,n.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=n[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(i,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],i=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let n;if(this.Pos(e)>this.Pos(t)){let i=e;e=t,t=i,n=-1}else n=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*n}},sd=Pl;sd.infinity=1e7;var $m=class extends tr{constructor(e,t,n,i,o){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(i,o),this.virtualVerticesStart=e.nodeCount,this.virtualVerticesEnd=t.NodeCount-1,this.layeredGraph=t,this.layerArrays=n}EdgeWeightMultiplier(e){let t=e.source,n=e.target;if(t<this.layeredGraph.NodeCount&&this.layerArrays.y[t]===this.layerArrays.y[n]&&this.layerArrays.x[t]===this.layerArrays.x[n]+1)return 0;let i=0,o=-1,a=-1;for(let u of this.outEdges[t])a===-1?a=u.target:o=u.target;return a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&i++,o>=this.virtualVerticesStart&&o<=this.virtualVerticesEnd&&i++,i===0?this.weightMultiplierOfOriginalOriginal:i===1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let e of this.edges)e.weight=e.weight*this.EdgeWeightMultiplier(e)}};var Bn=class{constructor(){this.length=Bn.defaultArrowheadLength;this.width=0}clone(){let e=new Bn;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=Bn.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let n=Bn.findTrimEndForArrowheadAtTarget(e);if(n==null||t>n-C.intersectionEpsilon||x.closeIntersectionPoints(e.curve.value(t),e.curve.value(n)))return!1;let i=e.curve.trim(t,n);return i==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=i,!0)}static getIntersectionsWithArrowheadCircle(e,t,n){let i=he.mkFullEllipseNNP(t,t,n);return x.getAllIntersections(i,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=C.distanceEpsilon*C.distanceEpsilon,n=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=C.distanceEpsilon)return n;let i=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u===0)return;l=Bn.getIntersectionsWithArrowheadCircle(i,o,i.end),n=l.length!==0?Math.max(...l.map(c=>c.par1)):i.parEnd,a=e.curve.value(n),o/=2}while(a.sub(i.start).lengthSquared<t||l.length===0);return n}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=C.distanceEpsilon)return e.curve.parStart;let t=C.distanceEpsilon*C.distanceEpsilon,n=e.sourceArrowhead.length,i,o=e.curve,a,l=10,u;for(;--l>0;){if(a=Bn.getIntersectionsWithArrowheadCircle(o,n,o.start),a.length===0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),i=a.filter(c=>c.par1===u)[0].x,i.sub(o.end).lengthSquared>=t)return u;n/=2}}static trimSplineAndCalculateArrowheads(e,t,n){return Bn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,n)}static trimSplineAndCalculateArrowheadsII(e,t,n,i,o){if(e.curve=x.trimEdgeSplineWithNodeBoundaries(t,n,i,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<C.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<C.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>C.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>C.intersectionEpsilon)&&!a&&(a=Bn.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!==0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=i.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=i.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,n=e.target.center,i=n.sub(t),o=i.length,a;o<.001?(a=new f(1,0),n=t.add(a.rotate(Math.PI/2))):a=i.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=x.createBezierSegN(t,n,a,u);if(Bn.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}Bn.createEdgeCurveWithNoTrimming(e,t,n)}static createEdgeCurveWithNoTrimming(e,t,n){let i=n.sub(t).normalize(),o=t,a=n,l=e.targetArrowhead;l!=null&&(l.tipPosition=n,a=n.sub(i.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(i.mul(u.length))),e.curve=R.mkPP(o,a)}},Ve=Bn;Ve.defaultArrowheadLength=5;var es=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new es(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length===0)return null;if(e.length===1)return e[0];let t=e[0].parallelogram,n=1,i=Oe.parallelogramOfTwo(t,e[n].parallelogram).area;for(let h=2;h<e.length;h++){let d=Oe.parallelogramOfTwo(t,e[h].parallelogram).area;d>i&&(n=h,i=d)}let o;for(let h=0;h<e.length;h++)if(h!==n){o=h;break}i=Oe.parallelogramOfTwo(e[n].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h===n)continue;let d=Oe.parallelogramOfTwo(e[n].parallelogram,e[h].parallelogram).area;d>i&&(o=h,i=d)}let a=new Array,l=new Array;a.push(e[n]),l.push(e[o]);let u=e[n].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h===n||h===o)continue;let d=Oe.parallelogramOfTwo(u,e[h].parallelogram),m=d.area-u.area,P=Oe.parallelogramOfTwo(c,e[h].parallelogram),S=P.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=P):m<S?(a.push(e[h]),u=d):(l.push(e[h]),c=P)}return{parallelogram:Oe.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var ts=class{clone(){let e=new ts;return e.transparency=this.transparency,e.width=this.width,e.color=this.color,e.icurve=this.icurve.clone(),e.label=this.label,e.dashArray=this.dashArray,e.drawPN=this.drawPN,e}static mkDebugCurveTWCILD(e,t,n,i,o,a,l=!1){let u=new ts;return u.transparency=e,u.width=t,u.color=n,u.icurve=i,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,n,i){return ts.mkDebugCurveTWCILD(e,t,n,i,null,null)}static mkDebugCurveWCI(e,t,n){return ts.mkDebugCurveTWCI(255,e,t,n)}static mkDebugCurveCI(e,t){return ts.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return ts.mkDebugCurveCI("Black",e)}},fe=ts;fe.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var jr=class{constructor(e,t,n,i,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=n,this.bottomSite=n.next,this.currentTopSite=n,this.currentBottomSite=n.next,this.layerArrays=i,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,n,i,o,a,l,u){new jr(e,t,n,o,a,l,i,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,n){if(e.equal(t))return t;let i=f.ClosestPointAtLineSegment(t,e,n),o=t.sub(i),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return Qo(2)===0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=jr.absCotan(e),n,i=!1;for(let o of this.bottomCorners()){let a=jr.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,n=o,i=!0)}return i?ie(t,jr.absCotan(e))?!1:(this.currentBottomSite=Be.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,n,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=jr.absCotan(e),n,i=!1;for(let o of this.topCorners()){let a=jr.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,n=o,i=!0)}return i?ie(t,jr.absCotan(e))?!1:(this.currentTopSite=Be.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,n,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,n=this.currentBottomSite.point.x;for(let i of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,n))for(let o of this.NodeCorners(i))o.y>this.currentBottomSite.point.y&&jr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,n=this.currentTopSite.point.x;for(let i of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,n))for(let o of this.NodeCorners(i))o.y<this.currentTopSite.point.y&&jr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,n=this.currentTopSite.point.x;for(let i of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,n))for(let o of this.NodeCorners(i))o.y>this.currentBottomSite.point.y&&jr.PossibleCorner(t,n,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,n=this.currentBottomSite.point.x;for(let i of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,n))for(let o of this.NodeCorners(i))o.y<this.currentTopSite.point.y&&jr.PossibleCorner(t,n,o)&&(yield o)}static PossibleCorner(e,t,n){return n.x>e&&n.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,n,i,o){let a=0,l=0;n===2&&(a=Number.MAX_VALUE),n===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>i&&(d.topAnchor>l+C.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+C.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,n,i,o){let a=0,l=0;n===2&&(a=Number.MAX_VALUE),n===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=i)break;d.left<o&&(d.topAnchor>l+C.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+C.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var nr=class{constructor(e,t,n,i,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=n,this.settings=i,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let n of e)t.push(n.pNodeOverICurve());return this.thinEastHierarchy=es.Calculate(this.thinRightNodes),es.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let n of e)t.push(n.pNodeOverICurve());return this.thinWestHierarchy=es.Calculate(this.thinWestNodes),es.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let n of this.edgePath){let i=null;for(let o of this.EastBoundaryNodesOfANode(n,ni.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(i==null||i.origin.x>a.origin.x)&&(i=a),e.push(a.polygonalBoundary)}i!=null&&this.thinRightNodes.push(R.mkLinePXY(i.origin,this.originalGraph.right,i.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let n of this.edgePath.nodes()){let i=-1;for(let o of this.LeftBoundaryNodesOfANode(n,ni.GetNodeKind(t,this.edgePath)))(i===-1||this.layerArrays.x[o]>this.layerArrays.x[i])&&(i=o),e.push(this.anchors[o].polygonalBoundary);if(i!==-1){let o=this.anchors[i];this.thinWestNodes.push(R.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,n){let i=0,o=0;n===2?i=Number.MAX_VALUE:n===0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>i&&(i=c.bottomAnchor),yield u):c.bottomAnchor>i&&(this.NodeUCanBeCrossedByNodeV(u,a)||(i=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,n){let i=0,o=0;n===0?o=Number.MAX_VALUE:n===2&&(i=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+C.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,i=Math.max(i,c.bottomAnchor),yield u):c.bottomAnchor>i+C.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),i=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)===this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let n=this.OutcomingEdge(e),i=this.OutcomingEdge(t);if(this.Intersect(n,i))return!0;e=n.Target,t=i.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}IntersectAbove(e,t){do{let n=this.IncomingEdge(e),i=this.IncomingEdge(t);if(this.Intersect(n,i))return!0;e=n.Source,t=i.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}Intersect(e,t){let n=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],i=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return n>0&&i<0||n<0&&i>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new Ue(this.headSite)}LineSegIntersectBound(e,t){let n=R.mkPP(e,t);return nr.CurveIntersectsHierarchy(n,this.westHierarchy)||nr.CurveIntersectsHierarchy(n,this.thinWestHierarchy)||nr.CurveIntersectsHierarchy(n,this.eastHierarchy)||nr.CurveIntersectsHierarchy(n,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return nr.SegIntersectsBound(e,t,this.westHierarchy)||nr.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return nr.SegIntersectsBound(e,t,this.eastHierarchy)||nr.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn===1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn===0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,n){return nr.CurveIntersectsHierarchy(R.mkPP(e.point,t.point),n)}static CurveIntersectsHierarchy(e,t){if(t==null||!Oe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let n=t.node;return nr.CurveIntersectsHierarchy(e,n.children[0])||nr.CurveIntersectsHierarchy(e,n.children[1])}return x.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return f.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2}Reverse(){let e=new nr(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,n=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=n,n!=null&&(n.prev=e.headSite),n=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,n;for(let i=0;i<this.edgePath.count;i++)n=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(i),this.EdgePathNode(i+1)),t=n;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,n){jr.Refine(t,n,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=Be.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=Be.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),n=this.anchors[e],i=this.anchors[t];if(ie(n.x,i.x))return;let o={ax:n.x,bx:i.x,sign:0};if(!this.FindLegalPositions(n,i,o))return;let a=(n.y-i.y)/(n.bottom-i.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new f(o.ax,n.y);let c=this.headSite.next,h=c.point.y;c.point=new f(this.MiddlePos(o.ax,o.bx,n,i,h),h),c.next.point=new f(o.bx,i.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),n=this.anchors[e],i=this.anchors[t];if(ie(n.x,i.x))return;let o={ax:n.x,bx:i.x,sign:0};if(!this.FindPositions(n,i,o))return;let a=(n.y-i.y)/(n.bottom-i.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new f(o.ax,n.y),this.headSite.next.point=new f(o.bx,i.y)}FindLegalPositions(e,t,n){return this.FindPositions(e,t,n)?this.PositionsAreLegal(n.ax,n.bx,n.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,n){let i,o;if(n.ax<n.bx?(n.sign=1,o=Math.max(n.ax,t.left),i=Math.min(e.right,n.bx)):(n.sign=-1,o=Math.max(e.left,n.bx),i=Math.min(t.right,n.ax)),o<=i)n.bx=.5*(o+i),n.ax=.5*(o+i);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;n.sign===1?(n.ax=e.right-.1*e.rightAnchor,n.bx=t.left):(n.ax=e.left+.1*e.leftAnchor,n.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let n=R.mkPP(e.origin,t.origin);return e.x<t.x&&x.CurvesIntersect(n,R.mkPP(e.rightBottom,e.rightTop))||x.CurvesIntersect(n,R.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&x.CurvesIntersect(n,R.mkPP(e.leftBottom,e.leftTop))||x.CurvesIntersect(n,R.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count===2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count===1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,n,i,o,a){if(!ie(e,t)&&(e-t)*n>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,i,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new f(e,i.bottom),new f(t,o.top)):!1}MiddleAnchorLegal(e,t,n){let i=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-n.x;return!(o>0&&this.anchors[i[o-1]].right>a+n.left||o<i.length-1&&this.anchors[i[o+1]].left<a+n.right)}MiddlePos(e,t,n,i,o){let a=n.y-o,l=o-i.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let n=t.turn;if(e===0)n>0?e=1:n<0&&(e=-1);else if(e*n<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e===this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new x,t=this.headSite,n=x.findCorner(t);return n!==void 0?(this.createFilletCurve(e,{a:t,b:n.b,c:n.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(R.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)nr.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!f.closeDistEps(t,e.start)){let n=new x;n.addSegs([R.mkPP(t,e.start),e]),e=n}return t=this.TailSite.point,f.closeDistEps(t,e.end)||e.addSegment(R.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,n,i){let o=.5,a;do a=x.createBezierSeg(o,o,e,t,n),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=x.createBezierSeg(o,o,e,t,n);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}i.segs.length>0&&!f.closeDistEps(i.end,a.start)&&i.addSegment(R.mkPP(i.end,a.start)),i.addSegment(a)}BezierSegIntersectsBoundary(e){return f.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(Oe.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let n=t.node;return this.BezierSegIntersectsTree(e,n.children[0])||this.BezierSegIntersectsTree(e,n.children[1])}else return nr.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let n of x.getAllIntersections(e,t,!1))if(t instanceof x){let i=t;if(x.realCutWithClosedCurve(n,i,!1))return!0}else return!0;return!1}};var ep=Ae(Qn()),ad=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.id=ad.debugCount++,this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new ad(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new ep.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let n of t.Children)e.enqueue(n)}}*Ancestors(){let e=new ep.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let n of t.Parents)e.enqueue(n)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}},mo=ad;mo.debugCount=0;var Zs=class{};var ir=class extends Zs{constructor(e,t){super();this.curve=this.curve,this.location=t.clone()}get Location(){return this.location}set Location(e){this.location=e}Translate(e){this.location=this.location.add(e)}get Curve(){return this.curve}set Curve(e){this.curve=e}};var or=class extends ir{static mk(e,t){return new or(e,t,new f(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(e){this.centerDelegate=e}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(e){this.curveDelegate=e}get LocationOffset(){return this.locationOffset}set LocationOffset(e){this.locationOffset=e}constructor(e,t,n){super(null,t().add(n));this.LocationOffset=n,this.CurveDelegate=e,this.CenterDelegate=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var ju=class{constructor(e,t,n,i,o){this.color=e,t!==void 0&&(this.item=t),n!==void 0&&(this.parent=n),i!==void 0&&(this.left=i),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var dt=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new ju(1)}clear(){this.root=this.nil=new ju(1)}toNull(e){return e!==this.nil?e:null}isEmpty(){return this.root===this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let n;for(;t!==this.nil&&(n=this.comparer(e,t.item))!==0;)t=n<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t===this.nil)return null;let n=null;for(;t!==this.nil;)t=e(t.item)?(n=t).left:t.right;return n}findLast(e,t=this.root){if(t===this.nil)return null;let n=null;for(;t!==this.nil;)t=e(t.item)?(n=t).right:t.left;return n}treeMinimum(e=this.root){for(;e.left!==this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!==this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!==this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!==this.nil&&e===t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!==this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!==this.nil&&e===t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!==this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!==this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!==this.root&&e.color===1;)if(e===e.parent.left){let t=e.parent.right;t.color===0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color===1&&t.right.color===1?(t.color=0,e=e.parent):(t.right.color===1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color===0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color===1&&t.left.color===1?(t.color=0,e=e.parent):(t.left.color===1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left===this.nil||e.right===this.nil)t=e;else for(t=e.right;t.left!==this.nil;)t=t.left;let n=t.left!==this.nil?t.left:t.right;return n.parent=t.parent,t.parent===this.nil?this.root=n:t===t.parent.left?t.parent.left=n:t.parent.right=n,t!==e&&(e.item=t.item),t.color===1&&this.deleteFixup(n),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,n=this.root,i=0;for(;n!==this.nil;)t=n,i=this.comparer(e,n.item),n=i<0?n.left:n.right;let o=new ju(1,e,t,this.nil,this.nil);return t===this.nil?this.root=o:i<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!==this.root&&e.parent.color===0;)if(e.parent===e.parent.parent.left){let t=e.parent.parent.right;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let n of this.allNodes())e+=n.toString(),t!==this.count-1&&(e+=`
`),t++;return e+"}"}};var $s=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let n=t>>1,i,o;for(;t>1&&this.Less(i=this.A[t],o=this.A[n]);)this.A[n]=i,this.A[t]=o,t=n,n=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,n=2,i=!1;for(;n<this.heapSize&&!i;){i=!0;let o=this.A[n],a=this.A[n+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[n]=e,i=!1,t=n,n=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[n+1]=e,i=!1,t=n+1,n=t<<1)}if(n===this.heapSize){let o=this.A[n];this.compare(o,e)<0&&(this.A[t]=o,this.A[n]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Xt=class{};var yn=class extends Xt{get Site(){return this.Vertex.point}constructor(e){super();this.Vertex=e}get Polyline(){return this.Vertex.polyline}};var tp=class extends yn{constructor(e){super(e)}};var rp=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(f.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),n=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(n))}};var np=class extends Xt{constructor(e){super();this.site=e}get Site(){return this.site}};var qu=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new $s((n,i)=>this.Compare(n,i)),this.ObstacleSideComparer=new rp(this),this.LeftObstacleSideTree=new dt((n,i)=>this.ObstacleSideComparer.Compare(n,i)),this.RightObstacleSideTree=new dt((n,i)=>this.ObstacleSideComparer.Compare(n,i))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+C.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>C.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(n=>f.pointToTheRightOfLineOrOnLine(e,n.Start,n.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(n=>!f.pointToTheRightOfLineOrOnLine(e,n.Start,n.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new np(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new tp(t))}GetLowestPoint(e){let t=e.startPoint,n=e.startPoint.next;for(;n!=null;n=n.next)this.Less(n.point,t.point)&&(t=n);return t}Compare(e,t){let n=e.Site,i=t.Site;return this.ComparePoints(n,i)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let n=this.SweepDirection.dot(e),i=this.SweepDirection.dot(t);return n<i?-1:n>i?1:(n=this.directionPerp.dot(e),i=this.directionPerp.dot(t),n<i?-1:n>i?1:0)}};var Y0=Ae(Ut()),yl=class{constructor(e,t,n=1){this.LengthMultiplier=1;this.Source=e,this.Target=t,this.Weight=n}static closeuv(e,t){return f.closeDistEps(e.point,yl.u,.1)&&f.closeDistEps(t.point,yl.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return Y0.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new yl(this.Target,this.Source)}Clone(){return new yl(this.Source,this.Target)}},ln=yl;ln.u=new f(545.833,840.458),ln.v=new f(606.1667261889578,786.2917261889578),ln.DefaultWeight=1;var sr=class extends ln{static constructorVV(e,t){return new sr(e,t,0)}constructor(e,t,n=0){super(e,t,n)}};var po=class{constructor(e){this._inEdges=new Array;this._outEdges=new dt((t,n)=>this.Compare(t,n)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t===-1)return;let n=this._inEdges.length-1;t!==n&&(this._inEdges[t]=this._inEdges[n]),this._inEdges.pop()}static FindFirst(e,t){return po.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,n){if(e===t.nil)return null;let i=null;for(;e!==t.nil;)e=e.item.TargetPoint.compareTo(n)>=0?(i=e).left:e.right;return i}get(e){let t=po.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target===e||(t=po.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target===this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var Xe=class{constructor(){this._prevEdgesMap=new Map;this.visVertexToId=new Map;this.VertexFactory=e=>new po(e);this.pointToVertexMap=new pt}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){this._prevEdgesMap.clear()}ShrinkLengthOfPrevEdge(e,t){this._prevEdgesMap.get(e).LengthMultiplier=t}PreviosVertex(e){let t=this._prevEdgesMap.get(e);return t?t.Source===e?t.Target:t.Source:null}SetPreviousEdge(e,t){this._prevEdgesMap.set(e,t)}AddHole(e){let t=e.startPoint;for(;t!==e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let n=t.startPoint;;n=n.next){let i=f.getTriangleOrientation(n.point,n.next.point,n.next.next.point);if(i!==2){yield i===0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let n=this.VertexFactory(e);return this.pointToVertexMap.set(e,n),n}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let n;if(n=e.get(t))return n;if(e===t)throw new Error("Self-edges are not allowed");let i=new ln(e,t);return e.OutEdges.insert(i),t.InEdges.push(i),i}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,n){let i=this.FindVertex(e),o=null;if(i!=null&&(o=this.FindVertex(t),o!=null)){let l=i.get(o);if(l)return l}i==null?(i=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=n(i,o);return i.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(n,i)=>new ln(n,i))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let n=this.FindVertex(e);if(n==null)return null;let i=this.FindVertex(t);return i==null?null:n.get(i)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var ea=class{constructor(){this.Removed=!1}};var ii=class extends ea{get Start(){return this.start}get End(){return this.EndVertex.point}constructor(e,t,n){super();this.start=e,this.EndVertex=t,this.ConeSide=n}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Xu=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var ld=class extends Xt{get ConeToClose(){return this.coneToClose}get Site(){return this.site}constructor(e,t){super();this.site=e,this.coneToClose=t}toString(){return"ConeClosureEvent "+this.site}};var Sn=class extends ea{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var Ni=class extends ea{constructor(e){super();this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var Sl=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let n=e instanceof ii,i=t instanceof ii;return n?i?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):i?this.CompareConeSideAndObstacleSide(e,t):Sl.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(f.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=f.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t===1?-1:t===0?1:e instanceof Sn?-1:1}CompareConeSideAndObstacleSide(e,t){let n=f.getTriangleOrientation(this.x,t.start,t.End);return n===1?-1:n===0||e instanceof Sn?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),n=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(n))}CompareBrokenSides(e,t){return e.EndVertex===t.EndVertex?Sl.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):f.getTriangleOrientation(this.x,t.start,t.EndVertex.point)===1?-1:1}};var ta=class extends Xt{get EndVertex(){return this.endVertex}constructor(e,t,n){super();this.coneLeftSide=e,this.intersectionPoint=t,this.endVertex=n}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var ra=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var na=class extends ra{Init(e){this.StartVertex=e}constructor(e){super();this.Init(e)}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var bo=class extends na{constructor(e){super(e);this.end=e.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var Gi=class extends yn{constructor(e){super(e)}};var ud=class extends Xt{get EndVertex(){return this.endVertex}set EndVertex(e){this.endVertex=e}constructor(e,t,n){super();this.coneRightSide=e,this.intersectionPoint=t,this.endVertex=n}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var Po=class extends na{constructor(e){super(e);this.end=e.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var Mi=class extends yn{constructor(e){super(e)}};var Bt=class extends qu{constructor(e,t,n,i,o,a,l){super(e,t);this.visibilityGraph=o,this.ConeRightSideDirection=n,this.ConeLeftSideDirection=i,this.coneSideComparer=new Sl(this),this.leftConeSides=new dt((u,c)=>this.coneSideComparer.Compare(u,c)),this.rightConeSides=new dt((u,c)=>this.coneSideComparer.Compare(u,c)),this.Ports=a,this.BorderPolyline=l,this.PortEdgesCreator=(u,c)=>new sr(u,c,0)}static Sweep(e,t,n,i,o,a){new Bt(e,t,t.rotate(-n/2),t.rotate(n/2),i,o,a).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let e of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(e.SourcePoint,e.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count===0)return;let e=this.BorderPolyline.startPoint,t=this.leftConeSides.count;do{let n=this.leftConeSides.treeMinimum().item.Cone;e=this.FindPolylineSideIntersectingConeRightSide(e,n),e=this.GetPolylinePointInsideOfConeAndRemoveCones(e,n),t--}while(this.leftConeSides.count>0&&t>0)}GetPolylinePointInsideOfConeAndRemoveCones(e,t){let n=e.nextOnPolyline,i=Bt.FindInsidePoint(e.point,n.point,t);return f.closeDistEps(i,e.point)?(this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)):f.closeDistEps(i,n.point)?(this.AddEdgeAndRemoveCone(t,n.point),this.AddEdgesAndRemoveRemainingConesByPoint(n.point),e=n):(e=Bt.InsertPointIntoPolylineAfter(this.BorderPolyline,e,i),this.AddEdgeAndRemoveCone(t,e.point),this.AddEdgesAndRemoveRemainingConesByPoint(e.point)),e}static FindInsidePoint(e,t,n){return Bt.FindInsidePointBool(e,t,n.Apex,n.Apex.add(n.LeftSideDirection),n.Apex.add(n.RightSideDirection))}static FindInsidePointBool(e,t,n,i,o){if(f.closeDistEps(e,t)||f.PointIsInsideCone(e,n,i,o))return e;if(f.PointIsInsideCone(t,n,i,o))return t;let a=f.middle(e,t);return f.pointToTheLeftOfLine(a,n,i)?Bt.FindInsidePointBool(a,t,n,i,o):Bt.FindInsidePointBool(e,a,n,i,o)}AddEdgesAndRemoveRemainingConesByPoint(e){let t=new Array;for(let n of this.leftConeSides)if(f.PointToTheRightOfLineOrOnLine(e,n.Start,n.Start.add(n.Direction)))t.push(n.Cone);else break;for(let n of t)this.AddEdgeAndRemoveCone(n,e)}FindPolylineSideIntersectingConeRightSide(e,t){let n=e,i=t.Apex,o=t.Apex.add(this.ConeRightSideDirection),a=Bt.GetSign(e,i,o);for(;;){let l=e.nextOnPolyline,u=Bt.GetSign(l,i,o);if(u-a>0)return e;if(e=l,a=u,e===n)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(e,t,n){let i=f.signedDoubledTriangleArea(t,n,e.point);return i<0?1:i>0?-1:0}AddEdgeAndRemoveCone(e,t){this.Ports!=null&&this.Ports.has(e.Apex)?this.CreatePortEdge(e,t):this.visibilityGraph.AddEdgePP(e.Apex,t),this.RemoveCone(e)}CreatePortEdge(e,t){this.portEdgesGraph==null&&(this.portEdgesGraph=new Xe);let n=this.portEdgesGraph.FindVertex(e.Apex),i=n!=null?Array.from(n.InEdges).concat(Array.from(n.OutEdges.allNodes())):null;if(i)for(let o of i){let a=(o.Target===n?o.Source:o.Target).point;Xe.RemoveEdge(o),this.portEdgesGraph.AddEdgePP(a,t)}this.portEdgesGraph.AddEdgePP(e.Apex,t)}static InsertPointIntoPolylineAfter(e,t,n){let i;return t.next!=null?(i=Lt.mkFromPoint(n),i.prev=t,i.next=t.next,t.next.prev=i,t.next=i):(i=Lt.mkFromPoint(n),i.prev=t,t.next=i,e.endPoint=i),i.polyline=e,e.setInitIsRequired(),i}ProcessEvent(e){e instanceof yn?this.ProcessVertexEvent(e):e instanceof ud?this.ProcessRightIntersectionEvent(e):e instanceof ta?this.ProcessLeftIntersectionEvent(e):(e instanceof ld?e.ConeToClose.Removed||this.RemoveCone(e.ConeToClose):this.ProcessPortObstacleEvent(e),this.Z=this.GetZS(e))}ProcessPortObstacleEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.CreateConeOnVertex(e)}ProcessLeftIntersectionEvent(e){if(e.coneLeftSide.Removed===!1)if(Math.abs(e.EndVertex.point.sub(e.Site).dot(this.SweepDirection))<C.distanceEpsilon)this.RemoveCone(e.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(e.coneLeftSide),this.Z=this.GetZP(e.Site);let t=new ii(e.Site,e.EndVertex,e.coneLeftSide);this.InsertToTree(this.leftConeSides,t),e.coneLeftSide.Cone.LeftSide=t,this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForLeftSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForLeftSide(e){if(e.Cone.RightSide instanceof Ni){let t=e.Cone.RightSide;f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.EndVertex.point)==0&&this.CreateConeClosureEvent(e,t)}}CreateConeClosureEvent(e,t){let n=f.RayIntersectsRayInteriors(e.start,e.Direction,t.Start,t.Direction);if(n){let i=new ld(n,e.Cone);this.EnqueueEvent(i)}}ProcessRightIntersectionEvent(e){if(e.coneRightSide.Removed===!1){this.RemoveSegFromRightTree(e.coneRightSide),this.Z=this.GetZP(e.Site);let t=new ii(e.Site,e.EndVertex,e.coneRightSide);this.InsertToTree(this.rightConeSides,t),e.coneRightSide.Cone.RightSide=t,this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,e.EndVertex),this.TryCreateConeClosureForRightSide(t)}else this.Z=this.GetZP(e.Site)}TryCreateConeClosureForRightSide(e){if(e.Cone.LeftSide instanceof Sn){let n=e.Cone.LeftSide;f.getTriangleOrientation(n.Start,n.Start.add(n.Direction),e.EndVertex.point)==1&&this.CreateConeClosureEvent(e,n)}}RemoveConesClosedBySegment(e,t){this.CloseConesCoveredBySegment(e,t,this.GetZP(e)>this.GetZP(t)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(e,t,n){let i=n.findFirst(l=>f.getTriangleOrientation(l.Start,l.Start.add(l.Direction),e)===1);if(i==null||!f.IntervalIntersectsRay(e,t,i.item.Start,i.item.Direction))return;let a=new Array;do a.push(i.item.Cone),i=n.next(i);while(i!=null&&f.IntervalIntersectsRay(e,t,i.item.Start,i.item.Direction)!==void 0);for(let l of a)this.RemoveCone(l)}ProcessVertexEvent(e){this.Z=this.GetZS(e),this.GoOverConesSeeingVertexEvent(e),this.AddConeAndEnqueueEvents(e)}static Diamond(e){return Ce.mkDiamond(2,2,e)}AddConeAndEnqueueEvents(e){if(e instanceof Gi){let n=e.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(e,n)}else if(e instanceof Mi){let i=e.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(e,i)}else this.CloseConesAddConeAtLeftVertex(e,e.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(e,e.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(e,t){let n=e.Vertex.nextOnPolyline.point;this.directionPerp.dot(e.Site.sub(n))>C.distanceEpsilon&&this.RemoveConesClosedBySegment(n,e.Vertex.point),this.directionPerp.dot(t.point.sub(e.Site))>C.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,t.point);let i=e.Site,o=i.add(this.ConeLeftSideDirection),a=i.add(this.ConeRightSideDirection),l=t.point;this.GetZP(i.sub(n))>C.distanceEpsilon&&this.RemoveRightSide(new Po(e.Vertex.nextOnPolyline)),this.GetZP(i.sub(t.point))>C.distanceEpsilon&&this.RemoveLeftSide(new bo(t)),this.GetZP(l)+C.distanceEpsilon<this.GetZS(e)&&this.CreateConeOnVertex(e),f.PointToTheRightOfLineOrOnLine(l,i,o)?f.PointToTheLeftOfLineOrOnLine(l,i,a)?this.CaseToTheLeftOfLineOrOnLineConeRp(e,t):(this.GetZP(l.sub(i))>C.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(e.Site,t),this.InsertRightSide(new Po(e.Vertex))),this.EnqueueRightVertexEvent(new Mi(t))):(this.CreateConeOnVertex(e),f.PointToTheLeftOfLineOrOnLine(l.add(this.DirectionPerp),l,i)&&this.EnqueueRightVertexEvent(new Mi(t)))}CaseToTheLeftOfLineOrOnLineConeRp(e,t){this.EnqueueRightVertexEvent(new Mi(t));let n=new Xu(e.Vertex.point,this),i=new ii(n.Apex,t,new Sn(n));n.LeftSide=i,n.RightSide=new Ni(n);let o=this.InsertToTree(this.rightConeSides,n.RightSide);this.LookForIntersectionWithConeRightSide(o);let a=this.InsertToTree(this.leftConeSides,n.LeftSide);this.FixConeLeftSideIntersections(i,a),this.GetZP(t.point.sub(e.Site))>C.distanceEpsilon&&this.InsertRightSide(new Po(e.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(e,t){let n=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(e);if(n!=null&&n.item instanceof Ni!=null){let o=f.IntervalIntersectsRay(e,t.point,n.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,t.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n.item,o,t))}}CreateRightIntersectionEvent(e,t,n){return new ud(e,t,n)}GetLastNodeToTheLeftOfPointInRightSegmentTree(e){return this.rightConeSides.findLast(t=>Bt.PointIsToTheRightOfSegment(e,t))}LookForIntersectionOfObstacleSideAndLeftConeSide(e,t){let n=this.GetFirstNodeToTheRightOfPoint(e);if(n==null||!(n.item instanceof Sn))return;let i=n.item,o=f.IntervalIntersectsRay(e,t.point,i.Start,this.ConeLeftSideDirection);o&&this.EnqueueEvent(new ta(i,o,t))}GetFirstNodeToTheRightOfPoint(e){return this.leftConeSides.findFirst(t=>Bt.PointIsToTheLeftOfSegment(e,t))}static PointIsToTheLeftOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)===1}static PointIsToTheRightOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e)===0}FixConeLeftSideIntersections(e,t){do t=this.leftConeSides.next(t);while(t!=null&&f.PointToTheRightOfLineOrOnLine(e.Start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null&&t.item instanceof Sn){let n=t.item,i=f.IntervalIntersectsRay(e.start,e.End,n.Start,n.Direction);i&&this.EnqueueEvent(new ta(n,i,e.EndVertex))}}InsertToTree(e,t){return this.coneSideComparer.SetOperand(t),e.insert(t)}CloseConesAddConeAtLeftVertex(e,t){let n=e.Vertex.prevOnPolyline.point;e.Site.sub(n).dot(this.directionPerp)<-C.distanceEpsilon&&this.RemoveConesClosedBySegment(e.Site,n),t.point.sub(e.Site).dot(this.directionPerp)<-C.distanceEpsilon&&this.RemoveConesClosedBySegment(t.point,e.Site);let i=e.Site,o=i.add(this.ConeLeftSideDirection),a=i.add(this.ConeRightSideDirection),l=t.point;this.GetZP(i.sub(n))>C.distanceEpsilon&&this.RemoveLeftSide(new bo(e.Vertex.prevOnPolyline));let u=this.GetZP(l)-this.Z;u<-C.distanceEpsilon&&this.RemoveRightSide(new Po(t));let c=l.sub(e.Site);if(u<-C.distanceEpsilon||ie(u,0)&&this.GetZP(c)>0&&c.dot(this.directionPerp)>-C.distanceEpsilon)this.CreateConeOnVertex(e);else if(!f.PointToTheLeftOfLineOrOnLine(l,i,a))this.CreateConeOnVertex(e),this.EnqueueEvent(new Gi(t));else if(f.PointToTheLeftOfLineOrOnLine(l,i,o))this.EnqueueEvent(new Gi(t)),this.GetZP(c)>C.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(e.Site,t),this.InsertLeftSide(new bo(e.Vertex)));else{this.EnqueueEvent(new Gi(t));let h=new Xu(e.Vertex.point,this),d=new ii(e.Vertex.point,t,new Ni(h));h.RightSide=d,h.LeftSide=new Sn(h),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,h.LeftSide));let m=this.InsertToTree(this.rightConeSides,d);this.FixConeRightSideIntersections(d,m),this.GetZP(c)>C.distanceEpsilon&&this.InsertLeftSide(new bo(e.Vertex))}}RemoveCone(e){e.Removed=!0,this.RemoveSegFromLeftTree(e.LeftSide),this.RemoveSegFromRightTree(e.RightSide)}RemoveSegFromRightTree(e){this.coneSideComparer.SetOperand(e);let t=this.rightConeSides.remove(e);if(e.Removed=!0,t==null){let n=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),t=this.rightConeSides.remove(e),this.Z=n}}RemoveSegFromLeftTree(e){if(e.Removed=!0,this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e)==null){let n=this.Z;this.Z=Math.max(this.GetZP(e.Start),this.Z-.01),this.coneSideComparer.SetOperand(e),this.leftConeSides.remove(e),this.Z=n}}FixConeRightSideIntersections(e,t){do t=this.rightConeSides.previous(t);while(t!=null&&f.PointToTheLeftOfLineOrOnLine(e.start,t.item.Start,t.item.Start.add(t.item.Direction)));if(t!=null){let n;if(t.item instanceof Ni){let i=t.item;(n=f.IntervalIntersectsRay(e.start,e.End,i.Start,i.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(i,n,e.EndVertex))}}}CreateConeOnVertex(e){let t=new Xu(e.Site,this);t.LeftSide=new Sn(t),t.RightSide=new Ni(t);let n=this.InsertToTree(this.leftConeSides,t.LeftSide),i=this.InsertToTree(this.rightConeSides,t.RightSide);this.LookForIntersectionWithConeRightSide(i),this.LookForIntersectionWithConeLeftSide(n)}LookForIntersectionWithConeLeftSide(e){if(e.item instanceof Sn){let n=e.item,i=this.FindFirstObstacleSideToTheLeftOfPoint(n.Start);i!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(n,i)}else{let n=e.item;e=this.leftConeSides.next(e),e!=null&&e.item instanceof Sn&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(e.item,n)}}LookForIntersectionWithConeRightSide(e){if(e.item instanceof Ni){let n=e.item,i=this.FindFirstObstacleSideToToTheRightOfPoint(n.Start);i!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(n,i)}else{let n=e.item;e=this.rightConeSides.previous(e),e!=null&&e.item instanceof Ni&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(e.item,n)}}TryIntersectionOfConeRightSideAndObstacleConeSide(e,t){let n=f.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,n,t.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(e,t){let n=f.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(e,n,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(e,t){let n=f.IntervalIntersectsRay(t.start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(new ta(e,n,t.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(e,t){let n=f.IntervalIntersectsRay(t.Start,t.End,e.Start,e.Direction);n&&this.EnqueueEvent(new ta(e,n,t.EndVertex))}Show(e,t){let n=Array.from(this.Obstacles).map(i=>fe.mkDebugCurveTWCI(200,.5,"Blue",i));for(let i of this.rightConeSides)n.push(fe.mkDebugCurveWCI(.5,"Brown",this.ExtendSegmentToZ(i))),i instanceof ii&&n.push(fe.mkDebugCurveCI("brown",Bt.Diamond(i.start))),n.push(fe.mkDebugCurveWCI(.5,"Green",this.ExtendSegmentToZ(i.Cone.LeftSide))),i.Cone.LeftSide instanceof ii&&n.push(fe.mkDebugCurveCI("green",Bt.Diamond(i.Cone.LeftSide.start)));n=n.concat(Array.from(this.visibilityGraph.Edges).map(i=>fe.mkDebugCurveWCI(2,"Black",R.mkPP(i.SourcePoint,i.TargetPoint)))),n=n.concat(e.map(i=>fe.mkDebugCurveCI("Red",i)))}ExtendSegmentToZ(e){let t=e.Direction.dot(this.SweepDirection),n=(this.Z+40-e.Start.dot(this.SweepDirection))/t;return R.mkPP(e.Start,e.Start.add(e.Direction.mul(n)))}GoOverConesSeeingVertexEvent(e){let t=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e);if(t==null)return;let i=t.item.Cone,o=i.LeftSide;if(Bt.VertexIsToTheLeftOfSegment(e,o))return;let a=[i];if(this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),t==null){let l=this.Z;this.Z=Math.max(this.GetZP(o.Start),this.PreviousZ),this.coneSideComparer.SetOperand(o),t=this.leftConeSides.find(o),this.Z=l}if(!(t==null&&(t=this.GetRbNodeEmergency(o),t==null))){for(t=this.leftConeSides.next(t);t!=null&&!Bt.VertexIsToTheLeftOfSegment(e,t.item);)a.push(t.item.Cone),t=this.leftConeSides.next(t);for(let l of a)this.AddEdgeAndRemoveCone(l,e.Site)}}GetRbNodeEmergency(e){if(this.leftConeSides.count===0)return null;for(let t=this.leftConeSides.treeMinimum();t!=null;t=this.leftConeSides.next(t))if(t.item===e)return t;return null}static VertexIsToTheLeftOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)===1}static VertexIsToTheRightOfSegment(e,t){return f.getTriangleOrientation(t.Start,t.Start.add(t.Direction),e.Site)===0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(e){return this.rightConeSides.findFirst(t=>!Bt.VertexIsToTheRightOfSegment(e,t))}EnqueueRightVertexEvent(e){this.GetZP(e.Site.sub(e.Vertex.prevOnPolyline.point))>C.tolerance||this.EnqueueEvent(e)}invariant(){for(let e of this.leftConeSides)if(e.Removed)return!1;for(let e of this.rightConeSides)if(e.Removed)return!1;return!0}};var yo=class extends Pe{constructor(e,t){super(null);this.coneAngle=Math.PI/6;this.ports=new We;this._obstacles=Array.from(Xe.OrientHolesClockwise(e)),this._visibilityGraph=t}static mk(e,t,n,i,o){let a=new yo(e,t);return a.Ports=i,a.BorderPolyline=o,a.ConeAngle=n,a}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Ports(){return this.ports}set Ports(e){this.ports=e}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(e){this.borderPolyline=e}get Bidirectional(){return this._bidirectional}set Bidirectional(e){this._bidirectional=e}static GetTotalSteps(e){return Math.floor((2*Math.PI-e/2)/e)+1}run(){let e=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let t;for(let n=0;(t=this.coneAngle*n)<=e;n++)super.ProgressStep(),this.AddDirection(new f(Math.cos(t),Math.sin(t)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let e=Math.PI/this.coneAngle;for(let t=0;t<e;t++){let n=t*this.coneAngle,i=new Xe;this.AddDirection(new f(Math.cos(n),Math.sin(n)),this.BorderPolyline,i);let o=new Xe;this.AddDirection(new f(Math.cos(n)*-1,Math.sin(n)*-1),this.BorderPolyline,o),this.AddIntersectionOfBothDirectionSweepsToTheResult(i,o)}}AddIntersectionOfBothDirectionSweepsToTheResult(e,t){for(let n of e.Edges)t.FindEdgePP(n.SourcePoint,n.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(n.SourcePoint,n.TargetPoint)}AddDirection(e,t,n){Bt.Sweep(this._obstacles,e,this.coneAngle,n,this.Ports,t)}};var Nt=class extends Zs{constructor(e){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=e,this.location=this.curve().start}mk(e,t){let n=new Nt(e);return n.HookSize=t,n}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(e){this.location=e}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(e){this.adjustmentAngle=e}get HookSize(){return this.hookSize}set HookSize(e){this.hookSize=e}};var br=class extends or{get LoosePolyline(){return this.loosePolyline}set LoosePolyline(e){this.loosePolyline=e}constructor(e,t,n=new f(0,0)){super(e,t,n)}static mk(e,t){return new br(e,t)}};var ar=class extends Zs{get Location(){return this.curve.value(this.parameter)}set Location(e){throw new Error("Method should not be called.")}static mk(e,t){let n=new ar;return n.curve=e,n.parameter=t,n}get Parameter(){return this.parameter}set Parameter(e){this.parameter=e}get Curve(){return this.curve}set Curve(e){this.curve=e}};var rs=class extends mo{get BoundaryCurve(){return this.curveDelegate()}set BoundaryCurve(e){if(e)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}constructor(e){super(null);this.curveDelegate=e}};var En=class{static GetShapes(e,t){let n=new Map;for(let i of e)En.ProcessAncestorDescendantCouple(i.target,i.source,n),En.InsertEdgePortsToShapes(n,i);for(let i of t)En.ProcessAncestorDescendantCouple(i.source,i.target,n),En.InsertEdgePortsToShapes(n,i);return En.BindShapes(n),Array.from(n.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,n]of e){if(!(t instanceof re))continue;let i=t;for(let o of ip(i)){let a=e.get(o);a&&n.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,n){let i=cd(t);do{for(let o of ip(i))En.CreateShapeIfNeeeded(o,n);if(i===e)break;i=cd(i)}while(!0);En.CreateShapeIfNeeeded(i,n)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new rs(()=>e.boundaryCurve))}static NumberOfActiveNodesIsUnderThreshold(e,t,n){let i=new Set;for(let o of e)if(En.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,i,n))return!1;for(let o of t)if(En.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,i,n))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,n,i){let o=cd(t);for(;;){for(let a of ip(o))if(n.add(a),n.size>i)return!0;if(o===e)break;o=cd(o)}return n.add(o),n.size>i}};function cd(s){let e=s.node.parent;return ce.getGeom(e)}function*ip(s){for(let e of s.graph.shallowNodes)yield ce.getGeom(e)}var qr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new f(0,Number.MAX_SAFE_INTEGER);let t=-1,n=0;for(let i of e)i.y<this.pivot.y?(this.pivot=i,t=n):i.y===this.pivot.y&&i.x>this.pivot.x&&(this.pivot=i,t=n),n++;if(n>=1){this.hullPoints=new Array(n-1),n=0;for(let i of e)n!==t?this.hullPoints[n++]={point:i,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new qr(e);for(let n of t.Calculate())yield n}*Calculate(){if(this.pivot.y!==Number.MAX_SAFE_INTEGER){if(this.hullPoints.length===0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return f.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)===1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=f.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t===1?!0:t===0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+C.distanceEpsilon&&e.x<this.pivot.x-C.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(TI(this.pivot))}static createConvexHullAsClosedPolyline(e){return ee.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(e)))}};function TI(s){return(e,t)=>{if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;switch(f.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let n=e.point.x-s.x,i=t.point.x-s.x;if(n>C.distanceEpsilon&&i<-C.distanceEpsilon)return-1;if(n<-C.distanceEpsilon&&i>C.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function Lr(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Lr(s,e.Left,t),Lr(s,e.Right,t)):e.Left!=null?(Lr(s.Left,e.Left,t),Lr(s.Left,e.Right,t),Lr(s.Right,e.Left,t),Lr(s.Right,e.Right,t)):(Lr(s.Left,e,t),Lr(s.Right,e,t)))}function Gt(s,e,t){!s.irect.intersects_rect(e.irect)||(s===e?wI(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Gt(s,e.Left,t),Gt(s,e.Right,t)):e.Left!=null?(Gt(s.Left,e.Left,t),Gt(s.Left,e.Right,t),Gt(s.Right,e.Left,t),Gt(s.Right,e.Right,t)):(Gt(s.Left,e,t),Gt(s.Right,e,t)))}function Cn(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s===e)return II(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(Cn(s,e.Left,t)||Cn(s,e.Right,t))return!0}else if(e.Left!=null){if(Cn(s.Left,e.Left,t)||Cn(s.Left,e.Right,t)||Cn(s.Right,e.Left,t)||Cn(s.Right,e.Right,t))return!0}else if(Cn(s.Left,e,t)||Cn(s.Right,e,t))return!0;return!1}function II(s,e){return s.Left==null?!1:Cn(s.Left,s.Left,e)||Cn(s.Left,s.Right,e)||Cn(s.Right,s.Right,e)}function wI(s,e){s.Left!=null&&(Gt(s.Left,s.Left,e),Gt(s.Left,s.Right,e),Gt(s.Right,s.Right,e))}var El=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,n=e+Math.floor((t-e)/2),i=this.f(n);if(i>=this.f(0)&&i>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(n=e+Math.floor((t-e)/2),this.BehaviourAtIndex(n)){case 1:e=n;break;case 0:t=n;break;case 2:return n}return e===t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e===0){let o=this.f(1);return o===t?2:o>t?0:1}if(e===this.length-1){let o=this.f(this.length-2);return o===t?2:o>t?1:0}let n=t-this.f(e-1),i=this.f(e+1)-t;return n*i<=0?2:n>0?0:1}FindMaximum(){let e=0,t=this.length-1,n=e+Math.floor((t-e)/2),i=this.f(n);if(i<=this.f(0)&&i<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(n=e+Math.floor((t-e)/2),this.BehaviourAtIndex(n)){case 1:t=n;break;case 0:e=n;break;case 2:return n}return e===t||this.f(e)>=this.f(t)?e:t}};var op=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),n=(this.f(this.length-1)-e)/(this.length-1);return i=>Math.min(this.f(i),e+n*i)}GetAdjustedSequenceForMaximum(){let e=this.f(0),n=(this.f(this.length-1)-e)/(this.length-1);return i=>Math.max(this.f(i),e+n*i)}FindMinimum(){return this.f(0)===this.f(this.length-1)?new El(this.f,this.length).FindMinimum():new El(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)===this.f(this.length-1)?new El(this.f,this.length).FindMaximum():new El(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var ia=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,n){let i=this.P.pnt(e);return this.upperBranchOnP?f.pointToTheLeftOfLineOrOnLine(n,i,t):f.pointToTheRightOfLineOrOnLine(n,i,t)}LeftFromLineOnQ(e,t,n){let i=this.Q.pnt(e);return this.lowerBranchOnQ?f.pointToTheLeftOfLineOrOnLine(n,i,t):f.pointToTheRightOfLineOrOnLine(n,i,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,n,i){for(;t!==e||i!==n;){let o=t!==e?this.MedianOnP(e,t):e,a=i!==n?this.MedianOnQ(n,i):n,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!==e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(n,i)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?n=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?i=a:h=!1:i!==n?this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:h=!1:h=!1,!c&&!h&&(e=o,t=o,n=a,i=a)}return[e,i]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=f.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.sub(t.qClosest).rotate(Math.PI/2),e.p1=t.p1,e.p2=t.p2,e.q1=t.q1,e.q2=t.q2}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2===e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2===e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1===e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1===e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=f.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),f.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:f.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=f.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),f.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:f.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,n,i){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(i-n)+1;return a>2||o===2&&a===2}ShrinkChunks(e){let t=e.p1===e.p2?e.p1:this.P.Median(e.p1,e.p2),n=e.q1===e.q2?e.q1:this.Q.Median(e.q2,e.q1),i=this.P.pp(t).point,o=this.Q.pp(n).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,n,i,o,a),!this.InternalCut(e,t,n,a.a1,a.a2,a.b1,a.b2)&&!ia.OneOfChunksContainsOnlyOneVertex(e,t,n,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:n},a)){if(e.p2===this.P.Next(e.p1)&&e.q1===this.Q.Next(e.q2)){let l=R.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab===0?e.p2=e.p1:l.parab===1?e.p1=e.p2:l.parcd===0?e.q2=e.q1:l.parcd===1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=n:a.a2>=Math.PI/2?e.p2=t:e.q2=n:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=n:e.q2=n}}InternalCut(e,t,n,i,o,a,l){let u=!1;if(i>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(n).point,d=this.P.pp(this.P.Next(t)).point,m=f.getTriangleOrientation(c,h,this.Q.pp(0).point),P=f.getTriangleOrientation(c,h,d);m===P?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(n).point,d=this.Q.pp(this.Q.Next(n)).point,m=f.getTriangleOrientation(c,h,this.P.pp(0).point),P=f.getTriangleOrientation(c,h,d);m===P?e.q2=this.Q.Next(n):e.q1=this.Q.Prev(n),u=!0}return u}GetAnglesAtTheMedian(e,t,n,i,o){o.a1=f.anglePCP(i,n,this.P.pnt(this.P.Prev(e))),o.a2=f.anglePCP(this.P.pnt(this.P.Next(e)),n,i),o.b1=f.anglePCP(this.Q.pnt(this.Q.Next(t)),i,n),o.b2=f.anglePCP(n,i,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,n){let i=e.p2===this.P.Next(e.p1),o=e.q1===this.Q.Next(e.q2);return i&&!o?(this.ProcessShortSide(e,t.mp,t.mq,n.a1,n.b1,n.a2,n.b2),!0):o&&!i?(this.SwapEverything(e,t,n),this.ProcessShortSide(e,t.mp,t.mq,n.a1,n.b1,n.a2,n.b2),this.SwapEverything(e,t,n),!0):!1}SwapEverything(e,t,n){this.SwapPq();let i=e.p2;e.p2=e.q1,e.q1=i,i=e.q2,e.q2=e.p1,e.p1=i,i=t.mq,t.mq=t.mp,t.mp=i,i=n.a2,n.a2=n.b1,n.b1=i,i=n.b2,n.b2=n.a1,n.a1=i}ProcessShortSide(e,t,n,i,o,a,l){t===e.p2?this.ProcessSide(e,n,i,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=n:o>=Math.PI/2?e.q1=n:a<l&&(f.canProject(this.Q.pnt(n),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=n:e.p1=e.p2):i+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,n,i,o){let a=this.Q.pnt(t);n<=Math.PI?n+i>=Math.PI?n>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:n<o&&(f.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,i>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,n,i,o){return e.p1===e.p2?(o>=Math.PI/2?e.q1=n:e.q2=n,!0):e.q1===e.q2?(i>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),n=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,n,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,n,e.q2)}CalculateRightTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),n=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,n,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,n,e.q2)}};var Yt=class{static mkFromPoints(e){return new Yt(ee.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,n,i){let o=i.rotate(Math.PI/2);this.polyline.startPoint.point.sub(n).dot(o)<0&&(o=o.mul(-1)),e===t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!==t);return e}static TestPolygonDist(e,t){let n=Number.MAX_SAFE_INTEGER;for(let i=0;i<e.count;i++)for(let o=0;o<t.count;o++){let a=R.minDistBetweenLineSegments(e.pnt(i),e.pnt(i+1),t.pnt(o),t.pnt(o+1));n=Math.min(n,a.dist)}return n}static Distance(e,t){let i=new ia(e,t).FindClosestPoints();return{p:i.pClosest,q:i.qClosest,dist:i.pClosest.sub(i.qClosest).length}}static DistanceOnly(e,t){return Yt.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let n=t.startPoint;n.next!=null&&n.next.next!=null;n=n.next)if(f.getTriangleOrientation(n.point,n.next.point,n.next.next.point)===2)return!1;return!0}static DistancePoint(e,t){let n=Number.MAX_VALUE;for(let i=0;i<e.count;i++){let o=f.distToLineSegment(t,e.points[i].point,e.points[(i+1)%e.count].point).dist;n=Math.min(n,o)}return n}GetTangentPoints(e,t){let n=new op(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=n.FindMaximum(),e.rightTangentPoint=n.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return n=>{let i=f.anglePCP(t,e,this.pnt(n));return i<Math.PI?i:i-2*Math.PI}}};var we=class{constructor(e,t,n,i){this.randomizeLoosePolylines=!1;this.TightObstacles=new Set;this.Obstacles=e,this.TightPadding=t,this.LoosePadding=n,this.IgnoreTightPadding=i}ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(R.mkPP(e,t))}static PadCorner(e,t,n,i,o){let a=we.GetPaddedCorner(t,n,i,o);return a.numberOfPoints===-1?!1:(e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return f.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t,n=!1){return we.CreatePaddedPolyline(x.polylineAroundClosedCurve(e),t,n)}static LoosePolylineWithFewCorners(e,t,n){return t<C.distanceEpsilon?e:we.CreateLoosePolylineOnBisectors(e,t,n)}static CreateLoosePolylineOnBisectors(e,t,n){let i=Array.from(we.BisectorPoints(e,t));n&&a();let o=qr.CalculateConvexHull(i);return ee.mkClosedFromPoints(o);function a(){for(let l=0;l<i.length;l++){let u=i[l];i[l]=new f(u.x+.001*Oi(),u.y+.001*Oi())}}}static CreateRectNodeOfPolyline(e){return st(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=we.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(we.LoosePolylineWithFewCorners(e,t,this.randomizeLoosePolylines))}this.RootOfLooseHierarchy=we.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=this.CreateTightObstacles_(),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size===0}ObstaclesIntersectICurve(e){let t=e.boundingBox;return we.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,n){if(!n.irect.intersects(t))return!1;if(n.UserData!=null){let i=n.UserData;return x.intersectionOne(i,e,!1)!=null||we.PointIsInside(i.start,e)}return we.CurveIntersectsRectangleNode(e,t,n.Left)||we.CurveIntersectsRectangleNode(e,t,n.Right)}static PointIsInside(e,t){return x.PointRelativeToCurveLocation(e,t)===2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(i=>x.polylineAroundClosedCurve(i)),t=we.CalculateHierarchy(e),n=we.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,n.size===0){for(let i of e){let o=we.FindMaxPaddingForTightPolyline(t,i,this.TightPadding);this.TightObstacles.add(we.LoosePolylineWithFewCorners(i,o,this.randomizeLoosePolylines))}this.RootOfTightHierarchy=we.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let i of e)this.TightObstacles.add(we.CreatePaddedPolyline(i,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=we.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;we.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=we.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(n)),this.OverlapsDetected=!0}}CreateTightObstacles_(){if(this.Obstacles.length===0)return null;for(let e of this.Obstacles)we.CalculateTightPolyline(this.TightObstacles,this.TightPadding,e);return we.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(this.TightObstacles)}static CalculateTightPolyline(e,t,n){let i=we.PaddedPolylineBoundaryOfNode(n,t);e.add(i)}static CalculateHierarchy(e){let t=e.map(n=>we.CreateRectNodeOfPolyline(n));return Ke(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=we.CalculateHierarchy(Array.from(e)),n;for(;(n=we.GetOverlappedPairSet(t)).size>0;)t=we.ReplaceTightObstaclesWithConvexHulls(e,Array.from(n));return t}static MapToInt(e){let t=new Map;for(let n=0;n<e.length;n++)t.set(e[n],n);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let n=new Set;for(let u of t)n.add(u[0]),n.add(u[1]);let i=Array.from(n),o=we.MapToInt(i),a=Jh(Array.from(t).map(u=>new ye(o.get(u[0]),o.get(u[1])))),l=Jn(a);for(let u of l){let c=u.map(m=>i[m]),h=Bi(c,m=>m),d=qr.createConvexHullAsClosedPolyline(h);for(let m of c)e.delete(m);e.add(d)}return we.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return x.PointRelativeToCurveLocation(e.start,t)!==0||x.PointRelativeToCurveLocation(t.start,e)!==0}static PolylinesIntersect(e,t){return x.CurvesIntersect(e,t)||we.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return Gt(e,e,(n,i)=>{we.PolylinesIntersect(n,i)&&t.add([n,i])}),t}static*BisectorPoints(e,t){for(let n=e.startPoint;n!=null;n=n.next){let i={skip:!1},o=we.GetStickingVertexOnBisector(n,t,i);i.skip||(yield o)}}static GetStickingVertexOnBisector(e,t,n){let i=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(i).normalize().add(o.sub(a).normalize()),u=l.length;return u<C.tolerance?n.skip=!0:(n.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,n){let i=n,o=new Yt(t),a=t.boundingBox.clone();a.pad(2*n);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!==t)){let u=Yt.Distance(o,new Yt(l)).dist;i=Math.min(i,u/we.LooseDistCoefficient)}return i}static GetPaddedCorner(e,t,n,i){let o=e.point,a=t.point,l=n.point;if(f.getTriangleOrientation(o,a,l)===1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(we.CornerIsNotTooSharp(o,a,l)){u=u.mul(i);let S=l.sub(a).normalize().mul(i).rotate(Math.PI/2),v=f.lineLineIntersection(o.add(u),a.add(u),a.add(S),l.add(S));return{a:v,b:v,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<C.intersectionEpsilon){let S=a.add(u.mul(i));return{a:S,b:S,numberOfPoints:1}}let h=c.normalize().mul(i),d=h.rotate(Math.PI/2),m=(i-h.dot(u))/d.dot(u),P=d.mul(m);return{a:h.add(P).add(a),b:h.sub(P).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,n){let i=e.sub(t).rotate(Math.PI/4).add(t);return f.getTriangleOrientation(t,i,n)===1}static CreatePaddedPolyline(e,t,n=!1){let i=new ee,o=n?LI(e):e;if(!we.PadCorner(i,o.endPoint.prev,o.endPoint,o.startPoint,t))return we.CreatePaddedPolyline(ee.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);if(!we.PadCorner(i,o.endPoint,o.startPoint,o.startPoint.next,t))return we.CreatePaddedPolyline(ee.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);for(let a=o.startPoint;a.next.next!=null;a=a.next)if(!we.PadCorner(i,a,a.next,a.next.next,t))return we.CreatePaddedPolyline(ee.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);return i.closed=!0,i}},Kt=we;Kt.LooseDistCoefficient=2.1;function LI(s){let e=new ee,t=.01;for(let n=s.startPoint;n;n=n.next){let i=n.point.x+t*Oi(),o=n.point.y+t*Oi();e.addPointXY(i,o)}return e.closed=s.closed,e}var Yu=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,n){let i=new Yu;return i.TightPolyline=e,i.LooseShape=t,i.Distance=n,i}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Ku=class{constructor(e,t,n,i){this.MainShape=e,this.TightPadding=t,this.LoosePadding=n,this.ShapesToTightLooseCouples=i}Calculate(e){this.MainShape.Children.length!==0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(e),this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=Ke(this.MainShape.Children.map(t=>st(t,t.BoundingBox)));Lr(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Ku.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return x.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)===2}CreateTigthLooseCouples(e){let t=new Array;for(let n of this.tightHierarchy.GetAllLeaves()){let i=Kt.FindMaxPaddingForTightPolyline(this.tightHierarchy,n,this.LoosePadding),o=Kt.LoosePolylineWithFewCorners(n,i,e);t.push(Yu.mk(n,new mo(o),i))}this.coupleHierarchy=Ke(t.map(n=>st(n,n.TightPolyline.boundingBox)))}CreateTightObstacles(){let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=Kt.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=Kt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),n=Bi(this.LoosePolylinesUnderShape(e),o=>o).filter(o=>x.PointRelativeToCurveLocation(o,t)===0);if(n.length<=0)return t;let i=Array.from(t).concat(n);return ee.mkClosedFromPoints(qr.CalculateConvexHull(i))}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var K0=Ae(Ut());var sp=class{constructor(e,t,n){this.indexToA=e,this.priority=t,this.v=n}};var Pr=class{constructor(e=Le){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let n=++this.heapSize,i=new sp(n,t,e);for(this.cache.set(e,i),this.A[n]=i;n>1&&this.compare(this.A[n>>1].priority,t)>0;)this.SwapWithParent(n),n>>=1}IsEmpty(){return this.heapSize===0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let n=t,i=t<<1;i<=this.heapSize&&this.compare(this.A[i].priority,this.A[t].priority)<0&&(n=i);let o=i+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[n].priority)<0&&(n=o),n!==t)this.SwapWithParent(n);else break;t=n}this.heapSize--}DecreasePriority(e,t){let n=this.cache.get(e);if(!n)return;n.priority=t;let i=n.indexToA;for(;i>1&&this.compare(this.A[i].priority,this.A[i>>1].priority)<0;){this.SwapWithParent(i);i>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count===0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new K0.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var ns=class{constructor(e,t,n){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=n,this._visGraph.ClearPrevEdgesTable();for(let i of n.Vertices())i.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new Pr(Le);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source===this.source||this.targets.has(e.Target)||!ns.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target===this.source||!ns.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof sr}ProcessNeighbor(e,t,n){let i=t.Length,o=this.current.Distance+i;o>=this.upperBound||(this.targets.has(n)&&(this.upperBound=o,this.closestTarget=n),n!==this.source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.Enqueue(n,o)):o<n.Distance&&(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.DecreasePriority(n,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!==this.source);return e.push(this.source),e.reverse()}};var Cl=class{constructor(e,t,n){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=n,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new Pr(Le);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let n={priority:0},i=t.DequeueAndGetPriority(n);if(n.priority>=this._target.Distance)break;for(let o of i.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,i,o,a)}for(let o of i.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,i,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source===this._source||e.Target===this._target||!Cl.IsForbidden(e)}PassableInEdge(e){return e.Source===this._target||e.Target===this._source||!Cl.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof sr}ProcessNeighborN(e,t,n,i,o){let a=n.Length+o,l=t.Distance+a;i!==this._source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=l,this._visGraph.SetPreviousEdge(i,n),i!==this._target&&e.Enqueue(i,this.H(i))):i!==this._source&&l<i.Distance&&(i.Distance=l,this._visGraph.SetPreviousEdge(i,n),i!==this._target&&e.DecreasePriority(i,this.H(i)))}ProcessNeighbor(e,t,n,i){let o=n.Length,a=t.Distance+o;i!==this._source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=a,this._visGraph.SetPreviousEdge(i,n),i!==this._target&&e.Enqueue(i,this.H(i))):i!==this._source&&a<i.Distance&&(i.Distance=a,this._visGraph.SetPreviousEdge(i,n),i!==this._target&&e.DecreasePriority(i,this.H(i)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,n=this._target;do t.push(n),e&&this._visGraph.ShrinkLengthOfPrevEdge(n,this.LengthMultiplier),n=this._visGraph.PreviosVertex(n);while(n!==this._source);return t.push(this._source),t.reverse()}};var Q0=Ae(Ut()),hd=class{toString(){return Q0.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var J0=Ae(Ut()),dd=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return J0.String.Format("{0},{1}",this.Start,this.End)}};var fd=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(f.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,n){return f.closeDistEps(e,f.ClosestPointAtLineSegment(e,t,n))}static IntersectDiagonalWithRay(e,t,n){let i=t.sub(e),o=n.Start,a=n.End,l=Kn.solve(a.x-o.x,i.x*-1,e.x-o.x,a.y-o.y,i.y*-1,e.y-o.y);return e.add(i.mul(l.y))}};var So=class{constructor(e){this.pivot=e}IComparer(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let n=e.Start.point.sub(this.pivot),i=t.Start.point.sub(this.pivot);return So.CompareVectorsByAngleToXAxis(n,i)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:So.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:So.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let n=e.x*t.y-e.y*t.x;if(n>C.tolerance)return-1;if(n<-C.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let i=Math.abs(e.x)-Math.abs(t.x);return i<0?-1:i>0?1:(i=Math.abs(e.y)-Math.abs(t.y),i<0?-1:i>0?1:0)}};var Di=class extends Pe{constructor(e,t,n){super(null);this.polygons=[];this.activeDiagonalComparer=new fd;this.polygons=e,this.visibilityGraph=n,this.addedPolygons=t}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let e of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(e);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(e){this.currentPolygon=e,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new dt(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let e=1;e<this.tangents.length;e++){let t=this.tangents[e];t.Diagonal!=null?(t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsHigh&&this.RemoveDiagonalFromActiveNodes(t.Diagonal)):t.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=t.End.point,this.InsertActiveDiagonal(new hd(t,t.Comp)),t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t))}}AddVisibleEdge(e){Xe.AddEdgeVV(Z0(this.visibilityGraph,e.start),Z0(this.visibilityGraph,e.End))}InitActiveDiagonals(){if(this.tangents.length===0)return;let e=this.tangents[0],t=e.start.point,n=e.End.point;for(let i of this.diagonals)Di.RayIntersectDiagonal(t,n,i)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=fd.IntersectDiagonalWithRay(t,n,i),this.InsertActiveDiagonal(i));if(e.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(e),e.IsLow===!1){let i=e.Diagonal;this.RemoveDiagonalFromActiveNodes(i)}}RemoveDiagonalFromActiveNodes(e){let t=this.activeDiagonalTree.deleteSubTree(e.RbNode);t!=null&&t.item!=null&&(t.item.RbNode=t),e.LeftTangent.Diagonal=null,e.RightTangent.Diagonal=null}InsertActiveDiagonal(e){e.RbNode=this.activeDiagonalTree.insert(e),Di.MarkDiagonalAsActiveInTangents(e)}static MarkDiagonalAsActiveInTangents(e){e.LeftTangent.Diagonal=e,e.RightTangent.Diagonal=e}static RayIntersectDiagonal(e,t,n){let i=n.Start,o=n.End;return f.getTriangleOrientation(e,i,o)===1&&f.getTriangleOrientation(e,t,i)!==1&&f.getTriangleOrientation(e,t,o)!==0}static TangentComparison(e,t){return So.CompareVectorsByAngleToXAxis(e.End.point.sub(e.start.point),t.End.point.sub(t.start.point))}*AllObstacles(){for(let e of this.addedPolygons)yield e;if(this.polygons)for(let e of this.polygons)yield e}OrganizeTangents(){for(let e of this.AllObstacles())e!==this.currentPolygon&&this.ProcessPolygonQ(e);this.tangents.sort(Di.TangentComparison)}ProcessPolygonQ(e){let t=new ia(this.currentPolygon,e);this.useLeftPTangents?t.CalculateLeftTangents():t.CalculateRightTangents();let n=this.useLeftPTangents?t.leftPLeftQ:t.rightPLeftQ,i=new dd(this.currentPolygon.pp(n[0]),e.pp(n[1]));i.IsLow=!0,i.SeparatingPolygons=!this.useLeftPTangents,n=this.useLeftPTangents?t.leftPRightQ:t.rightPRightQ;let o=new dd(this.currentPolygon.pp(n[0]),e.pp(n[1]));o.IsLow=!1,o.SeparatingPolygons=this.useLeftPTangents,i.Comp=o,o.Comp=i,this.tangents.push(i),this.tangents.push(o),this.diagonals.push(new hd(i,o))}};function Z0(s,e){return s.FindVertex(e.point)}var Qu=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(f.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),n=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*n.y-n.x*t.y)<C.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,n){let i=Kn.solve(t.x-e.x,-n.x,this.Pivot.x-e.x,t.y-e.y,-n.y,this.Pivot.y-e.y);if(!(-C.tolerance<=i.x&&i.x<=1+C.tolerance))throw new Error;if(!i)throw new Error;return this.Pivot.add(n.mul(i.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let n=new Qu;return n.pivot=e,n.pointOnTheRay=t,n}};var $0=Ae(Ut()),oa=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!==this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!==this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return $0.String.Format("Stem({0},{1})",this.Start,this.End)}};var oi=class{constructor(e,t,n,i){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=n,this.qPolylinePoint=Lt.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=i;let o=new So(this.q);this.heapForSorting=new $s(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,n,i){let o=t.FindVertex(n);if(o!=null)return o;let a=new oi(e,t,n,i);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!==0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let n=!1;for(let i of t.Sides()){let o=i;if(o.point.y<this.q.y){if(i.nextOnPolyline.point.y>=this.q.y){let a=f.getTriangleOrientation(this.q,o.point,i.nextOnPolyline.point);if(a===1||a===2){n=!0,yield new oa(t.Start,i),yield new oa(i.nextOnPolyline,t.End),this.RegisterActiveSide(i);break}}}else{if(o.point.y>this.q.y)break;if(i.point.x>=this.q.x){n=!0,yield new oa(i,t.End),i!==t.Start&&(yield new oa(t.Start,e.prev(o))),this.RegisterActiveSide(i);break}}}n||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new f(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=oi.GetIncomingSide(e),n=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let i;if(i=this.sideNodes.get(t)){if(i===this.activeSidesTree.treeMinimum()&&this.AddEdge(e),n!=null)i.item=n,this.sideNodes.set(n,i);else{let o=this.activeSidesTree.deleteSubTree(i);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(n!=null){let o;(o=this.sideNodes.get(n))||(o=this.activeSidesTree.insert(n),this.sideNodes.set(n,o),o===this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind===0||this.visibilityKind===1&&oi.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,n)=>new sr(t,n))}static LineTouchesPolygon(e,t){let n=t.polyline.prev(t).point,i=t.polyline.next(t).point,o=t.point;return f.signedDoubledTriangleArea(e,o,n)*f.signedDoubledTriangleArea(e,o,i)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e===t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Qu,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new dt(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,n=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))n=!1;let i=e.next(t);if(n)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,i);i=e.next(i));this.visibleBoundaries.set(e,new oa(t,i))}HoleSideIsVisibleFromQ(e,t){return f.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-C.squareOfDistanceEpsilon}};var ze=class extends Pe{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=z.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}static constructorANNN(e,t,n,i){return ze.constructorANNNB(e,t,n,i,!1)}get Obstacles(){return this.obstacles_}set Obstacles(e){this.obstacles_=e}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(e){this.enteringAngleBound_=e}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(e){this._sourceTightPolyline=e}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(e){this.targetTightPolyline=e}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(e){this.targetLoosePolyline=e}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(e){this.visibilityGraph=e}get SourcePort(){return this.sourcePort}set SourcePort(e){if(this.sourcePort=e,this.sourcePort!=null)if(this.SourceTightPolyline=ze.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof ir)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let t=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(t.Curve,t.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(e){this.targetPort=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=e)}get OffsetForPolylineRelaxing(){return this.TightPadding*.75}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(e){this.startPointOfRouting_=e}ExtendVisibilityGraphToLocation(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Xe);let t=null;if(!this.activeRectangle.contains(e)){this.activeRectangle.isEmpty?this.activeRectangle=z.mkPP(this.SourcePort.Location,e):this.activeRectangle.add(e),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null||t.length===0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Di(t,this.activePolygons,this.VisibilityGraph).run(),Ri(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(e){this.targetVV=oi.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,e,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=oi.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(e,t,n){let i=e.value(t),o=e.leftDerivative(t).normalize().add(e.rightDerivative(t).normalize()).normalize();f.getTriangleOrientation(ze.PointInsideOfConvexCurve(e),i,i.add(o))==1&&(o=o.mul(-1)),o=o.rotate(Math.PI/2);let a=n.boundingBox.diagonal,l=R.mkPP(i,i.add(o.mul(a))),u=x.intersectionOne(l,n,!1).x,c=o.mul(u.sub(i).length/2);for(;;){l=R.mkPP(i,u.add(c));let h=!1;for(let d of ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(l,this.ObstacleCalculator.RootOfLooseHierarchy))if(d.seg1!==n){c=c.div(1.5),h=!0;break}if(!h)break}return l.end}static PointInsideOfConvexCurve(e){return e.value(0).add(e.value(1.5)).div(2)}*GetActivePolylines(){for(let e of this.activePolygons)yield e.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let e=this.activeRectangle,t=new Array,n;do{n=!1;for(let i of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(i)||(e.addRec(i.boundingBox),t.push(new Yt(i)),this.alreadyAddedOrExcludedPolylines.add(i),n=!0);n&&(this.activeRectangle=e)}while(n);return t}PolylineSegmentIntersectsTightHierarchy(e,t){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(e,t,n){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(R.mkPP(e,t),n)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t){if(!e.boundingBox.intersects(t.irect))return!1;if(t.UserData!=null){for(let n of x.getAllIntersections(e,t.UserData,!1))if(n.seg1!==this.SourceTightPolyline&&n.seg1!==this.TargetTightPolyline||(n.seg1===this.SourceTightPolyline&&this.SourcePort)instanceof ar||(n.seg1===this.TargetTightPolyline&&this.TargetPort)instanceof ar)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(e,t.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,t){let n=new Array;return ze.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,n),n}static IntersectionsOfLineAndRectangleNodeOverPolyline(e,t,n){if(t!=null&&!!e.boundingBox.intersects(t.irect)){if(t.UserData!=null){Ri(n,x.getAllIntersections(e,t.UserData,!0));return}ze.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Left,n),ze.IntersectionsOfLineAndRectangleNodeOverPolyline(e,t.Right,n)}}LineCanBeAcceptedForRouting(e){let t=this.SourcePort instanceof ir,n=this.TargetPort instanceof ir;if(!t&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.end,this.SourcePort)||!n&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(e.start,this.TargetPort))return!1;let i=ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy);for(let o of i)if(o.seg1!==this.SourceTightPolyline&&o.seg1!==this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(e,t){let n=t.Curve,i=Kt.CurveIsClockwise(n,ze.PointInsideOfConvexCurve(n)),o=t.Location,a=this.GetPointOnTheRightBoundaryPortConeSide(o,n,i,t.Parameter),l=this.GetPointOnTheLeftBoundaryPortConeSide(o,n,i,t.Parameter);return f.getTriangleOrientation(o,a,e)!==0&&f.getTriangleOrientation(o,e,l)!==0}GetPointOnTheRightBoundaryPortConeSide(e,t,n,i){let o=n?t.rightDerivative(i):t.leftDerivative(i).neg();return e.add(o.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(e,t,n,i){let o=n?t.leftDerivative(i).neg():t.rightDerivative(i);return e.add(o.rotate(-this.EnteringAngleBound))}SmoothenCorners(e){let t=e.headSite,n={b:null,c:null};for(;n=x.findCorner(t);)t=this.SmoothOneCorner(t,n.c,n.b)}SmoothOneCorner(e,t,n){let a=.5,l,u,c;e.prev==null?(c=2,u=1):t.next==null?(c=1,u=2):c=u=1;do l=x.createBezierSeg(a*c,a*u,e,n,t),n.previouisBezierCoefficient=a*c,n.nextBezierCoefficient=a*u,a/=1.5;while(h()>this.loosePadding&&a>.01);return a*=1.5,a<.5&&a>.01&&(a=.5*(a+a*1.5),l=x.createBezierSeg(a*c,a*u,e,n,t),h()>this.loosePadding&&(n.previouisBezierCoefficient=a*c,n.nextBezierCoefficient=a*u)),n;function h(){let d=l.closestParameter(n.point);return n.point.sub(l.value(d)).length}}TryToRemoveInflectionsAndCollinearSegments(e){let t=!0,n={s:null};for(;t;)for(t=!1,n.s=e.headSite;n.s!=null&&n.s.next!=null;n.s=n.s.next)n.s.turn*n.s.next.turn<0&&(t=this.TryToRemoveInflectionEdge(n)||t)}TryToRemoveInflectionEdge(e){if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.point)){let t=e.s.prev,n=e.s.next;return t.next=n,n.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.prev.point,e.s.next.next.point)){let t=e.s.prev,n=e.s.next.next;return t.next=n,n.prev=t,e.s=t,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(e.s.point,e.s.next.next.point)){let t=e.s.next.next;return e.s.next=t,t.prev=e.s,!0}return!1}GetShortestPolyline(e,t){this.CleanTheGraphForShortestPath();let i=new Cl(this.visibilityGraph,e,t).GetPath(this.UseEdgeLengthMultiplier);if(i==null)return null;let o=new ee;for(let a of i)o.addPoint(a.point);return o=o.RemoveCollinearVertices(),this.pathOptimizer?(this.pathOptimizer.run(o,this.SourceLoosePolyline,this.targetLoosePolyline),this.pathOptimizer.poly):o}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(e){this.ObstacleCalculator.RootOfTightHierarchy=e}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(e){this.ObstacleCalculator.RootOfLooseHierarchy=e}CalculateObstacles(){this.ObstacleCalculator=new Kt(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}static constructorANNNB(e,t,n,i,o){let a=new ze(null);return a.IgnoreTightPadding=o,a.EnteringAngleBound=80*(Math.PI/180),a.TightPadding=t,a.LoosePadding=n,i>0?(Ee.assert(i>Math.PI/180),Ee.assert(i<=90*(Math.PI/180)),a.UseSpanner=!0,a.ExpectedProgressSteps=yo.GetTotalSteps(i)):a.ExpectedProgressSteps=e.length,a.ConeSpannerAngle=i,a.Obstacles=e,a.CalculateObstacles(),a}RouteEdgeToLocation(e){this.TargetPort=new ir(null,e),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let t=new be(null),n=R.mkPP(this.SourcePort.Location,e);return this.LineCanBeAcceptedForRouting(n)?(this._polyline=new ee,this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),t.smoothedPolyline=Ue.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):this.SourcePort instanceof ar&&(n=R.mkPP(this.StartPointOfEdgeRouting,e),ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(n,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new ee,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),t.smoothedPolyline=Ue.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t):(this.ExtendVisibilityGraphToLocation(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.SourcePort instanceof ar&&this._polyline.PrependPoint(this.SourcePort.Location),t.smoothedPolyline=Ue.mkFromPoints(this._polyline),t.curve=t.smoothedPolyline.createCurve(),t)}RouteEdgeToPort(e,t,n,i){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),R.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=e,this.TargetTightPolyline=ze.GetFirstHitPolyline(e.Location,this.ObstacleCalculator.RootOfTightHierarchy),e instanceof ar?this.RouteEdgeToBoundaryPort(t,n,i):this.RouteEdgeToFloatingPortOfNode(t,n,i))}SmoothedPolylineFromTwoPoints(e,t){return this._polyline=new ee,this._polyline.addPoint(e),this._polyline.addPoint(t),Ue.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(e,t,n){return this.sourcePort instanceof ir?this.RouteFromFloatingPortToFloatingPort(e,t,n):this.RouteFromBoundaryPortToFloatingPort(e,t,n)}RouteFromBoundaryPortToFloatingPort(e,t,n){let i=this.SourcePort.Location,o=this.targetPort.Location,a=R.mkPP(i,o);if(this.LineCanBeAcceptedForRouting(a))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a;if(!this.targetIsInsideOfSourceTightPolyline){let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(a=R.mkPP(u,o),this.LineAvoidsTightHierarchyLP(a,e))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),a}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let l=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.TryShortcutPolyline(),this.SourceTightPolyline=l,this._polyline.PrependPoint(i),this.SmoothCornersAndReturnCurve(t,n)}SmoothCornersAndReturnCurve(e,t){return t.smoothedPolyline=Ue.mkFromPoints(this._polyline),e&&this.SmoothenCorners(t.smoothedPolyline),t.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(e,t,n){let i=this.TargetPort.Location,o=R.mkPP(this.StartPointOfEdgeRouting,i);return this.AllowedShootingStraightLines&&this.LineAvoidsTightHierarchyLPP(o,this.SourceTightPolyline,this.targetTightPolyline)?(n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o):(this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(e),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),n.smoothedPolyline=Ue.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(t,n)))}TryShortcutPolyline(){}TryShortCutThePolylineEnds(){this.TryShortcutPolylineStart(),this.TryShortcutPolylineEnd()}TryShortcutPolylineEnd(){let e=this._polyline.endPoint,t=e.prev;if(t==null)return!1;let n=t.prev;if(n==null)return!1;if(this.LineAvoidsTightHierarchyPPPP(e.point,n.point,this._sourceTightPolyline,this.targetTightPolyline))return e.prev=n,n.next=e,e.polyline.setInitIsRequired(),!0;let i=f.middle(t.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,i,this._sourceTightPolyline,this.targetTightPolyline)){let o=Lt.mkFromPoint(i);return o.next=e,o.prev=n,e.prev=o,n.next=o,e.polyline.setInitIsRequired(),!0}return!1}TryShortcutPolylineStart(){let e=this._polyline.startPoint,t=e.next;if(t==null)return;let n=t.next;if(n==null)return;if(this.LineAvoidsTightHierarchyPPPP(e.point,n.point,this._sourceTightPolyline,this.targetTightPolyline))return e.next=n,n.prev=e,e.polyline.setInitIsRequired(),!0;let i=f.middle(t.point,n.point);if(this.LineAvoidsTightHierarchyPPPP(e.point,i,this._sourceTightPolyline,this.targetTightPolyline)){let o=Lt.mkFromPoint(i);return o.prev=e,o.next=n,e.next=o,n.prev=o,e.polyline.setInitIsRequired(),!0}}ShortcutPolylineOneTime(){let e=!1;for(let t=this._polyline.startPoint;t.next!=null&&t.next.next!=null;t=t.next)e=e||this.TryShortcutPolyPoint(t);return e}TryShortcutPolyPoint(e){return this.LineAvoidsTightHierarchyLPP(R.mkPP(e.point,e.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(e.next=e.next.next,e.next.prev=e,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(e){this.VisibilityGraph==null&&(this.VisibilityGraph=new Xe);let t=null,n=this.targetPort.Location;if(!this.activeRectangle.contains(n)){this.activeRectangle.isEmpty?this.activeRectangle=z.mkPP(this.SourcePort.Location,n):this.activeRectangle.add(n),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let i of t)this.VisibilityGraph.AddHole(i.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,e),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new Di(t,this.activePolygons,this.VisibilityGraph).run(),Ri(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,e),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(e,t){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(e,t):this.targetVV=oi.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(t),this.VisibilityGraph,e,1)}AddTransientVisibilityEdgesForPort(e,t){let n=this.GetVertex(e);if(n!=null)return n;if(n=this.visibilityGraph.AddVertexP(e),t!=null)for(let i of t)this.visibilityGraph.AddEdgeF(e,i,(o,a)=>new sr(o,a));else n=oi.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,e,1);return n}GetVertex(e){let t=this.visibilityGraph.FindVertex(e);return t==null&&this.LookForRoundedVertices&&(t=this.visibilityGraph.FindVertex(C.RoundPoint(e))),t}*GetActivePolylinesWithException(e){for(let t of this.activePolygons)t.Polyline!==e&&(yield t.Polyline)}RouteEdgeToBoundaryPort(e,t,n){return this.TargetLoosePolyline=e,this.sourcePort instanceof ir?this.RouteFromFloatingPortToBoundaryPort(t,n):this.RouteFromBoundaryPortToBoundaryPort(t,n)}RouteFromBoundaryPortToBoundaryPort(e,t){let n=this.SourcePort.Location,i,o=this.targetPort.Location,a=R.mkPP(n,o);if(this.LineCanBeAcceptedForRouting(a))this._polyline=new ee,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(a.start,a.end),i=Ue.mkFromPoints(this._polyline).createCurve();else{let l=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(a=R.mkPP(n,l),this.InsideOfTheAllowedConeOfBoundaryPort(l,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(a,this._sourceTightPolyline))this._polyline=new ee,this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(a=R.mkPP(this.StartPointOfEdgeRouting,o),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(a))this._polyline=new ee,this._polyline.addPoint(n),this._polyline.addPoint(a.start),this._polyline.addPoint(a.end),i=this.SmoothCornersAndReturnCurve(e,t);else{let u;if(u=R.IntersectPPPP(n,this.StartPointOfEdgeRouting,o,l))this._polyline=new ee,this._polyline.addPoint(n),this._polyline.addPoint(u),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(f.closeDistEps(this.StartPointOfEdgeRouting,l))this._polyline=new ee,this._polyline.addPoint(n),this._polyline.addPoint(l),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else if(this.LineAvoidsTightHierarchy(R.mkPP(this.StartPointOfEdgeRouting,l)))this._polyline=new ee,this._polyline.addPoint(n),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(l),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t);else{this.ExtendVisibilityGraphToTargetBoundaryPort(l),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let c={tmpTargetTight:null},h=this.HideSourceTargetTightsIfNeeded(c);this.TryShortcutPolyline(),this.RecoverSourceTargetTights(h,c.tmpTargetTight),this._polyline.PrependPoint(n),this._polyline.addPoint(o),i=this.SmoothCornersAndReturnCurve(e,t)}}}return i}RecoverSourceTargetTights(e,t){this.SourceTightPolyline=e,this.TargetTightPolyline=t}HideSourceTargetTightsIfNeeded(e){let t=this.SourceTightPolyline;return e.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,t}LineAvoidsTightHierarchy(e){return ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy).length===0}RouteFromFloatingPortToBoundaryPort(e,t){let n=this.targetPort.Location,i;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(i=R.mkPP(this.SourcePort.Location,n),this.LineCanBeAcceptedForRouting(i)))return t.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(i.start,i.end),i;let o=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(i=R.mkPP(this.SourcePort.Location,o),this.LineAvoidsTightHierarchyLP(i,this._sourceTightPolyline))return this._polyline=ee.mkFromPoints([i.start,i.end,n]),t.smoothedPolyline=Ue.mkFromPoints(this._polyline),t.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(o),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline.addPoint(n);let a={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(e,a)}LineAvoidsTightHierarchyLP(e,t){let n=!0;for(let i of ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(i.seg1!==t){n=!1;break}return n}LineAvoidsTightHierarchyLPP(e,t,n){let i=!0;for(let o of ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(e,this.ObstacleCalculator.RootOfTightHierarchy))if(!(o.seg1===t||o.seg1===n)){i=!1;break}return i}LineAvoidsTightHierarchyPPPP(e,t,n,i){return this.LineAvoidsTightHierarchyLPP(R.mkPP(e,t),n,i)}ExtendVisibilityGraphToTargetBoundaryPort(e){let t=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new Xe),!this.activeRectangle.contains(e)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(e)):(this.activeRectangle.add(e),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),t=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of t)this.VisibilityGraph.AddHole(n.Polyline)}t==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(e)):(this.RemovePointVisibilityGraphs(),new Di(t,this.activePolygons,this.VisibilityGraph).run(),Ri(this.activePolygons,t),this.CalculateEdgeTargetVisibilityGraph(e),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(e){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:ze.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(e,t){let n=ze.GetFirstHitRectangleNode(e,t);return n?n.UserData:null}static GetFirstHitRectangleNode(e,t){return t==null?null:t.FirstHitNodePF(e,(n,i)=>x.PointRelativeToCurveLocation(n,i)!==0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(e,t){this.SourceLoosePolyline=t,this.sourcePort=e,this.sourcePort!=null&&(this.SourceTightPolyline=ze.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof ir?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new Xe,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let t of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(t);let e;this.UseSpanner?e=new yo(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):e=new Di(new Array,this.activePolygons,this.visibilityGraph),e.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e,t,n,i){let o=e instanceof ir&&t instanceof ar||e instanceof Nt;if(o){let l=e;e=t,t=l}this.sourcePort=e,this.targetPort=t,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let a=this.GetEdgeGeomByRouting(n,i);return a==null?null:(this.targetVV=null,this.sourceVV=null,o&&(a=a.reverse()),a)}GetEdgeGeomByRouting(e,t){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||x.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)===2;let n;if(this.sourcePort instanceof ar){let i=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?i.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(i.Curve,i.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let o={smoothedPolyline:null};this.targetPort instanceof ar?n=this.RouteFromBoundaryPortToBoundaryPort(e,o):n=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,e,o)}else this.targetPort instanceof ir?(this.ExtendVisibilityGraphFromFloatingSourcePort(),n=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,e,t)):n=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,e,t,this.targetPort);return n}RouteFromFloatingPortToAnywherePort(e,t,n,i){return i.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(e))),this._polyline==null?null:(this.UseSpanner&&this.TryShortcutPolyline(),this.FixLastPolylinePointForAnywherePort(i),i.HookSize>0&&this.BuildHook(i),this.SmoothCornersAndReturnCurve(t,n))):(n.smoothedPolyline=null,null)}BuildHook(e){let t=e.Curve,n=he.mkFullEllipseNNP(e.HookSize,e.HookSize,this._polyline.end),i=x.getAllIntersections(t,n,!0);f.getTriangleOrientation(i[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&i.reverse();let o=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),a=t.derivative(i[0].par0).normalize(),l=a.dot(o);if(Math.abs(l)<.2)this.ExtendPolyline(a,i[0],o,e);else{let u=t.derivative(i[1].par0).normalize();u.dot(o)<l?this.ExtendPolyline(u,i[1],o,e):this.ExtendPolyline(a,i[0],o,e)}}ExtendPolyline(e,t,n,i){let o=e.rotate(Math.PI/2);o.dot(n)<0&&(o=o.neg());let a=t.x.add(o.mul(i.HookSize)),l;!(l=f.lineLineIntersection(a,a.add(e),this._polyline.end,this._polyline.end.add(n)))||(this._polyline.addPoint(l),this._polyline.addPoint(a),this._polyline.addPoint(t.x))}FixLastPolylinePointForAnywherePort(e){for(;;){let t=this.GetLastPointInsideOfCurveOnPolyline(e.Curve);t.next.next=null,this._polyline.endPoint=t.next;let n=t.next.point.sub(t.point);n=n.normalize().mul(e.Curve.boundingBox.diagonal);let i=n.rotate(e.AdjustmentAngle*-1),o=n.rotate(e.AdjustmentAngle),a=x.intersectionOne(e.Curve,R.mkPP(t.point,t.point.add(i)),!0),l=x.intersectionOne(e.Curve,R.mkPP(t.point,t.point.add(o)),!0);if(a==null||l==null)return;let u=ze.GetTrimmedCurveForHookingUpAnywhere(e.Curve,t,a,l),c=u.value(u.closestParameter(t.point));if(!this.LineAvoidsTightHierarchyLPP(R.mkPP(t.point,c),this.SourceTightPolyline,null)){let h=x.intersectionOne(e.Curve,R.mkPP(t.point,t.next.point),!1);if(h==null)return;this._polyline.endPoint.point=h.x;break}if(this._polyline.endPoint.point=c,t.prev==null||!this.TryShortcutPolyPoint(t.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(e,t,n,i){let o=f.getTriangleOrientation(i.x,n.x,t.point)===0,a=n.par0,l=i.par0,u,c,h;return o?a<l?e.trim(a,l):(c=e.trim(a,e.parEnd),u=e.trim(e.parStart,l),h=new x,h.addSegs([c,u])):l<a?e.trim(l,a):(c=e.trim(l,e.parEnd),u=e.trim(e.parStart,a),h=new x,h.addSegs([c,u]))}GetLastPointInsideOfCurveOnPolyline(e){for(let t=this._polyline.endPoint.prev;t!=null;t=t.prev)if(t.prev==null||x.PointRelativeToCurveLocation(t.point,e)===2)return t;throw new Error}GetShortestPolylineToMulitpleTargets(e,t){this.CleanTheGraphForShortestPath();let i=new ns(e,t,this.VisibilityGraph).GetPath();if(i==null)return null;let o=new ee;for(let a of i)o.addPoint(a.point);return o.RemoveCollinearVertices()}Targets(e){return Array.from(e).map(t=>this.visibilityGraph.FindVertex(t))}ExtendVisibilityGraphFromFloatingSourcePort(){let e=this.sourcePort;this.StartPointOfEdgeRouting=e.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=oi.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(t=>t!==this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let e=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=ze.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=ze.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),e=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=ze.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=ze.GetFirstHitPolyline(e,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=z.mkPP(new f(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new f(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let e of this.ObstacleCalculator.LooseObstacles)yield new Yt(e)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(e){Ri(this.activePolygons,e)}ClearActivePolygons(){this.activePolygons=[]}};var jS=Ae(Qn());var Fi=class{constructor(){this.size_=0;this.mapOfMaps=new pt}clear(){this.mapOfMaps.clear(),this.size_=0}get size(){return this.size_}set(e,t){let n=e._first,i=e._second,o=this.mapOfMaps.get(n);o==null&&this.mapOfMaps.set(n,o=new pt),o.has(i)||this.size_++,o.set(i,t)}delete(e){let t=e._first,n=e._second,i=this.mapOfMaps.get(t);i!=null&&i.deleteP(n)&&this.size_--}has(e){let t=this.mapOfMaps.get(e._first);return t!=null&&t.has(e._second)}get_(e,t){return this.get(new at(e,t))}get(e){let t=this.mapOfMaps.get(e._first);if(t!=null)return t.get(e._second)}*keys(){for(let e of this.mapOfMaps)for(let t of e[1])yield new at(e[0],t[0])}*[Symbol.iterator](){for(let[e,t]of this.mapOfMaps)for(let[n,i]of t)yield[new at(e,n),i]}*values(){for(let e of this.mapOfMaps)for(let t of e[1])yield t[1]}};var Or=class{static GetShapes(e,t=Array.from(e.shallowEdges)){let n=new Map;eS(e,n);for(let i of t){let o=n.get(i.source);o&&i.sourcePort!=null&&o.Ports.add(i.sourcePort),o=n.get(i.target),o&&i.targetPort!=null&&o.Ports.add(i.targetPort)}return Array.from(n.values())}static CreateShapeWithCenterPort(e){let t=new rs(()=>e.boundaryCurve),n=or.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(n);for(let i of e.inEdges())Or.FixPortAtTarget(n,i);for(let i of e.outEdges())Or.FixPortAtSource(n,i);for(let i of e.selfEdges())Or.FixPortAtSource(n,i),Or.FixPortAtTarget(n,i);return t}static CreateShapeWithClusterBoundaryPort(e){let t=new rs(()=>e.boundaryCurve),n=br.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(n);let i;for(let o of e.inEdges())o.EdgeToAncestor()===2?(i==null&&(i=new Nt(()=>e.boundaryCurve)),o.targetPort=i):Or.FixPortAtTarget(n,o);for(let o of e.outEdges())o.EdgeToAncestor()===1?(i==null&&(i=new Nt(()=>e.boundaryCurve)),o.sourcePort=i):Or.FixPortAtSource(n,o);for(let o of e.selfEdges())Or.FixPortAtSource(n,o),Or.FixPortAtTarget(n,o);return t}static FixPortAtSource(e,t){t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t.targetPort==null&&(t.targetPort=e)}};function eS(s,e){for(let t of s.shallowNodes)if(t instanceof re){let n=Or.CreateShapeWithClusterBoundaryPort(t);e.set(t,n);let i=t;if(!i.isCollapsed){eS(i,e);for(let o of i.shallowNodes)n.AddChild(e.get(o))}}else e.set(t,Or.CreateShapeWithCenterPort(t))}var ap=Ae(Ln()),nS=Ae(Ut());var tS=Ae(Ut());var is=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,n,i){let o=new is(e);return o.Left=e,o.Right=t,o.Gap=n,o.IsEquality=i,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return tS.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t===0&&(t=this.Right.CompareTo(e.Right)),t===0&&(t=Le(this.Gap,e.Gap)),t}};var rS=Ae(Ut()),sa=class{static constructorDCVV(e,t,n,i){let o=new sa(t);return o.Set(e,t,n,i),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,n,i){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=n,this.VariableDoneEval=i,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval===this.ConstraintToEval.Right}toString(){return rS.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var iS=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},xl=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return nS.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new ap.Stack;let t=new is(e);this.dfDvDummyParentNode=new sa(t);let n=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(n);;){let i=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!i.ChildrenHaveBeenPushed){i.ChildrenHaveBeenPushed=!0;for(let a of i.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!==i.VariableDoneEval){let l=this.GetDfDvNode(i,a,a.Right,i.VariableToEval);a.Right.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of i.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!==i.VariableDoneEval){let l=this.GetDfDvNode(i,a,a.Left,i.VariableToEval);a.Left.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(i),i===n)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,n,i){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,n,i):sa.constructorDCVV(e,t,n,i);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable===e.VariableToEval){for(;e.Parent!==this.dfDvDummyParentNode;)this.constraintPath.push(new iS(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let n=new Array;this.GetConnectedVariables(n,e.Right,e.Left);let i=e.Violation,o=n.length;for(let a=0;a<o;a++)n[a].OffsetInBlock=n[a].OffsetInBlock+i;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let n=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,i=this.Variables.length;for(let o=0;o<i;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<n&&(t=a,n=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new xl(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length===1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,n=e.OffsetInBlock/e.Scale,i=t*e.Weight;this.sumAd+=i*e.DesiredPos,this.sumAb+=i*n,this.sumA2+=i*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let n=0;n<t;n++){let i=this.Variables[n];i.ActualPos=(e+i.OffsetInBlock)/i.Scale}}GetConnectedVariables(e,t,n){this.RecurseGetConnectedVariables(e,t,n)}RecurseGetConnectedVariables(e,t,n){this.allConstraints.DfDvStack=new ap.Stack;let i=new is(t);for(this.dfDvDummyParentNode=new sa(i),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,i,t,n)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!==o.VariableDoneEval&&(l.Right.ActiveConstraintCount===1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!==o.VariableDoneEval&&(l.Left.ActiveConstraintCount===1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,n){this.GetConnectedVariables(e.Variables,t,n);let i=e.Variables.length;for(let a=0;a<i;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block===e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length===0){for(let a=0;a<i;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var lp=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var up=Ae(Ln()),cp=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new up.Stack;this.DfDvRecycleStack=new up.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var Ju=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new gd}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new Ju;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},gd=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new gd;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var oS=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},sS=class{constructor(e,t){this.Value=e,this.Column=t}},Xr=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=this.solverParameters,this.matrixQ=new Array(t),this.vectorWiDi=new Array(t),this.vectorQpscVars=new Array(t),this.gradientVector=new Array(t),this.vectorQg=new Array(t),this.vectorPrevY=new Array(t),this.vectorCurY=new Array(t)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!==0&&(this.newMatrixRow.push(new sS(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new oS(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let n of this.matrixQ[t.Ordinal])n.Column===t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(n.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let n=0;n<t.length;n++)t[n].Column===e?t[n].Value=1:t[n].Value=t[n].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[n].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;Xr.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=Xr.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!==0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=Xr.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t===0)return!1;let n=e/t;Xr.VectorCopy(this.vectorPrevY,this.vectorCurY),Xr.VectorScaledVectorSubtract(this.vectorPrevY,n,this.gradientVector,this.vectorCurY);for(let i=0;i<this.vectorCurY.length;i++)this.vectorQpscVars[i].Variable.DesiredPos=this.vectorCurY[i];return!0}PostProject(){for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;Xr.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=Xr.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!==0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let n=Xr.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=n===0?1:e/n,t>1?t=1:t<0&&(t=0)}return Xr.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let n=this.previousFunctionValue-e,i=0;if(n!==0){let o=this.previousFunctionValue!==0?this.previousFunctionValue:e;i=Math.abs(n/o)}(Math.abs(n)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(i)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return Xr.VectorVectorMultiply(this.gradientVector,e)/2+Xr.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let n=0;for(let i=0;i<e.length;i++)n=n+e[i]*t[i];return n}MatrixVectorMultiply(e,t){let n=0;for(let i of this.matrixQ){let o=0;for(let a of i)o=o+a.Value*e[a.Column];t[n++]=o}}static VectorVectorAdd(e,t,n){for(let i=0;i<e.length;i++)n[i]=e[i]+t[i]}static VectorVectorSubtract(e,t,n){for(let i=0;i<e.length;i++)n[i]=e[i]-t[i]}static VectorScaledVectorSubtract(e,t,n,i){for(let o=0;o<e.length;o++)i[o]=e[o]-t*n[o]}static VectorCopy(e,t){for(let n=0;n<t.length;n++)e[n]=t[n]}};var Al=class{constructor(){this.NumberOfUnsatisfiableConstraints=0;this.OuterProjectIterations=0;this.InnerProjectIterationsTotal=0;this.MinInnerProjectIterations=0;this.MaxInnerProjectIterations=0;this.MaxConstraintTreeDepth=0;this.GoalFunctionValue=0;this.TimeLimitExceeded=!1;this.OuterProjectIterationsLimitExceeded=!1;this.InnerProjectIterationsLimitExceeded=!1}get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Al;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var aS=Ae(Ut());var lS=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},hp=class{constructor(e,t,n,i,o){this.ActiveConstraintCount=0;if(i<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=n*i;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=n*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=n,this.Weight=i,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new lS(e,t))}toString(){return aS.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return Le(this.Ordinal,e.Ordinal)}};var pd=class{get IsFull(){return this.numConstraints===pd.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(pd.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let n=this.numConstraints-1;n>=0;n--){let i=this.constraints[n];if(i.Left.Block===e||i.Right.Block===e||i.IsActive||i.IsUnsatisfiable)n<this.numConstraints-1&&(this.constraints[n]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints===0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let n=0;n<this.numConstraints;n++){let i=this.constraints[n],o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale);o>e&&(e=o,t=i)}return t}Insert(e,t){let n=0,i=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<i?(o=i,n=a,i=u):u<o&&(o=u)}this.IsFull?(this.constraints[n]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=i))}},md=pd;md.MaxConstraints=20;var dp=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},fp=class{constructor(){this.allBlocks=new lp;this.allConstraints=new cp;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new md;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new Ju;this.solverSolution=new Al}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,n){return this.AddVariableANNN(e,t,n,1)}AddVariableANNN(e,t,n,i){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new hp(this.nextVariableOrdinal++,e,t,n,i),a=new xl(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new dp(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return Bi(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let n=t.Constraints.length;for(let i=0;i<n;i++){let o=t.Constraints[i];if(e===o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,n){return this.AddConstraintVVNB(e,t,n,!0)}AddConstraintVVNB(e,t,n,i){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e===t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=is.constructorVVNB(e,t,n,i);return this.loadedVariablesAndConstraintLists.set(e,new dp(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,i&&this.equalityConstraints.push(l),l}AddConstraint(e,t,n){return this.AddConstraintVVNB(e,t,n,!1)}SetConstraintUpdate(e,t){t!==e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,n){if(n<=0||Number.isNaN(n)||!Number.isFinite(n))throw new Error("relationshipWeight");if(e===t)throw new Error;e.AddNeighbor(t,n),t.AddNeighbor(e,n),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.floor(Math.log2(this.numberOfVariables))+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.max(0,Math.floor(Math.log2(this.numberOfConstraints)))+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Al,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints===0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length===0)return;let e=this.IsQpsc;for(let[t,n]of this.updatedConstraints){let i=t;if(i.UpdateGap(n),!e&&!i.IsEquality){this.SplitOnConstraintIfActive(i);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),n=t.Constraints,i=0,o=0,a=0;n!=null&&(i=n.length,o=t.NumberOfLeftConstraints,a=i-o);let l=this.emptyConstraintList;o!==0&&(l=new Array(o));let u=this.emptyConstraintList;a!==0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<i;d++){let m=n[d];e===m.Left?l[c++]=m:u[h++]=m}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){if(!this.RunProject())return;if(!this.SplitBlocks())break}}RunProject(){return this.solverSolution.OuterProjectIterations++,this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let n=this.allBlocks.item(t),i=n.Variables.length;for(let o=0;o<i;o++){let a=n.Variables[o];this.solverSolution.GoalFunctionValue+=a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue-=2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new Xr(this.solverParams,this.numberOfVariables);for(let n of this.allBlocks.Vector)for(let i of n.Variables)e.AddVariable(i);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1;for(;!(!e.PreProject()&&!t||(t=this.SplitBlocks(),!this.RunProject())||!e.PostProject()&&!t););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){return this.RunProject()}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let n of t.Variables){n.Reinitialize();let i=new xl(n,this.allConstraints);this.allBlocks.Add(i)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block===e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints===0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,n={maxViolation:0},i=this.GetMaxViolatedConstraint(n,e);if(!i)return!1;for(;i;){if(i.Left.Block===i.Right.Block?(i.Left.Block.Expand(i),i.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=i.Left.Block):this.lastModifiedBlock=this.MergeBlocks(i),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};i=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,n=e.Right.Block,i=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);n.Variables.length>t.Variables.length&&(t=e.Right.Block,n=e.Left.Block,i=-i);let o=n.Variables.length;for(let a=0;a<o;a++){let l=n.Variables[a];l.OffsetInBlock+=i,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(n),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let i=0;i<t;i++){let a=this.allBlocks.item(i).Split(this.IsQpsc);a!=null&&e.push(a)}let n=e.length;for(let i=0;i<n;i++){let o=e[i];this.allBlocks.Add(o)}return e.length!==0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let n=this.SearchViolationCache(e.maxViolation);return n!=null?n:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let n=this.lastModifiedBlock.Variables.length;for(let o=0;o<n;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);zh(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!==this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);zh(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let i=this.violationCache.FindIfGreater(e);return i!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=i),t}SearchAllConstraints(e,t){let n=null;this.violationCache.Clear();for(let i of this.allConstraints.Vector){if(i.IsActive)break;if(i.IsUnsatisfiable)continue;let o=i.Left.ActualPos*i.Left.Scale+(i.Gap-i.Right.ActualPos*i.Right.Scale),a=null,l=0;zh(o,e)&&(e>this.violationCache.LowViolation&&(a=n,l=e),e=o,n=i),t&&(a==null&&i!==n&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=i,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return n}};var Pd=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,n){this.variables.set(e,this.solver.AddVariableANN(e,t,n))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,n,i){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,n,i)}AddLeftRightSeparationConstraintNNN(e,t,n){this.AddLeftRightSeparationConstraintNNNB(e,t,n,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,n){let i=this.GetVariable(e);if(i==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(i,o,n)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let n;do{this.solution=null;let i=null;if(e!=null&&(i=e,i==null))throw new Error("parameters");this.solution=this.solver.SolvePar(i),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,n=this.AdjustConstraintsForMovedFixedVars()}while(n&&this.solution.ExecutionLimitExceeded===!1);return this.solution.ExecutionLimitExceeded===!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,n]of this.fixedVars.entries())Pd.Close(n,this.GetVariableResolvedPosition(t))||e.add(t);return e.size===0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let n of e){t=n;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let n={successInAdjusting:!1},i=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,n);if(!n.successInAdjusting||i.length===0)return!1;for(let o of i)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let n=this.variables.get(e).Block.Variables,i=new On,o=new On,a=1;for(let l of n)!this.fixedVars.has(l.UserData)||(i.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,i.length/o.length)));return a===1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(n,a),n.map(l=>l.UserData)}FixActiveConstraints(e,t){let n=!1;for(let i of e)for(let o of i.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(n=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return n}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new fp,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,Pd.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},bd=Pd;bd.FixedVarWeight=1e9;var gp=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var mp=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new bd;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let n=this.Var(t);n.LowBound=Math.max(e,n.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let n=this.Var(e);n.UpperBound=Math.min(t,n.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!==Number.NEGATIVE_INFINITY&&this.constraints.add(new ye(this.GetBoundId(t.LowBound),e)),t.UpperBound!==Number.POSITIVE_INFINITY&&this.constraints.add(new ye(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!==Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!==Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=rr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=pn.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new ye(e,t))}AddVariableNNNN(e,t,n,i){this.idealPositions.set(e,n),this.AddVariableNNBN(e,t,!1,i)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,n,i){let o=new gp;o.Position=t,o.IsFixed=n,o.Width=i,this.varList.push(o)}};var uS=Ae(Qn());var pp=class extends ln{constructor(e,t){super(e,t);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=H.DirectionFromPointToPoint(e.point,t.point)}AddRightNeighbor(e){this.RightNeighbors.add(e)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(e){this.setOfLongestSegs.add(e)}BoundFromRight(e){e=Math.max(e,this.LeftBound),this.RightBound=Math.min(e,this.RightBound)}BoundFromLeft(e){e=Math.min(e,this.RightBound),this.LeftBound=Math.max(e,this.LeftBound)}};var un=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,n){for(t--;e<t;t--)this.SetNewNext(n[t])}InsertVertsInReverse(e,t,n){for(e++;e<t;e++)this.SetNewNext(n[e])}SetNewNext(e){let t=new un(e),n=this.Next;this.Next=t,t.Next=n}};var vl=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return ie(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return vl.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?H.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var Rr=class{constructor(e){this.pathVisibilityGraph=new Xe;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(i(),e.Width),n=t.next();for(n.done||e.SetFirstEdge(n.value);(n=t.next()).done===!1;)e.AddEdge(n.value);function*i(){if(e.PathPoints instanceof un)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let n=e.next(),i=n.value;for(;!(n=e.next()).done;)yield this.CreatePathEdge(i,n.value,t),i=n.value}CreatePathEdge(e,t,n){switch(H.DirectionFromPointToPoint(e,t)){case 2:case 1:return new vl(this.GetAxisEdge(e,t),n);case 4:case 8:{let o=new vl(this.GetAxisEdge(t,e),n);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(n,i)=>new pp(n,i))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of Rr.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(Rr.CompareTwoPathEdges);let n=0;for(let i of t)i.Index=n++}static CompareTwoPathEdges(e,t){if(e===t)return 0;let n=Rr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return n!==0?n:-Rr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,H.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,n,i){for(;;){if(e=Rr.GetNextPathEdgeInDirection(e,n,i),e==null||(t=Rr.GetNextPathEdgeInDirection(t,n,i),t==null))return 0;if(e.AxisEdge===t.AxisEdge){i=Rr.FindContinuedDirection(n,i,e.AxisEdge),n=e.AxisEdge;let c=Rr.GetExistingOrder(e,t);if(c===Rr.NotOrdered)continue;return i===n.Direction?c:-c}let o=i===n.Direction?n.Target:n.Source,a=Rr.OtherVertex(e.AxisEdge,o),l=Rr.OtherVertex(t.AxisEdge,o),u=Rr.ProjectionForCompare(n,i!==n.Direction);return Le(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,n){return e.Direction===t?n.Source===e.Target?n.Direction:H.OppositeDir(n.Direction):n.Source===e.Source?n.Direction:H.OppositeDir(n.Direction)}static OtherVertex(e,t){return e.Source===t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction===1?t?n=>-n.x:n=>n.x:t?n=>n.y:n=>-n.y}static GetNextPathEdgeInDirection(e,t,n){return t.Direction===n?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let n=e.Index;if(n===-1)return Rr.NotOrdered;let i=t.Index;return Le(n,i)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,n){for(let i of n.Vertices()){let o=i.InEdgesLength();t.set(i,o),o===0&&e.enqueue(i)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new uS.Queue,n=new Map;for(Rr.InitQueueOfSources(t,n,e);t.length>0;){let i=t.dequeue();for(let o of i.OutEdges){let a=n.get(o.Target);n.set(o.Target,a-1),a===1&&t.enqueue(o.Target),yield o}}}},yd=Rr;yd.NotOrdered=Number.MAX_VALUE;var bp=class extends Xt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var Sd=class extends Xt{constructor(e,t){super();this.site=t,this.AxisEdge=e}get Site(){return this.site}};var Pp=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size===0}};var os=class extends qu{constructor(e,t,n,i,o){super(t,new H(e).ToPoint());this.DirectionPerp=new H(e).Right.ToPoint(),this.PathOrders=i,this.xProjection=e===1?a=>a.x:a=>-a.y,this.edgeContainersTree=new dt((a,l)=>this.CompareAA(a,l)),this.SweepPole=H.VectorDirection(this.SweepDirection),this.AxisEdges=o,this.AxisEdgesToObstaclesTheyOriginatedFrom=n}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(e){e instanceof yn?this.ProcessVertexEvent(e):(this.Z=this.GetZP(e.Site),e instanceof Sd?this.ProcessLowEdgeEvent(e):this.ProcessHighEdgeEvent(e))}ProcessHighEdgeEvent(e){let t=e.AxisEdge;this.RemoveEdge(t),this.ConstraintEdgeWithObstaclesAtZ(t,t.Target.point)}ProcessLowEdgeEvent(e){let t=e.AxisEdge,n=this.GetOrCreateAxisEdgesContainer(t);n.item.AddEdge(t);let i=this.edgeContainersTree.previous(n);if(i!=null)for(let a of i.item.edges)for(let l of n.item.edges)this.TryToAddRightNeighbor(a,l);let o=this.edgeContainersTree.next(n);if(o!=null)for(let a of n.item.Edges)for(let l of o.item.edges)this.TryToAddRightNeighbor(a,l);this.ConstraintEdgeWithObstaclesAtZ(t,t.Source.point)}TryToAddRightNeighbor(e,t){this.ProjectionsOfEdgesOverlap(e,t)&&e.AddRightNeighbor(t)}ProjectionsOfEdgesOverlap(e,t){return this.SweepPole===1?!(e.TargetPoint.y<t.SourcePoint.y-C.distanceEpsilon||t.TargetPoint.y<e.SourcePoint.y-C.distanceEpsilon):!(e.TargetPoint.x<t.SourcePoint.x-C.distanceEpsilon||t.TargetPoint.x<e.SourcePoint.x-C.distanceEpsilon)}GetObstacleBoundaries(e){return this.Obstacles.map(t=>fe.mkDebugCurveWCI(1,e,t))}ConstraintEdgeWithObstaclesAtZ(e,t){this.ConstraintEdgeWithObstaclesAtZFromLeft(e,t),this.ConstraintEdgeWithObstaclesAtZFromRight(e,t)}ConstraintEdgeWithObstaclesAtZFromRight(e,t){let n=this.GetActiveSideFromRight(t);if(n==null||this.NotRestricting(e,n.item.Polyline))return;let i=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);e.BoundFromRight(i.dot(this.DirectionPerp))}GetActiveSideFromRight(e){return this.LeftObstacleSideTree.findFirst(t=>os.PointToTheLeftOfLineOrOnLineLocal(e,t.Start,t.End))}ConstraintEdgeWithObstaclesAtZFromLeft(e,t){let n=this.GetActiveSideFromLeft(t);if(n==null||this.NotRestricting(e,n.item.Polyline))return;let i=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);e.BoundFromLeft(i.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(e,t,n){return f.signedDoubledTriangleArea(e,t,n)>-os.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(e,t,n){return f.signedDoubledTriangleArea(t,n,e)<os.AreaComparisonEpsilon}GetActiveSideFromLeft(e){return this.RightObstacleSideTree.findLast(t=>os.PointToTheRightOfLineOrOnLineLocal(e,t.Start,t.End))}static EdgeMidPoint(e){return f.middle(e.SourcePoint,e.TargetPoint)}GetOrCreateAxisEdgesContainer(e){let t=e.Source.point,n=this.GetAxisEdgesContainerNode(t);return n!=null?n:this.edgeContainersTree.insert(new Pp(t))}GetAxisEdgesContainerNode(e){let t=this.xProjection(e),n=this.edgeContainersTree.findFirst(i=>this.xProjection(i.Source)>=t-C.distanceEpsilon/2);return n!=null&&this.xProjection(n.item.Source)<=t+C.distanceEpsilon/2?n:null}ProcessVertexEvent(e){this.Z=this.GetZS(e),e instanceof Gi?this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline):e instanceof Mi?this.ProcessRightVertex(e,e.Vertex.prevOnPolyline):(this.ProcessLeftVertex(e,e.Vertex.nextOnPolyline),this.ProcessRightVertex(e,e.Vertex.prevOnPolyline))}ProcessRightVertex(e,t){let n=e.Site;this.ProcessPrevSegmentForRightVertex(e,n);let i=t.point.sub(e.Site),o=i.dot(this.DirectionPerp),a=i.dot(this.SweepDirection);a<=C.distanceEpsilon?o>0&&a>=0?this.EnqueueEvent(new Mi(t)):this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex):(this.InsertRightSide(new Po(e.Vertex)),this.EnqueueEvent(new Mi(t)),this.RestrictEdgeContainerToTheRightOfEvent(e.Vertex))}RestrictEdgeContainerToTheRightOfEvent(e){let t=e.point,n=this.xProjection(t),i=this.edgeContainersTree.findFirst(o=>n<=this.xProjection(o.Source));if(i!=null)for(let o of i.item.Edges)this.NotRestricting(o,e.polyline)||o.BoundFromLeft(this.DirectionPerp.dot(t))}NotRestricting(e,t){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(e)===t}ProcessPrevSegmentForRightVertex(e,t){let n=e.Vertex.nextOnPolyline.point;t.sub(n).dot(this.SweepDirection)>C.distanceEpsilon&&this.RemoveRightSide(new Po(e.Vertex.nextOnPolyline))}RemoveEdge(e){let t=this.GetAxisEdgesContainerNode(e.Source.point);t.item.RemoveAxis(e),t.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(t)}ProcessLeftVertex(e,t){let n=e.Site;this.ProcessPrevSegmentForLeftVertex(e,n);let i=t.point.sub(e.Site),o=i.dot(this.DirectionPerp),a=i.dot(this.SweepDirection);a<=C.distanceEpsilon?o<0&&a>=0&&this.EnqueueEvent(new Gi(t)):(this.InsertLeftSide(new bo(e.Vertex)),this.EnqueueEvent(new Gi(t))),this.RestrictEdgeFromTheLeftOfEvent(e.Vertex)}RestrictEdgeFromTheLeftOfEvent(e){let t=e.point,n=this.GetContainerNodeToTheLeftOfEvent(t);if(n!=null)for(let i of n.item.Edges)this.NotRestricting(i,e.polyline)||i.BoundFromRight(t.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(e){let t=this.xProjection(e);return this.edgeContainersTree.findLast(n=>this.xProjection(n.Source)<=t)}ProcessPrevSegmentForLeftVertex(e,t){let n=e.Vertex.prevOnPolyline.point;t.sub(n).dot(this.SweepDirection)>C.distanceEpsilon&&this.RemoveLeftSide(new bo(e.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let e of this.AxisEdges)this.EnqueueEventsForEdge(e)}EnqueueEventsForEdge(e){this.EdgeIsParallelToSweepDir(e)&&(this.EnqueueEvent(os.EdgeLowPointEvent(e,e.Source.point)),this.EnqueueEvent(os.EdgeHighPointEvent(e,e.Target.point)))}EdgeIsParallelToSweepDir(e){return e.Direction===this.SweepPole||e.Direction===H.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(e,t){return new bp(e,t)}static EdgeLowPointEvent(e,t){return new Sd(e,t)}CompareAA(e,t){return Le(e.Source.dot(this.DirectionPerp),t.Source.dot(this.DirectionPerp))}},Ed=os;Ed.AreaComparisonEpsilon=C.intersectionEpsilon;var yp=class extends ra{constructor(e){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=e}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(e){if(this.Edges.length===0){let t=H.VectorDirectionPP(e.Source,e.Target);switch(t){case 4:t=1;break;case 8:t=2;break}this.CompassDirection=t,this.start=e.Source,this.end=e.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(e.Source),this.TryPointForStartAndEndNorth(e.Target);break;case 2:this.TryPointForStartAndEndEast(e.Source),this.TryPointForStartAndEndEast(e.Target);break}this.Edges.push(e)}TryPointForStartAndEndNorth(e){e.y<this.start.y?this.start=e:e.y>this.end.y&&(this.end=e)}TryPointForStartAndEndEast(e){e.x<this.start.x?this.start=e:e.x>this.end.x&&(this.end=e)}get IsFixed(){return this._isFixed}set IsFixed(e){this._isFixed=e}get Width(){let e=0;for(let t of this.edges)e=Math.max(e,t.Width);return e}GetLeftBound(){if(!this.IsFixed){let e=Number.NEGATIVE_INFINITY;for(let t of this.edges)e=Math.max(e,t.AxisEdge.LeftBound);return e}return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let e=Number.POSITIVE_INFINITY;for(let t of this.edges)e=Math.min(e,t.AxisEdge.RightBound);return e}return this.Position()}Position(){return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var Nn=class{constructor(e,t){this.tree=new dt((e,t)=>Le(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length===0||this.HorizontalPoints.length===0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){ie(e.Next.Point.x,e.Point.x)?t===Nn.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,n,i,o=e.Y;if(e.Point.x<e.Next.Point.x?(n=e.Point.x,t=e.Next.Point.x,i=!0):(t=e.Point.x,n=e.Next.Point.x,i=!1),i)for(let a=this.tree.findFirst(l=>n<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new f(a.item.Point.x,o);e=Nn.TrySplitHorizontalPoint(e,l,!0),Nn.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=n;a=this.tree.previous(a)){let l=new f(a.item.Point.x,o);e=Nn.TrySplitHorizontalPoint(e,l,!1),Nn.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){Nn.Low(e)+C.distanceEpsilon<t.y&&t.y+C.distanceEpsilon<Nn.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,n){return n&&e.X+C.distanceEpsilon<t.x&&t.x+C.distanceEpsilon<e.Next.X||!n&&e.Next.X+C.distanceEpsilon<t.x&&t.x+C.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new Pr(Le);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,Nn.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var ss=class{constructor(e){this.verticesToPathOffsets=new pt;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,n=null;for(let i=e.PathPoints;i!=null;i=i.Next){let o=this.verticesToPathOffsets.get(i.Point);if(n!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,i),t.delete(a))}for(let[a,l]of n)o.has(a)||t.set(a,l)}n=o}}CollapseLoopingPath(e,t,n,i,o){let a=ss.FindLinkedPointInPath(i,t.Point),l=Array.from(ss.GetPointsInBetween(a,o));ss.Before(t,n)?(this.CleanDisappearedPiece(t,n,e),this.ReplacePiece(t,n,l,e)):(this.CleanDisappearedPiece(n,t,e),this.ReplacePiece(n,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let n=e.Next;n!==t;n=n.Next)yield n.Point}ReplacePiece(e,t,n,i){let o=e;for(let a of n){let l=new un(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(i,o)}o.Next=t}CleanDisappearedPiece(e,t,n){for(let i of ss.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(i).delete(n)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e===t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let n=e.PathPoints;;n=n.Next)if(n.Point.equal(t))return n}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let n=this.verticesToPathOffsets.get(t.Point);n||this.verticesToPathOffsets.set(t.Point,n=new Map);let i=n.get(e);i?(this.CleanDisappearedPiece(i,t,e),i.Next=t.Next):n.set(e,t)}}};var Sp=class{constructor(e){this.projection=e}compare(e,t){return Le(this.projection(e),this.projection(t))}};var lr=class{static RefinePaths(e,t){lr.AdjustPaths(e);let n=lr.CreatePathsToFirstLinkedVerticesMap(e);lr.Refine(Array.from(n.values())),lr.CrossVerticalAndHorizontalSegs(n.values()),lr.ReconstructPathsFromLinkedVertices(n),t&&new ss(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=lr.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length===0)return;let t=[],n=C.RoundPoint(e[0]);t.push(n);for(let i=1;i<e.length;i++){let o=C.RoundPoint(e[i]);n.equal(o)||(n=o,t.push(n))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,n=new Array;for(let i of e)for(let o=i;o.Next!=null;o=o.Next)ie(o.Point.x,o.Next.Point.x)?n.push(o):t.push(o);new Nn(t,n).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,n]of e)t.PathPoints=n}static Refine(e){lr.RefineInDirection(1,e),lr.RefineInDirection(2,e)}static*groupByProj(e,t){let n=new Map;for(let i of t){let o=e(i.Point),a=n.get(o);a||(a=new Array,n.set(o,a)),a.push(i)}for(let i of n.values())yield i}static RefineInDirection(e,t){let n={projectionToPerp:void 0,projectionToDirection:void 0};lr.GetProjectionsDelegates(e,n);let i=Array.from(lr.GetAllLinkedVertsInDirection(n.projectionToPerp,t)),o=lr.groupByProj(n.projectionToPerp,i);for(let a of o)lr.RefineCollinearBucket(a,n.projectionToDirection)}static GetProjectionsDelegates(e,t){e===2?(t.projectionToDirection=n=>n.x,t.projectionToPerp=n=>n.y):(t.projectionToPerp=n=>n.x,t.projectionToDirection=n=>n.y)}static*GetAllLinkedVertsInDirection(e,t){for(let n of t)for(let i=n;i.Next!=null;i=i.Next)ie(e(i.Point),e(i.Next.Point))&&(yield i)}static RefineCollinearBucket(e,t){let n=new wi(new Sp(t));for(let a of e)n.has(a.Point)||n.set(a.Point,0),n.has(a.Next.Point)||n.set(a.Next.Point,0);let i=new Array(n.size),o=0;for(let a of n.keys())i[o++]=a;for(o=0;o<i.length;o++)n.set(i[o],o);for(let a of e){o=n.get(a.Point);let l=n.get(a.Next.Point);Math.abs(l-o)>1&&lr.InsertPoints(a,i,o,l)}}static InsertPoints(e,t,n,i){n<i?e.InsertVerts(n,i,t):e.InsertVertsInReverse(i,n,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let n of e)t.set(n,lr.CreateLinkedVertexOfEdgePath(n));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,n=new un(t[0]),i=n;for(let o=1;o<t.length;o++)n.Next=new un(t[o]),n=n.Next;return i}};var Eo=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I===t.I&&e.Points===t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var Co=class{constructor(e,t){this.segTree=new Ti(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new Ti(t),this.Paths=e}static RemoveStaircases(e,t){new Co(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(n=>!this.crossedOutPaths.has(n)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new Eo(e.pts,0),new Eo(e.pts,1),new Eo(e.pts,2),new Eo(e.pts,3)],n=0;for(let i=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,i,t,o))return e.canHaveStaircase=!0,i;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,i++,e.pts.length<i+5)return-1;t[n]=new Eo(e.pts,i+3),n++,n%=4}}static GetFlippedPoint(e,t){return ie(e[t].y,e[t+1].y)?new f(e[t+4].x,e[t].y):new f(e[t].x,e[t+4].y)}Crossing(e,t,n){return Co.IsCrossing(R.mkPP(e,t),this.segTree,n)}static IsCrossing(e,t,n){for(let i of t.GetAllIntersecting(e.boundingBox))if(n.findIndex(o=>o===i)===-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,n){return this.IntersectObstacleHierarchyL(R.mkPP(e,t))||this.IntersectObstacleHierarchyL(R.mkPP(t,n))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>x.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,n,i){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return i.canHaveStaircaseAtI=!1,H.DirectionFromPointToPoint(o,a)!==H.DirectionFromPointToPoint(l,u)||H.DirectionFromPointToPoint(a,l)!==H.DirectionFromPointToPoint(u,c)||(l=Co.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(i.canHaveStaircaseAtI=!0,!this.Crossing(a,l,n))}RemoveStaircasePN(e,t){let n=e[t],i=e[t+1],o=Math.abs(n.y-i.y)<C.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,n){this.RemoveSegs(e);let i=new Array(e.length-2);BI(e,i,t+1);let o=e[t+1],a=e[t+3];return i[t+1]=n?new f(a.x,o.y):new f(o.x,a.y),RI(e,t+4,i,t+2,i.length-t-2),this.InsertNewSegs(i,t),i}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new Eo(e,t))}RemoveSeg(e){this.segTree.Remove(Co.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let n=new Eo(e,t);this.segTree.Add(Co.Rect(n),n)}static Rect(e){return z.mkPP(e.Start,e.End)}};function RI(s,e,t,n,i){for(;i-- >0;)t[n++]=s[e++]}function BI(s,e,t){let n=0;for(;t-- >0;)e[n++]=s[n++]}var it=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,n,i){this.AncestorsSets=i,this.HierarchyOfGroups=Ke(Array.from(i.keys()).filter(o=>o.IsGroup).map(o=>st(o,o.BoundingBox))),this.Obstacles=n,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=Ke(n.map(o=>st(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length===0)return;let t=e.PathPoints,n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],it.ObstacleTest),i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],it.ObstacleTest);n!=null&&i!=null&&this.PathToObstacles.set(e,[n.UserData,i.UserData])}static ObstacleTest(e,t){return x.PointRelativeToCurveLocation(e,t)!==0?1:0}Calculate(e,t){this.NudgingDirection=e,lr.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let n=this.FindLastUnmappedEdge(e);for(let i=t;i!=null&&i!==n;i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(i.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let n=e.LastEdge;n!=null&&H.DirectionsAreParallel(n.Direction,this.NudgingDirection);n=n.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(n.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let n=e.FirstEdge;n!=null&&H.DirectionsAreParallel(n.Direction,this.NudgingDirection);n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(n.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new yd(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let n=new Array;for(let i of e){let o=new ee;for(let a of i.PathPoints)o.addPoint(a);n.push(o)}return n.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdges()}SetWidthsOfArrowheads(){for(let e of this.Paths)it.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let n=e.LastEdge;n.Width=Math.max(t.targetArrowhead.width,n.Width)}if(t.sourceArrowhead!=null){let n=e.FirstEdge;n.Width=Math.max(t.sourceArrowhead.width,n.Width)}}PositionShiftedEdges(){this.Solver=new mp(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];it.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),n=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>n&&(e.IdealPosition=n)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return it.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x===t.x||e.y===t.y)return t;let n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return n<i?new f(e.x,t.y):new f(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],n=e.FirstEdge;t.push(this.ShiftedPoint(n.Source,n.LongestNudgedSegment));for(let i of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(i));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let n=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection===1?new f(n,e.y):new f(e.x,-n)}static LineSegOfLongestSeg(e,t){let n=t===2?o=>o.x:o=>o.y,i={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)it.UpdateMinMaxWithPoint(i,n,o.Source),it.UpdateMinMaxWithPoint(i,n,o.Target);return t===2?new R(i.min,-e.IdealPosition,i.max,-e.IdealPosition):new R(e.IdealPosition,i.min,e.IdealPosition,i.max)}static UpdateMinMaxWithPoint(e,t,n){let i=t(n);e.min>i&&(e.min=i),e.max<i&&(e.max=i)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let n of e.Edges){let i=n.AxisEdge;if(i!=null)for(let o of i.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let n of t)this.ConstraintTwoLongestSegs(e,n)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)it.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return ie(e.SourcePoint.x,e.TargetPoint.x);default:return ie(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let n of e.filter(i=>i.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,n.LongestNudgedSegment),t=n}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,it.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),n=e.GetRightBound();t>=n?(this.Solver.AddFixedVariable(e.Id,it.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,it.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!==Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),n!==Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,n))}}static SegmentPosition(e,t){return t===1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new Ed(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let n=t.BoundingBox;for(let i of e.PathEdges()){let o=i.AxisEdge;o.Direction===this.NudgingDirection&&this.BoundAxisEdgeByRect(n,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=it.MapPortsToShapes(this.AncestorsSets.keys()));let t=NI(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(n=>!n.Children.some(i=>t.has(i)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(z.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection===2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),it.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let n=null,i=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(n=a.LongestNudgedSegment,i!=null){let l;it.SetIdealPositionForSeg(i,l=t(i.start),o,t(n.Start)),o=l,i=null}}else n!=null&&(i=n,n=null);i!=null?it.SetIdealPositionForSeg(i,t(i.Start),o,t(e.End)):n!=null&&(n.IdealPosition=t(n.Start))}static SetIdealPositionForSeg(e,t,n,i){let o=Math.max(n,i),a=Math.min(n,i);a+C.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,n=H.OppositeDir(this.NudgingDirection);for(let i of e.PathEdges()){let o=i.Direction;o===this.NudgingDirection||o===n?(t==null?(i.LongestNudgedSegment=t=new yp(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):i.LongestNudgedSegment=t,i.IsFixed&&(t.IsFixed=!0)):(i.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(n=>n.clone())};return it.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){it.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),it.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let n=e.points.length-1,i=H.VectorDirectionPP(e.points[n-1],e.points[n]);if(it.ProjectionsAreClose(e.points[n-1],i,t)){e.points=e.points.slice(0,n);return}let o=e.points[n];i===2||i===8?e.points[n]=new f(t.x,o.y):e.points[n]=new f(o.x,t.y)}static ProjectionsAreClose(e,t,n){return t===2||t===8?ie(e.x,n.x):ie(e.y,n.y)}static ExtendPolylineToSourcePort(e,t){let n=H.VectorDirectionPP(e.points[0],e.points[1]);if(it.ProjectionsAreClose(e.points[1],n,t)){e.points=e.points.slice(1);return}let i=e.points[0];n===2||n===8?e.points[0]=new f(t.x,i.y):e.points[0]=new f(i.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],n=e[0];t.push(n);let i=e[1],o=H.VectorDirectionPP(n,i),a=1;for(;++a<e.length;){let l=H.VectorDirectionPP(i,e[a]);l===o||H.OppositeDir(l)===o||l===0||(f.closeDistEps(n,i)||t.push(n=it.Rectilinearise(n,i)),o=l),i=e[a]}return f.closeDistEps(n,i)||t.push(it.Rectilinearise(n,i)),t}static NudgePaths(e,t,n,i,o){if(e.length===0)return;let a=new it(e,t,n,i);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=ee.mkFromPoints(it.BuildPolylineForPath(l))}RemoveStaircases(){Co.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let n of e)for(let i of n.Ports)t.set(i,n);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,n,i){let o=i.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield fe.mkDebugCurveTWCI(200,e+l*u,n,R.mkPP(o[u],o[u+1]))}};function NI(s,e){let t=new Set;if(s.size<e.size)for(let n of s)e.has(n)&&t.add(n);else for(let n of e)s.has(n)&&t.add(n);return t}var cS=Ae(Ut());var Ep=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var xo=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new Ep(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:F.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,n=0,i=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;n<t||o<i;){if(n>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=i){a.push(this.ListOfPointsAndCrossings[n++]);continue}let l=this.ListOfPointsAndCrossings[n],u=e.ListOfPointsAndCrossings[o],c=F.ComparePP(l.Location,u.Location);c===0?(a.push(l),++n,++o):c===-1?(a.push(l),++n):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length===0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(n=>F.ComparePP(n.Location,e)>=0&&F.ComparePP(n.Location,t)<=0))}static ToCrossingArray(e,t){let n=0,i=e.length;for(let l=0;l<i;l++)e[l].DirectionToInside===t&&n++;if(n===0)return null;let o=new Array(n),a=0;for(let l=0;l<i;l++)e[l].DirectionToInside===t&&(o[a++]=e[l]);return o}ToString(){return cS.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var Q=class{static EdgeDirectionVE(e){return Q.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return F.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let n=Q.EdgeDirectionVE(e);return t===n?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let n of e.InEdges)if(F.GetDirections(e.point,n.SourcePoint)===t)return n.Source;for(let n of e.OutEdges)if(F.GetDirections(e.point,n.TargetPoint)===t)return n.Target;return null}static FindAdjacentEdge(e,t){for(let n of e.InEdges)if(F.GetDirections(n.SourcePoint,e.point)===t)return n;for(let n of e.OutEdges)if(F.GetDirections(e.point,n.TargetPoint)===t)return n;return null}static FindBendPointBetween(e,t,n){return Q.IsVerticalD(n)?new f(t.x,e.y):new f(e.x,t.y)}static SegmentIntersectionPPP(e,t,n){let i=F.GetDirections(e,t);return Q.IsVerticalD(i)?new f(e.x,n.y):new f(n.x,e.y)}static SegmentIntersectionSP(e,t){return Q.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return Q.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return Q.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return Q.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,n,i){return Q.IntervalsAreCollinear(e,t,n,i)&&F.ComparePP(e,i)!==F.ComparePP(t,n)}static IntervalsAreCollinear(e,t,n,i){let o=Q.IsVerticalPP(e,t);return Q.IsVerticalPP(n,i)===o?o?F.Equal(e.x,n.x):F.Equal(e.y,n.y):!1}static IntervalsAreSame(e,t,n,i){return F.EqualPP(e,n)&&F.EqualPP(t,i)}static IntervalsIntersect(e,t,n,i){let o=Q.SegmentIntersectionPPP(e,t,n);return Q.PointIsOnSegmentPPP(e,t,o)&&Q.PointIsOnSegmentPPP(n,i,o)?o:void 0}static SegmentIntersectionEP(e,t){return Q.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,n){return F.EqualPP(e,n)||F.EqualPP(t,n)||F.GetDirections(e,n)===F.GetDirections(n,t)}static PointIsOnSegmentSP(e,t){return Q.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!==0}static IsVerticalE(e){return Q.IsVerticalD(F.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return Q.IsVerticalD(F.GetDirections(e,t))}static IsVertical(e){return Q.IsVerticalD(F.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!==0}static Slope(e,t,n){let i=t.sub(e);return i.dot(n.PerpDirectionAsPoint)/i.dot(n.DirectionAsPoint)}static SortAscending(e,t){let n=F.GetDirections(e,t);return 0===n||Q.IsAscending(n)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,n){switch(n){case 1:case 4:return new f(t.x,Q.GetRectangleBound(e,n));case 2:case 8:return new f(Q.GetRectangleBound(e,n),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return F.Compare(e.bottom,t.top)<0&&F.Compare(t.bottom,e.top)<0&&F.Compare(e.left,t.right)<0&&F.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return F.Compare(e.y,t.top)<0&&F.Compare(t.bottom,e.y)<0&&F.Compare(e.x,t.right)<0&&F.Compare(t.left,e.x)<0}};var as=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=H.toPoint(this.Dir),this.PerpDirection=1===e?2:1,this.PerpDirectionAsPoint=H.toPoint(this.PerpDirection),this.OppositeDirection=H.OppositeDir(e)}get IsHorizontal(){return 2===this.Dir}get IsVertical(){return 1===this.Dir}Compare(e,t){let n=this.ComparePerpCoord(e,t);return n!==0?n:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return F.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return F.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return F.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return F.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?as.VerticalInstance:as.HorizontalInstance}static GetInstance(e){return Q.IsVerticalD(e)?as.VerticalInstance:as.HorizontalInstance}ToString(){return this.Dir.toString()}},Et=as;Et.HorizontalInstance=new as(2),Et.VerticalInstance=new as(1);var Ao=class extends ra{static mk(e,t){return new Ao(e,t,Ao.NormalWeight,null)}constructor(e,t,n,i){super();this.Update(e,t),this.Weight=n,this.GroupBoundaryPointAndCrossingsList=i}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Ao.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?Et.VerticalInstance:Et.HorizontalInstance}get IsOverlapped(){return Ao.OverlappedWeight===this.Weight}get IsReflection(){return Ao.ReflectionWeight===this.Weight}static IsVerticalSegment(e,t){return e.x===t.x}MergeGroupBoundaryCrossingList(e){e!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new xo),this.GroupBoundaryPointAndCrossingsList.MergeFrom(e))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(e,t){this.startPoint=e,this.endPoint=t}SetInitialVisibilityVertex(e){this.LowestVisibilityVertex=e,this.HighestVisibilityVertex=e}AppendVisibilityVertex(e,t){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.SetInitialVisibilityVertex(t);else{if(F.IsPureLower(t.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(e,t)||this.AppendHighestVisibilityVertex(t)}}AddVisibilityEdge(e,t){let n=new ln(e,t,this.Weight);return Xe.AddEdge(n),n}AppendHighestVisibilityVertex(e){F.EqualPP(this.HighestVisibilityVertex.point,e.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,e),this.HighestVisibilityVertex=e)}LoadStartOverlapVertexIfNeeded(e){if(this.NeedStartOverlapVertex){let t=e.FindVertex(this.Start);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(e){if(this.NeedEndOverlapVertex){let t=e.FindVertex(this.End);this.AppendVisibilityVertex(e,t!=null?t:e.AddVertexP(this.End))}}OnSegmentIntersectorBegin(e){this.AppendGroupCrossingsThroughPoint(e,this.Start)||this.LoadStartOverlapVertexIfNeeded(e)}OnSegmentIntersectorEnd(e){this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||F.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(e)}static Subsume(e,t,n,i,o,a,l,u){return u.extendStart=!0,u.extendEnd=!0,e.seg==null||!Q.IntervalsOverlapPPPP(e.seg.Start,e.seg.End,t,n)?!1:e.seg.Weight!==i?e.seg.Start===t&&e.seg.End===n?(e.seg.Weight=Math.min(e.seg.Weight,i),!0):!1:(u.extendStart=a.CompareScanCoord(t,e.seg.Start)===-1,u.extendEnd=a.CompareScanCoord(n,e.seg.End)===1,(u.extendStart||u.extendEnd)&&(l.Remove(e.seg),e.seg.startPoint=a.Min(e.seg.Start,t),e.seg.endPoint=a.Max(e.seg.End,n),e.seg=l.InsertUnique(e.seg).item,e.seg.MergeGroupBoundaryCrossingList(o)),!0)}IntersectsSegment(e){return Q.SegmentsIntersection(this,e)!==void 0}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(e){return F.EqualPP(this.Start,e)||F.EqualPP(this.End,e)||F.GetDirections(this.Start,e)===F.GetDirections(e,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(e){return this.IsVertical?new f(this.Start.x,e):new f(e,this.Start.y)}AddSparseVertexCoord(e){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(e)}AddSparseEndpoint(e){return this.sparsePerpendicularCoords.has(e)?!1:(this.sparsePerpendicularCoords.add(e),!0)}CreateSparseVerticesAndEdges(e){var t;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(e,this.Start);for(let n of Array.from(this.sparsePerpendicularCoords.values()).sort(Le)){let i=this.CreatePointFromPerpCoord(n);this.AppendVisibilityVertex(e,(t=e.FindVertex(i))!=null?t:e.AddVertexP(i))}this.AppendGroupCrossingsThroughPoint(e,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(e,t){return this.AppendGroupCrossingsThroughPoint(e,t.point)?(F.IsPureLower(this.HighestVisibilityVertex.point,t.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t),!0):!1}AppendGroupCrossingsThroughPoint(e,t){var i;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let n=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(t);){let o=this.GroupBoundaryPointAndCrossingsList.Pop(),a=null,l=null;F.ComparePP(o.Location,this.Start)>0&&(a=xo.ToCrossingArray(o.Crossings,this.ScanDirection.OppositeDirection)),F.ComparePP(o.Location,this.End)<0&&(l=xo.ToCrossingArray(o.Crossings,this.ScanDirection.Dir)),n=!0;let u=(i=e.FindVertex(o.Location))!=null?i:e.AddVertexP(o.Location);e.AddVertexP(o.Location),a!=null||l!=null?(this.AddLowCrossings(e,u,a),this.AddHighCrossings(e,u,l)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(u):this.AppendHighestVisibilityVertex(u)}return n}static GetCrossingInteriorVertex(e,t,n){var o;let i=n.GetInteriorVertexPoint(t.point);return(o=e.FindVertex(i))!=null?o:e.AddVertexP(i)}AddCrossingEdge(e,t,n,i){let o=null;this.HighestVisibilityVertex!=null&&(F.EqualPP(this.HighestVisibilityVertex.point,n.point)?o=e.FindEdgePP(t.point,n.point):this.AppendHighestVisibilityVertex(t)),o==null&&(o=this.AddVisibilityEdge(t,n));let a=i.map(u=>u.Group.InputShape),l=o.IsPassable;l==null?o.IsPassable=()=>{for(let u of a)if(u.IsTransparent)return!0;return!1}:o.IsPassable=()=>{for(let u of a)if(u.IsTransparent||l())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(t),this.HighestVisibilityVertex=n}AddLowCrossings(e,t,n){if(n!=null){let i=Ao.GetCrossingInteriorVertex(e,t,n[0]);this.AddCrossingEdge(e,i,t,n)}}AddHighCrossings(e,t,n){if(n!=null){let i=Ao.GetCrossingInteriorVertex(e,t,n[0]);this.AddCrossingEdge(e,t,i,n)}}},xe=Ao;xe.NormalWeight=ln.DefaultWeight,xe.ReflectionWeight=5,xe.OverlappedWeight=500;var Cd=class{constructor(e,t,n,i,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?H.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,n,i,o)}ResetEntry(e,t,n,i){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=n,this.Cost=i}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var xd=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},Ct=class{constructor(){this.nextNeighbors=[new xd,new xd,new xd];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,n){if(t===n||!this.InitEntryDirectionsAtTarget(n))return!1;this.Target=n,this.Source=t;let i=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return i>=this.upperBoundOnCost?!1:(this.queue=new Pr(Le),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(i):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|H.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|H.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!==0}static IsInDirs(e,t){return e===(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let n=this.Target.point.sub(e);if(ie(n.x,0)&&ie(n.y,0))return this.targetCostAdjustment;let i=H.VectorDirection(n),o;return t===0?(t=15,o=this.GetNumberOfBends(t,i)):o=this.GetNumberOfBends(t,i),this.CombinedCost(Ct.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return H.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):Ct.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)===t?Ct.IsInDirs(t,this.EntryDirectionsToTarget)?0:Ct.IsInDirs(Ct.Left(t),this.EntryDirectionsToTarget)||Ct.IsInDirs(Ct.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(Ct.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,n){let i=e&t;if(i===0)return Ct.GetBendsForNotPureDirection(e,Ct.AddOneTurn[t],n)+1;let o=e&n;return o===0?Ct.GetBendsForNotPureDirection(e,t,Ct.AddOneTurn[n])+1:(i|o)===e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return Ct.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let n=new Array,i=!1,o=0;for(;;){o===e.entry.Direction?i=!0:(i=!1,n.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex===t)break;e.entry=a}return i&&n.push(e.entry.Vertex.point),n.reverse(),n}QueueReversedEntryToNeighborVertexIfNeeded(e,t,n){let i={numberOfBends:0,length:0},o=t.PreviousVertex,a=Ct.GetLengthAndNumberOfBendsToNeighborVertex(e,o,n,i);if(this.CombinedCost(i.length,i.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree===1){let l=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,i.length,i.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,n){let i={numberOfBends:0,length:0},o=Ct.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,n,i);if(this.CombinedCost(i.length,i.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,i.length,i.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,n){let i={numberOfBends:0,length:0},o=Ct.GetLengthAndNumberOfBendsToNeighborVertex(e,t,n,i),a=this.TotalCostFromSourceToVertex(i.length,i.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,i.length,i.numberOfBends,a))}EnqueueEntry(e,t,n,i,o){let a=new Cd(t,e,n,i,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,n,i){i.length=e.Length+Ct.ManhattanDistance(e.Vertex.point,t.point)*n;let o=H.DirectionFromPointToPoint(e.Vertex.point,t.point);return i.numberOfBends=e.NumberOfBends,e.Direction!==0&&o!==e.Direction&&i.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,n,i,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=n,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c===this.Target){if(i==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget===0){let d=0;for(let m of this.Target.VertexEntries)i[d++]=m;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=Ct.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(i!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)i[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,n){for(let i of t)this.ExtendPathAlongEdge(e,i,!0,n)}ExtendPathAlongOutEdges(e,t,n){let i=t.isEmpty()?null:t.treeMinimum();for(;i!=null;i=t.next(i))this.ExtendPathAlongEdge(e,i.item,!1,n)}ExtendPathAlongEdge(e,t,n,i){if(!Ct.IsPassable(t))return;let o=n?t.Source:t.Target;if(o===e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!==this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=H.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!==e.Direction&&(l=this.nextNeighbors[a===i?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new Cd(this.Source,null,0,0,e);for(let n of this.Source.OutEdges)!Ct.IsPassable(n)||this.ExtendPathToNeighborVertex(t,n.Target,n.Weight);for(let n of this.Source.InEdges)!Ct.IsPassable(n)||this.ExtendPathToNeighborVertex(t,n.Source,n.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,n){let i=H.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[H.ToIndex(i)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,n)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,n):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,n)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,n){if(e.Vertex.VertexEntries!=null){let i=H.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[H.ToIndex(i)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,n),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},Gn=Ct;Gn.DefaultBendPenaltyAsAPercentageOfDistance=4,Gn.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var aa=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=Gn.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let n={entry:this.GetPathStage(null,e,null,t)};return Gn.RestorePathV(n)}GetPathStage(e,t,n,i){let o=new Gn,a={bestEntry:null,bestCost:Number.MAX_VALUE/xe.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=aa.Barycenter(t),c=aa.Barycenter(i),h=Gn.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,m=n!=null?this.currentPassTargetEntries:null,P=[];for(let I of t)for(let L of i)P.push([I,L]);P.sort(([I,L],[D,w])=>S(I,L)-S(D,w));for(let[I,L]of P){if(f.closeDistEps(I.point,L.point))continue;let D=v(I,u)*d,w=v(L,c)*d,M=a.bestCost;if(n!=null){for(let se=0;se<m.length;se++)m[se]=null;M=o.MultistageAdjustedCostBound(a.bestCost)}let K=o.GetPathWithCost(e,I,D,m,L,w,M);if(m!=null){aa.UpdateTargetEntriesForEachDirection(n,m,a);continue}if(K==null)continue;let X=K.Cost/S(I,L);(K.Cost<a.bestCost||ie(K.Cost,a.bestCost)&&X<l)&&(a.bestCost=K.Cost,a.bestEntry=K,l=K.Cost/S(I,L))}return a.bestEntry;function S(I,L){return Gn.ManhattanDistance(I.point,L.point)}function v(I,L){return Gn.ManhattanDistance(I.point,L)}}static UpdateTargetEntriesForEachDirection(e,t,n){for(let i=0;i<t.length;i++){let o=t[i];o!=null&&(e[i]==null||o.Cost<e[i].Cost)&&(e[i]=o,o.Cost<n.bestCost&&(n.bestCost=o.Cost,n.bestEntry=o))}}static Barycenter(e){let t=new f(0,0);for(let n of e)t=t.add(n.point);return t.div(e.length)}};var dS=Ae(Ut());var Cp=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof un?Array.from(hS(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new dS.StringBuilder;this.PathPoints instanceof un&&e.Append("L");for(let t of hS(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*hS(s){if(s instanceof un)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var xp=class extends na{constructor(e,t,n,i){super(t);this.Slope=0;this.SlopeInverse=0;this.Obstacle=e,this.endVertex=i?t.nextOnPolyline:t.prevOnPolyline,n.IsPerpendicularPP(t.point,this.endVertex.point)||(this.Slope=Q.Slope(t.point,this.endVertex.point,n),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(e){this.obstacle=e}get EndVertex(){return this.endVertex}},Br=class extends xp{constructor(e,t,n){super(e,t,n,n.IsHorizontal)}},ls=class extends xp{constructor(e,t,n){super(e,t,n,n.IsVertical)}};var la=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}GetPortChanges(e){return e.addedPorts=go(this.InputShape.Ports,this.Ports),e.removedPorts=go(this.Ports,this.InputShape.Ports),e.addedPorts.size===0&&e.removedPorts.size===0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,n,i){let o=la.mk(e,t,i);return o.CreateInitialSides(o.PaddedPolyline.startPoint,n),o}CreateInitialSides(e,t){this.ActiveLowSide=new Br(this,e,t),this.ActiveHighSide=new ls(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new ls(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t){e!=null&&(this.PaddedPolyline=Kt.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,t),la.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports))}static mk(e,t,n){let i=new la(null,0);return i.PaddedPolyline=ee.mkClosedFromPoints([C.RoundPoint(e),C.RoundPoint(t)]),i.Ordinal=n,i}IsPolylineRectangle(){if(this.PaddedPolyline.count!==4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,n=H.VectorDirectionPP(e.point,t.point);if(!H.IsPureDirection(n))return!1;do{e=t,t=e.nextOnPolyline;let i=H.DirectionFromPointToPoint(e.point,t.point);if(i!==H.RotateRight(n))return!1;n=i}while(e!==this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=C.RoundPoint(t.point),t=t.nextOnPolyline;while(t!==e.startPoint);la.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this===this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=C.intersectionEpsilon*10;for(let n=e.startPoint.next;n!=null;n=n.next)f.close(n.prev.point,n.point,t)&&(n.next==null?e.RemoveEndPoint():(n.prev.next=n.next,n.next.prev=n.prev));return f.close(e.start,e.end,t)&&e.RemoveStartPoint(),e=e.RemoveCollinearVertices(),e.endPoint.prev!=null&&e.endPoint.prev!==e.startPoint&&f.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)===2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!==e.startPoint&&f.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)===2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!==void 0&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump===e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=Kt.CreatePaddedPolyline(e,C.intersectionEpsilon*10);return la.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},yr=la;yr.FirstSentinelOrdinal=1,yr.FirstNonSentinelOrdinal=10;var fS=Ae(Ut());var Ap=class{constructor(e,t,n,i){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=xe.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=n;let o=R.mkPP(this.UnpaddedBorderIntersect,Q.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,n)),a=x.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=C.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=i.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=i.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,Et.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(i))&&(this.unpaddedToPaddedBorderWeight=xe.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight===xe.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(i)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight}get IsCollinearWithPort(){return H.IsPureDirection(F.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return Q.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return F.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!==0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=xe.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=z.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,n=>n.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(n=>!n.UserData.IsGroup&&n.UserData!==this.Obstacle).map(n=>n.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=z.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!==this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,n){let i=null;for(let o of n){let a=t(o);if(!Q.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(i=i!=null?i:R.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),x.intersectionOne(i,a,!1)!=null||0!==x.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=Q.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return F.GetDirections(this.MaxVisibilitySegment.start,t.Location)===F.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,n,i){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,n,i);return}this.OutwardDirection===F.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,n,i)}ExtendEdgeChain(e,t,n,i,o){e.ExtendEdgeChainVRLPB(n,i,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return fS.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var vp=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=z.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=C.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,n){let i=new Ap(this,e,t,n);this.PortEntrances.push(i),this.VisibilityRectangle.add(i.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||i.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!f.closeDistEps(this.Location,C.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var Tp=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight}get IsOutOfBounds(){return 0!==this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,n,i){let o=Q.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,n,i):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,n,i),a}AddToAdjacentVertex(e,t,n,i){F.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,n,i)}ExtendEdgeChain(e,t,n,i){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,n));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,n,e);e.ExtendEdgeChainVRLPB(t,i,a[0],a[1],o)}GetSegmentAndCrossings(e,t,n){let i=H.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[i];if(o==null){let a={pacList:null};o=[n.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[i]=o}else F.GetDirections(e.point,o[0].start)===t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let n=F.GetDirections(t,this.Vertex.point),i=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(i,this.Vertex,n&5,xe.NormalWeight),e.ConnectVertexToTargetVertex(i,this.Vertex,n&10,xe.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var pS=Ae(Ut());var gS=Ae(Ut());var Tl=class{constructor(e,t){this.BoundaryWidth=C.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return C.RoundPoint(e.add(H.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return gS.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};Tl.BoundaryWidth=C.distanceEpsilon;var Zu=class extends Xt{constructor(e){super();this.site=e}get Site(){return this.site}};var ua=class extends yn{constructor(e,t){super(t);this.Obstacle=e}};var ca=class extends ua{constructor(e,t){super(e,t)}};var Ip=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!F.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||F.GetDirections(this.CurrentSegment.End,e)==F.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&f.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(F.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new f(e,this.Coord):new f(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y === "+this.Coord:"(V) X === "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var Ad=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let n=Array.from(e).sort((i,o)=>i>o?1:i<o?-1:0);for(let i of n)this.vector.push(new Ip(i))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,n,i){this.CurrentSlot.AppendScanSegment(new xe(e,t,n,i))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let n=0,i=this.vector.length-1;if(e<=this.vector[n].Coord)return n;if(e>=this.vector[i].Coord)return i;for(;i-n>2;){let o=n+(i-n>>1),a=this.vector[o];if(e<a.Coord){i=o;continue}if(e>a.Coord){n=o;continue}return o}for(n++;n<=i;n++){let o=this.vector[n];if(e<o.Coord)return t>0?n:n-1;if(e===o.Coord)break}return n}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let n=t.FirstSegment;n!=null;n=n.NextSegment)n.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let n=t.NextSegment;n!=null;n=n.NextSegment){if(n.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&n.Start===t.End){let i=this.GetPerpendicularCoord(n.Start);t.AddSparseEndpoint(i),n.AddSparseEndpoint(i)}t=n}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count === ")+this.vector.length}};var Mn=class extends Xt{constructor(e,t,n){super();this.InitialObstacle=e,this.ReflectingObstacle=t,this.site=n}static mk(e,t,n){let i=new Mn(e.ReflectingObstacle,t,n);return i.PreviousSite=e,i}IsStaircaseStep(e){return this.InitialObstacle===e}get Site(){return this.site}};var vd=class{constructor(){this.eventTree=new $s((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let n=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(n)return n;let i=e instanceof Mn?0:1,o=t instanceof Mn?0:1;return n=i-o,n||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var mS=Ae(Ut());var $u=class{constructor(){this.pointCrossingMap=new pt;this.pointList=new Array}AddIntersection(e,t,n){let i=this.pointCrossingMap.get(e);i||(i=new Array,this.pointCrossingMap.set(e,i));let o=i.length;for(let l=0;l<o;l++){let u=i[l];if(u.Group===t)return u}let a=new Tl(t,n);return i.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size===0)return null;if(F.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())F.ComparePP(o,e)>=0&&F.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let n=new xo,i=this.pointList.length;for(let o=0;o<i;o++){let a=this.pointList[o];n.Add(a,this.pointCrossingMap.get(a))}return n}toString(){return mS.String.Format("{0}",this.pointCrossingMap.size)}};var Td=class extends Mn{constructor(e,t,n){super(e.ReflectingObstacle,t.Obstacle,n);this.Side=t}};var wp=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new dt((t,n)=>this.CompareBB(t,n)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let n=this.FindFirstInRange(e,t);n!=null;n=this.FindNextInRange(n,t))this.MarkStaleSite(n.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site===e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let n=this.eventTree.findFirst(this.findFirstPred);return n!=null&&this.Compare(n.item.Site,t)<=0?n:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let n=this.eventTree.next(e);return n!=null&&this.Compare(n.item.Site,t)<=0?n:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Id=class extends ua{constructor(e,t){super(e,t)}},wd=class extends ua{constructor(e,t){super(e,t)}},Ld=class extends ua{constructor(e,t){super(e,t)}};var Od=class extends Mn{constructor(e,t,n){super(e.ReflectingObstacle,t.obstacle,n);this.Side=t}};var Rd=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,n,i){if(Q.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=n,this.GroupSideInterveningBeforeHighNeighbor=i;return}this.LowNeighbor=t,this.LowOverlapEnd=n,this.GroupSideInterveningBeforeLowNeighbor=i}};var Bd=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],yr.RoundVerticesAndSimplify(this.Polyline)}};var vo=class{static MungeClosestIntersectionInfo(e,t,n){let i=t.seg1.boundingBox,o=C.RoundPoint(t.x).clone();return n?new f(vo.MungeIntersect(e.x,o.x,i.left,i.right),o.y):new f(o.x,vo.MungeIntersect(e.y,o.y,i.bottom,i.top))}static MungeIntersect(e,t,n,i){if(e<t){let o=Math.min(n,i);t<o&&(t=o)}else if(e>t){let o=Math.max(n,i);t>o&&(t=o)}return C.RoundDouble(t)}};var ft=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new $u;this.overlapPairs=new mr;this.hasOverlaps=!1;this.lookupIntPair=new ye(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,n){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=n}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=yr.FirstNonSentinelOrdinal;for(let n of this.allObstacles)n.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-yr.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=ft.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=ft.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(Gt(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let n={bIsInsideA:!1,aIsInsideB:!1};if(ft.ObstaclesIntersect(e,t,n)){this.hasOverlaps=!0;return}!n.aIsInsideB&&!n.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&n.bIsInsideA||t.IsGroup&&n.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(n=>st(n,n.VisibilityBoundingBox));return Ke(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&Lr(e,e,(t,n)=>this.EvaluateOverlappedPairForClump(t,n))}EvaluateOverlappedPairForClump(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1};!ft.ObstaclesIntersect(e,t,n)&&!n.aIsInsideB&&!n.bIsInsideA||this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&Lr(e,e,(t,n)=>this.EvaluateOverlappedPairForConvexHull(t,n))}EvaluateOverlappedPairForConvexHull(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1};!ft.ObstaclesIntersect(e,t,n)&&!n.aIsInsideB&&!n.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(n=>n.IsGroup)),t=ft.CalculateHierarchy(this.GetAllObstacles().filter(n=>n.IsPrimaryObstacle));e==null||t==null||Lr(e,t,(n,i)=>this.EvaluateOverlappedPairForGroup(n,i))}EvaluateOverlappedPairForGroup(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let n={bIsInsideA:!1,aIsInsideB:!1},i=ft.ObstaclesIntersect(e,t,n);if(!(!i&&!n.aIsInsideB&&!n.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(n.aIsInsideB||ft.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!i&&(t.IsGroup||n.bIsInsideA)||this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return x.PointRelativeToCurveLocation(e.start,t)!==0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(n=>n.Ordinal!==e.Ordinal))this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(n=>n.Ordinal!==e.Ordinal))this.overlapPairs.add(new ye(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=al(Array.from(this.overlapPairs.values())),t=Jn(e);for(let n of t){if(n.length===1)continue;let i=n.map(o=>this.OrdinalToObstacle(o));for(let o of i)o.clump=i}}CreateConvexHulls(){let e=!1,t=al(Array.from(this.overlapPairs.values())),n=Jn(t);for(let i of n){if(i.length===1)continue;e=!0;let o=i.map(this.OrdinalToObstacle),a=Bi(o,u=>u.VisibilityPolyline),l=new Bd(qr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let n=this.OrdinalToObstacle(t.x),i=this.OrdinalToObstacle(t.y);ft.ResolveGroupAndGroupOverlap(n,i)||ft.ResolveGroupAndObstacleOverlap(n,i)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?ft.ResolveGroupAndObstacleOverlap(e,t):ft.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let n=t.looseVisibilityPolyline;ft.GrowGroupAroundLoosePolyline(e,n);let i={bIsInsideA:!1,aIsInsideB:!1};for(;ft.ObstaclesIntersect(t,e,i)||!i.aIsInsideB;)n=yr.CreateLoosePolyline(n),ft.GrowGroupAroundLoosePolyline(e,n)}static GrowGroupAroundLoosePolyline(e,t){let n=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new Bd(qr.createConvexHullAsClosedPolyline(n),[e]))}static ObstaclesIntersect(e,t,n){return x.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(n.aIsInsideB=!1,n.bIsInsideA=!1,!0):(n.aIsInsideB=ft.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),n.bIsInsideA=!n.aIsInsideB&&ft.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:ft.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,n.aIsInsideB,n.bIsInsideA)?(n.aIsInsideB=!1,n.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,n,i){if(!n&&!i)return x.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=n?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=n?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(x.PointRelativeToCurveLocation(l,a)===0){let u=x.ClosestPoint(a,l);if(!f.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let n=t.VisibilityBoundingBox;for(let i of this.Root.GetNodeItemsIntersectingRectangle(n))if(i!==t&&x.ClosedCurveInteriorsIntersect(i.VisibilityPolyline,t.VisibilityPolyline)){if(i.IsInConvexHull)for(let o of i.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(i.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let n=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(i=>!n.intersects(this.shapeIdToObstacleMap.get(i).VisibilityBoundingBox)));for(let i of e)this.AncestorSets.get(t.InputShape).delete(i);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,n){let i=Q.RectangleBorderIntersect(this.GraphBox,e,t);if(F.GetDirections(e,i)===0)return n.pacList=null,R.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,i);return n.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,n,i){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=i,this.Root.FirstHitNodeWithPredicate(n,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,Et.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t===this.insideHitTestIgnoreObstacle1||t===this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!Q.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let n=Q.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),i=Q.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=R.mkPP(i,n),a=x.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length===2){let l=C.RoundPoint(a[0].x),u=C.RoundPoint(a[1].x);if(!F.EqualPP(e,l)&&!F.EqualPP(e,u)&&e.compareTo(l)!==e.compareTo(u)&&!ie(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let n=this.RestrictSegmentPrivate(e,t);return!F.EqualPP(n.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let n=this.RestrictSegmentPrivate(e,t);return!F.EqualPP(n.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=R.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let n=F.GetDirections(e,t),i=8===n?this.GraphBox.right:2===n?this.GraphBox.left:e.x,o=8===n?this.GraphBox.left:2===n?this.GraphBox.right:t.x,a=4===n?this.GraphBox.top*2:1===n?this.GraphBox.bottom:e.y,l=4===n?this.GraphBox.bottom:1===n?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=R.mkPP(new f(i,a),new f(o,l))}RecurseRestrictRayWithObstacles(e){if(!Q.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let n=x.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(n);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,n);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,n=null,i=this.restrictedRayLengthSquared,o=F.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=C.RoundPoint(a.x),u=F.GetDirections(this.currentRestrictedRay.start,l);if(u===H.OppositeDir(o))continue;if(t++,0===u){i=0,n=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<i){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<C.squareOfDistanceEpsilon)continue;i=c,n=a}}if(n!=null){if(t===1){let a=C.RoundPoint(n.x);if(f.closeIntersections(a,this.currentRestrictedRay.start)||f.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=i,this.currentRestrictedRay.end=vo.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,n,!Q.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let n of t){let i=C.RoundPoint(n.x);if(i.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=F.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=n.seg1,u=H.VectorDirection(l.derivative(n.par1)),c=a;(u&H.RotateRight(a))!==0&&(c=H.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(i,e,c)}}};var Lp=class{constructor(e,t){this.scanDirection=e,this.SideTree=new dt((n,i)=>this.Compare(n,i)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)===-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return Q.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle===t.Obstacle)return e===t?0:e instanceof Br?-1:1;let n=ha.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),i=ha.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=n.compareTo(i);if(o===0){let a=e instanceof Br,l=t instanceof Br;o=a0(a,l),o===0&&(o=Le(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var Il=class{constructor(e){this.lookupSegment=xe.mk(new f(0,0),new f(0,1));this.ScanDirection=e,this.segmentTree=new dt((t,n)=>this.Compare(t,n)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let n=this.segmentTree.find(this.lookupSegment);return n!=null&&F.EqualPP(n.item.End,t)?n.item:null}FindLowestIntersector(e,t){let n=this.FindLowestIntersectorNode(e,t);return n!=null?n.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let n=this.segmentTree.findLast(this.findIntersectorPred);if(F.EqualPP(e,t))n!=null&&this.ScanDirection.Compare(n.item.End,e)<0&&(n=null);else for(this.lookupSegment.Update(e,t);n!=null&&!n.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(n.item.Start,t)>0)return null;n=this.segmentTree.next(n)}return n}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let n=this.segmentTree.findLast(this.findIntersectorPred);if(F.EqualPP(e,t))n!=null&&this.ScanDirection.Compare(n.item.End,e)<0&&(n=null);else for(this.lookupSegment.Update(e,t);n!=null&&!n.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(n.item.End,e)<0)return null;n=this.segmentTree.previous(n)}return n!=null?n.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,n){this.lookupSegment.Update(e,t);let i=this.segmentTree.findFirst(this.findPointPred);if(i!=null){let o=i.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)===-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped===e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!==t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start===t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End===t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let i=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),i.Update(o.End,i.End),this.segmentTree.insert(i),i.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let n=this.ScanDirection.Compare(e.Start,t.Start);return n===0&&(n=this.ScanDirection.Compare(e.End,t.End)*-1),n}};var Op=class extends po{constructor(e){super(e)}SetVertexEntry(e){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[H.ToIndex(e.Direction)]=e}RemoveVertexEntries(){this.VertexEntries=null}};var Wt=class{constructor(e){this.ObstacleTree=new ft;this.CurrentGroupBoundaryCrossingMap=new $u;this.LowNeighborSides=new Rd;this.HighNeighborSides=new Rd;this.ScanDirection=Et.HorizontalInstance,this.eventQueue=new vd,this.HorizontalScanSegments=new Il(Et.HorizontalInstance),this.VerticalScanSegments=new Il(Et.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new Xe;return e.VertexFactory=t=>new Op(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(Et.HorizontalInstance);let e=yr.FirstSentinelOrdinal,t=new f(this.ObstacleTree.GraphBox.left-Wt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Wt.SentinelOffset),n=new f(this.ObstacleTree.GraphBox.left-Wt.SentinelOffset,this.ObstacleTree.GraphBox.top+Wt.SentinelOffset),i=yr.CreateSentinel(t,n,this.ScanDirection,e++);this.scanLine.Insert(i.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new f(this.ObstacleTree.GraphBox.right+Wt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Wt.SentinelOffset),n=new f(this.ObstacleTree.GraphBox.right+Wt.SentinelOffset,this.ObstacleTree.GraphBox.top+Wt.SentinelOffset),i=yr.CreateSentinel(t,n,this.ScanDirection,e++),this.scanLine.Insert(i.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(Et.VerticalInstance),t=new f(this.ObstacleTree.GraphBox.left-Wt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Wt.SentinelOffset),n=new f(this.ObstacleTree.GraphBox.right+Wt.SentinelOffset,this.ObstacleTree.GraphBox.bottom-Wt.SentinelOffset),i=yr.CreateSentinel(t,n,this.ScanDirection,e++),this.scanLine.Insert(i.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new f(this.ObstacleTree.GraphBox.left-Wt.SentinelOffset,this.ObstacleTree.GraphBox.top+Wt.SentinelOffset),n=new f(this.ObstacleTree.GraphBox.right+Wt.SentinelOffset,this.ObstacleTree.GraphBox.top+Wt.SentinelOffset),i=yr.CreateSentinel(t,n,this.ScanDirection,e),this.scanLine.Insert(i.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,n){let i=t.Direction,o=t.Start.x,a=t.Start.y;return n.IsHorizontal?(o+=i.x/i.y*(e.y-t.Start.y),o=vo.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=i.y/i.x*(e.x-t.Start.x),a=vo.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new f(o,a)}GetOpenVertex(e){let t=e.startPoint,n=this.TraversePolylineForEvents(t),i=this.PointCompare(n.point,t.point);for(;;n=this.TraversePolylineForEvents(n)){let o=this.PointCompare(n.point,t.point);if(o<=0)t=n;else if(o>0&&i<=0)break;i=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new Lp(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new wp(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new ca(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return Wt.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof Br?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof Br?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,n,i){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!i&&!Q.PointIsInRectangleInterior(n,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(n)==null&&this.lookaheadScan.Add(new Mn(e,t.Obstacle,n))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let n=z.mkPP(e.Start,e.End),i=z.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!n.intersectsOnX(i):!n.intersectsOnY(i))return;let o=z.intersect(n,i),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=Wt.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!==e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,n){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!Q.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(n!=null&&e.IsStaircaseStep(n.Obstacle))return this.ScanLineCrossesObstacle(e.Site,n.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,n,i){{let o=this.ScanLineIntersectSide(i.Site,t!=null?t:n),a=t!=null?o:i.Site,l=t!=null?i.Site:o;return t==null?t=this.scanLine.NextLowB(n).item:n=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,n,i)}}AddReflectionEvent(e,t,n){let i=t;i!=null?this.eventQueue.Enqueue(new Od(e,i,n)):this.eventQueue.Enqueue(new Td(e,t,n))}AddSideToScanLine(e,t){let n=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),n}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new vd,this.HorizontalScanSegments=new Il(Et.HorizontalInstance),this.VerticalScanSegments=new Il(Et.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof ca?this.ProcessEventO(e):e instanceof Id?this.ProcessEventLB(e):e instanceof wd?this.ProcessEventHB(e):e instanceof Ld?this.ProcessEventCV(e):e instanceof Od?this.ProcessEventLR(e):e instanceof Td?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,n){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,n,this.HighNeighborSides)}FindNeighbors(e,t,n){let i=e instanceof ca?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,i,o.lowNborSideNode,n),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,i,o.highNborSideNode,n)}SkipToNeighbor(e,t,n,i,o){let a=null,l=null;for(;;i=this.scanLine.Next(e,i))if(i.item.Obstacle!==t.Obstacle){if(i.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(i,n,e)&&l==null&&(l=i.item);continue}if(i.item instanceof ls===Q.IsAscending(e)){this.ScanLineCrossesObstacle(n,i.item.Obstacle)&&(a=i,l=null);continue}break}o.SetSides(e,i,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,n){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let i=e.item instanceof Br===Q.IsAscending(n)?n:H.OppositeDir(n),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,i),!0}FindNeighborsAndProcessVertexEvent(e,t,n){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(n,e,t),this.ProcessVertexEvent(e,t,n),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let n=this.AddSideToScanLine(t.ActiveHighSide,e.Site),i=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(i,n,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!==t.ActiveLowSide.Start){let c=new ls(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,n=new Br(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(n.End,n.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(n,e.Site),t.ActiveLowSide=n,this.EnqueueLowBendVertexEvent(n))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Id(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,n=new ls(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let i=this.AddSideToScanLine(n,e.Site);if(t.ActiveHighSide=n,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&n.Start.x===t.VisibilityBoundingBox.right&&this.SideReflectsUpward(n)){let o=this.scanLine.NextHighR(i);o.item instanceof Br&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(n.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,n,n.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,n=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(n.point,e.End)>0?this.eventQueue.Enqueue(new wd(t,e.EndVertex)):this.eventQueue.Enqueue(new Ld(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,n=this.scanLine.Find(t.ActiveLowSide),i=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)===1){let o=n;n=i,i=o}if(this.FindNeighborsAndProcessVertexEvent(n,i,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(n);o.item!==i.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,n=this.HighNeighborSides.HighNeighbor.item,i=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(n),i.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,n=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,n)&&this.AddParallelReflectionSegment(t,n,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,n=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,n)&&this.AddParallelReflectionSegment(t,null,n,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),n=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new f(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(n,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return F.EqualPP(e,this.MakeInBoundsLocation(e))}},ha=Wt;ha.SentinelOffset=1;var Nr=class extends ha{constructor(){super(!1);this.horizontalVertexPoints=new We;this.verticalVertexPoints=new We;this.boundingBoxSteinerPoints=new We;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let e of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(e.VisibilityBoundingBox.left),this.xCoordAccumulator.add(e.VisibilityBoundingBox.right),this.yCoordAccumulator.add(e.VisibilityBoundingBox.top),this.yCoordAccumulator.add(e.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new Ad(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new Ad(this.xCoordAccumulator,!1);for(let e=0;e<this.horizontalScanSegmentVector.Length;e++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(e).Coord,e);for(let e=0;e<this.verticalScanSegmentVector.Length;e++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(e).Coord,e)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(e){super.InitializeEventQueue(e),this.SetVectorsAndCoordMaps(e),this.AddAxisCoordinateEvents(e)}AddAxisCoordinateEvents(e){if(e.IsHorizontal){for(let t of this.yCoordAccumulator)this.eventQueue.Enqueue(new Zu(new f(this.ObstacleTree.GraphBox.left-Nr.SentinelOffset,t)));return}for(let t of this.xCoordAccumulator)this.eventQueue.Enqueue(new Zu(new f(t,this.ObstacleTree.GraphBox.bottom-Nr.SentinelOffset)))}ProcessCustomEvent(e){this.ProcessAxisCoordinate(e)||this.ProcessCustomEvent(e)}ProcessAxisCoordinate(e){return e instanceof Zu?(this.CreateScanSegmentsOnAxisCoordinate(e.Site),!0):!1}InsertPerpendicularReflectionSegment(e,t){return!1}InsertParallelReflectionSegment(e,t,n,i,o,a){return!1}ProcessVertexEvent(e,t,n){let i=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;i.add(n.Site);let o=this.LowNeighborSides.LowNeighbor.item,a=this.HighNeighborSides.HighNeighbor.item,l=this.ScanDirection.Dir,u=this.ScanDirection.OppositeDirection,c=this.ScanLineIntersectSide(n.Site,o),h=this.ScanLineIntersectSide(n.Site,a);if(this.ObstacleTree.GraphBox.contains(c)){let m=Q.RectangleBorderIntersect(o.Obstacle.VisibilityBoundingBox,c,l);F.IsPureLower(m,n.Site)&&this.boundingBoxSteinerPoints.add(m)}if(this.ObstacleTree.GraphBox.contains(h)){let m=Q.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);F.IsPureLower(n.Site,m)&&this.boundingBoxSteinerPoints.add(m)}let d={lowCorner:void 0,highCorner:void 0};Nr.GetBoundingCorners(e.item.Obstacle.VisibilityBoundingBox,n instanceof ca,this.ScanDirection.IsHorizontal,d),(F.IsPureLower(c,d.lowCorner)||o.Obstacle.IsInSameClump(n.Obstacle))&&i.add(d.lowCorner),(F.IsPureLower(d.highCorner,h)||a.Obstacle.IsInSameClump(n.Obstacle))&&i.add(d.highCorner)}static GetBoundingCorners(e,t,n,i){if(t){i.lowCorner=e.leftBottom,i.highCorner=n?e.rightBottom:e.leftTop;return}i.lowCorner=n?e.leftTop:e.rightBottom,i.highCorner=e.rightTop}CreateScanSegmentsOnAxisCoordinate(e){this.CurrentGroupBoundaryCrossingMap.Clear();let t=this.scanLine.Lowest(),n=this.scanLine.NextHighR(t),i=0,o=e,a=!1;for(;n!=null;n=this.scanLine.NextHighR(n)){if(this.SkipSide(o,n.item))continue;if(n.item.Obstacle.IsGroup){(i===0||a)&&this.HandleGroupCrossing(e,n.item);continue}if(n.item instanceof Br){if(i>0){i++;continue}o=this.CreateScanSegment(o,n.item,xe.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),i=1,a=n.item.Obstacle.isOverlapped;continue}i++,!(i>0)&&(o=n.item.Obstacle.isOverlapped||n.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(o,n.item,xe.OverlappedWeight):this.ScanLineIntersectSide(o,n.item),this.CurrentGroupBoundaryCrossingMap.Clear(),a=!1)}let l=this.ScanDirection.IsHorizontal?new f(this.ObstacleTree.GraphBox.right+Nr.SentinelOffset,o.y):new f(o.x,this.ObstacleTree.GraphBox.top+Nr.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(o,l,xe.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o,l)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(e,t){if(!this.ScanLineCrossesObstacle(e,t.Obstacle))return;let n=t instanceof Br?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,i=this.ScanLineIntersectSide(e,t),o=this.CurrentGroupBoundaryCrossingMap.AddIntersection(i,t.Obstacle,n);this.AddPerpendicularCoordForGroupCrossing(i);let a=o.GetInteriorVertexPoint(i);this.AddPerpendicularCoordForGroupCrossing(a)}AddPerpendicularCoordForGroupCrossing(e){let t=this.FindPerpendicularSlot(e,0);t!==-1&&this.perpendicularSegmentVector.Item(t).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(e,t){if(t.Obstacle.IsSentinel)return!0;let n=t.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?e.y===n.bottom||e.y===n.top:e.x===n.left||e.x===n.right}CreateScanSegment(e,t,n){let i=this.ScanLineIntersectSide(e,t);return e!==i&&this.parallelSegmentVector.CreateScanSegment(e,i,n,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(e,i)),i}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=Nr.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=il;let e=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=Et.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(n,i)=>n.compareTo(i);let e=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),t=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=Et.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(e,t)}SetVectorsAndCoordMaps(e){e.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(e,t){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let n=1,i={j:0};for(let o of this.parallelSegmentVector.Items())for(;!(!o.CurrentSegment.ContainsPoint(e[n])&&(!this.AddSteinerPointsToInterveningSegments(e[n],t,i,o)||!o.TraverseToSegmentContainingPoint(e[n])));){if(this.AddPointsToCurrentSegmentIntersections(t,i,o),this.GenerateIntersectionsFromVertexPointForCurrentSegment(e[n],o),o.PointIsCurrentEndAndNextStart(e[n])){o.MoveNext();continue}if(++n>=e.length)return}}AddSteinerPointsToInterveningSegments(e,t,n,i){for(;n.j<t.length&&this.currentAxisPointComparer(t[n.j],e)===-1;){if(!i.TraverseToSegmentContainingPoint(t[n.j]))return!1;this.AddPointsToCurrentSegmentIntersections(t,n,i)}return!0}AddPointsToCurrentSegmentIntersections(e,t,n){for(;t.j<e.length&&n.CurrentSegment.ContainsPoint(e[t.j]);t.j++){let i=this.FindPerpendicularSlot(e[t.j],0);this.AddSlotToSegmentIntersections(n,i)}}GenerateIntersectionsFromVertexPointForCurrentSegment(e,t){let n=this.FindPerpendicularSlot(t.CurrentSegment.Start,1),i=this.FindPerpendicularSlot(t.CurrentSegment.End,-1),o=this.FindPerpendicularSlot(e,0);n>=i||(this.AddSlotToSegmentIntersections(t,n),this.AddSlotToSegmentIntersections(t,i),o>n&&o<i&&(this.AddSlotToSegmentIntersections(t,o),this.AddBinaryDivisionSlotsToSegmentIntersections(t,n,o,i)))}FindPerpendicularSlot(e,t){return Nr.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,e,t)}static FindIntersectingSlot(e,t,n,i){let o=e.GetParallelCoord(n),a=t.get(o);return a!==void 0?a:i===0?-1:e.FindNearest(o,i)}AddSlotToSegmentIntersections(e,t){let n=this.perpendicularSegmentVector.Item(t);e.CurrentSegment.AddSparseVertexCoord(n.Coord),n.AddPerpendicularCoord(e.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(e,t,n,i){let o=0,a=this.perpendicularSegmentVector.Length-1;for(;a-o>1;){let l=o+Math.floor((a-o)/2);if(n<=l){a=l,n<a&&a<=i&&this.AddSlotToSegmentIntersections(e,a);continue}o=l,n>o&&o>=t&&this.AddSlotToSegmentIntersections(e,o)}}CreateScanSegmentTrees(){Nr.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),Nr.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(e,t){for(let n of e.Items())for(let i=n.FirstSegment;i!=null;i=i.NextSegment)i.HasVisibility()&&t.InsertUnique(i)}};var Yr=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof Nr}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,xe.NormalWeight)}FindOrAddEdge(e,t,n){let i=F.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};Yr.GetBrackets(e,t,i,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,n),a}static GetBrackets(e,t,n,i){if(i.splitVertex=t,!Yr.FindBracketingVertices(e,t.point,n,i)){let o={bracketSource:null,bracketTarget:null};Yr.FindBracketingVertices(t,e.point,H.OppositeDir(n),o)&&(i.bracketSource=o.bracketTarget,i.splitVertex=e),i.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,n,i){for(i.bracketSource=e;i.bracketTarget=Q.FindAdjacentVertex(i.bracketSource,n),i.bracketTarget!=null;){if(f.closeDistEps(i.bracketTarget.point,t))return!0;if(n!==F.GetDirections(i.bracketTarget.point,t))break;i.bracketSource=i.bracketTarget}return i.bracketTarget!=null}CreateEdge(e,t,n){let i=e,o=t;F.IsPureLower(i.point,o.point)||(i=t,o=e);let a=new sr(i,o,n);return Xe.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&Xe.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)Xe.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return Q.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,n){for(;;){let i=Q.FindAdjacentVertex(e,t);if(i==null)break;let o=F.GetDirections(i.point,n);if((H.OppositeDir(t)&o)!==0)return this.VisGraph.FindEdgePP(e.point,i.point);e=i}return null}FindNearestPerpendicularOrContainingEdge(e,t,n){let i;t&F.GetDirections(e.point,n);let o=e,a=i;for(;0!==a;){let u=Q.FindAdjacentVertex(o,i);if(u==null||(H.OppositeDir(i)&F.GetDirections(u.point,n))!==0)break;o=u,t&F.GetDirections(o.point,n)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,n),!(l!=null||o===e);)o=Q.FindAdjacentVertex(o,H.OppositeDir(i));return l}ConnectVertexToTargetVertex(e,t,n,i){if(f.closeDistEps(e.point,t.point))return;let o=F.GetDirections(e.point,t.point);if(F.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=Q.FindBendPointBetween(e.point,t.point,n),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,i),this.FindOrAddEdge(l,t,i)}AddEdgeToTargetEdge(e,t,n){let i=this.VisGraph.FindVertex(n);return i==null&&(i=this.AddVertex(n),this.SplitEdge(t,i)),this.FindOrAddEdgeVV(e,i),i}SplitEdge(e,t){return e==null?null:f.closeDistEps(e.Source.point,t.point)||f.closeDistEps(e.Target.point,t.point)?e:(e instanceof sr||this.edgesToRestore.push(e),Xe.RemoveEdge(e),(this.IsSparseVg||e.Weight===xe.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,n,i,o){let a=F.GetDirections(n.start,n.end);if(a===0)return;let l=Q.GetRectangleBound(t,a),u=Q.IsVerticalD(a)?C.RoundPoint(new f(e.point.x,l)):C.RoundPoint(new f(l,e.point.y));if(f.closeDistEps(u,e.point)||F.GetDirections(e.point,u)!==a)return;let c=n;F.GetDirections(u,c.end)===a&&(c=R.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,n,i,o)}ExtendEdgeChain(e,t,n,i,o,a){if(F.GetDirections(e.point,n.end)!==t)return;let u=H.RotateLeft(t),c=Q.FindAdjacentVertex(e,u);if(c==null&&(u=H.OppositeDir(u),c=Q.FindAdjacentVertex(e,u),c==null))return;let h=H.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,n,i,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,n,i,a,d),this.SpliceGroupBoundaryCrossings(o,e,n)}SpliceGroupBoundaryCrossings(e,t,n){if(e==null||e.Count()===0)return;e.Reset();let i=n.start,o=n.end,a=F.GetDirections(i,o);Q.IsAscending(a)||(i=n.end,o=n.start,a=H.OppositeDir(a)),t=Yr.TraverseToFirstVertexAtOrAbove(t,i,H.OppositeDir(a));for(let l=t;l!=null;l=Q.FindAdjacentVertex(l,a)){let u=F.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();F.ComparePP(c.Location,t.point)>0&&F.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,H.OppositeDir(a)),F.ComparePP(c.Location,t.point)>=0&&F.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,n){let i=e,o=H.OppositeDir(n);for(;;){let a=Q.FindAdjacentVertex(i,n);if(a==null||F.GetDirections(a.point,t)===o)break;i=a}return i}SpliceGroupBoundaryCrossing(e,t,n){var o,a;let i=xo.ToCrossingArray(t.Crossings,n);if(i!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);this.AddVertex(t.Location),e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=i[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u);this.AddVertex(u),this.FindOrAddEdgeVV(l,c);let h=this.VisGraph.FindEdgePP(l.point,c.point),d=i.map(m=>m.Group.InputShape);h.IsPassable=()=>d.some(m=>m.IsTransparent)}}ExtendSpliceWorker(e,t,n,i,o,a,l){let u=Q.FindAdjacentVertex(e,n);l.spliceTarget=Q.FindAdjacentVertex(u,n);let c={spliceSource:e};for(;Yr.GetNextSpliceSource(c,n,t);){let h=Q.FindBendPointBetween(u.point,c.spliceSource.point,H.OppositeDir(n));if(Yr.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=Yr.GetSpliceTarget(c,n,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?xe.OverlappedWeight:xe.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?xe.OverlappedWeight:xe.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?xe.OverlappedWeight:xe.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&F.GetDirections(h,i.end))===0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,n){let i=Q.FindAdjacentVertex(e.spliceSource,n);if(i==null)for(i=e.spliceSource;;){if(i=Q.FindAdjacentVertex(i,H.OppositeDir(t)),i==null)return!1;let o=Q.FindAdjacentVertex(i,n);if(o!=null){i=o;break}}return e.spliceSource=i,!0}static GetSpliceTarget(e,t,n){let i=F.GetDirections(e.spliceSource.point,n),o=i,a=e.spliceSource;for(;o===i&&(e.spliceSource=a,a=Q.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(f.closeDistEps(a.point,n)){a=Q.FindAdjacentVertex(a,t);break}o=F.GetDirections(a.point,n)}return a}SeeIfSpliceIsStillOverlapped(e,t){let n=this.FindNextEdge(t,H.RotateLeft(e)),i=n==null?!1:xe.NormalWeight===n.Weight;return i||(n=this.FindNextEdge(t,H.RotateRight(e)),i=n==null?!1:xe.NormalWeight===n.Weight),!i||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(Yr.IsSkippableSpliceSourceEdgeWithNullTarget(Q.FindAdjacentEdge(e,t)))return!0;let n=Q.FindAdjacentEdge(e,H.OppositeDir(t));return Yr.IsSkippableSpliceSourceEdgeWithNullTarget(n)||Yr.IsReflectionEdge(n)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&ie(e.Length,Tl.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight===xe.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return F.GetDirections(e.start,e.end)===F.GetDirections(e.end,t)}toString(){return pS.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var da=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new pt;this.freePointLocationsUsedByRouteEdges=new We;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new Yr(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let n=C.RoundPoint(t.Location);if(0===x.PointRelativeToCurveLocation(n,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!==t.Curve&&0===x.PointRelativeToCurveLocation(n,t.Curve))return null;let i=new vp(t,e);return this.obstaclePortMap.set(t,i),i}FindVertices(e){let t=new Array,n=this.obstaclePortMap.get(e);if(n)if(this.RouteToCenterOfObstacles)t.push(n.CenterVertex);else for(let i of n.PortEntrances){let o=this.VisGraph.FindVertex(i.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(C.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let n={oport:null},i={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);if(this.AncestorSets.size>0&&n.oport!=null&&i.oport!=null){let l=go(a,o),u=go(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,n.oport),this.AddPortToGraph(e.targetPort,i.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let n=this.FindVertices(t),i=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,i,n),i=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,i,n)}ConnectToGraphAtPointsCollinearWithVertices(e,t,n){if(0===t)return;let i=H.OppositeDir(t);for(let o of n){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,i,xe.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size===0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let n={oport:null},i={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size===0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(z.mkPP(e.Location,e.Location),n=>n.IsGroup)).map(n=>n.InputShape))}ActivateAncestors(e,t,n){for(let i of ti(e,t)){let o=n.get(i);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=z.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let n={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(n)){for(let i of n.addedPorts)this.CreateObstaclePort(t.Obstacle,i);for(let i of n.removedPorts)this.RemoveObstaclePort(i);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),n=this.FindObstaclePort(e.targetPort);if(t==null||n==null||t.Obstacle.IsInConvexHull||n.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(n),!t.VisibilityRectangle.intersects(n.VisibilityRectangle)))return null;for(let i of t.PortEntrances)if(!!i.WantVisibilityIntersection)for(let o of n.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=i.IsVertical===o.IsVertical?da.GetPathPointsFromOverlappingCollinearVisibility(i,o):da.GetPathPointsFromIntersectingVisibility(i,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!Q.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||f.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let n=Q.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!n||e.HasGroupCrossingBeforePoint(n)||t.HasGroupCrossingBeforePoint(n)?null:[e.UnpaddedBorderIntersect,n,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,n=z.mkPP(C.RoundPoint(e.PortCurve.boundingBox.leftBottom),C.RoundPoint(e.PortCurve.boundingBox.rightTop)),i=C.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!F.Equal(i.y,n.top)&&!F.Equal(i.y,n.bottom)){o=!0;let l=new R(t.left,i.y,t.right,i.y);this.GetBorderIntersections(i,l,e.PortCurve,a);let u=new f(Math.min(a.xx0.x,a.xx1.x),i.y);u.x<n.left&&(u=new f(n.left,u.y));let c=new f(Math.max(a.xx0.x,a.xx1.x),i.y);c.x>n.right&&(c=new f(n.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(n,e,i,u,c)}if(!F.Equal(i.x,n.left)&&!F.Equal(i.x,n.right)){o=!0;let l=new R(i.x,t.bottom,i.x,t.top);this.GetBorderIntersections(i,l,e.PortCurve,a);let u=new f(i.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new f(u.x,t.bottom));let c=new f(i.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new f(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(n,e,i,u,c)}o||this.CreateEntrancesForCornerPort(n,e,i)}GetBorderIntersections(e,t,n,i){let o=x.getAllIntersections(t,n,!0);i.xx0=C.RoundPoint(o[0].x),i.xx1=C.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,n,i,o){let a=F.GetDirections(i,o);F.EqualPP(i,n)||this.CreatePortEntrance(e,t,o,a),F.EqualPP(o,n)||this.CreatePortEntrance(e,t,i,H.OppositeDir(a))}static GetDerivative(e,t){let n=e.PortCurve.closestParameter(t),i=e.PortCurve.derivative(n),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return Kt.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(i=i.mul(-1)),i}CreatePortEntrance(e,t,n,i){t.CreatePortEntrance(n,i,this.ObstacleTree);let o=Et.GetInstance(i),a=Q.GetRectangleBound(e,i)-o.Coord(n);if(a<0&&(a=-a),a>C.intersectionEpsilon){let l=H.VectorDirection(da.GetDerivative(t,n)),u;i|H.OppositeDir(i),0!==(i&l)&&(u=H.OppositeDir(u)),t.CreatePortEntrance(n,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,n){let i=1;F.EqualPP(n,e.leftBottom)?i=4:F.EqualPP(n,e.leftTop)?i=8:F.EqualPP(n,e.rightTop)?i=1:F.EqualPP(n,e.rightBottom)&&(i=2),t.CreatePortEntrance(n,i,this.ObstacleTree),t.CreatePortEntrance(n,H.RotateRight(i),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let n={targetVertex:null},i=e.IsOverlapped?xe.OverlappedWeight:xe.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,i,n)!=null&&e.AddToAdjacentVertex(this.TransUtil,n.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return Q.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,n,i){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,n,i,o)}FindorCreateNearestPerpEdgePPDNT(e,t,n,i,o){let a=Q.SortAscending(e,t),l=a[0],u=a[1],c=Q.IsVerticalD(n)?this.HScanSegments:this.VScanSegments,h=Q.IsAscending(n)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=Q.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(Q.IsAscending(n)?l:u,h,d,i,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,n,i,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(n),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,n,t,i,a);if(d!=null)return d}else if(F.EqualPP(e,n))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,H.OppositeDir(t.ScanDirection.Dir));let l=F.GetDirections(n,e),u=F.GetDirections(a.segsegVertex.point,e);if(l===u){let d={bracketTarget:null,bracketSource:null};return Yr.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,H.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,H.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(n),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=Q.GetEdgeEnd(c,H.OppositeDir(u)),n=Q.SegmentIntersectionPPP(e,n,a.segsegVertex.point),F.EqualPP(a.segsegVertex.point,n)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(n),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,i)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,n,i,o){let l=(n.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(n.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,n.LowestVisibilityVertex,n.Weight);let u=Q.SegmentsIntersection(n,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(n,o.segsegVertex,n.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),F.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return F.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,i)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,n){return F.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,n):F.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,n):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():z.mkOnPoints([C.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new Tp(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=C.RoundPoint(e);let t=this.VisGraph.FindVertex(e),n=this.FindOrCreateFreePoint(e);if(t!=null)return n;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(n),n;let i=null;n.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(n.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};i=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,n.InitialWeight,l)}let a=4;if(i!=null)a=Q.EdgeDirectionVE(i),this.ConnectFreePointToLateralEdge(n,H.RotateLeft(a)),this.ConnectFreePointToLateralEdge(n,H.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(n,a),a=H.RotateLeft(a);return n}CreateOutOfBoundsFreePoint(e){let t=e.Point,n=this.graphGenerator.MakeInBoundsLocation(t),i=F.GetDirections(n,t);if(e.OutOfBoundsDirectionFromGraph=i,!F.IsPureDirectionD(i)){e.AddOobEdgesFromGraphCorner(this.TransUtil,n);return}let o=this.VisGraph.FindVertex(n),a=H.OppositeDir(i);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,n,i,xe.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=Q.FindAdjacentVertex(o,H.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,xe.NormalWeight);let u=Q.FindAdjacentVertex(o,H.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,xe.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let n=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),i=this.FindorCreateNearestPerpEdgePPDN(n,e.Point,t,e.InitialWeight);i!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,i,t,this.portSpliceLimitRectangle)}};var Qt=class extends Pe{constructor(e,t,n){super(null);this.Padding=0;this.CornerFitRadius=0;this.BendPenaltyAsAPercentageOfDistance=0;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=t,this.CornerFitRadius=n,this.BendPenaltyAsAPercentageOfDistance=Gn.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new Nr,this.PortManager=new da(this.GraphGenerator),this.AddShapes(e)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(e){this.PortManager.RouteToCenterOfObstacles=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=e}AddEdgeGeometryToRoute(e){f.closeDistEps(C.RoundPoint(e.sourcePort.Location),C.RoundPoint(e.targetPort.Location))?this.selfEdges.push(e):this.EdgesToRoute.push(e)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof Nr}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(e=>e.PaddedPolyline)}AddObstacles(e){this.AddShapes(e),this.RebuildTreeAndGraph()}AddShapes(e){for(let t of e)this.AddObstacleWithoutRebuild(t)}AddObstacle(e){this.AddObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}UpdateObstacles(e){for(let t of e)this.UpdateObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}UpdateObstacle(e){this.UpdateObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}RemoveObstacles(e){for(let t of e)this.RemoveObstacleWithoutRebuild(t);this.RebuildTreeAndGraph()}RemoveObstacle(e){this.RemoveObstacleWithoutRebuild(e),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(e)}UpdateObstacleWithoutRebuild(e){if(e.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(e)),this.CreatePaddedObstacle(e)}CreatePaddedObstacle(e){let t=new yr(e,this.Padding);this.ShapeToObstacleMap.set(e,t),this.PortManager.CreateObstaclePorts(t)}RemoveObstacleWithoutRebuild(e){let t=this.ShapeToObstacleMap.get(e);this.ShapeToObstacleMap.delete(e),this.PortManager.RemoveObstaclePorts(t)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let e=this.ObsTree.Root!=null,t=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),e&&this.GenerateObstacleTree(),t&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return Qt.constructorC(null)}static constructorC(e){return new Qt([],Qt.DefaultPadding,Qt.DefaultCornerFitRadius)}static constructorI(e){return new Qt(e,Qt.DefaultPadding,Qt.DefaultCornerFitRadius)}static constructorINN(e,t,n){return new Qt(e,t,n)}static constructorGNAN(e,t,n,i){let o=new Qt(Or.GetShapes(e),n,i);if(t==null)for(let a of e.deepEdges)o.AddEdgeGeometryToRoute(a);else for(let a of t)o.AddEdgeGeometryToRoute(a);return o}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let e=this.EdgesToRoute.map(t=>new Cp(t));this.FillEdgePathsWithShortestPaths(e),this.NudgePaths(e),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let e of this.selfEdges){let t={smoothedPolyline:null};e.curve=be.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.Padding,2*e.GetMaxArrowheadLength()),t)}}FillEdgePathsWithShortestPaths(e){this.PortManager.BeginRouteEdges();let t=new aa(this.BendPenaltyAsAPercentageOfDistance);for(let n of e)this.AddControlPointsAndGeneratePath(t,n);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(e,t){let n=this.PortManager.GetPortVisibilityIntersection(t.GeomEdge);if(n!=null){this.GeneratePathThroughVisibilityIntersection(t,n);return}this.SpliceVisibilityAndGeneratePath(e,t)}GeneratePathThroughVisibilityIntersection(e,t){e.PathPoints=t}SpliceVisibilityAndGeneratePath(e,t){this.PortManager.AddControlPointsToGraph(t.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(e,t,!1)||this.RetryPathsWithAdditionalGroupsEnabled(e,t),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(e,t,n){let i=this.PortManager.FindVertices(t.GeomEdge.sourcePort),o=this.PortManager.FindVertices(t.GeomEdge.targetPort);return Qt.GetSingleStagePath(t,e,i,o,n)}static GetSingleStagePath(e,t,n,i,o){return e.PathPoints=t.GetPath(n,i),o&&Qt.EnsureNonNullPath(e),e.PathPoints!=null&&e.PathPoints.length>0}static EnsureNonNullPath(e){e.PathPoints==null&&(F.IsPureDirection(e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location)?e.PathPoints=[e.GeomEdge.sourcePort.Location,e.GeomEdge.targetPort.Location]:e.PathPoints=[e.GeomEdge.sourcePort.Location,new f(e.GeomEdge.sourcePort.Location.x,e.GeomEdge.targetPort.Location.y),e.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(e,t){(!this.PortManager.SetAllAncestorsActive(t.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(e,t,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(e,t,!0))}NudgePaths(e){let t=this.ObsTree.SpatialAncestorsAdjusted?Fe.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;it.NudgePaths(e,this.CornerFitRadius,this.PaddedObstacles,t,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(e){this.removeStaircases=e}FinaliseEdgeGeometries(){for(let e of this.EdgesToRoute.concat(this.selfEdges)){if(e.curve==null)continue;e.curve instanceof ee&&(e.curve=Qt.FitArcsIntoCorners(this.CornerFitRadius,Array.from(e.curve))),Qt.CalculateArrowheads(e)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(e){Ve.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=Fe.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(e){this.GraphGenerator.Clear(),this.ClearShortestPaths(),e?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let e of this.EdgesToRoute)e.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(e,t){let n=Qt.GetFittedArcSegs(e,t),i=new x,o=null;for(let a of n){let l=Qt.EllipseIsAlmostLineSegment(a);o!=null?l?x.continueWithLineSegmentP(i,Qt.CornerPoint(a)):(x.continueWithLineSegmentP(i,a.start),i.addSegment(a)):l?x.addLineSegment(i,t[0],Qt.CornerPoint(a)):(x.addLineSegment(i,t[0],a.start),i.addSegment(a)),o=a}return i.segs.length>0?x.continueWithLineSegmentP(i,t[t.length-1]):x.addLineSegment(i,t[0],t[t.length-1]),i}static CornerPoint(e){return e.center.add(e.aAxis.add(e.bAxis))}static EllipseIsAlmostLineSegment(e){return e.aAxis.lengthSquared<1e-4||e.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(e,t){let n=t[1].sub(t[0]),i=n.normalize(),o=Math.min(e,n.length/2);for(let a=1;a<t.length-1;a++){n=t[a+1].sub(t[a]);let l=n.length;if(l<C.intersectionEpsilon){yield new he(0,0,new f(0,0),new f(0,0),t[a]);continue}let u=n.div(l);Math.abs(u.dot(i))>.9&&(yield new he(0,0,new f(0,0),new f(0,0),t[a]));let c=Math.min(e,n.length/2),h=u.mul(-c),d=i.mul(o);yield new he(0,Math.PI/2,h,d,t[a].sub(d.add(h))),i=u,o=c}}},us=Qt;us.DefaultPadding=1,us.DefaultCornerFitRadius=3;var ec=class extends Pe{constructor(e,t,n){super(null);this.graph=e,this.source=t,this.length=n}get Result(){return this.result}run(){let e=new Pr((i,o)=>i-o),t=new Map;for(let i of this.graph.shallowNodes){let o=i===this.source?0:Number.POSITIVE_INFINITY;e.Enqueue(i,o),t.set(i,o)}for(;e.count>0;){let i={priority:0},o=e.DequeueAndGetPriority(i);t.set(o,i.priority);let a=t.get(o);for(let l of o.inEdges()){let u=l.source,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}for(let l of o.outEdges()){let u=l.target,c=a+this.length(l);t.get(u)>c&&(t.set(u,c),e.DecreasePriority(u,c))}}this.result=new Array(this.graph.shallowNodeCount);let n=0;for(let i of this.graph.shallowNodes){let o=t.get(i);o!==void 0?this.result[n++]=o:this.result[n++]=Number.POSITIVE_INFINITY}}};var tc=class extends Pe{get Result(){return this.result}set Result(e){this.result=e}constructor(e,t){super(null);this.graph=e,this.length=t}run(){this.result=new Array(this.graph.shallowNodeCount);let e=0;for(let t of this.graph.shallowNodes){let n=new ec(this.graph,t,this.length);n.run(),this.Result[e++]=n.Result}}static Stress(e,t){let n=0;if(e.edgeCount===0)return n;let i=new tc(e,t);i.run();let o=i.Result,a=0;for(let u of e.shallowEdges)a+=t(u);a/=e.edgeCount;let l=0;for(let u of e.shallowNodes){let c=0;for(let h of e.shallowNodes){if(l!==c){let d=u.center.sub(h.center).length,m=a*o[l][c],P=m-d;n+=P*P/(m*m)}c++}l++}return n}};var Rp=class extends Pe{get Result(){return this.result}constructor(e,t,n){super(null);this.graph=e,this.pivotArray=t,this.length=n}run(){this.result=new Array(this.pivotArray.length);let e=Array.from(this.graph.shallowNodes),t=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),n=e[0];this.pivotArray[0]=0;for(let i=0;;i++){let o=new ec(this.graph,n,this.length);if(o.run(),this.Result[i]=o.Result,i+1<this.pivotArray.length){let a=0;for(let l=0;l<this.Result[i].length;l++)t[l]=Math.min(t[l],this.Result[i][l]),t[l]>t[a]&&(a=l);n=e[a],this.pivotArray[i+1]=a}else break}}};var Bp=class{static Rotate(e,t,n){let i=Math.sin(n*(Math.PI/180)),o=Math.cos(n*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+i*t[a];t[a]=o*t[a]-i*e[a],e[a]=l}}};var rt=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),n=new Array(e[0].length).fill(0),i=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],n[a]+=e[o][a],i+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)n[o]/=e[0].length;i/=e.length,i/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+n[a]-i}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let n=0;n<e[0].length;n++)e[t][n]=Math.pow(e[t][n],2)}static Multiply(e,t){for(let n=0;n<e.length;n++)for(let i=0;i<e[0].length;i++)e[n][i]*=t}static MultiplyX(e,t){if(e[0].length!==t.length)return null;let n=new Array(t.length).fill(0);for(let i=0;i<e.length;i++)for(let o=0;o<e[0].length;o++)n[i]+=e[i][o]*t[o];return n}static Norm(e){let t=0;for(let n=0;n<e.length;n++)t+=Math.pow(e[n],2);return Math.sqrt(t)}static Normalize(e){let t=rt.Norm(e);if(t<=0)return 0;for(let n=0;n<e.length;n++)e[n]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let n=0;n<e;n++)t[n]=Oi();return rt.Normalize(t),t}static SpectralDecomposition(e,t){rt.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,n,i){let o=e[0].length;t.u1=rt.RandomUnitLengthVector(o),t.lambda1=0,t.u2=rt.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-i;for(let u=0;u<n&&a<l;u++){let c=rt.MultiplyX(e,t.u1),h=rt.MultiplyX(e,t.u2);t.lambda1=rt.Normalize(c),t.lambda2=rt.Normalize(h),rt.MakeOrthogonal(h,c),rt.Normalize(h),a=Math.min(rt.DotProduct(t.u1,c),rt.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!==t.length)return 0;let n=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i];return n}static MakeOrthogonal(e,t){if(e.length!==t.length)return;let n=rt.DotProduct(e,t)/rt.DotProduct(t,t);for(let i=0;i<e.length;i++)e[i]-=n*t[i]}static ClassicalScaling(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=e[i].slice();rt.SquareEntries(n),rt.DoubleCenter(n),rt.Multiply(n,-.5),rt.SpectralDecomposition(n,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let i=0;i<t.u1.length;i++)t.u1[i]*=t.lambda1,t.u2[i]*=t.lambda2}static DistanceScalingSubset(e,t,n,i,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]===0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!==d&&(c[h]+=i[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let m=0,P=0;for(let S=0;S<a;S++)if(d!==S){let v=Math.sqrt(Math.pow(t[u[d]]-t[S],2)+Math.pow(n[u[d]]-n[S],2));v>0&&(v=1/v),m+=i[d][S]*(t[S]+e[d][S]*(t[u[d]]-t[S])*v),P+=i[d][S]*(n[S]+e[d][S]*(n[u[d]]-n[S])*v)}t[u[d]]=m/c[d],n[u[d]]=P/c[d]}}static DistanceScaling(e,t,n,i,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!==c&&(l[u]+=i[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let m=0;m<a;m++)if(c!==m){let P=Math.sqrt(Math.pow(t[c]-t[m],2)+Math.pow(n[c]-n[m],2));P>0&&(P=1/P),h+=i[c][m]*(t[m]+e[c][m]*(t[c]-t[m])*P),d+=i[c][m]*(n[m]+e[c][m]*(n[c]-n[m])*P)}t[c]=h/l[c],n[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++){n[i]=new Array(e[i].length).fill(0);for(let o=0;o<e[i].length;o++)e[i][o]>0&&(n[i][o]=Math.pow(e[i][o],t))}return n}static EuclideanDistanceMatrix(e,t){let n=new Array(e.length);for(let i=0;i<e.length;i++){n[i]=new Array(e.length);for(let o=0;o<e.length;o++)n[i][o]=Math.sqrt(Math.pow(e[i]-e[o],2)+Math.pow(t[i]-t[o],2))}return n}static LandmarkClassicalScaling(e,t,n){let i=new Array(e.length);for(let l=0;l<e.length;l++){i[l]=new Array(e.length);for(let u=0;u<e.length;u++)i[l][u]=e[l][n[u]]}rt.SquareEntries(i);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=i[l][u];o[l]/=e.length}rt.DoubleCenter(i),rt.Multiply(i,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};rt.SpectralDecomposition(i,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<i.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var bS=Ae(Ut());var Np=class{constructor(e,t){this.constrained=!1;this.Capacity=1e6;He.AbovePP(e.point,t.point)===1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e===this.upperSite||e===this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle===e?this.cwTriangle:this.ccwTriangle}toString(){return bS.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite===e?this.lowerSite:this.upperSite}};var fa=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}static mkSO(e,t){let n=new fa(e);return n.Owner=t,n}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite===e)return t}return null}AddInEdge(e){this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let n=t.upperSite===this?t.CcwTriangle:t.CwTriangle;if(n==null){t=null;break}yield n,t=n.Edges.getItem(n.Edges.index(t)+2)}while(t!==e);if(t!==e){t=e;do{let n=t.upperSite===this?t.CwTriangle:t.CcwTriangle;if(n==null)break;yield n,t=n.Edges.getItem(n.Edges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var Mp=Ae(Ln());var To=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite===e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var Nd=class{has(e){return e===this.item0||e===this.item1||e===this.item2}index(e){return e===this.item0?0:e===this.item1?1:e===this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var ur=class{constructor(){this.Edges=new Nd;this.Sites=new Nd}containsPoint(e){return ur.PointLocationForTriangle(e,this)!==0}static PointLocationForTriangle(e,t){let n=!1;for(let i=0;i<3;i++){let o=f.signedDoubledTriangleArea(e,t.Sites.getItem(i).point,t.Sites.getItem(i+1).point);if(o<-C.distanceEpsilon)return 0;o<C.distanceEpsilon&&(n=!0)}return n?1:2}intersectsLine(e,t){if(ur.PointLocationForTriangle(e,this)!=0||ur.PointLocationForTriangle(t,this)!=0)return!0;for(let n of this.Edges)if(R.IntersectPPPP(e,t,n.lowerSite.point,n.upperSite.point))return!0;return!1}static mkSSSD(e,t,n,i){let o=f.getTriangleOrientation(e.point,t.point,n.point),a=new ur;switch(o){case 1:a.FillCcwTriangle(e,t,n,i);break;case 0:a.FillCcwTriangle(e,n,t,i);break;default:throw new Error}return a}static mkSED(e,t,n){let i=new ur;switch(f.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=i,i.Sites.setItem(0,t.upperSite),i.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=i,i.Sites.setItem(0,t.lowerSite),i.Sites.setItem(1,t.upperSite);break;default:throw new Error}return i.Edges.setItem(0,t),i.Sites.setItem(2,e),i.CreateEdge(1,n),i.CreateEdge(2,n),i}static mkSSSEE(e,t,n,i,o,a){let l=ur.mkSSSD(e,t,n,a);return l.Edges.setItem(0,i),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,i),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e===t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,n,i){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,n);for(let o=0;o<3;o++)this.CreateEdge(o,i)}CreateEdge(e,t){let n=this.Sites.getItem(e),i=this.Sites.getItem(e+1),o=t(n,i);this.Edges.setItem(e,o),this.BindEdgeToTriangle(n,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.Edges.getItem(t+1)}OppositeSite(e){let t=this.Edges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=z.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,n,i,o,a){let l=new ur;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,n),l.Edges.setItem(0,i),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,i),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var Gp=class{constructor(e,t,n,i,o){this.elementsToBeRemovedFromFront=new Array;this.removedTriangles=new Array;this.edge=e,this.triangles=t,this.front=n,this.leftPolygon=i,this.rightPolygon=o,this.a=e.upperSite,this.b=e.lowerSite}Run(){this.Init(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let e of this.elementsToBeRemovedFromFront)this.front.remove(e)}ProcessLeftFrontPiercedElement(){let e=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.LeftSite),e=this.front.previous(e);while(f.pointToTheLeftOfLine(e.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.LeftSite),e.item.LeftSite===this.b){this.piercedToTheLeftFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(e){var o;let t=e.item.Edge,n=(o=t.CcwTriangle)!=null?o:t.CwTriangle,i=n.Edges.index(t);for(let a=1;a<=2;a++){let l=n.Edges.getItem(a+i),u=On.sign(f.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(On.sign(f.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){this.piercedTriangle=n,this.piercedEdge=l;break}}}FindMoreRemovedFromFrontElements(){for(let e of this.removedTriangles)for(let t of e.Edges)if(t.CcwTriangle==null&&t.CwTriangle==null){let n=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite,i=zt.FindNodeInFrontBySite(this.front,n);i.item.Edge===t&&this.elementsToBeRemovedFromFront.push(i.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle===this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var n,i;let e=(n=this.piercedEdge.CwTriangle)!=null?n:this.piercedEdge.CcwTriangle,t=e.Edges.index(this.piercedEdge);for(let o=1;o<=2;o++){let a=e.Edges.getItem(o+t),l=On.sign(f.signedDoubledTriangleArea(a.lowerSite.point,this.a.point,this.b.point));if(On.sign(f.signedDoubledTriangleArea(a.upperSite.point,this.a.point,this.b.point))*l<=0){if(a.CwTriangle!=null&&a.CcwTriangle!=null){this.piercedTriangle=e,this.piercedEdge=a;break}this.piercedTriangle=null,this.piercedEdge=null;let c=a.upperSite.point.x<a.lowerSite.point.x?a.upperSite:a.lowerSite,h=zt.FindNodeInFrontBySite(this.front,c);c.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=h:this.piercedToTheRightFrontElemNode=h,this.removePiercedTriangle((i=a.CwTriangle)!=null?i:a.CcwTriangle);break}}}removePiercedTriangle(e){this.triangles.delete(e);for(let t of e.Edges)t.CwTriangle===e?t.CwTriangle=null:t.CcwTriangle=null,this.removedTriangles.push(e)}ProcessRightFrontPiercedElement(){let e=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToRightPolygon(e.item.RightSite),e=this.front.next(e);while(f.pointToTheRightOfLine(e.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(e.item),this.AddSiteToLeftPolygon(e.item.RightSite),e.item.RightSite===this.b){this.piercedToTheRightFrontElemNode=e;return}this.FindPiercedTriangle(e),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(e){this.AddSiteToPolygonWithCheck(e,this.leftPolygon)}AddSiteToPolygonWithCheck(e,t){e!==this.b&&(t.length===0||t[t.length-1]!==e)&&t.push(e)}AddSiteToRightPolygon(e){this.AddSiteToPolygonWithCheck(e,this.rightPolygon)}BIsReached(){var t;let e=(t=this.piercedToTheLeftFrontElemNode)!=null?t:this.piercedToTheRightFrontElemNode;return e!=null?e.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}Init(){let e=zt.FindNodeInFrontBySite(this.front,this.a),t=this.front.previous(e);if(f.pointToTheLeftOfLine(this.b.point,t.item.LeftSite.point,t.item.RightSite.point))this.piercedToTheLeftFrontElemNode=t;else if(f.pointToTheRightOfLine(this.b.point,e.item.RightSite.point,e.item.LeftSite.point))this.piercedToTheRightFrontElemNode=e;else for(let n of this.a.Edges){let i=n.CcwTriangle;if(i==null||f.pointToTheLeftOfLine(this.b.point,n.lowerSite.point,n.upperSite.point))continue;let o=i.Edges.index(n),a=i.Sites.getItem(o+2);if(f.pointToTheLeftOfLineOrOnLine(this.b.point,a.point,n.upperSite.point)){this.piercedEdge=i.Edges.getItem(o+1),this.piercedTriangle=i;break}}}};var rc=class{constructor(e,t,n,i){this.rightPolygon=new Array;this.leftPolygon=new Array;this.addedTriangles=new Array;this.edge=e,this.triangles=t,this.front=n,this.createEdgeDelegate=i}Run(){this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.edge.upperSite,this.edge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.edge.upperSite,this.edge.lowerSite,!1),this.UpdateFront()}UpdateFront(){let e=new Set;for(let t of this.addedTriangles)for(let n of t.Edges)(n.CwTriangle==null||n.CcwTriangle==null)&&e.add(n);for(let t of e)this.AddEdgeToFront(t)}AddEdgeToFront(e){let t=e.upperSite.point.x<e.lowerSite.point.x?e.upperSite:e.lowerSite;this.front.insert(new To(t,e))}TriangulatePolygon0(e,t,n,i){e.length>0&&this.TriangulatePolygon1(0,e.length-1,e,t,n,i)}TriangulatePolygon1(e,t,n,i,o,a){let l=n[e],u=e;for(let h=e+1;h<=t;h++){let d=n[h];rc.LocalInCircle(d,i,o,l,a)&&(u=h,l=d)}let c=ur.mkSSSD(i,o,l,this.createEdgeDelegate);this.triangles.add(c),this.addedTriangles.push(c),e<u&&this.TriangulatePolygon1(e,u-1,n,i,l,a),u<t&&this.TriangulatePolygon1(u+1,t,n,l,o,a)}static LocalInCircle(e,t,n,i,o){return o?Gd(e,t,i,n):Gd(e,t,n,i)}TraceEdgeThroughTriangles(){new Gp(this.edge,this.triangles,this.front,this.leftPolygon,this.rightPolygon).Run()}};var Md=class{constructor(e){this.Edge=e}};var zt=class extends Pe{constructor(e,t,n,i){super(null);this.front=new dt((e,t)=>e.x-t.x);this.triangles=new Set;if(this.listOfSites=e,this.listOfSites.length===0)return;this.p_1=t,this.p_2=n,this.createEdgeDelegate=i;let o=ur.mkSSSD(t,n,this.listOfSites[0],i);this.triangles.add(o),this.front.insert(new To(t,o.Edges.getItem(2))),this.front.insert(new To(this.listOfSites[0],o.Edges.getItem(1)))}run(){if(this.listOfSites.length!==0){for(let e=1;e<this.listOfSites.length;e++)this.ProcessSite(this.listOfSites[e]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let e=this.CreateDoubleLinkedListOfPerimeter();do{let t=this.FindConcaveEdge(e);if(t==null)return;e=this.ShortcutTwoListElements(t)}while(!0)}FindConcaveEdge(e){let t=e,n;do{if(n=t.Next,f.getTriangleOrientation(t.Start.point,t.End.point,n.End.point)===1)return t;t=n}while(n!==e);return null}static FindPivot(e){let t=e,n=e;do n=n.Next,(n.Start.point.x<t.Start.point.x||n.Start.point.x===t.Start.point.x&&n.Start.point.y<t.Start.point.y)&&(t=n);while(n!==e);return t}FindFirsePerimeterEdge(){for(let e of this.triangles)for(let t of e.Edges)if(t.GetOtherTriangle_T(e)==null)return t;return null}CreateDoubleLinkedListOfPerimeter(){let e=this.FindFirsePerimeterEdge(),t=e,n=null,i,o=null,a=new Array;do i=zt.CreatePerimeterElementFromEdge(t),a.push(R.mkPP(i.Start.point,i.End.point)),t=zt.FindNextEdgeOnPerimeter(t),o!=null?(i.Prev=o,o.Next=i):n=i,o=i;while(t!==e);return n.Prev=i,i.Next=n,n}static FindNextEdgeOnPerimeter(e){var n;let t=(n=e.CwTriangle)!=null?n:e.CcwTriangle;for(e=t.Edges.getItem(t.Edges.index(e)+2);e.CwTriangle!=null&&e.CcwTriangle!=null;)t=e.GetOtherTriangle_T(t),e=t.Edges.getItem(t.Edges.index(e)+2);return e}static CreatePerimeterElementFromEdge(e){let t=new Md(e);return e.CwTriangle!=null?(t.Start=e.upperSite,t.End=e.lowerSite):(t.End=e.upperSite,t.Start=e.lowerSite),t}RemoveP1AndP2Triangles(){let e=new Set;for(let t of this.triangles)(t.Sites.has(this.p_1)||t.Sites.has(this.p_2))&&e.add(t);for(let t of e)zt.RemoveTriangleWithEdges(this.triangles,t)}static RemoveTriangleWithEdges(e,t){e.delete(t);for(let n of t.Edges)n.CwTriangle===t?n.CwTriangle=null:n.CcwTriangle=null,n.CwTriangle==null&&n.CcwTriangle==null&&Dp(n.upperSite.Edges,n)}static RemoveTriangleButLeaveEdges(e,t){e.delete(t);for(let n of t.Edges)n.CwTriangle===t?n.CwTriangle=null:n.CcwTriangle=null}ProcessSite(e){this.PointEvent(e);for(let t=0;t<e.Edges.length;t++){let n=e.Edges[t];n.constrained&&this.EdgeEvent(n)}}EdgeEvent(e){if(zt.EdgeIsProcessed(e))return;new rc(e,this.triangles,this.front,this.createEdgeDelegate).Run()}static EdgeIsProcessed(e){return e.CwTriangle!=null||e.CcwTriangle!=null}ShowFrontWithSite(e,t=null){let n=new Array;if(e.Edges!=null)for(let i of e.Edges)n.push(fe.mkDebugCurveTWCI(200,.8,i.constrained?"Pink":"Brown",R.mkPP(i.upperSite.point,i.lowerSite.point)));n.push(fe.mkDebugCurveTWCI(200,1,"Brown",he.mkFullEllipseNNP(.5,.5,e.point)));for(let i of this.triangles)for(let o=0;o<3;o++){let a=i.Edges.getItem(o);n.push(fe.mkDebugCurveTWCI(a.constrained?155:100,a.constrained?.8:.4,a.constrained?"Pink":"Navy",R.mkPP(a.upperSite.point,a.lowerSite.point)))}if(t!=null)for(let i of t)n.push(fe.mkDebugCurveTWCI(100,.5,"Red",i));for(let i of this.front)n.push(fe.mkDebugCurveTWCI(100,5.5,"Green",R.mkPP(i.Edge.upperSite.point,i.Edge.lowerSite.point)))}Show(e){zt.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],e)}static ShowCdt(e,t,n,i,o,a){let l=new Array;if(n!=null)for(let u of n)l.push(fe.mkDebugCurveTWCI(200,.1,"Red",u));if(i!=null)for(let u of i)l.push(fe.mkDebugCurveTWCI(200,.1,"Blue",u));if(t!=null)for(let u of t)l.push(fe.mkDebugCurveTWCI(200,.1,"Green",R.mkPP(u.Edge.upperSite.point,u.Edge.lowerSite.point)));for(let u of e)for(let c=0;c<3;c++){let h=u.Edges.getItem(c);l.push(zt.GetDebugCurveOfCdtEdge(h))}l=l.concat(o)}static GetDebugCurveOfCdtEdge(e){return e.CcwTriangle==null||e.CwTriangle==null?fe.mkDebugCurveTWCI(255,.5,e.constrained?"Brown":"Black",R.mkPP(e.upperSite.point,e.lowerSite.point)):fe.mkDebugCurveTWCI(200,e.constrained?.8:.2,e.constrained?"Pink":"Navy",R.mkPP(e.upperSite.point,e.lowerSite.point))}PointEvent(e){let t=this.ProjectToFront(e),n={rightSite:null},i=t.item.x+C.distanceEpsilon<e.point.x?this.MiddleCase(e,t,n):this.LeftCase(e,t,n),o=this.InsertSiteIntoFront(i,e,n.rightSite);this.TriangulateEmptySpaceToTheRight(o),o=zt.FindNodeInFrontBySite(this.front,i),this.TriangulateEmptySpaceToTheLeft(o)}LeftCase(e,t,n){let i=t.item;this.InsertAndLegalizeTriangle(e,i);let o=this.front.previous(t),a=o.item.LeftSite;n.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,o.item),this.front.deleteNodeInternal(o);let l=this.front.remove(i);return a}MiddleCase(e,t,n){let i=t.item.LeftSite;return n.rightSite=t.item.RightSite,this.InsertAndLegalizeTriangle(e,t.item),this.front.deleteNodeInternal(t),i}TriangulateEmptySpaceToTheLeft(e){let t=e.item.RightSite,n=this.front.previous(e);for(;n!=null;){let i=n.item,o=i.LeftSite,a=i.RightSite;if(a.point.sub(t.point).dot(o.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(n,e),n=this.front.previous(e);else{this.TryTriangulateBasinToTheLeft(e);break}}}ShortcutTwoListElements(e){var a;let t=e.Next,n=ur.mkSSSEE(e.Start,e.End,t.End,e.Edge,t.Edge,this.createEdgeDelegate);this.triangles.add(n);let i=n.Edges.getItem(2);this.LegalizeEdge(e.Start,n.OppositeEdge(e.Start)),n=(a=i.CcwTriangle)!=null?a:i.CwTriangle,this.LegalizeEdge(t.End,n.OppositeEdge(t.End));let o=new Md(i);return o.Start=e.Start,o.End=t.End,e.Prev.Next=o,o.Prev=e.Prev,o.Next=t.Next,t.Next.Prev=o,o}ShortcutTwoFrontElements(e,t){var l;let n=e.item,i=t.item,o=ur.mkSSSEED(n.LeftSite,n.RightSite,i.RightSite,n.Edge,i.Edge,this.createEdgeDelegate);this.triangles.add(o),this.front.deleteNodeInternal(e),this.front.remove(i);let a=o.Edges.getItem(2);return this.LegalizeEdge(n.LeftSite,o.OppositeEdge(n.LeftSite)),o=(l=a.CcwTriangle)!=null?l:a.CwTriangle,this.LegalizeEdge(i.RightSite,o.OppositeEdge(i.RightSite)),this.front.insert(new To(n.LeftSite,a))}TryTriangulateBasinToTheLeft(e){if(!zt.DropsSharpEnoughToTheLeft(e.item))return;let t=new Mp.Stack;for(t.push(e.item.LeftSite);;){let n=t.pop();e=zt.FindNodeInFrontBySite(this.front,n);let i=this.front.previous(e);if(i==null)return;if(f.getTriangleOrientation(i.item.LeftSite.point,e.item.LeftSite.point,e.item.RightSite.point)==1)t.push(i.item.LeftSite),this.ShortcutTwoFrontElements(i,e);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(i.item.LeftSite);else{if(i.item.LeftSite.point.y<=i.item.RightSite.point.y)return;t.push(i.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(e){let t=e.Edge;if(e.RightSite!==t.upperSite)return!1;let n=t.lowerSite.point.sub(t.upperSite.point);return n.x>=.5*n.y}InsertSiteIntoFront(e,t,n){let i=null,o=null;for(let a of t.Edges)if(o==null&&a.lowerSite===e&&(o=a),i==null&&a.lowerSite===n&&(i=a),o!=null&&i!=null)break;return this.front.insert(new To(e,o)),this.front.insert(new To(t,i))}TriangulateEmptySpaceToTheRight(e){let n=e.item.LeftSite.point,i=this.front.next(e);for(;i!=null;){let o=i.item,a=o.LeftSite,l=o.RightSite;if(a.point.sub(n).dot(l.point.sub(a.point))<0)e=this.ShortcutTwoFrontElements(e,i),i=this.front.next(e);else{this.TryTriangulateBasinToTheRight(e);break}}}TryTriangulateBasinToTheRight(e){if(!zt.DropsSharpEnoughToTheRight(e.item))return;let t=new Mp.Stack;for(t.push(e.item.LeftSite);;){let n=t.pop();e=zt.FindNodeInFrontBySite(this.front,n);let i=this.front.next(e);if(i==null)return;if(f.getTriangleOrientation(e.item.LeftSite.point,e.item.RightSite.point,i.item.RightSite.point)==1)this.ShortcutTwoFrontElements(e,i),t.push(n);else if(e.item.LeftSite.point.y>e.item.RightSite.point.y)t.push(e.item.RightSite);else{if(i.item.LeftSite.point.y>=i.item.RightSite.point.y)return;t.push(e.item.RightSite)}}}static DropsSharpEnoughToTheRight(e){let t=e.Edge;if(e.LeftSite!==t.upperSite)return!1;let n=t.lowerSite.point.sub(t.upperSite.point);return n.x<=-.5*n.y}static FindNodeInFrontBySite(e,t){return e.findLast(n=>n.LeftSite.point.x<=t.point.x)}InsertAndLegalizeTriangle(e,t){var n;if(f.getTriangleOrientation(e.point,t.LeftSite.point,t.RightSite.point)!==2){let i=ur.mkSED(e,t.Edge,this.createEdgeDelegate);this.triangles.add(i),this.LegalizeEdge(e,i.Edges.getItem(0))}else{let i=t.Edge;Dp(i.upperSite.Edges,i);let o=(n=i.CcwTriangle)!=null?n:i.CwTriangle,a=o.OppositeSite(i);zt.RemoveTriangleButLeaveEdges(this.triangles,o),o=ur.mkSSSD(t.LeftSite,a,e,this.createEdgeDelegate);let l=ur.mkSSSD(t.RightSite,a,e,this.createEdgeDelegate);this.triangles.add(o),this.triangles.add(l),this.LegalizeEdge(e,o.OppositeEdge(e)),this.LegalizeEdge(e,l.OppositeEdge(e))}}LegalizeEdge(e,t){t.constrained||t.CcwTriangle==null||t.CwTriangle==null||(t.CcwTriangle.Contains(e)?this.LegalizeEdgeForOtherCwTriangle(e,t):this.LegalizeEdgeForOtherCcwTriangle(e,t))}LegalizeEdgeForOtherCwTriangle(e,t){let n=t.CwTriangle.Edges.index(t);if(PS(e,t.upperSite,t.CwTriangle.Sites.getItem(n+2),t.lowerSite)){let i=yS(e,t);this.LegalizeEdge(e,i.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,i.CcwTriangle.OppositeEdge(e))}}LegalizeEdgeForOtherCcwTriangle(e,t){let n=t.CcwTriangle.Edges.index(t);if(PS(e,t.lowerSite,t.CcwTriangle.Sites.getItem(n+2),t.upperSite)){let i=yS(e,t);this.LegalizeEdge(e,i.CwTriangle.OppositeEdge(e)),this.LegalizeEdge(e,i.CcwTriangle.OppositeEdge(e))}}ProjectToFront(e){return this.front.findLast(t=>t.x<=e.point.x)}};function Dp(s,e){if(s.length===0)return;let t=s.findIndex(n=>e===n);t>=0&&(t!==s.length-1&&(s[t]=s[s.length-1]),s.pop())}function PS(s,e,t,n){return GI(s,e,t,n)&&Gd(s,e,t,n)}function GI(s,e,t,n){return f.getTriangleOrientation(e.point,s.point,t.point)===0&&f.getTriangleOrientation(t.point,s.point,n.point)===0}function Gd(s,e,t,n){let i=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=n.point.x-s.point.x,c=n.point.y-s.point.y,h=i*i+o*o,d=a*a+l*l,m=u*u+c*c;return i*(l*m-c*d)-a*(o*m-c*h)+u*(o*d-l*h)>C.tolerance}function yS(s,e){let t,n;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,n=e.CwTriangle):(t=e.CwTriangle,n=e.CcwTriangle);let i=t.Edges.index(e),o=n.Edges.index(e),a=n.Sites.getItem(o+2),l=t.Edges.getItem(i+1),u=n.Edges.getItem(o+1),c=He.GetOrCreateEdge(s,a);return t.Sites.setItem(i+1,a),t.Edges.setItem(i,u),t.Edges.setItem(i+1,c),n.Sites.setItem(o+1,s),n.Edges.setItem(o,l),n.Edges.setItem(o+1,c),u.lowerSite===a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite===s?l.CcwTriangle=n:l.CwTriangle=n,c.upperSite===s?(c.CcwTriangle=n,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=n),Dp(e.upperSite.Edges,e),c}var He=class extends Pe{constructor(e,t,n){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new pt;this.rectangleNodeOnTriangles=null;this.isolatedSites=e,this.obstacles=t,this.isolatedSegments=n}static constructor_(e){let t=new He(null,null,null);return t.isolatedSitesWithObject=e,t}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let e of this.isolatedSitesWithObject)this.AddSite(e[0],e[1]);if(this.isolatedSites!=null)for(let e of this.isolatedSites)this.AddSite(e,null);if(this.obstacles!=null)for(let e of this.obstacles)this.AddPolylineToAllInputSites(e);if(this.isolatedSegments!=null)for(let e of this.isolatedSegments)this.AddConstrainedEdge(e.A,e.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(e,t){let n;return(n=this.PointsToSites.get(e))?n.Owner=t:(n=fa.mkSO(e,t),this.PointsToSites.set(e,n)),n}AddP1AndP2(){let e=z.mkEmpty();for(let i of this.PointsToSites.keys())e.add(i);let t=Math.max(e.width/3,1),n=Math.max(e.height/3,1);this.P1=new fa(e.leftBottom.add(new f(-t,-n))),this.P2=new fa(e.rightBottom.add(new f(t,-n)))}AddPolylineToAllInputSites(e){for(let t=e.startPoint;t.next!=null;t=t.next)this.AddConstrainedEdge(t.point,t.next.point,e);e.closed&&this.AddConstrainedEdge(e.endPoint.point,e.startPoint.point,e)}AddConstrainedEdge(e,t,n){let i=He.AbovePP(e,t),o,a;i>0?(o=this.AddSite(e,n),a=this.AddSite(t,n)):(o=this.AddSite(t,n),a=this.AddSite(e,n));let l=He.CreateEdgeOnOrderedCouple(o,a);l.constrained=!0}static GetOrCreateEdge(e,t){if(He.AboveCC(e,t)===1){let n=e.EdgeBetweenUpperSiteAndLowerSite(t);return n!=null?n:He.CreateEdgeOnOrderedCouple(e,t)}else{let n=t.EdgeBetweenUpperSiteAndLowerSite(e);return n!=null?n:He.CreateEdgeOnOrderedCouple(t,e)}}static CreateEdgeOnOrderedCouple(e,t){return new Np(e,t)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new zt(this.allInputSites,this.P1,this.P2,He.GetOrCreateEdge),this.sweeper.run()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(He.OnComparison)}static OnComparison(e,t){return He.AboveCC(e,t)}static AbovePP(e,t){let n=e.y-t.y;return n>0?1:n<0?-1:(n=e.x-t.x,n>0?-1:n<0?1:0)}static AboveCC(e,t){return He.AbovePP(e.point,t.point)}RestoreEdgeCapacities(){for(let e of this.allInputSites)for(let t of e.Edges)t.constrained||(t.ResidualCapacity=t.Capacity)}SetInEdges(){for(let e of this.PointsToSites.values())for(let t of e.Edges)t.lowerSite.AddInEdge(t)}FindSite(e){return this.PointsToSites.get(e)}static PointIsInsideOfTriangle(e,t){for(let n=0;n<3;n++){let i=t.Sites.getItem(n).point,o=t.Sites.getItem(n+1).point;if(f.signedDoubledTriangleArea(e,i,o)<C.distanceEpsilon*-1)return!1}return!0}getRectangleNodeOnTriangles(){return this.rectangleNodeOnTriangles==null&&(this.rectangleNodeOnTriangles=Ke(Array.from(this.GetTriangles().values()).map(e=>st(e,e.BoundingBox())))),this.rectangleNodeOnTriangles}EdgeIsCorrect(e){let t=e.upperSite,n=!1;for(let o of t.Edges)if(o===e){n=!0;break}return n?this.PointsToSites.get(t.point)===t:!1}};function Dd(s){let e=Array.from(s.GetAllLeaves()),t=s.irect,n=t.diagonal/4,i=t.clone();return i.pad(n),MI(e.concat([i.perimeter()]))}function MI(s){let e=new He(null,s,null);return e.run(),e}var ga=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,n=this.clone();return n.add_d(t.start),n.add_d(t.end),n}clone(){return new ga(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new ga(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let n=new ga(e.start,e.end);return n.add_d(t.start),n.add_d(t.end),n}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+C.distanceEpsilon?!1:!(e.end<this.start-C.distanceEpsilon)}};var nc=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let n=this.heapSize;for(this._priors[e]=t,this.PutAtI(n,e);n>1&&this._priors[this._heap[n>>1]]>t;)this.SwapWithParent(n),n>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize===0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let n=t,i=t<<1;i<=this.heapSize&&this._priors[this._heap[i]]<this._priors[this._heap[t]]&&(n=i);let o=i+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[n]]&&(n=o),n!==t)this.SwapWithParent(n);else break;t=n}}return this.heapSize--,e}IsEmpty(){return this.heapSize===0}DecreasePriority(e,t){this._priors[e]=t;let n=this._reverse_heap[e];for(;n>1&&this._priors[this._heap[n]]<this._priors[this._heap[n>>1]];){this.SwapWithParent(n);n>>=1}}};var Fp=class{constructor(e,t,n,i){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=n,this._forLayers=i,this._q=new nc(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=vi([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let n of this._intervalTree.GetAllIntersecting(t)){let i=Kr.GetIdealEdge(e,n,this._nodePositions[e],this._nodePositions[n],this._nodeSizes);if(i.overlapFactor<=1)return;this._proximityEdges.push(i),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,n=this._nodePositions[e].x;return new ga(n-t,n+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,n=this._nodePositions[e].y;this._q.Enqueue(e,n-t),this._q.Enqueue(this._nodeSizes.length+e,n+t)}}};var Fd=class{constructor(e,t,n){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=n,this.q=new nc(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),n=this.hedgehog.get(t);this.treeNodes.add(t),e.push(n),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let n=t.target;if(this.NodeIsInTree(n))continue;let i=this.hedgehog.get(n);if(i){let o=this.weight(i),a=this.weight(t);a<o&&(this.q.DecreasePriority(n,a),this.hedgehog.set(n,t))}else this.q.Enqueue(n,this.weight(t)),this.hedgehog.set(n,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let n=t.source;if(this.NodeIsInTree(n))continue;let i=this.hedgehog.get(n);if(i){let o=this.weight(i),a=this.weight(t);a<o&&(this.q.DecreasePriority(n,a),this.hedgehog.set(n,t))}else this.q.Enqueue(n,this.weight(t)),this.hedgehog.set(n,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var ic=class{static GetMst(e,t){if(e.length===0)return null;let n=e.map(u=>new ye(u.source,u.target)),i=n.reduce((u,c)=>Math.max(u,Math.max(c.x,c.y)),0),o=new mn(i+1);for(let u=0;u<e.length;u++)o.setPair(n[u],e[u]);let a=rr(n,t);return new Fd(a,u=>o.get(u.source,u.target).weight,n[0].source).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetMstOnCdt(e,t){let n=Array.from(e.PointsToSites.values()),i=new Map;for(let u=0;u<n.length;u++)i.set(n[u],u);let o=ic.GetEdges(n,i),a=Jh(Array.from(o.keys()));return new Fd(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let n=new mn(e.length);for(let i=0;i<e.length;i++){let o=e[i],a=t.get(o);for(let l of o.Edges)n.set(a,t.get(l.lowerSite),l)}return n}};var oc=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizeAllPointsOnStart=!1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizeAllPointsOnStart(){return this.randomizeAllPointsOnStart}set RandomizeAllPointsOnStart(e){this.randomizeAllPointsOnStart=e}Clone(){let e=new oc;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizeAllPointsOnStart=this.randomizeAllPointsOnStart,e}};var Kr=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let n=new oc;n.RandomizeAllPointsOnStart=!0,n.NodeSeparation=t,new Kr(n,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(DI(this._settings,this._nodes,e,this._settings.randomizeAllPointsOnStart),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!==1&&this._nodes.length===2){let e=this._nodes[0],t=this._nodes[1];f.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new f(.001,0)));let n=this.GetIdealDistanceBetweenTwoNodes(e,t),i=f.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(n/a)),e.center=i.add(o),t.center=i.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let n=e.center.sub(t.center),i=Math.abs(n.x),o=Math.abs(n.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return i>C.tolerance&&(u=a/i),o>C.tolerance&&(c=l/o),Math.min(u,c)*n.length}static AvgEdgeLength(e){let t=0,n=0;for(let i of e)for(let o of i.outEdges())n+=i.center.sub(o.target.center).length,t++;return t>0?n/t:1}OneIteration(e,t,n){let i=new Array;for(let h=0;h<e.length;h++)i.push([e[h],h]);let o=He.constructor_(i);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let m=d.upperSite.point,P=d.lowerSite.point,S=a.get(d.upperSite),v=a.get(d.lowerSite),I=Kr.GetIdealEdge(S,v,m,P,t);u.push(I),I.overlapFactor>1&&l++}if(l===0||n){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l===0&&h===0||l===0&&!n)return!1}let c=ic.GetMst(u,e.length);return Kr.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,n){return new Fp(e,t,n,this._overlapForLayers).Run()}static GetIdealEdge(e,t,n,i,o){let a={overlapFactor:0},l=Kr.GetIdealEdgeLength(e,t,n,i,o,a),u=n.sub(i).length,c=z.mkSizeCenter(o[e],n),h=z.mkSizeCenter(o[t],i),d=a.overlapFactor>1?u-l:Kr.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,n,i,o,a){let l=n.sub(i),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,m=(o[e].height+o[t].height)/2;if(c>=d||h>=m)return a.overlapFactor=1,l.length;let P,S=1e-10;if(c>S)h>S?P=Math.min(d/c,m/h):P=d/c;else if(h>S)P=m/h;else return a.overlapFactor=2,Math.sqrt(d*d+m*m)/4;return P=Math.max(P,1.001),a.overlapFactor=P,P*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let n=0,i=0;return(e.right<t.left||t.right<e.left)&&(i=e.left-t.right),e.top<t.bottom?n=t.bottom-e.top:t.top<e.bottom&&(n=e.bottom-t.top),Math.sqrt(i*i+n*n)}static MoveNodePositions(e,t,n){let i=t.map(a=>a.clone()),o=new Set;o.add(n);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?Kr.MoveNode(l.source,l.target,i,t,o,l.idealDistance):Kr.MoveNode(l.target,l.source,i,t,o,l.idealDistance)}}static MoveNode(e,t,n,i,o,a){let l=n[t].sub(n[e]);l=l.mul(a/l.length+.01),i[t]=i[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function DI(s,e,t,n){t.nodePositions=e.map(i=>i.center),FI(t.nodePositions,new js(0,0),.01,n),t.nodeSizes=e.map(i=>{let o=i.boundingBox.size;return o.width+=s.NodeSeparation,o.height+=s.NodeSeparation,o})}function FI(s,e,t,n){let i=new We;for(let o=0;o<s.length;o++){let a=s[o];if(n||i.has(a))do{let l=a.x+(2*e.random()-1)*t,u=a.y+(2*e.random()-1)*t;a=new f(l,u)}while(i.has(a));s[o]=a,i.add(a)}}var cs=class extends Pe{constructor(e,t,n,i){super(n);this.settings=e,this.graph=t,this.length=i}run(){this.LayoutConnectedGraphWithMds(),this.graph.pumpTheBoxToTheGraphWithMargins()}static ScaleToAverageEdgeLength(e,t,n,i){let o=new Map,a=0;for(let c of e.shallowNodes)o.set(c,a),a++;let l=0,u=0;for(let c of e.shallowEdges){let h=o.get(c.source),d=o.get(c.target);u+=Math.sqrt(Math.pow(t[h]-t[d],2)+Math.pow(n[h]-n[d],2)),l+=i(c)}if(l>0&&(u/=l),u>0)for(let c=0;c<t.length;c++)t[c]/=u,n[c]/=u}static LayoutGraphWithMds(e,t,n,i){if(n.x=new Array(e.shallowNodeCount),n.y=new Array(e.shallowNodeCount),n.x.length===0)return;if(n.x.length===1){n.x[0]=n.y[0]=0;return}let o=Math.min(t.PivotNumber,e.shallowNodeCount),a=t.GetNumberOfIterationsWithMajorization(e.shallowNodeCount),l=t.Exponent,u=new Array(o),c=new Rp(e,u,i);c.run();let h=c.Result;if(rt.LandmarkClassicalScaling(h,n,u),cs.ScaleToAverageEdgeLength(e,n.x,n.y,i),a>0){let d=new tc(e,i);d.run();let m=d.Result,P=rt.ExponentialWeightMatrix(m,l);rt.DistanceScalingSubset(m,n.x,n.y,P,a)}}LayoutConnectedGraphWithMds(){let e={x:[],y:[]};cs.LayoutGraphWithMds(this.graph,this.settings,e,this.length),this.settings.RotationAngle!==0&&Bp.Rotate(e.x,e.y,this.settings.RotationAngle);let t=0;for(let n of this.graph.shallowNodes)n.boundingBox&&(n.center=new f(e.x[t]*this.settings.ScaleX,e.y[t]*this.settings.ScaleY)),t++;this.settings.removeOverlaps&&Kr.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins()}ScaleNodes(e,t){for(let n of e)n.center=n.center.mul(t)}static PackGraphs(e,t){if(e.length===0)return z.mkEmpty();if(e.length===1)return e[0].boundingBox;let n=e.map(a=>a.boundingBox),i=new Array;for(let a of e)i.push({g:a,lb:a.boundingBox.leftBottom.clone()});let o=new Mu(n,t.PackingAspectRatio);o.run();for(let{g:a,lb:l}of i){let u=a.boundingBox.leftBottom.sub(l);a.translate(u)}return new z({left:0,bottom:0,right:o.PackedWidth,top:o.PackedHeight})}};var Dn=class{constructor(){this.commonSettings=new Ii;this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=200;this.scaleY=200;this.exponent=-2;this.rotationAngle=0;this._removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=2e3;this.adjustScale=!1}static fromJSON(e){let t=new Dn;return e.pivotNumber&&(t.pivotNumber=e.pivotNumber),e.iterationsWithMajorization&&(t.iterationsWithMajorization=e.iterationsWithMajorization),e.scaleX&&(t.scaleX=e.scaleX),e.scaleY&&(t.scaleY=e.scaleY),e.exponent&&(t.exponent=e.exponent),e.rotationAngle&&(t.rotationAngle=e.rotationAngle),e.removeOverlaps!=null&&(t._removeOverlaps=e.removeOverlaps),e._callIterationsWithMajorizationThreshold&&(t._callIterationsWithMajorizationThreshold=e._callIterationsWithMajorizationThreshold),t}toJSON(){let e={};return this.pivotNumber!=50&&(e.pivotNumber=this.pivotNumber),this.iterationsWithMajorization!=30&&(e.iterationsWithMajorization=this.iterationsWithMajorization),this.scaleX!=200&&(e.scaleX=this.scaleX),this.scaleY!=200&&(e.scaleY=this.scaleY),this.exponent!=-2&&(e.exponent=this.exponent),this.rotationAngle!=0&&(e.rotationAngle=this.rotationAngle),this._removeOverlaps||(e.removeOverlaps=this._removeOverlaps),this._callIterationsWithMajorizationThreshold!=3e3&&(e._callIterationsWithMajorizationThreshold=this._callIterationsWithMajorizationThreshold),e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get removeOverlaps(){return this._removeOverlaps}set removeOverlaps(e){this._removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var sc=class extends Pe{get scaleX(){return this.settings.ScaleX}set scaleX(e){this.settings.ScaleX=e}get scaleY(){return this.settings.ScaleY}set scaleY(e){this.settings.ScaleY=e}constructor(e,t,n,i){super(t);this.graph=e,this.length=n,this.settings=i,this.settings.ScaleX=this.settings.ScaleY=200}run(){new cs(this.settings,this.graph,this.cancelToken,this.length).run()}};function _d(s,e,t){if(e)for(let n of e){if(t&&t.canceled)return;cr.RouteEdge(n,s.padding)}else for(let n of s.nodesBreadthFirst){if(t&&t.canceled)return;for(let i of n.outEdges())i.curve==null&&cr.RouteEdge(i,s.padding);for(let i of n.selfEdges())i.curve==null&&cr.RouteEdge(i,s.padding)}}var cr=class extends Pe{constructor(e,t){super(null);this.edges=e,this.padding=t}run(){Fe.CreatePortsIfNeeded(this.edges);for(let e of this.edges)cr.RouteEdge(e,this.padding)}static RouteEdge(e,t){let n=e;n.sourcePort==null&&(n.sourcePort=or.mk(()=>e.source.boundaryCurve,()=>e.source.center)),n.targetPort==null&&(n.targetPort=or.mk(()=>e.target.boundaryCurve,()=>e.target.center)),cr.ContainmentLoop(n,t)||(n.curve=cr.GetEdgeLine(e)),Ve.trimSplineAndCalculateArrowheadsII(n,n.sourcePort.Curve,n.targetPort.Curve,e.curve,!1)}static ContainmentLoop(e,t){let n=e.sourcePort.Curve,i=e.targetPort.Curve;if(n==null||i==null)return!1;let o=n.boundingBox,a=i.boundingBox,l=o.containsRect(a),u=!l&&a.containsRect(o);return l||u?(e.curve=cr.CreateLoop(o,a,u,t),!0):!1}static CreateLoop(e,t,n,i){return n?cr.CreateLoop_(e,t,i,!1):cr.CreateLoop_(t,e,i,!0)}static CreateLoop_(e,t,n,i){let o=e.center,a=cr.FindClosestPointOnBoxBoundary(e.center,t),l=a.sub(o),c=(Math.abs(l.x)<C.distanceEpsilon?Math.min(o.y-t.bottom,t.top-o.y):Math.min(o.x-t.left,t.right-o.x))/2,h=Math.min(n,c);l.length<=C.distanceEpsilon&&(l=new f(1,0));let d=l.normalize(),m=d.rotate(Math.PI/2),P=a.add(d.mul(n)),S=P.add(m.mul(h)),v=a.add(m.mul(h)),I=o.add(m.mul(h));return(i?Ue.mkFromPoints([I,v,S,P,a,o]):Ue.mkFromPoints([o,a,P,S,v,I])).createCurve()}static FindClosestPointOnBoxBoundary(e,t){let n=e.x-t.left<t.right-e.x?t.left:t.right,i=e.y-t.bottom<t.top-e.y?t.bottom:t.top;return Math.abs(n-e.x)<Math.abs(i-e.y)?new f(n,e.y):new f(e.x,i)}static GetEdgeLine(e){let t,n;e.sourcePort==null?(t=e.source.center,n=e.source.boundaryCurve):(t=e.sourcePort.Location,n=e.sourcePort.Curve);let i,o;e.targetPort==null?(i=e.target.center,o=e.target.boundaryCurve):(i=e.targetPort.Location,o=e.targetPort.Curve);let a=R.mkPP(t,i),l=x.getAllIntersections(n,a,!1);if(l.length>0){let u=a.trim(l[0].par1,1);u instanceof R&&(a=u,l=x.getAllIntersections(o,a,!1),l.length>0&&(u=a.trim(0,l[0].par1),u instanceof R&&(a=u)))}return a}static CreateSimpleEdgeCurveWithUnderlyingPolyline(e){let t=e.sourcePort?e.sourcePort.Location:e.source.center,n=e.targetPort?e.targetPort.Location:e.target.center;if(e.source===e.target){let i=2/(3*e.source.boundaryCurve.boundingBox.width),o=e.source.boundingBox.height/4;e.smoothedPolyline=cr.CreateUnderlyingPolylineForSelfEdge(t,i,o),e.curve=e.smoothedPolyline.createCurve()}else e.smoothedPolyline=Ue.mkFromPoints([t,n]),e.curve=e.smoothedPolyline.createCurve();Ve.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(e,t,n){let i=e.add(new f(0,n)),o=e.add(new f(t,n)),a=e.add(new f(t,n*-1)),l=e.add(new f(0,n*-1)),u=Be.mkSiteP(e),c=new Ue(u);return u=Be.mkSiteSP(u,i),u=Be.mkSiteSP(u,o),u=Be.mkSiteSP(u,a),u=Be.mkSiteSP(u,l),Be.mkSiteSP(u,e),c}static SetStraightLineEdgesWithUnderlyingPolylines(e){Fe.CreatePortsIfNeeded(Array.from(e.deepEdges));for(let t of e.deepEdges)cr.CreateSimpleEdgeCurveWithUnderlyingPolyline(t)}};var SS,_p=function(){var s={exports:{}};return function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=i}(s,s.exports,null),s.exports}(),ES=class{constructor(...e){this._values=[];let t,n;if(e.length>0){let i=e[0];i===void 0||i!=null&&Symbol.iterator in Object(i)?(t=i,e.length>1&&(n=e[1])):n=i}if(n??(n=Rn.defaultComparer),this._comparer=typeof n=="function"?Rn.create(n):n,t)for(let i of t)this.add(i)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return(0,_p.binarySearch)(this._values,e,this._comparer)>=0}add(e){let t=(0,_p.binarySearch)(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=(0,_p.binarySearch)(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let n of this)e.call(t,n,n,this)}get[Rt.size](){return this.size}[Rt.has](e){return this.has(e)}[Rt.add](e){this.add(e)}[Rt.delete](e){return this.delete(e)}[Rt.clear](){this.clear()}};SS=ES;Object.defineProperty(SS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedSet"});var CS,Qr=function(){var s={exports:{}};return function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let i=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(O){if(O&1){let V=Math.sqrt(O)|0;for(let U=3;U<=V;U+=2)if(!(O%U))return!1;return!0}return O===2}function c(O){if(O<0)throw new RangeError;for(let V=0;V<l.length;V++){let U=l[V];if(U>=O)return U}for(let V=O|1;V<i;V+=2)if(u(V)&&(V-1)%a)return V;return O}function h(O){let V=2*O;return V>o&&o>O?o:c(V)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function m(O,V){let U=d(),Z={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:O,head:U,tail:U};return P(Z,V),Z}t.createHashData=m;function P(O,V){let U=c(V);return O.freeList=-1,O.buckets=new Int32Array(U),O.entries=new Array(U),U}function S(O,V){let U=O.size,Z=new Int32Array(V),te=O.entries?O.entries.slice():[];te.length=V;for(let le=0;le<U;le++){let ge=te[le];if(ge&&ge.hashCode>=0){let Ne=ge.hashCode%V;ge.next=Z[Ne]-1,Z[Ne]=le+1}}O.buckets=Z,O.entries=te}function v(O,V){let U=-1;if(O.buckets&&O.entries){let Z=O.equaler.hash(V)&i;U=O.buckets[Z%O.buckets.length]-1;let te=O.entries.length;for(;U>>>0<te;){let le=O.entries[U];if(le.hashCode===Z&&O.equaler.equals(le.key,V))break;U=le.next}}return U}t.findEntryIndex=v;function I(O,V){let U=v(O,V);return U>=0?O.entries[U].value:void 0}t.findEntryValue=I;function L(O,V,U){if(O.buckets||P(O,0),!O.buckets||!O.entries)throw new Error;let Z=O.equaler.hash(V)&i,te=Z%O.buckets.length,le=O.buckets[te]-1;for(;le>>>0<O.entries.length;){let Vr=O.entries[le];if(Vr.hashCode===Z&&O.equaler.equals(Vr.key,V)){Vr.value=U;return}le=Vr.next}let ge=!1,Ne;if(O.freeSize>0)Ne=O.freeList,ge=!0,O.freeSize--;else{let Vr=O.size;if(Vr===O.entries.length){if(S(O,h(O.size)),!O.buckets||!O.entries)throw new Error;te=Z%O.buckets.length}Ne=Vr,O.size=Vr+1}let Pt=O.entries[Ne]||(O.entries[Ne]=d());ge&&(O.freeList=Pt.next),Pt.hashCode=Z,Pt.next=O.buckets[te]-1,Pt.key=V,Pt.value=U,Pt.skipNextEntry=!1;let Zt=O.tail;Zt.nextEntry=Pt,Pt.prevEntry=Zt,O.tail=Pt,O.buckets[te]=Ne+1}t.insertEntry=L;function D(O,V){if(O.buckets&&O.entries){let U=O.equaler.hash(V)&i,Z=U%O.buckets.length,te=-1,le;for(let ge=O.buckets[Z]-1;ge>=0;ge=le.next){if(le=O.entries[ge],le.hashCode===U&&O.equaler.equals(le.key,V)){te<0?O.buckets[Z]=le.next+1:O.entries[te].next=le.next;let Ne=le.prevEntry;return Ne.nextEntry=le.nextEntry,Ne.nextEntry&&(Ne.nextEntry.prevEntry=Ne),O.tail===le&&(O.tail=Ne),le.hashCode=-1,le.next=O.freeList,le.key=void 0,le.value=void 0,le.prevEntry=void 0,le.nextEntry=Ne,le.skipNextEntry=!0,O.freeList=ge,O.freeSize++,!0}te=ge}}return!1}t.deleteEntry=D;function w(O){if(O.size>0){O.buckets&&O.buckets.fill(0),O.entries&&O.entries.fill(void 0);let U=O.head.nextEntry;for(;U;){let Z=U.nextEntry;U.prevEntry=void 0,U.nextEntry=O.head,U.skipNextEntry=!0,U=Z}O.head.nextEntry=void 0,O.tail=O.head,O.size=0,O.freeList=-1,O.freeSize=0}}t.clearEntries=w;function M(O,V){if(V<0)throw new RangeError;let U=O.entries?O.entries.length:0;if(U>=V)return U;if(!O.buckets)return P(O,V);let Z=c(V);return S(O,c(V)),Z}t.ensureCapacity=M;function K(O,V=O.size-O.freeSize){if(V<O.size)throw new RangeError;if(!O.buckets||!O.entries)return;let U=c(V),Z=O.entries;if(U>=(Z?Z.length:0))return;let te=O.size;if(P(O,U),!O.buckets||!O.entries)throw new Error;let le=0;for(let ge=0;ge<te;ge++){let Ne=Z[ge].hashCode;if(Ne>=0){let Pt=Ne%U;O.entries[le]=Z[ge],O.entries[le].next=O.buckets[Pt]-1,O.buckets[Pt]=le+1,le++}}O.size=le,O.freeSize=0}t.trimExcessEntries=K;function X(O){return O.key}t.selectEntryKey=X;function se(O){return O.value}t.selectEntryValue=se;function Te(O){return[O.key,O.value]}t.selectEntryEntry=Te;function*pe(O,V){let U=O;for(;U;){let Z=U.skipNextEntry;U=U.nextEntry,!Z&&U&&(yield V(U))}}t.iterateEntries=pe;function G(O,V,U,Z){let te=V;for(;te;){let le=te.skipNextEntry;te=te.nextEntry,!le&&te&&U.call(Z,te.value,te.key,O)}}t.forEachEntry=G}(s,s.exports,null),s.exports}(),Vd=class{constructor(...e){let t,n,i;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(i=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(n=o,e.length>1&&(i=e[1])):i=o}if(t??(t=0),i??(i=pr.defaultEqualer),this._hashData=(0,Qr.createHashData)(i,t),n)for(let[o,a]of n)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,Qr.findEntryIndex)(this._hashData,e)>=0}get(e){return(0,Qr.findEntryValue)(this._hashData,e)}set(e,t){return(0,Qr.insertEntry)(this._hashData,e,t),this}delete(e){return(0,Qr.deleteEntry)(this._hashData,e)}clear(){(0,Qr.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,Qr.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,Qr.trimExcessEntries)(this._hashData,e)}keys(){return(0,Qr.iterateEntries)(this._hashData.head,Qr.selectEntryKey)}values(){return(0,Qr.iterateEntries)(this._hashData.head,Qr.selectEntryValue)}entries(){return(0,Qr.iterateEntries)(this._hashData.head,Qr.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,Qr.forEachEntry)(this,this._hashData.head,e,t)}get[sn.size](){return this.size}[sn.has](e){return this.has(e)}[sn.get](e){return this.get(e)}[sn.keys](){return this.keys()}[sn.values](){return this.values()}[zr.set](e,t){this.set(e,t)}[zr.delete](e){return this.delete(e)}[zr.clear](){this.clear()}};CS=Vd;Object.defineProperty(CS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashMap"});var xS,Jr=function(){var s={exports:{}};return function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let i=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(G){if(G&1){let O=Math.sqrt(G)|0;for(let V=3;V<=O;V+=2)if(!(G%V))return!1;return!0}return G===2}function c(G){if(G<0)throw new RangeError;for(let O=0;O<l.length;O++){let V=l[O];if(V>=G)return V}for(let O=G|1;O<i;O+=2)if(u(O)&&(O-1)%a)return O;return G}function h(G){let O=2*G;return O>o&&o>G?o:c(O)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function m(G,O){let V=d(),U={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:G,head:V,tail:V};return P(U,O),U}t.createHashData=m;function P(G,O){let V=c(O);return G.freeList=-1,G.buckets=new Int32Array(V),G.entries=new Array(V),V}function S(G,O){let V=G.size,U=new Int32Array(O),Z=G.entries?G.entries.slice():[];Z.length=O;for(let te=0;te<V;te++){let le=Z[te];if(le&&le.hashCode>=0){let ge=le.hashCode%O;le.next=U[ge]-1,U[ge]=te+1}}G.buckets=U,G.entries=Z}function v(G,O){let V=-1;if(G.buckets&&G.entries){let U=G.equaler.hash(O)&i;V=G.buckets[U%G.buckets.length]-1;let Z=G.entries.length;for(;V>>>0<Z;){let te=G.entries[V];if(te.hashCode===U&&G.equaler.equals(te.key,O))break;V=te.next}}return V}t.findEntryIndex=v;function I(G,O,V){if(G.buckets||P(G,0),!G.buckets||!G.entries)throw new Error;let U=G.equaler.hash(O)&i,Z=U%G.buckets.length,te=G.buckets[Z]-1;for(;te>>>0<G.entries.length;){let Zt=G.entries[te];if(Zt.hashCode===U&&G.equaler.equals(Zt.key,O)){Zt.value=V;return}te=Zt.next}let le=!1,ge;if(G.freeSize>0)ge=G.freeList,le=!0,G.freeSize--;else{let Zt=G.size;if(Zt===G.entries.length){if(S(G,h(G.size)),!G.buckets||!G.entries)throw new Error;Z=U%G.buckets.length}ge=Zt,G.size=Zt+1}let Ne=G.entries[ge]||(G.entries[ge]=d());le&&(G.freeList=Ne.next),Ne.hashCode=U,Ne.next=G.buckets[Z]-1,Ne.key=O,Ne.value=V,Ne.skipNextEntry=!1;let Pt=G.tail;Pt.nextEntry=Ne,Ne.prevEntry=Pt,G.tail=Ne,G.buckets[Z]=ge+1}t.insertEntry=I;function L(G,O){if(G.buckets&&G.entries){let V=G.equaler.hash(O)&i,U=V%G.buckets.length,Z=-1,te;for(let le=G.buckets[U]-1;le>=0;le=te.next){if(te=G.entries[le],te.hashCode===V&&G.equaler.equals(te.key,O)){Z<0?G.buckets[U]=te.next+1:G.entries[Z].next=te.next;let ge=te.prevEntry;return ge.nextEntry=te.nextEntry,ge.nextEntry&&(ge.nextEntry.prevEntry=ge),G.tail===te&&(G.tail=ge),te.hashCode=-1,te.next=G.freeList,te.key=void 0,te.value=void 0,te.prevEntry=void 0,te.nextEntry=ge,te.skipNextEntry=!0,G.freeList=le,G.freeSize++,!0}Z=le}}return!1}t.deleteEntry=L;function D(G){if(G.size>0){G.buckets&&G.buckets.fill(0),G.entries&&G.entries.fill(void 0);let V=G.head.nextEntry;for(;V;){let U=V.nextEntry;V.prevEntry=void 0,V.nextEntry=G.head,V.skipNextEntry=!0,V=U}G.head.nextEntry=void 0,G.tail=G.head,G.size=0,G.freeList=-1,G.freeSize=0}}t.clearEntries=D;function w(G,O){if(O<0)throw new RangeError;let V=G.entries?G.entries.length:0;if(V>=O)return V;if(!G.buckets)return P(G,O);let U=c(O);return S(G,c(O)),U}t.ensureCapacity=w;function M(G,O=G.size-G.freeSize){if(O<G.size)throw new RangeError;if(!G.buckets||!G.entries)return;let V=c(O),U=G.entries;if(V>=(U?U.length:0))return;let Z=G.size;if(P(G,V),!G.buckets||!G.entries)throw new Error;let te=0;for(let le=0;le<Z;le++){let ge=U[le].hashCode;if(ge>=0){let Ne=ge%V;G.entries[te]=U[le],G.entries[te].next=G.buckets[Ne]-1,G.buckets[Ne]=te+1,te++}}G.size=te,G.freeSize=0}t.trimExcessEntries=M;function K(G){return G.key}t.selectEntryKey=K;function X(G){return G.value}t.selectEntryValue=X;function se(G){return[G.key,G.value]}t.selectEntryEntry=se;function*Te(G,O){let V=G;for(;V;){let U=V.skipNextEntry;V=V.nextEntry,!U&&V&&(yield O(V))}}t.iterateEntries=Te;function pe(G,O,V,U){let Z=O;for(;Z;){let te=Z.skipNextEntry;Z=Z.nextEntry,!te&&Z&&V.call(U,Z.value,Z.key,G)}}t.forEachEntry=pe}(s,s.exports,null),s.exports}(),hs=class{constructor(...e){let t,n,i;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(i=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(n=o,e.length>1&&(i=e[1])):i=o}if(t??(t=0),i??(i=pr.defaultEqualer),this._hashData=(0,Jr.createHashData)(i,t),n)for(let o of n)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,Jr.findEntryIndex)(this._hashData,e)>=0}add(e){return(0,Jr.insertEntry)(this._hashData,e,e),this}tryAdd(e){let t=this.size;return(0,Jr.insertEntry)(this._hashData,e,e),this.size>t}delete(e){return(0,Jr.deleteEntry)(this._hashData,e)}clear(){(0,Jr.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,Jr.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,Jr.trimExcessEntries)(this._hashData,e)}keys(){return(0,Jr.iterateEntries)(this._hashData.head,Jr.selectEntryKey)}values(){return(0,Jr.iterateEntries)(this._hashData.head,Jr.selectEntryValue)}entries(){return(0,Jr.iterateEntries)(this._hashData.head,Jr.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,Jr.forEachEntry)(this,this._hashData.head,e,t)}get[Rt.size](){return this.size}[Rt.has](e){return this.has(e)}[Rt.add](e){this.add(e)}[Rt.delete](e){return this.delete(e)}[Rt.clear](){this.clear()}};xS=hs;Object.defineProperty(xS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashSet"});var AS,vS=class{constructor(...e){var t,n;this._size=0;let i,o,a;WI(e)?[i,a={}]=e:(i=0,UI(e)?[o,a={}]=e:a={});let l=(t=a?.keyEqualer)!==null&&t!==void 0?t:pr.defaultEqualer,u=(n=a?.valueEqualer)!==null&&n!==void 0?n:pr.defaultEqualer;if(this._map=new Vd(i,l),this._keyEqualer=l,this._valueEqualer=u,o)for(let[c,h]of o)this.add(c,h)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let n=this._map.get(e);return n?n.has(t):!1}get(e){return this._map.get(e)}add(e,t){let n=this._map.get(e);n||(n=new hs(this._valueEqualer),this._map.set(e,n));let i=n.size;return n.add(t),this._size+=n.size-i,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let n=this._map.get(e);if(n){let i=n.size;if(n.delete(t))return this._size+=n.size-i,n.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let n of t)yield[e,n]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[n,i]of this._map)for(let o of i)e.call(t,o,n,this)}get[wr.size](){return this.size}[wr.has](e){return this.has(e)}[wr.hasValue](e,t){return this.hasValue(e,t)}[wr.get](e){return this.get(e)}[wr.keys](){return this.keys()}[wr.values](){return this.values()}[Ws.add](e,t){this.add(e,t)}[Ws.delete](e){return this.delete(e)}[Ws.deleteValue](e,t){return this.deleteValue(e,t)}[Ws.clear](){this.clear()}};AS=vS;Object.defineProperty(AS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"MultiMap"});function UI(s){let[e,t]=s;return(e===void 0||e!=null&&Symbol.iterator in Object(e))&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}function WI(s){let[e,t]=s;return typeof e=="number"&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}var TS,IS,Vp,pa,ds,ba,fs,Sr=class{constructor(e){this._list=void 0,this._previous=void 0,this._next=void 0,this.value=e}get list(){return this._list}get previous(){if(this._previous&&this._list&&this!==this._list.first)return this._previous}get next(){if(this._next&&this._list&&this._next!==this._list.first)return this._next}detachSelf(){return this._list?this._list.deleteNode(this):!1}};TS=Sr;Vp=(s,e)=>{s._list=e},pa=s=>s._previous,ds=(s,e)=>{s._previous=e},ba=s=>s._next,fs=(s,e)=>{s._next=e},Object.defineProperty(TS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedListNode"});var Io=class{constructor(...e){this._size=0,this._head=void 0;let t,n;if(e.length>0){let i=e[0];i===void 0||i!=null&&Symbol.iterator in Object(i)?(t=i,e.length>1&&(n=e[1])):n=i}if(n??(n=pr.defaultEqualer),this._equaler=typeof n=="function"?pr.create(n):n,t)for(let i of t)this.push(i)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return pa(this._head)}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(t!=null&&!(t instanceof Sr))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let n=t??this.first;n;n=n.next)if(this._equaler.equals(n.value,e))return n}lastNodeOf(e,t){if(t!=null&&!(t instanceof Sr))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let n=t??this.last;n;n=n.previous)if(this._equaler.equals(n.value,e))return n}find(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;){n=i,i=n.next;let o=n.value;if(e.call(t,o,n,this))return o}}findLast(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.last;for(;i!==void 0;){n=i,i=n.previous;let o=n.value;if(e.call(t,o,n,this))return o}}findNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)if(n=i,i=n.next,e.call(t,n.value,n,this))return n}findLastNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.last;for(;i!==void 0;)if(n=i,i=n.previous,e.call(t,n.value,n,this))return n}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(e!=null&&!(e instanceof Sr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e??void 0,new Sr(t),0)}insertNodeBefore(e,t){if(e!=null&&!(e instanceof Sr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof Sr))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(e!=null&&!(e instanceof Sr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e||void 0,new Sr(t),1)}insertNodeAfter(e,t){if(e!=null&&!(e instanceof Sr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof Sr))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new Sr(e),1)}pushNode(e){if(!(e instanceof Sr))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new Sr(e),0)}unshiftNode(e){if(!(e instanceof Sr))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(e!=null&&!(e instanceof Sr))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return e==null||!e.list?!1:this._deleteNode(e)}deleteAll(e,t){if(typeof e!="function")throw new TypeError("Function expected: predicate");let n=0,i=this.first;for(;i;){let o=i.next;e.call(t,i.value,i,this)&&i.list===this&&(this._deleteNode(i),++n),i=o}return n}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)n=i,i=n.next,e.call(t,n.value,n,this)}map(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n=new Io,i,o=this.first;for(;o!==void 0;){i=o,o=i.next;let a=e.call(t,i.value,i,this);n.push(a)}return n}filter(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n=new Io(this.equaler),i,o=this.first;for(;o!==void 0;){i=o,o=i.next;let a=i.value;e.call(t,a,i,this)&&n.push(a)}return n}reduce(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n=arguments.length>1,i=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;n?i=e(i,l,o,this):(i=l,n=!0)}return i}reduceRight(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n=arguments.length>1,i=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;n?i=e(i,l,o,this):(i=l,n=!0),a=o.previous}return i}some(e,t){if(e!==void 0&&typeof e!="function")throw new TypeError("Function expected: callback");let n,i=this.first;for(;i!==void 0;)if(n=i,i=n.next,!e||e.call(t,n.value,n,this))return!0;return!1}every(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let n=!1,i,o=this.first;for(;o!==void 0;){if(i=o,o=i.next,!e.call(t,i.value,i,this))return!1;n=!0}return n}_deleteNode(e){return ba(e)===e?this._head=void 0:(ds(ba(e),pa(e)),fs(pa(e),ba(e)),this._head===e&&(this._head=ba(e))),Vp(e,void 0),ds(e,void 0),fs(e,void 0),this._size--,!0}_insertNode(e,t,n){if(Vp(t,this),this._head===void 0)fs(t,t),ds(t,t),this._head=t;else switch(n){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),fs(t,e),ds(t,pa(e)),fs(pa(e),t),ds(e,t);break;case 1:e===void 0&&(e=pa(this._head)),ds(t,e),fs(t,ba(e)),ds(ba(e),t),fs(e,t);break}return this._size++,t}get[Wr.size](){return this.size}[Wr.has](e){return this.has(e)}[Rt.add](e){this.push(e)}[Rt.delete](e){return!!this.delete(e)}[Rt.clear](){this.clear()}};IS=Io;Object.defineProperty(IS.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedList"});var wS=(i=>(i[i.OverlapsOtherLabels=0]="OverlapsOtherLabels",i[i.OverlapsNodes=1]="OverlapsNodes",i[i.OverlapsEdges=2]="OverlapsEdges",i[i.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",i))(wS||{});var LS=class{},OS=class{constructor(){this.points=new Io;this.coveredLength=0}AddFirst(e){if(this.points.size!==0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!==0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var kp=class{constructor(e){this.location=e,this.boundingBox=z.rectangleOnPoint(e)}},wl=class{constructor(e,t){this.data=t,this.boundingBox=e}},RS=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},je=class extends Pe{constructor(e,t){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=je.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(t.length):je.MinGranularity,this.InitializeObstacles(e,t),this.edges=t}get CollisionGranularity(){return this.granularity}set CollisionGranularity(e){this.granularity=e}static constructorG(e){return new je(Array.from(e.nodesBreadthFirst),Array.from(e.deepEdges).filter(t=>t.label))}static constructorGA(e,t){return new je(Array.from(e.nodesBreadthFirst),t.filter(n=>n.label))}interpolateGranularity(e){if(e<=je.LowerEdgeBound)return je.MaxGranularity;if(e>=je.UpperEdgeBound)return je.MinGranularity;let t=(je.UpperEdgeBound-je.LowerEdgeBound)/(e-je.LowerEdgeBound);return Math.ceil(je.MinGranularity+t)}InitializeObstacles(e,t){let n=this.GetEdgeObstacles(t);this.obstacleMaps[1]=vi(e.map(i=>[i.boundingBox,new wl(i.boundingBox,i)])),this.obstacleMaps[2]=vi(n.map(i=>[i.boundingBox,new wl(i.boundingBox,i)]))}static CurvePoints(e,t){let n=[],i=e.end.sub(e.start).lengthSquared/(t*t);return je.SubdivideCurveSegment(n,e,i,e.parStart,e.parEnd),n.sort(je.compareByArgument),n}static compareByArgument(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}static SubdivideCurveSegment(e,t,n,i,o){if(e.length>64)return;let a=t.value(i),l=t.value(o);if(a.sub(l).lengthSquared>n){let u=(i+o)/2;je.SubdivideCurveSegment(e,t,n,i,u),je.SubdivideCurveSegment(e,t,n,u,o)}else e.push([i,a])}static PlaceLabelsAtDefaultPositions(e,t){for(let n of t)n.label&&new je([n.source,n.target],[n]).run()}GetEdgeObstacles(e){let t=[];for(let n of e){if(n.curve==null)continue;let i=je.CurvePoints(n.curve,this.CollisionGranularity);this.edgeInfos.set(n,new RS(i));for(let o of i)t.push(new kp(o[1]))}return t}AddLabelObstacle(e){this.labelObstacleMap==null?(this.labelObstacleMap=vi([[e.boundingBox,e]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(e.boundingBox,e)}run(){this.edges.sort((e,t)=>this.edgeInfos.get(e).edgePoints.length-this.edgeInfos.get(t).edgePoints.length);for(let e of this.edges)this.PlaceLabel(e)}PlaceLabel(e){let t=!1;for(let n of this.placementStrategy){switch(n){case 0:t=this.PlaceEdgeLabelOnCurve(e.label);break;case 1:t=this.PlaceEdgeLabelHorizontally(e);break;default:throw new Error("unexpected case")}if(t)break}t?this.CalculateCenterLabelInfoCenter(e.label):this.PlaceLabelAtFirstPosition(e.label)}getLabelInfo(e){let t=e.parent;return this.edgeInfos.get(t)}PlaceLabelAtFirstPosition(e){let t=e.parent,n=t.curve,i=this.edgeInfos.get(t).edgePoints,o=this.StartIndex(e,i.map(m=>m[1])),a=i[o][1],l=n.derivative(i[o][0]);l.length<C.distanceEpsilon&&(l=new f(1,1)),l=l.normalize();let u=new vt(e.width,e.height),c=this.getLabelInfo(e),h=je.GetPossibleSides(c.placementSide,l)[0],d=je.GetLabelBounds(a,l,u,h);this.SetLabelBounds(this.getLabelInfo(e),d)}StartIndex(e,t){let n=this.getLabelInfo(e);return Math.min(t.length-1,Math.max(0,Math.floor(t.length*n.placementOffset)))}CalculateCenterLabelInfoCenter(e){let t=this.getLabelInfo(e),n=new f(0,0);for(let i of t.innerPoints)n=n.add(i);for(let i of t.outerPoints)n=n.add(i);e.positionCenter(n.div(t.innerPoints.length+t.outerPoints.length))}PlaceEdgeLabelHorizontally(e){let t=e.label,i=this.getLabelInfo(t).edgePoints,o=new vt(t.width,t.height),a=-1,l=z.mkEmpty(),u=e.curve;for(let c of je.ExpandingSearch(this.StartIndex(t,i.map(h=>h[1])),0,i.length)){let h=i[c],d=u.derivative(h[0]);if(!ie(d.lengthSquared,0)){d=d.normalize();for(let m of je.GetPossibleSides(this.getLabelInfo(t).placementSide,d)){let P=je.GetLabelBounds(h[1],d,o,m),S=this.ConflictIndexRL(P,t);if(S>a&&(a=S,l=P,a===Number.MAX_VALUE))break}if(a===Number.MAX_VALUE)break}}if(a>=0){this.SetLabelBounds(this.getLabelInfo(t),l);let c=new wl(l,null);this.AddLabelObstacle(c);let h=this.getLabelInfo(t);return a===0?h.placementResult=0:a===1?h.placementResult=1:a===2?h.placementResult=2:h.placementResult=wS.OverlapsNothing,!0}return!1}static GetLabelBounds(e,t,n,i){let o=t.rotate(Math.PI/2).mul(i),a=e.add(o),l=1,u=o.x>0?a.x:a.x-n.width,c=o.y>0?a.y:a.y-n.height;if(Math.abs(o.x)<.75){let h=Math.acos(Math.abs(o.y)/l),d=l/Math.sin(h),m=l/Math.cos(h);u+=(o.x>0?-1:1)*Math.min(d,n.width/2),c+=(o.y>0?1:-1)*m}else if(Math.abs(o.y)<.75){let h=Math.acos(Math.abs(o.x)/l),d=l/Math.sin(h),m=l/Math.cos(h);u+=(o.x>0?1:-1)*m,c+=(o.y>0?-1:1)*Math.min(d,n.height/2)}return z.mkLeftBottomSize(u,c,n)}SetLabelBounds(e,t){e.innerPoints=[t.leftTop,t.rightTop],e.outerPoints=[t.leftBottom,t.rightBottom]}static GetPossibleSides(e,t){switch(t.length===0&&(e=0),e){case 1:return[-1];case 2:return[1];case 3:return ie(t.x,0)?je.GetPossibleSides(5,t):[1];case 4:return ie(t.x,0)?je.GetPossibleSides(6,t):[t.x<0?-1:1];case 5:return ie(t.y,0)?je.GetPossibleSides(3,t):[t.y<0?-1:1];case 6:return ie(t.y,0)?je.GetPossibleSides(4,t):[t.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(e,t,n){let i=e+1,o=i;for(;o>t;)yield--o;for(;i<n;)yield i++}static PointSetLength(e){let t=0,n=null;for(let i of e)n!=null&&(t+=n.sub(i.Center).length),n=i.Center;return t}PlaceEdgeLabelOnCurve(e){let t=e.parent,n=this.getLabelInfo(e);n.innerPoints=null;let i=n.edgePoints,o=3,a=e.height/2,l=new vt(a,a),u=e.width;for(let c of je.ExpandingSearch(this.StartIndex(e,i),0,i.length)){let h=this.GetSidesAndEdgeCurve(e,t,i,c);for(let d of h){let m=new OS,P={coveredLength:0};if(this.ProcessExpandingSearchOnSide(c,i,t.curve,d,a,o,l,P,m,u),P.coveredLength>=u)return this.CaseOfCoveredLengthGreaterThanLabelLength(e,m,P.coveredLength,u,l),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(e,t,n,i,o){let a=new Array,l=new Array,u=Array.from(t.points),c=n-i;if(c>0){let d=u[u.length-1],m=u[u.length-2],P=d.Center.sub(m.Center),S=P.length;c>S&&(d=u[0],m=u[1],P=d.Center.sub(m.Center),S=P.length);let v=P.mul((S-c)/S);d.Center=m.Center.add(v),d.Inner=m.Inner.add(v),d.Outer=m.Outer.add(v)}this.GoOverOrderedPointsAndAddLabelObstacels(u,a,l,o);let h=this.getLabelInfo(e);h.innerPoints=a,h.outerPoints=l}GoOverOrderedPointsAndAddLabelObstacels(e,t,n,i){for(let o of e){let a=o.Center;t.push(o.Inner),n.push(o.Outer);let l=new wl(z.mkSizeCenter(new vt(i.width*2,i.height*2),a),null);this.AddLabelObstacle(l)}}ProcessExpandingSearchOnSide(e,t,n,i,o,a,l,u,c,h){for(let d of je.ExpandingSearch(e,0,t.length)){let[m,P]=t[d],S=n.derivative(m);if(ie(S.lengthSquared,0))continue;let v=S.rotate(Math.PI/2).normalize().mul(i),I=P.add(v.mul(o+a));if(this.Conflict(I,o,l))break;{let L=new LS;if(L.Center=I,L.Inner=P.add(v.mul(a)),L.Outer=P.add(v.mul(2*o+a)),u.coveredLength=d<=e?c.AddFirst(L):c.AddLast(L),u.coveredLength>=h)break}}}GetSidesAndEdgeCurve(e,t,n,i){let o=t.curve.derivative(n[i][0]);return je.GetPossibleSides(this.getLabelInfo(e).placementSide,o)}Conflict(e,t,n){return this.ConflictIndex(e,t,n)!==Number.MAX_VALUE}ConflictIndexRL(e,t){let n=t.parent,i=n.source,o=n.target;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l of this.obstacleMaps[a].GetAllIntersecting(e))if(!(a===1&&l instanceof wl&&l.data instanceof re!=null&&(i.node.isDescendantOf(l.data.graph)||o.node.isDescendantOf(l.data))))return a}return Number.MAX_VALUE}ConflictIndex(e,t,n){let i=z.creatRectangleWithSize(new vt(n.width*2,n.height*2),e),o=t*t;for(let a=0;a<this.obstacleMaps.length;a++)if(this.obstacleMaps[a]!=null){for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null)for(let u of this.obstacleMaps[l].GetAllIntersecting(i))if(u instanceof kp){if(e.sub(u.location).lengthSquared<o)return l}else return l;return Number.MAX_VALUE}}},Zr=je;Zr.MinGranularity=5,Zr.MaxGranularity=50,Zr.LowerEdgeBound=500,Zr.UpperEdgeBound=3e3;var Fn=class extends Ci{clone(){throw new Error("Method not implemented.")}rebind(e){this.entity=e,this.bind(ae.AlgorithmDataIndex)}constructor(e,t=null){super(e,ae.AlgorithmDataIndex);this.data=t}static getAlgData(e){return e.getAttr(ae.AlgorithmDataIndex)}};function lc(s){let e=Fn.getAlgData(s.node);return e==null?null:e.data}var Up=class{constructor(e,t){this.force=new f(0,0);this.stayWeight=1;this.index=e,this.geomNode=t,this.ResetBounds()}get Center(){return this.center}set Center(e){this.geomNode.center=e,this.center=e}ResetBounds(){this.previousCenter=this.geomNode.center,this.center=this.geomNode.center,this.Width=this.geomNode.width,this.Height=this.geomNode.height}ToString(){return"FINode("+(this.index+("):"+this.geomNode))}};var Wp=class{constructor(e){this._length=1;this.mEdge=e,this.sourceFiNode=lc(this.mEdge.source),this.targetFiNode=lc(this.mEdge.target)}get source(){return this.sourceFiNode.index}get target(){return this.targetFiNode.index}get length(){return this._length}set length(e){this._length=e}vector(){return this.sourceFiNode.geomNode.center.sub(this.targetFiNode.geomNode.center)}};var GS=Ae(Qn());var _n=class{get Center(){return this.c}get Radius(){return this.r}Distance2(e){let t=this.c.y-e.y,n=this.c.x-e.x;return n*n+t*t}Contains(e){return this.Distance2(e)-1e-7<=this.r2}ContainsPN(e,t){for(let n=0;n<e.length;n++)if(t.findIndex(i=>i==n)==-1&&!this.Contains(e[n]))return!1;return!0}static constructorP(e){let t=new _n;return t.c=e,t.r=0,t.r2=0,t}static midPoint(e,t){return new f((t.x+e.x)/2,(t.y+e.y)/2)}static constructorPP(e,t){let n=new _n;return n.c=_n.midPoint(e,t),n.r2=n.Distance2(e),n.r=Math.sqrt(n.r2),Ee.assert(n.OnBoundary(e)),Ee.assert(n.OnBoundary(t)),n}OnBoundary(e){let t=this.Distance2(e);return Math.abs(t-this.r2)/(t+this.r2)<1e-5}static centre(e,t,n){Ee.assert(t.x!=e.x),Ee.assert(n.x!=t.x);let i=(t.y-e.y)/(t.x-e.x),o=(n.y-t.y)/(n.x-t.x);Ee.assert(o!=i);let a,l=(i*o*(e.y-n.y)+o*(e.x+t.x)-i*(t.x+n.x))/(2*(o-i));return Math.abs(i)>Math.abs(o)?a=(e.y+t.y)/2-(l-(e.x+t.x)/2)/i:a=(t.y+n.y)/2-(l-(t.x+n.x)/2)/o,new f(l,a)}static Collinear(e,t,n){return e.x*(t.y-n.y)+(t.x*(n.y-e.y)+n.x*(e.y-t.y))==0}static constructorPPP(e,t,n){_n.count++;let i=new _n;if(_n.Collinear(e,t,n)){let o=new f(Math.min(e.x,Math.min(t.x,n.x)),Math.min(e.y,Math.max(t.y,n.y))),a=new f(Math.max(e.x,Math.max(t.x,n.x)),Math.max(e.y,Math.max(t.y,n.y)));i.c=_n.midPoint(o,a),i.r2=i.Distance2(a),i.r=Math.sqrt(i.r2)}else{let o=t.x-e.x,a=n.x-t.x,l=n.x-e.x;o!=0?a!=0?i.c=_n.centre(e,t,n):(Ee.assert(l!=0),i.c=_n.centre(t,e,n)):(Ee.assert(a!=0),i.c=_n.centre(t,n,e)),i.r2=i.Distance2(e),i.r=Math.sqrt(i.r2),Ee.assert(i.OnBoundary(e)),Ee.assert(i.OnBoundary(t)),Ee.assert(i.OnBoundary(n))}return i}},_i=_n;_i.count=0;var BS=class{constructor(e,t){switch(this.boundary=t,Ee.assert(t.length<=3),t.length){case 0:this.disc=null;break;case 1:this.disc=_i.constructorP(e[t[0]]);break;case 2:this.disc=_i.constructorPP(e[t[0]],e[t[1]]);break;case 3:this.disc=_i.constructorPPP(e[t[0]],e[t[1]],e[t[2]]);break}}contains(e){return this.disc==null?!1:this.disc.Contains(e)}},NS=class{constructor(e){this.ps=e,this.L=new Io;for(let n=0;n<this.ps.length;n++)this.L.push(n);let t=this.mtf_md(null,new Array);this.disc=t.disc,this.boundary=t.boundary}collinear3(e){return e.length==3?_i.Collinear(this.ps[e[0]],this.ps[e[1]],this.ps[e[2]]):!1}mtf_md(e,t){Ee.assert(t.length<=3);let n=new BS(this.ps,t);if(t.length==3)return n;let i=this.L.first;for(;i!=null&&i!=e;){let o=i.next,a=i.value;if(!n.contains(this.ps[a])){let l=Array.from(t);l.push(a),Ee.assert(!this.collinear3(l),"Collinear points on boundary of minimal enclosing disc"),n=this.mtf_md(i,l),this.L.deleteNode(i),this.L.insertNodeBefore(null,i)}i=o}return n}},zp=class{static LinearComputation(e){return new NS(e).disc}static SlowComputation(e){let t=e.length,n=null,i=null;for(let o=0;o<t;o++)for(let a=0;a<t;a++){if(o!=a){let l=_i.constructorPP(e[o],e[a]);l.ContainsPN(e,[o,a])&&(n==null||n.Radius>l.Radius)&&(n=l,i=[o,a])}for(let l=0;l<t;l++)if(l!=o&&l!=a&&!_i.Collinear(e[o],e[a],e[l])){let u=_i.constructorPPP(e[o],e[a],e[l]);u.ContainsPN(e,[o,a,l])&&(n==null||n.Radius>u.Radius)&&(n=u,i=[o,a,l])}}return Ee.assert(i!=null),n}};var $r=class{static constructorNPA(e,t,n){let i=new $r;i.p=e,i.z0=new bt(t.x,t.y),i.a=new Array(e);for(let o=0;o<e;o++)i.a[o]=i.compute(o,n);return i}static constructorPMM(e,t,n){let i=new $r;Ee.assert(t.p==n.p),i.p=t.p,i.z0=new bt(e.x,e.y);let o=n.shift(i.z0),a=t.shift(i.z0);i.a=new Array(i.p);for(let l=0;l<i.p;l++)i.a[l]=Hp(a[l],o[l]);return i}static factorial(e){let t=1;for(let n=2;n<=e;n++)t*=n;return t}static binomial(e,t){return $r.factorial(e)/($r.factorial(t)*$r.factorial(e-t))}sum(e,t){let n=bt.constructorN(0);for(let i=1;i<=e;i++){let o=bt.constructorN($r.binomial(e-1,i-1));n=Hp(n,gs(this.a[i],gs(bt.Pow(t,e-i),o)))}return n}shift(e){let t=new Array(this.p),n=t[0]=this.a[0],i=uc(this.z0,e);for(let o=1;o<this.p;o++){let a=bt.constructorN(o);t[o]=Hp(gs(HI(n),jp(bt.Pow(i,o),a)),this.sum(o,i))}return t}compute(e,t){let n=t.length,i=bt.constructorN(0);if(e==0)i.re=n;else{for(let o=0;o<n;o++){let a=t[o],l=new bt(a.x,a.y);i=uc(i,bt.Pow(uc(l,this.z0),e))}i.divideBy(e)}return i}ApproximateForce(e){let t=new bt(e.x,e.y),n=uc(t,this.z0),i=jp(this.a[0],n),o=n,a=0;for(;i=uc(i,jp(zI(this.a[a],a),o)),a++,a!=this.p;)o=gs(o,n);return new f(i.re,-i.im)}static Force(e,t){let n=t.sub(e),i=n.lengthSquared;return i<.1?i!=0?n.div(.1):new f(1,0):n.div(i)}},bt=class{constructor(e,t){this.re=e,this.im=t}static constructorN(e){return new bt(e,0)}divideBy(e){this.re/=e,this.im/=e}static Pow(e,t){switch(Ee.assert(t>=0),t){case 0:return bt.constructorN(1);case 1:return e;case 2:return gs(e,e);case 3:return gs(e,gs(e,e));default:return gs(bt.Pow(e,t/2),bt.Pow(e,t/2+t%2))}}};function Hp(s,e){return new bt(s.re+e.re,s.im+e.im)}function gs(s,e){return new bt(s.re*e.re-s.im*e.im,s.re*e.im+e.re*s.im)}function zI(s,e){return new bt(s.re*e,s.im*e)}function uc(s,e){return new bt(s.re-e.re,s.im-e.im)}function HI(s){return new bt(-s.re,-s.im)}function jp(s,e){let t=e.re*e.re+e.im*e.im;if(t==0)return bt.constructorN(0);let n=s.re*e.re+s.im*e.im,i=s.im*e.re-s.re*e.im;return new bt(n/t,i/t)}var qp=class{intersects(e){return e.med.Center.sub(this.med.Center).length<e.med.Radius+this.med.Radius}},MS=class extends qp{constructor(e,t,n){super();this.med=e,this.parent=t.parent,this.parent!=null&&(this.parent.leftChild==t?this.parent.leftChild=this:this.parent.rightChild=this),this.leftChild=t,this.rightChild=n,t.parent=this,n.parent=this}computeMultipoleCoefficients(e){this.leftChild.computeMultipoleCoefficients(e),this.rightChild.computeMultipoleCoefficients(e),this.multipoleCoefficients=$r.constructorPMM(this.med.Center,this.leftChild.multipoleCoefficients,this.rightChild.multipoleCoefficients)}},cc=class extends qp{constructor(e){super();this.particles=e,this.ComputeMinimumEnclosingDisc()}computeMultipoleCoefficients(e){this.multipoleCoefficients=$r.constructorNPA(e,this.med.Center,this.ps)}ComputeMinimumEnclosingDisc(){let e=this.Size();this.ps=new Array(e);for(let t=0;t<e;t++)this.ps[t]=this.particles[0][t].point;return this.med=zp.LinearComputation(this.ps)}Min(e){return this.particles[e][0].pos(e)}Size(){return this.particles[0].length}Max(e){return this.particles[e][this.Size()-1].pos(e)}Dimension(e){return this.Max(e)-this.Min(e)}Split(e){let t=this.Dimension(0)>this.Dimension(1)?0:1,n=t==0?1:0,i=this.Size(),o=i>>1,a=i-o,l=[new Array(o),new Array(o)],u=[new Array(a),new Array(a)],c=0,h=0;for(let m=0;m<i;m++){let P=this.particles[t][m];m<o?(l[t][m]=P,P.splitLeft=!0):(u[t][m-o]=P,P.splitLeft=!1)}for(let m=0;m<i;m++){let P=this.particles[n][m];P.splitLeft?l[n][h++]=P:u[n][c++]=P}let d=this.med;return this.particles=l,this.ComputeMinimumEnclosingDisc(),e.rightSibling=new cc(u),new MS(d,this,e.rightSibling)}ComputeForces(){for(let e of this.particles[0])for(let t of this.particles[0])e!=t&&(e.force=e.force.add($r.Force(e.point,t.point)))}},Xp=class{pos(e){return e==0?this.point.x:this.point.y}constructor(e){this.point=e,this.force=new f(0,0)}},Yp=class{particlesBy(e){return this.particles.map(t=>t).sort((t,n)=>t.pos(e)-n.pos(e))}constructor(e,t){this.particles=e;let n=new Array;n.push(this.particlesBy(0)),n.push(this.particlesBy(1)),this.leaves=new Array;let i=new cc(n);this.leaves.push(i);let o={rightSibling:null};this.root=i.Split(o),this.leaves.push(o.rightSibling);let a=new DS(t);for(a.EnqueueLL(i,o.rightSibling);a.length>0;)i=a.dequeue(),i.Split(o),this.leaves.push(o.rightSibling),a.EnqueueLL(i,o.rightSibling)}ComputeForces(e){this.root.computeMultipoleCoefficients(e);for(let t of this.leaves){t.ComputeForces();let n=new Array;for(n.push(this.root);n.length>0;){let i=n.pop();if(t.intersects(i))if(i instanceof cc)for(let o of t.particles[0])for(let a of i.particles[0])o!=a&&(o.force=o.force.add($r.Force(o.point,a.point)));else{let o=i;n.push(o.leftChild),n.push(o.rightChild)}else for(let o of t.particles[0])o.force=o.force.sub(i.multipoleCoefficients.ApproximateForce(o.point))}}}},DS=class extends GS.Queue{constructor(e){super();this.B=e}EnqueueLL(e,t){e.Size()>this.B&&this.enqueue(e),t.Size()>this.B&&this.enqueue(t)}};var ms=class extends Pe{constructor(e,t,n){super(null);this.clustersInfo=new Map;this.clusterEdges=new Array;if(this.graph=e,this.settings=t,this.initFiNodesEdges(),this.edges=Array.from(this.graph.shallowEdges).map(i=>Fn.getAlgData(i.edge).data),this.nodes=Array.from(this.graph.shallowNodes).map(i=>Fn.getAlgData(i.node).data),this.components=new Array,this.settings.InterComponentForces)this.components.push(this.nodes);else{this.basicGraph=rr(this.edges,this.nodes.length);for(let i of Jn(this.basicGraph)){let o=new Array(i.length),a=0;for(let l of i)o[a++]=this.nodes[l];this.components.push(o)}}this.computeWeight(e),this.setCurrentConstraintLevel(n)}initFiNodesEdges(){let e=0;for(let t of this.graph.shallowNodes){let n=new Up(e++,t);new Fn(t.node,n)}for(let t of this.graph.shallowEdges){let n=new Wp(t);new Fn(t.edge,n)}}getCurrentConstraintLevel(){return this.currentConstraintLevel}setCurrentConstraintLevel(e){this.currentConstraintLevel=e,this.settings.Unconverge()}ResetNodePositions(){for(let e of this.nodes)e.ResetBounds()}AddRepulsiveForce(e,t){e.force=t.mul(10*this.settings.RepulsiveForceConstant)}AddLogSpringForces(e,t,n){let i=t.length,o=7e-4*this.settings.AttractiveForceConstant*i*Math.log((i+.1)/(n+.1));e.sourceFiNode.force=e.sourceFiNode.force.add(t.mul(o)),e.targetFiNode.force=e.targetFiNode.force.sub(t.mul(o))}AddSquaredSpringForces(e,t,n){let i=t.length,o=n*n+.1,a=this.settings.AttractiveForceConstant*(i-n)/o;e.sourceFiNode.force=e.sourceFiNode.force.add(t.mul(a)),e.targetFiNode.force=e.targetFiNode.force.sub(t.mul(a))}AddSpringForces(e){let t;if(this.settings.RespectEdgePorts){let n=e.sourceFiNode.Center,i=e.targetFiNode.Center,o=e.mEdge.sourcePort;o instanceof ir&&(n=o.Location);let a=e.mEdge.targetPort;a instanceof ir&&(i=a.Location),t=n.sub(i)}else t=e.vector();this.settings.LogScaleEdgeForces?this.AddLogSpringForces(e,t,e.length):this.AddSquaredSpringForces(e,t,e.length)}static AddGravityForce(e,t,n){n!=null&&(n.force=n.force.sub(e.sub(n.Center).mul(t*1e-4)))}ComputeRepulsiveForces(e){let t=e.length;if(t>16&&this.settings.ApproximateRepulsion){let n=new Array(e.length),i=2*(Math.PI/t),o=0;for(let l=0;l<t;l++)n[l]=new Xp(e[l].Center.add(new f(Math.cos(o),Math.sin(o)).mul(1e-5))),o+=i;new Yp(n,8).ComputeForces(5);for(let l=0;l<e.length;l++)this.AddRepulsiveForce(e[l],n[l].force)}else for(let n of e){let i=new f(0,0);for(let o of e)n!=o&&(i=i.add($r.Force(n.Center,o.Center)));this.AddRepulsiveForce(n,i)}}SetBarycenter(e){let t=this.clustersInfo.get(e);if(t!=null)return t.barycenter;let n=new f(0,0);if(e.shallowNodeCount||jI(e)){let i=this.clustersInfo.get(e);if((i==null||i.weight==null)&&this.computeWeight(e),i.weight!=null){for(let o of e.shallowNodes)o instanceof Ge?n=n.add(o.center):n=n.add(this.SetBarycenter(o).mul(this.clustersInfo.get(o).weight));this.clustersInfo.get(e).barycenter=n=n.div(i.weight)}}else this.clustersInfo.get(e).barycenter=n;return n}computeWeight(e){let t=0;for(let i of e.shallowNodes)i.entity instanceof de?t+=this.computeWeight(i):t++;let n=this.clustersInfo.get(e);return n==null&&this.clustersInfo.set(e,n={barycenter:new f(0,0)}),n.weight=t,t}AddClusterForces(e){if(e!=null){this.SetBarycenter(e);for(let t of this.clusterEdges){let n=ce.getGeom(t.source),i=ce.getGeom(t.target),o=Fn.getAlgData(t.source).data,a=Fn.getAlgData(t.target).data,l=n.hasOwnProperty("shallowNodes"),u=l?this.clustersInfo.get(n).barycenter:n.center,c=i.hasOwnProperty("shallowNodes"),h=c?this.clustersInfo.get(i).barycenter:i.center,d=u.sub(h),m=d.length,P=1e-8*(this.settings.AttractiveInterClusterForceConstant*(m*Math.log(m+.1)));if(d=d.mul(P),l){let S=n;for(let v of S.shallowNodes){let I=Fn.getAlgData(v.node).data;I.force=I.force.add(d)}}else o.force=o.force.add(d);if(c){let S=i;for(let v of S.shallowNodes){let I=Fn.getAlgData(v.node).data;I.force=I.force.sub(d)}}else a.force=a.force.sub(d)}for(let t of e.subgraphsDepthFirst){let n=this.clustersInfo.get(t).barycenter;for(let i of t.shallowNodes)ms.AddGravityForce(n,this.settings.ClusterGravity,lc(i))}}}ComputeForces(){if(this.components!=null)for(let e of this.components)this.ComputeRepulsiveForces(e);else this.ComputeRepulsiveForces(this.nodes);this.edges.forEach(e=>this.AddSpringForces(e));for(let e of this.components){let t=new f(0,0);for(let i=0;i<e.length;i++)t=t.add(e[i].Center);t=t.div(e.length);let n=Number.NEGATIVE_INFINITY;for(let i=0;i<e.length;i++){let o=e[i];ms.AddGravityForce(t,this.settings.GravityConstant,o),o.force.length>n&&(n=o.force.length)}if(n>100)for(let i=0;i<e.length;i++)e[i].force=e[i].force.mul(100/n)}this.AddClusterForces(this.graph)}VerletIntegration(){let e=this.energy;this.energy=this.ComputeDescentDirection(1),this.UpdateStepSize(e);let t=0;for(let n=0;n<this.nodes.length;n++){let i=this.nodes[n];t+=i.Center.sub(i.previousCenter).lengthSquared}return t}ComputeDescentDirection(e){this.ResetForceVectors(),this.settings.ApplyForces&&this.ComputeForces();let t=0;for(let n of this.nodes){t=t+n.force.lengthSquared;let i=n.Center.sub(n.previousCenter).mul(this.settings.Friction),o=n.force.mul(-this.stepSize*e);n.previousCenter=n.Center,Ee.assert(!Number.isNaN(o.x),"!double.IsNaN(a.X)"),Ee.assert(!Number.isNaN(o.y),"!double.IsNaN(a.Y)"),Ee.assert(Number.isFinite(o.x),"!double.IsInfinity(a.X)"),Ee.assert(Number.isFinite(o.y),"!double.IsInfinity(a.Y)"),i=i.add(o),i=i.div(n.stayWeight),n.Center=n.Center.add(i)}return t}ResetForceVectors(){for(let e of this.nodes)e.force=new f(0,0)}UpdateStepSize(e){this.energy<e?++this.progress>=3&&(this.progress=0,this.stepSize/=this.settings.Decay):(this.progress=0,this.stepSize*=this.settings.Decay)}RungeKuttaIntegration(){let e=new Array(this.nodes.length),t=new Array(this.nodes.length),n=new Array(this.nodes.length),i=new Array(this.nodes.length),o=new Array(this.nodes.length),a=this.energy;for(let u=0;u<this.nodes.length;u++)this.nodes[u].previousCenter=this.nodes[u].Center,e[u]=this.nodes[u].Center;let l=3;this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)t[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].Center=e[u].add(t[u].mul(.5));this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)n[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u],this.nodes[u].Center=e[u].add(n[u].mul(.5));this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++)i[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u],this.nodes[u].Center=e[u].add(i[u]);this.energy=this.ComputeDescentDirection(l);for(let u=0;u<this.nodes.length;u++){o[u]=this.nodes[u].Center.sub(this.nodes[u].previousCenter),this.nodes[u].previousCenter=e[u];let c=t[u].add(n[u].mul(2).add(i[u].mul(2)).add(o[u])).div(6);this.nodes[u].Center=e[u].add(c)}return this.UpdateStepSize(a),this.nodes.reduce((u,c)=>c.Center.sub(c.previousCenter).lengthSquared+u,0)}run(){this.settings.Converged=!1,this.settings.EdgeRoutesUpToDate=!1,this.settings.Iterations++==0&&(this.stepSize=this.settings.InitialStepSize,this.energy=Number.MAX_VALUE,this.progress=0);for(let e=0;e<this.settings.MinorIterations;e++){if((this.settings.RungeKuttaIntegration?this.RungeKuttaIntegration():this.VerletIntegration())<this.settings.DisplacementThreshold||this.settings.Iterations>this.settings.MaxIterations){this.settings.Converged=!0;break}this.ProgressStep()}}};function jI(s){for(let e of s.Clusters)return!0;return!1}var Gr=class{constructor(){this.commonSettings=new Ii;this.maxIterations=100;this.clusterMargin=10;this.minorIterations=3;this.projectionIterations=5;this.approximateRepulsion=!0;this.RungeKuttaIntegration=!1;this.initialStepSize=1.4;this.decay=.9;this.friction=.8;this.repulsiveForceConstant=1;this.attractiveForceConstant=1;this.gravity=1;this.interComponentForces=!0;this.applyForces=!0;this.AvoidOverlaps=!0;this.approximateRouting=!0;this.logScaleEdgeForces=!0;this.displacementThreshold=.1;this.maxConstraintLevel=2;this.minConstraintLevel=0;this.attractiveInterClusterForceConstant=1;this.clusterGravity=1;this.commonSettings.NodeSeparation*=2}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get PackingAspectRatio(){return this.commonSettings.PackingAspectRatio}set PackingAspectRatio(e){this.commonSettings.PackingAspectRatio=e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get MaxIterations(){return this.maxIterations}set MaxIterations(e){this.maxIterations=e}get MinorIterations(){return this.minorIterations}set MinorIterations(e){this.minorIterations=e}get Iterations(){return this.iterations}set Iterations(e){this.iterations=e}get ProjectionIterations(){return this.projectionIterations}set ProjectionIterations(e){this.projectionIterations=e}get ApproximateRepulsion(){return this.approximateRepulsion}set ApproximateRepulsion(e){this.approximateRepulsion=e}get InitialStepSize(){return this.initialStepSize}set InitialStepSize(e){if(e<=0||e>2)throw new Error("ForceScalar should be greater than 0 and less than 2 (if we let you set it to 0 nothing would happen, greater than 2 would most likely be very unstable!)");this.initialStepSize=e}get Decay(){return this.decay}set Decay(e){if(e<.1||e>1)throw new Error("Setting decay too small gives no progress.  1==no decay, 0.1==minimum allowed value");this.decay=e}get Friction(){return this.friction}set Friction(e){if(e<0||e>1)throw new Error("Setting friction less than 0 or greater than 1 would just be strange.  1==no friction, 0==no conservation of velocity");this.friction=e}get RepulsiveForceConstant(){return this.repulsiveForceConstant}set RepulsiveForceConstant(e){this.repulsiveForceConstant=e}get AttractiveForceConstant(){return this.attractiveForceConstant}set AttractiveForceConstant(e){this.attractiveForceConstant=e}get GravityConstant(){return this.gravity}set GravityConstant(e){this.gravity=e}get InterComponentForces(){return this.interComponentForces}set InterComponentForces(e){this.interComponentForces=e}get ApplyForces(){return this.applyForces}set ApplyForces(e){this.applyForces=e}ResetLayout(){this.Unconverge(),this.algorithm!=null&&this.algorithm.ResetNodePositions()}Unconverge(){this.iterations=0,this.converged=!1}InitializeLayoutGN(e,t){this.InitializeLayout(e,t)}InitializeLayout(e,t){this.algorithm=new ms(e,this,t),this.ResetLayout()}Uninitialize(){this.algorithm=null}get IsInitialized(){return this.algorithm!=null}IncrementalRunG(e){this.IncrementalRunGF(e)}SetupIncrementalRun(e){this.IsInitialized?this.IsDone&&this.ResetLayout():this.InitializeLayout(e,this.MaxConstraintLevel)}IncrementalRunGF(e){this.SetupIncrementalRun(e),this.algorithm.run()}IncrementalRun(e,t){e!=null&&e.throwIfCanceled(),this.SetupIncrementalRun(t),this.algorithm.cancelToken=e,this.algorithm.run()}Clone(){return Gr.ctorClone(this)}get ApproximateRouting(){return this.approximateRouting}set ApproximateRouting(e){this.approximateRouting=e}get LogScaleEdgeForces(){return this.logScaleEdgeForces}set LogScaleEdgeForces(e){this.logScaleEdgeForces=e}get DisplacementThreshold(){return this.displacementThreshold}set DisplacementThreshold(e){this.displacementThreshold=e}get Converged(){return this.converged}set Converged(e){this.converged=e}get PercentDone(){return this.Converged?100:100*this.iterations/this.MaxIterations}get IsDone(){return this.Converged||this.iterations>=this.MaxIterations}get Energy(){return this.algorithm!=null?this.algorithm.energy:0}get MaxConstraintLevel(){return this.maxConstraintLevel}set MaxConstraintLevel(e){this.maxConstraintLevel!=e&&(this.maxConstraintLevel=e,this.IsInitialized&&this.Uninitialize())}get MinConstraintLevel(){return this.minConstraintLevel}set MinConstraintLevel(e){this.minConstraintLevel=e}getCurrentConstraintLevel(){return this.algorithm==null?0:this.algorithm.getCurrentConstraintLevel()}setCurrentConstraintLevel(e){this.algorithm.setCurrentConstraintLevel(e)}get AttractiveInterClusterForceConstant(){return this.attractiveInterClusterForceConstant}set AttractiveInterClusterForceConstant(e){this.attractiveInterClusterForceConstant=e}static ctorClone(e){let t=new Gr;return t.maxIterations=e.maxIterations,t.minorIterations=e.minorIterations,t.projectionIterations=e.projectionIterations,t.approximateRepulsion=e.approximateRepulsion,t.initialStepSize=e.initialStepSize,t.RungeKuttaIntegration=e.RungeKuttaIntegration,t.decay=e.decay,t.friction=e.friction,t.repulsiveForceConstant=e.repulsiveForceConstant,t.attractiveForceConstant=e.attractiveForceConstant,t.gravity=e.gravity,t.interComponentForces=e.interComponentForces,t.applyForces=e.applyForces,t.AvoidOverlaps=e.AvoidOverlaps,t.RespectEdgePorts=e.RespectEdgePorts,t.RouteEdges=e.RouteEdges,t.approximateRouting=e.approximateRouting,t.logScaleEdgeForces=e.logScaleEdgeForces,t.displacementThreshold=e.displacementThreshold,t.minConstraintLevel=e.minConstraintLevel,t.maxConstraintLevel=e.maxConstraintLevel,t.attractiveInterClusterForceConstant=e.attractiveInterClusterForceConstant,t.clusterGravity=e.clusterGravity,t.PackingAspectRatio=e.PackingAspectRatio,t.NodeSeparation=e.NodeSeparation,t.clusterMargin=e.clusterMargin,t}get ClusterGravity(){return this.clusterGravity}set ClusterGravity(e){this.clusterGravity=e}static CreateFastIncrementalLayoutSettings(){let e=new Gr;return e.ApplyForces=!1,e.ApproximateRepulsion=!0,e.ApproximateRouting=!0,e.AttractiveForceConstant=1,e.AttractiveInterClusterForceConstant=1,e.AvoidOverlaps=!0,e.ClusterGravity=1,e.Decay=.9,e.DisplacementThreshold=5e-8,e.Friction=.8,e.GravityConstant=1,e.InitialStepSize=2,e.InterComponentForces=!1,e.Iterations=0,e.LogScaleEdgeForces=!1,e.MaxConstraintLevel=2,e.MaxIterations=20,e.MinConstraintLevel=0,e.MinorIterations=1,e.ProjectionIterations=5,e.RepulsiveForceConstant=2,e.RespectEdgePorts=!1,e.RouteEdges=!1,e.RungeKuttaIntegration=!0,e.NodeSeparation=20,e}};var Kp=class{constructor(e){this.topNodes=e}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let e of this.topNodes)if(yield Ge.getGeom(e),e instanceof de)for(let t of e.nodesBreadthFirst)yield Ge.getGeom(t)}get Clusters(){return this.clusters()}*clusters(){for(let e of this.topNodes)e instanceof de&&(yield re.getGeom(e))}get subgraphsDepthFirst(){return this.subgraphsDepthFirst_()}*subgraphsDepthFirst_(){for(let e of this.topNodes)if(e instanceof de){let t=re.getGeom(e);yield*t.subgraphsDepthFirst,yield t}}get shallowEdges(){return this.edges_()}*edges_(){for(let e of this.topNodes){for(let t of e.outEdges)yield be.getGeom(t);for(let t of e.selfEdges)yield be.getGeom(t)}}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.topNodes)yield Ge.getGeom(e)}pumpTheBoxToTheGraphWithMargins(){let e={b:z.mkEmpty()};return Qh(this,e),this.boundingBox=e.b}get shallowNodeCount(){return this.topNodes.length}translate(e){this.boundingBox&&(this.boundingBox.center=this.boundingBox.center.add(e));for(let t of this.topNodes)Ge.getGeom(t).translate(e)}};var kd=class{static LinearInterpolation(e,t,n,i,o){if(e<t)return i;if(e>n)return o;let a=(e-t)/(n-t);return i+a*(o-i)}static NegativeLinearInterpolation(e,t,n,i,o){if(e<t)return o;if(e>n)return i;let a=(e-t)/(n-t);return i+(1-a)*(o-i)}};var Qp=class extends Pe{constructor(e,t){super(null);this.SingleComponent=!1;this.graph=e,this.settings=Gr.ctorClone(t),this.settings.ApplyForces=!0,this.settings.InterComponentForces=!0,this.settings.RungeKuttaIntegration=!1,this.settings.RespectEdgePorts=!1}run(){if(this.SingleComponent)this.componentCount=1,this.LayoutComponent(this.graph);else{let e=Array.from(this.graph.graph.getClusteredConnectedComponents()).map(t=>new Kp(t));this.componentCount=e.length;for(let t of e)this.LayoutComponent(t);this.graph.boundingBox=cs.PackGraphs(e,this.settings.commonSettings)}}LayoutComponent(e){if(e.shallowNodeCount>1){if(this.settings.MaxIterations=kd.NegativeLinearInterpolation(e.shallowNodeCount,50,500,5,10),this.settings.MinorIterations=kd.NegativeLinearInterpolation(e.shallowNodeCount,50,500,3,20),this.settings.MinConstraintLevel==0){let n=new Dn;n.removeOverlaps=!1,n.IterationsWithMajorization=0,new sc(e,null,()=>1,new Dn).run()}let t=new ms(e,this.settings,this.settings.MinConstraintLevel);for(let n of this.GetConstraintLevels(e)){if(n>this.settings.MaxConstraintLevel)break;n>this.settings.MinConstraintLevel&&t.setCurrentConstraintLevel(n);do t.run();while(!this.settings.IsDone)}this.settings.AvoidOverlaps&&Kr.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation)}e.pumpTheBoxToTheGraphWithMargins(),e.uniformMargins=this.settings.NodeSeparation,e.translate(e.boundingBox.leftBottom.mul(-1))}GetConstraintLevels(e){let t=new Set;return t.add(0),this.settings.AvoidOverlaps&&e.shallowNodeCount<2e3&&t.add(2),t}};function FS(s){s.layoutSettings||(s.layoutSettings=_S(s))}function qI(s){let e=s.parent;for(;e;){if(e.layoutSettings)return e.layoutSettings;e=e.parent}return null}function _S(s){let e=qI(s);if(e)return e;if(s.graph.shallowNodeCount>2e3||s.graph.deepEdgesCount()>4e3)return new Gr;let n=!1;for(let i of s.deepEdges)if(i.sourceArrowhead!=null||i.targetArrowhead!=null){n=!0;break}return n?new Ot:new Gr}function XI(s,e){if(FS(s),s.layoutSettings instanceof Ot)new fc(s,s.layoutSettings,e).run();else if(s.layoutSettings instanceof Dn)new sc(s,e,()=>1,s.layoutSettings).run();else if(s.layoutSettings instanceof Gr){let t=new Qp(s,s.layoutSettings);t.SingleComponent=!0,t.run()}else throw new Error("not implemented")}function hc(s,e=null){FS(s),ac(s,e,XI,ma,Kh)}function Jp(s){do{if(s.layoutSettings&&s.layoutSettings.commonSettings.edgeRoutingSettings)return s.layoutSettings.commonSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=ce.getGeom(t);else break}while(!0);let e=new uo;return e.EdgeRoutingMode=0,e}function ma(s,e,t){let n=Jp(s);n.EdgeRoutingMode===4?VS(s,e,t):n.EdgeRoutingMode===0||n.EdgeRoutingMode===1?US(s,e,t):n.EdgeRoutingMode===2?_d(s,e,t):n.EdgeRoutingMode!==6&&new Fe(s,e).run(),kS(s,e)}function ac(s,e,t,n,i,o=1){if(s.graph.isEmpty())return;s.parent==null&&(pl(o),QI(s));let a=d();h(s);let l=YI(s.graph),u=KI(s);if(m(),l.forEach(P=>{P[0].edge.remove(),P[1].add()}),u.forEach(P=>{for(let S of P.graph.shallowNodes)S.parent=s.graph}),a.forEach(P=>P.add()),s.graph.parent==null){let P=c(s);n(s,P,e),kS(s,P),s.pumpTheBoxToTheGraphWithMargins()}function c(P){let S=[];for(let v of P.nodesBreadthFirst){for(let I of v.outEdges())I.curve==null&&S.push(I);for(let I of v.selfEdges())I.curve==null&&S.push(I)}return S}function h(P){for(let S of P.shallowNodes)S instanceof re&&ac(S,e,t,n,i)}function d(){let P=new Set,S=s.graph;if(S.parent==null)return P;for(let v of S.shallowNodes){for(let I of v.outEdges){let L=S.liftNode(I.target);(L==null||L===v)&&P.add(I)}for(let I of v.inEdges){let L=S.liftNode(I.source);(L==null||L===v)&&P.add(I)}}for(let v of P)v.remove();return P}function m(){if(u.length===1)t(s,e);else{for(let P of u)t(P,e),P.boundingBox=P.pumpTheBoxToTheGraphWithMargins();i(s,u)}}}function YI(s){let e=new Array;for(let t of s.nodesBreadthFirst){let n=s.liftNode(t);if(n!=null)for(let i of t.outEdges.values()){let o=i.target,a=s.liftNode(o);if(a==null||n===t&&a===o||n===a)continue;i.remove();let l=new et(n,a),u=new be(l);e.push([u,i])}}return e}function KI(s){var o;let e=s.graph,t=c0(e),n=[],i=0;for(let a of t){let l=new de(e.id+i++);l.parent=e;let u=new re(l);u.layoutSettings=(o=s.layoutSettings)!=null?o:_S(s);for(let c of a)c.parent=l,l.addNode(c);n.push(u)}return n}function VS(s,e,t,n=1,i=3){us.constructorGNAN(s,e,n,i).run()}function kS(s,e){if(e.length===0)return;Zr.constructorGA(s,e).run()}function QI(s){for(let e of s.deepEdges)e.label&&(e.label.isPositioned=!1)}function dc(s){if(re.getGeom(s)==null)return!1;for(let e of s.shallowNodes){let t=ce.getGeom(e);if(t==null||t.boundaryCurve==null||e instanceof de&&dc(e)===!1)return!1}for(let e of s.edges)if(be.getGeom(e)==null)return!1;return!0}function Ud(s){let e=re.getGeom(s);if(e==null||e.boundingBox==null||e.boundingBox.isEmpty())return!1;for(let t of s.shallowNodes){let n=ce.getGeom(t);if(n==null||n.boundaryCurve==null||t instanceof de&&Ud(t)===!1)return!1}for(let t of s.deepEdges){let n=be.getGeom(t);if(n==null||n.curve==null)return!1}return!0}var gc=class{static constructorStatic(e,t){let n=new gc;n.edges=e,n.nodeBoundaries=t,n.boundingBox=z.mkEmpty();for(let i of n.nodeBoundaries)n.boundingBox=n.boundingBox.addRec(i.boundingBox);return n}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=ti(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var WS=Ae(Ln());var Pa=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,n){this.currentTriangle=e,this.start=t,this.end=n}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!==t&&f.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.Edges.item0;let n=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!==n&&f.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=n,this.currentTriangle.Edges.item1):(this.positiveSign=n,this.negativeSign=e,this.currentTriangle.Edges.item2)}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.Edges.index(this.currentPiercedEdge),t,n=this.currentTriangle.Sites.getItem(e+2),i=this.GetHyperplaneSign(n);this.negativeSign===0?i===-1||i===0?(this.negativeSign=i,t=e+1):t=e+2:this.positiveSign===0?i===1||i===0?(this.positiveSign=i,t=e+2):t=e+1:i!==this.positiveSign?(this.negativeSign=i,t=e+1):(this.positiveSign=i,t=e+2),this.currentPiercedEdge=f.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-C.distanceEpsilon?this.currentTriangle.Edges.getItem(t):null}GetHyperplaneSign(e){let t=f.signedDoubledTriangleArea(this.start,e.point,this.end);return t>C.distanceEpsilon?1:t<-C.distanceEpsilon?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var mc=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,n,i){if(He.PointIsInsideOfTriangle(t,n))return!0;let o=new Pa(n,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.constrained){let l=a.lowerSite.Owner;if(!i.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,n,i,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.cdtTriangle,i,n,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,n,i,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,n,i,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new hs;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(i.has(d))continue;let m=mc.FindPolylinePoint(d,h.point),P=R.minDistBetweenLineSegments(m.point,m.nextOnPolyline.point,t,n),S=P.dist,v=P.parab,I=P.parcd,L=R.minDistBetweenLineSegments(m.point,m.prevOnPolyline.point,t,n),D=L.dist,w=L.parab,M=L.parcd,K,X,se;if(S<D){if(se=S,se>o)continue;K=m.point.add(m.nextOnPolyline.point.sub(m.point).mul(v)),X=t.add(n.sub(t).mul(I))}else{if(se=D,se>o)continue;K=m.point.add(m.prevOnPolyline.point.sub(m.point).mul(w)),X=t.add(n.sub(t).mul(M))}a.get(d)||a.set(d,[K,X])}return a}ThreadLineSegmentThroughTriangles(e,t,n,i,o){if(He.PointIsInsideOfTriangle(n,e))return o.push(e),!0;let a=new Pa(e,t,n);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.constrained){let u=l.lowerSite.Owner;if(!i.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let n=!1;for(let i=0;i<3;i++){let o=f.signedDoubledTriangleArea(e,t.Sites.getItem(i).point,t.Sites.getItem(i+1).point);if(o<C.distanceEpsilon*-1)return 0;o<C.distanceEpsilon&&(n=!0)}return n?1:2}static FindPolylinePoint(e,t){for(let n of e.polylinePoints())if(n.point.equal(t))return n;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,n,i){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.cdtTriangle,n,i,a,o)}EdgeIsLegalSSPPS(e,t,n){let i=e.Position,o=e.cdtTriangle,a=t.Position;if(He.PointIsInsideOfTriangle(a,o))return!0;let l=new Pa(o,i,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.constrained){let c=u.lowerSite.Owner;if(!n.has(c))return!1}}return!0}};var en=class{constructor(e,t,n,i){this.metroGraphData=e,this.obstaclesToIgnoreLambda=i,this.bundlingSettings=t,this.obstacleTree=n}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?ti(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,n,i){let o={minimalDistance:n};return en.IntersectCircleWithTree(this.obstacleTree,t,n,this.obstaclesToIgnoreLambda(e),i.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,n){let i={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,n,i,o)}GetMinimalDistanceToObstacles(e,t,n){let i=new Array,o={minimalDistance:n};return en.IntersectCircleWithTree(this.obstacleTree,t,n,this.obstaclesToIgnoreLambda(e),i,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,n,i,o){return i.touchedObstacles=new Array,o.minimalDistance=t,en.IntersectCircleWithTree(this.obstacleTree,e,t,n,i.touchedObstacles,o)}static IntersectCircleWithTree(e,t,n,i,o,a){if(!e.irect.contains_point_radius(t,n))return!0;if(e.UserData==null){let l=en.IntersectCircleWithTree(e.Left,t,n,i,o,a);if(!l||(l=en.IntersectCircleWithTree(e.Right,t,n,i,o,a),!l))return!1}else{let l=e.UserData;if(i.has(l))return!0;if(x.PointRelativeToCurveLocation(t,l)!==0)return en.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=n&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,n,i){let o=t.sub(e).normalize();return o=new f(o.y,o.x*-1),ee.mkFromPoints([e.add(o.mul(n/2)),e.sub(o.mul(n/2)),t.sub(o.mul(i/2)),t.add(o.mul(i/2))])}};var Zp=class{constructor(e,t,n,i){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=n,this.Index=i}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var $p=class{constructor(e,t,n){this.metroline=e,this.station=t,this.polyPoint=n}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var eb=class{constructor(e,t,n){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=n}debStop(){return this.SerialNumber===28&&this.Position.sub(new f(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var tb=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Mt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new Pr(Le);for(let i of this.metroGraphData.VirtualStations())t.Enqueue(i,-this.CalculatePotential(i,e));let n=!1;for(;!t.IsEmpty();){let i={priority:0},o=t.DequeueAndGetPriority(i);if(i.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),n=!0)}return n}TryGrowHub(e,t){let n=this.CalculateAllowedHubRadius(e);if(e.Radius>=n)return!1;let i=t?Mt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=i)return!1;let a=.05*(i-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,n);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let n=t?Mt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return n<=e.Radius?0:(n-e.Radius)/n}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let i of e.Neighbors){let o=i.Position.sub(e.Position).length;t=Math.min(t,o/1.05-i.Radius)}let n=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return n<t&&(t=n-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,n){let i=1;for(let o of n.Neighbors){let l=e.GetWidthSSN(o,n,t.EdgeSeparation)/2+t.EdgeSeparation;i=Math.max(i,l)}return i=Math.min(i,2*t.MaxHubRadius),i}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,n){return Mt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,n,n.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,n,i){let o=Mt.CalculateIdealHubRadius(e,t,n);if(n.Neighbors.length>1){let a=n.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Mt.GetMinRadiusForTwoAdjacentBundles(o,n,i,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let n=e.MaxHubRadius;for(let i of t.Neighbors)n=Math.min(n,t.Position.sub(i.Position).length/2);return n}static GetMinRadiusForTwoAdjacentBundles(e,t,n,i,o,a,l){let u=a.GetWidthSSN(t,i,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,n,i.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,n,i,o,a,l){if(o<C.distanceEpsilon||a<C.distanceEpsilon)return e;let u=f.anglePCP(n,t,i);if(u=Math.min(u,Math.PI*2-u),u<C.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),m=a/(4*c),P=2*Math.sqrt(d*d+(m*m+2*(d*(m*h))));return P=Math.min(P,2*l.MaxHubRadius),P=Math.max(P,e),P}};var ya=class{constructor(e,t,n,i){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=n,this.cdt=i}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],n=e[1],i=this.metroGraphData.GetIjInfo(t,n);i.cachedBundleCost=this.costCalculator.BundleCost(t,n,t.Position),t.cachedBundleCost+=i.cachedBundleCost,n.cachedBundleCost+=i.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.getRectangleNodeOnTriangles();e.cdtTriangle=t.FirstHitNodeWithPredicate(e.Position,ya.testPointInside).UserData,e.cachedIdealRadius=Mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let n of e.Neighbors){n.IsReal||(n.cachedIdealRadius=Mt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,n),n.cachedRadiusCost=this.costCalculator.RadiusCost(n,n.Position));let i=this.metroGraphData.GetIjInfo(e,n);n.cachedBundleCost-=i.cachedBundleCost,i.cachedBundleCost=this.costCalculator.BundleCost(e,n,e.Position),e.cachedBundleCost+=i.cachedBundleCost,n.cachedBundleCost+=i.cachedBundleCost}}static testPointInside(e,t){return He.PointIsInsideOfTriangle(e,t)?1:0}};var pc=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size===0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let n=this.mainMap.get(e);if(n)return n.get(t)}has(e,t){let n=this.mainMap.get(e);return n?n.has(t):!1}set(e,t,n){let i=this.mainMap.get(e);i||(i=new Map,this.mainMap.set(e,i)),i.set(t,n)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[n,i]of t)yield[e,n,i]}*keys(){for(let[e,t]of this.mainMap)for(let[n]of t)yield[e,n]}};var rb=class{constructor(e,t,n,i,o,a,l,u){this.cachedEnterableLooseForEnd=new pt;this.bundlingSettings=i,this.regularEdges=e,o!=null?this.cdt=o:this.cdt=Dd(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new en(this,i,t,c=>c.getELP()),this.tightIntersections=new en(this,i,n,c=>c.EnterableTightPolylines),this.cdtIntersections=new mc(this,i),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],i=this.edgeInfoDictionary.get(n[0],n[1]);return i?i.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(n[0],n[1])}MoveNode(e,t){let n=e.Position;this.PointToStations.deleteP(n),this.PointToStations.set(t,e),e.Position=t;for(let i of this.MetroNodeInfosOfNode(e))i.PolyPoint.point=t;for(let i of this.MetroNodeInfosOfNode(e)){let o=i.Metroline,a=i.PolyPoint.prev.point,l=i.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(n).length-a.sub(n).length}for(let i of e.Neighbors)this.ink+=t.sub(i.Position).length-n.sub(i.Position).length;this.SortNeighbors(e);for(let i of e.Neighbors)this.SortNeighbors(i)}GetWidthSSN(e,t,n){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(i[0],i[1]);return o?o.Width+(o.Count-1)*n:0}GetWidthAN(e,t){let n=0;for(let o of e)n+=o.Width;let i=e.length;return n+=i>0?(i-1)*t:0,n}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,n=new WS.Stack,i=new We;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(i.has(o.point)){let l=o.next;do{let u=n.top;if(!u.equal(a))i.delete(u),n.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else n.push(a),i.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new pt;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!==e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let n=new eb(this.Stations.length,t,e.point);this.PointToStations.set(e.point,n),this.Stations.push(n)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let n=new Zp(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(n),this.PointToStations.get(n.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(n.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let n=this.PointToStations.get(t.Polyline.start),i;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,n=i)i=this.PointToStations.get(o.next.point),Ks(e,n,i),Ks(e,i,n)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new f(360.561,428.416)).length<.1&&t.Position.sub(new f(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let n=this.edgeInfoDictionary.get(e,t);return n||(n=new tb,this.edgeInfoDictionary.set(e,t,n),n)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new pc,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let n=this.metrolines[t];this.InitMetroNodeInfos(n),this.InitNodeEnterableLoosePolylines(n,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(n,this.regularEdges[t]),n.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let n=this.PointToStations.get(t.point);n.MetroNodeInfos.push(new $p(e,n,t))}}InitNodeEnterableLoosePolylines(e,t){let n=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let i=e.Polyline.startPoint.next;i!=null&&i.next!=null;i=i.next){let o=this.PointToStations.get(i.point);o.getELP()!=null?o.setELP(ri(o.getELP(),n)):o.setELP(new Set(n))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let n of this.LooseTree.AllHitItems_(e))x.PointRelativeToCurveLocation(e,n)===2&&t.AddEnterableLoosePolyline(n);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let n of this.TightTree.AllHitItems_(e))x.PointRelativeToCurveLocation(e,n)===2&&t.AddEnterableTightPolyline(n)}InitNodeEnterableTightPolylines(e,t){let n=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let i=e.Polyline.startPoint.next;i!=null&&i.next!=null;i=i.next){let o=this.PointToStations.get(i.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=ri(a,n):o.EnterableTightPolylines=new Set(n)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,n=e.Position;e.Neighbors.sort((i,o)=>Vi(t.sub(n),i.Position.sub(n),o.Position.sub(n)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,n=this.PointToStations.get(t.start),i;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,n=i){i=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(n,i);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.cdt.getRectangleNodeOnTriangles();for(let t of this.Stations)t.cdtTriangle=e.FirstHitNodeWithPredicate(t.Position,ya.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let n=e.sourceAndTargetLoosePolylines();return x.PointRelativeToCurveLocation(t,n[0])===0&&x.PointRelativeToCurveLocation(t,n[1])===0}};function Vi(s,e,t){let n=f.crossProduct(s,t),i=s.dot(t),o=f.crossProduct(s,e),a=s.dot(e);return ie(o,0)&&bc(a,0)?ie(n,0)&&bc(i,0)?0:1:ie(n,0)&&bc(i,0)?-1:ie(o,0)||ie(n,0)||o*n>0?Nu(f.crossProduct(t,e),0):-Nu(Math.sign(o),0)}function bc(s,e){return Nu(s,e)>=0}var HS=Ae(Ln());var ki=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,n){return(e-t)*n.InkImportance}static PathLengthsError(e,t,n,i){return(e-t)*(i.PathLengthImportance/n)}static RError(e,t,n){return e<=t?0:n.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,n){return e<=t?0:n.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let n=t.InkImportance*e.Ink;for(let i of e.Metrolines)n+=t.PathLengthImportance*i.Length/i.IdealLength;return n+=this.CostOfForces(e),n}static CostOfForces(e){let t=0;for(let n of e.VirtualStations())t=t+n.cachedRadiusCost;for(let n of e.VirtualEdges()){let i=n[0],o=n[1];t+=e.GetIjInfo(i,o).cachedBundleCost}return t}InkGain(e,t){let n=this.metroGraphData.Ink,i=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;i-=a.sub(e.Position).length,i+=a.sub(t).length}return ki.InkError(n,i,this.bundlingSettings)}PathLengthsGain(e,t){let n=0;for(let i of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=i.Metroline.Length,a=i.PolyPoint.prev.point,l=i.PolyPoint.next.point,u=i.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;n+=ki.PathLengthsError(o,u,i.Metroline.IdealLength,this.bundlingSettings)}return n}RadiusGain(e,t){let n=0;return n=n+e.cachedRadiusCost,n=n-this.RadiusCost(e,t),n}RadiusCost(e,t){let n;f.closeDistEps(e.Position,t)?n=e.cachedIdealRadius:n=Mt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let i={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,n,i))return ki.Inf;let o=0;for(let a of i.touchedObstacles){let l=a[1].sub(t).length;o+=ki.RError(n,l,this.bundlingSettings)}return o}BundleGain(e,t){let n=e.cachedBundleCost;for(let i of e.Neighbors){let o=this.BundleCost(e,i,t);if(bc(o,ki.Inf))return-ki.Inf;n-=o}return n}BundleCost(e,t,n){let i=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,n,t.Position,i,o))return ki.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=ki.BundleError(i/2,u,this.bundlingSettings)}return a}},Er=ki;Er.Inf=1e9;var zS=Ae(Qn());var nb=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new pt;this.interestingPoints=new We;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){JI(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){ZI(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new zS.Queue;for(let n of this.Polylines)t.enqueue(n);for(;t.length>0;){let n=t.dequeue();e.delete(n);let i=this.ProcessPolyline(n);i!=null&&(e.has(n)||(e.add(n),t.enqueue(n)),e.has(i)||(e.add(i),t.enqueue(i)))}}ProcessPolyline(e){let t=new Map;for(let n=e.startPoint.next;n!=null;n=n.next){this.FillDepartedPolylinePoints(n,t);for(let i of this.pathsThroughPoints.get(n.point)){let o=t.get(i.polyline);if(o){if(this.ProcessFlip(n,o))return i.polyline;t.delete(i.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let n=e.prev.point;for(let i of this.pathsThroughPoints.get(n))this.IsNeighborOnTheSamePolyline(i,e)||t.has(i.polyline)||t.set(i.polyline,i)}ProcessFlip(e,t){let n=e.polyline,i=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(n),u=this.polylineToEdgeGeom.get(i);if(l.lineWidth!==u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!Ys(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(n,o,a),h=c[0],d=c[1],m=c[2];c=this.FindPointsOnPolyline(i,o,a);let P=c[0],S=c[1],v=c[2],I=this.FindRelationOnFirstPoint(h,P,m,v),L=this.FindRelationOnLastPoint(d,S,m,v);return I!==2&&L!==2||I===1||L===1?!1:(this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.Swap(h,P,d,S,m,v),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,n){let i,o;for(let a=e.startPoint;a!=null;a=a.next)if(i==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];i=a}else o==null&&a.point.equal(n)&&(o=a);else if(a.point.equal(n))return[i,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let n=e;n!=null;n=n.next)if(n===t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,n,i){let o=e,a=t;for(;;){let l=this.Prev(e,n),u=this.Prev(t,i);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,n,i)}FindRelationOnLastPoint(e,t,n,i){let o=e,a=t;for(;;){let l=this.Next(e,n),u=this.Next(t,i);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,n).point.equal(this.Prev(t,i).point);)e=this.Next(e,n),t=this.Prev(t,i);return this.PolylinesIntersect(e,t,o,a,n,i)}PolylinesIntersect(e,t,n,i,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(n,o),h=this.Prev(n,o),d=this.Next(t,a),m=this.Prev(i,a);if(e.point.equal(n.point)){let P=e.point,S=Vi(h.point.sub(P),m.point.sub(P),u.point.sub(P)),v=Vi(h.point.sub(P),d.point.sub(P),u.point.sub(P));return S===v?1:2}else{let P=Vi(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),S=Vi(c.point.sub(n.point),m.point.sub(n.point),h.point.sub(n.point));return P===S?1:2}}Swap(e,t,n,i,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),n,o),u=this.GetRangeOnPolyline(this.Next(t,a),i,a);this.ChangePolylineSegment(e,n,o,u),this.ChangePolylineSegment(t,i,a,l),ps.RemoveSelfCyclesFromPolyline(e.polyline),ps.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,n,i){let o=e;for(let a of i){let l=Lt.mkFromPoint(a.point);l.polyline=o.polyline,n?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}n?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,n){let i=new Array;for(let o=e;o!==t;o=this.Next(o,n))i.push(o);return i}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new We;for(let n=e.startPoint;n!=null;n=n.next){if(n===e.startPoint){if(n.prev!=null)return!1}else if(n.prev.next!==n)return!1;if(n===e.endPoint){if(n.next!=null)return!1}else if(n.next.prev!==n)return!1;if(t.has(n.point))return!1;t.add(n.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function JI(s,e,t){let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)}function ZI(s,e,t){let n=s.get(e);!n||(n.delete(t),n.size===0&&s.deleteP(e))}var ps=class{constructor(e,t){this.foundCrossings=new We;this.crossingsThatShouldBecomeHubs=new We;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new Fi;for(let t of this.Vertices())t.next&&e.set(new at(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length===0)return!1;let e=new Fi,t=new Ti(null);for(let l of this.Vertices()){let u=z.mkOnPoints([l.point]);u.pad(C.intersectionEpsilon),t.Add(u,l.point)}let n=Vs(this.Edges(),l=>z.mkPP(l.first,l.second));Gt(n,n,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let i=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||i||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((n,i)=>Le(_e(n,e.first),_e(i,e.first)))}InsertPointsIntoPolylines(e){let t=!1;for(let n of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(n,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let n=!1;for(let i=e.Polyline.startPoint;i.next!=null;i=i.next)this.InsertPointsOnPolypoint(i,t,e)&&(n=!0);return n}InsertPointsOnPolypoint(e,t,n){let i=new at(e.point,e.next.point),o=e.point!==i.first,a=t.get(i);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(n,a[c]))continue;let h=Lt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(n,a[c]))continue;let h=Lt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)ps.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,n=new pt;for(let i=e.startPoint;i!=null;i=i.next){let o=i.point,a=n.get(o);if(a){for(let l=a.next;l!==i.next;l=l.next)n.deleteP(l.point);a.next=i.next,i.next.prev=a,t=!0}else n.set(i.point,i)}return t}ReduceEdgeCrossings(){let e=new nb(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=V0(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let n=e.startPoint.next;n!=null&&n.next!=null;n=n.next)if(this.pointsToDelete.has(n.point)&&f.getTriangleOrientation(n.prev.point,n.point,n.next.point)===2){let i=n.prev,o=n.next;i.next=o,o.prev=i,n=i,t=!0}return t}IntersectTwoEdges(e,t,n,i){let o=R.IntersectPPPP(e.first,e.second,t.first,t.second);if(o){let a=this.FindExistingVertexOrCreateNew(i,o);(this.AddVertexToSplittingList(e,n,a)||this.AddVertexToSplittingList(t,n,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let n=e.RootNode.FirstHitNode(t);if(n!=null)return n.UserData;let i=z.mkOnPoints([t]);return i.pad(C.intersectionEpsilon),e.Add(i,t),t}AddVertexToSplittingList(e,t,n){if(!x.closeIntersectionPoints(n,e.first)&&!x.closeIntersectionPoints(n,e.second)){let i=t.get(e);if(i||(i=new Array,t.set(e,i)),!i.find(o=>o.equal(n)))return i.push(n),!0}return!1}};var Wd=class{isCorrectlyOrienected(){return f.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!==1}get Count(){return this.points.length}constructor(e,t,n,i){this.BelongsToRealNode=i,this.Curve=t,this.Position=n,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return f.middle(this.StartPoint,this.EndPoint)}get Span(){return this.SpanBetweenTwoParameters(this.parStart,this.parEnd)}SpanBetweenTwoParameters(e,t){return e<=t?t-e:t-e+wn(this.Curve)}RotateLeftPoint(e,t){return e===0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e===0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,n){let i=wn(this.Curve)*n;return t+=e*i,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,n){let i=wn(this.Curve)*n;e!==0&&(this.ParStart=this.AdjustParam(this.ParStart+e*i)),t!==0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*i))}RelativeOrderOfBasesIsPreserved(e,t,n){let i=wn(this.Curve)*n,o=this.parStart+e*i,a=this.parStart<this.parEnd?this.parEnd+t*i:this.parEnd+wn(this.Curve)+t*i;if(o>a||this.SpanBetweenTwoParameters(o,a)>wn(this.Curve)/2)return!1;if(this.Prev==null||this.SpanBetweenTwoParameters(this.Prev.ParMid,this.ParMid)>i&&this.SpanBetweenTwoParameters(this.ParMid,this.Next.ParMid)>i)return!0;let l=this.RotateLeftPoint(t,n),u=this.RotateRigthPoint(e,n),c=f.middle(l,u),h=this.MidPoint;return!(f.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=f.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||f.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=f.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var Sa=class{constructor(e,t,n,i){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=n,this.HalfWidthArray=i,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let n=this.SourceBase.Curve.boundingBox.diagonal/2,i=this.TargetBase.Curve.boundingBox.diagonal/2,o=en.Create4gon(this.SourceBase.Position,this.TargetBase.Position,n*2,i*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&x.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,n=e.sub(t).normalize(),i=n.rotate90Ccw(),o=f.middle(e,t),a=n.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(i.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>Sa.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(i.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=Sa.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(i.mul(Sa.FeasibleWidthEpsilon),new f(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new f(0,0),i.mul(-Sa.FeasibleWidthEpsilon),l,u))&&(d=2*Sa.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"./tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,n){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,n)}SetRLParamsIfWidthIsFeasible_(e,t,n,i){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(R.mkPP(n.add(e),i.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>x.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(R.mkPP(n.add(t),i.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>x.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(R.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"./tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,n){let i=x.getAllIntersections(e,this.SourceBase.Curve,!0);if(i.length===0)return n.par=0,t.par=0,null;let o;if(i.length===1?o=i[0]:this.SourceBase.IsParent?o=i[0].par0<i[1].par0?i[1]:i[0]:o=i[0].par0<i[1].par0?i[0]:i[1],i=x.getAllIntersections(e,this.TargetBase.Curve,!0),i.length===0)return n.par=0,t.par=0,null;let a;return i.length===1?a=i[0]:this.TargetBase.IsParent?a=i[0].par0>i[1].par0?i[1]:i[0]:a=i[0].par0>i[1].par0?i[0]:i[1],t.par=o.par1,n.par=a.par1,R.mkPP(o.x,a.x)}RotateBy(e,t,n,i,o){let a=e!==0||t!==0,l=n!==0||i!==0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(n,i,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let n=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),i=n.length;i>=C.tolerance&&(n=n.div(i),this.TargetBase.Tangents[t]=n,this.SourceBase.Tangents[e-1-t]=n.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,n=e.Points,i=R.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];n[0]=i.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],n[l]=i.value(a*o)}RotationIsLegal(e,t,n,i,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!==0||n!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||i!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!==0||i!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||n!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!==0||t!==0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(n!==0||i!==0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(n,i,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(n=>x.intersectionOne(R.mkPP(e,t),n,!1)!=null)==null}},zd=Sa;zd.FeasibleWidthEpsilon=.1;var Hd=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,n,i){this.Segment=e,this.Reversed=t,this.Index=n,this.BundleBase=i}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var qe=class{constructor(e,t,n){this.fixedBundles=new hs;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=n}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=he.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let n=new Wd(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,n);let i=new Wd(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,i),x.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!==0?(n.IsParent=!0,Qs(this.internalBases,e,n),Qs(this.externalBases,t,i)):x.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!==0?(i.IsParent=!0,Qs(this.externalBases,e,n),Qs(this.internalBases,t,i)):(Qs(this.externalBases,e,n),Qs(this.externalBases,t,i));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new zd(n,i,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));n.OutgoingBundleInfo=i.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,n=e[0].CurveCenter;e.sort((i,o)=>Vi(t.sub(n),i.OppositeBase.Position.sub(n),o.OppositeBase.Position.sub(n)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let n=0;n<t;n++)e[n].Prev=e[(n-1+t)%t],e[n].Next=e[(n+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let n=this.metroGraphData.PointToStations.get(t.prev.point),i=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=i.BundleBases.get(n),l=i.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(n,i,e),c=this.metroOrdering.GetLineIndexInOrder(o,i,e),h=a.OrientedHubSegments[u]=new Hd(null,!1,u,a),d=l.OrientedHubSegments[c]=new Hd(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,n=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,n.Position),n.ParEnd=n.ParStart=this.GetBaseMiddleParamInDirection(n,n.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,n){let i=e.Curve;if(i instanceof he){let l=i;if(l.isArc())return f.angle(l.aAxis,n.sub(t))}let a=x.getAllIntersections(i,R.mkPP(t,n),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(n))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let n=0;n<t;n++){let i=e[n],o=i.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(i,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let n=$I(e,t);if(n==null||ie(n.start,n.end))return;let i=n.rbaseMiddle,o=n.lbaseMiddle;if(i<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(n.end*a+n.start*l)/(l+a);e.ParStart=e.AdjustParam(u+C.distanceEpsilon),t.ParEnd=t.AdjustParam(u-C.distanceEpsilon)}RegularCut(e,t,n,i,o,a){let l=(o*i+a*e)/(o+a),u=Math.min(t,i),c=Math.max(e,n);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=qe.MaxParameterChange,t={cost:this.Cost()},n=0;for(;n++<qe.MaxIterations;){let i=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,i,t.cost),e<qe.MinParameterChange)break}}UpdateParameterChange(e,t,n){return n+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let n=!1;for(let i of this.Bundles)this.fixedBundles.has(i)||(this.OptimizeBundle(i,e,t)?n=!0:this.fixedBundles.add(i));return n}OptimizeBundle(e,t,n){let i=this.CostBi(e);if(i<qe.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<qe.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(qe.Deltas[u][0],qe.Deltas[u][1],0,0,e,i,t);c>qe.CostDeltaThreshold&&c>o&&(l=u,a=qe.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,qe.Deltas[u][0],qe.Deltas[u][1],e,i,t),c>qe.CostDeltaThreshold&&c>o&&(l=qe.Deltas.length-1,a=u,o=c)}return o<qe.CostDeltaThreshold?!1:(n.cost-=o,e.RotateBy(qe.Deltas[l][0],qe.Deltas[l][1],qe.Deltas[a][0],qe.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,n,i,o,a,l){if(!o.RotationIsLegal(e,t,n,i,l))return 0;o.RotateBy(e,t,n,i,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,n*-1,i*-1,l),a-u}CostBi(e){return qe.SeparationCoeff*this.SeparationCost(e)+(qe.SqueezeCoeff*this.SqueezeCost(e)+(qe.AssymetryCoeff*this.AssymetryCost(e)+qe.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let n=0;return n=n+qe.CenterCoeff*this.CenterCostBi(e),n>t||(n=n+qe.SeparationCoeff*this.SeparationCost(e),n>t)||(n=n+qe.SqueezeCoeff*this.SqueezeCost(e),n>t)||(n=n+qe.AssymetryCoeff*this.AssymetryCost(e)),n}SqueezeCost(e){let n=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),i=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(n)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(n)),a=Math.abs(e.TotalRequiredWidth-i)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(i-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,n=Math.min(e.InitialMidParameter,t),i=Math.max(e.InitialMidParameter,t),o=Math.min(i-n,n+(wn(e.Curve)-i));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,n=0;for(let i of e.OrientedHubSegments){let o=i.Index,a=i.Other.Index,l=e.Points[o],u=e.Tangents[o],c=i.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],m=e.Count+c.Count;n+=this.GetAssymetryCostOnData(l,u,h,d,t)/m}return n}GetAssymetryCostOnData(e,t,n,i,o){let a=e.sub(n),l=a.length;if(l<C.distanceEpsilon)return 0;let u=t.add(i).dot(a),c=f.crossProduct(a,t),h=f.crossProduct(a,i),d=c-h,m=u*u+d*d,P=c*c+h*h;return 10*m+o*P}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let n=e.Curve,i=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,n),o=Math.min(e.Span,t.Span);return Math.exp(i/(o*10))-1}IntervalsOverlapLength(e,t,n,i,o){let a=o.parStart,l=o.parEnd;return e<t?n<i?this.IntersectRegularIntervals(e,t,n,i):this.IntersectRegularIntervals(e,t,n,l)+this.IntersectRegularIntervals(e,t,a,i):n<i?this.IntersectRegularIntervals(e,l,n,i)+this.IntersectRegularIntervals(a,t,n,i):this.IntersectRegularIntervals(e,l,n,l)+this.IntersectRegularIntervals(a,t,a,i)}IntersectRegularIntervals(e,t,n,i){let o=Math.max(e,n),a=Math.min(t,i);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let n=qe.SeparationCoeff*this.SeparationCost(t),i=qe.AssymetryCoeff*this.AssymetryCost(t),o=qe.SqueezeCoeff*this.SqueezeCost(t),a=qe.CenterCoeff*this.CenterCostBi(t);e+=(n+i)/2+o+a}return e}},xn=qe;xn.Deltas=[[1,-1],[1,-1]],xn.SeparationCoeff=1,xn.SqueezeCoeff=1,xn.CenterCoeff=10,xn.AssymetryCoeff=1,xn.MaxIterations=200,xn.MaxParameterChange=8/360,xn.MinParameterChange=.1/360,xn.CostThreshold=1e-5,xn.CostDeltaThreshold=.01;function $I(s,e){let t=wn(s.Curve),n=s.ParEnd,i=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-t,o=e.ParEnd,a=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-t;n>o?n-a>t&&(a+=t,o+=t):o-i>t&&(i+=t,n+=t);let l=Math.min(n,o),u=Math.max(i,a);return u<=l?{start:u,end:l,rbaseMiddle:(i+n)/2,lbaseMiddle:(a+o)/2}:null}var ib=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var Ll=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let n=new at(e.Position,t.Position),i=this.bundles.get(n).Metrolines;if(e.Position===n.first)for(let o=0;o<i.length;o++)yield i[o];else for(let o=i.length-1;o>=0;o--)yield i[o]}GetLineIndexInOrder(e,t,n){let i=new at(e.Position,t.Position),o=e.Position!==i.first,a=this.bundles.get(i).LineIndexInOrder;return o?a.size-1-a.get(n):a.get(n)}BuildOrder(){this.bundles=new Fi;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let n=new at(t.point,t.next.point),i=this.bundles.get(n);i||this.bundles.set(n,i=new ib),i.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((n,i)=>this.CompareLines(n,i,e.first,e.second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let n=0;n<t.Metrolines.length;n++)t.LineIndexInOrder.set(t.Metrolines[n],n)}}CompareLines(e,t,n,i){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(n,i,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(n,i,t,o);let c=o.polyPoint,h=o.next,d=o.prev,m=a,P=c,S,v;for(;(v=u(m))!=null&&(S=d(P))!=null&&v.point.equal(S.point);){let I=new at(v.point,m.point);if(this.bundles.get(I).orderFixed)return this.CompareOnFixedOrder(I,e,t,!v.point.equal(I.first));m=v,P=S}if(v!=null&&S!=null){let I=m.point;return-Ll.IsLeft(l(m).point.sub(I),v.point.sub(I),S.point.sub(I))}for(m=a,P=c;(v=l(m))!=null&&(S=h(P))!=null&&v.point.equal(S.point);){let I=new at(v.point,m.point);if(this.bundles.get(I).orderFixed)return this.CompareOnFixedOrder(I,e,t,!m.point.equal(I.first));m=v,P=S}if(v!=null&&S!=null){let I=m.point;return Ll.IsLeft(u(m).point.sub(I),v.point.sub(I),S.point.sub(I))}return Le(e.Index,t.Index)}CompareOnFixedOrder(e,t,n,i){let o=this.bundles.get(e).LineIndexInOrder;return(i?-1:1)*Le(o.get(t),o.get(n))}FindStationOnLine(e,t,n,i){for(let o=n.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){i.next=a=>a.next,i.prev=a=>a.prev,i.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){i.next=a=>a.prev,i.prev=a=>a.next,i.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,n){return Vi(e,t,n)}};var Qe=class extends Pe{constructor(e,t){super(null);this.metroGraphData=e,this.bundlingSettings=t}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Mt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new Ll(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new xn(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let e=0;e<this.metroGraphData.Metrolines.length;e++)this.CreateCurveLine(this.metroGraphData.Metrolines[e],this.metroGraphData.Edges[e])}CreateCurveLine(e,t){let n=new x,o=Qe.FindCurveStart(this.metroGraphData,this.metroOrdering,e),a=Qe.HubSegsOfLine(this.metroGraphData,this.metroOrdering,e);for(let l of a)l!=null&&(n.addSegment(R.mkPP(o,l.start)),n.addSegment(l),o=l.end);n.addSegment(R.mkPP(o,Qe.FindCurveEnd(this.metroGraphData,this.metroOrdering,e))),t.curve=n}static FindCurveStart(e,t,n){let i=e.PointToStations.get(n.Polyline.startPoint.point),o=e.PointToStations.get(n.Polyline.startPoint.next.point),a=i.BundleBases.get(o),l=a.IsParent?t.GetLineIndexInOrder(i,o,n):t.GetLineIndexInOrder(o,i,n);return a.Points[l]}static FindCurveEnd(e,t,n){let i=e.PointToStations.get(n.Polyline.endPoint.prev.point),o=e.PointToStations.get(n.Polyline.endPoint.point),a=o.BundleBases.get(i),l=a.IsParent?t.GetLineIndexInOrder(o,i,n):t.GetLineIndexInOrder(i,o,n);return a.Points[l]}static*HubSegsOfLine(e,t,n){for(let i=n.Polyline.startPoint.next;i.next!=null;i=i.next)yield Qe.SegOnLineVertex(e,t,n,i)}static SegOnLineVertex(e,t,n,i){let o=e.PointToStations.get(i.prev.point),a=e.PointToStations.get(i.point),l=a.BundleBases.get(o),u=t.GetLineIndexInOrder(o,a,n);if(l.OrientedHubSegments[u]==null||l.OrientedHubSegments[u].Segment==null){let c=e.PointToStations.get(i.next.point),h=a.BundleBases.get(c),d=t.GetLineIndexInOrder(c,a,n);return R.mkPP(l.Points[u],h.Points[d])}return l.OrientedHubSegments[u].Segment}CreateSegmentsInsideHubs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateICurveForOrientedSeg(e,t)}CreateICurveForOrientedSeg(e,t){let n=this.metroGraphData.PointToStations.get(t.prev.point),i=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=i.BundleBases.get(n),l=i.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(n,i,e),c=this.metroOrdering.GetLineIndexInOrder(o,i,e),h=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?Qe.StandardBezier(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]):Qe.BiArc(a.Points[u],a.Tangents[u],l.Points[c],l.Tangents[c]);a.OrientedHubSegments[u].Segment=h,l.OrientedHubSegments[c].Segment=h}static ShowHubs(e,t,n,i,o=[]){let a=Qe.GetAllDebugCurves(t,e);n!=null&&a.push(fe.mkDebugCurveTWCI(255,1,"red",Ce.mkDiamond(5,25,n.Position))),a=a.concat(o)}static GetAllDebugCurves(e,t){return Qe.GraphNodes(t).concat(Qe.VertexDebugCurves(e,t)).concat(Qe.DebugEdges(t))}static DebugEdges(e){return e.Edges.map(t=>fe.mkDebugCurveTWCI(40,.1,"gray",t.curve))}static VertexDebugCurves(e,t){return Qe.DebugCircles(t).concat(Qe.DebugHubBases(t)).concat(Qe.DebugSegs(t)).concat(Qe.BetweenHubs(e,t))}static BetweenHubs(e,t){let n=[];for(let i of t.Metrolines){let o=Qe.GetInterestingSegs(t,e,i),a=Qe.GetMonotoneColor(i.Polyline.start,i.Polyline.end,o);for(let l of o)n.push(fe.mkDebugCurveTWCI(100,i.Width,a,R.mkPP(l[0],l[1])))}return n}static GetInterestingSegs(e,t,n){let i=new Array;if(e.Stations.length===0||e.Stations[0].BundleBases==null||e.Stations[0].BundleBases.size===0)return[];let o=Qe.FindCurveStart(e,t,n),a=Qe.HubSegsOfLine(e,t,n);for(let l of a)l!=null&&(i.push([o,l.start]),o=l.end);return i.push([o,Qe.FindCurveEnd(e,t,n)]),i}static GetMonotoneColor(e,t,n){return"green"}static DebugHubBases(e){let t=new Array;for(let n of e.Stations)for(let i of n.BundleBases.values())t.push(fe.mkDebugCurveTWCI(100,1,"red",R.mkPP(i.EndPoint,i.StartPoint)));return t}static DebugCircles(e){return e.Stations.map(t=>fe.mkDebugCurveTWCI(100,.1,"blue",Ce.mkCircle(t.Radius,t.Position)))}static DebugSegs(e){let t=new Array;for(let n of e.VirtualStations())for(let i of n.BundleBases.values())for(let o of i.OrientedHubSegments)if(o!=null)if(o.Segment==null){let a=o.Other.BundleBase,l=o.Index,u=o.Other.Index;t.push(R.mkPP(i.Points[l],a.Points[u]))}else t.push(o.Segment);return t.map(n=>fe.mkDebugCurveTWCI(100,.01,"green",n))}static GraphNodes(e){return e.Edges.map(n=>n.sourcePort.Curve).concat(e.Edges.map(n=>n.targetPort.Curve)).map(n=>fe.mkDebugCurveTWCI(40,1,"black",n))}static BiArc(e,t,n,i){let o=e.sub(n);if(o.length<C.distanceEpsilon)return null;let a=o.dot(t.sub(i)),l=-t.dot(i);if(t.dot(n.sub(e))<=0&&t.dot(i)<=0)return Qe.StandardBezier(e,t,n,i);let u=2*(l-1),c=2*a,h=o.dot(o),d;if(Math.abs(u)<C.distanceEpsilon)if(Math.abs(c)>C.distanceEpsilon)d=-h/c;else return null;else{let D=c*c-4*u*h;D<0&&(D=0),D=Math.sqrt(D),d=(-c+D)/(2*u),d<0&&(d=(-c-D)/(2*u))}let m=e.add(t.mul(d)),P=n.add(i.mul(d)),S=f.middle(m,P),v=f.getTriangleOrientation(e,m,S),I=f.getTriangleOrientation(S,P,n);if(v!==I)return Qe.StandardBezier(e,t,n,i);let L=new x;return L.addSegs([Qe.ArcOn(e,m,S),Qe.ArcOn(S,P,n)]),L}static ArcOn(e,t,n){let i={center:null};if(Math.abs(f.signedDoubledTriangleArea(e,t,n))<1e-4||!Qe.FindArcCenter(e,t,n,i))return R.mkPP(e,n);let o=i.center,a=_e(e,o);if(_e(e,t)/a<1e-4)return R.mkPP(e,n);let u=e.sub(o),c=Math.atan2(u.y,u.x),h=n.sub(o),d=Math.atan2(h.y,h.x),m=d-c;if(m<0&&(m+=2*Math.PI,d+=2*Math.PI),m<=Math.PI)return new he(c,d,new f(a,0),new f(0,a),o);for(d>2*Math.PI&&(d-=2*Math.PI),c=Math.PI-c,d=Math.PI-d,c<0&&(c+=2*Math.PI);d<c;)d+=2*Math.PI;return m=d-c,new he(c,d,new f(-a,0),new f(0,a),o)}static FindArcCenter(e,t,n,i){let o=t.sub(e).rotate90Cw(),a=t.sub(n).rotate90Cw();return i.center=f.lineLineIntersection(e,e.add(o),n,n.add(a)),i.center!=null}static StandardBezier(e,t,n,i){let o=_e(e,n)/4;return Re.mkBezier([e,e.add(t.mul(o)),n.add(i.mul(o)),n])}FanBezierSegs(){let e=!0,t=5,n=0;for(;e&&n++<t;){e=!1;for(let i of this.metroGraphData.Stations)for(let o of i.BundleBases.values())e||(e=this.FanEdgesOfHubSegment(o))}}FanEdgesOfHubSegment(e){let t=!1;for(let n=0;n<e.Count-1;n++)t||(t=this.FanCouple(e,n,e.CurveCenter,e.Curve.boundingBox.diagonal/2));return t}FanCouple(e,t,n,i){let o=e.OrientedHubSegments[t],a=e.OrientedHubSegments[t+1];if(o==null||R.IntersectPPPP(o.Segment.start,o.Segment.end,a.Segment.start,a.Segment.end)||f.getTriangleOrientation(o.value(0),o.value(.5),o.value(1))!=f.getTriangleOrientation(a.value(0),a.value(.5),a.value(1)))return!1;let u=this.BaseLength(o),c=this.BaseLength(a);return Math.abs(u-c)<C.intersectionEpsilon?!1:u>c?this.AdjustLongerSeg(o,a,n,i):this.AdjustLongerSeg(a,o,n,i)}AdjustLongerSeg(e,t,n,i){let o=e.value(0).sub(t.value(0)),a=e.value(1).sub(t.value(1)),l=Math.min(o.length,a.length),u=t.value(.5),c=Math.max(o.length,a.length);return this.NicelyAligned(e.Segment,o,a,u,l,c)===0?!1:this.FitLonger(e,o,a,u,l,c,n,i)}FitLonger(e,t,n,i,o,a,l,u){let c=e.Segment,h=c.start,d=c.end,m=0,P=10,S=c.start.mul(1-Qe.SqueezeBound).add(c.B(1).mul(Qe.SqueezeBound)),v=c.end.mul(1-Qe.SqueezeBound).add(c.B(2).mul(Qe.SqueezeBound)),I=c.B(1).mul(2).sub(c.start),L=c.B(2).mul(2).sub(c.end),D={highP:I};this.PullControlPointToTheCircle(c.start,D,l,u),I=D.highP;let w=this.NicelyAligned(c,t,n,i,o,a);do{if(w===-1){let M=f.middle(c.B(1),S),K=f.middle(c.B(2),v);I=c.B(1),L=c.B(2),c=new Re(h,M,K,d)}else{let M=f.middle(c.B(1),I),K=(c.B(2),L);S=c.B(1),v=c.B(2),c=new Re(h,M,K,d)}if((w=this.NicelyAligned(c,t,n,i,o,a))===0)return e.Segment=c,e.Other.Segment=c,!0;if(m++>P)return!1}while(!0)}PullControlPointToTheCircle(e,t,n,i){let o=f.ProjectionToLine(e,t.highP,n),a=Math.sqrt(i*i-o.sub(n).lengthSquared),l=t.highP.sub(o),u=l.length;u>a&&(t.highP=o.add(l.mul(a/u)))}NicelyAligned(e,t,n,i,o,a){let u=e.value(.5).sub(i),c=u.length;return t.dot(u)<0||n.dot(u)<0||c<o-.001?1:c>a+.001?-1:0}BaseLength(e){return e.value(0).sub(e.value(1)).lengthSquared}},bs=Qe;bs.SqueezeBound=.2;var Vn=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new Er(this.metroGraphData,this.bundlingSettings),this.cache=new ya(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,n){return new Vn(e,t).FixRoutingP(n)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=Vn.MaxStep,n=Number.POSITIVE_INFINITY,i=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<Vn.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=n;n=Er.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,n);let u=i;if(i=this.metroGraphData.VirtualStations().map(c=>c.Position),t<Vn.MinStep||this.Converged(t,u,i))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let n=e[0],i=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(n,i),a=R.mkPP(n.Position,i.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>x.CurvesIntersect(a,u));return l.length>0?(bs.ShowHubs(t,null,null,"./tmp/badcross.svg",[fe.mkDebugCurveTWCI(200,1,"Brown",a),fe.mkDebugCurveTWCI(200,1,"Red",Ce.mkCircle(2,n.Position)),fe.mkDebugCurveTWCI(200,1,"Blue",Ce.mkCircle(5,i.Position)),fe.mkDebugCurveTWCI(100,1,"Blue",Ce.mkCircle(5,i.Position))].concat(l.map(u=>fe.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let n of e){let i=this.metroGraphData.PointToStations.get(n);i&&!i.IsReal&&t.add(i)}return t}}Converged(e,t,n){let i=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(n[l]).lengthSquared,i+=t[l].lengthSquared;return Math.sqrt(o/i)<Vn.MinRelativeChange}UpdateMaxStep(e,t,n){return n+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(Vn.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let n of this.stationsForOptimizations)if(this.TryMoveStation(n)){e=!0,t.add(n);for(let i of n.Neighbors)i.IsReal||t.add(i)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length===0)return!1;let n=this.BuildStepLength(e,t);if(n<Vn.MinStep&&(t=ew(),n=this.BuildStepLength(e,t),n<Vn.MinStep))return!1;let i=t.mul(n),o=e.Position.add(i);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let n of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(z.mkOnPoints([t]),i=>x.PointRelativeToCurveLocation(t,i)!==0))if(e.getELP().has(n)===!1)return!1;for(let n of e.Neighbors){let i=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(n,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(n.Position,t,n.cdtTriangle,i))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),n=this.BuildForceForPathLengths(e),i=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(n.add(i.add(o)));return a.length<.1?new f(0,0):a.normalize()}BuildStepLength(e,t){let n=Vn.MinStep,i=this.CostGain(e,e.Position.add(t.mul(n)));if(i<.01)return 0;for(;2*n<=Vn.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(n*2)));if(o<=i)break;n*=2,i=o}return n}CostGain(e,t){let i=this.costCalculator.RadiusGain(e,t);if(i<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return i+a+l+o}BuildForceForInk(e){let t=new f(0,0);for(let i of e.Neighbors){let o=i.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new f(0,0);for(let i of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=i.Metroline,a=i.PolyPoint.next.point,l=i.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new f(0,0),n=e.cachedIdealRadius,i={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,n,i))throw bs.ShowHubs(this.metroGraphData,null,e,"./tmp/hubs.svg",[fe.mkDebugCurveTWCI(255,1,"Brown",en.containingPoly),fe.mkDebugCurveTWCI(100,1,"Blue",Ce.mkCircle(n,e.Position))]),new Error;for(let l of i.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/n),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new f(0,0);for(let i of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,i,this.bundlingSettings.EdgeSeparation),a={closestDist:[]};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,i,e.Position,i.Position,o/2,a)||bs.ShowHubs(this.metroGraphData,null,e,"./tmp/inside_forbid.svg",[fe.mkDebugCurveTWCI(100,.2,"Blue",R.mkPP(e.Position,i.Position)),fe.mkDebugCurveTWCI(100,.2,"Red",Ce.mkCircle(2,e.Position)),fe.mkDebugCurveTWCI(100,.2,"Red",Ce.mkCircle(3,i.Position))]);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},si=Vn;si.MaxIterations=100,si.MaxStep=50,si.MinStep=1,si.MinRelativeChange=5e-4;function ew(){return new f(1+2*Oi(),1+2*Oi())}var wo=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let n=new wo(e,t);n.GlueConflictingStations(),n.UnglueEdgesFromBundleToSaveInk(!0);let i=0,o=10;for(;++i<o;){let a=n.GlueConflictingStations();if(a||(a=n.RelaxConstrainedEdges()),a||(a=i<=3&&n.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=n.GlueCollinearNeighbors(i)),a||(a=i===3&&n.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,n.RemoveDoublePathCrossings(),n.UnglueEdgesFromBundleToSaveInk(!0);n.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,n=new Set;if(Gt(e,e,(o,a)=>this.TryToGlueStations(o,a,t,n)),t.size===0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let i=new We;for(let o of n){i.add(o.Position);for(let a of o.Neighbors)a.IsReal||i.add(a.Position)}return this.metroGraphData.Initialize(!1),si.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,i),!0}GetCirclesHierarchy(){for(let n of this.metroGraphData.VirtualStations())n.Radius=this.GetCurrentHubRadius(n);let e=this.metroGraphData.VirtualStations().map(t);return Ke(e);function t(n){let i=n.Position,o=Math.max(n.Radius,5),a=new f(o,o),l=z.mkPP(i.add(a),i.sub(a));return st(n,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,n=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let i of e.Neighbors)n=Math.min(n,e.Position.sub(i.Position).length);return n}}TryToGlueStations(e,t,n,i){if(!Ys(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,i,n)||this.TryGlueOrdered(t,e,i,n)}TryGlueOrdered(e,t,n,i){return!i.has(e)&&!n.has(e)&&this.StationGluingIsAllowed(e,t,i)?(this.Map(e,t,n,i),!0):!1}Map(e,t,n,i){i.set(e,t),n.add(t)}StationGluingIsAllowed(e,t,n){for(let o of e.Neighbors){let a=wo.Glued(o,n),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,n)<0)}ComputeCostDeltaAfterStationGluing(e,t,n){let i=e.Position.sub(t.Position).length;if(e.Radius>=i||t.Radius>=i)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=wo.Glued(u,n);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)===0?c.Position.sub(t.Position).length:0}o+=Er.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,m=d.prev,P=d.next;h-=m.point.sub(e.Position).length+P.point.sub(e.Position).length,h+=m.point.sub(t.Position).length+P.point.sub(t.Position).length,o+=Er.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let n=this.metroGraphData.Metrolines[t].Polyline;for(let a of n)if(!this.metroGraphData.PointToStations.has(a))return;let i=!1;for(let a of n)if(e.has(this.metroGraphData.PointToStations.get(a))){i=!0;break}if(!i)return;let o=Array.from(n).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=ee.mkFromPoints(wo.GluedPolyline(o,e))}static GluedPolyline(e,t){let n,i=new HS.Stack;i.push(e[0]);let o=new Set;for(n=1;n<e.length-1;n++){let a=wo.Glued(e[n],t);if(o.has(a)){for(;i.top!==a;)o.delete(i.pop());continue}f.closeDistEps(a.Position,i.top.Position)||(o.add(a),i.push(a))}return i.push(e[n]),Array.from(i).reverse().map(a=>a.Position)}static Glued(e,t){var n;return(n=t.get(e))!=null?n:e}UnglueEdgesFromBundleToSaveInk(e){let t=new Fi;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new at(a.point,a.next.point);Ym(t,l,o)}}let n=new We,i=!1;for(let o of this.metroGraphData.Metrolines){let a=ri(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,n,a)&&(i=!0)}return i&&this.metroGraphData.Initialize(!1),(e||i)&&si.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:n),i}TrySeparateOnPolyline(e,t,n,i){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,n,i)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,n,i){return this.SeparationShortcutAllowed(e,t,i)?(n.add(e.point),n.add(e.next.point),n.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,n){let i=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(i),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=ti(l.getELP(),c.getELP()),d=k0([n,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,i,o,a)<0)}GetInkgain(e,t,n,i,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,m=n.sub(i).length,P=i.sub(o).length,S=n.sub(o).length;a.size===u.size&&(d-=m),l.size===u.size&&(d-=P);let v=t.get(new at(n,o));(!v||v.size===0)&&(d+=S),c+=Er.InkError(h,d,this.bundlingSettings);for(let K of u){let X=this.polylineLength.get(K),se=X-(m+P-S);c+=Er.PathLengthsError(X,se,K.IdealLength,this.bundlingSettings)}let I=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(n)),L=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),D=this.metroGraphData.GetWidthAN(Array.from(go(a,u)),this.bundlingSettings.EdgeSeparation),w=Mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(I,n,o,i,L,D,this.bundlingSettings);w>I&&(c-=Er.RError(w,I,this.bundlingSettings)),I=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let M=this.metroGraphData.GetWidthAN(Array.from(go(l,u)),this.bundlingSettings.EdgeSeparation);return w=Mt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(I,o,i,n,M,L,this.bundlingSettings),w>I&&(c-=Er.RError(w,I,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let n=e.point,i=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=_e(n,i),h=_e(i,o),d=_e(n,o);a.size===u.size&&(this.ink-=c),l.size===u.size&&(this.ink-=h);let m=t.get(new at(n,o));(!m||m.size===0)&&(this.ink+=d);for(let P of u){let S=this.polylineLength.get(P);this.polylineLength.set(P,S-(c+h-d))}for(let P of u){let S=Array.from(P.Polyline.polylinePoints()).find(v=>v.point.equal(i));this.RemovePolypoint(S),Km(t,[n,i],P),Km(t,[i,o],P),U0(t,[n,o],P)}}FindPolylines(e,t){let n=e.point,i=e.next.point,o=e.next.next.point,a=t.get_(n,i),l=t.get_(i,o),u=ri(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,n=e.next;t.next=n,n.prev=t}GlueCollinearNeighbors(e){let t=new We,n=!1;for(let i of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(i,t,e)&&(n=!0);return n&&(this.metroGraphData.Initialize(!1),si.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),n}GlueCollinearNeighborsSPN(e,t,n){if(e.Neighbors.length<=1)return!1;let i=new pc,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],i,n);if(i.isEmpty)return!1;for(let a of i)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,n,i,o){if(f.anglePCP(t.Position,e.Position,n.Position)<this.bundlingSettings.AngleThreshold){let l=_e(t.Position,e.Position),u=_e(n.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,n)){this.AddEdgeToGlue(e,n,t,t.Position,i);return}}else if(this.EdgeGluingIsAllowedSSS(e,n,t)){this.AddEdgeToGlue(e,t,n,n.Position,i);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,n);this.EdgeGluingIsAllowedSSSP(e,t,n,h)&&this.AddEdgeToGlue(e,n,t,h,i)}}}ConstructGluingPoint(e,t,n){let i=Math.min(_e(t.Position,e.Position),_e(n.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(n.Position.sub(e.Position).normalize());return e.Position.add(o.mul(i/2))}EdgeGluingIsAllowedSSS(e,t,n){if(t.IsReal||n.IsReal||!Ys(t.getELP(),n.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,n,t.Position,n.Position))return!1;let i=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,n);return!(ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(R.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!i.has(u.seg1))||ze.IntersectionsOfLineAndRectangleNodeOverPolylineLR(R.mkPP(t.Position,n.Position),this.metroGraphData.LooseTree).find(u=>!i.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,n,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,n,i){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(i,0,ri(t.getELP(),n.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,i)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,i)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(n,null,n.Position,i)||this.ComputeCostDeltaAfterEdgeGluing(e,t,n,i)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,n,i){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-_e(e.Position,n.Position)-_e(e.Position,t.Position)+_e(e.Position,i)+_e(i,t.Position)+_e(i,n.Position);o+=Er.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,n).Metrolines){let m=d.Length,P=d.Length-_e(e.Position,n.Position)+_e(e.Position,i)+_e(i,n.Position);o+=Er.PathLengthsError(m,P,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let m=d.Length,P=d.Length-_e(e.Position,t.Position)+_e(e.Position,i)+_e(i,t.Position);o+=Er.PathLengthsError(m,P,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Mt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,n,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=Er.RError(h,c,this.bundlingSettings)),u>_e(e.Position,i)&&!e.IsReal&&(o-=Er.RError(u,_e(e.Position,i),this.bundlingSettings)),o}AddEdgeToGlue(e,t,n,i,o){o.has(n,e)||o.has(t,e)||o.has(e,n)||o.has(e,t)||(o.set(e,n,i),o.set(e,t,i))}GlueEdge(e){let t=e[0],n=e[1],i=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(n.Position)?this.SplitPolylinePoint(o,i):o.prev!=null&&o.prev.point.equal(n.Position)&&this.SplitPolylinePoint(o.prev,i)}SplitPolylinePoint(e,t){if(e.point===t||e.next.point===t)return;let n=Lt.mkFromPoint(t);n.polyline=e.polyline,n.next=e.next,n.prev=e,n.next.prev=n,n.prev.next=n}RelaxConstrainedEdges(){let e=new We,t=!1;for(let n of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(n[0],n[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),si.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,n){let i=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*i/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(_e(e.Position,c[1]),_e(t.Position,c[1])),d=_e(e.Position,t.Position);if(h/d<.1)continue;let P=_e(c[0],c[1]);(l===-1||P<l)&&(l=P,u=c[1])}if(l===-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,ri(e.getELP(),t.getELP())))return!1;n.add(u),n.add(e.Position),n.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new ps(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),si.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var Ol=class{constructor(e,t,n){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=n,n.ClearPrevEdgesTable();for(let i of n.Vertices())i.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new Pr;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!Ol.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!Ol.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof sr}ProcessNeighbor(e,t,n){let i=t.Length,o=this._current.Distance+i;o>=this.upperBound||(this.targets.has(n)&&(this.upperBound=o,this.closestTarget=n),this._visGraph.PreviosVertex(n)==null?(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.Enqueue(n,o)):o<n.Distance&&(n.Distance=o,this._visGraph.SetPreviousEdge(n,t),e.DecreasePriority(n,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var Ps=class extends Pe{constructor(e,t,n,i,o,a,l,u,c,h){super(null);this.bundlingSettings=i,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=e,this.regularEdges=e.filter(d=>d.source!==d.target),this.VisibilityGraph=n,this.shortestPathRouter=t,this.LoosePadding=o,this.LooseHierarchy=l,this.TightHierarchy=a,this.EdgeLooseEnterable=u,this.EdgeTightEnterable=c,this.loosePolylineOfPort=h,pl(0)}ThereAreOverlaps(e){return Cn(e,e,x.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let e=new rb(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.cdt,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);wo.FixRouting(e,this.bundlingSettings),new bs(e,this.bundlingSettings).run()}FixChildParentEdges(){for(let e of this.regularEdges){let t=e.sourcePort,n=e.targetPort;if(t.Curve.boundingBox.containsRect(n.Curve.boundingBox)){let i=x.intersectionOne(t.Curve,R.mkPP(e.curve.start,e.curve.end),!1),o=e.curve;o.startPoint.point=i.x}if(n.Curve.boundingBox.containsRect(t.Curve.boundingBox)){let i=x.intersectionOne(n.Curve,R.mkPP(e.curve.start,e.curve.end),!0),o=e.curve;o.endPoint.point=i.x}}}FixLocationsForHookAnywherePorts(e){for(let t of e){let n=t.sourcePort instanceof Nt;if(n){let i=t.sourcePort;i.SetLocation(this.FigureOutHookLocation(i.LoosePolyline,t.targetPort,t))}else if(n=t.targetPort instanceof Nt,n){let i=t.targetPort;i.SetLocation(this.FigureOutHookLocation(i.LoosePolyline,t.sourcePort,t))}}}FigureOutHookLocation(e,t,n){return t instanceof br?this.FigureOutHookLocationForClusterOtherPort(e,t,n):this.FigureOutHookLocationForSimpleOtherPort(e,t,n)}FigureOutHookLocationForClusterOtherPort(e,t,n){let i=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),a=new Ol(Array.from(t.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(e).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let l of i)l.IsTransparent=!1;return a[a.length-1].point}FigureOutHookLocationForSimpleOtherPort(e,t,n){let i=t.Location,o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),l=new ns(this.VisibilityGraph.FindVertex(i),Array.from(e).map(u=>this.VisibilityGraph.FindVertex(u)),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.cdt!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let e=new Map;this.shortestPathRouter.FillCrossedCdtEdges(e);let t=this.GetPathsOnCdtEdge(e);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(t)}GetPathsOnCdtEdge(e){let t=new Map;for(let n of e.keys())for(let i of e.get(n))Ks(t,i,n);return t}CalculateEdgeWidthShrinkCoeff(e){let t=0,n=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(e,n))return n;let i=!1;for(;!i||Math.abs(n-t)>.01;){let o=(t+n)/2;this.EdgeSeparationIsOkMN(e,o)?(t=o,i=!0):n=o}return t}EdgeSeparationIsOkMN(e,t){for(let n of e.keys())if(!this.EdgeSeparationIsOk(n,e.get(n),t))return!1;return!0}EdgeSeparationIsOk(e,t,n){return Array.from(t).map(o=>this.bundlingSettings.ActualEdgeWidth(o,n)).reduce((o,a)=>o+a,0)<=e.Capacity}RouteSelfEdges(){for(let e of this.edgesToRoute)if(e.source===e.target){let t={smoothedPolyline:null};e.curve=be.RouteSelfEdge(e.source.boundaryCurve,this.LoosePadding*2,t)}}FixArrowheads(){for(let e of this.edgesToRoute)Ve.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!1)}};Ps.SuperLoosePaddingCoefficient=1.1;var ob=class{constructor(e,t,n){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=n}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var sb=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source===this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var ai=class{constructor(e,t,n){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.cdt=t,this.Gates=n}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let n of t.InEdges){let i=new ob(n,this.VisibilityVerticesToSdVerts.get(n.Source),this.VisibilityVerticesToSdVerts.get(n.Target)),o=this.VisibilityVerticesToSdVerts.get(n.Source);e.InBoneEdges.push(i),o.OutBoneEdges.push(i)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new sb(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new ee,n=this.EdgesToRouteSources.get(e);t.addPoint(n.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(n.Point)?(t.addPoint(a.TargetPoint),n=a.Target):(t.addPoint(a.SourcePoint),n=a.Source);e.curve=t,e.sourcePort instanceof br&&ai.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof br&&ai.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let n=t.closestParameter(e.end);e.addPoint(t.value(n))}static ExtendPolylineStartToClusterBoundary(e,t){let n=t.closestParameter(e.start);e.PrependPoint(t.value(n))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.cdt!=null&&this.cdt.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let n of t)n.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let i=0;i<this.vertexArray.length;i++){let o=this.vertexArray[i];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),n=this.RouteEdgeWithGroups();for(let i of t)i.IsTransparent=!1;return n}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new Pr,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e===0);if(t!=null)return t;for(let n=0;n<this.vertexArray.length;n++)this.vertexArray[n].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let n={priority:0},i=this.Queue.DequeueAndGetPriority(n);if(!(n.priority>=this.LowestCostToTarget)){for(let o=0;o<i.OutBoneEdges.length;o++){let a=i.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(i,a,e,t)}for(let o=0;o<i.InBoneEdges.length;o++){let a=i.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(i,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,n,i){i&&n.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,n,i){i&&n.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,n){let i=this.GetEdgeAdditionalCost(n,e.Cost);if(!(t.Cost<=i))if(t.Cost=i,t.PrevEdge=n,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,i);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof br&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),i+o<this.LowestCostToTarget&&(this.LowestCostToTarget=i+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.cdt!=null&&this.BundlingSettings.CapacityOverflowCoefficient!==0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity===t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let n=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*n+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*n)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.cdt==null||this.BundlingSettings.CapacityOverflowCoefficient===0)return 0;let t=0;for(let n of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,n);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,n=e.Source.Triangle,i=new Set,o=e.TargetPoint;if(He.PointIsInsideOfTriangle(o,n))return i;let a=new Pa(n,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&i.add(l)}return i}static CostOfCrossingCdtEdge(e,t,n,i){let o=n.lineWidth*t.edgeWidthShrinkCoeff;i.Capacity!==i.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=i.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,n,i){return this.AdjacentToSourceOrTarget(i)?0:ai.CostOfCrossingCdtEdge(e,t,n,i)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner===this.sourceLoosePoly||e.lowerSite.Owner===this.sourceLoosePoly||e.upperSite.Owner===this.targetLoosePoly||e.lowerSite.Owner===this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let n;if(e instanceof br){n=e.LoosePolyline;for(let o of n){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof Nt){n=e.LoosePolyline;for(let o of n)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let i=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=i[0].boundingBox.diagonal;n=i[0];for(let a=1;a<i.length;a++){let l=i[a],u=l.boundingBox.diagonal;u<o&&(o=u,n=l)}}return n}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,n){let i=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(i);t?(o.IsSourceOfRouting=!0,o.Cost=n,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.cdt!=null&&(this.capacityOverlowPenaltyMultiplier=ai.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)ai.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,n=e.lowerSite.Owner;if(t!==n){let i=Yt.DistancePoint(new Yt(t),e.lowerSite.point),o=Yt.DistancePoint(new Yt(n),e.upperSite.point);e.Capacity=(i+o)/2}}SetVertexTriangles(){let e=Ke(Array.from(this.cdt.GetTriangles()).map(n=>st(n,n.BoundingBox()))),t=Ke(this.vertexArray.map(n=>st(n,z.mkOnPoints([n.Point]))));Lr(e,t,(n,i)=>this.TryToAssigenTriangleToVertex(n,i))}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&He.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let n of this.EdgesToRoutes.get(t))for(let i of this.CrossedCdtEdgesOfBoneEdge(n))this.AdjacentToSourceOrTarget(i)||Ks(e,t,i)}}};var Rl=class{constructor(e,t,n,i,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=i,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=Vs(n,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new Ps(e.edges,new ai(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(n,i)=>x.PointRelativeToCurveLocation(n,i)!==0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,n={preGraphs:e};if(this.UniteConnectedPreGraphs(n),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=Rl.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let n=Jn(t),i=new Array;for(let o of n){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],i.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=i;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let n of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(n)}static GetIntersectionGraphOfPreGraphs(e){let t=Rl.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?rr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),n=Vs(t,o=>e[o].boundingBox),i=new Array;return Gt(n,n,(o,a)=>i.push(new ye(o,a))),i}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,n=e[0],i=this.GetPortCurve(n.sourcePort),o=i.boundingBox;t.add(i),t.add(n.targetPort.Curve),o.addRec(n.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return gc.constructorStatic(e,t)}};var ab=Ae(Qn());var lb=class{constructor(){this.triangles=new Set}setCdt(e){this.cdt=e,e&&(this.cdtTree=this.cdt.getRectangleNodeOnTriangles())}findTrianglesIntersectingThePolyline(){this.triangles.clear();let e=this.getPointTrianglesInTheGlobalCdt(this.poly.start);for(let t=this.poly.startPoint;t.next;t=t.next)this.addLineSeg(e,t.point,t.next.point)}getPointTrianglesInTheGlobalCdt(e){let t=new Set;for(let n of this.cdtTree.AllHitItems(z.mkOnPoints([e]),i=>i.containsPoint(e)))t.add(n);return t}addLineSeg(e,t,n){let i=new ab.Queue,o=new Set,a=[];for(let c of e)u(c,()=>!0),c.containsPoint(n)&&a.push(c);e.clear();for(let c of a)e.add(c);let l;for(;i.length>0;){l=i.dequeue(),this.addToTriangles(l);for(let c of l.Edges){let h=c.GetOtherTriangle_T(l);h==null||o.has(h)||h.intersectsLine(t,n)&&u(h,d=>this.canBelongToTriangles(d))}}return e;function u(c,h){i.enqueue(c),o.add(c),h(c)&&c.containsPoint(n)&&e.add(c)}}canBelongToTriangles(e){let t=e.Sites.item0.Owner;return t===this.sourcePoly||t===this.targetPoly||!tw(e)}addToTriangles(e){this.canBelongToTriangles(e)&&this.triangles.add(e)}run(e,t,n){if(this.poly=e,e.count<=2||this.cdt==null)return;this.sourcePoly=t,this.targetPoly=n,this.findTrianglesIntersectingThePolyline();let i=this.getPerimeterEdges(),o=new He([],[],Array.from(i).map(l=>({A:l.lowerSite.point,B:l.upperSite.point})));o.run();let a=this.getSleeve(this.findSourceTriangle(o));a!=null&&(this.initDiagonals(a),this.refineFunnel())}findSourceTriangle(e){let t;for(let n of e.GetTriangles())if(n.containsPoint(this.poly.start)){t=n;break}return t}refineFunnel(){let e=[],t=this.poly.start,n={point:t},i={point:t},o={point:this.d[0].left,prev:n},a={point:this.d[0].right,prev:i};n.next=o,i.next=a;let l;for(let w=1;w<this.d.length;w++)c(w,this.d);this.d.push({right:this.poly.end,left:o.point}),c(this.d.length-1,this.d);let u=ee.mkFromPoints(e);for(let w=i;w!=null;w=w.next)u.addPoint(w.point);this.poly=u;function c(w,M){if(M[w-1].left!==M[w].left){l=M[w].left;let X=o;for(;!(I(X)||m(X));X=X.prev);I(X)?S():D(X)}else{l=M[w].right;let X=a;for(;!(I(X)||P(X));X=X.prev);I(X)?v():L(X)}}function h(w){return w.next==null?!0:f.pointToTheLeftOfLineOrOnLine(l,w.point,w.next.point)}function d(w){return w.next==null?!0:f.pointToTheRightOfLineOrOnLine(l,w.point,w.next.point)}function m(w){return f.pointToTheLeftOfLine(l,w.prev.point,w.point)}function P(w){return f.pointToTheRightOfLine(l,w.prev.point,w.point)}function S(){let w=i;for(;!h(w);)w=w.next;if(!I(w)){let M=i;for(;!M.point.equal(w.point);M=M.next)e.push(M.point);i.point=M.point,i.next=M.next,t=M.point,a.point.equal(i.point)&&(a.prev=a.next=null)}n.point=t,o.point=l,o.prev=n,n.next=o}function v(){let w=n;for(;!d(w);)w=w.next;if(!I(w)){let M=n;for(;!M.point.equal(w.point);M=M.next)e.push(M.point);n.point=M.point,n.next=M.next,t=M.point,o.point.equal(n.point)&&(o.prev=n.next=null)}i.point=t,a.point=l,a.prev=i,i.next=a}function I(w){return w.point==t}function L(w){w!=a?(a.point=l,a.prev=w,w.next=a):(a={point:l,prev:w},w.next=a)}function D(w){w!=o?(o.point=l,o.prev=w,w.next=o):(o={point:l,prev:w},w.next=o)}}initDiagonals(e){this.d=[];for(let t of e){let n=t.edge,i=t.source.OppositeSite(n);f.getTriangleOrientation(i.point,n.lowerSite.point,n.upperSite.point)==1?this.d.push({left:n.upperSite.point,right:n.lowerSite.point}):this.d.push({right:n.upperSite.point,left:n.lowerSite.point})}}getSleeve(e){let t=new ab.Queue;t.enqueue(e);let n=new Map;for(n.set(e,void 0);t.length>0;){let i=t.dequeue(),o=n.get(i);if(i.containsPoint(this.poly.end))return this.recoverPath(e,n,i);for(let a of i.Edges){if(a.constrained||o!==void 0&&a===o.edge)continue;let l=a.GetOtherTriangle_T(i);l!=null&&(n.set(l,{source:i,edge:a}),t.enqueue(l))}}}recoverPath(e,t,n){let i=[];for(let o=n;o!=e&&o!==e;){let a=t.get(o);i.push(a),o=a.source}return i.reverse()}getPerimeterEdges(){let e=new Set;for(let t of this.triangles)for(let n of t.Edges)this.triangles.has(n.GetOtherTriangle_T(t))||e.add(n);return e}};function tw(s){return s.Sites.item0.Owner!=null&&s.Sites.item0.Owner==s.Sites.item1.Owner&&s.Sites.item0.Owner==s.Sites.item2.Owner}var Fe=class extends Pe{constructor(e,t,n=1,i=2,o=30*(Math.PI/180),a=null,l=null){super(l);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.multiEdgesSeparation=.5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.KeepOriginalSpline=!1;this.ArrowHeadRatio=0;this.bidirectional=!1;this.edges=t,this.BundlingSettings=a,this.geomGraph=e,this.LoosePadding=i,this.tightPadding=n,this.coneAngle=o,this.routeMultiEdgesAsBundles=t.length<1e3&&e.deepNodeCount<1e3}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(e){this.continueOnOverlaps=e}get LoosePadding(){return this.loosePadding}set LoosePadding(e){this.loosePadding=e}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(e){this.multiEdgesSeparation=e}static mk2(e,t){return Fe.mk5(e,t.Padding,t.PolylinePadding,t.ConeAngle,t.bundlingSettings)}static mk4(e,t,n,i){return new Fe(e,Array.from(e.deepEdges),t,n,i,null)}static mk5(e,t,n,i,o){return new Fe(e,Array.from(e.deepEdges),t,n,i,o)}static mk6(e,t,n,i,o,a){let l=Fe.mk4(e,t,n,i),u=En.GetShapes(o,a);return l.Initialize(u,i),l}Initialize(e,t){this.rootShapes=e.filter(n=>n.Parents==null||n.Parents.length===0),this.coneAngle=t,this.coneAngle===0&&(this.coneAngle=Math.PI/6)}run(){if(this.edges.length==0||this.geomGraph.isEmpty())return;let e=Or.GetShapes(this.geomGraph,this.edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings),this.Initialize(e,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot()}RouteOnRoot(){pl(0),this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[e,t]of this.portsToShapes){let n=new Set;Fe.EdgesAttachedToPortAvoidTheNode(e)||n.add(t),this.portsToEnterableShapes.set(e,n)}for(let e of this.rootShapes)for(let t of e.Descendants())for(let n of t.Ports){let i=this.portsToEnterableShapes.get(n);Jo(i,Array.from(t.Ancestors()).filter(o=>o.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(e){return e instanceof ar||e instanceof br}SetLoosePolylinesForAnywherePorts(){for(let[e,t]of this.shapesToTightLooseCouples)for(let n of e.Ports){if(n instanceof Nt){let o=n;o.LoosePolyline=t.LooseShape.BoundaryCurve}if(n instanceof br){let o=n;o.LoosePolyline=t.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new mo;for(let e of this.root.Children){let t=this.shapesToTightLooseCouples.get(e).LooseShape;this.BindLooseShapesUnderShape(e),this.looseRoot.AddChild(t)}}BindLooseShapesUnderShape(e){let t=this.shapesToTightLooseCouples.get(e).LooseShape;for(let n of e.Children){let i=this.shapesToTightLooseCouples.get(n).LooseShape;t.AddChild(i),this.BindLooseShapesUnderShape(n)}}CalculateShapeToBoundaries(e){if(this.ProgressStep(),e.Children.length!==0){for(let t of e.Children)this.CalculateShapeToBoundaries(t);this.obstacleCalculator=new Ku(e,this.tightPadding,this.AdjustedLoosePadding,this.shapesToTightLooseCouples),this.obstacleCalculator.Calculate(!0),this.OverlapsDetected||(this.OverlapsDetected=this.obstacleCalculator.OverlapsDetected)}}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(e){this._overlapsDetected=e}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*Ps.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let e=new Array;for(let t of this.edges){let n=this.EdgePassport(t),i=e.find(o=>Ys(o.passport,n));i||(i={passport:n,edges:[]},e.push(i)),i.edges.push(t)}return e}RouteOnVisGraph(){if(this.ancestorSets=Fe.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let e of this.GroupEdgesByPassport()){let t=e.passport,n=this.GetObstaclesFromPassport(t),i=this.CreateInteractiveEdgeRouter(Array.from(n));this.RouteEdgesWithTheSamePassport(e,i,n)}else this.RouteBundles()}getDebugCurvesFromEdgesAndCdt(e){let t=Array.from(this.geomGraph.deepEdges).map(n=>n.curve).filter(n=>n!=null).filter(n=>n.count>5).map(n=>fe.mkDebugCurveTWCI(200,1,"Red",n));for(let n of e.PointsToSites.values())for(let i of n.Edges)t.push(fe.mkDebugCurveTWCI(200,.5,i.constrained?"Blue":"Green",R.mkPP(i.lowerSite.point,i.upperSite.point)));return t}RouteEdgesWithTheSamePassport(e,t,n){let i={regularEdges:[],multiEdges:[]};try{let o=this.getCdtFromShapes(n);t.pathOptimizer.setCdt(o)}catch(o){console.log(o),t.pathOptimizer.setCdt(null)}if(this.RouteMultiEdgesAsBundles){if(this.SplitOnRegularAndMultiedges(e.edges,i),i.regularEdges.length>0)for(let o=0;o<i.regularEdges.length;o++)this.routeEdge(t,i.regularEdges[o]);i.multiEdges!=null&&(this.ScaleDownLooseHierarchy(t,n),this.RouteMultiEdges(i.multiEdges,t,e.passport))}else for(let o of e.edges)this.routeEdge(t,o)}getCdtFromShapes(e){let t=new Set;for(let a of e){let l=this.LoosePolyOfOriginalShape(a);l!=null&&t.add(l)}let n=this.geomGraph.boundingBox.clone();n.pad(Math.max(n.diagonal/4,100));let i=Array.from(t);i.push(n.perimeter());let o=new He([],i,[]);return o.run(),o}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}routeEdge(e,t){let n=this.makeTransparentShapesOfEdgeAndGetTheShapes(t);this.ProgressStep(),this.RouteEdgeInternal(t,e),Fe.SetTransparency(n,!1)}ScaleDownLooseHierarchy(e,t){let n=new Array;for(let i of t){let o=this.shapesToTightLooseCouples.get(i);n.push(Kt.LoosePolylineWithFewCorners(o.TightPolyline,o.Distance/1.1,!1))}e.LooseHierarchy=Fe.CreateLooseObstacleHierarachy(n),e.ClearActivePolygons(),e.AddActivePolygons(n.map(i=>new Yt(i)))}RouteMultiEdges(e,t,n){let i=[];for(let l of n)for(let u of l.Children)i.push(u.BoundaryCurve);let o=new $n;o.InkImportance=1e-5,o.EdgeSeparation=this.MultiEdgesSeparation,new Rl(e,t,i,o,l=>this.makeTransparentShapesOfEdgeAndGetTheShapes(l)).run()}SplitOnRegularAndMultiedges(e,t){let n=new Fi;for(let i of e)Fe.IsEdgeToParent(i)?t.regularEdges.push(i):Fe.RegisterInPortLocationsToEdges(i,n);t.multiEdges=null;for(let i of n.values())i.length===1||this.OverlapsDetected?Ri(t.regularEdges,i):(t.multiEdges==null&&(t.multiEdges=new Array),t.multiEdges.push(i))}static RegisterInPortLocationsToEdges(e,t){let n,i=new at(e.sourcePort.Location,e.targetPort.Location);n=t.get(i),n||(n=new Array,t.set(i,n)),n.push(e)}static IsEdgeToParent(e){return e.sourcePort instanceof Nt||e.targetPort instanceof Nt}CreateInteractiveEdgeRouter(e){let t=new Set(e.map(i=>this.shapesToTightLooseCouples.get(i).LooseShape.BoundaryCurve)),n=new ze(this.cancelToken);return n.pathOptimizer=new lb,n.ObstacleCalculator=new Kt(e.map(i=>i.BoundaryCurve),this.tightPadding,this.loosePadding,!1),n.VisibilityGraph=this.visGraph,n.TightHierarchy=this.CreateTightObstacleHierarachy(e),n.LooseHierarchy=Fe.CreateLooseObstacleHierarachy(Array.from(t)),n.UseSpanner=!0,n.LookForRoundedVertices=!0,n.TightPadding=this.tightPadding,n.LoosePadding=this.LoosePadding,n.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,n.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,n.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,n.AllowedShootingStraightLines=this.AllowedShootingStraightLines,n.AddActivePolygons(Array.from(t).map(i=>new Yt(i))),n}GetObstaclesFromPassport(e){if(e.size===0)return new Set(this.root.Children);let t=this.GetCommonAncestorsAbovePassport(e),n=this.GetAllAncestors(e),i=new Set;for(let l of e)for(let u of l.Children)n.has(u)||i.add(u);let o=ti(new Set(e),i),a=new jS.Queue;for(let l of e)t.has(l)||a.enqueue(l);for(;a.length>0;){let l=a.dequeue();for(let u of l.Parents){for(let c of u.Children)n.has(c)||i.add(c);!t.has(u)&&!o.has(u)&&(a.enqueue(u),o.add(u))}}return i}GetAllAncestors(e){if(e.size===0)return new Set;let t=new Set(e);for(let n of e)t=ti(t,this.ancestorSets.get(n));return t}GetCommonAncestorsAbovePassport(e){if(e.size===0)return new Set;let t=Array.from(e),n=this.ancestorSets.get(t[0]);for(let i=1;i<t.length;i++){let o=t[i];n=ri(n,this.ancestorSets.get(o))}return n}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let e=this.GetLooseHierarchy(),t=Dd(e),n=new ai(o=>this.makeTransparentShapesOfEdgeAndGetTheShapes(o),t,this.FindCdtGates(t));new Ps(this.edges,n,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),e,this.enterableLoose,this.enterableTight,o=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(o))).run()}CreateTheMapToParentLooseShapes(e,t){for(let n of e.Children){let o=this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve;t.set(o,e),this.CreateTheMapToParentLooseShapes(n,t)}}FindCdtGates(e){let t=new Map;this.CreateTheMapToParentLooseShapes(this.root,t);let n=new Set;for(let i of e.PointsToSites.values())for(let o of i.Edges){if(o.CwTriangle==null&&o.CcwTriangle==null)continue;let a=i.Owner,l=o.lowerSite.Owner;if(a===l)continue;let u=t.get(a);if(u){let c=t.get(l);u===c&&n.add(o)}}return n}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let e of this.edges){let t=new Set,n=new Set;this.GetEdgeEnterablePolylines(e,t,n),this.enterableLoose.set(e,t),this.enterableTight.set(e,n)}}GetEdgeEnterablePolylines(e,t,n){let i=this.portsToShapes.get(e.sourcePort),o=this.portsToShapes.get(e.targetPort);i!==this.root&&this.GetEnterablesForShape(i,t,n),o!==this.root&&this.GetEnterablesForShape(o,t,n)}GetEnterablesForShape(e,t,n){for(let i of this.ancestorSets.get(e)){let o=this.LoosePolyOfOriginalShape(i);o&&t.add(o);let a=this.TightPolyOfOriginalShape(i);a&&n.add(a)}}GetTightHierarchy(){return Ke(Array.from(this.shapesToTightLooseCouples.values()).map(e=>st(e.TightPolyline,e.TightPolyline.boundingBox)))}GetLooseHierarchy(){let e=new Set;for(let t of this.shapesToTightLooseCouples.values())e.add(t.LooseShape.BoundaryCurve);return Ke(Array.from(e).map(t=>st(t,t.boundingBox)))}ScaleLooseShapesDown(){for(let[,e]of this.shapesToTightLooseCouples)e.LooseShape.BoundaryCurve=Kt.LoosePolylineWithFewCorners(e.TightPolyline,e.Distance/Ps.SuperLoosePaddingCoefficient,!1)}EdgePassport(e){let t=new Set,n=this.portsToShapes.get(e.sourcePort),i=this.portsToShapes.get(e.targetPort);return this.IsAncestor(n,i)?(Jo(t,i.Parents),t.add(n),t):this.IsAncestor(i,n)?(Jo(t,n.Parents),t.add(i),t):(n!==this.looseRoot&&Jo(t,n.Parents),i!==this.looseRoot&&Jo(t,i.Parents),t)}*AllPorts(){for(let e of this.edges)yield e.sourcePort,yield e.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let e of this.root.Descendants())for(let t of e.Ports)this.portsToShapes.set(t,e);for(let e of this.AllPorts())this.portsToShapes.has(e)||(this.root.Ports.add(e),this.portsToShapes.set(e,this.root))}RouteEdgeInternal(e,t){let n=new Array;e.sourcePort instanceof Nt||Ri(n,this.AddVisibilityEdgesFromPort(e.sourcePort)),e.targetPort instanceof Nt||Ri(n,this.AddVisibilityEdgesFromPort(e.targetPort));let i={smoothedPolyline:null};if(f.closeDistEps(e.sourcePort.Location,e.targetPort.Location)?e.curve=be.RouteSelfEdge(e.sourcePort.Curve,Math.max(this.LoosePadding*2,e.GetMaxArrowheadLength()),i):e.curve=t.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(e.sourcePort,e.targetPort,!0,i),e.smoothedPolyline=i.smoothedPolyline,e.curve==null)throw new Error;for(let o of n)Xe.RemoveEdge(o);Ve.trimSplineAndCalculateArrowheadsII(e,e.sourcePort.Curve,e.targetPort.Curve,e.curve,!1)}*AddVisibilityEdgesFromPort(e){let t,n;if(e instanceof ar||!(t=this.portsToShapes.get(e))||!(n=this.shapesToTightLooseCouples.get(t)))return;let i=n.LooseShape;for(let o of i.BoundaryCurve)this.visGraph.FindEdgePP(e.Location,o)==null&&(yield this.visGraph.AddEdgePP(e.Location,o))}makeTransparentShapesOfEdgeAndGetTheShapes(e){let t=this.portsToShapes.get(e.sourcePort),n=this.portsToShapes.get(e.targetPort),i=new Array;for(let o of this.GetTransparentShapes(e.sourcePort,e.targetPort,t,n))o!=null&&i.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.sourcePort))i.push(this.LooseShapeOfOriginalShape(o));for(let o of this.portsToEnterableShapes.get(e.targetPort))i.push(this.LooseShapeOfOriginalShape(o));return Fe.SetTransparency(i,!0),i}LooseShapeOfOriginalShape(e){return e===this.root?this.looseRoot:this.shapesToTightLooseCouples.get(e).LooseShape}LoosePolyOfOriginalShape(e){return this.LooseShapeOfOriginalShape(e).BoundaryCurve}TightPolyOfOriginalShape(e){return e===this.root?null:this.shapesToTightLooseCouples.get(e).TightPolyline}*GetTransparentShapes(e,t,n,i){for(let o of this.ancestorSets.get(n))yield o;for(let o of this.ancestorSets.get(i))yield o;Fe.EdgesAttachedToPortAvoidTheNode(e)||(yield n),Fe.EdgesAttachedToPortAvoidTheNode(t)||(yield i)}static SetTransparency(e,t){for(let n of e)n.IsTransparent=t}IsAncestor(e,t){let n;return t!=null&&(n=this.ancestorSets.get(t))!=null&&n.has(e)}static CreateLooseObstacleHierarachy(e){return Ke(e.map(t=>st(t,t.boundingBox)))}CreateTightObstacleHierarachy(e){let t=e.map(n=>this.shapesToTightLooseCouples.get(n).TightPolyline);return Ke(t.map(n=>st(n,n.boundingBox)))}CalculateVisibilityGraph(){let e=this.LineSweeperPorts!=null?We.mk(this.LineSweeperPorts):new We;this.ProcessHookAnyWherePorts(e),this.portRTree=vi(Array.from(e.values()).map(t=>[z.rectangleOnPoint(t),t])),this.visGraph=new Xe,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(e,t,n,i=null,o=null){let a=Array.from(t.Edges).map(l=>fe.mkDebugCurveTWCI(100,1,l.IsPassable!=null&&l.IsPassable()?"green":"black",R.mkPP(l.SourcePoint,l.TargetPoint)));if(n!=null)for(let l of n){a.push(fe.mkDebugCurveTWCI(100,.3,"brown",l));for(let u of l)a.push(fe.mkDebugCurveTWCI(100,1,"green",Ce.mkCircle(1,u)))}if(i!=null)for(let l of i)a.push(fe.mkDebugCurveTWCI(100,10,"navy",l));if(o!=null)for(let l of o)a.push(fe.mkDebugCurveTWCI(100,10,"red",l))}ProcessHookAnyWherePorts(e){for(let t of this.edges)t.sourcePort instanceof Nt||t.sourcePort instanceof br||e.add(t.sourcePort.Location),t.targetPort instanceof Nt||t.targetPort instanceof br||e.add(t.targetPort.Location)}FillVisibilityGraphUnderShape(e){let t=e.Children;for(let h of t)this.FillVisibilityGraphUnderShape(h);let n=this.shapesToTightLooseCouples.get(e),i=n?n.LooseShape.BoundaryCurve:null,o=n?n.LooseShape:this.looseRoot,a=new Set(o.Children.map(h=>h.BoundaryCurve)),l=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(i),u=new Xe,c=yo.mk([],u,this.coneAngle,l,i);c.run(),u=new Xe,c=yo.mk(Array.from(a),u,this.coneAngle,l,i),c.run(),this.ProgressStep();for(let h of u.Edges)this.TryToCreateNewEdgeAndSetIsPassable(h,o);this.AddBoundaryEdgesToVisGraph(i)}get Bidirectional(){return this.bidirectional}set Bidirectional(e){this.bidirectional=e}TryToCreateNewEdgeAndSetIsPassable(e,t){let n=this.visGraph.FindEdgePP(e.SourcePoint,e.TargetPoint);n==null&&(n=this.visGraph.AddEdgePP(e.SourcePoint,e.TargetPoint),t!=null&&(n.IsPassable=()=>t.IsTransparent))}AddBoundaryEdgesToVisGraph(e){if(e==null)return;let t;for(let n=e.startPoint;t=n.nextOnPolyline,this.visGraph.AddEdgePP(n.point,t.point),t!==e.startPoint;n=t);}RemoveInsidePortsAndSplitBoundaryIfNeeded(e){let t=new We;if(e==null){for(let o of this.portRTree.GetAllLeaves())t.add(o);return this.portRTree.clear(),t}let n=e.boundingBox,i=this.portRTree.GetAllIntersecting(n);for(let o of i)switch(x.PointRelativeToCurveLocation(o,e)){case 2:t.add(o),this.portRTree.Remove(z.rectangleOnPoint(o),o);break;case 1:this.portRTree.Remove(z.rectangleOnPoint(o),o);let a=Fe.FindPointOnPolylineToInsertAfter(e,o);if(a!=null)Bt.InsertPointIntoPolylineAfter(e,a,o);else throw new Error;break}return t}static FindPointOnPolylineToInsertAfter(e,t){for(let n=e.startPoint;;){let i=n.nextOnPolyline;if(f.closeDistEps(t,n.point)||f.closeDistEps(t,i.point))return null;let o=f.distToLineSegment(t,n.point,i.point).dist;if(ie(o,0))return n;if(n=i,n===e.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length===1){let e=this.rootShapes[0];if(e.BoundaryCurve==null){this.root=e;return}}this.rootWasCreated=!0,this.root=new mo(null);for(let e of this.rootShapes)this.root.AddChild(e)}RemoveRoot(){if(this.rootWasCreated)for(let e of this.rootShapes)e.RemoveParent(this.root)}static GetAncestorSetsMap(e){let t=new Map;for(let n of e.filter(i=>!t.has(i)))t.set(n,Fe.GetAncestorSet(n,t));return t}static GetAncestorSet(e,t){let n=new Set(e.Parents);for(let i of e.Parents){let o=t.get(i);o||t.set(i,o=Fe.GetAncestorSet(i,t));for(let a of o)n.add(a)}return n}static CreatePortsIfNeeded(e){for(let t of e){if(t.sourcePort==null){let n=t;new or(()=>n.source.boundaryCurve,()=>n.source.center,new f(0,0))}if(t.targetPort==null){let n=t;new or(()=>n.target.boundaryCurve,()=>n.target.center,new f(0,0))}}}static ComputeLooseSplinePadding(e,t){let n=2*t;return(e-n)/8}};function US(s,e,t){let n=Jp(s);new Fe(s,e,n.Padding,n.PolylinePadding,n.coneAngle,n.bundlingSettings,t).run()}var ni=class extends Pe{constructor(e,t,n,i,o,a){super(null);this.settings=e,this.OriginalGraph=t,this.Database=n,this.ProperLayeredGraph=o,this.LayerArrays=i,this.IntGraph=a}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){let e=[];for(let a of this.OriginalGraph.deepEdges)a.curve||e.push(a);if(e.length==0)return;let n=(this.OriginalGraph.layoutSettings?this.OriginalGraph.layoutSettings:new Ot).commonSettings.edgeRoutingSettings;new Fe(this.OriginalGraph,e,n.padding,n.polylinePadding,n.coneAngle,n.bundlingSettings,this.cancelToken).run(),Zr.constructorGA(this.OriginalGraph,e).run()}RouteFlatEdges(){}createRegularSplines(){for(let e of this.Database.RegularMultiedges()){if(rw(e))continue;let t=e.length,n=t===1&&this.MayOptimizeEdge(e[0]);for(let i=Math.floor(t/2);i<t;i++)this.createSplineForNonSelfEdge(e[i],n);for(let i=Math.floor(t/2)-1;i>=0;i--)this.createSplineForNonSelfEdge(e[i],n)}}MayOptimizeEdge(e){return!(this.ProperLayeredGraph.OutDegreeIsMoreThanOne(e.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(e.target)||qS(e.edge.source)||qS(e.edge.target))}createSelfSplines(){for(let[e,t]of this.Database.Multiedges.keyValues()){let n=e;if(n.x===n.y){let i=this.Database.Anchors[n.x],o=i.leftAnchor;for(let a of t){let l=this.settings.NodeSeparation+(this.settings.MinNodeWidth+o),u=i.bottomAnchor/2,c=i.origin,h=c.add(new f(0,u)),d=c.add(new f(l,u)),m=c.add(new f(l,-u)),P=c.add(new f(0,-u)),S=Be.mkSiteP(c),v=new Ue(S);S=Be.mkSiteSP(S,h),S=Be.mkSiteSP(S,d),S=Be.mkSiteSP(S,m),S=Be.mkSiteSP(S,P),Be.mkSiteSP(S,c);let I=v.createCurve();if(a.curve=I,a.edge.smoothedPolyline=v,o=l,a.edge.label!=null){o+=a.edge.label.width;let L=I.value((I.parStart+I.parEnd)/2),D=new f(L.x+a.labelWidth/2,i.y),w=new f(a.edge.label.width/2,a.edge.label.height/2),M=z.mkPP(D.add(w),D.sub(w));a.edge.label.width=M.width,a.edge.label.height=M.height,a.edge.label.positionCenter(D)}Ve.trimSplineAndCalculateArrowheadsII(a.edge,a.edge.source.boundaryCurve,a.edge.target.boundaryCurve,I,!1)}}}}createSplineForNonSelfEdge(e,t){e.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(e,t),e.IsVirtualEdge||(e.updateEdgeLabelPosition(this.Database.Anchors),Ve.trimSplineAndCalculateArrowheadsII(e.edge,e.edge.source.boundaryCurve,e.edge.target.boundaryCurve,e.curve,!0)))}drawSplineBySmothingThePolyline(e,t){let n=new nr(e,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database),i=n.getSpline(t);e.reversed?(e.curve=i.reverse(),e.underlyingPolyline=n.Reverse().GetPolyline):(e.curve=i,e.underlyingPolyline=n.GetPolyline)}static UpdateLabel(e,t){let n=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new f(t.x+t.rightAnchor/2,t.y)),n=R.mkPP(e.label.boundingBox.leftTop,e.label.boundingBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new f(t.x-t.leftAnchor/2,t.y)),n=R.mkPP(e.label.boundingBox.rightTop,e.label.boundingBox.rightBottom));let i=ni.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(i!=null&&x.getAllIntersections(e.curve,x.polyFromBox(e.label.boundingBox),!1).length===0){let o={curveClosestPoint:void 0,labelSideClosest:void 0};if(ni.FindClosestPoints(o,i,n))ni.ShiftLabel(e,o);else{let a=i.closestParameter(n.start),l=i.closestParameter(n.end);i.value(a).sub(n.start).length<i.value(l).sub(n.end).length?(o.curveClosestPoint=i.value(a),o.labelSideClosest=n.start):(o.curveClosestPoint=i.value(l),o.labelSideClosest=n.end),ni.ShiftLabel(e,o)}}}static ShiftLabel(e,t){let n=e.lineWidth/2,i=t.curveClosestPoint.sub(t.labelSideClosest),o=i.length;o>n&&e.label.positionCenter(e.label.center.add(i.div(o*(o-n))))}static FindClosestPoints(e,t,n){let i=x.minDistWithinIntervals(t,n,t.parStart,t.parEnd,n.parStart,n.parEnd,(t.parStart+t.parEnd)/2,(n.parStart+n.parEnd)/2);return i?(e.curveClosestPoint=i.aX,e.labelSideClosest=i.bX,!0):!1}static GetSegmentInFrontOfLabel(e,t){if(e instanceof x){let n=e;for(let i of n.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static GetNodeKind(e,t){return e===0?0:e<t.count?1:2}};function rw(s){if(s.length<4)return!1;for(let e of s)if(e.edge.label)return!1;return!0}function qS(s){return s.node.selfEdges.size>0}var fc=class extends Pe{constructor(e,t,n){super(n);this.LayersAreDoubled=!1;if(e==null)return;this.originalGraph=e,this.sugiyamaSettings=t;let i=Array.from(e.shallowNodes);this.nodeIdToIndex=new Map;let o=0;for(let l of i)this.nodeIdToIndex.set(l.id,o++);let a=[];for(let l of this.originalGraph.shallowEdges){let u=this.nodeIdToIndex.get(l.source.id);if(u==null)continue;let c=this.nodeIdToIndex.get(l.target.id);if(c==null)continue;let h=new Ir(u,c,l);a.push(h)}this.IntGraph=new co(a,e.shallowNodeCount),this.IntGraph.nodes=i,this.database=new _m(i.length);for(let l of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(l);this.cycleRemoval()}get extremeAspectRatio(){let e=this.originalGraph.boundingBox,t=e.width/e.height;return t<1/50||t>50}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount===0){this.originalGraph.boundingBox=z.mkEmpty();return}bw(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode===3&&this.runPostLayering(),Pw(this.originalGraph,this.sugiyamaSettings.transform)}runPostLayering(){let e=this.sugiyamaSettings.commonSettings.edgeRoutingSettings,t=this.constrainedOrdering!=null?0:e.EdgeRoutingMode;this.extremeAspectRatio?_d(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken):t===3?this.calculateEdgeSplines():ma(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let e=this.sugiyamaSettings.verticalConstraints,t=e.isEmpty?pn.getFeedbackSet(this.IntGraph):e.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(t)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let e=this.CalculateLayerArrays();return this.UpdateNodePositionData(),e}UpdateNodePositionData(){for(let e=0;e<this.IntGraph.nodeCount&&e<this.database.Anchors.length;e++)this.IntGraph.nodes[e].center=this.database.Anchors[e].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let e=0;e<this.originalGraph.shallowNodeCount;e++)this.SnapLeftSidesOfTheNodeToGrid(e,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(e,t){let n=this.IntGraph.nodes[e],i=this.database.Anchors[e];i.leftAnchor-=t/2,i.rightAnchor-=t/2;let o=n.boundingBox.left,a=Math.floor(o/t),l=o-a*t;Math.abs(l)<.001||(Math.abs(l)<=t/2?n.center=n.center.add(new f(-l,0)):n.center=n.center.add(new f(t-l,0)),i.x=n.center.x)}GetCurrentHeight(){let e=new On;for(let t of this.NodeAnchors())e.AddValue(t.top),e.AddValue(t.bottom);return e.length}*NodeAnchors(){let e=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let t=0;t<e;t++)yield this.anchors[t]}GetCurrentWidth(){let e=new On;for(let t of this.NodeAnchors())e.AddValue(t.left),e.AddValue(t.right);return e.length}ExtendLayeringToUngluedSameLayerVertices(e){let t=this.verticalConstraints;for(let n=0;n<e.length;n++)e[n]=e[t.nodeToRepr(n)];return e}calculateEdgeSplines(){new ni(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(e){let t=e.GetLayers();ku.Balance(this.gluedDagSkeletonForLayering,t,this.GetNodeCountsOfGluedDag(),null),t=this.ExtendLayeringToUngluedSameLayerVertices(t);let n=new Pn(t);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return n=this.YLayeringAndOrderingWithoutHorizontalConstraints(n),n;throw new Error("not implemented")}CreateProperLayeredGraph(e){let t=e.length,n=0;for(let o of this.database.SkeletonEdges()){let a=aw(e,o);a>0&&(o.LayerEdges=new Array(a));let l=0;if(a>1){let u=t+n++,c=new bn(o.source,u,o.CrossingWeight,o.weight);o.LayerEdges[l++]=c;for(let h=0;h<a-2;h++)u++,n++,c=new bn(u-1,u,o.CrossingWeight,o.weight),o.LayerEdges[l++]=c;c=new bn(u,o.target,o.CrossingWeight,o.weight),o.LayerEdges[l]=c}else if(a===1){let u=new bn(o.source,o.target,o.CrossingWeight,o.weight);o.LayerEdges[l]=u}}let i=new Array(this.originalGraph.shallowNodeCount+n).fill(0);for(let o of this.database.SkeletonEdges())if(o.LayerEdges!=null){let a=e[o.source];i[o.source]=a--;for(let l of o.LayerEdges)i[l.Target]=a--}else i[o.source]=e[o.source],i[o.target]=e[o.target];return this.properLayeredGraph=new ei(new co(Array.from(this.database.SkeletonEdges()),e.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new Pn(i)}YLayeringAndOrderingWithoutHorizontalConstraints(e){let t=this.CreateProperLayeredGraph(e.y);return Zo.OrderLayers(this.properLayeredGraph,t,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),bl.UpdateLayerArrays1(this.properLayeredGraph,t),t}CalculateYLayers(){let e=this.YLayeringAndOrdering(new Zm(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?e:this.InsertLayersIfNeeded(e)}InsertLayersIfNeeded(e){this.InsertVirtualEdgesIfNeeded(e);let t=this.AnalyzeNeedToInsertLayersAndHasMultiedges(e);if(t.needToInsertLayers){let n=Ko.InsertLayers(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,e=n.la,this.LayersAreDoubled=!0}else if(t.multipleEdges){let n=Li.InsertPaths(this.properLayeredGraph,e,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,e=n.la}return this.RecreateIntGraphFromDataBase(),e}RecreateIntGraphFromDataBase(){let e=new Array;for(let t of this.database.Multiedges.values())e=e.concat(t);this.IntGraph.SetEdges(e,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(e){if(this.constrainedOrdering==null){for(let[t,n]of this.database.Multiedges.keyValues())if(n.length%2===0&&e.y[t.x]-1===e.y[t.y]){let i=new be(null),o=new Ir(t.x,t.y,i);o.IsVirtualEdge=!0,n.splice(n.length/2,0,o),this.IntGraph.addEdge(o)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(e){let t=!1,n=!1;for(let i of this.IntGraph.edges)if(i.hasLabel&&e.y[i.source]!==e.y[i.target]){t=!0;break}if(t===!1&&this.constrainedOrdering==null){for(let[i,o]of this.database.Multiedges.keyValues())if(o.length>1&&(n=!0,e.y[i.x]-e.y[i.y]===1)){t=!0;break}}return{needToInsertLayers:t,multipleEdges:n}}UseBrandesXCalculations(e){return e.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(e){this.anchors=iw(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),ow(e,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let e=0;e<this.anchors.length;e++){let t=this.anchors[e];if(t.labelIsToTheRightOfTheSpline){let n=this.GetSuccessorAndPredecessor(e);if(!hw(t,n.predecessor,n.successor)){let i=n.predecessor.origin.sub(t.origin).length+n.successor.origin.sub(t.origin).length,o=t.right-t.leftAnchor,a=new f(o,t.y);n.predecessor.origin.sub(a).length+n.successor.origin.sub(a).length<i&&QS(t)}}}}GetSuccessorAndPredecessor(e){let t;for(let i of this.properLayeredGraph.InEdges(e))t=i.Source;let n;for(let i of this.properLayeredGraph.OutEdges(e))n=i.Target;return{predecessor:this.anchors[t],successor:this.anchors[n]}}CalculateLayerArrays(){let e=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(e),this.UseBrandesXCalculations(e)?this.CalculateXPositionsByBrandes(e):this.CalculateXLayersByGansnerNorth(e)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=e,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),e}StretchToDesiredAspectRatio(e,t){e>t?this.StretchInYDirection(e/t):e<t&&this.StretchInXDirection(t/e)}StretchInYDirection(e){let t=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let i of this.database.Anchors)i.bottomAnchor=i.bottomAnchor*e,i.topAnchor=i.topAnchor*e,i.y=t+e*(i.y-t);let n=this.originalGraph.height*e;this.originalGraph.boundingBox=new z({left:this.originalGraph.boundingBox.left,top:t+n/2,right:this.originalGraph.boundingBox.right,bottom:t-n/2})}StretchInXDirection(e){let t=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let i of this.database.Anchors)i.leftAnchor=i.leftAnchor*e,i.rightAnchor=i.rightAnchor*e,i.x=t+e*(i.x-t);let n=this.originalGraph.width*e;this.originalGraph.boundingBox=new z({left:t-n/2,top:this.originalGraph.boundingBox.top,right:t+n/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length===0)return;let e=new z({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let t=1;t<this.anchors.length;t++){let n=this.anchors[t];e.add(n.leftTop),e.add(n.rightBottom)}this.originalGraph.labelSize&&this.originalGraph.addLabelToGraphBB(e),e.padEverywhere(this.originalGraph.margins),this.originalGraph.boundingBox=e}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let e=!1;for(let t of this.database.AllIntEdges())t.LayerSpan===2&&(e=this.ShiftVertexWithNeighbors(t.LayerEdges[0].Source,t.LayerEdges[0].Target,t.LayerEdges[1].Target)||e);return e}ShiftVertexWithNeighbors(e,t,n){let i=this.database.Anchors[e],o=this.database.Anchors[n],a=this.database.Anchors[t],l=(a.y-i.y)*((o.x-i.x)/(o.y-i.y))+i.x,u=1e-4;return l>a.x+u?this.TryShiftToTheRight(l,t):l<a.x-u?this.TryShiftToTheLeft(l,t):!1}TryShiftToTheLeft(e,t){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],i=this.engineLayerArrays.x[t];if(i>0){let o=this.database.Anchors[n[i-1]],a=Math.max(o.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[t].leftAnchor),e);return a<this.database.Anchors[t].x-1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}TryShiftToTheRight(e,t){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[t]],i=this.engineLayerArrays.x[t];if(i<n.length-1){let o=this.database.Anchors[n[i+1]],a=Math.min(o.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[t].rightAnchor),e);return a>this.database.Anchors[t].x+1?(this.database.Anchors[t].x=a,!0):!1}return this.database.Anchors[t].x=e,!0}CalculateXLayersByGansnerNorth(e){this.xLayoutGraph=this.CreateXLayoutGraph(e),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let e=new Hu(this.xLayoutGraph,null).GetLayers();for(let t=0;t<this.database.Anchors.length;t++)this.anchors[t].x=e[t]}CreateXLayoutGraph(e){let t=this.properLayeredGraph.NodeCount,n=new Array;for(let o of this.properLayeredGraph.Edges){let a=new Ir(t,o.Source,null),l=new Ir(t,o.Target,null);l.weight=o.Weight,a.weight=o.Weight,a.separation=0,l.separation=0,t++,n.push(a),n.push(l)}for(let o of e.Layers)for(let a=o.length-1;a>0;a--){let l=o[a],u=o[a-1],c=new Ir(l,u,null),h=this.database.Anchors[l],d=this.database.Anchors[u],m=h.leftAnchor+(d.rightAnchor+this.sugiyamaSettings.NodeSeparation);c.separation=Math.ceil(m+.5),n.push(c)}let i=new $m(this.IntGraph,this.properLayeredGraph,e,n,t);return i.SetEdgeWeights(),i}CalculateXPositionsByBrandes(e){sd.CalculateXCoordinates(e,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let e=new mn(this.IntGraph.nodeCount);for(let[n,i]of this.database.Multiedges.keyValues()){if(n.isDiagonal())continue;let o=this.verticalConstraints.gluedIntEdge(i[0]);o.source!==o.target&&e.set(o.source,o.target,o)}let t=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(n=>sw(n,null));for(let n of t)e.set(n.source,n.target,n);return Array.from(e.values())}static CalcAnchorsForOriginalNode(e,t,n,i,o){let a={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(t.nodes!=null){let c=t.nodes[e];gw(a,c,o)}mw(e,a,i,o);let l=o.MinNodeWidth/2;a.leftAnchor<l&&(a.leftAnchor=l),a.rightAnchor<l&&(a.rightAnchor=l);let u=o.MinNodeHeight/2;a.topAnchor<u&&(a.topAnchor=u),a.bottomAnchor<u&&(a.bottomAnchor=u),n[e]=Hr.mkAnchor(a.leftAnchor,a.rightAnchor,a.topAnchor,a.bottomAnchor,t.nodes[e],o.LabelCornersPreserveCoefficient),n[e].padding=t.nodes[e].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new co(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let e=new mn(this.IntGraph.nodeCount);for(let t of this.gluedDagSkeletonForLayering.edges)e.set(t.source,t.target,t);for(let[t,n]of this.database.Multiedges.keyValues())if(t.x!==t.y){let i=this.verticalConstraints.gluedIntPair(t);if(i.x===i.y)continue;let o=e.get(i.x,i.y);for(let a of n)o.weight+=a.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function XS(s,e){if(e===0)return 0;let t=Math.floor(s/e),n=s-t*e;return Math.abs(n)<1e-4?0:e-n}function nw(s,e){for(let t of s)if(t<e)return!0;return!1}function iw(s,e,t,n,i){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new Hr(i.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)fc.CalcAnchorsForOriginalNode(a,n,o,s,i);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!==a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=ub()*4,c.topAnchor=c.bottomAnchor=YS(i)/2):(c.leftAnchor=c.rightAnchor=ub()/2,c.topAnchor=c.bottomAnchor=YS(i)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=ub()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function ub(){return 1}function YS(s){return s.MinNodeHeight*1.5/8}function KS(s,e,t,n,i,o){let a=0;if(t>0){let l=dw(e.Layers[t-1],e.y,n);if(l.length){let u=i.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>fw(h,c,u,s)))}}return a}function ow(s,e,t,n,i,o,a){let l=n.Anchors,u=t.margins.top+e,c=0;for(let h of s.Layers){let d=0,m=0;for(let L of h){let D=l[L];D.bottomAnchor>d&&(d=D.bottomAnchor),D.topAnchor>m&&(m=D.topAnchor)}lw(h,d,m,t.shallowNodeCount,n.Anchors);let P=KS(n,s,c,i,o,u),S=u+d+P,v=S+m;if(uw(o)){v+=XS(v,o.GridSizeByY);for(let L of h)l[L].top=v}else if(cw(o)){let L=S-d;L+=XS(L,L);for(let D of h)l[D].bottom=L,v=Math.max(l[D].top,v)}else for(let L of h)l[L].y=S;let I=o.ActualLayerSeparation(a);u=v+I,c++}KS(n,s,c,i,o,u)}function sw(s,e){let t=new Ir(s.x,s.y,e);return t.weight=0,t.separation=1,t}function aw(s,e){return s[e.source]-s[e.target]}function lw(s,e,t,n,i){if(nw(s,n)){for(let o of s)if(o>=n){let a=i[o];a.bottomAnchor=e,a.topAnchor=t}}}function uw(s){return s.SnapToGridByY===1}function cw(s){return s.SnapToGridByY===2}function hw(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(f.getTriangleOrientation(e.origin,s.origin,t.origin)===0)return!0;let n=s.leftAnchor,i=s.rightAnchor,o=s.x;return QS(s),f.getTriangleOrientation(e.origin,s.origin,t.origin)===1?!0:(s.x=o,s.leftAnchor=n,s.rightAnchor=i,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function QS(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function dw(s,e,t){let n=new mr;for(let i of s)if(!(i>=t.nodeCount))for(let o of t.outEdges[i])e[o.source]===e[o.target]&&n.addNN(o.source,o.target);return Array.from(n.values())}function fw(s,e,t,n){let i=0,o=n.GetMultiedgeI(s);for(let a of o){i+=t;let l=a.edge.label;l!=null&&(l.positionCenter(new f(l.center.x,e+i+l.height/2)),i+=l.height)}return i}function gw(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function mw(s,e,t,n){let i=pw(t,s,e,n);e.rightAnchor+=i}function pw(s,e,t,n){let i=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));i+=(n.NodeSeparation+n.MinNodeWidth)*o.length}return i}function bw(s,e){if(e.isIdentity())return;let t=e.inverse();for(let n of s.shallowNodes)n.transform(t);for(let n of s.shallowEdges)if(n.label!=null){let i=z.mkPP(t.multiplyPoint(new f(0,0)),t.multiplyPoint(new f(n.label.width,n.label.height)));n.label.width=i.width,n.label.height=i.height}}function Pw(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes)t.transform(e);for(let t of s.shallowEdges)if(t.label!=null){let n=z.mkPP(e.multiplyPoint(new f(0,0)),e.multiplyPoint(new f(t.label.width,t.label.height)));t.label.width=n.width,t.label.height=n.height}yw(s,e),s.graph.parent==null&&(s.boundingBox=null)}}function yw(s,e){for(let t of s.shallowEdges)t.label&&t.label.transform(e),Sw(e,t)}function Sw(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),Ew(e,s)}}function Ew(s,e){if(s.smoothedPolyline!=null)for(let t=s.smoothedPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var JS="abstract a alf arrows arrowsize AvantGarde awilliams b100 b102 b103 b104 b106 b117 b123 b124 b135 b143 b145 b146 b155 b15 b22 b29 b33 b34 b36 b3 b491 b51 b53 b545 b56 b57 b58 b60 b62 b68 b69 b71 b73a b73 b76 b77 b786 b79 b7 b80a b80 b81 b85 b94 b993 bad badvoro b big biglabel Bookman cairo center channel clover clust1 clust2 clust3 clust4 clust5 clusters clust clustlabel color colorscheme colors compound Courier crazy ctext dd decorate dfa d dir dpd edgeclip ER fdp fig6 flatedge fsm grammar grdangles grdcluster grdcolors grdfillcolor grdlinear_angle grdlinear grdlinear_node grdradial_angle grdradial grdradial_node grdshapes hashtable Heawood Helvetica honda-tokoro html2 html in inv_inv inv_nul inv_val japanese jcctree jsort KW91 labelclust-fbc labelclust-fbd labelclust-fbl labelclust-fbr labelclust-fdc labelclust-fdd labelclust-fdl labelclust-fdr labelclust-ftc labelclust-ftd labelclust-ftl labelclust-ftr labelclust-nbc labelclust-nbd labelclust-nbl labelclust-nbr labelclust-ndc labelclust-ndd labelclust-ndl labelclust-ndr labelclust-ntc labelclust-ntd labelclust-ntl labelclust-ntr labelroot-fbc labelroot-fbd labelroot-fbl labelroot-fbr labelroot-fdc labelroot-fdd labelroot-fdl labelroot-fdr labelroot-ftc labelroot-ftd labelroot-ftl labelroot-ftr labelroot-nbc labelroot-nbd labelroot-nbl labelroot-nbr labelroot-ndc labelroot-ndd labelroot-ndl labelroot-ndr labelroot-ntc labelroot-ntd labelroot-ntl labelroot-ntr Latin1 layer2 layer layers ldbxtried longflat lsunix1 lsunix2 lsunix3 mike mode multi NaN nestedclust newarrows NewCenturySchlbk ngk10_4 nhg nojustify nul_inv nul_nul nul_val ordering overlap p2 p3 p4 pack Palatino Petersen pgram p pm2way pmpipe polypoly ports proc3d process ps pslib ps_user_shapes rd_rules record2 record records root rootlabel rowcolsep rowe russian sb_box_dbl sb_box sb_circle_dbl sb_circle shapes shells sides size sl_box_dbl sl_box sl_circle_dbl sl_circle smlred sq_rules sr_box_dbl sr_box sr_circle_dbl sr_circle states st_box_dbl st_box st_circle_dbl st_circle structs style Symbol Times train11 trapeziumlr tree triedds try unix2 unix2k unix url user_shapes val_inv val_nul val_val viewfile viewport weight world xlabels xx ZapfChancery ZapfDingbats".split(" "),cb={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},hb={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",ipsepCola:"IPSepCola",mds:"Pivot MDS"},ZS=["Times New Roman","Arial","Georgia","Courier New","Verdana"];function ys(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var Ui={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},xw=Ui.self||Ui.window||Ui.global||{},Aw=Ui.window||Ui.self||Ui.global||{},vw=Ui.global||Ui.self||Ui.window||{},Tw=Ui.document||{};var Ea=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var $S=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),Iw=$S&&parseFloat($S[1])||0;var eE="3.2.12";function Mr(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var Wi={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},Jie=Wi.self||Wi.window||Wi.global||{},Zie=Wi.window||Wi.self||Wi.global||{},$ie=Wi.global||Wi.self||Wi.window||{},eoe=Wi.document||{};var Ca=typeof process!="object"||String(process)!=="[object process]"||process.browser;var rE=typeof window<"u"&&typeof window.orientation<"u",tE=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),toe=tE&&parseFloat(tE[1])||0;function T(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var jd=class{constructor(e,t){T(this,"name",void 0),T(this,"workerThread",void 0),T(this,"isRunning",!0),T(this,"result",void 0),T(this,"_resolve",()=>{}),T(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((n,i)=>{this._resolve=n,this._reject=i})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Mr(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Mr(this.isRunning),this.isRunning=!1,this._reject(e)}};var Pc=class{};var db=new Map;function nE(s){Mr(s.source&&!s.url||!s.source&&s.url);let e=db.get(s.source||s.url);return e||(s.url&&(e=ww(s.url),db.set(s.url,e)),s.source&&(e=iE(s.source),db.set(s.source,e))),Mr(e),e}function ww(s){if(!s.startsWith("http"))return s;let e=Lw(s);return iE(e)}function iE(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function Lw(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function fb(s,e=!0,t){let n=t||new Set;if(s){if(oE(s))n.add(s);else if(oE(s.buffer))n.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let i in s)fb(s[i],e,n)}}return t===void 0?Array.from(n):[]}function oE(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var gb=()=>{},xa=class{static isSupported(){return typeof Worker<"u"&&Ca||typeof Pc<"u"&&!Ca}constructor(e){T(this,"name",void 0),T(this,"source",void 0),T(this,"url",void 0),T(this,"terminated",!1),T(this,"worker",void 0),T(this,"onMessage",void 0),T(this,"onError",void 0),T(this,"_loadableURL","");let{name:t,source:n,url:i}=e;Mr(n||i),this.name=t,this.source=n,this.url=i,this.onMessage=gb,this.onError=o=>console.log(o),this.worker=Ca?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=gb,this.onError=gb,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||fb(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=nE({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){let n=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new Pc(n,{eval:!1})}else if(this.source)e=new Pc(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}};var qd=class{static isSupported(){return xa.isSupported()}constructor(e){T(this,"name","unnamed"),T(this,"source",void 0),T(this,"url",void 0),T(this,"maxConcurrency",1),T(this,"maxMobileConcurrency",1),T(this,"onDebug",()=>{}),T(this,"reuseWorkers",!0),T(this,"props",{}),T(this,"jobQueue",[]),T(this,"idleQueue",[]),T(this,"count",0),T(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(i,o,a)=>i.done(a),n=(i,o)=>i.error(o)){let i=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:n,onStart:o}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let n=new jd(t.name,e);e.onMessage=i=>t.onMessage(n,i.type,i.payload),e.onError=i=>t.onError(n,i),t.onStart(n);try{await n.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new xa({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return rE?this.maxMobileConcurrency:this.maxConcurrency}};var Ow={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},An=class{static isSupported(){return xa.isSupported()}static getWorkerFarm(e={}){return An._workerFarm=An._workerFarm||new An({}),An._workerFarm.setProps(e),An._workerFarm}constructor(e){T(this,"props",void 0),T(this,"workerPools",new Map),this.props={...Ow},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:n,url:i}=e,o=this.workerPools.get(t);return o||(o=new qd({name:t,source:n,url:i}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};T(An,"_workerFarm",void 0);var Rw="latest";function mb(s,e={}){let t=e[s.id]||{},n="".concat(s.id,"-worker.js"),i=t.workerUrl;if(!i&&s.id==="compression"&&(i=e.workerUrl),e._workerType==="test"&&(i="modules/".concat(s.module,"/dist/").concat(n)),!i){let o=s.version;o==="latest"&&(o=Rw);let a=o?"@".concat(o):"";i="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(n)}return Mr(i),i}function pb(s,e=eE){Mr(s,"no worker provided");let t=s.version;return!(!e||!t)}function bb(s,e){return!An.isSupported()||!Ca&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&e?.worker}async function Pb(s,e,t,n,i){let o=s.id,a=mb(s,t),u=An.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t)),n=JSON.parse(JSON.stringify(n||{}));let c=await u.startJob("process-on-worker",Bw.bind(null,i));return c.postMessage("process",{input:e,options:t,context:n}),await(await c.result).result}async function Bw(s,e,t,n){switch(t){case"done":e.done(n);break;case"error":e.error(new Error(n.error));break;case"process":let{id:i,input:o,options:a}=n;try{let l=await s(o,a);e.postMessage("done",{id:i,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:i,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function yb(s){return s&&typeof s=="object"&&s.isBuffer}function sE(s){return yb(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function Xd(s){if(yb(s))return sE(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function Sb(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let n=new Uint8Array(s),i=new Uint8Array(e);for(let o=0;o<n.length;++o)if(n[o]!==i[o])return!1;return!0}function Eb(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),n=new Uint8Array(t),i=0;for(let o of e)n.set(o,i),i+=o.byteLength;return n.buffer}async function Cb(s){let e=[];for await(let t of s)e.push(t);return Eb(...e)}function yc(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var Aa=class{constructor(e,t){T(this,"name",void 0),T(this,"type",void 0),T(this,"sampleSize",1),T(this,"time",void 0),T(this,"count",void 0),T(this,"samples",void 0),T(this,"lastTiming",void 0),T(this,"lastSampleTime",void 0),T(this,"lastSampleCount",void 0),T(this,"_count",0),T(this,"_time",0),T(this,"_samples",0),T(this,"_startTime",0),T(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=yc(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(yc()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var Bl=class{constructor(e){T(this,"id",void 0),T(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:n}=e;return this.stats[t]||(e instanceof Aa?this.stats[t]=e:this.stats[t]=new Aa(t,n)),this.stats[t]}};var Nw="",aE={};function xb(s){for(let e in aE)if(s.startsWith(e)){let t=aE[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(Nw).concat(s)),s}var Yd={};GT(Yd,{dirname:()=>Mw,filename:()=>Gw,join:()=>Dw});function Gw(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function Mw(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function Dw(...s){let e="/";return s=s.map((t,n)=>(n&&(t=t.replace(new RegExp("^".concat(e)),"")),n!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var Fw=s=>typeof s=="boolean",Sc=s=>typeof s=="function",Nl=s=>s!==null&&typeof s=="object",Ab=s=>Nl(s)&&s.constructor==={}.constructor;var lE=s=>s&&typeof s[Symbol.iterator]=="function",uE=s=>s&&typeof s[Symbol.asyncIterator]=="function";var li=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var ui=s=>typeof Blob<"u"&&s instanceof Blob,cE=s=>s&&typeof s=="object"&&s.isBuffer;var _w=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||Nl(s)&&Sc(s.tee)&&Sc(s.cancel)&&Sc(s.getReader);var Vw=s=>Nl(s)&&Sc(s.read)&&Sc(s.pipe)&&Fw(s.readable),Kd=s=>_w(s)||Vw(s);var kw=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Uw=/^([-\w.]+\/[-\w.+]+)/;function hE(s){let e=Uw.exec(s);return e?e[1]:s}function vb(s){let e=kw.exec(s);return e?e[1]:""}var Ww=/\?.*/;function va(s){if(li(s)){let e=Tb(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:hE(t)||vb(e)}}return ui(s)?{url:Tb(s.name||""),type:s.type||""}:typeof s=="string"?{url:Tb(s),type:vb(s)}:{url:"",type:""}}function dE(s){return li(s)?s.headers["content-length"]||-1:ui(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function Tb(s){return s.replace(Ww,"")}async function Qd(s){if(li(s))return s;let e={},t=dE(s);t>=0&&(e["content-length"]=String(t));let{url:n,type:i}=va(s);i&&(e["content-type"]=i);let o=await Hw(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:n}),a}async function fE(s){if(!s.ok){let e=await zw(s);throw new Error(e)}}async function zw(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),n=s.statusText;t.includes("application/json")&&(n+=" ".concat(await s.text())),e+=n,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function Hw(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(n=>{let i=new FileReader;i.onload=o=>{var a;return n(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},i.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),n=jw(t);return"data:base64,".concat(n)}return null}function jw(s){let e="",t=new Uint8Array(s);for(let n=0;n<t.byteLength;n++)e+=String.fromCharCode(t[n]);return btoa(e)}async function Ib(s,e){if(typeof s=="string"){s=xb(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await Qd(s)}function Ec(s){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;let e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}function Cr(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Ec()}var Ss={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process};var qw=Ss.self||Ss.window||Ss.global,Gl=Ss.window||Ss.self||Ss.global,Xw=Ss.document||{},Ta=Ss.process||{};var Jd=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",Gse=Cr();var wb=globalThis;function Zd(s){if(!s&&!Cr())return"Node";if(Ec(s))return"Electron";let t=s||(typeof navigator<"u"?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";let n=t.indexOf("MSIE ")!==-1,i=t.indexOf("Trident/")!==-1;return n||i?"IE":wb.chrome?"Chrome":wb.safari?"Safari":wb.mozInnerScreenX?"Firefox":"Unknown"}function Yw(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var $d=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";T(this,"storage",void 0),T(this,"id",void 0),T(this,"config",{}),this.storage=Yw(n),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function gE(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function mE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function ef(s,e,t){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,i=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>n&&(t=Math.min(t,n/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(i,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var tf;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(tf||(tf={}));function pE(s){return typeof s=="string"?tf[s.toUpperCase()]||tf.WHITE:s}function bE(s,e,t){return!Cr&&typeof s=="string"&&(e&&(e=pE(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=pE(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function PE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),n=Object.getOwnPropertyNames(t);for(let i of n)typeof s[i]=="function"&&(e.find(o=>i===o)||(s[i]=s[i].bind(s)))}function Ml(s,e){if(!s)throw new Error(e||"Assertion failed")}function Ia(){let s;if(Cr&&"performance"in Gl){var e,t;s=Gl===null||Gl===void 0||(e=Gl.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in Ta){var n;let i=Ta===null||Ta===void 0||(n=Ta.hrtime)===null||n===void 0?void 0:n.call(Ta);s=i[0]*1e3+i[1]/1e6}else s=Date.now();return s}var Dl={debug:Cr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Kw={enabled:!0,level:0};function kn(){}var yE={},SE={once:!0},tn=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};T(this,"id",void 0),T(this,"VERSION",Jd),T(this,"_startTs",Ia()),T(this,"_deltaTs",Ia()),T(this,"_storage",void 0),T(this,"userData",{}),T(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new $d("__probe-".concat(this.id,"__"),Kw),this.userData={},this.timeStamp("".concat(this.id," started")),PE(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ia()-this._startTs).toPrecision(10))}getDelta(){return Number((Ia()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){Ml(e,t)}warn(e){return this._getLogFunction(0,e,Dl.warn,arguments,SE)}error(e){return this._getLogFunction(0,e,Dl.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,Dl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Dl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];return this._getLogFunction(e,t,Dl.debug||Dl.info,arguments,SE)}table(e,t,n){return t?this._getLogFunction(e,t,console.table||kn,n&&[n],{tag:$w(t)}):kn}image(e){let{logLevel:t,priority:n,image:i,message:o="",scale:a=1}=e;return this._shouldLog(t||n)?Cr?Zw({image:i,message:o,scale:a}):Jw({image:i,message:o,scale:a}):kn}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||kn)}group(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},i=EE({logLevel:e,message:t,opts:n}),{collapsed:o}=n;return i.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},n,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||kn)}withGroup(e,t,n){this.group(e,t)();try{n()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=CE(e)}_getLogFunction(e,t,n,i,o){if(this._shouldLog(e)){o=EE({logLevel:e,message:t,args:i,opts:o}),n=n||o.method,Ml(n),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Ia();let a=o.tag||o.message;if(o.once)if(!yE[a])yE[a]=Ia();else return kn;return t=Qw(this.id,o.message,o),n.bind(console,t,...o.args)}return kn}};T(tn,"VERSION",Jd);function CE(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return Ml(Number.isFinite(e)&&e>=0),e}function EE(s){let{logLevel:e,message:t}=s;s.logLevel=CE(e);let n=s.args?Array.from(s.args):[];for(;n.length&&n.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&n.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let i=typeof s.message;return Ml(i==="string"||i==="object"),Object.assign(s,{args:n},s.opts)}function Qw(s,e,t){if(typeof e=="string"){let n=t.time?mE(gE(t.total)):"";e=t.time?"".concat(s,": ").concat(n,"  ").concat(e):"".concat(s,": ").concat(e),e=bE(e,t.color,t.background)}return e}function Jw(s){let{image:e,message:t="",scale:n=1}=s,i=null;try{i=module.require("asciify-image")}catch{}return i?()=>i(e,{fit:"box",width:"".concat(Math.round(80*n),"%")}).then(o=>console.log(o)):kn}function Zw(s){let{image:e,message:t="",scale:n=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=ef(o,t,n);console.log(...a)},o.src=e,kn}let i=e.nodeName||"";if(i.toLowerCase()==="img")return console.log(...ef(e,t,n)),kn;if(i.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...ef(o,t,n)),o.src=e.toDataURL(),kn}return kn}function $w(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var fae=new tn({id:"@probe.gl/log"});var Lb=new tn({id:"loaders.gl"}),Ob=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},Rb=class{constructor(){T(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var Bb={fetch:null,mimeType:void 0,nothrow:!1,log:new Rb,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:Ea,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},xE={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Nb(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var TE=()=>{let s=Nb();return s.globalOptions=s.globalOptions||{...Bb},s.globalOptions};function IE(s,e,t,n){return t=t||[],t=Array.isArray(t)?t:[t],eL(s,t),rL(e,s,n)}function rf(s,e){let t=TE(),n=s||t;return typeof n.fetch=="function"?n.fetch:Nl(n.fetch)?i=>Ib(i,n):e!=null&&e.fetch?e?.fetch:Ib}function eL(s,e){AE(s,null,Bb,xE,e);for(let t of e){let n=s&&s[t.id]||{},i=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};AE(n,t.id,i,o,e)}}function AE(s,e,t,n,i){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&Nl(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in n)Lb.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(n[l],"'"))();else if(!u){let d=tL(l,i);Lb.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function tL(s,e){let t=s.toLowerCase(),n="";for(let i of e)for(let o in i.options){if(s===o)return"Did you mean '".concat(i.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(n=n||"Did you mean '".concat(i.id,".").concat(o,"'?"))}return n}function rL(s,e,t){let i={...s.options||{}};return nL(i,t),i.log===null&&(i.log=new Ob),vE(i,TE()),vE(i,e),i}function vE(s,e){for(let t in e)if(t in e){let n=e[t];Ab(n)&&Ab(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function nL(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function Cc(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function Gb(s){var e,t;ys(s,"null loader"),ys(Cc(s),"invalid loader");let n;return Array.isArray(s)&&(n=s[1],s=s[0],s={...s,options:{...s.options,...n}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var iL=()=>{let s=Nb();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function wE(){return iL()}var LE=new tn({id:"loaders.gl"});var oL=/\.([^.]+)$/;async function BE(s,e=[],t,n){if(!NE(s))return null;let i=OE(s,e,{...t,nothrow:!0},n);if(i)return i;if(ui(s)&&(s=await s.slice(0,10).arrayBuffer(),i=OE(s,e,t,n)),!i&&!(t!=null&&t.nothrow))throw new Error(GE(s));return i}function OE(s,e=[],t,n){if(!NE(s))return null;if(e&&!Array.isArray(e))return Gb(e);let i=[];e&&(i=i.concat(e)),t!=null&&t.ignoreRegisteredLoaders||i.push(...wE()),aL(i);let o=sL(s,i,t,n);if(!o&&!(t!=null&&t.nothrow))throw new Error(GE(s));return o}function sL(s,e,t,n){let{url:i,type:o}=va(s),a=i||n?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=Mb(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||lL(e,a),u=u||(l?"matched url ".concat(a):""),l=l||Mb(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||cL(e,s),u=u||(l?"matched initial data ".concat(ME(s)):""),l=l||Mb(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;LE.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function NE(s){return!(s instanceof Response&&s.status===204)}function GE(s){let{url:e,type:t}=va(s),n="No valid loader found (";n+=e?"".concat(Yd.filename(e),", "):"no url provided, ",n+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let i=s?ME(s):"";return n+=i?' first bytes: "'.concat(i,'"'):"first bytes: not available",n+=")",n}function aL(s){for(let e of s)Gb(e)}function lL(s,e){let t=e&&oL.exec(e),n=t&&t[1];return n?uL(s,n):null}function uL(s,e){e=e.toLowerCase();for(let t of s)for(let n of t.extensions)if(n.toLowerCase()===e)return t;return null}function Mb(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function cL(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(hL(e,t))return t}else if(ArrayBuffer.isView(e)){if(RE(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&RE(e,0,t))return t;return null}function hL(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(n=>s.startsWith(n))}function RE(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(i=>dL(s,e,t,i))}function dL(s,e,t,n){if(n instanceof ArrayBuffer)return Sb(n,s,n.byteLength);switch(typeof n){case"function":return n(s,t);case"string":let i=Db(s,e,n.length);return n===i;default:return!1}}function ME(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?Db(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?Db(s,0,e):""}function Db(s,e,t){if(s.byteLength<e+t)return"";let n=new DataView(s),i="";for(let o=0;o<t;o++)i+=String.fromCharCode(n.getUint8(e+o));return i}function*DE(s,e){let t=e?.chunkSize||262144,n=0,i=new TextEncoder;for(;n<s.length;){let o=Math.min(s.length-n,t),a=s.slice(n,n+o);n+=o,yield i.encode(a)}}function*FE(s,e={}){let{chunkSize:t=262144}=e,n=0;for(;n<s.byteLength;){let i=Math.min(s.byteLength-n,t),o=new ArrayBuffer(i),a=new Uint8Array(s,n,i);new Uint8Array(o).set(a),n+=i,yield o}}async function*_E(s,e){let t=e?.chunkSize||1048576,n=0;for(;n<s.size;){let i=n+t,o=await s.slice(n,i).arrayBuffer();n=i,yield o}}function Fb(s,e){return Ea?fL(s,e):gL(s,e)}async function*fL(s,e){let t=s.getReader(),n;try{for(;;){let i=n||t.read();e!=null&&e._streamReadAhead&&(n=t.read());let{done:o,value:a}=await i;if(o)return;yield Xd(a)}}catch{t.releaseLock()}}async function*gL(s,e){for await(let t of s)yield Xd(t)}function VE(s,e){if(typeof s=="string")return DE(s,e);if(s instanceof ArrayBuffer)return FE(s,e);if(ui(s))return _E(s,e);if(Kd(s))return Fb(s,e);if(li(s))return Fb(s.body,e);throw new Error("makeIterator")}var kE="Cannot convert supplied data type";function mL(s,e,t){if(e.text&&typeof s=="string")return s;if(cE(s)&&(s=s.buffer),s instanceof ArrayBuffer){let n=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let n=s.buffer,i=s.byteLength||s.length;return(s.byteOffset!==0||i!==n.byteLength)&&(n=n.slice(s.byteOffset,s.byteOffset+i)),n}throw new Error(kE)}async function UE(s,e,t){let n=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||n)return mL(s,e,t);if(ui(s)&&(s=await Qd(s)),li(s)){let i=s;return await fE(i),e.binary?await i.arrayBuffer():await i.text()}if(Kd(s)&&(s=VE(s,t)),lE(s)||uE(s))return Cb(s);throw new Error(kE)}function WE(s,e,t=null){if(t)return t;let n={fetch:rf(e,s),...s};return Array.isArray(n.loaders)||(n.loaders=null),n}function zE(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let n=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...n]:n}return t&&t.length?t:null}async function nf(s,e,t,n){Mr(!n||typeof n=="object"),e&&!Array.isArray(e)&&!Cc(e)&&(n=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:i}=va(s),a=zE(e,n),l=await BE(s,a,t);return l?(t=IE(t,l,a,i),n=WE({url:i,parse:nf,loaders:a},t,n),await pL(l,s,t,n)):null}async function pL(s,e,t,n){if(pb(s),li(e)){let i=e,{ok:o,redirected:a,status:l,statusText:u,type:c,url:h}=i,d=Object.fromEntries(i.headers.entries());n.response={headers:d,ok:o,redirected:a,status:l,statusText:u,type:c,url:h}}if(e=await UE(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,n,s);if(bb(s,t))return await Pb(s,e,t,n,nf);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,n,s);if(s.parse)return await s.parse(e,t,n,s);throw Mr(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function Fl(s,e,t,n){!Array.isArray(e)&&!Cc(e)&&(n=void 0,t=e,e=void 0);let i=rf(t),o=s;return typeof s=="string"&&(o=await i(s)),ui(s)&&(o=await i(s)),await nf(o,e,t)}var HE="3.2.12";var{_parseImageNode:bL}=globalThis,_b=typeof Image<"u",Vb=typeof ImageBitmap<"u",PL=Boolean(bL),kb=Ea?!0:PL;function jE(s){switch(s){case"auto":return Vb||_b||kb;case"imagebitmap":return Vb;case"image":return _b;case"data":return kb;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function qE(){if(Vb)return"imagebitmap";if(_b)return"image";if(kb)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function yL(s){let e=SL(s);if(!e)throw new Error("Not an image");return e}function XE(s){switch(yL(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function SL(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var EL=/^data:image\/svg\+xml/,CL=/\.svg((\?|#).*)?$/;function of(s){return s&&(EL.test(s)||CL.test(s))}function YE(s,e){if(of(e)){let n=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(n=unescape(encodeURIComponent(n)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(n))}return Ub(s,e)}function Ub(s,e){if(of(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function xc(s,e,t){let n=YE(s,t),i=self.URL||self.webkitURL,o=typeof n!="string"&&i.createObjectURL(n);try{return await xL(o||n,e)}finally{o&&i.revokeObjectURL(o)}}async function xL(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((n,i)=>{try{t.onload=()=>n(t),t.onerror=o=>i(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){i(o)}})}var AL={},KE=!0;async function Wb(s,e,t){let n;of(t)?n=await xc(s,e,t):n=Ub(s,t);let i=e&&e.imagebitmap;return await vL(n,i)}async function vL(s,e=null){if((TL(e)||!KE)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),KE=!1}return await createImageBitmap(s)}function TL(s){for(let e in s||AL)return!1;return!0}function sf(s){let e=Ac(s);return IL(e)||OL(e)||wL(e)||LL(e)}function IL(s){let e=Ac(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function wL(s){let e=Ac(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function LL(s){let e=Ac(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function OL(s){let e=Ac(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:n,sofMarkers:i}=RL(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(i.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!n.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function RL(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Ac(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function zb(s,e){let{mimeType:t}=sf(s)||{},n=globalThis._parseImageNode;return ys(n),await n(s,t)}async function Hb(s,e,t){e=e||{};let i=(e.image||{}).type||"auto",{url:o}=t||{},a=BL(i),l;switch(a){case"imagebitmap":l=await Wb(s,e,o);break;case"image":l=await xc(s,e,o);break;case"data":l=await zb(s,e);break;default:ys(!1)}return i==="data"&&(l=XE(l)),l}function BL(s){switch(s){case"auto":case"data":return qE();default:return jE(s),s}}var NL=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],GL=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],ML={image:{type:"auto",decode:!0}},jb={id:"image",module:"images",name:"Images",version:HE,mimeTypes:GL,extensions:NL,parse:Hb,tests:[s=>Boolean(sf(new DataView(s)))],options:ML};var Ye=new tn({id:"deck"});var QE={};function xr(s,e,t,n){Ye.level>0&&QE[s]&&QE[s].call(null,e,t,n)}var oe=new tn({id:"luma.gl"});function Ht(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var DL="Invalid WebGLRenderingContext";var FL="Requires WebGL2";function wa(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function me(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function qb(s){return me(s)?s:null}function Lo(s){return Ht(wa(s),DL),s}function gt(s){return Ht(me(s),FL),s}var vc={};function _L(s){globalThis.console&&globalThis.console.error&&globalThis.console.error(s)}function VL(s){globalThis.console&&globalThis.console.log&&globalThis.console.log(s)}function kL(s,e){vc[s]=!0,e!==void 0&&_L(e)}function UL(s){let e=s.getError;s.getError=function(){let n;do n=e.apply(s),n!==0&&(vc[n]=!0);while(n!==0);for(n in vc)if(vc[n])return delete vc[n],parseInt(n,10);return 0}}var Tc=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let n=0;n<this.attribs.length;n++){let i=new s.VertexAttrib(t);this.attribs[n]=i}this.maxAttrib=0};Tc.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};Tc.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var La=function(e){let t=this;this.gl=e,UL(e);let n=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:n.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return n.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let m=d.attribs[o];return m.buffer=t.currentArrayBuffer,m.size=a,m.type=l,m.normalized=u,m.stride=c,m.offset=h,m.recache(),n.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{VL("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};La.prototype.VERTEX_ARRAY_BINDING_OES=34229;La.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let n=0;n<this.vertexArrayObjects.length;++n)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new Tc(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};La.prototype.createVertexArrayOES=function(){let e=new Tc(this);return this.vertexArrayObjects.push(e),e};La.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};La.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof Tc&&e.hasBeenBound&&e.ext===this)};La.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){kL(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let n=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(i===o)return;(!i||o.elementArrayBuffer!==i.elementArrayBuffer)&&n.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(i?i.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=i?i.attribs[u]:null;if((!i||c.enabled!==h.enabled)&&(c.enabled?n.enableVertexAttribArray.call(t,u):n.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!i||c.buffer!==h.buffer)&&(a!==c.buffer&&(n.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&n.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&n.bindBuffer.call(t,34962,this.currentArrayBuffer)};function JE(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let i=e.call(this)||[];return i.indexOf("OES_vertex_array_object")<0&&i.push("OES_vertex_array_object"),i};let t=s.getExtension;s.getExtension=function(i){let o=t.call(this,i);return o||(i!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new La(this)),this.__OESVertexArrayObject))}}var ZE="OES_element_index",$E="WEBGL_draw_buffers",WL="EXT_disjoint_timer_query",zL="EXT_disjoint_timer_query_webgl2",HL="EXT_texture_filter_anisotropic",eC="WEBGL_debug_renderer_info",jL=35723,qL=4352,XL=36795,YL=34047,KL=37445,QL=37446,lt=s=>me(s)?void 0:0,JL={[3074]:s=>me(s)?void 0:36064,[jL]:s=>me(s)?void 0:qL,[35977]:lt,[32937]:lt,[XL]:(s,e)=>{let t=me(s)?s.getExtension(zL):s.getExtension(WL);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[KL]:(s,e)=>{let t=s.getExtension(eC);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[QL]:(s,e)=>{let t=s.getExtension(eC);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[YL]:(s,e)=>{let t=s.luma.extensions[HL];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:lt,[35071]:lt,[37447]:lt,[36063]:(s,e)=>{if(!me(s)){let t=s.getExtension($E);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:lt,[35374]:lt,[35377]:lt,[34852]:s=>{if(!me(s)){let e=s.getExtension($E);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(ZE)?2147483647:65535,[33001]:s=>s.getExtension(ZE)?16777216:65535,[33e3]:s=>16777216,[37157]:lt,[35373]:lt,[35657]:lt,[36183]:lt,[37137]:lt,[34045]:lt,[35978]:lt,[35979]:lt,[35968]:lt,[35376]:lt,[35375]:lt,[35659]:lt,[37154]:lt,[35371]:lt,[35658]:lt,[35076]:lt,[35077]:lt,[35380]:lt};function tC(s,e,t){let n=JL[t],i=typeof n=="function"?n(s,e,t):n;return i!==void 0?i:e(t)}var ZL="OES_vertex_array_object",rC="ANGLE_instanced_arrays",$L="WEBGL_draw_buffers",eO="EXT_disjoint_timer_query",tO="EXT_texture_filter_anisotropic",rO="VertexArray requires WebGL2 or OES_vertex_array_object extension";function nO(s,e){return{webgl2:me(s),ext:s.getExtension(e)}}var Xb={[ZL]:{meta:{suffix:"OES"},createVertexArray:()=>{Ht(!1,rO)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[rC]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){Ht(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[$L]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Ht(!1)}},[eO]:{meta:{suffix:"EXT"},createQuery:()=>{Ht(!1)},deleteQuery:()=>{Ht(!1)},beginQuery:()=>{Ht(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},af={readBuffer:(s,e,t)=>{me(s)&&e(t)},getVertexAttrib:(s,e,t,n)=>{let{webgl2:i,ext:o}=nO(s,rC),a;switch(n){case 35069:a=i?void 0:!1;break;case 35070:a=!i&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,n)},getProgramParameter:(s,e,t,n)=>{if(!me(s))switch(n){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,n)},getInternalformatParameter:(s,e,t,n,i)=>{if(!me(s))switch(i){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,n,i)},getTexParameter(s,e,t,n){switch(n){case 34046:let{extensions:i}=s.luma,o=i[tO];n=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,n)},getParameter:tC,hint(s,e,t,n){return e(t,n)}};function nC(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(JE(s),iO(s),sO(s,Xb),oO(s,{target:e,target2:s}),e.polyfilled=!0),s}globalThis.polyfillContext=nC;function iO(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function oO(s,e){let{target:t,target2:n}=e;Object.keys(af).forEach(i=>{if(typeof af[i]=="function"){let o=s[i]?s[i].bind(s):()=>{},a=af[i].bind(null,s,o);t[i]=a,n[i]=a}})}function sO(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&aO(s,{extension:t,target:s.luma,target2:s})}function aO(s,e){let{extension:t,target:n,target2:i}=e,o=Xb[t];Ht(o);let{meta:a={}}=o,{suffix:l=""}=a,u=s.getExtension(t);for(let c of Object.keys(o)){let h="".concat(c).concat(l),d=null;c==="meta"||typeof s[c]=="function"||(u&&typeof u[h]=="function"?d=function(){return u[h](...arguments)}:typeof o[c]=="function"&&(d=o[c].bind(n))),d&&(n[c]=d,i[c]=d)}}var lf={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Es=(s,e,t)=>e?s.enable(t):s.disable(t),iC=(s,e,t)=>s.hint(t,e),vn=(s,e,t)=>s.pixelStorei(t,e),lO=(s,e)=>{let t=me(s)?36009:36160;return s.bindFramebuffer(t,e)},uO=(s,e)=>s.bindFramebuffer(36008,e);function Ic(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var oC={[3042]:Es,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:Es,[2885]:(s,e)=>s.cullFace(e),[2929]:Es,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:Es,[35723]:iC,[36006]:lO,[2886]:(s,e)=>s.frontFace(e),[33170]:iC,[2849]:(s,e)=>s.lineWidth(e),[32823]:Es,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Es,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Es,[3088]:(s,e)=>s.scissor(...e),[2960]:Es,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:vn,[3317]:vn,[37440]:vn,[37441]:vn,[37443]:vn,[3330]:vn,[3332]:vn,[3331]:vn,[36010]:uO,[3314]:vn,[32878]:vn,[3316]:vn,[3315]:vn,[32877]:vn,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=Ic(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=Ic(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=Ic(e)?e:[e,e];let[t,n]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,n)},stencilFunc:(s,e)=>{e=Ic(e)&&e.length===3?[...e,...e]:e;let[t,n,i,o,a,l]=e;s.stencilFuncSeparate(1028,t,n,i),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=Ic(e)&&e.length===3?[...e,...e]:e;let[t,n,i,o,a,l]=e;s.stencilOpSeparate(1028,t,n,i),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function Tt(s,e,t){return e[s]!==void 0?e[s]:t[s]}var sC={blendEquation:(s,e,t)=>s.blendEquationSeparate(Tt(32777,e,t),Tt(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(Tt(32969,e,t),Tt(32968,e,t),Tt(32971,e,t),Tt(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(Tt(32824,e,t),Tt(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(Tt(32938,e,t),Tt(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,Tt(2962,e,t),Tt(2967,e,t),Tt(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,Tt(34816,e,t),Tt(36003,e,t),Tt(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,Tt(2964,e,t),Tt(2965,e,t),Tt(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,Tt(34817,e,t),Tt(34818,e,t),Tt(34819,e,t))},Yb={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,n,i)=>s({[32773]:new Float32Array([e,t,n,i])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,n,i)=>s({[32969]:e,[32968]:t,[32971]:n,[32970]:i}),clearColor:(s,e,t,n,i)=>s({[3106]:new Float32Array([e,t,n,i])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,n,i)=>s({[3107]:[e,t,n,i]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,n,i)=>s({[3088]:new Int32Array([e,t,n,i])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,n)=>s({[2962]:e,[2967]:t,[2963]:n,[34816]:e,[36003]:t,[36004]:n}),stencilFuncSeparate:(s,e,t,n,i)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:n,[e===1028?2963:36004]:i}),stencilOp:(s,e,t,n)=>s({[2964]:e,[2965]:t,[2966]:n,[34817]:e,[34818]:t,[34819]:n}),stencilOpSeparate:(s,e,t,n,i)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:n,[e===1028?2966:34819]:i}),viewport:(s,e,t,n,i)=>s({[2978]:[e,t,n,i]})},zi=(s,e)=>s.isEnabled(e),Kb={[3042]:zi,[2884]:zi,[2929]:zi,[3024]:zi,[32823]:zi,[32926]:zi,[32928]:zi,[3089]:zi,[2960]:zi,[35977]:zi};function Qb(s){for(let e in s)return!1;return!0}function aC(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),n=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&n&&s.length===e.length){for(let i=0;i<s.length;++i)if(s[i]!==e[i])return!1;return!0}return!1}function lC(s,e){let t=s[e].bind(s);s[e]=function(){let i=arguments.length<=0?void 0:arguments[0];return i in s.state.cache?s.state.enable?s.state.cache[i]:t(...arguments):t(...arguments)},Object.defineProperty(s[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function cO(s,e,t){let n=s[e].bind(s);s[e]=function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];let{valueChanged:u,oldValue:c}=t(s.state._updateCache,...a);return u&&n(...a),c},Object.defineProperty(s[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}function hO(s){let e=s.useProgram.bind(s);s.useProgram=function(n){s.state.program!==n&&(e(n),s.state.program=n)}}var uC=class{constructor(e){let{copyState:t=!1,log:n=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?cf(e):Object.assign({},lf),this.log=n,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.stateStack.push({})}pop(){Ht(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];Oa(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,n,i=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){Ht(o!==void 0);let a=e[o],l=this.cache[o];aC(a,l)||(t=!0,n=l,i&&!(o in i)&&(i[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:n}}};function Jb(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{enable:t=!0,copyState:n}=e;if(Ht(n!==void 0),!s.state){let{polyfillContext:i}=globalThis;i&&i(s),s.state=new uC(s,{copyState:n}),hO(s);for(let o in Yb){let a=Yb[o];cO(s,o,a)}lC(s,"getParameter"),lC(s,"isEnabled")}return s.state.enable=t,s}function Zb(s){s.state||Jb(s,{copyState:!1}),s.state.push()}function uf(s){Ht(s.state),s.state.pop()}function Oa(s,e){if(Ht(wa(s),"setParameters requires a WebGL context"),Qb(e))return;let t={};for(let i in e){let o=Number(i),a=oC[i];a&&(typeof a=="string"?t[a]=!0:a(s,e[i],o))}let n=s.state&&s.state.cache;if(n)for(let i in t)sC[i](s,e,n)}function cf(s,e){if(e=e||lf,typeof e=="number"){let i=e,o=Kb[i];return o?o(s,i):s.getParameter(i)}let t=Array.isArray(e)?e:Object.keys(e),n={};for(let i of t){let o=Kb[i];n[i]=o?o(s,Number(i)):s.getParameter(Number(i))}return n}function Ar(s,e,t){if(Qb(e))return t(s);let{nocatch:n=!0}=e;Zb(s),Oa(s,e);let i;if(n)i=t(s),uf(s);else try{i=t(s)}finally{uf(s)}return i}var kue=Cr();var wc="8.5.16",bO="set luma.log.level=1 (or higher) to trace rendering",hf=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new Bl({id:e})),this.stats.get(e)}},Ra=new hf;if(globalThis.luma&&globalThis.luma.VERSION!==wc)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(wc));globalThis.luma||(Cr()&&oe.log(1,"luma.gl ".concat(wc," - ").concat(bO))(),globalThis.luma=globalThis.luma||{VERSION:wc,version:wc,log:oe,stats:Ra,globals:{modules:{},nodeIO:{}}});var tce=globalThis.luma;function Y(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function df(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let n=s[e];return Y(n!==void 0,"Accessing undefined constant GL.".concat(e)),n}function Un(s,e){e=Number(e);for(let t in s)if(s[t]===e)return"GL.".concat(t);return String(e)}var $b={};function rn(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";$b[s]=$b[s]||1;let e=$b[s]++;return"".concat(s,"-").concat(e)}function eP(s){return Y(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function Hi(s){let e=!0;for(let t in s){e=!1;break}return e}function ff(s,e,t,n){let i="See luma.gl ".concat(t," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),o=Object.getPrototypeOf(s);n.forEach(a=>{o.methodName||(o[a]=()=>{throw oe.removed("Calling removed method ".concat(e,".").concat(a,": "),i)(),new Error(a)})})}var _l="Resource subclass must define virtual methods",hr=class{get[Symbol.toStringTag](){return"Resource"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Lo(e);let{id:n,userData:i={}}=t;this.gl=e,this.gl2=e,this.id=n||rn(this[Symbol.toStringTag]),this.userData=i,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._initStats(),this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(n=>n.delete()),this}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e=df(this.gl,e),Y(e);let i=(this.constructor.PARAMETERS||{})[e];if(i){let o=me(this.gl);if(!((!("webgl2"in i)||o)&&(!("extension"in i)||this.gl.getExtension(i.extension)))){let l=i.webgl1,u="webgl2"in i?i.webgl2:i.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{parameters:t,keys:n}=e,i=this.constructor.PARAMETERS||{},o=me(this.gl),a={},l=t||Object.keys(i);for(let u of l){let c=i[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=n?Un(this.gl,u):u;a[d]=this.getParameter(u,e),n&&c.type==="GLenum"&&(a[d]=Un(this.gl,a[d]))}}return a}setParameter(e,t){e=df(this.gl,e),Y(e);let i=(this.constructor.PARAMETERS||{})[e];if(i){let o=me(this.gl);if(!((!("webgl2"in i)||o)&&(!("extension"in i)||this.gl.getExtension(i.extension))))throw new Error("Parameter not available on this platform");i.type==="GLenum"&&(t=df(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,n){return ff(this,e,t,n)}initialize(e){}_createHandle(){throw new Error(_l)}_deleteHandle(){throw new Error(_l)}_bindHandle(e){throw new Error(_l)}_getOptsFromHandle(){throw new Error(_l)}_getParameter(e,t){throw new Error(_l)}_setParameter(e,t){throw new Error(_l)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_initStats(){this.gl.stats=this.gl.stats||new hf}_addStats(){let e=this[Symbol.toStringTag],t=Ra.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get("".concat(e,"s Created")).incrementCount(),t.get("".concat(e,"s Active")).incrementCount()}_removeStats(){let e=this[Symbol.toStringTag];Ra.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._doTrackAllocatedMemory(e,t),this._doTrackAllocatedMemory(e,t,this.gl.stats.get("Memory Usage"))}_doTrackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ra.get("Memory Usage");n.get("GPU Memory").addCount(e),n.get("".concat(t," Memory")).addCount(e),this.byteLength=e}_trackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._doTrackDeallocatedMemory(e),this._doTrackDeallocatedMemory(e,this.gl.stats.get("Memory Usage"))}_doTrackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ra.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get("".concat(e," Memory")).subtractCount(this.byteLength),this.byteLength=0}};var PO="Failed to deduce GL constant from typed array";function Lc(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(PO)}}function Cs(s){let{clamped:e=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function cC(s){let{data:e,width:t,height:n,bytesPerPixel:i=4,temp:o}=s,a=t*i;o=o||new Uint8Array(a);for(let l=0;l<n/2;++l){let u=l*a,c=(n-l-1)*a;o.set(e.subarray(u,u+a)),e.copyWithin(u,c,c+a),e.set(o,c)}}function hC(s){let{data:e,width:t,height:n}=s,i=Math.round(t/2),o=Math.round(n/2),a=new Uint8Array(i*o*4);for(let l=0;l<o;l++)for(let u=0;u<i;u++)for(let c=0;c<4;c++)a[(l*i+u)*4+c]=e[(l*2*t+u*2)*4+c];return{data:a,width:i,height:o}}function Oc(s,e,t){let{removedProps:n={},deprecatedProps:i={},replacedProps:o={}}=t;for(let l in n)if(l in e){let c=n[l]?"".concat(s,".").concat(n[l]):"N/A";oe.removed("".concat(s,".").concat(l),c)()}for(let l in i)if(l in e){let u=i[l];oe.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))()}let a=null;for(let l in o)if(l in e){let u=o[l];oe.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var yO={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},SO={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},dr=class{static getBytesPerElement(e){return Cs(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return Y(e.size),Cs(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new dr(...[yO,...t])}constructor(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach(i=>this._assign(i)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return dr.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return dr.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e=Oc("Accessor",e,SO),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var dC=10,fC={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},EO={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:fC},CO={removedProps:fC},ve=class extends hr{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/dr.getBytesPerElement(e))}getVertexCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/dr.getBytesPerVertex(e))}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Oc("Buffer",e,EO),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Oc("Buffer",e,CO),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new dr(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:n=0,srcOffset:i=0}=e,o=e.byteLength||e.length;Y(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),i!==0||o!==void 0?(gt(this.gl),this.gl.bufferSubData(this.target,n,t,i,o)):this.gl.bufferSubData(a,n,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData(e){let{sourceBuffer:t,readOffset:n=0,writeOffset:i=0,size:o}=e,{gl:a}=this;return gt(a),a.bindBuffer(36662,t.handle),a.bindBuffer(36663,this.handle),a.copyBufferSubData(36662,36663,n,i,o),a.bindBuffer(36662,null),a.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:t=0,dstOffset:n=0,length:i=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};gt(this.gl);let o=Cs(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=n,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,i||a),c=l+u);let h=Math.min(a,u);return i=i||h,Y(i<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,n,i),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:n=0,size:i}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?i!==void 0?this.gl.bindBufferRange(e,t,this.handle,n,i):(Y(n===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(dC,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e.byteLength+t;Y(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let i=this._getTarget();this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,this.usage),this.gl.bufferSubData(i,t,e),this.gl.bindBuffer(i,null),this.debugData=e.slice(0,dC),this.bytesUsed=n,this._trackAllocatedMemory(n);let o=Lc(e);return Y(o),this.setAccessor(new dr(this.accessor,{type:o})),this}_setByteLength(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;Y(e>=0),this._trackDeallocatedMemory();let n=e;e===0&&(n=new Float32Array(0));let i=this._getTarget();return this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,t),this.gl.bindBuffer(i,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=Cs(this.accessor.type||5126,{clamped:!1}),n=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-n}_inferType(e){this.accessor.type||this.setAccessor(new dr(this.accessor,{type:Lc(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return oe.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return oe.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return oe.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return oe.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new dr(this.accessor,e),this}};var gf={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},mf={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},pf={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function gC(s,e){let t=gf[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let n=me(s)&&t.gl2||t.gl1;return typeof n=="string"?s.getExtension(n):n}function mC(s,e){let t=gf[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var xO=[9729,9728],pC=globalThis.WebGLBuffer||function(){},nn=class extends hr{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{format:n,linearFiltering:i}=t,o=!0;return n&&(o=o&&gC(e,n),o=o&&(!i||mC(e,n))),o}constructor(e,t){let{id:n=rn("texture"),handle:i,target:o}=t;super(e,{id:n,handle:i});this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data;if(t instanceof Promise)return t.then(D=>this.initialize(Object.assign({},e,{pixels:D,data:D}))),this;let n=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(n&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:i=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=i);let{width:d,height:m,dataFormat:P,type:S,compressed:v=!1,mipmaps:I=!0}=e,{depth:L=0}=e;return{width:d,height:m,compressed:v,dataFormat:P,type:S}=this._deduceParameters({format:o,type:S,dataFormat:P,compressed:v,data:t,width:d,height:m}),this.width=d,this.height=m,this.depth=L,this.format=o,this.type=S,this.dataFormat=P,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),I&&this._isNPOT()&&(oe.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),I=!1,this._updateForNPOT(u)),this.mipmaps=I,this.setImageData({data:t,width:d,height:m,depth:L,format:o,type:S,dataFormat:P,border:a,mipmaps:I,parameters:c,compressed:v}),I&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),n&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:n}=this._video;if(n===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:t,width:n,mipmaps:i=!1}=e;return n!==this.width||t!==this.height?this.initialize({width:n,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(oe.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Ar(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:n=null,level:i=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:m=this.height,dataFormat:P=this.dataFormat,compressed:S=!1}=e;c||(c=n),{type:h,dataFormat:P,compressed:S,width:d,height:m}=this._deduceParameters({format:o,type:h,dataFormat:P,compressed:S,data:c,width:d,height:m});let{gl:v}=this;v.bindTexture(this.target,this.handle);let I=null;({data:c,dataType:I}=this._getDataType({data:c,compressed:S}));let L,D=0;if(Ar(this.gl,u,()=>{switch(I){case"null":v.texImage2D(t,i,o,d,m,a,P,h,c);break;case"typed-array":v.texImage2D(t,i,o,d,m,a,P,h,c,l);break;case"buffer":L=gt(v),L.bindBuffer(35052,c.handle||c),L.texImage2D(t,i,o,d,m,a,P,h,l),L.bindBuffer(35052,null);break;case"browser-object":me(v)?v.texImage2D(t,i,o,d,m,a,P,h,c):v.texImage2D(t,i,o,P,h,c);break;case"compressed":for(let[w,M]of c.entries())v.compressedTexImage2D(t,w,M.format,M.width,M.height,a,M.data),D+=M.levelSize;break;default:Y(!1,"Unknown image data type")}}),I==="compressed")this._trackAllocatedMemory(D,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let w=mf[this.dataFormat]||4,M=pf[this.type]||1;this._trackAllocatedMemory(this.width*this.height*w*M,"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:t=this.target,pixels:n=null,data:i=null,x:o=0,y:a=0,width:l=this.width,height:u=this.height,level:c=0,format:h=this.format,type:d=this.type,dataFormat:m=this.dataFormat,compressed:P=!1,offset:S=0,border:v=this.border,parameters:I={}}=e;if({type:d,dataFormat:m,compressed:P,width:l,height:u}=this._deduceParameters({format:h,type:d,dataFormat:m,compressed:P,data:i,width:l,height:u}),Y(this.depth===0,"texSubImage not supported for 3D textures"),i||(i=n),i&&i.data){let L=i;i=L.data,l=L.shape[0],u=L.shape[1]}i instanceof ve&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),Ar(this.gl,I,()=>{if(P)this.gl.compressedTexSubImage2D(t,c,o,a,l,u,h,i);else if(i===null)this.gl.texSubImage2D(t,c,o,a,l,u,m,d,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(t,c,o,a,l,u,m,d,i,S);else if(i instanceof pC){let L=gt(this.gl);L.bindBuffer(35052,i),L.texSubImage2D(t,c,o,a,l,u,m,d,S),L.bindBuffer(35052,null)}else me(this.gl)?gt(this.gl).texSubImage2D(t,c,o,a,l,u,m,d,i):this.gl.texSubImage2D(t,c,o,a,m,d,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType(e){let{data:t,compressed:n=!1}=e;return n?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof ve?{data:t.handle,dataType:"buffer"}:t instanceof pC?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:n}=e,{width:i,height:o,dataFormat:a,type:l,compressed:u}=e,c=gf[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:i,height:o}=this._deduceImageSize(n,i,o),{dataFormat:a,type:l,compressed:u,width:i,height:o,format:t,data:n}}_deduceImageSize(e,t,n){let i;return typeof ImageData<"u"&&e instanceof ImageData?i={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?i={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?i={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?i={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?i={width:e.videoWidth,height:e.videoHeight}:e?i={width:t,height:n}:i={width:t>=0?t:1,height:n>=0?n:1},Y(i,"Could not deduced texture size"),Y(t===void 0||i.width===t,"Deduced texture width does not match supplied width"),Y(n===void 0||i.height===n,"Deduced texture height does not match supplied height"),i}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:Y(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return me(this.gl)||!this.width||!this.height?!1:!eP(this.width)||!eP(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:xO.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var AO="";function bC(s,e){return Y(typeof s=="string"),s=AO+s,new Promise((t,n)=>{try{let i=new Image;i.onload=()=>t(i),i.onerror=()=>n(new Error("Could not load image ".concat(s,"."))),i.crossOrigin=e&&e.crossOrigin||"anonymous",i.src=s}catch(i){n(i)}})}var Dt=class extends nn{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return nn.isSupported(e,t)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Lo(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:bC(t.data)}));super(e,Object.assign({},t,{target:3553}));this.initialize(t),Object.seal(this)}};var tP=[34069,34070,34071,34072,34073,34074],Vl=class extends nn{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Lo(e);super(e,Object.assign({},t,{target:34067}));this.initialize(t),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{mipmaps:t=!0,parameters:n={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(n)}),this}subImage(e){let{face:t,data:n,x:i=0,y:o=0,mipmapLevel:a=0}=e;return this._subImage({target:t,data:n,x:i,y:o,mipmapLevel:a})}async setCubeMapImageData(e){let{width:t,height:n,pixels:i,data:o,border:a=0,format:l=6408,type:u=5121}=e,{gl:c}=this,h=i||o,d=await Promise.all(tP.map(m=>{let P=h[m];return Promise.all(Array.isArray(P)?P:[P])}));this.bind(),tP.forEach((m,P)=>{d[P].length>1&&this.opts.mipmaps!==!1&&oe.warn("".concat(this.id," has mipmap and multiple LODs."))(),d[P].forEach((S,v)=>{t&&n?c.texImage2D(m,v,l,t,n,a,l,u,S):c.texImage2D(m,v,l,l,u,S)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:n,height:i,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(m=>this.setImageDataForFace(Object.assign({},e,{face:t,data:m,pixels:m}))):this.width||this.height?h.texImage2D(t,0,u,n,i,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};Vl.FACES=tP;var Rc=class extends nn{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return me(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};gt(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1});super(e,t);this.initialize(t),Object.seal(this)}setImageData(e){let{level:t=0,dataFormat:n=6408,width:i,height:o,depth:a=1,border:l=0,format:u,type:c=5121,offset:h=0,data:d,parameters:m={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),Ar(this.gl,m,()=>{ArrayBuffer.isView(d)&&this.gl.texImage3D(this.target,t,n,i,o,a,l,u,c,d),d instanceof ve&&(this.gl.bindBuffer(35052,d.handle),this.gl.texImage3D(this.target,t,n,i,o,a,l,u,c,h))}),d&&d.byteLength)this._trackAllocatedMemory(d.byteLength,"Texture");else{let P=mf[this.dataFormat]||4,S=pf[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*P*S,"Texture")}return this.loaded=!0,this}};var Ba="EXT_color_buffer_float",rP={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Ba,bpp:2},[33327]:{gl2:Ba,bpp:4},[34842]:{gl2:Ba,bpp:8},[33326]:{gl2:Ba,bpp:4},[33328]:{gl2:Ba,bpp:8},[34836]:{gl2:Ba,bpp:16},[35898]:{gl2:Ba,bpp:4}};function vO(s,e,t){let n=t[e];if(!n)return!1;let i=me(s)&&n.gl2||n.gl1;return typeof i=="string"?s.getExtension(i):i}var ji=class extends hr{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!t||vO(e,t,rP)}static getSamplesForFormat(e,t){let{format:n}=t;return e.getInternalformatParameter(36161,n,32937)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.initialize(t),Object.seal(this)}initialize(e){let{format:t,width:n=1,height:i=1,samples:o=0}=e;return Y(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),o!==0&&me(this.gl)?this.gl.renderbufferStorageMultisample(36161,o,t,n,i):this.gl.renderbufferStorage(36161,t,n,i),this.format=t,this.width=n,this.height=i,this.samples=o,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*rP[this.format].bpp),this}resize(e){let{width:t,height:n}=e;return t!==this.width||n!==this.height?this.initialize({width:t,height:n,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var TO=256,IO=1024,wO=16384,PC=6144,yC=6145,SC=6146,EC=34041,CC="clear: bad arguments";function kl(s){let{framebuffer:e=null,color:t=null,depth:n=null,stencil:i=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o={};e&&(o.framebuffer=e);let a=0;t&&(a|=wO,t!==!0&&(o.clearColor=t)),n&&(a|=TO,n!==!0&&(o.clearDepth=n)),i&&(a|=IO,n!==!0&&(o.clearStencil=n)),Y(a!==0,CC),Ar(s,o,()=>{s.clear(a)})}function nP(s){let{framebuffer:e=null,buffer:t=PC,drawBuffer:n=0,value:i=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};gt(s),Ar(s,{framebuffer:e},()=>{switch(t){case PC:switch(i.constructor){case Int32Array:s.clearBufferiv(t,n,i);break;case Uint32Array:s.clearBufferuiv(t,n,i);break;case Float32Array:default:s.clearBufferfv(t,n,i)}break;case yC:s.clearBufferfv(yC,0,[i]);break;case SC:s.clearBufferiv(SC,0,[i]);break;case EC:let[o,a]=i;s.clearBufferfi(EC,0,o,a);break;default:Y(!1,CC)}})}function xC(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return Y(!1),0}}function Na(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{sourceX:t=0,sourceY:n=0,sourceFormat:i=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=AC(s);Y(h);let{gl:m,handle:P,attachments:S}=h;l=l||h.width,u=u||h.height,o===36064&&P===null&&(o=1028),Y(S[o]),c=c||S[o].type,a=LO(a,c,i,l,u),c=c||Lc(a);let v=m.bindFramebuffer(36160,P);return m.readPixels(t,n,l,u,i,c,a),m.bindFramebuffer(36160,v||null),d&&h.delete(),a}function bf(s){let{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=Na(s,{sourceAttachment:e}),{width:i,height:o}=s;for(;o>t;)({data:n,width:i,height:o}=hC({data:n,width:i,height:o}));cC({data:n,width:i,height:o});let a=document.createElement("canvas");a.width=i,a.height=o;let l=a.getContext("2d"),u=l.createImageData(i,o);return u.data.set(n),l.putImageData(u,0,0),a.toDataURL()}function Pf(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{sourceX:n=0,sourceY:i=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:m,deleteFramebuffer:P}=AC(s);Y(m);let{gl:S,handle:v}=m,I=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let L=S.bindFramebuffer(36160,v);Y(e);let D=null;if(e instanceof nn&&(D=e,h=Number.isFinite(h)?h:D.width,d=Number.isFinite(d)?d:D.height,D.bind(0),e=D.target),!I)S.copyTexImage2D(e,o,a,n,i,h,d,0);else switch(e){case 3553:case 34067:S.copyTexSubImage2D(e,o,l,u,n,i,h,d);break;case 35866:case 32879:gt(S).copyTexSubImage3D(e,o,l,u,c,n,i,h,d);break;default:}return D&&D.unbind(),S.bindFramebuffer(36160,L||null),P&&m.delete(),D}function AC(s){return s instanceof It?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:vC(s),deleteFramebuffer:!0}}function LO(s,e,t,n,i){if(s)return s;e=e||5121;let o=Cs(e,{clamped:!1}),a=xC(t);return new o(n*i*a)}var ut={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function OO(s){let e=new Dt(s,{format:6408,type:5126,dataFormat:6408}),t=new It(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),n=t.getStatus();return e.delete(),t.delete(),n===36053}var iP={[ut.WEBGL2]:[!1,!0],[ut.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[ut.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[ut.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[ut.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[ut.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[ut.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[ut.FLOAT_BLEND]:["EXT_float_blend"],[ut.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[ut.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[ut.TEXTURE_FLOAT]:["OES_texture_float",!0],[ut.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[ut.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[ut.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[ut.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[ut.COLOR_ATTACHMENT_RGBA32F]:[OO,"EXT_color_buffer_float"],[ut.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[ut.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[ut.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[ut.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[ut.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[ut.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var RO=2;function Bc(s,e){return yf(s,e)}function yf(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>TC(s,t))}function Sf(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in iP)s.luma.caps[e]===void 0&&(s.luma.caps[e]=TC(s,e));return s.luma.caps}function TC(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=BO(s,e)),s.luma.caps[e]||oe.log(RO,"Feature: ".concat(e," not supported"))(),s.luma.caps[e]}function BO(s,e){let t=iP[e];Y(t,e);let n,i=me(s)&&t[1]||t[0];if(typeof i=="function")n=i(s);else if(Array.isArray(i)){n=!0;for(let o of i)n=n&&Boolean(s.getExtension(o))}else typeof i=="string"?n=Boolean(s.getExtension(i)):typeof i=="boolean"?n=i:Y(!1);return n}var IC="Multiple render targets not supported",It=class extends hr{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{colorBufferFloat:n,colorBufferHalfFloat:i}=t,o=!0;return n&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),i&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new It(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=gt(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=gt(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:t=1,height:n=1,attachments:i=null,color:o=!0,depth:a=!0,stencil:l=!1,check:u=!0,readBuffer:c=void 0,drawBuffers:h=void 0}=e;if(Y(t>=0&&n>=0,"Width and height need to be integers"),this.width=t,this.height=n,i)for(let d in i){let m=i[d];(Array.isArray(m)?m[0]:m).resize({width:t,height:n})}else i=this._createDefaultAttachments(o,a,l,t,n);this.update({clearAttachments:!0,attachments:i,readBuffer:c,drawBuffers:h}),i&&u&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:t={},readBuffer:n,drawBuffers:i,clearAttachments:o=!1,resizeAttachments:a=!0}=e;this.attach(t,{clearAttachments:o,resizeAttachments:a});let{gl:l}=this,u=l.bindFramebuffer(36160,this.handle);return n&&this._setReadBuffer(n),i&&this._setDrawBuffers(i),l.bindFramebuffer(36160,u||null),this}resize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:t,height:n}=e;if(this.handle===null)return Y(t===void 0&&n===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),n===void 0&&(n=this.gl.drawingBufferHeight),t!==this.width&&n!==this.height&&oe.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(t,"x").concat(n))();for(let i in this.attachments)this.attachments[i].resize({width:t,height:n});return this.width=t,this.height=n,this}attach(e){let{clearAttachments:t=!1,resizeAttachments:n=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i={};t&&Object.keys(this.attachments).forEach(a=>{i[a]=null}),Object.assign(i,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in i){Y(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=i[l],c=u;if(!c)this._unattach(l);else if(c instanceof ji)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,m=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:m})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});n&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(GO(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),n=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),n}clear(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{color:t,depth:n,stencil:i,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||n||i)&&kl(this.gl,{color:t,depth:n,stencil:i}),o.forEach((l,u)=>{nP(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(e){let{attachments:t=[],x:n=0,y:i=0,width:o,height:a}=e,l=gt(this.gl),u=l.bindFramebuffer(36008,this.handle);return n===0&&i===0&&o===void 0&&a===void 0?l.invalidateFramebuffer(36008,t):l.invalidateFramebuffer(36008,t,n,i,o,a),l.bindFramebuffer(36008,u),this}getAttachmentParameter(e,t,n){let i=this._getAttachmentParameterFallback(t);return i===null&&(this.gl.bindFramebuffer(36160,this.handle),i=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),n&&i>1e3&&(i=Un(this.gl,i)),i}getAttachmentParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[],i={};for(let o of n){let a=t?Un(this.gl,o):o;i[a]=this.getAttachmentParameter(e,o,t)}return i}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=Object.keys(this.attachments),n={};for(let i of t){let o=Number(i),a=e?Un(this.gl,o):o;n[a]=this.getAttachmentParameters(o,e)}return n}show(){return typeof window<"u"&&window.open(bf(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(e>oe.level||typeof window>"u")return this;t=t||"Framebuffer ".concat(this.id);let n=bf(this,{targetMaxHeight:100});return oe.image({logLevel:e,message:t,image:n},t)(),this}bind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,n,i,o){let a=null;return e&&(a=a||{},a[36064]=new Dt(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:i,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&n?(a=a||{},a[33306]=new ji(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:i,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new ji(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:i,height:o}),this.ownResources.push(a[36096])):n&&Y(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof ji?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:t=36064,renderbuffer:n}=e,{gl:i}=this;i.framebufferRenderbuffer(36160,t,36161,n.handle),this.attachments[t]=n}_attachTexture(e){let{attachment:t=36064,texture:n,layer:i,level:o}=e,{gl:a}=this;switch(a.bindTexture(n.target,n.handle),n.target){case 35866:case 32879:gt(a).framebufferTextureLayer(36160,t,n.target,o,i);break;case 34067:let u=NO(i);a.framebufferTexture2D(36160,t,u,n.handle,o);break;case 3553:a.framebufferTexture2D(36160,t,3553,n.handle,o);break;default:Y(!1,"Illegal texture type")}a.bindTexture(n.target,null),this.attachments[t]=n}_setReadBuffer(e){let t=qb(this.gl);t?t.readBuffer(e):Y(e===36064||e===1029,IC),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,n=gt(t);if(n)n.drawBuffers(e);else{let i=t.getExtension("WEBGL_draw_buffers");i?i.drawBuffersWEBGL(e):Y(e.length===1&&(e[0]===36064||e[0]===1029),IC)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=Sf(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function NO(s){return s<34069?s+34069:s}function GO(s){return(It.STATUS||{})[s]||"Framebuffer error ".concat(s)}var MO=[36049,36048,33296,33298,33299,33300,33301,33302,33303];It.ATTACHMENT_PARAMETERS=MO;function Ef(s,e){Y(s instanceof Dt||s instanceof Vl||s instanceof Rc);let t=s.constructor,{gl:n,width:i,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:i,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(n,d)}function vC(s,e){let{gl:t,width:n,height:i,id:o}=s;return new It(t,Object.assign({},e,{id:"framebuffer-for-".concat(o),width:n,height:i,attachments:{[36064]:s}}))}function xs(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed",t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,n=s.match(t);return n?n[1]:e}function oP(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function sP(s,e,t,n){let i=s.split(/\r?\n/),o={},a={},l=n||xs(e)||"(unnamed)",u="".concat(oP(t)," shader ").concat(l);for(let h=0;h<i.length;h++){let d=i[h];if(d.length<=1)continue;let m=d.split(":"),P=m[0],S=parseInt(m[2],10);if(isNaN(S))throw new Error("GLSL compilation error in ".concat(u,": ").concat(s));P!=="WARNING"?o[S]=d:a[S]=d}let c=DO(e);return{shaderName:u,errors:wC(o,c),warnings:wC(a,c)}}function wC(s,e){let t="";for(let n=0;n<e.length;n++){let i=e[n];if(!(!s[n+3]&&!s[n+2]&&!s[n+1])&&(t+="".concat(i,`
`),s[n+1])){let o=s[n+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=LC("^^^ ".concat(l,": ").concat(c,`

`),u)}}return t}function DO(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ",n=s.split(/\r?\n/),i=String(n.length+e-1).length;return n.map((o,a)=>{let l=String(a+e),u=l.length;return LC(l,i-u)+t+o})}function LC(s,e){let t="";for(let n=0;n<e;++n)t+=" ";return"".concat(t).concat(s)}function Ul(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let n=parseInt(t[1],10);Number.isFinite(n)&&(e=n)}return e}var FO="Shader: GLSL source code must be a JavaScript string",Wl=class extends hr{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return Y(!1),"unknown"}}constructor(e,t){Lo(e),Y(typeof t.source=="string",FO);let n=xs(t.source,null)||t.id||rn("unnamed ".concat(Wl.getTypeName(t.shaderType)));super(e,{id:n});this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize(e){let{source:t}=e,n=xs(t,null);n&&(this.id=rn(n)),this._compile(t)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(Wl.getTypeName(this.shaderType),":").concat(this.id)}getName(){return xs(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(e.startsWith("#version ")||(e=`#version 100
`.concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let n=this.gl.getShaderInfoLog(this.handle),{shaderName:i,errors:o,warnings:a}=sP(n,this.source,this.shaderType,this.id);throw oe.error("GLSL compilation errors in ".concat(i,`
`).concat(o))(),oe.warn("GLSL compilation warnings in ".concat(i,`
`).concat(a))(),new Error("GLSL compilation errors in ".concat(i))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},zl=class extends Wl{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},Hl=class extends Wl{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){typeof t=="string"&&(t={source:t});super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var _O={[5126]:mt.bind(null,"uniform1fv",Tn,1,Dr),[35664]:mt.bind(null,"uniform2fv",Tn,2,Dr),[35665]:mt.bind(null,"uniform3fv",Tn,3,Dr),[35666]:mt.bind(null,"uniform4fv",Tn,4,Dr),[5124]:mt.bind(null,"uniform1iv",As,1,Dr),[35667]:mt.bind(null,"uniform2iv",As,2,Dr),[35668]:mt.bind(null,"uniform3iv",As,3,Dr),[35669]:mt.bind(null,"uniform4iv",As,4,Dr),[35670]:mt.bind(null,"uniform1iv",As,1,Dr),[35671]:mt.bind(null,"uniform2iv",As,2,Dr),[35672]:mt.bind(null,"uniform3iv",As,3,Dr),[35673]:mt.bind(null,"uniform4iv",As,4,Dr),[35674]:mt.bind(null,"uniformMatrix2fv",Tn,4,Oo),[35675]:mt.bind(null,"uniformMatrix3fv",Tn,9,Oo),[35676]:mt.bind(null,"uniformMatrix4fv",Tn,16,Oo),[35678]:vr,[35680]:vr,[5125]:mt.bind(null,"uniform1uiv",Cf,1,Dr),[36294]:mt.bind(null,"uniform2uiv",Cf,2,Dr),[36295]:mt.bind(null,"uniform3uiv",Cf,3,Dr),[36296]:mt.bind(null,"uniform4uiv",Cf,4,Dr),[35685]:mt.bind(null,"uniformMatrix2x3fv",Tn,6,Oo),[35686]:mt.bind(null,"uniformMatrix2x4fv",Tn,8,Oo),[35687]:mt.bind(null,"uniformMatrix3x2fv",Tn,6,Oo),[35688]:mt.bind(null,"uniformMatrix3x4fv",Tn,12,Oo),[35689]:mt.bind(null,"uniformMatrix4x2fv",Tn,8,Oo),[35690]:mt.bind(null,"uniformMatrix4x3fv",Tn,12,Oo),[35678]:vr,[35680]:vr,[35679]:vr,[35682]:vr,[36289]:vr,[36292]:vr,[36293]:vr,[36298]:vr,[36299]:vr,[36300]:vr,[36303]:vr,[36306]:vr,[36307]:vr,[36308]:vr,[36311]:vr},VO={},kO={},UO={},OC=[0];function aP(s,e,t,n){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(OC[0]=s,s=OC);let i=s.length;if(i%e&&oe.warn("Uniform size should be multiples of ".concat(e),s)(),s instanceof t)return s;let o=n[i];o||(o=new t(i),n[i]=o);for(let a=0;a<i;a++)o[a]=s[a];return o}function Tn(s,e){return aP(s,e,Float32Array,VO)}function As(s,e){return aP(s,e,Int32Array,kO)}function Cf(s,e){return aP(s,e,Uint32Array,UO)}function lP(s,e,t){let n=_O[t.type];if(!n)throw new Error("Unknown GLSL uniform type ".concat(t.type));return n().bind(null,s,e)}function RC(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(s));return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function BC(s,e,t){for(let n in s){let i=s[n];if((!t||Boolean(t[n]))&&!WO(i))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(n),i),new Error("".concat(e," Bad uniform ").concat(n))}return!0}function WO(s){return Array.isArray(s)||ArrayBuffer.isView(s)?zO(s):isFinite(s)||s===!0||s===!1||s instanceof nn||s instanceof ji?!0:s instanceof It?Boolean(s.texture):!1}function NC(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let n=s[e];for(let i=0,o=t.length;i<o;++i)n[i]=t[i]}else s[e]=t.slice();else s[e]=t}function zO(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function vr(){let s=null;return(e,t,n)=>{let i=s!==n;return i&&(e.uniform1i(t,n),s=n),i}}function mt(s,e,t,n){let i=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(i===null)i=new Float32Array(h),o=h,d=!0;else{Y(o===h,"Uniform length cannot change.");for(let m=0;m<h;++m)if(c[m]!==i[m]){d=!0;break}}return d&&(n(a,s,l,c),i.set(c)),d}}function Dr(s,e,t,n){s[e](t,n)}function Oo(s,e,t,n){s[e](t,!1,n)}var HO=5120,jO=5121,qO=5122,XO=5123,GC=0,xf=1,YO=2,KO=3,Af=4,QO=5,JO=6,Jt=5126,ZO=35664,$O=35665,eR=35666,Nc=5124,tR=35667,rR=35668,nR=35669,Gc=5125,iR=36294,oR=36295,sR=36296,aR=35670,lR=35671,uR=35672,cR=35673,hR=35674,dR=35675,fR=35676,gR=35685,mR=35686,pR=35687,bR=35688,PR=35689,yR=35690,uP={[Jt]:[Jt,1,"float"],[ZO]:[Jt,2,"vec2"],[$O]:[Jt,3,"vec3"],[eR]:[Jt,4,"vec4"],[Nc]:[Nc,1,"int"],[tR]:[Nc,2,"ivec2"],[rR]:[Nc,3,"ivec3"],[nR]:[Nc,4,"ivec4"],[Gc]:[Gc,1,"uint"],[iR]:[Gc,2,"uvec2"],[oR]:[Gc,3,"uvec3"],[sR]:[Gc,4,"uvec4"],[aR]:[Jt,1,"bool"],[lR]:[Jt,2,"bvec2"],[uR]:[Jt,3,"bvec3"],[cR]:[Jt,4,"bvec4"],[hR]:[Jt,8,"mat2"],[gR]:[Jt,8,"mat2x3"],[mR]:[Jt,8,"mat2x4"],[dR]:[Jt,12,"mat3"],[pR]:[Jt,12,"mat3x2"],[bR]:[Jt,12,"mat3x4"],[fR]:[Jt,16,"mat4"],[PR]:[Jt,16,"mat4x2"],[yR]:[Jt,16,"mat4x3"]};function MC(s){switch(s){case GC:return GC;case xf:return xf;case KO:return xf;case YO:return xf;case Af:return Af;case QO:return Af;case JO:return Af;default:return Y(!1),0}}function cP(s){let e=uP[s];if(!e)return null;let[t,n]=e;return{type:t,components:n}}function vf(s,e){switch(s){case HO:case jO:case qO:case XO:s=Jt;break;default:}for(let t in uP){let[n,i,o]=uP[t];if(n===s&&i===e)return{glType:t,name:o}}return null}var Tf=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,n=t.getProgramParameter(e.handle,35721);for(let i=0;i<n;i++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,i),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((i,o)=>i.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!me(t))return;let n=t.getProgramParameter(e.handle,35971);for(let i=0;i<n;i++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,i);this._addVarying(i,o,a,l)}this.varyingInfos.sort((i,o)=>i.location-o.location)}_addAttribute(e,t,n,i){let{type:o,components:a}=cP(n),l={type:o,size:i*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new dr(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,n){/instance/i.test(t)&&(n.divisor=1)}_addVarying(e,t,n,i){let{type:o,components:a}=cP(n),l=new dr({type:o,size:i*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var DC=4,SR=35981,ER=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],vs=class extends hr{get[Symbol.toStringTag](){return"Program"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t);this.stubRemovedMethods("Program","v6.0",ER),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{hash:t,vs:n,fs:i,varyings:o,bufferMode:a=SR}=e;return this.hash=t||"",this.vs=typeof n=="string"?new zl(this.gl,{id:"".concat(e.id,"-vs"),source:n}):n,this.fs=typeof i=="string"?new Hl(this.gl,{id:"".concat(e.id,"-fs"),source:i}):i,Y(this.vs instanceof zl),Y(this.fs instanceof Hl),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(gt(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Tf(this),this.setProps(e)}delete(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:t,drawMode:n=4,vertexCount:i,offset:o=0,start:a,end:l,isIndexed:u=!1,indexType:c=5123,instanceCount:h=0,isInstanced:d=h>0,vertexArray:m=null,transformFeedback:P,framebuffer:S,parameters:v={},uniforms:I,samplers:L}=e;if((I||L)&&(oe.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(I||{})),oe.priority>=t){let D=S?S.id:"default",w="mode=".concat(Un(this.gl,n)," verts=").concat(i," ")+"instances=".concat(h," indexType=").concat(Un(this.gl,c)," ")+"isInstanced=".concat(d," isIndexed=").concat(u," ")+"Framebuffer=".concat(D);oe.log(t,w)()}return Y(m),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||i===0||d&&h===0?!1:(m.bindForDraw(i,h,()=>{if(S!==void 0&&(v=Object.assign({},v,{framebuffer:S})),P){let D=MC(n);P.begin(D)}this._bindTextures(),Ar(this.gl,v,()=>{u&&d?this.gl2.drawElementsInstanced(n,i,c,o,h):u&&me(this.gl)&&!isNaN(a)&&!isNaN(l)?this.gl2.drawRangeElements(n,a,l,i,c,o):u?this.gl.drawElements(n,i,c,o):d?this.gl2.drawArraysInstanced(n,o,i,h):this.gl.drawArrays(n,o,i)}),P&&P.end()}),!0)}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};oe.priority>=2&&BC(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let n=e[t],i=this._uniformSetters[t];if(i){let o=n,a=!1;if(o instanceof It&&(o=o.texture),o instanceof nn)if(a=this.uniforms[t]!==n,a){i.textureIndex===void 0&&(i.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=i;l.bind(u),o=u,this._textureUniforms[t]=l}else o=i.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(i(o)||a)&&NC(this.uniforms,t,n)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let n=this._textureUniforms[t];n.update(),e=e&&n.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),n={};for(let i of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:n.vs=new zl({handle:i});break;case 35632:n.fs=new Hl({handle:i});break;default:}return n}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=rn(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),oe.time(DC,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),oe.timeEnd(DC,"linkProgram for ".concat(this._getName()))(),e.debug||oe.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let n=this.gl.getActiveUniform(this.handle,t),{name:i}=RC(n.name),o=e.getUniformLocation(this.handle,i);if(this._uniformSetters[i]=lP(e,o,n),n.size>1)for(let a=0;a<n.size;a++)o=e.getUniformLocation(this.handle,"".concat(i,"[").concat(a,"]")),this._uniformSetters["".concat(i,"[").concat(a,"]")]=lP(e,o,n)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var Ts=class extends hr{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return me(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};gt(e);super(e,t);this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Hi(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let n=this._getVaryingIndex(e),{buffer:i,byteSize:o,byteOffset:a}=this._getBufferParams(t);return n<0?(this.unused[e]=i,oe.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[n]=t,this.bindOnUse||this._bindBuffer(n,i,a,o),this)}begin(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,n,i;return e instanceof ve?i=e:(i=e.buffer,n=e.byteSize,t=e.byteOffset),(t!==void 0||n!==void 0)&&(t=t||0,n=n||i.byteLength-t),{buffer:i,byteOffset:t,byteSize:n}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:n,byteOffset:i}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,i,n)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=t&&t.handle;return!o||i===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,n,i),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var If=null;function CR(s){return(!If||If.byteLength<s)&&(If=new ArrayBuffer(s)),If}function FC(s,e){let t=CR(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function _C(s){let{target:e,source:t,start:n=0,count:i=1}=s,o=t.length,a=i*o,l=0;for(let u=n;l<o;l++)e[u++]=t[l];for(;l<a;)l<a-l?(e.copyWithin(n+l,n,n+l),l*=2):(e.copyWithin(n+l,n,n+a-l),l=a);return e}var xR="elements must be GL.ELEMENT_ARRAY_BUFFER",Fr=class extends hr{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?me(e)||Zd()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new Fr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return Fr.MAX_ATTRIBUTES=Fr.MAX_ATTRIBUTES||e.getParameter(34921),Fr.MAX_ATTRIBUTES}static setConstant(e,t,n){switch(n.constructor){case Float32Array:Fr._setConstantFloatArray(e,t,n);break;case Int32Array:Fr._setConstantIntArray(e,t,n);break;case Uint32Array:Fr._setConstantUintArray(e,t,n);break;default:Y(!1)}}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:n}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return Fr.getMaxAttributes(this.gl)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(e)}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Y(!e||e.target===34963,xR),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,n){if(t.target===34963)return this.setElementBuffer(t,n);let{size:i,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=n,{gl:d,gl2:m}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(Y(me(d)),m.vertexAttribIPointer(e,i,o,a,l)):d.vertexAttribPointer(e,i,o,u,a,l),d.enableVertexAttribArray(e),m.vertexAttribDivisor(e,h||0)}),this}enable(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!t&&e===0&&!Fr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let n=this._normalizeConstantArrayValue(t),i=n.byteLength*e,o=n.length*e,a=!this.buffer;if(this.buffer=this.buffer||new ve(this.gl,i),a=a||this.buffer.reallocate(i),a=a||!this._compareConstantArrayValues(n,this.bufferValue),a){let l=FC(t.constructor,o);_C({target:l,source:n,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}static _setConstantFloatArray(e,t,n){switch(n.length){case 1:e.vertexAttrib1fv(t,n);break;case 2:e.vertexAttrib2fv(t,n);break;case 3:e.vertexAttrib3fv(t,n);break;case 4:e.vertexAttrib4fv(t,n);break;default:Y(!1)}}static _setConstantIntArray(e,t,n){switch(Y(me(e)),n.length){case 1:e.vertexAttribI1iv(t,n);break;case 2:e.vertexAttribI2iv(t,n);break;case 3:e.vertexAttribI3iv(t,n);break;case 4:e.vertexAttribI4iv(t,n);break;default:Y(!1)}}static _setConstantUintArray(e,t,n){switch(Y(me(e)),n.length){case 1:e.vertexAttribI1uiv(t,n);break;case 2:e.vertexAttribI2uiv(t,n);break;case 3:e.vertexAttribI3uiv(t,n);break;case 4:e.vertexAttribI4uiv(t,n);break;default:Y(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,t){let{location:n}=t;return Y(Number.isFinite(n)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(n,e);default:return this.gl.getVertexAttrib(n,e)}})}};var AR="VertexArray: attributes must be Buffers or constants (i.e. typed array)",vR=/^(.+)__LOCATION_([0-9]+)$/,TR=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],Mc=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=t.id||t.program&&t.program.id;this.id=n,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new Fr(e),ff(this,"VertexArray","v6.0",TR),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let n=e[t];this._setAttribute(t,n)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t.target===34963)return this.setElementBuffer(t,n);let{location:i,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,n);return i>=0&&(this.values[i]=t,this.accessors[i]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(i,t,o)),this}setConstant(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{location:i,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},n));return i>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[i]=t,this.accessors[i]=o,this.clearDrawParams(),this.vertexArrayObject.enable(i,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new ve(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof ve&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof ve&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,n){let i;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),i=n()}),i}_resolveLocationAndAccessor(e,t,n,i){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,oe.once(3,()=>"unused value ".concat(e," in ").concat(this.id))(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=dr.resolve(u.accessor,c,n,i),{size:d,type:m}=h;return Y(Number.isFinite(d)&&Number.isFinite(m)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let n=vR.exec(e),i=n?n[1]:e,o=n?Number(n[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(i)+o,name:i}:{location:-1}}_setAttribute(e,t){if(t instanceof ve)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof ve){let n=t[0],i=t[1];this.setBuffer(e,n,i)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let n=t;this.setConstant(e,n)}else if(t.buffer instanceof ve){let n=t;this.setBuffer(e,n.buffer,n)}else throw new Error(AR)}_setConstantAttributes(e,t){let n=Math.max(e|0,t|0),i=this.values[0];ArrayBuffer.isView(i)&&this._setConstantAttributeZero(i,n);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)i=this.values[o],ArrayBuffer.isView(i)&&this._setConstantAttribute(o,i)}_setConstantAttributeZero(e,t){if(Fr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let n=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,n,this.accessors[0])}_setConstantAttribute(e,t){Fr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let n=this.values[t],i=this.accessors[t];if(!n)return;let{divisor:o}=i,a=o>0;if(e.isInstanced=e.isInstanced||a,n instanceof ve){let l=n;if(a){let u=l.getVertexCount(i);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(i);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return oe.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function IR(s,e){let{maxElts:t=16,size:n=1}=e,i="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(i+=",".concat(a%n===0?" ":"")),i+=Ga(s[a],e);let o=s.length>t?"...":"]";return"".concat(i).concat(o)}function Ga(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=1e-16,{isInteger:n=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return IR(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<t)return n?"0":"0.";if(n||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let i=s.toPrecision(2);return i.indexOf(".0")===i.length-2?i.slice(0,-1):i}function wf(s){let{header:e="Uniforms",program:t,uniforms:n,undefinedOnly:i=!1}=s;Y(t);let o=".*_.*",a=".*Matrix",l=t._uniformSetters,u={},c=Object.keys(l).sort(),h=0;for(let P of c)!P.match(o)&&!P.match(a)&&hP({table:u,header:e,uniforms:n,uniformName:P,undefinedOnly:i})&&h++;for(let P of c)P.match(a)&&hP({table:u,header:e,uniforms:n,uniformName:P,undefinedOnly:i})&&h++;for(let P of c)u[P]||hP({table:u,header:e,uniforms:n,uniformName:P,undefinedOnly:i})&&h++;let d=0,m={};if(!i)for(let P in n){let S=n[P];u[P]||(d++,m[P]={Type:"NOT USED: ".concat(S),[e]:Ga(S)})}return{table:u,count:h,unusedTable:m,unusedCount:d}}function hP(s){let{table:e,header:t,uniforms:n,uniformName:i,undefinedOnly:o}=s,a=n[i],l=wR(a);return!o||!l?(e[i]={[t]:l?Ga(a):"N/A","Uniform Type":l?a:"NOT PROVIDED"},!0):!1}function wR(s){return s!=null}function dP(s){let{vertexArray:e,header:t="Attributes"}=s;if(!e.configuration)return{};let n={};e.elements&&(n.ELEMENT_ARRAY_BUFFER=VC(e,e.elements,null,t));let i=e.values;for(let o in i){let a=e._getAttributeInfo(o);if(a){let l="".concat(o,": ").concat(a.name),u=e.accessors[a.location];u&&(l="".concat(o,": ").concat(LR(a.name,u))),n[l]=VC(e,i[o],u,t)}}return n}function VC(s,e,t,n){let{gl:i}=s;if(!e)return{[n]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof ve){let m=e,{data:P,changed:S}=m.getDebugData();h=S?"*":"",d=P,u=m.byteLength,l=u/P.BYTES_PER_ELEMENT/a;let v;if(t){let I=t.divisor>0;v="".concat(I?"I ":"P "," ").concat(l," (x").concat(a,"=").concat(u," bytes ").concat(Un(i,o),")")}else c=!0,v="".concat(u," bytes");return{[n]:"".concat(h).concat(Ga(d,{size:a,isInteger:c})),"Format ":v}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[n]:"".concat(Ga(d,{size:a,isInteger:c})," (constant)"),"Format ":"".concat(a,"x").concat(o," (constant)")}}function LR(s,e){let{type:t,size:n}=e,i=vf(t,n);return i?"".concat(s," (").concat(i.name,")"):s}function fP(s){let e={},t="Accessors for ".concat(s.id);for(let n of s.attributeInfos)if(n){let i=kC(n);e["in ".concat(i)]={[t]:JSON.stringify(n.accessor)}}for(let n of s.varyingInfos)if(n){let i=kC(n);e["out ".concat(i)]={[t]:JSON.stringify(n.accessor)}}return e}function kC(s){let{type:e,size:t}=s.accessor,n=vf(e,t);return n?"".concat(n.name," ").concat(s.name):s.name}var Ma="vs",Dc="fs";function Ft(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var gP={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function WC(s){let e={};for(let t in s){let n=s[t],i=RR(n);e[t]=i}return e}function RR(s){let e=UC(s);return e==="object"?s?"type"in s?Object.assign({},s,gP[s.type]):"value"in s?(e=UC(s.value),Object.assign({type:e},s,gP[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},gP[e])}function UC(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var BR="vs",NR="fs",Fc=class{constructor(e){let{name:t,vs:n,fs:i,dependencies:o=[],uniforms:a,getUniforms:l,deprecations:u=[],defines:c={},inject:h={},vertexShader:d,fragmentShader:m}=e;Ft(typeof t=="string"),this.name=t,this.vs=n||d,this.fs=i||m,this.getModuleUniforms=l,this.dependencies=o,this.deprecations=this._parseDeprecationDefinitions(u),this.defines=c,this.injections=GR(h),a&&(this.uniforms=WC(a))}getModuleSource(e){let t;switch(e){case BR:t=this.vs||"";break;case NR:t=this.fs||"";break;default:Ft(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(t,"// END MODULE_").concat(this.name,`

`)}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(n=>{n.regex.test(e)&&(n.deprecated?t.deprecated(n.old,n.new)():t.removed(n.old,n.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp("\\b".concat(t.old,"\\("));break;default:t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))}}),e}_defaultGetUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t={},n=this.uniforms;for(let i in n){let o=n[i];i in e&&!o.private?(o.validate&&Ft(o.validate(e[i],o),"".concat(this.name,": invalid ").concat(i)),t[i]=e[i]):t[i]=o.value}return t}};function GR(s){let e={vs:{},fs:{}};for(let t in s){let n=s[t],i=t.slice(0,2);typeof n=="string"&&(n={order:0,injection:n}),e[i][t]=n}return e}function zC(s){return MR(jC(s))}function MR(s){let e={},t={};return HC({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((n,i)=>t[i]-t[n]).map(n=>e[n])}function HC(s){let{modules:e,level:t,moduleMap:n,moduleDepth:i}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(let o of e)n[o.name]=o,(i[o.name]===void 0||i[o.name]<t)&&(i[o.name]=t);for(let o of e)o.dependencies&&HC({modules:o.dependencies,level:t+1,moduleMap:n,moduleDepth:i})}function jC(s,e){return s.map(t=>(t instanceof Fc||(Ft(typeof t!="string","Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),Ft(t.name,"shader module has no name"),t=new Fc(t),t.dependencies=jC(t.dependencies)),t))}function mP(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",n=t.indexOf("MSIE ")!==-1,i=t.indexOf("Trident/")!==-1;return n||i}var DR=7936,FR=7937,_R=7938,VR=35724,bP={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Is={};Object.keys(bP).forEach(s=>{Is[s]=s});function kR(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function qC(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||DR),n=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||FR);return{gpuVendor:UR(t,n),vendor:t,renderer:n,version:s.getParameter(_R),shadingLanguageVersion:s.getParameter(VR)}}function UR(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var pP={};function PP(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=bP[e];if(Ft(n,e),!mP(t))return!0;if(e in pP)return pP[e];let i=n[0],o=t.behavior||"enable",a="#extension GL_".concat(i," : ").concat(o,`
void main(void) {}`),l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),pP[e]=u,u}function WR(s,e){let t=bP[e];Ft(t,e);let n=kR(s)&&t[1]||t[0],i=typeof n=="string"?Boolean(s.getExtension(n)):n;return Ft(i===!1||i===!0),i}function _c(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>WR(s,t))}function XC(s){switch(qC(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function YC(s,e,t){let n=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return _c(s,Is.GLSL_FRAG_DEPTH)&&(n+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),_c(s,Is.GLSL_DERIVATIVES)&&PP(s,Is.GLSL_DERIVATIVES)&&(n+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),_c(s,Is.GLSL_FRAG_DATA)&&PP(s,Is.GLSL_FRAG_DATA,{behavior:"require"})&&(n+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),_c(s,Is.GLSL_TEXTURE_LOD)&&(n+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),n}var KC=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,QC=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var zR={[Ma]:KC,[Dc]:QC},Vc="__LUMA_INJECT_DECLARATIONS__",JC=/void\s+main\s*\([^)]*\)\s*\{\n?/,ZC=/}\n?[^{}]*$/,yP=[];function Lf(s,e,t){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,i=e===Ma;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),yP.length=a.length;for(let u=0,c=a.length;u<c;++u)yP[u]=a[u].injection;let l="".concat(yP.join(`
`),`
`);switch(o){case"vs:#decl":i&&(s=s.replace(Vc,l));break;case"vs:#main-start":i&&(s=s.replace(JC,u=>u+l));break;case"vs:#main-end":i&&(s=s.replace(ZC,u=>l+u));break;case"fs:#decl":i||(s=s.replace(Vc,l));break;case"fs:#main-start":i||(s=s.replace(JC,u=>u+l));break;case"fs:#main-end":i||(s=s.replace(ZC,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(Vc,""),n&&(s=s.replace(/\}\s*$/,o=>o+zR[e])),s}function jl(s){let e={};return Ft(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let n in t)e[n]=e[n]?"".concat(e[n],`
`).concat(t[n]):t[n]}),e}function ql(s){return new RegExp("\\b".concat(s,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}var $C=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],HR=[...$C,[ql("attribute"),"in $1"],[ql("varying"),"out $1"]],jR=[...$C,[ql("varying"),"in $1"]],ex=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],qR=[...ex,[ql("in"),"attribute $1"],[ql("out"),"varying $1"]],XR=[...ex,[ql("in"),"varying $1"]],SP="gl_FragColor",EP=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,YR=/void\s+main\s*\([^)]*\)\s*\{\n?/;function CP(s,e,t){switch(e){case 300:return t?Of(s,HR):KR(s);case 100:return t?Of(s,qR):QR(s);default:throw new Error("unknown GLSL version ".concat(e))}}function Of(s,e){for(let[t,n]of e)s=s.replace(t,n);return s}function KR(s){s=Of(s,jR);let e=s.match(EP);if(e){let t=e[1];s=s.replace(new RegExp("\\b".concat(SP,"\\b"),"g"),t)}else{let t="fragmentColor";s=s.replace(YR,n=>"out vec4 ".concat(t,`;
`).concat(n)).replace(new RegExp("\\b".concat(SP,"\\b"),"g"),t)}return s}function QR(s){s=Of(s,XR);let e=s.match(EP);if(e){let t=e[1];s=s.replace(EP,"").replace(new RegExp("\\b".concat(t,"\\b"),"g"),SP)}return s}var JR=`

`.concat(Vc,`

`),rx={[Ma]:"vertex",[Dc]:"fragment"},ZR=`precision highp float;

`;function xP(s,e){let{vs:t,fs:n}=e,i=zC(e.modules||[]);return{gl:s,vs:tx(s,Object.assign({},e,{source:t,type:Ma,modules:i})),fs:tx(s,Object.assign({},e,{source:n,type:Dc,modules:i})),getUniforms:$R(i)}}function tx(s,e){let{id:t,source:n,type:i,modules:o,defines:a={},hookFunctions:l=[],inject:u={},transpileToGLSL100:c=!1,prologue:h=!0,log:d}=e;Ft(typeof n=="string","shader source must be a string");let m=i===Ma,P=n.split(`
`),S=100,v="",I=n;P[0].indexOf("#version ")===0?(S=300,v=P[0],I=P.slice(1).join(`
`)):v="#version ".concat(S);let L={};o.forEach(se=>{Object.assign(L,se.getDefines())}),Object.assign(L,a);let D=h?"".concat(v,`
`).concat(t2({id:t,source:n,type:i}),`
`).concat(e2({type:i}),`
`).concat(XC(s),`
`).concat(YC(s,S,!m),`
`).concat(r2(L),`
`).concat(m?"":ZR,`
`):"".concat(v,`
`),w=i2(l),M={},K={},X={};for(let se in u){let Te=typeof u[se]=="string"?{injection:u[se],order:0}:u[se],pe=se.match(/^(v|f)s:(#)?([\w-]+)$/);if(pe){let G=pe[2],O=pe[3];G?O==="decl"?K[se]=[Te]:X[se]=[Te]:M[se]=[Te]}else X[se]=[Te]}for(let se of o){d&&se.checkDeprecations(I,d),D+=se.getModuleSource(i,S);let pe=se.injections[i];for(let G in pe){let O=G.match(/^(v|f)s:#([\w-]+)$/);if(O){let U=O[2]==="decl"?K:X;U[G]=U[G]||[],U[G].push(pe[G])}else M[G]=M[G]||[],M[G].push(pe[G])}}return D+=JR,D=Lf(D,i,K),D+=n2(w[i],M),D+=I,D=Lf(D,i,X),D=CP(D,c?100:S,m),D}function $R(s){return function(t){let n={};for(let i of s){let o=i.getUniforms(t,n);Object.assign(n,o)}return n}}function e2(s){let{type:e}=s;return`
#define SHADER_TYPE_`.concat(rx[e].toUpperCase(),`
`)}function t2(s){let{id:e,source:t,type:n}=s;return e&&typeof e=="string"&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(e,"_").concat(rx[n],`

`):""}function r2(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=0,t="";for(let n in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let i=s[n];(i||Number.isFinite(i))&&(t+="#define ".concat(n.toUpperCase()," ").concat(s[n],`
`))}return e===0&&(t+=`
`),t}function n2(s,e){let t="";for(let n in s){let i=s[n];if(t+="void ".concat(i.signature,` {
`),i.header&&(t+="  ".concat(i.header)),e[n]){let o=e[n];o.sort((a,l)=>a.order-l.order);for(let a of o)t+="  ".concat(a.injection,`
`)}i.footer&&(t+="  ".concat(i.footer)),t+=`}
`}return t}function i2(s){let e={vs:{},fs:{}};return s.forEach(t=>{let n;typeof t!="string"?(n=t,t=n.hook):n={},t=t.trim();let[i,o]=t.split(":"),a=t.replace(/\(.+/,"");e[i][a]=Object.assign(n,{signature:o})}),e}var o2="void main() {gl_FragColor = vec4(0);}",nx=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,s2=`#version 300 es
`.concat(nx);function Rf(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[n,i,o]=t;if(!e.includes(n)||!i||!o)return null;let a=o.split(";")[0];return{qualifier:n,type:i,name:a}}function kc(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{version:e=100,input:t,inputType:n,output:i}=s;if(!t)return e===300?s2:e>300?"#version ".concat(e,`
`).concat(nx):o2;let o=ix(t,n);return e>=300?"#version ".concat(e," ").concat(e===300?"es":"",`
in `).concat(n," ").concat(t,`;
out vec4 `).concat(i,`;
void main() {
  `).concat(i," = ").concat(o,`;
}`):"varying ".concat(n," ").concat(t,`;
void main() {
  gl_FragColor = `).concat(o,`;
}`)}function AP(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Ft(!1),null}}function vP(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Ft(!1),null}}function ix(s,e){switch(e){case"float":return"vec4(".concat(s,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(s,", 0.0, 1.0)");case"vec3":return"vec4(".concat(s,", 1.0)");case"vec4":return s;default:return Ft(!1),null}}var a2=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,Bf={name:"fp32",vs:a2,fs:null};function Nf(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var hge=1/Math.PI*180,dge=1/180*Math.PI,fr={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function TP(s,{precision:e=fr.precision}={}){return s=l2(s),"".concat(parseFloat(s.toPrecision(e)))}function Ro(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Uc(s,e,t){return c2(s,n=>Math.max(e,Math.min(t,n)))}function Gf(s,e,t){return Ro(s)?s.map((n,i)=>Gf(n,e[i],t)):t*e+(1-t)*s}function Da(s,e,t){let n=fr.EPSILON;t&&(fr.EPSILON=t);try{if(s===e)return!0;if(Ro(s)&&Ro(e)){if(s.length!==e.length)return!1;for(let i=0;i<s.length;++i)if(!Da(s[i],e[i]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=fr.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{fr.EPSILON=n}}function l2(s){return Math.round(s/fr.EPSILON)*fr.EPSILON}function u2(s){return s.clone?s.clone():new Array(s.length)}function c2(s,e,t){if(Ro(s)){let n=s;t=t||u2(n);for(let i=0;i<t.length&&i<n.length;++i)t[i]=e(s[i],i,t);return t}return e(s)}function h2(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var Xl=class extends h2(Array){clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}toArray(e=[],t=0){for(let n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ro(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(fr)}formatString(e){let t="";for(let n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+TP(this[n],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Da(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,n){if(n===void 0)return this.lerp(this,e,t);for(let i=0;i<this.ELEMENTS;++i){let o=e[i];this[i]=o+n*(t[i]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}add(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]+=t[n];return this.check()}subtract(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]-=t[n];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(fr.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}get elements(){return this}};function d2(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function _r(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function Mf(s,e,t=""){if(fr.debug&&!d2(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var Df=class extends Xl{get x(){return this[0]}set x(e){this[0]=_r(e)}get y(){return this[1]}set y(e){this[1]=_r(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let n=0;n<this.ELEMENTS;++n){let i=this[n]-e[n];t+=i*i}return _r(t)}dot(e){let t=0;for(let n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return _r(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]*=t[n];return this.check()}divide(...e){for(let t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]/=t[n];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Nf(e>=0&&e<this.ELEMENTS,"index is out of range"),_r(this[e])}setComponent(e,t){return Nf(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var ws=1e-6,qi=typeof Float32Array<"u"?Float32Array:Array;var Cge=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function f2(){var s=new qi(2);return qi!=Float32Array&&(s[0]=0,s[1]=0),s}function IP(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function sx(s,e){return s[0]=-e[0],s[1]=-e[1],s}function _f(s,e,t,n){var i=e[0],o=e[1];return s[0]=i+n*(t[0]-i),s[1]=o+n*(t[1]-o),s}function ax(s,e,t){var n=e[0],i=e[1];return s[0]=t[0]*n+t[4]*i+t[12],s[1]=t[1]*n+t[5]*i+t[13],s}var xge=function(){var s=f2();return function(e,t,n,i,o,a){var l,u;for(t||(t=2),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function lx(s,e,t){let n=e[0],i=e[1],o=t[3]*n+t[7]*i||1;return s[0]=(t[0]*n+t[4]*i)/o,s[1]=(t[1]*n+t[5]*i)/o,s}function kf(s,e,t){let n=e[0],i=e[1],o=e[2],a=t[3]*n+t[7]*i+t[11]*o||1;return s[0]=(t[0]*n+t[4]*i+t[8]*o)/a,s[1]=(t[1]*n+t[5]*i+t[9]*o)/a,s[2]=(t[2]*n+t[6]*i+t[10]*o)/a,s}function ux(s,e,t){let n=e[0],i=e[1];return s[0]=t[0]*n+t[2]*i,s[1]=t[1]*n+t[3]*i,s[2]=e[2],s}function g2(){var s=new qi(3);return qi!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function m2(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function cx(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function p2(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function hx(s,e,t){var n=e[0],i=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=i*u-o*l,s[1]=o*a-n*u,s[2]=n*l-i*a,s}function Uf(s,e,t){var n=e[0],i=e[1],o=e[2],a=t[3]*n+t[7]*i+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*n+t[4]*i+t[8]*o+t[12])/a,s[1]=(t[1]*n+t[5]*i+t[9]*o+t[13])/a,s[2]=(t[2]*n+t[6]*i+t[10]*o+t[14])/a,s}function dx(s,e,t){var n=e[0],i=e[1],o=e[2];return s[0]=n*t[0]+i*t[3]+o*t[6],s[1]=n*t[1]+i*t[4]+o*t[7],s[2]=n*t[2]+i*t[5]+o*t[8],s}function fx(s,e,t){var n=t[0],i=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=i*c-o*u,d=o*l-n*c,m=n*u-i*l,P=i*m-o*d,S=o*h-n*m,v=n*d-i*h,I=a*2;return h*=I,d*=I,m*=I,P*=2,S*=2,v*=2,s[0]=l+h+P,s[1]=u+d+S,s[2]=c+m+v,s}function gx(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[0],o[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),o[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function mx(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),o[1]=i[1],o[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function px(s,e,t,n){var i=[],o=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],o[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),o[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),o[2]=i[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function bx(s,e){var t=s[0],n=s[1],i=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+n*n+i*i),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&p2(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var Px=m2;var vge=function(){var s=g2();return function(e,t,n,i,o,a){var l,u;for(t||(t=3),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var wP=[0,0,0],zf,ci=class extends Df{static get ZERO(){return zf||(zf=new ci(0,0,0),Object.freeze(zf)),zf}constructor(e=0,t=0,n=0){super(-0,-0,-0);arguments.length===1&&Ro(e)?this.copy(e):(fr.debug&&(_r(e),_r(t),_r(n)),this[0]=e,this[1]=t,this[2]=n)}set(e,t,n){return this[0]=e,this[1]=t,this[2]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return fr.debug&&(_r(e.x),_r(e.y),_r(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=_r(e)}angle(e){return bx(this,e)}cross(e){return hx(this,this,e),this.check()}rotateX({radians:e,origin:t=wP}){return gx(this,this,t,e),this.check()}rotateY({radians:e,origin:t=wP}){return mx(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=wP}){return px(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Uf(this,this,e),this.check()}transformAsVector(e){return kf(this,this,e),this.check()}transformByMatrix3(e){return dx(this,this,e),this.check()}transformByMatrix2(e){return ux(this,this,e),this.check()}transformByQuaternion(e){return fx(this,this,e),this.check()}};var Hf=class extends Xl{toString(){let e="[";if(fr.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let n=0;n<this.RANK;++n)e+=" ".concat(this[n*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,n){return this[t*this.RANK+e]=_r(n),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let n=e*this.RANK;for(let i=0;i<this.RANK;++i)t[i]=this[n+i];return t}setColumn(e,t){let n=e*this.RANK;for(let i=0;i<this.RANK;++i)this[n+i]=t[i];return this}};function b2(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function yx(s,e){if(s===e){var t=e[1],n=e[2],i=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=n,s[9]=o,s[11]=e[14],s[12]=i,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function Wc(s,e){var t=e[0],n=e[1],i=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],m=e[10],P=e[11],S=e[12],v=e[13],I=e[14],L=e[15],D=t*l-n*a,w=t*u-i*a,M=t*c-o*a,K=n*u-i*l,X=n*c-o*l,se=i*c-o*u,Te=h*v-d*S,pe=h*I-m*S,G=h*L-P*S,O=d*I-m*v,V=d*L-P*v,U=m*L-P*I,Z=D*U-w*V+M*O+K*G-X*pe+se*Te;return Z?(Z=1/Z,s[0]=(l*U-u*V+c*O)*Z,s[1]=(i*V-n*U-o*O)*Z,s[2]=(v*se-I*X+L*K)*Z,s[3]=(m*X-d*se-P*K)*Z,s[4]=(u*G-a*U-c*pe)*Z,s[5]=(t*U-i*G+o*pe)*Z,s[6]=(I*M-S*se-L*w)*Z,s[7]=(h*se-m*M+P*w)*Z,s[8]=(a*V-l*G+c*Te)*Z,s[9]=(n*G-t*V-o*Te)*Z,s[10]=(S*X-v*M+L*D)*Z,s[11]=(d*M-h*X-P*D)*Z,s[12]=(l*pe-a*O-u*Te)*Z,s[13]=(t*O-n*pe+i*Te)*Z,s[14]=(v*w-S*K-I*D)*Z,s[15]=(h*K-d*w+m*D)*Z,s):null}function Sx(s){var e=s[0],t=s[1],n=s[2],i=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],m=s[11],P=s[12],S=s[13],v=s[14],I=s[15],L=e*a-t*o,D=e*l-n*o,w=e*u-i*o,M=t*l-n*a,K=t*u-i*a,X=n*u-i*l,se=c*S-h*P,Te=c*v-d*P,pe=c*I-m*P,G=h*v-d*S,O=h*I-m*S,V=d*I-m*v;return L*V-D*O+w*G+M*pe-K*Te+X*se}function Xi(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],m=e[9],P=e[10],S=e[11],v=e[12],I=e[13],L=e[14],D=e[15],w=t[0],M=t[1],K=t[2],X=t[3];return s[0]=w*n+M*l+K*d+X*v,s[1]=w*i+M*u+K*m+X*I,s[2]=w*o+M*c+K*P+X*L,s[3]=w*a+M*h+K*S+X*D,w=t[4],M=t[5],K=t[6],X=t[7],s[4]=w*n+M*l+K*d+X*v,s[5]=w*i+M*u+K*m+X*I,s[6]=w*o+M*c+K*P+X*L,s[7]=w*a+M*h+K*S+X*D,w=t[8],M=t[9],K=t[10],X=t[11],s[8]=w*n+M*l+K*d+X*v,s[9]=w*i+M*u+K*m+X*I,s[10]=w*o+M*c+K*P+X*L,s[11]=w*a+M*h+K*S+X*D,w=t[12],M=t[13],K=t[14],X=t[15],s[12]=w*n+M*l+K*d+X*v,s[13]=w*i+M*u+K*m+X*I,s[14]=w*o+M*c+K*P+X*L,s[15]=w*a+M*h+K*S+X*D,s}function Fa(s,e,t){var n=t[0],i=t[1],o=t[2],a,l,u,c,h,d,m,P,S,v,I,L;return e===s?(s[12]=e[0]*n+e[4]*i+e[8]*o+e[12],s[13]=e[1]*n+e[5]*i+e[9]*o+e[13],s[14]=e[2]*n+e[6]*i+e[10]*o+e[14],s[15]=e[3]*n+e[7]*i+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],m=e[6],P=e[7],S=e[8],v=e[9],I=e[10],L=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=m,s[7]=P,s[8]=S,s[9]=v,s[10]=I,s[11]=L,s[12]=a*n+h*i+S*o+e[12],s[13]=l*n+d*i+v*o+e[13],s[14]=u*n+m*i+I*o+e[14],s[15]=c*n+P*i+L*o+e[15]),s}function Yl(s,e,t){var n=t[0],i=t[1],o=t[2];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=e[3]*n,s[4]=e[4]*i,s[5]=e[5]*i,s[6]=e[6]*i,s[7]=e[7]*i,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function Ex(s,e,t,n){var i=n[0],o=n[1],a=n[2],l=Math.hypot(i,o,a),u,c,h,d,m,P,S,v,I,L,D,w,M,K,X,se,Te,pe,G,O,V,U,Z,te;return l<ws?null:(l=1/l,i*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],m=e[1],P=e[2],S=e[3],v=e[4],I=e[5],L=e[6],D=e[7],w=e[8],M=e[9],K=e[10],X=e[11],se=i*i*h+c,Te=o*i*h+a*u,pe=a*i*h-o*u,G=i*o*h-a*u,O=o*o*h+c,V=a*o*h+i*u,U=i*a*h+o*u,Z=o*a*h-i*u,te=a*a*h+c,s[0]=d*se+v*Te+w*pe,s[1]=m*se+I*Te+M*pe,s[2]=P*se+L*Te+K*pe,s[3]=S*se+D*Te+X*pe,s[4]=d*G+v*O+w*V,s[5]=m*G+I*O+M*V,s[6]=P*G+L*O+K*V,s[7]=S*G+D*O+X*V,s[8]=d*U+v*Z+w*te,s[9]=m*U+I*Z+M*te,s[10]=P*U+L*Z+K*te,s[11]=S*U+D*Z+X*te,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function jf(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],m=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*i+c*n,s[5]=a*i+h*n,s[6]=l*i+d*n,s[7]=u*i+m*n,s[8]=c*i-o*n,s[9]=h*i-a*n,s[10]=d*i-l*n,s[11]=m*i-u*n,s}function Cx(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],m=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*i-c*n,s[1]=a*i-h*n,s[2]=l*i-d*n,s[3]=u*i-m*n,s[8]=o*n+c*i,s[9]=a*n+h*i,s[10]=l*n+d*i,s[11]=u*n+m*i,s}function qf(s,e,t){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],m=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*i+c*n,s[1]=a*i+h*n,s[2]=l*i+d*n,s[3]=u*i+m*n,s[4]=c*i-o*n,s[5]=h*i-a*n,s[6]=d*i-l*n,s[7]=m*i-u*n,s}function xx(s,e){var t=e[0],n=e[1],i=e[2],o=e[3],a=t+t,l=n+n,u=i+i,c=t*a,h=n*a,d=n*l,m=i*a,P=i*l,S=i*u,v=o*a,I=o*l,L=o*u;return s[0]=1-d-S,s[1]=h+L,s[2]=m-I,s[3]=0,s[4]=h-L,s[5]=1-c-S,s[6]=P+v,s[7]=0,s[8]=m+I,s[9]=P-v,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Ax(s,e,t,n,i,o,a){var l=1/(t-e),u=1/(i-n),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(i+n)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function P2(s,e,t,n,i){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,i!=null&&i!==1/0?(a=1/(n-i),s[10]=(i+n)*a,s[14]=2*i*n*a):(s[10]=-1,s[14]=-2*n),s}var LP=P2;function y2(s,e,t,n,i,o,a){var l=1/(e-t),u=1/(n-i),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(i+n)*u,s[14]=(a+o)*c,s[15]=1,s}var vx=y2;function Tx(s,e,t,n){var i,o,a,l,u,c,h,d,m,P,S=e[0],v=e[1],I=e[2],L=n[0],D=n[1],w=n[2],M=t[0],K=t[1],X=t[2];return Math.abs(S-M)<ws&&Math.abs(v-K)<ws&&Math.abs(I-X)<ws?b2(s):(h=S-M,d=v-K,m=I-X,P=1/Math.hypot(h,d,m),h*=P,d*=P,m*=P,i=D*m-w*d,o=w*h-L*m,a=L*d-D*h,P=Math.hypot(i,o,a),P?(P=1/P,i*=P,o*=P,a*=P):(i=0,o=0,a=0),l=d*a-m*o,u=m*i-h*a,c=h*o-d*i,P=Math.hypot(l,u,c),P?(P=1/P,l*=P,u*=P,c*=P):(l=0,u=0,c=0),s[0]=i,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=m,s[11]=0,s[12]=-(i*S+o*v+a*I),s[13]=-(l*S+u*v+c*I),s[14]=-(h*S+d*v+m*I),s[15]=1,s)}function S2(){var s=new qi(4);return qi!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Ix(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function Bo(s,e,t){var n=e[0],i=e[1],o=e[2],a=e[3];return s[0]=t[0]*n+t[4]*i+t[8]*o+t[12]*a,s[1]=t[1]*n+t[5]*i+t[9]*o+t[13]*a,s[2]=t[2]*n+t[6]*i+t[10]*o+t[14]*a,s[3]=t[3]*n+t[7]*i+t[11]*o+t[15]*a,s}var Mge=function(){var s=S2();return function(e,t,n,i,o,a){var l,u;for(t||(t=4),n||(n=0),i?u=Math.min(i*t+n,e.length):u=e.length,l=n;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var NP;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(NP||(NP={}));var E2=45*Math.PI/180,C2=1,RP=.1,BP=500,x2=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Wn=class extends Hf{static get IDENTITY(){return v2()}static get ZERO(){return A2()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return NP}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,n,i,o,a,l,u,c,h,d,m,P,S,v,I){return this[0]=e,this[1]=t,this[2]=n,this[3]=i,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=m,this[12]=P,this[13]=S,this[14]=v,this[15]=I,this.check()}setRowMajor(e,t,n,i,o,a,l,u,c,h,d,m,P,S,v,I){return this[0]=e,this[1]=o,this[2]=c,this[3]=P,this[4]=t,this[5]=a,this[6]=h,this[7]=S,this[8]=n,this[9]=l,this[10]=d,this[11]=v,this[12]=i,this[13]=u,this[14]=m,this[15]=I,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(x2)}fromObject(e){return this.check()}fromQuaternion(e){return xx(this,e),this.check()}frustum(e){let{left:t,right:n,bottom:i,top:o,near:a=RP,far:l=BP}=e;return l===1/0?T2(this,t,n,i,o,a):Ax(this,t,n,i,o,a,l),this.check()}lookAt(e){let{eye:t,center:n=[0,0,0],up:i=[0,1,0]}=e;return Tx(this,t,n,i),this.check()}ortho(e){let{left:t,right:n,bottom:i,top:o,near:a=RP,far:l=BP}=e;return vx(this,t,n,i,o,a,l),this.check()}orthographic(e){let{fovy:t=E2,aspect:n=C2,focalDistance:i=1,near:o=RP,far:a=BP}=e;wx(t);let l=t/2,u=i*Math.tan(l),c=u*n;return this.ortho({left:-c,right:c,bottom:-u,top:u,near:o,far:a})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:n=1,near:i=.1,far:o=500}=e;return wx(t),LP(this,t,n,i,o),this.check()}determinant(){return Sx(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let n=this.getScale(t),i=1/n[0],o=1/n[1],a=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*i,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*i,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let n=this.getScale(t),i=1/n[0],o=1/n[1],a=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*i,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*i,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return yx(this,this),this.check()}invert(){return Wc(this,this),this.check()}multiplyLeft(e){return Xi(this,e,this),this.check()}multiplyRight(e){return Xi(this,this,e),this.check()}rotateX(e){return jf(this,this,e),this.check()}rotateY(e){return Cx(this,this,e),this.check()}rotateZ(e){return qf(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return Ex(this,this,e,t),this.check()}scale(e){return Yl(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return Fa(this,this,e),this.check()}transform(e,t){return e.length===4?(t=Bo(t||[-0,-0,-0,-0],e,this),Mf(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:n}=e,i;switch(n){case 2:i=ax(t||[-0,-0],e,this);break;case 3:i=Uf(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Mf(i,e.length),i}transformAsVector(e,t){let n;switch(e.length){case 2:n=lx(t||[-0,-0],e,this);break;case 3:n=kf(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Mf(n,e.length),n}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,n){return this.identity().translate([e,t,n])}},Yf,Kf;function A2(){return Yf||(Yf=new Wn([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Yf)),Yf}function v2(){return Kf||(Kf=new Wn,Object.freeze(Kf)),Kf}function wx(s){if(s>Math.PI*2)throw Error("expected radians")}function T2(s,e,t,n,i,o){let a=2*o/(t-e),l=2*o/(i-n),u=(t+e)/(t-e),c=(i+n)/(i-n),h=-1,d=-1,m=-2*o;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=l,s[6]=0,s[7]=0,s[8]=u,s[9]=c,s[10]=h,s[11]=d,s[12]=0,s[13]=0,s[14]=m,s[15]=0,s}var I2=new Uint8Array([0,255,255,255]),w2={pickingSelectedColor:null,pickingHighlightColor:I2,pickingActive:!1,pickingAttribute:!1};function L2(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:w2,e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,n=>n/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var O2=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,R2=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,Ls={name:"picking",vs:O2,fs:R2,getUniforms:L2};var B2=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,GP={name:"transform",vs:B2,fs:null};var _a=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new _a(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(n=>n.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{vs:t="",fs:n="",defines:i={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(n),m=c.map(w=>this._getHash(w.name)).sort(),P=a.map(w=>this._getHash(w)),S=Object.keys(i).sort(),v=Object.keys(o).sort(),I=[],L=[];for(let w of S)I.push(this._getHash(w)),I.push(this._getHash(i[w]));for(let w of v)L.push(this._getHash(w)),L.push(this._getHash(o[w]));let D="".concat(h,"/").concat(d,"D").concat(I.join("/"),"M").concat(m.join("/"),"I").concat(L.join("/"),"V").concat(P.join("/"),"H").concat(this.stateHash,"B").concat(l).concat(u?"T":"");if(!this._programCache[D]){let w=xP(this.gl,{vs:t,fs:n,modules:c,inject:o,defines:i,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[D]=new vs(this.gl,{hash:D,vs:w.vs,fs:w.fs,varyings:a,bufferMode:l}),this._getUniforms[D]=w.getUniforms||(M=>{}),this._useCounts[D]=0}return this._useCounts[D]++,this._programCache[D]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=new Array(this._defaultModules.length+e.length),n={},i=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[i++]=l,n[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;n[u]||(t[i++]=l,n[u]=!0)}return t.length=i,t}};var N2={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function Lx(s,e,t){let n={},i=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=G2(o,t);if(o==="indices")i=a;else if(a.constant)n[l]=a.value;else{let u=a.value,c={...a};delete c.value,n[l]=[new ve(s,u),c],M2(o,c)}}if(i){let o=i.value||i;Y(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:i.isIndexed===void 0?!0:i.isIndexed};n.indices=[new ve(s,{data:o,target:34963}),a]}return n}function G2(s,e){let{attributeMap:t=N2}=e||{};return t&&t[s]||s}function M2(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}Y(Number.isFinite(e.size),"attribute ".concat(s," needs size"))}var Kl=2,D2=1e4,F2="Model needs drawMode and vertexCount",Ox=()=>{},_2={},cn=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{id:n=rn("model")}=t;Y(wa(e)),this.id=n,this.gl=e,this.id=t.id||rn("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||_a.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},Y(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),F2)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:n,fs:i,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return Y(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return Y(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=Lx(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Hi(e))return this;let t={};for(let n in e){let i=e[n];t[n]=i.getValue?i.getValue():i}return this.vertexArray.setAttributes(t),this}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return kl(this.program.gl,e),this}draw(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();let{moduleSettings:t=null,framebuffer:n,uniforms:i={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(i);let c;oe.priority>=Kl&&(c=this._logDrawCallStart(Kl));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:m=h.indexType,indexOffset:P=h.indexOffset,vertexArrayInstanced:S=h.isInstanced}=this.props;S&&!this.isInstanced&&oe.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:v,instanceCount:I}=this,{onBeforeRender:L=Ox,onAfterRender:D=Ox}=this.props;L(),this.program.setUniforms(this.uniforms);let w=this.program.draw(Object.assign(_2,e,{logPriority:c,uniforms:null,framebuffer:n,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:m,isInstanced:v,instanceCount:I,offset:d?P:0}));return D(),oe.priority>=Kl&&this._logDrawCallEnd(c,u,n),w}transform(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{discard:t=!0,feedbackBuffers:n,unbindModels:i=[]}=e,{parameters:o}=e;n&&this._setFeedbackBuffers(n),t&&(o=Object.assign({},o,{[35977]:t})),i.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{i.forEach(a=>a.vertexArray.bindBuffers())}return this}render(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return oe.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:n,fs:i,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:n,fs:i,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}Y(t instanceof vs,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Mc(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof ve&&t.delete()}}_setAnimationProps(e){this.animated&&Y(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Hi(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new Ts(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:D2;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),oe.group(Kl,">>> DRAWING MODEL ".concat(this.id),{collapsed:oe.level<=2})(),e}_logDrawCallEnd(e,t,n,i){if(e===void 0)return;let o=dP({vertexArray:t,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=wf({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,n)}),{table:c,count:h}=wf({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,n),undefinedOnly:!0});h>0&&oe.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&oe.log("UNUSED UNIFORMS",Object.keys(l))();let d=fP(this.vertexArray.configuration);oe.table(e,o)(),oe.table(e,a)(),oe.table(e+1,d)(),i&&i.log({logLevel:Kl,message:"Rendered to ".concat(i.id)}),oe.groupEnd(Kl)()}};var Qf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this.bindings[this.currentIndex],{sourceBuffers:n,transformFeedback:i}=t;return{attributes:Object.assign({},n,e.attributes),transformFeedback:i}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],n=e?t[e]:null;return n?n instanceof ve?n:n.buffer:null}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyingName:t}=e,n=this.getBuffer(t);return n?n.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&Y(me(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,n={};if(this.bindings[this.currentIndex]&&Object.assign(n,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let i in this.feedbackMap){let o=this.feedbackMap[i];i in t&&(n[o]=i)}Object.assign(n,e.feedbackBuffers);for(let i in n){let o=n[i];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;n[i]=this._createNewBuffer(i,{byteLength:l,usage:u,accessor:c})}}return n}_setupBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let n=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:n})}_setupTransformFeedback(e,t){let{model:n}=t,{program:i}=n;e.transformFeedback=new Ts(this.gl,{program:i,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:n}=this._swapBuffers(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceBuffers:t,feedbackBuffers:n})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),n=Object.assign({},e.feedbackBuffers);for(let i in this.feedbackMap){let o=this.feedbackMap[i];t[i]=e.feedbackBuffers[o],n[o]=e.sourceBuffers[i],Y(n[o]instanceof ve)}return{sourceBuffers:t,feedbackBuffers:n}}_createNewBuffer(e,t){let n=new ve(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=n,n}_getNextIndex(){return(this.currentIndex+1)%2}};var V2="transform_uSampler_",Jf="transform_uSize_",Rx="transform_position";function Bx(s){let{vs:e,sourceTextureMap:t,targetTextureVarying:n,targetTexture:i}=s,a=Object.keys(t).length,l=null,u={},c=e,h={};if(a>0||n){let d=c.split(`
`),m=d.slice();if(d.forEach((P,S,v)=>{if(a>0){let I=z2(P,t);if(I){let{updatedLine:L,inject:D}=I;m[S]=L,h=jl([h,D]),Object.assign(u,I.samplerTextureMap),a--}}n&&!l&&(l=W2(P,n))}),n){Y(i);let P="".concat(Jf).concat(n),S="uniform vec2 ".concat(P,`;
`),v="     vec2 ".concat(Rx," = transform_getPos(").concat(P,`);
     gl_Position = vec4(`).concat(Rx,`, 0, 1.);
`);h=jl([h,{"vs:#decl":S,"vs:#main-start":v}])}c=m.join(`
`)}return{vs:c,targetTextureType:l,inject:h,samplerTextureMap:u}}function Nx(s){let{sourceTextureMap:e,targetTextureVarying:t,targetTexture:n}=s,i={},o,a;t&&({width:o,height:a}=n,i["".concat(Jf).concat(t)]=[o,a]);for(let l in e)({width:o,height:a}=e[l]),i["".concat(Jf).concat(l)]=[o,a];return i}function k2(s){return Rf(s,["attribute","in"])}function U2(s){let e="".concat(V2).concat(s),t="".concat(Jf).concat(s),n="  uniform sampler2D ".concat(e,`;
  uniform vec2 `).concat(t,";");return{samplerName:e,sizeName:t,uniformDeclerations:n}}function W2(s,e){let t=Rf(s,["varying","out"]);return t&&t.name===e?t.type:null}function z2(s,e){let t={},n=k2(s);if(!n)return null;let{type:i,name:o}=n;if(o&&e[o]){let a="// ".concat(s," => Replaced by Transform with a sampler"),{samplerName:l,sizeName:u,uniformDeclerations:c}=U2(o),h=AP(i),d="  ".concat(i," ").concat(o," = transform_getInput(").concat(l,", ").concat(u,").").concat(h,`;
`);return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var H2={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},j2="transform_output",Zf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,sourceTextures:n,framebuffer:i,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let m=this.samplerTextureMap[d];l[d]=n[m]}this._setSourceTextureParameters();let h=Nx({sourceTextureMap:n,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,i.width,i.height]),{attributes:a,framebuffer:i,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{framebuffer:t}=this.bindings[this.currentIndex],n=Na(t);if(!e)return n;let i=n.constructor,o=vP(this.targetTextureType),a=new i(n.length*o/4),l=0;for(let u=0;u<n.length;u+=4)for(let c=0;c<o;c++)a[l++]=n[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{_targetTextureVarying:t,_swapTexture:n}=e;this._swapTexture=n,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:n}=e;if(n instanceof Dt)return n;let i=t[n];return i?(this._targetRefTexName=n,this._createNewTexture(i)):null}_setupTextures(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,_sourceTextures:n={},_targetTexture:i}=e,o=this._createTargetTexture({sourceTextures:n,textureOrReference:i});this.hasSourceTextures=this.hasSourceTextures||n&&Object.keys(n).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:n,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((n,i,o)=>{o[i]=i}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new ve(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:n}=this._swapTextures(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceTextures:t,targetTexture:n})}}_updateBinding(e,t){let{sourceBuffers:n,sourceTextures:i,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,i),Object.assign(e.sourceBuffers,n),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new It(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let n in t)t[n].setParameters(H2)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let n=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:n}}_createNewTexture(e){let t=Ef(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceTextures:t,targetTexture:n}=this.bindings[this.currentIndex],{vs:i,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=Bx({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:n}),c=jl([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||kc({version:Ul(i),input:this.targetTextureVarying,inputType:a,output:j2}),d=this.hasSourceTextures||this.targetTextureVarying?[GP].concat(e.modules||[]):e.modules;return{vs:i,fs:h,modules:d,uniforms:o,inject:c}}};var Yi=class{static isSupported(e){return me(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:n}=this;e&&e.delete(),t&&t.delete(),n&&n.delete()}run(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{clearRenderTarget:t=!0}=e,n=this._updateDrawOptions(e);t&&n.framebuffer&&n.framebuffer.clear({color:!0}),this.model.transform(n)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t)e=e||n.swap();Y(e,"Nothing to swap")}getBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t){let i=n.getData(e);if(i)return i}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of t)n.update(e)}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new cn(t,Object.assign({},e,{fs:e.fs||kc({version:Ul(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of n)t=i.updateModelProps(t);return t}_buildResourceTransforms(e,t){q2(t)&&(this.bufferTransform=new Qf(e,t)),X2(t)&&(this.textureTransform=new Zf(e,t)),Y(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of n)t=Object.assign(t,i.getDrawOptions(t));return t}};function q2(s){return!!(!Hi(s.feedbackBuffers)||!Hi(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function X2(s){return!!(!Hi(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var Gx={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},zn=class{static get DRAW_MODE(){return Gx}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{id:t=rn("geometry"),drawMode:n=Gx.TRIANGLES,attributes:i={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=n|0,this.attributes={},this.userData={},this._setAttributes(i,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let n in e){let i=e[n];i=ArrayBuffer.isView(i)?{value:i}:i,Y(ArrayBuffer.isView(i.value),"".concat(this._print(n),": must be typed array or object with value as typed array")),(n==="POSITION"||n==="positions")&&!i.size&&(i.size=3),n==="indices"?(Y(!this.indices),this.indices=i):this.attributes[n]=i}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let n=1/0;for(let i in e){let o=e[i],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(n=Math.min(n,a.length/l))}return Y(Number.isFinite(n)),n}};var Mx="#define SMOOTH_EDGE_RADIUS 0.5",Q2=`
`.concat(Mx,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),J2=`
`.concat(Mx,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),Dx={name:"geometry",vs:Q2,fs:J2};var ke={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(ke,"IDENTITY",{get:()=>(Ye.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var Hn={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},jn={common:0,meters:1,pixels:2};var MP={DRAW:"draw",MASK:"mask"};var Z2=Object.keys(ke).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(ke[s],";")).join(""),$2=Object.keys(Hn).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(Hn[s],";")).join(""),eB=Object.keys(jn).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(jn[s],";")).join(""),Fx="".concat(Z2,`
`).concat($2,`
`).concat(eB,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function tB(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}return!1}function zc(s){let e={},t;return n=>{for(let i in n)if(!tB(n[i],e[i])){t=s(n),e=n;break}return t}}var _x=[0,0,0,0],rB=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Vx=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],nB=[0,0,0],kx=[0,0,0],iB=zc(sB);function DP(s,e,t=kx){t.length<3&&(t=[t[0],t[1],0]);let n=t,i,o=!0;switch(e===ke.LNGLAT_OFFSETS||e===ke.METER_OFFSETS?i=t:i=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case Hn.WEB_MERCATOR:(e===ke.LNGLAT||e===ke.CARTESIAN)&&(i=[0,0,0],o=!1);break;case Hn.WEB_MERCATOR_AUTO_OFFSET:e===ke.LNGLAT?n=i:e===ke.CARTESIAN&&(n=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],i=s.unprojectPosition(n),n[0]-=t[0],n[1]-=t[1],n[2]-=t[2]);break;case Hn.IDENTITY:n=s.position.map(Math.fround),n[2]=n[2]||0;break;case Hn.GLOBE:o=!1,i=null;break;default:o=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:n,offsetMode:o}}function oB(s,e,t){let{viewMatrixUncentered:n,projectionMatrix:i}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=_x,u=_x,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:m}=DP(s,e,t);return m&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=Bo([],u,a),o=n||o,a=Xi([],i,o),a=Xi([],a,rB)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function Ux({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:n=ke.DEFAULT,coordinateOrigin:i=kx,autoWrapLongitude:o=!1}){n===ke.DEFAULT&&(n=s.isGeospatial?ke.LNGLAT:ke.CARTESIAN);let a=iB({viewport:s,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:i});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||Vx,a}function sB({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:n}){let{projectionCenter:i,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=oB(s,t,n),h=s.getDistanceScales(),d=[s.width*e,s.height*e],m=Bo([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,P={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:i,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:m,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:nB,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:Vx,project_uCameraPosition:l};if(c){let S=s.getDistanceScales(c);switch(t){case ke.METER_OFFSETS:P.project_uCommonUnitsPerWorldUnit=S.unitsPerMeter,P.project_uCommonUnitsPerWorldUnit2=S.unitsPerMeter2;break;case ke.LNGLAT:case ke.LNGLAT_OFFSETS:s._pseudoMeters||(P.project_uCommonUnitsPerMeter=S.unitsPerMeter),P.project_uCommonUnitsPerWorldUnit=S.unitsPerDegree,P.project_uCommonUnitsPerWorldUnit2=S.unitsPerDegree2;break;case ke.CARTESIAN:P.project_uCommonUnitsPerWorldUnit=[1,1,S.unitsPerMeter[2]],P.project_uCommonUnitsPerWorldUnit2=[0,0,S.unitsPerMeter2[2]];break;default:break}}return P}var aB={};function lB(s=aB){return"viewport"in s?Ux(s):{}}var FP={name:"project",dependencies:[Bf,Dx],vs:Fx,getUniforms:lB};var uB=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Ki={name:"project32",dependencies:[FP],vs:uB};function _P(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Os(s,e){let t=Bo([],e,s);return Ix(t,t,1/t[3]),t}function Hc(s,e,t){return s<e?e:s>t?t:s}function cB(s){return Math.log(s)*Math.LOG2E}var jc=Math.log2||cB;function qn(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var hi=Math.PI,Wx=hi/4,di=hi/180,VP=180/hi,qc=512,kP=4003e4,Ql=85.051129,zx=1.5;function UP(s){return jc(s)}function No(s){let[e,t]=s;qn(Number.isFinite(e)),qn(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");let n=e*di,i=t*di,o=qc*(n+hi)/(2*hi),a=qc*(hi+Math.log(Math.tan(Wx+i*.5)))/(2*hi);return[o,a]}function fi(s){let[e,t]=s,n=e/qc*(2*hi)-hi,i=2*(Math.atan(Math.exp(t/qc*(2*hi)-hi))-Wx);return[n*VP,i*VP]}function WP(s){let{latitude:e}=s;qn(Number.isFinite(e));let t=Math.cos(e*di);return UP(kP*t)-9}function Jl(s){let{latitude:e,longitude:t,highPrecision:n=!1}=s;qn(Number.isFinite(e)&&Number.isFinite(t));let i=qc,o=Math.cos(e*di),a=i/360,l=a/o,u=i/kP/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[a,l,u],degreesPerUnit:[1/a,1/l,1/u]};if(n){let h=di*Math.tan(e*di)/o,d=a*h/2,m=i/kP*h,P=m/l*u;c.unitsPerDegree2=[0,d,m],c.unitsPerMeter2=[P,0,P]}return c}function Xc(s,e){let[t,n,i]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=Jl({longitude:t,latitude:n,highPrecision:!0}),h=No(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=fi(h),m=(i||0)+(l||0);return Number.isFinite(i)||Number.isFinite(l)?[d[0],d[1],m]:d}function $f(s){let{height:e,pitch:t,bearing:n,altitude:i,scale:o,center:a}=s,l=_P();Fa(l,l,[0,0,-i]),jf(l,l,-t*di),qf(l,l,n*di);let u=o/e;return Yl(l,l,[u,u,u]),a&&Fa(l,l,cx([],a)),l}function zP(s){let{width:e,height:t,altitude:n,pitch:i=0,offset:o,center:a,scale:l,nearZMultiplier:u=1,farZMultiplier:c=1}=s,{fovy:h=Va(zx)}=s;n!==void 0&&(h=Va(n));let d=h*di,m=i*di,P=Yc(h),S=P;a&&(S+=a[2]*l/Math.cos(m)/t);let v=d*(.5+(o?o[1]:0)/t),I=Math.sin(v)*S/Math.sin(Hc(Math.PI/2-m-v,.01,Math.PI-.01)),L=Math.sin(m)*I+S,D=S*10,w=Math.min(L*c,D);return{fov:d,aspect:e/t,focalDistance:P,near:u,far:w}}function Va(s){return 2*Math.atan(.5/s)*VP}function Yc(s){return .5/Math.tan(.5*s*di)}function Zl(s,e){let[t,n,i=0]=s;return qn(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(i)),Os(e,[t,n,i,1])}function $l(s,e,t=0){let[n,i,o]=s;if(qn(Number.isFinite(n)&&Number.isFinite(i),"invalid pixel coordinate"),Number.isFinite(o))return Os(e,[n,i,o,1]);let a=Os(e,[n,i,0,1]),l=Os(e,[n,i,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return _f([],a,l,h)}function Kc(s){let{width:e,height:t,bounds:n,minExtent:i=0,maxZoom:o=24,offset:a=[0,0]}=s,[[l,u],[c,h]]=n,d=hB(s.padding),m=No([l,Hc(h,-Ql,Ql)]),P=No([c,Hc(u,-Ql,Ql)]),S=[Math.max(Math.abs(P[0]-m[0]),i),Math.max(Math.abs(P[1]-m[1]),i)],v=[e-d.left-d.right-Math.abs(a[0])*2,t-d.top-d.bottom-Math.abs(a[1])*2];qn(v[0]>0&&v[1]>0);let I=v[0]/S[0],L=v[1]/S[1],D=(d.right-d.left)/2/I,w=(d.bottom-d.top)/2/L,M=[(P[0]+m[0])/2+D,(P[1]+m[1])/2+w],K=fi(M),X=Math.min(o,jc(Math.abs(Math.min(I,L))));return qn(Number.isFinite(X)),{longitude:K[0],latitude:K[1],zoom:X}}function hB(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(qn(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}var Hx=Math.PI/180;function Qc(s,e=0){let{width:t,height:n,unproject:i}=s,o={targetZ:e},a=i([0,n],o),l=i([t,n],o),u,c,h=s.fovy?.5*s.fovy*Hx:Math.atan(.5/s.altitude),d=(90-s.pitch)*Hx;return h>d-.01?(u=jx(s,0,e),c=jx(s,t,e)):(u=i([0,0],o),c=i([t,0],o)),[a,l,c,u]}function jx(s,e,t){let{pixelUnprojectionMatrix:n}=s,i=Os(n,[e,0,1,1]),o=Os(n,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-i[2])/(o[2]-i[2]),u=_f([],i,o,l),c=fi(u);return c.push(t),c}var eu={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...Ls};var Xx=class{constructor(e={}){T(this,"_pool",[]),T(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:n=1,type:i,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=i||e&&e.constructor||Float32Array,h=t*n+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d=1/0;u&&(d=u*n+o);let m=this._allocate(c,h,l,d);return e&&a?m.set(e):l||m.fill(0,0,4),this._release(e),m}release(e){this._release(e)}_allocate(e,t,n,i){let o=Math.max(Math.ceil(t*this.opts.overAlloc),1);o>i&&(o=i);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return n&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:n}=e,{byteLength:i}=n,o=t.findIndex(a=>a.byteLength>=i);o<0?t.push(n):(o>0||t.length<this.opts.poolSize)&&t.splice(o,0,n),t.length>this.opts.poolSize&&t.shift()}},ka=new Xx;function ru(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Kx(s){return[s[12],s[13],s[14]]}function Qx(s){return{left:tu(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:tu(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:tu(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:tu(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:tu(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:tu(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var Yx=new ci;function tu(s,e,t,n){Yx.set(s,e,t);let i=Yx.len();return{distance:n/i,normal:new ci(-s/i,-e/i,-t/i)}}function gB(s){return s-Math.fround(s)}var Jc;function eg(s,e){let{size:t=1,startIndex:n=0}=e,i=e.endIndex!==void 0?e.endIndex:s.length,o=(i-n)/t;Jc=ka.allocate(Jc,o,{type:Float32Array,size:t*2});let a=n,l=0;for(;a<i;){for(let u=0;u<t;u++){let c=s[a++];Jc[l+u]=c,Jc[l+u+t]=gB(c)}l+=t*2}return Jc.subarray(0,o*t*2)}var mB=Math.PI/180,pB=ru(),Jx=[0,0,0],bB={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function PB({width:s,height:e,orthographic:t,fovyRadians:n,focalDistance:i,padding:o,near:a,far:l}){let u=s/e,c=t?new Wn().orthographic({fovy:n,aspect:u,focalDistance:i,near:a,far:l}):new Wn().perspective({fovy:n,aspect:u,near:a,far:l});if(o){let{left:h=0,right:d=0,top:m=0,bottom:P=0}=o,S=Uc((h+s-d)/2,0,s)-s/2,v=Uc((m+e-P)/2,0,e)-e/2;c[8]-=S*2/s,c[9]+=v*2/e}return c}var Ua=class{constructor(e={}){T(this,"id",void 0),T(this,"x",void 0),T(this,"y",void 0),T(this,"width",void 0),T(this,"height",void 0),T(this,"padding",void 0),T(this,"isGeospatial",void 0),T(this,"zoom",void 0),T(this,"focalDistance",void 0),T(this,"position",void 0),T(this,"modelMatrix",void 0),T(this,"distanceScales",void 0),T(this,"scale",void 0),T(this,"center",void 0),T(this,"cameraPosition",void 0),T(this,"projectionMatrix",void 0),T(this,"viewMatrix",void 0),T(this,"viewMatrixUncentered",void 0),T(this,"viewMatrixInverse",void 0),T(this,"viewProjectionMatrix",void 0),T(this,"pixelProjectionMatrix",void 0),T(this,"pixelUnprojectionMatrix",void 0),T(this,"resolution",void 0),T(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||bB,this.focalDistance=e.focalDistance||1,this.position=e.position||Jx,this.modelMatrix=e.modelMatrix||null;let{longitude:t,latitude:n}=e;this.isGeospatial=Number.isFinite(n)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Hn.WEB_MERCATOR:Hn.WEB_MERCATOR_AUTO_OFFSET:Hn.IDENTITY}equals(e){return e instanceof Ua?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Da(e.projectionMatrix,this.projectionMatrix)&&Da(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let n=this.projectPosition(e),i=Zl(n,this.pixelProjectionMatrix),[o,a]=i,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,i[2]]}unproject(e,{topLeft:t=!0,targetZ:n}={}){let[i,o,a]=e,l=t?o:this.height-o,u=n&&n*this.distanceScales.unitsPerMeter[2],c=$l([i,l,a],this.pixelUnprojectionMatrix,u),[h,d,m]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,m]:Number.isFinite(n)?[h,d,n]:[h,d]}projectPosition(e){let[t,n]=this.projectFlat(e),i=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,n,i]}unprojectPosition(e){let[t,n]=this.unprojectFlat(e),i=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,n,i]}projectFlat(e){if(this.isGeospatial){let t=No(e);return t[1]=Uc(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?fi(e):e}getBounds(e={}){let t={targetZ:e.z||0},n=this.unproject([0,0],t),i=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(n[0],i[0],o[0],a[0]),Math.min(n[1],i[1],o[1],a[1]),Math.max(n[0],i[0],o[0],a[0]),Math.max(n[1],i[1],o[1],a[1])]}getDistanceScales(e){return e?Jl({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:n=1,height:i=1}){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+i}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,Qx(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,n=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=WP({latitude:n})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Jl({latitude:n,longitude:t}));let i=Math.pow(2,this.zoom);this.scale=i;let{position:o,modelMatrix:a}=e,l=Jx;if(o&&(l=a?new Wn(a).transformAsVector(o,[]):o),this.isGeospatial){let u=this.projectPosition([t,n,0]);this.center=new ci(l).scale(this.distanceScales.unitsPerMeter).add(u)}else this.center=this.projectPosition(l)}_initMatrices(e){let{viewMatrix:t=pB,projectionMatrix:n=null,orthographic:i=!1,fovyRadians:o,fovy:a=75,near:l=.1,far:u=1e3,padding:c=null,focalDistance:h=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new Wn().multiplyRight(t).translate(new ci(this.center).negate()),this.projectionMatrix=n||PB({width:this.width,height:this.height,orthographic:i,fovyRadians:o||a*mB,focalDistance:h,padding:c,near:l,far:u});let d=ru();Xi(d,d,this.projectionMatrix),Xi(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=Wc([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=Kx(this.viewMatrixInverse);let m=ru(),P=ru();Yl(m,m,[this.width/2,-this.height/2,1]),Fa(m,m,[1,-1,0]),Xi(P,m,this.viewProjectionMatrix),this.pixelProjectionMatrix=P,this.pixelUnprojectionMatrix=Wc(ru(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Ye.warn("Pixel project matrix not invertible")()}};T(Ua,"displayName","Viewport");var yB=512,SB=4003e4,EB=Math.PI/180;function Zx(s){let e=Math.cos(s*EB);return yB/SB/e}var Rs=class extends Ua{constructor(e={}){let{latitude:t=0,longitude:n=0,zoom:i=0,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:m=0,legacyMeterSizes:P=!1}=e,{width:S,height:v,altitude:I=1.5}=e,L=Math.pow(2,i);S=S||1,v=v||1;let D,w=null;h?(I=h[5]/2,D=Va(I)):(e.fovy?(D=e.fovy,I=Yc(D)):D=Va(I),w=zP({width:S,height:v,pitch:o,fovy:D,nearZMultiplier:l,farZMultiplier:u}));let M=$f({height:v,pitch:o,bearing:a,scale:L,altitude:I});m&&(M=new Wn().translate([512*m,0,0]).multiplyLeft(M));super({...e,width:S,height:v,viewMatrix:M,longitude:n,latitude:t,zoom:i,...w,fovy:D,focalDistance:I});T(this,"longitude",void 0),T(this,"latitude",void 0),T(this,"pitch",void 0),T(this,"bearing",void 0),T(this,"altitude",void 0),T(this,"fovy",void 0),T(this,"orthographic",void 0),T(this,"_subViewports",void 0),T(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=n,this.zoom=i,this.pitch=o,this.bearing=a,this.altitude=I,this.fovy=D,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=P,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),n=Math.ceil((e[2]-180)/360);for(let i=t;i<=n;i++){let o=i?new Rs({...this,worldOffset:i}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,n]=this.projectFlat(e),i=(e[2]||0)*Zx(e[1]);return[t,n,i]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,n]=this.unprojectFlat(e),i=(e[2]||0)/Zx(n);return[t,n,i]}addMetersToLngLat(e,t){return Xc(e,t)}panByPosition(e,t){let n=$l(t,this.pixelUnprojectionMatrix),i=this.projectFlat(e),o=IP([],i,sx([],n)),a=IP([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=Qc(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:n,height:i}=this,{longitude:o,latitude:a,zoom:l}=Kc({width:n,height:i,bounds:e,...t});return new Rs({width:n,height:i,longitude:o,latitude:a,zoom:l})}};T(Rs,"displayName","WebMercatorViewport");function HP(s,e,t=!1){let n=e.projectPosition(s);if(t&&e instanceof Rs){let[i,o,a=0]=s,l=e.getDistanceScales([i,o]);n[2]=a*l.unitsPerMeter[2]}return n}function CB(s){let{viewport:e,modelMatrix:t,coordinateOrigin:n}=s,{coordinateSystem:i,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return i===ke.DEFAULT&&(i=e.isGeospatial?ke.LNGLAT:ke.CARTESIAN),o===void 0&&(o=i),a===void 0&&(a=n),{viewport:e,coordinateSystem:i,coordinateOrigin:n,modelMatrix:t,fromCoordinateSystem:o,fromCoordinateOrigin:a}}function jP(s,{viewport:e,modelMatrix:t,coordinateSystem:n,coordinateOrigin:i,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=Bo([],[a,l,u,1],t)),n){case ke.LNGLAT:return HP([a,l,u],e,o);case ke.LNGLAT_OFFSETS:return HP([a+i[0],l+i[1],u+(i[2]||0)],e,o);case ke.METER_OFFSETS:return HP(Xc(i,[a,l,u]),e,o);case ke.CARTESIAN:default:return e.isGeospatial?[a+i[0],l+i[1],u+i[2]]:e.projectPosition([a,l,u])}}function $x(s,e){let{viewport:t,coordinateSystem:n,coordinateOrigin:i,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=CB(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=DP(t,n,i),d=jP(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let m=t.projectPosition(u||c);Px(d,d,m)}return d}var eA={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},nu=Symbol.for("component"),Go=Symbol.for("asyncPropDefaults"),Qi=Symbol.for("asyncPropOriginal"),gi=Symbol.for("asyncPropResolved");function tA(s,e=()=>!0){return Array.isArray(s)?rA(s,e,[]):e(s)?[s]:[]}function rA(s,e,t){let n=-1;for(;++n<s.length;){let i=s[n];Array.isArray(i)?rA(i,e,t):e(i)&&t.push(i)}return t}function nA({target:s,source:e,start:t=0,count:n=1}){let i=e.length,o=n*i,a=0;for(let l=t;a<i;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}function qP(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let n=s[t],i=e[t];if(!(n===i||Array.isArray(n)&&Array.isArray(i)&&qP(n,i)))return!1}return!0}function mi(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}var Ji=class{constructor(e){T(this,"_inProgress",void 0),T(this,"_handle",void 0),T(this,"_timeline",void 0),T(this,"time",void 0),T(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,n;this.cancel(),this.settings=e,this._inProgress=!0,(t=(n=this.settings).onStart)===null||t===void 0||t.call(n,this)}end(){if(this._inProgress){var e,t;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(t=this.settings).onEnd)===null||e===void 0||e.call(t,this)}}cancel(){if(this._inProgress){var e,t;(e=(t=this.settings).onInterrupt)===null||e===void 0||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:n,settings:i}=this;this._handle=n.addChannel({delay:n.getTime(),duration:i.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(t=this.settings).onUpdate)===null||e===void 0||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var iu=class{constructor(e,t){T(this,"opts",void 0),T(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:n}=this.source,{size:i}=t,o=n;if(n&&n.length!==i){o=new Float32Array(i);let a=t.elementOffset||0;for(let l=0;l<i;++l)o[l]=n[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function iA(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function tg(s){return s.stride||s.size*s.bytesPerElement}function oA(s,e){e.offset&&Ye.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=tg(s),n=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,i=e.elementOffset||0,o=n*t+i*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function xB(s,e){let t=oA(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var rg=class{constructor(e,t,n){T(this,"gl",void 0),T(this,"id",void 0),T(this,"size",void 0),T(this,"settings",void 0),T(this,"value",void 0),T(this,"doublePrecision",void 0),T(this,"_buffer",void 0),T(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;let i=t.logicalType||t.type,o=i===5130,{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0);let l;o?l=5126:!i&&t.isIndexed?l=e&&Bc(e,ut.ELEMENT_INDEX_UINT32)?5125:5123:l=i||5126;let u=iA(i||l||5126);this.doublePrecision=o,o&&t.fp64===!1&&(u=Float32Array),this.value=null,this.settings={...t,defaultType:u,defaultValue:a,logicalType:i,type:l,size:this.size,bytesPerElement:u.BYTES_PER_ELEMENT},this.state={...n,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new ve(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*tg(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),ka.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let n={},i=this.value instanceof Float64Array,o=xB(this.getAccessor(),t||{});return n[e]=new iu(this,o.high),n["".concat(e,"64Low")]=i?new iu(this,o.low):new Float32Array(this.size),n}if(t){let n=oA(this.getAccessor(),t);return{[e]:new iu(this,n)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:n,size:i}=this,o=n*i;if(t&&o&&t.length>=o){let a=new Array(i).fill(1/0),l=new Array(i).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<i;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this,n;ArrayBuffer.isView(e)?n={value:e}:e instanceof ve?n={buffer:e}:n=e;let i={...this.settings,...n};if(t.bufferAccessor=i,t.bounds=null,n.constant){let o=n.value;if(o=this._normalizeValue(o,[],0),this.settings.normalized&&(o=this.normalizeConstant(o)),!(!t.constant||!this._areValuesEqual(o,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=o}else if(n.buffer){let o=n.buffer;t.externalBuffer=o,t.constant=!1,this.value=n.value||null;let a=n.value instanceof Float64Array;i.type=n.type||o.accessor.type,i.bytesPerElement=o.accessor.BYTES_PER_ELEMENT*(a?2:1),i.stride=tg(i)}else if(n.value){this._checkExternalBuffer(n);let o=n.value;t.externalBuffer=null,t.constant=!1,this.value=o,i.bytesPerElement=o.BYTES_PER_ELEMENT,i.stride=tg(i);let{buffer:a,byteOffset:l}=this;this.doublePrecision&&o instanceof Float64Array&&(o=eg(o,i));let u=o.byteLength+l+i.stride*2;a.byteLength<u&&a.reallocate(u),a.setAccessor(null),a.subData({data:o,offset:l}),i.type=n.type||a.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:n=0,endOffset:i}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?eg(t,{size:this.size,startIndex:n,endIndex:i}):t.subarray(n,i),offset:n*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){let{state:n}=this,i=n.allocatedValue,o=ka.allocate(i,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&i&&a.subData({data:i instanceof Float64Array?eg(i,this):i,offset:l})),n.allocatedValue=o,n.constant=!1,n.externalBuffer=null,n.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));let n=this.settings.defaultType,i=!1;if(this.doublePrecision&&(i=t.BYTES_PER_ELEMENT<4),i)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof n)&&this.settings.normalized&&!("normalized"in e)&&Ye.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,n){let{defaultValue:i,size:o}=this.settings;if(Number.isFinite(e))return t[n]=e,t;if(!e)return t[n]=i[0],t;switch(o){case 4:t[n+3]=Number.isFinite(e[3])?e[3]:i[3];case 3:t[n+2]=Number.isFinite(e[2])?e[2]:i[2];case 2:t[n+1]=Number.isFinite(e[1])?e[1]:i[1];case 1:t[n+0]=Number.isFinite(e[0])?e[0]:i[0];break;default:let a=o;for(;--a>=0;)t[n+a]=Number.isFinite(e[a])?e[a]:i[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:n}=this;for(let i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0}};var sA=[],aA=[];function Mo(s,e=0,t=1/0){let n=sA,i={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?n=s:s.length>0&&(aA.length=s.length,n=aA):n=sA,(e>0||Number.isFinite(t))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,t),i.index=e-1),{iterable:n,objectInfo:i}}function ng(s){return s&&s[Symbol.asyncIterator]}function lA(s,e){let{size:t,stride:n,offset:i,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=n?n/l:t,c=i?i/l:0,h=Math.floor((s.length-c)/u);return(d,{index:m,target:P})=>{if(!o){let L=m*u+c;for(let D=0;D<t;D++)P[D]=s[L+D];return P}let S=o[m],v=o[m+1]||h,I;if(a){I=new Array(v-S);for(let L=S;L<v;L++){let D=L*u+c;P=new Array(t);for(let w=0;w<t;w++)P[w]=s[D+w];I[L-S]=P}}else if(u===t)I=s.subarray(S*t+c,v*t+c);else{I=new s.constructor((v-S)*t);let L=0;for(let D=S;D<v;D++){let w=D*u+c;for(let M=0;M<t;M++)I[L++]=s[w+M]}}return I}}var uA=[],Zc=[[0,1/0]];function cA(s,e){if(s===Zc||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],n=s.length,i=0;for(let o=0;o<n;o++){let a=s[o];a[1]<e[0]?(t.push(a),i=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(i,0,e),t}function XP(s){let{source:e,target:t,start:n=0,size:i,getData:o}=s,a=s.end||t.length,l=e.length,u=a-n;if(l>u){t.set(e.subarray(0,u),n);return}if(t.set(e,n),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<i;d++)t[n+c]=h[d]||0,c++}}function hA({source:s,target:e,size:t,getData:n,sourceStartIndices:i,targetStartIndices:o}){if(!Array.isArray(o))return XP({source:s,target:e,size:t,getData:n}),e;let a=0,l=0,u=n&&((h,d)=>n(h+l,d)),c=Math.min(i.length,o.length);for(let h=1;h<c;h++){let d=i[h]*t,m=o[h]*t;XP({source:s.subarray(a,d),target:e,start:l,end:m,size:t,getData:u}),a=d,l=m}return l<e.length&&XP({source:[],target:e,start:l,size:t,getData:u}),e}var vB={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function ig(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});let t=s.type||"interpolation";return{...vB[t],...e,...s,type:t}}function og(s,e){let t=e.getBuffer();return t?[t,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function sg(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function ag(s){s.push(s.shift())}function $c(s,e){let{doublePrecision:t,settings:n,value:i,size:o}=s,a=t&&i instanceof Float64Array?2:1;return(n.noAlloc?i.length:e*o)*a}function lg({buffer:s,numInstances:e,attribute:t,fromLength:n,fromStartIndices:i,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=i&&c,d=$c(t,e),m=t.isConstant;if(!h&&n>=d)return;let P=m?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!m){let L=o;o=(D,w)=>t.normalizeConstant(L(D,w))}let S=m?(L,D)=>o(P,D):(L,D)=>o(P.subarray(L,L+l),D),v=s.getData({length:n}),I=new Float32Array(d);hA({source:v,target:I,sourceStartIndices:i,targetStartIndices:c,size:l,getData:S}),s.byteLength<I.byteLength+u&&s.reallocate(I.byteLength+u),s.subData({data:I,offset:u})}var Bs=class extends rg{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:Zc});T(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,n=this.settings.transition,i=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return ig(i,n)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:n=0,endRow:i=1/0}=t;this.state.updateRanges=cA(this.state.updateRanges,[n,i])}else this.state.updateRanges=Zc}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=uA}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:n}=this;return n.noAlloc?!1:n.update?(super.allocate(e,t.updateRanges!==Zc),!0):!1}updateBuffer({numInstances:e,data:t,props:n,context:i}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(i,this,{data:t,startRow:c,endRow:h,props:n,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,m=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:m})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:n,settings:i}=this;if(!e)return n.binaryValue=null,n.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(n.binaryValue===e)return this.clearNeedsUpdate(),!0;if(n.binaryValue=e,this.setNeedsRedraw(),i.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let a=e;mi(ArrayBuffer.isView(a.value),"invalid ".concat(i.accessor));let l=Boolean(a.size)&&a.size!==this.size;return n.binaryAccessor=lA(a.value,{size:a.size||this.size,stride:a.stride,offset:a.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let n in e)Object.assign(t,super.getShaderAttributes(n,e[n]));return t}_autoUpdater(e,{data:t,startRow:n,endRow:i,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:m,transform:P}=l,S=u.binaryAccessor||(typeof m=="function"?m:o[m]);mi(typeof S=="function",'accessor "'.concat(m,'" is not a function'));let v=e.getVertexOffset(n),{iterable:I,objectInfo:L}=Mo(t,n,i);for(let D of I){L.index++;let w=S(D,L);if(P&&(w=P.call(this,w)),d){let M=(L.index<d.length-1?d[L.index+1]:a)-d[L.index];if(w&&Array.isArray(w[0])){let K=v;for(let X of w)e._normalizeValue(X,c,K),K+=h}else w&&w.length>h?c.set(w,v):(e._normalizeValue(w,L.target,0),nA({target:c,source:L.target,start:v,count:M}));v+=M*h}else e._normalizeValue(w,c,v),v+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let n=!0;switch(t){case 4:n=n&&Number.isFinite(e[3]);case 3:n=n&&Number.isFinite(e[2]);case 2:n=n&&Number.isFinite(e[1]);case 1:n=n&&Number.isFinite(e[0]);break;default:n=!1}if(!n)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var ug=class{constructor({gl:e,attribute:t,timeline:n}){T(this,"gl",void 0),T(this,"type","interpolation"),T(this,"attributeInTransition",void 0),T(this,"settings",void 0),T(this,"attribute",void 0),T(this,"transition",void 0),T(this,"currentStartIndices",void 0),T(this,"currentLength",void 0),T(this,"transform",void 0),T(this,"buffers",void 0),this.gl=e,this.transition=new Ji(n),this.attribute=t,this.attributeInTransition=new Bs(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=IB(e,t);let i={byteLength:0,usage:35050};this.buffers=[new ve(e,i),new ve(e,i)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}this.settings=e;let{gl:n,buffers:i,attribute:o}=this;ag(i);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of i)lg({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=$c(o,t),this.attributeInTransition.setData({buffer:i[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:i[0],aTo:og(n,o)},feedbackBuffers:{vCurrent:i[1]}})}update(){let e=this.transition.update();if(e){let{duration:t,easing:n}=this.settings,{time:i}=this.transition,o=i/t;n&&(o=n(o)),this.transform.run({uniforms:{time:o}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0}},TB=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function IB(s,e){let t=sg(e.size);return new Yi(s,{vs:TB,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var cg=class{constructor({gl:e,attribute:t,timeline:n}){T(this,"gl",void 0),T(this,"type","spring"),T(this,"attributeInTransition",void 0),T(this,"settings",void 0),T(this,"attribute",void 0),T(this,"transition",void 0),T(this,"currentStartIndices",void 0),T(this,"currentLength",void 0),T(this,"texture",void 0),T(this,"framebuffer",void 0),T(this,"transform",void 0),T(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new Ji(n),this.attribute=t,this.attributeInTransition=new Bs(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=LB(e),this.framebuffer=OB(e,this.texture),this.transform=wB(e,t,this.framebuffer);let i={byteLength:0,usage:35050};this.buffers=[new ve(e,i),new ve(e,i),new ve(e,i)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:n,buffers:i,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of i)lg({buffer:l,...a});this.settings=e,this.currentStartIndices=o.startIndices,this.currentLength=$c(o,t),this.attributeInTransition.setData({buffer:i[1],value:o.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:og(n,o)}})}update(){let{buffers:e,transform:t,framebuffer:n,transition:i}=this;if(!i.update())return!1;let a=this.settings;return t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:n,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:a.stiffness,damping:a.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),ag(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),Na(n)[0]>0||i.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}};function wB(s,e,t){let n=sg(e.size);return new Yi(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:n},varyings:["vNext"]})}function LB(s){return new Dt(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function OB(s,e){return new It(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var RB={interpolation:ug,spring:cg},hg=class{constructor(e,{id:t,timeline:n}){T(this,"id",void 0),T(this,"isSupported",void 0),T(this,"gl",void 0),T(this,"timeline",void 0),T(this,"transitions",void 0),T(this,"needsRedraw",void 0),T(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=Yi.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:n}){this.numInstances=n||1;for(let i in e){let o=e[i],a=o.getTransitionSetting(t);!a||this._updateAttribute(i,o,a)}for(let i in this.transitions){let o=e[i];(!o||!o.getTransitionSetting(t))&&this._removeTransition(i)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let n=this.transitions[t];n.inProgress&&(e[t]=n.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,n){let i=this.transitions[e],o=!i||i.type!==n.type;if(o){if(!this.isSupported){Ye.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}i&&this._removeTransition(e);let a=RB[n.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(Ye.error("unsupported transition type '".concat(n.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(n,this.numInstances))}};var dA="attributeManager.invalidate",BB="attributeManager.updateStart",NB="attributeManager.updateEnd",GB="attribute.updateStart",MB="attribute.allocate",DB="attribute.updateEnd",dg=class{constructor(e,{id:t="attribute-manager",stats:n,timeline:i}={}){T(this,"id",void 0),T(this,"gl",void 0),T(this,"attributes",void 0),T(this,"updateTriggers",void 0),T(this,"needsRedraw",void 0),T(this,"userData",void 0),T(this,"stats",void 0),T(this,"attributeTransitionManager",void 0),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new hg(e,{id:"".concat(t,"-transitions"),timeline:i}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(let t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let n=this._invalidateTrigger(e,t);xr(dA,this,e,n)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);xr(dA,this,"all")}update({data:e,numInstances:t,startIndices:n=null,transitions:i,props:o={},buffers:a={},context:l={}}){let u=!1;xr(BB,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=n,h.numInstances=t,o[c]&&Ye.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(typeof d=="string"?a[d]:void 0,e.startIndices)||typeof d=="string"&&!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}u&&xr(NB,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:i})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:n}=this,i={...n.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!n.hasAttribute(o)&&(i[o]=a)}return i}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let n={};for(let i in e)t[i]||Object.assign(n,e[i].getShaderAttributes());return n}_add(e,t={}){for(let n in e){let i=e[n];this.attributes[n]=this._createAttribute(n,i,t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,n){let i={...t,id:e,size:t.isIndexed&&1||t.size||1,divisor:n.instanced?1:t.divisor||0};return new Bs(this.gl,i)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(i=>{e[i]||(e[i]=[]),e[i].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:n,updateTriggers:i}=this,o=i[e];return o&&o.forEach(a=>{let l=n[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:n}=e;if(xr(GB,t),t.constant){t.setConstantValue(t.value);return}t.allocate(n)&&xr(MB,t,n),t.updateBuffer(e)&&(this.needsRedraw=!0,xr(DB,t,n))}};var fg=class extends Ji{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:n,duration:i,easing:o}}=this,a=o(e/i);this._value=Gf(t,n,a)}};var fA=1e-5;function gA(s,e,t,n,i){let o=e-s,l=(t-e)*i,u=-o*n;return l+u+o+e}function FB(s,e,t,n,i){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=gA(s[a],e[a],t[a],n,i);return o}return gA(s,e,t,n,i)}function mA(s,e){if(Array.isArray(s)){let t=0;for(let n=0;n<s.length;n++){let i=s[n]-e[n];t+=i*i}return Math.sqrt(t)}return Math.abs(s-e)}var gg=class extends Ji{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:n,stiffness:i}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=FB(o,a,t,n,i),u=mA(l,t),c=mA(l,a);u<fA&&c<fA&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var _B={interpolation:fg,spring:gg},mg=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,n,i){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(i=ig(i),!i)return;let a=_B[i.type];if(!a){Ye.error("unsupported transition type '".concat(i.type,"'"))();return}let l=new a(this.timeline);l.start({...i,fromValue:t,toValue:n}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,n]of this.transitions)n.update(),e[t]=n.value,n.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function bA(s){let e=KP(s);for(let t in e){let n=e[t],{validate:i}=n;if(i&&!i(s[t],n))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function PA(s,e){let t=yA({newProps:s,oldProps:e,propTypes:KP(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=kB(s,e),i=!1;return n||(i=UB(s,e)),{dataChanged:n,propsChanged:t,updateTriggersChanged:i,extensionsChanged:WB(s,e),transitionsChanged:VB(s,e)}}function VB(s,e){if(!s.transitions)return!1;let t={},n=KP(s),i=!1;for(let o in s.transitions){let a=n[o],l=a&&a.type;(l==="number"||l==="color"||l==="array")&&YP(s[o],e[o],a)&&(t[o]=!0,i=!0)}return i?t:!1}function yA({newProps:s,oldProps:e,ignoreProps:t={},propTypes:n={},triggerName:i="props"}){if(e===s)return!1;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(i," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(i,".").concat(o," added");let a=YP(s[o],e[o],n[o]);if(a)return"".concat(i,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(i,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=YP(s[o],e[o],n[o]);if(a)return"".concat(i,".").concat(o," ").concat(a)}}return!1}function YP(s,e,t){let n=t&&t.equal;return n&&!n(s,e,t)||!n&&(n=s&&e&&s.equals,n&&!n.call(s,e))?"changed deeply":!n&&e!==s?"changed shallowly":null}function kB(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1,{dataComparator:n,_dataDiff:i}=s;return n?n(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&i&&(t=i(s.data,e.data)||t),t}function UB(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&pA(s,e,"all"))return{all:!0};let t={},n=!1;for(let i in s.updateTriggers)i!=="all"&&pA(s,e,i)&&(t[i]=!0,n=!0);return n?t:!1}function WB(s,e){if(e===null)return!0;let t=e.extensions,{extensions:n}=s;if(n===t)return!1;if(!t||!n||n.length!==t.length)return!0;for(let i=0;i<n.length;i++)if(!n[i].equals(t[i]))return!0;return!1}function pA(s,e,t){let n=s.updateTriggers[t];n=n??{};let i=e.updateTriggers[t];return i=i??{},yA({oldProps:i,newProps:n,triggerName:t})}function KP(s){let e=s[nu],t=e&&e.constructor;return t?t._propTypes:{}}var zB="count(): argument not an object",HB="count(): argument not a container";function SA(s){if(!qB(s))throw new Error(zB);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(jB(s))return Object.keys(s).length;throw new Error(HB)}function jB(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function qB(s){return s!==null&&typeof s=="object"}function EA(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(n=>n.name==="project64"))){let n=t.modules.findIndex(i=>i.name==="project32");n>=0&&t.modules.splice(n,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let n={...s.inject};for(let i in e.inject)n[i]=(n[i]||"")+e.inject[i];t.inject=n}return t}var XB={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},QP={};function CA(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Dt)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let n=null;e.compressed&&(n={[10241]:e.data.length>1?9985:9729});let i=new Dt(t,{...e,parameters:{...XB,...n,...s.props.textureParameters}});return QP[i.id]=!0,i}function xA(s){!s||!(s instanceof Dt)||QP[s.id]&&(s.delete(),delete QP[s.id])}var YB={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||th(s)&&(s.length===3||s.length===4)},equal(s,e,t){return JP(s,e)}},accessor:{validate(s,e){let t=pg(s);return t==="function"||t===pg(e.value)},equal(s,e,t){return typeof e=="function"?!0:JP(s,e)}},array:{validate(s,e){return e.optional&&!s||th(s)},equal(s,e,t){return t.compare?JP(s,e):s===e}},object:{equal(s,e,t){return t.compare?qP(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:n}=t.props;return n&&s?n(s):s}},image:{transform:(s,e,t)=>CA(t,s),release:s=>{xA(s)}}};function JP(s,e){if(s===e)return!0;if(!th(s)||!th(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}function AA(s){let e={},t={},n={};for(let[i,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)n[i]=Array.isArray(a)?a:[a];else{let l=KB(i,o);e[i]=l,t[i]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:n}}function KB(s,e){switch(pg(e)){case"object":return eh(s,e);case"array":return eh(s,{type:"array",value:e,compare:!1});case"boolean":return eh(s,{type:"boolean",value:e});case"number":return eh(s,{type:"number",value:e});case"function":return eh(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function eh(s,e){return"type"in e?{name:s,...YB[e.type],...e}:"value"in e?{name:s,type:pg(e.value),...e}:{name:s,type:"object",value:e}}function th(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function pg(s){return th(s)?"array":s===null?"null":typeof s}function vA(s,e){let t=TA(s.constructor),n=Object.create(t);n[nu]=s,n[Qi]={},n[gi]={};for(let i=0;i<e.length;++i){let o=e[i];for(let a in o)n[a]=o[a]}return Object.freeze(n),n}function TA(s){let e=bg(s,"_mergedDefaultProps");return e||(QB(s),s._mergedDefaultProps)}function QB(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),n=TA(t),i=bg(s,"defaultProps")||{},o=AA(i),a=JB(o.defaultProps,n,s),l={...t._propTypes,...o.propTypes};$B(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};ZB(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function JB(s,e,t){let n=Object.create(null);Object.assign(n,e,s);let i=tN(t);return delete s.id,Object.defineProperties(n,{id:{writable:!0,value:i}}),n}function ZB(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(n){let i="".concat(this.id,": ").concat(t);for(let o of e[t])IA(this,o)||(this[o]=n);Ye.deprecated(i,e[t].join("/"))()}})}function $B(s,e){let t={},n={};for(let i in e){let o=e[i],{name:a,value:l}=o;o.async&&(t[a]=l,n[a]=eN(a))}s[Go]=t,s[Qi]={},Object.defineProperties(s,n)}function eN(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||ng(e)?this[Qi][s]=e:this[gi][s]=e},get(){if(this[gi]){if(s in this[gi])return this[gi][s]||this[Go][s];if(s in this[Qi]){let e=this[nu]&&this[nu].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[Go][s]}}return this[Go][s]}}}function IA(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function bg(s,e){return IA(s,e)&&s[e]}function tN(s){let e=bg(s,"layerName")||bg(s,"componentName");return e||Ye.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var rN=0,ou=class{constructor(...e){T(this,"id",void 0),T(this,"props",void 0),T(this,"count",void 0),this.props=vA(this,e),this.id=this.props.id,this.count=rN++}clone(e){let{props:t}=this,n={};for(let i in t[Go])i in t[gi]?n[i]=t[gi][i]:i in t[Qi]&&(n[i]=t[Qi][i]);return new this.constructor({...t,...n,...e})}};T(ou,"componentName","Component");T(ou,"defaultProps",{});var nN=Object.freeze({}),Pg=class{constructor(e){T(this,"component",void 0),T(this,"onAsyncPropUpdated",void 0),T(this,"asyncProps",void 0),T(this,"oldProps",void 0),T(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||nN}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[gi]||{},n=e[Qi]||e,i=e[Go]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,i[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in n){let a=n[o];this._createAsyncPropData(o,i[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(ng(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let n=this.asyncProps[e];return t===n.resolvedValue||t===n.lastValue?!1:(n.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let n=this.asyncProps[e];n&&(t=this._postProcessValue(n,t),n.resolvedValue=t,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(e,t,n){let i=this.asyncProps[e];i&&n>=i.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),i.resolvedValue=t,i.resolvedLoadCount=n,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let n=this.asyncProps[e];if(n){n.pendingLoadCount++;let i=n.pendingLoadCount;t.then(o=>{o=this._postProcessValue(n,o),this._setAsyncPropValue(e,o,i),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let n=this.asyncProps[e];if(!n)return;n.pendingLoadCount++;let i=n.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,i)}this._onResolve(e,o)}_postProcessValue(e,t){let n=e.type;return n&&(n.release&&n.release(e.resolvedValue,n,this.component),n.transform)?n.transform(t,n,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let i=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:i&&i[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var yg=class extends Pg{constructor({attributeManager:e,layer:t}){super(t);T(this,"attributeManager",void 0),T(this,"needsRedraw",void 0),T(this,"needsUpdate",void 0),T(this,"subLayers",void 0),T(this,"usesPickingColorCache",void 0),T(this,"changeFlags",void 0),T(this,"viewport",void 0),T(this,"uniformTransitions",void 0),T(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let n=this.component.props.fetch;return n?n(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let n=this.component.props.onDataLoad;e==="data"&&n&&n(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var iN="layer.changeFlag",oN="layer.initialize",sN="layer.update",aN="layer.finalize",lN="layer.matched",wA=2**24-1,uN=Object.freeze([]),cN=zc(({oldViewport:s,viewport:e})=>s.equals(e)),Zi=new Uint8ClampedArray(0),hN={data:{type:"data",value:uN,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:n,loadOptions:i,signal:o})=>{let{resourceManager:a}=t.context;if(i=i||t.getLoadOptions(),n=n||t.props.loaders,o){var l;i={...i,fetch:{...(l=i)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!i&&(a.add({resourceId:s,data:Fl(s,n),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>{var h;return(h=t.internalState)===null||h===void 0?void 0:h.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):Fl(s,n,i)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:MP.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:ke.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},on=class extends ou{constructor(...e){super(...e);T(this,"internalState",null),T(this,"lifecycle",eA.NO_STATE),T(this,"context",void 0),T(this,"state",void 0),T(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){mi(this.internalState);let t=this.internalState.viewport||this.context.viewport,n=jP(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,o,a]=Zl(n,t.pixelProjectionMatrix);return e.length===2?[i,o]:[i,o,a]}unproject(e){return mi(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){mi(this.internalState);let n=this.internalState.viewport||this.context.viewport;return $x(e,{viewport:n,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===ke.DEFAULT||e===ke.LNGLAT||e===ke.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){mi(e instanceof Uint8Array);let[t,n,i]=e;return t+n*256+i*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:SA(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:n,instancePositions:i}=t.attributes;return(e=n||i)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(let t of this.props.extensions)e=EA(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:n}=e.changeFlags;if(n&&t)if(Array.isArray(n))for(let u of n)t.invalidateAll(u);else t.invalidateAll();let{props:i,oldProps:o}=e,a=Number.isInteger(o.highlightedObjectIndex)||o.pickable,l=Number.isInteger(i.highlightedObjectIndex)||i.pickable;if(a!==l&&t){let{pickingColors:u,instancePickingColors:c}=t.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,t.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(e){for(let n of this.getModels())n.delete();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:n}){let{index:i}=e;return i>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[i]),e}raiseError(e,t){var n,i;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((n=(i=this.props).onError)!==null&&n!==void 0&&n.call(i,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!cN({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();!t||(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,n=this.getNumInstances(),i=this.getStartIndices();e.update({data:t.data,numInstances:n,startIndices:i,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),n=Object.create(this.props);for(let i in t)Object.defineProperty(n,i,{value:t[i]});return n}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let n=Math.floor(Zi.length/3);if(this.internalState.usesPickingColorCache=!0,n<t){t>wA&&Ye.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Zi=ka.allocate(Zi,t,{size:3,copy:!0,maxCount:Math.max(t,wA)});let i=Math.floor(Zi.length/3),o=[];for(let a=n;a<i;a++)this.encodePickingColor(a,o),Zi[a*3+0]=o[0],Zi[a*3+1]=o[1],Zi[a*3+2]=o[2]}e.value=Zi.subarray(0,t*3)}_setModelAttributes(e,t){let n=this.getAttributeManager(),i=e.userData.excludeAttributes||{},o=n.getShaderAttributes(t,i);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:n}=this.getAttributeManager().attributes,i=t||n;if(!i)return;let o=i.getVertexOffset(e),a=i.getVertexOffset(e+1);i.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,n=e||t;!n||(this.internalState.usesPickingColorCache&&n.value.buffer!==Zi.buffer&&(n.value=Zi.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0}))}_initialize(){mi(!this.internalState),mi(Number.isFinite(this.props.coordinateSystem)),xr(oN,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new yg({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Ye.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new mg(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){xr(lN,this,this===e);let{state:t,internalState:n}=e;this!==e&&(this.internalState=n,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(xr(sN,this,e),!e)return;let t=this.props,n=this.context,i=this.internalState,o=n.viewport,a=this._updateUniformTransition();i.propsInTransition=a,n.viewport=i.viewport||o,this.props=a;try{let l=this._getUpdateParams(),u=this.getModels();if(n.gl)this.updateState(l);else try{this.updateState(l)}catch{}for(let h of this.props.extensions)h.updateState.call(this,l,h);let c=this.getModels()[0]!==u[0];this._postUpdate(l,c)}finally{n.viewport=o,this.props=t,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){xr(aN,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:n={}}){this._updateAttributeTransition();let i=this.props,o=this.context;this.props=this.internalState.propsInTransition||i;let a=this.props.opacity;t.opacity=Math.pow(a,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:l}=this.props,u=l&&l(t)||[0,0];Oa(o.gl,{polygonOffset:u}),Ar(o.gl,n,()=>{let c={moduleParameters:e,uniforms:t,parameters:n,context:o};for(let h of this.props.extensions)h.draw.call(this,c,h);this.draw(c)})}finally{this.props=i}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let i in e)if(e[i]){let o=!1;switch(i){case"dataChanged":let a=e[i],l=t[i];a&&Array.isArray(l)&&(t.dataChanged=Array.isArray(a)?l.concat(a):a,o=!0);default:t[i]||(t[i]=e[i],o=!0)}o&&xr(iN,this,i,e)}let n=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=n,t.somethingChanged=n||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let n=PA(e,t);if(n.updateTriggersChanged)for(let o in n.updateTriggersChanged)n.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(n.transitionsChanged)for(let o in n.transitionsChanged){var i;this.internalState.uniformTransitions.add(o,t[o],e[o],(i=e.transitions)===null||i===void 0?void 0:i[o])}return this.setChangeFlags(n)}validateProps(){bA(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:n}=this.props;e.picked&&typeof n=="function"&&(t.pickingHighlightColor=n(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new dg(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:n,oldProps:i}=e;this.setNeedsRedraw(),this._updateAttributes();let{model:o}=this.state;o?.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:l,highlightColor:u}=n;if(t||i.autoHighlight!==a||i.highlightedObjectIndex!==l||i.highlightColor!==u){let c={};a||(c.pickingSelectedColor=null),Array.isArray(u)&&(c.pickingHighlightColor=u),Number.isInteger(l)&&(c.pickingSelectedColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setModuleParameters(c)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let n=this.getAttributeManager(),i=n?n.getNeedsRedraw(e):!1;return t=t||i,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};T(on,"defaultProps",hN);T(on,"layerName","Layer");var dN="compositeLayer.renderLayers",Xn=class extends on{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:n}=this.props;return n&&n[e]&&n[e].type||t}getSubLayerRow(e,t,n){return e.__source={parent:this,object:t,index:n},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={index:-1,data:this.props.data,target:[]};return(n,i)=>n&&n.__source?(t.index=n.__source.index,e(n.__source.object,t)):e(n,i)}return e}getSubLayerProps(e={}){var t;let{opacity:n,pickable:i,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:m,wrapLongitude:P,positionFormat:S,modelMatrix:v,extensions:I,fetch:L,operation:D,_subLayerProps:w}=this.props,M={id:"",updateTriggers:{},opacity:n,pickable:i,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:m,wrapLongitude:P,positionFormat:S,modelMatrix:v,extensions:I,fetch:L,operation:D},K=w&&e.id&&w[e.id],X=K&&K.updateTriggers,se=e.id||"sublayer";if(K){let Te=this.constructor._propTypes,pe=e.type?e.type._propTypes:{};for(let G in K){let O=pe[G]||Te[G];O&&O.type==="accessor"&&(K[G]=this.getSubLayerAccessor(K[G]))}}Object.assign(M,e,K),M.id="".concat(this.props.id,"-").concat(se),M.updateTriggers={all:(t=this.props.updateTriggers)===null||t===void 0?void 0:t.all,...e.updateTriggers,...X};for(let Te of I){let pe=Te.getSubLayerProps.call(this,Te);pe&&Object.assign(M,pe,{updateTriggers:Object.assign(M.updateTriggers,pe.updateTriggers)})}return M}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let n=this.internalState.subLayers,i=!n||this.needsUpdate();if(i){let o=this.renderLayers();n=tA(o,Boolean),this.internalState.subLayers=n}xr(dN,this,i,n);for(let o of n)o.parent=this}};T(Xn,"layerName","CompositeLayer");var LA=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var OA=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var fN=1024,gN=4,RA=()=>{},BA={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function mN(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function pN(s,e,t,n){return t===e.width&&n===e.height?e:(s.canvas.height=n,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,n),s.canvas)}function rh(s){return s&&(s.id||s.url)}function bN(s,e,t,n){let i=s.width,o=s.height,a=new Dt(s.gl,{width:e,height:t,parameters:n});return Pf(s,a,{targetY:0,width:i,height:o}),s.delete(),a}function NA(s,e,t){for(let n=0;n<e.length;n++){let{icon:i,xOffset:o}=e[n],a=rh(i);s[a]={...i,x:o,y:t}}}function PN({icons:s,buffer:e,mapping:t={},xOffset:n=0,yOffset:i=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=rh(c);if(!t[h]){let{height:d,width:m}=c;n+m+e>a&&(NA(t,l,i),n=0,i=o+i+e,o=0,l=[]),l.push({icon:c,xOffset:n}),n=n+m+e,o=Math.max(o,d)}}return l.length>0&&NA(t,l,i),{mapping:t,rowHeight:o,xOffset:n,yOffset:i,canvasWidth:a,canvasHeight:mN(o+i+e)}}function yN(s,e,t){if(!s||!e)return null;t=t||{};let n={},{iterable:i,objectInfo:o}=Mo(s);for(let a of i){o.index++;let l=e(a,o),u=rh(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!n[u]&&(!t[u]||l.url!==t[u].url)&&(n[u]={...l,source:a,sourceIndex:o.index})}return n}var Sg=class{constructor(e,{onUpdate:t=RA,onError:n=RA}){T(this,"gl",void 0),T(this,"onUpdate",void 0),T(this,"onError",void 0),T(this,"_loadOptions",null),T(this,"_texture",null),T(this,"_externalTexture",null),T(this,"_mapping",{}),T(this,"_textureParameters",null),T(this,"_pendingCount",0),T(this,"_autoPacking",!1),T(this,"_xOffset",0),T(this,"_yOffset",0),T(this,"_rowHeight",0),T(this,"_buffer",gN),T(this,"_canvasWidth",fN),T(this,"_canvasHeight",0),T(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=n}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?rh(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:n,iconMapping:i,textureParameters:o}){if(e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),i&&(this._mapping=i),n){var a;(a=this._texture)===null||a===void 0||a.delete(),this._texture=null,this._externalTexture=n}o&&(this._textureParameters=o)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;let n=Object.values(yN(e,t,this._mapping)||{});if(n.length>0){let{mapping:i,xOffset:o,yOffset:a,rowHeight:l,canvasHeight:u}=PN({icons:n,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=i,this._xOffset=o,this._yOffset=a,this._canvasHeight=u,this._texture||(this._texture=new Dt(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||BA})),this._texture.height!==this._canvasHeight&&(this._texture=bN(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||BA)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(n)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let n of e)this._pendingCount++,Fl(n.url,jb,this._loadOptions).then(i=>{let o=rh(n),{x:a,y:l,width:u,height:c}=this._mapping[o],h=pN(t,i,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(i=>{this.onError({url:n.url,source:n.source,sourceIndex:n.sourceIndex,loadOptions:this._loadOptions,error:i})}).finally(()=>{this._pendingCount--})}};var GA=[0,0,0,255],SN={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:GA},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},Do=class extends on{constructor(...e){super(...e);T(this,"state",void 0)}getShaders(){return super.getShaders({vs:LA,fs:OA,modules:[Ki,eu]})}initializeState(){this.state={iconManager:new Sg(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:GA},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:n,changeFlags:i}=e,o=this.getAttributeManager(),{iconAtlas:a,iconMapping:l,data:u,getIcon:c,textureParameters:h}=t,{iconManager:d}=this.state,m=a||this.internalState.isAsyncPropLoading("iconAtlas");if(d.setProps({loadOptions:t.loadOptions,autoPacking:!m,iconAtlas:a,iconMapping:m?l:null,textureParameters:h}),m?n.iconMapping!==t.iconMapping&&o.invalidate("getIcon"):(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getIcon))&&d.packIcons(u,c),i.extensionsChanged){var P;let{gl:S}=this.context;(P=this.state.model)===null||P===void 0||P.delete(),this.state.model=this._getModel(S),o.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:jn[o],sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new cn(e,{...this.getShaders(),id:this.props.id,geometry:new zn({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;let n=(t=this.getCurrentLayer())===null||t===void 0?void 0:t.props.onIconError;n?n(e):Ye.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:n,anchorX:i=t/2,anchorY:o=n/2}=this.state.iconManager.getIconMapping(e);return[t/2-i,n/2-o]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let{x:t,y:n,width:i,height:o}=this.state.iconManager.getIconMapping(e);return[t,n,i,o]}};T(Do,"defaultProps",SN);T(Do,"layerName","IconLayer");var MA=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var DA=192/256,FA=[],EN={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},su=class extends Do{constructor(...e){super(...e);T(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:MA}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:n,target:i})=>this.encodePickingColor(n,i)}})}updateState(e){super.updateState(e);let{props:t,oldProps:n}=e,{outlineColor:i}=t;i!==n.outlineColor&&(i=i.map(o=>o/255),i[3]=Number.isFinite(i[3])?i[3]:1,this.setState({outlineColor:i})),!t.sdf&&t.outlineWidth&&Ye.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:n,outlineWidth:i}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:DA,outlineBuffer:i?Math.max(n,DA*(1-i)):-1,gamma:n,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):FA}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):FA}};T(su,"defaultProps",EN);T(su,"layerName","MultiIconLayer");var YA=Ae(kA());var AN=32,vN=[];function TN(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function UA({characterSet:s,getFontWidth:e,fontHeight:t,buffer:n,maxCanvasWidth:i,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a;for(let d of s)if(!o[d]){let m=e(d);c+m+n*2>i&&(c=0,u++),o[d]={x:c+n,y:l+u*(t+n*2)+n,width:m,height:t},c+=m+n*2}let h=t+n*2;return{mapping:o,xOffset:c,yOffset:l+u*h,canvasHeight:TN(l+(u+1)*h)}}function WA(s,e,t,n){let i=0;for(let a=e;a<t;a++){var o;let l=s[a];i+=((o=n[l])===null||o===void 0?void 0:o.width)||0}return i}function zA(s,e,t,n,i,o){let a=e,l=0;for(let u=e;u<t;u++){let c=WA(s,u,u+1,i);l+c>n&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function IN(s,e,t,n,i,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=WA(s,l,u,i);c+d>n&&(a<l&&(o.push(l),a=l,c=0),d>n&&(d=zA(s,l,u,n,i,o),a=o[o.length-1])),l=u,c+=d}return c}function wN(s,e,t,n,i=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?zA(s,i,o,t,n,a):IN(s,i,o,t,n,a),a}function LN(s,e,t,n,i,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=n[c];h?(l||(l=h.height),i[u]=a+h.width/2,a+=h.width):(Ye.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),i[u]=a,a+=AN)}o[0]=a,o[1]=l}function $P(s,e,t,n,i){let o=Array.from(s),a=o.length,l=new Array(a),u=new Array(a),c=new Array(a),h=(t==="break-word"||t==="break-all")&&isFinite(n)&&n>0,d=[0,0],m=[0,0],P=0,S=0,v=0;for(let I=0;I<=a;I++){let L=o[I];if((L===`
`||I===a)&&(v=I),v>S){let D=h?wN(o,t,n,i,S,v):vN;for(let w=0;w<=D.length;w++){let M=w===0?S:D[w-1],K=w<D.length?D[w]:v;LN(o,M,K,i,l,m);for(let X=M;X<K;X++)u[X]=P+m[1]/2,c[X]=m[0];P=P+m[1]*e,d[0]=Math.max(d[0],m[0])}S=v}L===`
`&&(l[S]=0,u[S]=0,c[S]=0,S++)}return d[1]=P,{x:l,y:u,rowWidth:c,size:d}}function HA({value:s,length:e,stride:t,offset:n,startIndices:i,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=n?n/a:0,c=i[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),m=s;if(l>1||u>0){let P=s.constructor;m=new P(c);for(let S=0;S<c;S++)m[S]=s[S*l+u]}for(let P=0;P<e;P++){let S=i[P],v=i[P+1]||c,I=m.subarray(S,v);d[P]=String.fromCodePoint.apply(null,I),h&&I.forEach(h.add,h)}if(h)for(let P of h)o.add(String.fromCodePoint(P));return{texts:d,characterCount:c}}var ih=class{constructor(e=5){T(this,"limit",void 0),T(this,"_cache",{}),T(this,"_order",[]),this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function ON(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var lu={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:ON(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},jA=1024,RN=.9,qA=1.2,KA=3,Eg=new ih(KA);function BN(s,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);let n=Eg.get(s);if(!n)return t;for(let i in n.mapping)t.has(i)&&t.delete(i);return t}function NN(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function XA(s,e,t,n){s.font="".concat(n," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="alphabetic",s.textAlign="left"}function QA(s){Ye.assert(Number.isFinite(s)&&s>=KA,"Invalid cache limit"),Eg=new ih(s)}var Cg=class{constructor(){T(this,"props",{...lu}),T(this,"_key",void 0),T(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return qA}setProps(e={}){Object.assign(this.props,e);let t=this._key;this._key=this._getKey();let n=BN(this._key,this.props.characterSet),i=Eg.get(this._key);if(i&&n.size===0){this._key!==t&&(this._atlas=i);return}let o=this._generateFontAtlas(this._key,n,i);this._atlas=o,Eg.set(this._key,o)}_generateFontAtlas(e,t,n){let{fontFamily:i,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=n&&n.data;d||(d=document.createElement("canvas"),d.width=jA);let m=d.getContext("2d");XA(m,i,a,o);let{mapping:P,canvasHeight:S,xOffset:v,yOffset:I}=UA({getFontWidth:L=>m.measureText(L).width,fontHeight:a*qA,buffer:l,characterSet:t,maxCanvasWidth:jA,...n&&{mapping:n.mapping,xOffset:n.xOffset,yOffset:n.yOffset}});if(d.height!==S){let L=m.getImageData(0,0,d.width,d.height);d.height=S,m.putImageData(L,0,0)}if(XA(m,i,a,o),u){let L=new YA.default(a,l,c,h,i,o),D=m.getImageData(0,0,L.size,L.size);for(let w of t)NN(L.draw(w),D),m.putImageData(D,P[w].x-l,P[w].y+l)}else for(let L of t)m.fillText(L,P[L].x,P[L].y+a*RN);return{xOffset:v,yOffset:I,mapping:P,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:n,buffer:i,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(n," ").concat(i," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(n," ").concat(i)}};var JA=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var ZA=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var GN={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},uu=class extends on{constructor(...e){super(...e);T(this,"state",void 0)}getShaders(){return super.getShaders({vs:JA,fs:ZA,modules:[Ki,eu]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;if(t.extensionsChanged){var n;let{gl:i}=this.context;(n=this.state.model)===null||n===void 0||n.delete(),this.state.model=this._getModel(i),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:n,sizeUnits:i,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:jn[i],sizeScale:n,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new cn(e,{...this.getShaders(),id:this.props.id,geometry:new zn({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};T(uu,"defaultProps",GN);T(uu,"layerName","TextBackgroundLayer");var $A={start:1,middle:0,end:-1},ev={top:1,center:0,bottom:-1},ey=[0,0,0,255],MN=1,DN={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:ey},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:lu.characterSet},fontFamily:lu.fontFamily,fontWeight:lu.fontWeight,lineHeight:MN,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:ey},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:ey},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},pi=class extends Xn{constructor(...e){super(...e);T(this,"state",void 0),T(this,"getBoundingRect",(t,n)=>{let i=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,n)||"",{size:[m,P]}=$P(d,u,a,l,i),S=$A[typeof c=="function"?c(t,n):c],v=ev[typeof h=="function"?h(t,n):h];return[(S-1)*m/2,(v-1)*P/2,m,P]}),T(this,"getIconOffsets",(t,n)=>{let i=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,n)||"",{x:m,y:P,rowWidth:S,size:[v,I]}=$P(d,u,a,l,i),L=$A[typeof c=="function"?c(t,n):c],D=ev[typeof h=="function"?h(t,n):h],w=m.length,M=new Array(w*2),K=0;for(let X=0;X<w;X++){let se=(1-L)*(v-S[X])/2;M[K++]=(L-1)*v/2+se+m[X],M[K++]=(D-1)*I/2+P[X]}return M})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new Cg}}updateState(e){let{props:t,oldProps:n,changeFlags:i}=e;(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==n.lineHeight||t.wordBreak!==n.wordBreak||t.maxWidth!==n.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:n}=this.props,{fontAtlasManager:i,characterSet:o}=this.state,a={...e,characterSet:o,fontFamily:t,fontWeight:n};if(!i.mapping)return i.setProps(a),!0;for(let l in a)if(a[l]!==i.props[l])return i.setProps(a),!0;return!1}_updateText(){var e;let{data:t,characterSet:n}=this.props,i=(e=t.attributes)===null||e===void 0?void 0:e.getText,{getText:o}=this.props,a=t.startIndices,l,u=n==="auto"&&new Set;if(i&&a){let{texts:c,characterCount:h}=HA({...ArrayBuffer.isView(i)?{value:i}:i,length:t.length,startIndices:a,characterSet:u});l=h,o=(d,{index:m})=>c[m]}else{let{iterable:c,objectInfo:h}=Mo(t);a=[0],l=0;for(let d of c){h.index++;let m=Array.from(o(d,h)||"");u&&m.forEach(u.add,u),l+=m.length,a.push(l)}}this.setState({getText:o,startIndices:a,numInstances:l,characterSet:u||n})}renderLayers(){let{startIndices:e,numInstances:t,getText:n,fontAtlasManager:{scale:i,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:m,getAngle:P,getPixelOffset:S,getBackgroundColor:v,getBorderColor:I,getBorderWidth:L,backgroundPadding:D,background:w,billboard:M,fontSettings:K,outlineWidth:X,outlineColor:se,sizeScale:Te,sizeUnits:pe,sizeMinPixels:G,sizeMaxPixels:O,transitions:V,updateTriggers:U}=this.props,Z=this.getSubLayerClass("characters",su),te=this.getSubLayerClass("background",uu);return[w&&new te({getFillColor:v,getLineColor:I,getLineWidth:L,padding:D,getPosition:h,getSize:m,getAngle:P,getPixelOffset:S,billboard:M,sizeScale:Te/this.state.fontAtlasManager.props.fontSize,sizeUnits:pe,sizeMinPixels:G,sizeMaxPixels:O,transitions:V&&{getPosition:V.getPosition,getAngle:V.getAngle,getSize:V.getSize,getFillColor:V.getBackgroundColor,getLineColor:V.getBorderColor,getLineWidth:V.getBorderWidth,getPixelOffset:V.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:U.getPosition,getAngle:U.getAngle,getSize:U.getSize,getFillColor:U.getBackgroundColor,getLineColor:U.getBorderColor,getLineWidth:U.getBorderWidth,getPixelOffset:U.getPixelOffset,getBoundingRect:{getText:U.getText,getTextAnchor:U.getTextAnchor,getAlignmentBaseline:U.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new Z({sdf:K.sdf,smoothing:Number.isFinite(K.smoothing)?K.smoothing:lu.smoothing,outlineWidth:X,outlineColor:se,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:m,getAngle:P,getPixelOffset:S,billboard:M,sizeScale:Te*i,sizeUnits:pe,sizeMinPixels:G*i,sizeMaxPixels:O*i,transitions:V&&{getPosition:V.getPosition,getAngle:V.getAngle,getColor:V.getColor,getSize:V.getSize,getPixelOffset:V.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:U.getText,getPosition:U.getPosition,getAngle:U.getAngle,getColor:U.getColor,getSize:U.getSize,getPixelOffset:U.getPixelOffset,getIconOffsets:{getText:U.getText,getTextAnchor:U.getTextAnchor,getAlignmentBaseline:U.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:n})]}static set fontAtlasCacheLimit(e){QA(e)}};T(pi,"defaultProps",DN);T(pi,"layerName","TextLayer");var A=class{static mkWithKeyword(e,t,n,i,o){let a=new A(e,t,n,i);return a.keyword=o,a}static parse(e){switch(e.toLowerCase()){case"aliceblue":return A.AliceBlue;case"antiquewhite":return A.AntiqueWhite;case"aqua":return A.Aqua;case"aquamarine":return A.Aquamarine;case"azure":return A.Azure;case"beige":return A.Beige;case"bisque":return A.Bisque;case"black":return A.Black;case"blanchedalmond":return A.BlanchedAlmond;case"blue":return A.Blue;case"blueviolet":return A.BlueViolet;case"brown":return A.Brown;case"burlywood":return A.BurlyWood;case"cadetblue":return A.CadetBlue;case"chartreuse":return A.Chartreuse;case"chocolate":return A.Chocolate;case"coral":return A.Coral;case"cornflowerblue":return A.CornflowerBlue;case"cornsilk":return A.Cornsilk;case"crimson":return A.Crimson;case"cyan":return A.Cyan;case"darkblue":return A.DarkBlue;case"darkcyan":return A.DarkCyan;case"darkgoldenrod":return A.DarkGoldenrod;case"darkgray":return A.DarkGray;case"darkgreen":return A.DarkGreen;case"darkkhaki":return A.DarkKhaki;case"darkmagenta":return A.DarkMagenta;case"darkolivegreen":return A.DarkOliveGreen;case"darkorange":return A.DarkOrange;case"darkorchid":return A.DarkOrchid;case"darkred":return A.DarkRed;case"darksalmon":return A.DarkSalmon;case"darkseagreen":return A.DarkSeaGreen;case"darkslateblue":return A.DarkSlateBlue;case"darkslategray":return A.DarkSlateGray;case"darkturquoise":return A.DarkTurquoise;case"darkviolet":return A.DarkViolet;case"deeppink":return A.DeepPink;case"deepskyblue":return A.DeepSkyBlue;case"dimgray":return A.DimGray;case"dodgerblue":return A.DodgerBlue;case"firebrick":return A.Firebrick;case"floralwhite":return A.FloralWhite;case"forestgreen":return A.ForestGreen;case"fuchsia":return A.Fuchsia;case"gainsboro":return A.Gainsboro;case"ghostwhite":return A.GhostWhite;case"gold":return A.Gold;case"goldenrod":return A.Goldenrod;case"gray":return A.Gray;case"green":return A.Green;case"greenyellow":return A.GreenYellow;case"honeydew":return A.Honeydew;case"hotpink":return A.HotPink;case"indianred":return A.IndianRed;case"indigo":return A.Indigo;case"ivory":return A.Ivory;case"khaki":return A.Khaki;case"lavender":return A.Lavender;case"lavenderblush":return A.LavenderBlush;case"lawngreen":return A.LawnGreen;case"lemonchiffon":return A.LemonChiffon;case"lightblue":return A.LightBlue;case"lightcoral":return A.LightCoral;case"lightcyan":return A.LightCyan;case"lightgoldenrodyellow":return A.LightGoldenrodYellow;case"lightgray":case"lightgrey":return A.LightGray;case"lightgreen":return A.LightGreen;case"lightpink":return A.LightPink;case"lightsalmon":return A.LightSalmon;case"lightseagreen":return A.LightSeaGreen;case"lightskyblue":return A.LightSkyBlue;case"lightslategray":return A.LightSlateGray;case"lightsteelblue":return A.LightSteelBlue;case"lightyellow":return A.LightYellow;case"lime":return A.Lime;case"limegreen":return A.LimeGreen;case"linen":return A.Linen;case"magenta":return A.Magenta;case"maroon":return A.Maroon;case"mediumaquamarine":return A.MediumAquamarine;case"mediumblue":return A.MediumBlue;case"mediumorchid":return A.MediumOrchid;case"mediumpurple":return A.MediumPurple;case"mediumseagreen":return A.MediumSeaGreen;case"mediumslateblue":return A.MediumSlateBlue;case"mediumspringgreen":return A.MediumSpringGreen;case"mediumturquoise":return A.MediumTurquoise;case"mediumvioletred":return A.MediumVioletRed;case"midnightblue":return A.MidnightBlue;case"mintcream":return A.MintCream;case"mistyrose":return A.MistyRose;case"moccasin":return A.Moccasin;case"navajowhite":return A.NavajoWhite;case"navy":return A.Navy;case"oldlace":return A.OldLace;case"olive":return A.Olive;case"olivedrab":return A.OliveDrab;case"orange":return A.Orange;case"orangered":return A.OrangeRed;case"orchid":return A.Orchid;case"palegoldenrod":return A.PaleGoldenrod;case"palegreen":return A.PaleGreen;case"paleturquoise":return A.PaleTurquoise;case"palevioletred":return A.PaleVioletRed;case"papayawhip":return A.PapayaWhip;case"peachpuff":return A.PeachPuff;case"peru":return A.Peru;case"pink":return A.Pink;case"plum":return A.Plum;case"powderblue":return A.PowderBlue;case"purple":return A.Purple;case"red":return A.Red;case"rosybrown":return A.RosyBrown;case"royalblue":return A.RoyalBlue;case"saddlebrown":return A.SaddleBrown;case"salmon":return A.Salmon;case"sandybrown":return A.SandyBrown;case"seagreen":return A.SeaGreen;case"seashell":return A.SeaShell;case"sienna":return A.Sienna;case"silver":return A.Silver;case"skyblue":return A.SkyBlue;case"slateblue":return A.SlateBlue;case"slategray":return A.SlateGray;case"snow":return A.Snow;case"springgreen":return A.SpringGreen;case"steelblue":return A.SteelBlue;case"tan":return A.Tan;case"teal":return A.Teal;case"thistle":return A.Thistle;case"tomato":return A.Tomato;case"transparent":return A.Transparent;case"turquoise":return A.Turquoise;case"violet":return A.Violet;case"wheat":return A.Wheat;case"white":return A.White;case"whitesmoke":return A.WhiteSmoke;case"yellow":return A.Yellow;case"yellowgreen":return A.YellowGreen;default:return}}get keyword(){return this.keyword_}set keyword(e){this.keyword_=e}constructor(e,t,n,i){this.a=e,this.r=t,this.g=n,this.b=i}static mkRGB(e,t,n){return new A(255,e,t,n)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length===1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a===t.a&&e.r===t.r&&e.b===t.b&&e.g===t.g}toString(){return this.keyword?this.keyword:'"#'+A.Xex(this.R)+A.Xex(this.G)+A.Xex(this.B)+(this.A===255?"":A.Xex(this.A))+'"'}static get AliceBlue(){return A.mkWithKeyword(255,240,248,255,"aliceblue")}static get AntiqueWhite(){return A.mkWithKeyword(255,250,235,215,"antiquewhite")}static get Aqua(){return A.mkWithKeyword(255,0,255,255,"aqua")}static get Aquamarine(){return A.mkWithKeyword(255,127,255,212,"aquamarine")}static get Azure(){return A.mkWithKeyword(255,240,255,255,"azure")}static get Beige(){return A.mkWithKeyword(255,245,245,220,"beige")}static get Bisque(){return A.mkWithKeyword(255,255,228,196,"bisque")}static get Black(){return A.mkWithKeyword(255,0,0,0,"black")}static get BlanchedAlmond(){return A.mkWithKeyword(255,255,235,205,"blanchedalmond")}static get Blue(){return A.mkWithKeyword(255,0,0,255,"blue")}static get BlueViolet(){return A.mkWithKeyword(255,138,43,226,"blueviolet")}static get Brown(){return A.mkWithKeyword(255,165,42,42,"brown")}static get BurlyWood(){return A.mkWithKeyword(255,222,184,135,"burlywood")}static get CadetBlue(){return A.mkWithKeyword(255,95,158,160,"cadetblue")}static get Chartreuse(){return A.mkWithKeyword(255,127,255,0,"chartreuse")}static get Chocolate(){return A.mkWithKeyword(255,210,105,30,"chocolate")}static get Coral(){return A.mkWithKeyword(255,255,127,80,"coral")}static get CornflowerBlue(){return A.mkWithKeyword(255,100,149,237,"cornflowerblue")}static get Cornsilk(){return A.mkWithKeyword(255,255,248,220,"cornsilk")}static get Crimson(){return A.mkWithKeyword(255,220,20,60,"crimson")}static get Cyan(){return A.mkWithKeyword(255,0,255,255,"cyan")}static get DarkBlue(){return A.mkWithKeyword(255,0,0,139,"darkblue")}static get DarkCyan(){return A.mkWithKeyword(255,0,139,139,"darkcyan")}static get DarkGoldenrod(){return A.mkWithKeyword(255,184,134,11,"darkgoldenrod")}static get DarkGray(){return A.mkWithKeyword(255,169,169,169,"darkgray")}static get DarkGreen(){return A.mkWithKeyword(255,0,100,0,"darkgreen")}static get DarkKhaki(){return A.mkWithKeyword(255,189,183,107,"darkkhaki")}static get DarkMagenta(){return A.mkWithKeyword(255,139,0,139,"darkmagenta")}static get DarkOliveGreen(){return A.mkWithKeyword(255,85,107,47,"darkolivegreen")}static get DarkOrange(){return A.mkWithKeyword(255,255,140,0,"darkorange")}static get DarkOrchid(){return A.mkWithKeyword(255,153,50,204,"darkorchid")}static get DarkRed(){return A.mkWithKeyword(255,139,0,0,"darkred")}static get DarkSalmon(){return A.mkWithKeyword(255,233,150,122,"darksalmon")}static get DarkSeaGreen(){return A.mkWithKeyword(255,143,188,139,"darkseagreen")}static get DarkSlateBlue(){return A.mkWithKeyword(255,72,61,139,"darkslateblue")}static get DarkSlateGray(){return A.mkWithKeyword(255,47,79,79,"darkslategray")}static get DarkTurquoise(){return A.mkWithKeyword(255,0,206,209,"darkturquoise")}static get DarkViolet(){return A.mkWithKeyword(255,148,0,211,"darkviolet")}static get DeepPink(){return A.mkWithKeyword(255,255,20,147,"deeppink")}static get DeepSkyBlue(){return A.mkWithKeyword(255,0,191,255,"deepskyblue")}static get DimGray(){return A.mkWithKeyword(255,105,105,105,"dimgray")}static get DodgerBlue(){return A.mkWithKeyword(255,30,144,255,"dodgerblue")}static get Firebrick(){return A.mkWithKeyword(255,178,34,34,"firebrick")}static get FloralWhite(){return A.mkWithKeyword(255,255,250,240,"floralwhite")}static get ForestGreen(){return A.mkWithKeyword(255,34,139,34,"forestgreen")}static get Fuchsia(){return A.mkWithKeyword(255,255,0,255,"fuchsia")}static get Gainsboro(){return A.mkWithKeyword(255,220,220,220,"gainsboro")}static get GhostWhite(){return A.mkWithKeyword(255,248,248,255,"ghostwhite")}static get Gold(){return A.mkWithKeyword(255,255,215,0,"gold")}static get Goldenrod(){return A.mkWithKeyword(255,218,165,32,"goldenrod")}static get Gray(){return A.mkWithKeyword(255,128,128,128,"gray")}static get Green(){return A.mkWithKeyword(255,0,128,0,"green")}static get GreenYellow(){return A.mkWithKeyword(255,173,255,47,"greenyellow")}static get Honeydew(){return A.mkWithKeyword(255,240,255,240,"honeydew")}static get HotPink(){return A.mkWithKeyword(255,255,105,180,"hotpink")}static get IndianRed(){return A.mkWithKeyword(255,205,92,92,"indianred")}static get Indigo(){return A.mkWithKeyword(255,75,0,130,"indigo")}static get Ivory(){return A.mkWithKeyword(255,255,255,240,"ivory")}static get Khaki(){return A.mkWithKeyword(255,240,230,140,"khaki")}static get Lavender(){return A.mkWithKeyword(255,230,230,250,"lavender")}static get LavenderBlush(){return A.mkWithKeyword(255,255,240,245,"lavenderblush")}static get LawnGreen(){return A.mkWithKeyword(255,124,252,0,"lawngreen")}static get LemonChiffon(){return A.mkWithKeyword(255,255,250,205,"lemonchiffon")}static get LightBlue(){return A.mkWithKeyword(255,173,216,230,"lightblue")}static get LightCoral(){return A.mkWithKeyword(255,240,128,128,"lightcoral")}static get LightCyan(){return A.mkWithKeyword(255,224,255,255,"lightcyan")}static get LightGoldenrodYellow(){return A.mkWithKeyword(255,250,250,210,"lightgoldenrodyellow")}static get LightGray(){return A.mkWithKeyword(255,211,211,211,"lightgray")}static get LightGreen(){return A.mkWithKeyword(255,144,238,144,"lightgreen")}static get LightPink(){return A.mkWithKeyword(255,255,182,193,"lightpink")}static get LightSalmon(){return A.mkWithKeyword(255,255,160,122,"lightsalmon")}static get LightSeaGreen(){return A.mkWithKeyword(255,32,178,170,"lightseagreen")}static get LightSkyBlue(){return A.mkWithKeyword(255,135,206,250,"lightskyblue")}static get LightSlateGray(){return A.mkWithKeyword(255,119,136,153,"lightslategray")}static get LightSteelBlue(){return A.mkWithKeyword(255,176,196,222,"lightsteelblue")}static get LightYellow(){return A.mkWithKeyword(255,255,255,224,"lightyellow")}static get Lime(){return A.mkWithKeyword(255,0,255,0,"lime")}static get LimeGreen(){return A.mkWithKeyword(255,50,205,50,"limegreen")}static get Linen(){return A.mkWithKeyword(255,250,240,230,"linen")}static get Magenta(){return A.mkWithKeyword(255,255,0,255,"magenta")}static get Maroon(){return A.mkWithKeyword(255,128,0,0,"maroon")}static get MediumAquamarine(){return A.mkWithKeyword(255,102,205,170,"mediumaquamarine")}static get MediumBlue(){return A.mkWithKeyword(255,0,0,205,"mediumblue")}static get MediumOrchid(){return A.mkWithKeyword(255,186,85,211,"mediumorchid")}static get MediumPurple(){return A.mkWithKeyword(255,147,112,219,"mediumpurple")}static get MediumSeaGreen(){return A.mkWithKeyword(255,60,179,113,"mediumseagreen")}static get MediumSlateBlue(){return A.mkWithKeyword(255,123,104,238,"mediumslateblue")}static get MediumSpringGreen(){return A.mkWithKeyword(255,0,250,154,"mediumspringgreen")}static get MediumTurquoise(){return A.mkWithKeyword(255,72,209,204,"mediumturquoise")}static get MediumVioletRed(){return A.mkWithKeyword(255,199,21,133,"mediumvioletred")}static get MidnightBlue(){return A.mkWithKeyword(255,25,25,112,"midnightblue")}static get MintCream(){return A.mkWithKeyword(255,245,255,250,"mintcream")}static get MistyRose(){return A.mkWithKeyword(255,255,228,225,"mistyrose")}static get Moccasin(){return A.mkWithKeyword(255,255,228,181,"moccasin")}static get NavajoWhite(){return A.mkWithKeyword(255,255,222,173,"navajowhite")}static get Navy(){return A.mkWithKeyword(255,0,0,128,"navy")}static get OldLace(){return A.mkWithKeyword(255,253,245,230,"oldlace")}static get Olive(){return A.mkWithKeyword(255,128,128,0,"olive")}static get OliveDrab(){return A.mkWithKeyword(255,107,142,35,"olivedrab")}static get Orange(){return A.mkWithKeyword(255,255,165,0,"orange")}static get OrangeRed(){return A.mkWithKeyword(255,255,69,0,"orangered")}static get Orchid(){return A.mkWithKeyword(255,218,112,214,"orchid")}static get PaleGoldenrod(){return A.mkWithKeyword(255,238,232,170,"palegoldenrod")}static get PaleGreen(){return A.mkWithKeyword(255,152,251,152,"palegreen")}static get PaleTurquoise(){return A.mkWithKeyword(255,175,238,238,"paleturquoise")}static get PaleVioletRed(){return A.mkWithKeyword(255,219,112,147,"palevioletred")}static get PapayaWhip(){return A.mkWithKeyword(255,255,239,213,"papayawhip")}static get PeachPuff(){return A.mkWithKeyword(255,255,218,185,"peachpuff")}static get Peru(){return A.mkWithKeyword(255,205,133,63,"peru")}static get Pink(){return A.mkWithKeyword(255,255,192,203,"pink")}static get Plum(){return A.mkWithKeyword(255,221,160,221,"plum")}static get PowderBlue(){return A.mkWithKeyword(255,176,224,230,"powderblue")}static get Purple(){return A.mkWithKeyword(255,128,0,128,"purple")}static get Red(){return A.mkWithKeyword(255,255,0,0,"red")}static get RosyBrown(){return A.mkWithKeyword(255,188,143,143,"rosybrown")}static get RoyalBlue(){return A.mkWithKeyword(255,65,105,225,"royalblue")}static get SaddleBrown(){return A.mkWithKeyword(255,139,69,19,"saddlebrown")}static get Salmon(){return A.mkWithKeyword(255,250,128,114,"salmon")}static get SandyBrown(){return A.mkWithKeyword(255,244,164,96,"sandybrown")}static get SeaGreen(){return A.mkWithKeyword(255,46,139,87,"seagreen")}static get SeaShell(){return A.mkWithKeyword(255,255,245,238,"seashell")}static get Sienna(){return A.mkWithKeyword(255,160,82,45,"sienna")}static get Silver(){return A.mkWithKeyword(255,192,192,192,"silver")}static get SkyBlue(){return A.mkWithKeyword(255,135,206,235,"skyblue")}static get SlateBlue(){return A.mkWithKeyword(255,106,90,205,"slateblue")}static get SlateGray(){return A.mkWithKeyword(255,112,128,144,"slategray")}static get Snow(){return A.mkWithKeyword(255,255,250,250,"snow")}static get SpringGreen(){return A.mkWithKeyword(255,0,255,127,"springgreen")}static get SteelBlue(){return A.mkWithKeyword(255,70,130,180,"steelblue")}static get Tan(){return A.mkWithKeyword(255,210,180,140,"tan")}static get Teal(){return A.mkWithKeyword(255,0,128,128,"teal")}static get Thistle(){return A.mkWithKeyword(255,216,191,216,"thistle")}static get Tomato(){return A.mkWithKeyword(255,255,99,71,"tomato")}static get Transparent(){return A.mkWithKeyword(0,255,255,255,"transparent")}static get Turquoise(){return A.mkWithKeyword(255,64,224,208,"turquoise")}static get Violet(){return A.mkWithKeyword(255,238,130,238,"violet")}static get Wheat(){return A.mkWithKeyword(255,245,222,179,"wheat")}static get White(){return A.mkWithKeyword(255,255,255,255,"white")}static get WhiteSmoke(){return A.mkWithKeyword(255,245,245,245,"whitesmoke")}static get Yellow(){return A.mkWithKeyword(255,255,255,0,"yellow")}static get YellowGreen(){return A.mkWithKeyword(255,154,205,50,"yellowgreen")}};var Wa=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(Wa||{});var Ns=class extends Ci{constructor(e){super(e,ae.DrawingObjectIndex);this.labelfontcolor=A.Black;this.styles=[];this.penwidth=1;this.fontname=Ns.defaultLabelFontName,this.fontsize=Ns.defaultLabelFontSize}rebind(e){this.entity=e,this.bind(ae.DrawingObjectIndex)}static copyValidFields(e,t){e==null||t==null||(e.color&&e.color.keyword&&e.color.keyword.toLowerCase()!=="black"&&(t.color=e.color),e.fillColor&&(t.fillColor=e.fillColor),e.labelfontcolor&&e.labelfontcolor.keyword.toLowerCase()!=="black"&&(t.labelfontcolor=e.labelfontcolor),e.labelText!=null&&e.labelText!==""&&e.labelText!==e.id&&(t.labelText=e.labelText),e.fontColor&&e.fontColor.keyword&&e.fontColor.keyword.toLowerCase()!=="black"&&(t.fontColor=e.fontColor),e.styles&&e.styles.length&&(t.styles=e.styles.map(n=>n)),e.pencolor&&e.pencolor.keyword!=="black"&&(t.pencolor=e.pencolor),e.penwidth&&e.penwidth!==1&&(t.penwidth=e.penwidth),e.rankdir&&(t.rankdir=e.rankdir),e.fontname&&e.fontname!==Ns.defaultLabelFontName&&(t.fontname=e.fontname),e.margin&&(t.margin=e.margin),e.fontsize&&e.fontsize!==Ns.defaultLabelFontSize&&(t.fontsize=e.fontsize),e.orientation&&(t.orientation=e.orientation),e.ranksep&&(t.ranksep=e.ranksep),e.arrowtail&&(t.arrowtail=e.arrowtail),e.arrowhead&&(t.arrowhead=e.arrowhead),e.ordering&&(t.ordering=e.ordering),e.bgcolor&&(t.bgcolor=e.bgcolor),e.pos&&(t.pos=e.pos),e.nodesep&&(t.nodesep=e.nodesep),e.arrowsize&&(t.arrowsize=e.arrowsize),e.samehead&&(t.samehead=e.samehead),e.layersep&&(t.layersep=e.layersep),e.clusterRank&&(t.clusterRank=e.clusterRank))}*attrIter(){if(this.color&&this.color.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"color",eq:this.color.toString()}),this.fillColor&&(yield{type:"attr",id:"fillColor",eq:this.fillColor.toString()}),this.labelfontcolor&&this.labelfontcolor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"labelfontcolor",eq:this.labelfontcolor.toString()}),!(this.labelText==null||this.labelText==="")&&this.entity&&this.labelText!==this.id&&(yield{type:"attr",id:"label",eq:this.labelText}),this.fontColor&&this.fontColor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"fontColor",eq:this.fontColor.toString()}),this.styles&&this.styles.length){let e=this.styles.map(t=>Wa[t]).reduce((t,n)=>t.concat(","+n));yield{type:"attr",id:"style",eq:e}}this.pencolor&&this.pencolor.keyword!=="black"&&(yield{type:"attr",id:"pencolor",eq:this.pencolor.toString()}),this.penwidth&&this.penwidth!==1&&(yield{type:"attr",id:"penwidth",eq:this.penwidth.toString()}),this.rankdir&&(yield{type:"attr",id:"rankdir",eq:this.rankdir.toString()}),this.fontname&&this.fontname!==Ns.defaultLabelFontName&&(yield{type:"attr",id:"fontname",eq:this.fontname}),this.margin&&(yield{type:"attr",id:"margin",eq:this.margin.toString()}),this.fontsize&&this.fontsize!==Ns.defaultLabelFontSize&&(yield{type:"attr",id:"fontsize",eq:this.fontsize.toString()}),this.orientation&&(yield{type:"attr",id:"orientation",eq:this.orientation.toString()}),this.ranksep&&(yield{type:"attr",id:"ranksep",eq:this.ranksep.toString()}),this.arrowtail&&(yield{type:"attr",id:"arrowtail",eq:this.arrowtail.toString()}),this.arrowhead&&(yield{type:"attr",id:"arrowhead",eq:this.arrowhead.toString()}),this.ordering&&(yield{type:"attr",id:"ordering",eq:this.ordering.toString()}),this.bgcolor&&(yield{type:"attr",id:"bgcolor",eq:this.bgcolor.toString()}),this.pos&&(yield{type:"attr",id:"pos",eq:this.pos.toString()}),this.nodesep&&(yield{type:"attr",id:"nodesep",eq:this.nodesep.toString()}),this.arrowsize&&(yield{type:"attr",id:"arrowsize",eq:this.arrowsize.toString()}),this.samehead&&(yield{type:"attr",id:"samehead",eq:this.samehead.toString()}),this.layersep&&(yield{type:"attr",id:"layersep",eq:this.layersep.toString()}),this.clusterRank&&(yield{type:"attr",id:"clusterrank",eq:this.clusterRank.toString()}),this.measuredTextSize&&(yield{type:"attr",id:"measuredTextSize",eq:JSON.stringify(this.measuredTextSize)})}get labelText(){return this._labelText}set labelText(e){this._labelText=e}get id(){return this._id}set id(e){this._id=e}static getDrawingObj(e){return e==null?null:e.getAttr(ae.DrawingObjectIndex)}},De=Ns;De.defaultLabelFontName="Times-Roman",De.defaultLabelFontSize=12;var $i=(w=>(w[w.normal=0]="normal",w[w.inv=1]="inv",w[w.dot=2]="dot",w[w.invdot=3]="invdot",w[w.odot=4]="odot",w[w.invodot=5]="invodot",w[w.none=6]="none",w[w.tee=7]="tee",w[w.empty=8]="empty",w[w.invempty=9]="invempty",w[w.diamond=10]="diamond",w[w.odiamond=11]="odiamond",w[w.ediamond=12]="ediamond",w[w.crow=13]="crow",w[w.box=14]="box",w[w.obox=15]="obox",w[w.open=16]="open",w[w.halfopen=17]="halfopen",w[w.vee=18]="vee",w))($i||{});var _t=class extends De{constructor(e,t){super(e);this.directed=!0;this.directed=t,t?this.arrowhead=0:this.arrowhead=6,this.arrowtail=6}clone(){let e=new _t(null,this.directed);return De.copyValidFields(this,e),e.directed=this.directed,e.arrowtail=this.arrowtail,e.arrowhead=this.arrowhead,e}};var eo=(M=>(M[M.diamond=0]="diamond",M[M.ellipse=1]="ellipse",M[M.box=2]="box",M[M.circle=3]="circle",M[M.record=4]="record",M[M.plaintext=5]="plaintext",M[M.point=6]="point",M[M.mdiamond=7]="mdiamond",M[M.msquare=8]="msquare",M[M.polygon=9]="polygon",M[M.doublecircle=10]="doublecircle",M[M.house=11]="house",M[M.invhouse=12]="invhouse",M[M.parallelogram=13]="parallelogram",M[M.octagon=14]="octagon",M[M.tripleoctagon=15]="tripleoctagon",M[M.triangle=16]="triangle",M[M.trapezium=17]="trapezium",M[M.drawFromGeometry=18]="drawFromGeometry",M[M.hexagon=19]="hexagon",M))(eo||{});var xg=class extends De{constructor(e){super(e);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;e!=null&&(this.labelText=e.id)}clone(){throw new Error("Method not implemented.")}*attrIter(){yield*super.attrIter(),this.shape&&this.shape!==2&&(yield{type:"attr",id:"shape",eq:this.shape.toString()}),this.xRad&&this.xRad!==3&&(yield{type:"attr",id:"xRad",eq:this.xRad.toString()}),this.yRad&&this.yRad!==3&&(yield{type:"attr",id:"yRad",eq:this.yRad.toString()}),this.padding&&this.padding!==2&&(yield{type:"attr",id:"padding",eq:this.padding.toString()})}get Padding(){return this.padding}set Padding(e){this.padding=Math.max(0,e)}get XRadius(){return this.xRad}set XRadius(e){this.xRad=e}get YRadius(){return this.yRad}set YRadius(e){this.yRad=e}static get DefaultFillColor(){return xg.defaultFillColor}static set DefaultFillColor(e){xg.defaultFillColor=e}get ShapeEnum(){return this.shape}set ShapeEnum(e){this.shape=e}get LabelMargin(){return this.labelMargin}set LabelMargin(e){this.labelMargin=e}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(e){this.labelWidthToHeightRatio=e}get node(){return this.entity}get id(){return this.node?this.node.id:null}},ct=xg;ct.defaultFillColor=A.LightGray;var gr=class{static CreatePortsAndRouteEdges(e,t,n,i,o,a=null){gr.FillRouter(e,t,n,i,o).run(),gr.CreateSelfEdges(Array.from(i).filter(u=>u.sourcePort.Location===u.targetPort.Location),e)}static CreatePortsAndRouteEdges_(e,t,n,i,o,a,l){gr.CreatePortsAndRouteEdges(e,t,n,i,o)}static CreatePortsAndRouteEdges__(e,t,n,i,o,a){gr.CreatePortsAndRouteEdges(e,t,n,i,o)}static FillRouter(e,t,n,i,o){let a=new Map;gr.FillNodeShapesMap(n,i,a);let l=new us(a.values(),t,e);for(let u of i)u.sourcePort=tv(a.get(u.source).Ports),u.targetPort=tv(a.get(u.target).Ports),l.AddEdgeGeometryToRoute(u);return l}static FillNodeShapesMap(e,t,n){for(let i of e){let o=gr.CreateShapeWithRelativeNodeAtCenter(i);n.set(i,o)}for(let i of t){let o=i.source;n.has(o)||n.set(o,gr.CreateShapeWithRelativeNodeAtCenter(o)),o=i.target,n.has(o)||n.set(o,gr.CreateShapeWithRelativeNodeAtCenter(o))}}static CreateSelfEdges(e,t){for(let n of e)gr.CreateSimpleEdgeCurveWithGivenFitRadius(n,t)}static CreateSimpleEdgeCurveWithGivenFitRadius(e,t){let n=e.source.center,i=e.target.center;if(e.source===e.target){let o=e.source.boundaryCurve.boundingBox.width/2,a=e.source.boundingBox.height/4;e.smoothedPolyline=gr.CreateUnderlyingPolylineForSelfEdge(n,o,a);for(let l=e.smoothedPolyline.headSite.next;l.next!=null;l=l.next)gr.CalculateCoefficiensUnderSite(l,t);e.curve=e.smoothedPolyline.createCurve()}else e.smoothedPolyline=Ue.mkFromPoints([n,i]),e.curve=e.smoothedPolyline.createCurve();Ve.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!0)||Ve.createBigEnoughSpline(e)}static CreateSimpleEdgeCurve(e){let t=e.source.center,n=e.target.center;if(e.source===e.target){let i=e.source.boundaryCurve.boundingBox.width/2,o=e.source.boundingBox.height/4;e.smoothedPolyline=gr.CreateUnderlyingPolylineForSelfEdge(t,i,o),e.curve=e.smoothedPolyline.createCurve()}else e.smoothedPolyline=Ue.mkFromPoints([t,n]),e.curve=e.smoothedPolyline.createCurve();Ve.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,e.curve,!0)||Ve.createBigEnoughSpline(e)}static CreateUnderlyingPolylineForSelfEdge(e,t,n){let i=e.add(new f(0,n)),o=e.add(new f(t,n)),a=e.add(new f(t,n*-1)),l=e.add(new f(0,n*-1)),u=Be.mkSiteP(e),c=new Ue(u);return u=Be.mkSiteSP(u,i),u=Be.mkSiteSP(u,o),u=Be.mkSiteSP(u,a),u=Be.mkSiteSP(u,l),Be.mkSiteSP(u,e),c}static CreateShapeWithRelativeNodeAtCenter(e){let t=new rs(()=>e.boundaryCurve);return t.Ports.add(new or(()=>e.boundaryCurve,()=>e.center,new f(0,0))),t}static CalculateCoefficiensUnderSite(e,t){let n=t/e.point.sub(e.prev.point).length;n=Math.min(.5,n),e.previouisBezierCoefficient=n,n=t/e.next.point.sub(e.point).length,n=Math.min(.5,n),e.nextBezierCoefficient=n}};function tv(s){for(let e of s)return e}var rv=Ae(Qn());var cu=class{constructor(e,t,n){this.fixedNodes=new Set;this.separation=t,this.rtree=new Ti(Vs(e,i=>this.GetPaddedBoxOfNode(i))),this.pushingNodes=n}get FixedNodes(){return this.fixedNodes}GetPaddedBoxOfNode(e){let t=e.boundaryCurve.boundingBox.clone();return t.pad(this.separation/2),t}PushNodes(){this.fixedNodes.clear(),Jo(this.fixedNodes,this.pushingNodes);let e=new rv.Queue;for(let n of this.pushingNodes)e.enqueue(n);let t=new Array;for(;e.length>0;){let n=e.dequeue();for(let i of this.PushByNodeAndReportPushedAsFixed(n))e.enqueue(i),this.fixedNodes.add(i),t.push(i)}return t}PushByNodeAndReportPushedAsFixed(e){let t=[],n=this.GetPaddedBoxOfNode(e);for(let i of this.rtree.GetAllLeavesIntersectingRectangle(n))this.fixedNodes.has(i.UserData)||this.PushNodeAndUpdateRTree(e,i)&&t.push(i.UserData);return t}PushNodeAndUpdateRTree(e,t){let n=t.UserData.center.sub(e.center),i=e.width/2+t.UserData.width/2,o=e.height/2+t.UserData.height/2,a=Math.abs(n.x),l=Math.abs(n.y),u=a-i,c=l-o;if(u>=this.separation||c>=this.separation)return!1;if(a>=l){let h=n.x>0?this.separation-u:u-this.separation;this.PushByX(h,t)}else{let h=n.y>0?this.separation-c:c-this.separation;this.PushByY(h,t)}return this.UpdateBoundingBoxesOfPushedAndUpParents(t),!0}PushByX(e,t){let n=new f(e,0);cu.PushByPoint(t,n)}static PushByPoint(e,t){e.UserData.center=e.UserData.center.add(t),e.UserData instanceof re&&e.UserData.translate(t)}PushByY(e,t){let n=new f(0,e);cu.PushByPoint(t,n)}UpdateBoundingBoxesOfPushedAndUpParents(e){e.irect=this.GetPaddedBoxOfNode(e.UserData);let t=e.Parent;for(;t!=null;)t.irect=t.Left.irect.add_rect(t.Right.irect),t=t.Parent}UpdateRTreeByChangedNodeBox(e,t){let n=this.FindClusterNode(e,t);this.UpdateBoundingBoxesOfPushedAndUpParents(n)}FindClusterNode(e,t){let n=this.rtree.RootNode;return this.FindClusterNodeRecurse(n,e,t)}FindClusterNodeRecurse(e,t,n){if(e.UserData!=null)return e.UserData===t?e:null;let i=null;return n.intersects(e.left.irect)&&(i=this.FindClusterNodeRecurse(e.Left,t,n)),i!=null?i:n.intersects(e.right.irect)?this.FindClusterNodeRecurse(e.Right,t,n):null}FirstPushingNode(){return this.pushingNodes[0]}};var ty=class{constructor(e,t,n){this.RelativeLengthOnCurve=e,this.RightSide=t,this.NormalLength=n}};var ry=class{constructor(e,t,n){this.listOfPushers=new Array;this.labelFixtures=new Map;this.geomGraph=t,this.nodeSeparation=n.NodeSeparation,this.layoutSettings=n,this.pushingNodesArray=e,this.InitBumperPushers()}get geomGraph(){return this.geomGraph_}set geomGraph(e){this.geomGraph_=e}InitBumperPushers(){if(this.pushingNodesArray.length===0)return;let e=re.getGeom(this.pushingNodesArray[0].node.parent),t=this.pushingNodesArray;do if(this.listOfPushers.push(new cu(e.shallowNodes,this.nodeSeparation,t)),e.graph.parent)e=re.getGeom(e.graph.parent),t=[e];else break;while(!0)}RunPushers(){for(let e=0;e<this.listOfPushers.length;e++){let t=this.listOfPushers[e];t.PushNodes();let n=t.FirstPushingNode().node.parent;if(n===this.geomGraph_.graph)break;let i=re.getGeom(n),o=i.boundingBox;if(i.calculateBoundsFromChildren(),i.boundingBox.equalEps(o))break;this.listOfPushers[e+1].UpdateRTreeByChangedNodeBox(i,o)}}Drag(e){if(!(e.x==null&&e.y==null)){for(let t of this.pushingNodesArray)t.translate(e);this.RunPushers(),this.RouteChangedEdges()}}RouteChangedEdges(){this.changedEdges=this.GetChangedEdges(this.GetChangedNodes()),this.InitLabelFixtures(this.changedEdges),new Fe(this.geomGraph_,this.changedEdges,this.layoutSettings.commonSettings.edgeRoutingSettings.Padding,this.layoutSettings.commonSettings.edgeRoutingSettings.PolylinePadding,this.layoutSettings.commonSettings.edgeRoutingSettings.ConeAngle,this.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings).run(),this.PositionLabels(this.changedEdges)}PositionLabels(e){for(let t of e)this.PositionEdgeLabel(t)}PositionEdgeLabel(e){let t=this.labelFixtures.get(e);if(t==null)return;let n=e.curve,i=n.length*t.RelativeLengthOnCurve,o=n.getParameterAtLength(i),a=n.derivative(o),l=(t.RightSide?a.rotate90Cw():a.rotate90Ccw()).normalize().mul(t.NormalLength);e.label.positionCenter(n.value(o).add(l))}InitLabelFixtures(e){for(let t of e)this.InitLabelFixture(t)}InitLabelFixture(e){if(e.label==null||this.labelFixtures.has(e))return;let t=e.curve.closestParameter(e.label.center),n=e.curve,o=n.derivative(t).rotate90Cw(),a=e.label.center.sub(n.value(t)),l=new ty(n.lengthPartial(0,t)/n.length,a.dot(o)>0,a.length);this.labelFixtures.set(e,l)}GetChangedEdges(e){let t=[],n=z.mkOnRectangles(Array.from(e).map(o=>o.boundingBox)),i=n.perimeter();for(let o of this.geomGraph.deepEdges)this.EdgeNeedsRouting(n,o,i,e)&&t.push(o);return t}EdgeNeedsRouting(e,t,n,i){return t.curve==null||i.has(t.source)||i.has(t.target)||t.source.boundingBox.intersects(e)||t.target.boundaryCurve.boundingBox.intersects(e)?!0:t.boundingBox.intersects(e)?x.intersectionOne(n,t.curve,!1)!=null:!1}GetChangedNodes(){let e=new Set;for(let t of this.listOfPushers)for(let n of t.FixedNodes)e.add(n);return e}};var hu=class{constructor(){this._canUndo=!0}updateDeltaForDragUndo(e){let t=this.data;t.delta=e}registerUndoDrag(e){this.data==null&&(this.data={draggedEnts:new Set,delta:null,changeData:new Map}),"draggedEnts"in this.data&&this.data.draggedEnts.add(e)}undo(){if(Ee.assert(this.canUndo),this.data instanceof Map)for(let[e,t]of this.data)for(let n of t)n.new=e.getAttr(ny(n.old)).clone(),n.old.rebind(e);else if(this.data&&"deletedEnts"in this.data)for(let e of this.data.deletedEnts)nv(e);else if("insertedEnts"in this.data)for(let e of this.data.insertedEnts){let t=e.parent;if(e instanceof tt)t.removeNode(e);else if(e instanceof et)e.remove();else throw new Error("not implemented")}else if("draggedEnts"in this.data){for(let e of this.data.draggedEnts)ce.getGeom(e).translate(this.data.delta);for(let[e,t]of this.data.changeData)for(let n of t)n.new=e.getAttr(ny(n.old)).clone(),n.old.rebind(e)}else throw new Error("not implemented");this.canUndo=!1}redo(){if(Ee.assert(this.canRedo),this.data instanceof Map)for(let[e,t]of this.data)for(let n of t)n.new.rebind(e);else if("deletedEnts"in this.data)for(let e of this.data.deletedEnts)if(e instanceof de)e.removeSubgraph();else if(e instanceof tt)e.parent.removeNode(e);else if(e instanceof et)e.remove();else if(e instanceof er){let t=e.parent;t.label=null}else throw new Error("unexpected type in redo");else if("draggedEnts"in this.data){let e=this.data.delta.neg();for(let t of this.data.draggedEnts)ce.getGeom(t).translate(e);for(let[t,n]of this.data.changeData)for(let i of n)i.new.rebind(t)}else if("insertedEnts"in this.data)for(let e of this.data.insertedEnts)nv(e);else throw new Error("not implemented");this.canUndo=!0}addOldNewPair(e,t){this.data||(this.data=new Map);let n="draggedEnts"in this.data?this.data.changeData:this.data;n.has(e)||n.set(e,[]);let i=ny(t),o=n.get(e);o[i]==null&&(o[i]={old:t.clone(),new:null})}registerDelete(e){this.data||(this.data={deletedEnts:new Set}),this.data.deletedEnts.add(e)}registerAdd(e){this.data||(this.data={insertedEnts:new Set}),this.data.insertedEnts.add(e)}get canRedo(){return!this._canUndo}get canUndo(){return this._canUndo}set canUndo(e){this._canUndo=e}*entities(){if(!!this.data)if(this.data instanceof Map)yield*this.data.keys();else if("draggedEnts"in this.data)yield*this.data.changeData.keys(),yield*this.data.draggedEnts;else if("deletedEnts"in this.data)yield*this.data.deletedEnts;else if("insertedEnts"in this.data)yield*this.data.insertedEnts;else throw new Error("not implemented")}};function ny(s){let e;return s instanceof ce?e=ae.GeomObjectIndex:s instanceof De?e=ae.DrawingObjectIndex:e=ae.ViewerIndex,e}function nv(s){if(s instanceof er){let e=s.parent;e.label=s}else if(s instanceof de){s.parent.addNode(s);for(let t of s.edges)t.add();for(let t of s.nodesBreadthFirst){for(let n of t.outEdges)n.add();for(let n of t.inEdges)n.add()}}else s instanceof tt?s.parent.addNode(s):s instanceof et&&s.add()}var Ag=class{updateDeltaForDragUndo(e){this.currentBridge.updateDeltaForDragUndo(e)}registerForUndoDrag(e){this.currentBridge==null&&(this.currentBridge=new hu),this.currentBridge.registerUndoDrag(e)}registerDelete(e){this.currentBridge==null&&(this.currentBridge=new hu),this.currentBridge.registerDelete(e)}registerAdd(e){this.createUndoPoint(),this.currentBridge.registerAdd(e)}*entitiesToBeChangedByRedo(){this.currentBridge!=null&&(this.currentBridge.canRedo?yield*this.currentBridge.entities():this.currentBridge.next!=null&&this.currentBridge.next.canRedo&&(yield*this.currentBridge.next.entities()))}*entitiesToBeChangedByUndo(){this.currentBridge!=null&&(this.currentBridge.canUndo?yield*this.currentBridge.entities():this.currentBridge.prev!=null&&this.currentBridge.prev.canUndo&&(yield*this.currentBridge.prev.entities()))}registerForUndo(e){this.currentBridge==null&&(this.currentBridge=new hu),this.currentBridge.addOldNewPair(e,e.getAttr(ae.GeomObjectIndex))}canUndo(){return this.currentBridge==null?!1:!!(this.currentBridge.canUndo||this.currentBridge.prev!=null&&this.currentBridge.prev.canUndo)}canRedo(){return this.currentBridge==null?!1:!!(this.currentBridge.canRedo||this.currentBridge.next!=null&&this.currentBridge.next.canRedo)}undo(){!this.canUndo||(this.currentBridge.canUndo?this.currentBridge.undo():this.currentBridge.prev.undo(),this.currentBridge.prev&&(this.currentBridge=this.currentBridge.prev))}redo(){!this.canRedo||(this.currentBridge.canRedo?this.currentBridge.redo():this.currentBridge.next.redo(),this.currentBridge.next&&(this.currentBridge=this.currentBridge.next))}createUndoPoint(){let e=new hu;if(!this.currentBridge)this.currentBridge=e;else if(this.currentBridge.canUndo)this.currentBridge.next=e,e.prev=this.currentBridge,this.currentBridge=e;else{Ee.assert(this.currentBridge.canRedo);let t=this.currentBridge.prev;t&&(e.prev=t,t.next=e),this.currentBridge=e}}};var Vt=class{constructor(){this.edgesToReroute=new Set;this.objectsToDrag=new Set;this.undoList=new Ag}updateDeltaForDragUndo(e){this.undoList.updateDeltaForDragUndo(e)}registerDelete(e){this.undoList.registerDelete(e)}registerAdd(e){this.undoList.registerAdd(e)}*entitiesToBeChangedByRedo(){yield*this.undoList.entitiesToBeChangedByRedo()}*entitiesToBeChangedByUndo(){yield*this.undoList.entitiesToBeChangedByUndo()}createUndoPoint(){this.undoList.createUndoPoint()}get LayoutSettings(){return this.graph().layoutSettings}get EdgeRoutingMode(){return this.LayoutSettings.commonSettings.edgeRoutingSettings.EdgeRoutingMode}get canUndo(){return this.undoList.canUndo()}get canRedo(){return this.undoList.canRedo()}static calculateAttachmentSegment(e){let t=ce.getGeom(e.parent.entity);if(t!=null)if(Vt.CalculateAttachedSegmentEnd(e,t),f.closeDistEps(e.attachmentSegmentEnd,e.center))e.attachmentSegmentStart=e.center;else{let n=x.intersectionOne(e.boundingBox.perimeter(),R.mkPP(e.attachmentSegmentEnd,e.center),!1);e.attachmentSegmentStart=n!=null?n.x:e.center}}static CalculateAttachedSegmentEnd(e,t){e.attachmentSegmentEnd=t.curve.value(t.curve.closestParameter(e.center))}drag(e,t,n){if(!(e.x==0&&e.y==0)){for(let i of this.objectsToDrag)this.registerForUndoDrag(i.entity);this.geomEdgeWithSmoothedPolylineExposed==null?this.EdgeRoutingMode!==4&&this.EdgeRoutingMode!==5?this.dragObjectsForNonRectilinearCase(e,t):this.DragObjectsForRectilinearCase(e):this.dragPolylineCorner(n,e)}}registerForUndoDrag(e){this.undoList.registerForUndoDrag(e)}DragObjectsForRectilinearCase(e){for(let t of this.objectsToDrag)t instanceof Ge&&t.translate(e);throw gr.CreatePortsAndRouteEdges(this.LayoutSettings.commonSettings.NodeSeparation/3,1,this.graph().nodesBreadthFirst,this.graph().deepEdges,this.LayoutSettings.commonSettings.edgeRoutingSettings.EdgeRoutingMode),Zr.constructorG(this.graph()).run(),this.propagateChangesToClusterParents(),new Error("not implemented")}dragObjectsForNonRectilinearCase(e,t){t===0?this.DragIncrementally(e):this.dragWithStraightLines(e)}dragWithStraightLines(e){for(let t of this.objectsToDrag)t instanceof re?t.deepTranslate(e):t.translate(e);this.propagateChangesToClusterParents(),this.routeEdgesAsStraightLines()}propagateChangesToClusterParents(){let e=new Set;for(let t of this.objectsToDrag){if(!(t instanceof Ge))continue;let n=t;for(let i of n.node.getAncestors()){let o=ce.getGeom(i);o!==this.graph()&&!this.objectsToDrag.has(o)&&e.add(o)}}if(e.size>0)for(let t of this.graph().subgraphsDepthFirst){let n=t;if(e.has(n)){let i=n.getPumpedGraphWithMarginsBox();if(!i.equalEps(n.boundingBox)){this.registerForUndo(n.entity);for(let o of n.selfEdges())this.addToEdgesToReroute(o);for(let o of n.inEdges())this.addToEdgesToReroute(o);for(let o of n.outEdges())this.addToEdgesToReroute(o);n.boundingBox=i}}}}addToEdgesToReroute(e){this.edgesToReroute.add(e)}DragWithSplinesOrBundles(e){for(let t of this.objectsToDrag)t instanceof Ge&&t.translate(e);this.RunSplineRouterAndPutLabels()}RunSplineRouterAndPutLabels(){Fe.mk5(this.graph(),this.LayoutSettings.commonSettings.edgeRoutingSettings.Padding,this.LayoutSettings.commonSettings.edgeRoutingSettings.PolylinePadding,this.LayoutSettings.commonSettings.edgeRoutingSettings.ConeAngle,this.LayoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings).run(),Zr.constructorG(this.graph()).run()}registerForUndo(e){this.undoList.registerForUndo(e)}routeEdgesAsStraightLines(){for(let t of this.edgesToReroute)this.registerForUndo(t.entity),cr.CreateSimpleEdgeCurveWithUnderlyingPolyline(t),t.label&&this.registerForUndo(t.edge.label);Zr.constructorGA(this.graph(),Array.from(this.edgesToReroute)).run()}DragIncrementally(e){this.incrementalDragger==null&&this.InitIncrementalDragger(),this.incrementalDragger.Drag(e)}dragPolylineCorner(e,t){let n=Vt.findClosestCornerForEdit(this.geomEdgeWithSmoothedPolylineExposed.smoothedPolyline,e);n.point=n.point.add(t),n.prev==null?iv(this.geomEdgeWithSmoothedPolylineExposed.source,n):n.next==null&&iv(this.geomEdgeWithSmoothedPolylineExposed.target,n),Vt.createCurveOnChangedPolyline(this.geomEdgeWithSmoothedPolylineExposed)}static dragEdgeWithSite(e,t,n){n.point=n.point.add(e),Vt.createCurveOnChangedPolyline(t)}static createCurveOnChangedPolyline(e){let t=e.smoothedPolyline.createCurve();Ve.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,!1)||Ve.createBigEnoughSpline(e),e.sourcePort=new or(()=>e.source.boundaryCurve,()=>e.source.center,n().sub(e.source.center)),e.targetPort=new or(()=>e.target.boundaryCurve,()=>e.target.center,i().sub(e.target.center));function n(){return e.sourceArrowhead?e.sourceArrowhead.tipPosition:e.curve.start}function i(){return e.targetArrowhead?e.targetArrowhead.tipPosition:e.curve.end}}prepareForObjectDragging(e,t){this.geomEdgeWithSmoothedPolylineExposed=null,this.calculateObjectToDragAndEdgesToReroute(e),this.undoList.createUndoPoint(),t===0&&this.InitIncrementalDragger()}PrepareForClusterCollapseChange(e){throw new Error("not implemented")}InitIncrementalDragger(){this.incrementalDragger=new ry(Array.from(this.objectsToDrag).filter(e=>e instanceof Ge),this.graph(),this.LayoutSettings)}clearDraggedSets(){this.objectsToDrag.clear(),this.edgesToReroute.clear()}addToObjectsToDrag(e){this.objectsToDrag.add(e)}calculateObjectToDragAndEdgesToReroute(e){this.clearDraggedSets();for(let t of e)this.addToObjectsToDrag(t),t instanceof be&&(this.addToObjectsToDrag(t.source),this.addToObjectsToDrag(t.target));this.removeClusterSuccessorsFromObjectsToDrag(),this.calculateDragSetsForEdges()}removeClusterSuccessorsFromObjectsToDrag(){let e=new Array;for(let t of this.objectsToDrag)this.hasAncestorInObjectsToDrag(t)&&e.push(t);for(let t of e)this.objectsToDrag.delete(t)}calculateDragSetsForEdges(){for(let e of Array.from(this.objectsToDrag))e instanceof re?this.addGeomGraphEdgesToRerouteOrDrag(e):e instanceof Ge?this.addNodeEdgesToRerouteOrDrag(e):e instanceof be&&e.edge.label&&this.addToObjectsToDrag(e.edge.label.getAttr(ae.GeomObjectIndex))}addNodeEdgesToRerouteOrDrag(e){Ee.assert(!(e instanceof re));for(let t of e.selfEdges())this.addToObjectsToDrag(t);for(let t of e.inEdges())this.hasSelfOrAncestorInObjectsToDrag(t.source)?this.addToObjectsToDrag(t):this.addToEdgesToReroute(t);for(let t of e.outEdges())this.hasSelfOrAncestorInObjectsToDrag(t.target)?this.addToObjectsToDrag(t):this.addToEdgesToReroute(t);if(e instanceof re)for(let t of e.nodesBreadthFirst)this.addNodeEdgesToRerouteOrDrag(t)}addGeomGraphEdgesToRerouteOrDrag(e){Ee.assert(e instanceof re);for(let t of e.selfEdges())this.addToObjectsToDrag(t);for(let t of e.inEdges())e.isAncestor(t.source)||(this.hasSelfOrAncestorInObjectsToDrag(t.source)?this.addToObjectsToDrag(t):this.addToEdgesToReroute(t));for(let t of e.outEdges())e.isAncestor(t.target)||(this.hasSelfOrAncestorInObjectsToDrag(t.target)?this.addToObjectsToDrag(t):this.addToEdgesToReroute(t));for(let t of e.nodesBreadthFirst){for(let n of t.outEdges()){let i=n.target;e.isAncestor(i)||(this.hasSelfOrAncestorInObjectsToDrag(i)?this.addToObjectsToDrag(n):this.addToEdgesToReroute(n))}for(let n of t.inEdges()){let i=n.source;e.isAncestor(i)||(this.hasSelfOrAncestorInObjectsToDrag(i)?this.addToObjectsToDrag(n):this.addToEdgesToReroute(n))}}}hasSelfOrAncestorInObjectsToDrag(e){for(;e;){if(this.objectsToDrag.has(e))return!0;e=e.parent}return!1}hasAncestorInObjectsToDrag(e){for(e=e.parent;e;){if(this.objectsToDrag.has(e))return!0;e=e.parent}return!1}static CalculateMiddleOffsetsForMultiedge(e,t,n,i){let o=Vt.GetMiddleAnglesOfMultiedge(e,t),a=Array.from(o.values()),l=i*6,u=a.length/2,c=u*2===a.length,h;if(c){h=-(l/2);for(let d=u-1;d>=0;d--){let m=a[d];n.set(m,h),h-=l+(m.label?m.label.width:0)}h=l/2;for(let d=u;d<a.length;d++){let m=a[d];n.set(m,h),h+=l+(m.label?m.label.width:0)}}else{h=0;for(let d=u;d>=0;d--){let m=a[d];n.set(m,h),h=l+(m.label?m.label.width:0)}h=l;for(let d=u+1;d<a.length;d++){let m=a[d];n.set(m,h),h+=l+(m.label?m.label.width:0)}}}static GetMiddleAnglesOfMultiedge(e,t){let n=new wi,i=e[0],o=t.center,a=Vt.Middle(i.curve);n.set(0,i);for(let l=1;l<e.length;l++){let u=e[l],c=Vt.Middle(u.curve),h=f.anglePCP(a,o,c);h>Math.PI&&(h-=Math.PI*2),n.set(h,u)}return n}static Middle(e){return e.value(.5*e.parStart+.5*e.parEnd)}static*GetMultiEdges(e){let t=new Map;for(let n of e.outEdges())Vt.GetOrCreateListOfMultiedge(t,n.target).push(n);for(let n of e.inEdges())Vt.GetOrCreateListOfMultiedge(t,n.source).push(n);for(let n of t.values())n.length>1&&(yield n)}static GetOrCreateListOfMultiedge(e,t){let n=e.get(t);return n||(e.set(t,n=[]),n)}prepareForGeomEdgeChange(e){Ee.assert(this.geomEdgeWithSmoothedPolylineExposed===e),this.createUndoPoint(),this.registerForUndo(e.edge)}undo(){this.undoList.undo()}redo(){this.undoList.redo()}clear(){this.objectsToDrag=new Set,this.edgesToReroute.clear(),this.undoList=new Ag}static getPreviousCornerSite(e,t){let n=e.smoothedPolyline.headSite,i=n.next;for(;i!=null;){if(Vt.betweenSites(n,i,t))return n;n=i,i=i.next}return null}static betweenSites(e,t,n){let i=R.closestParameterOnLineSegment(n,e.point,t.point);return i>.1&&i<.9}insertSite(e,t,n){this.prepareForGeomEdgeChange(e);let i=Be.mkSiteSPS(n,t,n.next);Vt.dragEdgeWithSite(new f(0,0),e,i)}deleteSite(e,t){this.prepareForGeomEdgeChange(e),Ee.assert(this.geomEdgeWithSmoothedPolylineExposed===e),t.prev.next=t.next,t.next.prev=t.prev,Vt.dragEdgeWithSite(new f(0,0),e,t.prev)}static findClosestCornerForEdit(e,t,n=Number.POSITIVE_INFINITY){n!==Number.POSITIVE_INFINITY&&(n*=n);let i=e.headSite,o=i,a=o.point.sub(t).lengthSquared;for(;i.next!=null;){i=i.next;let l=t.sub(i.point).lengthSquared;l<a&&(o=i,a=l)}return a>n?null:o}ReactOnViewChange(){}ForgetDragging(){this.incrementalDragger=null}};function iv(s,e){let t=s.boundaryCurve;if(x.PointRelativeToCurveLocation(e.point,t)!=0)return;let i=R.mkPP(s.center,e.point),o=x.intersectionOne(i,t,!1);o&&(e.point=o.x)}function wt(s){return s.getAttr(ae.ViewerIndex)}function oh(s){return ce.getGeom(s.entity)}function FN(s){return s&&s.entity instanceof tt}var jt=class{constructor(e){this.RadiusOfPolylineCorner=10;this.geomEdge=new be(null);this.EdgeAttr=new _t(null,!0);this.arrowheadLength=Ve.defaultArrowheadLength;this.dragGroup=new Set;this.geomGraphEditor=new Vt;this.mouseMoveThreshold=.05;this.sourceLoosePolylineWrap={loosePolyline:null};this.sourceOfInsertedEdgeWrap={node:null};this.sourcePortWrap={port:null};this.targetOfInsertedEdgeWrap={node:null};this.targetPortWrap={port:null};this.dragging=!1;this.edgeAttr=new _t(null,!0);this.viewer=e,this.decorateObjectForDragging=this.defaultObjectDecorator,this.removeObjDraggingDecorations=this.defaultObjectDecoratorRemover,this.DecorateEdgeForDragging=jt.TheDefaultEdgeDecoratorStub,this.decorateEdgeLabelForDragging=this.defaultEdgeLabelDecorator,this.RemoveEdgeDraggingDecorations=jt.TheDefaultEdgeDecoratorStub,this.geomGraphEditor.graph=()=>re.getGeom(this._graph)}resizeLabel(e,t){let n=t.getAttr(ae.DrawingObjectIndex);n.labelText=e,this.viewer.invalidate(t.getAttr(ae.ViewerIndex))}get hasEdgeInsertionPort(){return this.SourcePort!=null||this.TargetPort!=null}get insertingEdge(){return this.insertionMode==2}createUndoPoint(){this.geomGraphEditor.createUndoPoint()}registerDelete(e){this.geomGraphEditor.registerDelete(e)}registerAdd(e){this.geomGraphEditor.registerAdd(e)}forget(e){this.dragGroup.delete(e),this.edgeWithSmoothedPolylineExposed===e&&(this.edgeWithSmoothedPolylineExposed=null)}get edgeWithSmoothedPolylineExposed(){return this._edgeWithSmoothedPolylineExposed}set edgeWithSmoothedPolylineExposed(e){this._edgeWithSmoothedPolylineExposed!==e&&this._edgeWithSmoothedPolylineExposed&&(this._edgeWithSmoothedPolylineExposed.selectedForEditing=!1),this._edgeWithSmoothedPolylineExposed=e,e?(e.selectedForEditing=!0,this.geomGraphEditor.geomEdgeWithSmoothedPolylineExposed=be.getGeom(e.edge)):this.geomGraphEditor.geomEdgeWithSmoothedPolylineExposed=null}get ActiveDraggedObject(){return this.aActiveDraggedObject}set ActiveDraggedObject(e){this.aActiveDraggedObject=e}get interactiveEdgeRouter(){return this._interactiveEdgeRouter}set interactiveEdgeRouter(e){this._interactiveEdgeRouter=e}ViewerObjectUnderMouseCursorChanged(e,t){this.TargetPort!=null&&(this.viewer.RemoveTargetPortEdgeRouting(),this.TargetPort=null)}ViewChangeEventHandler(e,t){this._graph!=null}get graph(){return this._graph}set graph(e){this._graph=e,this.geomGraphEditor.clear()}get MouseMoveThreshold(){return this.mouseMoveThreshold}set MouseMoveThreshold(e){this.mouseMoveThreshold=e}get DecorateEdgeForDragging(){return this.decorateEdgeForDragging}set DecorateEdgeForDragging(e){this.decorateEdgeForDragging=e}get RemoveEdgeDraggingDecorations(){return this.removeEdgeDraggingDecorations}set RemoveEdgeDraggingDecorations(e){this.removeEdgeDraggingDecorations=e}get NodeInsertPredicate(){return this.nodeInsertPredicate}set NodeInsertPredicate(e){this.nodeInsertPredicate=e}get SourceOfInsertedEdge(){return this.sourceOfInsertedEdgeWrap.node}set SourceOfInsertedEdge(e){this.sourceOfInsertedEdgeWrap.node=e}get TargetOfInsertedEdge(){return this.targetOfInsertedEdgeWrap.node}set TargetOfInsertedEdge(e){this.targetOfInsertedEdgeWrap.node=e}get SourcePort(){return this.sourcePortWrap.port}set SourcePort(e){this.sourcePortWrap.port=e}get TargetPort(){return this.targetPortWrap.port}set TargetPort(e){this.targetPortWrap.port=e}get CanUndo(){return this.geomGraphEditor.canUndo}get CanRedo(){return this.geomGraphEditor.canRedo}get insertionMode(){return this.viewer==null?0:this.viewer.insertionMode}set insertionMode(e){this.viewer!=null&&(this.viewer.insertionMode=e)}viewerGraphChanged(){this._graph=this.viewer.graph,this.geomGraphEditor.clear(),this._graph!=null&&re.getGeom(this._graph)!=null&&this.geomGraphEditor.clear(),this.ActiveDraggedObject=null,this.dragGroup.clear(),this.cleanObstacles()}cleanObstacles(){this.interactiveEdgeRouter=null,this.looseObstaclesToTheirViewerNodes=null,this.SourceOfInsertedEdge=null,this.TargetOfInsertedEdge=null,this.SourcePort=null,this.TargetPort=null,this.viewer.RemoveSourcePortEdgeRouting(),this.viewer.RemoveTargetPortEdgeRouting()}RelayoutOnIsCollapsedChanged(e){this.geomGraphEditor.PrepareForClusterCollapseChange([e]);let t=re.getGeom(e.node);t.isCollapsed?this.CollapseCluster(e.node):this.ExpandCluster(t);for(let n of this.geomGraphEditor.entitiesToBeChangedByUndo())this.invalidate(n)}relayout(e){let t=e;for(;t.parent!=null;)t=t.parent;hc(t),this.MakeExpandedNodesVisible(e.entity)}ExpandCluster(e){e!=null&&this.relayout(e)}MakeExpandedNodesVisible(e){for(let t of e.shallowNodes){let n=wt(t);jt.UnhideNodeEdges(t),n.isVisible=!0,t instanceof de&&t.getAttr(ae.GeomObjectIndex).isCollapsed==!1&&this.MakeExpandedNodesVisible(t)}}static UnhideNodeEdges(e){for(let t of e.selfEdges){let n=wt(t);n.isVisible=!0}for(let t of e.outEdges)wt(t.target).isVisible&&(wt(t).isVisible=!0);for(let t of e.inEdges)wt(t.source).isVisible&&(wt(t).isVisible=!0)}CollapseCluster(e){jt.HideCollapsed(e);let t=re.getGeom(e),n=t.center;t.boundingBox=z.mkSizeCenter(t.labelSize,n),this.relayout(t)}static HideCollapsed(e){for(let t of e.shallowNodes)wt(t).isVisible=!1,t instanceof de&&re.getGeom(t).isCollapsed==!1&&jt.HideCollapsed(t)}defaultObjectDecorator(e){if(e.entity instanceof er){this.decorateEdgeLabelForDragging(e);return}let t=ct.getDrawingObj(e.entity),n=t.penwidth;e.unmarkedForDraggingCallback||(e.unmarkedForDraggingCallback=()=>De.getDrawingObj(e.entity).penwidth=n),t.penwidth=Math.max(this.viewer.LineThicknessForEditing,n*2),this.invalidate(e.entity)}defaultObjectDecoratorRemover(e){let t=e.unmarkedForDraggingCallback;t&&(t(),e.unmarkedForDraggingCallback=null,this.invalidate(e.entity));let n=e.entity;if(n instanceof tt)for(let i of n.edges)this.removeObjDraggingDecorations(wt(i))}static TheDefaultEdgeDecoratorStub(e){}defaultEdgeLabelDecorator(e){let t=e.entity.getAttr(ae.GeomObjectIndex);e.markedForDragging&&(Vt.calculateAttachmentSegment(t),e.unmarkedForDraggingCallback=()=>{this.invalidate(e.entity)}),this.invalidate(e.entity)}static LeftButtonIsPressed(e){return(e.buttons&1)==1}static MiddleButtonIsPressed(e){return(e.buttons&4)==4}static RightButtonIsPressed(e){return(e.buttons&2)==2}MouseDownPointAndMouseUpPointsAreFarEnoughOnScreen(e){let t=e.clientX,n=e.clientY,i=(this.mouseDownScreenPoint.x-t)/this.viewer.DpiX,o=(this.mouseDownScreenPoint.y-n)/this.viewer.DpiY;return Math.sqrt(i*i+o*o)>this.MouseMoveThreshold/3}analyzeLeftMouseButtonClick(e){this.edgeWithSmoothedPolylineExposed?this.toggleCornerForSelectedEdge():this.viewer.objectUnderMouseCursor&&this.analyzeLeftMouseButtonClickOnObjectUnderCursor(e)}analyzeLeftMouseButtonClickOnObjectUnderCursor(e){let t=this.viewer.objectUnderMouseCursor,n=e.ctrlKey||e.shiftKey,i=t.entity;if(i instanceof et){let o=i.getAttr(ae.GeomObjectIndex);o!=null&&this.viewer.layoutEditingEnabled&&(o.smoothedPolyline==null&&(o.smoothedPolyline=jt.CreateUnderlyingPolyline(o)),this.edgeWithSmoothedPolylineExposed!==t&&this.switchToEdgeEditing(t))}else t.markedForDragging?this.unselectForDragging(t):(n||this.unselectEverything(),this.selectObjectForDragging(t)),this.unselectEdge()}toggleCornerForSelectedEdge(){let e=Vt.findClosestCornerForEdit(be.getGeom(this.edgeWithSmoothedPolylineExposed.edge).smoothedPolyline,this.mouseDownGraphPoint,this.edgeWithSmoothedPolylineExposed.radiusOfPolylineCorner);if(e==null)this.tryInsertCorner();else{if(e.prev==null||e.next==null)return;this.geomGraphEditor.createUndoPoint(),this.geomGraphEditor.registerForUndo(this.edgeWithSmoothedPolylineExposed.edge),this.geomGraphEditor.deleteSite(be.getGeom(this.edgeWithSmoothedPolylineExposed.edge),e),this.invalidate(this.edgeWithSmoothedPolylineExposed.entity)}}tryInsertCorner(){if(!this.closeEnoughToSelectedEdge())this.unselectEdge();else{let e=Vt.getPreviousCornerSite(be.getGeom(this.edgeWithSmoothedPolylineExposed.edge),this.mouseDownGraphPoint);if(e==null||e.next==null)return;this.geomGraphEditor.insertSite(be.getGeom(this.edgeWithSmoothedPolylineExposed.edge),this.mouseDownGraphPoint,e),this.invalidate(this.edgeWithSmoothedPolylineExposed.edge)}}closeEnoughToSelectedEdge(){let e=be.getGeom(this.edgeWithSmoothedPolylineExposed.edge).curve,t=e.closestParameter(this.mouseDownGraphPoint);return e.value(t).sub(this.mouseDownGraphPoint).length<this.edgeWithSmoothedPolylineExposed.radiusOfPolylineCorner}static CreateUnderlyingPolyline(e){return Ue.mkFromPoints(jt.CurvePoints(e))}static*CurvePoints(e){if(yield e.source.center,e.curve instanceof x){let n=e.curve;n.segs.length>0&&(yield n.start);for(let i=0;i<n.segs.length;i++)yield n.segs[i].end}yield e.target.center}ModifierKeyIsPressed(){return(this.viewer.modifierKeys&2)==2||(this.viewer.modifierKeys&4)==4}switchToEdgeEditing(e){this.unselectEverything(),this.edgeWithSmoothedPolylineExposed=e,e.radiusOfPolylineCorner=this.viewer.smoothedPolylineCircleRadius,this.DecorateEdgeForDragging(e),this.invalidate(e.entity)}*ViewerNodes(){for(let e of this.viewer.entities)e.entity instanceof tt&&(yield e.entity.getAttr(ae.ViewerIndex))}selectObjectForDragging(e){e.markedForDragging==!1&&(e.markedForDragging=!0,this.dragGroup.add(e),this.decorateObjectForDragging(e))}prepareToRemoveFromDragGroup(e){e.markedForDragging=!1,this.removeObjDraggingDecorations(e)}unselectForDragging(e){this.prepareToRemoveFromDragGroup(e),this.dragGroup.delete(e)}unselectEverything(){for(let e of this.dragGroup)this.prepareToRemoveFromDragGroup(e);this.dragGroup.clear(),this.unselectEdge()}unselectEdge(){this.edgeWithSmoothedPolylineExposed!=null&&(this.edgeWithSmoothedPolylineExposed.selectedForEditing=!1,this.removeEdgeDraggingDecorations(this.edgeWithSmoothedPolylineExposed),this.invalidate(this.edgeWithSmoothedPolylineExposed.edge),this.edgeWithSmoothedPolylineExposed=null)}static*Edges(e){for(let t of e.entity.edges)yield wt(t)}viewerMouseDown(e,t){if(!this.viewer.layoutEditingEnabled||this.viewer.graph==null||(this.viewer.setObjectUnderCursorFromEvent(t),this.mouseDownGraphPoint=this.viewer.screenToSource(t),this.mouseDownScreenPoint=new f(t.clientX,t.clientY),!jt.LeftButtonIsPressed(t)))return!1;if(this.leftMouseButtonWasPressed=!0,this.insertingEdge)return!0;if(this.insertionMode==1)return this.insertNode(),!0;if(this.edgeWithSmoothedPolylineExposed!=null)return this.mouseIsInsideOfCornerSite(t)&&t.preventDefault(),!0;let n=this.viewer.objectUnderMouseCursor;return n&&!this.viewer.objectUnderMouseCursor.hasOwnProperty("edge")?(this.ActiveDraggedObject=n,!0):this.ActiveDraggedObject!=null?(t.preventDefault(),!0):!1}insertNode(){let e=this.findNodeID(),t=new tt(e);this._graph.addNode(t),new ct(t);let n=this.viewer.createIViewerNodeN(t,this.mouseDownGraphPoint);this.viewer.addNode(n,!0)}findNodeID(){let e=0,t="node"+e.toString();for(;this._graph.findNode(t);)t="node"+ ++e;return t}viewerMouseMove(e,t){!this.viewer.layoutEditingEnabled||(jt.LeftButtonIsPressed(t)?(console.log("lefb"),this.ActiveDraggedObject!=null||this.activeCornerSite!=null?this.drag(t):this.insertingEdge?this.mouseMoveInsertEdgeLeftButtonOn(t):this.MouseMoveLiveSelectObjectsForDragging(t)):this.insertingEdge&&this.mouseMoveInsertEdgeNoButtons(t))}setDraggingFlag(e){!this.dragging&&this.MouseDownPointAndMouseUpPointsAreFarEnoughOnScreen(e)&&(this.dragging=!0)}TrySetNodePort(e,t,n,i){if(this.graph==null)return;Ee.assert(this.insertingEdge);let o=this.viewer.screenToSource(e);return i.loosePolyline=null,this.DraggingStraightLine()?t.node=this.setPortWhenDraggingStraightLine(n,o):(this.interactiveEdgeRouter==null&&this.PrepareForEdgeDragging(),i.loosePolyline=this.interactiveEdgeRouter.GetHitLoosePolyline(o),i.loosePolyline!=null?this.SetPortUnderLoosePolyline(o,i.loosePolyline,t,n):(t.node=null,n.port=null)),n.port!=null}setPortWhenDraggingStraightLine(e,t){if(FN(this.viewer.objectUnderMouseCursor)){let n=this.viewer.objectUnderMouseCursor,i={portParameter:0},o=oh(n);return this.NeedToCreateBoundaryPort(t,n,i)?e.port=this.CreateOrUpdateCurvePort(i.portParameter,o,e.port):jt.PointIsInside(t,o.boundaryCurve)?e.port=this.CreateFloatingPort(o,t):e.port=null,n}return e.port=null,null}CreateOrUpdateCurvePort(e,t,n){if(!(n instanceof ar))return ar.mk(t.boundaryCurve,e);let o=n;return o.parameter=e,o.curve=t.boundaryCurve,n}CreateFloatingPort(e,t){return new ir(e.boundaryCurve,t)}SetPortUnderLoosePolyline(e,t,n,i){let o=Number.POSITIVE_INFINITY,a=0;for(let l of this.GetViewerNodesInsideOfLooseObstacle(t)){let u=l.entity.getAttr(ae.GeomObjectIndex).boundaryCurve;if(jt.PointIsInside(e,u)){n.node=l,this.SetPortForMousePositionInsideOfNode(e,n.node,i);return}let c=u.closestParameter(e),h=u.value(c).sub(e).length;h<o&&(a=c,o=h,n.node=l)}i.port=this.CreateOrUpdateCurvePort(a,oh(n.node),i.port)}GetViewerNodesInsideOfLooseObstacle(e){return this.looseObstaclesToTheirViewerNodes==null&&this.InitLooseObstaclesToViewerNodeMap(),this.looseObstaclesToTheirViewerNodes.get(e)}InitLooseObstaclesToViewerNodeMap(){this.looseObstaclesToTheirViewerNodes=new Map;for(let e of this.ViewerNodes()){let t=this.interactiveEdgeRouter.GetHitLoosePolyline(oh(e).center),n=this.looseObstaclesToTheirViewerNodes.get(t);n==null&&this.looseObstaclesToTheirViewerNodes.set(t,n=new Array),n.push(e)}}SetPortForMousePositionInsideOfNode(e,t,n){let i=oh(t),o={portParameter:0};this.NeedToCreateBoundaryPort(e,t,o)?n.port=this.CreateOrUpdateCurvePort(o.portParameter,i,n.port):n.port=this.CreateFloatingPort(i,e)}static PointIsInside(e,t){return x.PointRelativeToCurveLocation(e,t)==2}NeedToCreateBoundaryPort(e,t,n){let i=t.entity.getAttr(ae.DrawingObjectIndex),o=oh(t).boundaryCurve;n.portParameter=o.closestParameter(e);let a=o.value(n.portParameter);return e.sub(a).length<=this.viewer.smoothedPolylineCircleRadius*2+i.penwidth/2?(this.TryToSnapToTheSegmentEnd(n,o,a),!0):!1}TryToSnapToTheSegmentEnd(e,t,n){if(t instanceof x){let i=t.getSegIndexParam(e.portParameter),o=i.par,a=t.segs[i.segIndex];o-a.parStart<a.parEnd-o&&(a.start.sub(n).length<this.viewer.smoothedPolylineCircleRadius*2?e.portParameter-=o-a.parStart:a.end.sub(n).length<this.viewer.smoothedPolylineCircleRadius*2&&(e.portParameter+=+(a.parEnd-o)))}}drag(e){if(!this.dragging)if(this.MouseDownPointAndMouseUpPointsAreFarEnoughOnScreen(e))this.prepareFirstTimeDragging();else return;let t=this.viewer.screenToSource(e);this.handleTheMouseCursorOutOfTheBoundingBox(t),this.geomGraphEditor.drag(t.sub(this._lastDragPoint),this.GetDraggingMode(),this._lastDragPoint);for(let n of this.geomGraphEditor.entitiesToBeChangedByUndo())this.invalidate(n);e.stopPropagation(),this._lastDragPoint=t}prepareFirstTimeDragging(){this.dragging=!0,this.activeCornerSite!=null?this.geomGraphEditor.prepareForGeomEdgeChange(this.edgeWithSmoothedPolylineExposed.edge.getAttr(ae.GeomObjectIndex)):this.ActiveDraggedObject!=null&&(this.unselectEdge(),this.ActiveDraggedObject.markedForDragging||this.unselectEverything(),this.prepareForDragging()),this._lastDragPoint=this.mouseDownGraphPoint}handleTheMouseCursorOutOfTheBoundingBox(e){let t=this.viewer.smoothedPolylineCircleRadius,n=z.mkSizeCenter(new vt(t,t),e),i=re.getGeom(this._graph);i.boundingBox.containsRect(n)||(this.geomGraphEditor.registerForUndo(this._graph),i.boundingBox=i.boundingBox.addRec(n),this.invalidate(this._graph))}prepareForDragging(){this.selectObjectForDragging(this.ActiveDraggedObject),this.geomGraphEditor.prepareForObjectDragging(this.DraggedGeomObjects(),this.GetDraggingMode())}GetDraggingMode(){return(this.viewer.modifierKeys&4)==4||this.viewer.IncrementalDraggingModeAlways?0:1}static RouteEdgesRectilinearly(e){let t=e.graph.getAttr(ae.GeomObjectIndex),n=t.layoutSettings;gr.CreatePortsAndRouteEdges(n.commonSettings.NodeSeparation/3,1,t.nodesBreadthFirst,t.deepEdges,n.commonSettings.edgeRoutingSettings.EdgeRoutingMode),Zr.constructorG(t).run()}*DraggedGeomObjects(){let e=jt.GetActiveObjectCluster(this.ActiveDraggedObject);for(let t of this.dragGroup)jt.GetActiveObjectCluster(t)==e&&(yield ce.getGeom(t.entity))}static GetActiveObjectCluster(e){return e.entity.parent}viewerMouseUp(e,t){t.defaultPrevented||!this.viewer.layoutEditingEnabled||this.handleMouseUpOnLayoutEnabled(t)}handleMouseUpOnLayoutEnabled(e){if(!this.MouseDownPointAndMouseUpPointsAreFarEnoughOnScreen(e)&&this.leftMouseButtonWasPressed)this.viewer.objectUnderMouseCursor!=null||this.edgeWithSmoothedPolylineExposed!=null?(this.analyzeLeftMouseButtonClick(e),e.preventDefault()):this.unselectEverything();else if(this.dragging){this.insertingEdge?this.InsertEdgeOnMouseUp():(this.geomGraphEditor.updateDeltaForDragUndo(this.mouseDownGraphPoint.sub(this._lastDragPoint)),this.interactiveEdgeRouter=null,this.looseObstaclesToTheirViewerNodes=null);let n=re.getGeom(this._graph),i=n.getPumpedGraphWithMarginsBox();i.equal(n.boundingBox)||(this.geomGraphEditor.registerForUndo(this._graph),n.boundingBox=i,this.invalidate(this._graph),e.preventDefault())}this.dragging=!1,this.geomGraphEditor.ForgetDragging(),this.activeCornerSite=null,this.ActiveDraggedObject=null,this.leftMouseButtonWasPressed=!1,this.TargetPort!=null&&this.viewer.RemoveTargetPortEdgeRouting(),this.SourcePort!=null&&this.viewer.RemoveSourcePortEdgeRouting(),this.TargetOfInsertedEdge=null,this.SourceOfInsertedEdge=null,this.TargetPort=null,this.SourcePort=null}InsertEdgeOnMouseUp(){if(this.viewer.stopDrawingRubberEdge(),this.TargetPort!=null){let e=this.FinishRoutingEdge();this.addEdgeToTheViewer(e)}this.interactiveEdgeRouter.Clean()}addEdgeToTheViewer(e){let t=this.viewer.createEdgeWithGivenGeometry(e);this.viewer.addEdge(t,!0)}mkArrowhead(){let e=new Ve;return e.length=this.arrowheadLength,e}FinishRoutingEdge(){let e=new et(this.sourceOfInsertedEdgeWrap.node.entity,this.targetOfInsertedEdgeWrap.node.entity);e.add();let t=this.EdgeAttr.clone();return t.rebind(e),this.geomEdge.rebind(e),this.geomEdge.sourceArrowhead=t.arrowtail==6?null:this.mkArrowhead(),this.geomEdge.targetArrowhead=t.arrowhead==6?null:this.mkArrowhead(),this.TargetOfInsertedEdge!=this.SourceOfInsertedEdge?(this.geomEdge.curve instanceof R||(this.interactiveEdgeRouter.TryToRemoveInflectionsAndCollinearSegments(this.geomEdge.smoothedPolyline),this.interactiveEdgeRouter.SmoothenCorners(this.geomEdge.smoothedPolyline),this.geomEdge.curve=this.geomEdge.smoothedPolyline.createCurve()),Ve.trimSplineAndCalculateArrowheads(this.geomEdge,this.geomEdge.curve,!0)):this.geomEdge=jt.CreateEdgeGeometryForSelfEdge(this.SourceOfInsertedEdge.entity),this.viewer.RemoveSourcePortEdgeRouting(),this.viewer.RemoveTargetPortEdgeRouting(),e}static CreateEdgeGeometryForSelfEdge(e){let t=new et(e,e),n=new be(t);return cr.CreateSimpleEdgeCurveWithUnderlyingPolyline(n),n}SelectEntitiesForDraggingWithRectangle(e){}mouseIsInsideOfCornerSite(e){let t=this.viewer.screenToSource(e),n=this.edgeWithSmoothedPolylineExposed.edge.getAttr(ae.DrawingObjectIndex).penwidth;return this.activeCornerSite=Vt.findClosestCornerForEdit(be.getGeom(this.edgeWithSmoothedPolylineExposed.edge).smoothedPolyline,t,this.edgeWithSmoothedPolylineExposed.radiusOfPolylineCorner+n),this.activeCornerSite!==null}MouseScreenPointIsCloseEnoughToVertex(e,t){return e.sub(this.mouseDownGraphPoint).length<t}invalidate(e){let t=wt(e);if(!!t){if(t.entity instanceof er){if(t.markedForDragging){let n=ce.getGeom(t.entity);Vt.calculateAttachmentSegment(n)}}else t.entity instanceof et&&t.entity.label&&this.viewer.invalidate(wt(t.entity.label));if(this.viewer.invalidate(t),e instanceof de){for(let n of e.nodesBreadthFirst)this.viewer.invalidate(wt(n));for(let n of e.deepEdges)this.viewer.invalidate(wt(n)),n.label&&this.viewer.invalidate(wt(n.label))}}}undo(){if(this.geomGraphEditor.canUndo){let e=new Set(this.geomGraphEditor.entitiesToBeChangedByUndo());this.geomGraphEditor.undo();for(let t of e){let n=wt(t);n.markedForDragging?this.dragGroup.add(n):this.dragGroup.delete(n),this.invalidate(t)}}}redo(){if(this.geomGraphEditor.canRedo){let e=new Set(this.geomGraphEditor.entitiesToBeChangedByRedo());this.geomGraphEditor.redo();for(let t of e){let n=wt(t);n.markedForDragging?this.dragGroup.add(n):this.dragGroup.delete(n),this.invalidate(t)}}}static RectRouting(e){return e==4||e==5}PrepareForEdgeDragging(){if(this.viewer.graph==null||this.DraggingStraightLine())return;let e=re.getGeom(this.viewer.graph).layoutSettings;if(!jt.RectRouting(e.commonSettings.edgeRoutingSettings.EdgeRoutingMode)&&this.interactiveEdgeRouter==null){let t=e.commonSettings.NodeSeparation/3,n=.65*t;this.interactiveEdgeRouter=ze.constructorANNN(Array.from(this._graph.nodesBreadthFirst).map(i=>Ge.getGeom(i).boundaryCurve),t,n,0)}}mouseMoveInsertEdgeNoButtons(e){let t=this.SourceOfInsertedEdge;this.TrySetNodePort(e,this.sourceOfInsertedEdgeWrap,this.sourcePortWrap,this.sourceLoosePolylineWrap)?this.viewer.SetSourcePortForEdgeRouting(this.sourcePortWrap.port.Location):t!=null&&this.viewer.RemoveSourcePortEdgeRouting()}mouseMoveInsertEdgeLeftButtonOn(e){if(this.SourcePort!=null){if(this.setDraggingFlag(e),this.dragging){let t={loosePolyline:null};this.TrySetNodePort(e,this.targetOfInsertedEdgeWrap,this.targetPortWrap,t)?(this.viewer.setTargetPortForEdgeRouting(this.targetPortWrap.port.Location),this.drawEdgeInteractivelyToPort(t.loosePolyline,this.DraggingStraightLine())):(this.viewer.RemoveTargetPortEdgeRouting(),this.DrawEdgeInteractivelyToLocation(e,this.DraggingStraightLine()))}e.preventDefault()}}MouseMoveLiveSelectObjectsForDragging(e){this.unselectEverything(),_N(e)&&(this.viewer.modifierKeys&4)!=4&&this.SelectEntitiesForDraggingWithRectangle(e)}DrawEdgeInteractivelyToLocation(e,t){this.DrawEdgeInteractivelyToLocationP(this.viewer.screenToSource(e),t)}DrawEdgeInteractivelyToLocationP(e,t){this.geomEdge=t?this.getStraightLineEdge(e):this.CalculateEdgeInteractivelyToLocation(e),this.viewer.drawRubberEdge(this.geomEdge)}getStraightLineEdge(e){let t=new be(null);return t.curve=R.mkPP(this.SourcePort.Location,e),t}CalculateEdgeInteractivelyToLocation(e){return this.interactiveEdgeRouter.SourcePort==null&&this.interactiveEdgeRouter.SetSourcePortAndSourceLoosePolyline(this.SourcePort,this.sourceLoosePolylineWrap.loosePolyline),this.interactiveEdgeRouter.RouteEdgeToLocation(e)}drawEdgeInteractivelyToPort(e,t){this.geomEdge=t?this.getStraightLineEdge(this.TargetPort.Location):this.CalculateEdgeInteractively(this.TargetPort,e),this.viewer.drawRubberEdge(this.geomEdge)}DraggingStraightLine(){return this.viewer.graph==null?!0:this.interactiveEdgeRouter!=null&&this.interactiveEdgeRouter.OverlapsDetected}CalculateEdgeInteractively(e,t){this.interactiveEdgeRouter.SourcePort==null&&this.interactiveEdgeRouter.SetSourcePortAndSourceLoosePolyline(this.SourcePort,this.sourceLoosePolylineWrap.loosePolyline);let n,i=null;if(this.SourceOfInsertedEdge==this.TargetOfInsertedEdge)n=R.mkPP(this.SourcePort.Location,this.TargetPort.Location);else{let a={smoothedPolyline:null};n=this.interactiveEdgeRouter.RouteEdgeToPort(e,t,!1,a),i=a.smoothedPolyline}let o=new be(null);return o.curve=n,o.smoothedPolyline=i,o}};function _N(s){return(s.buttons&1)==1}var vg=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(vg||{});var Tg=(i=>(i[i.forward=0]="forward",i[i.back=1]="back",i[i.both=2]="both",i[i.none=3]="none",i))(Tg||{});var Ig=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(Ig||{});var xt=class extends ct{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get defaultNodeObject(){return this._defaultNodeObject}set defaultNodeObject(e){this._defaultNodeObject=e}static getDrawingGraph(e){return De.getDrawingObj(e)}get graph(){return this.entity}findNode(e){let n=this.graph.findNode(e);return n==null?null:De.getDrawingObj(n)}hasDirectedEdge(){for(let e of this.graph.deepEdges)if(De.getDrawingObj(e).directed)return!0;return!1}createGeometry(e=t=>t?new vt(t.length*8+8,20):null){let t=new re(this.graph);this.textMeasure=e;let n={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};t.labelSize=e(this.labelText,n);for(let i of this.graph.nodesBreadthFirst)this.createNodeGeometry(i);for(let i of this.graph.deepEdges)this.createEdgeGeometry(i);if(this.rankdir){let i=t.layoutSettings=new Ot;i.layerDirection=this.rankdir}return t}createEdgeGeometry(e){let t=_t.getDrawingObj(e),n=new be(e);if(t.arrowhead!=6?n.targetArrowhead=new Ve:n.targetArrowhead=null,t.arrowtail!=6?n.sourceArrowhead=new Ve:n.sourceArrowhead=null,t.labelText){let i=this.textMeasure(t.labelText,{fontSize:t.fontsize,fontFamily:t.fontname,fontStyle:"normal"}),o=e.label=new er(e);new Ur(o,z.mkPP(new f(0,0),new f(i.width,i.height))),t.measuredTextSize=i}t.penwidth&&(n.lineWidth=t.penwidth)}curveByShape(e,t,n,i){let o;switch(i.shape){case 0:o=Ce.mkDiamond(e,t,n);break;case 1:o=Ce.mkEllipse(e/1.6,t/1.6,n);break;case 4:case 2:o=Ce.mkRectangleWithRoundedCorners(e,t,i.XRadius,i.YRadius,n);break;case 3:o=Ce.mkCircle(Math.sqrt(e*e+t*t),n);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:o=Ce.mkCircle(Math.sqrt(e*e+t*t)+2*i.penwidth,n);break;case 11:o=Ce.createHouse(e,t,n);break;case 12:o=Ce.createInvertedHouse(e,t,n);break;case 13:o=Ce.createParallelogram(e,t,n);break;case 14:o=Ce.createOctagon(e,t,n);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:o=Ce.createHexagon(e,t,n);break}return o!=null?o:Ce.mkRectangleWithRoundedCorners(e,t,i.XRadius,i.YRadius,n)}createNodeGeometry(e,t=new f(0,0)){if(e instanceof de){let n=De.getDrawingObj(e),i=new re(e);n.labelText&&(i.labelSize=n.measuredTextSize=oy(n,this.textMeasure))}else{let n=ct.getDrawingObj(e),i=new vt(1,1);n.labelText&&(i=oy(n,this.textMeasure)),n.measuredTextSize=i;let o=new Ge(e),a=i.width+n.LabelMargin*2,l=i.height+n.LabelMargin*2;o.boundaryCurve=this.curveByShape(a,l,t,n)}}measureLabelSizes(e){var t;for(let n of this.graph.nodesBreadthFirst){let i=ct.getDrawingObj(n);i.measuredTextSize=(t=oy(i,e))!=null?t:new vt(1,1)}}};function oy(s,e){return s.labelText?e(s.labelText,{fontSize:s.fontsize,fontFamily:s.fontname,fontStyle:"normal"}):null}var VN=4;var sv=kN({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},VN);function kN(s,e){for(let t in s){let n=s[t];n.x*=e,n.y*=e,n.width*=e,n.height*=e,n.anchorX&&(n.anchorX*=e),n.anchorY&&(n.anchorY*=e)}return s}var bi={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var av=`
uniform sampler2D nodeDepth;
uniform vec2 textureDim;

vec2 getCoordinate(vec3 nodeIdx) {
  // index = r + g * 256 + b * 65536
  // textureDim.x is always power of 2 and <= 65536
  // avoid making big integers (float32 precision)
  float x = nodeIdx.r + nodeIdx.g * 256.0;
  float y = floor(x / textureDim.x);
  x -= y * textureDim.x;
  y += 65536.0 / textureDim.x * nodeIdx.b;
  return vec2(x + 0.5, y + 0.5) / textureDim;
}

bool getDepth(vec3 nodeIdx, out float depth) {
  vec2 coord = getCoordinate(nodeIdx);
  vec4 c = texture2D(nodeDepth, coord);
  depth = c.r * 255.0;
  return c.a == 0.0;
}
`,zCe=new Uint8Array(4);var UN={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColors:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPickingColor:{type:"accessor",value:[0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},WN=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

${av}

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  float depth;
  if (getDepth(instancePickingColors, depth)) {
    applyHighlight(int(depth));
  }
}
`,zN=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  return smoothedgeCommon(length(cornerVec), radius) * inside;
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,za=class extends on{getShaders(){return super.getShaders({vs:WN,fs:zN,modules:[Ki,Ls]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:bi.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:bi.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:bi.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:bi.UNSIGNED_BYTE,accessor:"getShape"},instancePickingColors:{size:3,type:bi.UNSIGNED_BYTE,accessor:"getPickingColor"}})}updateState(e){var a;super.updateState(e);let{props:t,oldProps:n,changeFlags:i}=e,o=!1;if(i.extensionsChanged){let{gl:l}=this.context;(a=this.state.model)==null||a.delete(),this.state.model=this._getModel(l),this.getAttributeManager().invalidateAll(),o=!0}if(o||t.highlightColors!==n.highlightColors){let l=new Float32Array(16);for(let u=0;u<4;u++){let c=t.highlightColors[u];c&&(l[u*4]=c[0]/255,l[u*4+1]=c[1]/255,l[u*4+2]=c[2]/255,l[u*4+3]=Number.isFinite(c[3])?c[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:l})}}draw({uniforms:e}){let{stroked:t,filled:n,cornerRadius:i,lineWidthUnits:o,lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:t,filled:n,cornerRadius:i,lineWidthUnits:jn[o],lineWidthScale:a,lineWidthMinPixels:l,lineWidthMaxPixels:u,nodeDepth:c,textureDim:[c.width,c.height]}).draw()}_getModel(e){let t=[-1,-1,1,-1,1,1,-1,1];return new cn(e,{...this.getShaders(),id:this.props.id,geometry:new zn({drawMode:bi.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};za.defaultProps=UN,za.layerName="GeometryLayer";function sh(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!sh(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(let i of t)if(!e.hasOwnProperty(i)||!sh(s[i],e[i]))return!1;return!0}return!1}function lv(s){if(s instanceof re){let e=s.boundingBox;return[e.center.x,e.bottom+s.labelSize.height/2+2]}return[s.center.x,s.center.y]}var du=class extends Xn{getPickingInfo({sourceLayer:e,info:t}){return e.id.endsWith("boundary")&&t.picked&&(t.object=this.props.fromIndex(t.index)),t}renderLayers(){return[new za(this.props,this.getSubLayerProps({id:"boundary",lineWidthUnits:"pixels"}),{getPosition:e=>[e.boundingBox.center.x,e.boundingBox.center.y],getSize:e=>[e.boundingBox.width,e.boundingBox.height],getShape:e=>qN(e.node),cornerRadius:HN(this.props.data[0]),getLineColor:uv,getFillColor:jN}),new pi(this.props,this.getSubLayerProps({id:"label"}),{dataTransform:e=>e.filter(t=>!(t instanceof re)||t.labelSize),getPosition:e=>lv(e),getText:e=>ct.getDrawingObj(e.node).labelText,getColor:uv,getSize:this.props.getTextSize,billboard:!1,sizeUnits:"common",characterSet:"auto",_subLayerProps:{characters:{clipByInstance:!1}}})]}};du.defaultProps={...pi.defaultProps,...za.defaultProps,fromIndex:{type:"function",compare:!1},getTextSize:{type:"accessor",value:16}},du.layerName="NodeLayer";function HN(s){return s?ct.getDrawingObj(s.node).xRad:0}function uv(s){let e=De.getDrawingObj(s.node);if(e){let t=e.pencolor;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function jN(s){let e=De.getDrawingObj(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}function qN(s){let e=De.getDrawingObj(s);if(e==null)return 0;switch(e.shape){case 0:return 2;case 1:return 1;case 2:return 0;case 3:return 1;case 4:return 0;case 5:return 1;case 6:return 1;case 10:return 1;case 14:return 1;case 18:return 0;case 11:return 0;case 12:return 0;default:return 0}}var XN={widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getControlPoints:{type:"accessor",value:s=>s.points},getCurveType:{type:"accessor",value:0},getResolution:{type:"accessor",value:4},getRange:{type:"accessor",value:[0,1]},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},YN=`#define SHADER_NAME curve-layer-vertex-shader
#define LINE    0.0
#define BEZIER  1.0
#define ARC     2.0

attribute vec2 positions;
attribute vec2 instanceSegments;
attribute vec4 instancePositions1;
attribute vec4 instancePositions2;
attribute float instanceTypes;
attribute float instanceWidths;
attribute vec4 instanceColors;

uniform float opacity;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform int widthUnits;

varying vec4 vColor;

void interpolateLine(float t, vec2 start, vec2 end, out vec2 point) {
  point = mix(start, end, t);
}

void interpolateBezierCurve(float t, vec2 start, vec2 c1, vec2 c2, vec2 end, out vec2 point) {
  vec2 c = (c1 - start) * 3.0;
  vec2 e = (c2 - c1) * 3.0 - c;
  vec2 l = end - start - c - e;

  float t2 = t * t;
  float t3 = t2 * t;
  
  point = l * t3 + e * t2 + c * t + start;
}

void interpolateArc(float t, vec2 center, vec2 aAxis, vec2 bAxis, out vec2 point) {
  point = center + cos(t) * aAxis + sin(t) * bAxis;
}

vec2 getExtrusionOffset(vec2 line, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir = normalize(line);
  // rotate by 90 degrees
  dir = vec2(-dir.y, dir.x);
  return dir * offset_direction * width / 2.0;
}

void main(void) {
  // Multiply out line width and clamp to limits
  float widthPixels = clamp(
    project_size_to_pixel(widthScale * instanceWidths, widthUnits),
    widthMinPixels, widthMaxPixels
  );
  float widthCommon = project_pixel_size(widthPixels);

  geometry.uv = positions.xy;

  vec2 pointOnCurve;
  vec2 nextPointOnCurve;
  vec2 pointOnCurve64Low = vec2(0.0);
  float r = instanceSegments.x + positions.x * instanceSegments.y;
  float rNext = r + instanceSegments.y;

  if (instanceTypes == BEZIER) {
    interpolateBezierCurve(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, pointOnCurve);
    interpolateBezierCurve(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, nextPointOnCurve);
  }
  else if (instanceTypes == ARC) {
    interpolateArc(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, pointOnCurve);
    interpolateArc(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, nextPointOnCurve);
  }
  else {
    interpolateLine(r, instancePositions1.xy, instancePositions1.zw, pointOnCurve);
    interpolateLine(rNext, instancePositions1.xy, instancePositions1.zw, nextPointOnCurve);
  }
  
  vec3 offset = vec3(getExtrusionOffset(
    nextPointOnCurve - pointOnCurve,
    positions.y,
    widthCommon), 0.0);

  gl_Position = project_position_to_clipspace(
    vec3(pointOnCurve, 0.0),
    vec3(pointOnCurve64Low, 0.0),
    offset,
    geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,KN=`#define SHADER_NAME curve-layer-fragment-shader
varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,fu=class extends on{getShaders(){return super.getShaders({vs:YN,fs:KN,modules:[Ki,Ls]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:8,transition:!0,accessor:"getControlPoints",shaderAttributes:{instancePositions1:{size:4},instancePositions2:{size:4,elementOffset:4}}},instanceSegments:{size:2,update:this._getSegments},instanceTypes:{size:1,type:bi.UNSIGNED_BYTE,accessor:"getCurveType"},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceColors:{size:4,transition:!0,normalized:!0,type:bi.UNSIGNED_BYTE,accessor:"getColor"}})}updateState(e){var i;super.updateState(e);let{props:t,changeFlags:n}=e;if(n.dataChanged&&this.updateGeometry(),n.extensionsChanged){let{gl:o}=this.context;(i=this.state.model)==null||i.delete(),this.state.model=this._getModel(o),this.getAttributeManager().invalidateAll()}}updateGeometry(){let{data:e,getResolution:t,getCurveType:n,getRange:i}=this.props,{iterable:o,objectInfo:a}=Mo(e),l=[0],u=0,c=[];for(let h of o){a.index++;let d=typeof n=="function"?n(h,a):n,m=typeof i=="function"?i(h,a):i,P=d===0?1:Math.ceil(typeof t=="function"?t(h,a):t);u+=P;let S=(m[1]-m[0])/P;l.push(u);for(let v=0;v<P;v++)c.push(m[0]+S*v,S)}this.setState({startIndices:l,numInstances:u,segments:new Float32Array(c)})}draw({uniforms:e}){let{widthUnits:t,widthScale:n,widthMinPixels:i,widthMaxPixels:o}=this.props;this.state.model.setUniforms(e).setUniforms({widthUnits:jn[t],widthScale:n,widthMinPixels:i,widthMaxPixels:o}).draw()}_getModel(e){let t=[0,-1,1,-1,1,1,0,1];return new cn(e,{...this.getShaders(),id:this.props.id,geometry:new zn({drawMode:bi.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_getSegments(e){e.value=this.state.segments}};fu.layerName="CurveLayer",fu.defaultProps=XN;var QN={resolution:{type:"number",value:1},widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},gu=class extends Xn{updateState(e){if(super.updateState(e),e.changeFlags.dataChanged){let t=Array.from($N(this.props.data,(n,i,o)=>this.getSubLayerRow(n,i,o)));this.setState({curves:t})}}renderLayers(){let{getWidth:e,getColor:t,resolution:n}=this.props;return[new fu({getWidth:this.getSubLayerAccessor(e),getColor:this.getSubLayerAccessor(t)},this.getSubLayerProps({id:"path"}),{data:this.state.curves,getCurveType:JN,getControlPoints:ZN,getRange:i=>[i.parStart,i.parEnd],widthUnits:"pixels",getResolution:i=>i.length*n,clipByInstance:!1})]}};gu.defaultProps=QN,gu.layerName="EdgeLayer";function JN(s){return s instanceof he?2:s instanceof Re?1:0}function ZN(s){return s instanceof he?[s.center,s.aAxis,s.bAxis].flatMap(sy):s instanceof Re?s.b.flatMap(sy):[s.start,s.end].flatMap(sy)}function*$N(s,e){let t=0;for(let n of s){let{curve:i}=n;e(i,n,t),yield i,t++}}function sy(s){return[s.x,s.y]}var ah=class extends Xn{renderLayers(){let e=this.props.data,{highlighter:t,resolution:n,fontFamily:i,fontWeight:o,lineHeight:a,getTextSize:l}=this.props;return[e.nodes.length>0&&new du(this.getSubLayerProps({id:"nodes"}),{data:e.nodes,getPickingColor:(u,{target:c})=>t.encodeNodeIndex(u,c),fromIndex:u=>t.getNode(u),nodeDepth:t.nodeDepth,getLineWidth:1,fontFamily:i,fontWeight:o,lineHeight:a,getTextSize:l,clipByInstance:!1}),e.curveClips.length>0&&new gu(this.getSubLayerProps({id:"curves"}),{data:e.curveClips,getWidth:1,getDepth:t.edgeDepth,resolution:n}),e.arrowheads.length>0&&new Do(this.getSubLayerProps({id:"arrowheads"}),{data:e.arrowheads,iconAtlas:"deck://arrowAtlas",iconMapping:sv,getPosition:u=>[u.tip.x,u.tip.y],getColor:u=>eG(u.edge),getIcon:u=>tG(u.edge),getSize:u=>rG(u.tip,u.base),getAngle:u=>nG(u.tip,u.base),billboard:!1,sizeUnits:"common"}),e.labels.length>0&&new pi(this.getSubLayerProps({id:"labels"}),{data:e.labels,getText:u=>ay(u).labelText,getSize:u=>ay(u).fontsize,getColor:iG,getPosition:u=>[u.center.x,u.center.y],fontFamily:i,fontWeight:o,lineHeight:a,sizeUnits:"common"})]}};ah.defaultProps={...pi.defaultProps,resolution:{type:"number",value:1},highlighter:{type:"object"},getTextSize:{type:"accessor",value:16}},ah.layerName="Graphayer";function eG(s){let e=De.getDrawingObj(s);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function tG(s){return"triangle-n"}function rG(s,e){let t=s.x-e.x,n=s.y-e.y;return Math.sqrt(t*t+n*n)}function nG(s,e){let t=s.x-e.x,n=s.y-e.y;return Math.atan2(n,t)/Math.PI*180}function ay(s){let t=s.parent.entity;return De.getDrawingObj(t)}function iG(s){let e=ay(s).labelfontcolor;return e?[e.R,e.G,e.B]:[0,0,0]}var Lv=Ae(fv());var vv=Ae(Av());function to(s){let e=(0,vv.default)(s);if(e.keyword!=null)return A.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new A(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return A.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return A.Black}function pu(s){return"nodes"in s?GG(s):Tv(s)}function GG(s){let e=new de;for(let t of s.nodes){let n=String(t.id),i=e.addNode(new tt(n)),o=new ct(i),{label:a=n,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=eo[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=to(t.color))}for(let t of s.edges){let n=e.setEdge(String(t.source),String(t.target)),i=new _t(n,!1),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;i.arrowhead=$i[o],i.arrowtail=$i[a],i.directed=l,"weight"in t&&(i.weight=t.weight),"color"in t&&(i.color=to(t.color))}return new xt(e),e}function yy(s,e,t){for(let i of t.attr_list)if(i.type==="attr"){let o=i.eq;switch(i.id){case"edgeCurve":{let a=mh(s),l=JSON.parse(o);a.curve=jh(l)}break;case"graphBoundingBox":{let a=mh(s),l=JSON.parse(o);a.boundingBox=new z(l)}break;case"boundaryCurve":{let a=mh(s),l=JSON.parse(o),u=jh(l);a instanceof re?a.boundingBox=u.boundingBox:a.boundaryCurve=u}break;case"sourceArrowhead":{let a=mh(s);a.sourceArrowhead==null&&(a.sourceArrowhead=new Ve),a.sourceArrowhead.tipPosition=f.fromJSON(JSON.parse(o));break}case"targetArrowhead":{let a=mh(s);a.targetArrowhead==null&&(a.targetArrowhead=new Ve),a.targetArrowhead.tipPosition=f.fromJSON(JSON.parse(o));break}case"geomEdgeLabel":{let a=JSON.parse(o),l=s;n(l),new Ur(l.label,new z(a)).setBoundingBox(new z(a));break}case"color":e.color=to(o);break;case"pencolor":e.pencolor=to(o);break;case"labelfontcolor":e.labelfontcolor=to(o);break;case"fontcolor":e.fontColor=to(o);break;case"fillcolor":e.fillColor=to(o);break;case"style":for(let a of MG(o))e.styles.push(a);break;case"shape":{let a=e;a.shape=DG(o);break}case"peripheries":e.peripheries=parseInt(o);break;case"headlabel":e.headlabel=o;break;case"label":if(typeof o=="string"){let a="\\n",l=0;e.labelText="";do{let u=o.indexOf(a,l);if(u>=0)e.labelText+=o.substring(l,u)+`
`,l=u+2;else{e.labelText+=o.substring(l);break}}while(!0)}else typeof o=="number"&&(e.labelText=o.toString());s instanceof et&&n(s);break;case"size":e.size=Py(o);break;case"pos":e.pos=Py(o);break;case"rankdir":e.rankdir=FG(o);break;case"fontname":e.fontname=o;break;case"fontsize":e.fontsize=parseFloat(o);break;case"width":e.width=parseFloat(o);break;case"penwidth":e.penwidth=parseFloat(o);break;case"height":e.height=parseFloat(o);break;case"margin":e.margin=parseFloat(o);break;case"len":e.len=parseFloat(o);break;case"minlen":e.minlen=parseFloat(o);break;case"rank":e.rank=_G(o);break;case"charset":e.charset=o;break;case"orientation":e.orientation=o;break;case"ratio":e.ratio=o;break;case"weight":e.weight=parseFloat(o);break;case"nodesep":e.nodesep=parseFloat(o);break;case"layersep":e.layersep=parseFloat(o);break;case"arrowsize":e.arrowsize=parseFloat(o);break;case"rotate":e.rotate=parseFloat(o);break;case"ranksep":e.ranksep=parseFloat(o);break;case"splines":e.splines=o==="true";break;case"overlap":e.overlap=o==="true";break;case"arrowtail":e.arrowtail=Iv(o);break;case"taillabel":e.taillabel=o;break;case"arrowhead":e.arrowhead=Iv(o);break;case"ordering":e.ordering=VG(o);break;case"URL":e.URL=o;break;case"dir":e.dir=kG(o);break;case"concentrate":e.concentrate=o==="true";break;case"compound":e.compound=o==="true";break;case"lhead":e.lhead=o;break;case"ltail":e.ltail=o;break;case"bgcolor":e.bgcolor=to(o);break;case"center":e.center=o===!0||parseInt(o)===1;break;case"colorscheme":e.colorscheme=o;break;case"sides":e.sides=parseInt(o);break;case"distortion":e.distortion=parseFloat(o);break;case"skew":e.skew=parseFloat(o);break;case"bb":e.bb=UG(o);break;case"labelloc":e.labelloc=o;break;case"decorate":e.decorate=o==="true";break;case"tailclip":e.tailclip=o==="true";break;case"headclip":e.headclip=o==="true";break;case"constraint":e.constraint=o==="true";break;case"gradientangle":e.gradientangle=parseFloat(o);break;case"samehead":e.samehead=o;break;case"href":e.href=o;break;case"imagepath":e.imagepath=o;break;case"image":e.image=o;break;case"labeljust":e.labejust=o;break;case"layers":e.layers=o.split(",");break;case"layer":e.layer=o;break;case"f":e.f=parseFloat(o);break;case"nojustify":e.nojustify=o==="true";break;case"root":e.root=o==="true";break;case"page":e.page=Py(o);break;case"pname":e.pname=o;break;case"kind":e.kind=o;break;case"fname":e.fname=o;break;case"subkind":e.subkind=o;break;case"area":e.area=parseFloat(o);break;case"tailport":e.tailport=o;break;case"headport":e.headport=o;break;case"wt":e.wt=o;break;case"id":e instanceof ct||(e.id=o);break;case"edgetooltip":e.edgetooltip=o;break;case"headtooltip":e.headtooltip=o;break;case"tailtooltip":e.tailtooltip=o;break;case"headURL":e.headURL=o;break;case"tailURL":e.tailURL=o;break;case"labelURL":e.labelURL=o;break;case"edgeurl":e.edgeurl=o;break;case"shapefile":e.shapefile=o;break;case"xlabel":e.xlabel=o;break;case"sametail":e.sametail=o;break;case"clusterrank":e.clusterRank=o;break;case"measuredTextSize":e.measuredTextSize=JSON.parse(o);break;default:break}}else throw new Error("unexpected type "+i.type);function n(i){i.label==null&&(i.label=new er(i))}}function bu(s,e){let t=De.getDrawingObj(e);s.attr_list!=null&&yy(e,t,s)}var Sy=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,n,i,o){let a,l;if(e.type==="node_id"){let c=e.id.toString();a=this.nodeMap.get(c),a==null?a=this.newNode(c,n,!1):this.tryToMoveToADeeperGraph(a,n)}else{let c=[];for(let h of e.children)if(h.type==="node_stmt")for(let d of this.parseEdge(h.node_id,t,n,i,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of e.children)if(h.type==="attr_stmt")for(let d of c)bu(h,d);return c}if(t.type==="node_id"){let c=t.id.toString();l=this.nodeMap.get(c),l==null?l=this.newNode(c,n,!1):this.tryToMoveToADeeperGraph(l,n)}else if(t.type==="subgraph"){let c=new Array;for(let h of t.children)if(h.type==="node_stmt")for(let d of this.parseEdge(e,h.node_id,n,i,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of t.children)if(h.type==="attr_stmt")for(let d of c)bu(h,d);return c}let u=new et(a,l);return new _t(u,i),bu(o,u),[u]}tryToMoveToADeeperGraph(e,t){Ee.assert(e.parent!=null);let n=e.parent;n!=t&&i(n)<i(t)&&(n.remove(e),t.addNode(e));function i(o){let a=0,l=o.parent;for(;l;)a++,l=l.parent;return a}}newNode(e,t,n){let i=this.nodeMap.get(e);if(i==null){i=new tt(e),this.nodeMap.set(e,i),t.addNode(i);let o=new ct(i);o.labelText=e;let a=xt.getDrawingObj(t);De.copyValidFields(a.defaultNodeObject,o)}else n&&Im(t,i);return i}parseNode(e,t,n){let i=e.node_id.id.toString(),o=this.newNode(i,t,n);return De.getDrawingObj(o)==null&&new ct(o),bu(e,o),o}parse(){return this.ast==null?null:(this.graph=new de(this.ast[0].id?this.ast[0].id.toString():"__graph__"),this.drawingGraph=new xt(this.graph),this.parseUnderGraph(this.ast[0].children,this.graph,this.ast[0].type==="digraph",!1),zG(this.graph),HG(this.graph),this.graph)}parseGraphAttr(e,t){if(e.target==="node"){let n=xt.getDrawingObj(t);n.defaultNodeObject==null&&(n.defaultNodeObject=new ct(null)),yy(null,n.defaultNodeObject,e)}else e.target==="graph"&&bu(e,t)}getEntitiesSubg(e,t,n){let i=[];for(let o of e.children)if(o.type==="edge_stmt")for(let a=0;a<o.edge_list.length-1;a++)for(let l of this.parseEdge(o.edge_list[a],o.edge_list[a+1],t,n,o))i.push(l);else if(o.type!=="attr_stmt")if(o.type==="node_stmt")i.push(this.parseNode(o,t,!0));else if(o.type==="subgraph")if(o.id!=null){let a=new de(o.id.toString());t.addNode(a),this.nodeMap.set(a.id,a);let l=new xt(a);this.parseUnderGraph(o.children,a,n,!0),i.push(l.graph),a.isEmpty&&(t.removeNode(a),this.nodeMap.delete(a.id))}else i=i.concat(this.getEntitiesSubg(o,t,n));else throw new Error("Function not implemented.");return i}parseUnderGraph(e,t,n,i){for(let o of e)switch(o.type){case"node_stmt":this.parseNode(o,t,i);break;case"edge_stmt":{let a=o.edge_list;for(let l=0;l<a.length-1;l++)this.parseEdge(a[l],a[l+1],t,n,o)}break;case"subgraph":if(!this.process_same_rank(o,xt.getDrawingGraph(t)))if(o.id==null){let a=this.getEntitiesSubg(o,t,n);WG(o,xt.getDrawingGraph(t),a)}else{let a=new de(o.id.toString());this.nodeMap.set(o.id.toString(),a),t.addNode(a),new xt(a),this.parseUnderGraph(o.children,a,n,!0),a.isEmpty()&&(t.remove(a),this.nodeMap.delete(a.id))}break;case"attr_stmt":this.parseGraphAttr(o,t);break;default:throw new Error("not implemented")}}process_same_rank(e,t){let n=e.children[0];if(n==null||n.type!=="attr_stmt")return!1;let i=n.attr_list;if(i==null||i.length===0)return!1;let o=i[0];if(o.type!=="attr"||o.id!=="rank")return!1;switch(o.eq){case"min":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"max":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"same":{let a=[];for(let l=1;l<e.children.length;l++){let u=e.children[l];u.type==="node_stmt"?(this.newNode(u.node_id.id.toString(),t.graph,!1),a.push(u.node_id.id.toString())):u.type==="attr_stmt"&&u.target==="node"&&(t.defaultNodeObject==null&&(t.defaultNodeObject=new ct(null)),yy(null,t.defaultNodeObject,u))}return t.graphVisData.sameRanks.push(a),!0}case"source":{for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sourceRanks.push(l.node_id.id.toString());else throw new Error}return!0}case"sink":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sinkRanks.push(l.node_id.id.toString());else throw new Error}return!0;default:throw new Error("incorrect rank")}}};function Ey(s){try{return new Sy((0,Lv.default)(s)).parse()}catch(e){return console.log("cannot parse the graph"),null}}function Tv(s){try{return new Sy([s]).parse()}catch(e){return console.log(e.message),null}}function*MG(s){let e=s.split(",");for(let t of e){let i=Wa[t];i&&(yield i)}}function DG(s){let e=s.toLowerCase();return eo[e]}function Py(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function FG(s){return ul[s]}function _G(s){return vg[s]}function Iv(s){return $i[s]}function VG(s){return Ig[s]}function kG(s){return Tg[s]}function UG(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function WG(s,e,t){for(let n of s.children)if(n.type==="attr_stmt")for(let i of t)bu(n,i)}function zG(s){let e=[];for(let t of s.subgraphsBreadthFirst())t.isEmpty()&&e.push(t);for(let t of e){let n=t.parent;n&&n.removeNode(t)}}function HG(s){for(let e of s.subgraphsBreadthFirst())re.getGeom(e)==null&&e.hasSomeAttrOnIndex(ae.GeomObjectIndex)&&new re(e);re.getGeom(s)==null&&s.hasSomeAttrOnIndex(ae.GeomObjectIndex)&&new re(s)}function ph(s){let e=$G(s);return{type:JG(s),id:s.id,children:qG(s,e)}}function jG(s){return{type:"edge_stmt",edge_list:[{type:"node_id",id:s.source.id},{type:"node_id",id:s.target.id}],attr_list:Array.from(XG(s))}}function qG(s,e){let t=new Map,n=[],i=re.getGeom(s);if(i){let o=Array.from(Rv(i));n.push({type:"attr_stmt",target:"graph",attr_list:o})}tM(n,s);for(let o of s.nodesBreadthFirst)t.set(o.id,YG(o));for(let o of s.nodesBreadthFirst){if(o.parent===s)continue;t.get(o.parent.id).children.push(t.get(o.id))}for(let o of s.deepEdges){let a=jG(o),l=ZG(o,e);l===s?n.push(a):t.get(l.id).children.push(a)}for(let o of s.shallowNodes)n.push(t.get(o.id));return n}function*XG(s){let e=ce.getGeom(s);if(e&&e.curve&&(yield{type:"attr",id:"edgeCurve",eq:JSON.stringify(qh(e.curve))},e.sourceArrowhead&&(yield{type:"attr",id:"sourceArrowhead",eq:JSON.stringify(e.sourceArrowhead.tipPosition.toJSON())}),e.targetArrowhead&&(yield{type:"attr",id:"targetArrowhead",eq:JSON.stringify(e.targetArrowhead.tipPosition.toJSON())}),s.label)){let t=s.label.getAttr(ae.GeomObjectIndex).boundingBox,n={left:t.left,right:t.right,top:t.top,bottom:t.bottom};yield{type:"attr",id:"geomEdgeLabel",eq:JSON.stringify(n)}}yield*Cy(De.getDrawingObj(s))}function YG(s){if(s instanceof de){let t=Array.from(Rv(re.getGeom(s))),n=[],i={type:"attr_stmt",target:"graph",attr_list:t};return n.push(i),{type:"subgraph",children:n,id:s.id}}else return{type:"node_stmt",node_id:{type:"node_id",id:s.id},attr_list:Array.from(QG(s))}}function KG(s){let e=Ge.getGeom(s).boundaryCurve;return{type:"attr",id:"boundaryCurve",eq:JSON.stringify(qh(e))}}function*QG(s){ce.getGeom(s)&&(yield KG(s)),yield*Cy(De.getDrawingObj(s))}function*Cy(s){if(s)for(let e of s.attrIter())yield e}function JG(s){return xt.getDrawingGraph(s).hasDirectedEdge()?"digraph":"graph"}function ZG(s,e){let t=s.source,n=s.target,i=e.get(t.id),o=e.get(n.id);for(;i>o;)t=t.parent,i--;for(;i<o;)n=n.parent,o--;for(;t.parent!==n.parent;)t=t.parent,n=n.parent;return t.parent}function $G(s){let e=new Map;return e.set(s.id,0),Ov(s,e),e}function Ov(s,e){let t=e.get(s.id)+1;for(let n of s.shallowNodes)e.set(n.id,t),n instanceof de&&Ov(n,e)}function mh(s){var e;return(e=ce.getGeom(s))!=null?e:eM(s)}function eM(s){if(s instanceof de)return new re(s);if(s instanceof tt)return new Ge(s);if(s instanceof et)return new be(s);throw new Error("unsupported type "+s)}function tM(s,e){let t=xt.getDrawingObj(e);if(t==null)return;let n=t.defaultNodeObject;n&&s.push({type:"attr_stmt",target:"node",attr_list:Array.from(Cy(n))})}function*Rv(s){if(s==null)return;let e=s.boundingBox;if(e&&e.isEmpty()===!1){let t={left:e.left,right:e.right,top:e.top,bottom:e.bottom};yield{type:"attr",id:"graphBoundingBox",eq:JSON.stringify(t)}}s.radX!==10&&(yield{type:"attr",id:"radX",eq:s.radX.toString()}),s.radY!==10&&(yield{type:"attr",id:"radY",eq:s.radY.toString()})}function xy(s){let e=new de;try{let t=s.split(/\r\n|\r|\n/);for(let n of t){if(n.length==0||n.charAt(0)=="#")continue;let i=n.split(/\t/);if(i.length!=2)return console.log("cannot parse",n),null;let o=i[0],a=i[1],l=wv(e,o),u=wv(e,a),c=new et(l,u);new _t(c,!0)}}catch(t){console.log(t.message)}return new xt(e),e}function wv(s,e){let t=s.findNode(e);return t==null&&(t=s.addNode(new tt(e)),new ct(t)),t}async function Ay(s){let e=await s.text(),t;return s.name.toLowerCase().endsWith(".json")?t=pu(JSON.parse(e)):s.name.toLowerCase().endsWith(".txt")?t=xy(e):t=Ey(e),t&&(t.id=s.name),t}async function Bg(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),n;if(e.endsWith(".json")){let i=await t.json();n=pu(i)}else if(e.endsWith(".txt")){let i=await t.text();n=xy(i)}else{let i=await t.text();n=Ey(i)}return n&&(n.id=e),n}function bh(s,e,t=!1){let n=!1,i=t,o=xt.getDrawingObj(s),a=re.getGeom(s);function l(u){if(!u)return;for(let d of u.subgraphs())l(d);let c=rM(o,u,e),h=nM(u.layoutSettings,c);i=i||h.layoutChanged,n=n||h.routingChanged,u.layoutSettings=c}if(l(a),i||n)for(let u of a.deepEdges)u.requireRouting();return i?hc(a,null):n&&ma(a,Array.from(a.deepEdges),null),s}function rM(s,e,t){let n=!1;for(let o of e.deepEdges)if(o.sourceArrowhead!=null||o.targetArrowhead!=null){n=!0;break}let i;switch(t.layoutType){case"Sugiyama LR":{let o=i=new Ot;o.layerDirection=1;break}case"Sugiyama RL":{let o=i=new Ot;o.layerDirection=3;break}case"Sugiyama TB":{let o=i=new Ot;o.layerDirection=0;break}case"Sugiyama BT":{let o=i=new Ot;o.layerDirection=2;break}case"MDS":i=new Dn;break;case"IPsepCola":i=new Gr;break;default:{let o=e.graph.shallowNodeCount>2e3||e.graph.deepEdgesCount()>4e3;if(n&&!o){let a=i=new Ot;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else i=new Gr}}return t.edgeRoutingMode==null?i instanceof Ot?i.edgeRoutingSettings.EdgeRoutingMode=3:i.edgeRoutingSettings.EdgeRoutingMode=0:i.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,i}function nM(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.commonSettings.edgeRoutingSettings.EdgeRoutingMode!==e.commonSettings.edgeRoutingSettings.EdgeRoutingMode,n=t&&e.commonSettings.edgeRoutingSettings.EdgeRoutingMode===3,i=s instanceof Ot&&e instanceof Ot&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||n||i,routingChanged:t}}var Xa=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:n,fontStyle:i,fontWeight:o}=this.opts;this.ctx.font=`${i} ${o} ${n}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:n,lineHeight:i}=this.opts,o=n*1.2,a=n*(i-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new vt(l,u.length*o+(u.length-1)*a)}};var Ya=Ae(Ut()),Sh=class extends Ci{constructor(e,t){super(e,ae.ViewerIndex);this.isVisible=!0;this.markedForDragging=!1;this.svgData=t}clone(){throw new Error("not implemented")}rebind(e){this.entity=e,this.bind(ae.ViewerIndex)}},Bv=class extends Sh{get graph(){return this.entity}},Nv=class extends Sh{get node(){return this.entity}},Gv=class extends Sh{},Mv=class extends Sh{get edge(){return this.entity}},Ph=class{constructor(e){this._textMeasurer=new Xa;this.container=e}removeRubberEdge(){this.rubberEdge.remove(),this.rubberEdge=null}drawRubberEdge(e){let t=this.rubberEdge=this.createOrGetWithId(this.transformGroup,"path","rubberEdge");t.setAttribute("d",Gs(e.curve)),t.setAttribute("fill","none"),t.setAttribute("stroke","black"),t.setAttribute("stroke-opacity","1"),t.setAttribute("stroke-width","1"),t.setAttribute("stroke-dasharray","5")}positionEdgeInsertionElement(e,t){let n=t?"brown":"blue",i=this.getSmoothedPolylineRadius()/2,o=Gs(t?Ce.mkCircle(i,e):Ce.mkDiamond(i,i,e));this.edgeInsertionPortElem.setAttribute("d",o),this.edgeInsertionPortElem.setAttribute("fill",n)}prepareToEdgeInsertion(e,t){this.stopNodeInsertion(),this.edgeInsertionPortElem=this.createOrGetWithId(this.transformGroup,"path","edgeInsertCircle"),this.positionEdgeInsertionElement(e,t)}positionNodeInsertionCircle(e){let t=Gs(Ce.mkCircle(this.getSmoothedPolylineRadius()/2,e));this.nodeInsertionCircle.setAttribute("d",t),this.nodeInsertionCircle.setAttribute("fill","red")}stopNodeInsertion(){this.nodeInsertionCircle&&this.nodeInsertionCircle.remove()}stopEdgeInsertion(){this.edgeInsertionPortElem&&this.edgeInsertionPortElem.remove()}prepareToNodeInsertion(e){this.stopEdgeInsertion(),this.nodeInsertionCircle=this.createOrGetWithId(this.transformGroup,"path","nodeInsertCircle");let t=this.getSmoothedPolylineRadius()/2,n=Gs(Ce.mkCircle(t,e));this.nodeInsertionCircle.setAttribute("d",n),this.nodeInsertionCircle.setAttribute("fill","red")}invalidate(e){let t=e.entity;if(t instanceof de)t.parent==null?(this.setGraphWidthAndHightAttributes(),this.setTransformForTranformGroup()):this.drawNode(t);else if(t instanceof tt)this.drawNode(t);else if(t instanceof et)this.drawEdge(t);else if(t instanceof er)this.drawEdgeLabel(t);else throw new Error("not implemented")}getSvgString(){return this.svg==null?null:new XMLSerializer().serializeToString(this.svg)}get geomGraph(){return re.getGeom(this.graph)}clearContainer(){for(;this.container.childNodes.length>0;)this.container.removeChild(this.container.firstChild)}setGraph(e){this.clearContainer(),this.graph=e,this.graph.setAttr(ae.ViewerIndex,null),this.svg=this.createAndBindWithGraph(e,"svg",this.container),this.svg.setAttribute("style","border: 1px solid black"),this.open(),this.svg.appendChild(this.transformGroup=document.createElementNS(vy,"g")),this.setTransformForTranformGroup();for(let t of this.graph.nodesBreadthFirst)this.drawNode(t);for(let t of this.graph.deepEdges)this.drawEdge(t),this.drawEdgeLabel(t.label)}setTransformForTranformGroup(){this.transformGroup.setAttribute("transform",Ya.String.Format("matrix(1,0,0,-1, {0},{1})",-this.geomGraph.left,this.geomGraph.top))}getTransform(){if(!this.svg)return ot.getIdentity();let e=this.svg.getScreenCTM(),t=new ot(e.a,e.b,e.e,e.c,e.d,e.f),n=new ot(1,0,-this.geomGraph.left,0,-1,this.geomGraph.top);return t.multiply(n)}getScale(){try{return this.svg.getScreenCTM().a}catch(e){return 1}}drawEdge(e){if(be.getGeom(e).curve==null)return;let t=this.createAndBindWithGraph(e,"g",this.transformGroup),n=this.createOrGetWithId(t,"path","curve");n.setAttribute("fill","none"),this.setStroke(n,_t.getDrawingObj(e));let i=be.getGeom(e);return n.setAttribute("d",Gs(i.curve)),this.addArrows(e,t),this.drawSelectedForEdit(e,t),t}drawSelectedForEdit(e,t){let n=wt(e),i="smoothPoly",o="corners";if(n.selectedForEditing)this.drawSmoothPolyline(e,t,i),this.addCornerCirclesGroup(e,t,o);else{let a=t.children.namedItem(i);a&&t.removeChild(a);let l=t.children.namedItem(o);l&&t.removeChild(l)}}addCornerCirclesGroup(e,t,n){let i=this.createOrGetWithId(t,"g",n),o=be.getGeom(e).smoothedPolyline,a=0;for(let l of o)this.addCornerCircle(l,i,a++,e)}addCornerCircle(e,t,n,i){let o=this.createOrGetWithId(t,"path",n.toString()),a=this.getSmoothedPolylineRadius(),l=Gs(Ce.mkCircle(a,e));o.setAttribute("d",l),o.setAttribute("fill","none"),this.setStroke(o,_t.getDrawingObj(i))}drawSmoothPolyline(e,t,n){let i=this.createOrGetWithId(t,"path",n),o=e.getAttr(ae.GeomObjectIndex).smoothedPolyline,a=iM(o);i.setAttribute("d",a),i.setAttribute("fill","none"),this.setStroke(i,_t.getDrawingObj(e))}createOrGetWithId(e,t,n){let i=e.children.namedItem(n);if(i)return i;let o=document.createElementNS(vy,t);return o.id=n,e.appendChild(o),o}drawEdgeLabel(e){if(e==null)return;let t=this.createAndBindWithGraph(e,"g",this.transformGroup),n=e.getAttr(ae.GeomObjectIndex);if(!n)return;this.drawLabelAtXY(e,_t.getDrawingObj(e.parent),n.boundingBox,t,"edgeLabel");let i="attachPrompt";e.getAttr(ae.ViewerIndex).markedForDragging?this.addLabelAttachmentPrompt(e,n,t,i):this.removeLabelAttachmentPrompt(t,i)}removeLabelAttachmentPrompt(e,t){let n=e.children.namedItem(t);n&&e.removeChild(n)}addLabelAttachmentPrompt(e,t,n,i){let o=R.mkPP(t.attachmentSegmentStart,t.attachmentSegmentEnd),a=this.createOrGetWithId(n,"path",i);a.setAttribute("fill","none");let l=o.length;a.setAttribute("stroke-dasharray",[l*.4,l*.2,l*.4].toString()),this.setStroke(a,_t.getDrawingObj(e.parent)),a.setAttribute("d",Gs(o))}addArrows(e,t){let n=be.getGeom(e),i=n.curve;this.AddArrowhead(e,n.sourceArrowhead,i.start,t,"sourceArr"),this.AddArrowhead(e,n.targetArrowhead,i.end,t,"targetArr")}AddArrowhead(e,t,n,i,o){if(!t)return;let a=this.createOrGetWithId(i,"polygon",o);this.setStroke(a,_t.getDrawingObj(e));let l=cM(n,t.tipPosition);return a.setAttribute("points",Fv(l)),a}setStroke(e,t){let n=Ng(t.color);if(e.setAttribute("stroke",n),e.setAttribute("stroke-opacity",(t.color?t.color.A/255:1).toString()),e.setAttribute("stroke-width",t.penwidth.toString()),t.styles&&t.styles.length)for(let i of t.styles)this.attachStyleToPath(e,i)}attachStyleToPath(e,t){switch(t){case 1:e.setAttribute("stroke-dasharray","5");break;case 7:e.setAttribute("stroke-dasharray","2");break;default:break}}drawNode(e){let t=this.createAndBindWithGraph(e,"g",this.transformGroup),i=ce.getGeom(e).boundaryCurve;!i||this.drawNodeOnCurve(i,e,t)}drawNodeOnCurve(e,t,n){let i=De.getDrawingObj(t);if(i.shape!=5&&(this.makePathOnCurve(t,i,e,n,"boundaryCurve"),i.shape==10)){let o=e,a=o.aAxis.length-2*i.penwidth;o=Ce.mkCircle(a,o.center),this.makePathOnCurve(t,i,o,n,"doubleCircle")}this.drawLabel(t,i,n)}makePathOnCurve(e,t,n,i,o){var l,u;let a=this.createOrGetWithId(i,"path",o);if(t.styles.find(c=>c==5)){let c=(u=(l=t.fillColor)!=null?l:t.color)!=null?u:ct.defaultFillColor;a.setAttribute("fill",Ng(c))}else a.setAttribute("fill","none");a.setAttribute("d",Gs(n)),a.setAttribute("stroke",Ng(t.color)),a.setAttribute("stroke-width",t.penwidth.toString())}drawLabel(e,t,n){if(!!t&&!(!t.labelText||t.labelText.length==0))if(t instanceof ct)this.writeLabelText(e,t.measuredTextSize,n,"nodeLabel");else throw new Error("not implemented")}writeLabelText(e,t,n,i){let o=Ge.getGeom(e),a=De.getDrawingObj(e),u=e instanceof de?z.creatRectangleWithSize(t,new f(o.boundaryCurve.boundingBox.center.x,o.boundaryCurve.boundingBox.top-(t.height/2+a.LabelMargin))):z.creatRectangleWithSize(t,o.center);this.drawLabelAtXY(null,a,u,n,i)}drawLabelAtXY(e,t,n,i,o){let a=t.fontsize,l=this.createOrGetWithId(i,"text",o);l.setAttribute("text-anchor","middle"),l.setAttribute("x",n.center.x.toString()),l.setAttribute("fill",Ng(t.fontColor)),l.setAttribute("font-family",t.fontname),l.setAttribute("font-size",a.toString()+"px"),l.setAttribute("transform","scale(1,-1)"),this.createTspans(t.labelText,l,a,n)}createTspans(e,t,n,i){let o=`
`,a=e.split(o);for(;t.children.length;)t.removeChild(t.children.item(0));if(a.length==1){let l=this.createOrGetWithId(t,"tspan","0");l.textContent=e,l.setAttribute("text-anchor","middle"),l.setAttribute("x",i.center.x.toString()),l.setAttribute("alignment-baseline","middle"),l.setAttribute("y",(-i.center.y).toString())}else{let l=i.top-1;for(let u=0;u<a.length;u++){let c=this.createOrGetWithId(t,"tspan",u.toString());c.textContent=a[u],c.setAttribute("text-anchor","middle"),c.setAttribute("x",i.center.x.toString()),c.setAttribute("alignment-baseline","hanging"),c.setAttribute("y",(-l).toString()),l-=1.21*n}}}open(){this.setGraphWidthAndHightAttributes()}setGraphWidthAndHightAttributes(){this.svg.setAttribute("viewBox",this.getViewBoxString())}getViewBoxString(){return Ya.String.Format("0 0 {0} {1}",this.geomGraph.width,this.geomGraph.height)}createAndBindWithGraph(e,t,n){let i=e?wt(e):null;if(i){let a=i.svgData;return Ee.assert(i.svgData!=null),n!==a.parentNode&&(a.parentNode&&a.parentNode.removeChild(a),n.appendChild(a)),a}let o=document.createElementNS(vy,t);return n.appendChild(o),e instanceof de?new Bv(e,o):e instanceof tt?new Nv(e,o):e instanceof et?new Mv(e,o):e instanceof er&&new Gv(e,o),o}};Ph.arrowAngle=25;var vy="http://www.w3.org/2000/svg";function Gs(s){return Ya.String.Join(" ",Array.from(sM(s)))}function iM(s){return Ya.String.Join(" ",Array.from(oM(s)))}function*oM(s){let e=!0;for(let t of s)e?(e=!1,yield"M",yield Fo(t)):(yield"L",yield Fo(t))}function*sM(s){if(yield"M",yield Fo(s.start),s instanceof x)for(let t of s.segs)yield lM(t);else if(s instanceof R)yield"L",yield Fo(s.end);else if(s instanceof Re)yield Dv(s);else if(s instanceof ee){let o=s;for(let a of o.skip(1))yield"L",yield Fo(a.point);o.closed&&(yield"L",yield Fo(o.start))}else if(s instanceof he){let a=s;a.isFullEllipse()?(yield Ty(new he(0,Math.PI,a.aAxis,a.bAxis,a.center)),yield Ty(new he(Math.PI,Math.PI*2,a.aAxis,a.bAxis,a.center))):this.ellipseToString(a)}}function Fo(s){return yh(s.x)+" "+yh(s.y)}function yh(s){return Math.abs(s)<1e-11?"0":s.toString()}function Dv(s){return"C"+Fv([s.B(1),s.B(2),s.B(3)])}function Ty(s){let e=Math.abs(s.parEnd-s.parStart)>=Math.PI?"1":"0",t=s.orientedCounterclockwise()?"1":"0";return Ya.String.Join(" ","A",aM(s),yh(f.angle(new f(1,0),s.aAxis)/(Math.PI/180)),e,t,Fo(s.end))}function aM(s){return yh(s.aAxis.length)+","+yh(s.bAxis.length)}function Fv(s){return Ya.String.Join(" ",s.map(e=>Fo(e)))}function lM(s){if(s instanceof R)return uM(s);if(s instanceof Re)return Dv(s);if(s instanceof he)return Ty(s);throw new Error("NotImplementedException")}function uM(s){return"L "+Fo(s.end)}function Ng(s){return s?"rgba("+s.R+","+s.G+","+s.B+","+s.A/255+")":"Black"}function cM(s,e){let t=e.sub(s),n=t;t=t.normalize();let i=new f(-t.y,t.x),o=n.length*Math.tan(Ph.arrowAngle*.5*(Math.PI/180));return i=i.mul(o),[s.add(i),e,s.sub(i)]}var C1=Ae(S1());function ro(s){return wt(s)}var _g=class{constructor(e=document.body){this.mouseHitDistance=.05/2;this.needCreateGeometry=!0;this.needCalculateLayout=!0;this._layoutOptions={};this.IncrementalDraggingModeAlways=!1;this.GraphChanged=new Bu;this.objectUnderMouseCursorChanged=new Bu;this.modifierKeys=0;this.LineThicknessForEditing=2;this.layoutEditingEnabled=!0;this._textMeasurer=new Xa,this._svgCreator=new Ph(e),this._svgCreator.getSmoothedPolylineRadius=()=>this.smoothedPolylineCircleRadius,e.addEventListener("pointerdown",t=>{this.layoutEditor.viewerMouseDown(this,t)&&this.panZoom.pause()}),e.addEventListener("pointermove",t=>{this.processMouseMove(t),this.layoutEditingEnabled&&this.layoutEditor.viewerMouseMove(this,t)}),e.addEventListener("pointerup",t=>{!this.layoutEditingEnabled||(this.layoutEditor.viewerMouseUp(this,t),this.panZoom.resume())}),this.layoutEditor=new jt(this)}addKeyDownListener(e){this.keyDownListener=e}*entitiesIter(){for(let e of this.graph.nodesBreadthFirst)yield ro(e);for(let e of this.graph.deepEdges)yield ro(e),e.label&&(yield ro(e.label))}get smoothedPolylineRadiusWithNoScale(){return this.Dpi*.05}getInterpolationSlack(){return this.mouseHitDistance}get Dpi(){return 96*window.devicePixelRatio}getHitSlack(){return this.Dpi*this.mouseHitDistance/this.CurrentScale}getSvgString(){return this._svgCreator.getSvgString()}getJSONString(){return this.graph==null?"no graph":JSON.stringify(ph(this.graph),null,2)}processMouseMove(e){if(this.mousePosition=new f(e.clientX,e.clientY),!(this==null||this._svgCreator==null)&&!!this.layoutEditingEnabled&&!(this.layoutEditor.dragging&&this.insertingEdge==!1)){if(this.insertingNode){this._svgCreator.positionNodeInsertionCircle(this.ScreenToSourceP(this.mousePosition.x,this.mousePosition.y));return}this.insertingEdge&&this._svgCreator.positionEdgeInsertionElement(this.ScreenToSourceP(this.mousePosition.x,this.mousePosition.y),this.layoutEditor.hasEdgeInsertionPort),this.setObjectUnderCursorFromEvent(e)}}setObjectUnderCursorFromEvent(e){this._objectTree==null&&(this._objectTree=Mm(this.graph,this.getHitSlack()));let t=Array.from(Gm(this._objectTree,this.getHitSlack(),this.screenToSource(e)));if(t.length==0){this.objectUnderMouseCursor=null;return}i();let n=t[0];n instanceof ce&&(this.objectUnderMouseCursor=n.entity.getAttr(ae.ViewerIndex));function i(){t.sort((o,a)=>{let l=o instanceof re?3:o instanceof Ur?2:o instanceof Ge?1:0,u=a instanceof re?3:a instanceof Ur?2:a instanceof Ge?1:0;if(l!=u)return l-u;if(l==2)return 0;return c(a)-c(o);function c(h){let d=0,m=h.entity.parent;for(;m;)d++,m=m.parent;return d}})}}get insertionMode(){return this._insertionMode}set insertionMode(e){if(e!=this.insertionMode){switch(e){case 0:this._svgCreator.stopNodeInsertion(),this._svgCreator.stopEdgeInsertion();break;case 1:this._svgCreator.prepareToNodeInsertion(this.ScreenToSourceP(this.mousePosition.x,this.mousePosition.y));break;case 2:this._svgCreator.prepareToEdgeInsertion(this.ScreenToSourceP(this.mousePosition.x,this.mousePosition.y),this.layoutEditor.hasEdgeInsertionPort);break;default:throw new Error("not implemented")}this._insertionMode=e}}createUndoPoint(){this.layoutEditor.createUndoPoint()}selectedEntities(){let e=Array.from(this.layoutEditor.dragGroup);return this.objectUnderMouseCursor&&e.push(this.objectUnderMouseCursor),this.layoutEditor.edgeWithSmoothedPolylineExposed&&e.push(this.layoutEditor.edgeWithSmoothedPolylineExposed),e}createIViewerNodeNPA(e,t,n){throw new Error("Method not implemented.")}createIViewerNodeN(e,t){return this.graph.getAttr(ae.DrawingObjectIndex).createNodeGeometry(e,t),this._svgCreator.drawNode(e),ro(e)}undo(){this.layoutEditor.undo()}redo(){this.layoutEditor.redo()}setGraph(e,t=this._layoutOptions){if(this._graph===e)this.setOptions(t);else{this._graph=e,this._layoutOptions=t,this._textMeasurer.setOptions(t.label||{});let n=xt.getDrawingObj(e)||new xt(e);this.needCreateGeometry?n.createGeometry(this._textMeasurer.measure):n.measureLabelSizes(this._textMeasurer.measure),this.needCalculateLayout&&bh(e,this._layoutOptions,!0),this._update()}this.needCalculateLayout=this.needCreateGeometry=!0}setOptions(e){let t=this._layoutOptions.label,n=e.label,i=!sh(t,n);if(this._layoutOptions=e,!this._graph)return;let o=xt.getDrawingObj(this._graph);i&&(this._textMeasurer.setOptions(e.label||{}),o.createGeometry(this._textMeasurer.measure));let a=i;bh(this._graph,this._layoutOptions,a),this._update()}_update(){!this._graph||(this._objectTree=null,this._svgCreator.setGraph(this._graph),this.panZoom=(0,C1.default)(this._svgCreator.svg,{onTouch:()=>!1}),this.panZoom.showRectangle(this._svgCreator.svg.getBoundingClientRect()),this.layoutEditor.viewerGraphChanged(),this.graph.deepEdgesCount()>2e3&&this.graph.nodeCountDeep>1e3&&(this.layoutEditingEnabled=!1))}screenToSource(e){return this.ScreenToSourceP(e.clientX,e.clientY)}ScreenToSourceP(e,t){return this._svgCreator.getTransform().inverse().multiplyPoint(new f(e,t))}get CurrentScale(){return this._svgCreator.getScale()}get objectUnderMouseCursor(){return this._objectUnderMouse}set objectUnderMouseCursor(e){this._objectUnderMouse!==e&&(this._objectUnderMouse=e)}invalidate(e){this._objectTree=null,this.graph!==e.entity&&x1(e.entity)?e.entity.getAttr(ae.ViewerIndex).svgData.remove():this._svgCreator.invalidate(e)}invalidateAll(){}get entities(){return this.entitiesIter()}get DpiX(){return this.Dpi}get DpiY(){return this.Dpi}get insertingNode(){return this.insertionMode==1}get insertingEdge(){return this.insertionMode==2}PopupMenus(e){throw new Error("Method not implemented.")}get smoothedPolylineCircleRadius(){return this.smoothedPolylineRadiusWithNoScale/this.CurrentScale}addEdge(e,t){this._objectTree=null,t&&this.layoutEditor.registerAdd(e.entity)}createEdgeWithGivenGeometry(e){return this._svgCreator.drawEdge(e),ro(e)}addNode(e,t){this._objectTree=null,t&&this.layoutEditor.registerAdd(e.entity)}remove(e,t){let n=e.entity;this._objectTree=null,t&&this.layoutEditor.registerDelete(n),this.objectUnderMouseCursor===e&&(this.objectUnderMouseCursor=null),e.svgData.remove(),this.layoutEditor.forget(e),n instanceof de?this.removeSubgraph(n):this.removeForNonSubgraph(n,t)}removeForNonSubgraph(e,t){if(e instanceof tt){if(t)for(let i of e.edges)this.layoutEditor.registerDelete(i),i.label&&this.layoutEditor.registerDelete(i.label);e.parent.removeNode(e);for(let i of e.edges)E1(i)}else if(e instanceof et)e.remove(),t&&e.label&&this.layoutEditor.registerDelete(e.label),E1(e);else if(e instanceof er){let n=e.parent;n.label=null}}removeSubgraph(e){let t=Array.from(e.allElements());for(let n of t)ro(n).svgData.remove();e.removeSubgraph();for(let n of t)ro(n).svgData.remove(),n instanceof et&&n.label&&ro(n.label).svgData.remove()}RouteEdge(e){throw new Error("Method not implemented.")}SetSourcePortForEdgeRouting(e){this.sourcePortLocatiton=e}setTargetPortForEdgeRouting(e){this.targetPortLocatiton=e}RemoveSourcePortEdgeRouting(){}RemoveTargetPortEdgeRouting(){}drawRubberEdge(e){this._svgCreator.drawRubberEdge(e)}stopDrawingRubberEdge(){this._svgCreator.removeRubberEdge()}get graph(){return this._graph}get Transform(){return this._svgCreator.getTransform()}};function E1(s){s.remove(),ro(s).svgData.remove(),s.label&&ro(s.label).svgData.remove()}function x1(s){if(s instanceof et)return s.source!==s.target?!s.source.outEdges.has(s)||!s.target.inEdges.has(s)?!0:e(s.source)||e(s.target):!s.source.selfEdges.has(s)||e(s.source);if(s instanceof tt)return e(s);if(s instanceof er)return s.parent==null?!0:x1(s.parent);return!1;function e(t){let n=t.parent;for(;n;){if(n.findNode(t.id)!==t)return!0;t=n,n=n.parent}return!1}}var Vg=document.getElementById("viewer");Vg.setAttribute("style","touch-action: none;");var zM="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/fsm.gv",Je=new _g(Vg),A1=KM(),Ry;Vg.addEventListener("dblclick",s=>{s.stopImmediatePropagation()});window.addEventListener("click",s=>{s.target!==xh&&xh.style.display==="table-cell"&&(L1(xh,"hide"),Je.layoutEditor.resizeLabel(xh.innerText,Ry),Ry=null)});Vg.addEventListener("keydown",s=>{if(s.ctrlKey)switch(s.key.toLowerCase()){case"e":Je.layoutEditingEnabled=!Je.layoutEditingEnabled,s.preventDefault();break;case"z":Je.undo(),s.preventDefault();break;case"y":Je.redo(),s.preventDefault();break;case"i":Je.insertionMode!=1?Je.insertionMode=1:Je.insertionMode=0,s.preventDefault();break;case"d":Je.insertionMode!=2?Je.insertionMode=2:Je.insertionMode=0,s.preventDefault();break}else if(s.key=="Delete"){let e=!0;for(let t of Je.selectedEntities())e&&(Je.createUndoPoint(),e=!1),Je.remove(t,!0)}else Je.objectUnderMouseCursor!=null&&QM(Je.objectUnderMouseCursor.entity,Je,xh,s)});A1.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+A1.value;Bg(s).then(e=>(Je.setGraph(e,Su()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)};var xh=document.getElementById("textedit"),v1=YM();v1.onchange=()=>{Je.setOptions(Su())};var T1=XM();T1.onchange=()=>{Je.setOptions(Su())};var I1=qM();I1.onchange=()=>{Je.setOptions(Su())};var HM=document.getElementById("save-svg");HM.onclick=()=>{let s=Je.getSvgString();w1(Je.graph.id+".svg",s)};var jM=document.getElementById("save-JSON");jM.onclick=()=>{let s=Je.getJSONString();w1(Je.graph.id+".JSON",s)};function w1(s,e){let t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download",s),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}s0("drop-target",async s=>{Ay(s).then(e=>(dc(e)&&(Je.needCreateGeometry=!1,Ud(e)&&(Je.needCalculateLayout=!1)),Je.setGraph(e,Su()),e.id)).then(e=>document.getElementById("graph-name").innerText=e)});(async()=>{let s=await Bg(zM);Je.setOptions(Su()),Je.setGraph(s),document.getElementById("graph-name").innerText=s.id})();function qM(){let s=document.getElementById("fonts");for(let e of ZS){let t=document.createElement("option");t.value=e,t.innerText=e,t.style.fontFamily=e,s.appendChild(t)}return s}function XM(){let s=document.getElementById("layouts");for(let e in hb){let t=document.createElement("option");t.value=e,t.innerText=hb[e],s.appendChild(t)}return s}function YM(){let s=document.getElementById("routings");for(let e in cb){let t=document.createElement("option");t.value=e,t.innerText=cb[e],s.appendChild(t)}return s}function KM(){let s=document.getElementById("gv");for(let e of JS){let t=document.createElement("option");t.value=`${e}.gv`,t.innerText=e,s.appendChild(t)}return s.selectedIndex=-1,s}function Su(){let s={label:{fontFamily:I1.value}};switch(T1.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;case"ipsepCola":s.layoutType="IPsepCola";break;default:break}switch(v1.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}function L1(s,e){e==="show"?s.style.display="table-cell":s.style.display="none"}function QM(s,e,t,n){if(s instanceof tt){let i=s.getAttr(ae.GeomObjectIndex),a=e.Transform.multiplyPoint(i.boundingBox.leftTop);t.style.left=`${a.x}px`,t.style.top=`${a.y}px`;let l=s.getAttr(ae.DrawingObjectIndex);t.innerText=l.labelText,Ry=s,L1(t,"show"),n.stopImmediatePropagation()}}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.
   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   xxHash Library
   Copyright (c) 2012-2021 Yann Collet
   All rights reserved.

   BSD 2-Clause License (https://www.opensource.org/licenses/bsd-license.php)

   Redistribution and use in source and binary forms, with or without modification,
   are permitted provided that the following conditions are met:

   * Redistributions of source code must retain the above copyright notice, this
     list of conditions and the following disclaimer.

   * Redistributions in binary form must reproduce the above copyright notice, this
     list of conditions and the following disclaimer in the documentation and/or
     other materials provided with the distribution.

   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! The following comments were added due to code inlined from "@esfx/internal-binarysearch": */
/*! The following comments were added due to code inlined from "@esfx/internal-collections-hash": */
